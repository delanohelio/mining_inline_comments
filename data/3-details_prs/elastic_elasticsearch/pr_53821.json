{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTQ0Mzgw", "number": 53821, "title": "[ML] adjusting feature importance mapping for multi-class support", "bodyText": "Feature importance storage format is changing to encompass multi-class.\nFeature importance objects are now mapped as follows\n(logistic) Regression:\n{\n   \"feature_name\": \"feature_0\",\n   \"importance\": -1.3\n}\n\nMulti-class [class names are foo, bar, baz]\n{ \n   \u201cfeature_name\u201d: \u201cfeature_0\u201d, \n   \u201cimportance\u201d: 2.0, // sum(abs()) of class importances\n   \u201cfoo\u201d: 1.0, \n   \u201cbar\u201d: 0.5, \n   \u201cbaz\u201d: -0.5 \n},\n\nThis change adjusts the mapping creation for analytics so that the field is mapped as a nested type.\nNative side change: elastic/ml-cpp#1071", "createdAt": "2020-03-19T17:40:06Z", "url": "https://github.com/elastic/elasticsearch/pull/53821", "merged": true, "mergeCommit": {"oid": "2a99f4e50ead8f1bf3f404f31770924391f7f323"}, "closed": true, "closedAt": "2020-03-23T18:41:50Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPPd11gH2gAyMzkxMTQ0MzgwOmUwNzhhODYyOTRmZTJkMTc3MDNjNmIzZDg5NGJhNDNiYjg0Mjk5MzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQeGZ0gFqTM3OTQxNDA0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e078a86294fe2d17703c6b3d894ba43bb8429936", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/e078a86294fe2d17703c6b3d894ba43bb8429936", "committedDate": "2020-03-19T17:36:07Z", "message": "[ML] adjusting feature importance mapping for multi-class support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d439e202f20d77e6c94cb69d191aeef0e6118e38", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/d439e202f20d77e6c94cb69d191aeef0e6118e38", "committedDate": "2020-03-20T13:54:03Z", "message": "removing nested type for now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7cd8df470542a791a650b42d3dde5dfe93dc04a", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7cd8df470542a791a650b42d3dde5dfe93dc04a", "committedDate": "2020-03-20T14:08:57Z", "message": "Unmuting tests for feature importance integration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MTkzMDE0", "url": "https://github.com/elastic/elasticsearch/pull/53821#pullrequestreview-379193014", "createdAt": "2020-03-23T07:53:08Z", "commit": {"oid": "b7cd8df470542a791a650b42d3dde5dfe93dc04a"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNzo1MzowOFrOF5564A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwODowMjoyNFrOF56KHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2MjExMg==", "bodyText": "Suggested change", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396262112", "createdAt": "2020-03-23T07:53:08Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/MapUtils.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ *//*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.ml.dataframe.analyses;\n+\n+import org.elasticsearch.index.mapper.KeywordFieldMapper;\n+import org.elasticsearch.index.mapper.NumberFieldMapper;\n+\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+final class MapUtils {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cd8df470542a791a650b42d3dde5dfe93dc04a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2MzkzNw==", "bodyText": "You could put the hasEntry assertion into allOf in line 257 where the other hasEntry assertions are.", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396263937", "createdAt": "2020-03-23T07:57:33Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/ClassificationTests.java", "diffHunk": "@@ -244,39 +243,45 @@ public void testFieldCardinalityLimitsIsNonEmpty() {\n     }\n \n     public void testGetExplicitlyMappedFields() {\n-        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(null, \"results\"), is(anEmptyMap()));\n-        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(Collections.emptyMap(), \"results\"), is(anEmptyMap()));\n+        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(null, \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n+        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(Collections.emptyMap(), \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n         assertThat(\n             new Classification(\"foo\").getExplicitlyMappedFields(Collections.singletonMap(\"foo\", \"not_a_map\"), \"results\"),\n-            is(anEmptyMap()));\n-        assertThat(\n-            new Classification(\"foo\").getExplicitlyMappedFields(\n-                Collections.singletonMap(\"foo\", Collections.singletonMap(\"bar\", \"baz\")),\n-                \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n+        Map<String, Object> explicitlyMappedFields = new Classification(\"foo\").getExplicitlyMappedFields(\n+            Collections.singletonMap(\"foo\", Collections.singletonMap(\"bar\", \"baz\")),\n+            \"results\");\n+        assertThat(explicitlyMappedFields,\n             allOf(\n                 hasEntry(\"results.foo_prediction\", Collections.singletonMap(\"bar\", \"baz\")),\n                 hasEntry(\"results.top_classes.class_name\", Collections.singletonMap(\"bar\", \"baz\"))));\n-        assertThat(\n-            new Classification(\"foo\").getExplicitlyMappedFields(\n-                new HashMap<>() {{\n-                    put(\"foo\", new HashMap<>() {{\n-                        put(\"type\", \"alias\");\n-                        put(\"path\", \"bar\");\n-                    }});\n-                    put(\"bar\", Collections.singletonMap(\"type\", \"long\"));\n-                }},\n-                \"results\"),\n+        assertThat(explicitlyMappedFields, hasEntry(\"results.feature_importance\", MapUtils.featureImportanceMapping()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cd8df470542a791a650b42d3dde5dfe93dc04a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NDA5OQ==", "bodyText": "Same here.", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396264099", "createdAt": "2020-03-23T07:57:51Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/ClassificationTests.java", "diffHunk": "@@ -244,39 +243,45 @@ public void testFieldCardinalityLimitsIsNonEmpty() {\n     }\n \n     public void testGetExplicitlyMappedFields() {\n-        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(null, \"results\"), is(anEmptyMap()));\n-        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(Collections.emptyMap(), \"results\"), is(anEmptyMap()));\n+        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(null, \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n+        assertThat(new Classification(\"foo\").getExplicitlyMappedFields(Collections.emptyMap(), \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n         assertThat(\n             new Classification(\"foo\").getExplicitlyMappedFields(Collections.singletonMap(\"foo\", \"not_a_map\"), \"results\"),\n-            is(anEmptyMap()));\n-        assertThat(\n-            new Classification(\"foo\").getExplicitlyMappedFields(\n-                Collections.singletonMap(\"foo\", Collections.singletonMap(\"bar\", \"baz\")),\n-                \"results\"),\n+            equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n+        Map<String, Object> explicitlyMappedFields = new Classification(\"foo\").getExplicitlyMappedFields(\n+            Collections.singletonMap(\"foo\", Collections.singletonMap(\"bar\", \"baz\")),\n+            \"results\");\n+        assertThat(explicitlyMappedFields,\n             allOf(\n                 hasEntry(\"results.foo_prediction\", Collections.singletonMap(\"bar\", \"baz\")),\n                 hasEntry(\"results.top_classes.class_name\", Collections.singletonMap(\"bar\", \"baz\"))));\n-        assertThat(\n-            new Classification(\"foo\").getExplicitlyMappedFields(\n-                new HashMap<>() {{\n-                    put(\"foo\", new HashMap<>() {{\n-                        put(\"type\", \"alias\");\n-                        put(\"path\", \"bar\");\n-                    }});\n-                    put(\"bar\", Collections.singletonMap(\"type\", \"long\"));\n-                }},\n-                \"results\"),\n+        assertThat(explicitlyMappedFields, hasEntry(\"results.feature_importance\", MapUtils.featureImportanceMapping()));\n+\n+        explicitlyMappedFields = new Classification(\"foo\").getExplicitlyMappedFields(\n+            new HashMap<>() {{\n+                put(\"foo\", new HashMap<>() {{\n+                    put(\"type\", \"alias\");\n+                    put(\"path\", \"bar\");\n+                }});\n+                put(\"bar\", Collections.singletonMap(\"type\", \"long\"));\n+            }},\n+            \"results\");\n+        assertThat(explicitlyMappedFields,\n             allOf(\n                 hasEntry(\"results.foo_prediction\", Collections.singletonMap(\"type\", \"long\")),\n                 hasEntry(\"results.top_classes.class_name\", Collections.singletonMap(\"type\", \"long\"))));\n+        assertThat(explicitlyMappedFields, hasEntry(\"results.feature_importance\", MapUtils.featureImportanceMapping()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cd8df470542a791a650b42d3dde5dfe93dc04a"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTIxNw==", "bodyText": "You could use more idiomatic hasSize(greaterThan(0)) here.", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396265217", "createdAt": "2020-03-23T08:00:28Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/RegressionIT.java", "diffHunk": "@@ -86,11 +87,13 @@ public void testSingleNumericFeatureAndMixedTrainingAndNonTrainingRows() throws\n             assertThat(resultsObject.containsKey(predictedClassField), is(true));\n             assertThat(resultsObject.containsKey(\"is_training\"), is(true));\n             assertThat(resultsObject.get(\"is_training\"), is(destDoc.containsKey(DEPENDENT_VARIABLE_FIELD)));\n+            @SuppressWarnings(\"unchecked\")\n+            List<Map<String, Object>> importanceArray = (List<Map<String, Object>>)resultsObject.get(\"feature_importance\");\n+            assertThat(importanceArray.size(), greaterThan(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cd8df470542a791a650b42d3dde5dfe93dc04a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTcxOQ==", "bodyText": "findAny() returns Optional so you could use it as a subject and the assertion would be isPresent from OptionalMatchers.", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396265719", "createdAt": "2020-03-23T08:01:38Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/RegressionIT.java", "diffHunk": "@@ -86,11 +87,13 @@ public void testSingleNumericFeatureAndMixedTrainingAndNonTrainingRows() throws\n             assertThat(resultsObject.containsKey(predictedClassField), is(true));\n             assertThat(resultsObject.containsKey(\"is_training\"), is(true));\n             assertThat(resultsObject.get(\"is_training\"), is(destDoc.containsKey(DEPENDENT_VARIABLE_FIELD)));\n+            @SuppressWarnings(\"unchecked\")\n+            List<Map<String, Object>> importanceArray = (List<Map<String, Object>>)resultsObject.get(\"feature_importance\");\n+            assertThat(importanceArray.size(), greaterThan(0));\n             assertThat(\n-                resultsObject.toString(),\n-                resultsObject.containsKey(\"feature_importance.\" + NUMERICAL_FEATURE_FIELD)\n-                    || resultsObject.containsKey(\"feature_importance.\" + DISCRETE_NUMERICAL_FEATURE_FIELD),\n-                is(true));\n+                importanceArray.stream().filter(m -> NUMERICAL_FEATURE_FIELD.equals(m.get(\"feature_name\"))\n+                    || DISCRETE_NUMERICAL_FEATURE_FIELD.equals(m.get(\"feature_name\"))).findAny().orElse(null),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cd8df470542a791a650b42d3dde5dfe93dc04a"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NjAxMw==", "bodyText": "You could use more idiomatic hasSize(greaterThan(0)) here.", "url": "https://github.com/elastic/elasticsearch/pull/53821#discussion_r396266013", "createdAt": "2020-03-23T08:02:24Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -107,7 +106,9 @@ public void testSingleNumericFeatureAndMixedTrainingAndNonTrainingRows() throws\n             assertThat(getFieldValue(resultsObject, predictedClassField), is(in(KEYWORD_FIELD_VALUES)));\n             assertThat(getFieldValue(resultsObject, \"is_training\"), is(destDoc.containsKey(KEYWORD_FIELD)));\n             assertTopClasses(resultsObject, 2, KEYWORD_FIELD, KEYWORD_FIELD_VALUES);\n-            assertThat(resultsObject.keySet().stream().filter(k -> k.startsWith(\"feature_importance.\")).findAny().isPresent(), is(true));\n+            @SuppressWarnings(\"unchecked\")\n+            List<Map<String, Object>> importanceArray = (List<Map<String, Object>>)resultsObject.get(\"feature_importance\");\n+            assertThat(importanceArray.size(), greaterThan(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7cd8df470542a791a650b42d3dde5dfe93dc04a"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d2e7683658ff0ec0dd5b6f644daaaf23ab258bb", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/6d2e7683658ff0ec0dd5b6f644daaaf23ab258bb", "committedDate": "2020-03-23T12:39:40Z", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-analysis-adjust-feature-importance-format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1d0367c4b562e3ac317c9d955843e35512557e9", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/b1d0367c4b562e3ac317c9d955843e35512557e9", "committedDate": "2020-03-23T12:48:22Z", "message": "addressing pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e887eaa4f1607cba6309c9788cf3d4e3c4a7cb2", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e887eaa4f1607cba6309c9788cf3d4e3c4a7cb2", "committedDate": "2020-03-23T13:01:18Z", "message": "addressing PR comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDE0MDQz", "url": "https://github.com/elastic/elasticsearch/pull/53821#pullrequestreview-379414043", "createdAt": "2020-03-23T13:13:01Z", "commit": {"oid": "8e887eaa4f1607cba6309c9788cf3d4e3c4a7cb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1871, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}