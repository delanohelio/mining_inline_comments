{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4ODk3NjAw", "number": 64095, "title": "Compute polygon orientation using signed area", "bodyText": "We currently relay in the  southernmost point of a polygon ring to compute the orientation of the polygon. This might lead to wrong results if the point neighbours cross the dateline. This commit changes the computation by using the signed area of the polygon ring.\ncloses #26286", "createdAt": "2020-10-23T11:18:42Z", "url": "https://github.com/elastic/elasticsearch/pull/64095", "merged": true, "mergeCommit": {"oid": "8b00a2c6c5ea4ed0f84e7e1bc9a1d0b6754bcfce"}, "closed": true, "closedAt": "2020-10-28T08:00:13Z", "author": {"login": "iverase"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVUol4gH2gAyNTA4ODk3NjAwOmI1NjM5NTU4NjRkYmIyN2I2ODAyZjY3NjFmYWI0MzVhZjczOWU3MGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWkQ67AH2gAyNTA4ODk3NjAwOjhiYzM1ODE3YjQ4MWY3MGE3MzU1ZTNhYmNjYzAxNGNiOGVjZDBiYjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b563955864dbb27b6802f6761fab435af739e70d", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/b563955864dbb27b6802f6761fab435af739e70d", "committedDate": "2020-10-23T11:12:05Z", "message": "Compute polygon orientation using signed area"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e98128a42eb97e627c875a5ce5edc342f759686", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/1e98128a42eb97e627c875a5ce5edc342f759686", "committedDate": "2020-10-23T13:32:28Z", "message": "remove some unnecessary methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59918e70aad1004908587f690688e54fd97f1dfe", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/59918e70aad1004908587f690688e54fd97f1dfe", "committedDate": "2020-10-23T13:34:38Z", "message": "remove some unnecessary methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTg1MDIx", "url": "https://github.com/elastic/elasticsearch/pull/64095#pullrequestreview-516985021", "createdAt": "2020-10-26T16:55:10Z", "commit": {"oid": "59918e70aad1004908587f690688e54fd97f1dfe"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjo1NToxMVrOHoZP9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjo1NToxMVrOHoZP9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExODc3Mg==", "bodyText": "Maybe we should add the text of this comment to the exception message?", "url": "https://github.com/elastic/elasticsearch/pull/64095#discussion_r512118772", "createdAt": "2020-10-26T16:55:11Z", "author": {"login": "imotov"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeoPolygonDecomposer.java", "diffHunk": "@@ -145,17 +144,27 @@ private static int createEdges(int component, boolean orientation, LinearRing sh\n      */\n     private static Edge[] ring(int component, boolean direction, boolean handedness,\n                         Point[] points, int offset, Edge[] edges, int toffset, int length, final AtomicBoolean translated) {\n-\n-        boolean orientation = getOrientation(points, offset, length);\n+        double signedArea = 0;\n+        double minX = Double.POSITIVE_INFINITY;\n+        double maxX = Double.NEGATIVE_INFINITY;\n+        for (int i = offset; i < offset + length; i++) {\n+            signedArea += points[i].getX() * points[i + 1].getY() - points[i].getY() * points[i + 1].getX();\n+            minX = Math.min(minX, points[i].getX());\n+            maxX = Math.max(maxX, points[i].getX());\n+        }\n+        if (signedArea == 0) {\n+            // Points are collinear or self-intersection\n+            throw new InvalidShapeException(\"Cannot determine orientation: signed area equal to 0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59918e70aad1004908587f690688e54fd97f1dfe"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f19955705d1b599be88318125c897d04e5399e0b", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/f19955705d1b599be88318125c897d04e5399e0b", "committedDate": "2020-10-27T07:08:47Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bc35817b481f70a7355e3abccc014cb8ecd0bb3", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/8bc35817b481f70a7355e3abccc014cb8ecd0bb3", "committedDate": "2020-10-27T07:58:38Z", "message": "Merge branch 'master' into polygonOrientation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1140, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}