{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0ODA0Mjgy", "number": 59076, "title": "Fix the timestamp field of a data stream to @timestamp", "bodyText": "The commit makes the following changes:\n\nThe timestamp field of a data stream definition in a composable\nindex template can only be set to @timestamp.\nRemoved custom data stream timestamp field validation and reuse the validation from TimestampFieldMapper and\ninstead only check that the _timestamp field mapping has been defined on a backing index of a data stream.\nMoved code that injects _timestamp meta field mapping from MetadataCreateIndexService#applyCreateIndexRequestWithV2Template(...) method\nto MetadataIndexTemplateService#collectMappings(...) method.\nFixed a bug (#58956) that cases timestamp field validation to be performed\nfor each template and instead of the final mappings that is created.\n\nRelates to #58642\nRelates to #53100\nCloses #58956\nCloses #58583", "createdAt": "2020-07-06T14:15:04Z", "url": "https://github.com/elastic/elasticsearch/pull/59076", "merged": true, "mergeCommit": {"oid": "cb6b05d12b97dd61da9f09d5b76fe19d4afef62f"}, "closed": true, "closedAt": "2020-07-08T07:41:48Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyR6qAgH2gAyNDQ0ODA0MjgyOjUyNjkwMzRkOWNlY2JkNWNhMmU0MDcxZGZhMmYzOTk3YzRjMDkwNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczXhnMgFqTQ0NjAyMjk0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5269034d9cecbd5ca2e4071dfa2f3997c4c0906b", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/5269034d9cecbd5ca2e4071dfa2f3997c4c0906b", "committedDate": "2020-07-06T14:14:45Z", "message": "Fix the timestamp field of a data stream to @timestamp\n\nThe commit makes the following changes:\n* The timestamp field of a data stream definition in a composable\n  index template can only be set to '@timestamp'.\n* Removed custom data stream timestamp field validation and reuse the validation from `TimestampFieldMapper` and\n  instead only check that the _timestamp field mapping has been defined on a backing index of a data stream.\n* Moved code that injects _timestamp meta field mapping from `MetadataCreateIndexService#applyCreateIndexRequestWithV2Template58956(...)` method\n  to `MetadataIndexTemplateService#collectMappings(...)` method.\n* Fixed a bug (#58956) that cases timestamp field validation to be performed\n  for each template and instead of the final mappings that is created.\n\nRelates to #58642\nRelates to #53100\nCloses #58956\nCloses #58583"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "257d33a64341242155b7da07e0de99b0f92943af", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/257d33a64341242155b7da07e0de99b0f92943af", "committedDate": "2020-07-06T15:06:51Z", "message": "fixed tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95e5b2cad41c9e9724b2db0575f378c7138b9cce", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/95e5b2cad41c9e9724b2db0575f378c7138b9cce", "committedDate": "2020-07-06T16:04:12Z", "message": "fixed more tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjE4MTA5", "url": "https://github.com/elastic/elasticsearch/pull/59076#pullrequestreview-443218109", "createdAt": "2020-07-06T16:12:54Z", "commit": {"oid": "95e5b2cad41c9e9724b2db0575f378c7138b9cce"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjoxMjo1NFrOGtd_OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjoyMDowNFrOGteRIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzMDQyNQ==", "bodyText": "Can we make this a public static string so it can be referenced elsewhere?", "url": "https://github.com/elastic/elasticsearch/pull/59076#discussion_r450330425", "createdAt": "2020-07-06T16:12:54Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/ComposableIndexTemplate.java", "diffHunk": "@@ -256,6 +257,10 @@ public String toString() {\n         private final String timestampField;\n \n         public DataStreamTemplate(String timestampField) {\n+            if (\"@timestamp\".equals(timestampField) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e5b2cad41c9e9724b2db0575f378c7138b9cce"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzMjAyNA==", "bodyText": "Super minor:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return Map.of(\"_doc\", Map.of(TimestampFieldMapper.NAME, Map.of(\"path\", timestampField)));\n          \n          \n            \n                        return Map.of(MapperService.SINGLE_MAPPING_NAME, Map.of(TimestampFieldMapper.NAME, Map.of(\"path\", timestampField)));", "url": "https://github.com/elastic/elasticsearch/pull/59076#discussion_r450332024", "createdAt": "2020-07-06T16:15:21Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/ComposableIndexTemplate.java", "diffHunk": "@@ -267,6 +272,13 @@ public String getTimestampField() {\n             this(in.readString());\n         }\n \n+        /**\n+         * @return a mapping snippet for a backing index with `_timestamp` meta field mapper properly configured.\n+         */\n+        public Map<String, Object> getDataSteamMappingSnippet() {\n+            return Map.of(\"_doc\", Map.of(TimestampFieldMapper.NAME, Map.of(\"path\", timestampField)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e5b2cad41c9e9724b2db0575f378c7138b9cce"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzNDMxMg==", "bodyText": "I think we should transform this into an actual error, that way if we end up using it for the HLRC it doesn't fail to throw because assertions are disabled", "url": "https://github.com/elastic/elasticsearch/pull/59076#discussion_r450334312", "createdAt": "2020-07-06T16:19:00Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -213,67 +207,37 @@ public int hashCode() {\n     public static final class TimestampField implements Writeable, ToXContentObject {\n \n         static ParseField NAME_FIELD = new ParseField(\"name\");\n-        static ParseField FIELD_MAPPING_FIELD = new ParseField(\"mapping\");\n \n         @SuppressWarnings(\"unchecked\")\n         private static final ConstructingObjectParser<TimestampField, Void> PARSER = new ConstructingObjectParser<>(\n             \"timestamp_field\",\n-            args -> new TimestampField((String) args[0], (Map<String, Object>) args[1])\n+            args -> new TimestampField((String) args[0])\n         );\n \n         static {\n             PARSER.declareString(ConstructingObjectParser.constructorArg(), NAME_FIELD);\n-            PARSER.declareObject(ConstructingObjectParser.optionalConstructorArg(), (p, c) -> p.mapOrdered(), FIELD_MAPPING_FIELD);\n         }\n \n         private final String name;\n-        private final Map<String, Object> fieldMapping;\n-\n-        public TimestampField(String name, Map<String, Object> fieldMapping) {\n-            assert fieldMapping.containsKey(\"type\") : \"no type defined for mapping of timestamp_field\";\n-            assert ALLOWED_TIMESTAMPFIELD_TYPES.contains(fieldMapping.get(\"type\")) :\n-                \"invalid type defined for mapping of timestamp_field\";\n \n+        public TimestampField(String name) {\n+            assert \"@timestamp\".equals(name) : \"unexpected timestamp field [\" + name + \"]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e5b2cad41c9e9724b2db0575f378c7138b9cce"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzNTAwOQ==", "bodyText": "This makes me wonder, this is fine as-is, but should we even bother having this class or specifying the name of the field if it's going to be hardcoded for the foreseeable future?", "url": "https://github.com/elastic/elasticsearch/pull/59076#discussion_r450335009", "createdAt": "2020-07-06T16:20:04Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -213,67 +207,37 @@ public int hashCode() {\n     public static final class TimestampField implements Writeable, ToXContentObject {\n \n         static ParseField NAME_FIELD = new ParseField(\"name\");\n-        static ParseField FIELD_MAPPING_FIELD = new ParseField(\"mapping\");\n \n         @SuppressWarnings(\"unchecked\")\n         private static final ConstructingObjectParser<TimestampField, Void> PARSER = new ConstructingObjectParser<>(\n             \"timestamp_field\",\n-            args -> new TimestampField((String) args[0], (Map<String, Object>) args[1])\n+            args -> new TimestampField((String) args[0])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e5b2cad41c9e9724b2db0575f378c7138b9cce"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a23d2e484594b5cbe788f3ef4bfcd40f97136f67", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a23d2e484594b5cbe788f3ef4bfcd40f97136f67", "committedDate": "2020-07-06T20:56:15Z", "message": "only apply _timestamp meta field if index is created as part of a data stream or data stream rollover,\nthis fixes a docs test, where a regular index creation matches (logs-*) with a template with a data stream definition."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e6b32292082810dfb4c6c93b3de24744fc6d175", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1e6b32292082810dfb4c6c93b3de24744fc6d175", "committedDate": "2020-07-06T20:56:37Z", "message": "Merge remote-tracking branch 'es/master' into fix_timestamp_field_to_@timestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa6f0ab41f29c5f3012392ea0a93a2d652bbeef3", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa6f0ab41f29c5f3012392ea0a93a2d652bbeef3", "committedDate": "2020-07-06T21:44:14Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "289aa1365de355631a534a637a9c617855f13563", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/289aa1365de355631a534a637a9c617855f13563", "committedDate": "2020-07-07T09:47:45Z", "message": "fix ml integ tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bd67642ac8d268c0cf974e416cd49bba3d28b39", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/3bd67642ac8d268c0cf974e416cd49bba3d28b39", "committedDate": "2020-07-07T09:48:07Z", "message": "Merge remote-tracking branch 'es/master' into fix_timestamp_field_to_@timestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c78733204c12cf44b53026052aff9865d99ced03", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c78733204c12cf44b53026052aff9865d99ced03", "committedDate": "2020-07-07T10:32:53Z", "message": "only include template with _timestamp field mapping if creation a backing index"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODQzODM1", "url": "https://github.com/elastic/elasticsearch/pull/59076#pullrequestreview-443843835", "createdAt": "2020-07-07T12:32:48Z", "commit": {"oid": "c78733204c12cf44b53026052aff9865d99ced03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjozMjo0OVrOGt8Ylw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjozMjo0OVrOGt8Ylw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyODQzOQ==", "bodyText": "@dakrone I had to add this if statement otherwise the meta field mapper was going to be applied on each create index api call. In a docs test, the new logs-- composable index template was triggered by a regular create index api call and then the test failed, because the document being indexed had no timestamp field.\nI think only applying the meta field automatically makes sense for backing indices only and not when a user creates a new index via create index api and the index composable template matches?\nSee commits: a23d2e4, which then was superseded by: c787332", "url": "https://github.com/elastic/elasticsearch/pull/59076#discussion_r450828439", "createdAt": "2020-07-07T12:32:49Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -902,6 +909,23 @@ public static String findV2Template(Metadata metadata, String indexName, boolean\n         Optional.ofNullable(template.template())\n             .map(Template::mappings)\n             .ifPresent(mappings::add);\n+\n+        // Only include _timestamp mapping snippet if creating backing index.\n+        if (indexName.startsWith(DataStream.BACKING_INDEX_PREFIX)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c78733204c12cf44b53026052aff9865d99ced03"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14e8da3c3d2e1b5e9e23eea0031cbcaba931decd", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/14e8da3c3d2e1b5e9e23eea0031cbcaba931decd", "committedDate": "2020-07-07T13:10:20Z", "message": "one search and replace too many"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c9eb00cf7096a97099269aef945977d3febf745", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c9eb00cf7096a97099269aef945977d3febf745", "committedDate": "2020-07-07T17:46:17Z", "message": "instead of changeing the current timestamp field, just add @timestamp and keep using current timestamp field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c92c3a84435fc73efa53dbfb886cc0d79d4032ef", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c92c3a84435fc73efa53dbfb886cc0d79d4032ef", "committedDate": "2020-07-07T17:59:31Z", "message": "Merge remote-tracking branch 'es/master' into fix_timestamp_field_to_@timestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3160b015ed3f4ecba42e934932c77a9a2763579", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/d3160b015ed3f4ecba42e934932c77a9a2763579", "committedDate": "2020-07-07T19:12:11Z", "message": "disable bwc tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "163ae67e431902b7f1648ff6a9a7c5db0ae27cbb", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/163ae67e431902b7f1648ff6a9a7c5db0ae27cbb", "committedDate": "2020-07-07T19:23:26Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29ce2f4666f37402dc68cc0b24e1313291a92e5e", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/29ce2f4666f37402dc68cc0b24e1313291a92e5e", "committedDate": "2020-07-07T20:24:41Z", "message": "iter2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5052d876998c61bb50fb9de20f2cff0b9de7a325", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/5052d876998c61bb50fb9de20f2cff0b9de7a325", "committedDate": "2020-07-07T20:25:00Z", "message": "Merge remote-tracking branch 'es/master' into fix_timestamp_field_to_@timestamp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDIyOTQw", "url": "https://github.com/elastic/elasticsearch/pull/59076#pullrequestreview-446022940", "createdAt": "2020-07-09T23:00:11Z", "commit": {"oid": "5052d876998c61bb50fb9de20f2cff0b9de7a325"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMzowMDoxMlrOGvkiVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMzoxMjo1NlrOGvkxmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNDg3MA==", "bodyText": "Noticed this typo as I was trying to pull up the method: DataSteam -> DataStream.", "url": "https://github.com/elastic/elasticsearch/pull/59076#discussion_r452534870", "createdAt": "2020-07-09T23:00:12Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/ComposableIndexTemplate.java", "diffHunk": "@@ -267,6 +275,13 @@ public String getTimestampField() {\n             this(in.readString());\n         }\n \n+        /**\n+         * @return a mapping snippet for a backing index with `_timestamp` meta field mapper properly configured.\n+         */\n+        public Map<String, Object> getDataSteamMappingSnippet() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5052d876998c61bb50fb9de20f2cff0b9de7a325"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzNjU1OQ==", "bodyText": "Does TimestampFieldMapper need a path parameter now? We're not sure how we will eventually implement custom timestamp names, I can see an implementation where we don't use path here at all. So maybe we could simplify and just have an enabled boolean flag instead.\nDepending on the implementation, we can always add path later and just default to @timestamp if it's not specified.", "url": "https://github.com/elastic/elasticsearch/pull/59076#discussion_r452536559", "createdAt": "2020-07-09T23:05:34Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/TimestampFieldMapper.java", "diffHunk": "@@ -196,6 +196,10 @@ public void validate(DocumentFieldMappers lookup) {\n         }\n     }\n \n+    public String getPath() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5052d876998c61bb50fb9de20f2cff0b9de7a325"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUzODc3OA==", "bodyText": "I think this error will be hard for end users to understand, since they shouldn't be aware of the _timestamp field. Maybe we won't even need this check, once we remove the ability to set timestamp_field, as discussed in #59317 (comment)?", "url": "https://github.com/elastic/elasticsearch/pull/59076#discussion_r452538778", "createdAt": "2020-07-09T23:12:56Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -183,31 +169,16 @@ public static ComposableIndexTemplate lookupTemplateForDataStream(String dataStr\n     }\n \n     public static void validateTimestampFieldMapping(String timestampFieldName, MapperService mapperService) {\n-        MappedFieldType timestampFieldMapper = mapperService.fieldType(timestampFieldName);\n-        if (timestampFieldMapper == null) {\n-            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"], but found no timestamp field\");\n-        }\n-        String type = timestampFieldMapper.typeName();\n-        if (ALLOWED_TIMESTAMPFIELD_TYPES.contains(type) == false) {\n-            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"] to be of types \" +\n-                ALLOWED_TIMESTAMPFIELD_TYPES + \", but instead found type [\" + type  + \"]\");\n-        }\n-    }\n+        TimestampFieldMapper fieldMapper = (TimestampFieldMapper) mapperService.documentMapper().mappers().getMapper(\"_timestamp\");\n+        assert fieldMapper != null : \"[_timestamp] meta field mapper must exist\";\n \n-    public static String convertFieldPathToMappingPath(String fieldPath) {\n-        // The mapping won't allow such fields, so this is a sanity check:\n-        assert Arrays.stream(fieldPath.split(\"\\\\.\")).filter(String::isEmpty).count() == 0L ||\n-            fieldPath.startsWith(\".\") ||\n-            fieldPath.endsWith(\".\") : \"illegal field path [\" + fieldPath + \"]\";\n-\n-        String mappingPath;\n-        if (fieldPath.indexOf('.') == -1) {\n-            mappingPath = \"properties.\" + fieldPath;\n-        } else {\n-            mappingPath = \"properties.\" + fieldPath.replace(\".\", \".properties.\");\n+        if (timestampFieldName.equals(fieldMapper.getPath()) == false) {\n+            throw new IllegalArgumentException(\"[_timestamp] meta field doesn't point to data stream timestamp field [\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5052d876998c61bb50fb9de20f2cff0b9de7a325"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2290, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}