{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MDE5NzU3", "number": 58280, "title": "[ML] allow data streams to be expanded for analytics and transforms", "bodyText": "This commits allows data streams to be a valid source for analytics and transforms.\nData streams are fairly transparent and our _search and _reindex actions work without error.\nFor _transforms the check-pointing works as desired as well. Data streams are effectively treated as an alias and the backing index values are stored within checkpointing information.", "createdAt": "2020-06-17T18:21:46Z", "url": "https://github.com/elastic/elasticsearch/pull/58280", "merged": true, "mergeCommit": {"oid": "67cc7ecd0df76afe26949807b1f12e1d396a5a94"}, "closed": true, "closedAt": "2020-06-23T16:32:58Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsOBuHAH2gAyNDM2MDE5NzU3OjdmYTllZjc0OTgxYTM5NTUwMzg5NWU4MmFjODQ1YjRlMDRkODA0Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuHZe1AH2gAyNDM2MDE5NzU3OjY0ZjA2OWRjZWUzY2VjMGM0MmMzMTAwNmY0OTlkODkxNzYwMWZkZDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7fa9ef74981a395503895e82ac845b4e04d80468", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/7fa9ef74981a395503895e82ac845b4e04d80468", "committedDate": "2020-06-17T18:19:18Z", "message": "[ML] allow datastreams to be expanded for analytics and transforms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDAxMzAw", "url": "https://github.com/elastic/elasticsearch/pull/58280#pullrequestreview-433001300", "createdAt": "2020-06-18T07:15:20Z", "commit": {"oid": "7fa9ef74981a395503895e82ac845b4e04d80468"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNzoxNToyMFrOGligOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNzoxNToyMFrOGligOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAxNTgwMw==", "bodyText": "makes me wonder, if we have a use case, where we do not want data streams, in this PR it seems not.\nExcept the unit tests: Do they fail for includeDatastreams=true?\nIf there is no good reason, I suggest to keep it simple and make data streams default.", "url": "https://github.com/elastic/elasticsearch/pull/58280#discussion_r442015803", "createdAt": "2020-06-18T07:15:20Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/validation/SourceDestValidator.java", "diffHunk": "@@ -65,6 +65,7 @@\n     private final RemoteClusterLicenseChecker remoteClusterLicenseChecker;\n     private final String nodeName;\n     private final String license;\n+    private final boolean includeDatastreams;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa9ef74981a395503895e82ac845b4e04d80468"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc5271aa8404ef333c4b568f6ee9205f2fe194de", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc5271aa8404ef333c4b568f6ee9205f2fe194de", "committedDate": "2020-06-18T12:16:35Z", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-add-data_streams-to-transform-and-analytics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ceb72c79fd531452dd1f025cdee5b09e42aace3", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/0ceb72c79fd531452dd1f025cdee5b09e42aace3", "committedDate": "2020-06-18T12:42:21Z", "message": "simplifying"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a0aa574a048ac5c4aae4a86c8f209b6e63e855b", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a0aa574a048ac5c4aae4a86c8f209b6e63e855b", "committedDate": "2020-06-18T12:44:43Z", "message": "removing unnecessary data stream expansion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMzMxNTQ0", "url": "https://github.com/elastic/elasticsearch/pull/58280#pullrequestreview-433331544", "createdAt": "2020-06-18T14:19:21Z", "commit": {"oid": "2a0aa574a048ac5c4aae4a86c8f209b6e63e855b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMzg3NzM5", "url": "https://github.com/elastic/elasticsearch/pull/58280#pullrequestreview-433387739", "createdAt": "2020-06-18T15:15:38Z", "commit": {"oid": "2a0aa574a048ac5c4aae4a86c8f209b6e63e855b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d139353c40c6144c775b93a6f9296d1fe70dae", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/49d139353c40c6144c775b93a6f9296d1fe70dae", "committedDate": "2020-06-18T20:09:01Z", "message": "adding data stream integration tests to datafeeds transforms and analytics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39d0be5cf4f73a32badfb967bef348ade3f71acf", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/39d0be5cf4f73a32badfb967bef348ade3f71acf", "committedDate": "2020-06-18T21:25:06Z", "message": "fixing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NzIyNTk5", "url": "https://github.com/elastic/elasticsearch/pull/58280#pullrequestreview-435722599", "createdAt": "2020-06-23T12:18:27Z", "commit": {"oid": "39d0be5cf4f73a32badfb967bef348ade3f71acf"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMjoxODoyN1rOGnmgaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMjoyMjozMVrOGnmpQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE3ODUzNw==", "bodyText": "Could we move this to MlNativeIntegTestCase and then also reuse it in DatafeedJobsIT?", "url": "https://github.com/elastic/elasticsearch/pull/58280#discussion_r444178537", "createdAt": "2020-06-23T12:18:27Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/MlNativeDataFrameAnalyticsIntegTestCase.java", "diffHunk": "@@ -113,6 +119,20 @@ private void stopAnalyticsAndForceStopOnError() {\n         }\n     }\n \n+    protected static void createDataStreamAndTemplate(String dataStreamName, String timeField, String mapping) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d0be5cf4f73a32badfb967bef348ade3f71acf"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE4MDQ4Mg==", "bodyText": "I think it'd be nice to have a new test like you added in DatafeedJobsID. Having a test that explains it works on data streams in its name adds to the documentation of what those jobs should support. Also, if that test failed but all others worked fine, we'd immediately know it's because of data streams and not something else.", "url": "https://github.com/elastic/elasticsearch/pull/58280#discussion_r444180482", "createdAt": "2020-06-23T12:21:57Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -454,7 +459,7 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         String sourceIndex = \"classification_two_jobs_with_same_randomize_seed_source\";\n         String dependentVariable = KEYWORD_FIELD;\n \n-        createIndex(sourceIndex);\n+        createIndex(sourceIndex, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d0be5cf4f73a32badfb967bef348ade3f71acf"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE4MDgwMA==", "bodyText": "Similarly here, I think we'd benefit from having a single dedicated test that tests data streams.", "url": "https://github.com/elastic/elasticsearch/pull/58280#discussion_r444180800", "createdAt": "2020-06-23T12:22:31Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/RegressionIT.java", "diffHunk": "@@ -398,28 +402,51 @@ private void initialize(String jobId) {\n     }\n \n     static void indexData(String sourceIndex, int numTrainingRows, int numNonTrainingRows) {\n-        client().admin().indices().prepareCreate(sourceIndex)\n-            .setMapping(\n-                NUMERICAL_FEATURE_FIELD, \"type=double\",\n-                DISCRETE_NUMERICAL_FEATURE_FIELD, \"type=long\",\n-                DEPENDENT_VARIABLE_FIELD, \"type=double\")\n-            .get();\n+        String mapping = \"{\\n\" +\n+            \"      \\\"properties\\\": {\\n\" +\n+            \"        \\\"time\\\": {\\n\" +\n+            \"          \\\"type\\\": \\\"date\\\"\\n\" +\n+            \"        },\" +\n+            \"        \\\"\"+ NUMERICAL_FEATURE_FIELD + \"\\\": {\\n\" +\n+            \"          \\\"type\\\": \\\"double\\\"\\n\" +\n+            \"        },\" +\n+            \"        \\\"\" + DISCRETE_NUMERICAL_FEATURE_FIELD + \"\\\": {\\n\" +\n+            \"          \\\"type\\\": \\\"long\\\"\\n\" +\n+            \"        },\" +\n+            \"        \\\"\" + DEPENDENT_VARIABLE_FIELD + \"\\\": {\\n\" +\n+            \"          \\\"type\\\": \\\"double\\\"\\n\" +\n+            \"        }\" +\n+            \"      }\\n\" +\n+            \"    }\";\n+        if (randomBoolean()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d0be5cf4f73a32badfb967bef348ade3f71acf"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7640772e59f70ad44ecdf53feb8c21f1127abd7c", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/7640772e59f70ad44ecdf53feb8c21f1127abd7c", "committedDate": "2020-06-23T14:25:45Z", "message": "adding specific datastream tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1ODkwNzgw", "url": "https://github.com/elastic/elasticsearch/pull/58280#pullrequestreview-435890780", "createdAt": "2020-06-23T15:18:10Z", "commit": {"oid": "7640772e59f70ad44ecdf53feb8c21f1127abd7c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f069dcee3cec0c42c31006f499d8917601fdd0", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/64f069dcee3cec0c42c31006f499d8917601fdd0", "committedDate": "2020-06-23T15:43:46Z", "message": "fixing test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 441, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}