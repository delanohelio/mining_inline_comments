{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MjI4NzA5", "number": 57490, "title": "Make parent and child aggregator more obvious", "bodyText": "Pulls the way that the ParentJoinAggregator collects global ordinals\ninto a strategy object so it is a little simpler to reason about and\nit'll be simpler to save memory by removing asMultiBucketAggregator in\nthe future.\nRelates to #56487", "createdAt": "2020-06-01T21:39:34Z", "url": "https://github.com/elastic/elasticsearch/pull/57490", "merged": true, "mergeCommit": {"oid": "9479ec1d1cd0f6283856b52916caabb4b3fb56c0"}, "closed": true, "closedAt": "2020-06-02T19:18:00Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnHP5vAH2gAyNDI2MjI4NzA5OmI3OTVkZjY0NGQxZDRiZjkzYjM4ZGYwMWVlN2M2NTBhZmI5ZWQ4ZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnZFSkAH2gAyNDI2MjI4NzA5OjE1YmY0OWU0MzcxMDY0NGVkNzRjNzcwYzY0YWE5NGMwZjNhZDQ0NDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b795df644d1d4bf93b38df01ee7c650afb9ed8e4", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/b795df644d1d4bf93b38df01ee7c650afb9ed8e4", "committedDate": "2020-06-01T21:35:50Z", "message": "Make parent and child aggregator more obvious\n\nPulls the way that the `ParentJoinAggregator` collects global ordinals\ninto a strategy object so it is a little simpler to reason about and\nit'll be simpler to save memory by removing `asMultiBucketAggregator` in\nthe future.\n\nRelates to #56487"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMjI1NjUz", "url": "https://github.com/elastic/elasticsearch/pull/57490#pullrequestreview-422225653", "createdAt": "2020-06-01T22:31:44Z", "commit": {"oid": "b795df644d1d4bf93b38df01ee7c650afb9ed8e4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjozMTo0NVrOGdcODQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjozMTo0NVrOGdcODQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyNDIzNw==", "bodyText": "needs updating?", "url": "https://github.com/elastic/elasticsearch/pull/57490#discussion_r433524237", "createdAt": "2020-06-01T22:31:45Z", "author": {"login": "talevy"}, "path": "modules/parent-join/src/main/java/org/elasticsearch/join/aggregations/ParentJoinAggregator.java", "diffHunk": "@@ -165,6 +150,81 @@ public int docID() {\n \n     @Override\n     protected void doClose() {\n-        Releasables.close(ordsBit, ordsHash);\n+        Releasables.close(collectionStrategy);\n+    }\n+\n+    /**\n+     * Strategy for collecting the global ordinals of the join field in for all\n+     * docs that match the {@code ParentJoinAggregator#inFilter} and then\n+     * checking if which of the docs in the\n+     * {@code ParentJoinAggregator#outFilter} also have the ordinal.\n+     */\n+    protected interface CollectionStrategy extends Releasable {\n+        void addGlobalOrdinal(int globalOrdinal);\n+        boolean existsGlobalOrdinal(int globalOrdinal);\n+    }\n+\n+    /**\n+     * Uses a dense, bit per ordinal representation of the join field in the\n+     * docs that match {@code ParentJoinAggregator#inFilter}. Its memory usage\n+     * is proportional to the maximum ordinal so it is only a good choice if\n+     * most docs match.\n+     */\n+    protected class DenseCollectionStrategy implements CollectionStrategy {\n+        /**\n+         * Otherwise we use a dense bit array to record the global ordinals.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b795df644d1d4bf93b38df01ee7c650afb9ed8e4"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9706f9eee63f2002dcd83e1e204e7bbe73343460", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9706f9eee63f2002dcd83e1e204e7bbe73343460", "committedDate": "2020-06-02T18:21:50Z", "message": "Merge branch 'master' into parent_join_strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15bf49e43710644ed74c770c64aa94c0f3ad4447", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/15bf49e43710644ed74c770c64aa94c0f3ad4447", "committedDate": "2020-06-02T18:22:32Z", "message": "Drop outdated comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3932, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}