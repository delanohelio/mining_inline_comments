{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNjYyMTU4", "number": 54936, "title": "Add method to check if object is generically writeable in stream", "bodyText": "When calling scripts in metric aggregation, the returned metric state is\npassed along to the coordinating node to do the final reduce. However,\nit is possible the object could contain nested state which is unknown to\nStreamOutput/StreamInput. This would then result in the node crashing as\nexceptions are not expected in the middle of serialization.\nThis commit adds a method to StreamOutput that can determine if an\nobject is writeable by the stream. It uses the same logic\nwriteGenericValue, special casing each of the supported collection types\nto recursively determine if each contained value is itself writeable.\nrelates #54708", "createdAt": "2020-04-08T06:51:28Z", "url": "https://github.com/elastic/elasticsearch/pull/54936", "merged": true, "mergeCommit": {"oid": "62b4964f3b25755031a3be06e19e27346d79a324"}, "closed": true, "closedAt": "2020-04-21T23:31:22Z", "author": {"login": "rjernst"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcViIvugH2gAyNDAwNjYyMTU4OmMwOTIxYWZhODEzMDhmMDE5MWYwMzE1YTYwMjQ2MDFiNWZkZWIyNmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZtp2tAFqTM5NzAyMDIwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c0921afa81308f0191f0315a6024601b5fdeb26a", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/c0921afa81308f0191f0315a6024601b5fdeb26a", "committedDate": "2020-04-08T06:44:49Z", "message": "Add method to check if object is generically writeable in stream\n\nWhen calling scripts in metric aggregation, the returned metric state is\npassed along to the coordinating node to do the final reduce. However,\nit is possible the object could contain nested state which is unknown to\nStreamOutput/StreamInput. This would then result in the node crashing as\nexceptions are not expected in the middle of serialization.\n\nThis commit adds a method to StreamOutput that can determine if an\nobject is writeable by the stream. It uses the same logic\nwriteGenericValue, special casing each of the supported collection types\nto recursively determine if each contained value is itself writeable.\n\nrelates #54708"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NzM3NDk0", "url": "https://github.com/elastic/elasticsearch/pull/54936#pullrequestreview-389737494", "createdAt": "2020-04-08T08:00:14Z", "commit": {"oid": "c0921afa81308f0191f0315a6024601b5fdeb26a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODowMDoxNFrOGCjcTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODowMDoxNFrOGCjcTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMzMTAyMw==", "bodyText": "I wonder if we could/should combine this with org.elasticsearch.common.util.CollectionUtils#ensureNoSelfReferences(java.lang.Object, java.lang.String) somehow? It seems like technically we would want to use this in all the spots that we currently also use that method to validate script returns (maybe I'm missing some detail and we wouldn't need to do this kind of validation in other script return spots and only need the no-self-references there for some reason?). That way we'd save iterating through the object to validate twice?", "url": "https://github.com/elastic/elasticsearch/pull/54936#discussion_r405331023", "createdAt": "2020-04-08T08:00:14Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregator.java", "diffHunk": "@@ -90,6 +91,7 @@ public InternalAggregation buildAggregation(long owningBucketOrdinal) {\n         } else {\n             aggregation = aggState;\n         }\n+        StreamOutput.checkWriteable(aggregation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0921afa81308f0191f0315a6024601b5fdeb26a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd05bfe105e8c38fcb42a6f6ff2cfe640a7872da", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd05bfe105e8c38fcb42a6f6ff2cfe640a7872da", "committedDate": "2020-04-20T18:37:33Z", "message": "Merge branch 'master' into stream_iswriteable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de5fd366753d20304aca42df09443106f347b23c", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/de5fd366753d20304aca42df09443106f347b23c", "committedDate": "2020-04-20T18:37:39Z", "message": "add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MDIwMjAy", "url": "https://github.com/elastic/elasticsearch/pull/54936#pullrequestreview-397020202", "createdAt": "2020-04-21T06:25:38Z", "commit": {"oid": "de5fd366753d20304aca42df09443106f347b23c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3583, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}