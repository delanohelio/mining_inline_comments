{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NTMyNTU0", "number": 57741, "title": "Enforce valid field mapping exists for timestamp_field in templates.", "bodyText": "This change is just about validating that composable templates have a date or date_nanos field mapping configured in the mapping section for the timestamp_field that is defined in the data stream definition.\nA followup change will store the timestamp_field mapping with the data stream instance in the cluster state, so that the timestamp mapping will stick with the data stream as long as it will exist. This will make sure subsequent rollover invocations always create a new backing index with consistent timestamp field mapping.\nRelates to #53100", "createdAt": "2020-06-05T15:31:43Z", "url": "https://github.com/elastic/elasticsearch/pull/57741", "merged": true, "mergeCommit": {"oid": "eb6f46a342c3d2c38a87cb00d9987f3c39f5f354"}, "closed": true, "closedAt": "2020-06-12T11:22:20Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoUUx1gH2gAyNDI4NTMyNTU0OmIzMmM2ZGY1NTAxNzc1NzNjN2MwNzdhZTUzNGE4NGJlY2Y5YjgyN2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqdnmSAH2gAyNDI4NTMyNTU0OmQ1ZTg5OWViZGMyZjIyN2Q0YzUwMzIwM2JkNGI3NjE2OGIxOWZiM2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b32c6df550177573c7c077ae534a84becf9b827c", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b32c6df550177573c7c077ae534a84becf9b827c", "committedDate": "2020-06-05T15:23:51Z", "message": "Enforce valid field mapping exists for timestamp_field in templates.\n\nRelates to #53100"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a746ec7c446b3917d976dfd0e9aaac026134514", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a746ec7c446b3917d976dfd0e9aaac026134514", "committedDate": "2020-06-05T15:42:08Z", "message": "removed incorrect console snippet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbd49ac400d5a05b08079fb418873a3927560833", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/cbd49ac400d5a05b08079fb418873a3927560833", "committedDate": "2020-06-05T16:10:40Z", "message": "skip validating if no data stream template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd23c0aceb3951f9d0978e46426b625ee8563869", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd23c0aceb3951f9d0978e46426b625ee8563869", "committedDate": "2020-06-05T16:44:45Z", "message": "fixed docs snippets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd68c5d3c597a72315cbe5360bbe8bc2c4e43839", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/cd68c5d3c597a72315cbe5360bbe8bc2c4e43839", "committedDate": "2020-06-05T17:00:42Z", "message": "fixed unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0c92954eed88a236015ba5cfa0a33fe79023080", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e0c92954eed88a236015ba5cfa0a33fe79023080", "committedDate": "2020-06-05T17:01:21Z", "message": "fixed snippet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57104471b3804152a5aebd20277f01cf71214e0b", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/57104471b3804152a5aebd20277f01cf71214e0b", "committedDate": "2020-06-05T18:01:55Z", "message": "incase of data stream template also generate a mapping"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2Njg0OTYx", "url": "https://github.com/elastic/elasticsearch/pull/57741#pullrequestreview-426684961", "createdAt": "2020-06-08T23:18:00Z", "commit": {"oid": "57104471b3804152a5aebd20277f01cf71214e0b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzoxODowMFrOGgzj1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzoxODozN1rOGgzkhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1MjM3NQ==", "bodyText": "This validation needs to be moved to the validateCompositeTemplate method, that way, when a component template is updated we will still validate the mapping is correct.\nOtherwise a composable template could be added where the mapping is in the component template, and then the component template could be updated to remove the timestamp mapping. Once we move the validation it'll be checked for both index and component templates", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r437052375", "createdAt": "2020-06-08T23:18:00Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -442,9 +444,20 @@ public ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n \n         validate(name, finalIndexTemplate);\n         logger.info(\"adding index template [{}]\", name);\n-        return ClusterState.builder(currentState)\n+        ClusterState newState = ClusterState.builder(currentState)\n             .metadata(Metadata.builder(currentState.metadata()).put(name, finalIndexTemplate))\n             .build();\n+        if (finalIndexTemplate.getDataStreamTemplate() != null) {\n+            validateDataStreamTemplate(name, finalIndexTemplate, newState);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57104471b3804152a5aebd20277f01cf71214e0b"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1MjU0OA==", "bodyText": "When moving the validation to the validateCompositeTemplate method we should be able to reuse the mapping generated in that method", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r437052548", "createdAt": "2020-06-08T23:18:37Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -442,9 +444,20 @@ public ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n \n         validate(name, finalIndexTemplate);\n         logger.info(\"adding index template [{}]\", name);\n-        return ClusterState.builder(currentState)\n+        ClusterState newState = ClusterState.builder(currentState)\n             .metadata(Metadata.builder(currentState.metadata()).put(name, finalIndexTemplate))\n             .build();\n+        if (finalIndexTemplate.getDataStreamTemplate() != null) {\n+            validateDataStreamTemplate(name, finalIndexTemplate, newState);\n+        }\n+        return newState;\n+    }\n+\n+    private void validateDataStreamTemplate(String name, ComposableIndexTemplate finalIndexTemplate, ClusterState state) throws Exception {\n+        String tsFieldName = finalIndexTemplate.getDataStreamTemplate().getTimestampField();\n+        Map<String, Object> finalMapping = parseV2Mappings(\"{}\", resolveMappings(state, name), xContentRegistry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57104471b3804152a5aebd20277f01cf71214e0b"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24451da21e254ef6d25cc3f1033e81bd1378edae", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/24451da21e254ef6d25cc3f1033e81bd1378edae", "committedDate": "2020-06-09T07:41:20Z", "message": "Merge remote-tracking branch 'es/master' into enforce_ts_field_in_templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eab7e7c4db82cbb37e63a15419bd91661c68aef0", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/eab7e7c4db82cbb37e63a15419bd91661c68aef0", "committedDate": "2020-06-09T08:02:15Z", "message": "moved timestamp_field validation to the right place inside the template service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00f5aa04ee29f75eb37b01914297bc6b75bf4d45", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/00f5aa04ee29f75eb37b01914297bc6b75bf4d45", "committedDate": "2020-06-09T10:59:53Z", "message": "fixed test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eca0e0e8b168c581cb54b54f4f8dca740aec5af", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/3eca0e0e8b168c581cb54b54f4f8dca740aec5af", "committedDate": "2020-06-09T11:47:07Z", "message": "fixed test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTA0MTQy", "url": "https://github.com/elastic/elasticsearch/pull/57741#pullrequestreview-427104142", "createdAt": "2020-06-09T12:47:21Z", "commit": {"oid": "3eca0e0e8b168c581cb54b54f4f8dca740aec5af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MTIwOTA0", "url": "https://github.com/elastic/elasticsearch/pull/57741#pullrequestreview-428120904", "createdAt": "2020-06-10T14:36:00Z", "commit": {"oid": "3eca0e0e8b168c581cb54b54f4f8dca740aec5af"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDozNjowMFrOGh38xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDo0MjowNFrOGh4PNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3Mjg2OA==", "bodyText": "Super minor, but can you move this variable definition up to the top of the file (it's nice to have all the vars defined up top where we can see them)", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r438172868", "createdAt": "2020-06-10T14:36:00Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -158,4 +163,20 @@ public static ComposableIndexTemplate lookupTemplateForDataStream(String dataStr\n         return composableIndexTemplate;\n     }\n \n+    private static final Set<String> ALLOWED_TIMESTAMPFIELD_TYPES =\n+        new LinkedHashSet<>(List.of(DateFieldMapper.CONTENT_TYPE, DateFieldMapper.DATE_NANOS_CONTENT_TYPE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eca0e0e8b168c581cb54b54f4f8dca740aec5af"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NzU4OA==", "bodyText": "Unfortunately, I don't think this will work for nested fields, for example the following fails on this PR:\nPUT /_index_template/generic\n{\n  \"index_patterns\": [\"logs-*\"],\n  \"data_stream\": {\n    \"timestamp_field\": \"foo.timestamp\"\n  },\n  \"template\": {\n    \"mappings\": {\n      \"properties\": {\n        \"foo\": {\n          \"properties\": {\n            \"timestamp\": {\n              \"type\": \"date\"\n            }\n          }\n        }\n      }\n    }\n  }\n}", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r438177588", "createdAt": "2020-06-10T14:42:04Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -158,4 +163,20 @@ public static ComposableIndexTemplate lookupTemplateForDataStream(String dataStr\n         return composableIndexTemplate;\n     }\n \n+    private static final Set<String> ALLOWED_TIMESTAMPFIELD_TYPES =\n+        new LinkedHashSet<>(List.of(DateFieldMapper.CONTENT_TYPE, DateFieldMapper.DATE_NANOS_CONTENT_TYPE));\n+\n+    public static void validateTimestampFieldMapping(String timestampFieldName, Map<?, ?> mapping) {\n+        String timestampFieldMapperPath = \"properties.\" + timestampFieldName;\n+        Map<?, ?> timestampFieldMapper = ObjectPath.eval(timestampFieldMapperPath, mapping);\n+        if (timestampFieldMapper == null) {\n+            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"], but found no timestamp field\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eca0e0e8b168c581cb54b54f4f8dca740aec5af"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "267a21d3a1afbb910586178822fd7d7cf88dd4fb", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/267a21d3a1afbb910586178822fd7d7cf88dd4fb", "committedDate": "2020-06-11T06:11:28Z", "message": "Merge remote-tracking branch 'es/master' into enforce_ts_field_in_templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfe93c9f8e7c00300cdd14788264bd77c6e7891e", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/cfe93c9f8e7c00300cdd14788264bd77c6e7891e", "committedDate": "2020-06-11T06:29:45Z", "message": "move constants to top of file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b018664a30783f18c024cdf8ce1e2f42d430285", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b018664a30783f18c024cdf8ce1e2f42d430285", "committedDate": "2020-06-11T09:07:13Z", "message": "Use MapperService to validate the timestamp_field's field mapping instead of custom parsing logic.\n\nThis avoids introducing custom parsing logic, at the cost\nof using mapper service in tests, which imo is minimal."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88f92d5938131899db09f983ba2782d4b1df1974", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/88f92d5938131899db09f983ba2782d4b1df1974", "committedDate": "2020-06-11T11:08:39Z", "message": "fixed tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cca07a21ac47628408f0fa8196b66bf30e904f6", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/0cca07a21ac47628408f0fa8196b66bf30e904f6", "committedDate": "2020-06-11T11:09:34Z", "message": "Merge remote-tracking branch 'es/master' into enforce_ts_field_in_templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9d873ee0fb501fb1a7808dc4cb6d7f78cc2888f", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f9d873ee0fb501fb1a7808dc4cb6d7f78cc2888f", "committedDate": "2020-06-11T11:52:41Z", "message": "fixed test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MTYxNzg5", "url": "https://github.com/elastic/elasticsearch/pull/57741#pullrequestreview-429161789", "createdAt": "2020-06-11T18:01:42Z", "commit": {"oid": "f9d873ee0fb501fb1a7808dc4cb6d7f78cc2888f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODowMTo0M1rOGio3FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODowMTo0M1rOGio3FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDIyOA==", "bodyText": "Super minor:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"] to be of types [\" +\n          \n          \n            \n                            ALLOWED_TIMESTAMPFIELD_TYPES + \"], but instead found type [\" + type  + \"]\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"] to be of types \" +\n          \n          \n            \n                            ALLOWED_TIMESTAMPFIELD_TYPES + \", but instead found type [\" + type  + \"]\");\n          \n      \n    \n    \n  \n\nTo avoid the [[]] double brackets", "url": "https://github.com/elastic/elasticsearch/pull/57741#discussion_r438974228", "createdAt": "2020-06-11T18:01:43Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -158,4 +165,16 @@ public static ComposableIndexTemplate lookupTemplateForDataStream(String dataStr\n         return composableIndexTemplate;\n     }\n \n+    public static void validateTimestampFieldMapping(String timestampFieldName, MapperService mapperService) {\n+        MappedFieldType timestampFieldMapper = mapperService.fieldType(timestampFieldName);\n+        if (timestampFieldMapper == null) {\n+            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"], but found no timestamp field\");\n+        }\n+        String type = timestampFieldMapper.typeName();\n+        if (ALLOWED_TIMESTAMPFIELD_TYPES.contains(type) == false) {\n+            throw new IllegalArgumentException(\"expected timestamp field [\" + timestampFieldName + \"] to be of types [\" +\n+                ALLOWED_TIMESTAMPFIELD_TYPES + \"], but instead found type [\" + type  + \"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9d873ee0fb501fb1a7808dc4cb6d7f78cc2888f"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a37c26f1d51cdf8aefa15072eebb64998427273", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a37c26f1d51cdf8aefa15072eebb64998427273", "committedDate": "2020-06-12T06:54:02Z", "message": "adjusted error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5e899ebdc2f227d4c503203bd4b76168b19fb3c", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/d5e899ebdc2f227d4c503203bd4b76168b19fb3c", "committedDate": "2020-06-12T07:21:24Z", "message": "Merge remote-tracking branch 'es/master' into enforce_ts_field_in_templates"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3757, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}