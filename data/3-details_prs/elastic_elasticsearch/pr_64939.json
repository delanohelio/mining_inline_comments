{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5Mjc0ODMw", "number": 64939, "title": "[7.x] Implement aggregations on aggregate metric fields", "bodyText": "Backports #56745 to 7.x\n\nIn the process of developing a new implementation for the Elasticsearch Rollups functionality we came up with the concept of the aggregate metric field type.\nThe aggregate_metric_double field type can store the results of aggregations (currently min, max, sum, value_count and avg are supported - more to come).\nThis field allows us to run (min, max, sum, value_count, avg) aggregations on the container field and the field will return the correct metric depending on the aggregation that is computed.", "createdAt": "2020-11-11T15:31:46Z", "url": "https://github.com/elastic/elasticsearch/pull/64939", "merged": true, "mergeCommit": {"oid": "1a940eb5dd986f8c9103d0a28b804d61eb5c746a"}, "closed": true, "closedAt": "2020-11-12T14:32:01Z", "author": {"login": "csoulios"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbd7tDgH2gAyNTE5Mjc0ODMwOjI3MjQzOTIxMTM1MGM3Y2E0YzQxZWI4NjRhMmY0MGJlMmU0M2M1ZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbzdeygFqTUyOTE0MTY2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "272439211350c7ca4c41eb864a2f40be2e43c5dd", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/272439211350c7ca4c41eb864a2f40be2e43c5dd", "committedDate": "2020-11-11T13:25:39Z", "message": "Implement aggregations on aggregate metric fields (#56745)\n\nIn the process of developing a new implementation for the Elasticsearch Rollups functionality we came up with the concept of the aggregate metric field type.\n\nThe aggregate_metric_double field type can store the results of aggregations (currently min, max, sum, value_count and avg are supported - more to come).\n\nThis field allows us to run (min, max, sum, value_count, avg) aggregations on the container field and the field will return the correct metric depending on the aggregation that is computed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56ea6dd78606d5f833033992d96f2c9d35bc4806", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/56ea6dd78606d5f833033992d96f2c9d35bc4806", "committedDate": "2020-11-11T15:13:21Z", "message": "Fix build and test after backport"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MjgxNTkx", "url": "https://github.com/elastic/elasticsearch/pull/64939#pullrequestreview-528281591", "createdAt": "2020-11-11T15:34:07Z", "commit": {"oid": "56ea6dd78606d5f833033992d96f2c9d35bc4806"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNTozNDowOFrOHxSSHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNTozNDowOFrOHxSSHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0MTgyMg==", "bodyText": "@polyfractal I guess after this PR is merged, we should change the minimal supported version in master branch from V_8_0_0 to V_7_11_0. Right?", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r521441822", "createdAt": "2020-11-11T15:34:08Z", "author": {"login": "csoulios"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/aggregatemetric/AggregateMetricFeatureSetUsage.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.aggregatemetric;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.xpack.core.XPackFeatureSet;\n+import org.elasticsearch.xpack.core.XPackField;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+public class AggregateMetricFeatureSetUsage extends XPackFeatureSet.Usage {\n+\n+    public AggregateMetricFeatureSetUsage(StreamInput input) throws IOException {\n+        super(input);\n+    }\n+\n+    public AggregateMetricFeatureSetUsage(boolean available, boolean enabled) {\n+        super(XPackField.AGGREGATE_METRIC, available, enabled);\n+    }\n+\n+    @Override public Version getMinimalSupportedVersion() {\n+        return Version.V_7_11_0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56ea6dd78606d5f833033992d96f2c9d35bc4806"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79013d6f3bc02d67b616a7790a41889aa2601418", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/79013d6f3bc02d67b616a7790a41889aa2601418", "committedDate": "2020-11-11T15:42:51Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c58b1cc4809430268f39c5f550b09961f8895a77", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/c58b1cc4809430268f39c5f550b09961f8895a77", "committedDate": "2020-11-11T17:24:04Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a5e5c976268ce12ce2c168f84dc42fc5ae7b92d", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a5e5c976268ce12ce2c168f84dc42fc5ae7b92d", "committedDate": "2020-11-11T17:31:23Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7312ae67634f8eff94b74357c7084894fbbb3b3", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7312ae67634f8eff94b74357c7084894fbbb3b3", "committedDate": "2020-11-11T19:24:06Z", "message": "Merge branch '7.x' into aggregate-metrics-7.x"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NTU5MzI4", "url": "https://github.com/elastic/elasticsearch/pull/64939#pullrequestreview-528559328", "createdAt": "2020-11-11T21:48:20Z", "commit": {"oid": "e7312ae67634f8eff94b74357c7084894fbbb3b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo0ODoyMFrOHxfhNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo1Nzo0NlrOHxfyUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1ODY3OA==", "bodyText": "Yes, I believe that is correct... we'll need to followup with a third PR in master to toggle over the BWC version.  And adjust any yaml/BWC tests as necessary too, if they had version skips added in master, etc.", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r521658678", "createdAt": "2020-11-11T21:48:20Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/aggregatemetric/AggregateMetricFeatureSetUsage.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.aggregatemetric;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.xpack.core.XPackFeatureSet;\n+import org.elasticsearch.xpack.core.XPackField;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+public class AggregateMetricFeatureSetUsage extends XPackFeatureSet.Usage {\n+\n+    public AggregateMetricFeatureSetUsage(StreamInput input) throws IOException {\n+        super(input);\n+    }\n+\n+    public AggregateMetricFeatureSetUsage(boolean available, boolean enabled) {\n+        super(XPackField.AGGREGATE_METRIC, available, enabled);\n+    }\n+\n+    @Override public Version getMinimalSupportedVersion() {\n+        return Version.V_7_11_0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0MTgyMg=="}, "originalCommit": {"oid": "56ea6dd78606d5f833033992d96f2c9d35bc4806"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2MjAwNA==", "bodyText": "I think we need to add a clause to check if this is running as a transport client, and not inject the plugin in that case.  See: https://github.com/elastic/elasticsearch/blob/7.x/x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/AnalyticsPlugin.java#L143\nI'm not 100 percent sure this is still necessary, but I skimmed the other 7x plugins and they seem to still have this structure so probably for the best to follow suit too :)", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r521662004", "createdAt": "2020-11-11T21:55:21Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/mapper-aggregate-metric/src/main/java/org/elasticsearch/xpack/aggregatemetric/AggregateMetricMapperPlugin.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.aggregatemetric;\n+\n+import org.elasticsearch.common.collect.List;\n+import org.elasticsearch.common.inject.Module;\n+import org.elasticsearch.index.mapper.Mapper;\n+import org.elasticsearch.plugins.ActionPlugin;\n+import org.elasticsearch.plugins.MapperPlugin;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.SearchPlugin;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceRegistry;\n+import org.elasticsearch.xpack.aggregatemetric.aggregations.metrics.AggregateMetricsAggregatorsRegistrar;\n+import org.elasticsearch.xpack.aggregatemetric.mapper.AggregateDoubleMetricFieldMapper;\n+import org.elasticsearch.xpack.core.XPackPlugin;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.function.Consumer;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class AggregateMetricMapperPlugin extends Plugin implements MapperPlugin, ActionPlugin, SearchPlugin {\n+\n+    public AggregateMetricMapperPlugin() {}\n+\n+    @Override\n+    public Collection<Module> createGuiceModules() {\n+        return Collections.singletonList(b -> { XPackPlugin.bindFeatureSet(b, AggregateMetricFeatureSet.class); });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7312ae67634f8eff94b74357c7084894fbbb3b3"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2MzA1OA==", "bodyText": "I think we'll need to tweak the versions in all these yaml tests, right?", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r521663058", "createdAt": "2020-11-11T21:57:46Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/aggregate-metrics/10_basic.yml", "diffHunk": "@@ -0,0 +1,292 @@\n+---\n+\"Test exists query on aggregate metric field\":\n+  - skip:\n+      version: \" - 7.99.99\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7312ae67634f8eff94b74357c7084894fbbb3b3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8373b3f238528a9233ffe7c0f6599f594bc5d4b2", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/8373b3f238528a9233ffe7c0f6599f594bc5d4b2", "committedDate": "2020-11-12T10:14:17Z", "message": "Addressed reviewer comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTQxNjY1", "url": "https://github.com/elastic/elasticsearch/pull/64939#pullrequestreview-529141665", "createdAt": "2020-11-12T14:30:33Z", "commit": {"oid": "8373b3f238528a9233ffe7c0f6599f594bc5d4b2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1017, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}