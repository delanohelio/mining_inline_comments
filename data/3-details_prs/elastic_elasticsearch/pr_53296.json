{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NzA0MTc0", "number": 53296, "title": "Fix composite agg sort bug", "bodyText": "When an composite aggregation is run against an index with a sort that\nstarts with the \"source\" fields from the composite but has additional\nfields it'd blow up in while trying to decide if it could use the sort.\nThis changes it to decide that it can use the sort.\nCloses #52480", "createdAt": "2020-03-09T16:58:51Z", "url": "https://github.com/elastic/elasticsearch/pull/53296", "merged": true, "mergeCommit": {"oid": "57853de283cafaecc3e63df60498925738eab4a0"}, "closed": true, "closedAt": "2020-03-10T13:23:45Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMA3FAAH2gAyMzg1NzA0MTc0OmE4NmM4OGNmYjQ2NWU4YTI4NjkzODI4NDQ3MjE1YjQ1OGE1ZWI3OWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMES2bgH2gAyMzg1NzA0MTc0OmUzZTM1MmM3Yjg0OTFiYjJiMjVkM2UzZmI2ZjE5YWM1ZDUwNDVlZDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a86c88cfb465e8a28693828447215b458a5eb79b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a86c88cfb465e8a28693828447215b458a5eb79b", "committedDate": "2020-03-09T16:53:20Z", "message": "Fix composite agg sort bug\n\nWhen an composite aggregation is run against an index with a sort that\n*starts* with the \"source\" fields from the composite but has additional\nfields it'd blow up in while trying to decide if it could use the sort.\nThis changes it to decide that it *can* use the sort.\n\nCloses #52480"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzY2NTk4", "url": "https://github.com/elastic/elasticsearch/pull/53296#pullrequestreview-371366598", "createdAt": "2020-03-09T17:06:54Z", "commit": {"oid": "a86c88cfb465e8a28693828447215b458a5eb79b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzowNjo1NFrOFzxbYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzowNjo1NFrOFzxbYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzMTUyMw==", "bodyText": "You can still hit the bug if the source configs is smaller than the index sort ? Since we're looking for the biggest prefix of the index sort maybe we could leave the for loop as it is but add a check that breaks the loop if the source configs length is reached:\nif (i >= sourceConfigs.length) {\n  break;\n}", "url": "https://github.com/elastic/elasticsearch/pull/53296#discussion_r389831523", "createdAt": "2020-03-09T17:06:54Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/CompositeAggregator.java", "diffHunk": "@@ -202,7 +202,8 @@ private Sort buildIndexSortPrefix(LeafReaderContext context) throws IOException\n             return null;\n         }\n         List<SortField> sortFields = new ArrayList<>();\n-        for (int i = 0; i < indexSort.getSort().length; i++) {\n+        int max = Math.min(indexSort.getSort().length, sourceConfigs.length);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a86c88cfb465e8a28693828447215b458a5eb79b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzc2NzE1", "url": "https://github.com/elastic/elasticsearch/pull/53296#pullrequestreview-371376715", "createdAt": "2020-03-09T17:19:34Z", "commit": {"oid": "a86c88cfb465e8a28693828447215b458a5eb79b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cd354f4594062cac633de3cd810228ebcd0078a", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4cd354f4594062cac633de3cd810228ebcd0078a", "committedDate": "2020-03-09T17:22:06Z", "message": "Randomly shorten the sort as well"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzgwMjI2", "url": "https://github.com/elastic/elasticsearch/pull/53296#pullrequestreview-371380226", "createdAt": "2020-03-09T17:23:59Z", "commit": {"oid": "a86c88cfb465e8a28693828447215b458a5eb79b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d47387bbbbf46af6ab0e02acd688587d8e1fb5a7", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/d47387bbbbf46af6ab0e02acd688587d8e1fb5a7", "committedDate": "2020-03-09T17:24:14Z", "message": "Revert \"Randomly shorten the sort as well\"\n\nThis reverts commit 4cd354f4594062cac633de3cd810228ebcd0078a."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d00fa93f319154f6b28fb3802b5166ab6ec9a33", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1d00fa93f319154f6b28fb3802b5166ab6ec9a33", "committedDate": "2020-03-09T17:25:55Z", "message": "Merge branch 'master' into composit_sorted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b8dbe1e19fa40468f07813b2bd78244197cc78c", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b8dbe1e19fa40468f07813b2bd78244197cc78c", "committedDate": "2020-03-09T20:36:52Z", "message": "Rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "523708dcaea417fe0aa57f73cf5c2e5c09f656e9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/523708dcaea417fe0aa57f73cf5c2e5c09f656e9", "committedDate": "2020-03-09T20:37:24Z", "message": "Skip?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3e352c7b8491bb2b25d3e3fb6f19ac5d5045ed0", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e3e352c7b8491bb2b25d3e3fb6f19ac5d5045ed0", "committedDate": "2020-03-09T20:53:23Z", "message": "Updateskip"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1654, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}