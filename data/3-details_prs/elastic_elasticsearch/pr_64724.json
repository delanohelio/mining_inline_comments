{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2ODA1MzQ5", "number": 64724, "title": "Fix TaskIT", "bodyText": "This took me a bit of time so I'll try to describe what happened. The TaskIT.testGetValidTask() test failed twice this year (1, 2) with a \"resource not exception\" indicating that a task was not correctly created (the task is a reindexing task).\nThe elasticsearch logs show the following warning messages for both builds failures:\n\nWARN ][o.e.t.LoggingTaskListener] [asyncIntegTest-0] 56987 failed with exception\norg.elasticsearch.index.mapper.MapperException: the [enabled] parameter can't be updated for the object mapping [response]\n\nIt indicates that the .tasks index was already created with a mapping for the response object. Since indices are deleted between tests there was no reason the index already exist when the test is executed.\nMore over the index is a system index and should be appear as [.tasks] creating index, cause [auto(task api)] in logs when it is created but in the failures the index creation is logged with cause [auto(bulk api)], indicating that some indexing operation somewhere (re)created the tasks index.\nThe only other action that could create a document in the .tasks index is a DeleteJobAction with a wait_for_completion set to false as this action overrides ActionRequest#getShouldStoreResult() which allows to store a task result for the action.\nSuch an action is triggered by the test MachineLearningIT.testDeleteJob_GivenWaitForCompletionIsFalse() which does not wait for the task result to be indexed. The REST API call it executes also does not wait at all for any result when wait_for_completion=false.\nThe test failure in #64056 can be reproduce when the test in MachineLearningIT is executed soon before the test TaskId.\nThis pull request makes the test in MachineLearningIT wait for the task to complete.\nCloses #64056", "createdAt": "2020-11-06T15:10:40Z", "url": "https://github.com/elastic/elasticsearch/pull/64724", "merged": true, "mergeCommit": {"oid": "90c476e69adc20063f4f363a75908ac2cb071a54"}, "closed": true, "closedAt": "2020-11-10T09:18:31Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ4AW6gH2gAyNTE2ODA1MzQ5OjQxZjMwMzQxMmFjZjViMzkyZDhmMWUzNTliMWE4Y2I3ZDZlZGE1Y2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda3tmRgH2gAyNTE2ODA1MzQ5Ojg0MTY2MDZmYzg1ODkwYjQ0MWRjZDA2MDMxNzU2M2JkM2Y1N2VmZTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41f303412acf5b392d8f1e359b1a8cb7d6eda5cd", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/41f303412acf5b392d8f1e359b1a8cb7d6eda5cd", "committedDate": "2020-11-06T14:40:25Z", "message": "Fix TaskIT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzI2MTg5", "url": "https://github.com/elastic/elasticsearch/pull/64724#pullrequestreview-525326189", "createdAt": "2020-11-06T16:51:24Z", "commit": {"oid": "41f303412acf5b392d8f1e359b1a8cb7d6eda5cd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjo1MToyNFrOHu1u7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNjo1MzoyOVrOHu1z2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3NjkwOQ==", "bodyText": "Should this get more than a 10s wait?", "url": "https://github.com/elastic/elasticsearch/pull/64724#discussion_r518876909", "createdAt": "2020-11-06T16:51:24Z", "author": {"login": "original-brownbear"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/MachineLearningIT.java", "diffHunk": "@@ -302,7 +306,18 @@ public void testDeleteJob_GivenWaitForCompletionIsFalse() throws Exception {\n         DeleteJobResponse response = execute(deleteJobRequest, machineLearningClient::deleteJob, machineLearningClient::deleteJobAsync);\n \n         assertNull(response.getAcknowledged());\n-        assertNotNull(response.getTask());\n+\n+        final TaskId taskId = response.getTask();\n+        assertNotNull(taskId);\n+\n+        // When wait_for_completion=false the DeleteJobAction stored the task result in the .tasks index. In tests we need to wait\n+        // for the delete job task to complete, otherwise the .tasks index could be created during the execution of a following test.\n+        final GetTaskRequest taskRequest = new GetTaskRequest(taskId.getNodeId(), taskId.getId());\n+        assertBusy(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f303412acf5b392d8f1e359b1a8cb7d6eda5cd"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg3ODE2OA==", "bodyText": "One thing I don't fully understand is, how is this not caught by us ensure that no tasks are running after a test? Shouldn't this task show up in _cat/tasks and the wait we do here run there as a result?", "url": "https://github.com/elastic/elasticsearch/pull/64724#discussion_r518878168", "createdAt": "2020-11-06T16:53:29Z", "author": {"login": "original-brownbear"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/MachineLearningIT.java", "diffHunk": "@@ -302,7 +306,18 @@ public void testDeleteJob_GivenWaitForCompletionIsFalse() throws Exception {\n         DeleteJobResponse response = execute(deleteJobRequest, machineLearningClient::deleteJob, machineLearningClient::deleteJobAsync);\n \n         assertNull(response.getAcknowledged());\n-        assertNotNull(response.getTask());\n+\n+        final TaskId taskId = response.getTask();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41f303412acf5b392d8f1e359b1a8cb7d6eda5cd"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MjM4NTMz", "url": "https://github.com/elastic/elasticsearch/pull/64724#pullrequestreview-526238533", "createdAt": "2020-11-09T13:05:48Z", "commit": {"oid": "41f303412acf5b392d8f1e359b1a8cb7d6eda5cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d438d67e5b9c8593a1be01632aec1bf0d380023", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/6d438d67e5b9c8593a1be01632aec1bf0d380023", "committedDate": "2020-11-09T16:53:32Z", "message": "30s"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8416606fc85890b441dcd060317563bd3f57efe0", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/8416606fc85890b441dcd060317563bd3f57efe0", "committedDate": "2020-11-09T16:53:51Z", "message": "Merge branch 'master' into fix-64056"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1233, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}