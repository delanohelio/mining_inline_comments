{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNDc2NjMy", "number": 59817, "title": "Track backing indices in data streams stats from cluster state", "bodyText": "In some cases, if shard level results are incomplete in the data streams stats call, it is possible to get inaccurate counts of the number of backing indices, despite this data being accurate and available in the cluster state. If an index has no shards allocated due to a failure, or because it is closed (as I've seen on 7.x line), or if all shards of an index fail to return a result, then the shard level responses would contain none from the unallocated index, and thus the index would be missed during the stats aggregations.", "createdAt": "2020-07-17T21:36:55Z", "url": "https://github.com/elastic/elasticsearch/pull/59817", "merged": true, "mergeCommit": {"oid": "0e4f493ac4e539b9879640992b5aa29b109210d3"}, "closed": true, "closedAt": "2020-07-21T17:58:55Z", "author": {"login": "jbaiera"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc16FlsAH2gAyNDUxNDc2NjMyOmQzODQxOWEwMDE1M2JjOWM2MzMxMDAzNjE5MzBjYWQ3YWY5MTcyMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3HbCVgH2gAyNDUxNDc2NjMyOjFiZmJhZWRjZDc1Yzk5OTg0YzkwZWRhOGQ2NTE5MDk2MGMzNmVkZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d38419a00153bc9c633100361930cad7af917235", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/d38419a00153bc9c633100361930cad7af917235", "committedDate": "2020-07-17T20:44:40Z", "message": "Track backing indices from cluster state instead of shard responses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "470a2995744d528740a3936a9366b427992aba87", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/470a2995744d528740a3936a9366b427992aba87", "committedDate": "2020-07-17T21:03:07Z", "message": "Merge branch 'master' into fix-data-streams-backing-index-stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4488d08e419393ac4904f1e64afbbff0e15a05a7", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/4488d08e419393ac4904f1e64afbbff0e15a05a7", "committedDate": "2020-07-20T19:32:14Z", "message": "Ensure indices are closed properly before continuing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ece51be3815524ad4d7f279249aeeb8ff2dd1d9c", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/ece51be3815524ad4d7f279249aeeb8ff2dd1d9c", "committedDate": "2020-07-20T19:32:48Z", "message": "Merge branch 'master' into fix-data-streams-backing-index-stats"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTE1NzQw", "url": "https://github.com/elastic/elasticsearch/pull/59817#pullrequestreview-451915740", "createdAt": "2020-07-20T19:58:25Z", "commit": {"oid": "ece51be3815524ad4d7f279249aeeb8ff2dd1d9c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxOTo1ODoyNVrOG0dLJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxOTo1ODoyNVrOG0dLJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY1NzEyNQ==", "bodyText": "It's not the focus of this PR, but I do wonder if this could be replaced with IndexNameExpressionResolver::dataStreamNames since it needs to resolve only data stream names and not indices or aliases.", "url": "https://github.com/elastic/elasticsearch/pull/59817#discussion_r457657125", "createdAt": "2020-07-20T19:58:25Z", "author": {"login": "danhermann"}, "path": "x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/action/DataStreamsStatsTransportAction.java", "diffHunk": "@@ -94,18 +96,22 @@ protected ClusterBlockException checkRequestBlock(\n         return state.blocks().indicesBlockedException(ClusterBlockLevel.METADATA_READ, concreteIndices);\n     }\n \n-    @Override\n-    protected ShardsIterator shards(ClusterState clusterState, DataStreamsStatsAction.Request request, String[] concreteIndices) {\n+    private List<String> dataStreamNames(ClusterState clusterState, DataStreamsStatsAction.Request request) {\n         String[] requestIndices = request.indices();\n         if (requestIndices == null || requestIndices.length == 0) {\n             requestIndices = new String[] { \"*\" };\n         }\n-        List<String> abstractionNames = indexAbstractionResolver.resolveIndexAbstractions(\n+        return indexAbstractionResolver.resolveIndexAbstractions(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ece51be3815524ad4d7f279249aeeb8ff2dd1d9c"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daacd80f09b77144fc422f5f5b886ee3f46f8ccd", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/daacd80f09b77144fc422f5f5b886ee3f46f8ccd", "committedDate": "2020-07-20T20:54:36Z", "message": "Use dataStreamNames instead of resolveIndexAbstractions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2506e4c255800f0c171501b3f54d3c5bcfa419b8", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/2506e4c255800f0c171501b3f54d3c5bcfa419b8", "committedDate": "2020-07-21T00:13:58Z", "message": "Precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bfbaedcd75c99984c90eda8d65190960c36eddf", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/1bfbaedcd75c99984c90eda8d65190960c36eddf", "committedDate": "2020-07-21T14:50:47Z", "message": "Merge branch 'master' into fix-data-streams-backing-index-stats"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4208, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}