{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNTA3NzI3", "number": 54161, "title": "Clean up how pipeline aggs check for multi-bucket", "bodyText": "Pipeline aggregations like stats_bucket, sum_bucket, and\npercentiles_bucket only operate on buckets that have multiple buckets.\nThis adds support for those aggregations to geo_distance, ip_range,\nauto_date_histogram, and rare_terms.\nThis all happened because we used a marker interface to mark compatible\naggs, MultiBucketAggregationBuilder and it was fairly easy to forget\nto implement the interface.\nThis replaces the marker interface with an abstract method in\nAggregationBuilder, bucketCardinality which makes you return NONE,\nONE, or MANY. The bucket aggregations can check for MANY. At\nthis point ONE and NONE amount to about the same thing, but I\nsuspect that'll be a useful distinction when validating bucket sorts.\nCloses #53215", "createdAt": "2020-03-25T10:33:38Z", "url": "https://github.com/elastic/elasticsearch/pull/54161", "merged": true, "mergeCommit": {"oid": "a0f7c4a6a48cec30da37f0ac773485b1130e949c"}, "closed": true, "closedAt": "2020-03-28T15:47:02Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRE6_fgH2gAyMzkzNTA3NzI3OjdlMTRkZDU0YmRlNmI3Y2ViZTFkYzczZjJhMDVhMDY0OTE5YjcxY2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSD_mRAH2gAyMzkzNTA3NzI3OmIzZmNiYmE1MDg0NjlkODAyMjE4Mjk3OTY4M2I1ZGYyODQ1ZTNmNmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e14dd54bde6b7cebe1dc73f2a05a064919b71ce", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e14dd54bde6b7cebe1dc73f2a05a064919b71ce", "committedDate": "2020-03-25T10:26:51Z", "message": "Clean up how pipeline aggs check for multi-bucket\n\nPipeline aggregations like `stats_bucket`, `sum_bucket`, and\n`percentiles_bucket` only operate on buckets that have multiple buckets.\nThis adds support for those aggregations to `geo_distance`, `ip_range`,\n`auto_date_histogram`, and `rare_terms`.\n\nThis all happened because we used a marker interface to mark compatible\naggs, `MultiBucketAggregationBuilder` and it was fairly easy to forget\nto implement the interface.\n\nThis replaces the marker interface with an abstract method in\n`AggregationBuilder`, `bucketCardinality` which makes you return `NONE`,\n`ONE`, or `MANY`. The `bucket` aggregations can check for `MANY`. At\nthis point `ONE` and `NONE` amount to about the same thing, but I\nsuspect that'll be a useful distinction when validating bucket sorts.\n\nCloses #53215"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af76a7f415a958e151dbd40b0b5d7a441b9787b9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/af76a7f415a958e151dbd40b0b5d7a441b9787b9", "committedDate": "2020-03-25T13:32:54Z", "message": "Merge branch 'master' into agg_multi_validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "660e5acb59c3a2c28afb874d49e34afda2238885", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/660e5acb59c3a2c28afb874d49e34afda2238885", "committedDate": "2020-03-25T13:34:42Z", "message": "Update skips"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMDU3NTEy", "url": "https://github.com/elastic/elasticsearch/pull/54161#pullrequestreview-383057512", "createdAt": "2020-03-27T17:21:32Z", "commit": {"oid": "660e5acb59c3a2c28afb874d49e34afda2238885"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNzoyMTozMlrOF862bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNzoyMTozMlrOF862bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQyMzA4NA==", "bodyText": "Yeah... I wonder if we should set this to NONE for the time being, to prevent people from accidentally using pipelines on composite?  There's an issue flying around somewhere discussing it... but last time we chatted, we decided to punt on the decision.  Some pipelines are theoretically safe (bucket_script, operating on the bucket itself), but others like derivative are totally not kosher.", "url": "https://github.com/elastic/elasticsearch/pull/54161#discussion_r399423084", "createdAt": "2020-03-27T17:21:32Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/CompositeAggregationBuilder.java", "diffHunk": "@@ -147,6 +147,15 @@ public int size() {\n         return size;\n     }\n \n+    @Override\n+    public BucketCardinality bucketCardinality() {\n+        /*\n+         * This might be a bit of a lie though because you can't really use\n+         * pipeline aggregations on composite aggregations.\n+         */\n+        return BucketCardinality.MANY;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "660e5acb59c3a2c28afb874d49e34afda2238885"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93951b1eabd43444d398e6a57313b142507835ce", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/93951b1eabd43444d398e6a57313b142507835ce", "committedDate": "2020-03-27T19:53:05Z", "message": "Merge branch 'master' into agg_multi_validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97c642aeac3b99a06d2c3a1658a81533ff90af70", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/97c642aeac3b99a06d2c3a1658a81533ff90af70", "committedDate": "2020-03-28T11:51:47Z", "message": "Merge branch 'master' into agg_multi_validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3fcbba508469d8022182979683b5df2845e3f6d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/b3fcbba508469d8022182979683b5df2845e3f6d", "committedDate": "2020-03-28T11:55:54Z", "message": "Nope"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1728, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}