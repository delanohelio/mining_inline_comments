{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NjA4Nzcw", "number": 54407, "title": "Avoid holding onto bulk items until all completed", "bodyText": "Bulk requests currently keep a reference to all bulk item requests until every one of them has completed. There is no need to do so, however, and, in case of large bulks, can mean unnecessary holding onto memory that might be better used elsewhere. More so as different shard-level bulks can complete at different speeds, and one slow shard-level request should not require holding onto every other shard-level request.", "createdAt": "2020-03-30T12:10:32Z", "url": "https://github.com/elastic/elasticsearch/pull/54407", "merged": true, "mergeCommit": {"oid": "599aacff467d5e9bacb8d3f0cbc6a4d11d594774"}, "closed": true, "closedAt": "2020-03-31T14:18:23Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcStRTmgH2gAyMzk1NjA4NzcwOmFlYzE1NWM4YzA3NDdkNjhhZjJjY2U5NjNmMGVhNjZjMDVjMWM3NWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSz99MgFqTM4NDE3Nzc5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aec155c8c0747d68af2cce963f0ea66c05c1c75e", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/aec155c8c0747d68af2cce963f0ea66c05c1c75e", "committedDate": "2020-03-30T12:01:21Z", "message": "free memory for unused items"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzODAxMzQ5", "url": "https://github.com/elastic/elasticsearch/pull/54407#pullrequestreview-383801349", "createdAt": "2020-03-30T12:26:19Z", "commit": {"oid": "aec155c8c0747d68af2cce963f0ea66c05c1c75e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14002998aaee3c512325c2cd0792d51a21fcde88", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/14002998aaee3c512325c2cd0792d51a21fcde88", "committedDate": "2020-03-30T14:04:48Z", "message": "alt impl."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzODkxODk1", "url": "https://github.com/elastic/elasticsearch/pull/54407#pullrequestreview-383891895", "createdAt": "2020-03-30T14:08:47Z", "commit": {"oid": "14002998aaee3c512325c2cd0792d51a21fcde88"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDowODo0N1rOF9riww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDowODo0N1rOF9riww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyMDg2Nw==", "bodyText": "NIT: no need for this to be volatile I think, you're only ever touching it on the thread that nulls it out?", "url": "https://github.com/elastic/elasticsearch/pull/54407#discussion_r400220867", "createdAt": "2020-03-30T14:08:47Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -388,7 +388,7 @@ private long buildTookInMillis(long startTimeNanos) {\n      * */\n     private final class BulkOperation extends ActionRunnable<BulkResponse> {\n         private final Task task;\n-        private final BulkRequest bulkRequest;\n+        private volatile BulkRequest bulkRequest; // set to null once all requests are sent out", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14002998aaee3c512325c2cd0792d51a21fcde88"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b306001962072ac9948c231f4d163619f90774ea", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/b306001962072ac9948c231f4d163619f90774ea", "committedDate": "2020-03-30T14:11:07Z", "message": "no volatile for you"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MTc3Nzkz", "url": "https://github.com/elastic/elasticsearch/pull/54407#pullrequestreview-384177793", "createdAt": "2020-03-30T19:49:33Z", "commit": {"oid": "b306001962072ac9948c231f4d163619f90774ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1495, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}