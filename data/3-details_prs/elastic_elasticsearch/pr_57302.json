{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NjIzNDYx", "number": 57302, "title": "Ensure Joni warning are logged at debug", "bodyText": "When Joni, the regex engine that powers grok emits a warning it\ndoes so by default to System.err. System.err logs are all bucketed\ntogether in the server log at WARN level.  When Joni emits a warning,\nit can be extremely verbose, logging a message for each execution\nagain that pattern. For ingest node that means for every document\nthat is run that Grok filter. Fortunately, Joni provides a call\nback hook to push these warnings to a custom location.\nThis commit implements Joni's callback hook to push the Joni warning\nto the Elasticsearch server logger (logger.org.elasticsearch.ingest.common.GrokProcessor)\nat debug level. A warning will be emitted on processor creation at WARN\nlevel.  Generally these warning indicate a possible issue with\nthe regular expression. Since Grok is an abstraction on top of the regex,\nthese warning may not provide much value outside of a troubleshooting\nscenario.\nAdditionally, the documentation is updated with instructions for how\nto set the logger to debug level.\n===\nNotes:\nThis error is pretty easily reproduced:\nfor input\n[foo]\n\nand pattern\n.*\\[.*%{SPACE}*\\].*\n\nbefore this commit result in the following warning for every document run through the pattern.\n[2020-05-28T11:21:31,050][WARN ][stderr                   ] [runTask-0] regular expression has redundant nested repeat operator * /.*\\[.*(?:\\s*)*\\].*/\n\nPrior to 7.7 this message was incorrectly missed in our logs due to stderr not getting routed properly... that fix: #51569 now allows this error (as shown above) to persist in the ES server log possibly causing a lot of noise to the ES server log. This fix quiets that noise.", "createdAt": "2020-05-28T17:15:54Z", "url": "https://github.com/elastic/elasticsearch/pull/57302", "merged": true, "mergeCommit": {"oid": "f5910664b7b9e3a205d13a3d8575c033af4781fc"}, "closed": true, "closedAt": "2020-06-09T18:33:28Z", "author": {"login": "jakelandis"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclw_2iAH2gAyNDI0NjIzNDYxOjJmNjRlYjc0ZTE0Yjc0MTE5Nzk4YTY2MWMzMDBmNjNlZGFhMzUwZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpWO23gFqTQyNjU4MzI0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2f64eb74e14b74119798a661c300f63edaa350e9", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f64eb74e14b74119798a661c300f63edaa350e9", "committedDate": "2020-05-28T17:06:28Z", "message": "Ensure Joni warning are logged at debug\n\nWhen Joni, the regex engine that powers grok emits a warning it does so by default to System.err. System.err logs are all bucketed together in the server log at WARN level.  When Joni emits a warning, it can be extremely verbose, logging a message for each execution again that pattern. For ingest node that means for every document that is run that Grok filter. Fortunately, Joni provides a call back hook to push these warnings to a custom location.\n\nThis commit implements Joni's callback hook to push the Joni warning to the Elasticsearch server logger (logger.org.elasticsearch.grok.Grok)\nat debug level. Generally these warning indicate a possible issue with the regular expression. Since Grok is an abstraction on top of the regex, these warning may not provide much value outside of a troubleshooting scenario.\n\nAdditionally, the documentation is updated with instructions for how to set the logger to debug level."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMzI5MTA2", "url": "https://github.com/elastic/elasticsearch/pull/57302#pullrequestreview-420329106", "createdAt": "2020-05-28T17:18:41Z", "commit": {"oid": "2f64eb74e14b74119798a661c300f63edaa350e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoxODo0MVrOGb_FYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoxODo0MVrOGb_FYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5ODMwNg==", "bodyText": "^^ this line is only substantive change here. (it implements the callback so that it does not default to Std.err)", "url": "https://github.com/elastic/elasticsearch/pull/57302#discussion_r431998306", "createdAt": "2020-05-28T17:18:41Z", "author": {"login": "jakelandis"}, "path": "libs/grok/src/main/java/org/elasticsearch/grok/Grok.java", "diffHunk": "@@ -101,7 +106,8 @@ private Grok(Map<String, String> patternBank, String grokPattern, boolean namedC\n \n         String expression = toRegex(grokPattern);\n         byte[] expressionBytes = expression.getBytes(StandardCharsets.UTF_8);\n-        this.compiledExpression = new Regex(expressionBytes, 0, expressionBytes.length, Option.DEFAULT, UTF8Encoding.INSTANCE);\n+        this.compiledExpression = new Regex(expressionBytes, 0, expressionBytes.length, Option.DEFAULT, UTF8Encoding.INSTANCE,\n+            message -> logger.log(Level.DEBUG, message));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f64eb74e14b74119798a661c300f63edaa350e9"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNDE4MjUy", "url": "https://github.com/elastic/elasticsearch/pull/57302#pullrequestreview-420418252", "createdAt": "2020-05-28T19:22:47Z", "commit": {"oid": "2f64eb74e14b74119798a661c300f63edaa350e9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa0493a9e29ba7a57086afec68ffe7396039612f", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa0493a9e29ba7a57086afec68ffe7396039612f", "committedDate": "2020-05-31T21:14:53Z", "message": "Revert \"Ensure Joni warning are logged at debug\"\n\nThis reverts commit 2f64eb74e14b74119798a661c300f63edaa350e9."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4068dc49eefab95af52d786daef229c7cbad2808", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/4068dc49eefab95af52d786daef229c7cbad2808", "committedDate": "2020-05-31T21:58:09Z", "message": "use callback instead of direct log4j dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56437624d2016ae1b19a0491049e076eb4f1d7e9", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/56437624d2016ae1b19a0491049e076eb4f1d7e9", "committedDate": "2020-05-31T22:14:55Z", "message": "add on construction warning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTMyOTE0", "url": "https://github.com/elastic/elasticsearch/pull/57302#pullrequestreview-421532914", "createdAt": "2020-05-31T22:18:16Z", "commit": {"oid": "56437624d2016ae1b19a0491049e076eb4f1d7e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQyMjoxODoxNlrOGc7oCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQyMjoxODoxNlrOGc7oCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk5MDIxNw==", "bodyText": "this is kinda weird, but hopefully the comment explains why. This allows Joni warnings to be emitted at WARN level on PUT of the pipeline, but DEBUG for normal running.\nIf we put a WARN for normal running we can flood the log (and what this PR seeks to address)", "url": "https://github.com/elastic/elasticsearch/pull/57302#discussion_r432990217", "createdAt": "2020-05-31T22:18:16Z", "author": {"login": "jakelandis"}, "path": "modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/GrokProcessor.java", "diffHunk": "@@ -48,9 +51,12 @@\n         super(tag);\n         this.matchField = matchField;\n         this.matchPatterns = matchPatterns;\n-        this.grok = new Grok(patternBank, combinePatterns(matchPatterns, traceMatch), matcherWatchdog);\n+        this.grok = new Grok(patternBank, combinePatterns(matchPatterns, traceMatch), matcherWatchdog, logger::debug);\n         this.traceMatch = traceMatch;\n         this.ignoreMissing = ignoreMissing;\n+        // Joni warnings are only emitted on an attempt to match, and the warning emitted for every call to match which is too verbose\n+        // so here we emit a warning (if there is one) to the logfile at warn level on construction / processor creation.\n+        new Grok(patternBank, combinePatterns(matchPatterns, traceMatch), matcherWatchdog, logger::warn).match(\"___nomatch___\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56437624d2016ae1b19a0491049e076eb4f1d7e9"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eea02311bbca37638816f234f4c38c6d88d7ab02", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/eea02311bbca37638816f234f4c38c6d88d7ab02", "committedDate": "2020-05-31T22:19:04Z", "message": "fix import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDA3ODE4", "url": "https://github.com/elastic/elasticsearch/pull/57302#pullrequestreview-422007818", "createdAt": "2020-06-01T16:44:32Z", "commit": {"oid": "eea02311bbca37638816f234f4c38c6d88d7ab02"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjo0NDozM1rOGdR-_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjo0NToxN1rOGdSAfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1NjU0MQ==", "bodyText": "This is already included as a compileOnly dep through server, so it shouldn't be needed here?", "url": "https://github.com/elastic/elasticsearch/pull/57302#discussion_r433356541", "createdAt": "2020-06-01T16:44:33Z", "author": {"login": "rjernst"}, "path": "modules/ingest-common/build.gradle", "diffHunk": "@@ -27,6 +27,7 @@ dependencies {\n   compileOnly project(':modules:lang-painless')\n   compile project(':libs:elasticsearch-grok')\n   compile project(':libs:elasticsearch-dissect')\n+  compile \"org.apache.logging.log4j:log4j-api:${versions.log4j}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eea02311bbca37638816f234f4c38c6d88d7ab02"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1NjkyNQ==", "bodyText": "the license file should not be needed since the log4j jar is not actually bundled in this module; it is part of server", "url": "https://github.com/elastic/elasticsearch/pull/57302#discussion_r433356925", "createdAt": "2020-06-01T16:45:17Z", "author": {"login": "rjernst"}, "path": "modules/ingest-common/license/log4j-api-LICENSE.txt", "diffHunk": "@@ -0,0 +1,202 @@\n+\n+                                 Apache License", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eea02311bbca37638816f234f4c38c6d88d7ab02"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b2f269f49fe8e8c0d0f83392517f462543cb65b", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b2f269f49fe8e8c0d0f83392517f462543cb65b", "committedDate": "2020-06-08T17:32:28Z", "message": "remove compile dependency on log4jApi and remove license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e800e42cdd2659e85fad145562c9a098b2bf3fe", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e800e42cdd2659e85fad145562c9a098b2bf3fe", "committedDate": "2020-06-08T17:51:17Z", "message": "Merge branch 'master' into route_joni_warnings_to_debug_log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NTgzMjQ2", "url": "https://github.com/elastic/elasticsearch/pull/57302#pullrequestreview-426583246", "createdAt": "2020-06-08T20:11:07Z", "commit": {"oid": "9e800e42cdd2659e85fad145562c9a098b2bf3fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4131, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}