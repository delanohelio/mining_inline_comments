{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NTAzMzAy", "number": 58103, "title": "Allow follower indices to override leader settings", "bodyText": "Today when creating a follower index via the put follow API, or via an auto-follow pattern, it is not possible to specify settings overrides for the follower index. Instead, we copy all of the leader index settings to the follower. Yet, there are cases where a user would want some different settings on the follower index such as the number of replicas, or allocation settings. This commit addresses this by allowing the user to specify settings overrides when creating follower index via manual put follower calls, or via auto-follow patterns. Note that not all settings can be overrode (e.g., index.number_of_shards) so we also have detection that prevents attempting to override settings that must be equal between the leader and follow index. Note that we do not even allow specifying such settings in the overrides, even if they are specified to be equal between the leader and the follower index. Instead, the must be implicitly copied from the leader index, not explicitly set by the user.", "createdAt": "2020-06-15T12:20:22Z", "url": "https://github.com/elastic/elasticsearch/pull/58103", "merged": true, "mergeCommit": {"oid": "2e0274266f3f2af3c7b301df4980ab19892f4f82"}, "closed": true, "closedAt": "2020-06-18T14:55:18Z", "author": {"login": "jasontedor"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcq3NxDgH2gAyNDM0NTAzMzAyOmZiZDVlMjM1NGRjNjUxYTc5MWY5MmM2ZDkzNTczYTNmOWJhYzEzMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsVy-VAFqTQzMjkxMzg5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fbd5e2354dc651a791f92c6d93573a3f9bac131a", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/fbd5e2354dc651a791f92c6d93573a3f9bac131a", "committedDate": "2020-06-13T13:10:43Z", "message": "Allow follower indices to override leader settings\n\nToday when creating a follower index via the put follow API, or via an\nauto-follow pattern, it is not possible to specify settings overrides\nfor the follower index. Instead, we copy all of the leader index\nsettings to the follower. Yet, there are cases where a user would want\nsome different settings on the follower index such as the number of\nreplicas, or allocation settings. This commit addresses this by allowing\nthe user to specify settings overrides when creating follower index via\nmanual put follower calls, or via auto-follow patterns. Note that not\nall settings can be overrode (e.g., index.number_of_shards) so we also\nhave detection that prevents attempting to override settings that must\nbe equal between the leader and follow index. Note that we do not even\nallow specifying such settings in the overrides, even if they are\nspecified to be equal between the leader and the follower\nindex. Instead, the must be implicitly copied from the leader index, not\nexplicitly set by the user."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ec56ef8a06618372bf563508a4fee92d55925df", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ec56ef8a06618372bf563508a4fee92d55925df", "committedDate": "2020-06-15T12:22:48Z", "message": "Fix docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTkxODU0", "url": "https://github.com/elastic/elasticsearch/pull/58103#pullrequestreview-430591854", "createdAt": "2020-06-15T12:24:19Z", "commit": {"oid": "fbd5e2354dc651a791f92c6d93573a3f9bac131a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMjoyNDoxOVrOGjv3hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMjoyNDoxOVrOGjv3hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzNzYwNQ==", "bodyText": "This is the crux of the change, where the request settings are propagated to the follower index. The rest of this change is just ceremony around this, parsing the settings from the request, validating that they are not including any settings that must be propagated from the leader index, and tests around this.", "url": "https://github.com/elastic/elasticsearch/pull/58103#discussion_r440137605", "createdAt": "2020-06-15T12:24:19Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/TransportPutFollowAction.java", "diffHunk": "@@ -124,14 +125,28 @@ private void createFollowerIndex(\n             return;\n         }\n \n-        final Settings.Builder settingsBuilder = Settings.builder()\n+        final Settings replicatedRequestSettings = TransportResumeFollowAction.filter(request.getSettings());\n+        if (replicatedRequestSettings.isEmpty() == false) {\n+            final String message = String.format(\n+                Locale.ROOT,\n+                \"can not put follower index that could override leader settings %s\",\n+                replicatedRequestSettings\n+            );\n+            listener.onFailure(new IllegalArgumentException(message));\n+            return;\n+        }\n+\n+        final Settings overrideSettings = Settings.builder()\n             .put(IndexMetadata.SETTING_INDEX_PROVIDED_NAME, request.getFollowerIndex())\n-            .put(CcrSettings.CCR_FOLLOWING_INDEX_SETTING.getKey(), true);\n+            .put(CcrSettings.CCR_FOLLOWING_INDEX_SETTING.getKey(), true)\n+            .put(request.getSettings())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbd5e2354dc651a791f92c6d93573a3f9bac131a"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec1cb7cb71fae120c6a90d61aeb9ae1b6e5e48c4", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/ec1cb7cb71fae120c6a90d61aeb9ae1b6e5e48c4", "committedDate": "2020-06-15T12:25:15Z", "message": "Remove accidental line insertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ce822a82c31a7defc6f7a4cf943d43d146fe23b", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ce822a82c31a7defc6f7a4cf943d43d146fe23b", "committedDate": "2020-06-15T12:30:52Z", "message": "Fix some checkstyle violations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0295304fbf4e87cec0d304c4ce662f9820924ba", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/f0295304fbf4e87cec0d304c4ce662f9820924ba", "committedDate": "2020-06-15T12:37:10Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37ae0f17a41766bcff99523467d33441069ae14b", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/37ae0f17a41766bcff99523467d33441069ae14b", "committedDate": "2020-06-15T12:58:08Z", "message": "Do not write empty settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ac9c16ea25435ccc3c33875e4b70a8b96428a6", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/85ac9c16ea25435ccc3c33875e4b70a8b96428a6", "committedDate": "2020-06-15T13:35:35Z", "message": "Fix serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc2424634970d5ab101d5cac31b761020ce3dc0", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/adc2424634970d5ab101d5cac31b761020ce3dc0", "committedDate": "2020-06-16T01:22:27Z", "message": "Fix serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6077d11caef49ad2dafc592eae0c636e446d066", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/c6077d11caef49ad2dafc592eae0c636e446d066", "committedDate": "2020-06-17T21:29:05Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20ec09c98f07fa0665f555f94ea59756fa1f44e8", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/20ec09c98f07fa0665f555f94ea59756fa1f44e8", "committedDate": "2020-06-17T21:29:31Z", "message": "Merge remote-tracking branch 'elastic/master' into follower-index-settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2e2f07df5372b1f1da10dad6ac1245c7f821b38", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/c2e2f07df5372b1f1da10dad6ac1245c7f821b38", "committedDate": "2020-06-17T21:37:46Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dd60ca8c32e06793ad6e3bedee88ba4953a22ae", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/5dd60ca8c32e06793ad6e3bedee88ba4953a22ae", "committedDate": "2020-06-17T22:01:03Z", "message": "Merge branch 'master' into follower-index-settings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTEzODk2", "url": "https://github.com/elastic/elasticsearch/pull/58103#pullrequestreview-432913896", "createdAt": "2020-06-18T03:22:26Z", "commit": {"oid": "5dd60ca8c32e06793ad6e3bedee88ba4953a22ae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 681, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}