{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NTI3MTkx", "number": 55328, "title": "Add geo_bounds aggregation support for geo_shape", "bodyText": "This PR adds a new GeoShapeBoundsAggregator to the spatial plugin and registers it with the GeoShapeValuesSourceType.", "createdAt": "2020-04-16T16:42:14Z", "url": "https://github.com/elastic/elasticsearch/pull/55328", "merged": true, "mergeCommit": {"oid": "4431ed72da0d3b23647987cbc865576dbfa5f332"}, "closed": true, "closedAt": "2020-04-22T15:11:57Z", "author": {"login": "talevy"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYPUHqgH2gAyNDA0NTI3MTkxOmY5NTNlMWE2NzQxNDAwMGQ5Njc2MDZkMWM4YjM1ZjViZjA2ODI2YjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaImilgH2gAyNDA0NTI3MTkxOmE3NzY5MmM1MmQ2MzkzZGNhYzU1ZGZlMzA3OWNiMjUyMzUxZDI3MDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f953e1a67414000d967606d1c8b35f5bf06826b1", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/f953e1a67414000d967606d1c8b35f5bf06826b1", "committedDate": "2020-04-16T16:30:49Z", "message": "add geo_bounds for shapes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ef925cd78cf4cb4cba69b59527fe102d3282cc7", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ef925cd78cf4cb4cba69b59527fe102d3282cc7", "committedDate": "2020-04-17T00:49:24Z", "message": "add yaml tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MDk3MjAz", "url": "https://github.com/elastic/elasticsearch/pull/55328#pullrequestreview-395097203", "createdAt": "2020-04-17T01:04:55Z", "commit": {"oid": "1ef925cd78cf4cb4cba69b59527fe102d3282cc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMTowNDo1NVrOGG8ZbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMTowNDo1NVrOGG8ZbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNDE4OQ==", "bodyText": "@iverase I really dislike this hack, but I am also weary of editing GeoBoundsAggregator to be more generic just for this extension. I might take another pass at this tomorrow", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r409934189", "createdAt": "2020-04-17T01:04:55Z", "author": {"login": "talevy"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/aggregations/metrics/GeoShapeBoundsAggregator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.spatial.aggregations.metrics;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.elasticsearch.common.util.BigArrays;\n+import org.elasticsearch.search.aggregations.Aggregator;\n+import org.elasticsearch.search.aggregations.LeafBucketCollector;\n+import org.elasticsearch.search.aggregations.LeafBucketCollectorBase;\n+import org.elasticsearch.search.aggregations.metrics.GeoBoundsAggregator;\n+import org.elasticsearch.search.aggregations.support.ValuesSource;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.xpack.spatial.index.mapper.GeoShapeValuesSource;\n+import org.elasticsearch.xpack.spatial.index.mapper.MultiGeoShapeValues;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+public final class GeoShapeBoundsAggregator extends GeoBoundsAggregator {\n+    private final GeoShapeValuesSource valuesSource;\n+\n+    public GeoShapeBoundsAggregator(String name, SearchContext aggregationContext, Aggregator parent,\n+                             GeoShapeValuesSource valuesSource, boolean wrapLongitude, Map<String, Object> metadata) throws IOException {\n+        // the valuesSource as GeoPoint passed to GeoBoundsAggregator is not used\n+        super(name, aggregationContext, parent, ValuesSource.GeoPoint.EMPTY, wrapLongitude, metadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ef925cd78cf4cb4cba69b59527fe102d3282cc7"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MDk3NTYx", "url": "https://github.com/elastic/elasticsearch/pull/55328#pullrequestreview-395097561", "createdAt": "2020-04-17T01:06:07Z", "commit": {"oid": "1ef925cd78cf4cb4cba69b59527fe102d3282cc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMTowNjowN1rOGG8amw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMTowNjowN1rOGG8amw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkzNDQ5MQ==", "bodyText": "@iverase I also am investigating errors with this file. I am experiencing inconsistent behavior and investigating why, but I think most of what is tested here is good. would love to know what you think!", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r409934491", "createdAt": "2020-04-17T01:06:07Z", "author": {"login": "talevy"}, "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/upgraded_cluster/100_geo_shape_doc_values.yml", "diffHunk": "@@ -0,0 +1,76 @@\n+---", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ef925cd78cf4cb4cba69b59527fe102d3282cc7"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e723014e3ba15e503fdc8db89cb11b9feb256e2", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e723014e3ba15e503fdc8db89cb11b9feb256e2", "committedDate": "2020-04-17T01:13:32Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0491b5f6b4b896405980f3e1f366b987e3f5edd5", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/0491b5f6b4b896405980f3e1f366b987e3f5edd5", "committedDate": "2020-04-17T22:37:24Z", "message": "Merge remote-tracking branch 'elastic/master' into geo_bounds2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20ec976b71ead310369f1cf3dcb56c18d8bacb79", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/20ec976b71ead310369f1cf3dcb56c18d8bacb79", "committedDate": "2020-04-20T05:25:00Z", "message": "inherit from MetricsAggregator and fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MTQ4MTI2", "url": "https://github.com/elastic/elasticsearch/pull/55328#pullrequestreview-396148126", "createdAt": "2020-04-20T05:29:10Z", "commit": {"oid": "20ec976b71ead310369f1cf3dcb56c18d8bacb79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNToyOToxMFrOGIDtYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNToyOToxMFrOGIDtYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTEwMjU2MA==", "bodyText": "Hey @rjernst. I do not like what I'm doing here, but I did it to express my intention to\nhelp reach a better solution. I was a bit surprised that the rolling-upgrade tests were run on 8.0 -> 8.0\nand I do not want my tests to be run in this scenario. To achieve this I used skip: and this here.\nDo you think that my tests do not belong in qa/rolling-upgrade or do you think we need a clearer way to have tests that only run on true upgrade scenarios?", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r411102560", "createdAt": "2020-04-20T05:29:10Z", "author": {"login": "talevy"}, "path": "x-pack/qa/rolling-upgrade/build.gradle", "diffHunk": "@@ -142,6 +142,11 @@ for (Version bwcVersion : bwcVersions.wireCompatible) {\n     nonInputProperties.systemProperty('tests.rest.cluster', \"${-> testClusters.\"${baseName}\".allHttpSocketURI.join(\",\")}\")\n     nonInputProperties.systemProperty('tests.clustername', \"${-> testClusters.\"${baseName}\".getName()}\")\n     systemProperty 'tests.rest.suite', 'upgraded_cluster'\n+    if (bwcVersion.onOrAfter(\"8.0.0\")) {\n+      systemProperty 'tests.rest.blacklist', [\n+        'upgraded_cluster/100_geo_shape_doc_values/Test upgraded 8.x cluster with 8.x and 7.x geo_shape fields'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20ec976b71ead310369f1cf3dcb56c18d8bacb79"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2548f967d151ddcc1acb73baf290ae496fd8d113", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/2548f967d151ddcc1acb73baf290ae496fd8d113", "committedDate": "2020-04-20T22:08:58Z", "message": "revert the upgraded cluster skipping tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "968a0846cbf2f5bb8c15d484aa6f62362d4ed23f", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/968a0846cbf2f5bb8c15d484aa6f62362d4ed23f", "committedDate": "2020-04-20T23:14:33Z", "message": "Merge remote-tracking branch 'elastic/master' into geo_bounds2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3OTQ0Nzg4", "url": "https://github.com/elastic/elasticsearch/pull/55328#pullrequestreview-397944788", "createdAt": "2020-04-22T08:09:46Z", "commit": {"oid": "968a0846cbf2f5bb8c15d484aa6f62362d4ed23f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwODowOTo0N1rOGJpQ1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwODowOTo0N1rOGJpQ1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc2NjQyMA==", "bodyText": "Does it need to be public?", "url": "https://github.com/elastic/elasticsearch/pull/55328#discussion_r412766420", "createdAt": "2020-04-22T08:09:47Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/GeoBoundsAggregator.java", "diffHunk": "@@ -36,20 +36,20 @@\n import java.io.IOException;\n import java.util.Map;\n \n-final class GeoBoundsAggregator extends MetricsAggregator {\n+public class GeoBoundsAggregator extends MetricsAggregator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "968a0846cbf2f5bb8c15d484aa6f62362d4ed23f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4b30d44529596cb4212d45c957d1209ac5248f0", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4b30d44529596cb4212d45c957d1209ac5248f0", "committedDate": "2020-04-22T13:49:21Z", "message": "remove bwc tests to be merged in 7.x. fix scoping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a77692c52d6393dcac55dfe3079cb252351d2705", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/a77692c52d6393dcac55dfe3079cb252351d2705", "committedDate": "2020-04-22T13:49:27Z", "message": "Merge remote-tracking branch 'elastic/master' into geo_bounds2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3236, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}