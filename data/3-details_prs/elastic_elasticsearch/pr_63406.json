{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MjgyNzYx", "number": 63406, "title": "Remove MapperService searchAnalyzer and searchQuoteAnalyzer", "bodyText": "Everywhere that pulls the searchAnalyzer or searchQuoteAnalyzer from\nMapperService can either instead pull an analyzer from the MappedFieldType\nthey are working with (which will always have a valid analyzer set) or can\ncall MapperService#getIndexAnalyzers()#getDefaultSearchAnalyzer if they\nneed a default.", "createdAt": "2020-10-07T14:13:02Z", "url": "https://github.com/elastic/elasticsearch/pull/63406", "merged": true, "mergeCommit": {"oid": "3c752acfec9eedef988e21bab7f71643ca21cef8"}, "closed": true, "closedAt": "2020-10-08T12:20:28Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQNi89AH2gAyNDk5MjgyNzYxOjAzODNmOWFhMDcyMmY1MmJkMzQ3NTY5YmRkMmEwNThhZjIzZDk4Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQghUrgFqTUwNDcxNjI5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0383f9aa0722f52bd347569bdd2a058af23d9878", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/0383f9aa0722f52bd347569bdd2a058af23d9878", "committedDate": "2020-10-07T14:06:58Z", "message": "Remove QueryShardContext#searchAnalyzer and #searchQuoteAnalyzer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2436e0fc820f73597d0248cd6de73bf79e97789", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2436e0fc820f73597d0248cd6de73bf79e97789", "committedDate": "2020-10-07T14:09:12Z", "message": "Merge remote-tracking branch 'origin/master' into qsc/search-analyzer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13d56e777ee592c8d54cb4121a8888a536e0d0a5", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/13d56e777ee592c8d54cb4121a8888a536e0d0a5", "committedDate": "2020-10-07T14:20:52Z", "message": "compilation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzOTM2MDky", "url": "https://github.com/elastic/elasticsearch/pull/63406#pullrequestreview-503936092", "createdAt": "2020-10-07T14:23:30Z", "commit": {"oid": "13d56e777ee592c8d54cb4121a8888a536e0d0a5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDoyMzozMFrOHd189w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDoyNDoxNlrOHd1_Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA1NDcxMQ==", "bodyText": "This looks like it's changing behaviour, but is actually just detecting the error earlier - previously we would go through analysis and parsing and then blow up when calling one of the query factory methods on MappedFieldType.", "url": "https://github.com/elastic/elasticsearch/pull/63406#discussion_r501054711", "createdAt": "2020-10-07T14:23:30Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/search/MatchQuery.java", "diffHunk": "@@ -296,8 +297,13 @@ protected final Query parseInternal(Type type, String fieldName, MatchQueryBuild\n     }\n \n     protected Analyzer getAnalyzer(MappedFieldType fieldType, boolean quoted) {\n+        TextSearchInfo tsi = fieldType.getTextSearchInfo();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13d56e777ee592c8d54cb4121a8888a536e0d0a5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA1NTMxNQ==", "bodyText": "This change makes range query and fuzzy query behave the same way as prefix query", "url": "https://github.com/elastic/elasticsearch/pull/63406#discussion_r501055315", "createdAt": "2020-10-07T14:24:16Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/search/QueryStringQueryParser.java", "diffHunk": "@@ -417,11 +417,11 @@ protected Query getRangeQuery(String field, String part1, String part2,\n     private Query getRangeQuerySingle(String field, String part1, String part2,\n                                       boolean startInclusive, boolean endInclusive, QueryShardContext context) {\n         MappedFieldType currentFieldType = context.fieldMapper(field);\n-        if (currentFieldType == null) {\n+        if (currentFieldType == null || currentFieldType.getTextSearchInfo() == TextSearchInfo.NONE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13d56e777ee592c8d54cb4121a8888a536e0d0a5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2614e4817befd9cdeda7f00d2d98fdef5e0c96d", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2614e4817befd9cdeda7f00d2d98fdef5e0c96d", "committedDate": "2020-10-07T15:30:56Z", "message": "Remove MapperSearch searchAnalyzer and searchQuoteAnalyzer entirely"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf3b0c88b49bb2f6dacc294897af90af5be957d6", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/bf3b0c88b49bb2f6dacc294897af90af5be957d6", "committedDate": "2020-10-07T16:08:21Z", "message": "Merge remote-tracking branch 'origin/master' into qsc/search-analyzer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MTgxODk3", "url": "https://github.com/elastic/elasticsearch/pull/63406#pullrequestreview-504181897", "createdAt": "2020-10-07T19:02:12Z", "commit": {"oid": "bf3b0c88b49bb2f6dacc294897af90af5be957d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd6b6cf45d7df76070e23e5228ae5afaaf8e8f1", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/4bd6b6cf45d7df76070e23e5228ae5afaaf8e8f1", "committedDate": "2020-10-08T08:36:37Z", "message": "Merge remote-tracking branch 'origin/master' into qsc/search-analyzer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a97fc8dec7b621e13bdfec433ea99ff4691fafed", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a97fc8dec7b621e13bdfec433ea99ff4691fafed", "committedDate": "2020-10-08T09:11:55Z", "message": "Add test for MLT analyzer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjYwOTk4", "url": "https://github.com/elastic/elasticsearch/pull/63406#pullrequestreview-504660998", "createdAt": "2020-10-08T10:55:12Z", "commit": {"oid": "a97fc8dec7b621e13bdfec433ea99ff4691fafed"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDo1NToxMlrOHeZAjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMTowMzoxMlrOHeZRXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYyOTA2OQ==", "bodyText": "would you mind adding a comment about this? It seems to me that we cannot avoid checking this here otherwise the analyzers may be null, and as a result we would only fail earlier compared to before.", "url": "https://github.com/elastic/elasticsearch/pull/63406#discussion_r501629069", "createdAt": "2020-10-08T10:55:12Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/search/MatchQuery.java", "diffHunk": "@@ -296,8 +297,13 @@ protected final Query parseInternal(Type type, String fieldName, MatchQueryBuild\n     }\n \n     protected Analyzer getAnalyzer(MappedFieldType fieldType, boolean quoted) {\n+        TextSearchInfo tsi = fieldType.getTextSearchInfo();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA1NDcxMQ=="}, "originalCommit": {"oid": "13d56e777ee592c8d54cb4121a8888a536e0d0a5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzMTA4NA==", "bodyText": "I wonder if this may have implications: we treat a field that does not support term queries as an unmapped field? Shouldn't we rather throw exception?", "url": "https://github.com/elastic/elasticsearch/pull/63406#discussion_r501631084", "createdAt": "2020-10-08T10:58:54Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/search/QueryStringQueryParser.java", "diffHunk": "@@ -467,11 +467,11 @@ protected Query getFuzzyQuery(String field, String termStr, float minSimilarity)\n \n     private Query getFuzzyQuerySingle(String field, String termStr, int minSimilarity) throws ParseException {\n         MappedFieldType currentFieldType = context.getFieldType(field);\n-        if (currentFieldType == null) {\n+        if (currentFieldType == null || currentFieldType.getTextSearchInfo() == TextSearchInfo.NONE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a97fc8dec7b621e13bdfec433ea99ff4691fafed"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzMjEwMg==", "bodyText": "here we don't need a delegating analyzer because we don't do cross fields, but rather the field name that the analyzer will get as an argument is always the same field name which we the suggestions are pulled from?", "url": "https://github.com/elastic/elasticsearch/pull/63406#discussion_r501632102", "createdAt": "2020-10-08T11:00:50Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/search/suggest/SuggestionBuilder.java", "diffHunk": "@@ -306,7 +306,7 @@ protected void populateCommonFields(QueryShardContext context, SuggestionSearchC\n \n         MappedFieldType fieldType = context.getFieldType(field);\n         if (analyzer == null) {\n-            suggestionContext.setAnalyzer(context.getSearchAnalyzer(fieldType));\n+            suggestionContext.setAnalyzer(fieldType.getTextSearchInfo().getSearchAnalyzer());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a97fc8dec7b621e13bdfec433ea99ff4691fafed"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzMzM3NQ==", "bodyText": "wasn't this a useful test? Dont we lose coverage by removing this case? maybe though we should have a specific test for this scenario?", "url": "https://github.com/elastic/elasticsearch/pull/63406#discussion_r501633375", "createdAt": "2020-10-08T11:03:12Z", "author": {"login": "javanna"}, "path": "server/src/test/java/org/elasticsearch/search/suggest/AbstractSuggestionBuilderTestCase.java", "diffHunk": "@@ -165,10 +165,7 @@ public void testBuild() throws IOException {\n                     indexSettings);\n             MapperService mapperService = mock(MapperService.class);\n             ScriptService scriptService = mock(ScriptService.class);\n-            boolean fieldTypeSearchAnalyzerSet = randomBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a97fc8dec7b621e13bdfec433ea99ff4691fafed"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "323fe140b19fef8bba2a8581cd7b1642d52dc43d", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/323fe140b19fef8bba2a8581cd7b1642d52dc43d", "committedDate": "2020-10-08T11:28:35Z", "message": "add a comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzE2Mjk3", "url": "https://github.com/elastic/elasticsearch/pull/63406#pullrequestreview-504716297", "createdAt": "2020-10-08T12:13:23Z", "commit": {"oid": "323fe140b19fef8bba2a8581cd7b1642d52dc43d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4370, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}