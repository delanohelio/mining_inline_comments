{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NjUxNDA4", "number": 64008, "title": "Allow shrink in the hot phase for ILM policies", "bodyText": "Resolves #56377, very much along the same lines as #52073\nThis PR changes the shrink action to also be allowed in the hot phase after a rollover. As with #52073, a shrink in the hot phase MUST be accompanied by a rollover, and policy validation has been updated to check for this.\nReviewing commit-by-commit is best, there's a few relatively self-contained cleanup commits.", "createdAt": "2020-10-21T15:44:50Z", "url": "https://github.com/elastic/elasticsearch/pull/64008", "merged": true, "mergeCommit": {"oid": "9986cb80abc341640ede776378acf79a3de487fe"}, "closed": true, "closedAt": "2020-10-29T18:21:51Z", "author": {"login": "joegallo"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUvI6yAH2gAyNTA3NjUxNDA4OjdlNmU5MGYyZTllYzE0ZDkzYjU3M2Y0ODc0Mzg5ZjliODYwNjU0OGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXjVtagFqTUyMDQ5NzY0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e6e90f2e9ec14d93b573f4874389f9b8606548f", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e6e90f2e9ec14d93b573f4874389f9b8606548f", "committedDate": "2020-10-21T15:31:00Z", "message": "getOrDefault with null is just get"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a8b2d999f7f84a98c3df612c97221af3c47c9de", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a8b2d999f7f84a98c3df612c97221af3c47c9de", "committedDate": "2020-10-21T15:31:00Z", "message": "Map.of makes this immutable\n\nand lets us drop the static initializer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10219f0cd5ab599ee62f2973ff4a714d02ef5ed0", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/10219f0cd5ab599ee62f2973ff4a714d02ef5ed0", "committedDate": "2020-10-21T15:31:00Z", "message": "Refactor a bit\n\nto allow the possibility that there could be more actions in the hot\nphase that require rollover, rather than only just forcemerge."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd1bebc79e8d687b48e97294905e944a54420f11", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd1bebc79e8d687b48e97294905e944a54420f11", "committedDate": "2020-10-21T15:31:00Z", "message": "Allow shrink in the hot phase\n\nas long as there's an accompanying rollover."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7066d58b1b77316cb735f29ea0101b52f9691349", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/7066d58b1b77316cb735f29ea0101b52f9691349", "committedDate": "2020-10-21T15:31:00Z", "message": "Tidy up some whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "315f569ac20698d9fdf79056ec9a607b24b786f9", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/315f569ac20698d9fdf79056ec9a607b24b786f9", "committedDate": "2020-10-21T17:11:39Z", "message": "Update the shrink docs to match"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c40a1ab3abcd34aa41f6c7ce2fb368b8190d86c", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c40a1ab3abcd34aa41f6c7ce2fb368b8190d86c", "committedDate": "2020-10-21T17:27:48Z", "message": "Add a yamlRestTest for the changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe5c39094ee298b6fea76a014f8230b7f1364442", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe5c39094ee298b6fea76a014f8230b7f1364442", "committedDate": "2020-10-28T20:58:15Z", "message": "Minor refactor\n\nInline forceMergeActionWithCodec in place of its only caller."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a537aaf5a4245d4b38f269a99495d87a28f588d", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a537aaf5a4245d4b38f269a99495d87a28f588d", "committedDate": "2020-10-29T14:15:52Z", "message": "Add an integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5e71e6efb62c076091fcf224e544a1d126116b5", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/c5e71e6efb62c076091fcf224e544a1d126116b5", "committedDate": "2020-10-29T14:26:48Z", "message": "More docs changes\n\nMove forcemerge after rollover, since that's when it'll actually\nexecute. Add shrink to the hot phase. Migrate was missing in the warm\nand cold phases, fix that."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6910ceb29900abe3563ac9195114188b636bf10b", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/6910ceb29900abe3563ac9195114188b636bf10b", "committedDate": "2020-10-29T14:35:29Z", "message": "Merge branch 'master' into add-shrink-to-hot-phase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d9c307e63a94c4eaca1a9e8996459e1b591b869", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d9c307e63a94c4eaca1a9e8996459e1b591b869", "committedDate": "2020-10-29T16:41:02Z", "message": "Oops, drop an extraneous assertOK"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5ODg2Nzg0", "url": "https://github.com/elastic/elasticsearch/pull/64008#pullrequestreview-519886784", "createdAt": "2020-10-29T17:03:22Z", "commit": {"oid": "2d9c307e63a94c4eaca1a9e8996459e1b591b869"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzowMzoyMlrOHql0sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzowNzowMVrOHql-Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyMTkzNg==", "bodyText": "This will not compile on backport (which is fine, just wanted to let you know since you asked about this previously)", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514421936", "createdAt": "2020-10-29T17:03:22Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/TimeseriesLifecycleType.java", "diffHunk": "@@ -50,14 +50,13 @@\n     static final Set<String> VALID_WARM_ACTIONS = Sets.newHashSet(ORDERED_VALID_WARM_ACTIONS);\n     static final Set<String> VALID_COLD_ACTIONS = Sets.newHashSet(ORDERED_VALID_COLD_ACTIONS);\n     static final Set<String> VALID_DELETE_ACTIONS = Sets.newHashSet(ORDERED_VALID_DELETE_ACTIONS);\n-    private static final Map<String, Set<String>> ALLOWED_ACTIONS = new HashMap<>();\n+    private static final Map<String, Set<String>> ALLOWED_ACTIONS = Map.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9c307e63a94c4eaca1a9e8996459e1b591b869"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQyNDM1OA==", "bodyText": "This change is a little out of the scope of this PR, you did discover that we're missing a method below this one that has\npublic void testForceMergeActionWithCompressionCodec() throws Exception {\n    forceMergeActionWithCodec(\"best_compression\");\n}\nSo I think we should not apply this change in this PR", "url": "https://github.com/elastic/elasticsearch/pull/64008#discussion_r514424358", "createdAt": "2020-10-29T17:07:01Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/ilm/qa/multi-node/src/javaRestTest/java/org/elasticsearch/xpack/ilm/TimeSeriesLifecycleActionsIT.java", "diffHunk": "@@ -467,10 +467,6 @@ public void forceMergeActionWithCodec(String codec) throws Exception {\n         expectThrows(ResponseException.class, () -> indexDocument(client(), index));\n     }\n \n-    public void testForceMergeAction() throws Exception {\n-        forceMergeActionWithCodec(null);\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d9c307e63a94c4eaca1a9e8996459e1b591b869"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "563720a2d0030f9592ef81a369d5effa4592d6b5", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/563720a2d0030f9592ef81a369d5effa4592d6b5", "committedDate": "2020-10-29T17:25:13Z", "message": "Revert \"Minor refactor\"\n\nThis reverts commit fe5c39094ee298b6fea76a014f8230b7f1364442."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDk3NjQ5", "url": "https://github.com/elastic/elasticsearch/pull/64008#pullrequestreview-520497649", "createdAt": "2020-10-30T09:27:53Z", "commit": {"oid": "563720a2d0030f9592ef81a369d5effa4592d6b5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1073, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}