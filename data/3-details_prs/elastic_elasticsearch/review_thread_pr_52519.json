{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3MjM5OTA3", "number": 52519, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjo0MTozM1rODzELDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTowODo1MVrOEQ9a7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODcyMzM1OnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjo0MTozM1rOGHfGRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjo0Mzo1OFrOGIdx7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMjcyNg==", "bodyText": "How large is this output? This is going to need to be included in the \"docker context\" that we publish. I suspect it's within a reasonable size.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r410502726", "createdAt": "2020-04-17T22:41:33Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"\n+  def platform = \"aarch64\".equals(architecture) ? 'linux/arm64' : 'linux/amd64'\n+  def image = \"aarch64\".equals(architecture) ? 'arm64v8/centos:7' : 'centos:7'\n+\n+  final Task buildDockerBaseImageTask = task(taskName(\"build\", architecture, oss, \"DockerBaseImage\"), type: LoggedExec) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI1OTU5Mg==", "bodyText": "distribution:docker:buildDockerBaseImage gives me a 17MB, but then I realised I can gzip it down to 7.3MB and everything still works.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r411259592", "createdAt": "2020-04-20T10:14:10Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"\n+  def platform = \"aarch64\".equals(architecture) ? 'linux/arm64' : 'linux/amd64'\n+  def image = \"aarch64\".equals(architecture) ? 'arm64v8/centos:7' : 'centos:7'\n+\n+  final Task buildDockerBaseImageTask = task(taskName(\"build\", architecture, oss, \"DockerBaseImage\"), type: LoggedExec) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMjcyNg=="}, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUyOTcwOA==", "bodyText": "No need to gzip anything. Gradle gzips task outputs prior to sending to the cache.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r411529708", "createdAt": "2020-04-20T16:43:58Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"\n+  def platform = \"aarch64\".equals(architecture) ? 'linux/arm64' : 'linux/amd64'\n+  def image = \"aarch64\".equals(architecture) ? 'arm64v8/centos:7' : 'centos:7'\n+\n+  final Task buildDockerBaseImageTask = task(taskName(\"build\", architecture, oss, \"DockerBaseImage\"), type: LoggedExec) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMjcyNg=="}, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODcyNjI0OnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjo0MzoyMVrOGHfIDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDoxNDo1OFrOGINUtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMzE4Mg==", "bodyText": "We need to track platform and image as inputs to this task as well. Otherwise x86 executions could reuse arm outputs and vice versa.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r410503182", "createdAt": "2020-04-17T22:43:21Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"\n+  def platform = \"aarch64\".equals(architecture) ? 'linux/arm64' : 'linux/amd64'\n+  def image = \"aarch64\".equals(architecture) ? 'arm64v8/centos:7' : 'centos:7'\n+\n+  final Task buildDockerBaseImageTask = task(taskName(\"build\", architecture, oss, \"DockerBaseImage\"), type: LoggedExec) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MDA4NQ==", "bodyText": "I've added tracking for these.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r411260085", "createdAt": "2020-04-20T10:14:58Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"\n+  def platform = \"aarch64\".equals(architecture) ? 'linux/arm64' : 'linux/amd64'\n+  def image = \"aarch64\".equals(architecture) ? 'arm64v8/centos:7' : 'centos:7'\n+\n+  final Task buildDockerBaseImageTask = task(taskName(\"build\", architecture, oss, \"DockerBaseImage\"), type: LoggedExec) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMzE4Mg=="}, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODcyODg2OnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjo0NDo1NVrOGHfJnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDoxNToxMFrOGINVEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMzU4MQ==", "bodyText": "For this to have good cache reuse we'll want to add a path sensitivity attribute here. Otherwise the absolute path to this file will be included in the cache key, meaning something as innocuous as a different checkout directory will mean a cache miss. Here's an example usage: \n  \n    \n      elasticsearch/buildSrc/build.gradle\n    \n    \n         Line 237\n      in\n      b2c9d68\n    \n    \n    \n    \n\n        \n          \n           inputs.dir(file(\"src/testKit\")).withPropertyName(\"testkit dir\").withPathSensitivity(PathSensitivity.RELATIVE)", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r410503581", "createdAt": "2020-04-17T22:44:55Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"\n+  def platform = \"aarch64\".equals(architecture) ? 'linux/arm64' : 'linux/amd64'\n+  def image = \"aarch64\".equals(architecture) ? 'arm64v8/centos:7' : 'centos:7'\n+\n+  final Task buildDockerBaseImageTask = task(taskName(\"build\", architecture, oss, \"DockerBaseImage\"), type: LoggedExec) {\n+    inputs.file(installer)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MDE3OQ==", "bodyText": "Thanks for the pointer, I've added that.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r411260179", "createdAt": "2020-04-20T10:15:10Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"\n+  def platform = \"aarch64\".equals(architecture) ? 'linux/arm64' : 'linux/amd64'\n+  def image = \"aarch64\".equals(architecture) ? 'arm64v8/centos:7' : 'centos:7'\n+\n+  final Task buildDockerBaseImageTask = task(taskName(\"build\", architecture, oss, \"DockerBaseImage\"), type: LoggedExec) {\n+    inputs.file(installer)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMzU4MQ=="}, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODczMDMwOnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjo0NTo0N1rOGHfKfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDoxNTo0M1rOGINWRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMzgwNg==", "bodyText": "Let's just use ${buildDir} instead of ${projectDir}/build.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r410503806", "createdAt": "2020-04-17T22:45:47Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"\n+  def platform = \"aarch64\".equals(architecture) ? 'linux/arm64' : 'linux/amd64'\n+  def image = \"aarch64\".equals(architecture) ? 'arm64v8/centos:7' : 'centos:7'\n+\n+  final Task buildDockerBaseImageTask = task(taskName(\"build\", architecture, oss, \"DockerBaseImage\"), type: LoggedExec) {\n+    inputs.file(installer)\n+    outputs.file(outputPath)\n+    outputs.cacheIf({ true })\n+    executable 'docker'\n+    args 'run', '--rm', '-t',\n+      '-v', \"${projectDir}/build:/build\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MDQ4NA==", "bodyText": "Changed to ${buildDir}, I don't know why I didn't do that in the first place \ud83e\udd37\u200d\u2642\ufe0f", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r411260484", "createdAt": "2020-04-20T10:15:43Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"\n+  def platform = \"aarch64\".equals(architecture) ? 'linux/arm64' : 'linux/amd64'\n+  def image = \"aarch64\".equals(architecture) ? 'arm64v8/centos:7' : 'centos:7'\n+\n+  final Task buildDockerBaseImageTask = task(taskName(\"build\", architecture, oss, \"DockerBaseImage\"), type: LoggedExec) {\n+    inputs.file(installer)\n+    outputs.file(outputPath)\n+    outputs.cacheIf({ true })\n+    executable 'docker'\n+    args 'run', '--rm', '-t',\n+      '-v', \"${projectDir}/build:/build\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMzgwNg=="}, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODczMTE5OnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjo0NjozMlrOGHfLHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDoxNTo1MFrOGINWcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMzk2NQ==", "bodyText": "Let's use buildDir here.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r410503965", "createdAt": "2020-04-17T22:46:32Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MDUyOQ==", "bodyText": "Changed.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r411260529", "createdAt": "2020-04-20T10:15:50Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -174,10 +189,32 @@ task integTest(type: Test) {\n \n check.dependsOn integTest\n \n+void addBuildDockerBaseImage(final String architecture, final boolean oss) {\n+  def installer = \"${projectDir}/src/docker/bin/install-baseimage.sh\"\n+  def outputFile = baseImageFilename(architecture)\n+  def outputPath = \"${projectDir}/build/${outputFile}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwMzk2NQ=="}, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODc1MTI2OnYy", "diffSide": "RIGHT", "path": "distribution/docker/src/docker/bin/curl", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjo1OToxN1rOGHfXPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMDoxOToyMVrOGIl--g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzA3MQ==", "bodyText": "I wonder if this is really strictly required and if it's possible this might throw things off that try and detect the existence of utility via things like hash curl and such.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r410507071", "createdAt": "2020-04-17T22:59:17Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/src/docker/bin/curl", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTU4NA==", "bodyText": "The script won't execute without a shebang, and I don't see how it can throw off anyone else's scripting unless they're doing something daft like file /usr/bin/curl (and file isn't present in the final image anyway).", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r411261584", "createdAt": "2020-04-20T10:17:29Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/src/docker/bin/curl", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/sh", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzA3MQ=="}, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzMDMwMg==", "bodyText": "If we know wget has funny behavior do we still want to go this route of pointing them at that tool?", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r411530302", "createdAt": "2020-04-20T16:44:48Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/src/docker/bin/curl", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/sh", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzA3MQ=="}, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY2NDEyMg==", "bodyText": "I oscillated about this, but in the end I removed it. If people expect to find curl, I'd rather it be missing and they complained. Then maybe we have chance to learn more about what they're trying to do.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r411664122", "createdAt": "2020-04-20T20:19:21Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/src/docker/bin/curl", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/bin/sh", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzA3MQ=="}, "originalCommit": {"oid": "b67bb4eebe7e6131c14e3c2c1b79f682599cebe4"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDQ0MzQ5OnYy", "diffSide": "RIGHT", "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1NzowM1rOGQiXCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1NzowM1rOGQiXCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MzM1NA==", "bodyText": "Is this comment still valid?", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r419993354", "createdAt": "2020-05-05T09:57:03Z", "author": {"login": "dliappis"}, "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "diffHunk": "@@ -0,0 +1,149 @@\n+#!/usr/bin/env bash\n+#\n+# Create a basic filesystem that can be used to create a Docker images that\n+# don't require a full distro.\n+#\n+# Originally from:\n+#\u00a0\n+# https://github.com/moby/moby/blob/master/contrib/mkimage-yum.sh\n+\n+set -e\n+\n+usage() {\n+    cat <<EOOPTS\n+$(basename $0) <platform> <output_file>\n+EOOPTS\n+    exit 1\n+}\n+\n+platform=\"$1\"\n+output_file=\"$2\"\n+\n+if [[ -z $platform ]]; then\n+    usage\n+fi\n+\n+if [[ -z \"$output_file\" ]]; then\n+    usage\n+fi\n+\n+# Start off with an up-to-date system\n+yum update --setopt=tsflags=nodocs -y\n+\n+# Create a temporary directory into which we will install files\n+target=$(mktemp -d --tmpdir $(basename $0).XXXXXX)\n+\n+set -x\n+\n+#\u00a0Create required devices\n+mkdir -m 755 \"$target\"/dev\n+mknod -m 600 \"$target\"/dev/console c 5 1\n+mknod -m 600 \"$target\"/dev/initctl p\n+mknod -m 666 \"$target\"/dev/full c 1 7\n+mknod -m 666 \"$target\"/dev/null c 1 3\n+mknod -m 666 \"$target\"/dev/ptmx c 5 2\n+mknod -m 666 \"$target\"/dev/random c 1 8\n+mknod -m 666 \"$target\"/dev/tty c 5 0\n+mknod -m 666 \"$target\"/dev/tty0 c 4 0\n+mknod -m 666 \"$target\"/dev/urandom c 1 9\n+mknod -m 666 \"$target\"/dev/zero c 1 5\n+\n+# Install files. We attempt to install a headless Java distro, and exclude a\n+# number of unnecessary dependencies. In so doing, we also filter out Java itself,\n+#\u00a0but since Elasticsearch ships its own JDK, with its own libs, that isn't a problem\n+# and in fact is what we want.\n+#\n+# Note that we also skip coreutils, as it pulls in all kinds of stuff that\n+# we don't want.\n+#\n+# Note that I haven't yet verified that these dependencies are, in fact, unnecessary.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1603735e0ea53c96600e9e1c8d6247c903a84c"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDQ0Nzg3OnYy", "diffSide": "RIGHT", "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1ODoxNlrOGQiZnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1ODoxNlrOGQiZnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5NDAxMw==", "bodyText": "(extreme) nit: no period at the end of sentence but you have period at the bullets for pigz and tini.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r419994013", "createdAt": "2020-05-05T09:58:16Z", "author": {"login": "dliappis"}, "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "diffHunk": "@@ -0,0 +1,149 @@\n+#!/usr/bin/env bash\n+#\n+# Create a basic filesystem that can be used to create a Docker images that\n+# don't require a full distro.\n+#\n+# Originally from:\n+#\u00a0\n+# https://github.com/moby/moby/blob/master/contrib/mkimage-yum.sh\n+\n+set -e\n+\n+usage() {\n+    cat <<EOOPTS\n+$(basename $0) <platform> <output_file>\n+EOOPTS\n+    exit 1\n+}\n+\n+platform=\"$1\"\n+output_file=\"$2\"\n+\n+if [[ -z $platform ]]; then\n+    usage\n+fi\n+\n+if [[ -z \"$output_file\" ]]; then\n+    usage\n+fi\n+\n+# Start off with an up-to-date system\n+yum update --setopt=tsflags=nodocs -y\n+\n+# Create a temporary directory into which we will install files\n+target=$(mktemp -d --tmpdir $(basename $0).XXXXXX)\n+\n+set -x\n+\n+#\u00a0Create required devices\n+mkdir -m 755 \"$target\"/dev\n+mknod -m 600 \"$target\"/dev/console c 5 1\n+mknod -m 600 \"$target\"/dev/initctl p\n+mknod -m 666 \"$target\"/dev/full c 1 7\n+mknod -m 666 \"$target\"/dev/null c 1 3\n+mknod -m 666 \"$target\"/dev/ptmx c 5 2\n+mknod -m 666 \"$target\"/dev/random c 1 8\n+mknod -m 666 \"$target\"/dev/tty c 5 0\n+mknod -m 666 \"$target\"/dev/tty0 c 4 0\n+mknod -m 666 \"$target\"/dev/urandom c 1 9\n+mknod -m 666 \"$target\"/dev/zero c 1 5\n+\n+# Install files. We attempt to install a headless Java distro, and exclude a\n+# number of unnecessary dependencies. In so doing, we also filter out Java itself,\n+#\u00a0but since Elasticsearch ships its own JDK, with its own libs, that isn't a problem\n+# and in fact is what we want.\n+#\n+# Note that we also skip coreutils, as it pulls in all kinds of stuff that\n+# we don't want.\n+#\n+# Note that I haven't yet verified that these dependencies are, in fact, unnecessary.\n+#\n+# We also include some utilities that we ship with the image.\n+#\n+#   * `nc` is useful for checking network issues", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1603735e0ea53c96600e9e1c8d6247c903a84c"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDQ0OTQ3OnYy", "diffSide": "RIGHT", "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1ODo0MFrOGQiahw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNToyMjozOFrOGSD0Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5NDI0Nw==", "bodyText": "what is upzip? If it's a typo for unzip it ought to fail due to set -e above.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r419994247", "createdAt": "2020-05-05T09:58:40Z", "author": {"login": "dliappis"}, "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "diffHunk": "@@ -0,0 +1,149 @@\n+#!/usr/bin/env bash\n+#\n+# Create a basic filesystem that can be used to create a Docker images that\n+# don't require a full distro.\n+#\n+# Originally from:\n+#\u00a0\n+# https://github.com/moby/moby/blob/master/contrib/mkimage-yum.sh\n+\n+set -e\n+\n+usage() {\n+    cat <<EOOPTS\n+$(basename $0) <platform> <output_file>\n+EOOPTS\n+    exit 1\n+}\n+\n+platform=\"$1\"\n+output_file=\"$2\"\n+\n+if [[ -z $platform ]]; then\n+    usage\n+fi\n+\n+if [[ -z \"$output_file\" ]]; then\n+    usage\n+fi\n+\n+# Start off with an up-to-date system\n+yum update --setopt=tsflags=nodocs -y\n+\n+# Create a temporary directory into which we will install files\n+target=$(mktemp -d --tmpdir $(basename $0).XXXXXX)\n+\n+set -x\n+\n+#\u00a0Create required devices\n+mkdir -m 755 \"$target\"/dev\n+mknod -m 600 \"$target\"/dev/console c 5 1\n+mknod -m 600 \"$target\"/dev/initctl p\n+mknod -m 666 \"$target\"/dev/full c 1 7\n+mknod -m 666 \"$target\"/dev/null c 1 3\n+mknod -m 666 \"$target\"/dev/ptmx c 5 2\n+mknod -m 666 \"$target\"/dev/random c 1 8\n+mknod -m 666 \"$target\"/dev/tty c 5 0\n+mknod -m 666 \"$target\"/dev/tty0 c 4 0\n+mknod -m 666 \"$target\"/dev/urandom c 1 9\n+mknod -m 666 \"$target\"/dev/zero c 1 5\n+\n+# Install files. We attempt to install a headless Java distro, and exclude a\n+# number of unnecessary dependencies. In so doing, we also filter out Java itself,\n+#\u00a0but since Elasticsearch ships its own JDK, with its own libs, that isn't a problem\n+# and in fact is what we want.\n+#\n+# Note that we also skip coreutils, as it pulls in all kinds of stuff that\n+# we don't want.\n+#\n+# Note that I haven't yet verified that these dependencies are, in fact, unnecessary.\n+#\n+# We also include some utilities that we ship with the image.\n+#\n+#   * `nc` is useful for checking network issues\n+#   * `zip` and `unzip` are for working with bundles\n+#   * `pigz` is used for compressing large heaps dumps, and is considerably faster than `gzip` for this task.\n+#   * `tini` is a tiny but valid init for containers. This is used to cleanly control how ES and any child processes are shut down.\n+#\n+yum --installroot=\"$target\" --releasever=/ --setopt=tsflags=nodocs \\\n+  --setopt=group_package_types=mandatory -y  \\\n+  -x copy-jdk-configs -x cups-libs -x javapackages-tools -x alsa-lib -x freetype -x libjpeg -x libjpeg-turbo \\\n+  -x coreutils \\\n+  --skip-broken \\\n+  install \\\n+    java-latest-openjdk-headless \\\n+    bash nc zip upzip pigz", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1603735e0ea53c96600e9e1c8d6247c903a84c"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU5MDA5NA==", "bodyText": "I think --skip-broken stops the script from failing. It should, of course, be unzip.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r421590094", "createdAt": "2020-05-07T15:22:38Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "diffHunk": "@@ -0,0 +1,149 @@\n+#!/usr/bin/env bash\n+#\n+# Create a basic filesystem that can be used to create a Docker images that\n+# don't require a full distro.\n+#\n+# Originally from:\n+#\u00a0\n+# https://github.com/moby/moby/blob/master/contrib/mkimage-yum.sh\n+\n+set -e\n+\n+usage() {\n+    cat <<EOOPTS\n+$(basename $0) <platform> <output_file>\n+EOOPTS\n+    exit 1\n+}\n+\n+platform=\"$1\"\n+output_file=\"$2\"\n+\n+if [[ -z $platform ]]; then\n+    usage\n+fi\n+\n+if [[ -z \"$output_file\" ]]; then\n+    usage\n+fi\n+\n+# Start off with an up-to-date system\n+yum update --setopt=tsflags=nodocs -y\n+\n+# Create a temporary directory into which we will install files\n+target=$(mktemp -d --tmpdir $(basename $0).XXXXXX)\n+\n+set -x\n+\n+#\u00a0Create required devices\n+mkdir -m 755 \"$target\"/dev\n+mknod -m 600 \"$target\"/dev/console c 5 1\n+mknod -m 600 \"$target\"/dev/initctl p\n+mknod -m 666 \"$target\"/dev/full c 1 7\n+mknod -m 666 \"$target\"/dev/null c 1 3\n+mknod -m 666 \"$target\"/dev/ptmx c 5 2\n+mknod -m 666 \"$target\"/dev/random c 1 8\n+mknod -m 666 \"$target\"/dev/tty c 5 0\n+mknod -m 666 \"$target\"/dev/tty0 c 4 0\n+mknod -m 666 \"$target\"/dev/urandom c 1 9\n+mknod -m 666 \"$target\"/dev/zero c 1 5\n+\n+# Install files. We attempt to install a headless Java distro, and exclude a\n+# number of unnecessary dependencies. In so doing, we also filter out Java itself,\n+#\u00a0but since Elasticsearch ships its own JDK, with its own libs, that isn't a problem\n+# and in fact is what we want.\n+#\n+# Note that we also skip coreutils, as it pulls in all kinds of stuff that\n+# we don't want.\n+#\n+# Note that I haven't yet verified that these dependencies are, in fact, unnecessary.\n+#\n+# We also include some utilities that we ship with the image.\n+#\n+#   * `nc` is useful for checking network issues\n+#   * `zip` and `unzip` are for working with bundles\n+#   * `pigz` is used for compressing large heaps dumps, and is considerably faster than `gzip` for this task.\n+#   * `tini` is a tiny but valid init for containers. This is used to cleanly control how ES and any child processes are shut down.\n+#\n+yum --installroot=\"$target\" --releasever=/ --setopt=tsflags=nodocs \\\n+  --setopt=group_package_types=mandatory -y  \\\n+  -x copy-jdk-configs -x cups-libs -x javapackages-tools -x alsa-lib -x freetype -x libjpeg -x libjpeg-turbo \\\n+  -x coreutils \\\n+  --skip-broken \\\n+  install \\\n+    java-latest-openjdk-headless \\\n+    bash nc zip upzip pigz", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5NDI0Nw=="}, "originalCommit": {"oid": "2d1603735e0ea53c96600e9e1c8d6247c903a84c"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDQ5MzcyOnYy", "diffSide": "RIGHT", "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDoxMTo0OVrOGQi1zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDoxMTo0OVrOGQi1zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwMTIzMA==", "bodyText": "At some point there will be bugs with these utilities (busybox, or tini) as well.\nI think it's hard to keep track of the versions as they are hard coded here.\nWhat if we specify such versions as readonly vars at the top of this shell script so that it's easier to track the versions and do future updates?\nexample after\n#!/usr/bin/env bash\n...\n\nthen\ndeclare -r BUSYBOX_VERSION=\"1.31.0\"\ndeclare -r TINI_VERSION=\"0.19.0\"", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r420001230", "createdAt": "2020-05-05T10:11:49Z", "author": {"login": "dliappis"}, "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "diffHunk": "@@ -0,0 +1,149 @@\n+#!/usr/bin/env bash\n+#\n+# Create a basic filesystem that can be used to create a Docker images that\n+# don't require a full distro.\n+#\n+# Originally from:\n+#\u00a0\n+# https://github.com/moby/moby/blob/master/contrib/mkimage-yum.sh\n+\n+set -e\n+\n+usage() {\n+    cat <<EOOPTS\n+$(basename $0) <platform> <output_file>\n+EOOPTS\n+    exit 1\n+}\n+\n+platform=\"$1\"\n+output_file=\"$2\"\n+\n+if [[ -z $platform ]]; then\n+    usage\n+fi\n+\n+if [[ -z \"$output_file\" ]]; then\n+    usage\n+fi\n+\n+# Start off with an up-to-date system\n+yum update --setopt=tsflags=nodocs -y\n+\n+# Create a temporary directory into which we will install files\n+target=$(mktemp -d --tmpdir $(basename $0).XXXXXX)\n+\n+set -x\n+\n+#\u00a0Create required devices\n+mkdir -m 755 \"$target\"/dev\n+mknod -m 600 \"$target\"/dev/console c 5 1\n+mknod -m 600 \"$target\"/dev/initctl p\n+mknod -m 666 \"$target\"/dev/full c 1 7\n+mknod -m 666 \"$target\"/dev/null c 1 3\n+mknod -m 666 \"$target\"/dev/ptmx c 5 2\n+mknod -m 666 \"$target\"/dev/random c 1 8\n+mknod -m 666 \"$target\"/dev/tty c 5 0\n+mknod -m 666 \"$target\"/dev/tty0 c 4 0\n+mknod -m 666 \"$target\"/dev/urandom c 1 9\n+mknod -m 666 \"$target\"/dev/zero c 1 5\n+\n+# Install files. We attempt to install a headless Java distro, and exclude a\n+# number of unnecessary dependencies. In so doing, we also filter out Java itself,\n+#\u00a0but since Elasticsearch ships its own JDK, with its own libs, that isn't a problem\n+# and in fact is what we want.\n+#\n+# Note that we also skip coreutils, as it pulls in all kinds of stuff that\n+# we don't want.\n+#\n+# Note that I haven't yet verified that these dependencies are, in fact, unnecessary.\n+#\n+# We also include some utilities that we ship with the image.\n+#\n+#   * `nc` is useful for checking network issues\n+#   * `zip` and `unzip` are for working with bundles\n+#   * `pigz` is used for compressing large heaps dumps, and is considerably faster than `gzip` for this task.\n+#   * `tini` is a tiny but valid init for containers. This is used to cleanly control how ES and any child processes are shut down.\n+#\n+yum --installroot=\"$target\" --releasever=/ --setopt=tsflags=nodocs \\\n+  --setopt=group_package_types=mandatory -y  \\\n+  -x copy-jdk-configs -x cups-libs -x javapackages-tools -x alsa-lib -x freetype -x libjpeg -x libjpeg-turbo \\\n+  -x coreutils \\\n+  --skip-broken \\\n+  install \\\n+    java-latest-openjdk-headless \\\n+    bash nc zip upzip pigz\n+\n+ARCH=\"$(basename $platform)\"\n+curl --retry 10 -L -o \"$target\"/bin/tini-static-$ARCH           \"https://github.com/krallin/tini/releases/download/v0.19.0/tini-static-$ARCH\"\n+curl --retry 10 -L -o \"$target\"/bin/tini-static-$ARCH.sha256sum \"https://github.com/krallin/tini/releases/download/v0.19.0/tini-static-$ARCH.sha256sum\"\n+(cd \"$target/bin\" && sha256sum -c tini-static-$ARCH.sha256sum)\n+rm \"$target\"/bin/tini-static-$ARCH.sha256sum\n+mv \"$target\"/bin/tini-static-$ARCH \"$target\"/bin/tini\n+chmod +x \"$target\"/bin/tini\n+\n+# Use busybox instead of installing more RPMs, which can pull in all kinds of\n+# stuff we don't want. There's no RPM for busybox available for CentOS.\n+BUSYBOX_URL=\"https://busybox.net/downloads/binaries/1.31.0-i686-uclibc/busybox\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1603735e0ea53c96600e9e1c8d6247c903a84c"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDUyMDk2OnYy", "diffSide": "RIGHT", "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDoyMDoxOVrOGQjGcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDoyMDoxOVrOGQjGcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAwNTQ5MQ==", "bodyText": "Is there a particular reason for the use of tar here for copying?\nI was thinking something like mkdir -p \"$target\"/etc && cp -a /etc/pki \"$target\"/etc/ is simpler to reason about in the future, or am I missing something?", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r420005491", "createdAt": "2020-05-05T10:20:19Z", "author": {"login": "dliappis"}, "path": "distribution/docker/src/docker/bin/install-baseimage.sh", "diffHunk": "@@ -0,0 +1,149 @@\n+#!/usr/bin/env bash\n+#\n+# Create a basic filesystem that can be used to create a Docker images that\n+# don't require a full distro.\n+#\n+# Originally from:\n+#\u00a0\n+# https://github.com/moby/moby/blob/master/contrib/mkimage-yum.sh\n+\n+set -e\n+\n+usage() {\n+    cat <<EOOPTS\n+$(basename $0) <platform> <output_file>\n+EOOPTS\n+    exit 1\n+}\n+\n+platform=\"$1\"\n+output_file=\"$2\"\n+\n+if [[ -z $platform ]]; then\n+    usage\n+fi\n+\n+if [[ -z \"$output_file\" ]]; then\n+    usage\n+fi\n+\n+# Start off with an up-to-date system\n+yum update --setopt=tsflags=nodocs -y\n+\n+# Create a temporary directory into which we will install files\n+target=$(mktemp -d --tmpdir $(basename $0).XXXXXX)\n+\n+set -x\n+\n+#\u00a0Create required devices\n+mkdir -m 755 \"$target\"/dev\n+mknod -m 600 \"$target\"/dev/console c 5 1\n+mknod -m 600 \"$target\"/dev/initctl p\n+mknod -m 666 \"$target\"/dev/full c 1 7\n+mknod -m 666 \"$target\"/dev/null c 1 3\n+mknod -m 666 \"$target\"/dev/ptmx c 5 2\n+mknod -m 666 \"$target\"/dev/random c 1 8\n+mknod -m 666 \"$target\"/dev/tty c 5 0\n+mknod -m 666 \"$target\"/dev/tty0 c 4 0\n+mknod -m 666 \"$target\"/dev/urandom c 1 9\n+mknod -m 666 \"$target\"/dev/zero c 1 5\n+\n+# Install files. We attempt to install a headless Java distro, and exclude a\n+# number of unnecessary dependencies. In so doing, we also filter out Java itself,\n+#\u00a0but since Elasticsearch ships its own JDK, with its own libs, that isn't a problem\n+# and in fact is what we want.\n+#\n+# Note that we also skip coreutils, as it pulls in all kinds of stuff that\n+# we don't want.\n+#\n+# Note that I haven't yet verified that these dependencies are, in fact, unnecessary.\n+#\n+# We also include some utilities that we ship with the image.\n+#\n+#   * `nc` is useful for checking network issues\n+#   * `zip` and `unzip` are for working with bundles\n+#   * `pigz` is used for compressing large heaps dumps, and is considerably faster than `gzip` for this task.\n+#   * `tini` is a tiny but valid init for containers. This is used to cleanly control how ES and any child processes are shut down.\n+#\n+yum --installroot=\"$target\" --releasever=/ --setopt=tsflags=nodocs \\\n+  --setopt=group_package_types=mandatory -y  \\\n+  -x copy-jdk-configs -x cups-libs -x javapackages-tools -x alsa-lib -x freetype -x libjpeg -x libjpeg-turbo \\\n+  -x coreutils \\\n+  --skip-broken \\\n+  install \\\n+    java-latest-openjdk-headless \\\n+    bash nc zip upzip pigz\n+\n+ARCH=\"$(basename $platform)\"\n+curl --retry 10 -L -o \"$target\"/bin/tini-static-$ARCH           \"https://github.com/krallin/tini/releases/download/v0.19.0/tini-static-$ARCH\"\n+curl --retry 10 -L -o \"$target\"/bin/tini-static-$ARCH.sha256sum \"https://github.com/krallin/tini/releases/download/v0.19.0/tini-static-$ARCH.sha256sum\"\n+(cd \"$target/bin\" && sha256sum -c tini-static-$ARCH.sha256sum)\n+rm \"$target\"/bin/tini-static-$ARCH.sha256sum\n+mv \"$target\"/bin/tini-static-$ARCH \"$target\"/bin/tini\n+chmod +x \"$target\"/bin/tini\n+\n+# Use busybox instead of installing more RPMs, which can pull in all kinds of\n+# stuff we don't want. There's no RPM for busybox available for CentOS.\n+BUSYBOX_URL=\"https://busybox.net/downloads/binaries/1.31.0-i686-uclibc/busybox\"\n+if [[ \"$platform\" == \"linux/arm64\" ]]; then\n+  BUSYBOX_URL=\"https://www.busybox.net/downloads/binaries/1.31.0-defconfig-multiarch-musl/busybox-armv8l\"\n+fi\n+curl --retry 10 -L -o \"$target\"/bin/busybox \"$BUSYBOX_URL\"\n+chmod +x \"$target\"/bin/busybox\n+\n+set +x\n+# Add links for all the utilities (except sh, as we have bash)\n+for path in $( \"$target\"/bin/busybox --list-full | grep -v bin/sh ); do\n+  ln \"$target\"/bin/busybox \"$target\"/$path\n+done\n+set -x\n+\n+# Copy in our static curl build. This is provided via a Docker bind mount\n+cp /curl \"$target\"/usr/bin/curl\n+\n+# Curl needs files under here. More importantly, we change Elasticsearch's\n+# bundled JDK to use /etc/pki/ca-trust/extracted/java/cacerts instead of\n+# the bundled cacerts.\n+tar cf - /etc/pki | (cd \"$target\" && tar xf -)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1603735e0ea53c96600e9e1c8d6247c903a84c"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MzMxNDI5OnYy", "diffSide": "RIGHT", "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/ProcessInfo.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMjoyNDozOFrOGX0xkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMjo0MTozMFrOGo4zAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzNTA5MA==", "bodyText": "I believe this javadoc should mention that the code here is targeting Linux, and perhaps mention the specific distro or environment it's intended for. The commands here wouldn't work on a Mac (no /proc directory, for one thing), and certainly wouldn't work on Windows, and someone new to the code might think this is a general class for retrieving process info.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r427635090", "createdAt": "2020-05-19T22:24:38Z", "author": {"login": "williamrandolph"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/ProcessInfo.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.packaging.util;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.hasSize;\n+\n+/**\n+ * Encapsulates the fetching of information about a running process.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1603735e0ea53c96600e9e1c8d6247c903a84c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTUyNjc4Ng==", "bodyText": "Good point, I'll update the Javadoc.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r445526786", "createdAt": "2020-06-25T12:41:30Z", "author": {"login": "pugnascotia"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/ProcessInfo.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.packaging.util;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.hasSize;\n+\n+/**\n+ * Encapsulates the fetching of information about a running process.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzNTA5MA=="}, "originalCommit": {"oid": "2d1603735e0ea53c96600e9e1c8d6247c903a84c"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MjE4OTkxOnYy", "diffSide": "RIGHT", "path": "distribution/docker/src/docker/Dockerfile", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTowODo1MlrOG1ZtzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjo0OTo0M1rOG2I97A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0OTAzNg==", "bodyText": "How about adding pigz?\nIt's very useful for compressing large heap dumps. It's not a must-have from Cloud's perspective (we can fall back to gzip) but since we will be lacking package manager it'd make a lot of sense to add it here.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r458649036", "createdAt": "2020-07-22T09:08:52Z", "author": {"login": "mieciu"}, "path": "distribution/docker/src/docker/Dockerfile", "diffHunk": "@@ -10,70 +10,174 @@\n \n   https://docs.groovy-lang.org/latest/html/api/groovy/text/SimpleTemplateEngine.html\n */ %>\n+\n ################################################################################\n-# Build stage 0 `builder`:\n-# Extract elasticsearch artifact\n-# Set gid=0 and make group perms==owner perms\n+# Step 1. Build curl statically. Installing it from RPM on CentOS pulls in too\n+# many dependencies.\n ################################################################################\n+FROM alpine:latest AS curl\n \n-FROM centos:7 AS builder\n+ENV VERSION 7.71.0\n+ENV TARBALL_URL https://curl.haxx.se/download/curl-\\${VERSION}.tar.xz\n+ENV TARBALL_PATH curl-\\${VERSION}.tar.xz\n+\n+# Install dependencies\n+RUN apk add gnupg gcc make musl-dev openssl-dev openssl-libs-static file\n+\n+RUN mkdir /work\n+WORKDIR /work\n+\n+# Fetch curl sources and files for validation\n+RUN wget \"https://daniel.haxx.se/mykey.asc\" -O \"curl-gpg.pub\" && \\\\\n+    wget \"\\${TARBALL_URL}.asc\" -O \"\\${TARBALL_PATH}.asc\" && \\\\\n+    wget \"\\${TARBALL_URL}\" -O \"\\${TARBALL_PATH}\"\n+\n+# Validate source\n+RUN gpg --import --always-trust \"curl-gpg.pub\" && \\\\\n+    gpg --verify \"\\${TARBALL_PATH}.asc\" \"\\${TARBALL_PATH}\"\n+\n+# Unpack and build\n+RUN tar xfJ \"\\${TARBALL_PATH}\" && \\\\\n+    cd \"curl-\\${VERSION}\" && \\\\\n+    ./configure --disable-shared --with-ca-fallback --with-ca-bundle=/etc/pki/tls/certs/ca-bundle.crt && \\\\\n+    make curl_LDFLAGS=\"-all-static\" && \\\\\n+    cp src/curl /work/curl && \\\\\n+    strip /work/curl\n+\n+################################################################################\n+# Step 2. Create a minimal root filesystem directory. This will form the basis\n+# for our image.\n+################################################################################\n+FROM centos:7 AS rootfs\n+\n+ENV BUSYBOX_VERSION 1.31.0\n+ENV TINI_VERSION 0.19.0\n+\n+# Start off with an up-to-date system\n+RUN yum update --setopt=tsflags=nodocs -y\n+\n+# Create a directory into which we will install files\n+RUN mkdir /rootfs\n+\n+#\u00a0Create required devices\n+RUN mkdir -m 755 /rootfs/dev && \\\\\n+    mknod -m 600 /rootfs/dev/console c 5 1 && \\\\\n+    mknod -m 600 /rootfs/dev/initctl p && \\\\\n+    mknod -m 666 /rootfs/dev/full c 1 7 && \\\\\n+    mknod -m 666 /rootfs/dev/null c 1 3 && \\\\\n+    mknod -m 666 /rootfs/dev/ptmx c 5 2 && \\\\\n+    mknod -m 666 /rootfs/dev/random c 1 8 && \\\\\n+    mknod -m 666 /rootfs/dev/tty c 5 0 && \\\\\n+    mknod -m 666 /rootfs/dev/tty0 c 4 0 && \\\\\n+    mknod -m 666 /rootfs/dev/urandom c 1 9 && \\\\\n+    mknod -m 666 /rootfs/dev/zero c 1 5\n+\n+# Install a minimal set of dependencies, and some for Elasticsearch\n+RUN yum --installroot=/rootfs --releasever=/ --setopt=tsflags=nodocs \\\\\n+      --setopt=group_package_types=mandatory -y  \\\\\n+      --skip-broken \\\\\n+      install basesystem bash zip zlib", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af035fe89e95e7183d21e0616cb60443914ff5d3"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwNTY5Mw==", "bodyText": "@mieciu It's my assumption that heap dumps would be written to a volume that is mounted on the host (otherwise, they vanish when the container dies, which will happen when the process died because of an OOME), and thus could be processed on the host external to the container.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r458705693", "createdAt": "2020-07-22T10:51:20Z", "author": {"login": "jasontedor"}, "path": "distribution/docker/src/docker/Dockerfile", "diffHunk": "@@ -10,70 +10,174 @@\n \n   https://docs.groovy-lang.org/latest/html/api/groovy/text/SimpleTemplateEngine.html\n */ %>\n+\n ################################################################################\n-# Build stage 0 `builder`:\n-# Extract elasticsearch artifact\n-# Set gid=0 and make group perms==owner perms\n+# Step 1. Build curl statically. Installing it from RPM on CentOS pulls in too\n+# many dependencies.\n ################################################################################\n+FROM alpine:latest AS curl\n \n-FROM centos:7 AS builder\n+ENV VERSION 7.71.0\n+ENV TARBALL_URL https://curl.haxx.se/download/curl-\\${VERSION}.tar.xz\n+ENV TARBALL_PATH curl-\\${VERSION}.tar.xz\n+\n+# Install dependencies\n+RUN apk add gnupg gcc make musl-dev openssl-dev openssl-libs-static file\n+\n+RUN mkdir /work\n+WORKDIR /work\n+\n+# Fetch curl sources and files for validation\n+RUN wget \"https://daniel.haxx.se/mykey.asc\" -O \"curl-gpg.pub\" && \\\\\n+    wget \"\\${TARBALL_URL}.asc\" -O \"\\${TARBALL_PATH}.asc\" && \\\\\n+    wget \"\\${TARBALL_URL}\" -O \"\\${TARBALL_PATH}\"\n+\n+# Validate source\n+RUN gpg --import --always-trust \"curl-gpg.pub\" && \\\\\n+    gpg --verify \"\\${TARBALL_PATH}.asc\" \"\\${TARBALL_PATH}\"\n+\n+# Unpack and build\n+RUN tar xfJ \"\\${TARBALL_PATH}\" && \\\\\n+    cd \"curl-\\${VERSION}\" && \\\\\n+    ./configure --disable-shared --with-ca-fallback --with-ca-bundle=/etc/pki/tls/certs/ca-bundle.crt && \\\\\n+    make curl_LDFLAGS=\"-all-static\" && \\\\\n+    cp src/curl /work/curl && \\\\\n+    strip /work/curl\n+\n+################################################################################\n+# Step 2. Create a minimal root filesystem directory. This will form the basis\n+# for our image.\n+################################################################################\n+FROM centos:7 AS rootfs\n+\n+ENV BUSYBOX_VERSION 1.31.0\n+ENV TINI_VERSION 0.19.0\n+\n+# Start off with an up-to-date system\n+RUN yum update --setopt=tsflags=nodocs -y\n+\n+# Create a directory into which we will install files\n+RUN mkdir /rootfs\n+\n+#\u00a0Create required devices\n+RUN mkdir -m 755 /rootfs/dev && \\\\\n+    mknod -m 600 /rootfs/dev/console c 5 1 && \\\\\n+    mknod -m 600 /rootfs/dev/initctl p && \\\\\n+    mknod -m 666 /rootfs/dev/full c 1 7 && \\\\\n+    mknod -m 666 /rootfs/dev/null c 1 3 && \\\\\n+    mknod -m 666 /rootfs/dev/ptmx c 5 2 && \\\\\n+    mknod -m 666 /rootfs/dev/random c 1 8 && \\\\\n+    mknod -m 666 /rootfs/dev/tty c 5 0 && \\\\\n+    mknod -m 666 /rootfs/dev/tty0 c 4 0 && \\\\\n+    mknod -m 666 /rootfs/dev/urandom c 1 9 && \\\\\n+    mknod -m 666 /rootfs/dev/zero c 1 5\n+\n+# Install a minimal set of dependencies, and some for Elasticsearch\n+RUN yum --installroot=/rootfs --releasever=/ --setopt=tsflags=nodocs \\\\\n+      --setopt=group_package_types=mandatory -y  \\\\\n+      --skip-broken \\\\\n+      install basesystem bash zip zlib", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0OTAzNg=="}, "originalCommit": {"oid": "af035fe89e95e7183d21e0616cb60443914ff5d3"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyMTI2Mg==", "bodyText": "That's a good point - @mieciu what is Cloud doing with heapdumps exactly - compressing them in the container?", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r458721262", "createdAt": "2020-07-22T11:23:45Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/src/docker/Dockerfile", "diffHunk": "@@ -10,70 +10,174 @@\n \n   https://docs.groovy-lang.org/latest/html/api/groovy/text/SimpleTemplateEngine.html\n */ %>\n+\n ################################################################################\n-# Build stage 0 `builder`:\n-# Extract elasticsearch artifact\n-# Set gid=0 and make group perms==owner perms\n+# Step 1. Build curl statically. Installing it from RPM on CentOS pulls in too\n+# many dependencies.\n ################################################################################\n+FROM alpine:latest AS curl\n \n-FROM centos:7 AS builder\n+ENV VERSION 7.71.0\n+ENV TARBALL_URL https://curl.haxx.se/download/curl-\\${VERSION}.tar.xz\n+ENV TARBALL_PATH curl-\\${VERSION}.tar.xz\n+\n+# Install dependencies\n+RUN apk add gnupg gcc make musl-dev openssl-dev openssl-libs-static file\n+\n+RUN mkdir /work\n+WORKDIR /work\n+\n+# Fetch curl sources and files for validation\n+RUN wget \"https://daniel.haxx.se/mykey.asc\" -O \"curl-gpg.pub\" && \\\\\n+    wget \"\\${TARBALL_URL}.asc\" -O \"\\${TARBALL_PATH}.asc\" && \\\\\n+    wget \"\\${TARBALL_URL}\" -O \"\\${TARBALL_PATH}\"\n+\n+# Validate source\n+RUN gpg --import --always-trust \"curl-gpg.pub\" && \\\\\n+    gpg --verify \"\\${TARBALL_PATH}.asc\" \"\\${TARBALL_PATH}\"\n+\n+# Unpack and build\n+RUN tar xfJ \"\\${TARBALL_PATH}\" && \\\\\n+    cd \"curl-\\${VERSION}\" && \\\\\n+    ./configure --disable-shared --with-ca-fallback --with-ca-bundle=/etc/pki/tls/certs/ca-bundle.crt && \\\\\n+    make curl_LDFLAGS=\"-all-static\" && \\\\\n+    cp src/curl /work/curl && \\\\\n+    strip /work/curl\n+\n+################################################################################\n+# Step 2. Create a minimal root filesystem directory. This will form the basis\n+# for our image.\n+################################################################################\n+FROM centos:7 AS rootfs\n+\n+ENV BUSYBOX_VERSION 1.31.0\n+ENV TINI_VERSION 0.19.0\n+\n+# Start off with an up-to-date system\n+RUN yum update --setopt=tsflags=nodocs -y\n+\n+# Create a directory into which we will install files\n+RUN mkdir /rootfs\n+\n+#\u00a0Create required devices\n+RUN mkdir -m 755 /rootfs/dev && \\\\\n+    mknod -m 600 /rootfs/dev/console c 5 1 && \\\\\n+    mknod -m 600 /rootfs/dev/initctl p && \\\\\n+    mknod -m 666 /rootfs/dev/full c 1 7 && \\\\\n+    mknod -m 666 /rootfs/dev/null c 1 3 && \\\\\n+    mknod -m 666 /rootfs/dev/ptmx c 5 2 && \\\\\n+    mknod -m 666 /rootfs/dev/random c 1 8 && \\\\\n+    mknod -m 666 /rootfs/dev/tty c 5 0 && \\\\\n+    mknod -m 666 /rootfs/dev/tty0 c 4 0 && \\\\\n+    mknod -m 666 /rootfs/dev/urandom c 1 9 && \\\\\n+    mknod -m 666 /rootfs/dev/zero c 1 5\n+\n+# Install a minimal set of dependencies, and some for Elasticsearch\n+RUN yum --installroot=/rootfs --releasever=/ --setopt=tsflags=nodocs \\\\\n+      --setopt=group_package_types=mandatory -y  \\\\\n+      --skip-broken \\\\\n+      install basesystem bash zip zlib", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0OTAzNg=="}, "originalCommit": {"oid": "af035fe89e95e7183d21e0616cb60443914ff5d3"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxMzcyMA==", "bodyText": "We could move the compression out of the ES container and into the allocator container. Then pigz is always available (if we want it to be).", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r459413720", "createdAt": "2020-07-23T12:33:25Z", "author": {"login": "joegallo"}, "path": "distribution/docker/src/docker/Dockerfile", "diffHunk": "@@ -10,70 +10,174 @@\n \n   https://docs.groovy-lang.org/latest/html/api/groovy/text/SimpleTemplateEngine.html\n */ %>\n+\n ################################################################################\n-# Build stage 0 `builder`:\n-# Extract elasticsearch artifact\n-# Set gid=0 and make group perms==owner perms\n+# Step 1. Build curl statically. Installing it from RPM on CentOS pulls in too\n+# many dependencies.\n ################################################################################\n+FROM alpine:latest AS curl\n \n-FROM centos:7 AS builder\n+ENV VERSION 7.71.0\n+ENV TARBALL_URL https://curl.haxx.se/download/curl-\\${VERSION}.tar.xz\n+ENV TARBALL_PATH curl-\\${VERSION}.tar.xz\n+\n+# Install dependencies\n+RUN apk add gnupg gcc make musl-dev openssl-dev openssl-libs-static file\n+\n+RUN mkdir /work\n+WORKDIR /work\n+\n+# Fetch curl sources and files for validation\n+RUN wget \"https://daniel.haxx.se/mykey.asc\" -O \"curl-gpg.pub\" && \\\\\n+    wget \"\\${TARBALL_URL}.asc\" -O \"\\${TARBALL_PATH}.asc\" && \\\\\n+    wget \"\\${TARBALL_URL}\" -O \"\\${TARBALL_PATH}\"\n+\n+# Validate source\n+RUN gpg --import --always-trust \"curl-gpg.pub\" && \\\\\n+    gpg --verify \"\\${TARBALL_PATH}.asc\" \"\\${TARBALL_PATH}\"\n+\n+# Unpack and build\n+RUN tar xfJ \"\\${TARBALL_PATH}\" && \\\\\n+    cd \"curl-\\${VERSION}\" && \\\\\n+    ./configure --disable-shared --with-ca-fallback --with-ca-bundle=/etc/pki/tls/certs/ca-bundle.crt && \\\\\n+    make curl_LDFLAGS=\"-all-static\" && \\\\\n+    cp src/curl /work/curl && \\\\\n+    strip /work/curl\n+\n+################################################################################\n+# Step 2. Create a minimal root filesystem directory. This will form the basis\n+# for our image.\n+################################################################################\n+FROM centos:7 AS rootfs\n+\n+ENV BUSYBOX_VERSION 1.31.0\n+ENV TINI_VERSION 0.19.0\n+\n+# Start off with an up-to-date system\n+RUN yum update --setopt=tsflags=nodocs -y\n+\n+# Create a directory into which we will install files\n+RUN mkdir /rootfs\n+\n+#\u00a0Create required devices\n+RUN mkdir -m 755 /rootfs/dev && \\\\\n+    mknod -m 600 /rootfs/dev/console c 5 1 && \\\\\n+    mknod -m 600 /rootfs/dev/initctl p && \\\\\n+    mknod -m 666 /rootfs/dev/full c 1 7 && \\\\\n+    mknod -m 666 /rootfs/dev/null c 1 3 && \\\\\n+    mknod -m 666 /rootfs/dev/ptmx c 5 2 && \\\\\n+    mknod -m 666 /rootfs/dev/random c 1 8 && \\\\\n+    mknod -m 666 /rootfs/dev/tty c 5 0 && \\\\\n+    mknod -m 666 /rootfs/dev/tty0 c 4 0 && \\\\\n+    mknod -m 666 /rootfs/dev/urandom c 1 9 && \\\\\n+    mknod -m 666 /rootfs/dev/zero c 1 5\n+\n+# Install a minimal set of dependencies, and some for Elasticsearch\n+RUN yum --installroot=/rootfs --releasever=/ --setopt=tsflags=nodocs \\\\\n+      --setopt=group_package_types=mandatory -y  \\\\\n+      --skip-broken \\\\\n+      install basesystem bash zip zlib", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0OTAzNg=="}, "originalCommit": {"oid": "af035fe89e95e7183d21e0616cb60443914ff5d3"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMzIxMg==", "bodyText": "So I'm happy to do something to smooth the way, though compressing heapdumps does feel like an orchestration concern, so ultimately I think the allocator should handle it in whatever way it deems fit.", "url": "https://github.com/elastic/elasticsearch/pull/52519#discussion_r459423212", "createdAt": "2020-07-23T12:49:43Z", "author": {"login": "pugnascotia"}, "path": "distribution/docker/src/docker/Dockerfile", "diffHunk": "@@ -10,70 +10,174 @@\n \n   https://docs.groovy-lang.org/latest/html/api/groovy/text/SimpleTemplateEngine.html\n */ %>\n+\n ################################################################################\n-# Build stage 0 `builder`:\n-# Extract elasticsearch artifact\n-# Set gid=0 and make group perms==owner perms\n+# Step 1. Build curl statically. Installing it from RPM on CentOS pulls in too\n+# many dependencies.\n ################################################################################\n+FROM alpine:latest AS curl\n \n-FROM centos:7 AS builder\n+ENV VERSION 7.71.0\n+ENV TARBALL_URL https://curl.haxx.se/download/curl-\\${VERSION}.tar.xz\n+ENV TARBALL_PATH curl-\\${VERSION}.tar.xz\n+\n+# Install dependencies\n+RUN apk add gnupg gcc make musl-dev openssl-dev openssl-libs-static file\n+\n+RUN mkdir /work\n+WORKDIR /work\n+\n+# Fetch curl sources and files for validation\n+RUN wget \"https://daniel.haxx.se/mykey.asc\" -O \"curl-gpg.pub\" && \\\\\n+    wget \"\\${TARBALL_URL}.asc\" -O \"\\${TARBALL_PATH}.asc\" && \\\\\n+    wget \"\\${TARBALL_URL}\" -O \"\\${TARBALL_PATH}\"\n+\n+# Validate source\n+RUN gpg --import --always-trust \"curl-gpg.pub\" && \\\\\n+    gpg --verify \"\\${TARBALL_PATH}.asc\" \"\\${TARBALL_PATH}\"\n+\n+# Unpack and build\n+RUN tar xfJ \"\\${TARBALL_PATH}\" && \\\\\n+    cd \"curl-\\${VERSION}\" && \\\\\n+    ./configure --disable-shared --with-ca-fallback --with-ca-bundle=/etc/pki/tls/certs/ca-bundle.crt && \\\\\n+    make curl_LDFLAGS=\"-all-static\" && \\\\\n+    cp src/curl /work/curl && \\\\\n+    strip /work/curl\n+\n+################################################################################\n+# Step 2. Create a minimal root filesystem directory. This will form the basis\n+# for our image.\n+################################################################################\n+FROM centos:7 AS rootfs\n+\n+ENV BUSYBOX_VERSION 1.31.0\n+ENV TINI_VERSION 0.19.0\n+\n+# Start off with an up-to-date system\n+RUN yum update --setopt=tsflags=nodocs -y\n+\n+# Create a directory into which we will install files\n+RUN mkdir /rootfs\n+\n+#\u00a0Create required devices\n+RUN mkdir -m 755 /rootfs/dev && \\\\\n+    mknod -m 600 /rootfs/dev/console c 5 1 && \\\\\n+    mknod -m 600 /rootfs/dev/initctl p && \\\\\n+    mknod -m 666 /rootfs/dev/full c 1 7 && \\\\\n+    mknod -m 666 /rootfs/dev/null c 1 3 && \\\\\n+    mknod -m 666 /rootfs/dev/ptmx c 5 2 && \\\\\n+    mknod -m 666 /rootfs/dev/random c 1 8 && \\\\\n+    mknod -m 666 /rootfs/dev/tty c 5 0 && \\\\\n+    mknod -m 666 /rootfs/dev/tty0 c 4 0 && \\\\\n+    mknod -m 666 /rootfs/dev/urandom c 1 9 && \\\\\n+    mknod -m 666 /rootfs/dev/zero c 1 5\n+\n+# Install a minimal set of dependencies, and some for Elasticsearch\n+RUN yum --installroot=/rootfs --releasever=/ --setopt=tsflags=nodocs \\\\\n+      --setopt=group_package_types=mandatory -y  \\\\\n+      --skip-broken \\\\\n+      install basesystem bash zip zlib", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0OTAzNg=="}, "originalCommit": {"oid": "af035fe89e95e7183d21e0616cb60443914ff5d3"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3975, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}