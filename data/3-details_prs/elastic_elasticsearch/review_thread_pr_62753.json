{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwODMyOTk5", "number": 62753, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTozMzoyOFrOEoCbrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTozMzoyOFrOEoCbrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNDE4MzQ5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTozMzoyOFrOHY5oxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTo1NzozOVrOHY6WjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3MjE5OQ==", "bodyText": "nit: this reintroduces double firing the listener if listener.onResponse fails (will also invoke onFailure now). I am OK with it, since it is a separate effort to come up with a good solution for the pattern you use here - unless you can see an easy way around it.", "url": "https://github.com/elastic/elasticsearch/pull/62753#discussion_r495872199", "createdAt": "2020-09-28T11:33:28Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java", "diffHunk": "@@ -226,15 +256,7 @@ private void onFailure(int idx, String nodeId, Throwable t) {\n         }\n \n         private void finishHim() {\n-            NodesResponse finalResponse;\n-            try {\n-                finalResponse = newResponse(request, responses);\n-            } catch (Exception e) {\n-                logger.debug(\"failed to combine responses from nodes\", e);\n-                listener.onFailure(e);\n-                return;\n-            }\n-            listener.onResponse(finalResponse);\n+            threadPool.executor(finalExecutor).execute(ActionRunnable.supply(listener, () -> newResponse(request, responses)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19028898559535391b3c8ba21a12dc104b0e876e"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg4MzkxNg==", "bodyText": "I knew you were gonna point that out (really :)). The problem here is, that we really need this safe-guard here I think. Otherwise an exception in listener.onResponse (highly likely a bug in the transport code but still) would lead to the request never getting a response back leaking memory on the caller. We have the same issue when we run this on the same thread actually (the transport handler upstream brings the exception back around to the listener in that case).\n-> no easy fix here for now I'm afraid. But I do think we should look into adding more assertions for this kind of thing to ActionRunnable like you did to ActionListener.map and clean these things up more for sure.", "url": "https://github.com/elastic/elasticsearch/pull/62753#discussion_r495883916", "createdAt": "2020-09-28T11:57:39Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java", "diffHunk": "@@ -226,15 +256,7 @@ private void onFailure(int idx, String nodeId, Throwable t) {\n         }\n \n         private void finishHim() {\n-            NodesResponse finalResponse;\n-            try {\n-                finalResponse = newResponse(request, responses);\n-            } catch (Exception e) {\n-                logger.debug(\"failed to combine responses from nodes\", e);\n-                listener.onFailure(e);\n-                return;\n-            }\n-            listener.onResponse(finalResponse);\n+            threadPool.executor(finalExecutor).execute(ActionRunnable.supply(listener, () -> newResponse(request, responses)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3MjE5OQ=="}, "originalCommit": {"oid": "19028898559535391b3c8ba21a12dc104b0e876e"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3410, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}