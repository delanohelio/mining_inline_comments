{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2ODYyMzM2", "number": 61768, "title": "Fix to actually throttle indexing under memory pressure", "bodyText": "Fix to actually throttle indexing on getting activated. Looks like this got reverted in following change\n3ad6d6e\n[Edit on 09/08]\nHow did I identify this?\nI was seeing increased load in production cluster for scheduled indexing and too many merge threads and so I started to look at code and identified this (bulk/write thread pool were choking on shard refresh lock but never got throttled).", "createdAt": "2020-09-01T06:58:13Z", "url": "https://github.com/elastic/elasticsearch/pull/61768", "merged": true, "mergeCommit": {"oid": "f5affcd34f6363f43391396665a233015ea97e99"}, "closed": true, "closedAt": "2020-10-02T13:10:36Z", "author": {"login": "nitin2goyal"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG0K4oAH2gAyNDc2ODYyMzM2OjMzYjNjNjJkYTdhNTMwMGI4M2ZjYjM5MDYyNDMwMzcyYzAzZmRiYTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOhiM8AH2gAyNDc2ODYyMzM2OmUxNzBjZTJiZDg0M2FmMzZiMzAxZWEwMWRmNGI5ZGUwNzgxMmI2YWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "33b3c62da7a5300b83fcb39062430372c03fdba8", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/33b3c62da7a5300b83fcb39062430372c03fdba8", "committedDate": "2020-09-08T09:27:44Z", "message": "Fix to actually throttle indexing on getting activated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2fbe744b4d03f23fa5c2f9248aa4b54a57aaf3fa", "author": {"user": null}, "url": "https://github.com/elastic/elasticsearch/commit/2fbe744b4d03f23fa5c2f9248aa4b54a57aaf3fa", "committedDate": "2020-09-01T06:48:15Z", "message": "Fix to actually throttle indexing on getting activated"}, "afterCommit": {"oid": "33b3c62da7a5300b83fcb39062430372c03fdba8", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/33b3c62da7a5300b83fcb39062430372c03fdba8", "committedDate": "2020-09-08T09:27:44Z", "message": "Fix to actually throttle indexing on getting activated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93f6f163c4cfac8872d28e2facd1db4022e145ad", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/93f6f163c4cfac8872d28e2facd1db4022e145ad", "committedDate": "2020-09-23T11:45:02Z", "message": "Add test\n\nAdd test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e3f0a1ea820ebbc262a6712b8b12ad3c0ccc52f", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/9e3f0a1ea820ebbc262a6712b8b12ad3c0ccc52f", "committedDate": "2020-09-23T11:42:53Z", "message": "Add test"}, "afterCommit": {"oid": "93f6f163c4cfac8872d28e2facd1db4022e145ad", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/93f6f163c4cfac8872d28e2facd1db4022e145ad", "committedDate": "2020-09-23T11:45:02Z", "message": "Add test\n\nAdd test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTcxNDY3", "url": "https://github.com/elastic/elasticsearch/pull/61768#pullrequestreview-494571467", "createdAt": "2020-09-23T11:46:46Z", "commit": {"oid": "93f6f163c4cfac8872d28e2facd1db4022e145ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMTo0Njo0NlrOHWoWJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMTo0Njo0NlrOHWoWJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzQ5MTc0OA==", "bodyText": "I know it's not a good design but couldn't think of a better way to ensure sequential indexing in case of throttling", "url": "https://github.com/elastic/elasticsearch/pull/61768#discussion_r493491748", "createdAt": "2020-09-23T11:46:46Z", "author": {"login": "nitin2goyal"}, "path": "server/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java", "diffHunk": "@@ -5786,6 +5788,69 @@ private void runTestDeleteFailure(final CheckedBiConsumer<InternalEngine, Engine\n         }\n     }\n \n+    public void testIndexThrottling() throws Exception {\n+        engine = spy(engine);\n+\n+        long sleepInMillis = 1000;\n+        engine.activateThrottling();\n+        Long timeTaken = concurrentIndexingWithSleep(sleepInMillis);\n+        assertTrue(timeTaken > (2 * sleepInMillis));\n+\n+        engine.deactivateThrottling();\n+        timeTaken = concurrentIndexingWithSleep(sleepInMillis);\n+        assertTrue(timeTaken < (2 * sleepInMillis));\n+    }\n+\n+    private long concurrentIndexingWithSleep(long sleepInMillis) throws Exception {\n+        CountDownLatch countDownLatch = new CountDownLatch(3);\n+        Mockito.doAnswer((Answer<InternalEngine.IndexingStrategy>) invocation -> {\n+            try {\n+                Thread.sleep(sleepInMillis);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93f6f163c4cfac8872d28e2facd1db4022e145ad"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MzY1NzQ2", "url": "https://github.com/elastic/elasticsearch/pull/61768#pullrequestreview-498365746", "createdAt": "2020-09-29T11:22:00Z", "commit": {"oid": "93f6f163c4cfac8872d28e2facd1db4022e145ad"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ede13c5c2a404d3bababd730e10f4480507b6c6", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/1ede13c5c2a404d3bababd730e10f4480507b6c6", "committedDate": "2020-10-02T04:40:41Z", "message": "Improved test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ee786069c4f82f25ba5ef0782f4f960efb5740c", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/5ee786069c4f82f25ba5ef0782f4f960efb5740c", "committedDate": "2020-10-02T04:43:22Z", "message": "Removed unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwODgxNTM2", "url": "https://github.com/elastic/elasticsearch/pull/61768#pullrequestreview-500881536", "createdAt": "2020-10-02T06:21:13Z", "commit": {"oid": "5ee786069c4f82f25ba5ef0782f4f960efb5740c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNjoyMToxM1rOHbiOSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNjoyMTozMVrOHbiOlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYzNDMxMw==", "bodyText": "I would like to add a comment that this is to be used in assertions and tests only.", "url": "https://github.com/elastic/elasticsearch/pull/61768#discussion_r498634313", "createdAt": "2020-10-02T06:21:13Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/index/engine/Engine.java", "diffHunk": "@@ -279,6 +279,13 @@ long getThrottleTimeInMillis() {\n         boolean isThrottled() {\n             return lock != NOOP_LOCK;\n         }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee786069c4f82f25ba5ef0782f4f960efb5740c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYzNDM4OQ==", "bodyText": "Also add comment here on only use in assertions and tests.", "url": "https://github.com/elastic/elasticsearch/pull/61768#discussion_r498634389", "createdAt": "2020-10-02T06:21:31Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java", "diffHunk": "@@ -2178,6 +2178,10 @@ public boolean isThrottled() {\n         return throttle.isThrottled();\n     }\n \n+    boolean throttleLockIsHeldByCurrentThread() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ee786069c4f82f25ba5ef0782f4f960efb5740c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05e91af97db8b29bb1e1209af7de91b17dbe7901", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/05e91af97db8b29bb1e1209af7de91b17dbe7901", "committedDate": "2020-10-02T06:36:49Z", "message": "Add comments and fix spelling mistake"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24e852802a6dfc19e8e1172836af80cf3ca520f8", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/24e852802a6dfc19e8e1172836af80cf3ca520f8", "committedDate": "2020-10-02T06:34:28Z", "message": "Add comments and fix spelling mistake"}, "afterCommit": {"oid": "05e91af97db8b29bb1e1209af7de91b17dbe7901", "author": {"user": {"login": "nitin2goyal", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/05e91af97db8b29bb1e1209af7de91b17dbe7901", "committedDate": "2020-10-02T06:36:49Z", "message": "Add comments and fix spelling mistake"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTI0NDM1", "url": "https://github.com/elastic/elasticsearch/pull/61768#pullrequestreview-500924435", "createdAt": "2020-10-02T07:49:59Z", "commit": {"oid": "05e91af97db8b29bb1e1209af7de91b17dbe7901"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e170ce2bd843af36b301ea01df4b9de07812b6aa", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e170ce2bd843af36b301ea01df4b9de07812b6aa", "committedDate": "2020-10-02T08:16:24Z", "message": "Merge remote-tracking branch 'origin/master' into throttle-fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4917, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}