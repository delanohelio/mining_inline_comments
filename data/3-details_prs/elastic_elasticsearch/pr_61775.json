{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2OTk0NzY1", "number": 61775, "title": "Runtime fields to expose _source and stored fields like existing scripts", "bodyText": "This PR exposes stored fields to runtime fields (through params._fields) and replaces the current way to access _source (source['field']) in favour of the documented way for all existing scripts: params._source .\nRelates to #59332", "createdAt": "2020-09-01T10:49:58Z", "url": "https://github.com/elastic/elasticsearch/pull/61775", "merged": true, "mergeCommit": {"oid": "0040a593b2c43b351298c2c2cae569b1dafd5c90"}, "closed": true, "closedAt": "2020-09-02T07:58:37Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEmZ02AH2gAyNDc2OTk0NzY1OjI2MWI5MmE2MjhlM2IzNWNlNTg1NDBmMTc4NDRmY2Y5NWRhYjVjNmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE2VhlgH2gAyNDc2OTk0NzY1OjA1MDM1YTRmMjdiZjRjMWUxMjRkODhjY2MwNDBmNzNhNzRjYzhiMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "261b92a628e3b35ce58540f17844fcf95dab5c6d", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/261b92a628e3b35ce58540f17844fcf95dab5c6d", "committedDate": "2020-09-01T12:17:32Z", "message": "Runtime fields to expose _source and stored fields like other script fields\n\nThis commit exposes stored fields to runtime fields (through params._fields) and replaces the current way to access _source (source['field']) in favour of the documented way for all existing scripts: params._source ."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c085680e9a4a37d69713925e772ab63ec6e0ccc3", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/c085680e9a4a37d69713925e772ab63ec6e0ccc3", "committedDate": "2020-09-01T10:47:23Z", "message": "Runtime fields to expose _source and stored fields like other script fields\n\nThis commit exposes stored fields to runtime fields (through params._fields) and replaces the current way to access _source (source['field']) in favour of the documented way for all existing scripts: params._source ."}, "afterCommit": {"oid": "261b92a628e3b35ce58540f17844fcf95dab5c6d", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/261b92a628e3b35ce58540f17844fcf95dab5c6d", "committedDate": "2020-09-01T12:17:32Z", "message": "Runtime fields to expose _source and stored fields like other script fields\n\nThis commit exposes stored fields to runtime fields (through params._fields) and replaces the current way to access _source (source['field']) in favour of the documented way for all existing scripts: params._source ."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5Nzk5MjUx", "url": "https://github.com/elastic/elasticsearch/pull/61775#pullrequestreview-479799251", "createdAt": "2020-09-01T14:29:43Z", "commit": {"oid": "261b92a628e3b35ce58540f17844fcf95dab5c6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNDoyOTo0M1rOHK49Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNDoyOTo0M1rOHK49Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE4MTAzMQ==", "bodyText": "@javanna and I talked about this over video - I think that this syntax dates back to when we used mvel and the only reason for us to stick with it is backwards compatibility. But that aggregation scripts didn't really support _source before so maybe it isn't worth adding it to runtime fields like this. But we'll talk with a few folks about it before deciding for sure.", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481181031", "createdAt": "2020-09-01T14:29:43Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/qa/rest/src/yamlRestTest/java/org/elasticsearch/xpack/runtimefields/rest/CoreTestsWithRuntimeFieldsIT.java", "diffHunk": "@@ -166,7 +166,7 @@ private static String painlessToLoadFromSource(String name, String type) {\n             return null;\n         }\n         StringBuilder b = new StringBuilder();\n-        b.append(\"def v = source['\").append(name).append(\"'];\\n\");\n+        b.append(\"def v = params._source.\").append(name).append(\";\\n\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "261b92a628e3b35ce58540f17844fcf95dab5c6d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "204884d617beaedbcae93750125975ac99226893", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/204884d617beaedbcae93750125975ac99226893", "committedDate": "2020-09-01T21:02:23Z", "message": "Merge branch 'feature/runtime_fields' into enhancement/runtime_fields_source_fields_access"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d03249b7a5e964301765fd5ed6b3992204ca10c", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/9d03249b7a5e964301765fd5ed6b3992204ca10c", "committedDate": "2020-09-01T21:03:34Z", "message": "address failing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTE4MjA4", "url": "https://github.com/elastic/elasticsearch/pull/61775#pullrequestreview-480118208", "createdAt": "2020-09-01T21:10:47Z", "commit": {"oid": "9d03249b7a5e964301765fd5ed6b3992204ca10c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMToxMDo0N1rOHLIYKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMToxMDo0N1rOHLIYKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQzMzY0Mg==", "bodyText": "Do you think it'd be more clear to:\nparams.put(\"_source\", leafSearchLookup.searchLookup());\nparams.put(\"_fields\", leafSearchLookup.fields());\n\n?", "url": "https://github.com/elastic/elasticsearch/pull/61775#discussion_r481433642", "createdAt": "2020-09-01T21:10:47Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/AbstractScriptFieldScript.java", "diffHunk": "@@ -45,13 +49,25 @@\n         );\n     }\n \n+    private static final Map<String, Function<Object, Object>> PARAMS_FUNCTIONS = Map.of(\n+        \"_source\",\n+        value -> ((SourceLookup) value).loadSourceIfNeeded()\n+    );\n+\n     private final Map<String, Object> params;\n     private final LeafSearchLookup leafSearchLookup;\n \n     public AbstractScriptFieldScript(Map<String, Object> params, SearchLookup searchLookup, LeafReaderContext ctx) {\n         this.leafSearchLookup = searchLookup.getLeafSearchLookup(ctx);\n-        // TODO how do other scripts get stored fields exposed? Through asMap? I don't see any getters for them.\n-        this.params = params;\n+        params = new HashMap<>(params);\n+        for (Map.Entry<String, Object> entry : leafSearchLookup.asMap().entrySet()) {\n+            // accessing doc_values through through params._doc and params.doc is deprecated in all existing script contexts,\n+            // it makes little sense to expose it deprecated for runtime fields\n+            if (entry.getKey().equals(\"_doc\") == false && entry.getKey().equals(\"doc\") == false) {\n+                params.put(entry.getKey(), entry.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d03249b7a5e964301765fd5ed6b3992204ca10c"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aed741eb3bd90f46bf9dbfa20a29d6ed4dc64aca", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/aed741eb3bd90f46bf9dbfa20a29d6ed4dc64aca", "committedDate": "2020-09-01T21:24:11Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05035a4f27bf4c1e124d88ccc040f73a74cc8b06", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/05035a4f27bf4c1e124d88ccc040f73a74cc8b06", "committedDate": "2020-09-02T06:51:19Z", "message": "Merge branch 'feature/runtime_fields' into enhancement/runtime_fields_source_fields_access"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4924, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}