{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4Njk4Nzgw", "number": 61927, "title": "Check for runtime field loops in queries", "bodyText": "We were checking for loops in queries before, but we had an \"off by one\"\nerror where we wouldn't notice the \"top level\" runtime field when\ndetecting a loop. So the error message would be wrong.\nI also caught a few bugs with query generation caused by missing\n@Override annotations and fixed a few of them. There is a bug with\nregexp queries with match options that I'm not fixing in this PR but\nwill get to later.\nRelates to #59332", "createdAt": "2020-09-03T15:06:35Z", "url": "https://github.com/elastic/elasticsearch/pull/61927", "merged": true, "mergeCommit": {"oid": "12c3c1517211a163a60306cb7d4831cb6573af51"}, "closed": true, "closedAt": "2020-09-15T20:26:04Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFR-eegH2gAyNDc4Njk4NzgwOmMzOTM2MGFkYmExYmY5NGZhOWFhZWM0MzhmOTNhZDkxYjIzYjFhYmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJL7GqAH2gAyNDc4Njk4NzgwOmJlZjQ3ZTIyNDc3YTlkZWYzZDEzMzUzZjc1MzMyNzllZTMxYjg5N2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c39360adba1bf94fa9aaec438f93ad91b23b1abd", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/c39360adba1bf94fa9aaec438f93ad91b23b1abd", "committedDate": "2020-09-03T15:03:29Z", "message": "Check for runtime field loops in queries\n\nWe were checking for loops in queries before, but we had an \"off by one\"\nerror where we wouldn't notice the \"top level\" runtime field when\ndetecting a loop. So the error message would be wrong.\n\nI also caught a few bugs with query generation caused by missing\n`@Override` annotations and fixed a few of them. There is a bug with\n`regexp` queries with match options that I'm not fixing in this PR but\nwill get to later.\n\nRelates to #59332"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTM2NDM4", "url": "https://github.com/elastic/elasticsearch/pull/61927#pullrequestreview-481936438", "createdAt": "2020-09-03T15:07:36Z", "commit": {"oid": "c39360adba1bf94fa9aaec438f93ad91b23b1abd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNTowNzozNlrOHMrHoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNTowOTowMlrOHMrLkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1MTQyNA==", "bodyText": "I pulled this function into the superclass because it the \"for query\" version of it is tricky. We could probably avoid the type parameter if we really wanted to by being a bit more tricky, but I'm not sure it is worth it.", "url": "https://github.com/elastic/elasticsearch/pull/61927#discussion_r483051424", "createdAt": "2020-09-03T15:07:36Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptMappedFieldType.java", "diffHunk": "@@ -61,6 +71,26 @@ public final boolean isAggregatable() {\n         return true;\n     }\n \n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c39360adba1bf94fa9aaec438f93ad91b23b1abd"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1MTY3MQ==", "bodyText": "Missing this was a bug that causes regexes not to work at all!", "url": "https://github.com/elastic/elasticsearch/pull/61927#discussion_r483051671", "createdAt": "2020-09-03T15:07:53Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptMappedFieldType.java", "diffHunk": "@@ -102,38 +133,47 @@ public Query fuzzyQuery(\n         throw new IllegalArgumentException(unsupported(\"fuzzy\", \"keyword and text\"));\n     }\n \n+    @Override\n     public Query prefixQuery(String value, MultiTermQuery.RewriteMethod method, QueryShardContext context) {\n         throw new IllegalArgumentException(unsupported(\"prefix\", \"keyword, text and wildcard\"));\n     }\n \n+    @Override\n     public Query wildcardQuery(String value, MultiTermQuery.RewriteMethod method, QueryShardContext context) {\n         throw new IllegalArgumentException(unsupported(\"wildcard\", \"keyword, text and wildcard\"));\n     }\n \n+    @Override\n     public Query regexpQuery(\n         String value,\n-        int flags,\n+        int syntaxFlags,\n+        int matchFlags,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c39360adba1bf94fa9aaec438f93ad91b23b1abd"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1MjIzMQ==", "bodyText": "This was a bug!", "url": "https://github.com/elastic/elasticsearch/pull/61927#discussion_r483052231", "createdAt": "2020-09-03T15:08:42Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptIpMappedFieldType.java", "diffHunk": "@@ -119,14 +109,18 @@ public Query rangeQuery(\n     public Query termQuery(Object value, QueryShardContext context) {\n         checkAllowExpensiveQueries(context);\n         if (value instanceof InetAddress) {\n-            return InetAddressPoint.newExactQuery(name(), (InetAddress) value);\n+            return inetAddressQuery((InetAddress) value, context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c39360adba1bf94fa9aaec438f93ad91b23b1abd"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1MjQzNQ==", "bodyText": "I'd like to leave this for later.", "url": "https://github.com/elastic/elasticsearch/pull/61927#discussion_r483052435", "createdAt": "2020-09-03T15:09:02Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptKeywordMappedFieldType.java", "diffHunk": "@@ -127,32 +117,37 @@ public Query rangeQuery(\n     }\n \n     @Override\n-    public Query regexpQuery(String value, int flags, int maxDeterminizedStates, RewriteMethod method, QueryShardContext context) {\n+    public Query regexpQuery(\n+        String value,\n+        int syntaxFlags,\n+        int matchFlags,\n+        int maxDeterminizedStates,\n+        RewriteMethod method,\n+        QueryShardContext context\n+    ) {\n         checkAllowExpensiveQueries(context);\n-        return new StringScriptFieldRegexpQuery(script, leafFactory(context.lookup()), name(), value, flags, maxDeterminizedStates);\n+        if (matchFlags != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c39360adba1bf94fa9aaec438f93ad91b23b1abd"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0716b27f5ee3dc8572f0d34ca5092c9a93b45f70", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/0716b27f5ee3dc8572f0d34ca5092c9a93b45f70", "committedDate": "2020-09-03T15:39:57Z", "message": "Merge branch 'master' into runtime_fields_loop_in_query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ce71746f1bea55d9f8206b2d1cd3fb4cc620b9a", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ce71746f1bea55d9f8206b2d1cd3fb4cc620b9a", "committedDate": "2020-09-04T14:45:38Z", "message": "Merge branch 'master' into runtime_fields_loop_in_query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MTY1MDIy", "url": "https://github.com/elastic/elasticsearch/pull/61927#pullrequestreview-485165022", "createdAt": "2020-09-09T15:58:45Z", "commit": {"oid": "0716b27f5ee3dc8572f0d34ca5092c9a93b45f70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo1ODo0NVrOHPORbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNTo1ODo0NVrOHPORbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyNDUyNw==", "bodyText": "I've seen this popup in this and some other PR, can we merge this fix separately?", "url": "https://github.com/elastic/elasticsearch/pull/61927#discussion_r485724527", "createdAt": "2020-09-09T15:58:45Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptMappedFieldType.java", "diffHunk": "@@ -102,38 +133,47 @@ public Query fuzzyQuery(\n         throw new IllegalArgumentException(unsupported(\"fuzzy\", \"keyword and text\"));\n     }\n \n+    @Override\n     public Query prefixQuery(String value, MultiTermQuery.RewriteMethod method, QueryShardContext context) {\n         throw new IllegalArgumentException(unsupported(\"prefix\", \"keyword, text and wildcard\"));\n     }\n \n+    @Override\n     public Query wildcardQuery(String value, MultiTermQuery.RewriteMethod method, QueryShardContext context) {\n         throw new IllegalArgumentException(unsupported(\"wildcard\", \"keyword, text and wildcard\"));\n     }\n \n+    @Override\n     public Query regexpQuery(\n         String value,\n-        int flags,\n+        int syntaxFlags,\n+        int matchFlags,\n         int maxDeterminizedStates,\n-        MultiTermQuery.RewriteMethod method,\n+        RewriteMethod method,\n         QueryShardContext context\n     ) {\n         throw new IllegalArgumentException(unsupported(\"regexp\", \"keyword and text\"));\n     }\n \n+    @Override\n     public abstract Query existsQuery(QueryShardContext context);\n \n+    @Override\n     public Query phraseQuery(TokenStream stream, int slop, boolean enablePositionIncrements) throws IOException {\n         throw new IllegalArgumentException(unsupported(\"phrase\", \"text\"));\n     }\n \n+    @Override\n     public Query multiPhraseQuery(TokenStream stream, int slop, boolean enablePositionIncrements) throws IOException {\n         throw new IllegalArgumentException(unsupported(\"phrase\", \"text\"));\n     }\n \n+    @Override\n     public Query phrasePrefixQuery(TokenStream stream, int slop, int maxExpansions) throws IOException {\n         throw new IllegalArgumentException(unsupported(\"phrase prefix\", \"text\"));\n     }\n \n+    @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0716b27f5ee3dc8572f0d34ca5092c9a93b45f70"}, "originalPosition": 125}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MzcyMDYz", "url": "https://github.com/elastic/elasticsearch/pull/61927#pullrequestreview-485372063", "createdAt": "2020-09-09T20:17:51Z", "commit": {"oid": "0716b27f5ee3dc8572f0d34ca5092c9a93b45f70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDoxNzo1MlrOHPYzwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDoxNzo1MlrOHPYzwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5NzE1Mg==", "bodyText": "do you mind adding one test here also for loops around queries? I know you wrote a lot of those above (thanks) but I would find this yaml suite more complete if we also covered loops for queries (I did not add specific tests in the first place because I knew they would fail)", "url": "https://github.com/elastic/elasticsearch/pull/61927#discussion_r485897152", "createdAt": "2020-09-09T20:17:52Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/90_loops.yml", "diffHunk": "@@ -183,6 +183,7 @@ setup:\n             loop:\n              terms:\n                field: over_max_depth", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0716b27f5ee3dc8572f0d34ca5092c9a93b45f70"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72c1b8b03074f188e1e98d5da04501e6d90c880a", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/72c1b8b03074f188e1e98d5da04501e6d90c880a", "committedDate": "2020-09-10T21:49:04Z", "message": "Merge branch 'master' into runtime_fields_loop_in_query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f780a42b36f5bf07e4a89722cbc28dfd2e15f588", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f780a42b36f5bf07e4a89722cbc28dfd2e15f588", "committedDate": "2020-09-14T13:09:47Z", "message": "Compile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bc988b8cbb383f910f98512ae224183bed98903", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4bc988b8cbb383f910f98512ae224183bed98903", "committedDate": "2020-09-14T13:12:31Z", "message": "Prettier"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NzM3NzY4", "url": "https://github.com/elastic/elasticsearch/pull/61927#pullrequestreview-487737768", "createdAt": "2020-09-14T13:11:56Z", "commit": {"oid": "f780a42b36f5bf07e4a89722cbc28dfd2e15f588"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzoxMTo1NlrOHRTE1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzoxNDowMlrOHRTJ8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkwMDM3Mw==", "bodyText": "This is something I bumped into while working on this. Just had the old name left over.", "url": "https://github.com/elastic/elasticsearch/pull/61927#discussion_r487900373", "createdAt": "2020-09-14T13:11:56Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptMappedFieldType.java", "diffHunk": "@@ -149,7 +179,7 @@ public SpanQuery spanPrefixQuery(String value, SpanMultiTermQueryWrapper.SpanRew\n     }\n \n     private String unsupported(String query, String supported) {\n-        String thisField = \"[\" + name() + \"] which is of type [script] with runtime_type [\" + runtimeType() + \"]\";\n+        String thisField = \"[\" + name() + \"] which is of type [runtime] with runtime_type [\" + runtimeType() + \"]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f780a42b36f5bf07e4a89722cbc28dfd2e15f588"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkwMDkxOQ==", "bodyText": "This is the other half of the \"old name\" bug I fixed way above.", "url": "https://github.com/elastic/elasticsearch/pull/61927#discussion_r487900919", "createdAt": "2020-09-14T13:12:49Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/test/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractNonTextScriptMappedFieldTypeTestCase.java", "diffHunk": "@@ -43,7 +43,7 @@ private void assertQueryOnlyOnTextAndKeyword(String queryName, ThrowingRunnable\n             equalTo(\n                 \"Can only use \"\n                     + queryName\n-                    + \" queries on keyword and text fields - not on [test] which is of type [script] with runtime_type [\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f780a42b36f5bf07e4a89722cbc28dfd2e15f588"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkwMTY4Mg==", "bodyText": "I've added some in the last commit I pushed.", "url": "https://github.com/elastic/elasticsearch/pull/61927#discussion_r487901682", "createdAt": "2020-09-14T13:14:02Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/90_loops.yml", "diffHunk": "@@ -183,6 +183,7 @@ setup:\n             loop:\n              terms:\n                field: over_max_depth", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5NzE1Mg=="}, "originalCommit": {"oid": "0716b27f5ee3dc8572f0d34ca5092c9a93b45f70"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b66a16dcdadc0fb580881301ad3055d349f916a7", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/b66a16dcdadc0fb580881301ad3055d349f916a7", "committedDate": "2020-09-14T13:49:18Z", "message": "Merge branch 'master' into runtime_fields_loop_in_query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDM2NjQx", "url": "https://github.com/elastic/elasticsearch/pull/61927#pullrequestreview-488436641", "createdAt": "2020-09-15T08:16:25Z", "commit": {"oid": "b66a16dcdadc0fb580881301ad3055d349f916a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45d124b7f70bcea52fc5a5d2888328237565db5d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/45d124b7f70bcea52fc5a5d2888328237565db5d", "committedDate": "2020-09-15T17:01:46Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bef47e22477a9def3d13353f7533279ee31b897a", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/bef47e22477a9def3d13353f7533279ee31b897a", "committedDate": "2020-09-15T18:16:04Z", "message": "Merge branch 'master' into runtime_fields_loop_in_query"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4829, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}