{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NDQzMDky", "number": 58196, "title": "For the fields fetch phase, avoid reloading stored fields.", "bodyText": "This PR updates FetchFieldsPhase to override hitExecute instead of hitsExecute\n(plural). This way, we can make sure that the stored fields (including _source)\nare only loaded once per hit as part of FetchPhase.\nThis improves the performance of fields loading so that it's very close to\nsource filtering. See #55363 (comment) for more details.\nRelates to #55363.", "createdAt": "2020-06-16T20:14:20Z", "url": "https://github.com/elastic/elasticsearch/pull/58196", "merged": true, "mergeCommit": {"oid": "d652d7226ea0bd1d19d91fec6459d5eef53b47b5"}, "closed": true, "closedAt": "2020-06-17T17:36:11Z", "author": {"login": "jtibshirani"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr7MQsgH2gAyNDM1NDQzMDkyOjJjNzI3OWRiNDY4OWM1MjY2MDhhYWMyZjgzMmEzMmE3M2VkZmFhMGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr8gmKAH2gAyNDM1NDQzMDkyOjAyYzVjNTk5ZGRkMjI2OTQxNzU4ODY1NzQyM2M3NzA0MzBiZmM1YWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c7279db4689c526608aac2f832a32a73edfaa0f", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/2c7279db4689c526608aac2f832a32a73edfaa0f", "committedDate": "2020-06-16T20:22:37Z", "message": "For the fields fetch phase, avoid reloading stored fields.\n\nThis PR updates FetchFieldsPhase to override hitExecute instead of hitsExecute\n(plural). This way, we can make sure that the stored fields (including _source)\nare only loaded once per hit as part of FetchPhase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47c46f9e816ed8a0f7a893a6167ac38d60cc625b", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/47c46f9e816ed8a0f7a893a6167ac38d60cc625b", "committedDate": "2020-06-16T20:04:10Z", "message": "For the fields fetch phase, avoid reloading stored fields.\n\nThis PR updates FetchFieldsPhase to override hitExecute instead of hitsExecute\n(plural). This way, we can make sure that the stored fields (including _source)\nare only loaded once per hit as part of FetchPhase."}, "afterCommit": {"oid": "2c7279db4689c526608aac2f832a32a73edfaa0f", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/2c7279db4689c526608aac2f832a32a73edfaa0f", "committedDate": "2020-06-16T20:22:37Z", "message": "For the fields fetch phase, avoid reloading stored fields.\n\nThis PR updates FetchFieldsPhase to override hitExecute instead of hitsExecute\n(plural). This way, we can make sure that the stored fields (including _source)\nare only loaded once per hit as part of FetchPhase."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODY4Nzc3", "url": "https://github.com/elastic/elasticsearch/pull/58196#pullrequestreview-431868777", "createdAt": "2020-06-16T20:31:52Z", "commit": {"oid": "2c7279db4689c526608aac2f832a32a73edfaa0f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMDozMTo1MlrOGksEvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMDozMTo1MlrOGksEvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEyNDAzMQ==", "bodyText": "Should we have the same logic in the else below or do we expect users to not use stored_fields in conjunction with the new fields option ?", "url": "https://github.com/elastic/elasticsearch/pull/58196#discussion_r441124031", "createdAt": "2020-06-16T20:31:52Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -101,7 +101,8 @@ public void execute(SearchContext context) {\n             if (!context.hasScriptFields() && !context.hasFetchSourceContext()) {\n                 context.fetchSourceContext(new FetchSourceContext(true));\n             }\n-            fieldsVisitor = new FieldsVisitor(context.sourceRequested());\n+            boolean loadSource = context.sourceRequested() || context.fetchFieldsContext() != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c7279db4689c526608aac2f832a32a73edfaa0f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1ff79aa51408e581b9b993bbf043ff91b35d106", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/b1ff79aa51408e581b9b993bbf043ff91b35d106", "committedDate": "2020-06-16T21:21:34Z", "message": "Make sure to load _source when stored_fields are requested."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxOTE2Mjg2", "url": "https://github.com/elastic/elasticsearch/pull/58196#pullrequestreview-431916286", "createdAt": "2020-06-16T21:48:07Z", "commit": {"oid": "b1ff79aa51408e581b9b993bbf043ff91b35d106"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMTo0ODowN1rOGkuWwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMTo0ODowN1rOGkuWwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2MTQwOQ==", "bodyText": "I tend to stick refresh on the index request.", "url": "https://github.com/elastic/elasticsearch/pull/58196#discussion_r441161409", "createdAt": "2020-06-16T21:48:07Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/330_fetch_fields.yml", "diffHunk": "@@ -169,3 +169,51 @@ setup:\n \n   - match: { hits.hits.0.fields.integer.0: 42 }\n   - is_false: hits.hits.1.fields.integer\n+\n+---\n+\"Test disable _source loading\":\n+  - do:\n+      indices.create:\n+        index:  test\n+        body:\n+          settings:\n+            number_of_shards: 1\n+          mappings:\n+            properties:\n+              keyword:\n+                type: keyword\n+              integer:\n+                type: integer\n+                store: true\n+\n+  - do:\n+      index:\n+        index:  test\n+        id:     1\n+        body:\n+          keyword: \"x\"\n+          integer: 42\n+\n+  - do:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1ff79aa51408e581b9b993bbf043ff91b35d106"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02c5c599ddd2269417588657423c770430bfc5af", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/02c5c599ddd2269417588657423c770430bfc5af", "committedDate": "2020-06-16T21:54:44Z", "message": "Small simplification to YAML test."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 549, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}