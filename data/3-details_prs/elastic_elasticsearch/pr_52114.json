{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyODg1MTUy", "number": 52114, "title": "Smarter copying of the rest specs and tests", "bodyText": "This PR addresses the unnecessary copying of the rest specs and allows\nfor better semantics for which specs and tests are copied. By default\nthe rest specs will get copied if the project applies\nelasticsearch.standalone-rest-test or esplugin and the project\nhas rest tests or you configure the custom extension restResources.\nThis PR also removes the need for dozens of places where the x-pack\nspecs were copied by supporting copying of the x-pack rest specs too.\nThe plugin/task introduced here can also copy the rest tests to the\nlocal project through a similar configuration.\nThe new plugin/task allows a user to minimize the surface area of\nwhich rest specs are copied. Per project can be configured to include\nonly a subset of the specs (or tests). Configuring a project to only\ncopy the specs when actually needed should help with build cache hit\nrates since we can better define what is actually in use.\nHowever, project level optimizations for build cache hit rates are\nnot included with this PR.\nAlso, with this PR you can no longer use the includePackaged flag on\nintegTest task.\nThe following items are included in this PR:\n\nnew plugin: elasticsearch.rest-resources\nnew tasks: CopyRestApiTask and CopyRestTestsTask - performs the copy\nnew extension 'restResources'\n\nrestResources {\n  restApi {\n    includeCore 'foo' , 'bar' //will include the core specs that start with foo and bar\n    includeXpack 'baz' //will include x-pack specs that start with baz\n  }\n  restTests {\n    includeCore 'foo', 'bar' //will include the core tests that start with foo and bar\n    includeXpack 'baz' //will include the x-pack tests that start with baz\n  }\n}", "createdAt": "2020-02-09T23:04:40Z", "url": "https://github.com/elastic/elasticsearch/pull/52114", "merged": true, "mergeCommit": {"oid": "810dc9fce3af94197c318ee6fd606730daecd28d"}, "closed": true, "closedAt": "2020-02-26T00:46:33Z", "author": {"login": "jakelandis"}, "timelineItems": {"totalCount": 36, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCwttXAH2gAyMzcyODg1MTUyOmM3ZDM2ZTA2M2VkM2Y3ODlhYWFhMDBiYTNlNWQzNTFmYjQ2ZDYwMzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcH6-KwgH2gAyMzcyODg1MTUyOjllNmUyYWEyMTFlMjVlYmZkYjg1ODMxNWZiNGQ1OTY3ODNmOWExY2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c7d36e063ed3f789aaaa00ba3e5d351fb46d6034", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/c7d36e063ed3f789aaaa00ba3e5d351fb46d6034", "committedDate": "2020-02-09T22:59:18Z", "message": "Smarter copying of the rest specs and tests\n\nThis PR addresses the uncessary copying of the rest specs and allows for better semantics for which specs and tests are copied. By default the rest specs will get copied if the project applies `elasticsearch.standalone-rest-test` or `esplugin` and the project has rest tests. If the project does not have rest tests, you can configure the project to copy the specs anyway with `restApiSpec { alwaysCopySpec true }`. This PR also removes the need for dozens of places where the x-pack specs were copied by supporting copying of the x-pack rest specs if the project starts with `:x-pack` and the preceeding applies. The plugin introduced here can also copy the rest tests to the local project through similar configuration.\n\nThe new plugin allows a user to minimize the surface area of which rest specs are copyied. Per project can be configured to include only a subset of the specs (or tests) `restApiSpec { includeXpackSpec \"ccr\" }` through a custom plugin extention. Only copying the specs when actually needed and only copying the minimal set of specs should help with build cache hit rates since we can define only what is in use. Project level optimizations for build cache hit rates are not included with this PR.\n\nAlso, with this PR you can no longer use the includePackaged flag on integTest task, instead you will need to configure the plugin extention `restApiSpec { copyCoreTests true  }`. Support for copying the rest tests from an external JAR is also dropped. While techincally non-passive, I can not imaging why a plugin developer (or any user of that JAR) would need the rest tests accessible from our `integTest` task. (the tests are still aviable in jar)\n\nThe following items are included in this PR:\n`apply plugin: 'elasticsearch.rest-api-spec-for-testing'` (applied by default to `elasticsearch.standalone-rest-test` and `esplugin`)\n```\nrestApiSpec {\n  includeCoreSpec \"foo\" //will include the core specs that start with foo\n  includeXpackSpec \"bar\" //will include x-pack specs that start with bar\n  copyCoreTests true //will copy the core rest tests to the local project\n  includeCoreTests \"foo\" //will include the core tests that start with foo\n  copyXpackTests true //will copy the x-pack rest tests to the local project\n  includeXpackTests \"bar\" //will include the x-pack tests that start with bar\n  alwaysCopySpec true //will always copy the specs (core and/or x-pack), even if no tests exist to to the local project\n}\n```"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e02fbe8139e4698e1fdf46e29f5602a80ea4207", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/1e02fbe8139e4698e1fdf46e29f5602a80ea4207", "committedDate": "2020-02-09T23:24:15Z", "message": "fix autoscaling project (merge clash)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02f95b8a814b961fec545e03891d21ac3d509462", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/02f95b8a814b961fec545e03891d21ac3d509462", "committedDate": "2020-02-09T23:45:17Z", "message": "fix graph tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b81e65cdc523c14f64a9849a0c13684612943a2", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b81e65cdc523c14f64a9849a0c13684612943a2", "committedDate": "2020-02-10T14:45:47Z", "message": "fix xpack docs build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f334d4050181f0f93aadb7f80a0ed36e07763914", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/f334d4050181f0f93aadb7f80a0ed36e07763914", "committedDate": "2020-02-10T15:46:52Z", "message": "fix ml tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1ee4ffaf56f82ae7730071967f6f63ac7226199", "committedDate": "2020-02-10T19:41:27Z", "message": "Merge branch 'master' into rest_spec_from_common_dir3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzI5NjI4", "url": "https://github.com/elastic/elasticsearch/pull/52114#pullrequestreview-356329628", "createdAt": "2020-02-10T23:03:42Z", "commit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzowMzo0M1rOFn41UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzowMzo0M1rOFn41UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM2OTkzNw==", "bodyText": "tip: this could be String... include to make the DSL a little less verbose allowing for things like includeCoreSpec 'foo', 'bar'.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r377369937", "createdAt": "2020-02-10T23:03:43Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/RestApiSpecExtension.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package org.elasticsearch.gradle.test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class RestApiSpecExtension {\n+    private List<String> includesCoreSpec = new ArrayList<>();\n+    private List<String> includesCoreTests = new ArrayList<>();\n+    private List<String> includesXpackSpec = new ArrayList<>();\n+    private List<String> includesXpackTests = new ArrayList<>();\n+    private boolean alwaysCopySpec = false;\n+    private boolean copyTests = false;\n+    private boolean copyXpackTests = false;\n+\n+    public void includeCoreSpec(String include) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzMwMTUy", "url": "https://github.com/elastic/elasticsearch/pull/52114#pullrequestreview-356330152", "createdAt": "2020-02-10T23:04:59Z", "commit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzowNDo1OVrOFn43Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzowNDo1OVrOFn43Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3MDM3NA==", "bodyText": "We should use a typical setter/getter pattern here. I think configuring  likecopyCoreTests = true is more idiomatic.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r377370374", "createdAt": "2020-02-10T23:04:59Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/RestApiSpecExtension.java", "diffHunk": "@@ -0,0 +1,70 @@\n+package org.elasticsearch.gradle.test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class RestApiSpecExtension {\n+    private List<String> includesCoreSpec = new ArrayList<>();\n+    private List<String> includesCoreTests = new ArrayList<>();\n+    private List<String> includesXpackSpec = new ArrayList<>();\n+    private List<String> includesXpackTests = new ArrayList<>();\n+    private boolean alwaysCopySpec = false;\n+    private boolean copyTests = false;\n+    private boolean copyXpackTests = false;\n+\n+    public void includeCoreSpec(String include) {\n+        includesCoreSpec.add(include);\n+    }\n+\n+    public List<String> getIncludesCoreSpec() {\n+        return includesCoreSpec;\n+    }\n+\n+    public void includeCoreTests(String include) {\n+        includesCoreTests.add(include);\n+    }\n+\n+    public List<String> getIncludesCoreTests() {\n+        return includesCoreTests;\n+    }\n+\n+    public void includeXpackSpec(String include) {\n+        includesXpackSpec.add(include);\n+    }\n+\n+    public List<String> getIncludesXpackSpec() {\n+        return includesXpackSpec;\n+    }\n+\n+    public void copyCoreTests(boolean copyTests) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzMxMDMz", "url": "https://github.com/elastic/elasticsearch/pull/52114#pullrequestreview-356331033", "createdAt": "2020-02-10T23:07:05Z", "commit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzowNzowNlrOFn458Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzowNzowNlrOFn458Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3MTEyMQ==", "bodyText": "I'm wondering if everywhere we see REST we should actually use YAML. If you are not using are YAML testing framework, is anything of this stuff useful? That is, for the Java-based REST tests, do we need any of this stuff? If not, let's be more specific since we already overload the phrase \"rest tests\" to an enormous degree, let's be as specific as possible with naming conventions here.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r377371121", "createdAt": "2020-02-10T23:07:06Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/RestApiSpecForTestingPlugin.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.SourceSet;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+//TODO: change logger.info to logger.debug\n+public class RestApiSpecForTestingPlugin implements Plugin<Project> {\n+\n+    private static final Logger logger = Logging.getLogger(RestApiSpecForTestingPlugin.class);\n+    private static final String EXTENSION_NAME = \"restApiSpec\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzMxODg1", "url": "https://github.com/elastic/elasticsearch/pull/52114#pullrequestreview-356331885", "createdAt": "2020-02-10T23:09:09Z", "commit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzowOTowOVrOFn481w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzowOTowOVrOFn481w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3MTg2Mw==", "bodyText": "I think this may go without saying after your comment about lazy properties, but with your new direction instead we would always create the copy tasks, they would simply be skipped in cases where we didn't configure any includes. In this case Gradle would report the task as NO-SOURCE I believe, indicating that task was scheduled for execution, but didn't have any work to perform.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r377371863", "createdAt": "2020-02-10T23:09:09Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/RestApiSpecForTestingPlugin.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.SourceSet;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+//TODO: change logger.info to logger.debug\n+public class RestApiSpecForTestingPlugin implements Plugin<Project> {\n+\n+    private static final Logger logger = Logging.getLogger(RestApiSpecForTestingPlugin.class);\n+    private static final String EXTENSION_NAME = \"restApiSpec\";\n+    private static final String apiDir = \"rest-api-spec/api\";\n+    private static final String testDir = \"rest-api-spec/test\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        RestApiSpecExtension extension = project.getExtensions().create(EXTENSION_NAME, RestApiSpecExtension.class);\n+        // need to defer to after evaluation to allow the custom extension to be populated\n+        project.afterEvaluate(p -> {\n+            try {\n+                // copy tests\n+                boolean hasCopiedTests = false;\n+                if (extension.shouldCopyCoreTests()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzMyNjEw", "url": "https://github.com/elastic/elasticsearch/pull/52114#pullrequestreview-356332610", "createdAt": "2020-02-10T23:10:44Z", "commit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzoxMDo0NFrOFn4_BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzoxMDo0NFrOFn4_BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3MjQyMQ==", "bodyText": "Please use getTasks.register() instead of create() so we can avoid creating these tasks if they aren't to be executed.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r377372421", "createdAt": "2020-02-10T23:10:44Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/RestApiSpecForTestingPlugin.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.SourceSet;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+//TODO: change logger.info to logger.debug\n+public class RestApiSpecForTestingPlugin implements Plugin<Project> {\n+\n+    private static final Logger logger = Logging.getLogger(RestApiSpecForTestingPlugin.class);\n+    private static final String EXTENSION_NAME = \"restApiSpec\";\n+    private static final String apiDir = \"rest-api-spec/api\";\n+    private static final String testDir = \"rest-api-spec/test\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        RestApiSpecExtension extension = project.getExtensions().create(EXTENSION_NAME, RestApiSpecExtension.class);\n+        // need to defer to after evaluation to allow the custom extension to be populated\n+        project.afterEvaluate(p -> {\n+            try {\n+                // copy tests\n+                boolean hasCopiedTests = false;\n+                if (extension.shouldCopyCoreTests()) {\n+                    Configuration coreTestConfig = project.getConfigurations().create(\"copyRestSpecCoreTests\");\n+                    Dependency coreTestDep = project.getDependencies()\n+                        .project(Map.of(\"path\", \":rest-api-spec\", \"configuration\", \"restSpecCoreTests\"));\n+                    logger.info(\"Rest specs tests for project [{}] will be copied to the test resources.\", project.getPath());\n+                    createCopyTask(project, coreTestConfig, coreTestDep, extension.getIncludesCoreTests(), testDir, false);\n+                    hasCopiedTests = true;\n+                }\n+                if (extension.shouldCopyXpackTests()) {\n+                    Configuration xpackSpecTestsConfig = project.getConfigurations().create(\"copyRestSpecXpackTests\");\n+                    Dependency xpackTestsDep = project.getDependencies()\n+                        .project(Map.of(\"path\", \":x-pack:plugin\", \"configuration\", \"restSpecXpackTests\"));\n+                    logger.info(\"Rest specs x-pack tests for project [{}] will be copied to the test resources.\", project.getPath());\n+                    createCopyTask(project, xpackSpecTestsConfig, xpackTestsDep, extension.getIncludesXpackTests(), testDir, false);\n+                    hasCopiedTests = true;\n+                }\n+                // copy specs\n+                if (projectHasRestTests(project) || hasCopiedTests || extension.shouldAlwaysCopySpec()) {\n+                    Configuration coreSpecConfig = project.getConfigurations().create(\"restSpec\"); // name chosen for passivity\n+                    Dependency coreSpecDep = project.getDependencies()\n+                        .project(Map.of(\"path\", \":rest-api-spec\", \"configuration\", \"restSpecCore\"));\n+\n+                    if (BuildParams.isInternal()) {\n+                        // source the specs from this project - this is the path for Elasticsearch builds\n+                        if (project.getPath().startsWith(\":x-pack\")) {\n+                            Configuration xpackSpecConfig = project.getConfigurations().create(\"copyRestSpecXpack\");\n+                            Dependency xpackSpecDep = project.getDependencies()\n+                                .project(Map.of(\"path\", \":x-pack:plugin\", \"configuration\", \"restSpecXpack\"));\n+                            logger.info(\"X-pack rest specs for project [{}] will be copied to the test resources.\", project.getPath());\n+                            createCopyTask(project, xpackSpecConfig, xpackSpecDep, extension.getIncludesXpackSpec(), apiDir, false);\n+                        }\n+\n+                        logger.info(\"Rest specs for project [{}] will be copied to the test resources.\", project.getPath());\n+                        createCopyTask(project, coreSpecConfig, coreSpecDep, extension.getIncludesCoreSpec(), apiDir, false);\n+\n+                    } else {\n+                        // source the specs from the published jar - this is the path plugin developers\n+                        logger.info(\n+                            \"Rest specs for project [{}] will be copied to the test resources from the published jar (version: [{}]).\",\n+                            project.getPath(),\n+                            VersionProperties.getElasticsearch()\n+                        );\n+                        Dependency coreSpecFromJarDep = project.getDependencies()\n+                            .create(\"org.elasticsearch:rest-api-spec:\" + VersionProperties.getElasticsearch());\n+\n+                        createCopyTask(project, coreSpecConfig, coreSpecFromJarDep, extension.getIncludesCoreSpec(), \"\", true);\n+                    }\n+                } else {\n+                    logger.info(\"Rest specs will be ignored for project [{}] since there are no REST tests\", project.getPath());\n+                    return;\n+                }\n+            } catch (Exception e) {\n+                throw new IllegalStateException(\"Error configuring the rest-api-spec-for-testing plugin. This is likely a bug.\", e);\n+            }\n+        });\n+    }\n+\n+    private void createCopyTask(Project project, Configuration config, Dependency dep, List<String> includes, String into, boolean isJar) {\n+        project.getDependencies().add(config.getName(), dep);\n+        Copy copyTask = project.getTasks().create(config.getName() + \"Task\", Copy.class, copy -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzMzMDQ3", "url": "https://github.com/elastic/elasticsearch/pull/52114#pullrequestreview-356333047", "createdAt": "2020-02-10T23:11:50Z", "commit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzoxMTo1MFrOFn5AYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzoxMTo1MFrOFn5AYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3Mjc3MQ==", "bodyText": "We need to wrap any calls to Configuration.getSingleFile() in some kind of deferrable, such as Callable otherwise we'll trigger the configuration to be resolved during configuration time, which in the case of an external dependency means downloading the JAR.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r377372771", "createdAt": "2020-02-10T23:11:50Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/RestApiSpecForTestingPlugin.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.SourceSet;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+//TODO: change logger.info to logger.debug\n+public class RestApiSpecForTestingPlugin implements Plugin<Project> {\n+\n+    private static final Logger logger = Logging.getLogger(RestApiSpecForTestingPlugin.class);\n+    private static final String EXTENSION_NAME = \"restApiSpec\";\n+    private static final String apiDir = \"rest-api-spec/api\";\n+    private static final String testDir = \"rest-api-spec/test\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        RestApiSpecExtension extension = project.getExtensions().create(EXTENSION_NAME, RestApiSpecExtension.class);\n+        // need to defer to after evaluation to allow the custom extension to be populated\n+        project.afterEvaluate(p -> {\n+            try {\n+                // copy tests\n+                boolean hasCopiedTests = false;\n+                if (extension.shouldCopyCoreTests()) {\n+                    Configuration coreTestConfig = project.getConfigurations().create(\"copyRestSpecCoreTests\");\n+                    Dependency coreTestDep = project.getDependencies()\n+                        .project(Map.of(\"path\", \":rest-api-spec\", \"configuration\", \"restSpecCoreTests\"));\n+                    logger.info(\"Rest specs tests for project [{}] will be copied to the test resources.\", project.getPath());\n+                    createCopyTask(project, coreTestConfig, coreTestDep, extension.getIncludesCoreTests(), testDir, false);\n+                    hasCopiedTests = true;\n+                }\n+                if (extension.shouldCopyXpackTests()) {\n+                    Configuration xpackSpecTestsConfig = project.getConfigurations().create(\"copyRestSpecXpackTests\");\n+                    Dependency xpackTestsDep = project.getDependencies()\n+                        .project(Map.of(\"path\", \":x-pack:plugin\", \"configuration\", \"restSpecXpackTests\"));\n+                    logger.info(\"Rest specs x-pack tests for project [{}] will be copied to the test resources.\", project.getPath());\n+                    createCopyTask(project, xpackSpecTestsConfig, xpackTestsDep, extension.getIncludesXpackTests(), testDir, false);\n+                    hasCopiedTests = true;\n+                }\n+                // copy specs\n+                if (projectHasRestTests(project) || hasCopiedTests || extension.shouldAlwaysCopySpec()) {\n+                    Configuration coreSpecConfig = project.getConfigurations().create(\"restSpec\"); // name chosen for passivity\n+                    Dependency coreSpecDep = project.getDependencies()\n+                        .project(Map.of(\"path\", \":rest-api-spec\", \"configuration\", \"restSpecCore\"));\n+\n+                    if (BuildParams.isInternal()) {\n+                        // source the specs from this project - this is the path for Elasticsearch builds\n+                        if (project.getPath().startsWith(\":x-pack\")) {\n+                            Configuration xpackSpecConfig = project.getConfigurations().create(\"copyRestSpecXpack\");\n+                            Dependency xpackSpecDep = project.getDependencies()\n+                                .project(Map.of(\"path\", \":x-pack:plugin\", \"configuration\", \"restSpecXpack\"));\n+                            logger.info(\"X-pack rest specs for project [{}] will be copied to the test resources.\", project.getPath());\n+                            createCopyTask(project, xpackSpecConfig, xpackSpecDep, extension.getIncludesXpackSpec(), apiDir, false);\n+                        }\n+\n+                        logger.info(\"Rest specs for project [{}] will be copied to the test resources.\", project.getPath());\n+                        createCopyTask(project, coreSpecConfig, coreSpecDep, extension.getIncludesCoreSpec(), apiDir, false);\n+\n+                    } else {\n+                        // source the specs from the published jar - this is the path plugin developers\n+                        logger.info(\n+                            \"Rest specs for project [{}] will be copied to the test resources from the published jar (version: [{}]).\",\n+                            project.getPath(),\n+                            VersionProperties.getElasticsearch()\n+                        );\n+                        Dependency coreSpecFromJarDep = project.getDependencies()\n+                            .create(\"org.elasticsearch:rest-api-spec:\" + VersionProperties.getElasticsearch());\n+\n+                        createCopyTask(project, coreSpecConfig, coreSpecFromJarDep, extension.getIncludesCoreSpec(), \"\", true);\n+                    }\n+                } else {\n+                    logger.info(\"Rest specs will be ignored for project [{}] since there are no REST tests\", project.getPath());\n+                    return;\n+                }\n+            } catch (Exception e) {\n+                throw new IllegalStateException(\"Error configuring the rest-api-spec-for-testing plugin. This is likely a bug.\", e);\n+            }\n+        });\n+    }\n+\n+    private void createCopyTask(Project project, Configuration config, Dependency dep, List<String> includes, String into, boolean isJar) {\n+        project.getDependencies().add(config.getName(), dep);\n+        Copy copyTask = project.getTasks().create(config.getName() + \"Task\", Copy.class, copy -> {\n+            copy.from(isJar ? project.zipTree(config.getSingleFile()) : config.getSingleFile());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzMzODQx", "url": "https://github.com/elastic/elasticsearch/pull/52114#pullrequestreview-356333841", "createdAt": "2020-02-10T23:13:40Z", "commit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzoxMzo0MFrOFn5C9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMzoxMzo0MFrOFn5C9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM3MzQzMQ==", "bodyText": "Should be unnecessary since false is the default behavior here.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r377373431", "createdAt": "2020-02-10T23:13:40Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/RestApiSpecForTestingPlugin.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.SourceSet;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+//TODO: change logger.info to logger.debug\n+public class RestApiSpecForTestingPlugin implements Plugin<Project> {\n+\n+    private static final Logger logger = Logging.getLogger(RestApiSpecForTestingPlugin.class);\n+    private static final String EXTENSION_NAME = \"restApiSpec\";\n+    private static final String apiDir = \"rest-api-spec/api\";\n+    private static final String testDir = \"rest-api-spec/test\";\n+\n+    @Override\n+    public void apply(Project project) {\n+\n+        RestApiSpecExtension extension = project.getExtensions().create(EXTENSION_NAME, RestApiSpecExtension.class);\n+        // need to defer to after evaluation to allow the custom extension to be populated\n+        project.afterEvaluate(p -> {\n+            try {\n+                // copy tests\n+                boolean hasCopiedTests = false;\n+                if (extension.shouldCopyCoreTests()) {\n+                    Configuration coreTestConfig = project.getConfigurations().create(\"copyRestSpecCoreTests\");\n+                    Dependency coreTestDep = project.getDependencies()\n+                        .project(Map.of(\"path\", \":rest-api-spec\", \"configuration\", \"restSpecCoreTests\"));\n+                    logger.info(\"Rest specs tests for project [{}] will be copied to the test resources.\", project.getPath());\n+                    createCopyTask(project, coreTestConfig, coreTestDep, extension.getIncludesCoreTests(), testDir, false);\n+                    hasCopiedTests = true;\n+                }\n+                if (extension.shouldCopyXpackTests()) {\n+                    Configuration xpackSpecTestsConfig = project.getConfigurations().create(\"copyRestSpecXpackTests\");\n+                    Dependency xpackTestsDep = project.getDependencies()\n+                        .project(Map.of(\"path\", \":x-pack:plugin\", \"configuration\", \"restSpecXpackTests\"));\n+                    logger.info(\"Rest specs x-pack tests for project [{}] will be copied to the test resources.\", project.getPath());\n+                    createCopyTask(project, xpackSpecTestsConfig, xpackTestsDep, extension.getIncludesXpackTests(), testDir, false);\n+                    hasCopiedTests = true;\n+                }\n+                // copy specs\n+                if (projectHasRestTests(project) || hasCopiedTests || extension.shouldAlwaysCopySpec()) {\n+                    Configuration coreSpecConfig = project.getConfigurations().create(\"restSpec\"); // name chosen for passivity\n+                    Dependency coreSpecDep = project.getDependencies()\n+                        .project(Map.of(\"path\", \":rest-api-spec\", \"configuration\", \"restSpecCore\"));\n+\n+                    if (BuildParams.isInternal()) {\n+                        // source the specs from this project - this is the path for Elasticsearch builds\n+                        if (project.getPath().startsWith(\":x-pack\")) {\n+                            Configuration xpackSpecConfig = project.getConfigurations().create(\"copyRestSpecXpack\");\n+                            Dependency xpackSpecDep = project.getDependencies()\n+                                .project(Map.of(\"path\", \":x-pack:plugin\", \"configuration\", \"restSpecXpack\"));\n+                            logger.info(\"X-pack rest specs for project [{}] will be copied to the test resources.\", project.getPath());\n+                            createCopyTask(project, xpackSpecConfig, xpackSpecDep, extension.getIncludesXpackSpec(), apiDir, false);\n+                        }\n+\n+                        logger.info(\"Rest specs for project [{}] will be copied to the test resources.\", project.getPath());\n+                        createCopyTask(project, coreSpecConfig, coreSpecDep, extension.getIncludesCoreSpec(), apiDir, false);\n+\n+                    } else {\n+                        // source the specs from the published jar - this is the path plugin developers\n+                        logger.info(\n+                            \"Rest specs for project [{}] will be copied to the test resources from the published jar (version: [{}]).\",\n+                            project.getPath(),\n+                            VersionProperties.getElasticsearch()\n+                        );\n+                        Dependency coreSpecFromJarDep = project.getDependencies()\n+                            .create(\"org.elasticsearch:rest-api-spec:\" + VersionProperties.getElasticsearch());\n+\n+                        createCopyTask(project, coreSpecConfig, coreSpecFromJarDep, extension.getIncludesCoreSpec(), \"\", true);\n+                    }\n+                } else {\n+                    logger.info(\"Rest specs will be ignored for project [{}] since there are no REST tests\", project.getPath());\n+                    return;\n+                }\n+            } catch (Exception e) {\n+                throw new IllegalStateException(\"Error configuring the rest-api-spec-for-testing plugin. This is likely a bug.\", e);\n+            }\n+        });\n+    }\n+\n+    private void createCopyTask(Project project, Configuration config, Dependency dep, List<String> includes, String into, boolean isJar) {\n+        project.getDependencies().add(config.getName(), dep);\n+        Copy copyTask = project.getTasks().create(config.getName() + \"Task\", Copy.class, copy -> {\n+            copy.from(isJar ? project.zipTree(config.getSingleFile()) : config.getSingleFile());\n+            copy.into(new File(getTestSourceSet(project).getOutput().getResourcesDir(), into));\n+            if (includes.isEmpty()) {\n+                copy.include(isJar ? apiDir + \"/**\" : \"*/**\");\n+            } else {\n+                includes.forEach(s -> copy.include(isJar ? apiDir + \"/\" + s + \"*/**\" : s + \"*/**\"));\n+            }\n+            copy.setIncludeEmptyDirs(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1ee4ffaf56f82ae7730071967f6f63ac7226199"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f43429c29594e4bd6e8b0f75d8fbd5d7a96a15ea", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/f43429c29594e4bd6e8b0f75d8fbd5d7a96a15ea", "committedDate": "2020-02-12T19:04:29Z", "message": "Use lazy config, task, and review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "818e761124dce06e8209e9cd05cbdc31aaa64409", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/818e761124dce06e8209e9cd05cbdc31aaa64409", "committedDate": "2020-02-12T19:05:00Z", "message": "Merge branch 'master' into rest_spec_from_common_dir3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bddf05bebb3bf720059b7b5a124c009aded4e973", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/bddf05bebb3bf720059b7b5a124c009aded4e973", "committedDate": "2020-02-12T19:28:55Z", "message": "change name of plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c1d16403a3c6cb1e743f59e9b4d07fdb3facd58", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c1d16403a3c6cb1e743f59e9b4d07fdb3facd58", "committedDate": "2020-02-12T21:21:59Z", "message": "fix hlrc test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODA2MzE4", "url": "https://github.com/elastic/elasticsearch/pull/52114#pullrequestreview-357806318", "createdAt": "2020-02-12T21:38:24Z", "commit": {"oid": "0c1d16403a3c6cb1e743f59e9b4d07fdb3facd58"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMTozODoyNFrOFo_eRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMTo1NToyNFrOFo_93Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUyNzMwMw==", "bodyText": "We can't add this dependency for external project as this will cause them to fail. We don't publish xpack specs or tests so we should probably make it that if you try to add them and isInternal == false we throw an error. We can work about separating this so we don't expose internals to external users later.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r378527303", "createdAt": "2020-02-12T21:38:24Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiPlugin.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.provider.Provider;\n+\n+import java.util.Map;\n+\n+/**\n+ * Gradle plugin to help configure {@link CopyRestApiTask}'s that will copy the artifacts needed for the Rest API spec and YAML tests.\n+ * @see CopyRestApiTask\n+ */\n+public class CopyRestApiPlugin implements Plugin<Project> {\n+\n+    private static final String COPY_SPEC_EXTENSION_NAME = \"copyRestApiSpecs\";\n+    private static final String COPY_TEST_EXTENSION_NAME = \"copyYamlTests\";\n+\n+    @Override\n+    public void apply(Project project) {\n+        CopyRestApiExtension copySpecExtension = project.getExtensions().create(COPY_SPEC_EXTENSION_NAME, CopyRestApiExtension.class);\n+        CopyRestApiExtension copyTestExtension = project.getExtensions().create(COPY_TEST_EXTENSION_NAME, CopyRestApiExtension.class);\n+\n+        Provider<CopyRestApiTask> copyRestYamlTestTask = project.getTasks().register(\"copyYamlTestsTask\", CopyRestApiTask.class, task -> {\n+            task.includeCore.set(copyTestExtension.getIncludeCore());\n+            task.includeXpack.set(copyTestExtension.getIncludeXpack());\n+            task.copyTo = \"rest-api-spec/test\";\n+            task.coreConfig = project.getConfigurations().create(\"restTest\");\n+            if (BuildParams.isInternal()) {\n+                Dependency dependency = project.getDependencies().project(Map.of(\"path\", \":rest-api-spec\", \"configuration\", \"restTests\"));\n+                project.getDependencies().add(task.coreConfig.getName(), dependency);\n+            } else {\n+                Dependency dependency = project.getDependencies()\n+                    .create(\"org.elasticsearch:rest-api-spec:\" + VersionProperties.getElasticsearch());\n+                project.getDependencies().add(task.coreConfig.getName(), dependency);\n+            }\n+            task.dependsOn(task.coreConfig);\n+\n+            task.xpackConfig = project.getConfigurations().create(\"restXpackTest\");\n+            Dependency dependency = project.getDependencies().project(Map.of(\"path\", \":x-pack:plugin\", \"configuration\", \"restXpackTests\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c1d16403a3c6cb1e743f59e9b4d07fdb3facd58"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUzMTY4MQ==", "bodyText": "We should avoid creating two extensions here. For a couple of reasons:\n\nIt's not clear from the model these two are related or \"owned\" by a single plugin. Having a single extension encourages putting this stuff together.\nBecause we are using the same type for this extension, it then means folks can't effectively use extensions.getByType() since there would be ambiguity here.\n\nI suggest we do the following:\n\nRename CopyRestApiExtension to RestResourcesSpec.\nCreate a new RestResourcesExtension with two fields, restApi and restTests.\nRestResourcesExtension should have methods to configure those fields that look like void restApi(Action<? super RestResourcesSpec> spec).\nAdd the single RestResourcesExtension to the project.\n\nWe should then have a DSL looking like this:\nrestResources {\n  restApi {\n    includeXpack 'ilm', 'slm'\n  }\n  restTests {\n    includeXpack 'ilm', 'slm'\n  }\n}", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r378531681", "createdAt": "2020-02-12T21:47:28Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiPlugin.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.provider.Provider;\n+\n+import java.util.Map;\n+\n+/**\n+ * Gradle plugin to help configure {@link CopyRestApiTask}'s that will copy the artifacts needed for the Rest API spec and YAML tests.\n+ * @see CopyRestApiTask\n+ */\n+public class CopyRestApiPlugin implements Plugin<Project> {\n+\n+    private static final String COPY_SPEC_EXTENSION_NAME = \"copyRestApiSpecs\";\n+    private static final String COPY_TEST_EXTENSION_NAME = \"copyYamlTests\";\n+\n+    @Override\n+    public void apply(Project project) {\n+        CopyRestApiExtension copySpecExtension = project.getExtensions().create(COPY_SPEC_EXTENSION_NAME, CopyRestApiExtension.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c1d16403a3c6cb1e743f59e9b4d07fdb3facd58"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUzMjMyMg==", "bodyText": "FYI, i use the term \"rest resources\" here because I think it's the best generic term. Please suggest a better one. I hesitate to use the term \"rest testing\" or similar due to your earlier comment about api specs being used for purposes not necessarily related to testing.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r378532322", "createdAt": "2020-02-12T21:48:50Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiPlugin.java", "diffHunk": "@@ -0,0 +1,93 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.provider.Provider;\n+\n+import java.util.Map;\n+\n+/**\n+ * Gradle plugin to help configure {@link CopyRestApiTask}'s that will copy the artifacts needed for the Rest API spec and YAML tests.\n+ * @see CopyRestApiTask\n+ */\n+public class CopyRestApiPlugin implements Plugin<Project> {\n+\n+    private static final String COPY_SPEC_EXTENSION_NAME = \"copyRestApiSpecs\";\n+    private static final String COPY_TEST_EXTENSION_NAME = \"copyYamlTests\";\n+\n+    @Override\n+    public void apply(Project project) {\n+        CopyRestApiExtension copySpecExtension = project.getExtensions().create(COPY_SPEC_EXTENSION_NAME, CopyRestApiExtension.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUzMTY4MQ=="}, "originalCommit": {"oid": "0c1d16403a3c6cb1e743f59e9b4d07fdb3facd58"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUzNDQ0Nw==", "bodyText": "This should live in the plugin not in the task.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r378534447", "createdAt": "2020-02-12T21:53:25Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -0,0 +1,218 @@\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.file.ConfigurableFileCollection;\n+import org.gradle.api.file.FileTree;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.provider.ListProperty;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.OutputDirectory;\n+import org.gradle.api.tasks.SkipWhenEmpty;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.TaskAction;\n+import org.gradle.api.tasks.util.PatternFilterable;\n+import org.gradle.api.tasks.util.PatternSet;\n+import org.gradle.internal.Factory;\n+\n+import javax.inject.Inject;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * <p>Copies the files needed for the Rest YAML tests to the current projects test resources output directory.\n+ * This is intended to be be used from {@link CopyRestApiPlugin} since the plugin wires up the needed\n+ * configurations and custom extensions.\n+ * </p>\n+ * <p>This task supports copying either the Rest YAML tests (.yml), or the Rest API specification (.json).</p>\n+ * <br>\n+ * <strong>Rest API specification:</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied this task will automatically copy the Rest API specification\n+ * if there are any Rest YAML tests present (either in source, or output) or if `includeCore` or `includeXpack` has been explicitly\n+ * declared through the 'copyRestApiSpecs' extension. <br>\n+ * This task supports copying only a subset of the Rest API specification through the use of the custom extension.<br>\n+ * <i>For example:</i>\n+ * <pre>\n+ * copyRestApiSpecs {\n+ *   includeXpack 'enrich'\n+ * }\n+ * </pre>\n+ * Will copy any of the the x-pack specs that start with enrich*. The core API specs will also be copied iff the project also has\n+ * Rest YAML tests. To help optimize the build cache, it is recommended to explicitly declare which specs your project depends on.\n+ * <i>For example:</i>\n+ * <pre>\n+ * copyRestApiSpecs {\n+ *   includeCore 'index', 'cat'\n+ *   includeXpack 'enrich'\n+ * }\n+ *  </pre>\n+ * <br>\n+ * <strong>Rest YAML tests :</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied this task can copy the Rest YAML tests iff explicitly configured with\n+ * `includeCore` or `includeXpack` through the `copyYamlTests` extension.\n+ * <i>For example:</i>\n+ * <pre>\n+ * copyYamlTests {\n+ *   includeXpack 'graph'\n+ * }\n+ * </pre>\n+ * Will copy any of the the x-pack tests that start with graph.\n+ */\n+public class CopyRestApiTask extends DefaultTask {\n+    private static final Logger logger = Logging.getLogger(CopyRestApiTask.class);\n+    final ListProperty<String> includeCore = getProject().getObjects().listProperty(String.class);\n+    final ListProperty<String> includeXpack = getProject().getObjects().listProperty(String.class);\n+\n+    Configuration coreConfig;\n+    Configuration xpackConfig;\n+    String copyTo;\n+\n+    private final PatternFilterable corePatternSet;\n+    private final PatternFilterable xpackPatternSet;\n+\n+    public CopyRestApiTask() {\n+        corePatternSet = getPatternSetFactory().create();\n+        xpackPatternSet = getPatternSetFactory().create();\n+    }\n+\n+    @Inject\n+    protected Factory<PatternSet> getPatternSetFactory() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeCore() {\n+        return includeCore;\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeXpack() {\n+        return includeXpack;\n+    }\n+\n+    @SkipWhenEmpty\n+    @InputFiles\n+    public FileTree getInputDir() {\n+        xpackPatternSet.setIncludes(includeXpack.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+        ConfigurableFileCollection fileCollection = getProject().files(xpackConfig.getAsFileTree().matching(xpackPatternSet));\n+        if (BuildParams.isInternal()) {\n+            corePatternSet.setIncludes(includeCore.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+            fileCollection.plus(coreConfig.getAsFileTree().matching(corePatternSet));\n+        } else {\n+            fileCollection.plus(coreConfig);\n+        }\n+        return \"spec\".equals(getTestOrSpec()) && projectHasYamlRestTests()\n+            || includeCore.get().isEmpty() == false\n+            || includeXpack.get().isEmpty() == false ? fileCollection.getAsFileTree() : null;\n+    }\n+\n+    @OutputDirectory\n+    public File getOutputDir() {\n+        return new File(getTestSourceSet().getOutput().getResourcesDir(), copyTo);\n+    }\n+\n+    @TaskAction\n+    void copy() {\n+        Project project = getProject();\n+        if (BuildParams.isInternal()) {\n+            logger.info(\"Rest {} for project [{}] will be copied to the test resources.\", getTestOrSpec(), project.getPath());\n+            project.copy(c -> {\n+                c.from(coreConfig.getSingleFile());\n+                c.into(getOutputDir());\n+                c.include(corePatternSet.getIncludes());\n+            });\n+\n+        } else {\n+            logger.info(\n+                \"Rest {} for project [{}] will be copied to the test resources from the published jar (version: [{}]).\",\n+                getTestOrSpec(),\n+                project.getPath(),\n+                VersionProperties.getElasticsearch()\n+            );\n+            project.copy(c -> {\n+                c.from(project.zipTree(coreConfig.getSingleFile()));\n+                c.into(getTestSourceSet().getOutput().getResourcesDir()); // this ends up as the same dir as outputDir\n+                c.include(includeCore.get().stream().map(prefix -> copyTo + \"/\" + prefix + \"*/**\").collect(Collectors.toList()));\n+            });\n+        }\n+        // only include x-pack if explicitly instructed\n+        if (includeXpack.get().isEmpty() == false) {\n+            logger.info(\"X-pack YAML{} for project [{}] will be copied to the test resources.\", getTestOrSpec(), project.getPath());\n+            project.copy(c -> {\n+                c.from(xpackConfig.getSingleFile());\n+                c.into(getOutputDir());\n+                c.include(xpackPatternSet.getIncludes());\n+            });\n+        }\n+    }\n+\n+    /**\n+     * Returns true if any files with a .yml extension exist the test resources rest-api-spec/test directory (from source or output dir)\n+     */\n+    private boolean projectHasYamlRestTests() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c1d16403a3c6cb1e743f59e9b4d07fdb3facd58"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUzNDYxMA==", "bodyText": "Let's not trigger behavior based on loose conventions. Let's make this an explicit thing.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r378534610", "createdAt": "2020-02-12T21:53:44Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -0,0 +1,218 @@\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.file.ConfigurableFileCollection;\n+import org.gradle.api.file.FileTree;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.provider.ListProperty;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.OutputDirectory;\n+import org.gradle.api.tasks.SkipWhenEmpty;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.TaskAction;\n+import org.gradle.api.tasks.util.PatternFilterable;\n+import org.gradle.api.tasks.util.PatternSet;\n+import org.gradle.internal.Factory;\n+\n+import javax.inject.Inject;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * <p>Copies the files needed for the Rest YAML tests to the current projects test resources output directory.\n+ * This is intended to be be used from {@link CopyRestApiPlugin} since the plugin wires up the needed\n+ * configurations and custom extensions.\n+ * </p>\n+ * <p>This task supports copying either the Rest YAML tests (.yml), or the Rest API specification (.json).</p>\n+ * <br>\n+ * <strong>Rest API specification:</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied this task will automatically copy the Rest API specification\n+ * if there are any Rest YAML tests present (either in source, or output) or if `includeCore` or `includeXpack` has been explicitly\n+ * declared through the 'copyRestApiSpecs' extension. <br>\n+ * This task supports copying only a subset of the Rest API specification through the use of the custom extension.<br>\n+ * <i>For example:</i>\n+ * <pre>\n+ * copyRestApiSpecs {\n+ *   includeXpack 'enrich'\n+ * }\n+ * </pre>\n+ * Will copy any of the the x-pack specs that start with enrich*. The core API specs will also be copied iff the project also has\n+ * Rest YAML tests. To help optimize the build cache, it is recommended to explicitly declare which specs your project depends on.\n+ * <i>For example:</i>\n+ * <pre>\n+ * copyRestApiSpecs {\n+ *   includeCore 'index', 'cat'\n+ *   includeXpack 'enrich'\n+ * }\n+ *  </pre>\n+ * <br>\n+ * <strong>Rest YAML tests :</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied this task can copy the Rest YAML tests iff explicitly configured with\n+ * `includeCore` or `includeXpack` through the `copyYamlTests` extension.\n+ * <i>For example:</i>\n+ * <pre>\n+ * copyYamlTests {\n+ *   includeXpack 'graph'\n+ * }\n+ * </pre>\n+ * Will copy any of the the x-pack tests that start with graph.\n+ */\n+public class CopyRestApiTask extends DefaultTask {\n+    private static final Logger logger = Logging.getLogger(CopyRestApiTask.class);\n+    final ListProperty<String> includeCore = getProject().getObjects().listProperty(String.class);\n+    final ListProperty<String> includeXpack = getProject().getObjects().listProperty(String.class);\n+\n+    Configuration coreConfig;\n+    Configuration xpackConfig;\n+    String copyTo;\n+\n+    private final PatternFilterable corePatternSet;\n+    private final PatternFilterable xpackPatternSet;\n+\n+    public CopyRestApiTask() {\n+        corePatternSet = getPatternSetFactory().create();\n+        xpackPatternSet = getPatternSetFactory().create();\n+    }\n+\n+    @Inject\n+    protected Factory<PatternSet> getPatternSetFactory() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeCore() {\n+        return includeCore;\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeXpack() {\n+        return includeXpack;\n+    }\n+\n+    @SkipWhenEmpty\n+    @InputFiles\n+    public FileTree getInputDir() {\n+        xpackPatternSet.setIncludes(includeXpack.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+        ConfigurableFileCollection fileCollection = getProject().files(xpackConfig.getAsFileTree().matching(xpackPatternSet));\n+        if (BuildParams.isInternal()) {\n+            corePatternSet.setIncludes(includeCore.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+            fileCollection.plus(coreConfig.getAsFileTree().matching(corePatternSet));\n+        } else {\n+            fileCollection.plus(coreConfig);\n+        }\n+        return \"spec\".equals(getTestOrSpec()) && projectHasYamlRestTests()\n+            || includeCore.get().isEmpty() == false\n+            || includeXpack.get().isEmpty() == false ? fileCollection.getAsFileTree() : null;\n+    }\n+\n+    @OutputDirectory\n+    public File getOutputDir() {\n+        return new File(getTestSourceSet().getOutput().getResourcesDir(), copyTo);\n+    }\n+\n+    @TaskAction\n+    void copy() {\n+        Project project = getProject();\n+        if (BuildParams.isInternal()) {\n+            logger.info(\"Rest {} for project [{}] will be copied to the test resources.\", getTestOrSpec(), project.getPath());\n+            project.copy(c -> {\n+                c.from(coreConfig.getSingleFile());\n+                c.into(getOutputDir());\n+                c.include(corePatternSet.getIncludes());\n+            });\n+\n+        } else {\n+            logger.info(\n+                \"Rest {} for project [{}] will be copied to the test resources from the published jar (version: [{}]).\",\n+                getTestOrSpec(),\n+                project.getPath(),\n+                VersionProperties.getElasticsearch()\n+            );\n+            project.copy(c -> {\n+                c.from(project.zipTree(coreConfig.getSingleFile()));\n+                c.into(getTestSourceSet().getOutput().getResourcesDir()); // this ends up as the same dir as outputDir\n+                c.include(includeCore.get().stream().map(prefix -> copyTo + \"/\" + prefix + \"*/**\").collect(Collectors.toList()));\n+            });\n+        }\n+        // only include x-pack if explicitly instructed\n+        if (includeXpack.get().isEmpty() == false) {\n+            logger.info(\"X-pack YAML{} for project [{}] will be copied to the test resources.\", getTestOrSpec(), project.getPath());\n+            project.copy(c -> {\n+                c.from(xpackConfig.getSingleFile());\n+                c.into(getOutputDir());\n+                c.include(xpackPatternSet.getIncludes());\n+            });\n+        }\n+    }\n+\n+    /**\n+     * Returns true if any files with a .yml extension exist the test resources rest-api-spec/test directory (from source or output dir)\n+     */\n+    private boolean projectHasYamlRestTests() {\n+        File testSourceResourceDir = getTestSourceResourceDir();\n+        File testOutputResourceDir = getTestOutputResourceDir(); // check output for cases where tests are copied programmatically\n+\n+        if (testSourceResourceDir == null && testOutputResourceDir == null) {\n+            return false;\n+        }\n+        try {\n+            if (testSourceResourceDir != null) {\n+                return new File(testSourceResourceDir, \"rest-api-spec/test\").exists() == false\n+                    || Files.walk(testSourceResourceDir.toPath().resolve(\"rest-api-spec/test\"))\n+                        .anyMatch(p -> p.getFileName().toString().endsWith(\"yml\"));\n+            }\n+            if (testOutputResourceDir != null) {\n+                return new File(testOutputResourceDir, \"rest-api-spec/test\").exists() == false\n+                    || Files.walk(testOutputResourceDir.toPath().resolve(\"rest-api-spec/test\"))\n+                        .anyMatch(p -> p.getFileName().toString().endsWith(\"yml\"));\n+            }\n+        } catch (IOException e) {\n+            throw new IllegalStateException(String.format(\"Error determining if this project [%s] has rest tests.\", getProject()), e);\n+        }\n+        return false;\n+    }\n+\n+    private File getTestSourceResourceDir() {\n+        SourceSet testSources = getTestSourceSet();\n+        if (testSources == null) {\n+            return null;\n+        }\n+        Set<File> resourceDir = testSources.getResources()\n+            .getSrcDirs()\n+            .stream()\n+            .filter(f -> f.isDirectory() && f.getParentFile().getName().equals(\"test\") && f.getName().equals(\"resources\"))\n+            .collect(Collectors.toSet());\n+        assert resourceDir.size() <= 1;\n+        if (resourceDir.size() == 0) {\n+            return null;\n+        }\n+        return resourceDir.iterator().next();\n+    }\n+\n+    private File getTestOutputResourceDir() {\n+        SourceSet testSources = getTestSourceSet();\n+        if (testSources == null) {\n+            return null;\n+        }\n+        return testSources.getOutput().getResourcesDir();\n+    }\n+\n+    private SourceSet getTestSourceSet() {\n+        return Boilerplate.getJavaSourceSets(getProject()).findByName(\"test\");\n+    }\n+\n+    private String getTestOrSpec() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c1d16403a3c6cb1e743f59e9b4d07fdb3facd58"}, "originalPosition": 214}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUzNTM4OQ==", "bodyText": "I don't know how many times I've looked at this I still have trouble following this. Why the different behavior based on whether we are copying specs or tests? Also, as mentioned below, conditioning on whether the project \"has yaml tests\" should live in the plugin, not the task implementation. If this stuff is n/a for projects w/o yaml tests, then we can ditch creating this task altogether in the plugin itself.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r378535389", "createdAt": "2020-02-12T21:55:24Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -0,0 +1,218 @@\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.file.ConfigurableFileCollection;\n+import org.gradle.api.file.FileTree;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.provider.ListProperty;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.OutputDirectory;\n+import org.gradle.api.tasks.SkipWhenEmpty;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.TaskAction;\n+import org.gradle.api.tasks.util.PatternFilterable;\n+import org.gradle.api.tasks.util.PatternSet;\n+import org.gradle.internal.Factory;\n+\n+import javax.inject.Inject;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * <p>Copies the files needed for the Rest YAML tests to the current projects test resources output directory.\n+ * This is intended to be be used from {@link CopyRestApiPlugin} since the plugin wires up the needed\n+ * configurations and custom extensions.\n+ * </p>\n+ * <p>This task supports copying either the Rest YAML tests (.yml), or the Rest API specification (.json).</p>\n+ * <br>\n+ * <strong>Rest API specification:</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied this task will automatically copy the Rest API specification\n+ * if there are any Rest YAML tests present (either in source, or output) or if `includeCore` or `includeXpack` has been explicitly\n+ * declared through the 'copyRestApiSpecs' extension. <br>\n+ * This task supports copying only a subset of the Rest API specification through the use of the custom extension.<br>\n+ * <i>For example:</i>\n+ * <pre>\n+ * copyRestApiSpecs {\n+ *   includeXpack 'enrich'\n+ * }\n+ * </pre>\n+ * Will copy any of the the x-pack specs that start with enrich*. The core API specs will also be copied iff the project also has\n+ * Rest YAML tests. To help optimize the build cache, it is recommended to explicitly declare which specs your project depends on.\n+ * <i>For example:</i>\n+ * <pre>\n+ * copyRestApiSpecs {\n+ *   includeCore 'index', 'cat'\n+ *   includeXpack 'enrich'\n+ * }\n+ *  </pre>\n+ * <br>\n+ * <strong>Rest YAML tests :</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied this task can copy the Rest YAML tests iff explicitly configured with\n+ * `includeCore` or `includeXpack` through the `copyYamlTests` extension.\n+ * <i>For example:</i>\n+ * <pre>\n+ * copyYamlTests {\n+ *   includeXpack 'graph'\n+ * }\n+ * </pre>\n+ * Will copy any of the the x-pack tests that start with graph.\n+ */\n+public class CopyRestApiTask extends DefaultTask {\n+    private static final Logger logger = Logging.getLogger(CopyRestApiTask.class);\n+    final ListProperty<String> includeCore = getProject().getObjects().listProperty(String.class);\n+    final ListProperty<String> includeXpack = getProject().getObjects().listProperty(String.class);\n+\n+    Configuration coreConfig;\n+    Configuration xpackConfig;\n+    String copyTo;\n+\n+    private final PatternFilterable corePatternSet;\n+    private final PatternFilterable xpackPatternSet;\n+\n+    public CopyRestApiTask() {\n+        corePatternSet = getPatternSetFactory().create();\n+        xpackPatternSet = getPatternSetFactory().create();\n+    }\n+\n+    @Inject\n+    protected Factory<PatternSet> getPatternSetFactory() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeCore() {\n+        return includeCore;\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeXpack() {\n+        return includeXpack;\n+    }\n+\n+    @SkipWhenEmpty\n+    @InputFiles\n+    public FileTree getInputDir() {\n+        xpackPatternSet.setIncludes(includeXpack.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+        ConfigurableFileCollection fileCollection = getProject().files(xpackConfig.getAsFileTree().matching(xpackPatternSet));\n+        if (BuildParams.isInternal()) {\n+            corePatternSet.setIncludes(includeCore.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+            fileCollection.plus(coreConfig.getAsFileTree().matching(corePatternSet));\n+        } else {\n+            fileCollection.plus(coreConfig);\n+        }\n+        return \"spec\".equals(getTestOrSpec()) && projectHasYamlRestTests()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c1d16403a3c6cb1e743f59e9b4d07fdb3facd58"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbcde3abfce4b3852af9be693f2724e1d0a76c5b", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/bbcde3abfce4b3852af9be693f2724e1d0a76c5b", "committedDate": "2020-02-12T22:33:52Z", "message": "fix some missed includes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dc1a3af361cb8a41fcec193ea81e58a47989e5a", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/2dc1a3af361cb8a41fcec193ea81e58a47989e5a", "committedDate": "2020-02-12T23:29:48Z", "message": "move to 1 extension, minor clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8942ac214e8f886f9943066b21b6676fe2b8102a", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/8942ac214e8f886f9943066b21b6676fe2b8102a", "committedDate": "2020-02-13T14:59:51Z", "message": "split to two tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f5739cbf81e8db69b14a3624dea94e3eb4b892d", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f5739cbf81e8db69b14a3624dea94e3eb4b892d", "committedDate": "2020-02-13T16:38:28Z", "message": "fix smoke-test-security-with-mustache test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "907c0ddf3ccdcbef03f86f1619be0356c03f9201", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/907c0ddf3ccdcbef03f86f1619be0356c03f9201", "committedDate": "2020-02-13T20:52:53Z", "message": "fix some of the x-pack:qa tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "173b494ed2701a97bce4755359692eab70ca935a", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/173b494ed2701a97bce4755359692eab70ca935a", "committedDate": "2020-02-13T21:30:54Z", "message": "fix another x-pack qa test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d0aec5938c32aca802b75276d8c867ee12061d3", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/6d0aec5938c32aca802b75276d8c867ee12061d3", "committedDate": "2020-02-13T22:08:05Z", "message": "fix spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a74f0b20a621cde5528453fa3146f12d414cb94", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a74f0b20a621cde5528453fa3146f12d414cb94", "committedDate": "2020-02-13T23:24:43Z", "message": "another qa xpack test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a391dd73d667e290005e8b55c7d1475c8bb9be78", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/a391dd73d667e290005e8b55c7d1475c8bb9be78", "committedDate": "2020-02-14T15:27:55Z", "message": "fix another x-pack test (the prior iteration auto added all of  x-pack specs, now you have to declare which x-pack specs)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9583d15eacde9d5b270d1407d0192ee4518f58ec", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/9583d15eacde9d5b270d1407d0192ee4518f58ec", "committedDate": "2020-02-24T18:15:12Z", "message": "clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1617f6fa9d7a279d440ef6cb6a8113b01a89db65", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/1617f6fa9d7a279d440ef6cb6a8113b01a89db65", "committedDate": "2020-02-24T18:18:03Z", "message": "Merge remote-tracking branch 'upstream/master' into rest_spec_from_common_dir3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d86fc58b580a6a4b0095f7e3d0d046ccdf7d0d0e", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/d86fc58b580a6a4b0095f7e3d0d046ccdf7d0d0e", "committedDate": "2020-02-24T18:33:02Z", "message": "move logger to debug and remove incidental change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "852b30e92739a80289ec819243d3f273e7ccf4bf", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/852b30e92739a80289ec819243d3f273e7ccf4bf", "committedDate": "2020-02-25T16:01:44Z", "message": "fix 3rd party config and remove uneeded copy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDMxMTcw", "url": "https://github.com/elastic/elasticsearch/pull/52114#pullrequestreview-364431170", "createdAt": "2020-02-25T20:38:50Z", "commit": {"oid": "852b30e92739a80289ec819243d3f273e7ccf4bf"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDozODo1MFrOFuUZRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDo0NjoxNVrOFuUmcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExMjk2Ng==", "bodyText": "Let's avoid reassigning variables like this. It's a bit difficult to follow and opens up opportunity for nasty bugs vs using explicit variables.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r384112966", "createdAt": "2020-02-25T20:38:50Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiPlugin.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.provider.Provider;\n+\n+import java.util.Map;\n+\n+/**\n+ * <p>\n+ * Gradle plugin to help configure {@link CopyRestApiTask}'s and {@link CopyRestTestsTask} that copies the artifacts needed for the Rest API\n+ * spec and YAML based rest tests.\n+ * </p>\n+ * <strong>Rest API specification:</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied the {@link CopyRestApiTask} will automatically copy the core Rest API specification\n+ * if there are any Rest YAML tests present in source, or copied from {@link CopyRestTestsTask} output. X-pack specs must be explicitly\n+ * declared to be copied.\n+ * <br>\n+ * <i>For example:</i>\n+ * <pre>\n+ * restResources {\n+ *   restApi {\n+ *     includeXpack 'enrich'\n+ *   }\n+ * }\n+ * </pre>\n+ * Will copy the entire core Rest API specifications (assuming the project has tests) and any of the the X-pack specs starting with enrich*.\n+ * It is recommended (but not required) to also explicitly declare which core specs your project depends on to help optimize the caching\n+ * behavior.\n+ * <i>For example:</i>\n+ * <pre>\n+ * restResources {\n+ *   restApi {\n+ *     includeCore 'index', 'cat'\n+ *     includeXpack 'enrich'\n+ *   }\n+ * }\n+ * </pre>\n+ * <br>\n+ * <strong>Rest YAML tests :</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied the {@link CopyRestTestsTask} will copy the Rest YAML tests if explicitly\n+ * configured with `includeCore` or `includeXpack` through the `restResources.restTests` extension.\n+ * <i>For example:</i>\n+ * <pre>\n+ * restResources {\n+ *  restApi {\n+ *      includeXpack 'graph'\n+ *   }\n+ *   restTests {\n+ *     includeXpack 'graph'\n+ *   }\n+ * }\n+ * </pre>\n+ * Will copy any of the the x-pack tests that start with graph, and will copy the X-pack graph specification, as well as the full core\n+ * Rest API specification.\n+ *\n+ * @see CopyRestApiTask\n+ * @see CopyRestTestsTask\n+ */\n+public class CopyRestApiPlugin implements Plugin<Project> {\n+\n+    private static final String EXTENSION_NAME = \"restResources\";\n+\n+    @Override\n+    public void apply(Project project) {\n+        RestResourcesExtension extension = project.getExtensions().create(EXTENSION_NAME, RestResourcesExtension.class);\n+\n+        Provider<CopyRestTestsTask> copyRestYamlTestTask = project.getTasks()\n+            .register(\"copyYamlTestsTask\", CopyRestTestsTask.class, task -> {\n+                task.includeCore.set(extension.restTests.getIncludeCore());\n+                task.includeXpack.set(extension.restTests.getIncludeXpack());\n+                task.coreConfig = project.getConfigurations().create(\"restTest\");\n+                if (BuildParams.isInternal()) {\n+                    Dependency dependency = project.getDependencies()\n+                        .project(Map.of(\"path\", \":rest-api-spec\", \"configuration\", \"restTests\"));\n+                    project.getDependencies().add(task.coreConfig.getName(), dependency);\n+\n+                    task.xpackConfig = project.getConfigurations().create(\"restXpackTest\");\n+                    dependency = project.getDependencies().project(Map.of(\"path\", \":x-pack:plugin\", \"configuration\", \"restXpackTests\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "852b30e92739a80289ec819243d3f273e7ccf4bf"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExMzM3Mw==", "bodyText": "Let's name this the RestResourcesPlugin to match the DSL.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r384113373", "createdAt": "2020-02-25T20:39:45Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiPlugin.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Dependency;\n+import org.gradle.api.provider.Provider;\n+\n+import java.util.Map;\n+\n+/**\n+ * <p>\n+ * Gradle plugin to help configure {@link CopyRestApiTask}'s and {@link CopyRestTestsTask} that copies the artifacts needed for the Rest API\n+ * spec and YAML based rest tests.\n+ * </p>\n+ * <strong>Rest API specification:</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied the {@link CopyRestApiTask} will automatically copy the core Rest API specification\n+ * if there are any Rest YAML tests present in source, or copied from {@link CopyRestTestsTask} output. X-pack specs must be explicitly\n+ * declared to be copied.\n+ * <br>\n+ * <i>For example:</i>\n+ * <pre>\n+ * restResources {\n+ *   restApi {\n+ *     includeXpack 'enrich'\n+ *   }\n+ * }\n+ * </pre>\n+ * Will copy the entire core Rest API specifications (assuming the project has tests) and any of the the X-pack specs starting with enrich*.\n+ * It is recommended (but not required) to also explicitly declare which core specs your project depends on to help optimize the caching\n+ * behavior.\n+ * <i>For example:</i>\n+ * <pre>\n+ * restResources {\n+ *   restApi {\n+ *     includeCore 'index', 'cat'\n+ *     includeXpack 'enrich'\n+ *   }\n+ * }\n+ * </pre>\n+ * <br>\n+ * <strong>Rest YAML tests :</strong> <br>\n+ * When the {@link CopyRestApiPlugin} has been applied the {@link CopyRestTestsTask} will copy the Rest YAML tests if explicitly\n+ * configured with `includeCore` or `includeXpack` through the `restResources.restTests` extension.\n+ * <i>For example:</i>\n+ * <pre>\n+ * restResources {\n+ *  restApi {\n+ *      includeXpack 'graph'\n+ *   }\n+ *   restTests {\n+ *     includeXpack 'graph'\n+ *   }\n+ * }\n+ * </pre>\n+ * Will copy any of the the x-pack tests that start with graph, and will copy the X-pack graph specification, as well as the full core\n+ * Rest API specification.\n+ *\n+ * @see CopyRestApiTask\n+ * @see CopyRestTestsTask\n+ */\n+public class CopyRestApiPlugin implements Plugin<Project> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "852b30e92739a80289ec819243d3f273e7ccf4bf"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExNDk0OQ==", "bodyText": "This is unnecessary. Just use the getLogger() method provided by AbstractTask. Same applies for the copy tests task.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r384114949", "createdAt": "2020-02-25T20:43:12Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.file.ConfigurableFileCollection;\n+import org.gradle.api.file.FileTree;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.provider.ListProperty;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.OutputDirectory;\n+import org.gradle.api.tasks.SkipWhenEmpty;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.TaskAction;\n+import org.gradle.api.tasks.util.PatternFilterable;\n+import org.gradle.api.tasks.util.PatternSet;\n+import org.gradle.internal.Factory;\n+\n+import javax.inject.Inject;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Copies the files needed for the Rest YAML specs to the current projects test resources output directory.\n+ * This is intended to be be used from {@link CopyRestApiPlugin} since the plugin wires up the needed\n+ * configurations and custom extensions.\n+ * @see CopyRestApiPlugin\n+ */\n+public class CopyRestApiTask extends DefaultTask {\n+    private static final Logger logger = Logging.getLogger(CopyRestApiTask.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "852b30e92739a80289ec819243d3f273e7ccf4bf"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExNTg3MA==", "bodyText": "FYI, we now have three (3) tasks all using the same output directory which is going to cause issues with incremental build. I'll address this in a subsequent PR since it's a bit involved to register additional sourceset output directories but it's something to be aware of, by convention multiple tasks dumping their output in the same place is bad practice.", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r384115870", "createdAt": "2020-02-25T20:45:17Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.file.ConfigurableFileCollection;\n+import org.gradle.api.file.FileTree;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.provider.ListProperty;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.OutputDirectory;\n+import org.gradle.api.tasks.SkipWhenEmpty;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.TaskAction;\n+import org.gradle.api.tasks.util.PatternFilterable;\n+import org.gradle.api.tasks.util.PatternSet;\n+import org.gradle.internal.Factory;\n+\n+import javax.inject.Inject;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Copies the files needed for the Rest YAML specs to the current projects test resources output directory.\n+ * This is intended to be be used from {@link CopyRestApiPlugin} since the plugin wires up the needed\n+ * configurations and custom extensions.\n+ * @see CopyRestApiPlugin\n+ */\n+public class CopyRestApiTask extends DefaultTask {\n+    private static final Logger logger = Logging.getLogger(CopyRestApiTask.class);\n+    private static final String COPY_TO = \"rest-api-spec/api\";\n+    final ListProperty<String> includeCore = getProject().getObjects().listProperty(String.class);\n+    final ListProperty<String> includeXpack = getProject().getObjects().listProperty(String.class);\n+\n+    Configuration coreConfig;\n+    Configuration xpackConfig;\n+\n+    private final PatternFilterable corePatternSet;\n+    private final PatternFilterable xpackPatternSet;\n+\n+    public CopyRestApiTask() {\n+        corePatternSet = getPatternSetFactory().create();\n+        xpackPatternSet = getPatternSetFactory().create();\n+    }\n+\n+    @Inject\n+    protected Factory<PatternSet> getPatternSetFactory() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeCore() {\n+        return includeCore;\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeXpack() {\n+        return includeXpack;\n+    }\n+\n+    @SkipWhenEmpty\n+    @InputFiles\n+    public FileTree getInputDir() {\n+        xpackPatternSet.setIncludes(includeXpack.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+        ConfigurableFileCollection fileCollection = getProject().files(xpackConfig.getAsFileTree().matching(xpackPatternSet));\n+        if (BuildParams.isInternal()) {\n+            corePatternSet.setIncludes(includeCore.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+            fileCollection.plus(coreConfig.getAsFileTree().matching(corePatternSet));\n+        } else {\n+            fileCollection.plus(coreConfig);\n+        }\n+        // if project has rest tests or the includes are explicitly configured execute the task, else NO-SOURCE due to the null input\n+        return projectHasYamlRestTests() || includeCore.get().isEmpty() == false || includeXpack.get().isEmpty() == false\n+            ? fileCollection.getAsFileTree()\n+            : null;\n+    }\n+\n+    @OutputDirectory\n+    public File getOutputDir() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "852b30e92739a80289ec819243d3f273e7ccf4bf"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExNjMzNw==", "bodyText": "This comment is very helpful \ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/52114#discussion_r384116337", "createdAt": "2020-02-25T20:46:15Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/CopyRestApiTask.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.tool.Boilerplate;\n+import org.gradle.api.DefaultTask;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.Configuration;\n+import org.gradle.api.file.ConfigurableFileCollection;\n+import org.gradle.api.file.FileTree;\n+import org.gradle.api.logging.Logger;\n+import org.gradle.api.logging.Logging;\n+import org.gradle.api.provider.ListProperty;\n+import org.gradle.api.tasks.Input;\n+import org.gradle.api.tasks.InputFiles;\n+import org.gradle.api.tasks.OutputDirectory;\n+import org.gradle.api.tasks.SkipWhenEmpty;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.TaskAction;\n+import org.gradle.api.tasks.util.PatternFilterable;\n+import org.gradle.api.tasks.util.PatternSet;\n+import org.gradle.internal.Factory;\n+\n+import javax.inject.Inject;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Copies the files needed for the Rest YAML specs to the current projects test resources output directory.\n+ * This is intended to be be used from {@link CopyRestApiPlugin} since the plugin wires up the needed\n+ * configurations and custom extensions.\n+ * @see CopyRestApiPlugin\n+ */\n+public class CopyRestApiTask extends DefaultTask {\n+    private static final Logger logger = Logging.getLogger(CopyRestApiTask.class);\n+    private static final String COPY_TO = \"rest-api-spec/api\";\n+    final ListProperty<String> includeCore = getProject().getObjects().listProperty(String.class);\n+    final ListProperty<String> includeXpack = getProject().getObjects().listProperty(String.class);\n+\n+    Configuration coreConfig;\n+    Configuration xpackConfig;\n+\n+    private final PatternFilterable corePatternSet;\n+    private final PatternFilterable xpackPatternSet;\n+\n+    public CopyRestApiTask() {\n+        corePatternSet = getPatternSetFactory().create();\n+        xpackPatternSet = getPatternSetFactory().create();\n+    }\n+\n+    @Inject\n+    protected Factory<PatternSet> getPatternSetFactory() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeCore() {\n+        return includeCore;\n+    }\n+\n+    @Input\n+    public ListProperty<String> getIncludeXpack() {\n+        return includeXpack;\n+    }\n+\n+    @SkipWhenEmpty\n+    @InputFiles\n+    public FileTree getInputDir() {\n+        xpackPatternSet.setIncludes(includeXpack.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+        ConfigurableFileCollection fileCollection = getProject().files(xpackConfig.getAsFileTree().matching(xpackPatternSet));\n+        if (BuildParams.isInternal()) {\n+            corePatternSet.setIncludes(includeCore.get().stream().map(prefix -> prefix + \"*/**\").collect(Collectors.toList()));\n+            fileCollection.plus(coreConfig.getAsFileTree().matching(corePatternSet));\n+        } else {\n+            fileCollection.plus(coreConfig);\n+        }\n+        // if project has rest tests or the includes are explicitly configured execute the task, else NO-SOURCE due to the null input", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "852b30e92739a80289ec819243d3f273e7ccf4bf"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10700bc2fdcbb146afa6ebe7c2b444fbd321e217", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/10700bc2fdcbb146afa6ebe7c2b444fbd321e217", "committedDate": "2020-02-25T21:57:32Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb841614f16e2cf18e301ffc449f0e3478b356fa", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb841614f16e2cf18e301ffc449f0e3478b356fa", "committedDate": "2020-02-25T22:11:49Z", "message": "fix checkStyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e4d1d6c78555544a3eb3b603b2ba3f17bf533ce", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e4d1d6c78555544a3eb3b603b2ba3f17bf533ce", "committedDate": "2020-02-25T22:11:59Z", "message": "Merge remote-tracking branch 'upstream/master' into rest_spec_from_common_dir3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e6e2aa211e25ebfdb858315fb4d596783f9a1cf", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e6e2aa211e25ebfdb858315fb4d596783f9a1cf", "committedDate": "2020-02-25T23:45:57Z", "message": "fix plugin name"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2739, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}