{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MDI4MzM2", "number": 61779, "title": "Improve reduction of terms aggregations", "bodyText": "Today, the terms aggregation reduces multiple aggregations at once using a map\nto group same buckets together. This operation can be costly since it requires\nto lookup every bucket in a global map with no particular order.\nThis commit changes how term buckets are sorted by shards and partial reduces in\norder to be able to reduce results using a merge-sort strategy.\nFor bwc, results are merged with the legacy code if any of the aggregations use\na different sort (if the shard response was created by a node in prior versions).\nRelates #51857", "createdAt": "2020-09-01T11:56:17Z", "url": "https://github.com/elastic/elasticsearch/pull/61779", "merged": true, "mergeCommit": {"oid": "49ae2bb56a6bd865effeaaab6ee2940cae997599"}, "closed": true, "closedAt": "2020-09-04T13:08:33Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEmFDvgH2gAyNDc3MDI4MzM2OmM5N2ExZWRjZDI1YjBhOGViY2VlNDI3MTg1ZTRkM2RkYzhlZjU3YjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFgeVSgH2gAyNDc3MDI4MzM2OjJkOTZjNjQ0ZTc5MTAzNGE3MDViMjQ0ZDI4ODQ3MDkwZWY4NDBhOWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c97a1edcd25b0a8ebcee427185e4d3ddc8ef57b2", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/c97a1edcd25b0a8ebcee427185e4d3ddc8ef57b2", "committedDate": "2020-09-01T11:54:51Z", "message": "Improve reduction of terms aggregations\n\nToday, the terms aggregation reduces multiple aggregations at once using a map\nto group same buckets together. This operation can be costly since it requires\nto lookup every bucket in a global map with no particular order.\nThis commit changes how term buckets are sorted by shards and partial reduces in\norder to be able to reduce results using a merge-sort strategy.\nFor bwc, results are merged with the legacy code if any of the aggregations use\na different sort (if it was returned by a node in prior versions).\n\nRelates #51857"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NzY5NjU2", "url": "https://github.com/elastic/elasticsearch/pull/61779#pullrequestreview-479769656", "createdAt": "2020-09-01T13:59:23Z", "commit": {"oid": "c97a1edcd25b0a8ebcee427185e4d3ddc8ef57b2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzo1OToyM1rOHK3mWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNDowMjo1MFrOHK3v9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1ODc0Nw==", "bodyText": "topLevel? Maybe even make this a method one BucketOrder instead of this instanceof stuff?", "url": "https://github.com/elastic/elasticsearch/pull/61779#discussion_r481158747", "createdAt": "2020-09-01T13:59:23Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalOrder.java", "diffHunk": "@@ -369,6 +369,20 @@ public static boolean isKeyDesc(BucketOrder order) {\n         return isOrder(order, KEY_DESC);\n     }\n \n+    /**\n+     * Return the primary {@link BucketOrder} if the provided <code>order</code>\n+     * is a {@link CompoundOrder}.\n+     */\n+    public static BucketOrder unwrap(BucketOrder order) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c97a1edcd25b0a8ebcee427185e4d3ddc8ef57b2"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE1OTc2Mg==", "bodyText": "isKeyOrder is false here, right?", "url": "https://github.com/elastic/elasticsearch/pull/61779#discussion_r481159762", "createdAt": "2020-09-01T14:00:44Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/GlobalOrdinalsStringTermsAggregator.java", "diffHunk": "@@ -724,8 +727,15 @@ void buildSubAggs(StringTerms.Bucket[][] topBucketsPreOrd) throws IOException {\n \n         @Override\n         StringTerms buildResult(long owningBucketOrd, long otherDocCount, StringTerms.Bucket[] topBuckets) {\n-            return new StringTerms(name, order, bucketCountThresholds.getRequiredSize(), bucketCountThresholds.getMinDocCount(),\n-                metadata(), format, bucketCountThresholds.getShardSize(), showTermDocCountError,\n+            final BucketOrder reduceOrder;\n+            if (isKeyOrder(order) == false) {\n+                reduceOrder = isKeyOrder(order) ? InternalOrder.unwrap(order) : InternalOrder.key(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c97a1edcd25b0a8ebcee427185e4d3ddc8ef57b2"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE2MTIwNg==", "bodyText": "Fine for now, but I feel like we have four or five of these and maybe it'd be worth merging their implementations.", "url": "https://github.com/elastic/elasticsearch/pull/61779#discussion_r481161206", "createdAt": "2020-09-01T14:02:50Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/InternalTerms.java", "diffHunk": "@@ -189,44 +220,173 @@ protected final void doWriteTo(StreamOutput out) throws IOException {\n     @Override\n     public abstract B getBucketByKey(String term);\n \n-    @Override\n+    private static class IteratorAndCurrent<B extends InternalTerms.Bucket<B>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c97a1edcd25b0a8ebcee427185e4d3ddc8ef57b2"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99bc538cad46e88ab35a84ecb32db184fd2890e0", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/99bc538cad46e88ab35a84ecb32db184fd2890e0", "committedDate": "2020-09-01T17:50:02Z", "message": "address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5OTk4NzUx", "url": "https://github.com/elastic/elasticsearch/pull/61779#pullrequestreview-479998751", "createdAt": "2020-09-01T18:13:28Z", "commit": {"oid": "99bc538cad46e88ab35a84ecb32db184fd2890e0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoxMzoyOVrOHLCjWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoxMzoyOVrOHLCjWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMzODIwMA==", "bodyText": "Leftover?", "url": "https://github.com/elastic/elasticsearch/pull/61779#discussion_r481338200", "createdAt": "2020-09-01T18:13:29Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/search/aggregations/InternalAggregationsTests.java", "diffHunk": "@@ -35,6 +35,7 @@\n import org.elasticsearch.test.ESTestCase;\n import org.elasticsearch.test.InternalAggregationTestCase;\n import org.elasticsearch.test.VersionUtils;\n+import org.junit.Ignore;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99bc538cad46e88ab35a84ecb32db184fd2890e0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a45a6136ec355d446579bf7e5ed86e5a65ca772", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/3a45a6136ec355d446579bf7e5ed86e5a65ca772", "committedDate": "2020-09-01T19:11:03Z", "message": "fix the computation of doc_count_error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f060ccd144d87b6e3be485bad59f93a6f63f92be", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f060ccd144d87b6e3be485bad59f93a6f63f92be", "committedDate": "2020-09-01T19:23:03Z", "message": "handle empty buckets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b027d817475714447bbbc0871dac7a96d0474ddd", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/b027d817475714447bbbc0871dac7a96d0474ddd", "committedDate": "2020-09-01T19:56:45Z", "message": "fix serialization test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "163ff53c6d5c2fd800a303b9e2d7f0dea0c97f0a", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/163ff53c6d5c2fd800a303b9e2d7f0dea0c97f0a", "committedDate": "2020-09-02T06:56:44Z", "message": "fix NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8f3a5d26cf91c4039d49b0d6debff762d3aebf0", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8f3a5d26cf91c4039d49b0d6debff762d3aebf0", "committedDate": "2020-09-02T08:02:27Z", "message": "remove version randomization in query search result tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "646cfb606a0bfc7e1610124946018170c944b642", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/646cfb606a0bfc7e1610124946018170c944b642", "committedDate": "2020-09-02T11:41:42Z", "message": "we can prune the list on partial reduce if the aggregation is ordered by key and not filtered (minDocCount == 0)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7af5dfb46ea822a010c5949715a701ca9d0be94b", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/7af5dfb46ea822a010c5949715a701ca9d0be94b", "committedDate": "2020-09-02T13:07:19Z", "message": "fix anither it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "038700d00b79a9477d3345d6e71ffca5e4145f74", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/038700d00b79a9477d3345d6e71ffca5e4145f74", "committedDate": "2020-09-02T13:27:31Z", "message": "unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1958054d4893411ac7f13cfe0abdede8c830c46", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/a1958054d4893411ac7f13cfe0abdede8c830c46", "committedDate": "2020-09-02T19:27:12Z", "message": "Merge branch 'master' into terms_aggs_merge_reduce"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d752ac7c09cea32aa753be06eb99ed628421d61f", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d752ac7c09cea32aa753be06eb99ed628421d61f", "committedDate": "2020-09-02T19:56:52Z", "message": "generalize IteratorAndCurrent with histograms and terms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902d2c934e3a09752544f6874600c87ccf9ec523", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/902d2c934e3a09752544f6874600c87ccf9ec523", "committedDate": "2020-09-02T21:35:05Z", "message": "fix assert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72d2ded4d844e115aa68fe1230dc884413baa73e", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/72d2ded4d844e115aa68fe1230dc884413baa73e", "committedDate": "2020-09-02T22:29:04Z", "message": "missing next"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "237c68627a17051ff9c3600ea7e66da8a8628af9", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/237c68627a17051ff9c3600ea7e66da8a8628af9", "committedDate": "2020-09-03T07:43:27Z", "message": "set the right comparator in assert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae5d7a8529219635c0ccb0f352c26218d516868a", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae5d7a8529219635c0ccb0f352c26218d516868a", "committedDate": "2020-09-03T12:53:08Z", "message": "Merge branch 'master' into terms_aggs_merge_reduce"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d96c644e791034a705b244d28847090ef840a9b", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d96c644e791034a705b244d28847090ef840a9b", "committedDate": "2020-09-04T07:56:57Z", "message": "Merge branch 'master' into terms_aggs_merge_reduce"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4940, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}