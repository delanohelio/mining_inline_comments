{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MDE3NzE5", "number": 59009, "title": "Clean searchable snapshots cache on startup", "bodyText": "Today we empty the searchable snapshots cache when cleanly closing a\nshard, but leak cache files in some cases involving an unclean shutdown.\nSuch leaks are not permanent, they are cleaned up on shard relocation or\ndeletion, but they still might last for arbitrarily long until that\nhappens. This commit introduces a cleanup process that runs during node\nstartup to catch such leaks sooner.\nAlso, today we permit searchable snapshots to be held on custom data\npaths, and store the corresponding cache files within the custom\nlocation. Supporting this feature would make the cleanup process\nsignificantly more complicated since it would require each node to parse\nthe index metadata for the shards it held before shutdown. Yet, this\nfeature is undocumented and offers minimal benefits to searchable\nsnapshots. Therefore with this commit we forbid custom data paths for\nsearchable snapshot shards.", "createdAt": "2020-07-03T11:50:57Z", "url": "https://github.com/elastic/elasticsearch/pull/59009", "merged": true, "mergeCommit": {"oid": "04e1177d2daa9818df0af89a36d57af139dbd895"}, "closed": true, "closedAt": "2020-07-08T14:13:45Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxR9NigH2gAyNDQ0MDE3NzE5OjgzMTRjNzdkMzQ4NDQwYzBmZjkyMzBjODRlMjk3MDVhYTQzNDMxMjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy6gb0gFqTQ0NDc2NzM2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8314c77d348440c0ff9230c84e29705aa4343129", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/8314c77d348440c0ff9230c84e29705aa4343129", "committedDate": "2020-07-03T11:43:37Z", "message": "Clean searchable snapshots cache on startup\n\nToday we empty the searchable snapshots cache when cleanly closing a\nshard, but leak cache files in some cases involving an unclean shutdown.\nSuch leaks are not permanent, they are cleaned up on shard relocation or\ndeletion, but they still might last for arbitrarily long until that\nhappens. This commit introduces a cleanup process that runs during node\nstartup to catch such leaks sooner.\n\nAlso, today we permit searchable snapshots to be held on custom data\npaths, and store the corresponding cache files within the custom\nlocation. Supporting this feature would make the cleanup process\nsignificantly more complicated since it would require each node to parse\nthe index metadata for the shards it held before shutdown. Yet, this\nfeature is undocumented and offers minimal benefits to searchable\nsnapshots. Therefore with this commit we forbid custom data paths for\nsearchable snapshot shards."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd5bd16ee784fc4a6213237cb3bd82c96f004c10", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/dd5bd16ee784fc4a6213237cb3bd82c96f004c10", "committedDate": "2020-07-03T11:53:05Z", "message": "No need to remove setting, we ignore it elsewhere"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6e17d4787b92772bd5bbcbf35124f1f77287adc", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6e17d4787b92772bd5bbcbf35124f1f77287adc", "committedDate": "2020-07-03T12:01:58Z", "message": "Imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c31b5a5949be0412143e55d6e1d02300c0c3e43f", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/c31b5a5949be0412143e55d6e1d02300c0c3e43f", "committedDate": "2020-07-03T12:04:34Z", "message": "Add assertion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODIyMDg0", "url": "https://github.com/elastic/elasticsearch/pull/59009#pullrequestreview-442822084", "createdAt": "2020-07-06T07:08:13Z", "commit": {"oid": "c31b5a5949be0412143e55d6e1d02300c0c3e43f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNzowODoxM1rOGtLQgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNzowODoxM1rOGtLQgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMzU1NA==", "bodyText": "I've made a suggestion in Slack how we can possibly avoid introducing this setting. The idea is to simulate a crash by blocking write access to the disk during a restart, similar as is done in DiskDisruptionIT.", "url": "https://github.com/elastic/elasticsearch/pull/59009#discussion_r450023554", "createdAt": "2020-07-06T07:08:13Z", "author": {"login": "ywelsch"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheService.java", "diffHunk": "@@ -47,18 +48,39 @@\n         Setting.Property.NodeScope\n     );\n \n+    // Deliberately unregistered, we only use this in tests\n+    public static final Setting<Boolean> DELETE_ON_EVICTION_SETTING = Setting.boolSetting(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c31b5a5949be0412143e55d6e1d02300c0c3e43f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "169a0623785f839611564c2d2b72a32a134bfcdf", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/169a0623785f839611564c2d2b72a32a134bfcdf", "committedDate": "2020-07-07T10:21:08Z", "message": "Merge branch 'master' into 2020-07-03-clean-searchable-snapshots-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa00566bb01cffe9abe39357bb2d300d3aa3206e", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa00566bb01cffe9abe39357bb2d300d3aa3206e", "committedDate": "2020-07-08T09:34:41Z", "message": "Remove setting for tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86f8d74a5a8c755843406d8849a6c0e37467c72d", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/86f8d74a5a8c755843406d8849a6c0e37467c72d", "committedDate": "2020-07-08T12:02:00Z", "message": "Merge branch 'master' into 2020-07-03-clean-searchable-snapshots-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a346a53f32d095b3a356de962e3c81df7a20634", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a346a53f32d095b3a356de962e3c81df7a20634", "committedDate": "2020-07-08T12:12:41Z", "message": "Separate test harness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47a6949d109a29bd4044defe7241f6f443d2bfff", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/47a6949d109a29bd4044defe7241f6f443d2bfff", "committedDate": "2020-07-08T12:37:51Z", "message": "Block deleteIfExists calls during shutdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "825b94942e0ef02dfcf059920f229d7c5fb120bf", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/825b94942e0ef02dfcf059920f229d7c5fb120bf", "committedDate": "2020-07-08T12:47:48Z", "message": "Spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NzMzMzg2", "url": "https://github.com/elastic/elasticsearch/pull/59009#pullrequestreview-444733386", "createdAt": "2020-07-08T12:53:32Z", "commit": {"oid": "47a6949d109a29bd4044defe7241f6f443d2bfff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c064b81331872f8017ac805f386cfce1afc377b0", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/c064b81331872f8017ac805f386cfce1afc377b0", "committedDate": "2020-07-08T12:58:25Z", "message": "Better URI scheme"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NzY3MzYz", "url": "https://github.com/elastic/elasticsearch/pull/59009#pullrequestreview-444767363", "createdAt": "2020-07-08T13:32:13Z", "commit": {"oid": "c064b81331872f8017ac805f386cfce1afc377b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2246, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}