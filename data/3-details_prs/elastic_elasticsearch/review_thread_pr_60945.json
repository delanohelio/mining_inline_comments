{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1ODEyMzg0", "number": 60945, "reviewThreads": {"totalCount": 64, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoxNDoxN1rOEXpYog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToxNDoxNlrOEqyi3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjMwNzU0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/ClusterModule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoxNDoxOFrOG_jQ-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoxNDoxOFrOG_jQ-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5MTI1Nw==", "bodyText": "since we only need the ThreadContext here can we pass that as the constructor argument instead of the ThreadPool?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469291257", "createdAt": "2020-08-12T14:14:18Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/cluster/ClusterModule.java", "diffHunk": "@@ -107,13 +108,13 @@\n     final ShardsAllocator shardsAllocator;\n \n     public ClusterModule(Settings settings, ClusterService clusterService, List<ClusterPlugin> clusterPlugins,\n-                         ClusterInfoService clusterInfoService) {\n+                         ClusterInfoService clusterInfoService, ThreadPool threadPool) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjMxMTY0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexAbstraction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoxNToxMFrOG_jThA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoxNToxMFrOG_jThA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5MTkwOA==", "bodyText": "I agree and think we should make this similar to what we did with hidden aliases", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469291908", "createdAt": "2020-08-12T14:15:10Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexAbstraction.java", "diffHunk": "@@ -210,6 +217,13 @@ public boolean isHidden() {\n             return isHidden;\n         }\n \n+        @Override\n+        public boolean isSystem() {\n+            //G-> This is probably not the best way to tell if an alias is a system-index-alias\n+            // this should probably be checked on the alias layer and added as a property in the AliasMetadata\n+            return referenceIndexMetadatas.stream().anyMatch(IndexMetadata::isSystem);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjMyMDU3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoxNzowM1rOG_jZCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoxNzowM1rOG_jZCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5MzMyMg==", "bodyText": "this is a nit, I personally like _system_index_access_allowed", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469293322", "createdAt": "2020-08-12T14:17:03Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -61,17 +62,25 @@\n public class IndexNameExpressionResolver {\n \n     public static final String EXCLUDED_DATA_STREAMS_KEY = \"es.excluded_ds\";\n+    public static final String SYSTEM_INDEX_ACCESS_CONTROL_KEY = \"_prevent_system_index_access\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjMyNTU4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoxODoxNFrOG_jcLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxOTo1NDoyMlrOG_wN2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5NDEyNQ==", "bodyText": "why would the threadContext be null?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469294125", "createdAt": "2020-08-12T14:18:14Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -650,6 +665,13 @@ boolean isPatternMatchingAllIndices(Metadata metadata, String[] indicesOrAliases\n         return false;\n     }\n \n+    private boolean isSystemIndexAccessAllowed() {\n+        if (threadContext == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUwMzQ1MA==", "bodyText": "I think this was a hack I put in during development to work around some (since otherwise fixed) test issues that accidentally got committed. I'll remove it, thanks for the catch.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469503450", "createdAt": "2020-08-12T19:54:22Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -650,6 +665,13 @@ boolean isPatternMatchingAllIndices(Metadata metadata, String[] indicesOrAliases\n         return false;\n     }\n \n+    private boolean isSystemIndexAccessAllowed() {\n+        if (threadContext == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5NDEyNQ=="}, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 151}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjM0NTQ5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoyMjo0MlrOG_jo-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoyMjo0MlrOG_jo-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5NzQwMQ==", "bodyText": "Please use Booleans.parseBoolean instead, see #59190. This will also remove the need for the null/empty checks.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469297401", "createdAt": "2020-08-12T14:22:42Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "diffHunk": "@@ -76,6 +79,16 @@ public final long getUsageCount() {\n \n     @Override\n     public final void handleRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n+        if (allowSystemIndexAccessByDefault() == false) {\n+            final String allow_system_index_access = request.param(\"allow_system_index_access\");\n+            final ThreadContext threadContext = client.threadPool().getThreadContext();\n+            if (threadContext.getHeader(SYSTEM_INDEX_ACCESS_CONTROL_KEY) == null\n+                && (allow_system_index_access == null\n+                || allow_system_index_access.isEmpty()\n+                || Boolean.parseBoolean(allow_system_index_access) == false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjM1NjE0OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoyNTowMlrOG_jvsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDoyNTowMlrOG_jvsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI5OTEyMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    AutoCreateIndex  autoCreateIndex = new AutoCreateIndex(settings, clusterSettings,\n          \n          \n            \n                    AutoCreateIndex autoCreateIndex = new AutoCreateIndex(settings, clusterSettings,", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469299122", "createdAt": "2020-08-12T14:25:02Z", "author": {"login": "jaymode"}, "path": "server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java", "diffHunk": "@@ -177,7 +178,8 @@ public void testUpdate() {\n \n         ClusterSettings clusterSettings = new ClusterSettings(settings,\n                 ClusterSettings.BUILT_IN_CLUSTER_SETTINGS);\n-        AutoCreateIndex  autoCreateIndex = new AutoCreateIndex(settings, clusterSettings, new IndexNameExpressionResolver());\n+        AutoCreateIndex  autoCreateIndex = new AutoCreateIndex(settings, clusterSettings,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjM4NTU0OnYy", "diffSide": "LEFT", "path": "server/src/test/java/org/elasticsearch/rest/action/document/RestBulkActionTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozMTozMlrOG_kCkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxOTo1NToyOVrOG_wQSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzk1NA==", "bodyText": "By removing this, we no longer verify that the bulk method is actually called. I think adding an AtomicInteger as a counter for method invocations and validating that the method is called once should be sufficient", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469303954", "createdAt": "2020-08-12T14:31:32Z", "author": {"login": "jaymode"}, "path": "server/src/test/java/org/elasticsearch/rest/action/document/RestBulkActionTests.java", "diffHunk": "@@ -45,32 +46,38 @@\n public class RestBulkActionTests extends ESTestCase {\n \n     public void testBulkPipelineUpsert() throws Exception {\n-        final NodeClient mockClient = mock(NodeClient.class);\n-        final Map<String, String> params = new HashMap<>();\n-        params.put(\"pipeline\", \"timestamps\");\n-        new RestBulkAction(settings(Version.CURRENT).build())\n-            .handleRequest(\n-                new FakeRestRequest.Builder(\n-                    xContentRegistry()).withPath(\"my_index/_bulk\").withParams(params)\n-                    .withContent(\n-                        new BytesArray(\n-                            \"{\\\"index\\\":{\\\"_id\\\":\\\"1\\\"}}\\n\" +\n-                                \"{\\\"field1\\\":\\\"val1\\\"}\\n\" +\n-                                \"{\\\"update\\\":{\\\"_id\\\":\\\"2\\\"}}\\n\" +\n-                                \"{\\\"script\\\":{\\\"source\\\":\\\"ctx._source.counter++;\\\"},\\\"upsert\\\":{\\\"field1\\\":\\\"upserted_val\\\"}}\\n\"\n-                        ),\n-                        XContentType.JSON\n-                    ).withMethod(RestRequest.Method.POST).build(),\n-                mock(RestChannel.class), mockClient\n-            );\n-        Mockito.verify(mockClient)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTUwNDA3NQ==", "bodyText": "++, I did that for a number of other tests that needed similar change, but forgot on this one.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469504075", "createdAt": "2020-08-12T19:55:29Z", "author": {"login": "gwbrown"}, "path": "server/src/test/java/org/elasticsearch/rest/action/document/RestBulkActionTests.java", "diffHunk": "@@ -45,32 +46,38 @@\n public class RestBulkActionTests extends ESTestCase {\n \n     public void testBulkPipelineUpsert() throws Exception {\n-        final NodeClient mockClient = mock(NodeClient.class);\n-        final Map<String, String> params = new HashMap<>();\n-        params.put(\"pipeline\", \"timestamps\");\n-        new RestBulkAction(settings(Version.CURRENT).build())\n-            .handleRequest(\n-                new FakeRestRequest.Builder(\n-                    xContentRegistry()).withPath(\"my_index/_bulk\").withParams(params)\n-                    .withContent(\n-                        new BytesArray(\n-                            \"{\\\"index\\\":{\\\"_id\\\":\\\"1\\\"}}\\n\" +\n-                                \"{\\\"field1\\\":\\\"val1\\\"}\\n\" +\n-                                \"{\\\"update\\\":{\\\"_id\\\":\\\"2\\\"}}\\n\" +\n-                                \"{\\\"script\\\":{\\\"source\\\":\\\"ctx._source.counter++;\\\"},\\\"upsert\\\":{\\\"field1\\\":\\\"upserted_val\\\"}}\\n\"\n-                        ),\n-                        XContentType.JSON\n-                    ).withMethod(RestRequest.Method.POST).build(),\n-                mock(RestChannel.class), mockClient\n-            );\n-        Mockito.verify(mockClient)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzk1NA=="}, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjM5NjExOnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozMzo1MlrOG_kJSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozMzo1MlrOG_kJSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwNTY3NA==", "bodyText": "Do you want to have a constant version somewhere for when the allow_system_index_access flag was added?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469305674", "createdAt": "2020-08-12T14:33:52Z", "author": {"login": "jaymode"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -642,9 +642,13 @@ private void wipeCluster() throws Exception {\n \n     protected static void wipeAllIndices() throws IOException {\n         boolean includeHidden = minimumNodeVersion().onOrAfter(Version.V_7_7_0);\n+        boolean includeSystem = minimumNodeVersion().onOrAfter(Version.V_8_0_0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMjQwMjAxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAlias.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozNToxMFrOG_kM9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozNToxMFrOG_kM9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwNjYxNA==", "bodyText": "I guess this needs to be added to the TODO list", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r469306614", "createdAt": "2020-08-12T14:35:10Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAlias.java", "diffHunk": "@@ -99,7 +99,7 @@ public static void createIndexAndAliasIfNecessary(Client client,\n         // The initial index name must be suitable for rollover functionality.\n         String firstConcreteIndex = indexPatternPrefix + \"-000001\";\n         String[] concreteIndexNames =\n-            resolver.concreteIndexNames(clusterState, IndicesOptions.lenientExpandOpen(), indexPattern);\n+            resolver.concreteIndexNames(clusterState, IndicesOptions.lenientExpandOpen(), indexPattern); //G-> Does this work as expected?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19147b7f2ad8520c524586df0ee9a36d478b9a59"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzIzMzgxOnYy", "diffSide": "RIGHT", "path": "docs/reference/api-conventions.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDoyMTowM1rOHCk6cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDoyMTowM1rOHCk6cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ2Mzk4NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            and maintain the current behavior in the next major version.\n          \n          \n            \n            and maintain the current behavior with the addition of deprecation warnings in the next major version.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472463984", "createdAt": "2020-08-18T20:21:03Z", "author": {"login": "jaymode"}, "path": "docs/reference/api-conventions.asciidoc", "diffHunk": "@@ -37,6 +37,18 @@ include::{es-repo-dir}/rest-api/common-parms.asciidoc[tag=expand-wildcards]\n \n The defaults settings for the above parameters depend on the API being used.\n \n+Some indices (hereafter \"system indices\") are used by various system\n+components and/or plugins to store state or configuration. These indices\n+are not intended to be accessed directly, and accessing them directly is\n+deprecated. In the next major version, access to these indices will be prevented\n+by default to prevent accidental operations. You can opt in to access to these\n+indices by using the following query string parameter:\n+\n+include::{es-repo-dir}/rest-api/common-parms.asciidoc[tag=allow-system-index-access]\n+\n+Using this parameter will prevent deprecation warnings in the current version,\n+and maintain the current behavior in the next major version.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzI5NTg0OnYy", "diffSide": "RIGHT", "path": "docs/reference/rest-api/common-parms.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDozMTo1NlrOHCli0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTozNToxNVrOHCnhBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3NDMyMA==", "bodyText": "is this going to be true everywhere? Shouldn't cluster health access system indices by default? If a system index is red, the cluster is red?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472474320", "createdAt": "2020-08-18T20:31:56Z", "author": {"login": "jaymode"}, "path": "docs/reference/rest-api/common-parms.asciidoc", "diffHunk": "@@ -228,6 +228,14 @@ Wildcard expressions are not accepted.\n --\n end::expand-wildcards[]\n \n+tag::allow-system-index-access[]\n+`allow_system_index_access`::\n+(Optional, boolean) If `true`, allows this request to access system indices\n+directly. This option should be used with caution, as system indices are not\n+intended to be accessed directly.\n+Defaults to `false`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwNjYzMQ==", "bodyText": "You're right, it's not false everywhere - some APIs (like Cluster Health) override it:\nhttps://github.com/gwbrown/elasticsearch/blob/8d4f90c9c6f8dc0a35b2bbfbc6dd6f348a7cf1da/server/src/main/java/org/elasticsearch/rest/action/admin/cluster/RestClusterHealthAction.java#L55-L58\nI'll update the docs.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472506631", "createdAt": "2020-08-18T21:35:15Z", "author": {"login": "gwbrown"}, "path": "docs/reference/rest-api/common-parms.asciidoc", "diffHunk": "@@ -228,6 +228,14 @@ Wildcard expressions are not accepted.\n --\n end::expand-wildcards[]\n \n+tag::allow-system-index-access[]\n+`allow_system_index_access`::\n+(Optional, boolean) If `true`, allows this request to access system indices\n+directly. This option should be used with caution, as system indices are not\n+intended to be accessed directly.\n+Defaults to `false`.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3NDMyMA=="}, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzMxNzY2OnYy", "diffSide": "RIGHT", "path": "qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/SystemIndicesUpgradeIT.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDozNjozMFrOHClwVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNjozNDoxMFrOHDP0xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3Nzc4MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } else if (CLUSTER_TYPE == ClusterType.UPGRADED) {\n          \n          \n            \n                    } else {\n          \n          \n            \n                        assertThat(CLUSTER_TYPE, is(ClusterType.UPGRADED));", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472477781", "createdAt": "2020-08-18T20:36:30Z", "author": {"login": "jaymode"}, "path": "qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/SystemIndicesUpgradeIT.java", "diffHunk": "@@ -23,73 +23,85 @@\n \n import java.util.Map;\n \n+import static org.hamcrest.Matchers.hasKey;\n import static org.hamcrest.Matchers.is;\n \n public class SystemIndicesUpgradeIT extends AbstractRollingTestCase {\n \n-    public void testOldDoesntHaveSystemIndexMetadata() throws Exception {\n-        assumeTrue(\"only run in old cluster\", CLUSTER_TYPE == ClusterType.OLD);\n-        // create index\n-        Request createTestIndex = new Request(\"PUT\", \"/test_index_old\");\n-        createTestIndex.setJsonEntity(\"{\\\"settings\\\": {\\\"index.number_of_replicas\\\": 0}}\");\n-        client().performRequest(createTestIndex);\n+    @SuppressWarnings(\"unchecked\")\n+    public void testSystemIndicesUpgrades() throws Exception {\n+        if (CLUSTER_TYPE == ClusterType.OLD) {\n+            // create index\n+            Request createTestIndex = new Request(\"PUT\", \"/test_index_old\");\n+            createTestIndex.setJsonEntity(\"{\\\"settings\\\": {\\\"index.number_of_replicas\\\": 0}}\");\n+            client().performRequest(createTestIndex);\n \n-        Request bulk = new Request(\"POST\", \"/_bulk\");\n-        bulk.addParameter(\"refresh\", \"true\");\n-        bulk.setJsonEntity(\"{\\\"index\\\": {\\\"_index\\\": \\\"test_index_old\\\"}}\\n\" +\n-            \"{\\\"f1\\\": \\\"v1\\\", \\\"f2\\\": \\\"v2\\\"}\\n\");\n-        client().performRequest(bulk);\n+            Request bulk = new Request(\"POST\", \"/_bulk\");\n+            bulk.addParameter(\"refresh\", \"true\");\n+            bulk.setJsonEntity(\"{\\\"index\\\": {\\\"_index\\\": \\\"test_index_old\\\"}}\\n\" +\n+                \"{\\\"f1\\\": \\\"v1\\\", \\\"f2\\\": \\\"v2\\\"}\\n\");\n+            client().performRequest(bulk);\n \n-        // start a async reindex job\n-        Request reindex = new Request(\"POST\", \"/_reindex\");\n-        reindex.setJsonEntity(\n-            \"{\\n\" +\n-                \"  \\\"source\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_old\\\"\\n\" +\n-                \"  },\\n\" +\n-                \"  \\\"dest\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_reindex\\\"\\n\" +\n-                \"  }\\n\" +\n-                \"}\");\n-        reindex.addParameter(\"wait_for_completion\", \"false\");\n-        Map<String, Object> response = entityAsMap(client().performRequest(reindex));\n-        String taskId = (String) response.get(\"task\");\n+            // start a async reindex job\n+            Request reindex = new Request(\"POST\", \"/_reindex\");\n+            reindex.setJsonEntity(\n+                \"{\\n\" +\n+                    \"  \\\"source\\\":{\\n\" +\n+                    \"    \\\"index\\\":\\\"test_index_old\\\"\\n\" +\n+                    \"  },\\n\" +\n+                    \"  \\\"dest\\\":{\\n\" +\n+                    \"    \\\"index\\\":\\\"test_index_reindex\\\"\\n\" +\n+                    \"  }\\n\" +\n+                    \"}\");\n+            reindex.addParameter(\"wait_for_completion\", \"false\");\n+            Map<String, Object> response = entityAsMap(client().performRequest(reindex));\n+            String taskId = (String) response.get(\"task\");\n \n-        // wait for task\n-        Request getTask = new Request(\"GET\", \"/_tasks/\" + taskId);\n-        getTask.addParameter(\"wait_for_completion\", \"true\");\n-        client().performRequest(getTask);\n+            // wait for task\n+            Request getTask = new Request(\"GET\", \"/_tasks/\" + taskId);\n+            getTask.addParameter(\"wait_for_completion\", \"true\");\n+            client().performRequest(getTask);\n \n-        // make sure .tasks index exists\n-        assertBusy(() -> {\n-            Request getTasksIndex = new Request(\"GET\", \"/.tasks\");\n-            assertThat(client().performRequest(getTasksIndex).getStatusLine().getStatusCode(), is(200));\n-        });\n-    }\n+            // make sure .tasks index exists\n+            assertBusy(() -> {\n+                Request getTasksIndex = new Request(\"GET\", \"/.tasks\");\n+                getTasksIndex.addParameter(\"allow_no_indices\", \"false\");\n+                assertThat(client().performRequest(getTasksIndex).getStatusLine().getStatusCode(), is(200));\n+            });\n \n-    public void testMixedCluster() {\n-        assumeTrue(\"nothing to do in mixed cluster\", CLUSTER_TYPE == ClusterType.MIXED);\n-    }\n-\n-    @SuppressWarnings(\"unchecked\")\n-    public void testUpgradedCluster() throws Exception {\n-        assumeTrue(\"only run on upgraded cluster\", CLUSTER_TYPE == ClusterType.UPGRADED);\n+            // Create an alias to make sure it gets upgraded properly\n+            Request putAliasRequest = new Request(\"POST\", \"/_aliases\");\n+            putAliasRequest.setJsonEntity(\"{\\n\" +\n+                \"  \\\"actions\\\": [\\n\" +\n+                \"    {\\\"add\\\":  {\\\"index\\\":  \\\".tasks\\\", \\\"alias\\\": \\\"test-system-alias\\\"}},\\n\" +\n+                \"    {\\\"add\\\":  {\\\"index\\\":  \\\"test_index_reindex\\\", \\\"alias\\\": \\\"test-system-alias\\\"}}\\n\" +\n+                \"  ]\\n\" +\n+                \"}\");\n+            assertThat(client().performRequest(putAliasRequest).getStatusLine().getStatusCode(), is(200));\n+        } else if (CLUSTER_TYPE == ClusterType.UPGRADED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwNjg4Mg==", "bodyText": "That won't work, I think, because there's also a ClusterType.MIXED that this might be called with.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472506882", "createdAt": "2020-08-18T21:35:53Z", "author": {"login": "gwbrown"}, "path": "qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/SystemIndicesUpgradeIT.java", "diffHunk": "@@ -23,73 +23,85 @@\n \n import java.util.Map;\n \n+import static org.hamcrest.Matchers.hasKey;\n import static org.hamcrest.Matchers.is;\n \n public class SystemIndicesUpgradeIT extends AbstractRollingTestCase {\n \n-    public void testOldDoesntHaveSystemIndexMetadata() throws Exception {\n-        assumeTrue(\"only run in old cluster\", CLUSTER_TYPE == ClusterType.OLD);\n-        // create index\n-        Request createTestIndex = new Request(\"PUT\", \"/test_index_old\");\n-        createTestIndex.setJsonEntity(\"{\\\"settings\\\": {\\\"index.number_of_replicas\\\": 0}}\");\n-        client().performRequest(createTestIndex);\n+    @SuppressWarnings(\"unchecked\")\n+    public void testSystemIndicesUpgrades() throws Exception {\n+        if (CLUSTER_TYPE == ClusterType.OLD) {\n+            // create index\n+            Request createTestIndex = new Request(\"PUT\", \"/test_index_old\");\n+            createTestIndex.setJsonEntity(\"{\\\"settings\\\": {\\\"index.number_of_replicas\\\": 0}}\");\n+            client().performRequest(createTestIndex);\n \n-        Request bulk = new Request(\"POST\", \"/_bulk\");\n-        bulk.addParameter(\"refresh\", \"true\");\n-        bulk.setJsonEntity(\"{\\\"index\\\": {\\\"_index\\\": \\\"test_index_old\\\"}}\\n\" +\n-            \"{\\\"f1\\\": \\\"v1\\\", \\\"f2\\\": \\\"v2\\\"}\\n\");\n-        client().performRequest(bulk);\n+            Request bulk = new Request(\"POST\", \"/_bulk\");\n+            bulk.addParameter(\"refresh\", \"true\");\n+            bulk.setJsonEntity(\"{\\\"index\\\": {\\\"_index\\\": \\\"test_index_old\\\"}}\\n\" +\n+                \"{\\\"f1\\\": \\\"v1\\\", \\\"f2\\\": \\\"v2\\\"}\\n\");\n+            client().performRequest(bulk);\n \n-        // start a async reindex job\n-        Request reindex = new Request(\"POST\", \"/_reindex\");\n-        reindex.setJsonEntity(\n-            \"{\\n\" +\n-                \"  \\\"source\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_old\\\"\\n\" +\n-                \"  },\\n\" +\n-                \"  \\\"dest\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_reindex\\\"\\n\" +\n-                \"  }\\n\" +\n-                \"}\");\n-        reindex.addParameter(\"wait_for_completion\", \"false\");\n-        Map<String, Object> response = entityAsMap(client().performRequest(reindex));\n-        String taskId = (String) response.get(\"task\");\n+            // start a async reindex job\n+            Request reindex = new Request(\"POST\", \"/_reindex\");\n+            reindex.setJsonEntity(\n+                \"{\\n\" +\n+                    \"  \\\"source\\\":{\\n\" +\n+                    \"    \\\"index\\\":\\\"test_index_old\\\"\\n\" +\n+                    \"  },\\n\" +\n+                    \"  \\\"dest\\\":{\\n\" +\n+                    \"    \\\"index\\\":\\\"test_index_reindex\\\"\\n\" +\n+                    \"  }\\n\" +\n+                    \"}\");\n+            reindex.addParameter(\"wait_for_completion\", \"false\");\n+            Map<String, Object> response = entityAsMap(client().performRequest(reindex));\n+            String taskId = (String) response.get(\"task\");\n \n-        // wait for task\n-        Request getTask = new Request(\"GET\", \"/_tasks/\" + taskId);\n-        getTask.addParameter(\"wait_for_completion\", \"true\");\n-        client().performRequest(getTask);\n+            // wait for task\n+            Request getTask = new Request(\"GET\", \"/_tasks/\" + taskId);\n+            getTask.addParameter(\"wait_for_completion\", \"true\");\n+            client().performRequest(getTask);\n \n-        // make sure .tasks index exists\n-        assertBusy(() -> {\n-            Request getTasksIndex = new Request(\"GET\", \"/.tasks\");\n-            assertThat(client().performRequest(getTasksIndex).getStatusLine().getStatusCode(), is(200));\n-        });\n-    }\n+            // make sure .tasks index exists\n+            assertBusy(() -> {\n+                Request getTasksIndex = new Request(\"GET\", \"/.tasks\");\n+                getTasksIndex.addParameter(\"allow_no_indices\", \"false\");\n+                assertThat(client().performRequest(getTasksIndex).getStatusLine().getStatusCode(), is(200));\n+            });\n \n-    public void testMixedCluster() {\n-        assumeTrue(\"nothing to do in mixed cluster\", CLUSTER_TYPE == ClusterType.MIXED);\n-    }\n-\n-    @SuppressWarnings(\"unchecked\")\n-    public void testUpgradedCluster() throws Exception {\n-        assumeTrue(\"only run on upgraded cluster\", CLUSTER_TYPE == ClusterType.UPGRADED);\n+            // Create an alias to make sure it gets upgraded properly\n+            Request putAliasRequest = new Request(\"POST\", \"/_aliases\");\n+            putAliasRequest.setJsonEntity(\"{\\n\" +\n+                \"  \\\"actions\\\": [\\n\" +\n+                \"    {\\\"add\\\":  {\\\"index\\\":  \\\".tasks\\\", \\\"alias\\\": \\\"test-system-alias\\\"}},\\n\" +\n+                \"    {\\\"add\\\":  {\\\"index\\\":  \\\"test_index_reindex\\\", \\\"alias\\\": \\\"test-system-alias\\\"}}\\n\" +\n+                \"  ]\\n\" +\n+                \"}\");\n+            assertThat(client().performRequest(putAliasRequest).getStatusLine().getStatusCode(), is(200));\n+        } else if (CLUSTER_TYPE == ClusterType.UPGRADED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3Nzc4MQ=="}, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2NzA0Ng==", "bodyText": "You're right; I missed that the line with ClusterType.MIXED was a deletion only.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r473167046", "createdAt": "2020-08-19T16:34:10Z", "author": {"login": "jaymode"}, "path": "qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/SystemIndicesUpgradeIT.java", "diffHunk": "@@ -23,73 +23,85 @@\n \n import java.util.Map;\n \n+import static org.hamcrest.Matchers.hasKey;\n import static org.hamcrest.Matchers.is;\n \n public class SystemIndicesUpgradeIT extends AbstractRollingTestCase {\n \n-    public void testOldDoesntHaveSystemIndexMetadata() throws Exception {\n-        assumeTrue(\"only run in old cluster\", CLUSTER_TYPE == ClusterType.OLD);\n-        // create index\n-        Request createTestIndex = new Request(\"PUT\", \"/test_index_old\");\n-        createTestIndex.setJsonEntity(\"{\\\"settings\\\": {\\\"index.number_of_replicas\\\": 0}}\");\n-        client().performRequest(createTestIndex);\n+    @SuppressWarnings(\"unchecked\")\n+    public void testSystemIndicesUpgrades() throws Exception {\n+        if (CLUSTER_TYPE == ClusterType.OLD) {\n+            // create index\n+            Request createTestIndex = new Request(\"PUT\", \"/test_index_old\");\n+            createTestIndex.setJsonEntity(\"{\\\"settings\\\": {\\\"index.number_of_replicas\\\": 0}}\");\n+            client().performRequest(createTestIndex);\n \n-        Request bulk = new Request(\"POST\", \"/_bulk\");\n-        bulk.addParameter(\"refresh\", \"true\");\n-        bulk.setJsonEntity(\"{\\\"index\\\": {\\\"_index\\\": \\\"test_index_old\\\"}}\\n\" +\n-            \"{\\\"f1\\\": \\\"v1\\\", \\\"f2\\\": \\\"v2\\\"}\\n\");\n-        client().performRequest(bulk);\n+            Request bulk = new Request(\"POST\", \"/_bulk\");\n+            bulk.addParameter(\"refresh\", \"true\");\n+            bulk.setJsonEntity(\"{\\\"index\\\": {\\\"_index\\\": \\\"test_index_old\\\"}}\\n\" +\n+                \"{\\\"f1\\\": \\\"v1\\\", \\\"f2\\\": \\\"v2\\\"}\\n\");\n+            client().performRequest(bulk);\n \n-        // start a async reindex job\n-        Request reindex = new Request(\"POST\", \"/_reindex\");\n-        reindex.setJsonEntity(\n-            \"{\\n\" +\n-                \"  \\\"source\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_old\\\"\\n\" +\n-                \"  },\\n\" +\n-                \"  \\\"dest\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_reindex\\\"\\n\" +\n-                \"  }\\n\" +\n-                \"}\");\n-        reindex.addParameter(\"wait_for_completion\", \"false\");\n-        Map<String, Object> response = entityAsMap(client().performRequest(reindex));\n-        String taskId = (String) response.get(\"task\");\n+            // start a async reindex job\n+            Request reindex = new Request(\"POST\", \"/_reindex\");\n+            reindex.setJsonEntity(\n+                \"{\\n\" +\n+                    \"  \\\"source\\\":{\\n\" +\n+                    \"    \\\"index\\\":\\\"test_index_old\\\"\\n\" +\n+                    \"  },\\n\" +\n+                    \"  \\\"dest\\\":{\\n\" +\n+                    \"    \\\"index\\\":\\\"test_index_reindex\\\"\\n\" +\n+                    \"  }\\n\" +\n+                    \"}\");\n+            reindex.addParameter(\"wait_for_completion\", \"false\");\n+            Map<String, Object> response = entityAsMap(client().performRequest(reindex));\n+            String taskId = (String) response.get(\"task\");\n \n-        // wait for task\n-        Request getTask = new Request(\"GET\", \"/_tasks/\" + taskId);\n-        getTask.addParameter(\"wait_for_completion\", \"true\");\n-        client().performRequest(getTask);\n+            // wait for task\n+            Request getTask = new Request(\"GET\", \"/_tasks/\" + taskId);\n+            getTask.addParameter(\"wait_for_completion\", \"true\");\n+            client().performRequest(getTask);\n \n-        // make sure .tasks index exists\n-        assertBusy(() -> {\n-            Request getTasksIndex = new Request(\"GET\", \"/.tasks\");\n-            assertThat(client().performRequest(getTasksIndex).getStatusLine().getStatusCode(), is(200));\n-        });\n-    }\n+            // make sure .tasks index exists\n+            assertBusy(() -> {\n+                Request getTasksIndex = new Request(\"GET\", \"/.tasks\");\n+                getTasksIndex.addParameter(\"allow_no_indices\", \"false\");\n+                assertThat(client().performRequest(getTasksIndex).getStatusLine().getStatusCode(), is(200));\n+            });\n \n-    public void testMixedCluster() {\n-        assumeTrue(\"nothing to do in mixed cluster\", CLUSTER_TYPE == ClusterType.MIXED);\n-    }\n-\n-    @SuppressWarnings(\"unchecked\")\n-    public void testUpgradedCluster() throws Exception {\n-        assumeTrue(\"only run on upgraded cluster\", CLUSTER_TYPE == ClusterType.UPGRADED);\n+            // Create an alias to make sure it gets upgraded properly\n+            Request putAliasRequest = new Request(\"POST\", \"/_aliases\");\n+            putAliasRequest.setJsonEntity(\"{\\n\" +\n+                \"  \\\"actions\\\": [\\n\" +\n+                \"    {\\\"add\\\":  {\\\"index\\\":  \\\".tasks\\\", \\\"alias\\\": \\\"test-system-alias\\\"}},\\n\" +\n+                \"    {\\\"add\\\":  {\\\"index\\\":  \\\"test_index_reindex\\\", \\\"alias\\\": \\\"test-system-alias\\\"}}\\n\" +\n+                \"  ]\\n\" +\n+                \"}\");\n+            assertThat(client().performRequest(putAliasRequest).getStatusLine().getStatusCode(), is(200));\n+        } else if (CLUSTER_TYPE == ClusterType.UPGRADED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3Nzc4MQ=="}, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzMzMDIzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDo0MDoyNFrOHCl4NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNjozNToxNFrOHDP5bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3OTc5Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String ALLOW_SYSTEM_INDEX_ACCESS_KEY = \"allow_system_index_access\";\n          \n          \n            \n                public static final String ALLOW_SYSTEM_INDEX_ACCESS_KEY = \"_allow_system_index_access\";\n          \n      \n    \n    \n  \n\nThe general convention has been to use underscore in keys for system added items. I think you had one in a previous version too.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472479796", "createdAt": "2020-08-18T20:40:24Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "diffHunk": "@@ -53,6 +58,8 @@\n \n     public static final Setting<Boolean> MULTI_ALLOW_EXPLICIT_INDEX =\n         Setting.boolSetting(\"rest.action.multi.allow_explicit_index\", true, Property.NodeScope);\n+    public static final Version ALLOW_SYSTEM_INDEX_ADDED_VERSION = Version.V_8_0_0;\n+    public static final String ALLOW_SYSTEM_INDEX_ACCESS_KEY = \"allow_system_index_access\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwODI4MA==", "bodyText": "This string is the REST parameter, as in GET _search?allow_system_index_access=true. The constant defining the key used for the ThreadContext header is defined in IndexNameExpressionResolver.\nMy general philosophy has been to put the constant definitions as close to their \"primary consumer\" as possible.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472508280", "createdAt": "2020-08-18T21:38:57Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "diffHunk": "@@ -53,6 +58,8 @@\n \n     public static final Setting<Boolean> MULTI_ALLOW_EXPLICIT_INDEX =\n         Setting.boolSetting(\"rest.action.multi.allow_explicit_index\", true, Property.NodeScope);\n+    public static final Version ALLOW_SYSTEM_INDEX_ADDED_VERSION = Version.V_8_0_0;\n+    public static final String ALLOW_SYSTEM_INDEX_ACCESS_KEY = \"allow_system_index_access\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3OTc5Ng=="}, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwODc1NQ==", "bodyText": "That said, this tells me that these constants probably need names that are clearer about their purpose. So I'll update the names to make them clearer.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472508755", "createdAt": "2020-08-18T21:39:54Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "diffHunk": "@@ -53,6 +58,8 @@\n \n     public static final Setting<Boolean> MULTI_ALLOW_EXPLICIT_INDEX =\n         Setting.boolSetting(\"rest.action.multi.allow_explicit_index\", true, Property.NodeScope);\n+    public static final Version ALLOW_SYSTEM_INDEX_ADDED_VERSION = Version.V_8_0_0;\n+    public static final String ALLOW_SYSTEM_INDEX_ACCESS_KEY = \"allow_system_index_access\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3OTc5Ng=="}, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE2ODIzNw==", "bodyText": "Thanks; maybe ALLOW_SYSTEM_INDEX_ACCESS_PARAM?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r473168237", "createdAt": "2020-08-19T16:35:14Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "diffHunk": "@@ -53,6 +58,8 @@\n \n     public static final Setting<Boolean> MULTI_ALLOW_EXPLICIT_INDEX =\n         Setting.boolSetting(\"rest.action.multi.allow_explicit_index\", true, Property.NodeScope);\n+    public static final Version ALLOW_SYSTEM_INDEX_ADDED_VERSION = Version.V_8_0_0;\n+    public static final String ALLOW_SYSTEM_INDEX_ACCESS_KEY = \"allow_system_index_access\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3OTc5Ng=="}, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzM2OTczOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDo1MjowMVrOHCmP5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0MjowN1rOHCntVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4NTg2Mw==", "bodyText": "Is the check for a value in the threadcontext due to the wrapping of handlers?\nI suggest we move this \"up a level\" out of BaseRestHandler and into RestController#dispatchRequest that calls this method. The allowSystemIndexAccessByDefault method would also move to the RestHandler interface. This is due to the fact that not all RestHandlers have to be a BaseRestHandler, which could allow an unknowing bypass. I think having both a base class and an interface is a bit trappy here but changing that is beyond the scope of this PR.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472485863", "createdAt": "2020-08-18T20:52:01Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "diffHunk": "@@ -76,6 +83,14 @@ public final long getUsageCount() {\n \n     @Override\n     public final void handleRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n+        if (allowSystemIndexAccessByDefault() == false) {\n+            final String allowSystemIndexParameter = request.param(ALLOW_SYSTEM_INDEX_ACCESS_KEY);\n+            final ThreadContext threadContext = client.threadPool().getThreadContext();\n+            if (threadContext.getHeader(SYSTEM_INDEX_ACCESS_CONTROL_KEY) == null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwOTc4Mw==", "bodyText": "\ud83d\udc4d Yeah, this is primarily due to wrapping of handlers, and actually IIRC it only triggers in a few test cases that do somewhat odd things. I'll look into moving it up a level, thanks for the suggestion.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472509783", "createdAt": "2020-08-18T21:42:07Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/rest/BaseRestHandler.java", "diffHunk": "@@ -76,6 +83,14 @@ public final long getUsageCount() {\n \n     @Override\n     public final void handleRequest(RestRequest request, RestChannel channel, NodeClient client) throws Exception {\n+        if (allowSystemIndexAccessByDefault() == false) {\n+            final String allowSystemIndexParameter = request.param(ALLOW_SYSTEM_INDEX_ACCESS_KEY);\n+            final ThreadContext threadContext = client.threadPool().getThreadContext();\n+            if (threadContext.getHeader(SYSTEM_INDEX_ACCESS_CONTROL_KEY) == null", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4NTg2Mw=="}, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzM4NDE4OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/cluster/ClusterModuleTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDo1NjowOVrOHCmYmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDo1NjowOVrOHCmYmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4ODA5MA==", "bodyText": "Drop the threadpool from here and just create a threadcontext?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472488090", "createdAt": "2020-08-18T20:56:09Z", "author": {"login": "jaymode"}, "path": "server/src/test/java/org/elasticsearch/cluster/ClusterModuleTests.java", "diffHunk": "@@ -63,8 +65,24 @@\n \n public class ClusterModuleTests extends ModuleTestCase {\n     private ClusterInfoService clusterInfoService = EmptyClusterInfoService.INSTANCE;\n-    private ClusterService clusterService = new ClusterService(Settings.EMPTY,\n-        new ClusterSettings(Settings.EMPTY, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), null);\n+    private ClusterService clusterService;\n+    private ThreadPool threadPool;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzM4NzY3OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/DateMathExpressionResolverTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDo1NzoyMVrOHCmazw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDo1NzoyMVrOHCmazw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4ODY1NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ClusterState.builder(new ClusterName(\"_name\")).build(), IndicesOptions.strictExpand(),\n          \n          \n            \n                    false);\n          \n          \n            \n                        ClusterState.builder(new ClusterName(\"_name\")).build(), IndicesOptions.strictExpand(), false\n          \n          \n            \n                );", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472488655", "createdAt": "2020-08-18T20:57:21Z", "author": {"login": "jaymode"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/DateMathExpressionResolverTests.java", "diffHunk": "@@ -43,8 +43,8 @@\n \n     private final DateMathExpressionResolver expressionResolver = new DateMathExpressionResolver();\n     private final Context context = new Context(\n-            ClusterState.builder(new ClusterName(\"_name\")).build(), IndicesOptions.strictExpand()\n-    );\n+            ClusterState.builder(new ClusterName(\"_name\")).build(), IndicesOptions.strictExpand(),\n+        false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a17155c1de71005e39be572c36816a6a63fbe047"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzQxNTI4OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/client/NoOpNodeClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTowNjoxOVrOHCmrtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTowNjoxOVrOHCmrtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5Mjk4MQ==", "bodyText": "can you add basic javadocs?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472492981", "createdAt": "2020-08-18T21:06:19Z", "author": {"login": "jaymode"}, "path": "test/framework/src/main/java/org/elasticsearch/test/client/NoOpNodeClient.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.test.client;\n+\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.ActionResponse;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.support.TransportAction;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.tasks.TaskListener;\n+import org.elasticsearch.tasks.TaskManager;\n+import org.elasticsearch.threadpool.TestThreadPool;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.RemoteClusterService;\n+\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Supplier;\n+\n+public class NoOpNodeClient extends NodeClient {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4f90c9c6f8dc0a35b2bbfbc6dd6f348a7cf1da"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzQxODg1OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/RestActionTestCase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTowNzoyOVrOHCmuCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTowNzoyOVrOHCmuCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5MzU3OA==", "bodyText": "can you add basic class level javadocs?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472493578", "createdAt": "2020-08-18T21:07:29Z", "author": {"login": "jaymode"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/RestActionTestCase.java", "diffHunk": "@@ -66,4 +78,54 @@ protected void dispatchRequest(RestRequest request) {\n         ThreadContext threadContext = new ThreadContext(Settings.EMPTY);\n         controller.dispatchRequest(request, channel, threadContext);\n     }\n+\n+    public static class VerifyingClient extends NoOpNodeClient {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4f90c9c6f8dc0a35b2bbfbc6dd6f348a7cf1da"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzQ1ODIxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/TransportExecuteEnrichPolicyAction.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMToxOTo1M1rOHCnFWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMjoyMzowOVrOHQHxYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5OTU0Ng==", "bodyText": "I don't know that this is correct. If I am not mistaken this is to take a user's policy and execute it to create the enrich index for the policy. The user's permissions dictate what indices they can access so we do not want to override that with the enrich origin when reading the data from the source index but instead need to do it only when writing the data to the enrich system indices unless I missed something?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472499546", "createdAt": "2020-08-18T21:19:53Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/TransportExecuteEnrichPolicyAction.java", "diffHunk": "@@ -58,7 +61,7 @@ public TransportExecuteEnrichPolicyAction(\n         this.executor = new EnrichPolicyExecutor(\n             settings,\n             clusterService,\n-            client,\n+            new OriginSettingClient(client, ENRICH_ORIGIN),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4f90c9c6f8dc0a35b2bbfbc6dd6f348a7cf1da"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMTU5Mg==", "bodyText": "Looking at this closer, I think you're correct - I think I misread what this does the first time. Thanks for the catch!\n(Also, do we not have enrich+security tests to catch something like this? I'll have to check)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472511592", "createdAt": "2020-08-18T21:46:14Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/TransportExecuteEnrichPolicyAction.java", "diffHunk": "@@ -58,7 +61,7 @@ public TransportExecuteEnrichPolicyAction(\n         this.executor = new EnrichPolicyExecutor(\n             settings,\n             clusterService,\n-            client,\n+            new OriginSettingClient(client, ENRICH_ORIGIN),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5OTU0Ng=="}, "originalCommit": {"oid": "8d4f90c9c6f8dc0a35b2bbfbc6dd6f348a7cf1da"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE3MjI4Ng==", "bodyText": "It looks like we do have some security tests for Enrich (x-pack/plugin/enrich/qa/rest-with-security) but it is a limited set of tests.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r473172286", "createdAt": "2020-08-19T16:41:43Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/TransportExecuteEnrichPolicyAction.java", "diffHunk": "@@ -58,7 +61,7 @@ public TransportExecuteEnrichPolicyAction(\n         this.executor = new EnrichPolicyExecutor(\n             settings,\n             clusterService,\n-            client,\n+            new OriginSettingClient(client, ENRICH_ORIGIN),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5OTU0Ng=="}, "originalCommit": {"oid": "8d4f90c9c6f8dc0a35b2bbfbc6dd6f348a7cf1da"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY2NjU5NA==", "bodyText": "We discussed this offline and came to the conclusion that this is indeed the incorrect way to handle this. I've updated this to ensure that all actions that touch the source index in an Enrich policy run in the user's security context, and the Enrich security context is used only for operations that only touch the .enrich* index.\nThis does run into a problem in the reindex call used to populate the .enrich* index, which touches both. In this case, we simply drop the response headers added during the reindex call - a change which will need a follow-up later, as that approach will not work when we enable full protection of system indices.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r486666594", "createdAt": "2020-09-10T22:23:09Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/TransportExecuteEnrichPolicyAction.java", "diffHunk": "@@ -58,7 +61,7 @@ public TransportExecuteEnrichPolicyAction(\n         this.executor = new EnrichPolicyExecutor(\n             settings,\n             clusterService,\n-            client,\n+            new OriginSettingClient(client, ENRICH_ORIGIN),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5OTU0Ng=="}, "originalCommit": {"oid": "8d4f90c9c6f8dc0a35b2bbfbc6dd6f348a7cf1da"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MzQ2MzU4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/AbstractEnrichProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMToyMTozN1rOHCnIlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMTo0Njo0MlrOHCn1PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDM3Mg==", "bodyText": "I think this one is right since this is used to access the enrich system indices.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472500372", "createdAt": "2020-08-18T21:21:37Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/AbstractEnrichProcessor.java", "diffHunk": "@@ -188,8 +191,9 @@ int getMaxMatches() {\n     }\n \n     private static BiConsumer<SearchRequest, BiConsumer<SearchResponse, Exception>> createSearchRunner(Client client) {\n+        Client originClient = new OriginSettingClient(client, ENRICH_ORIGIN);\n         return (req, handler) -> {\n-            client.execute(\n+            originClient.execute(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d4f90c9c6f8dc0a35b2bbfbc6dd6f348a7cf1da"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUxMTgwNQ==", "bodyText": "++, this one I'm pretty confident on being the right thing.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r472511805", "createdAt": "2020-08-18T21:46:42Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/AbstractEnrichProcessor.java", "diffHunk": "@@ -188,8 +191,9 @@ int getMaxMatches() {\n     }\n \n     private static BiConsumer<SearchRequest, BiConsumer<SearchResponse, Exception>> createSearchRunner(Client client) {\n+        Client originClient = new OriginSettingClient(client, ENRICH_ORIGIN);\n         return (req, handler) -> {\n-            client.execute(\n+            originClient.execute(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUwMDM3Mg=="}, "originalCommit": {"oid": "8d4f90c9c6f8dc0a35b2bbfbc6dd6f348a7cf1da"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjQyMTA1OnYy", "diffSide": "RIGHT", "path": "docs/reference/api-conventions.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODozMzowMVrOHR21fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTowMjozNlrOHSGVbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4NjI2OA==", "bodyText": "Do we define what a \"system component\" is?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488486268", "createdAt": "2020-09-15T08:33:01Z", "author": {"login": "pugnascotia"}, "path": "docs/reference/api-conventions.asciidoc", "diffHunk": "@@ -42,6 +42,19 @@ include::{es-repo-dir}/rest-api/common-parms.asciidoc[tag=expand-wildcards]\n \n The defaults settings for the above parameters depend on the API being used.\n \n+Some indices (hereafter \"system indices\") are used by various system\n+components and/or plugins to store state or configuration. These indices", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MDIwNA==", "bodyText": "This should probably be modules and/or plugins, thanks.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488740204", "createdAt": "2020-09-15T15:02:36Z", "author": {"login": "gwbrown"}, "path": "docs/reference/api-conventions.asciidoc", "diffHunk": "@@ -42,6 +42,19 @@ include::{es-repo-dir}/rest-api/common-parms.asciidoc[tag=expand-wildcards]\n \n The defaults settings for the above parameters depend on the API being used.\n \n+Some indices (hereafter \"system indices\") are used by various system\n+components and/or plugins to store state or configuration. These indices", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4NjI2OA=="}, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjQ1MDM1OnYy", "diffSide": "RIGHT", "path": "qa/full-cluster-restart/src/test/java/org/elasticsearch/upgrades/FullClusterRestartIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo0MDozMFrOHR3Htg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTowNToyM1rOHSGeLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5MDkzNA==", "bodyText": "Why have we combined two tests into one, where before they were using assumeTrue / assumeFalse?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488490934", "createdAt": "2020-09-15T08:40:30Z", "author": {"login": "pugnascotia"}, "path": "qa/full-cluster-restart/src/test/java/org/elasticsearch/upgrades/FullClusterRestartIT.java", "diffHunk": "@@ -1386,67 +1390,97 @@ public void testResize() throws Exception {\n         }\n     }\n \n-    public void testCreateSystemIndexInOldVersion() throws Exception {\n-        assumeTrue(\"only run on old cluster\", isRunningAgainstOldCluster());\n-        // create index\n-        Request createTestIndex = new Request(\"PUT\", \"/test_index_old\");\n-        createTestIndex.setJsonEntity(\"{\\\"settings\\\": {\\\"index.number_of_replicas\\\": 0}}\");\n-        client().performRequest(createTestIndex);\n-\n-        Request bulk = new Request(\"POST\", \"/_bulk\");\n-        bulk.addParameter(\"refresh\", \"true\");\n-        bulk.setJsonEntity(\"{\\\"index\\\": {\\\"_index\\\": \\\"test_index_old\\\"}}\\n\" +\n-            \"{\\\"f1\\\": \\\"v1\\\", \\\"f2\\\": \\\"v2\\\"}\\n\");\n-        client().performRequest(bulk);\n-\n-        // start a async reindex job\n-        Request reindex = new Request(\"POST\", \"/_reindex\");\n-        reindex.setJsonEntity(\n-            \"{\\n\" +\n-                \"  \\\"source\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_old\\\"\\n\" +\n-                \"  },\\n\" +\n-                \"  \\\"dest\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_reindex\\\"\\n\" +\n-                \"  }\\n\" +\n-                \"}\");\n-        reindex.addParameter(\"wait_for_completion\", \"false\");\n-        Map<String, Object> response = entityAsMap(client().performRequest(reindex));\n-        String taskId = (String) response.get(\"task\");\n-\n-        // wait for task\n-        Request getTask = new Request(\"GET\", \"/_tasks/\" + taskId);\n-        getTask.addParameter(\"wait_for_completion\", \"true\");\n-        client().performRequest(getTask);\n-\n-        // make sure .tasks index exists\n-        assertBusy(() -> {\n+    @SuppressWarnings(\"unchecked\")\n+    public void testSystemIndexMetadataIsUpgraded() throws Exception {\n+        if (isRunningAgainstOldCluster()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MjQ0Nw==", "bodyText": "The code is logically the same, but combines the setup and check steps into one test method.\nUsing assumeTrue/assumeFalse causes the assuming test method to effectively be skipped when the assumed condition is not met - and in this case, they weren't really separate test cases, but a setup step (on the old cluster) and a check step (on the new cluster). By combining them into one test method that branches based on which cluster it's running against, it makes it much easier to run the entire test, as you can now use -Dtests.method=testSystemIndexMetadataIsUpgraded instead of having to specify multiple methods.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488742447", "createdAt": "2020-09-15T15:05:23Z", "author": {"login": "gwbrown"}, "path": "qa/full-cluster-restart/src/test/java/org/elasticsearch/upgrades/FullClusterRestartIT.java", "diffHunk": "@@ -1386,67 +1390,97 @@ public void testResize() throws Exception {\n         }\n     }\n \n-    public void testCreateSystemIndexInOldVersion() throws Exception {\n-        assumeTrue(\"only run on old cluster\", isRunningAgainstOldCluster());\n-        // create index\n-        Request createTestIndex = new Request(\"PUT\", \"/test_index_old\");\n-        createTestIndex.setJsonEntity(\"{\\\"settings\\\": {\\\"index.number_of_replicas\\\": 0}}\");\n-        client().performRequest(createTestIndex);\n-\n-        Request bulk = new Request(\"POST\", \"/_bulk\");\n-        bulk.addParameter(\"refresh\", \"true\");\n-        bulk.setJsonEntity(\"{\\\"index\\\": {\\\"_index\\\": \\\"test_index_old\\\"}}\\n\" +\n-            \"{\\\"f1\\\": \\\"v1\\\", \\\"f2\\\": \\\"v2\\\"}\\n\");\n-        client().performRequest(bulk);\n-\n-        // start a async reindex job\n-        Request reindex = new Request(\"POST\", \"/_reindex\");\n-        reindex.setJsonEntity(\n-            \"{\\n\" +\n-                \"  \\\"source\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_old\\\"\\n\" +\n-                \"  },\\n\" +\n-                \"  \\\"dest\\\":{\\n\" +\n-                \"    \\\"index\\\":\\\"test_index_reindex\\\"\\n\" +\n-                \"  }\\n\" +\n-                \"}\");\n-        reindex.addParameter(\"wait_for_completion\", \"false\");\n-        Map<String, Object> response = entityAsMap(client().performRequest(reindex));\n-        String taskId = (String) response.get(\"task\");\n-\n-        // wait for task\n-        Request getTask = new Request(\"GET\", \"/_tasks/\" + taskId);\n-        getTask.addParameter(\"wait_for_completion\", \"true\");\n-        client().performRequest(getTask);\n-\n-        // make sure .tasks index exists\n-        assertBusy(() -> {\n+    @SuppressWarnings(\"unchecked\")\n+    public void testSystemIndexMetadataIsUpgraded() throws Exception {\n+        if (isRunningAgainstOldCluster()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ5MDkzNA=="}, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjU2Mzk1OnYy", "diffSide": "RIGHT", "path": "qa/smoke-test-http/src/test/java/org/elasticsearch/http/SystemIndexRestIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOTowODoyMFrOHR4Ntw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTowNzowMVrOHSGjHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwODg1NQ==", "bodyText": "I think this comment is incorrect?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488508855", "createdAt": "2020-09-15T09:08:20Z", "author": {"login": "pugnascotia"}, "path": "qa/smoke-test-http/src/test/java/org/elasticsearch/http/SystemIndexRestIT.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.http;\n+\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.node.DiscoveryNodes;\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.IndexScopedSettings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsFilter;\n+import org.elasticsearch.indices.SystemIndexDescriptor;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.SystemIndexPlugin;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestHandler;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestStatusToXContentListener;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import static org.elasticsearch.test.rest.ESRestTestCase.entityAsMap;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasKey;\n+import static org.hamcrest.Matchers.is;\n+\n+public class SystemIndexRestIT extends HttpSmokeTestCase {\n+\n+    @Override\n+    protected Collection<Class<? extends Plugin>> nodePlugins() {\n+        List<Class<? extends Plugin>> plugins = new ArrayList<>(super.nodePlugins());\n+        plugins.add(SystemIndexTestPlugin.class);\n+        return plugins;\n+    }\n+\n+    public void testSystemIndexAccessBlockedByDefault() throws Exception {\n+        // create index\n+        {\n+            Request putDocRequest = new Request(\"POST\", \"/_sys_index_test/add_doc/42\");\n+            Response resp = getRestClient().performRequest(putDocRequest);\n+            assertThat(resp.getStatusLine().getStatusCode(), equalTo(201));\n+        }\n+\n+\n+        // make sure the system index now exists (with allow_system_index_access flag)\n+        assertBusy(() -> {\n+            Request searchRequest = new Request(\"GET\", \"/\" + SystemIndexTestPlugin.SYSTEM_INDEX_NAME + \"/_count\");\n+            searchRequest.addParameter(\"allow_system_index_access\", \"true\");\n+\n+            // Disallow no indices to cause an exception if the flag above doesn't work\n+            searchRequest.addParameter(\"allow_no_indices\", \"false\");\n+            searchRequest.setJsonEntity(\"{\\\"query\\\": {\\\"match\\\":  {\\\"some_field\\\":  \\\"some_value\\\"}}}\");\n+\n+            final Response searchResponse = getRestClient().performRequest(searchRequest);\n+            assertThat(searchResponse.getStatusLine().getStatusCode(), is(200));\n+            Map<String, Object> responseMap = entityAsMap(searchResponse);\n+            assertThat(responseMap, hasKey(\"count\"));\n+            assertThat(responseMap.get(\"count\"), equalTo(1));\n+        });\n+\n+        // now try without `allow_system_index_access`\n+        assertDeprecationWarningOnAccess(SystemIndexTestPlugin.SYSTEM_INDEX_NAME, SystemIndexTestPlugin.SYSTEM_INDEX_NAME);\n+\n+        // And with a partial wildcard\n+        assertDeprecationWarningOnAccess(\".test-*\", SystemIndexTestPlugin.SYSTEM_INDEX_NAME);\n+\n+        // And with a total wildcard\n+        assertDeprecationWarningOnAccess(randomFrom(\"*\", \"_all\"), SystemIndexTestPlugin.SYSTEM_INDEX_NAME);\n+\n+        // Try to index a doc directly\n+        {\n+            String expectedWarning = \"this request accesses system indices: [\" + SystemIndexTestPlugin.SYSTEM_INDEX_NAME + \"], but in a \" +\n+                \"future major version, direct access to system indices will be prevented by default\";\n+            RequestOptions expectWarningOptions = RequestOptions.DEFAULT.toBuilder().setWarningsHandler(expectedWarning::equals).build();\n+            Request putDocDirectlyRequest = new Request(\"PUT\", \"/\" + SystemIndexTestPlugin.SYSTEM_INDEX_NAME + \"/_doc/43\");\n+            putDocDirectlyRequest.setJsonEntity(\"{\\\"some_field\\\":  \\\"some_other_value\\\"}\");\n+            putDocDirectlyRequest.setOptions(expectWarningOptions);\n+            Response response = getRestClient().performRequest(putDocDirectlyRequest);\n+            assertThat(response.getStatusLine().getStatusCode(), equalTo(201));\n+        }\n+    }\n+\n+    private void assertDeprecationWarningOnAccess(String queryPattern, String warningIndexName) throws IOException {\n+        String expectedWarning = \"this request accesses system indices: [\" + warningIndexName + \"], but in a \" +\n+            \"future major version, direct access to system indices will be prevented by default\";\n+        RequestOptions expectWarningOptions = RequestOptions.DEFAULT.toBuilder()\n+            .setWarningsHandler(w -> w.contains(expectedWarning) == false || w.size() != 1)\n+            .build();\n+        Request searchRequest = new Request(\"GET\", \"/\" + queryPattern + randomFrom(\"/_count\", \"/_search\"));\n+        searchRequest.setJsonEntity(\"{\\\"query\\\": {\\\"match\\\":  {\\\"some_field\\\":  \\\"some_value\\\"}}}\");\n+        // Disallow no indices to cause an exception if this resolves to zero indices (as we expect)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0MzcxMA==", "bodyText": "Yes, this is from an old version of the test, before I switched this to emit a deprecation warning instead of omitting system indices. I'll fix.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488743710", "createdAt": "2020-09-15T15:07:01Z", "author": {"login": "gwbrown"}, "path": "qa/smoke-test-http/src/test/java/org/elasticsearch/http/SystemIndexRestIT.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.http;\n+\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.node.DiscoveryNodes;\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.IndexScopedSettings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsFilter;\n+import org.elasticsearch.indices.SystemIndexDescriptor;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.SystemIndexPlugin;\n+import org.elasticsearch.rest.BaseRestHandler;\n+import org.elasticsearch.rest.RestController;\n+import org.elasticsearch.rest.RestHandler;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestStatusToXContentListener;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import static org.elasticsearch.test.rest.ESRestTestCase.entityAsMap;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasKey;\n+import static org.hamcrest.Matchers.is;\n+\n+public class SystemIndexRestIT extends HttpSmokeTestCase {\n+\n+    @Override\n+    protected Collection<Class<? extends Plugin>> nodePlugins() {\n+        List<Class<? extends Plugin>> plugins = new ArrayList<>(super.nodePlugins());\n+        plugins.add(SystemIndexTestPlugin.class);\n+        return plugins;\n+    }\n+\n+    public void testSystemIndexAccessBlockedByDefault() throws Exception {\n+        // create index\n+        {\n+            Request putDocRequest = new Request(\"POST\", \"/_sys_index_test/add_doc/42\");\n+            Response resp = getRestClient().performRequest(putDocRequest);\n+            assertThat(resp.getStatusLine().getStatusCode(), equalTo(201));\n+        }\n+\n+\n+        // make sure the system index now exists (with allow_system_index_access flag)\n+        assertBusy(() -> {\n+            Request searchRequest = new Request(\"GET\", \"/\" + SystemIndexTestPlugin.SYSTEM_INDEX_NAME + \"/_count\");\n+            searchRequest.addParameter(\"allow_system_index_access\", \"true\");\n+\n+            // Disallow no indices to cause an exception if the flag above doesn't work\n+            searchRequest.addParameter(\"allow_no_indices\", \"false\");\n+            searchRequest.setJsonEntity(\"{\\\"query\\\": {\\\"match\\\":  {\\\"some_field\\\":  \\\"some_value\\\"}}}\");\n+\n+            final Response searchResponse = getRestClient().performRequest(searchRequest);\n+            assertThat(searchResponse.getStatusLine().getStatusCode(), is(200));\n+            Map<String, Object> responseMap = entityAsMap(searchResponse);\n+            assertThat(responseMap, hasKey(\"count\"));\n+            assertThat(responseMap.get(\"count\"), equalTo(1));\n+        });\n+\n+        // now try without `allow_system_index_access`\n+        assertDeprecationWarningOnAccess(SystemIndexTestPlugin.SYSTEM_INDEX_NAME, SystemIndexTestPlugin.SYSTEM_INDEX_NAME);\n+\n+        // And with a partial wildcard\n+        assertDeprecationWarningOnAccess(\".test-*\", SystemIndexTestPlugin.SYSTEM_INDEX_NAME);\n+\n+        // And with a total wildcard\n+        assertDeprecationWarningOnAccess(randomFrom(\"*\", \"_all\"), SystemIndexTestPlugin.SYSTEM_INDEX_NAME);\n+\n+        // Try to index a doc directly\n+        {\n+            String expectedWarning = \"this request accesses system indices: [\" + SystemIndexTestPlugin.SYSTEM_INDEX_NAME + \"], but in a \" +\n+                \"future major version, direct access to system indices will be prevented by default\";\n+            RequestOptions expectWarningOptions = RequestOptions.DEFAULT.toBuilder().setWarningsHandler(expectedWarning::equals).build();\n+            Request putDocDirectlyRequest = new Request(\"PUT\", \"/\" + SystemIndexTestPlugin.SYSTEM_INDEX_NAME + \"/_doc/43\");\n+            putDocDirectlyRequest.setJsonEntity(\"{\\\"some_field\\\":  \\\"some_other_value\\\"}\");\n+            putDocDirectlyRequest.setOptions(expectWarningOptions);\n+            Response response = getRestClient().performRequest(putDocDirectlyRequest);\n+            assertThat(response.getStatusLine().getStatusCode(), equalTo(201));\n+        }\n+    }\n+\n+    private void assertDeprecationWarningOnAccess(String queryPattern, String warningIndexName) throws IOException {\n+        String expectedWarning = \"this request accesses system indices: [\" + warningIndexName + \"], but in a \" +\n+            \"future major version, direct access to system indices will be prevented by default\";\n+        RequestOptions expectWarningOptions = RequestOptions.DEFAULT.toBuilder()\n+            .setWarningsHandler(w -> w.contains(expectedWarning) == false || w.size() != 1)\n+            .build();\n+        Request searchRequest = new Request(\"GET\", \"/\" + queryPattern + randomFrom(\"/_count\", \"/_search\"));\n+        searchRequest.setJsonEntity(\"{\\\"query\\\": {\\\"match\\\":  {\\\"some_field\\\":  \\\"some_value\\\"}}}\");\n+        // Disallow no indices to cause an exception if this resolves to zero indices (as we expect)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwODg1NQ=="}, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 120}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjY2MzczOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOTozMzoxNFrOHR5KkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNToxMTowMVrOHSGusA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyNDQzMg==", "bodyText": "Should this be removed?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488524432", "createdAt": "2020-09-15T09:33:14Z", "author": {"login": "pugnascotia"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -282,10 +317,44 @@\n             }\n             throw infe;\n         }\n+        checkSystemIndexAccess(context, metadata, concreteIndices);\n         return concreteIndices.toArray(new Index[concreteIndices.size()]);\n     }\n \n+    private static void checkSystemIndexAccess(Context context, Metadata metadata, Set<Index> concreteIndices) {\n+        if (context.isSystemIndexAccessAllowed() == false) {\n+            final List<String> resolvedSystemIndices = concreteIndices.stream()\n+                .map(metadata::index)\n+                .filter(IndexMetadata::isSystem)\n+                .map(i -> i.getIndex().getName())\n+                .sorted() // reliable order for testing\n+                .collect(Collectors.toList());\n+            if (resolvedSystemIndices.isEmpty() == false) {\n+                switch (SYSTEM_INDEX_ACCESS_BEHAVIOR) {\n+                    case ALLOWED:\n+                        // If access is allowed in all cases, then there's nothing to do here.\n+                        break;\n+                    case DEPRECATED:\n+                        deprecationLogger.deprecate(\"open_system_index_access\",\n+                            \"this request accesses system indices: {}, but in a future major version, direct access to system \" +\n+                                \"indices will be prevented by default\", resolvedSystemIndices);\n+                        break;\n+                    case RESTRICTED:\n+                        final String errorMsg = \"while resolving indices, resolved system indices [\" + resolvedSystemIndices +\n+                            \"] when access to system indices is restricted\";\n+                        assert false : errorMsg;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0NjY3Mg==", "bodyText": "This is intentional. This will cause the node to fail if this line is hit with assertions enabled (i.e. during testing), which is what I want as this would indicate there's a bug in the code which should cause system indices to be completely omitted - and if there is, I want it to yell as loudly as possible.\nIf this line is hit without assertions enabled, it will fall through to the next line, which throws an exception. This is a relatively common pattern to enforce invariants more strictly during testing than at runtime.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488746672", "createdAt": "2020-09-15T15:11:01Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -282,10 +317,44 @@\n             }\n             throw infe;\n         }\n+        checkSystemIndexAccess(context, metadata, concreteIndices);\n         return concreteIndices.toArray(new Index[concreteIndices.size()]);\n     }\n \n+    private static void checkSystemIndexAccess(Context context, Metadata metadata, Set<Index> concreteIndices) {\n+        if (context.isSystemIndexAccessAllowed() == false) {\n+            final List<String> resolvedSystemIndices = concreteIndices.stream()\n+                .map(metadata::index)\n+                .filter(IndexMetadata::isSystem)\n+                .map(i -> i.getIndex().getName())\n+                .sorted() // reliable order for testing\n+                .collect(Collectors.toList());\n+            if (resolvedSystemIndices.isEmpty() == false) {\n+                switch (SYSTEM_INDEX_ACCESS_BEHAVIOR) {\n+                    case ALLOWED:\n+                        // If access is allowed in all cases, then there's nothing to do here.\n+                        break;\n+                    case DEPRECATED:\n+                        deprecationLogger.deprecate(\"open_system_index_access\",\n+                            \"this request accesses system indices: {}, but in a future major version, direct access to system \" +\n+                                \"indices will be prevented by default\", resolvedSystemIndices);\n+                        break;\n+                    case RESTRICTED:\n+                        final String errorMsg = \"while resolving indices, resolved system indices [\" + resolvedSystemIndices +\n+                            \"] when access to system indices is restricted\";\n+                        assert false : errorMsg;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUyNDQzMg=="}, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 164}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1Njg3MjIxOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/IndexAbstractionTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMDoyNjoyOFrOHR7MeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMDo0NDowMlrOHST2UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU1NzY4OQ==", "bodyText": "I'm not generally a fan of long tests that check lots of cases. Can we usefully split up this method into a series of more targeted test cases, ideally with a Javadoc comment that explains what is the test is for (see point 9 here).", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488557689", "createdAt": "2020-09-15T10:26:28Z", "author": {"login": "pugnascotia"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/IndexAbstractionTests.java", "diffHunk": "@@ -116,13 +118,82 @@ public void testHiddenAliasValidation() {\n         }\n     }\n \n-    private IndexMetadata buildIndexWithAlias(String indexName, String aliasName, @Nullable Boolean aliasIsHidden) {\n+    public void testSystemAliasValidation() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk2MTYxNw==", "bodyText": "I've split this test and the one in IndexNameExpressionResolverTests into multiple tests. I have not added Javadoc to the split test cases though, as the test cases ended up fairly small and I was finding in attempting to write Javadoc for them that the Javadoc largely was just repeating the test names.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488961617", "createdAt": "2020-09-15T20:44:02Z", "author": {"login": "gwbrown"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/IndexAbstractionTests.java", "diffHunk": "@@ -116,13 +118,82 @@ public void testHiddenAliasValidation() {\n         }\n     }\n \n-    private IndexMetadata buildIndexWithAlias(String indexName, String aliasName, @Nullable Boolean aliasIsHidden) {\n+    public void testSystemAliasValidation() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU1NzY4OQ=="}, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjkwMjY2OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolverTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMDozNTowOVrOHR7fDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMDozNTowOVrOHR7fDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU2MjQ0Nw==", "bodyText": "Same observation here about splitting up this test.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488562447", "createdAt": "2020-09-15T10:35:09Z", "author": {"login": "pugnascotia"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolverTests.java", "diffHunk": "@@ -1810,6 +1828,125 @@ public void testIgnoreThrottled() {\n         }\n     }\n \n+    public void testSystemIndexResolutionWhenAllowed() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 543}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NjkyNDkzOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolverTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMDo0MTozOVrOHR7s9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMDo0MTozOVrOHR7s9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU2NjAwNA==", "bodyText": "What do you think about defining a helper method, to cut down on the ceremony here? Something like:\nprivate void getConcreteIndexNames(ClusterState state, SearchRequest request) {\n    return List<String> indexNames = Arrays\n        .stream(indexNameExpressionResolver.concreteIndices(state, request))\n        .map(i -> i.getName())\n        .collect(Collectors.toList());\n}", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488566004", "createdAt": "2020-09-15T10:41:39Z", "author": {"login": "pugnascotia"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolverTests.java", "diffHunk": "@@ -1810,6 +1828,125 @@ public void testIgnoreThrottled() {\n         }\n     }\n \n+    public void testSystemIndexResolutionWhenAllowed() {\n+        Settings settings = Settings.builder().build();\n+        Metadata.Builder mdBuilder = Metadata.builder()\n+            .put(indexBuilder(\".ml-meta\", settings).state(State.OPEN).system(true))\n+            .put(indexBuilder(\".watches\", settings).state(State.OPEN).system(true))\n+            .put(indexBuilder(\".ml-stuff\", settings).state(State.OPEN).system(true))\n+            .put(indexBuilder(\"some-other-index\").state(State.OPEN));\n+        ClusterState state = ClusterState.builder(new ClusterName(\"_name\")).metadata(mdBuilder).build();\n+\n+        // Single name\n+        {\n+            SearchRequest request = new SearchRequest(\".ml-meta\");\n+\n+            List<String> indexNames = Arrays\n+                .stream(indexNameExpressionResolver.concreteIndices(state, request))\n+                .map(i -> i.getName())\n+                .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 559}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NzI1MzE3OnYy", "diffSide": "RIGHT", "path": "x-pack/qa/src/main/java/org/elasticsearch/xpack/test/rest/IndexMappingTemplateAsserter.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMjoxMzo1N1rOHR-06w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMToyNTo1MlrOHSVHBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYxNzE5NQ==", "bodyText": "I can't see this new parameter being used. Am I missing something?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488617195", "createdAt": "2020-09-15T12:13:57Z", "author": {"login": "pugnascotia"}, "path": "x-pack/qa/src/main/java/org/elasticsearch/xpack/test/rest/IndexMappingTemplateAsserter.java", "diffHunk": "@@ -51,9 +51,10 @@\n      * effect of a different test running in the cluster.\n      *\n      * @param client The rest client\n+     * @param allowSystemIndexWarnings Whether deprecation warnings for system index access should be allowed/expected.\n      * @throws IOException On error\n      */\n-    public static void assertMlMappingsMatchTemplates(RestClient client) throws IOException {\n+    public static void assertMlMappingsMatchTemplates(RestClient client, boolean allowSystemIndexWarnings) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0OTQ3NQ==", "bodyText": "Good catch, I forgot some plumbing here. I'll fix - if this is false, it should then pass false to all of the assertLegacyTemplateMatchesIndexMappings calls (as opposed to now, where some of them are hardcoded to true)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488749475", "createdAt": "2020-09-15T15:14:38Z", "author": {"login": "gwbrown"}, "path": "x-pack/qa/src/main/java/org/elasticsearch/xpack/test/rest/IndexMappingTemplateAsserter.java", "diffHunk": "@@ -51,9 +51,10 @@\n      * effect of a different test running in the cluster.\n      *\n      * @param client The rest client\n+     * @param allowSystemIndexWarnings Whether deprecation warnings for system index access should be allowed/expected.\n      * @throws IOException On error\n      */\n-    public static void assertMlMappingsMatchTemplates(RestClient client) throws IOException {\n+    public static void assertMlMappingsMatchTemplates(RestClient client, boolean allowSystemIndexWarnings) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYxNzE5NQ=="}, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4MjI3Ng==", "bodyText": "Actually, it turns out I misread one of the callsites and this must be true for both places this is called, so I removed this parameter and went back to specifying the values passed to assertLegacyTemplateMatchesIndexMappings directly.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r488982276", "createdAt": "2020-09-15T21:25:52Z", "author": {"login": "gwbrown"}, "path": "x-pack/qa/src/main/java/org/elasticsearch/xpack/test/rest/IndexMappingTemplateAsserter.java", "diffHunk": "@@ -51,9 +51,10 @@\n      * effect of a different test running in the cluster.\n      *\n      * @param client The rest client\n+     * @param allowSystemIndexWarnings Whether deprecation warnings for system index access should be allowed/expected.\n      * @throws IOException On error\n      */\n-    public static void assertMlMappingsMatchTemplates(RestClient client) throws IOException {\n+    public static void assertMlMappingsMatchTemplates(RestClient client, boolean allowSystemIndexWarnings) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODYxNzE5NQ=="}, "originalCommit": {"oid": "e5f90679f5b7059d4ea6d4cbe5fc06aa8538131a"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2Mzg0MjkwOnYy", "diffSide": "RIGHT", "path": "modules/reindex/src/yamlRestTest/resources/rest-api-spec/test/delete_by_query/80_slices.yml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxODo1NToxN1rOHS-_bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMTowNTozNVrOHTEMjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY2ODQ2MA==", "bodyText": "I think we should open an issue for tests like this that access a system index directly. We will want to track this and find solutions", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489668460", "createdAt": "2020-09-16T18:55:17Z", "author": {"login": "jaymode"}, "path": "modules/reindex/src/yamlRestTest/resources/rest-api-spec/test/delete_by_query/80_slices.yml", "diffHunk": "@@ -154,6 +154,7 @@\n       indices.refresh: {}\n   - do:\n       search:\n+        allow_system_index_access: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcyMDUzMQ==", "bodyText": "++, I'll open a meta-issue (as I think there are a few too many for individual issues).", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489720531", "createdAt": "2020-09-16T19:59:48Z", "author": {"login": "gwbrown"}, "path": "modules/reindex/src/yamlRestTest/resources/rest-api-spec/test/delete_by_query/80_slices.yml", "diffHunk": "@@ -154,6 +154,7 @@\n       indices.refresh: {}\n   - do:\n       search:\n+        allow_system_index_access: true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY2ODQ2MA=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1Mzc0Mg==", "bodyText": "I've opened #62501 with all the places in our REST tests which either 1) use allow_system_index_access or 2) swallow the deprecation warning.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489753742", "createdAt": "2020-09-16T21:05:35Z", "author": {"login": "gwbrown"}, "path": "modules/reindex/src/yamlRestTest/resources/rest-api-spec/test/delete_by_query/80_slices.yml", "diffHunk": "@@ -154,6 +154,7 @@\n       indices.refresh: {}\n   - do:\n       search:\n+        allow_system_index_access: true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY2ODQ2MA=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2Mzk3ODQ0OnYy", "diffSide": "RIGHT", "path": "server/build.gradle", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOToxNTo0MVrOHTAfpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTo0NTo1NVrOHTy7ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MzA5NQ==", "bodyText": "I am not sure about this; shouldn't this be an assume in the tests?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489693095", "createdAt": "2020-09-16T19:15:41Z", "author": {"login": "jaymode"}, "path": "server/build.gradle", "diffHunk": "@@ -298,3 +298,10 @@ tasks.named(\"licenseHeaders\").configure {\n     excludes << 'org/apache/lucene/search/RegExp87*'\n     excludes << 'org/apache/lucene/search/RegexpQuery87*'\n }\n+\n+tasks.named(\"test\").configure {\n+  /* We need to set this to prevent release builds from failing while the default is different between snapshot and release builds.\n+  * In particular, this is needed for IndexNameExpressionResolverTests, which assumes the value is `deprecated`.\n+  */\n+  systemProperty 'es.system_index_access_behavior', 'deprecated'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxOTExMw==", "bodyText": "That sounds like a better solution - I just didn't think of it when I noticed the situation would happen. Will do that instead.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489719113", "createdAt": "2020-09-16T19:57:02Z", "author": {"login": "gwbrown"}, "path": "server/build.gradle", "diffHunk": "@@ -298,3 +298,10 @@ tasks.named(\"licenseHeaders\").configure {\n     excludes << 'org/apache/lucene/search/RegExp87*'\n     excludes << 'org/apache/lucene/search/RegexpQuery87*'\n }\n+\n+tasks.named(\"test\").configure {\n+  /* We need to set this to prevent release builds from failing while the default is different between snapshot and release builds.\n+  * In particular, this is needed for IndexNameExpressionResolverTests, which assumes the value is `deprecated`.\n+  */\n+  systemProperty 'es.system_index_access_behavior', 'deprecated'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MzA5NQ=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxOTQxOQ==", "bodyText": "I've removed the system property in these gradle files and used assumeTrue in the tests in question.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r490519419", "createdAt": "2020-09-17T19:45:55Z", "author": {"login": "gwbrown"}, "path": "server/build.gradle", "diffHunk": "@@ -298,3 +298,10 @@ tasks.named(\"licenseHeaders\").configure {\n     excludes << 'org/apache/lucene/search/RegExp87*'\n     excludes << 'org/apache/lucene/search/RegexpQuery87*'\n }\n+\n+tasks.named(\"test\").configure {\n+  /* We need to set this to prevent release builds from failing while the default is different between snapshot and release builds.\n+  * In particular, this is needed for IndexNameExpressionResolverTests, which assumes the value is `deprecated`.\n+  */\n+  systemProperty 'es.system_index_access_behavior', 'deprecated'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MzA5NQ=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2Mzk3OTMwOnYy", "diffSide": "RIGHT", "path": "qa/smoke-test-http/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOToxNTo1MVrOHTAgRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTo0NjowMlrOHTy7yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MzI1Mw==", "bodyText": "I am not sure about this; shouldn't this be an assume in the tests?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489693253", "createdAt": "2020-09-16T19:15:51Z", "author": {"login": "jaymode"}, "path": "qa/smoke-test-http/build.gradle", "diffHunk": "@@ -34,4 +34,9 @@ integTest {\n    * other if we allow them to set the number of available processors as it's set-once in Netty.\n    */\n   systemProperty 'es.set.netty.runtime.available.processors', 'false'\n+\n+  /* We need to set this here to prevent release builds from failing while the default is different between snapshot and release builds.\n+  * Specifically, this is needed for SystemIndexRestIT, which assumes the value is `deprecated`.\n+  */\n+  systemProperty 'es.system_index_access_behavior', 'deprecated'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxOTQ5Ng==", "bodyText": "I've removed the system property in these gradle files and used assumeTrue in the tests in question.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r490519496", "createdAt": "2020-09-17T19:46:02Z", "author": {"login": "gwbrown"}, "path": "qa/smoke-test-http/build.gradle", "diffHunk": "@@ -34,4 +34,9 @@ integTest {\n    * other if we allow them to set the number of available processors as it's set-once in Netty.\n    */\n   systemProperty 'es.set.netty.runtime.available.processors', 'false'\n+\n+  /* We need to set this here to prevent release builds from failing while the default is different between snapshot and release builds.\n+  * Specifically, this is needed for SystemIndexRestIT, which assumes the value is `deprecated`.\n+  */\n+  systemProperty 'es.system_index_access_behavior', 'deprecated'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5MzI1Mw=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDAwNjM3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestGetAliasesAction.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOToyMDoyMlrOHTAywA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMDo1NTo0MlrOHT1Nvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5Nzk4NA==", "bodyText": "Should resolution of _all that includes system indices trigger a deprecation warning? If we get all aliases and return system aliases such as .security in 7.x but stop doing so in 8.0, then that would be a breaking change right?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489697984", "createdAt": "2020-09-16T19:20:22Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestGetAliasesAction.java", "diffHunk": "@@ -72,8 +72,15 @@ public String getName() {\n         return \"get_aliases_action\";\n     }\n \n+    @Override\n+    public boolean allowSystemIndexAccessByDefault() {\n+        // If not given an index (only an alias), resolves `_all`, which causes deprecation warnings.\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxOTIwOA==", "bodyText": "Should resolution of _all that includes system indices trigger a deprecation warning?\n\nThis does feel odd, but:\n\nIf it doesn't trigger a deprecation warning, then (for example) searches against _all that return documents in system indices will have an unannounced breaking change in 8.0, as you note in your second question.\nAs far as I can tell, in the presence of Security, it's impossible to tell in IndexNameExpressionResolver if the original query used a wildcard or not, as the original list of indices has by then been replaced. If I'm wrong and there's a good way to get that information, this might be a bit easier to fix.\n\n\nIf we get all aliases and return system aliases such as .security in 7.x but stop doing so in 8.0, then that would be a breaking change right?\n\nSort of - if we go ahead with our plan of treating system indices created in 7.x with the previous 7.x behavior, then technically no, but if we upgrade all of the system indices shortly after ugprade, it'll feel like it to a user.\nI'd definitely like to figure out something better to do here.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r490519208", "createdAt": "2020-09-17T19:45:28Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestGetAliasesAction.java", "diffHunk": "@@ -72,8 +72,15 @@ public String getName() {\n         return \"get_aliases_action\";\n     }\n \n+    @Override\n+    public boolean allowSystemIndexAccessByDefault() {\n+        // If not given an index (only an alias), resolves `_all`, which causes deprecation warnings.\n+        return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5Nzk4NA=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU1Njg2Mg==", "bodyText": "As far as I can tell, in the presence of Security, it's impossible to tell in IndexNameExpressionResolver if the original query used a wildcard or not, as the original list of indices has by then been replaced\n\nThat is 100% correct. I do wonder if we could have security place the original indices in the thread context and have the IndexNameExpressionResolver know that header/context key?\n\nif we go ahead with our plan of treating system indices created in 7.x with the previous 7.x behavior, then technically no, but if we upgrade all of the system indices shortly after ugprade, it'll feel like it to a user.\n\nI think there may be confusion around treatment of 7.x system indices. The original plan involved every index that was dot-prefixed to be a system index except those created in 7.x or earlier. Once we made the decision to allow hidden indices to be dot-prefixed, that opened up the ability to no longer having to provide this layer of bwc for system indices since we could have user created indices, hidden indices, and system indices that all start with dots after an upgrade. Instead, we allow 7.x dot indices that are not system or hidden to behave normally.\nWe're already marking specific indices as system indices in 7.x if a descriptor has been registered for that index to route the read operations to the correct thread pool.\nI am wondering if the types removal behavior could fit here:\n\nImplicit system index access without the parameter is deprecated in 7.x\nExplicit system index access without the parameter is deprecated in 7.x\nSystem index access with the parameter is not deprecated in 7.x\nImplicit system index access without the parameter is a bad request in 8.0\nExplicit system index access without the parameter is a bad request in 8.0\nSystem index access with the parameter is deprecated in 8.0+\nParameter removed for 9.0 :)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r490556862", "createdAt": "2020-09-17T20:55:42Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestGetAliasesAction.java", "diffHunk": "@@ -72,8 +72,15 @@ public String getName() {\n         return \"get_aliases_action\";\n     }\n \n+    @Override\n+    public boolean allowSystemIndexAccessByDefault() {\n+        // If not given an index (only an alias), resolves `_all`, which causes deprecation warnings.\n+        return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5Nzk4NA=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDAwOTI4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/action/cat/AbstractCatAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOToyMDo0NVrOHTA0nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTo0MzowNFrOHTy1ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5ODQ2MA==", "bodyText": "why do we allow system by default for cat apis?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489698460", "createdAt": "2020-09-16T19:20:45Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/action/cat/AbstractCatAction.java", "diffHunk": "@@ -42,6 +42,11 @@\n \n     protected abstract Table getTableWithHeader(RestRequest request);\n \n+    @Override\n+    public boolean allowSystemIndexAccessByDefault() {\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxNzkyMw==", "bodyText": "This ties into the \"Resolving _all causes a deprecation warning\" issue, and we can't omit them (like we do with hidden indices) in 7.x, as that would break BWC.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r490517923", "createdAt": "2020-09-17T19:43:04Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/rest/action/cat/AbstractCatAction.java", "diffHunk": "@@ -42,6 +42,11 @@\n \n     protected abstract Table getTableWithHeader(RestRequest request);\n \n+    @Override\n+    public boolean allowSystemIndexAccessByDefault() {\n+        return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY5ODQ2MA=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDAyMTEzOnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/watcher/managing-watches.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOToyMjozMVrOHTA83Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTo0NzozNVrOHTy-vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwMDU3Mw==", "bodyText": "we should open an issue for the watcher docs since we need to stop accessing .watches directly", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489700573", "createdAt": "2020-09-16T19:22:31Z", "author": {"login": "jaymode"}, "path": "x-pack/docs/en/watcher/managing-watches.asciidoc", "diffHunk": "@@ -28,7 +28,7 @@ For example, the following returns the first 100 watches:\n \n [source,console]\n --------------------------------------------------\n-GET .watches/_search\n+GET .watches/_search?allow_system_index_access=true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUyMDI1NA==", "bodyText": "I've added this to the list of tests that need to be adjusted to remove this flag (#62501).", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r490520254", "createdAt": "2020-09-17T19:47:35Z", "author": {"login": "gwbrown"}, "path": "x-pack/docs/en/watcher/managing-watches.asciidoc", "diffHunk": "@@ -28,7 +28,7 @@ For example, the following returns the first 100 watches:\n \n [source,console]\n --------------------------------------------------\n-GET .watches/_search\n+GET .watches/_search?allow_system_index_access=true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwMDU3Mw=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDAyNjk1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/rest/RestDataStreamsStatsAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOToyMzo1NFrOHTBA5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTo0ODoxM1rOHTzACg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwMTYwNA==", "bodyText": "this feels like a hack to me; I wonder if we can find a way to not need this for items that resolve _all to do certain things :|", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489701604", "createdAt": "2020-09-16T19:23:54Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/rest/RestDataStreamsStatsAction.java", "diffHunk": "@@ -29,6 +29,12 @@ public String getName() {\n         );\n     }\n \n+    @Override\n+    public boolean allowSystemIndexAccessByDefault() {\n+        // Does not actually access system indices, but does resolve `_all`, which can cause confusing deprecation warnings.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUyMDU4Ng==", "bodyText": "It's definitely a hack, and I'd love to not do this. I'll dig in a bit and see if there's a better way to handle this case.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r490520586", "createdAt": "2020-09-17T19:48:13Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/data-streams/src/main/java/org/elasticsearch/xpack/datastreams/rest/RestDataStreamsStatsAction.java", "diffHunk": "@@ -29,6 +29,12 @@ public String getName() {\n         );\n     }\n \n+    @Override\n+    public boolean allowSystemIndexAccessByDefault() {\n+        // Does not actually access system indices, but does resolve `_all`, which can cause confusing deprecation warnings.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwMTYwNA=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDAzMDM1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/EnrichPolicyRunner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOToyNDo1NVrOHTBDFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMTozODowOVrOHTFI-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwMjE2NA==", "bodyText": "Do we have an issue for this yet?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489702164", "createdAt": "2020-09-16T19:24:55Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/EnrichPolicyRunner.java", "diffHunk": "@@ -350,67 +355,80 @@ private void transferDataToEnrichIndex(final String destinationIndexName) {\n         reindexRequest.getDestination().source(new BytesArray(new byte[0]), XContentType.SMILE);\n         reindexRequest.getDestination().routing(\"discard\");\n         reindexRequest.getDestination().setPipeline(EnrichPolicyReindexPipeline.pipelineName());\n-        client.execute(ReindexAction.INSTANCE, reindexRequest, new ActionListener<>() {\n-            @Override\n-            public void onResponse(BulkByScrollResponse bulkByScrollResponse) {\n-                // Do we want to fail the request if there were failures during the reindex process?\n-                if (bulkByScrollResponse.getBulkFailures().size() > 0) {\n-                    logger.warn(\n-                        \"Policy [{}]: encountered [{}] bulk failures. Turn on DEBUG logging for details.\",\n-                        policyName,\n-                        bulkByScrollResponse.getBulkFailures().size()\n-                    );\n-                    if (logger.isDebugEnabled()) {\n-                        for (BulkItemResponse.Failure failure : bulkByScrollResponse.getBulkFailures()) {\n-                            logger.debug(\n-                                new ParameterizedMessage(\n-                                    \"Policy [{}]: bulk index failed for index [{}], id [{}]\",\n-                                    policyName,\n-                                    failure.getIndex(),\n-                                    failure.getId()\n-                                ),\n-                                failure.getCause()\n+\n+        // The ContextPreservingActionListener here is for the purpose of dropping the response headers, as we need this reindex to run\n+        // in the security context of the user (rather than Enrich's security context) to ensure that DLS/FLS is correctly applied, but\n+        // the reindex needs to access the `.enrich` index, which causes a deprecation warning. Since we drop the response headers,\n+        // the deprecation warning is also dropped - but this is a hack and will not work once full protections of system indices are", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc2OTIwOQ==", "bodyText": "We do now: #62505", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489769209", "createdAt": "2020-09-16T21:38:09Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/EnrichPolicyRunner.java", "diffHunk": "@@ -350,67 +355,80 @@ private void transferDataToEnrichIndex(final String destinationIndexName) {\n         reindexRequest.getDestination().source(new BytesArray(new byte[0]), XContentType.SMILE);\n         reindexRequest.getDestination().routing(\"discard\");\n         reindexRequest.getDestination().setPipeline(EnrichPolicyReindexPipeline.pipelineName());\n-        client.execute(ReindexAction.INSTANCE, reindexRequest, new ActionListener<>() {\n-            @Override\n-            public void onResponse(BulkByScrollResponse bulkByScrollResponse) {\n-                // Do we want to fail the request if there were failures during the reindex process?\n-                if (bulkByScrollResponse.getBulkFailures().size() > 0) {\n-                    logger.warn(\n-                        \"Policy [{}]: encountered [{}] bulk failures. Turn on DEBUG logging for details.\",\n-                        policyName,\n-                        bulkByScrollResponse.getBulkFailures().size()\n-                    );\n-                    if (logger.isDebugEnabled()) {\n-                        for (BulkItemResponse.Failure failure : bulkByScrollResponse.getBulkFailures()) {\n-                            logger.debug(\n-                                new ParameterizedMessage(\n-                                    \"Policy [{}]: bulk index failed for index [{}], id [{}]\",\n-                                    policyName,\n-                                    failure.getIndex(),\n-                                    failure.getId()\n-                                ),\n-                                failure.getCause()\n+\n+        // The ContextPreservingActionListener here is for the purpose of dropping the response headers, as we need this reindex to run\n+        // in the security context of the user (rather than Enrich's security context) to ensure that DLS/FLS is correctly applied, but\n+        // the reindex needs to access the `.enrich` index, which causes a deprecation warning. Since we drop the response headers,\n+        // the deprecation warning is also dropped - but this is a hack and will not work once full protections of system indices are", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwMjE2NA=="}, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA1MDI3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/ml/custom_all_field.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMDoyOFrOHTBPAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMDoyOFrOHTBPAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNTIxOQ==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489705219", "createdAt": "2020-09-16T19:30:28Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/ml/custom_all_field.yml", "diffHunk": "@@ -148,6 +148,7 @@ setup:\n \n   - do:\n       search:\n+        allow_system_index_access: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA1MTk4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformConfigurationIndexIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMTowMVrOHTBQJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMTowMVrOHTBQJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNTUxMQ==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489705511", "createdAt": "2020-09-16T19:31:01Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformConfigurationIndexIT.java", "diffHunk": "@@ -43,6 +43,7 @@ public void testDeleteConfigurationLeftOver() throws IOException {\n             final StringEntity entity = new StringEntity(Strings.toString(builder), ContentType.APPLICATION_JSON);\n             Request req = new Request(\"PUT\",\n                     TransformInternalIndexConstants.LATEST_INDEX_NAME + \"/_doc/\" + TransformConfig.documentId(fakeTransformName));\n+            req.addParameter(\"allow_system_index_access\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA1MzUxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformInternalIndexIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMTozMFrOHTBRJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMTozMFrOHTBRJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNTc2Nw==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489705767", "createdAt": "2020-09-16T19:31:30Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformInternalIndexIT.java", "diffHunk": "@@ -79,14 +76,18 @@ public void testUpdateDeletesOldTransformConfig() throws Exception {\n             + \" } } } },\"\n             + \"\\\"frequency\\\":\\\"1s\\\"\"\n             + \"}\";\n-        client.index(new IndexRequest(OLD_INDEX)\n-                .id(TransformConfig.documentId(transformId))\n-                .source(config, XContentType.JSON)\n-                .setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE),\n-            RequestOptions.DEFAULT);\n-        GetResponse getResponse = client.get(new GetRequest(OLD_INDEX, TransformConfig.documentId(transformId)),\n-            RequestOptions.DEFAULT);\n-        assertThat(getResponse.isExists(), is(true));\n+        Request indexRequest = new Request(\"PUT\", OLD_INDEX + \"/_doc/\" + TransformConfig.documentId(transformId));\n+        indexRequest.addParameter(\"allow_system_index_access\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA1NDgwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformRestTestCase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMTo1MVrOHTBR6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMTo1MVrOHTBR6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNTk2MA==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489705960", "createdAt": "2020-09-16T19:31:51Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformRestTestCase.java", "diffHunk": "@@ -480,6 +480,7 @@ public void wipeTransforms() throws IOException {\n \n         // the configuration index should be empty\n         Request request = new Request(\"GET\", TransformInternalIndexConstants.LATEST_INDEX_NAME + \"/_search\");\n+        request.addParameter(\"allow_system_index_access\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA1NTU4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformRobustnessIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMjowN1rOHTBSYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMjowN1rOHTBSYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNjA4MA==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489706080", "createdAt": "2020-09-16T19:32:07Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformRobustnessIT.java", "diffHunk": "@@ -117,6 +117,8 @@ private int getNumberOfTransformTasks() throws IOException {\n     }\n \n     private void beEvilAndDeleteTheTransformIndex() throws IOException {\n-        adminClient().performRequest(new Request(\"DELETE\", TransformInternalIndexConstants.LATEST_INDEX_NAME));\n+        final Request deleteRequest = new Request(\"DELETE\", TransformInternalIndexConstants.LATEST_INDEX_NAME);\n+        deleteRequest.addParameter(\"allow_system_index_access\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA1NjUzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformUsageIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMjoyMVrOHTBS7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMjoyMVrOHTBS7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNjIyMA==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489706220", "createdAt": "2020-09-16T19:32:21Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformUsageIT.java", "diffHunk": "@@ -62,6 +62,7 @@ public void testUsage() throws Exception {\n                 + \":\"\n                 + TransformStoredDoc.NAME\n         );\n+        statsExistsRequest.addParameter(\"allow_system_index_access\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA1OTI2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMzowNlrOHTBUlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMzowNlrOHTBUlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNjY0Nw==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489706647", "createdAt": "2020-09-16T19:33:06Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java", "diffHunk": "@@ -73,6 +73,7 @@ public final void stopWatcher() throws Exception {\n \n         Request deleteWatchesIndexRequest = new Request(\"DELETE\", \".watches\");\n         deleteWatchesIndexRequest.addParameter(\"ignore_unavailable\", \"true\");\n+        deleteWatchesIndexRequest.addParameter(\"allow_system_index_access\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA2MDM3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherYamlSuiteTestCase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMzozMFrOHTBVVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMzozMFrOHTBVVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNjgzOQ==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489706839", "createdAt": "2020-09-16T19:33:30Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherYamlSuiteTestCase.java", "diffHunk": "@@ -105,6 +105,7 @@ public final void stopWatcher() throws Exception {\n     private static void deleteWatcherIndices() throws IOException {\n         Request deleteWatchesIndexRequest = new Request(\"DELETE\", \".watches\");\n         deleteWatchesIndexRequest.addParameter(\"ignore_unavailable\", \"true\");\n+        deleteWatchesIndexRequest.addParameter(\"allow_system_index_access\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA2MTAwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/10_basic.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMzo0MlrOHTBVuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMzo0MlrOHTBVuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNjkzNg==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489706936", "createdAt": "2020-09-16T19:33:42Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/10_basic.yml", "diffHunk": "@@ -46,6 +46,7 @@\n   - do:\n       search:\n         rest_total_hits_as_int: true\n+        allow_system_index_access: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA2MTg3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/activate_watch/10_basic.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMzo1N1rOHTBWQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozMzo1N1rOHTBWQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzA3Mw==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489707073", "createdAt": "2020-09-16T19:33:57Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/activate_watch/10_basic.yml", "diffHunk": "@@ -50,6 +50,7 @@\n   - do:\n       search:\n         rest_total_hits_as_int: true\n+        allow_system_index_access: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA2Mjg3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/delete_watch/10_basic.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNDowOVrOHTBW0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNDowOVrOHTBW0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzIxNg==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489707216", "createdAt": "2020-09-16T19:34:09Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/delete_watch/10_basic.yml", "diffHunk": "@@ -54,6 +54,7 @@ teardown:\n   - do:\n       search:\n         rest_total_hits_as_int: true\n+        allow_system_index_access: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA2MzY2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/10_basic.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNDoyMFrOHTBXQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNDoyMFrOHTBXQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzMzMQ==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489707331", "createdAt": "2020-09-16T19:34:20Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/10_basic.yml", "diffHunk": "@@ -49,6 +49,7 @@ teardown:\n   - do:\n       search:\n         rest_total_hits_as_int: true\n+        allow_system_index_access: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA2NDA0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/80_put_get_watch_with_passwords.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNDoyOFrOHTBXjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNDoyOFrOHTBXjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzQwNA==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489707404", "createdAt": "2020-09-16T19:34:28Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/80_put_get_watch_with_passwords.yml", "diffHunk": "@@ -262,6 +262,7 @@ setup:\n   - do:\n       search:\n         rest_total_hits_as_int: true\n+        allow_system_index_access: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDA2NTkyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/with-monitoring/src/javaRestTest/java/org/elasticsearch/smoketest/MonitoringWithWatcherRestIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNTowNFrOHTBYug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTozNTowNFrOHTBYug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcwNzcwNg==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489707706", "createdAt": "2020-09-16T19:35:04Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/watcher/qa/with-monitoring/src/javaRestTest/java/org/elasticsearch/smoketest/MonitoringWithWatcherRestIT.java", "diffHunk": "@@ -86,8 +88,10 @@ private void assertMonitoringWatchHasBeenOverWritten(String watchId) throws Exce\n \n     private void assertTotalWatchCount(int expectedWatches) throws Exception {\n         assertBusy(() -> {\n-            assertOK(client().performRequest(new Request(\"POST\", \"/.watches/_refresh\")));\n-            ObjectPath path = ObjectPath.createFromResponse(client().performRequest(new Request(\"POST\", \"/.watches/_count\")));\n+            refreshAllIndices();\n+            final Request countRequest = new Request(\"POST\", \"/.watches/_count\");\n+            countRequest.addParameter(\"allow_system_index_access\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDEwOTA5OnYy", "diffSide": "RIGHT", "path": "x-pack/qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/MlMappingsUpgradeIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTo0ODowMFrOHTBzdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxOTo0ODowMFrOHTBzdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTcxNDU0OQ==", "bodyText": "add an issue for this test too (or add it to an issue for all tests)", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r489714549", "createdAt": "2020-09-16T19:48:00Z", "author": {"login": "jaymode"}, "path": "x-pack/qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/MlMappingsUpgradeIT.java", "diffHunk": "@@ -163,6 +163,7 @@ private void assertUpgradedConfigMappings() throws Exception {\n \n         assertBusy(() -> {\n             Request getMappings = new Request(\"GET\", \".ml-config/_mappings\");\n+            getMappings.addParameter(\"allow_system_index_access\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bde46a126c5df2928a88f499d8d86f79afcca3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODkxNzkxOnYy", "diffSide": "RIGHT", "path": "docs/reference/api-conventions.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjozNjo1MlrOHclE3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjozNjo1MlrOHclE3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyOTYyOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            deprecated. In the next major version, access to these indices will be prevented\n          \n          \n            \n            by default to prevent accidental operations that may cause problems with\n          \n          \n            \n            deprecated. In the next major version, access to these indices will no longer\n          \n          \n            \n            be allowed to prevent accidental operations that may cause problems with", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499729629", "createdAt": "2020-10-05T16:36:52Z", "author": {"login": "jaymode"}, "path": "docs/reference/api-conventions.asciidoc", "diffHunk": "@@ -42,6 +42,14 @@ include::{es-repo-dir}/rest-api/common-parms.asciidoc[tag=expand-wildcards]\n \n The defaults settings for the above parameters depend on the API being used.\n \n+Some indices (hereafter \"system indices\") are used by various system\n+modules and/or plugins to store state or configuration. These indices\n+are not intended to be accessed directly, and accessing them directly is\n+deprecated. In the next major version, access to these indices will be prevented\n+by default to prevent accidental operations that may cause problems with", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODk5NzcyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/alias/get/TransportGetAliasesAction.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjo1ODozOVrOHcl2bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMjo0OTowNlrOHcwTJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0MjMxNg==", "bodyText": "Shouldn't we also deprecate if the alias request was for a \"system alias\" (say .kibana) but it doesn't exist?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499742316", "createdAt": "2020-10-05T16:58:39Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/alias/get/TransportGetAliasesAction.java", "diffHunk": "@@ -85,7 +99,27 @@ protected void masterOperation(Task task, GetAliasesRequest request, ClusterStat\n                 assert previous == null;\n             }\n         }\n-        return mapBuilder.build();\n+        final ImmutableOpenMap<String, List<AliasMetadata>> finalResponse = mapBuilder.build();\n+        if (systemIndexAccessAllowed == false) {\n+            checkSystemIndexAccess(state, finalResponse);\n+        }\n+        return finalResponse;\n+    }\n+\n+    private static void checkSystemIndexAccess(ClusterState state, ImmutableOpenMap<String, List<AliasMetadata>> aliasesMap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc3MTUwOQ==", "bodyText": "We can do so if it matches a System Index pattern, at least, yes.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499771509", "createdAt": "2020-10-05T17:52:43Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/alias/get/TransportGetAliasesAction.java", "diffHunk": "@@ -85,7 +99,27 @@ protected void masterOperation(Task task, GetAliasesRequest request, ClusterStat\n                 assert previous == null;\n             }\n         }\n-        return mapBuilder.build();\n+        final ImmutableOpenMap<String, List<AliasMetadata>> finalResponse = mapBuilder.build();\n+        if (systemIndexAccessAllowed == false) {\n+            checkSystemIndexAccess(state, finalResponse);\n+        }\n+        return finalResponse;\n+    }\n+\n+    private static void checkSystemIndexAccess(ClusterState state, ImmutableOpenMap<String, List<AliasMetadata>> aliasesMap) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0MjMxNg=="}, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkxMzUxMA==", "bodyText": "I've implemented this such that the alias is only checked if there are no concrete system indices found to warn about.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499913510", "createdAt": "2020-10-05T22:49:06Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/alias/get/TransportGetAliasesAction.java", "diffHunk": "@@ -85,7 +99,27 @@ protected void masterOperation(Task task, GetAliasesRequest request, ClusterStat\n                 assert previous == null;\n             }\n         }\n-        return mapBuilder.build();\n+        final ImmutableOpenMap<String, List<AliasMetadata>> finalResponse = mapBuilder.build();\n+        if (systemIndexAccessAllowed == false) {\n+            checkSystemIndexAccess(state, finalResponse);\n+        }\n+        return finalResponse;\n+    }\n+\n+    private static void checkSystemIndexAccess(ClusterState state, ImmutableOpenMap<String, List<AliasMetadata>> aliasesMap) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0MjMxNg=="}, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTAwNzA3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzowMToyMlrOHcl8ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzowMToyMlrOHcl8ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0Mzg2Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static DeprecationLogger deprecationLogger = DeprecationLogger.getLogger(IndexNameExpressionResolver.class);\n          \n          \n            \n                private static final DeprecationLogger deprecationLogger = DeprecationLogger.getLogger(IndexNameExpressionResolver.class);", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499743867", "createdAt": "2020-10-05T17:01:22Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -59,19 +63,37 @@\n import java.util.stream.StreamSupport;\n \n public class IndexNameExpressionResolver {\n+    public static DeprecationLogger deprecationLogger = DeprecationLogger.getLogger(IndexNameExpressionResolver.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTAxMTIxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzowMjo0MVrOHcl_FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzowMjo0MVrOHcl_FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NDUzMw==", "bodyText": "can you document this method?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499744533", "createdAt": "2020-10-05T17:02:41Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -650,6 +693,10 @@ boolean isPatternMatchingAllIndices(Metadata metadata, String[] indicesOrAliases\n         return false;\n     }\n \n+    public boolean isSystemIndexAccessAllowed() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 195}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTAyNjM2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzowNzowN1rOHcmIsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzowNzowN1rOHcmIsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0Njk5Mg==", "bodyText": "technically we don't need to modify this method's signature since the class has the NodeClient, so we could do client.threadPool().getThreadContext() to get the ThreadContext and even store the reference in the class constructor.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499746992", "createdAt": "2020-10-05T17:07:07Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -218,7 +219,8 @@ public void dispatchBadRequest(final RestChannel channel, final ThreadContext th\n         }\n     }\n \n-    private void dispatchRequest(RestRequest request, RestChannel channel, RestHandler handler) throws Exception {\n+    private void dispatchRequest(RestRequest request, RestChannel channel, RestHandler handler,\n+                                 ThreadContext threadContext) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTAzMzM3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestRefreshAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzowOToxNlrOHcmNAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzo1MToyMlrOHcnluw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0ODA5OQ==", "bodyText": "Do you recall why we need to allow system indices to be refreshed?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499748099", "createdAt": "2020-10-05T17:09:16Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestRefreshAction.java", "diffHunk": "@@ -51,6 +51,11 @@ public String getName() {\n         return \"refresh_action\";\n     }\n \n+    @Override\n+    public boolean allowSystemIndexAccessByDefault() {\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc3MDgxMQ==", "bodyText": "I don't think we do - I had intended to remove this.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499770811", "createdAt": "2020-10-05T17:51:22Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/rest/action/admin/indices/RestRefreshAction.java", "diffHunk": "@@ -51,6 +51,11 @@ public String getName() {\n         return \"refresh_action\";\n     }\n \n+    @Override\n+    public boolean allowSystemIndexAccessByDefault() {\n+        return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0ODA5OQ=="}, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTAzNzQ2OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/action/ActionModuleTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzoxMDozMlrOHcmPiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzoxMDozMlrOHcmPiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0ODc0NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            new IndexNameExpressionResolver(new ThreadContext(Settings.EMPTY)), settings.getIndexScopedSettings(),\n          \n          \n            \n                            new IndexNameExpressionResolver(threadPool.getThreadContext()), settings.getIndexScopedSettings(),", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499748745", "createdAt": "2020-10-05T17:10:32Z", "author": {"login": "jaymode"}, "path": "server/src/test/java/org/elasticsearch/action/ActionModuleTests.java", "diffHunk": "@@ -146,9 +148,10 @@ public String getName() {\n         ThreadPool threadPool = new TestThreadPool(getTestName());\n         try {\n             UsageService usageService = new UsageService();\n-            ActionModule actionModule = new ActionModule(settings.getSettings(), new IndexNameExpressionResolver(),\n-                    settings.getIndexScopedSettings(), settings.getClusterSettings(), settings.getSettingsFilter(), threadPool,\n-                    singletonList(dupsMainAction), null, null, usageService, null);\n+            ActionModule actionModule = new ActionModule(settings.getSettings(),\n+                new IndexNameExpressionResolver(new ThreadContext(Settings.EMPTY)), settings.getIndexScopedSettings(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTAzODc5OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/action/ActionModuleTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzoxMDo1OFrOHcmQXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzoxMDo1OFrOHcmQXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0ODk1Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            new IndexNameExpressionResolver(new ThreadContext(Settings.EMPTY)), settings.getIndexScopedSettings(),\n          \n          \n            \n                            new IndexNameExpressionResolver(threadPool.getThreadContext()), settings.getIndexScopedSettings(),", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499748956", "createdAt": "2020-10-05T17:10:58Z", "author": {"login": "jaymode"}, "path": "server/src/test/java/org/elasticsearch/action/ActionModuleTests.java", "diffHunk": "@@ -180,9 +183,10 @@ public void handleRequest(RestRequest request, RestChannel channel, NodeClient c\n         ThreadPool threadPool = new TestThreadPool(getTestName());\n         try {\n             UsageService usageService = new UsageService();\n-            ActionModule actionModule = new ActionModule(settings.getSettings(), new IndexNameExpressionResolver(),\n-                    settings.getIndexScopedSettings(), settings.getClusterSettings(), settings.getSettingsFilter(), threadPool,\n-                    singletonList(registersFakeHandler), null, null, usageService, null);\n+            ActionModule actionModule = new ActionModule(settings.getSettings(),\n+                new IndexNameExpressionResolver(new ThreadContext(Settings.EMPTY)), settings.getIndexScopedSettings(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTA1OTU5OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/watcher/managing-watches.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzoxNjo0M1rOHcmdEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzo1MDozNlrOHcnkNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MjIwOA==", "bodyText": "what is the plan for this documentation?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499752208", "createdAt": "2020-10-05T17:16:43Z", "author": {"login": "jaymode"}, "path": "x-pack/docs/en/watcher/managing-watches.asciidoc", "diffHunk": "@@ -33,4 +33,4 @@ GET .watches/_search\n   \"size\" : 100\n }\n --------------------------------------------------\n-// TEST[setup:my_active_watch]\n+// TEST[skip:deprecation warning]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc3MDQyMw==", "bodyText": "This is listed in #62501, to be updated by core/features. While it's not quite a test in the same vein as many of the others, it appears as though it may be an indication that there is a Watcher feature missing (similar to some of the other tests).", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499770423", "createdAt": "2020-10-05T17:50:36Z", "author": {"login": "gwbrown"}, "path": "x-pack/docs/en/watcher/managing-watches.asciidoc", "diffHunk": "@@ -33,4 +33,4 @@ GET .watches/_search\n   \"size\" : 100\n }\n --------------------------------------------------\n-// TEST[setup:my_active_watch]\n+// TEST[skip:deprecation warning]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MjIwOA=="}, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTA2ODYwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzoxOToxNFrOHcminw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzo1MTowMFrOHcnk_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MzYzMQ==", "bodyText": "do we need this log statement?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499753631", "createdAt": "2020-10-05T17:19:14Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -71,8 +70,26 @@ protected Settings restClientSettings() {\n     @After\n     public void cleanUpData() throws Exception {\n         new MlRestTestStateCleaner(logger, adminClient()).clearMlMetadata();\n-        client().performRequest(new Request(\"DELETE\", InferenceIndexConstants.INDEX_PATTERN));\n-        client().performRequest(new Request(\"DELETE\", MlStatsIndex.indexPattern()));\n+        RequestOptions allowSystemIndexAccessWarningOptions = RequestOptions.DEFAULT.toBuilder()\n+            .setWarningsHandler(warnings -> {\n+                if (warnings.isEmpty()) {\n+                    // There may not be an index to delete, in which case there's no warning\n+                    return false;\n+                } else if (warnings.size() > 1) {\n+                    logger.warn(\"too many warnings: {}\", warnings);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc3MDYyMg==", "bodyText": "No, thanks for catching. I'll remove.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r499770622", "createdAt": "2020-10-05T17:51:00Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -71,8 +70,26 @@ protected Settings restClientSettings() {\n     @After\n     public void cleanUpData() throws Exception {\n         new MlRestTestStateCleaner(logger, adminClient()).clearMlMetadata();\n-        client().performRequest(new Request(\"DELETE\", InferenceIndexConstants.INDEX_PATTERN));\n-        client().performRequest(new Request(\"DELETE\", MlStatsIndex.indexPattern()));\n+        RequestOptions allowSystemIndexAccessWarningOptions = RequestOptions.DEFAULT.toBuilder()\n+            .setWarningsHandler(warnings -> {\n+                if (warnings.isEmpty()) {\n+                    // There may not be an index to delete, in which case there's no warning\n+                    return false;\n+                } else if (warnings.size() > 1) {\n+                    logger.warn(\"too many warnings: {}\", warnings);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MzYzMQ=="}, "originalCommit": {"oid": "0e302e6c75e75684b2d0f5b3b36bcbcd5836cdc7"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMjk3NjI2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/alias/get/TransportGetAliasesAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowMzozNlrOHdL-sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowMzozNlrOHdL-sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM2NzAyNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static DeprecationLogger deprecationLogger = DeprecationLogger.getLogger(TransportGetAliasesAction.class);\n          \n          \n            \n                private static final DeprecationLogger deprecationLogger = DeprecationLogger.getLogger(TransportGetAliasesAction.class);", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r500367027", "createdAt": "2020-10-06T15:03:36Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/alias/get/TransportGetAliasesAction.java", "diffHunk": "@@ -25,27 +25,39 @@\n import org.elasticsearch.cluster.block.ClusterBlockException;\n import org.elasticsearch.cluster.block.ClusterBlockLevel;\n import org.elasticsearch.cluster.metadata.AliasMetadata;\n+import org.elasticsearch.cluster.metadata.IndexMetadata;\n import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n import org.elasticsearch.cluster.service.ClusterService;\n import org.elasticsearch.common.collect.ImmutableOpenMap;\n import org.elasticsearch.common.inject.Inject;\n import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.logging.DeprecationLogger;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.indices.SystemIndices;\n import org.elasticsearch.tasks.Task;\n import org.elasticsearch.threadpool.ThreadPool;\n import org.elasticsearch.transport.TransportService;\n \n import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.Collections;\n+import java.util.Iterator;\n import java.util.List;\n+import java.util.stream.Collectors;\n \n public class TransportGetAliasesAction extends TransportMasterNodeReadAction<GetAliasesRequest, GetAliasesResponse> {\n+    private static DeprecationLogger deprecationLogger = DeprecationLogger.getLogger(TransportGetAliasesAction.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ea0be50bf135f020ef5c49506dd88e0a390a1be"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzAyOTIzOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/rest/RestControllerTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToxMjo0MlrOHdMglQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToxMjo0MlrOHdMglQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3NTcwMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    client.close();\n          \n          \n            \n                    IOUtils.close(client);\n          \n      \n    \n    \n  \n\nThis allows us to guard in case the client is null to avoid unnecessary exceptions in case of odd setup failure. The IOUtils class I am referencing is from package org.elasticsearch.core.internal.io", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r500375701", "createdAt": "2020-10-06T15:12:42Z", "author": {"login": "jaymode"}, "path": "server/src/test/java/org/elasticsearch/rest/RestControllerTests.java", "diffHunk": "@@ -103,8 +107,13 @@ public void setup() {\n         httpServerTransport.start();\n     }\n \n+    @After\n+    public void teardown() {\n+        client.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ea0be50bf135f020ef5c49506dd88e0a390a1be"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzAzNzc1OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNToxNDoxNlrOHdMl1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTo0OToxMVrOHdOflQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3NzA0NQ==", "bodyText": "why did closed get dropped here?", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r500377045", "createdAt": "2020-10-06T15:14:16Z", "author": {"login": "jaymode"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -798,7 +812,17 @@ private void wipeRollupJobs() throws IOException {\n     protected void refreshAllIndices() throws IOException {\n         boolean includeHidden = minimumNodeVersion().onOrAfter(Version.V_7_7_0);\n         Request refreshRequest = new Request(\"POST\", \"/_refresh\");\n-        refreshRequest.addParameter(\"expand_wildcards\", \"open,closed\" + (includeHidden ? \",hidden\" : \"\"));\n+        refreshRequest.addParameter(\"expand_wildcards\", \"open\" + (includeHidden ? \",hidden\" : \"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ea0be50bf135f020ef5c49506dd88e0a390a1be"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQwODIxMw==", "bodyText": "Trying to refresh a closed index appears to cause an exception, but that only came up after I switched a test which involves closing an index to use this instead of a direct POST _refresh call (to take advantage of the deprecation warning handling). This method is only used in a few tests, and I think specifying closed was always wrong, it just never mattered before.", "url": "https://github.com/elastic/elasticsearch/pull/60945#discussion_r500408213", "createdAt": "2020-10-06T15:49:11Z", "author": {"login": "gwbrown"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -798,7 +812,17 @@ private void wipeRollupJobs() throws IOException {\n     protected void refreshAllIndices() throws IOException {\n         boolean includeHidden = minimumNodeVersion().onOrAfter(Version.V_7_7_0);\n         Request refreshRequest = new Request(\"POST\", \"/_refresh\");\n-        refreshRequest.addParameter(\"expand_wildcards\", \"open,closed\" + (includeHidden ? \",hidden\" : \"\"));\n+        refreshRequest.addParameter(\"expand_wildcards\", \"open\" + (includeHidden ? \",hidden\" : \"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3NzA0NQ=="}, "originalCommit": {"oid": "0ea0be50bf135f020ef5c49506dd88e0a390a1be"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2550, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}