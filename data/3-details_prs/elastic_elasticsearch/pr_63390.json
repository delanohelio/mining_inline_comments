{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MDk4Mjc4", "number": 63390, "title": "SnapshotShardSizeInfo should prefer default value when provided", "bodyText": "In #61906 we agreed on always providing the default value ShardRouting.UNAVAILABLE_EXPECTED_SHARD_SIZE when the SnasphotInfoService failed to retrieve the exact size for a given snapshot shard. The motivation was to allow the shard allocation to move forward in case of failures (so that the unassigned shard does not get stuck in an unassigned state for too long) while relying on the fallback values for shard sizes.\nSadly a bug in the SnapshotShardSizeInfo#getShardSize(ShardRouting, long) makes the default value to be ignored when the snapshot shard size retrieval previously failed, returning ShardRouting.UNAVAILABLE_EXPECTED_SHARD_SIZE instead of the provided default value. With DiskThresholdDecider also not relying on the provided default value this triggers some assertion like in #63376 which helped us to spot the bug.\nNote that we'd like to add more test to the DiskThresholdDecider as suggested in #61906 (review)\nCloses #63376", "createdAt": "2020-10-07T09:06:50Z", "url": "https://github.com/elastic/elasticsearch/pull/63390", "merged": true, "mergeCommit": {"oid": "dae6c367b51217da01c937b035b2179bae7a3ce8"}, "closed": true, "closedAt": "2020-10-07T10:55:56Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQJGClAH2gAyNDk5MDk4Mjc4OmY3YTA0MjEwMDI5ZjdkZmQ3M2EzOTZlNGI1MTQwZWEwN2RkNzUxMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQKsPmAFqTUwMzc1MjMyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7a04210029f7dfd73a396e4b5140ea07dd75139", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/f7a04210029f7dfd73a396e4b5140ea07dd75139", "committedDate": "2020-10-07T08:55:46Z", "message": "SnapshotShardSizeInfo should prefer default value when provided"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjkzNzUw", "url": "https://github.com/elastic/elasticsearch/pull/63390#pullrequestreview-503693750", "createdAt": "2020-10-07T09:31:01Z", "commit": {"oid": "f7a04210029f7dfd73a396e4b5140ea07dd75139"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8766ff4fdcc897a6175d85f2d5d127b6dbc6a2e", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/f8766ff4fdcc897a6175d85f2d5d127b6dbc6a2e", "committedDate": "2020-10-07T09:31:17Z", "message": "fix checkstyle + assert shardrouting is found in test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNjk1Mzc3", "url": "https://github.com/elastic/elasticsearch/pull/63390#pullrequestreview-503695377", "createdAt": "2020-10-07T09:33:01Z", "commit": {"oid": "f7a04210029f7dfd73a396e4b5140ea07dd75139"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOTozMzowMVrOHdqzIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOTozMzowMVrOHdqzIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg3MTk3MA==", "bodyText": "maybe rename this to getFetchedShardSize? I am not too fond of having two methods with same name and a fallback argument that behaves differently (thinking of the != null assertion meaning this is only legal to call when size has been fetched).", "url": "https://github.com/elastic/elasticsearch/pull/63390#discussion_r500871970", "createdAt": "2020-10-07T09:33:01Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotShardSizeInfo.java", "diffHunk": "@@ -48,6 +48,7 @@ public Long getShardSize(ShardRouting shardRouting) {\n \n     public long getShardSize(ShardRouting shardRouting, long fallback) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7a04210029f7dfd73a396e4b5140ea07dd75139"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11aaf496f71968392f3eee25f4982e1e50d85128", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/11aaf496f71968392f3eee25f4982e1e50d85128", "committedDate": "2020-10-07T09:55:04Z", "message": "remove assertion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzUyMzIx", "url": "https://github.com/elastic/elasticsearch/pull/63390#pullrequestreview-503752321", "createdAt": "2020-10-07T10:47:24Z", "commit": {"oid": "11aaf496f71968392f3eee25f4982e1e50d85128"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4354, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}