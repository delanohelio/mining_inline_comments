{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NDU5NTkz", "number": 57278, "title": "Make AnnotationPersister use bulk requests instead of indexing individual documents", "bodyText": "With the model change annotations in the works, there will be a need for AnnotationPersister to handle large number of indexing requests. To improve performance, this PR makes AnnotationPersister use bulk requests (with the bulk limit of 10000) instead of indexing individual annotation documents.\nAdditionally, this PR:\n\nmakes AnnotationPersister use ResultsPersisterService for retrying (this required moving AnnotationPersister from core plugin to ml plugin)\nremoves errorMessage parameter from AnnotationPersister::persistAnnotation to simplify the code.\ngives JobResultsPersister.Builder.shouldRetry a default value of () -> true so that the interfaces of JobResultsPersister.Builder and AnnotationPersister.Builder are consistent.\n\nRelates #55781", "createdAt": "2020-05-28T12:39:51Z", "url": "https://github.com/elastic/elasticsearch/pull/57278", "merged": true, "mergeCommit": {"oid": "e50f5d5d869a776b023d3a0febbe221464aaaa45"}, "closed": true, "closedAt": "2020-05-29T12:27:03Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclthvsABqjMzODI2Nzk2Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmAleMABqjMzODY3NDM2MDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e23498aca277fb1d30f4fece42d7cb1cf7a41ce", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e23498aca277fb1d30f4fece42d7cb1cf7a41ce", "committedDate": "2020-05-28T12:35:46Z", "message": "Make AnnotationPersister use bulk requests instead of indexing individual documents"}, "afterCommit": {"oid": "45b649412990280a0d6f0e3c2cef1b042dd0c833", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/45b649412990280a0d6f0e3c2cef1b042dd0c833", "committedDate": "2020-05-28T13:03:41Z", "message": "Make AnnotationPersister use bulk requests instead of indexing individual documents"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45b649412990280a0d6f0e3c2cef1b042dd0c833", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/45b649412990280a0d6f0e3c2cef1b042dd0c833", "committedDate": "2020-05-28T13:03:41Z", "message": "Make AnnotationPersister use bulk requests instead of indexing individual documents"}, "afterCommit": {"oid": "f6e6dde2ebcfa2325d7818a4737ff02ac523dca7", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6e6dde2ebcfa2325d7818a4737ff02ac523dca7", "committedDate": "2020-05-28T13:56:36Z", "message": "Make AnnotationPersister use bulk requests instead of indexing individual documents"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNzc0NTU4", "url": "https://github.com/elastic/elasticsearch/pull/57278#pullrequestreview-420774558", "createdAt": "2020-05-29T08:59:36Z", "commit": {"oid": "f6e6dde2ebcfa2325d7818a4737ff02ac523dca7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODo1OTozNlrOGcUmOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwODo1OTozNlrOGcUmOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MDc3OA==", "bodyText": "nit: make bulkRequest.numberOfActions() a Supplier so it is only called if trace logging is enabled.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.trace(\"[{}] ES API CALL: bulk request with {} actions\", jobId, bulkRequest.numberOfActions());\n          \n          \n            \n                        logger.trace(\"[{}] ES API CALL: bulk request with {} actions\",  () -> jobId, () -> bulkRequest.numberOfActions());", "url": "https://github.com/elastic/elasticsearch/pull/57278#discussion_r432350778", "createdAt": "2020-05-29T08:59:36Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/annotations/AnnotationPersister.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.ml.annotations;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.xcontent.ToXContent;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.elasticsearch.xpack.core.common.notifications.AbstractAuditor;\n+import org.elasticsearch.xpack.core.ml.annotations.Annotation;\n+import org.elasticsearch.xpack.core.ml.annotations.AnnotationIndex;\n+import org.elasticsearch.xpack.ml.utils.persistence.ResultsPersisterService;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+import java.util.function.Supplier;\n+\n+/**\n+ * Persists annotations to Elasticsearch index.\n+ */\n+public class AnnotationPersister {\n+\n+    private static final Logger logger = LogManager.getLogger(AnnotationPersister.class);\n+\n+    private static final int DEFAULT_BULK_LIMIT = 10_000;\n+\n+    private final ResultsPersisterService resultsPersisterService;\n+    private final AbstractAuditor<?> auditor;\n+    /**\n+     * Execute bulk requests when they reach this size\n+     */\n+    private final int bulkLimit;\n+\n+    public AnnotationPersister(ResultsPersisterService resultsPersisterService, AbstractAuditor<?> auditor) {\n+        this(resultsPersisterService, auditor, DEFAULT_BULK_LIMIT);\n+    }\n+\n+    // For testing\n+    AnnotationPersister(ResultsPersisterService resultsPersisterService, AbstractAuditor<?> auditor, int bulkLimit) {\n+        this.resultsPersisterService = Objects.requireNonNull(resultsPersisterService);\n+        this.auditor = Objects.requireNonNull(auditor);\n+        this.bulkLimit = bulkLimit;\n+    }\n+\n+    /**\n+     * Persists the given annotation to annotations index.\n+     *\n+     * @param annotationId existing annotation id. If {@code null}, a new annotation will be created and id will be assigned automatically\n+     * @param annotation annotation to be persisted\n+     * @return tuple of the form (annotation id, annotation object)\n+     */\n+    public Tuple<String, Annotation> persistAnnotation(@Nullable String annotationId, Annotation annotation) {\n+        Objects.requireNonNull(annotation);\n+        String jobId = annotation.getJobId();\n+        BulkResponse bulkResponse = bulkPersisterBuilder(jobId).persistAnnotation(annotationId, annotation).executeRequest();\n+        assert bulkResponse.getItems().length == 1;\n+        return Tuple.tuple(bulkResponse.getItems()[0].getId(), annotation);\n+    }\n+\n+    public Builder bulkPersisterBuilder(String jobId) {\n+        return new Builder(jobId);\n+    }\n+\n+    public class Builder {\n+\n+        private final String jobId;\n+        private BulkRequest bulkRequest = new BulkRequest(AnnotationIndex.WRITE_ALIAS_NAME);\n+        private Supplier<Boolean> shouldRetry = () -> true;\n+\n+        private Builder(String jobId) {\n+            this.jobId = Objects.requireNonNull(jobId);\n+        }\n+\n+        public Builder shouldRetry(Supplier<Boolean> shouldRetry) {\n+            this.shouldRetry = Objects.requireNonNull(shouldRetry);\n+            return this;\n+        }\n+\n+        public Builder persistAnnotation(Annotation annotation) {\n+            return persistAnnotation(null, annotation);\n+        }\n+\n+        public Builder persistAnnotation(@Nullable String annotationId, Annotation annotation) {\n+            Objects.requireNonNull(annotation);\n+            try (XContentBuilder xContentBuilder = annotation.toXContent(XContentFactory.jsonBuilder(), ToXContent.EMPTY_PARAMS)) {\n+                bulkRequest.add(new IndexRequest().id(annotationId).source(xContentBuilder));\n+            } catch (IOException e) {\n+                logger.error(new ParameterizedMessage(\"[{}] Error serialising annotation\", jobId), e);\n+            }\n+\n+            if (bulkRequest.numberOfActions() >= bulkLimit) {\n+                executeRequest();\n+            }\n+            return this;\n+        }\n+\n+        /**\n+         * Execute the bulk action\n+         */\n+        public BulkResponse executeRequest() {\n+            if (bulkRequest.numberOfActions() == 0) {\n+                return null;\n+            }\n+            logger.trace(\"[{}] ES API CALL: bulk request with {} actions\", jobId, bulkRequest.numberOfActions());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6e6dde2ebcfa2325d7818a4737ff02ac523dca7"}, "originalPosition": 114}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6e6dde2ebcfa2325d7818a4737ff02ac523dca7", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6e6dde2ebcfa2325d7818a4737ff02ac523dca7", "committedDate": "2020-05-28T13:56:36Z", "message": "Make AnnotationPersister use bulk requests instead of indexing individual documents"}, "afterCommit": {"oid": "8862f8472ce47cb98221d8828a358fbef6f6cfd1", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/8862f8472ce47cb98221d8828a358fbef6f6cfd1", "committedDate": "2020-05-29T10:52:24Z", "message": "Give JobResultsPersister.Builder.shouldRetry default value."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a97ec60839508812c219ea2a1b27ed49147d2aeb", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a97ec60839508812c219ea2a1b27ed49147d2aeb", "committedDate": "2020-05-29T11:15:53Z", "message": "Make AnnotationPersister use bulk requests instead of indexing individual documents"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddaa7429805c4b566cb54de0b80405965ba3b6b9", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ddaa7429805c4b566cb54de0b80405965ba3b6b9", "committedDate": "2020-05-29T11:15:53Z", "message": "Apply review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dff6e6ddb4022515cab6f689ea7d64987e89ff80", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/dff6e6ddb4022515cab6f689ea7d64987e89ff80", "committedDate": "2020-05-29T11:15:53Z", "message": "Give JobResultsPersister.Builder.shouldRetry default value."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8862f8472ce47cb98221d8828a358fbef6f6cfd1", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/8862f8472ce47cb98221d8828a358fbef6f6cfd1", "committedDate": "2020-05-29T10:52:24Z", "message": "Give JobResultsPersister.Builder.shouldRetry default value."}, "afterCommit": {"oid": "dff6e6ddb4022515cab6f689ea7d64987e89ff80", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/dff6e6ddb4022515cab6f689ea7d64987e89ff80", "committedDate": "2020-05-29T11:15:53Z", "message": "Give JobResultsPersister.Builder.shouldRetry default value."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4113, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}