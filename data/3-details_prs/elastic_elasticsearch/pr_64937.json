{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MjcxMTEx", "number": 64937, "title": "[ML] fix custom feature processor extraction bugs around boolean fields and custom one_hot feature output order", "bodyText": "This commit fixes two problems:\n\nWhen extracting a doc value, we allow boolean scalars to be used as input\nThe output order of processed feature names is deterministic. Previous custom one hot fields used to be non-deterministic and thus could cause weird bugs.", "createdAt": "2020-11-11T15:25:52Z", "url": "https://github.com/elastic/elasticsearch/pull/64937", "merged": true, "mergeCommit": {"oid": "7cb8de4f1813aea5d942b5b310600d451ef6bd56"}, "closed": true, "closedAt": "2020-11-12T15:33:14Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbfm5aAH2gAyNTE5MjcxMTExOmZhYjk3ZWViNjZhMGVhNjkxMTkyMzM5NTliYjhlNmU5MDM3NGU3YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbzdPKgFqTUyOTE0MTM4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fab97eeb66a0ea69119233959bb8e6e90374e7a5", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/fab97eeb66a0ea69119233959bb8e6e90374e7a5", "committedDate": "2020-11-11T15:22:44Z", "message": "[ML] fix custom featur processor extraction bugs around boolean fields and field order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb6f94fb4cca99734a9e9aab670348838bbda761", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb6f94fb4cca99734a9e9aab670348838bbda761", "committedDate": "2020-11-11T15:42:06Z", "message": "Merge branch 'master' into bugfix/ml-analytics-processed-field-boolean-handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/d830809c7b658eaada3550f18a8b75cf3e3b366b", "committedDate": "2020-11-11T21:26:03Z", "message": "Merge remote-tracking branch 'upstream/master' into bugfix/ml-analytics-processed-field-boolean-handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4ODg4MzYz", "url": "https://github.com/elastic/elasticsearch/pull/64937#pullrequestreview-528888363", "createdAt": "2020-11-12T09:16:37Z", "commit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOToxNjozN1rOHxxdIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOToyMDowN1rOHxxlrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1MjU0Nw==", "bodyText": "Ditto", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r521952547", "createdAt": "2020-11-12T09:16:37Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -24,20 +27,21 @@ public ProcessedField(PreProcessor processor) {\n     }\n \n     public List<String> getInputFieldNames() {\n-        return preProcessor.inputFields();\n+        return preProcessor.inputFields().stream().sorted().collect(Collectors.toList());\n     }\n \n     public List<String> getOutputFieldNames() {\n-        return preProcessor.outputFields();\n+        return preProcessor.outputFields().stream().sorted().collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1Mjk0MA==", "bodyText": "This is called for every document we load into the process. I suggest we sort once when we store them in the PreProcessor.", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r521952940", "createdAt": "2020-11-12T09:17:11Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -24,20 +27,21 @@ public ProcessedField(PreProcessor processor) {\n     }\n \n     public List<String> getInputFieldNames() {\n-        return preProcessor.inputFields();\n+        return preProcessor.inputFields().stream().sorted().collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1NDczMg==", "bodyText": "If the preprocessor already returns the output fields sorted, we shouldn't need to sort here.\nNow unfortunately there is not sorted list interface. But as we're dealing with fields, if we want to enforce this to the PreProcessor interface we should switch to SortedSet.", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r521954732", "createdAt": "2020-11-12T09:20:07Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -47,12 +51,12 @@ public ProcessedField(PreProcessor processor) {\n                 continue;\n             }\n             final Object value = values[0];\n-            if (values.length == 1 && (value instanceof String || value instanceof Number)) {\n+            if (values.length == 1 && (isValidValue(value))) {\n                 inputs.put(field, value);\n             }\n         }\n         preProcessor.process(inputs);\n-        return preProcessor.outputFields().stream().map(inputs::get).toArray();\n+        return preProcessor.outputFields().stream().sorted().map(inputs::get).toArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f9846a6fd9680d9d03215ff321447d9b96586e2", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f9846a6fd9680d9d03215ff321447d9b96586e2", "committedDate": "2020-11-12T12:33:12Z", "message": "making and testing preprocessor outputs to be consistent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c87a95ebd6d1664cba33ddfa2299e4ed3889034c", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/c87a95ebd6d1664cba33ddfa2299e4ed3889034c", "committedDate": "2020-11-12T13:24:45Z", "message": "validating and fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e22e13baa50849565ec152e3362fce3252f63628", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/e22e13baa50849565ec152e3362fce3252f63628", "committedDate": "2020-11-12T13:25:11Z", "message": "Merge remote-tracking branch 'upstream/master' into bugfix/ml-analytics-processed-field-boolean-handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTQxMzg1", "url": "https://github.com/elastic/elasticsearch/pull/64937#pullrequestreview-529141385", "createdAt": "2020-11-12T14:30:17Z", "commit": {"oid": "e22e13baa50849565ec152e3362fce3252f63628"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1201, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}