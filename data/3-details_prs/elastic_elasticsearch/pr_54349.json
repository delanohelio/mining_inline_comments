{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0ODE2Mzc2", "number": 54349, "title": "Preserve final response headers in asynchronous search", "bodyText": "This change adds the response headers of the original search request\nin the stored response in order to be able to restore them when retrieving a result\nfrom the async-search index. It also ensures that response headers are preserved for\nusers that retrieve a final response on a running search task.\nPartial response can eventually return response headers too but this change only ensures\nthat they are present when the response if final.\nRelates #33936", "createdAt": "2020-03-27T15:22:23Z", "url": "https://github.com/elastic/elasticsearch/pull/54349", "merged": true, "mergeCommit": {"oid": "f3f1b6993c48576adf68589865c879994e70e430"}, "closed": true, "closedAt": "2020-04-07T06:29:22Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRyUINAH2gAyMzk0ODE2Mzc2OmU5ZjcwMGMyZDEwNTQzMTM4ZWU3ZGYyMDk5MTU4ZmNiMGViN2Y2YWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcU-7wUgH2gAyMzk0ODE2Mzc2OjljYzZhZDE3MmQ3Mzc3NDk1OTZhYTQyMTQ0MjUyZjI5YjNmZmM2N2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e9f700c2d10543138ee7df2099158fcb0eb7f6ad", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/e9f700c2d10543138ee7df2099158fcb0eb7f6ad", "committedDate": "2020-03-27T15:20:02Z", "message": "Preserve final response headers in asynchronous search\n\nThis change adds the response headers of the original search request\nin the stored response in order to be able to restore them when retrieving a result\nfrom the async-search index. It also ensures that response headers are preserved for\nusers that retrieve a final response on a running search task.\nPartial response can eventually return response headers too but this change only ensures\nthat they are present when the response if final.\n\nRelates #33936"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f83e972696bd2b288adaead47eae65abf9bd10a5", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f83e972696bd2b288adaead47eae65abf9bd10a5", "committedDate": "2020-03-27T15:45:13Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd538b5faf722c706f306756c29eb930e4a8d331", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/dd538b5faf722c706f306756c29eb930e4a8d331", "committedDate": "2020-03-27T16:37:37Z", "message": "fix rest api include"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MDM5Njcy", "url": "https://github.com/elastic/elasticsearch/pull/54349#pullrequestreview-387039672", "createdAt": "2020-04-03T08:03:26Z", "commit": {"oid": "dd538b5faf722c706f306756c29eb930e4a8d331"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODowMzoyNlrOGAJe9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwODoxMTo0M1rOGAJ7Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgwODU2Nw==", "bodyText": "nit: is it necessary to have both these two submit? if so maybe they should be part of a different test section (one only for submit, the other one to test get and delete)", "url": "https://github.com/elastic/elasticsearch/pull/54349#discussion_r402808567", "createdAt": "2020-04-03T08:03:26Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/qa/rest/src/test/resources/rest-api-spec/test/async-search/10_deprecation.yml", "diffHunk": "@@ -0,0 +1,99 @@\n+---\n+\"Async search\":\n+  - skip:\n+      features: \"warnings\"\n+\n+  - do:\n+      indices.create:\n+        index: test-1\n+        body:\n+          settings:\n+            number_of_shards: \"2\"\n+\n+  - do:\n+      indices.create:\n+        index: test-2\n+        body:\n+          settings:\n+            number_of_shards: \"1\"\n+\n+  - do:\n+      indices.create:\n+        index: test-3\n+        body:\n+          settings:\n+            number_of_shards: \"3\"\n+\n+  - do:\n+      index:\n+        index:  test-2\n+        body:   { max: 2 }\n+\n+  - do:\n+      index:\n+        index:  test-1\n+        body:   { max: 1 }\n+\n+  - do:\n+      index:\n+        index:  test-3\n+        body:   { max: 3 }\n+\n+  - do:\n+      indices.refresh: {}\n+\n+  - do:\n+      warnings:\n+        - '[deprecated] query'\n+      async_search.submit:\n+        index: test-*\n+        wait_for_completion_timeout: 10s\n+        body:\n+          query:\n+            deprecated: {}\n+\n+  - is_false: id\n+  - match:  { is_partial:                   false }\n+  - length: { response.hits.hits:               3 }\n+\n+  - do:\n+      warnings:\n+        - '[deprecated] query'\n+      async_search.submit:\n+        index: test-*\n+        wait_for_completion_timeout: 10s\n+        keep_on_completion: true\n+        body:\n+          query:\n+            deprecated: {}\n+\n+  - set:    { id:                              id }\n+  - match:  { is_partial:                   false }\n+  - length: { response.hits.hits:               3 }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd538b5faf722c706f306756c29eb930e4a8d331"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNDYyMQ==", "bodyText": "instead of having these two atomic references, would it make sense to have the headers become part of MutableSearchResponse? I always worry about the complexity added by two independent multi-threaded data structures.", "url": "https://github.com/elastic/elasticsearch/pull/54349#discussion_r402814621", "createdAt": "2020-04-03T08:10:19Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -61,7 +63,8 @@\n     private volatile long expirationTimeMillis;\n     private final AtomicBoolean isCancelling = new AtomicBoolean(false);\n \n-    private AtomicReference<MutableSearchResponse> searchResponse;\n+    private final AtomicReference<MutableSearchResponse> searchResponse = new AtomicReference<>();\n+    private final AtomicReference<Map<String, List<String>>> responseHeaders = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd538b5faf722c706f306756c29eb930e4a8d331"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgxNTgwNg==", "bodyText": "I am not a fan of boolean flags, this method looks simple enough that we could split in two: getResponse and getResponseWithHeaders or something along those lines?", "url": "https://github.com/elastic/elasticsearch/pull/54349#discussion_r402815806", "createdAt": "2020-04-03T08:11:43Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -284,15 +286,24 @@ private void executeCompletionListeners() {\n             }\n             hasCompleted = true;\n         }\n-        AsyncSearchResponse finalResponse = getResponse();\n+        // we don't need to restore the response headers, they should be included in the current\n+        // context since we are called by the search action listener.\n+        AsyncSearchResponse finalResponse = getResponse(false);\n         for (Consumer<AsyncSearchResponse> listener : completionListeners.values()) {\n             listener.accept(finalResponse);\n         }\n         completionListeners.clear();\n     }\n \n-    private AsyncSearchResponse getResponse() {\n+    /**\n+     * Returns the current {@link AsyncSearchResponse} and restores the response headers\n+     * in the local thread context depending on the value of <code>restoreResponseHeaders</code>.\n+     */\n+    private AsyncSearchResponse getResponse(boolean restoreResponseHeaders) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd538b5faf722c706f306756c29eb930e4a8d331"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60649c21be4bec1b25a8335cc42d03afbde8b4ce", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/60649c21be4bec1b25a8335cc42d03afbde8b4ce", "committedDate": "2020-04-06T11:18:30Z", "message": "Merge branch 'master' into async_response_headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6e8ab01a0564e371793d79a7d3dd145732783d0", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6e8ab01a0564e371793d79a7d3dd145732783d0", "committedDate": "2020-04-06T11:45:18Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58b3edd0b86a24b60d6e3141b6880d49048e3e67", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/58b3edd0b86a24b60d6e3141b6880d49048e3e67", "committedDate": "2020-04-06T11:46:52Z", "message": "add missing comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cc6ad172d737749596aa42144252f29b3ffc67b", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/9cc6ad172d737749596aa42144252f29b3ffc67b", "committedDate": "2020-04-06T13:43:57Z", "message": "split new rest test in 2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1442, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}