{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwODc1MTI5", "number": 57792, "title": "Use clean thread context for transport and applier service", "bodyText": "Adds assertions to Netty to make sure that its threads are not polluted by thread contexts (and also that thread contexts are not leaked). Moves the ClusterApplierService to use the system context (same as we do for MasterService), which allows to remove a hack from TemplateUgradeService  and makes it clearer that applying CS updates is fully executing under system context.", "createdAt": "2020-06-08T07:43:12Z", "url": "https://github.com/elastic/elasticsearch/pull/57792", "merged": true, "mergeCommit": {"oid": "5221970b2abd13ed684697c430f7091e28dbe350"}, "closed": true, "closedAt": "2020-06-09T10:23:46Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpLgq2gH2gAyNDMwODc1MTI5OjYzMDg3NzI5YTQxYjA5Mzc0ODA0MzBmNmM1NTdkODAzMzYwNzYzZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpR7WDgFqTQyNjM0MDU3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "63087729a41b0937480430f6c557d803360763f6", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/63087729a41b0937480430f6c557d803360763f6", "committedDate": "2020-06-08T07:41:37Z", "message": "Use clean thread context for transport and applier service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4cb9c13ce631fead51da029a9049151f9d17b80", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4cb9c13ce631fead51da029a9049151f9d17b80", "committedDate": "2020-06-08T09:15:42Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb869d1ec411b7d987dbdedd83cf3f779583991e", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/cb869d1ec411b7d987dbdedd83cf3f779583991e", "committedDate": "2020-06-08T09:15:57Z", "message": "Merge remote-tracking branch 'elastic/master' into clean-thread-context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ae9ad57ac28bfbd3b7357d4d01c92118ff15ca3", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ae9ad57ac28bfbd3b7357d4d01c92118ff15ca3", "committedDate": "2020-06-08T09:52:24Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2Mjc0NjY2", "url": "https://github.com/elastic/elasticsearch/pull/57792#pullrequestreview-426274666", "createdAt": "2020-06-08T14:02:53Z", "commit": {"oid": "9ae9ad57ac28bfbd3b7357d4d01c92118ff15ca3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNDowMjo1M1rOGgf-Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNDowMjo1M1rOGgf-Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjczMTQwMg==", "bodyText": "Do we even need to do this? Now that we fixed NetworkMessage I think there are only two possible scenarios here:\n\nWe are running this on the IO thread for the channel we send to. In that case, the context was polluted elsewhere already and this isn't really safe in the first place (because under load the actions in Netty's flush might run after this block executed and restored the unclean context for example)?\nWe are running this off of the network thread of the channel, in which case switching the context here is just irrelevant?", "url": "https://github.com/elastic/elasticsearch/pull/57792#discussion_r436731402", "createdAt": "2020-06-08T14:02:53Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/transport/OutboundHandler.java", "diffHunk": "@@ -116,7 +117,8 @@ private void sendMessage(TcpChannel channel, OutboundMessage networkMessage, Act\n \n     private void internalSend(TcpChannel channel, SendContext sendContext) {\n         channel.getChannelStats().markAccessed(threadPool.relativeTimeInMillis());\n-        try {\n+        // stash thread context so that channel event loop is not polluted by thread context\n+        try (ThreadContext.StoredContext existing = threadPool.getThreadContext().stashContext()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ae9ad57ac28bfbd3b7357d4d01c92118ff15ca3"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MzQwNTc1", "url": "https://github.com/elastic/elasticsearch/pull/57792#pullrequestreview-426340575", "createdAt": "2020-06-08T15:10:11Z", "commit": {"oid": "9ae9ad57ac28bfbd3b7357d4d01c92118ff15ca3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3812, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}