{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1NzAwNTQ5", "number": 59196, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MDoyMlrOEMbkIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MjoyN1rOEMbm0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDY5OTg1OnYy", "diffSide": "RIGHT", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/eql/EqlSearchRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MDoyMlrOGuiMWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MDoyMlrOGuiMWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ0Nzg5Ng==", "bodyText": "@matriv Included your feedback from the previous PR.", "url": "https://github.com/elastic/elasticsearch/pull/59196#discussion_r451447896", "createdAt": "2020-07-08T10:40:22Z", "author": {"login": "costin"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/eql/EqlSearchRequest.java", "diffHunk": "@@ -191,8 +191,8 @@ public int fetchSize() {\n         return this.fetchSize;\n     }\n \n-    public EqlSearchRequest fetchSize(int size) {\n-        this.fetchSize = size;\n+    public EqlSearchRequest fetchSize(int fetchSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8142fc383c7145250b765c15912ad1370d800bd5"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDcwMTgwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/eql/qa/common/src/main/java/org/elasticsearch/test/eql/CommonEqlActionTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MTowMFrOGuiNiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MTowMFrOGuiNiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ0ODIwMA==", "bodyText": "@matriv see this one as well. It unraveled a bug - when the fetchSize was 5, the results were different due to us skipping a window.", "url": "https://github.com/elastic/elasticsearch/pull/59196#discussion_r451448200", "createdAt": "2020-07-08T10:41:00Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/qa/common/src/main/java/org/elasticsearch/test/eql/CommonEqlActionTestCase.java", "diffHunk": "@@ -146,7 +146,7 @@ protected EqlSearchResponse runQuery(String index, String query, boolean isCaseS\n         request.tiebreakerField(\"event.sequence\");\n         // some queries return more than 10 results\n         request.size(50);\n-        request.fetchSize(2);\n+        request.fetchSize(randomIntBetween(2, 50));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8142fc383c7145250b765c15912ad1370d800bd5"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDcwNDA4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/SequenceStateMachine.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MTo0MFrOGuiO8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MTo0MFrOGuiO8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ0ODU2MQ==", "bodyText": "Made maxspan to be inclusive.", "url": "https://github.com/elastic/elasticsearch/pull/59196#discussion_r451448561", "createdAt": "2020-07-08T10:41:40Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/SequenceStateMachine.java", "diffHunk": "@@ -82,19 +83,19 @@ public void match(int stage, SequenceKey key, Ordinal ordinal, SearchHit hit) {\n         Sequence sequence = before.v1();\n         // eliminate the match and all previous values from the frame\n         group.trim(before.v2() + 1);\n+\n+        // remove the frame and keys early (as the key space is large)\n+        if (group.isEmpty()) {\n+            stageToKeys.keys(previousStage).remove(key);\n+        }\n         \n         // check maxspan before continuing the sequence\n-        if (maxSpanInMillis > 0 && (ordinal.timestamp() - sequence.startTimestamp() >= maxSpanInMillis)) {\n+        if (maxSpanInMillis > 0 && (ordinal.timestamp() - sequence.startTimestamp() > maxSpanInMillis)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8142fc383c7145250b765c15912ad1370d800bd5"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDcwNjc0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/SequenceStateMachine.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MjoyN1rOGuiQhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0MjoyN1rOGuiQhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ0ODk2NA==", "bodyText": "This turned out to be causing data skipping by ignoring potential matches for following stages.", "url": "https://github.com/elastic/elasticsearch/pull/59196#discussion_r451448964", "createdAt": "2020-07-08T10:42:27Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/SequenceStateMachine.java", "diffHunk": "@@ -117,7 +118,27 @@ public boolean reachedLimit() {\n         return limitReached;\n     }\n \n+    /**\n+     * Checks whether the rest of the stages have in-flight data.\n+     * This method is called when a query returns no data meaning\n+     * sequences on previous stages cannot match this window (since there's no new data).\n+     * However sequences on higher stages can, hence this check to know whether\n+     * it's possible to advance the window early.\n+     */\n     public boolean hasCandidates(int stage) {\n-        return stage < completionStage && stageToKeys.keys(stage).isEmpty() == false;\n+        for (int i = stage; i < completionStage; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8142fc383c7145250b765c15912ad1370d800bd5"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1996, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}