{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NjIyMTU4", "number": 55342, "title": "Add explicit generation member to data streams", "bodyText": "Adds an explicit generation attribute to data streams. The current write index is derived from the generation and the data stream validates that it contains a backing index corresponding to its generation.\nAlso DRYs up the logic for naming backing indices for data streams.\nRelated to #53100", "createdAt": "2020-04-16T19:04:46Z", "url": "https://github.com/elastic/elasticsearch/pull/55342", "merged": true, "mergeCommit": {"oid": "e1730452e37c04864e17b21f83a5558d8662a032"}, "closed": true, "closedAt": "2020-04-17T14:02:10Z", "author": {"login": "danhermann"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYRc3ngH2gAyNDA0NjIyMTU4OjA2YTU4YmE3MDlkYWY2MzRkYjg0YjFiNTUxNWUwODc5ODk2NDhhYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYgwVKgH2gAyNDA0NjIyMTU4OmEzZmQ5NTc2Y2IxODZiYjE0MWY4YWZlODRjOTczOTc5OTg0NTNiNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "06a58ba709daf634db84b1b5515e087989648ab2", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/06a58ba709daf634db84b1b5515e087989648ab2", "committedDate": "2020-04-16T19:00:11Z", "message": "add generation member, derive current write index from generation, DRY backing index naming logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTI3OTIw", "url": "https://github.com/elastic/elasticsearch/pull/55342#pullrequestreview-394927920", "createdAt": "2020-04-16T19:16:23Z", "commit": {"oid": "06a58ba709daf634db84b1b5515e087989648ab2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOToxNjoyM1rOGGzpLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOToxNjoyM1rOGGzpLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MDc2Nw==", "bodyText": "maybe statically import getBackingIndexName(...) for readability?", "url": "https://github.com/elastic/elasticsearch/pull/55342#discussion_r409790767", "createdAt": "2020-04-16T19:16:23Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexAbstraction.java", "diffHunk": "@@ -264,12 +264,15 @@ private boolean isNonEmpty(List<IndexMetadata> idxMetas) {\n         private final List<IndexMetadata> dataStreamIndices;\n         private final IndexMetadata writeIndex;\n \n-        public DataStream(org.elasticsearch.cluster.metadata.DataStream dataStream,\n-                          List<IndexMetadata> dataStreamIndices, IndexMetadata writeIndex) {\n+        public DataStream(org.elasticsearch.cluster.metadata.DataStream dataStream, List<IndexMetadata> dataStreamIndices) {\n             this.dataStream = dataStream;\n             this.dataStreamIndices = List.copyOf(dataStreamIndices);\n-            this.writeIndex = writeIndex;\n-            assert dataStreamIndices.contains(writeIndex);\n+            this.writeIndex =  dataStreamIndices.stream()\n+                .filter(index -> index.getIndex().getName().equals(\n+                    org.elasticsearch.cluster.metadata.DataStream.getBackingIndexName(dataStream.getName(), dataStream.getGeneration())))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06a58ba709daf634db84b1b5515e087989648ab2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e8958a48e2b89ec4b0d0c7a18ecd0f108e9fe6d", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/4e8958a48e2b89ec4b0d0c7a18ecd0f108e9fe6d", "committedDate": "2020-04-16T19:24:15Z", "message": "static import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTc0OTc0", "url": "https://github.com/elastic/elasticsearch/pull/55342#pullrequestreview-395174974", "createdAt": "2020-04-17T05:44:45Z", "commit": {"oid": "4e8958a48e2b89ec4b0d0c7a18ecd0f108e9fe6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNTo0NDo0NVrOGHAqDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNTo0NDo0NVrOGHAqDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAwMzk4MA==", "bodyText": "I wonder if we should simply keep this (and the IndexAbstraction.DataStream constructor) as it was, except to add an assertion that the generation we have should match the name of the last index in the list. I think we want that to hold true anyway?", "url": "https://github.com/elastic/elasticsearch/pull/55342#discussion_r410003980", "createdAt": "2020-04-17T05:44:45Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -1384,7 +1384,7 @@ public Metadata build() {\n \n                     IndexMetadata writeIndex = backingIndices.get(backingIndices.size() - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e8958a48e2b89ec4b0d0c7a18ecd0f108e9fe6d"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6590f7c2dc58f9c68228266fac67ddb010638f64", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/6590f7c2dc58f9c68228266fac67ddb010638f64", "committedDate": "2020-04-17T11:43:28Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3fd9576cb186bb141f8afe84c97397998453b46", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/a3fd9576cb186bb141f8afe84c97397998453b46", "committedDate": "2020-04-17T12:50:01Z", "message": "fix tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3248, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}