{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMDQwNDE2", "number": 50903, "title": "[Transform] correctly retrieve checkpoints from remote indices", "bodyText": "uses remote client(s) to correctly retrieve index checkpoints from remote clusters", "createdAt": "2020-01-13T10:28:02Z", "url": "https://github.com/elastic/elasticsearch/pull/50903", "merged": true, "mergeCommit": {"oid": "360f954816e89920c4db782c04b119cfe299ca1d"}, "closed": true, "closedAt": "2020-01-14T12:21:53Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6BdA8AFqTM0MjA3NDI5Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6OkUwgBqjI5NDY1MzkwMjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMDc0Mjkz", "url": "https://github.com/elastic/elasticsearch/pull/50903#pullrequestreview-342074293", "createdAt": "2020-01-13T19:13:31Z", "commit": {"oid": "85140ab5c0162e697b910e9b76fa3c3ba525edbf"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxOToxMzozMVrOFdBiWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxOToyMTo0N1rOFdBx-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk3ODIwMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public int size() {\n          \n          \n            \n                    public int numClusters() {\n          \n      \n    \n    \n  \n\nOr something. I thought size() was meant to be the number of total resolved indices, but instead it is used to help allocate the grouped listener.", "url": "https://github.com/elastic/elasticsearch/pull/50903#discussion_r365978201", "createdAt": "2020-01-13T19:13:31Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/checkpoint/RemoteClusterResolver.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.transform.checkpoint;\n+\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.transport.RemoteClusterAware;\n+import org.elasticsearch.transport.RemoteConnectionStrategy;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CopyOnWriteArraySet;\n+\n+/**\n+ * Maintain a list of remote clusters (aliases) and provide the ability to resolve.\n+ */\n+class RemoteClusterResolver extends RemoteClusterAware {\n+\n+    private final CopyOnWriteArraySet<String> clusters;\n+\n+    class ResolvedIndices {\n+        private final Map<String, List<String>> remoteIndicesPerClusterAlias;\n+        private final List<String> localIndices;\n+\n+        ResolvedIndices(Map<String, List<String>> remoteIndicesPerClusterAlias, List<String> localIndices) {\n+            this.localIndices = localIndices;\n+            this.remoteIndicesPerClusterAlias = remoteIndicesPerClusterAlias;\n+        }\n+\n+        public Map<String, List<String>> getRemoteIndicesPerClusterAlias() {\n+            return remoteIndicesPerClusterAlias;\n+        }\n+\n+        public List<String> getLocalIndices() {\n+            return localIndices;\n+        }\n+\n+        public int size() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85140ab5c0162e697b910e9b76fa3c3ba525edbf"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk4MjIwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"\",\n          \n          \n            \n                                LOCAL_CLUSTER_GROUP_KEY,", "url": "https://github.com/elastic/elasticsearch/pull/50903#discussion_r365982203", "createdAt": "2020-01-13T19:21:47Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/checkpoint/DefaultCheckpointProvider.java", "diffHunk": "@@ -84,13 +93,61 @@ public void createNextCheckpoint(final TransformCheckpoint lastCheckpoint, final\n     }\n \n     protected void getIndexCheckpoints(ActionListener<Map<String, long[]>> listener) {\n+        try {\n+            ResolvedIndices resolvedIndexes = remoteClusterResolver.resolve(transformConfig.getSource().getIndex());\n+            ActionListener<Map<String, long[]>> groupedListener = listener;\n+\n+            if (resolvedIndexes.size() > 1) {\n+                ActionListener<Collection<Map<String, long[]>>> mergeMapsListener = ActionListener.wrap(indexCheckpoints -> {\n+                    listener.onResponse(\n+                        indexCheckpoints.stream()\n+                            .flatMap(m -> m.entrySet().stream())\n+                            .collect(Collectors.toMap(entry -> entry.getKey(), entry -> entry.getValue()))\n+                    );\n+                }, listener::onFailure);\n+\n+                groupedListener = new GroupedActionListener<>(mergeMapsListener, resolvedIndexes.size());\n+            }\n+\n+            if (resolvedIndexes.getLocalIndices().isEmpty() == false) {\n+                getCheckpointsFromOneCluster(\n+                    client,\n+                    transformConfig.getHeaders(),\n+                    resolvedIndexes.getLocalIndices().toArray(new String[0]),\n+                    \"\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85140ab5c0162e697b910e9b76fa3c3ba525edbf"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "881e882d6f4c133ba05eb8153778c70f397bf850", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/881e882d6f4c133ba05eb8153778c70f397bf850", "committedDate": "2020-01-14T10:40:36Z", "message": "correctly retrieve checkpoints from remote indices"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "864d454923504fe0415b7c33c478a8725854a6ef", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/864d454923504fe0415b7c33c478a8725854a6ef", "committedDate": "2020-01-14T10:40:36Z", "message": "improve RemoteClusterResolver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fc72587eb7656fe0c82cf58a10420e29ef6a9b9", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/3fc72587eb7656fe0c82cf58a10420e29ef6a9b9", "committedDate": "2020-01-14T10:40:36Z", "message": "do not mock Settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "628fed16c1f049ce9cde1567a28cc32fda7940a3", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/628fed16c1f049ce9cde1567a28cc32fda7940a3", "committedDate": "2020-01-14T10:40:36Z", "message": "fix NPE when mocking cluster settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c4bf5c4c302d6ee186a033723b952bd17d015a0", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c4bf5c4c302d6ee186a033723b952bd17d015a0", "committedDate": "2020-01-14T10:40:36Z", "message": "remove debug leftover"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cf7691852923f8a5e116858e6bc1ca073edc78a", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/4cf7691852923f8a5e116858e6bc1ca073edc78a", "committedDate": "2020-01-14T10:40:36Z", "message": "apply review suggestions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c109593d3baaf02194b3fd64b47f18f9449898e0", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/c109593d3baaf02194b3fd64b47f18f9449898e0", "committedDate": "2020-01-14T08:49:13Z", "message": "apply review suggestions"}, "afterCommit": {"oid": "4cf7691852923f8a5e116858e6bc1ca073edc78a", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/4cf7691852923f8a5e116858e6bc1ca073edc78a", "committedDate": "2020-01-14T10:40:36Z", "message": "apply review suggestions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3159, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}