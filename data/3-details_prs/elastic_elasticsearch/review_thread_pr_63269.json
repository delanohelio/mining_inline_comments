{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3OTk5MTA4", "number": 63269, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODoyNzo0NlrOEqbtvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODozNDo1MFrOEqb2fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTI5NzI0OnYy", "diffSide": "RIGHT", "path": "plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODoyNzo0NlrOHcoyVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODoyNzo0NlrOHcoyVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MDQyMg==", "bodyText": "Could you move this below all the Parameter so I don't lose it?", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499790422", "createdAt": "2020-10-05T18:27:46Z", "author": {"login": "nik9000"}, "path": "plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java", "diffHunk": "@@ -72,92 +70,94 @@\n  * This code is largely a copy of TextFieldMapper which is less than ideal -\n  * my attempts to subclass TextFieldMapper failed but we can revisit this.\n  **/\n-public class AnnotatedTextFieldMapper extends FieldMapper {\n+public class AnnotatedTextFieldMapper extends ParametrizedFieldMapper {\n \n     public static final String CONTENT_TYPE = \"annotated_text\";\n     private static final int POSITION_INCREMENT_GAP_USE_ANALYZER = -1;\n \n-    public static class Builder extends TextFieldMapper.Builder {\n+    private static Builder builder(FieldMapper in) {\n+        return ((AnnotatedTextFieldMapper)in).builder;\n+    }\n \n-        private int positionIncrementGap = POSITION_INCREMENT_GAP_USE_ANALYZER;\n+    public static class Builder extends ParametrizedFieldMapper.Builder {\n \n-        public Builder(String name) {\n-            super(name);\n-            builder = this;\n-        }\n+        private final Parameter<Boolean> index = Parameter.indexParam(m -> builder(m).index.getValue(), true);\n+        private final Parameter<Boolean> store = Parameter.storeParam(m -> builder(m).store.getValue(), false);\n \n-        public Builder positionIncrementGap(int positionIncrementGap) {\n-            if (positionIncrementGap < 0) {\n-                throw new MapperParsingException(\"[positions_increment_gap] must be positive, got \" + positionIncrementGap);\n-            }\n-            this.positionIncrementGap = positionIncrementGap;\n-            return this;\n+        final TextParams.Analyzers analyzers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4b5adc1cd1ce53ffe532d67a664192439962dc"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTMwNzY4OnYy", "diffSide": "RIGHT", "path": "plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODozMDo1MVrOHco45g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODozMDo1MVrOHco45g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MjEwMg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499792102", "createdAt": "2020-10-05T18:30:51Z", "author": {"login": "nik9000"}, "path": "plugins/mapper-annotated-text/src/main/java/org/elasticsearch/index/mapper/annotatedtext/AnnotatedTextFieldMapper.java", "diffHunk": "@@ -191,22 +191,18 @@ public static AnnotatedText parse (String textPlusMarkup) {\n                 String value = null;\n                 for (String pair : pairs) {\n                     String[] kv = pair.split(\"=\");\n-                    try {\n-                        if(kv.length == 2){\n-                            throw new ElasticsearchParseException(\"key=value pairs are not supported in annotations\");\n-                        }\n-                        if(kv.length == 1) {\n-                            //Check \"=\" sign wasn't in the pair string\n-                            if(kv[0].length() == pair.length()) {\n-                                //untyped value\n-                                value = URLDecoder.decode(kv[0], \"UTF-8\");\n-                            }\n-                        }\n-                        if (value!=null && value.length() > 0) {\n-                            annotations.add(new AnnotationToken(startOffset, endOffset, value));\n+                    if(kv.length == 2){\n+                        throw new ElasticsearchParseException(\"key=value pairs are not supported in annotations\");\n+                    }\n+                    if(kv.length == 1) {\n+                        //Check \"=\" sign wasn't in the pair string\n+                        if(kv[0].length() == pair.length()) {\n+                            //untyped value\n+                            value = URLDecoder.decode(kv[0], StandardCharsets.UTF_8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4b5adc1cd1ce53ffe532d67a664192439962dc"}, "originalPosition": 228}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTMxMTU2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODozMjoxNFrOHco7gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMDozNDo0MFrOHdAGTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5Mjc2OA==", "bodyText": "I wonder if alwaysSerialize should a shortcut to this new thing - it is easier for me to read the intent of alwaysSerialize than this lambda.", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499792768", "createdAt": "2020-10-05T18:32:14Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java", "diffHunk": "@@ -142,7 +142,7 @@ private static CompletionFieldMapper toType(FieldMapper in) {\n             m -> toType(m).maxInputLength, Defaults.DEFAULT_MAX_INPUT_LENGTH)\n             .addDeprecatedName(\"max_input_len\")\n             .setValidator(Builder::validateInputLength)\n-            .alwaysSerialize();\n+            .setSerializerCheck((id, ic, v) -> true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4b5adc1cd1ce53ffe532d67a664192439962dc"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3MjM2NQ==", "bodyText": "I added alwaysSerialize and neverSerialize as shortcuts.", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r500172365", "createdAt": "2020-10-06T10:34:40Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java", "diffHunk": "@@ -142,7 +142,7 @@ private static CompletionFieldMapper toType(FieldMapper in) {\n             m -> toType(m).maxInputLength, Defaults.DEFAULT_MAX_INPUT_LENGTH)\n             .addDeprecatedName(\"max_input_len\")\n             .setValidator(Builder::validateInputLength)\n-            .alwaysSerialize();\n+            .setSerializerCheck((id, ic, v) -> true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5Mjc2OA=="}, "originalCommit": {"oid": "ad4b5adc1cd1ce53ffe532d67a664192439962dc"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTMxMzg2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/ParametrizedFieldMapper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODozMzowNFrOHco9CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNzo0Nzo1N1rOHc599A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MzE2MQ==", "bodyText": "Are you thinking of removing the old getValue in a follow up?", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499793161", "createdAt": "2020-10-05T18:33:04Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ParametrizedFieldMapper.java", "diffHunk": "@@ -178,6 +180,11 @@ public T getValue() {\n             return isSet ? value : defaultValue.get();\n         }\n \n+        @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4b5adc1cd1ce53ffe532d67a664192439962dc"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA3MTkyNA==", "bodyText": "That's the plan, yes", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r500071924", "createdAt": "2020-10-06T07:47:57Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ParametrizedFieldMapper.java", "diffHunk": "@@ -178,6 +180,11 @@ public T getValue() {\n             return isSet ? value : defaultValue.get();\n         }\n \n+        @Override", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5MzE2MQ=="}, "originalCommit": {"oid": "ad4b5adc1cd1ce53ffe532d67a664192439962dc"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTMxOTY0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODozNDo1MFrOHcpAnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxODozNDo1MFrOHcpAnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc5NDA3Ng==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/63269#discussion_r499794076", "createdAt": "2020-10-05T18:34:50Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java", "diffHunk": "@@ -121,101 +119,230 @@\n         public static final int POSITION_INCREMENT_GAP = 100;\n     }\n \n-    public static class Builder extends FieldMapper.Builder<Builder> {\n+    private static Builder builder(FieldMapper in) {\n+        return ((TextFieldMapper) in).builder;\n+    }\n \n-        private int positionIncrementGap = POSITION_INCREMENT_GAP_USE_ANALYZER;\n-        private int minPrefixChars = -1;\n-        private int maxPrefixChars = -1;\n-        private boolean fielddata = false;\n-        private boolean indexPhrases = false;\n-        private boolean eagerGlobalOrdinals = false;\n-        private double fielddataMinFreq = Defaults.FIELDDATA_MIN_FREQUENCY;\n-        private double fielddataMaxFreq = Defaults.FIELDDATA_MAX_FREQUENCY;\n-        private int fielddataMinSegSize = Defaults.FIELDDATA_MIN_SEGMENT_SIZE;\n-        protected SimilarityProvider similarity;\n+    private static final class PrefixConfig implements ToXContent {\n+        final int minChars;\n+        final int maxChars;\n \n-        public Builder(String name) {\n-            super(name, Defaults.FIELD_TYPE);\n-            builder = this;\n+        private PrefixConfig(int minChars, int maxChars) {\n+            this.minChars = minChars;\n+            this.maxChars = maxChars;\n+            if (minChars > maxChars) {\n+                throw new IllegalArgumentException(\"min_chars [\" + minChars + \"] must be less than max_chars [\" + maxChars + \"]\");\n+            }\n+            if (minChars < 1) {\n+                throw new IllegalArgumentException(\"min_chars [\" + minChars + \"] must be greater than zero\");\n+            }\n+            if (maxChars >= 20) {\n+                throw new IllegalArgumentException(\"max_chars [\" + maxChars + \"] must be less than 20\");\n+            }\n         }\n \n-        public Builder positionIncrementGap(int positionIncrementGap) {\n-            if (positionIncrementGap < 0) {\n-                throw new MapperParsingException(\"[positions_increment_gap] must be positive, got \" + positionIncrementGap);\n-            }\n-            this.positionIncrementGap = positionIncrementGap;\n-            return this;\n+        @Override\n+        public boolean equals(Object o) {\n+            if (this == o) return true;\n+            if (o == null || getClass() != o.getClass()) return false;\n+            PrefixConfig that = (PrefixConfig) o;\n+            return minChars == that.minChars &&\n+                maxChars == that.maxChars;\n         }\n \n-        public Builder fielddata(boolean fielddata) {\n-            this.fielddata = fielddata;\n-            return builder;\n+        @Override\n+        public int hashCode() {\n+            return Objects.hash(minChars, maxChars);\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return \"{ min_chars=\" + minChars + \", max_chars=\" + maxChars + \" }\";\n         }\n \n-        public Builder indexPhrases(boolean indexPhrases) {\n-            this.indexPhrases = indexPhrases;\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+            builder.startObject();\n+            builder.field(\"min_chars\", minChars);\n+            builder.field(\"max_chars\", maxChars);\n+            builder.endObject();\n             return builder;\n         }\n+    }\n \n-        public void similarity(SimilarityProvider similarity) {\n-            this.similarity = similarity;\n+    private static PrefixConfig parsePrefixConfig(String propName, ParserContext parserContext, Object propNode) {\n+        if (propNode == null) {\n+            return null;\n+        }\n+        Map<?, ?> indexPrefix = (Map<?, ?>) propNode;\n+        int minChars = XContentMapValues.nodeIntegerValue(indexPrefix.remove(\"min_chars\"),\n+            Defaults.INDEX_PREFIX_MIN_CHARS);\n+        int maxChars = XContentMapValues.nodeIntegerValue(indexPrefix.remove(\"max_chars\"),\n+            Defaults.INDEX_PREFIX_MAX_CHARS);\n+        DocumentMapperParser.checkNoRemainingFields(propName, indexPrefix, parserContext.indexVersionCreated());\n+        return new PrefixConfig(minChars, maxChars);\n+    }\n+\n+    private static final class FielddataFrequencyFilter implements ToXContent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad4b5adc1cd1ce53ffe532d67a664192439962dc"}, "originalPosition": 127}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3195, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}