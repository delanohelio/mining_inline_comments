{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2ODkzMDgy", "number": 63945, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwOTo1Nzo0OFrOEwK1Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMDowMzoxOVrOEwK9cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4OTQ0NTYzOnYy", "diffSide": "RIGHT", "path": "server/src/internalClusterTest/java/org/elasticsearch/search/aggregations/bucket/SignificantTermsSignificanceScoreIT.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwOTo1Nzo0OFrOHlj9zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMjo1NjoyM1rOHlqZ8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0ODYyMQ==", "bodyText": "don't we lose coverage with these changes?", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509148621", "createdAt": "2020-10-21T09:57:48Z", "author": {"login": "javanna"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/search/aggregations/bucket/SignificantTermsSignificanceScoreIT.java", "diffHunk": "@@ -590,11 +578,7 @@ public void testScriptCaching() throws Exception {\n                 .getMissCount(), equalTo(1L));\n \n         // Ensure that non-scripted requests are cached as normal\n-        if (useSigText) {\n-            r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantText(\"foo\", \"s\")).get();\n-        } else {\n-            r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantTerms(\"foo\").field(\"s\")).get();\n-        }\n+        r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantTerms(\"foo\").field(\"s\")).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE2MDcxMQ==", "bodyText": "Hm, you're right, I had thought this was just testing a useless agg but actually I should change it instead to also have some text and to run the sigText agg over the text field instead.", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509160711", "createdAt": "2020-10-21T10:17:32Z", "author": {"login": "romseygeek"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/search/aggregations/bucket/SignificantTermsSignificanceScoreIT.java", "diffHunk": "@@ -590,11 +578,7 @@ public void testScriptCaching() throws Exception {\n                 .getMissCount(), equalTo(1L));\n \n         // Ensure that non-scripted requests are cached as normal\n-        if (useSigText) {\n-            r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantText(\"foo\", \"s\")).get();\n-        } else {\n-            r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantTerms(\"foo\").field(\"s\")).get();\n-        }\n+        r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantTerms(\"foo\").field(\"s\")).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0ODYyMQ=="}, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1NDEzMA==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509254130", "createdAt": "2020-10-21T12:56:23Z", "author": {"login": "javanna"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/search/aggregations/bucket/SignificantTermsSignificanceScoreIT.java", "diffHunk": "@@ -590,11 +578,7 @@ public void testScriptCaching() throws Exception {\n                 .getMissCount(), equalTo(1L));\n \n         // Ensure that non-scripted requests are cached as normal\n-        if (useSigText) {\n-            r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantText(\"foo\", \"s\")).get();\n-        } else {\n-            r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantTerms(\"foo\").field(\"s\")).get();\n-        }\n+        r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantTerms(\"foo\").field(\"s\")).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0ODYyMQ=="}, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4OTQ1NTE1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/VersionFieldMapper.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMDowMDoxOVrOHlkDtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMjo1NjowOVrOHlqZSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MDEzMw==", "bodyText": "This seems to have slipped when I double checked all the mappers, maybe it does not have a test so we don't enforce its consistency.", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509150133", "createdAt": "2020-10-21T10:00:19Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/VersionFieldMapper.java", "diffHunk": "@@ -42,7 +42,7 @@\n         public static final VersionFieldType INSTANCE = new VersionFieldType();\n \n         private VersionFieldType() {\n-            super(NAME, false, false, true, TextSearchInfo.SIMPLE_MATCH_ONLY, Collections.emptyMap());\n+            super(NAME, false, false, true, TextSearchInfo.NONE, Collections.emptyMap());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE2MDk5Mw==", "bodyText": "Yes, there's no test for VersionFieldMapper - I'll add one as a follow up.", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509160993", "createdAt": "2020-10-21T10:17:59Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/VersionFieldMapper.java", "diffHunk": "@@ -42,7 +42,7 @@\n         public static final VersionFieldType INSTANCE = new VersionFieldType();\n \n         private VersionFieldType() {\n-            super(NAME, false, false, true, TextSearchInfo.SIMPLE_MATCH_ONLY, Collections.emptyMap());\n+            super(NAME, false, false, true, TextSearchInfo.NONE, Collections.emptyMap());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MDEzMw=="}, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI1Mzk2MA==", "bodyText": "thank you", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509253960", "createdAt": "2020-10-21T12:56:09Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/VersionFieldMapper.java", "diffHunk": "@@ -42,7 +42,7 @@\n         public static final VersionFieldType INSTANCE = new VersionFieldType();\n \n         private VersionFieldType() {\n-            super(NAME, false, false, true, TextSearchInfo.SIMPLE_MATCH_ONLY, Collections.emptyMap());\n+            super(NAME, false, false, true, TextSearchInfo.NONE, Collections.emptyMap());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MDEzMw=="}, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4OTQ2NjcyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMDowMzoyMFrOHlkK8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMDoxODoyMFrOHlku5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MTk4NA==", "bodyText": "should it be return ft.getTextSearchInfo != NONE && gt.getTextSearchIngo != SIMPLE_MATCH_WITHOUT_TERMS ?", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509151984", "createdAt": "2020-10-21T10:03:20Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorFactory.java", "diffHunk": "@@ -98,6 +99,13 @@ public SignificantTextAggregatorFactory(String name,\n         this.significanceHeuristic = significanceHeuristic;\n     }\n \n+    private static boolean supportsAgg(MappedFieldType ft) {\n+        if (ft.getTextSearchInfo() == TextSearchInfo.NONE) {\n+            return false;\n+        }\n+        return ft.getTextSearchInfo() != TextSearchInfo.SIMPLE_MATCH_WITHOUT_TERMS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE2MTE5MA==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509161190", "createdAt": "2020-10-21T10:18:20Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorFactory.java", "diffHunk": "@@ -98,6 +99,13 @@ public SignificantTextAggregatorFactory(String name,\n         this.significanceHeuristic = significanceHeuristic;\n     }\n \n+    private static boolean supportsAgg(MappedFieldType ft) {\n+        if (ft.getTextSearchInfo() == TextSearchInfo.NONE) {\n+            return false;\n+        }\n+        return ft.getTextSearchInfo() != TextSearchInfo.SIMPLE_MATCH_WITHOUT_TERMS;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MTk4NA=="}, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4346, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}