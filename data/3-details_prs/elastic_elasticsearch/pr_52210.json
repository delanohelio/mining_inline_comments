{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNzAyNTc1", "number": 52210, "title": "SQL: [Docs] Add limitation for sorting on aggs", "bodyText": "Add a section to point out that when ordering by an aggregate\nonly plain aggregate functions are allowed, no scalars/operators\ncan be used on top of them.\nFixes: #52204", "createdAt": "2020-02-11T14:52:04Z", "url": "https://github.com/elastic/elasticsearch/pull/52210", "merged": true, "mergeCommit": {"oid": "78a1185549ff7f3229fd2d036567eb2a4f2cf230"}, "closed": true, "closedAt": "2020-02-12T11:54:43Z", "author": {"login": "matriv"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDS5snAH2gAyMzczNzAyNTc1OmExY2MzMGI1NzJmYWE4ZjZjMmNkMmRmY2UwNDA0MzFhYzJjMDI0MDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDkzR_gH2gAyMzczNzAyNTc1Ojk2OWI5MjlmNDU1YjZmYTYwNzI3MjA1N2Y1ODg4OGU3YmQ4OTZhMjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a1cc30b572faa8f6c2cd2dfce040431ac2c02409", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/a1cc30b572faa8f6c2cd2dfce040431ac2c02409", "committedDate": "2020-02-11T14:49:10Z", "message": "SQL: [Docs] Add limitation for sorting on aggs\n\nAdd a sections to point out that when ordering by an aggregate\ncertain restrictions are applied to the columns used in the `ORDER BY`\nclause. Only the exact same aggregate function(s) as in the `SELECT`\nclause and/or the exact same grouping keys must be used.\n\nFixes: #52204"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0509c6675e6e323b7798c681cf6396cca46905a8", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/0509c6675e6e323b7798c681cf6396cca46905a8", "committedDate": "2020-02-11T16:05:25Z", "message": "Merge remote-tracking branch 'upstream/master' into fix-52204"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2ODEwMzMw", "url": "https://github.com/elastic/elasticsearch/pull/52210#pullrequestreview-356810330", "createdAt": "2020-02-11T16:36:20Z", "commit": {"oid": "0509c6675e6e323b7798c681cf6396cca46905a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjozNjoyMVrOFoQO4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjozNjoyMVrOFoQO4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1MzMxNQ==", "bodyText": "\"they must be the exact the same exact aggregation\"", "url": "https://github.com/elastic/elasticsearch/pull/52210#discussion_r377753315", "createdAt": "2020-02-11T16:36:21Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/limitations.asciidoc", "diffHunk": "@@ -118,6 +118,22 @@ SELECT * FROM test GROUP BY age ORDER BY COUNT(*) LIMIT 100;\n It is possible to run the same queries without a `LIMIT` however in that case if the maximum size (*10000*) is passed,\n an exception will be returned as {es-sql} is unable to track (and sort) all the results returned.\n \n+Moreover, if there are aggregation(s) in the `ORDER BY`, they must be the exact the same exact aggregation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0509c6675e6e323b7798c681cf6396cca46905a8"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2ODExMTAz", "url": "https://github.com/elastic/elasticsearch/pull/52210#pullrequestreview-356811103", "createdAt": "2020-02-11T16:37:16Z", "commit": {"oid": "0509c6675e6e323b7798c681cf6396cca46905a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjozNzoxNlrOFoQRNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjozNzoxNlrOFoQRNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1MzkxMA==", "bodyText": "\"that are defined in the GROUP BY\"", "url": "https://github.com/elastic/elasticsearch/pull/52210#discussion_r377753910", "createdAt": "2020-02-11T16:37:16Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/limitations.asciidoc", "diffHunk": "@@ -118,6 +118,22 @@ SELECT * FROM test GROUP BY age ORDER BY COUNT(*) LIMIT 100;\n It is possible to run the same queries without a `LIMIT` however in that case if the maximum size (*10000*) is passed,\n an exception will be returned as {es-sql} is unable to track (and sort) all the results returned.\n \n+Moreover, if there are aggregation(s) in the `ORDER BY`, they must be the exact the same exact aggregation\n+expressions(s), as used in the `SELECT` clause. The same applies for the fields that are defined the `GROUP BY` clause:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0509c6675e6e323b7798c681cf6396cca46905a8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2ODE0MDIz", "url": "https://github.com/elastic/elasticsearch/pull/52210#pullrequestreview-356814023", "createdAt": "2020-02-11T16:40:51Z", "commit": {"oid": "0509c6675e6e323b7798c681cf6396cca46905a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjo0MDo1MVrOFoQaaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjo0MDo1MVrOFoQaaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc1NjI2NQ==", "bodyText": "Might be useful to add one-two examples on how to change the statement, so that it works. Up to you.", "url": "https://github.com/elastic/elasticsearch/pull/52210#discussion_r377756265", "createdAt": "2020-02-11T16:40:51Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/limitations.asciidoc", "diffHunk": "@@ -118,6 +118,22 @@ SELECT * FROM test GROUP BY age ORDER BY COUNT(*) LIMIT 100;\n It is possible to run the same queries without a `LIMIT` however in that case if the maximum size (*10000*) is passed,\n an exception will be returned as {es-sql} is unable to track (and sort) all the results returned.\n \n+Moreover, if there are aggregation(s) in the `ORDER BY`, they must be the exact the same exact aggregation\n+expressions(s), as used in the `SELECT` clause. The same applies for the fields that are defined the `GROUP BY` clause:\n+they must be the exact same expressions in the `ORDER BY` as in the `GROUP BY`. No operators or scalar functions can be\n+used on top or removed from those expressions. Here are some examples of queries that are not allowed:\n+\n+[source, sql]\n+--------------------------------------------------\n+SELECT age, MAX(salary) FROM test GROUP BY gender ORDER BY age % 10, MAX(salary);\n+\n+SELECT age, MAX(salary) FROM test GROUP BY gender ORDER BY age, CAST(MAX(salary) AS FLOAT);\n+\n+SELECT age % 10, MAX(salary) FROM test GROUP BY gender ORDER BY age, MAX(salary);\n+\n+SELECT age, MAX(salary) / 12 AS max_salary FROM test GROUP BY ORDER BY age, MAX(salary);\n+--------------------------------------------------", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0509c6675e6e323b7798c681cf6396cca46905a8"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2ODE0MzA1", "url": "https://github.com/elastic/elasticsearch/pull/52210#pullrequestreview-356814305", "createdAt": "2020-02-11T16:41:10Z", "commit": {"oid": "0509c6675e6e323b7798c681cf6396cca46905a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5191624cf139adc65beb7d537849b62926a5cd51", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/5191624cf139adc65beb7d537849b62926a5cd51", "committedDate": "2020-02-11T19:46:59Z", "message": "fix limitation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94b28283844b020101f073c72c9775ec811ce06c", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/94b28283844b020101f073c72c9775ec811ce06c", "committedDate": "2020-02-11T19:52:47Z", "message": "gender -> age"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MzQ1MjU1", "url": "https://github.com/elastic/elasticsearch/pull/52210#pullrequestreview-357345255", "createdAt": "2020-02-12T10:34:45Z", "commit": {"oid": "94b28283844b020101f073c72c9775ec811ce06c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MzU3NTQ0", "url": "https://github.com/elastic/elasticsearch/pull/52210#pullrequestreview-357357544", "createdAt": "2020-02-12T10:53:02Z", "commit": {"oid": "94b28283844b020101f073c72c9775ec811ce06c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDo1MzowM1rOFoqDYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDo1MzowM1rOFoqDYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE3NjM1NQ==", "bodyText": "\"must be only plain aggregate functions\" could be rephrased to \"can only be ...\"", "url": "https://github.com/elastic/elasticsearch/pull/52210#discussion_r378176355", "createdAt": "2020-02-12T10:53:03Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/limitations.asciidoc", "diffHunk": "@@ -118,6 +118,17 @@ SELECT * FROM test GROUP BY age ORDER BY COUNT(*) LIMIT 100;\n It is possible to run the same queries without a `LIMIT` however in that case if the maximum size (*10000*) is passed,\n an exception will be returned as {es-sql} is unable to track (and sort) all the results returned.\n \n+Moreover, the aggregation(s) used in the `ORDER BY`, must be only plain aggregate functions. No scalar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94b28283844b020101f073c72c9775ec811ce06c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MzU4NTQ4", "url": "https://github.com/elastic/elasticsearch/pull/52210#pullrequestreview-357358548", "createdAt": "2020-02-12T10:54:28Z", "commit": {"oid": "94b28283844b020101f073c72c9775ec811ce06c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "969b929f455b6fa607272057f58888e7bd896a29", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/969b929f455b6fa607272057f58888e7bd896a29", "committedDate": "2020-02-12T11:40:27Z", "message": "address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2561, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}