{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MTQzMTk5", "number": 62357, "title": "Introduce FetchContext", "bodyText": "We currently pass a SearchContext around to share configuration among\nFetchSubPhases. With the introduction of runtime fields, it would be useful\nto start storing some state on this context to be shared between different\nsubphases (for example, stored fields or search lookups can be loaded lazily\nbut referred to by many different subphases). However, SearchContext is a\nvery large and unwieldy class, and adding more methods or state here feels\nlike a bridge too far.\nThis commit introduces a new FetchContext class that exposes only those\nmethods on SearchContext that are required for fetch phases.  This reduces\nthe API surface area for fetch phases considerably, and should give us some\nleeway to add further state.", "createdAt": "2020-09-15T08:55:02Z", "url": "https://github.com/elastic/elasticsearch/pull/62357", "merged": true, "mergeCommit": {"oid": "41bce50e7127e5507ed8e5bbd304fb7d4f8208f5"}, "closed": true, "closedAt": "2020-09-17T08:46:04Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHge6fAH2gAyNDg3MTQzMTk5OmYzMTUzYWE0NDgzNGU2NGM0Y2E3OWQxOTNlZjIyNTYyODRjZjg2ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJsx04AFqTQ5MDM2NDE4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3153aa44834e64c4ca79d193ef2256284cf8689", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/f3153aa44834e64c4ca79d193ef2256284cf8689", "committedDate": "2020-09-10T13:05:26Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7966f1e4c2baedca0f5252745f5876cdf8fdfac5", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/7966f1e4c2baedca0f5252745f5876cdf8fdfac5", "committedDate": "2020-09-10T13:54:25Z", "message": "Rationalise fetch phase exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c0ad25bdc541472ea5952ff3316b60165868686", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/9c0ad25bdc541472ea5952ff3316b60165868686", "committedDate": "2020-09-10T15:51:19Z", "message": "Merge branch 'fetch/exceptions' into fetch/fetchcontext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66541df9770c8948285f419ba7e8d7931694dc1f", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/66541df9770c8948285f419ba7e8d7931694dc1f", "committedDate": "2020-09-12T15:46:38Z", "message": "Introduce FetchContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a994425fb7a894e5fc758b33d4ba62f7e447cd67", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a994425fb7a894e5fc758b33d4ba62f7e447cd67", "committedDate": "2020-09-13T10:49:31Z", "message": "Merge remote-tracking branch 'origin/master' into fetch/fetchcontext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8df15359f34d4094567b879e4be2b00ab44856d0", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/8df15359f34d4094567b879e4be2b00ab44856d0", "committedDate": "2020-09-13T14:56:19Z", "message": "reduce our surface area a little"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39f599cabbc9d2a519f86d5940eab8759a9f77e6", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/39f599cabbc9d2a519f86d5940eab8759a9f77e6", "committedDate": "2020-09-14T15:03:52Z", "message": "Merge remote-tracking branch 'origin/master' into fetch/fetchcontext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e66798aee28445ef9039c4a238c94b88e999c8c5", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/e66798aee28445ef9039c4a238c94b88e999c8c5", "committedDate": "2020-09-14T15:15:55Z", "message": "null check on matchedqueries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c13e6165722927df146bae37140a87dd68f2999", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c13e6165722927df146bae37140a87dd68f2999", "committedDate": "2020-09-15T08:37:11Z", "message": "Merge remote-tracking branch 'origin/master' into fetch/fetchcontext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/d292e4ff61b6d68e20c9cb2ed954f418d27351a6", "committedDate": "2020-09-15T08:48:01Z", "message": "javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "762f3a89146a93ba149efacb3878f4d47a097c10", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/762f3a89146a93ba149efacb3878f4d47a097c10", "committedDate": "2020-09-15T09:06:04Z", "message": "precommit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDcwMTc1", "url": "https://github.com/elastic/elasticsearch/pull/62357#pullrequestreview-488470175", "createdAt": "2020-09-15T08:56:57Z", "commit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODo1Njo1N1rOHR3xQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwOTowOTo1OVrOHR4RmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwMTU3MQ==", "bodyText": "This is I think only used in error messages, and is duplicated by information in FetchPhaseExecutionException so we may be able to remove it.", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488501571", "createdAt": "2020-09-15T08:56:57Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.fetch;\n+\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.index.query.ParsedQuery;\n+import org.elasticsearch.search.SearchExtBuilder;\n+import org.elasticsearch.search.fetch.subphase.FetchDocValuesContext;\n+import org.elasticsearch.search.fetch.subphase.FetchFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n+import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n+import org.elasticsearch.search.fetch.subphase.InnerHitsContext;\n+import org.elasticsearch.search.fetch.subphase.ScriptFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.highlight.SearchHighlightContext;\n+import org.elasticsearch.search.internal.ContextIndexSearcher;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.search.rescore.RescoreContext;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Encapsulates state required to execute fetch phases\n+ */\n+public class FetchContext {\n+\n+    private FetchContext(SearchContext searchContext) {\n+        this.searchContext = searchContext;\n+    }\n+\n+    /**\n+     * Create a FetchContext based on a SearchContext\n+     */\n+    public static FetchContext fromSearchContext(SearchContext context) {\n+        return new FetchContext(context);\n+    }\n+\n+    private final SearchContext searchContext;\n+\n+    /**\n+     * The name of the index that documents are being fetched from\n+     */\n+    public String getIndexName() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwMTkxNg==", "bodyText": "It would be really nice to be able to replace this with a SearchLookup", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488501916", "createdAt": "2020-09-15T08:57:24Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.fetch;\n+\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.index.query.ParsedQuery;\n+import org.elasticsearch.search.SearchExtBuilder;\n+import org.elasticsearch.search.fetch.subphase.FetchDocValuesContext;\n+import org.elasticsearch.search.fetch.subphase.FetchFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n+import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n+import org.elasticsearch.search.fetch.subphase.InnerHitsContext;\n+import org.elasticsearch.search.fetch.subphase.ScriptFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.highlight.SearchHighlightContext;\n+import org.elasticsearch.search.internal.ContextIndexSearcher;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.search.rescore.RescoreContext;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Encapsulates state required to execute fetch phases\n+ */\n+public class FetchContext {\n+\n+    private FetchContext(SearchContext searchContext) {\n+        this.searchContext = searchContext;\n+    }\n+\n+    /**\n+     * Create a FetchContext based on a SearchContext\n+     */\n+    public static FetchContext fromSearchContext(SearchContext context) {\n+        return new FetchContext(context);\n+    }\n+\n+    private final SearchContext searchContext;\n+\n+    /**\n+     * The name of the index that documents are being fetched from\n+     */\n+    public String getIndexName() {\n+        return searchContext.indexShard().shardId().getIndexName();\n+    }\n+\n+    /**\n+     * The point-in-time searcher the original query was executed against\n+     */\n+    public ContextIndexSearcher searcher() {\n+        return searchContext.searcher();\n+    }\n+\n+    /**\n+     * The mapper service for the index we are fetching documents from\n+     */\n+    public MapperService mapperService() {\n+        return searchContext.mapperService();\n+    }\n+\n+    /**\n+     * The index settings for the index we are fetching documents from\n+     */\n+    public IndexSettings getIndexSettings() {\n+        return mapperService().getIndexSettings();\n+    }\n+\n+    /**\n+     * Gets index field data for a specific fieldtype\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwMzg3NQ==", "bodyText": "It seems odd that disabling stored fields means that we don't return the version, but this does not apply to seqNo/primaryTerm?", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488503875", "createdAt": "2020-09-15T09:00:15Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.fetch;\n+\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.index.query.ParsedQuery;\n+import org.elasticsearch.search.SearchExtBuilder;\n+import org.elasticsearch.search.fetch.subphase.FetchDocValuesContext;\n+import org.elasticsearch.search.fetch.subphase.FetchFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n+import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n+import org.elasticsearch.search.fetch.subphase.InnerHitsContext;\n+import org.elasticsearch.search.fetch.subphase.ScriptFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.highlight.SearchHighlightContext;\n+import org.elasticsearch.search.internal.ContextIndexSearcher;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.search.rescore.RescoreContext;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Encapsulates state required to execute fetch phases\n+ */\n+public class FetchContext {\n+\n+    private FetchContext(SearchContext searchContext) {\n+        this.searchContext = searchContext;\n+    }\n+\n+    /**\n+     * Create a FetchContext based on a SearchContext\n+     */\n+    public static FetchContext fromSearchContext(SearchContext context) {\n+        return new FetchContext(context);\n+    }\n+\n+    private final SearchContext searchContext;\n+\n+    /**\n+     * The name of the index that documents are being fetched from\n+     */\n+    public String getIndexName() {\n+        return searchContext.indexShard().shardId().getIndexName();\n+    }\n+\n+    /**\n+     * The point-in-time searcher the original query was executed against\n+     */\n+    public ContextIndexSearcher searcher() {\n+        return searchContext.searcher();\n+    }\n+\n+    /**\n+     * The mapper service for the index we are fetching documents from\n+     */\n+    public MapperService mapperService() {\n+        return searchContext.mapperService();\n+    }\n+\n+    /**\n+     * The index settings for the index we are fetching documents from\n+     */\n+    public IndexSettings getIndexSettings() {\n+        return mapperService().getIndexSettings();\n+    }\n+\n+    /**\n+     * Gets index field data for a specific fieldtype\n+     */\n+    public IndexFieldData<?> getForField(MappedFieldType fieldType) {\n+        return searchContext.getForField(fieldType);\n+    }\n+\n+    /**\n+     * The original query\n+     */\n+    public Query query() {\n+        return searchContext.query();\n+    }\n+\n+    /**\n+     * The original query with additional filters and named queries\n+     */\n+    public ParsedQuery parsedQuery() {\n+        return searchContext.parsedQuery();\n+    }\n+\n+    /**\n+     * Any post-filters run as part of the search\n+     */\n+    public ParsedQuery parsedPostFilter() {\n+        return searchContext.parsedPostFilter();\n+    }\n+\n+    /**\n+     * Configuration for fetching _source\n+     */\n+    public FetchSourceContext fetchSourceContext() {\n+        return searchContext.fetchSourceContext();\n+    }\n+\n+    /**\n+     * Should the response include `explain` output\n+     */\n+    public boolean explain() {\n+        return searchContext.explain();\n+    }\n+\n+    /**\n+     * The rescorers included in the original search, used for explain output\n+     */\n+    public List<RescoreContext> rescore() {\n+        return searchContext.rescore();\n+    }\n+\n+    /**\n+     * Should the response include sequence number and primary term metadata\n+     */\n+    public boolean seqNoAndPrimaryTerm() {\n+        return searchContext.seqNoAndPrimaryTerm();\n+    }\n+\n+    /**\n+     * Configuration for fetching docValues fields\n+     */\n+    public FetchDocValuesContext docValuesContext() {\n+        FetchDocValuesContext dvContext = searchContext.docValuesContext();\n+        if (searchContext.collapse() != null) {\n+            // retrieve the `doc_value` associated with the collapse field\n+            String name = searchContext.collapse().getFieldName();\n+            if (dvContext == null) {\n+                return new FetchDocValuesContext(Collections.singletonList(new FieldAndFormat(name, null)));\n+            } else if (searchContext.docValuesContext().fields().stream().map(ff -> ff.field).anyMatch(name::equals) == false) {\n+                dvContext.fields().add(new FieldAndFormat(name, null));\n+            }\n+        }\n+        return dvContext;\n+    }\n+\n+    /**\n+     * Configuration for highlighting\n+     */\n+    public SearchHighlightContext highlight() {\n+        return searchContext.highlight();\n+    }\n+\n+    /**\n+     * Should the response include scores, even if scores were not calculated in the original query\n+     */\n+    public boolean fetchScores() {\n+        return searchContext.sort() != null && searchContext.trackScores();\n+    }\n+\n+    /**\n+     * Configuration for returning inner hits\n+     */\n+    public InnerHitsContext innerHits() {\n+        return searchContext.innerHits();\n+    }\n+\n+    /**\n+     * Should the response include version metadata\n+     */\n+    public boolean version() {\n+        // TODO version is loaded from docvalues, not stored fields, so why are we checking\n+        // stored fields here?\n+        return searchContext.version() &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 189}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwNTYzMQ==", "bodyText": "We were checking in a couple of subphases for things like \"how many docs are we executing against\" or \"is this a suggest-only response\".  This pulls this check up to the top level, which also means we don't need to include this information in the FetchContext.", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488505631", "createdAt": "2020-09-15T09:03:01Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -87,19 +88,28 @@ public void execute(SearchContext context) {\n             LOGGER.trace(\"{}\", new SearchContextSourcePrinter(context));\n         }\n \n-        Map<String, Set<String>> storedToRequestedFields = new HashMap<>();\n-        FieldsVisitor fieldsVisitor = createStoredFieldsVisitor(context, storedToRequestedFields);\n+        if (context.docIdsToLoadSize() == 0) {\n+            // no individual hits to process, so we shortcut", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwNjYxOQ==", "bodyText": "The hasOnlySuggest check is now done at the top level", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488506619", "createdAt": "2020-09-15T09:04:31Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/ExplainPhase.java", "diffHunk": "@@ -33,8 +33,8 @@\n public final class ExplainPhase implements FetchSubPhase {\n \n     @Override\n-    public FetchSubPhaseProcessor getProcessor(SearchContext context) {\n-        if (context.explain() == false || context.hasOnlySuggest()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwNzA2Mw==", "bodyText": "This logic is moved into FetchContext#docValuesContext(), meaning that we don't need to expose collapse() on FetchContext", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488507063", "createdAt": "2020-09-15T09:05:10Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesPhase.java", "diffHunk": "@@ -48,24 +48,15 @@\n public final class FetchDocValuesPhase implements FetchSubPhase {\n \n     @Override\n-    public FetchSubPhaseProcessor getProcessor(SearchContext context) throws IOException {\n-        if (context.collapse() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwODM4OA==", "bodyText": "This logic is all contained in FetchContext#fetchScores()", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488508388", "createdAt": "2020-09-15T09:07:31Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchScorePhase.java", "diffHunk": "@@ -25,19 +25,17 @@\n import org.apache.lucene.search.Scorer;\n import org.apache.lucene.search.ScorerSupplier;\n import org.apache.lucene.search.Weight;\n+import org.elasticsearch.search.fetch.FetchContext;\n import org.elasticsearch.search.fetch.FetchSubPhase;\n import org.elasticsearch.search.fetch.FetchSubPhaseProcessor;\n-import org.elasticsearch.search.internal.SearchContext;\n \n import java.io.IOException;\n \n public class FetchScorePhase implements FetchSubPhase {\n \n     @Override\n-    public FetchSubPhaseProcessor getProcessor(SearchContext context) throws IOException {\n-        if (context.trackScores() == false || context.docIdsToLoadSize() == 0 ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwOTg0OQ==", "bodyText": "IOExceptions are handled in the top-level FetchPhase", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488509849", "createdAt": "2020-09-15T09:09:59Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/UnifiedHighlighter.java", "diffHunk": "@@ -80,13 +79,7 @@ public HighlightField highlight(FieldHighlightContext fieldContext) throws IOExc\n             }\n             return mergeFieldValues(fieldValues, MULTIVAL_SEP_CHAR);\n         };\n-        Snippet[] fieldSnippets;\n-        try {\n-            fieldSnippets = highlighter.highlightField(hitContext.reader(), hitContext.docId(), loadFieldValues);\n-        } catch (IOException e) {\n-            throw new FetchPhaseExecutionException(fieldContext.shardTarget,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa61e5b51a564b40f801f5b6a78528a31b963d40", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa61e5b51a564b40f801f5b6a78528a31b963d40", "committedDate": "2020-09-15T10:11:11Z", "message": "check for null query in explain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f76bd7502b7ec4c078246d420919d638678b0a1", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f76bd7502b7ec4c078246d420919d638678b0a1", "committedDate": "2020-09-15T11:02:54Z", "message": "test plugin failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4OTMwMDQy", "url": "https://github.com/elastic/elasticsearch/pull/62357#pullrequestreview-488930042", "createdAt": "2020-09-15T17:55:59Z", "commit": {"oid": "9f76bd7502b7ec4c078246d420919d638678b0a1"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNzo1NTo1OVrOHSNmOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxODo0MDoxMVrOHSPEJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1OTE5NA==", "bodyText": "This sort of deletion is a good sign !", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488859194", "createdAt": "2020-09-15T17:55:59Z", "author": {"login": "jtibshirani"}, "path": "server/src/test/java/org/elasticsearch/search/fetch/subphase/FetchSourcePhaseTests.java", "diffHunk": "@@ -173,30 +172,4 @@ private HitContext hitExecuteMultiple(XContentBuilder source, boolean fetchSourc\n         return hitContext;\n     }\n \n-    private static class FetchSourcePhaseTestSearchContext extends TestSearchContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f76bd7502b7ec4c078246d420919d638678b0a1"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2MzY2MA==", "bodyText": "Checking I understand, does this actually fix a bug where we wouldn't return named query information if there was only a post filter?", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488863660", "createdAt": "2020-09-15T18:04:08Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/MatchedQueriesPhase.java", "diffHunk": "@@ -38,13 +38,11 @@\n public final class MatchedQueriesPhase implements FetchSubPhase {\n \n     @Override\n-    public FetchSubPhaseProcessor getProcessor(SearchContext context) throws IOException {\n-        if (context.docIdsToLoadSize() == 0 ||\n-            // in case the request has only suggest, parsed query is null\n-            context.parsedQuery() == null) {\n-            return null;\n+    public FetchSubPhaseProcessor getProcessor(FetchContext context) throws IOException {\n+        Map<String, Query> namedQueries = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f76bd7502b7ec4c078246d420919d638678b0a1"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2ODkyNg==", "bodyText": "Checking I understand, is this just an optional clean-up ?", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488868926", "createdAt": "2020-09-15T18:13:48Z", "author": {"login": "jtibshirani"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/search/fetch/FetchSubPhasePluginIT.java", "diffHunk": "@@ -139,19 +135,18 @@ private void hitExecute(SearchContext context, HitContext hitContext) {\n                 hitField = new DocumentField(NAME, new ArrayList<>(1));\n                 hitContext.hit().setDocumentField(NAME, hitField);\n             }\n-            TermVectorsRequest termVectorsRequest = new TermVectorsRequest(context.indexShard().shardId().getIndex().getName(),\n-                    hitContext.hit().getId());\n-            TermVectorsResponse termVector = TermVectorsService.getTermVectors(context.indexShard(), termVectorsRequest);\n-            try {\n+            Terms terms = hitContext.reader().getTermVector(hitContext.docId(), field);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f76bd7502b7ec4c078246d420919d638678b0a1"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4MDAzNQ==", "bodyText": "This does seem off! I think we could treat it as a bug and fix it in another PR.", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488880035", "createdAt": "2020-09-15T18:34:13Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.fetch;\n+\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.index.query.ParsedQuery;\n+import org.elasticsearch.search.SearchExtBuilder;\n+import org.elasticsearch.search.fetch.subphase.FetchDocValuesContext;\n+import org.elasticsearch.search.fetch.subphase.FetchFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n+import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n+import org.elasticsearch.search.fetch.subphase.InnerHitsContext;\n+import org.elasticsearch.search.fetch.subphase.ScriptFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.highlight.SearchHighlightContext;\n+import org.elasticsearch.search.internal.ContextIndexSearcher;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.search.rescore.RescoreContext;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Encapsulates state required to execute fetch phases\n+ */\n+public class FetchContext {\n+\n+    private FetchContext(SearchContext searchContext) {\n+        this.searchContext = searchContext;\n+    }\n+\n+    /**\n+     * Create a FetchContext based on a SearchContext\n+     */\n+    public static FetchContext fromSearchContext(SearchContext context) {\n+        return new FetchContext(context);\n+    }\n+\n+    private final SearchContext searchContext;\n+\n+    /**\n+     * The name of the index that documents are being fetched from\n+     */\n+    public String getIndexName() {\n+        return searchContext.indexShard().shardId().getIndexName();\n+    }\n+\n+    /**\n+     * The point-in-time searcher the original query was executed against\n+     */\n+    public ContextIndexSearcher searcher() {\n+        return searchContext.searcher();\n+    }\n+\n+    /**\n+     * The mapper service for the index we are fetching documents from\n+     */\n+    public MapperService mapperService() {\n+        return searchContext.mapperService();\n+    }\n+\n+    /**\n+     * The index settings for the index we are fetching documents from\n+     */\n+    public IndexSettings getIndexSettings() {\n+        return mapperService().getIndexSettings();\n+    }\n+\n+    /**\n+     * Gets index field data for a specific fieldtype\n+     */\n+    public IndexFieldData<?> getForField(MappedFieldType fieldType) {\n+        return searchContext.getForField(fieldType);\n+    }\n+\n+    /**\n+     * The original query\n+     */\n+    public Query query() {\n+        return searchContext.query();\n+    }\n+\n+    /**\n+     * The original query with additional filters and named queries\n+     */\n+    public ParsedQuery parsedQuery() {\n+        return searchContext.parsedQuery();\n+    }\n+\n+    /**\n+     * Any post-filters run as part of the search\n+     */\n+    public ParsedQuery parsedPostFilter() {\n+        return searchContext.parsedPostFilter();\n+    }\n+\n+    /**\n+     * Configuration for fetching _source\n+     */\n+    public FetchSourceContext fetchSourceContext() {\n+        return searchContext.fetchSourceContext();\n+    }\n+\n+    /**\n+     * Should the response include `explain` output\n+     */\n+    public boolean explain() {\n+        return searchContext.explain();\n+    }\n+\n+    /**\n+     * The rescorers included in the original search, used for explain output\n+     */\n+    public List<RescoreContext> rescore() {\n+        return searchContext.rescore();\n+    }\n+\n+    /**\n+     * Should the response include sequence number and primary term metadata\n+     */\n+    public boolean seqNoAndPrimaryTerm() {\n+        return searchContext.seqNoAndPrimaryTerm();\n+    }\n+\n+    /**\n+     * Configuration for fetching docValues fields\n+     */\n+    public FetchDocValuesContext docValuesContext() {\n+        FetchDocValuesContext dvContext = searchContext.docValuesContext();\n+        if (searchContext.collapse() != null) {\n+            // retrieve the `doc_value` associated with the collapse field\n+            String name = searchContext.collapse().getFieldName();\n+            if (dvContext == null) {\n+                return new FetchDocValuesContext(Collections.singletonList(new FieldAndFormat(name, null)));\n+            } else if (searchContext.docValuesContext().fields().stream().map(ff -> ff.field).anyMatch(name::equals) == false) {\n+                dvContext.fields().add(new FieldAndFormat(name, null));\n+            }\n+        }\n+        return dvContext;\n+    }\n+\n+    /**\n+     * Configuration for highlighting\n+     */\n+    public SearchHighlightContext highlight() {\n+        return searchContext.highlight();\n+    }\n+\n+    /**\n+     * Should the response include scores, even if scores were not calculated in the original query\n+     */\n+    public boolean fetchScores() {\n+        return searchContext.sort() != null && searchContext.trackScores();\n+    }\n+\n+    /**\n+     * Configuration for returning inner hits\n+     */\n+    public InnerHitsContext innerHits() {\n+        return searchContext.innerHits();\n+    }\n+\n+    /**\n+     * Should the response include version metadata\n+     */\n+    public boolean version() {\n+        // TODO version is loaded from docvalues, not stored fields, so why are we checking\n+        // stored fields here?\n+        return searchContext.version() &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwMzg3NQ=="}, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 189}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4MzIzNw==", "bodyText": "To me it seems off to have non-trivial logic in a simple getter. It feels okay to keep this in FetchDocValuesPhase and expose FetchContext#collapse() since it has some relevance to the fetch phase ?", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r488883237", "createdAt": "2020-09-15T18:40:11Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesPhase.java", "diffHunk": "@@ -48,24 +48,15 @@\n public final class FetchDocValuesPhase implements FetchSubPhase {\n \n     @Override\n-    public FetchSubPhaseProcessor getProcessor(SearchContext context) throws IOException {\n-        if (context.collapse() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwNzA2Mw=="}, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12e9bbb331fd2c798a8d5f1382fc88956c570ac1", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/12e9bbb331fd2c798a8d5f1382fc88956c570ac1", "committedDate": "2020-09-16T12:31:15Z", "message": "Merge remote-tracking branch 'origin/master' into fetch/fetchcontext"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NjA5NDY0", "url": "https://github.com/elastic/elasticsearch/pull/62357#pullrequestreview-489609464", "createdAt": "2020-09-16T13:12:43Z", "commit": {"oid": "12e9bbb331fd2c798a8d5f1382fc88956c570ac1"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzoxMjo0M1rOHSwKRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzoxODozNFrOHSwadg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQyNTQ3Ng==", "bodyText": "Why the private ctor and static factory? I know its nice sometimes when you need the name to describe, but I think we don't here?", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r489425476", "createdAt": "2020-09-16T13:12:43Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java", "diffHunk": "@@ -0,0 +1,204 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.fetch;\n+\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.index.query.ParsedQuery;\n+import org.elasticsearch.search.SearchExtBuilder;\n+import org.elasticsearch.search.fetch.subphase.FetchDocValuesContext;\n+import org.elasticsearch.search.fetch.subphase.FetchFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n+import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n+import org.elasticsearch.search.fetch.subphase.InnerHitsContext;\n+import org.elasticsearch.search.fetch.subphase.ScriptFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.highlight.SearchHighlightContext;\n+import org.elasticsearch.search.internal.ContextIndexSearcher;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.search.rescore.RescoreContext;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Encapsulates state required to execute fetch phases\n+ */\n+public class FetchContext {\n+\n+    private FetchContext(SearchContext searchContext) {\n+        this.searchContext = searchContext;\n+    }\n+\n+    /**\n+     * Create a FetchContext based on a SearchContext\n+     */\n+    public static FetchContext fromSearchContext(SearchContext context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e9bbb331fd2c798a8d5f1382fc88956c570ac1"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQyNTgyOA==", "bodyText": "Could you float it to the top so it doesn't get lost? I get really confused if member variables aren't above member methods. I'm just super used to that.", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r489425828", "createdAt": "2020-09-16T13:13:13Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java", "diffHunk": "@@ -0,0 +1,204 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.fetch;\n+\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.index.query.ParsedQuery;\n+import org.elasticsearch.search.SearchExtBuilder;\n+import org.elasticsearch.search.fetch.subphase.FetchDocValuesContext;\n+import org.elasticsearch.search.fetch.subphase.FetchFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.FetchSourceContext;\n+import org.elasticsearch.search.fetch.subphase.FieldAndFormat;\n+import org.elasticsearch.search.fetch.subphase.InnerHitsContext;\n+import org.elasticsearch.search.fetch.subphase.ScriptFieldsContext;\n+import org.elasticsearch.search.fetch.subphase.highlight.SearchHighlightContext;\n+import org.elasticsearch.search.internal.ContextIndexSearcher;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.search.rescore.RescoreContext;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * Encapsulates state required to execute fetch phases\n+ */\n+public class FetchContext {\n+\n+    private FetchContext(SearchContext searchContext) {\n+        this.searchContext = searchContext;\n+    }\n+\n+    /**\n+     * Create a FetchContext based on a SearchContext\n+     */\n+    public static FetchContext fromSearchContext(SearchContext context) {\n+        return new FetchContext(context);\n+    }\n+\n+    private final SearchContext searchContext;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e9bbb331fd2c798a8d5f1382fc88956c570ac1"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQyNzcwMA==", "bodyText": "Do you think lookup should be a member on FetchContext? I know I just added it, but now that you are proposing our own \"context\" I think I'd be nice to fold it in.", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r489427700", "createdAt": "2020-09-16T13:15:57Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchSubPhase.java", "diffHunk": "@@ -100,8 +99,8 @@ public IndexReader topLevelReader() {\n     /**\n      * Returns a {@link FetchSubPhaseProcessor} for this sub phase.\n      *\n-     * If nothing should be executed for the provided {@link SearchContext}, then the\n+     * If nothing should be executed for the provided {@code FetchContext}, then the\n      * implementation should return {@code null}\n      */\n-    FetchSubPhaseProcessor getProcessor(SearchContext searchContext, SearchLookup lookup) throws IOException;\n+    FetchSubPhaseProcessor getProcessor(FetchContext fetchContext, SearchLookup lookup) throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12e9bbb331fd2c798a8d5f1382fc88956c570ac1"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQyOTYyMg==", "bodyText": "Would it feel better if the logic was in FetchContext's ctor? I do like the idea of moving separating \"which doc values do we need\" from \"how do we load doc values\". We do the same thing with source visiting right now so it kind of makes sense.", "url": "https://github.com/elastic/elasticsearch/pull/62357#discussion_r489429622", "createdAt": "2020-09-16T13:18:34Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesPhase.java", "diffHunk": "@@ -48,24 +48,15 @@\n public final class FetchDocValuesPhase implements FetchSubPhase {\n \n     @Override\n-    public FetchSubPhaseProcessor getProcessor(SearchContext context) throws IOException {\n-        if (context.collapse() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODUwNzA2Mw=="}, "originalCommit": {"oid": "d292e4ff61b6d68e20c9cb2ed954f418d27351a6"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b429a82dea54cd2c2fb6103475df0dec626d8d5", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b429a82dea54cd2c2fb6103475df0dec626d8d5", "committedDate": "2020-09-16T14:25:11Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ccde5e1ec556394a08b52ad0163fc2f541ba6bf", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ccde5e1ec556394a08b52ad0163fc2f541ba6bf", "committedDate": "2020-09-16T15:21:55Z", "message": "Merge branch 'master' into fetch/fetchcontext"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMDA3ODEy", "url": "https://github.com/elastic/elasticsearch/pull/62357#pullrequestreview-490007812", "createdAt": "2020-09-16T20:46:35Z", "commit": {"oid": "1ccde5e1ec556394a08b52ad0163fc2f541ba6bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff13ae34ec5a961fc808bd06fae5693c076df93c", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff13ae34ec5a961fc808bd06fae5693c076df93c", "committedDate": "2020-09-17T07:51:02Z", "message": "Merge branch 'master' into fetch/fetchcontext"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMzY0MTgx", "url": "https://github.com/elastic/elasticsearch/pull/62357#pullrequestreview-490364181", "createdAt": "2020-09-17T08:32:48Z", "commit": {"oid": "ff13ae34ec5a961fc808bd06fae5693c076df93c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4621, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}