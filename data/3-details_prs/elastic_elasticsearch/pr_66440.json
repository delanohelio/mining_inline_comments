{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMTM3Mjcy", "number": 66440, "title": "Allow dynamic port allocation for hdfs fixture", "bodyText": "Running multiple hdfs fixtures in parallel for running integration tests requires\na dynamic port assignment in order to avoid port clashes. This introduces\nthe ability to assign port ranges to gradle projects that can be used\nto allocate dynamically ports used by these projects.\nWe apply this dynamic port setup for hdfs fixtures used in\n:x-pack:plugin:searchable-snapshots:qa only at the moment as\ntests sources (rest tests) in :plugins:repository-hdfs still rely on\nhard coded ports.\nThis is a simplified version of fixtures I created before on the gradle codebase\nto deal with similar issues.\nFixes #66377", "createdAt": "2020-12-16T12:39:18Z", "url": "https://github.com/elastic/elasticsearch/pull/66440", "merged": true, "mergeCommit": {"oid": "d5f1bbf9ef3bb811b6099ec381463d4fa4f5fb91"}, "closed": true, "closedAt": "2020-12-16T14:59:34Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmuNf2AH2gAyNTQxMTM3MjcyOjBjNmI2YmUyYWZiNjg2ZjhlM2UzMTY0YTM0ZmEwNTU0MzI1MzRjNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmzyQ2gFqTU1Mzk5MjQyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0c6b6be2afb686f8e3e3164a34fa055432534c73", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c6b6be2afb686f8e3e3164a34fa055432534c73", "committedDate": "2020-12-16T12:36:44Z", "message": "Allow dynamic port allocation for hdfs fixture\n\nRunning multiple hdfs fixtures in parallel for running integration tests requires\na dynamic port assignment in order to avoid port clashes. This introduces\nthe ability to assign port ranges to gradle projects that can be used\nto allocate dynamically ports used by these projects.\n\nWe apply this dynamic port setup for hdfs fixtures used in\n:x-pack:plugin:searchable-snapshots:qa only at the moment as\ntests sources (rest tests) in :plugins:repository-hdfs still rely on\nhard coded ports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "848e49bbc5caf5c28ad095d0f0a680a1887cdcba", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/848e49bbc5caf5c28ad095d0f0a680a1887cdcba", "committedDate": "2020-12-16T12:43:03Z", "message": "Fix task dependency declaration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a6e1a3bf0a39a3c5026a8a2864531550ed5ab77", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a6e1a3bf0a39a3c5026a8a2864531550ed5ab77", "committedDate": "2020-12-16T13:08:26Z", "message": "Fix javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNzAwNDQy", "url": "https://github.com/elastic/elasticsearch/pull/66440#pullrequestreview-553700442", "createdAt": "2020-12-16T13:47:55Z", "commit": {"oid": "2a6e1a3bf0a39a3c5026a8a2864531550ed5ab77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxMzo0Nzo1NVrOIHGHeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxMzo0Nzo1NVrOIHGHeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMxMTE2Mg==", "bodyText": "Do we need this property, since it's final and initialised to DEFAULT_RANGE_SIZE?", "url": "https://github.com/elastic/elasticsearch/pull/66440#discussion_r544311162", "createdAt": "2020-12-16T13:47:55Z", "author": {"login": "pugnascotia"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/util/ports/AvailablePortAllocator.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.util.ports;\n+\n+import org.gradle.internal.Pair;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+public class AvailablePortAllocator implements PortAllocator {\n+    public static final int MIN_PRIVATE_PORT = 49152;\n+    public static final int MAX_PRIVATE_PORT = 65535;\n+    public static final int DEFAULT_RANGE_SIZE = 100;\n+\n+    private final List<ReservedPortRange> reservations = new ArrayList<ReservedPortRange>();\n+    private final int rangeSize = DEFAULT_RANGE_SIZE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a6e1a3bf0a39a3c5026a8a2864531550ed5ab77"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5dc49c211b48c235e25ffb65fbe8a3e4037f791", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5dc49c211b48c235e25ffb65fbe8a3e4037f791", "committedDate": "2020-12-16T13:54:13Z", "message": "Address review feedback\n\n- remove unnecessary field"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTkyNDI1", "url": "https://github.com/elastic/elasticsearch/pull/66440#pullrequestreview-553992425", "createdAt": "2020-12-16T18:58:49Z", "commit": {"oid": "b5dc49c211b48c235e25ffb65fbe8a3e4037f791"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxODo1ODo0OVrOIHUepA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxOTowMDozNFrOIHUjOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NjQ2OA==", "bodyText": "What's the motivation for having these port ranges per-project? Why not just allocate a single big block for the entire build?", "url": "https://github.com/elastic/elasticsearch/pull/66440#discussion_r544546468", "createdAt": "2020-12-16T18:58:49Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/util/ports/AvailablePortAllocator.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.util.ports;\n+\n+import org.gradle.internal.Pair;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+public class AvailablePortAllocator implements PortAllocator {\n+    public static final int MIN_PRIVATE_PORT = 49152;\n+    public static final int MAX_PRIVATE_PORT = 65535;\n+    public static final int DEFAULT_RANGE_SIZE = 100;\n+\n+    private final List<ReservedPortRange> reservations = new ArrayList<ReservedPortRange>();\n+\n+    private final Lock lock = new ReentrantLock();\n+\n+    private ReservedPortRangeFactory portRangeFactory = new DefaultReservedPortRangeFactory();\n+\n+    @Override\n+    public int assignPort() {\n+        try {\n+            lock.lock();\n+            return reservePort();\n+        } finally {\n+            lock.unlock();\n+        }\n+    }\n+\n+    protected Pair<Integer, Integer> getNextPortRange(int rangeNumber) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5dc49c211b48c235e25ffb65fbe8a3e4037f791"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU0NzY0Mg==", "bodyText": "From what I can tell assignePort and releasePort are never used. Is there something that needs to be still wired up?", "url": "https://github.com/elastic/elasticsearch/pull/66440#discussion_r544547642", "createdAt": "2020-12-16T19:00:34Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/util/ports/AvailablePortAllocator.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.util.ports;\n+\n+import org.gradle.internal.Pair;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+public class AvailablePortAllocator implements PortAllocator {\n+    public static final int MIN_PRIVATE_PORT = 49152;\n+    public static final int MAX_PRIVATE_PORT = 65535;\n+    public static final int DEFAULT_RANGE_SIZE = 100;\n+\n+    private final List<ReservedPortRange> reservations = new ArrayList<ReservedPortRange>();\n+\n+    private final Lock lock = new ReentrantLock();\n+\n+    private ReservedPortRangeFactory portRangeFactory = new DefaultReservedPortRangeFactory();\n+\n+    @Override\n+    public int assignPort() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5dc49c211b48c235e25ffb65fbe8a3e4037f791"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4430, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}