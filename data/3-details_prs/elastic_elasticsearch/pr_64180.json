{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMjc2NDI4", "number": 64180, "title": "Fix #invariant Assertion in CacheFile", "bodyText": "This assertion can trip pretty easily now that we made everything non-blocking. The ref count is decreased before the file is physically deleted so\nassert evicted.get() == false || refCounter.refCount() != 0 || Files.notExists(file);\nin invariant can trip when the assertion is checked before the delete on another thread has gone through but after it finished counting down the ref counter to 0.\nNot 100% sure about this one. It's a small performance hit when closing index inputs I guess (seems practically irrelevant though) but also it seems weird to add another layer of sync just to fix an assertion (otoh we already synchronize on file opening so maybe it's all good and it's nice to have the assertion I suppose).\nObvious alternative to this PR is to just drop invariant and maybe just deal with asserting that the cache is actually cleared in the end by enhancing tests to check for this in an @After hook or so", "createdAt": "2020-10-26T20:06:27Z", "url": "https://github.com/elastic/elasticsearch/pull/64180", "merged": true, "mergeCommit": {"oid": "eaac6496fc42167b382cc3081d0312f227354313"}, "closed": true, "closedAt": "2020-10-27T16:59:18Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWZ7lugH2gAyNTEwMjc2NDI4OmJiMjNjZGMxODY4MTI2ZWJiZTk0NzExMmU5YzQ5OGVhNzkyMDk0YTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW7axygFqTUxODU0MDM2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bb23cdc1868126ebbe947112e9c498ea792094a3", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb23cdc1868126ebbe947112e9c498ea792094a3", "committedDate": "2020-10-26T19:56:17Z", "message": "Fix #invariant Assertion in CacheFile\n\nWIP, just a basis for discussion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "473332b2ff8b2b40d07f1566d28cc70b83c77990", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/473332b2ff8b2b40d07f1566d28cc70b83c77990", "committedDate": "2020-10-27T13:48:57Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-cf-assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1118ad394e3892fae274b8f3a6a84b226cd2d1dc", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/1118ad394e3892fae274b8f3a6a84b226cd2d1dc", "committedDate": "2020-10-27T13:49:02Z", "message": "foo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e76b4739c315d772b943680930df2a221e5730ed", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e76b4739c315d772b943680930df2a221e5730ed", "committedDate": "2020-10-27T14:08:39Z", "message": "use ref cnt return"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08b74aaa43af2df6c942aa5f4a4972540994d4cf", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/08b74aaa43af2df6c942aa5f4a4972540994d4cf", "committedDate": "2020-10-27T14:14:42Z", "message": "moar assertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a58728bee43c44c44b21268b73e6c845e39940be", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a58728bee43c44c44b21268b73e6c845e39940be", "committedDate": "2020-10-27T14:24:34Z", "message": "moar assertions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NzY0NTg1", "url": "https://github.com/elastic/elasticsearch/pull/64180#pullrequestreview-517764585", "createdAt": "2020-10-27T14:26:17Z", "commit": {"oid": "a58728bee43c44c44b21268b73e6c845e39940be"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f2ef4bb7755332fe0a4a43295d3e01a8eb2f66", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/64f2ef4bb7755332fe0a4a43295d3e01a8eb2f66", "committedDate": "2020-10-27T14:56:34Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-cf-assertion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTQwMzY1", "url": "https://github.com/elastic/elasticsearch/pull/64180#pullrequestreview-518540365", "createdAt": "2020-10-28T10:57:13Z", "commit": {"oid": "64f2ef4bb7755332fe0a4a43295d3e01a8eb2f66"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo1NzoxM1rOHpkgDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo1NzoxM1rOHpkgDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM1MTY5NA==", "bodyText": "Can we also assert:\nassert released == false || evicted.get();\n\n?", "url": "https://github.com/elastic/elasticsearch/pull/64180#discussion_r513351694", "createdAt": "2020-10-28T10:57:13Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -191,6 +192,11 @@ private boolean assertNoPendingListeners() {\n         return true;\n     }\n \n+    private void decrementRefCount() {\n+        final boolean released = refCounter.decRef();\n+        assert released == false || Files.notExists(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64f2ef4bb7755332fe0a4a43295d3e01a8eb2f66"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 979, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}