{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MTE5MTI4", "number": 56783, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODozNjowOVrOD8mkyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMzo1ODo0M1rOD84hzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODczMTYyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "isResolved": false, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODozNjowOVrOGVpWOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMjoyNDo0OFrOGWCpRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw==", "bodyText": "Is it guaranteed that sample.cardinality is at least 1? If it was 0, then targetSampleCount would be 1 but maybe that's not what we'd wanted?", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425350713", "createdAt": "2020-05-14T18:36:09Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1NDA5MQ==", "bodyText": "Wouldn't it be easier to just take the first value found?\nboolean isTraining = random.nextDouble() <= p || sample.observed == 0;", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425354091", "createdAt": "2020-05-14T18:42:05Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, "originalCommit": {"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzMjY5Mw==", "bodyText": "@przemekwitek If cardinality was zero then we'd never encounter a doc with that class.\nHowever, @benwtrent 's suggestion also works. I'll change it to that as it seems simpler indeed.", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425632693", "createdAt": "2020-05-15T08:01:45Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, "originalCommit": {"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY2MzgyMg==", "bodyText": "Actually, as soon as I made that change the unit test we have for checking we uniformly pick samples failed. As this solution means we always pick the first value we see, we introduce a bias towards that. I'll stick to my original solution as it prevents that bias.", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425663822", "createdAt": "2020-05-15T08:59:55Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, "originalCommit": {"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTczNTA1Mg==", "bodyText": "@dimitris-athanasiou I thought it was not possible to even run a classification job if cardinality was < 2. The test talks about a cardinality of 1.", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425735052", "createdAt": "2020-05-15T11:19:56Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, "originalCommit": {"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc1Njg2NQ==", "bodyText": "It makes no difference from the perspective of the code but I'll update to use cardinality of 2 for the sake of reflecting actual conditions.", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425756865", "createdAt": "2020-05-15T12:07:46Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, "originalCommit": {"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2MzE5Mg==", "bodyText": "Also, note these are different cardinalities we're talking about. The requirement of 2 refers to \"there should be at least 2 classes\". Whereas the addressed problem arises when the cardinality of the docs belonging to a certain class is low.", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425763192", "createdAt": "2020-05-15T12:20:47Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, "originalCommit": {"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2NDc3NA==", "bodyText": "Whereas the addressed problem arises when the cardinality of the docs belonging to a certain class is low.\n\nAH! This is confusing \ud83e\udd14 . The solution as posed makes sense.", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425764774", "createdAt": "2020-05-15T12:23:58Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, "originalCommit": {"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTc2NTE5MQ==", "bodyText": "I have pushed a commit that should make the unit test clearer and more realistic.", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425765191", "createdAt": "2020-05-15T12:24:48Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality\n+        // is too low we might get a target of zero and, thus, no samples of the whole class\n+        double targetSampleCount = Math.max(1.0, samplingRatio * sample.cardinality);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM1MDcxMw=="}, "originalCommit": {"oid": "e5acbedd08f50e6462c5d5a1620d82906ddd70aa"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MTY3MzExOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMzo1ODo0M1rOGWGC2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxMzo1ODo0M1rOGWGC2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgyMDg5MQ==", "bodyText": "\"We use ensure\"\nSomething is wrong with this sentence.", "url": "https://github.com/elastic/elasticsearch/pull/56783#discussion_r425820891", "createdAt": "2020-05-15T13:58:43Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitter.java", "diffHunk": "@@ -57,9 +57,13 @@ public void process(String[] row, Runnable incrementTrainingDocs, Runnable incre\n             throw new IllegalStateException(\"Unknown class [\" + classValue + \"]; expected one of \" + classSamples.keySet());\n         }\n \n+        // We use ensure the target sample count is at least 1 as if the cardinality", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9300543b50143ec1ff26cb5fea3821fb7f1627c3"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 421, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}