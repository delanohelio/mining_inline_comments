{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwODY4Mjc4", "number": 53783, "title": "Create an annotation when a model snapshot is stored", "bodyText": "This PR creates an annotation every time a model snapshot is stored and deletes an annotation when the model snapshot is deleted.\nIt is achieved the following way:\n\nThe logic to persist annotation documents is extracted into AnnotationPersister class in a separate file.\nAnnotationPersister is used in DatafeedJob which creates annotations for delayed data\nAnnotationPersister is re-used in AutodetectResultProcessor on every new ModelSnapshot object received from C++\nJobDataDeleter is extended so that it also deletes model snapshot annotation from .ml-annotations* index\n\nPoints 1. and 2. is just refactoring.\nPoint 3. is the new behavior.\nRelates #52149", "createdAt": "2020-03-19T08:36:40Z", "url": "https://github.com/elastic/elasticsearch/pull/53783", "merged": true, "mergeCommit": {"oid": "7c5c9122a72352ecf44512f166cd282db3cf7453"}, "closed": true, "closedAt": "2020-03-30T11:57:59Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPH1wiABqjMxNDQ1ODIwMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdTrRmgFqTQwNDUxNzIwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a813e4b3c73262040e579ca8678fcd9627dfbf4", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a813e4b3c73262040e579ca8678fcd9627dfbf4", "committedDate": "2020-03-19T08:34:41Z", "message": "Create annotation on model snapshot"}, "afterCommit": {"oid": "0003ca40668408586a6dfef6689bae5c6303fe06", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/0003ca40668408586a6dfef6689bae5c6303fe06", "committedDate": "2020-03-19T08:42:31Z", "message": "Create annotation on model snapshot"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0003ca40668408586a6dfef6689bae5c6303fe06", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/0003ca40668408586a6dfef6689bae5c6303fe06", "committedDate": "2020-03-19T08:42:31Z", "message": "Create annotation on model snapshot"}, "afterCommit": {"oid": "445f405fc877c6f73b8e0688b00777b0e22f25c4", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/445f405fc877c6f73b8e0688b00777b0e22f25c4", "committedDate": "2020-03-19T13:06:05Z", "message": "Create an annotation when a model snapshot is stored"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "445f405fc877c6f73b8e0688b00777b0e22f25c4", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/445f405fc877c6f73b8e0688b00777b0e22f25c4", "committedDate": "2020-03-19T13:06:05Z", "message": "Create an annotation when a model snapshot is stored"}, "afterCommit": {"oid": "ed54e46dd7c74503ad20a7f4956f388d4b452ece", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed54e46dd7c74503ad20a7f4956f388d4b452ece", "committedDate": "2020-03-19T15:50:00Z", "message": "Create an annotation when a model snapshot is stored"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed54e46dd7c74503ad20a7f4956f388d4b452ece", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed54e46dd7c74503ad20a7f4956f388d4b452ece", "committedDate": "2020-03-19T15:50:00Z", "message": "Create an annotation when a model snapshot is stored"}, "afterCommit": {"oid": "ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e", "committedDate": "2020-03-20T10:27:59Z", "message": "Create an annotation when a model snapshot is stored"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTIyOTAz", "url": "https://github.com/elastic/elasticsearch/pull/53783#pullrequestreview-378522903", "createdAt": "2020-03-20T14:19:21Z", "commit": {"oid": "ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxOToyMlrOF5VmnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxOToyMlrOF5VmnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NzEwMQ==", "bodyText": "This still leaves open the following bug (unsure how to fix it really).\n\nNode running the job is updated\nJob gets reallocated to a new node\nJob writes annotation for a model snapshot\nThe master node is still Old, consequently never crated the annotations index\nAnnotation persistence auto-created the index and now the UI fails to read from the index.\n\nIt seems to me that we need to verify if the index exists already and create it if necessary when we write annotations.", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r395667101", "createdAt": "2020-03-20T14:19:22Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlInitializationService.java", "diffHunk": "@@ -66,7 +66,7 @@ public void clusterChanged(ClusterChangedEvent event) {\n         // The atomic flag prevents multiple simultaneous attempts to create the\n         // index if there is a flurry of cluster state updates in quick succession\n         if (event.localNodeMaster() && isIndexCreationInProgress.compareAndSet(false, true)) {\n-            AnnotationIndex.createAnnotationsIndexIfNecessary(settings, client, event.state(), ActionListener.wrap(\n+            AnnotationIndex.createAnnotationsIndexIfNecessary(client, event.state(), ActionListener.wrap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e", "committedDate": "2020-03-20T10:27:59Z", "message": "Create an annotation when a model snapshot is stored"}, "afterCommit": {"oid": "9290993a9cad16296ca4b974ed06399b91c78f3a", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/9290993a9cad16296ca4b974ed06399b91c78f3a", "committedDate": "2020-03-27T13:38:51Z", "message": "Delete annotation when model snapshot or job is deleted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9290993a9cad16296ca4b974ed06399b91c78f3a", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/9290993a9cad16296ca4b974ed06399b91c78f3a", "committedDate": "2020-03-27T13:38:51Z", "message": "Delete annotation when model snapshot or job is deleted"}, "afterCommit": {"oid": "ef1f094b708d71143640b64b15e5d98cd16efbfb", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ef1f094b708d71143640b64b15e5d98cd16efbfb", "committedDate": "2020-03-27T13:40:50Z", "message": "Delete annotation when model snapshot or job is deleted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef1f094b708d71143640b64b15e5d98cd16efbfb", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ef1f094b708d71143640b64b15e5d98cd16efbfb", "committedDate": "2020-03-27T13:40:50Z", "message": "Delete annotation when model snapshot or job is deleted"}, "afterCommit": {"oid": "968b88e864548a82b8e2e4930b8bfca1185c2666", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/968b88e864548a82b8e2e4930b8bfca1185c2666", "committedDate": "2020-03-27T13:50:23Z", "message": "Delete annotation when model snapshot or job is deleted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "968b88e864548a82b8e2e4930b8bfca1185c2666", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/968b88e864548a82b8e2e4930b8bfca1185c2666", "committedDate": "2020-03-27T13:50:23Z", "message": "Delete annotation when model snapshot or job is deleted"}, "afterCommit": {"oid": "a3445e174f7c06bc457e534c094009422acdb7ae", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a3445e174f7c06bc457e534c094009422acdb7ae", "committedDate": "2020-03-27T15:11:26Z", "message": "Delete annotation when model snapshot or job is deleted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3445e174f7c06bc457e534c094009422acdb7ae", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a3445e174f7c06bc457e534c094009422acdb7ae", "committedDate": "2020-03-27T15:11:26Z", "message": "Delete annotation when model snapshot or job is deleted"}, "afterCommit": {"oid": "ea8be292f891820b3f4f655288690ebdc35a490e", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea8be292f891820b3f4f655288690ebdc35a490e", "committedDate": "2020-03-27T15:35:38Z", "message": "Delete annotation when model snapshot or job is deleted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea8be292f891820b3f4f655288690ebdc35a490e", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea8be292f891820b3f4f655288690ebdc35a490e", "committedDate": "2020-03-27T15:35:38Z", "message": "Delete annotation when model snapshot or job is deleted"}, "afterCommit": {"oid": "c9615ca698dda9f3933cb3a05d3211378afbcf45", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9615ca698dda9f3933cb3a05d3211378afbcf45", "committedDate": "2020-03-27T15:36:59Z", "message": "Delete annotation when model snapshot or job is deleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMDExMTc2", "url": "https://github.com/elastic/elasticsearch/pull/53783#pullrequestreview-383011176", "createdAt": "2020-03-27T16:23:53Z", "commit": {"oid": "c9615ca698dda9f3933cb3a05d3211378afbcf45"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNjoyMzo1NFrOF84mrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNjoyOToxNVrOF840gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4NjI4Nw==", "bodyText": "I think it could be confusing if the annotation spans a time range.  Is it possible to set both the start and end time to be the model snapshot's timestamp?  Or does it break the UI if the start and end timestamps are identical?", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r399386287", "createdAt": "2020-03-27T16:23:54Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -310,6 +325,21 @@ void processResult(AutodetectResult result) {\n         }\n     }\n \n+    private Annotation createModelSnapshotAnnotation(ModelSnapshot modelSnapshot) {\n+        assert modelSnapshot != null;\n+        Date currentTime = new Date(clock.millis());\n+        return new Annotation(\n+            Messages.JOB_AUDIT_SNAPSHOT_STORED,\n+            currentTime,\n+            XPackUser.NAME,\n+            modelSnapshot.getTimestamp(),\n+            modelSnapshot.getLatestRecordTimeStamp(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9615ca698dda9f3933cb3a05d3211378afbcf45"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4Nzc5OQ==", "bodyText": "Can we also include the model snapshot ID, so that if somebody wants to revert to the snapshot they can get the piece of information they need in order to do this from the annotation?", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r399387799", "createdAt": "2020-03-27T16:26:15Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -310,6 +325,21 @@ void processResult(AutodetectResult result) {\n         }\n     }\n \n+    private Annotation createModelSnapshotAnnotation(ModelSnapshot modelSnapshot) {\n+        assert modelSnapshot != null;\n+        Date currentTime = new Date(clock.millis());\n+        return new Annotation(\n+            Messages.JOB_AUDIT_SNAPSHOT_STORED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9615ca698dda9f3933cb3a05d3211378afbcf45"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM4OTgyNA==", "bodyText": "I think that scenario was a problem in 6.7 and 6.8 as there were 6.x indices that didn't have the annotations index - it probably explains a few bug reports we had when the annotations index was not available as expected.  But now any rolling upgrades must be starting from 6.8 at the earliest, so the old version will have the annotations index already.", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r399389824", "createdAt": "2020-03-27T16:29:15Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlInitializationService.java", "diffHunk": "@@ -66,7 +66,7 @@ public void clusterChanged(ClusterChangedEvent event) {\n         // The atomic flag prevents multiple simultaneous attempts to create the\n         // index if there is a flurry of cluster state updates in quick succession\n         if (event.localNodeMaster() && isIndexCreationInProgress.compareAndSet(false, true)) {\n-            AnnotationIndex.createAnnotationsIndexIfNecessary(settings, client, event.state(), ActionListener.wrap(\n+            AnnotationIndex.createAnnotationsIndexIfNecessary(client, event.state(), ActionListener.wrap(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NzEwMQ=="}, "originalCommit": {"oid": "ef9fa5d7172eaac4ed71caee8c9c21f8037aa18e"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9615ca698dda9f3933cb3a05d3211378afbcf45", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9615ca698dda9f3933cb3a05d3211378afbcf45", "committedDate": "2020-03-27T15:36:59Z", "message": "Delete annotation when model snapshot or job is deleted"}, "afterCommit": {"oid": "8717e21ab767d3496ae3aa9926df96e86defb268", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/8717e21ab767d3496ae3aa9926df96e86defb268", "committedDate": "2020-03-30T06:40:06Z", "message": "Delete annotation when model snapshot or job is deleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjU0Nzc3", "url": "https://github.com/elastic/elasticsearch/pull/53783#pullrequestreview-383654777", "createdAt": "2020-03-30T08:57:56Z", "commit": {"oid": "03b0c58195ecd6928cc2a58cf13651d5df782c82"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd85302089d47b63bd2522eda3e7d44753ca93d2", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd85302089d47b63bd2522eda3e7d44753ca93d2", "committedDate": "2020-03-30T11:10:07Z", "message": "Create an annotation when a model snapshot is stored"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26a0ac4bf41871b46235fc698948e586f5861ed2", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/26a0ac4bf41871b46235fc698948e586f5861ed2", "committedDate": "2020-03-30T11:10:07Z", "message": "Delete annotation when model snapshot or job is deleted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70fbc6e73994d1fdd911b60da31fe25024b01658", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/70fbc6e73994d1fdd911b60da31fe25024b01658", "committedDate": "2020-03-30T11:10:07Z", "message": "Apply review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03b0c58195ecd6928cc2a58cf13651d5df782c82", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/03b0c58195ecd6928cc2a58cf13651d5df782c82", "committedDate": "2020-03-30T08:33:17Z", "message": "Apply review comments"}, "afterCommit": {"oid": "70fbc6e73994d1fdd911b60da31fe25024b01658", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/70fbc6e73994d1fdd911b60da31fe25024b01658", "committedDate": "2020-03-30T11:10:07Z", "message": "Apply review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTE3MjA2", "url": "https://github.com/elastic/elasticsearch/pull/53783#pullrequestreview-404517206", "createdAt": "2020-05-02T10:25:20Z", "commit": {"oid": "70fbc6e73994d1fdd911b60da31fe25024b01658"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxMDoyNToyMVrOGPiKfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxMDoyNToyMVrOGPiKfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk0MTU2NQ==", "bodyText": "I wonder if these should have been modelSnapshot.getLatestResultTimeStamp()?\nSee #56076 (comment) for more details on this.", "url": "https://github.com/elastic/elasticsearch/pull/53783#discussion_r418941565", "createdAt": "2020-05-02T10:25:21Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessorTests.java", "diffHunk": "@@ -367,6 +380,23 @@ public void testProcessResult_modelSnapshot() {\n         verify(persister).bulkPersisterBuilder(eq(JOB_ID), any());\n         verify(persister).persistModelSnapshot(eq(modelSnapshot), eq(WriteRequest.RefreshPolicy.IMMEDIATE), any());\n \n+        ArgumentCaptor<Annotation> annotationCaptor = ArgumentCaptor.forClass(Annotation.class);\n+        verify(annotationPersister).persistAnnotation(\n+            eq(ModelSnapshot.annotationDocumentId(modelSnapshot)), annotationCaptor.capture(), any());\n+        Annotation annotation = annotationCaptor.getValue();\n+        Annotation expectedAnnotation =\n+            new Annotation(\n+                \"Job model snapshot with id [a_snapshot_id] stored\",\n+                Date.from(CURRENT_TIME),\n+                XPackUser.NAME,\n+                modelSnapshot.getTimestamp(),\n+                modelSnapshot.getTimestamp(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70fbc6e73994d1fdd911b60da31fe25024b01658"}, "originalPosition": 96}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2050, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}