{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNjI1MzMw", "number": 52196, "title": "Change privilege of enrich stats API to monitor (#52027)", "bodyText": "The remote_monitoring_user user needs to access the enrich stats API.\nBut the request is denied because the API is categorized under admin.\nThe correct privilege should be monitor.\nChanging action name breaks backwards compability as the name is serialised\nand sent across the wire. Changes are made to send the old names for nodes\nof old versions (before v7.7.0) and use new names for newer versions. This helps\nv8.0 to not worry about any breaking changes and just use the new name.\nrelates: #51677", "createdAt": "2020-02-11T12:13:25Z", "url": "https://github.com/elastic/elasticsearch/pull/52196", "merged": true, "mergeCommit": {"oid": "61fa7f4d22aa94844c2511ae67c940e2232b3285"}, "closed": true, "closedAt": "2020-06-29T00:25:34Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDQxSJAFqTM1NjYxMjAyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcv1IiagH2gAyMzczNjI1MzMwOmRiMDA2NmY3NmFmYWFmN2IxNzBkYjI4Njc5ZGQzNjU1ZTQ1ZTk3YWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NjEyMDI2", "url": "https://github.com/elastic/elasticsearch/pull/52196#pullrequestreview-356612026", "createdAt": "2020-02-11T12:20:10Z", "commit": {"oid": "7f3e54a403e406e94dea27660d933d97171d5ba9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjoyMDoxMFrOFoG5qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjoyMDoxMFrOFoG5qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwMDQyNw==", "bodyText": "Add a new method to opt-in for using an old action name.", "url": "https://github.com/elastic/elasticsearch/pull/52196#discussion_r377600427", "createdAt": "2020-02-11T12:20:10Z", "author": {"login": "ywangd"}, "path": "server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java", "diffHunk": "@@ -138,6 +138,12 @@ protected void resolveRequest(NodesRequest request, ClusterState clusterState) {\n         request.setConcreteNodes(Arrays.stream(nodesIds).map(clusterState.nodes()::get).toArray(DiscoveryNode[]::new));\n     }\n \n+    /**\n+     * Get a backwards compatible transport action name\n+     */\n+    protected String getBwcTransportNodeAction(DiscoveryNode node) {\n+        return transportNodeAction;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f3e54a403e406e94dea27660d933d97171d5ba9"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NjEyODQ4", "url": "https://github.com/elastic/elasticsearch/pull/52196#pullrequestreview-356612848", "createdAt": "2020-02-11T12:21:36Z", "commit": {"oid": "325ad3cdcc1f35a47d46dca6ba9c73243b1cfa57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjoyMTozNlrOFoG8Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMjoyMTozNlrOFoG8Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwMTA5OA==", "bodyText": "Override existing methods for opt-in bwc action name.", "url": "https://github.com/elastic/elasticsearch/pull/52196#discussion_r377601098", "createdAt": "2020-02-11T12:21:36Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/TransportEnrichStatsAction.java", "diffHunk": "@@ -108,4 +110,9 @@ protected void masterOperation(\n     protected ClusterBlockException checkBlock(EnrichStatsAction.Request request, ClusterState state) {\n         return state.blocks().globalBlockedException(ClusterBlockLevel.METADATA_READ);\n     }\n+\n+    @Override\n+    protected String getMasterActionName(DiscoveryNode node) {\n+        return node.getVersion().before(Version.V_7_7_0) ? EnrichStatsAction.OLD_NAME : actionName;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "325ad3cdcc1f35a47d46dca6ba9c73243b1cfa57"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNDUwMjE5", "url": "https://github.com/elastic/elasticsearch/pull/52196#pullrequestreview-402450219", "createdAt": "2020-04-29T08:14:39Z", "commit": {"oid": "c8a0b4499ee8f27f0a1c6e923b6f96572a57f181"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwODoxNDozOVrOGN0SGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQwODoyMDoyN1rOGN0d3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MTI3NQ==", "bodyText": "I think this just should be\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected String getBwcTransportNodeAction(DiscoveryNode node) {\n          \n          \n            \n                protected String getTransportNodeAction(DiscoveryNode node) {\n          \n      \n    \n    \n  \n\nI don't think the \"BWC\" helps with the method name - it assumes that this is only relevant for BWC, but really it's \"what is the right action for this node\" ?", "url": "https://github.com/elastic/elasticsearch/pull/52196#discussion_r417141275", "createdAt": "2020-04-29T08:14:39Z", "author": {"login": "tvernum"}, "path": "server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java", "diffHunk": "@@ -138,6 +138,12 @@ protected void resolveRequest(NodesRequest request, ClusterState clusterState) {\n         request.setConcreteNodes(Arrays.stream(nodesIds).map(clusterState.nodes()::get).toArray(DiscoveryNode[]::new));\n     }\n \n+    /**\n+     * Get a backwards compatible transport action name\n+     */\n+    protected String getBwcTransportNodeAction(DiscoveryNode node) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8a0b4499ee8f27f0a1c6e923b6f96572a57f181"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MjMwMg==", "bodyText": "Also, I think this part of the change should go to master - I know you don't need it for BWC purposes there, but we shouldn't make core API changes on 7.x only.", "url": "https://github.com/elastic/elasticsearch/pull/52196#discussion_r417142302", "createdAt": "2020-04-29T08:16:42Z", "author": {"login": "tvernum"}, "path": "server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java", "diffHunk": "@@ -138,6 +138,12 @@ protected void resolveRequest(NodesRequest request, ClusterState clusterState) {\n         request.setConcreteNodes(Arrays.stream(nodesIds).map(clusterState.nodes()::get).toArray(DiscoveryNode[]::new));\n     }\n \n+    /**\n+     * Get a backwards compatible transport action name\n+     */\n+    protected String getBwcTransportNodeAction(DiscoveryNode node) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MTI3NQ=="}, "originalCommit": {"oid": "c8a0b4499ee8f27f0a1c6e923b6f96572a57f181"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0MjU4Mw==", "bodyText": "Can you add a javadoc here that it had this name in pre 7.8 versions", "url": "https://github.com/elastic/elasticsearch/pull/52196#discussion_r417142583", "createdAt": "2020-04-29T08:17:15Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/enrich/action/EnrichStatsAction.java", "diffHunk": "@@ -24,7 +24,8 @@\n public class EnrichStatsAction extends ActionType<EnrichStatsAction.Response> {\n \n     public static final EnrichStatsAction INSTANCE = new EnrichStatsAction();\n-    public static final String NAME = \"cluster:admin/xpack/enrich/stats\";\n+    public static final String NAME = \"cluster:monitor/xpack/enrich/stats\";\n+    public static final String BWC_NAME = \"cluster:admin/xpack/enrich/stats\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8a0b4499ee8f27f0a1c6e923b6f96572a57f181"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzE0NDI4Nw==", "bodyText": "This needs to update now that it's slipped.", "url": "https://github.com/elastic/elasticsearch/pull/52196#discussion_r417144287", "createdAt": "2020-04-29T08:20:27Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/EnrichCoordinatorStatsAction.java", "diffHunk": "@@ -161,6 +184,11 @@ protected NodeResponse nodeOperation(NodeRequest request) {\n             DiscoveryNode node = clusterService.localNode();\n             return new NodeResponse(node, coordinator.getStats(node.getId()));\n         }\n+\n+        @Override\n+        protected String getBwcTransportNodeAction(DiscoveryNode node) {\n+            return node.getVersion().before(Version.V_7_7_0) ? BWC_NAME + \"[n]\" : transportNodeAction;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8a0b4499ee8f27f0a1c6e923b6f96572a57f181"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fddaaf9fd9d5b51dc3d6300eb8b58f278548e4f8", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/fddaaf9fd9d5b51dc3d6300eb8b58f278548e4f8", "committedDate": "2020-06-17T06:21:13Z", "message": "Change privilege of enrich stats API to monitor (#52027)\n\nThe remote_monitoring_user user needs to access the enrich stats API.\nBut the request is denied because the API is categorized under admin.\nThe correct privilege should be monitor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe9854135c4b7df18ea825a148ba036b387db3df", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe9854135c4b7df18ea825a148ba036b387db3df", "committedDate": "2020-06-17T06:28:17Z", "message": "Add tests for changed action privileges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b9ef5e3a0f7f4b65d2b7a52b11613086bcf28e1", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b9ef5e3a0f7f4b65d2b7a52b11613086bcf28e1", "committedDate": "2020-06-17T06:28:17Z", "message": "Update tests for better names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "824aa0442f631559235c8b21200705ea0a24e3c7", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/824aa0442f631559235c8b21200705ea0a24e3c7", "committedDate": "2020-06-17T06:31:00Z", "message": "Add bwc for old action names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4feb9a3d37baec34d3db654dc07a8ac5ba864787", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/4feb9a3d37baec34d3db654dc07a8ac5ba864787", "committedDate": "2020-06-17T06:31:01Z", "message": "fix spotless error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902a03aa4e69d0435590dd1d1817cd0ca2d4dae3", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/902a03aa4e69d0435590dd1d1817cd0ca2d4dae3", "committedDate": "2020-06-17T06:31:01Z", "message": "Add smoke test for enrich stats API for mixed cluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7a883dd2c7aa3c3b2f839c272b0453caa7ba4b1", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/f7a883dd2c7aa3c3b2f839c272b0453caa7ba4b1", "committedDate": "2020-06-17T06:31:01Z", "message": "Fix bwc and add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "124455512e48d032ef481356ec5153727b527c9f", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/124455512e48d032ef481356ec5153727b527c9f", "committedDate": "2020-06-17T06:31:01Z", "message": "Fix spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d8af3acd207fe7e318a81abc9fe272740572412", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/3d8af3acd207fe7e318a81abc9fe272740572412", "committedDate": "2020-06-17T06:31:02Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a57f923bd0b6e6a7beabe828c5fef65b99492ec9", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/a57f923bd0b6e6a7beabe828c5fef65b99492ec9", "committedDate": "2020-06-17T06:31:02Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72ea69105496b7c838927ea2dfa07186c27e95b5", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/72ea69105496b7c838927ea2dfa07186c27e95b5", "committedDate": "2020-06-17T06:31:02Z", "message": "Update version selector for yaml tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b882db74344d1bcca7fa981180427f2cb50ee418", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/b882db74344d1bcca7fa981180427f2cb50ee418", "committedDate": "2020-06-17T06:32:12Z", "message": "Minor tweak"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0525f42decdd73145e65f0b45092199dd0c12e89", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/0525f42decdd73145e65f0b45092199dd0c12e89", "committedDate": "2020-05-07T05:30:23Z", "message": "Update version selector for yaml tests"}, "afterCommit": {"oid": "b882db74344d1bcca7fa981180427f2cb50ee418", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/b882db74344d1bcca7fa981180427f2cb50ee418", "committedDate": "2020-06-17T06:32:12Z", "message": "Minor tweak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c3effcfb1e5099cabcab19f978a2afae4b2f318", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c3effcfb1e5099cabcab19f978a2afae4b2f318", "committedDate": "2020-06-17T06:38:51Z", "message": "Add bwc name javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e55e883eecbb0c1f5acc031abe425e47a1619e0", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e55e883eecbb0c1f5acc031abe425e47a1619e0", "committedDate": "2020-06-17T12:38:02Z", "message": "Merge remote-tracking branch 'origin/7.x' into es-51677-enrich-stats-privilege-7.x"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MzQ2NjMz", "url": "https://github.com/elastic/elasticsearch/pull/52196#pullrequestreview-436346633", "createdAt": "2020-06-24T06:03:29Z", "commit": {"oid": "2e55e883eecbb0c1f5acc031abe425e47a1619e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MzQ2ODk3", "url": "https://github.com/elastic/elasticsearch/pull/52196#pullrequestreview-436346897", "createdAt": "2020-06-24T06:04:11Z", "commit": {"oid": "2e55e883eecbb0c1f5acc031abe425e47a1619e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNjowNDoxMVrOGoEFbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNjowNDoxMVrOGoEFbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY2MzE1MQ==", "bodyText": "Actually, is this right? This is the 7.9 backport.", "url": "https://github.com/elastic/elasticsearch/pull/52196#discussion_r444663151", "createdAt": "2020-06-24T06:04:11Z", "author": {"login": "tvernum"}, "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/mixed_cluster/110_enrich.yml", "diffHunk": "@@ -0,0 +1,13 @@\n+---\n+\"Enrich stats query smoke test for mixed cluster\":\n+  - skip:\n+      version: \" - 7.99.99\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e55e883eecbb0c1f5acc031abe425e47a1619e0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63fa8e6e60cec14e8a2b5180f01681abef013894", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/63fa8e6e60cec14e8a2b5180f01681abef013894", "committedDate": "2020-06-24T06:56:38Z", "message": "Remove redundant file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "117c4d96c910450a5cfcd25b07215d8337e586c8", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/117c4d96c910450a5cfcd25b07215d8337e586c8", "committedDate": "2020-06-24T06:57:04Z", "message": "Merge remote-tracking branch 'origin/7.x' into es-51677-enrich-stats-privilege-7.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db0066f76afaaf7b170db28679dd3655e45e97ad", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/db0066f76afaaf7b170db28679dd3655e45e97ad", "committedDate": "2020-06-28T23:34:49Z", "message": "Merge remote-tracking branch 'origin/7.x' into es-51677-enrich-stats-privilege-7.x"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2549, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}