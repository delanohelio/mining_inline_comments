{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NzE0MDMw", "number": 55349, "title": "[ML] fixing and unmuting testHRDSplit test", "bodyText": "This fixes the long muted testHRDSplit. Some minor adjustments for modern day elasticsearch changes :).\nThe cause of the failure is that a new by field entering the model with an exceptionally high count does not cause an anomaly. We have since stopped combining the rare and by in this manner. New entries in a by field are not anomalous because we have no history on them yet.\ncloses #32966", "createdAt": "2020-04-16T20:45:48Z", "url": "https://github.com/elastic/elasticsearch/pull/55349", "merged": true, "mergeCommit": {"oid": "7adbc35bbf482a5f8392fd38725bbe1ad695f5ff"}, "closed": true, "closedAt": "2020-04-17T13:04:35Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYS--6gH2gAyNDA0NzE0MDMwOmJkYTAxMTcyNjM0ZDg4YjFlYjg2YTI1ODBhOTM0OWE1N2E3NDM4ZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYgUbCAH2gAyNDA0NzE0MDMwOjk0MTM4NDJiZmI1OGRjNTZmOGI4MzkzMTczNGRhMjNmMWMxMzRkN2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bda01172634d88b1eb86a2580a9349a57a7438fe", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/bda01172634d88b1eb86a2580a9349a57a7438fe", "committedDate": "2020-04-16T20:47:21Z", "message": "[ML] fixing and unmuting testHRDSplit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "526afae86e5da4861594097aa0da4d8bf6364e8f", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/526afae86e5da4861594097aa0da4d8bf6364e8f", "committedDate": "2020-04-16T20:44:02Z", "message": "[ML] fixing and unmuting testHRDSplit test"}, "afterCommit": {"oid": "bda01172634d88b1eb86a2580a9349a57a7438fe", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/bda01172634d88b1eb86a2580a9349a57a7438fe", "committedDate": "2020-04-16T20:47:21Z", "message": "[ML] fixing and unmuting testHRDSplit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzYwOTIx", "url": "https://github.com/elastic/elasticsearch/pull/55349#pullrequestreview-395360921", "createdAt": "2020-04-17T11:02:53Z", "commit": {"oid": "bda01172634d88b1eb86a2580a9349a57a7438fe"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMTowMjo1M1rOGHJp4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMTowODozNVrOGHJzKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1MTM5Mg==", "bodyText": "This fail dates back to when the assertBusy on line 330 was an awaitBusy.  I think the whole try/catch is redundant now.", "url": "https://github.com/elastic/elasticsearch/pull/55349#discussion_r410151392", "createdAt": "2020-04-17T11:02:53Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/single-node-tests/src/test/java/org/elasticsearch/xpack/ml/transforms/PainlessDomainSplitIT.java", "diffHunk": "@@ -355,4 +366,16 @@ public void testHRDSplit() throws Exception {\n             fail(\"Anomaly records were not found within 5 seconds\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda01172634d88b1eb86a2580a9349a57a7438fe"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1MjExMg==", "bodyText": "Now that you're waiting for the job to be closed we shouldn't need to loop here.  By the time the job is closed it should have written all results it's ever going to write.", "url": "https://github.com/elastic/elasticsearch/pull/55349#discussion_r410152112", "createdAt": "2020-04-17T11:04:39Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/single-node-tests/src/test/java/org/elasticsearch/xpack/ml/transforms/PainlessDomainSplitIT.java", "diffHunk": "@@ -313,8 +310,22 @@ public void testHRDSplit() throws Exception {\n                 \"}\");\n \n         client().performRequest(createFeedRequest);\n-        client().performRequest(new Request(\"POST\", MachineLearning.BASE_PATH + \"datafeeds/hrd-split-datafeed/_start\"));\n+        Request startDatafeedRequest = new Request(\"POST\", MachineLearning.BASE_PATH + \"datafeeds/hrd-split-datafeed/_start\");\n+        startDatafeedRequest.addParameter(\"start\", baseTime.format(DateTimeFormatter.ISO_DATE_TIME));\n+        startDatafeedRequest.addParameter(\"end\", ZonedDateTime.now(ZoneOffset.UTC).format(DateTimeFormatter.ISO_DATE_TIME));\n+        client().performRequest(startDatafeedRequest);\n+        assertBusy(() -> {\n+            try {\n+                Response datafeedStatsResponse = client().performRequest(new Request(\"GET\",\n+                    MachineLearning.BASE_PATH + \"datafeeds/hrd-split-datafeed/_stats\"));\n+                assertThat(EntityUtils.toString(datafeedStatsResponse.getEntity()),\n+                    containsString(\"\\\"state\\\":\\\"stopped\\\"\"));\n+            } catch (Exception e) {\n+                throw new RuntimeException(e);\n+            }\n+        }, 60, TimeUnit.SECONDS);\n \n+        waitUntilJobIsClosed(\"hrd-split-job\");\n         try {\n             assertBusy(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda01172634d88b1eb86a2580a9349a57a7438fe"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1Mzc3MA==", "bodyText": "Now that our indices are hidden this won't be refreshing them.  The assertBusy will be masking this at the moment, but I think that should be removed and it's sometimes waiting a second unnecessarily.  We only need it to refresh .ml-anomalies-*, so might as well specify this in the refresh.", "url": "https://github.com/elastic/elasticsearch/pull/55349#discussion_r410153770", "createdAt": "2020-04-17T11:08:35Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/single-node-tests/src/test/java/org/elasticsearch/xpack/ml/transforms/PainlessDomainSplitIT.java", "diffHunk": "@@ -313,8 +310,22 @@ public void testHRDSplit() throws Exception {\n                 \"}\");\n \n         client().performRequest(createFeedRequest);\n-        client().performRequest(new Request(\"POST\", MachineLearning.BASE_PATH + \"datafeeds/hrd-split-datafeed/_start\"));\n+        Request startDatafeedRequest = new Request(\"POST\", MachineLearning.BASE_PATH + \"datafeeds/hrd-split-datafeed/_start\");\n+        startDatafeedRequest.addParameter(\"start\", baseTime.format(DateTimeFormatter.ISO_DATE_TIME));\n+        startDatafeedRequest.addParameter(\"end\", ZonedDateTime.now(ZoneOffset.UTC).format(DateTimeFormatter.ISO_DATE_TIME));\n+        client().performRequest(startDatafeedRequest);\n+        assertBusy(() -> {\n+            try {\n+                Response datafeedStatsResponse = client().performRequest(new Request(\"GET\",\n+                    MachineLearning.BASE_PATH + \"datafeeds/hrd-split-datafeed/_stats\"));\n+                assertThat(EntityUtils.toString(datafeedStatsResponse.getEntity()),\n+                    containsString(\"\\\"state\\\":\\\"stopped\\\"\"));\n+            } catch (Exception e) {\n+                throw new RuntimeException(e);\n+            }\n+        }, 60, TimeUnit.SECONDS);\n \n+        waitUntilJobIsClosed(\"hrd-split-job\");\n         try {\n             assertBusy(() -> {\n                 client().performRequest(new Request(\"POST\", \"/_refresh\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bda01172634d88b1eb86a2580a9349a57a7438fe"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35ba4fa611144f9d01d31bbb2531a1edb46ef5b7", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/35ba4fa611144f9d01d31bbb2531a1edb46ef5b7", "committedDate": "2020-04-17T11:46:39Z", "message": "fixing up test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Mzk1OTAz", "url": "https://github.com/elastic/elasticsearch/pull/55349#pullrequestreview-395395903", "createdAt": "2020-04-17T12:06:18Z", "commit": {"oid": "35ba4fa611144f9d01d31bbb2531a1edb46ef5b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9413842bfb58dc56f8b83931734da23f1c134d7a", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/9413842bfb58dc56f8b83931734da23f1c134d7a", "committedDate": "2020-04-17T12:19:32Z", "message": "Merge branch 'master' into feature/ml-fix-test-hrd-test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3256, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}