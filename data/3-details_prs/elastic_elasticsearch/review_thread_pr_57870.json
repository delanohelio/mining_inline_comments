{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNjk3OTI5", "number": 57870, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDozNzozNVrOED0IRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDozODoxMVrOED0JCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDM1MjY5OnYy", "diffSide": "RIGHT", "path": "modules/reindex/src/main/java/org/elasticsearch/index/reindex/Reindexer.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDozNzozNVrOGhDXkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNTo0NjoxNFrOGiPSSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA==", "bodyText": "According to the reindex docs, op_type is a valid argument. However it was currently not supported, as the op_type wasn't copied over from the destination index request template to the actual index requests that reindex api generates.", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r437311378", "createdAt": "2020-06-09T10:37:35Z", "author": {"login": "martijnvg"}, "path": "modules/reindex/src/main/java/org/elasticsearch/index/reindex/Reindexer.java", "diffHunk": "@@ -265,7 +266,11 @@ protected void finishHim(Exception failure, List<BulkItemResponse.Failure> index\n              */\n             index.routing(mainRequest.getDestination().routing());\n             index.setPipeline(mainRequest.getDestination().getPipeline());\n-            // OpType is synthesized from version so it is handled when we copy version above.\n+            // Only copy the op_type if it has been set to CREATE.\n+            // (INDEX is the default and UPDATE and DELETE are invalid values)\n+            if (mainRequest.getDestination().opType() == DocWriteRequest.OpType.CREATE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3OTYwOA==", "bodyText": "My previous comment is incorrect. While the op_type isn't copied over, this wasn't needed, because it was only used for enforcing that only new docs were indexed (no updates). This works, because when the version is copied over then the version() method is invoked (mainRequest.getDestination().version()), which delegates to resolveVersionDefaults(), that returns Versions.MATCH_DELETED if op_type was set to create.\nHowever with changes in the pr, the op_type is now also used to ensure that reindex can index into a data stream, so there is a reason to copy over the op_type.", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r438079608", "createdAt": "2020-06-10T12:23:16Z", "author": {"login": "martijnvg"}, "path": "modules/reindex/src/main/java/org/elasticsearch/index/reindex/Reindexer.java", "diffHunk": "@@ -265,7 +266,11 @@ protected void finishHim(Exception failure, List<BulkItemResponse.Failure> index\n              */\n             index.routing(mainRequest.getDestination().routing());\n             index.setPipeline(mainRequest.getDestination().getPipeline());\n-            // OpType is synthesized from version so it is handled when we copy version above.\n+            // Only copy the op_type if it has been set to CREATE.\n+            // (INDEX is the default and UPDATE and DELETE are invalid values)\n+            if (mainRequest.getDestination().opType() == DocWriteRequest.OpType.CREATE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA=="}, "originalCommit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0NTQ4Nw==", "bodyText": "I would be inclined to remove the comment. It seems quite natural to copy the op-type and the comment mostly explains history I think.", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r438345487", "createdAt": "2020-06-10T19:02:48Z", "author": {"login": "henningandersen"}, "path": "modules/reindex/src/main/java/org/elasticsearch/index/reindex/Reindexer.java", "diffHunk": "@@ -265,7 +266,11 @@ protected void finishHim(Exception failure, List<BulkItemResponse.Failure> index\n              */\n             index.routing(mainRequest.getDestination().routing());\n             index.setPipeline(mainRequest.getDestination().getPipeline());\n-            // OpType is synthesized from version so it is handled when we copy version above.\n+            // Only copy the op_type if it has been set to CREATE.\n+            // (INDEX is the default and UPDATE and DELETE are invalid values)\n+            if (mainRequest.getDestination().opType() == DocWriteRequest.OpType.CREATE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA=="}, "originalCommit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1NTIwOA==", "bodyText": "That is true. I will remove it and include the it in the commit message.", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r438555208", "createdAt": "2020-06-11T05:46:14Z", "author": {"login": "martijnvg"}, "path": "modules/reindex/src/main/java/org/elasticsearch/index/reindex/Reindexer.java", "diffHunk": "@@ -265,7 +266,11 @@ protected void finishHim(Exception failure, List<BulkItemResponse.Failure> index\n              */\n             index.routing(mainRequest.getDestination().routing());\n             index.setPipeline(mainRequest.getDestination().getPipeline());\n-            // OpType is synthesized from version so it is handled when we copy version above.\n+            // Only copy the op_type if it has been set to CREATE.\n+            // (INDEX is the default and UPDATE and DELETE are invalid values)\n+            if (mainRequest.getDestination().opType() == DocWriteRequest.OpType.CREATE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA=="}, "originalCommit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNDM1NDY0OnYy", "diffSide": "RIGHT", "path": "docs/reference/indices/rollover-index.asciidoc", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDozODoxMVrOGhDYzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDozODoxMVrOGhDYzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTY5NQ==", "bodyText": "This change is required for #57788, but in order to that all other changes in this pr are needed.", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r437311695", "createdAt": "2020-06-09T10:38:11Z", "author": {"login": "martijnvg"}, "path": "docs/reference/indices/rollover-index.asciidoc", "diffHunk": "@@ -254,7 +254,7 @@ POST /my-data-stream/_rollover <2>\n --------------------------------------------------\n // TEST[continued]\n // TEST[setup:huge_twitter]\n-// TEST[s/# Add > 1000 documents to my-data-stream/POST _reindex?refresh\\n{\"source\":{\"index\":\"twitter\"},\"dest\":{\"index\":\".ds-my-data-stream-000001\"}}/]\n+// TEST[s/# Add > 1000 documents to my-data-stream/POST _reindex?refresh\\n{\"source\":{\"index\":\"twitter\"},\"dest\":{\"index\":\"my-data-stream\",\"op_type\":\"create\"}}/]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1731, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}