{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2ODkzMDgy", "number": 63945, "title": "Distinguish between simple matches with and without the terms index", "bodyText": "We currently use TextSearchInfo to let query parsers know when a field\nwill support match queries.  Some field types (numeric, constant, range)\ncan produce simple match queries that don't use the terms index, and\nit is useful to distinguish between these fields on the one hand and\nkeyword/text-type fields on the other.  In particular, the\nSignificantTextAggregation only works on fields that have indexed terms,\nbut there is currently no efficient way to see this at search time and so\nthe factory falls back on checking to see if an index analyzer has been\ndefined, with the result that some nonsensical field types are permitted.\nThis commit adds a new static TextSearchInfo implementation called\nSIMPLE_MATCH_WITHOUT_TERMS that can be returned by field\ntypes with no corresponding terms index.  It changes significant text\nto check for this rather than for the presence of an index analyzer.\nThis is a breaking change, in that the significant text agg will now throw\nan error up-front if you try and apply it to a numeric field, whereas before\nyou would get an empty result.", "createdAt": "2020-10-20T15:14:22Z", "url": "https://github.com/elastic/elasticsearch/pull/63945", "merged": true, "mergeCommit": {"oid": "4191c72baf517d793405c89b5e9645ecb1e5dde1"}, "closed": true, "closedAt": "2020-10-27T12:07:51Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUaK8EAH2gAyNTA2ODkzMDgyOjVlMGMxZGQwNGJmODJjZjhiNTBjNzVmNzY0OTQ5NDAwODBjYTI2OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWmvCEAH2gAyNTA2ODkzMDgyOjExZmM5ZDQ5NzY4N2ZkOGRmMTRlYzE1YzEzMjIwMWYzOGQwN2Q4MTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5e0c1dd04bf82cf8b50c75f76494940080ca2691", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/5e0c1dd04bf82cf8b50c75f76494940080ca2691", "committedDate": "2020-10-20T15:05:12Z", "message": "Distinguish between simple matches with and without the terms index"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "172c80336c5d8d5e05dfe61ded8e85b28cb5770d", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/172c80336c5d8d5e05dfe61ded8e85b28cb5770d", "committedDate": "2020-10-20T17:13:45Z", "message": "test should use text field, not long..."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDYyNzc0", "url": "https://github.com/elastic/elasticsearch/pull/63945#pullrequestreview-513062774", "createdAt": "2020-10-20T19:26:48Z", "commit": {"oid": "172c80336c5d8d5e05dfe61ded8e85b28cb5770d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2037bfce2afeb52b06423b92872599be1170ad7", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2037bfce2afeb52b06423b92872599be1170ad7", "committedDate": "2020-10-21T08:32:16Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/numericsearchinfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/807bae1c7942cdeb8dfc1ab9099a25cdf840a249", "committedDate": "2020-10-21T08:34:34Z", "message": "sigterms test should not try and use sigtext agg because it indexes longs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNTA2Njc1", "url": "https://github.com/elastic/elasticsearch/pull/63945#pullrequestreview-513506675", "createdAt": "2020-10-21T09:57:48Z", "commit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwOTo1Nzo0OFrOHlj9zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMDowMzoyMFrOHlkK8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0ODYyMQ==", "bodyText": "don't we lose coverage with these changes?", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509148621", "createdAt": "2020-10-21T09:57:48Z", "author": {"login": "javanna"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/search/aggregations/bucket/SignificantTermsSignificanceScoreIT.java", "diffHunk": "@@ -590,11 +578,7 @@ public void testScriptCaching() throws Exception {\n                 .getMissCount(), equalTo(1L));\n \n         // Ensure that non-scripted requests are cached as normal\n-        if (useSigText) {\n-            r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantText(\"foo\", \"s\")).get();\n-        } else {\n-            r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantTerms(\"foo\").field(\"s\")).get();\n-        }\n+        r = client().prepareSearch(\"cache_test_idx\").setSize(0).addAggregation(significantTerms(\"foo\").field(\"s\")).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MDEzMw==", "bodyText": "This seems to have slipped when I double checked all the mappers, maybe it does not have a test so we don't enforce its consistency.", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509150133", "createdAt": "2020-10-21T10:00:19Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/VersionFieldMapper.java", "diffHunk": "@@ -42,7 +42,7 @@\n         public static final VersionFieldType INSTANCE = new VersionFieldType();\n \n         private VersionFieldType() {\n-            super(NAME, false, false, true, TextSearchInfo.SIMPLE_MATCH_ONLY, Collections.emptyMap());\n+            super(NAME, false, false, true, TextSearchInfo.NONE, Collections.emptyMap());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE1MTk4NA==", "bodyText": "should it be return ft.getTextSearchInfo != NONE && gt.getTextSearchIngo != SIMPLE_MATCH_WITHOUT_TERMS ?", "url": "https://github.com/elastic/elasticsearch/pull/63945#discussion_r509151984", "createdAt": "2020-10-21T10:03:20Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorFactory.java", "diffHunk": "@@ -98,6 +99,13 @@ public SignificantTextAggregatorFactory(String name,\n         this.significanceHeuristic = significanceHeuristic;\n     }\n \n+    private static boolean supportsAgg(MappedFieldType ft) {\n+        if (ft.getTextSearchInfo() == TextSearchInfo.NONE) {\n+            return false;\n+        }\n+        return ft.getTextSearchInfo() != TextSearchInfo.SIMPLE_MATCH_WITHOUT_TERMS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807bae1c7942cdeb8dfc1ab9099a25cdf840a249"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f81fbed3c12f3b47ff5c6039cb0cae5dae6d19d", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f81fbed3c12f3b47ff5c6039cb0cae5dae6d19d", "committedDate": "2020-10-21T10:19:03Z", "message": "Revert \"sigterms test should not try and use sigtext agg because it indexes longs\"\n\nThis reverts commit 807bae1c7942cdeb8dfc1ab9099a25cdf840a249."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8714356399c179341467ee272c3a21a289029fcd", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/8714356399c179341467ee272c3a21a289029fcd", "committedDate": "2020-10-21T10:22:53Z", "message": "keep test coverage; simplify support test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzODQ5NTg0", "url": "https://github.com/elastic/elasticsearch/pull/63945#pullrequestreview-513849584", "createdAt": "2020-10-21T16:01:27Z", "commit": {"oid": "8714356399c179341467ee272c3a21a289029fcd"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6adf89ec66416710cf842ca09c5c4e6645b8b44e", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/6adf89ec66416710cf842ca09c5c4e6645b8b44e", "committedDate": "2020-10-26T16:10:52Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/numericsearchinfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11fc9d497687fd8df14ec15c132201f38d07d810", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/11fc9d497687fd8df14ec15c132201f38d07d810", "committedDate": "2020-10-27T10:51:20Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/numericsearchinfo"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1207, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}