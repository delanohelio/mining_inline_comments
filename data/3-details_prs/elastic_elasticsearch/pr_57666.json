{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3ODM0OTA2", "number": 57666, "title": "MappedFieldType should not extend FieldType", "bodyText": "MappedFieldType is a combination of two concerns:\n\nan extension of lucene's FieldType, defining how a field should be indexed\na set of query factory methods, defining how a field should be searched\n\nWe want to break these two concerns apart.  This commit is a first step to doing this, breaking\nthe inheritance relationship between MappedFieldType and FieldType.  MappedFieldType instead\nhas a series of boolean flags defining whether or not the field is searchable or aggregatable,\nand FieldMapper has a separate FieldType passed to its constructor defining how indexing\nshould be done.\nRelates to #56814", "createdAt": "2020-06-04T13:22:10Z", "url": "https://github.com/elastic/elasticsearch/pull/57666", "merged": true, "mergeCommit": {"oid": "3b696828ada5953bb1669b972a353736383edf08"}, "closed": true, "closedAt": "2020-06-15T16:47:16Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnqQTegH2gAyNDI3ODM0OTA2OjIzYTM1ZWIzOTQyZGJmZTkxNzE2MTY4OTEyOTA5NzhlMWRhNjE0M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrmVVJgFqTQzMDk1Mzk1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "23a35eb3942dbfe9171616891290978e1da6143d", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/23a35eb3942dbfe9171616891290978e1da6143d", "committedDate": "2020-06-03T14:22:57Z", "message": "Cut 1: /server compiles, mapping tests pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9", "committedDate": "2020-06-04T13:16:58Z", "message": "server/ tests passing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDU1OTAz", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-424455903", "createdAt": "2020-06-04T13:36:36Z", "commit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzozNjozN1rOGfGEmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzo0MTozNFrOGfGYBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1ODUyMA==", "bodyText": "I super hate all of these instanceofs!", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435258520", "createdAt": "2020-06-04T13:36:37Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java", "diffHunk": "@@ -179,7 +179,7 @@ private static Analyzer getAnalyzer(AnalyzeAction.Request request, AnalysisRegis\n             }\n             MappedFieldType fieldType = indexService.mapperService().fieldType(request.field());\n             if (fieldType != null) {\n-                if (fieldType.tokenized() || fieldType instanceof KeywordFieldMapper.KeywordFieldType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1ODYwNQ==", "bodyText": "But you are making it better.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435258605", "createdAt": "2020-06-04T13:36:44Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java", "diffHunk": "@@ -179,7 +179,7 @@ private static Analyzer getAnalyzer(AnalyzeAction.Request request, AnalysisRegis\n             }\n             MappedFieldType fieldType = indexService.mapperService().fieldType(request.field());\n             if (fieldType != null) {\n-                if (fieldType.tokenized() || fieldType instanceof KeywordFieldMapper.KeywordFieldType) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1ODUyMA=="}, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1OTcyOQ==", "bodyText": "\u2764\ufe0f", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435259729", "createdAt": "2020-06-04T13:37:51Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -54,52 +52,45 @@\n \n import java.io.IOException;\n import java.time.ZoneId;\n-import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.Objects;\n \n /**\n  * This defines the core properties and functions to operate on a field.\n  */\n-public abstract class MappedFieldType extends FieldType {\n+public abstract class MappedFieldType {\n \n-    private String name;\n+    private final String name;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI2MTI3Ng==", "bodyText": "I've always been a fan of if (o == null || getClass() != o.getClass()) for this. Every equals implementation is ugly, but at least mine bails early if the subtypes don't line up.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435261276", "createdAt": "2020-06-04T13:39:21Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -130,7 +121,9 @@ public ValuesSourceType getValuesSourceType() {\n \n     @Override\n     public boolean equals(Object o) {\n-        if (!super.equals(o)) return false;\n+        if (o instanceof MappedFieldType == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI2MzQ5NA==", "bodyText": "Could Mapper has a method that returns null if it isn't a FieldMapper?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435263494", "createdAt": "2020-06-04T13:41:34Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -166,6 +167,17 @@ public DocumentMapperParser documentMapperParser() {\n         return this.documentParser;\n     }\n \n+    public FieldType getLuceneFieldType(String field) {\n+        Mapper mapper = documentMapper().mappers().getMapper(field);\n+        if (mapper == null) {\n+            return null;\n+        }\n+        if (mapper instanceof FieldMapper == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDYzNzYz", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-424463763", "createdAt": "2020-06-04T13:44:38Z", "commit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzo0NDozOFrOGfGkNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzo0NDozOFrOGfGkNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI2NjYxNQ==", "bodyText": "Maybe just run the formatter on the method declaration while you are here. It isn't really my favorite formatter, but we're going to hit the whole code base with it eventually.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435266615", "createdAt": "2020-06-04T13:44:38Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/LegacyGeoShapeFieldMapper.java", "diffHunk": "@@ -441,11 +420,11 @@ public PrefixTreeStrategy resolvePrefixTreeStrategy(String strategyName) {\n         }\n     }\n \n-    public LegacyGeoShapeFieldMapper(String simpleName, MappedFieldType fieldType, MappedFieldType defaultFieldType,\n-                               Explicit<Boolean> ignoreMalformed, Explicit<Boolean> coerce, Explicit<Orientation> orientation,\n-                               Explicit<Boolean> ignoreZValue, Settings indexSettings,\n-                               MultiFields multiFields, CopyTo copyTo) {\n-        super(simpleName, fieldType, defaultFieldType, ignoreMalformed, coerce, ignoreZValue, orientation, indexSettings,\n+    public LegacyGeoShapeFieldMapper(String simpleName, FieldType fieldType, MappedFieldType mappedFieldType,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 202}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDQyODQw", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-424442840", "createdAt": "2020-06-04T13:28:53Z", "commit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzoyODo1M1rOGfFvtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzo1MzoxOVrOGfHFtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1MzE3NQ==", "bodyText": "The fact that we only have a single type helps simplify a lot here", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435253175", "createdAt": "2020-06-04T13:28:53Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -56,66 +55,46 @@\n         Setting.boolSetting(\"index.mapping.ignore_malformed\", false, Property.IndexScope);\n     public static final Setting<Boolean> COERCE_SETTING =\n         Setting.boolSetting(\"index.mapping.coerce\", false, Property.IndexScope);\n-    public abstract static class Builder<T extends Builder> extends Mapper.Builder<T> {\n+    public abstract static class Builder<T extends Builder<T>> extends Mapper.Builder<T> {\n \n-        protected final MappedFieldType fieldType;\n-        protected final MappedFieldType defaultFieldType;\n-        private final IndexOptions defaultOptions;\n+        protected final FieldType fieldType;\n         protected boolean omitNormsSet = false;\n         protected boolean indexOptionsSet = false;\n-        protected boolean docValuesSet = false;\n+        protected boolean hasDocValues = true;\n+        protected boolean indexed = true;\n         protected final MultiFields.Builder multiFieldsBuilder;\n         protected CopyTo copyTo = CopyTo.empty();\n-\n-        protected Builder(String name, MappedFieldType fieldType, MappedFieldType defaultFieldType) {\n+        protected float boost = 1.0f;\n+        protected Map<String, String> meta = Collections.emptyMap();\n+        // TODO move to KeywordFieldMapper.Builder\n+        protected boolean eagerGlobalOrdinals;\n+        // TODO move to text-specific builder base class\n+        protected NamedAnalyzer indexAnalyzer;\n+        protected NamedAnalyzer searchAnalyzer;\n+        protected NamedAnalyzer searchQuoteAnalyzer;\n+        protected SimilarityProvider similarity;\n+\n+        protected Builder(String name, FieldType fieldType) {\n             super(name);\n-            this.fieldType = fieldType.clone();\n-            this.defaultFieldType = defaultFieldType.clone();\n-            this.defaultOptions = fieldType.indexOptions(); // we have to store it the fieldType is mutable\n-            this.docValuesSet = fieldType.hasDocValues();\n+            this.fieldType = new FieldType(fieldType);\n             multiFieldsBuilder = new MultiFields.Builder();\n         }\n \n-        public MappedFieldType fieldType() {\n-            return fieldType;\n-        }\n-\n         public T index(boolean index) {\n-            if (index) {\n-                if (fieldType.indexOptions() == IndexOptions.NONE) {\n-                    /*\n-                     * the logic here is to reset to the default options only if we are not indexed ie. options are null\n-                     * if the fieldType has a non-null option we are all good it might have been set through a different\n-                     * call.\n-                     */\n-                    IndexOptions options = getDefaultIndexOption();\n-                    if (options == IndexOptions.NONE) {\n-                        // can happen when an existing type on the same index has disabled indexing\n-                        // since we inherit the default field type from the first mapper that is\n-                        // created on an index\n-                        throw new IllegalArgumentException(\"mapper [\" + name + \"] has different [index] values from other types\"\n-                            + \" of the same index\");\n-                    }\n-                    fieldType.setIndexOptions(options);\n-                }\n-            } else {\n-                fieldType.setIndexOptions(IndexOptions.NONE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1Njk5Nw==", "bodyText": "We have a few places that were doing instanceof checks on lucene IndexableField fieldtypes - this allows us to continue doing those for now, as we can instead do an instanceof check for KeywordField", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435256997", "createdAt": "2020-06-04T13:34:26Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/KeywordFieldMapper.java", "diffHunk": "@@ -72,23 +75,36 @@\n \n         public static final String NULL_VALUE = null;\n         public static final int IGNORE_ABOVE = Integer.MAX_VALUE;\n+        public static final boolean EAGER_GLOBAL_ORDINALS = false;\n+        public static final boolean SPLIT_QUERIES_ON_WHITESPACE = false;\n+    }\n+\n+    public static class KeywordField extends Field {\n+\n+        public KeywordField(String field, BytesRef term, FieldType ft) {\n+            super(field, term, ft);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI1ODQ2OQ==", "bodyText": "nullValue and nullValueAsString are now dealt with directly by FieldMappers that require it", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435258469", "createdAt": "2020-06-04T13:36:32Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -54,52 +52,45 @@\n \n import java.io.IOException;\n import java.time.ZoneId;\n-import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.Objects;\n \n /**\n  * This defines the core properties and functions to operate on a field.\n  */\n-public abstract class MappedFieldType extends FieldType {\n+public abstract class MappedFieldType {\n \n-    private String name;\n+    private final String name;\n+    private final boolean docValues;\n+    private final boolean isSearchable;\n     private float boost;\n-    // TODO: remove this docvalues flag and use docValuesType\n-    private boolean docValues;\n     private NamedAnalyzer indexAnalyzer;\n     private NamedAnalyzer searchAnalyzer;\n     private NamedAnalyzer searchQuoteAnalyzer;\n     private SimilarityProvider similarity;\n-    private Object nullValue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI2MTA3NQ==", "bodyText": "This is a bit of an unfortunate hack - there are still places that require access directly to the lucene field type, particularly in the highlighter code.  They can almost certainly be refactored to use either information from the MappedFieldType or from the Mapper, but this PR is big enough already.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435261075", "createdAt": "2020-06-04T13:39:10Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -166,6 +167,17 @@ public DocumentMapperParser documentMapperParser() {\n         return this.documentParser;\n     }\n \n+    public FieldType getLuceneFieldType(String field) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI2Nzc0NA==", "bodyText": "Formatter and Resolution are non-modifiable, so the tests on DateFieldMapperTests replace these bits", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435267744", "createdAt": "2020-06-04T13:45:45Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DateFieldTypeTests.java", "diffHunk": "@@ -53,67 +51,46 @@\n import org.elasticsearch.index.query.QueryRewriteContext;\n import org.elasticsearch.index.query.QueryShardContext;\n import org.joda.time.DateTimeZone;\n-import org.junit.Before;\n \n import java.io.IOException;\n import java.time.Instant;\n import java.time.ZoneOffset;\n+import java.util.Collections;\n+import java.util.Map;\n \n public class DateFieldTypeTests extends FieldTypeTestCase<DateFieldType> {\n-    @Override\n-    protected DateFieldType createDefaultFieldType() {\n-        return new DateFieldType();\n-    }\n \n-    @Before", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI2OTgxMg==", "bodyText": "This ends up making this TODO official", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435269812", "createdAt": "2020-06-04T13:47:42Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorTests.java", "diffHunk": "@@ -76,10 +77,7 @@ protected AggregationBuilder createAggBuilderForTypeTest(MappedFieldType fieldTy\n     @Override\n     protected List<ValuesSourceType> getSupportedValuesSourceTypes() {\n         // TODO it is likely accidental that SigText supports anything other than Bytes, and then only text fields\n-        return List.of(CoreValuesSourceType.NUMERIC,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI3MTE1OQ==", "bodyText": "So it turns out that these tests didn't test what they thought they were testing, and the functionality they should have been testing for is broken.  I opened #57651 to deal with them separately.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435271159", "createdAt": "2020-06-04T13:48:58Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/range/DateRangeAggregatorTests.java", "diffHunk": "@@ -70,6 +71,7 @@ public void testNoMatchingField() throws IOException {\n         });\n     }\n \n+    @AwaitsFix(bugUrl=\"https://github.com/elastic/elasticsearch/issues/57651\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI3NTE5MA==", "bodyText": "This is a bit slow, unfortunately - the idea is to check that serializing a mapper and then using it as a merge input always ends up with the same mapper, for each possible modification.  But we need a new MapperService for each test, because some modifications are unmergeable.  And that means we have to rebuild a whole new index each time, so that we load mappers from plugins, etc.  Which is slow.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435275190", "createdAt": "2020-06-04T13:53:19Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/FieldMapperTestCase.java", "diffHunk": "@@ -205,4 +203,47 @@ protected String contentType() {\n         }\n     }\n \n+    public void testSerialization() throws IOException {\n+        for (Modifier modifier : modifiers) {\n+            if (unsupportedProperties().contains(modifier.property)) {\n+                continue;\n+            }\n+            T builder1 = newBuilder();\n+            T builder2 = newBuilder();\n+            modifier.apply(builder1, builder2);\n+            assertSerializes(modifier.property + \"-a\", builder1);\n+            assertSerializes(modifier.property + \"-b\", builder2);\n+        }\n+    }\n+\n+    protected Settings getIndexMapperSettings() {\n+        return Settings.EMPTY;\n+    }\n+\n+    protected void assertSerializes(String indexname, T builder) throws IOException {\n+\n+        // TODO can we do this without building an entire index?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 146}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b18c1b9d3d06fe90cb5f1cd7fc7ef86a0ba7fbb0", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/b18c1b9d3d06fe90cb5f1cd7fc7ef86a0ba7fbb0", "committedDate": "2020-06-04T16:09:57Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/fieldtype"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "344520bd33727e47c326bcd1a8e7dc368a40d4f6", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/344520bd33727e47c326bcd1a8e7dc368a40d4f6", "committedDate": "2020-06-07T15:41:29Z", "message": "compilation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b26fd8007e3339fa8e1c7dc82eaaad8188a55ea9", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/b26fd8007e3339fa8e1c7dc82eaaad8188a55ea9", "committedDate": "2020-06-07T15:43:20Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/fieldtype"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f331482137dede869b42de5efd8152f685377a5b", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/f331482137dede869b42de5efd8152f685377a5b", "committedDate": "2020-06-08T11:01:00Z", "message": "mapper-extras, analytics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a146b6fb63296215ed24565aa662ef25aaf3eb94", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a146b6fb63296215ed24565aa662ef25aaf3eb94", "committedDate": "2020-06-08T12:57:02Z", "message": "percolator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc791057092db6f8dd9744ee18586fe6f143521e", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/fc791057092db6f8dd9744ee18586fe6f143521e", "committedDate": "2020-06-08T14:57:00Z", "message": "server integtests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3772c31f8f5513c6a2549532ffa1d39b905fe23f", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/3772c31f8f5513c6a2549532ffa1d39b905fe23f", "committedDate": "2020-06-08T15:02:50Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb8a244e084ce34f83d6d94fcc8ec0fcc2fad9e1", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb8a244e084ce34f83d6d94fcc8ec0fcc2fad9e1", "committedDate": "2020-06-08T16:55:15Z", "message": "flattened; precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e6ce42d7ab85044fb2fe0aa23ffb18c85c1e222", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/5e6ce42d7ab85044fb2fe0aa23ffb18c85c1e222", "committedDate": "2020-06-09T10:07:14Z", "message": "tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTk0ODU5", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-426994859", "createdAt": "2020-06-09T10:14:07Z", "commit": {"oid": "5e6ce42d7ab85044fb2fe0aa23ffb18c85c1e222"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoxNDowN1rOGhCm0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDoxNDowN1rOGhCm0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5ODg5OA==", "bodyText": "How hard would it be to get rid of FieldType here? It's a bit annoying because usually there isn't a single FieldType that applies, e.g. numeric fields leverage both points and numeric doc values, but it's impossible to configure both on a FieldType, which is why we create different Fields for points and doc values.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r437298898", "createdAt": "2020-06-09T10:14:07Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -210,44 +189,30 @@ protected boolean defaultDocValues(Version indexCreated) {\n             return fieldType.tokenized() == false;\n         }\n \n-        protected void setupFieldType(BuilderContext context) {\n-            fieldType.setName(buildFullName(context));\n-            if (fieldType.indexAnalyzer() == null && fieldType.tokenized() == false && fieldType.indexOptions() != IndexOptions.NONE) {\n-                fieldType.setIndexAnalyzer(Lucene.KEYWORD_ANALYZER);\n-                fieldType.setSearchAnalyzer(Lucene.KEYWORD_ANALYZER);\n-            }\n-            boolean defaultDocValues = defaultDocValues(context.indexCreatedVersion());\n-            defaultFieldType.setHasDocValues(defaultDocValues);\n-            if (docValuesSet == false) {\n-                fieldType.setHasDocValues(defaultDocValues);\n-            }\n-        }\n-\n         /** Set metadata on this field. */\n         public T meta(Map<String, String> meta) {\n-            fieldType.setMeta(meta);\n+            this.meta = meta;\n             return (T) this;\n         }\n     }\n \n     protected final Version indexCreatedVersion;\n-    protected MappedFieldType fieldType;\n-    protected final MappedFieldType defaultFieldType;\n+    protected FieldType fieldType;\n+    protected MappedFieldType mappedFieldType;\n     protected MultiFields multiFields;\n     protected CopyTo copyTo;\n \n-    protected FieldMapper(String simpleName, MappedFieldType fieldType, MappedFieldType defaultFieldType,\n+    protected FieldMapper(String simpleName, FieldType fieldType, MappedFieldType mappedFieldType,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e6ce42d7ab85044fb2fe0aa23ffb18c85c1e222"}, "originalPosition": 174}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50d43a636d269424182d2bc57145caf1c3a7113d", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/50d43a636d269424182d2bc57145caf1c3a7113d", "committedDate": "2020-06-09T12:56:19Z", "message": "tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b6ebdf17c33579543352352c555f0822e56f8f9", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b6ebdf17c33579543352352c555f0822e56f8f9", "committedDate": "2020-06-09T14:19:45Z", "message": "tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f71d49e499536de1e9f7bc2f30a6b8716e4b9852", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/f71d49e499536de1e9f7bc2f30a6b8716e4b9852", "committedDate": "2020-06-09T14:22:24Z", "message": "line length"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5bbeeec9472d9da5d6938eb34f9c1d403e92e30", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5bbeeec9472d9da5d6938eb34f9c1d403e92e30", "committedDate": "2020-06-09T15:48:16Z", "message": "moar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39468c05f069405b2e0a04e1496d8dc19f14f114", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/39468c05f069405b2e0a04e1496d8dc19f14f114", "committedDate": "2020-06-09T16:10:57Z", "message": "murmur3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6816f5fad17866b747508d77b77198abe12a5f90", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/6816f5fad17866b747508d77b77198abe12a5f90", "committedDate": "2020-06-09T17:28:42Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/fieldtype"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9e36a7132e0dedcdf0eac637dc1ea11a312c5b8", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a9e36a7132e0dedcdf0eac637dc1ea11a312c5b8", "committedDate": "2020-06-10T09:12:40Z", "message": "percolator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/f97840e27eb50236c2f82b64855ccb87e67d61c1", "committedDate": "2020-06-15T09:10:13Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/fieldtype"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NTM2OTk3", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-424536997", "createdAt": "2020-06-04T14:56:37Z", "commit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNDo1NjozN1rOGfKEoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDoxNjowNVrOGjr-5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTMyNDA2NA==", "bodyText": "maybe as a follow-up we'll want to rename this, I assume that the reason why its name ends with FieldType is that it extended FieldType.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r435324064", "createdAt": "2020-06-04T14:56:37Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -54,52 +52,45 @@\n \n import java.io.IOException;\n import java.time.ZoneId;\n-import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n import java.util.Objects;\n \n /**\n  * This defines the core properties and functions to operate on a field.\n  */\n-public abstract class MappedFieldType extends FieldType {\n+public abstract class MappedFieldType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MDA2Mg==", "bodyText": "intuitively, this has been replaced by the newly added docValuesByDefault method ? But why doesn't indexedByDefault also replace the index options bit above?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440050062", "createdAt": "2020-06-15T09:34:00Z", "author": {"login": "javanna"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeaturesFieldMapper.java", "diffHunk": "@@ -41,12 +42,11 @@\n     public static final String CONTENT_TYPE = \"rank_features\";\n \n     public static class Defaults {\n-        public static final MappedFieldType FIELD_TYPE = new RankFeaturesFieldType();\n+        public static final FieldType FIELD_TYPE = new FieldType();\n \n         static {\n             FIELD_TYPE.setTokenized(false);\n             FIELD_TYPE.setIndexOptions(IndexOptions.NONE);\n-            FIELD_TYPE.setHasDocValues(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MTI0Nw==", "bodyText": "I got lost on where this error was returned before, can you help me out?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440051247", "createdAt": "2020-06-15T09:36:06Z", "author": {"login": "javanna"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeaturesFieldMapper.java", "diffHunk": "@@ -55,35 +55,37 @@\n     public static class Builder extends FieldMapper.Builder<Builder> {\n \n         public Builder(String name) {\n-            super(name, Defaults.FIELD_TYPE, Defaults.FIELD_TYPE);\n+            super(name, Defaults.FIELD_TYPE);\n             builder = this;\n         }\n \n         @Override\n-        public RankFeaturesFieldType fieldType() {\n-            return (RankFeaturesFieldType) super.fieldType();\n+        public Builder docValues(boolean docValues) {\n+            if (docValues) {\n+                throw new IllegalArgumentException(\"mapper [\" + name() + \"] of type [rank_features] does not support doc values\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2MTY0OQ==", "bodyText": "for my info, are these newly introduced checks or were they just moved?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440061649", "createdAt": "2020-06-15T09:53:52Z", "author": {"login": "javanna"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/TokenCountFieldMapper.java", "diffHunk": "@@ -202,8 +212,14 @@ protected String contentType() {\n \n     @Override\n     protected void mergeOptions(FieldMapper other, List<String> conflicts) {\n-        this.analyzer = ((TokenCountFieldMapper) other).analyzer;\n-        this.enablePositionIncrements = ((TokenCountFieldMapper) other).enablePositionIncrements;\n+        // TODO we should ban updating analyzers as well\n+        if (this.enablePositionIncrements != ((TokenCountFieldMapper)other).enablePositionIncrements) {\n+            conflicts.add(\"mapper [\" + name() + \"] has a different [enable_position_increments] setting\");\n+        }\n+        if (Objects.equals(this.nullValue, ((TokenCountFieldMapper)other).nullValue) == false) {\n+            conflicts.add(\"mapper [\" + name() + \"] has a different [null_value] setting\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3Mzk1OA==", "bodyText": "I find this confusing given that soon we'll have searchable fields that are not indexed. Should we rather rename it to failIfNotSearchable ? And the error message? Or maybe isSearchable should rather be isIndexed ?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440073958", "createdAt": "2020-06-15T10:16:05Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -378,7 +342,7 @@ protected final void failIfNoDocValues() {\n     }\n \n     protected final void failIfNotIndexed() {\n-        if (indexOptions() == IndexOptions.NONE && pointDimensionCount() == 0) {\n+        if (isSearchable == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 209}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4Njk2MTgz", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-428696183", "createdAt": "2020-06-11T08:24:37Z", "commit": {"oid": "a9e36a7132e0dedcdf0eac637dc1ea11a312c5b8"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwODoyNDozN1rOGiTcDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMjoxNToxNlrOGjvk8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYyMzI0NQ==", "bodyText": "+1 to check classes directly instead of using instanceof, I expect that MappedFieldType instances should never be considered equal if they are different implementations?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r438623245", "createdAt": "2020-06-11T08:24:37Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -130,7 +121,9 @@ public ValuesSourceType getValuesSourceType() {\n \n     @Override\n     public boolean equals(Object o) {\n-        if (!super.equals(o)) return false;\n+        if (o instanceof MappedFieldType == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI2MTI3Ng=="}, "originalCommit": {"oid": "ac2cc4a58982e13e8758cf8c6e8cb6bec76e18b9"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzMjg0OQ==", "bodyText": "Am I correct that these methods are only used for serialization? Should we also rely on these default for parsing?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440132849", "createdAt": "2020-06-15T12:15:16Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -431,6 +398,18 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         return builder.endObject();\n     }\n \n+    protected boolean indexedByDefault() {\n+        return true;\n+    }\n+\n+    protected boolean docValuesByDefault() {\n+        return true;\n+    }\n+\n+    protected boolean storedByDefault() {\n+        return false;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 299}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd0e5e16a3679b46f31d285307e3c8e84e4827f6", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd0e5e16a3679b46f31d285307e3c8e84e4827f6", "committedDate": "2020-06-15T13:53:23Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/0ac318dbcf7a767e370e8a36417dcc22796ede0c", "committedDate": "2020-06-15T14:16:56Z", "message": "null check for booleans"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjc2OTg5", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430676989", "createdAt": "2020-06-15T14:06:01Z", "commit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNDowNjowMVrOGjzuMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNDoyODozNFrOGj0sbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIwMDc1NA==", "bodyText": "This is so much better!", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440200754", "createdAt": "2020-06-15T14:06:01Z", "author": {"login": "nik9000"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/ScaledFloatFieldMapper.java", "diffHunk": "@@ -111,11 +114,16 @@ public Builder coerce(boolean coerce) {\n         }\n \n         public Builder scalingFactor(double scalingFactor) {\n-            ((ScaledFloatFieldType) fieldType).setScalingFactor(scalingFactor);\n+            this.scalingFactor = scalingFactor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIwOTY3NQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440209675", "createdAt": "2020-06-15T14:18:37Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -592,35 +595,34 @@ protected void parseCreateField(ParseContext context) throws IOException {\n             dateAsString = context.parser().textOrNull();\n         }\n \n-        if (dateAsString == null) {\n-            dateAsString = fieldType().nullValueAsString();\n-        }\n-\n-        if (dateAsString == null) {\n-            return;\n-        }\n-\n         long timestamp;\n-        try {\n-            timestamp = fieldType().parse(dateAsString);\n-        } catch (IllegalArgumentException | ElasticsearchParseException | DateTimeException e) {\n-            if (ignoreMalformed.value()) {\n-                context.addIgnoredField(fieldType.name());\n+        if (dateAsString == null) {\n+            if (nullValue == null) {\n                 return;\n-            } else {\n-                throw e;\n+            }\n+            timestamp = nullValue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 223}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIxMDIyNw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440210227", "createdAt": "2020-06-15T14:19:24Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -56,66 +55,46 @@\n         Setting.boolSetting(\"index.mapping.ignore_malformed\", false, Property.IndexScope);\n     public static final Setting<Boolean> COERCE_SETTING =\n         Setting.boolSetting(\"index.mapping.coerce\", false, Property.IndexScope);\n-    public abstract static class Builder<T extends Builder> extends Mapper.Builder<T> {\n+    public abstract static class Builder<T extends Builder<T>> extends Mapper.Builder<T> {\n \n-        protected final MappedFieldType fieldType;\n-        protected final MappedFieldType defaultFieldType;\n-        private final IndexOptions defaultOptions;\n+        protected final FieldType fieldType;\n         protected boolean omitNormsSet = false;\n         protected boolean indexOptionsSet = false;\n-        protected boolean docValuesSet = false;\n+        protected boolean hasDocValues = true;\n+        protected boolean indexed = true;\n         protected final MultiFields.Builder multiFieldsBuilder;\n         protected CopyTo copyTo = CopyTo.empty();\n-\n-        protected Builder(String name, MappedFieldType fieldType, MappedFieldType defaultFieldType) {\n+        protected float boost = 1.0f;\n+        protected Map<String, String> meta = Collections.emptyMap();\n+        // TODO move to KeywordFieldMapper.Builder\n+        protected boolean eagerGlobalOrdinals;\n+        // TODO move to text-specific builder base class", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIxNjM5Mw==", "bodyText": "I don't think we meant to support it, no. We probably should deprecate it and drop it in 8.0.\nI think it is probably worth adding a comment that this won't cause us to make an index of the text representation of the keyword.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440216393", "createdAt": "2020-06-15T14:28:11Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/NumberFieldMapper.java", "diffHunk": "@@ -893,12 +903,15 @@ private static double objectToDouble(Object value) {\n \n         private final NumberType type;\n \n-        public NumberFieldType(NumberType type) {\n-            super();\n+        public NumberFieldType(String name, NumberType type, boolean isSearchable, boolean hasDocValues, Map<String, String> meta) {\n+            super(name, isSearchable, hasDocValues, meta);\n             this.type = Objects.requireNonNull(type);\n-            setTokenized(false);\n-            setHasDocValues(true);\n-            setOmitNorms(true);\n+            this.setIndexAnalyzer(Lucene.KEYWORD_ANALYZER);     // allows number fields in significant text aggs - do we need this?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIxNjY4Ng==", "bodyText": "Huh! That feels like a \"funny\" abstraction being invoked.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440216686", "createdAt": "2020-06-15T14:28:34Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/NumberFieldMapper.java", "diffHunk": "@@ -893,12 +903,15 @@ private static double objectToDouble(Object value) {\n \n         private final NumberType type;\n \n-        public NumberFieldType(NumberType type) {\n-            super();\n+        public NumberFieldType(String name, NumberType type, boolean isSearchable, boolean hasDocValues, Map<String, String> meta) {\n+            super(name, isSearchable, hasDocValues, meta);\n             this.type = Objects.requireNonNull(type);\n-            setTokenized(false);\n-            setHasDocValues(true);\n-            setOmitNorms(true);\n+            this.setIndexAnalyzer(Lucene.KEYWORD_ANALYZER);     // allows number fields in significant text aggs - do we need this?\n+            this.setSearchAnalyzer(Lucene.KEYWORD_ANALYZER);    // allows match queries on number fields", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f97840e27eb50236c2f82b64855ccb87e67d61c1"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTA5MDY4", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430909068", "createdAt": "2020-06-15T18:54:52Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxODo1NDo1MlrOGj-qVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxODo1NDo1MlrOGj-qVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM3OTk4OQ==", "bodyText": "is it ok that the includeDefaults condition is gone here?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440379989", "createdAt": "2020-06-15T18:54:52Z", "author": {"login": "javanna"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/ScaledFloatFieldMapper.java", "diffHunk": "@@ -446,17 +456,16 @@ protected void mergeOptions(FieldMapper other, List<String> conflicts) {\n     protected void doXContentBody(XContentBuilder builder, boolean includeDefaults, Params params) throws IOException {\n         super.doXContentBody(builder, includeDefaults, params);\n \n-        builder.field(\"scaling_factor\", fieldType().getScalingFactor());\n+        builder.field(\"scaling_factor\", scalingFactor);\n \n         if (includeDefaults || ignoreMalformed.explicit()) {\n             builder.field(\"ignore_malformed\", ignoreMalformed.value());\n         }\n         if (includeDefaults || coerce.explicit()) {\n             builder.field(\"coerce\", coerce.value());\n         }\n-\n-        if (includeDefaults || fieldType().nullValue() != null) {\n-            builder.field(\"null_value\", fieldType().nullValue());\n+        if (nullValue != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 183}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTA5ODIx", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430909821", "createdAt": "2020-06-15T18:55:56Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxODo1NTo1NlrOGj-svg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxODo1NTo1NlrOGj-svg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM4MDYwNg==", "bodyText": "is this an existing error or was it silently rejected before?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440380606", "createdAt": "2020-06-15T18:55:56Z", "author": {"login": "javanna"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java", "diffHunk": "@@ -147,23 +148,26 @@ public Builder maxShingleSize(int maxShingleSize) {\n         }\n \n         @Override\n-        public SearchAsYouTypeFieldType fieldType() {\n-            return (SearchAsYouTypeFieldType) this.fieldType;\n+        public Builder docValues(boolean docValues) {\n+            if (docValues) {\n+                throw new IllegalArgumentException(\"mapper [\" + name() + \"] of type [search_as_you_type] does not support doc values\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTEwOTU3", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430910957", "createdAt": "2020-06-15T18:57:37Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxODo1NzozOFrOGj-wcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxODo1NzozOFrOGj-wcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM4MTU1Mw==", "bodyText": "was this also thrown before?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440381553", "createdAt": "2020-06-15T18:57:38Z", "author": {"login": "javanna"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java", "diffHunk": "@@ -681,6 +703,9 @@ protected void mergeOptions(FieldMapper other, List<String> conflicts) {\n                 this.shingleFields[i] = (ShingleFieldMapper) this.shingleFields[i].merge(m.shingleFields[i]);\n             }\n         }\n+        if (Objects.equals(this.fieldType().similarity(), other.fieldType().similarity()) == false) {\n+            conflicts.add(\"mapper [\" + name() + \"] has different [similarity] settings\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 311}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTExNjg0", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430911684", "createdAt": "2020-06-15T18:58:42Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxODo1ODo0MlrOGj-ytA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxODo1ODo0MlrOGj-ytA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM4MjEzMg==", "bodyText": "this seems like a new error that was not returned before?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440382132", "createdAt": "2020-06-15T18:58:42Z", "author": {"login": "javanna"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/TokenCountFieldMapper.java", "diffHunk": "@@ -202,8 +211,11 @@ protected String contentType() {\n \n     @Override\n     protected void mergeOptions(FieldMapper other, List<String> conflicts) {\n-        this.analyzer = ((TokenCountFieldMapper) other).analyzer;\n-        this.enablePositionIncrements = ((TokenCountFieldMapper) other).enablePositionIncrements;\n+        // TODO we should ban updating analyzers and null values as well\n+        if (this.enablePositionIncrements != ((TokenCountFieldMapper)other).enablePositionIncrements) {\n+            conflicts.add(\"mapper [\" + name() + \"] has a different [enable_position_increments] setting\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTM2NTQ0", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430936544", "createdAt": "2020-06-15T19:37:06Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTozNzowN1rOGkABJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTozNzowN1rOGkABJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQwMjIxMg==", "bodyText": "what happens with these checks once isSearchable returns true yet there is no index? Do we need to distinguish between the two?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440402212", "createdAt": "2020-06-15T19:37:07Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -328,13 +306,13 @@ public void parse(ParseContext context) throws IOException {\n             }\n \n             List<IndexableField> fields = new ArrayList<>();\n-            if (fieldType.indexOptions() != IndexOptions.NONE || fieldType.hasDocValues()) {\n+            if (mappedFieldType.isSearchable() || mappedFieldType.hasDocValues()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTM3MjE3", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430937217", "createdAt": "2020-06-15T19:38:08Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTozODowOVrOGkADQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTozODowOVrOGkADQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQwMjc1Mw==", "bodyText": "is this a new error that gets returned compared to before?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440402753", "createdAt": "2020-06-15T19:38:09Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/BinaryFieldMapper.java", "diffHunk": "@@ -65,16 +67,23 @@\n     public static class Builder extends FieldMapper.Builder<Builder> {\n \n         public Builder(String name) {\n-            super(name, Defaults.FIELD_TYPE, Defaults.FIELD_TYPE);\n+            super(name, Defaults.FIELD_TYPE);\n             builder = this;\n         }\n \n         @Override\n         public BinaryFieldMapper build(BuilderContext context) {\n-            setupFieldType(context);\n-            return new BinaryFieldMapper(name, fieldType, defaultFieldType,\n+            return new BinaryFieldMapper(name, fieldType, new BinaryFieldType(buildFullName(context), hasDocValues, meta),\n                     context.indexSettings(), multiFieldsBuilder.build(this, context), copyTo);\n         }\n+\n+        @Override\n+        public Builder index(boolean index) {\n+            if (index) {\n+                throw new MapperParsingException(\"Binary field [\" + name() + \"] cannot be indexed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTM3ODM0", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430937834", "createdAt": "2020-06-15T19:39:11Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTozOToxMVrOGkAFQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTozOToxMVrOGkAFQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQwMzI2Nw==", "bodyText": "new error?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440403267", "createdAt": "2020-06-15T19:39:11Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java", "diffHunk": "@@ -411,13 +422,21 @@ private void checkCompletionContextsLimit(BuilderContext context) {\n                 }\n             }\n         }\n+\n+        @Override\n+        public Builder index(boolean index) {\n+            if (index == false) {\n+                throw new MapperParsingException(\"Completion field type must be indexed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTQxMzAx", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430941301", "createdAt": "2020-06-15T19:44:38Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTo0NDozOFrOGkAQWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTo0NDozOFrOGkAQWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQwNjEwNw==", "bodyText": "new or existing error?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440406107", "createdAt": "2020-06-15T19:44:38Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -372,18 +334,23 @@ private void mergeSharedOptions(FieldMapper mergeWith, List<String> conflicts) {\n                 + \"] to [\" + mergeWith.contentType() + \"]\");\n         }\n \n-        MappedFieldType other = mergeWith.fieldType;\n+        FieldType other = mergeWith.fieldType;\n+        MappedFieldType otherm = mergeWith.mappedFieldType;\n+        this.mappedFieldType.updateMeta(otherm.meta());\n \n         boolean indexed =  fieldType.indexOptions() != IndexOptions.NONE;\n         boolean mergeWithIndexed = other.indexOptions() != IndexOptions.NONE;\n-        // TODO: should be validating if index options go \"up\" (but \"down\" is ok)\n         if (indexed != mergeWithIndexed) {\n             conflicts.add(\"mapper [\" + name() + \"] has different [index] values\");\n         }\n+        // TODO: should be validating if index options go \"up\" (but \"down\" is ok)\n+        if (fieldType.indexOptions() != other.indexOptions()) {\n+            conflicts.add(\"mapper [\" + name() + \"] has different [index_options] values\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 252}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTQyNDQz", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430942443", "createdAt": "2020-06-15T19:46:22Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTo0NjoyMlrOGkAUEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTo0NjoyMlrOGkAUEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQwNzA1OQ==", "bodyText": "have we changed behaviour here?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440407059", "createdAt": "2020-06-15T19:46:22Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/IdFieldMapper.java", "diffHunk": "@@ -160,9 +169,6 @@ public Query termsQuery(List<?> values, QueryShardContext context) {\n \n         @Override\n         public IndexFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName) {\n-            if (indexOptions() == IndexOptions.NONE) {\n-                throw new IllegalArgumentException(\"Fielddata access on the _id field is disallowed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTQ1ODg5", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430945889", "createdAt": "2020-06-15T19:51:57Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTo1MTo1N1rOGkAerw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTo1MTo1N1rOGkAerw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQwOTc3NQ==", "bodyText": "new error?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440409775", "createdAt": "2020-06-15T19:51:57Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MetadataFieldMapper.java", "diffHunk": "@@ -46,16 +47,24 @@\n     }\n \n     @SuppressWarnings(\"rawtypes\")\n-    public abstract static class Builder<T extends Builder> extends FieldMapper.Builder<T> {\n-        public Builder(String name, MappedFieldType fieldType, MappedFieldType defaultFieldType) {\n-            super(name, fieldType, defaultFieldType);\n+    public abstract static class Builder<T extends Builder<T>> extends FieldMapper.Builder<T> {\n+        public Builder(String name, FieldType fieldType) {\n+            super(name, fieldType);\n+        }\n+\n+        @Override\n+        public T index(boolean index) {\n+            if (index == false) {\n+                throw new IllegalArgumentException(\"Metadata fields must be indexed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTQ2NTAz", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430946503", "createdAt": "2020-06-15T19:52:55Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTo1Mjo1NVrOGkAgiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxOTo1Mjo1NVrOGkAgiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxMDI0OQ==", "bodyText": "is it ok that includeDefaults is no longer checked?", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440410249", "createdAt": "2020-06-15T19:52:55Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/NumberFieldMapper.java", "diffHunk": "@@ -1114,8 +1129,8 @@ protected void doXContentBody(XContentBuilder builder, boolean includeDefaults,\n             builder.field(\"coerce\", coerce.value());\n         }\n \n-        if (includeDefaults || fieldType().nullValue() != null) {\n-            builder.field(\"null_value\", fieldType().nullValue());\n+        if (nullValue != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 189}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTUzOTU3", "url": "https://github.com/elastic/elasticsearch/pull/57666#pullrequestreview-430953957", "createdAt": "2020-06-15T20:04:30Z", "commit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDowNDozMVrOGkA3Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDowNDozMVrOGkA3Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQxNjAxMA==", "bodyText": "I got lost trying to figure out if the updated if is equivalent to the previous one.", "url": "https://github.com/elastic/elasticsearch/pull/57666#discussion_r440416010", "createdAt": "2020-06-15T20:04:31Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/termvectors/TermVectorsService.java", "diffHunk": "@@ -333,10 +332,12 @@ private static Fields generateTermVectorsFromDoc(IndexShard indexShard, TermVect\n     public static String[] getValues(IndexableField[] fields) {\n         List<String> result = new ArrayList<>();\n         for (IndexableField field : fields) {\n-            if (field.fieldType() instanceof KeywordFieldMapper.KeywordFieldType) {\n-                result.add(field.binaryValue().utf8ToString());\n-            } else if (field.fieldType() instanceof StringFieldType) {\n-                result.add(field.stringValue());\n+            if (field.fieldType().indexOptions() != IndexOptions.NONE) {\n+                if (field.binaryValue() != null) {\n+                    result.add(field.binaryValue().utf8ToString());\n+                } else {\n+                    result.add(field.stringValue());\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ac318dbcf7a767e370e8a36417dcc22796ede0c"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3888, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}