{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NDQ2NDAz", "number": 63985, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1NToxM1rOE5ebLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1NTozNlrOE5eb8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzAyNzY1OnYy", "diffSide": "RIGHT", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotBrokenSettingsIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1NToxM1rOHz9gag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1NToxM1rOHz9gag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0NzE0Ng==", "bodyText": "I know this test is muted but I'd expect an expectThrows() here.", "url": "https://github.com/elastic/elasticsearch/pull/63985#discussion_r524247146", "createdAt": "2020-11-16T12:55:13Z", "author": {"login": "tlrx"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotBrokenSettingsIT.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.snapshots;\n+\n+import org.apache.lucene.util.LuceneTestCase;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.plugins.Plugin;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.function.Consumer;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+@LuceneTestCase.AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/37485\")\n+public class SnapshotBrokenSettingsIT extends AbstractSnapshotIntegTestCase {\n+\n+    @Override\n+    protected Collection<Class<? extends Plugin>> nodePlugins() {\n+        return Collections.singletonList(BrokenSettingPlugin.class);\n+    }\n+\n+    public void testExceptionWhenRestoringPersistentSettings() {\n+        logger.info(\"--> start 2 nodes\");\n+        internalCluster().startNodes(2);\n+\n+        Client client = client();\n+        Consumer<String> setSettingValue = value -> client.admin().cluster().prepareUpdateSettings().setPersistentSettings(\n+                Settings.builder().put(BrokenSettingPlugin.BROKEN_SETTING.getKey(), value)).execute().actionGet();\n+\n+        Consumer<String> assertSettingValue = value -> assertThat(client.admin().cluster().prepareState().setRoutingTable(false)\n+                .setNodes(false).execute().actionGet().getState().getMetadata().persistentSettings()\n+                .get(BrokenSettingPlugin.BROKEN_SETTING.getKey()), equalTo(value));\n+\n+        logger.info(\"--> set test persistent setting\");\n+        setSettingValue.accept(\"new value\");\n+        assertSettingValue.accept(\"new value\");\n+\n+        createRepository(\"test-repo\", \"fs\");\n+        createFullSnapshot(\"test-repo\", \"test-snap\");\n+        assertThat(getSnapshot(\"test-repo\", \"test-snap\").state(), equalTo(SnapshotState.SUCCESS));\n+\n+        logger.info(\"--> change the test persistent setting and break it\");\n+        setSettingValue.accept(\"new value 2\");\n+        assertSettingValue.accept(\"new value 2\");\n+        BrokenSettingPlugin.breakSetting();\n+\n+        logger.info(\"--> restore snapshot\");\n+        try {\n+            client.admin().cluster().prepareRestoreSnapshot(\"test-repo\", \"test-snap\").setRestoreGlobalState(true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "576d27c32141b26640bb1209cf6a52176c9a6e58"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzAyOTYzOnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1NTozNlrOHz9hwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMjo1NTozNlrOHz9hwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0NzQ4OQ==", "bodyText": "Can we add the node name?", "url": "https://github.com/elastic/elasticsearch/pull/63985#discussion_r524247489", "createdAt": "2020-11-16T12:55:36Z", "author": {"login": "tlrx"}, "path": "test/framework/src/main/java/org/elasticsearch/snapshots/AbstractSnapshotIntegTestCase.java", "diffHunk": "@@ -539,17 +539,17 @@ protected SnapshotInfo getSnapshot(String repository, String snapshot) {\n         return snapshotInfos.get(0);\n     }\n \n+    protected static ThreadPoolStats.Stats snapshotThreadPoolStats(final String node) {\n+        return StreamSupport.stream(internalCluster().getInstance(ThreadPool.class, node).stats().spliterator(), false)\n+                .filter(threadPool -> threadPool.getName().equals(ThreadPool.Names.SNAPSHOT))\n+                .findFirst()\n+                .orElseThrow(() -> new AssertionError(\"Failed to find snapshot pool\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "576d27c32141b26640bb1209cf6a52176c9a6e58"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4359, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}