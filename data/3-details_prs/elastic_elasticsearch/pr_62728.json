{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTE0MTk3", "number": 62728, "title": "Check glibc version", "bodyText": "Part of fixing #62709.\nJava 15 requires at last glibc 2.14, but we support older Linux OSs that ship with older versions. Rather than continue to ship Java 14, which is now EOL and therefore unsupported, ES will detect this situation and print a helpful message, instead of the cryptic error that would otherwise be printed. User on older OSs will have to set JAVA_HOME instead of using the bundled JVM.\nThis doesn't affect v8.0.0 because these older Linux OSs will not be supported, and all the supported ones have glibc 2.14.", "createdAt": "2020-09-21T19:33:57Z", "url": "https://github.com/elastic/elasticsearch/pull/62728", "merged": true, "mergeCommit": {"oid": "54d97ecc606380fec3e07285431c08ce20eb6bda"}, "closed": true, "closedAt": "2020-09-22T20:48:28Z", "author": {"login": "pugnascotia"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLD4LqgH2gAyNDkwNTE0MTk3Ojk4NDAyZDRjNjkwOTJlMzlmNmVjNGYwN2EyZDY2OWMzZGEwYzk0NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLcCYsgFqTQ5MzcyMzAzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "98402d4c69092e39f6ec4f07a2d669c3da0c9466", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/98402d4c69092e39f6ec4f07a2d669c3da0c9466", "committedDate": "2020-09-21T14:01:29Z", "message": "First stab at checking glibc version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de80305f724e874477a5099a400eb30fec1083ea", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/de80305f724e874477a5099a400eb30fec1083ea", "committedDate": "2020-09-21T19:23:15Z", "message": "More work"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTIwMzk0", "url": "https://github.com/elastic/elasticsearch/pull/62728#pullrequestreview-492920394", "createdAt": "2020-09-21T19:34:49Z", "commit": {"oid": "de80305f724e874477a5099a400eb30fec1083ea"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTozNDo0OVrOHVfkOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTozNzowN1rOHVfpEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI5OTMyMQ==", "bodyText": "debug?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492299321", "createdAt": "2020-09-21T19:34:49Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,41 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  echo check_glibc_version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de80305f724e874477a5099a400eb30fec1083ea"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMDMwOA==", "bodyText": "this isn't portable. i think can avoid it altogether and only use getconf?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492300308", "createdAt": "2020-09-21T19:36:38Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,41 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  echo check_glibc_version\n+  if [[ -e /lib64/libc.so.6 ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de80305f724e874477a5099a400eb30fec1083ea"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMDU2MA==", "bodyText": "i think can can avoid all the fallbacks? just use getconf", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492300560", "createdAt": "2020-09-21T19:37:07Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,41 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  echo check_glibc_version\n+  if [[ -e /lib64/libc.so.6 ]]; then\n+    # We need to check the version of glibc, because JDK >=15 requires\n+    # glibc 2.14\n+    LIBC_VERSION=\"$( getconf GNU_LIBC_VERSION | awk '{ if ($2 ~ /^[0-9.]*$/) { print $2; exit 0 } else { exit 1 } }' )\"\n+    if [[ $? -ne 0 ]]; then\n+      LIBC_VERSION=\"$( ldd --version | head -1 | awk '{ if ($4 ~ /^[0-9.]*$/) { print $4; exit 0 } else { exit 1 } }' )\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de80305f724e874477a5099a400eb30fec1083ea"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87367da508dced150d7875d2777f366716b1c185", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/87367da508dced150d7875d2777f366716b1c185", "committedDate": "2020-09-21T19:54:40Z", "message": "Simplify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "243a2066943392054cee0eb7ab4ba255d02f705a", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/243a2066943392054cee0eb7ab4ba255d02f705a", "committedDate": "2020-09-21T20:03:06Z", "message": "Tweaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyOTQwOTQy", "url": "https://github.com/elastic/elasticsearch/pull/62728#pullrequestreview-492940942", "createdAt": "2020-09-21T20:06:01Z", "commit": {"oid": "243a2066943392054cee0eb7ab4ba255d02f705a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDowNjowMVrOHVgjbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDowODozOVrOHVgohQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNTUwMw==", "bodyText": "Does this work? I thought the $? would be the result of the assignment, not the inner command?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492315503", "createdAt": "2020-09-21T20:06:01Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,31 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  # We need to check the version of glibc, because JDK >=15 requires\n+  # glibc 2.14\n+  GLIBC_VERSION=\"$( getconf GNU_LIBC_VERSION 2>/dev/null | cut -d' ' -f2)\"\n+  if [[ $? -ne 0 ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "243a2066943392054cee0eb7ab4ba255d02f705a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNjgwNQ==", "bodyText": "Is this doing a numeric comparison? Is it casting $1 to a float? Are there any floating point precision issues possible?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492316805", "createdAt": "2020-09-21T20:08:39Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,31 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  # We need to check the version of glibc, because JDK >=15 requires\n+  # glibc 2.14\n+  GLIBC_VERSION=\"$( getconf GNU_LIBC_VERSION 2>/dev/null | cut -d' ' -f2)\"\n+  if [[ $? -ne 0 ]]; then\n+    # Must be on a POSIX system that isn't using glibc.\n+    return 0\n+  fi\n+\n+  if echo \"$GLIBC_VERSION\" | awk '{ if ($1 >= 2.14) { exit 1 } else { exit 0 } }'; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "243a2066943392054cee0eb7ab4ba255d02f705a"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91307273d54df8dbc61f18352b749fee208dd77d", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/91307273d54df8dbc61f18352b749fee208dd77d", "committedDate": "2020-09-22T08:57:45Z", "message": "Improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTYyODUw", "url": "https://github.com/elastic/elasticsearch/pull/62728#pullrequestreview-493562850", "createdAt": "2020-09-22T15:06:07Z", "commit": {"oid": "91307273d54df8dbc61f18352b749fee208dd77d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTc1MjM0", "url": "https://github.com/elastic/elasticsearch/pull/62728#pullrequestreview-493575234", "createdAt": "2020-09-22T15:16:34Z", "commit": {"oid": "91307273d54df8dbc61f18352b749fee208dd77d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNToxNjozNVrOHV_Zsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNToxNjozNVrOHV_Zsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyMDkxNA==", "bodyText": "Would this say 3.1 was unacceptable?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492820914", "createdAt": "2020-09-22T15:16:35Z", "author": {"login": "droberts195"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,35 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+# On systems that are built upon glibc, We need to check the version of\n+# glibc because Elasticsearch bundles JDK 15, which requires glibc >= 2.14\n+check_glibc_version() {\n+  local GETCONF=\"$( getconf GNU_LIBC_VERSION 2>/dev/null )\"\n+  if [[ $? -ne 0 ]]; then\n+    # Must be on a POSIX system that isn't using glibc.\n+    return 0\n+  fi\n+\n+  local GLIBC_VERSION=\"$( echo \"$GETCONF\" | cut -d' ' -f2 )\"\n+  local MAJOR=\"$( echo $GLIBC_VERSION | cut -d. -f1 )\"\n+  local MINOR=\"$( echo $GLIBC_VERSION | cut -d. -f2 )\"\n+\n+  if [[ \"$MAJOR\" -lt 2 || \"$MINOR\" -lt 14 ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91307273d54df8dbc61f18352b749fee208dd77d"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "631f22b4e4f6155d95d393fcc6d908cbb608713d", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/631f22b4e4f6155d95d393fcc6d908cbb608713d", "committedDate": "2020-09-22T17:14:32Z", "message": "Fix perms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df4b1cd3169eae1854e7e7596e8f5dcf7adaefd5", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/df4b1cd3169eae1854e7e7596e8f5dcf7adaefd5", "committedDate": "2020-09-22T17:20:40Z", "message": "Tighten up version check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzIzMDM3", "url": "https://github.com/elastic/elasticsearch/pull/62728#pullrequestreview-493723037", "createdAt": "2020-09-22T18:10:21Z", "commit": {"oid": "df4b1cd3169eae1854e7e7596e8f5dcf7adaefd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4688, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}