{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MTU0MTQ2", "number": 53155, "title": "Fix inaccurate total hit count in _search/template api", "bodyText": "Relates to #52801.\nThe main changes are:\n\n\nWhen 'rest_track_total_hits_as_int' is set to true, the total hits count in the response should be accurate. So we should  set trackTotalHits to true if need when parsing the inline script of a search template request.\n\n\nAdd some test code in MultiSearchTemplateIT  and SearchTemplateIT.", "createdAt": "2020-03-05T09:15:27Z", "url": "https://github.com/elastic/elasticsearch/pull/53155", "merged": true, "mergeCommit": {"oid": "fb158dfb3ea36eb24335bd2e004305c1033c9e2f"}, "closed": true, "closedAt": "2020-03-13T14:35:03Z", "author": {"login": "gaobinlong"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKniSAAH2gAyMzg0MTU0MTQ2OmZiMmM4YWQ2ZGRjZmUwYmU2OGU2YTFhOThhYjM3NzlhNWM5ZTA1NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNRQkhgFqTM3NDM0ODI2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570", "committedDate": "2020-03-05T08:49:04Z", "message": "Fix inaccurate total hit count in _search/template api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDA5Nzg0", "url": "https://github.com/elastic/elasticsearch/pull/53155#pullrequestreview-369409784", "createdAt": "2020-03-05T09:26:50Z", "commit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwOToyNjo1MFrOFyMAaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwOTozMDoyN1rOFyMIhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2OTgzMg==", "bodyText": "This method has been called in RestSearchAction.parseSearchRequest above, so it's repeatly called here but useless.", "url": "https://github.com/elastic/elasticsearch/pull/53155#discussion_r388169832", "createdAt": "2020-03-05T09:26:50Z", "author": {"login": "gaobinlong"}, "path": "modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/RestSearchTemplateAction.java", "diffHunk": "@@ -72,7 +72,6 @@ public RestChannelConsumer prepareRequest(RestRequest request, NodeClient client\n             searchTemplateRequest = SearchTemplateRequest.fromXContent(parser);\n         }\n         searchTemplateRequest.setRequest(searchRequest);\n-        RestSearchAction.checkRestTotalHits(request, searchRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE3MTkxMA==", "bodyText": "When rest_total_hits_as_int is set to true, trackTotalHitsUpToin the searchRequest is set to Integer.MAX_VALUE,\nwe should copy the value to the new searchRequest here  and check whether the track_total_hits in the inline script is set to a not accurate number.", "url": "https://github.com/elastic/elasticsearch/pull/53155#discussion_r388171910", "createdAt": "2020-03-05T09:30:27Z", "author": {"login": "gaobinlong"}, "path": "modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/TransportSearchTemplateAction.java", "diffHunk": "@@ -110,6 +111,19 @@ static SearchRequest convert(SearchTemplateRequest searchTemplateRequest, Search\n             builder.parseXContent(parser, false);\n             builder.explain(searchTemplateRequest.isExplain());\n             builder.profile(searchTemplateRequest.isProfile());\n+            if (searchRequest.source() == null) {\n+                searchRequest.source(new SearchSourceBuilder());\n+            }\n+            Integer trackTotalHitsUpTo = searchRequest.source().trackTotalHitsUpTo();\n+            if (trackTotalHitsUpTo != null) {\n+                if (builder.trackTotalHitsUpTo() == null) {\n+                    builder.trackTotalHitsUpTo(trackTotalHitsUpTo);\n+                } else if (builder.trackTotalHitsUpTo() != SearchContext.TRACK_TOTAL_HITS_ACCURATE\n+                    && builder.trackTotalHitsUpTo() != SearchContext.TRACK_TOTAL_HITS_DISABLED) {\n+                    throw new IllegalArgumentException(\"[\" + RestSearchAction.TOTAL_HITS_AS_INT_PARAM + \"] cannot be used \" +\n+                        \"if the tracking of total hits is not accurate, got \" + trackTotalHitsUpTo);\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDM0NzU2", "url": "https://github.com/elastic/elasticsearch/pull/53155#pullrequestreview-369434756", "createdAt": "2020-03-05T10:00:57Z", "commit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMDowMDo1N1rOFyNNVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMDoyMDoxN1rOFyN1xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE4OTUyNA==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/53155#discussion_r388189524", "createdAt": "2020-03-05T10:00:57Z", "author": {"login": "jimczi"}, "path": "modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/RestSearchTemplateAction.java", "diffHunk": "@@ -72,7 +72,6 @@ public RestChannelConsumer prepareRequest(RestRequest request, NodeClient client\n             searchTemplateRequest = SearchTemplateRequest.fromXContent(parser);\n         }\n         searchTemplateRequest.setRequest(searchRequest);\n-        RestSearchAction.checkRestTotalHits(request, searchRequest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2OTgzMg=="}, "originalCommit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5MDUxOQ==", "bodyText": "Is this needed ? We throw a runtime exception so it should be ok to leave the IOException as is.", "url": "https://github.com/elastic/elasticsearch/pull/53155#discussion_r388190519", "createdAt": "2020-03-05T10:02:49Z", "author": {"login": "jimczi"}, "path": "modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/TransportSearchTemplateAction.java", "diffHunk": "@@ -85,13 +86,13 @@ public void onFailure(Exception t) {\n             } else {\n                 listener.onResponse(response);\n             }\n-        } catch (IOException e) {\n+        } catch (Exception e) {\n             listener.onFailure(e);\n         }\n     }\n \n     static SearchRequest convert(SearchTemplateRequest searchTemplateRequest, SearchTemplateResponse response, ScriptService scriptService,\n-                                 NamedXContentRegistry xContentRegistry) throws IOException {\n+                                 NamedXContentRegistry xContentRegistry) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5MjI4MQ==", "bodyText": "Can you move this part and the checks below outside of the parser block ?", "url": "https://github.com/elastic/elasticsearch/pull/53155#discussion_r388192281", "createdAt": "2020-03-05T10:06:16Z", "author": {"login": "jimczi"}, "path": "modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/TransportSearchTemplateAction.java", "diffHunk": "@@ -110,6 +111,19 @@ static SearchRequest convert(SearchTemplateRequest searchTemplateRequest, Search\n             builder.parseXContent(parser, false);\n             builder.explain(searchTemplateRequest.isExplain());\n             builder.profile(searchTemplateRequest.isProfile());\n+            if (searchRequest.source() == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5OTAwNw==", "bodyText": "Can you replace these tests with yaml tests. It's odd that the rest option is not used to test the behavior and we to prefer yaml tests when doing small integration tests like this.", "url": "https://github.com/elastic/elasticsearch/pull/53155#discussion_r388199007", "createdAt": "2020-03-05T10:18:39Z", "author": {"login": "jimczi"}, "path": "modules/lang-mustache/src/test/java/org/elasticsearch/script/mustache/SearchTemplateIT.java", "diffHunk": "@@ -106,6 +107,67 @@ public void testTemplateQueryAsEscapedString() throws Exception {\n         assertThat(searchResponse.getResponse().getHits().getHits().length, equalTo(1));\n     }\n \n+    /**\n+     * Test the template query's hit count with an index which has more than 10k documents, relates to #52801.\n+     */\n+    public void testTemplateQueryHitCount() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5OTY0Ng==", "bodyText": "Can you add a comment that a non-value of trackTotalHitsUpTo here indicates that rest_total_hits_as_int was used ?", "url": "https://github.com/elastic/elasticsearch/pull/53155#discussion_r388199646", "createdAt": "2020-03-05T10:19:53Z", "author": {"login": "jimczi"}, "path": "modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/TransportSearchTemplateAction.java", "diffHunk": "@@ -110,6 +111,19 @@ static SearchRequest convert(SearchTemplateRequest searchTemplateRequest, Search\n             builder.parseXContent(parser, false);\n             builder.explain(searchTemplateRequest.isExplain());\n             builder.profile(searchTemplateRequest.isProfile());\n+            if (searchRequest.source() == null) {\n+                searchRequest.source(new SearchSourceBuilder());\n+            }\n+            Integer trackTotalHitsUpTo = searchRequest.source().trackTotalHitsUpTo();\n+            if (trackTotalHitsUpTo != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5OTg3Nw==", "bodyText": "Maybe also add one for the _msearch_template since your pr fixes both.", "url": "https://github.com/elastic/elasticsearch/pull/53155#discussion_r388199877", "createdAt": "2020-03-05T10:20:17Z", "author": {"login": "jimczi"}, "path": "modules/lang-mustache/src/test/java/org/elasticsearch/script/mustache/SearchTemplateIT.java", "diffHunk": "@@ -106,6 +107,67 @@ public void testTemplateQueryAsEscapedString() throws Exception {\n         assertThat(searchResponse.getResponse().getHits().getHits().length, equalTo(1));\n     }\n \n+    /**\n+     * Test the template query's hit count with an index which has more than 10k documents, relates to #52801.\n+     */\n+    public void testTemplateQueryHitCount() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5OTAwNw=="}, "originalCommit": {"oid": "fb2c8ad6ddcfe0be68e6a1a98ab3779a5c9e0570"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1372b1445c6ac0bb369b0b03d9fe65c578f8697", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1372b1445c6ac0bb369b0b03d9fe65c578f8697", "committedDate": "2020-03-08T11:58:39Z", "message": "use yaml test instead of the test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ff0fa908d5808c07960eee3b6dae3c41f3a07a", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/22ff0fa908d5808c07960eee3b6dae3c41f3a07a", "committedDate": "2020-03-08T12:02:00Z", "message": "Merge remote-tracking branch 'origin/master' into patch#52801"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa8acfe9d07ac6e46d9c5bca07353375ba0db3da", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa8acfe9d07ac6e46d9c5bca07353375ba0db3da", "committedDate": "2020-03-13T11:40:02Z", "message": "Merge branch 'master' into patch#52801"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MzQ4MjY1", "url": "https://github.com/elastic/elasticsearch/pull/53155#pullrequestreview-374348265", "createdAt": "2020-03-13T14:33:35Z", "commit": {"oid": "fa8acfe9d07ac6e46d9c5bca07353375ba0db3da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1785, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}