{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMTg2ODk1", "number": 50823, "title": "SQL: change the way unsupported data types fields are handled", "bodyText": "By default, new field types in SQL are treated as UNSUPPORTED, but because \"flattened\" adds a _keyed sub-field to the flattened field, the fields discovery algorithm in SQL (looking at the output of field_caps API) is broken by the _keyed suffix.\nThis PR fixes this situation for the \"flattened\" data type, but also for other future unsupported data types, by marking an entire hierarchy of fields and sub-fields under an unsupported data type field, as unsupported.", "createdAt": "2020-01-09T22:18:12Z", "url": "https://github.com/elastic/elasticsearch/pull/50823", "merged": true, "mergeCommit": {"oid": "7adb286c4c485b9e781f88b0a2f98cab9ec5b7e2"}, "closed": true, "closedAt": "2020-01-20T10:59:31Z", "author": {"login": "astefan"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4xd38AH2gAyMzYxMTg2ODk1OmIyYjU1M2ExNzRiZjI5MWFmOGNjZmY5ZWRjYTg4Y2E3NWYxYjExOWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7PIyTAFqTM0NDU5MTM1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b2b553a174bf291af8ccff9edca88ca75f1b119e", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2b553a174bf291af8ccff9edca88ca75f1b119e", "committedDate": "2020-01-09T22:12:40Z", "message": "Properly ignore (for the moment) the \"flattened\" data type, treating it\nas of UNSUPPORTED type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920e14334928482f0d8cd9dae57385c058133c9b", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/920e14334928482f0d8cd9dae57385c058133c9b", "committedDate": "2020-01-09T22:12:58Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into ignore_flattened_fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMDQ0MTg0", "url": "https://github.com/elastic/elasticsearch/pull/50823#pullrequestreview-341044184", "createdAt": "2020-01-10T09:33:30Z", "commit": {"oid": "920e14334928482f0d8cd9dae57385c058133c9b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwOTozMzozMFrOFcOmUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwOTozNToxM1rOFcOpMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0MzYzNA==", "bodyText": "Unfortunately this creates a runtime issue as plugins that are not marked as extensible (such as Painless) cannot have their classes imported into a different project.\nIn other words the FlatObjectFieldMapper.CONTENT_TYPE won't be available which would result in a CNFE.\nAs such as I would simply declare the String constant internally and use it verbatim instead of linking to it.", "url": "https://github.com/elastic/elasticsearch/pull/50823#discussion_r365143634", "createdAt": "2020-01-10T09:33:30Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/build.gradle", "diffHunk": "@@ -39,6 +39,7 @@ check.dependsOn internalClusterTest\n \n dependencies {\n   compileOnly project(path: xpackModule('core'), configuration: 'default')\n+  compileOnly project(path: xpackModule('mapper-flattened'))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "920e14334928482f0d8cd9dae57385c058133c9b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NDM3MQ==", "bodyText": "I wonder if we cannot make this a bit generic by looking for field names that have leaves starting with _ and if so, look at their type  - if its not recognized, mark the field as unsupported.", "url": "https://github.com/elastic/elasticsearch/pull/50823#discussion_r365144371", "createdAt": "2020-01-10T09:35:13Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/index/IndexResolver.java", "diffHunk": "@@ -493,6 +495,12 @@ public void resolveAsSeparateMappings(String indexWildcard, String javaRegex, bo\n                 if (typeEntry.getKey().startsWith(\"_\") && typeCap.getType().startsWith(\"_\")) {\n                     continue;\n                 }\n+                \n+                // skip the \"flattened\" type of field's \"_keyed\" subfield", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "920e14334928482f0d8cd9dae57385c058133c9b"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba09e3e25360d1cd6f18c5aa46e70421ebd3489f", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/ba09e3e25360d1cd6f18c5aa46e70421ebd3489f", "committedDate": "2020-01-13T16:20:34Z", "message": "Make the unsupported fields handling a generic one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "007d6cdfa0310b0cd36e2387d23b16861065f4b8", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/007d6cdfa0310b0cd36e2387d23b16861065f4b8", "committedDate": "2020-01-13T16:21:04Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into ignore_flattened_fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1809e585e7c357451795af9fea79c352400c673", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1809e585e7c357451795af9fea79c352400c673", "committedDate": "2020-01-13T16:32:45Z", "message": "Small cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMTczNTAz", "url": "https://github.com/elastic/elasticsearch/pull/50823#pullrequestreview-342173503", "createdAt": "2020-01-13T22:09:05Z", "commit": {"oid": "44cf2049aacaec835df2d0b487f316cc41b5706a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjkzNDE4", "url": "https://github.com/elastic/elasticsearch/pull/50823#pullrequestreview-342693418", "createdAt": "2020-01-14T17:04:17Z", "commit": {"oid": "44cf2049aacaec835df2d0b487f316cc41b5706a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzowNDoxN1rOFdfAnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzowNDoxN1rOFdfAnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ2MTA4NA==", "bodyText": "minor: extra new line", "url": "https://github.com/elastic/elasticsearch/pull/50823#discussion_r366461084", "createdAt": "2020-01-14T17:04:17Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/index/IndexResolver.java", "diffHunk": "@@ -495,6 +501,7 @@ public void resolveAsSeparateMappings(String indexWildcard, String javaRegex, bo\n                 if (typeEntry.getKey().startsWith(\"_\") && typeCap.getType().startsWith(\"_\")) {\n                     continue;\n                 }\n+                ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44cf2049aacaec835df2d0b487f316cc41b5706a"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e51f4376d9992afb83d13a72289cf2e5e423d73", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e51f4376d9992afb83d13a72289cf2e5e423d73", "committedDate": "2020-01-15T12:05:13Z", "message": "Add one more test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "330557d24a9907ad227f861e70651566c00188d1", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/330557d24a9907ad227f861e70651566c00188d1", "committedDate": "2020-01-15T12:05:28Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into ignore_flattened_fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d1d5dae44d28fce1179b6031b0de0725f130e14", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/1d1d5dae44d28fce1179b6031b0de0725f130e14", "committedDate": "2020-01-15T15:51:52Z", "message": "Added a way to remember the first unsupported data type in a hierarchy\nof fields to improve error reporting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/a9e92964d51ee46440627913aa6fb3aca81401c8", "committedDate": "2020-01-15T15:57:15Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into ignore_flattened_fields"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44cf2049aacaec835df2d0b487f316cc41b5706a", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/44cf2049aacaec835df2d0b487f316cc41b5706a", "committedDate": "2020-01-13T22:02:52Z", "message": "Merge branch 'master' into ignore_flattened_fields"}, "afterCommit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/a9e92964d51ee46440627913aa6fb3aca81401c8", "committedDate": "2020-01-15T15:57:15Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into ignore_flattened_fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNDA4MTI2", "url": "https://github.com/elastic/elasticsearch/pull/50823#pullrequestreview-343408126", "createdAt": "2020-01-15T17:53:02Z", "commit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODE3NzUz", "url": "https://github.com/elastic/elasticsearch/pull/50823#pullrequestreview-343817753", "createdAt": "2020-01-16T10:37:53Z", "commit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDozNzo1NFrOFeVA0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDo0NDoxOVrOFeVMbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NTg3Mw==", "bodyText": "The whole block can be further simplified by\nesField = new UnsupportedEsField(esField.getName(), type, inherited != null ? inherited : unsupportedParent.getName(), esField.getProperties());", "url": "https://github.com/elastic/elasticsearch/pull/50823#discussion_r367345873", "createdAt": "2020-01-16T10:37:54Z", "author": {"login": "costin"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/index/IndexResolver.java", "diffHunk": "@@ -387,7 +388,22 @@ private static EsField createField(String fieldName, Map<String, Map<String, Fie\n         }\n \n         EsField esField = field.apply(fieldName);\n-        \n+\n+        if (parent != null && parent instanceof UnsupportedEsField) {\n+            UnsupportedEsField unsupportedParent = (UnsupportedEsField) parent;\n+            String inherited = unsupportedParent.getInherited();\n+            String type = unsupportedParent.getOriginalType();\n+            \n+            if (inherited == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NjkwMQ==", "bodyText": "Why is the if needed - the result will be the same regardless of whether field is UnsupportedEsField or not.", "url": "https://github.com/elastic/elasticsearch/pull/50823#discussion_r367346901", "createdAt": "2020-01-16T10:40:03Z", "author": {"login": "costin"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/type/Types.java", "diffHunk": "@@ -113,4 +114,21 @@ private static boolean boolSetting(Object value, boolean defaultValue) {\n     private static int intSetting(Object value, int defaultValue) {\n         return value == null ? defaultValue : Integer.parseInt(value.toString());\n     }\n+    \n+    private static void propagateUnsupportedType(String inherited, String originalType, Map<String, EsField> properties) {\n+        if (properties != null && properties.isEmpty() == false) {\n+            for (Entry<String, EsField> entry : properties.entrySet()) {\n+                EsField field = entry.getValue();\n+                UnsupportedEsField u;\n+                if (field instanceof UnsupportedEsField) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0ODg0NA==", "bodyText": "Since the message is the same in the branch, simply do the if on the prefix\nString inheritedMessage = \"\";\nif (unsupportedField.hasInherited()) {\n   inheritedMessage = format(\"in hierarchy (field [{}\"], unsupportedField.getInherited()));\n}\nnamed = u.withUnresolvedMessage(... + inheritedMessage);\n\nFurther more replace the string concatenation in the message with MessageFormat.format to trim it a bit.", "url": "https://github.com/elastic/elasticsearch/pull/50823#discussion_r367348844", "createdAt": "2020-01-16T10:44:19Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Analyzer.java", "diffHunk": "@@ -217,8 +217,14 @@ private static Attribute handleSpecialFields(UnresolvedAttribute u, Attribute na\n             // unsupported types\n             else if (DataTypes.isUnsupported(fa.dataType())) {\n                 UnsupportedEsField unsupportedField = (UnsupportedEsField) fa.field();\n-                named = u.withUnresolvedMessage(\n-                        \"Cannot use field [\" + fa.name() + \"] type [\" + unsupportedField.getOriginalType() + \"] as is unsupported\");\n+                if (unsupportedField.hasInherited()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODIzNzEx", "url": "https://github.com/elastic/elasticsearch/pull/50823#pullrequestreview-343823711", "createdAt": "2020-01-16T10:47:49Z", "commit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDo0Nzo0OVrOFeVSyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDo0Nzo0OVrOFeVSyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1MDQ3Mg==", "bodyText": "Why is propagated needed? The parents should always be discovered before children which means an unsupported parent will discovered before its children, which in turn, will already know their parent is unsupported and thus become unsupported as well.", "url": "https://github.com/elastic/elasticsearch/pull/50823#discussion_r367350472", "createdAt": "2020-01-16T10:47:49Z", "author": {"login": "costin"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/type/Types.java", "diffHunk": "@@ -91,7 +91,8 @@ private static void walkMapping(String name, Object value, Map<String, EsField>\n                     break;\n                 case UNSUPPORTED:\n                     String type = content.get(\"type\").toString();\n-                    field = new UnsupportedEsField(name, type);\n+                    field = new UnsupportedEsField(name, type, null, properties);\n+                    propagateUnsupportedType(name, type, properties);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NTkxMzUw", "url": "https://github.com/elastic/elasticsearch/pull/50823#pullrequestreview-344591350", "createdAt": "2020-01-17T13:54:38Z", "commit": {"oid": "a9e92964d51ee46440627913aa6fb3aca81401c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3724, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}