{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NDEzMDY5", "number": 58096, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNTowNDoyNlrOEFk4Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMTozMjo0MFrOEGT2ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MjgyNTQyOnYy", "diffSide": "RIGHT", "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNTowNDoyNlrOGj2SlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNTowNDoyNlrOGj2SlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0MjgzNg==", "bodyText": "Where possible, could we use the DataStream::getDefaultBackingIndexName method so that any changes there are automatically picked up at least in Java classes?", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440242836", "createdAt": "2020-06-15T15:04:26Z", "author": {"login": "danhermann"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java", "diffHunk": "@@ -433,6 +444,87 @@ public void testCannotDeleteComposableTemplateUsedByDataStream() throws Exceptio\n         assertTrue(maybeE.isPresent());\n     }\n \n+    public void testChangeTimestampFieldInComposableTemplatePriorToRollOver() throws Exception {\n+        createIndexTemplate(\"id1\", \"logs-foo*\", \"@timestamp\");\n+\n+        // Index doc that triggers creation of a data stream\n+        IndexRequest indexRequest = new IndexRequest(\"logs-foobar\").source(\"{}\", XContentType.JSON).opType(\"create\");\n+        IndexResponse indexResponse = client().index(indexRequest).actionGet();\n+        assertThat(indexResponse.getIndex(), equalTo(\".ds-logs-foobar-000001\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0Mjg1NTM4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNToxMToyNlrOGj2luw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToyNjowNFrOGkS-5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0NzczOQ==", "bodyText": "Do we want to allow this field to contain any mapping properties or just the field's data type? Also, should we require that it contains a data type property of either date or date_nanos?", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440247739", "createdAt": "2020-06-15T15:11:26Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -201,4 +204,77 @@ public boolean equals(Object o) {\n     public int hashCode() {\n         return Objects.hash(name, timeStampField, indices, generation);\n     }\n+\n+    public static final class TimestampField implements Writeable, ToXContentObject {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI2MjU3MQ==", "bodyText": "This class should contain the mapping attributes. Part of the mapping attributes is the type attribute, so that data type is kept track of.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440262571", "createdAt": "2020-06-15T15:32:02Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -201,4 +204,77 @@ public boolean equals(Object o) {\n     public int hashCode() {\n         return Objects.hash(name, timeStampField, indices, generation);\n     }\n+\n+    public static final class TimestampField implements Writeable, ToXContentObject {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0NzczOQ=="}, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4ODEzOQ==", "bodyText": "Ok, should we permit not specifying a data type? A data type of either date or date_nanos is required on the composable template, so it seems like maybe it should be required on the data stream, too?", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440288139", "createdAt": "2020-06-15T16:10:21Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -201,4 +204,77 @@ public boolean equals(Object o) {\n     public int hashCode() {\n         return Objects.hash(name, timeStampField, indices, generation);\n     }\n+\n+    public static final class TimestampField implements Writeable, ToXContentObject {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0NzczOQ=="}, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxMjkzMw==", "bodyText": "It isn't possible that any other data type than date and date_nanos is being included the fieldMapping map, because no composable index template with a data stream definition can be created with timestamp field mapping that is not of type date or date_nanos.\nWhen creating a data stream the contents of the field mapping is copied and this includes a type attribute, so that we know whether either date or date_nanos is specified.\nI can add an assert here that checks that value for the type key either returns date or date_nanos for sanity checking.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440712933", "createdAt": "2020-06-16T09:26:04Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -201,4 +204,77 @@ public boolean equals(Object o) {\n     public int hashCode() {\n         return Objects.hash(name, timeStampField, indices, generation);\n     }\n+\n+    public static final class TimestampField implements Writeable, ToXContentObject {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0NzczOQ=="}, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTcxNzYwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToxMjoyM1rOGkSegA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToyNzo1MVrOGkTC_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNDY0MA==", "bodyText": "I think this is unused?", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440704640", "createdAt": "2020-06-16T09:12:23Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -51,13 +55,16 @@\n         new LinkedHashSet<>(List.of(DateFieldMapper.CONTENT_TYPE, DateFieldMapper.DATE_NANOS_CONTENT_TYPE));\n \n     private final ClusterService clusterService;\n+    private final IndicesService indicesService;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxMzk4MA==", "bodyText": "A left over from an iteration that never made it into the pr.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440713980", "createdAt": "2020-06-16T09:27:51Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -51,13 +55,16 @@\n         new LinkedHashSet<>(List.of(DateFieldMapper.CONTENT_TYPE, DateFieldMapper.DATE_NANOS_CONTENT_TYPE));\n \n     private final ClusterService clusterService;\n+    private final IndicesService indicesService;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNDY0MA=="}, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTczNDA0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToxNjo0MFrOGkSo_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMToxODo0N1rOGkWwLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNzMyNQ==", "bodyText": "I wonder if it was more intuitive to require that the mapping be specified on the timestamp field in the template rather than mixing it in with the index mappings. In particular, it will be more clear that those are special, not modifiable compared to the others which can change on rollover.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440707325", "createdAt": "2020-06-16T09:16:40Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -145,9 +154,18 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n         currentState = metadataCreateIndexService.applyCreateIndexRequest(currentState, createIndexRequest, false);\n         IndexMetadata firstBackingIndex = currentState.metadata().index(firstBackingIndexName);\n         assert firstBackingIndex != null;\n+        assert firstBackingIndex.mapping() != null : \"no mapping found for backing index [\" + firstBackingIndexName + \"]\";\n+\n+        String fieldName = template.getDataStreamTemplate().getTimestampField();\n+        Map<String, Object> mapping = firstBackingIndex.mapping().getSourceAsMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxNzgyNg==", "bodyText": "I think requiring that timestamp field mapping the be specified inside the timestamp_field object in a composable template makes sense. It helps highlighting that the timestamp_field and its mapping are special.\nHowever I do think it should be made modifiable? So that new data streams being created can use an updated field mapping? This was my motivation for keeping track of the timestamp field mapping on the DataStream instance, so that new backing indices would use the same valid timestamp field mapping, but when new data streams are being created from the same composable template than an updated timestamp field mapping could be used.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440717826", "createdAt": "2020-06-16T09:34:13Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -145,9 +154,18 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n         currentState = metadataCreateIndexService.applyCreateIndexRequest(currentState, createIndexRequest, false);\n         IndexMetadata firstBackingIndex = currentState.metadata().index(firstBackingIndexName);\n         assert firstBackingIndex != null;\n+        assert firstBackingIndex.mapping() != null : \"no mapping found for backing index [\" + firstBackingIndexName + \"]\";\n+\n+        String fieldName = template.getDataStreamTemplate().getTimestampField();\n+        Map<String, Object> mapping = firstBackingIndex.mapping().getSourceAsMap();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNzMyNQ=="}, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcyMjkyOQ==", "bodyText": "++, agreed, I meant unmodifiable in the sense that template changes will not reflect on already created data-streams.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440722929", "createdAt": "2020-06-16T09:42:37Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -145,9 +154,18 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n         currentState = metadataCreateIndexService.applyCreateIndexRequest(currentState, createIndexRequest, false);\n         IndexMetadata firstBackingIndex = currentState.metadata().index(firstBackingIndexName);\n         assert firstBackingIndex != null;\n+        assert firstBackingIndex.mapping() != null : \"no mapping found for backing index [\" + firstBackingIndexName + \"]\";\n+\n+        String fieldName = template.getDataStreamTemplate().getTimestampField();\n+        Map<String, Object> mapping = firstBackingIndex.mapping().getSourceAsMap();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNzMyNQ=="}, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc3MTk3NA==", "bodyText": "\ud83d\udc4d I think we can change the data_stream definition in a composable template to include the mapping for the timestamp_field mapping in a seperate change?", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440771974", "createdAt": "2020-06-16T11:13:19Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -145,9 +154,18 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n         currentState = metadataCreateIndexService.applyCreateIndexRequest(currentState, createIndexRequest, false);\n         IndexMetadata firstBackingIndex = currentState.metadata().index(firstBackingIndexName);\n         assert firstBackingIndex != null;\n+        assert firstBackingIndex.mapping() != null : \"no mapping found for backing index [\" + firstBackingIndexName + \"]\";\n+\n+        String fieldName = template.getDataStreamTemplate().getTimestampField();\n+        Map<String, Object> mapping = firstBackingIndex.mapping().getSourceAsMap();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNzMyNQ=="}, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc3NDcwMw==", "bodyText": "Yes, that can work out too.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r440774703", "createdAt": "2020-06-16T11:18:47Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -145,9 +154,18 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n         currentState = metadataCreateIndexService.applyCreateIndexRequest(currentState, createIndexRequest, false);\n         IndexMetadata firstBackingIndex = currentState.metadata().index(firstBackingIndexName);\n         assert firstBackingIndex != null;\n+        assert firstBackingIndex.mapping() != null : \"no mapping found for backing index [\" + firstBackingIndexName + \"]\";\n+\n+        String fieldName = template.getDataStreamTemplate().getTimestampField();\n+        Map<String, Object> mapping = firstBackingIndex.mapping().getSourceAsMap();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwNzMyNQ=="}, "originalCommit": {"oid": "07bb5f880016335bd7ff2886f7aff07bf670346d"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MDQ2Mzk4OnYy", "diffSide": "RIGHT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/10_basic.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMToxMjozOFrOGlBD8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMToxMjozOFrOGlBD8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2Nzg4OA==", "bodyText": "I wonder if this should be just timestamp_field.name?\nI would like to also see an assert on the mapping being included and having the right content.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r441467888", "createdAt": "2020-06-17T11:12:38Z", "author": {"login": "henningandersen"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/10_basic.yml", "diffHunk": "@@ -50,12 +50,12 @@ setup:\n       indices.get_data_stream:\n         name: \"*\"\n   - match: { 0.name: simple-data-stream1 }\n-  - match: { 0.timestamp_field: '@timestamp' }\n+  - match: { 0.timestamp_field.field_name: '@timestamp' }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f256b024717a7c711e7d125cd710b1369f677a3f"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MDQ2OTk0OnYy", "diffSide": "RIGHT", "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMToxNDo0MlrOGlBH4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMToxNDo0MlrOGlBH4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODg5Ng==", "bodyText": "I think we should rename createIndexTemplate to putIndexTemplate to signal that it also updates existing.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r441468896", "createdAt": "2020-06-17T11:14:42Z", "author": {"login": "henningandersen"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java", "diffHunk": "@@ -433,6 +444,87 @@ public void testCannotDeleteComposableTemplateUsedByDataStream() throws Exceptio\n         assertTrue(maybeE.isPresent());\n     }\n \n+    public void testChangeTimestampFieldInComposableTemplatePriorToRollOver() throws Exception {\n+        createIndexTemplate(\"id1\", \"logs-foo*\", \"@timestamp\");\n+\n+        // Index doc that triggers creation of a data stream\n+        IndexRequest indexRequest = new IndexRequest(\"logs-foobar\").source(\"{}\", XContentType.JSON).opType(\"create\");\n+        IndexResponse indexResponse = client().index(indexRequest).actionGet();\n+        assertThat(indexResponse.getIndex(), equalTo(DataStream.getDefaultBackingIndexName(\"logs-foobar\", 1)));\n+        assertBackingIndex(DataStream.getDefaultBackingIndexName(\"logs-foobar\", 1), \"properties.@timestamp\");\n+\n+        // Rollover data stream\n+        RolloverResponse rolloverResponse = client().admin().indices().rolloverIndex(new RolloverRequest(\"logs-foobar\", null)).get();\n+        assertThat(rolloverResponse.getNewIndex(), equalTo(DataStream.getDefaultBackingIndexName(\"logs-foobar\", 2)));\n+        assertTrue(rolloverResponse.isRolledOver());\n+        assertBackingIndex(DataStream.getDefaultBackingIndexName(\"logs-foobar\", 2), \"properties.@timestamp\");\n+\n+        // Index another doc into a data stream\n+        indexRequest = new IndexRequest(\"logs-foobar\").source(\"{}\", XContentType.JSON).opType(\"create\");\n+        indexResponse = client().index(indexRequest).actionGet();\n+        assertThat(indexResponse.getIndex(), equalTo(DataStream.getDefaultBackingIndexName(\"logs-foobar\", 2)));\n+\n+        // Change the template to have a different timestamp field\n+        createIndexTemplate(\"id1\", \"logs-foo*\", \"@timestamp2\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f256b024717a7c711e7d125cd710b1369f677a3f"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MDQ4ODg4OnYy", "diffSide": "RIGHT", "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMToyMToyN1rOGlBUMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMToyMToyN1rOGlBUMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3MjA1MA==", "bodyText": "Should we also include tests of any mapping specialization/params? AFAICS, the implementation could keep only the mapping type now and all tests would succeed.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r441472050", "createdAt": "2020-06-17T11:21:27Z", "author": {"login": "henningandersen"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/DataStreamIT.java", "diffHunk": "@@ -433,6 +444,87 @@ public void testCannotDeleteComposableTemplateUsedByDataStream() throws Exceptio\n         assertTrue(maybeE.isPresent());\n     }\n \n+    public void testChangeTimestampFieldInComposableTemplatePriorToRollOver() throws Exception {\n+        createIndexTemplate(\"id1\", \"logs-foo*\", \"@timestamp\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f256b024717a7c711e7d125cd710b1369f677a3f"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MDUwODI0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMToyODoxMFrOGlBgnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjowODo0MFrOGlCv6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NTIyOA==", "bodyText": "Maybe assert that the parentObjectMapper does not contain a definition for the timestamp field already?\nShould potentially be a production code check in case a component template can have the timestamp field too? Not sure if we guard against that.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r441475228", "createdAt": "2020-06-17T11:28:10Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -493,6 +495,16 @@ private ClusterState applyCreateIndexRequestWithV2Template(final ClusterState cu\n \n         final Map<String, Object> mappings = resolveV2Mappings(request.mappings(), currentState, templateName, xContentRegistry);\n \n+        if (request.dataStreamName() != null) {\n+            DataStream dataStream = currentState.metadata().dataStreams().get(request.dataStreamName());\n+            if (dataStream != null) {\n+                String mappingPath = convertFieldPathToMappingPath(dataStream.getTimeStampField().getFieldName());\n+                String parentObjectFieldPath = mappingPath.substring(0, mappingPath.lastIndexOf('.'));\n+                Map<String, Object> parentObjectMapper = ObjectPath.eval(\"_doc.\" + parentObjectFieldPath, mappings);\n+                parentObjectMapper.put(dataStream.getTimeStampField().getFieldName(), dataStream.getTimeStampField().getFieldMapping());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f256b024717a7c711e7d125cd710b1369f677a3f"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5MDA2MQ==", "bodyText": "Currently the definition is coming from a composable index / component template. So if the name of the timestamp field mapping doesn't change then parentObjectMapper should always contain the mapping definition for the timestamp field.\nOnly if the name of the timestamp field changes then this logic will make sure that the original mapping definition will be used.\nI think verifying whether no mapping definition exists, makes more sense when do this: #58096 (comment)\nIn that case it is expected that the mapping definition for the timestamp_field originates not from composable index or component templates.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r441490061", "createdAt": "2020-06-17T11:57:49Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -493,6 +495,16 @@ private ClusterState applyCreateIndexRequestWithV2Template(final ClusterState cu\n \n         final Map<String, Object> mappings = resolveV2Mappings(request.mappings(), currentState, templateName, xContentRegistry);\n \n+        if (request.dataStreamName() != null) {\n+            DataStream dataStream = currentState.metadata().dataStreams().get(request.dataStreamName());\n+            if (dataStream != null) {\n+                String mappingPath = convertFieldPathToMappingPath(dataStream.getTimeStampField().getFieldName());\n+                String parentObjectFieldPath = mappingPath.substring(0, mappingPath.lastIndexOf('.'));\n+                Map<String, Object> parentObjectMapper = ObjectPath.eval(\"_doc.\" + parentObjectFieldPath, mappings);\n+                parentObjectMapper.put(dataStream.getTimeStampField().getFieldName(), dataStream.getTimeStampField().getFieldMapping());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NTIyOA=="}, "originalCommit": {"oid": "f256b024717a7c711e7d125cd710b1369f677a3f"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NTUyOQ==", "bodyText": "Ah yes, sorry, I was one thought too far ahead.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r441495529", "createdAt": "2020-06-17T12:08:40Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -493,6 +495,16 @@ private ClusterState applyCreateIndexRequestWithV2Template(final ClusterState cu\n \n         final Map<String, Object> mappings = resolveV2Mappings(request.mappings(), currentState, templateName, xContentRegistry);\n \n+        if (request.dataStreamName() != null) {\n+            DataStream dataStream = currentState.metadata().dataStreams().get(request.dataStreamName());\n+            if (dataStream != null) {\n+                String mappingPath = convertFieldPathToMappingPath(dataStream.getTimeStampField().getFieldName());\n+                String parentObjectFieldPath = mappingPath.substring(0, mappingPath.lastIndexOf('.'));\n+                Map<String, Object> parentObjectMapper = ObjectPath.eval(\"_doc.\" + parentObjectFieldPath, mappings);\n+                parentObjectMapper.put(dataStream.getTimeStampField().getFieldName(), dataStream.getTimeStampField().getFieldMapping());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NTIyOA=="}, "originalCommit": {"oid": "f256b024717a7c711e7d125cd710b1369f677a3f"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MDUyMTMzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMTozMjo0MFrOGlBo4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjoxMDo0MlrOGlC0Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NzM0Nw==", "bodyText": "Should we assert that the fieldMapping contains (\"type\")?", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r441477347", "createdAt": "2020-06-17T11:32:40Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -201,4 +204,82 @@ public boolean equals(Object o) {\n     public int hashCode() {\n         return Objects.hash(name, timeStampField, indices, generation);\n     }\n+\n+    public static final class TimestampField implements Writeable, ToXContentObject {\n+\n+        static ParseField FIELD_NAME_FIELD = new ParseField(\"field_name\");\n+        static ParseField FIELD_MAPPING_FIELD = new ParseField(\"field_mapping\");\n+\n+        @SuppressWarnings(\"unchecked\")\n+        private static final ConstructingObjectParser<TimestampField, Void> PARSER = new ConstructingObjectParser<>(\n+            \"timestamp_field\",\n+            args -> new TimestampField((String) args[0], (Map<String, Object>) args[1])\n+        );\n+\n+        static {\n+            PARSER.declareString(ConstructingObjectParser.constructorArg(), FIELD_NAME_FIELD);\n+            PARSER.declareObject(ConstructingObjectParser.optionalConstructorArg(), (p, c) -> p.mapOrdered(), FIELD_MAPPING_FIELD);\n+        }\n+\n+        private final String fieldName;\n+        private final Map<String, Object> fieldMapping;\n+\n+        public TimestampField(String fieldName, Map<String, Object> fieldMapping) {\n+            this.fieldName = fieldName;\n+            this.fieldMapping = fieldMapping;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f256b024717a7c711e7d125cd710b1369f677a3f"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5MTkwMw==", "bodyText": "I added that assert here: https://github.com/elastic/elasticsearch/pull/58096/files#diff-82f348b800c60fabd3a34ff574e248a5R159\nThe reason is that in production, this is where new data stream instances are initiated.\nIdeally this assertion would be added here, but then all tests need to be changes to supply: Map.of(\"type, \"date\") whereas currently tests supply: Map.of(). Maybe it makes sense to add an new constructor that just sets fieldMapping to Map.of(\"type, \"date\") and then delegates to this constructor where we can assert whether type key contains a valid value?", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r441491903", "createdAt": "2020-06-17T12:01:22Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -201,4 +204,82 @@ public boolean equals(Object o) {\n     public int hashCode() {\n         return Objects.hash(name, timeStampField, indices, generation);\n     }\n+\n+    public static final class TimestampField implements Writeable, ToXContentObject {\n+\n+        static ParseField FIELD_NAME_FIELD = new ParseField(\"field_name\");\n+        static ParseField FIELD_MAPPING_FIELD = new ParseField(\"field_mapping\");\n+\n+        @SuppressWarnings(\"unchecked\")\n+        private static final ConstructingObjectParser<TimestampField, Void> PARSER = new ConstructingObjectParser<>(\n+            \"timestamp_field\",\n+            args -> new TimestampField((String) args[0], (Map<String, Object>) args[1])\n+        );\n+\n+        static {\n+            PARSER.declareString(ConstructingObjectParser.constructorArg(), FIELD_NAME_FIELD);\n+            PARSER.declareObject(ConstructingObjectParser.optionalConstructorArg(), (p, c) -> p.mapOrdered(), FIELD_MAPPING_FIELD);\n+        }\n+\n+        private final String fieldName;\n+        private final Map<String, Object> fieldMapping;\n+\n+        public TimestampField(String fieldName, Map<String, Object> fieldMapping) {\n+            this.fieldName = fieldName;\n+            this.fieldMapping = fieldMapping;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NzM0Nw=="}, "originalCommit": {"oid": "f256b024717a7c711e7d125cd710b1369f677a3f"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NjU5NQ==", "bodyText": "Could we not just supply DataStreamTestHelper.defaultMapping() (new method) instead? A few more bytes of source code, but I would prefer asserting this here to avoid something creating this in a wrong way somewhere or under some condition.", "url": "https://github.com/elastic/elasticsearch/pull/58096#discussion_r441496595", "createdAt": "2020-06-17T12:10:42Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/DataStream.java", "diffHunk": "@@ -201,4 +204,82 @@ public boolean equals(Object o) {\n     public int hashCode() {\n         return Objects.hash(name, timeStampField, indices, generation);\n     }\n+\n+    public static final class TimestampField implements Writeable, ToXContentObject {\n+\n+        static ParseField FIELD_NAME_FIELD = new ParseField(\"field_name\");\n+        static ParseField FIELD_MAPPING_FIELD = new ParseField(\"field_mapping\");\n+\n+        @SuppressWarnings(\"unchecked\")\n+        private static final ConstructingObjectParser<TimestampField, Void> PARSER = new ConstructingObjectParser<>(\n+            \"timestamp_field\",\n+            args -> new TimestampField((String) args[0], (Map<String, Object>) args[1])\n+        );\n+\n+        static {\n+            PARSER.declareString(ConstructingObjectParser.constructorArg(), FIELD_NAME_FIELD);\n+            PARSER.declareObject(ConstructingObjectParser.optionalConstructorArg(), (p, c) -> p.mapOrdered(), FIELD_MAPPING_FIELD);\n+        }\n+\n+        private final String fieldName;\n+        private final Map<String, Object> fieldMapping;\n+\n+        public TimestampField(String fieldName, Map<String, Object> fieldMapping) {\n+            this.fieldName = fieldName;\n+            this.fieldMapping = fieldMapping;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NzM0Nw=="}, "originalCommit": {"oid": "f256b024717a7c711e7d125cd710b1369f677a3f"}, "originalPosition": 113}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1618, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}