{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0Njg5NTg5", "number": 56342, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMToxMDo0N1rOD_oJhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMToxMDo0N1rOD_oJhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDQ0Njc2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMToxMDo0N1rOGaZgjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNzoxNDozOFrOGdk8Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMzNDA5NQ==", "bodyText": "There is no batching here.  I worry that this could be really slow if there is a job with 100000 split field values and we detect periodicity in all 100000 time series at the same time.  To avoid the risk it needs to create bulk requests for these model change annotations, then execute these bulk requests when the next bucket result is seen, when the job is flushed, or when the results stream ends (basically wherever we currently call bulkResultsPersister.executeRequest()).", "url": "https://github.com/elastic/elasticsearch/pull/56342#discussion_r430334095", "createdAt": "2020-05-26T11:10:47Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -243,6 +243,10 @@ void processResult(AutodetectResult result) {\n         if (modelPlot != null) {\n             bulkResultsPersister.persistModelPlot(modelPlot);\n         }\n+        Annotation annotation = result.getAnnotation();\n+        if (annotation != null) {\n+            annotationPersister.persistAnnotation(null, annotation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1b783bb59f96f8ce88c5ac66d34c722f490c824"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYzOTE0Ng==", "bodyText": "There is no batching here.\n\nGood point. Let me do it in a separate PR that I'm going to send soon.\nThen I'll merge the preparational PR (batching) before this one (model change results).\n\nAnother thing that needs doing as part of this project is to add a subtype enum field to each annotation to record what sort of annotation it is.\n\nAlready sent for review (#57144).", "url": "https://github.com/elastic/elasticsearch/pull/56342#discussion_r431639146", "createdAt": "2020-05-28T07:37:08Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -243,6 +243,10 @@ void processResult(AutodetectResult result) {\n         if (modelPlot != null) {\n             bulkResultsPersister.persistModelPlot(modelPlot);\n         }\n+        Annotation annotation = result.getAnnotation();\n+        if (annotation != null) {\n+            annotationPersister.persistAnnotation(null, annotation);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMzNDA5NQ=="}, "originalCommit": {"oid": "e1b783bb59f96f8ce88c5ac66d34c722f490c824"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQwOTI4Mg==", "bodyText": "Update:\nbatching is now implemented in #57278", "url": "https://github.com/elastic/elasticsearch/pull/56342#discussion_r432409282", "createdAt": "2020-05-29T10:57:41Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -243,6 +243,10 @@ void processResult(AutodetectResult result) {\n         if (modelPlot != null) {\n             bulkResultsPersister.persistModelPlot(modelPlot);\n         }\n+        Annotation annotation = result.getAnnotation();\n+        if (annotation != null) {\n+            annotationPersister.persistAnnotation(null, annotation);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMzNDA5NQ=="}, "originalCommit": {"oid": "e1b783bb59f96f8ce88c5ac66d34c722f490c824"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzY2NzEzNQ==", "bodyText": "then execute these bulk requests when the next bucket result is seen, when the job is flushed, or when the results stream ends\n\nDone.\n\n(basically wherever we currently call bulkResultsPersister.executeRequest())\n\nThere are some calls to bulkResultsPersister.executeRequest() which I think do not need accompanying calls to bulkAnnotationsPersister.executeRequest(), namely forecasts and quantiles.", "url": "https://github.com/elastic/elasticsearch/pull/56342#discussion_r433667135", "createdAt": "2020-06-02T07:14:38Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -243,6 +243,10 @@ void processResult(AutodetectResult result) {\n         if (modelPlot != null) {\n             bulkResultsPersister.persistModelPlot(modelPlot);\n         }\n+        Annotation annotation = result.getAnnotation();\n+        if (annotation != null) {\n+            annotationPersister.persistAnnotation(null, annotation);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMzNDA5NQ=="}, "originalCommit": {"oid": "e1b783bb59f96f8ce88c5ac66d34c722f490c824"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 606, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}