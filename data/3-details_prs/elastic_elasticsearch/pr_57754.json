{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NjA4OTYx", "number": 57754, "title": "Fix recovery stage transition with sync_id", "bodyText": "If the recovery source is on an old node (before 7.2), then the recovery target won't have the safe commit after phase1 because the recovery source does not send the global checkpoint in the clean_files step. And if the recovery fails and retries, then the recovery stage won't transition properly. If a sync_id is used in peer recovery, then the clean_files step won't be executed to move the stage to TRANSLOG.\nThis issue was addressed in #57187, but not forward-ported to 8.0. I think we should do it as this issue can occur in 8.0. (requires a full cluster restart to 8.0 after a peer recovery on 7.1 fails after it has completed phase 1).\nCloses #57708", "createdAt": "2020-06-05T17:35:08Z", "url": "https://github.com/elastic/elasticsearch/pull/57754", "merged": true, "mergeCommit": {"oid": "bf910e913283045aedc857aabbb029c43b13582e"}, "closed": true, "closedAt": "2020-06-15T17:06:32Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoV_RRAH2gAyNDI4NjA4OTYxOjVmYTM5NzkwNDQ2YmQ3NWRhZGUxYjA5ZTQ4NTAwNzI1ZjRiMjZkOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrjZayAFqTQzMDgxMzgxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5fa39790446bd75dade1b09e48500725f4b26d98", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/5fa39790446bd75dade1b09e48500725f4b26d98", "committedDate": "2020-06-05T17:20:10Z", "message": "Fix recovery stage transition with sync_id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c5cbf36d8faccc29c10396e95002e17f1b80bad", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c5cbf36d8faccc29c10396e95002e17f1b80bad", "committedDate": "2020-06-06T01:59:49Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1OTQ0MjI3", "url": "https://github.com/elastic/elasticsearch/pull/57754#pullrequestreview-425944227", "createdAt": "2020-06-08T06:30:23Z", "commit": {"oid": "4c5cbf36d8faccc29c10396e95002e17f1b80bad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNjozMDoyM1rOGgQqXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNjozMDoyM1rOGgQqXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ4MDYwNg==", "bodyText": "Can we drop this test in v9? If so, can we link Version#V_7_2_0 in the comment to remind us?", "url": "https://github.com/elastic/elasticsearch/pull/57754#discussion_r436480606", "createdAt": "2020-06-08T06:30:23Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/gateway/ReplicaShardAllocatorSyncIdIT.java", "diffHunk": "@@ -243,6 +245,53 @@ public void testFullClusterRestartPerformNoopRecovery() throws Exception {\n         assertNoOpRecoveries(indexName);\n     }\n \n+    /**\n+     * If the recovery source is on an old node (before 7.2), then the recovery target won't have the safe commit after phase1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c5cbf36d8faccc29c10396e95002e17f1b80bad"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c591f94f8b48a4e959e0b89eaadb8335141c06d", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c591f94f8b48a4e959e0b89eaadb8335141c06d", "committedDate": "2020-06-11T17:23:02Z", "message": "Merge branch 'master' into fix-recovery-transition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8d63fb4a00ab5958df4adbd710994d3fc92bc27", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b8d63fb4a00ab5958df4adbd710994d3fc92bc27", "committedDate": "2020-06-11T17:40:49Z", "message": "add version to comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24d42737dad3760c726b6872b6a0cee72d188d02", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/24d42737dad3760c726b6872b6a0cee72d188d02", "committedDate": "2020-06-11T18:57:27Z", "message": "fix code link"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODEzODE0", "url": "https://github.com/elastic/elasticsearch/pull/57754#pullrequestreview-430813814", "createdAt": "2020-06-15T16:39:17Z", "commit": {"oid": "24d42737dad3760c726b6872b6a0cee72d188d02"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3772, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}