{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MzMyNDc2", "number": 62631, "title": "Dense vector field type minor fixes", "bodyText": "The dense vector field is not aggregatable although it produces fielddata through its BinaryDocValuesField. It should pass up hasDocValues set to true to its parent class in its constructor, and return isAggregatable false\nThis may not have consequences today, but it will be important once we try to share the same exists query implementation throughout all of the mappers with #57607.", "createdAt": "2020-09-18T13:55:40Z", "url": "https://github.com/elastic/elasticsearch/pull/62631", "merged": true, "mergeCommit": {"oid": "d669cb500fadd52fd2ceb1dff0fe5a0e9379cc04"}, "closed": true, "closedAt": "2020-09-18T22:27:18Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKF9rFAH2gAyNDg5MzMyNDc2OmVmNDE4Nzg3MmMwOTA3NDc3YTMxNjk1YWY4NjQyZjk1MTcxMDQ4ZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKLs88AFqTQ5MTc2NDkzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef4187872c0907477a31695af8642f95171048f4", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/ef4187872c0907477a31695af8642f95171048f4", "committedDate": "2020-09-18T13:53:22Z", "message": "Dense vector field should set doc_values to true\n\nAs the dense vector field is aggregatable and produces fielddata through its BinaryDocValuesField, it should pass up hasDocValues set to true to its parent class in its constructor.\n\nThis may not have consequences today, but it will be important once we try to share the same exists query implementation throughout all of the mappers with #57607.\n\nAs part of the change we introduce a new test method in FieldTypeTestCase that allows to verify the consistency between hasDocValues and what isAggregatable returns."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNDk1NDI4", "url": "https://github.com/elastic/elasticsearch/pull/62631#pullrequestreview-491495428", "createdAt": "2020-09-18T14:03:19Z", "commit": {"oid": "ef4187872c0907477a31695af8642f95171048f4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDowMzoxOVrOHUOiUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDowNjo0MVrOHUOqzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MTczMA==", "bodyText": "Maybe collapse these two into a single method that takes a boolean parameter?", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r490971730", "createdAt": "2020-09-18T14:03:19Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java", "diffHunk": "@@ -40,4 +40,48 @@ static QueryShardContext createMockQueryShardContext(boolean allowExpensiveQueri\n         return queryShardContext;\n     }\n \n+    protected boolean hasConfigurableDocValues() {\n+        return true;\n+    }\n+\n+    protected abstract MappedFieldType createDefaultFieldType();\n+\n+    protected MappedFieldType createFieldTypeWithDocValuesEnabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef4187872c0907477a31695af8642f95171048f4"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MzkwMQ==", "bodyText": "I\"m not sure that we want to enforce this association between hasDocValues and isAggregatable.  I think they're asserting different things - hasDocValues is an implementation detail about how we build exists queries (and also how we build documents, but that will be going away once all mappers are parametrized), whereas isAggregatable says something about the capabilities of the field.  I can even see hasDocValues() being removed entirely and it just being a member field used for the exists query impl.", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r490973901", "createdAt": "2020-09-18T14:06:41Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/FieldTypeTestCase.java", "diffHunk": "@@ -40,4 +40,48 @@ static QueryShardContext createMockQueryShardContext(boolean allowExpensiveQueri\n         return queryShardContext;\n     }\n \n+    protected boolean hasConfigurableDocValues() {\n+        return true;\n+    }\n+\n+    protected abstract MappedFieldType createDefaultFieldType();\n+\n+    protected MappedFieldType createFieldTypeWithDocValuesEnabled() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    protected MappedFieldType createFieldTypeWithDocValuesDisabled() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    protected boolean isAggregatableWhenDocValuesAreDisabled() {\n+        return false;\n+    }\n+\n+    protected boolean isAggregatableWhenDocValuesAreEnabled() {\n+        return true;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef4187872c0907477a31695af8642f95171048f4"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93e413ec3f26a9fd18450c629f3deac6b7340172", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/93e413ec3f26a9fd18450c629f3deac6b7340172", "committedDate": "2020-09-18T14:45:54Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "247da6bc63105291204f56fb84ac99ace7a76e3a", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/247da6bc63105291204f56fb84ac99ace7a76e3a", "committedDate": "2020-09-18T14:51:46Z", "message": "iter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNTQyNTc1", "url": "https://github.com/elastic/elasticsearch/pull/62631#pullrequestreview-491542575", "createdAt": "2020-09-18T14:56:28Z", "commit": {"oid": "247da6bc63105291204f56fb84ac99ace7a76e3a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDo1NjoyOFrOHUQsiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDo1Njo0M1rOHUQtQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNzExMw==", "bodyText": "Do we still need these changes?", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r491007113", "createdAt": "2020-09-18T14:56:28Z", "author": {"login": "romseygeek"}, "path": "plugins/analysis-icu/src/test/java/org/elasticsearch/index/mapper/CollationFieldTypeTests.java", "diffHunk": "@@ -42,8 +42,12 @@\n \n     private static final Collator DEFAULT_COLLATOR = Collator.getInstance(ULocale.ROOT).freeze();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "247da6bc63105291204f56fb84ac99ace7a76e3a"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwNzI5OQ==", "bodyText": "Same here?", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r491007299", "createdAt": "2020-09-18T14:56:43Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/RangeFieldTypeTests.java", "diffHunk": "@@ -54,7 +54,6 @@\n \n public class RangeFieldTypeTests extends FieldTypeTestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "247da6bc63105291204f56fb84ac99ace7a76e3a"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNjI0MzM0", "url": "https://github.com/elastic/elasticsearch/pull/62631#pullrequestreview-491624334", "createdAt": "2020-09-18T16:43:34Z", "commit": {"oid": "247da6bc63105291204f56fb84ac99ace7a76e3a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dec8daa5d27bab23c6f1aa401d49a65df78d648", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/8dec8daa5d27bab23c6f1aa401d49a65df78d648", "committedDate": "2020-09-18T18:51:47Z", "message": "correct isAggregatable and docValuesByDefault"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a1a1bb8be568460c9624cebcc6be847a8d475bd", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a1a1bb8be568460c9624cebcc6be847a8d475bd", "committedDate": "2020-09-18T18:53:31Z", "message": "Merge branch 'master' into fix/dense_vector_doc_values_true"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdb3c0400dabd089fb47e04738d523679fa1c507", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/cdb3c0400dabd089fb47e04738d523679fa1c507", "committedDate": "2020-09-18T19:14:25Z", "message": "fix testCompile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzY0OTM0", "url": "https://github.com/elastic/elasticsearch/pull/62631#pullrequestreview-491764934", "createdAt": "2020-09-18T20:34:28Z", "commit": {"oid": "cdb3c0400dabd089fb47e04738d523679fa1c507"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDozNDoyOVrOHUbGcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDozNDoyOVrOHUbGcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE3NzU4NA==", "bodyText": "This approach makes sense to me. I wondered if we should FieldMapper#isAggregatable more robust/ general, now that there are field types that produce field data but don't support aggregations. But I think dense_vector is the only example right now, so we can avoid generalizing too early.", "url": "https://github.com/elastic/elasticsearch/pull/62631#discussion_r491177584", "createdAt": "2020-09-18T20:34:29Z", "author": {"login": "jtibshirani"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "diffHunk": "@@ -129,6 +129,11 @@ public Query existsQuery(QueryShardContext context) {\n             return new DocValuesFieldExistsQuery(name());\n         }\n \n+        @Override\n+        public boolean isAggregatable() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdb3c0400dabd089fb47e04738d523679fa1c507"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4786, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}