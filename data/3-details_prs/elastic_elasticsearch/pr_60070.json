{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MjUyMDY0", "number": 60070, "title": "Set timeout of master node requests on follower to unbounded", "bodyText": "Today, a follow task will fail if the master node of the follower cluster is temporarily overloaded and unable to process master node requests (such as update mapping, setting, or alias) from a follow-task within the default timeout. This error is transient, and follow-tasks should not abort. We can avoid this problem by setting the timeout of master node requests on the follower cluster to unbounded.\nCloses #56891", "createdAt": "2020-07-22T17:20:52Z", "url": "https://github.com/elastic/elasticsearch/pull/60070", "merged": true, "mergeCommit": {"oid": "f238d0a3678452b3fc944739effc034e46528eb9"}, "closed": true, "closedAt": "2020-07-27T13:23:31Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3eD_vAH2gAyNDU1MjUyMDY0OjQyYTMwOGU0YmM5YjUwYWMxOTUzNGFiN2MyMWFmNDI4OTE4MjA2NTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc48kB9AFqTQ1NTUyNzM1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "42a308e4bc9b50ac19534ab7c21af42891820656", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/42a308e4bc9b50ac19534ab7c21af42891820656", "committedDate": "2020-07-22T17:13:26Z", "message": "Set timeout of master node requests on follower to unbounded"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzODc2NjE0", "url": "https://github.com/elastic/elasticsearch/pull/60070#pullrequestreview-453876614", "createdAt": "2020-07-23T07:00:53Z", "commit": {"oid": "42a308e4bc9b50ac19534ab7c21af42891820656"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwNzowMDo1M1rOG1-ZmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwNzowMzo0M1rOG1-dsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI1MDA3Mg==", "bodyText": "Should we add this to CcrRequests.putMappingRequest instead? There is one other caller of that method that does something similar (setting it to 30 minutes, mainly because that felt like \"unbounded\" at the time)", "url": "https://github.com/elastic/elasticsearch/pull/60070#discussion_r459250072", "createdAt": "2020-07-23T07:00:53Z", "author": {"login": "ywelsch"}, "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java", "diffHunk": "@@ -158,7 +181,8 @@ protected void innerUpdateMapping(long minRequiredMappingVersion, LongConsumer h\n                             return;\n                         }\n                         MappingMetadata mappingMetadata = indexMetadata.mapping();\n-                        PutMappingRequest putMappingRequest = CcrRequests.putMappingRequest(followerIndex.getName(), mappingMetadata);\n+                        PutMappingRequest putMappingRequest = CcrRequests.putMappingRequest(followerIndex.getName(), mappingMetadata)\n+                            .masterNodeTimeout(UNBOUNDED_TIMEOUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42a308e4bc9b50ac19534ab7c21af42891820656"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI1MTEyMA==", "bodyText": "Instead of checking this here, could we add a transport interceptor in the CCR IT tests that asserts the same thing?", "url": "https://github.com/elastic/elasticsearch/pull/60070#discussion_r459251120", "createdAt": "2020-07-23T07:03:43Z", "author": {"login": "ywelsch"}, "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java", "diffHunk": "@@ -137,7 +144,23 @@ protected AllocatedPersistentTask createTask(long id, String type, String action\n                                                  PersistentTasksCustomMetadata.PersistentTask<ShardFollowTask> taskInProgress,\n                                                  Map<String, String> headers) {\n         ShardFollowTask params = taskInProgress.getParams();\n-        Client followerClient = wrapClient(client, params.getHeaders());\n+        final Client followerClient;\n+        if (Assertions.ENABLED) {\n+            followerClient = new FilterClient(wrapClient(client, params.getHeaders())) {\n+                @Override\n+                protected <Request extends ActionRequest, Response extends ActionResponse>\n+                void doExecute(ActionType<Response> action, Request request, ActionListener<Response> listener) {\n+                    if (request instanceof MasterNodeRequest) {\n+                        final TimeValue masterTimeout = ((MasterNodeRequest<?>) request).masterNodeTimeout();\n+                        assert masterTimeout.nanos() == Long.MAX_VALUE :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42a308e4bc9b50ac19534ab7c21af42891820656"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ad4d4fd4584485b7312bc0ec4f7e03e7af64082", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/6ad4d4fd4584485b7312bc0ec4f7e03e7af64082", "committedDate": "2020-07-23T16:14:09Z", "message": "move timeout for requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de4fc6153915034a1b6cbcfb82b0a205342fed46", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/de4fc6153915034a1b6cbcfb82b0a205342fed46", "committedDate": "2020-07-23T16:47:52Z", "message": "add validation in tests instead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8845591e074d1cdb7552c895db71adb66d1a376", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8845591e074d1cdb7552c895db71adb66d1a376", "committedDate": "2020-07-23T18:49:07Z", "message": "Merge branch 'master' into ccr-request-unbounded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3909afdb8dbc67bf59793d46e1d7d50520d6be9f", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/3909afdb8dbc67bf59793d46e1d7d50520d6be9f", "committedDate": "2020-07-25T00:56:47Z", "message": "set timeout for requests used in tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NTI3MzU0", "url": "https://github.com/elastic/elasticsearch/pull/60070#pullrequestreview-455527354", "createdAt": "2020-07-27T07:19:30Z", "commit": {"oid": "3909afdb8dbc67bf59793d46e1d7d50520d6be9f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4058, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}