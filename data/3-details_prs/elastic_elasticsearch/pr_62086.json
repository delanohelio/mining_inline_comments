{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxOTU3OTY3", "number": 62086, "title": "[Transform] Improve robustness when saving state", "bodyText": "refactor how state is persisted, call doSaveState only from the indexer thread, except there is none.\nfixes #60781\nfixes #52931\nfixes #51629\nfixes #52035", "createdAt": "2020-09-08T10:53:13Z", "url": "https://github.com/elastic/elasticsearch/pull/62086", "merged": true, "mergeCommit": {"oid": "3fc407bd2dea7c3820d668294d3976f8f78d9667"}, "closed": true, "closedAt": "2020-09-28T06:53:45Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHhP8LgBqjM3NTEyMjA1Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMALJTAFqTQ5NTUwNjg4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80bb154d363b835a336eb1c9bdcfdb2cf5bec353", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/80bb154d363b835a336eb1c9bdcfdb2cf5bec353", "committedDate": "2020-09-10T13:41:28Z", "message": "enhance the integration test to do several runs with start and stop"}, "afterCommit": {"oid": "41d1f8babd30c020938bf8ef5d0fedeaab6c820f", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/41d1f8babd30c020938bf8ef5d0fedeaab6c820f", "committedDate": "2020-09-10T13:58:44Z", "message": "enhance the integration test to do several runs with start and stop"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41d1f8babd30c020938bf8ef5d0fedeaab6c820f", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/41d1f8babd30c020938bf8ef5d0fedeaab6c820f", "committedDate": "2020-09-10T13:58:44Z", "message": "enhance the integration test to do several runs with start and stop"}, "afterCommit": {"oid": "37e71c2b42513252f33c8e567736ad34c44fe916", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/37e71c2b42513252f33c8e567736ad34c44fe916", "committedDate": "2020-09-14T06:51:58Z", "message": "enhance the integration test to do several runs with start and stop"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37e71c2b42513252f33c8e567736ad34c44fe916", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/37e71c2b42513252f33c8e567736ad34c44fe916", "committedDate": "2020-09-14T06:51:58Z", "message": "enhance the integration test to do several runs with start and stop"}, "afterCommit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/6f77dacfa489eba7bb70d76eab916b02919244e9", "committedDate": "2020-09-14T07:45:50Z", "message": "enhance the integration test to do several runs with start and stop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NjY1NTUy", "url": "https://github.com/elastic/elasticsearch/pull/62086#pullrequestreview-487665552", "createdAt": "2020-09-14T11:35:46Z", "commit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMTozNTo0NlrOHRPpyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMTo0MTowOFrOHRPz7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0NDI5OQ==", "bodyText": "for loop could be used here as well, making this snippet more concise:\nfor (int retries = 10; retries > 0; --retries) {\n}", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r487844299", "createdAt": "2020-09-14T11:35:46Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/qa/multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformIntegTestCase.java", "diffHunk": "@@ -140,6 +142,26 @@ protected StartTransformResponse startTransform(String id, RequestOptions option\n         }\n     }\n \n+    // workaround for https://github.com/elastic/elasticsearch/issues/62204\n+    protected StartTransformResponse startTransformWithRetryOnConflict(String id, RequestOptions options) throws Exception {\n+        int retries = 10;\n+        ElasticsearchStatusException lastConflict = null;\n+        while (retries > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0NTA4OQ==", "bodyText": "[nit] It's rather style issue, not a real problem here, but I would write this line:\n                if (RestStatus.CONFLICT.equals(e.status()) == false) {\n\nso that NPE is impossible (even theoretically).", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r487845089", "createdAt": "2020-09-14T11:37:25Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/qa/multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformIntegTestCase.java", "diffHunk": "@@ -140,6 +142,26 @@ protected StartTransformResponse startTransform(String id, RequestOptions option\n         }\n     }\n \n+    // workaround for https://github.com/elastic/elasticsearch/issues/62204\n+    protected StartTransformResponse startTransformWithRetryOnConflict(String id, RequestOptions options) throws Exception {\n+        int retries = 10;\n+        ElasticsearchStatusException lastConflict = null;\n+        while (retries > 0) {\n+            try (RestHighLevelClient restClient = new TestRestHighLevelClient()) {\n+                return restClient.transform().startTransform(new StartTransformRequest(id), options);\n+            } catch (ElasticsearchStatusException e) {\n+                if (e.status().equals(RestStatus.CONFLICT) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0NjI5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * can overwrite this, to provide a better logic, when state should be saved.\n          \n          \n            \n                 * can override this, to provide a better logic, when state should be saved.", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r487846293", "createdAt": "2020-09-14T11:39:55Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -244,6 +244,17 @@ public synchronized boolean maybeTriggerAsyncJob(long now) {\n         }\n     }\n \n+    /**\n+     * Checks if the state should be persisted, if true doSaveState is called before continuing. Inherited classes\n+     * can overwrite this, to provide a better logic, when state should be saved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0NjgxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected void runSearchImmediatly() {\n          \n          \n            \n                protected void runSearchImmediately() {", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r487846814", "createdAt": "2020-09-14T11:40:57Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -254,7 +265,16 @@ protected void rethrottle() {\n             return;\n         }\n \n-        reQueueThrottledSearch();\n+        reQueueThrottledSearch(false);\n+    }\n+\n+    /**\n+     * Re-schedules the current search request to run immediately, iff one is scheduled.\n+     *\n+     * Call this if you need the indexer to fast forward a scheduled(throttled) search once in order to complete a full cycle.\n+     */\n+    protected void runSearchImmediatly() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg0Njg5NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Call this if you need the indexer to fast forward a scheduled(throttled) search once in order to complete a full cycle.\n          \n          \n            \n                 * Call this if you need the indexer to fast forward a scheduled (throttled) search once in order to complete a full cycle.", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r487846895", "createdAt": "2020-09-14T11:41:08Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -254,7 +265,16 @@ protected void rethrottle() {\n             return;\n         }\n \n-        reQueueThrottledSearch();\n+        reQueueThrottledSearch(false);\n+    }\n+\n+    /**\n+     * Re-schedules the current search request to run immediately, iff one is scheduled.\n+     *\n+     * Call this if you need the indexer to fast forward a scheduled(throttled) search once in order to complete a full cycle.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3Njk1NzYw", "url": "https://github.com/elastic/elasticsearch/pull/62086#pullrequestreview-487695760", "createdAt": "2020-09-14T12:21:07Z", "commit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjoyMTowN1rOHRRGLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjoyNzo0MlrOHRRVnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2Nzk0OQ==", "bodyText": "Since this is no longer synchronized, it is possible for a stop call or a start call to be executing at any point.\nIs this acceptable?", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r487867949", "createdAt": "2020-09-14T12:21:07Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformTask.java", "diffHunk": "@@ -299,7 +295,7 @@ void setShouldStopAtCheckpoint(boolean shouldStopAtCheckpoint) {\n      * @param shouldStopAtCheckpoint whether or not we should stop at the next checkpoint or not\n      * @param shouldStopAtCheckpointListener the listener to return to when we have persisted the updated value to the state index.\n      */\n-    public synchronized void setShouldStopAtCheckpoint(\n+    public void setShouldStopAtCheckpoint(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2ODAxMA==", "bodyText": "This always assumes that the saving state succeeds. If saving the state fails, the listeners are never called.", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r487868010", "createdAt": "2020-09-14T12:21:17Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -508,6 +518,43 @@ protected void onAbort() {\n         context.shutdown();\n     }\n \n+    protected void callAndResetSaveStateListeners() {\n+        Collection<ActionListener<Void>> listeners = saveStateListeners.getAndSet(null);\n+        if (listeners != null) {\n+            for (ActionListener<Void> l : listeners) {\n+                l.onResponse(null);\n+            }\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg3MTkwMQ==", "bodyText": "It also seems to me that a previous save state could be getting called (its listener executing), and these listeners get triggered. But, it is not their current state (e.g. the one with \"stop at checkpoint\") that was saved, but the previous one that was in the middle of saving.", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r487871901", "createdAt": "2020-09-14T12:27:42Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -508,6 +518,43 @@ protected void onAbort() {\n         context.shutdown();\n     }\n \n+    protected void callAndResetSaveStateListeners() {\n+        Collection<ActionListener<Void>> listeners = saveStateListeners.getAndSet(null);\n+        if (listeners != null) {\n+            for (ActionListener<Void> l : listeners) {\n+                l.onResponse(null);\n+            }\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2ODAxMA=="}, "originalCommit": {"oid": "6f77dacfa489eba7bb70d76eab916b02919244e9"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NDUxMDU4", "url": "https://github.com/elastic/elasticsearch/pull/62086#pullrequestreview-488451058", "createdAt": "2020-09-15T08:33:43Z", "commit": {"oid": "f30b704a51af627a432552e3b7353bfa7ae4d79e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODozMzo0M1rOHR23QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwODozMzo0M1rOHR23QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQ4NjcyMA==", "bodyText": "This line is not needed anymore.", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r488486720", "createdAt": "2020-09-15T08:33:43Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/qa/multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/TransformIntegTestCase.java", "diffHunk": "@@ -140,6 +142,25 @@ protected StartTransformResponse startTransform(String id, RequestOptions option\n         }\n     }\n \n+    // workaround for https://github.com/elastic/elasticsearch/issues/62204\n+    protected StartTransformResponse startTransformWithRetryOnConflict(String id, RequestOptions options) throws Exception {\n+        ElasticsearchStatusException lastConflict = null;\n+        for (int retries = 10; retries > 0; --retries) {\n+            try (RestHighLevelClient restClient = new TestRestHighLevelClient()) {\n+                return restClient.transform().startTransform(new StartTransformRequest(id), options);\n+            } catch (ElasticsearchStatusException e) {\n+                if (RestStatus.CONFLICT.equals(e.status()) == false) {\n+                    throw e;\n+                }\n+\n+                lastConflict = e;\n+                --retries;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30b704a51af627a432552e3b7353bfa7ae4d79e"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0aa4ee46c4b39e8ea5d8c50700181a2a9c2311b", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/d0aa4ee46c4b39e8ea5d8c50700181a2a9c2311b", "committedDate": "2020-09-15T08:36:42Z", "message": "remove superflous line"}, "afterCommit": {"oid": "883ee7699a2081d6c351194ef0f4a1e20c05391c", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/883ee7699a2081d6c351194ef0f4a1e20c05391c", "committedDate": "2020-09-18T15:22:27Z", "message": "add module tests for shopAtCheckpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTgzMjMz", "url": "https://github.com/elastic/elasticsearch/pull/62086#pullrequestreview-492583233", "createdAt": "2020-09-21T13:10:01Z", "commit": {"oid": "9f159e71a3f26ba7a297114655f8b0276cef6530"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzoxMDowMVrOHVPOFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzoxMzowOVrOHVPWFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAzMTUwOQ==", "bodyText": "Could you adjust the comment indicating that this is because the method is synchronized? It took me a second to see that all the triggering methods, etc. were synchronized.\nAlso, it might be good to make this method final so it cannot be overridden and consequently cause MT issues in the future by accident.", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r492031509", "createdAt": "2020-09-21T13:10:01Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -508,6 +522,89 @@ protected void onAbort() {\n         context.shutdown();\n     }\n \n+    /**\n+     * Let the indexer stop at the next checkpoint and call the listener after the flag has been persisted in state.\n+     *\n+     * If the indexer isn't running, persist state if required and call the listener immediately.\n+     */\n+    synchronized void setStopAtCheckpoint(boolean shouldStopAtCheckpoint, ActionListener<Void> shouldStopAtCheckpointListener) {\n+        IndexerState state = getState();\n+\n+        // in case the indexer isn't running, respond immediately\n+        if (state == IndexerState.STARTED && context.shouldStopAtCheckpoint() != shouldStopAtCheckpoint) {\n+            context.setShouldStopAtCheckpoint(shouldStopAtCheckpoint);\n+\n+            // because save state is async we need to block the call until state is persisted, so that the job can not\n+            // be triggered\n+            CountDownLatch latch = new CountDownLatch(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f159e71a3f26ba7a297114655f8b0276cef6530"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAzMzU1OA==", "bodyText": "I think this method call stack goes all the way back to the transport layer:\n\n  \n    \n      elasticsearch/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java\n    \n    \n        Lines 219 to 228\n      in\n      95a7eed\n    \n    \n    \n    \n\n        \n          \n           protected void taskOperation(Request request, TransformTask transformTask, ActionListener<Response> listener) { \n        \n\n        \n          \n            \n        \n\n        \n          \n               Set<String> ids = request.getExpandedIds(); \n        \n\n        \n          \n               if (ids == null) { \n        \n\n        \n          \n                   listener.onFailure(new IllegalStateException(\"Request does not have expandedIds set\")); \n        \n\n        \n          \n                   return; \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               if (ids.contains(transformTask.getTransformId())) { \n        \n\n        \n          \n                   transformTask.setShouldStopAtCheckpoint(request.isWaitForCheckpoint(), ActionListener.wrap(r -> { \n        \n    \n  \n\n\nConsequently, do we know what threadpool we will be locking up for 5 seconds?", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r492033558", "createdAt": "2020-09-21T13:13:09Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -508,6 +522,89 @@ protected void onAbort() {\n         context.shutdown();\n     }\n \n+    /**\n+     * Let the indexer stop at the next checkpoint and call the listener after the flag has been persisted in state.\n+     *\n+     * If the indexer isn't running, persist state if required and call the listener immediately.\n+     */\n+    synchronized void setStopAtCheckpoint(boolean shouldStopAtCheckpoint, ActionListener<Void> shouldStopAtCheckpointListener) {\n+        IndexerState state = getState();\n+\n+        // in case the indexer isn't running, respond immediately\n+        if (state == IndexerState.STARTED && context.shouldStopAtCheckpoint() != shouldStopAtCheckpoint) {\n+            context.setShouldStopAtCheckpoint(shouldStopAtCheckpoint);\n+\n+            // because save state is async we need to block the call until state is persisted, so that the job can not\n+            // be triggered\n+            CountDownLatch latch = new CountDownLatch(1);\n+            try {\n+                doSaveState(IndexerState.STARTED, getPosition(), () -> {\n+                    latch.countDown();\n+                    shouldStopAtCheckpointListener.onResponse(null);\n+                });\n+\n+                latch.await(PERSIST_STOP_AT_CHECKPOINT_TIMEOUT_SEC, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f159e71a3f26ba7a297114655f8b0276cef6530"}, "originalPosition": 70}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36f5ef40fb664fa419420b0c6e434a41976e6858", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/36f5ef40fb664fa419420b0c6e434a41976e6858", "committedDate": "2020-09-21T14:46:59Z", "message": "adapt tests, so it does not assert on the threadpool"}, "afterCommit": {"oid": "5a475ad27f6ce8304527be8dabf363a2c21306dc", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a475ad27f6ce8304527be8dabf363a2c21306dc", "committedDate": "2020-09-21T19:23:31Z", "message": "adapt tests, so it does not assert on the threadpool"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDgyOTcx", "url": "https://github.com/elastic/elasticsearch/pull/62086#pullrequestreview-493482971", "createdAt": "2020-09-22T13:52:28Z", "commit": {"oid": "21840f06251fe6189854de7c16a0c431cb6e6369"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21aa065928e0cc02168aff3633f71c850d878edd", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/21aa065928e0cc02168aff3633f71c850d878edd", "committedDate": "2020-09-22T13:53:33Z", "message": "ensure listeners are called if transform stops"}, "afterCommit": {"oid": "5a5214910f9e517bcb200e23178f265f0c113634", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a5214910f9e517bcb200e23178f265f0c113634", "committedDate": "2020-09-22T15:19:51Z", "message": "ensure listeners are called if transform stops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a5214910f9e517bcb200e23178f265f0c113634", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a5214910f9e517bcb200e23178f265f0c113634", "committedDate": "2020-09-22T15:19:51Z", "message": "ensure listeners are called if transform stops"}, "afterCommit": {"oid": "a7df454cbc34b5b94abadf2af52029a85d656231", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/a7df454cbc34b5b94abadf2af52029a85d656231", "committedDate": "2020-09-23T06:11:45Z", "message": "ensure listeners are called if transform stops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25dfb540a6299cbc70a8e2ded95ee923e2f2b213", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/25dfb540a6299cbc70a8e2ded95ee923e2f2b213", "committedDate": "2020-09-23T10:24:53Z", "message": "refactor how state is persisted, so it can not be called from more than 1\nthread at the same time by moving it completely into the indexer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "196b5c13f4e6d30570f83e5c181400265df26415", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/196b5c13f4e6d30570f83e5c181400265df26415", "committedDate": "2020-09-23T10:24:53Z", "message": "unmute integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "926d68386f5abe12843c59cbc63723d33f9195d3", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/926d68386f5abe12843c59cbc63723d33f9195d3", "committedDate": "2020-09-23T10:24:53Z", "message": "enhance the integration test to do several runs with start and stop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "269f61566b95b95a4d78f2909821b56aeaa4dd37", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/269f61566b95b95a4d78f2909821b56aeaa4dd37", "committedDate": "2020-09-23T10:24:53Z", "message": "apply review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78265d44d0a69e3b75239538eb81ddd3549501c9", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/78265d44d0a69e3b75239538eb81ddd3549501c9", "committedDate": "2020-09-23T10:24:53Z", "message": "ensure saveState listeners are called in either case and fix concurrency\nissue if stopAtCheckpoint is called while doSaveState is waiting for the\nresponse callback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ce27e5b3632c393ae309fcc4933576d37b36d79", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/8ce27e5b3632c393ae309fcc4933576d37b36d79", "committedDate": "2020-09-23T10:24:53Z", "message": "remove superflous line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca5e7b2313b7387fc96e02bd61d7e161f37bcc72", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca5e7b2313b7387fc96e02bd61d7e161f37bcc72", "committedDate": "2020-09-23T10:24:53Z", "message": "Call listener immediately if indexer is not indexing or value hasn't changed.\nUse optimistic lock for listeners"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2364f7443058be6179cdf0c1e1bdd3ea4df0d7ee", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/2364f7443058be6179cdf0c1e1bdd3ea4df0d7ee", "committedDate": "2020-09-23T10:24:53Z", "message": "add module tests for shopAtCheckpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56388b2b4385a0f7ccc273887ff1909e4c6c8b00", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/56388b2b4385a0f7ccc273887ff1909e4c6c8b00", "committedDate": "2020-09-23T10:24:53Z", "message": "add file headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf1ab2775c3458358699e81c049465a434bda4f1", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/bf1ab2775c3458358699e81c049465a434bda4f1", "committedDate": "2020-09-23T10:24:53Z", "message": "persist state if indexer state is started"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "139ba319407142f4ce5503db26ae60a760546fa5", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/139ba319407142f4ce5503db26ae60a760546fa5", "committedDate": "2020-09-23T10:24:53Z", "message": "log if state persistance fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b092ac6d29ce3bb174f7709ea9e35e42cb579c13", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/b092ac6d29ce3bb174f7709ea9e35e42cb579c13", "committedDate": "2020-09-23T10:24:53Z", "message": "do not block the network thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0156590073a2b5cfd5085e8ad52953e805e054a9", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/0156590073a2b5cfd5085e8ad52953e805e054a9", "committedDate": "2020-09-23T10:24:53Z", "message": "adapt tests, so it does not assert on the threadpool"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7829caea17d39e95ecdf5b6ff98e3fc40be7d8", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/cb7829caea17d39e95ecdf5b6ff98e3fc40be7d8", "committedDate": "2020-09-23T10:24:53Z", "message": "add testcase for throttling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "447504b4bb83048c320a978c6ef8f6cc32892b01", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/447504b4bb83048c320a978c6ef8f6cc32892b01", "committedDate": "2020-09-23T10:24:53Z", "message": "assert that state has been persisted with shouldStopAtCheckpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eb2b53e4d2a60de2fbf654925f140f3796d7c99", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/4eb2b53e4d2a60de2fbf654925f140f3796d7c99", "committedDate": "2020-09-23T10:24:53Z", "message": "ensure listeners are called if transform stops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b06dafb6e42e6df56bf1165e3dfae12b01e5f14", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b06dafb6e42e6df56bf1165e3dfae12b01e5f14", "committedDate": "2020-09-23T10:24:53Z", "message": "add back synchronized to setShouldStopAtCheckpoint to avoid problems\nif start runs in parralel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7df454cbc34b5b94abadf2af52029a85d656231", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/a7df454cbc34b5b94abadf2af52029a85d656231", "committedDate": "2020-09-23T06:11:45Z", "message": "ensure listeners are called if transform stops"}, "afterCommit": {"oid": "3b06dafb6e42e6df56bf1165e3dfae12b01e5f14", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b06dafb6e42e6df56bf1165e3dfae12b01e5f14", "committedDate": "2020-09-23T10:24:53Z", "message": "add back synchronized to setShouldStopAtCheckpoint to avoid problems\nif start runs in parralel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1687e322249e47b8cabe7b832bfe6edd62321cbb", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/1687e322249e47b8cabe7b832bfe6edd62321cbb", "committedDate": "2020-09-23T15:32:21Z", "message": "do not call action listener onResponse inside getAndUpdate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38994fb6caadb483e0ad2b34b26ca57e29f6e186", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/38994fb6caadb483e0ad2b34b26ca57e29f6e186", "committedDate": "2020-09-23T15:37:15Z", "message": "simplify by using updateAndGet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "552023a542e233993bd9f827c6255441ccdb381f", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/552023a542e233993bd9f827c6255441ccdb381f", "committedDate": "2020-09-23T16:02:07Z", "message": "make updateAndGet free of side effects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0efdfd87ca0c5f4e0aee98ccf06c3ea2e38d643", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/d0efdfd87ca0c5f4e0aee98ccf06c3ea2e38d643", "committedDate": "2020-09-23T19:04:25Z", "message": "do not call listener from synchronized block"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTA2ODg3", "url": "https://github.com/elastic/elasticsearch/pull/62086#pullrequestreview-495506887", "createdAt": "2020-09-24T12:16:25Z", "commit": {"oid": "d0efdfd87ca0c5f4e0aee98ccf06c3ea2e38d643"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMjoxNjoyNlrOHXXnmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMjoxNjoyNlrOHXXnmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI2NjI2Ng==", "bodyText": "In testing (or where assertions are enabled), this would cause the caller to freeze and never return.\nI am not sure how to assert here AND fire an onFailure result. But, not doing so might cause some frustrating test investigations", "url": "https://github.com/elastic/elasticsearch/pull/62086#discussion_r494266266", "createdAt": "2020-09-24T12:16:26Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -508,6 +522,100 @@ protected void onAbort() {\n         context.shutdown();\n     }\n \n+    /**\n+     * Let the indexer stop at the next checkpoint and call the listener after the flag has been persisted in state.\n+     *\n+     * If the indexer isn't running, persist state if required and call the listener immediately.\n+     */\n+    final void setStopAtCheckpoint(boolean shouldStopAtCheckpoint, ActionListener<Void> shouldStopAtCheckpointListener) {\n+        // this should be called from the generic threadpool\n+        assert Thread.currentThread().getName().contains(ThreadPool.Names.GENERIC);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0efdfd87ca0c5f4e0aee98ccf06c3ea2e38d643"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4750, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}