{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMjQ5NTE0", "number": 55167, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1NDoyNlrODxtihw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwOToxODoxMFrODx_G6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDUyOTM1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1NDoyNlrOGFVfDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMTo0ODozNFrOGF2DfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ==", "bodyText": "Drive-by comment, but does this really need to return a brand new builder? Since the existing builder is being passed in couldn't this be a BiConsumer<Metadata.Builder, IndexMetadata> and modify the builder directly?", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408248079", "createdAt": "2020-04-14T15:54:26Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NzkwMA==", "bodyText": "That makes sense to me if the return value on builder methods is only for enabling a fluent API and not for changing the identity of the builder.", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408257900", "createdAt": "2020-04-14T16:08:02Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NzEzNA==", "bodyText": "This PR didn't have any uses of the actual transaction builder, what is the expected use that will change the identity of the builder?", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408277134", "createdAt": "2020-04-14T16:35:42Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3ODg4MQ==", "bodyText": "@dakrone, it's for rolling over data streams. Create the new backing index and add it to the data stream in the same cluster state update operation.", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408278881", "createdAt": "2020-04-14T16:38:28Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5ODE0MQ==", "bodyText": "I agree that there is no need need for the metadataTransaction to return a new builder instance.\nReturning the same instance should suffice for the use case we would like to do with this change.", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408698141", "createdAt": "2020-04-15T09:15:52Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTkzNA==", "bodyText": "maybe in that spirit also add an assertion that the same metadata builder instance is returned from the function?", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408699934", "createdAt": "2020-04-15T09:18:57Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc4MTY5Mw==", "bodyText": "I think we should just turn it into a BiConsumer instead?", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408781693", "createdAt": "2020-04-15T11:48:34Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 145}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNzQwNTM1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwOToxNzoyOFrOGFxAww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMjoxMToyOFrOGF2yQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTA3NQ==", "bodyText": "Maybe rename metadataTransaction to metadataTransformer?\nSince if provided the function will change the metadata builder.", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408699075", "createdAt": "2020-04-15T09:17:28Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc5MzY2Nw==", "bodyText": "Ah, that is a better name \ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408793667", "createdAt": "2020-04-15T12:11:28Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTA3NQ=="}, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 141}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNzQwNzc3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwOToxODoxMFrOGFxCRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwOToxODoxMFrOGFxCRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTQ2Mw==", "bodyText": "nit: List.of()?", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408699463", "createdAt": "2020-04-15T09:18:10Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -492,7 +508,7 @@ private ClusterState applyCreateIndexRequestWithExistingMetadata(final ClusterSt\n                 // the context is only used for validation so it's fine to pass fake values for the\n                 // shard id and the current timestamp\n                 indexService.newQueryShardContext(0, null, () -> 0L, null)),\n-            Collections.emptyList());\n+            Collections.emptyList(), metadataTransaction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 128}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1157, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}