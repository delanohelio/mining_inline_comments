{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5MzUwMjA4", "number": 52741, "title": "Move states of search to coordinating node", "bodyText": "This commit moves the states of search to the coordinating node instead of keeping them in the data node. Changes in this commit:\n\nInclude ShardSearchRequest to QuerySearchResult\nResend ShardSearchRequest in step 1 in the fetch phase so we can recreate a SearchContext from ShardFetchRequest\nInclude AggregatedDfs to ShardFetchRequest as we need it in both the query and fetch phase\nInclude RecoreDocIds to QuerySearchResult and send it back in the fetch phase\n\nRelates #46523\nI ran a few benchmarks for this change on a single node with http_logs, geonames, and geopoint. There was no regression. I will try to benchmark it with multiple nodes.", "createdAt": "2020-02-25T03:49:02Z", "url": "https://github.com/elastic/elasticsearch/pull/52741", "merged": true, "mergeCommit": {"oid": "206381e6a86c4afb24d70c17c9d854512efc1cbe"}, "closed": true, "closedAt": "2020-03-03T19:33:55Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHpWaAAH2gAyMzc5MzUwMjA4OjZlNmZiZWU1MmI5NDVkNzZmMzYwZDBlYzdiYzdlMjM4MGI2MDRhNGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKGYcJgH2gAyMzc5MzUwMjA4OmYxYmE5ZGQyNDk1ZDBkZGFjZDAyNzBiMjdjOWE3YWQ2NTgxZGIxOTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6e6fbee52b945d76f360d0ec7bc7e2380b604a4c", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e6fbee52b945d76f360d0ec7bc7e2380b604a4c", "committedDate": "2020-02-25T03:14:08Z", "message": "Move search state to coordinating node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8c7e4e8aa15a3d0676b7d0105fe789c36cb6b76", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f8c7e4e8aa15a3d0676b7d0105fe789c36cb6b76", "committedDate": "2020-02-26T16:51:29Z", "message": "Register percolator plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ccec44e0b39a7b91ed4ad6b5c39406a37dd6412", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ccec44e0b39a7b91ed4ad6b5c39406a37dd6412", "committedDate": "2020-02-26T16:52:33Z", "message": "Merge branch 'feature/reader-context' into stateless-search-context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MzY5MzE3", "url": "https://github.com/elastic/elasticsearch/pull/52741#pullrequestreview-366369317", "createdAt": "2020-02-28T12:41:22Z", "commit": {"oid": "1ccec44e0b39a7b91ed4ad6b5c39406a37dd6412"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMjo0MToyMlrOFvzsLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMjo0NTozM1rOFvzzGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NDI4Nw==", "bodyText": "Is this change needed for this pr ? It seems unrelated.", "url": "https://github.com/elastic/elasticsearch/pull/52741#discussion_r385674287", "createdAt": "2020-02-28T12:41:22Z", "author": {"login": "jimczi"}, "path": "modules/percolator/src/test/java/org/elasticsearch/percolator/PercolatorQuerySearchIT.java", "diffHunk": "@@ -71,6 +75,14 @@\n \n public class PercolatorQuerySearchIT extends ESIntegTestCase {\n \n+    @Override\n+    protected Collection<Class<? extends Plugin>> nodePlugins() {\n+        List<Class<? extends Plugin>> plugins = new ArrayList<>();\n+        plugins.addAll(super.nodePlugins());\n+        plugins.add(PercolatorPlugin.class);\n+        return plugins;\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ccec44e0b39a7b91ed4ad6b5c39406a37dd6412"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY3NjA1Nw==", "bodyText": "we could apply the TODO here and clean the (de)serialization ? This would mean reconciling the logic between the different implementations and move the serialization of the object accessible here to this function. Happy to do this in a follow up though.", "url": "https://github.com/elastic/elasticsearch/pull/52741#discussion_r385676057", "createdAt": "2020-02-28T12:45:33Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/SearchPhaseResult.java", "diffHunk": "@@ -90,6 +94,23 @@ public QuerySearchResult queryResult() {\n      */\n     public FetchSearchResult fetchResult() { return null; }\n \n+    @Nullable\n+    public ShardSearchRequest getShardSearchRequest() {\n+        return shardSearchRequest;\n+    }\n+\n+    public void setShardSearchRequest(ShardSearchRequest shardSearchRequest) {\n+        this.shardSearchRequest = shardSearchRequest;\n+    }\n+\n+    public RescoreDocIds getRescoreDocIds() {\n+        return rescoreDocIds;\n+    }\n+\n+    public void setRescoreDocIds(RescoreDocIds rescoreDocIds) {\n+        this.rescoreDocIds = rescoreDocIds;\n+    }\n+\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n         // TODO: this seems wrong, SearchPhaseResult should have a writeTo?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ccec44e0b39a7b91ed4ad6b5c39406a37dd6412"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1ba9dd2495d0ddacd0270b27c9a7ad6581db192", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f1ba9dd2495d0ddacd0270b27c9a7ad6581db192", "committedDate": "2020-03-03T18:11:27Z", "message": "Merge branch 'feature/reader-context' into stateless-search-context"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2135, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}