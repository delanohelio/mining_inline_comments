{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczMDkzMzg2", "number": 61516, "title": "Fix doc-update interceptor for indices with DLS and FLS", "bodyText": "This fixes the protection against updates (and bulk updates) for indices with DLS or FLS, when the request uses date math expressions.", "createdAt": "2020-08-25T10:08:45Z", "url": "https://github.com/elastic/elasticsearch/pull/61516", "merged": true, "mergeCommit": {"oid": "9374db5427666892dcad9274dc7866c9eb59f261"}, "closed": true, "closedAt": "2020-09-22T11:40:40Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCUVb-AH2gAyNDczMDkzMzg2OmIyYWYyMTBkMTcxOTAyNDViZTYyZjU1OGYxYjM3YjE0MmM5MDkwNmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLSN7_gH2gAyNDczMDkzMzg2OmQ0YmRhYTIwODZiMDJmOWUxNThmMGU4Yjc2OWYxMDE0N2E1MmNmNWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b2af210d17190245be62f558f1b37b142c90906a", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2af210d17190245be62f558f1b37b142c90906a", "committedDate": "2020-08-25T10:06:36Z", "message": "Done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd4a0e9e1580887b7afe425cb6eddfb6d9a7921c", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd4a0e9e1580887b7afe425cb6eddfb6d9a7921c", "committedDate": "2020-08-25T10:16:11Z", "message": "Unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a70d87a49102ddae2017850402f0f21dd8e11880", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/a70d87a49102ddae2017850402f0f21dd8e11880", "committedDate": "2020-08-25T10:50:55Z", "message": "Mhm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2b18e7244a40f68a979272f181c8e68283ae8c0", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2b18e7244a40f68a979272f181c8e68283ae8c0", "committedDate": "2020-08-25T13:05:32Z", "message": "assert is not suitable yet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "223f4326386521fe341adb99ec855fe9e6aa4932", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/223f4326386521fe341adb99ec855fe9e6aa4932", "committedDate": "2020-08-25T18:41:32Z", "message": "Tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzU5OTY2", "url": "https://github.com/elastic/elasticsearch/pull/61516#pullrequestreview-474759966", "createdAt": "2020-08-25T18:49:29Z", "commit": {"oid": "223f4326386521fe341adb99ec855fe9e6aa4932"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODo0OToyOVrOHGlUOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODo0OToyOVrOHGlUOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2NDg4OQ==", "bodyText": "This if must go away and be replaced with an assert, but the assert currently trips for enrich policies which make use of reindex.", "url": "https://github.com/elastic/elasticsearch/pull/61516#discussion_r476664889", "createdAt": "2020-08-25T18:49:29Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/interceptor/BulkShardRequestInterceptor.java", "diffHunk": "@@ -43,32 +43,33 @@ public BulkShardRequestInterceptor(ThreadPool threadPool, XPackLicenseState lice\n     public void intercept(RequestInfo requestInfo, AuthorizationEngine authzEngine, AuthorizationInfo authorizationInfo,\n                           ActionListener<Void> listener) {\n         boolean shouldIntercept = licenseState.isSecurityEnabled();\n-        var licenseChecker = new MemoizedSupplier<>(() -> licenseState.checkFeature(Feature.SECURITY_DLS_FLS));\n+        var featureUsageChecker = new MemoizedSupplier<>(() -> licenseState.checkFeature(Feature.SECURITY_DLS_FLS));\n         if (requestInfo.getRequest() instanceof BulkShardRequest && shouldIntercept) {\n             IndicesAccessControl indicesAccessControl = threadContext.getTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY);\n-\n-            final BulkShardRequest bulkShardRequest = (BulkShardRequest) requestInfo.getRequest();\n-            for (BulkItemRequest bulkItemRequest : bulkShardRequest.items()) {\n-                IndicesAccessControl.IndexAccessControl indexAccessControl =\n-                    indicesAccessControl.getIndexPermissions(bulkItemRequest.index());\n-                boolean found = false;\n-                if (indexAccessControl != null) {\n-                    boolean fls = indexAccessControl.getFieldPermissions().hasFieldLevelSecurity();\n-                    boolean dls = indexAccessControl.getDocumentPermissions().hasDocumentLevelPermissions();\n-                    if (fls || dls) {\n-                        if (licenseChecker.get() && bulkItemRequest.request() instanceof UpdateRequest) {\n+            BulkShardRequest bulkShardRequest = (BulkShardRequest) requestInfo.getRequest();\n+            // this uses the {@code BulkShardRequest#index()} because the {@code bulkItemRequest#index()}\n+            // can still be an unresolved date math expression\n+            IndicesAccessControl.IndexAccessControl indexAccessControl = indicesAccessControl.getIndexPermissions(bulkShardRequest.index());\n+            // TODO replace if condition with assertion\n+            if (indexAccessControl != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "223f4326386521fe341adb99ec855fe9e6aa4932"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NDIxODI1", "url": "https://github.com/elastic/elasticsearch/pull/61516#pullrequestreview-476421825", "createdAt": "2020-08-27T06:33:05Z", "commit": {"oid": "223f4326386521fe341adb99ec855fe9e6aa4932"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwNjozMzowNVrOHIB6uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwNjozMzowNVrOHIB6uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODE4MjA3NQ==", "bodyText": "Nit: redundant parenthesis around (UpdateRequest) indicesRequest", "url": "https://github.com/elastic/elasticsearch/pull/61516#discussion_r478182075", "createdAt": "2020-08-27T06:33:05Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/interceptor/UpdateRequestInterceptor.java", "diffHunk": "@@ -33,6 +33,17 @@ protected void disableFeatures(IndicesRequest updateRequest, boolean fieldLevelS\n             \"is enabled\", RestStatus.BAD_REQUEST));\n     }\n \n+    @Override\n+    String[] requestIndices(IndicesRequest indicesRequest) {\n+        if (indicesRequest instanceof UpdateRequest) {\n+            UpdateRequest updateRequest = ((UpdateRequest) indicesRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "223f4326386521fe341adb99ec855fe9e6aa4932"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b45893b365eeff292e83f81c60aa955bdae6a70", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/8b45893b365eeff292e83f81c60aa955bdae6a70", "committedDate": "2020-08-31T13:03:00Z", "message": "Merge branch 'master' into fix_bulk_shard_req_interceptor_for_date_expressions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d59293d9a4427c65d059200b996b657f156b951", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/1d59293d9a4427c65d059200b996b657f156b951", "committedDate": "2020-08-31T13:12:54Z", "message": "Nit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02f5f690c2f92e371f3c30a7e14c3b48e8bf6575", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/02f5f690c2f92e371f3c30a7e14c3b48e8bf6575", "committedDate": "2020-09-07T12:22:03Z", "message": "Merge branch 'master' into fix_bulk_shard_req_interceptor_for_date_expressions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzgyMjMy", "url": "https://github.com/elastic/elasticsearch/pull/61516#pullrequestreview-483782232", "createdAt": "2020-09-08T04:09:12Z", "commit": {"oid": "02f5f690c2f92e371f3c30a7e14c3b48e8bf6575"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDowOToxMlrOHOMBPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNDoxMToxNlrOHOMC-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzOTAzNg==", "bodyText": "Why would we randomise on this rather than just have 2 tests?\nIt feels like having a permanent test with datemath would be a good thing.", "url": "https://github.com/elastic/elasticsearch/pull/61516#discussion_r484639036", "createdAt": "2020-09-08T04:09:12Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/integration/DocumentAndFieldLevelSecurityTests.java", "diffHunk": "@@ -144,6 +149,38 @@ public void testSimpleQuery() {\n         assertThat(response.getHits().getAt(1).getSourceAsMap().get(\"field2\").toString(), equalTo(\"value2\"));\n     }\n \n+    public void testUpdatesAreRejected() {\n+        String indexName = randomFrom(\"<test-{2015.05.05||+1d}>\", \"test\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f5f690c2f92e371f3c30a7e14c3b48e8bf6575"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzOTQ4MA==", "bodyText": "The previous name seems more appropriate to me. The purpose is to check the license allows the feature, not to track usage.", "url": "https://github.com/elastic/elasticsearch/pull/61516#discussion_r484639480", "createdAt": "2020-09-08T04:11:16Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/interceptor/BulkShardRequestInterceptor.java", "diffHunk": "@@ -43,32 +43,33 @@ public BulkShardRequestInterceptor(ThreadPool threadPool, XPackLicenseState lice\n     public void intercept(RequestInfo requestInfo, AuthorizationEngine authzEngine, AuthorizationInfo authorizationInfo,\n                           ActionListener<Void> listener) {\n         boolean shouldIntercept = licenseState.isSecurityEnabled();\n-        var licenseChecker = new MemoizedSupplier<>(() -> licenseState.checkFeature(Feature.SECURITY_DLS_FLS));\n+        var featureUsageChecker = new MemoizedSupplier<>(() -> licenseState.checkFeature(Feature.SECURITY_DLS_FLS));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f5f690c2f92e371f3c30a7e14c3b48e8bf6575"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bb8e39a1bd59ef56002b13e6dad5621aa48407b", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/6bb8e39a1bd59ef56002b13e6dad5621aa48407b", "committedDate": "2020-09-08T11:42:21Z", "message": "Merge branch 'master' into fix_bulk_shard_req_interceptor_for_date_expressions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8654a386301844579a6615a27486ed6af1209bfe", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/8654a386301844579a6615a27486ed6af1209bfe", "committedDate": "2020-09-08T12:05:13Z", "message": "Review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3b73045428630793637ee03ce71498f789afd29", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d3b73045428630793637ee03ce71498f789afd29", "committedDate": "2020-09-14T15:14:32Z", "message": "Merge branch 'master' into fix_bulk_shard_req_interceptor_for_date_expressions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMzU0NjM3", "url": "https://github.com/elastic/elasticsearch/pull/61516#pullrequestreview-490354637", "createdAt": "2020-09-17T08:21:10Z", "commit": {"oid": "d3b73045428630793637ee03ce71498f789afd29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4bdaa2086b02f9e158f0e8b769f10147a52cf5b", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4bdaa2086b02f9e158f0e8b769f10147a52cf5b", "committedDate": "2020-09-22T06:43:55Z", "message": "Merge branch 'master' into fix_bulk_shard_req_interceptor_for_date_expressions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4709, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}