{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0NjQwMzQ5", "number": 64521, "title": "Use data stream for ILM history", "bodyText": "This change moves ILM history from using normal index and legacy template to data streams and composable templates.\nIt also unmutes several ITs to check if using data streams will resolve some race conditions there.", "createdAt": "2020-11-03T10:37:26Z", "url": "https://github.com/elastic/elasticsearch/pull/64521", "merged": true, "mergeCommit": {"oid": "9dedef081d7c7f6b693a4e6f49fac86d40235205"}, "closed": true, "closedAt": "2020-11-09T21:45:44Z", "author": {"login": "probakowski"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY2jgAAH2gAyNTE0NjQwMzQ5OjNiZjRmNTcxMTQzNDA4ZDE2NzBkNWNhYjkzYzNlMDQ4MjdlZGRhODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda7RjJAH2gAyNTE0NjQwMzQ5OjVjYmIwODlmNTdjNWU4ZTQzOWNjM2U3OTNiZDYwZDM4YmFlMGU0MmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3bf4f571143408d1670d5cab93c3e04827edda89", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/3bf4f571143408d1670d5cab93c3e04827edda89", "committedDate": "2020-11-03T10:25:04Z", "message": "ILM history data stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73029fc59346076f32ff0018cc59bff7d51b5517", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/73029fc59346076f32ff0018cc59bff7d51b5517", "committedDate": "2020-11-03T10:31:18Z", "message": "remove unneeded tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b19b7b5904aecdcde6882194db8dfd285c7af6e0", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/b19b7b5904aecdcde6882194db8dfd285c7af6e0", "committedDate": "2020-11-03T22:29:48Z", "message": "add flush"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73ef56ea19a61556ca17ccfead8eef3f88975473", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/73ef56ea19a61556ca17ccfead8eef3f88975473", "committedDate": "2020-11-03T22:48:26Z", "message": "null check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ec4de52624b235ff107d9f6da27fabadaa80500", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ec4de52624b235ff107d9f6da27fabadaa80500", "committedDate": "2020-11-04T00:07:51Z", "message": "discard"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e16b332df299a5cc6aa5a66cea46976e6a8c248", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/1e16b332df299a5cc6aa5a66cea46976e6a8c248", "committedDate": "2020-11-04T00:28:01Z", "message": "null check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17d1d669539efb9692ef4ed3b1660afe7327559a", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/17d1d669539efb9692ef4ed3b1660afe7327559a", "committedDate": "2020-11-04T07:47:52Z", "message": "Revert \"null check\"\n\nThis reverts commit 1e16b332df299a5cc6aa5a66cea46976e6a8c248."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bd1c2d89e1d1984460eabffc1e6c491609a57f1", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/5bd1c2d89e1d1984460eabffc1e6c491609a57f1", "committedDate": "2020-11-04T07:48:03Z", "message": "Revert \"discard\"\n\nThis reverts commit 3ec4de52624b235ff107d9f6da27fabadaa80500."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90922c8d5716ba75b53c26dbd5caee6c1772c125", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/90922c8d5716ba75b53c26dbd5caee6c1772c125", "committedDate": "2020-11-04T08:26:45Z", "message": "ilm history connected to ilm status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7644a989290fef497fbf411118fc212117b0485", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7644a989290fef497fbf411118fc212117b0485", "committedDate": "2020-11-04T09:36:57Z", "message": "test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "833a333d9afb60f088e9cf01feb5bbcadd076534", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/833a333d9afb60f088e9cf01feb5bbcadd076534", "committedDate": "2020-11-04T09:57:05Z", "message": "Merge remote-tracking branch 'origin/master' into ilm-history-data-stream2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e13b573dba5e2238506a465480168e2b6a639584", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/e13b573dba5e2238506a465480168e2b6a639584", "committedDate": "2020-11-04T12:06:42Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94f090016417313c642684bb8762fba984b487af", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/94f090016417313c642684bb8762fba984b487af", "committedDate": "2020-11-04T12:10:45Z", "message": "ignore backing indices from history"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fb80dc811c2ad22e6c245e57dad08cfd82446d4", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/9fb80dc811c2ad22e6c245e57dad08cfd82446d4", "committedDate": "2020-11-04T12:11:49Z", "message": "imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "051319bff95543b3b1802051b1a4cb38ffd34e91", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/051319bff95543b3b1802051b1a4cb38ffd34e91", "committedDate": "2020-11-04T12:12:22Z", "message": "Merge branch 'master' into ilm-history-data-stream2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62ad220558cf182d7d1da11825e6273568be7e37", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/62ad220558cf182d7d1da11825e6273568be7e37", "committedDate": "2020-11-04T12:13:53Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81cfcf0be34024cb30f2f8febc7b24a38d061413", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/81cfcf0be34024cb30f2f8febc7b24a38d061413", "committedDate": "2020-11-04T12:17:43Z", "message": "fix pattern"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8183cd084f4d1aa7a9984f2d2b31cb55b35f802", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8183cd084f4d1aa7a9984f2d2b31cb55b35f802", "committedDate": "2020-11-04T12:19:45Z", "message": "fix pattern"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52330f2813dca52777d557fa1e66dc5045921e2c", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/52330f2813dca52777d557fa1e66dc5045921e2c", "committedDate": "2020-11-04T12:32:10Z", "message": "import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDI0NzQz", "url": "https://github.com/elastic/elasticsearch/pull/64521#pullrequestreview-524424743", "createdAt": "2020-11-05T16:12:30Z", "commit": {"oid": "52330f2813dca52777d557fa1e66dc5045921e2c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjoxMjozMFrOHuKzbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjoxMjozMFrOHuKzbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE3MzU0OQ==", "bodyText": "This looks fishy but it's similar situation as we had before - ILM history index could pop up just after deleting all indices and it didn't do any harm", "url": "https://github.com/elastic/elasticsearch/pull/64521#discussion_r518173549", "createdAt": "2020-11-05T16:12:30Z", "author": {"login": "probakowski"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -646,7 +646,8 @@ private void wipeCluster() throws Exception {\n     protected static void wipeAllIndices() throws IOException {\n         boolean includeHidden = minimumNodeVersion().onOrAfter(Version.V_7_7_0);\n         try {\n-            final Request deleteRequest = new Request(\"DELETE\", \"*\");\n+            //remove all indices except ilm history which can pop up after deleting all data streams but shouldn't interfere\n+            final Request deleteRequest = new Request(\"DELETE\", \"*,-.ds-ilm-history-*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52330f2813dca52777d557fa1e66dc5045921e2c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MDE3MzIy", "url": "https://github.com/elastic/elasticsearch/pull/64521#pullrequestreview-525017322", "createdAt": "2020-11-06T10:10:57Z", "commit": {"oid": "52330f2813dca52777d557fa1e66dc5045921e2c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDoxMDo1OFrOHun5fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDoxMDo1OFrOHun5fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1MDIzOQ==", "bodyText": "I don't think we need this check here as well.\nIs this meant to catch the case when the ilm history was disabled between the time putAsync was called and the bulk was actually executed? If so, I think it'd be fine to allow it to go through as opposed to failing (and the next putAsync call will not record any history items anymore)\nIf we do decide to keep it I believe the exception should report the items it had not indexed.\nWhat do you think?", "url": "https://github.com/elastic/elasticsearch/pull/64521#discussion_r518650239", "createdAt": "2020-11-06T10:10:58Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java", "diffHunk": "@@ -75,18 +65,12 @@ public ILMHistoryStore(Settings nodeSettings, Client client, ClusterService clus\n             new BulkProcessor.Listener() {\n                 @Override\n                 public void beforeBulk(long executionId, BulkRequest request) {\n-                    // Prior to actually performing the bulk, we should ensure the index exists, and\n-                    // if we were unable to create it or it was in a bad state, we should not\n-                    // attempt to index documents.\n-                    try {\n-                        final CompletableFuture<Boolean> indexCreated = new CompletableFuture<>();\n-                        ensureHistoryIndex(client, clusterService.state(), ActionListener.wrap(indexCreated::complete,\n-                            ex -> {\n-                                logger.warn(\"failed to create ILM history store index prior to issuing bulk request\", ex);\n-                                indexCreated.completeExceptionally(ex);\n-                            }));\n-                        indexCreated.get(2, TimeUnit.MINUTES);\n-                    } catch (Exception e) {\n+                    if (ilmHistoryEnabled == false) {\n+                        throw new ElasticsearchException(\"can not index ILM history items when ILM history is disabled\");\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52330f2813dca52777d557fa1e66dc5045921e2c"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTc3NDY1", "url": "https://github.com/elastic/elasticsearch/pull/64521#pullrequestreview-526577465", "createdAt": "2020-11-09T19:18:11Z", "commit": {"oid": "52330f2813dca52777d557fa1e66dc5045921e2c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOToxODoxMVrOHv99Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOToxODoxMVrOHv99Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2MDE3MA==", "bodyText": "Since the indices.lifecycle.history_index_enabled setting is not dynamic, I don't think we need this check (since putAsync will always punt)", "url": "https://github.com/elastic/elasticsearch/pull/64521#discussion_r520060170", "createdAt": "2020-11-09T19:18:11Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/history/ILMHistoryStore.java", "diffHunk": "@@ -75,18 +65,12 @@ public ILMHistoryStore(Settings nodeSettings, Client client, ClusterService clus\n             new BulkProcessor.Listener() {\n                 @Override\n                 public void beforeBulk(long executionId, BulkRequest request) {\n-                    // Prior to actually performing the bulk, we should ensure the index exists, and\n-                    // if we were unable to create it or it was in a bad state, we should not\n-                    // attempt to index documents.\n-                    try {\n-                        final CompletableFuture<Boolean> indexCreated = new CompletableFuture<>();\n-                        ensureHistoryIndex(client, clusterService.state(), ActionListener.wrap(indexCreated::complete,\n-                            ex -> {\n-                                logger.warn(\"failed to create ILM history store index prior to issuing bulk request\", ex);\n-                                indexCreated.completeExceptionally(ex);\n-                            }));\n-                        indexCreated.get(2, TimeUnit.MINUTES);\n-                    } catch (Exception e) {\n+                    if (ilmHistoryEnabled == false) {\n+                        throw new ElasticsearchException(\"can not index ILM history items when ILM history is disabled\");\n+                    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1MDIzOQ=="}, "originalCommit": {"oid": "52330f2813dca52777d557fa1e66dc5045921e2c"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7543e0efcf5208ffb28400f84c9e30e2ca15144d", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/7543e0efcf5208ffb28400f84c9e30e2ca15144d", "committedDate": "2020-11-09T20:45:40Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cbb089f57c5e8e439cc3e793bd60d38bae0e42c", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/5cbb089f57c5e8e439cc3e793bd60d38bae0e42c", "committedDate": "2020-11-09T21:02:50Z", "message": "Merge branch 'master' into ilm-history-data-stream2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 770, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}