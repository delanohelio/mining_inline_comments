{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MTIyODQ1", "number": 53458, "title": "Make classification evaluation metrics work when there is field mapping type mismatch", "bodyText": "This PR makes the comparison used in evaluation metrics more lenient.\nInstead of comparing raw field values, it now compares their string representations so e.g.: actual field value \"1\" and predicted field value 1 are assumed the same.\nRelates #53485", "createdAt": "2020-03-12T09:10:48Z", "url": "https://github.com/elastic/elasticsearch/pull/53458", "merged": true, "mergeCommit": {"oid": "4bfe288d2f20c97c2a195669cee12ca0c73423eb"}, "closed": true, "closedAt": "2020-03-16T13:11:37Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM8hGhABqjMxMjMwNTM0Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOMtLpAH2gAyMzg3MTIyODQ1OjBjNGIwNmY0NzgzMGVjZDEwOWY1OTUyZDhjOTVhMTIyYWViOTljNTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da41f986d1b040e06d67867df67e8dcc35066f1a", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/da41f986d1b040e06d67867df67e8dcc35066f1a", "committedDate": "2020-03-12T10:03:46Z", "message": "Use `equals` instead of `==`"}, "afterCommit": {"oid": "b75cbbef35769ff57cff6a82a95c803053cd4fe2", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/b75cbbef35769ff57cff6a82a95c803053cd4fe2", "committedDate": "2020-03-12T14:23:30Z", "message": "Make accuracy evaluation metric work when there is field mapping type mismatch"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b75cbbef35769ff57cff6a82a95c803053cd4fe2", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/b75cbbef35769ff57cff6a82a95c803053cd4fe2", "committedDate": "2020-03-12T14:23:30Z", "message": "Make accuracy evaluation metric work when there is field mapping type mismatch"}, "afterCommit": {"oid": "b05927cbd61318a84ec2077e1bad0088920074b7", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/b05927cbd61318a84ec2077e1bad0088920074b7", "committedDate": "2020-03-12T14:31:49Z", "message": "Make accuracy evaluation metric work when there is field mapping type mismatch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e66ea305ca4e7d0dfc5072cec80fc814e7b37aa", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e66ea305ca4e7d0dfc5072cec80fc814e7b37aa", "committedDate": "2020-03-16T08:46:57Z", "message": "Make accuracy evaluation metric work when there is field mapping type mismatch"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b05927cbd61318a84ec2077e1bad0088920074b7", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/b05927cbd61318a84ec2077e1bad0088920074b7", "committedDate": "2020-03-12T14:31:49Z", "message": "Make accuracy evaluation metric work when there is field mapping type mismatch"}, "afterCommit": {"oid": "8e66ea305ca4e7d0dfc5072cec80fc814e7b37aa", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e66ea305ca4e7d0dfc5072cec80fc814e7b37aa", "committedDate": "2020-03-16T08:46:57Z", "message": "Make accuracy evaluation metric work when there is field mapping type mismatch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTI4MzM2", "url": "https://github.com/elastic/elasticsearch/pull/53458#pullrequestreview-375128336", "createdAt": "2020-03-16T11:37:35Z", "commit": {"oid": "8e66ea305ca4e7d0dfc5072cec80fc814e7b37aa"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMTozNzozNVrOF2wFUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMTozNzozNVrOF2wFUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1NTIxNg==", "bodyText": "I think buildIsEqualScript or something makes more sense. We are verifying the two fields are equal, not just comparing them. Comparing could also mean gt, or gte which we are not doing.", "url": "https://github.com/elastic/elasticsearch/pull/53458#discussion_r392955216", "createdAt": "2020-03-16T11:37:35Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/evaluation/classification/PainlessScripts.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.ml.dataframe.evaluation.classification;\n+\n+import org.elasticsearch.script.Script;\n+\n+import java.text.MessageFormat;\n+import java.util.Locale;\n+\n+/**\n+ * Painless scripts used by classification metrics in this package.\n+ */\n+final class PainlessScripts {\n+\n+    /**\n+     * Template for the comparison script.\n+     * It uses \"String.valueOf\" method in case the mapping types of the two fields are different.\n+     */\n+    private static final MessageFormat COMPARISON_SCRIPT_TEMPLATE =\n+        new MessageFormat(\"String.valueOf(doc[''{0}''].value).equals(String.valueOf(doc[''{1}''].value))\", Locale.ROOT);\n+\n+    /**\n+     * Builds field comparison script for the given actual and predicted field names.\n+     * @param actualField name of the actual field\n+     * @param predictedField name of the predicted field\n+     * @return script that compares values of actualField and predictedField\n+     */\n+    static Script buildComparisonScript(String actualField, String predictedField) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e66ea305ca4e7d0dfc5072cec80fc814e7b37aa"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c4b06f47830ecd109f5952d8c95a122aeb99c54", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c4b06f47830ecd109f5952d8c95a122aeb99c54", "committedDate": "2020-03-16T11:49:14Z", "message": "Apply review comments and add unit test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1532, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}