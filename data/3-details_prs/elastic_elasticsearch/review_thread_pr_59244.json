{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2Mzk3MjUy", "number": 59244, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzo1NjozNlrOEMmLrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxMjowNlrOEMz2pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNjQzOTQ4OnYy", "diffSide": "RIGHT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/10_basic.yml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzo1NjozNlrOGuzOjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxNDo1MlrOGvIsRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcyNjk5MA==", "bodyText": "This is changed to exemplify a custom @timestamp mapping", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r451726990", "createdAt": "2020-07-08T17:56:36Z", "author": {"login": "andreidan"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/10_basic.yml", "diffHunk": "@@ -28,7 +24,7 @@ setup:\n             mappings:\n               properties:\n                 '@timestamp':\n-                  type: date\n+                  type: date_nanos", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA3ODY2MQ==", "bodyText": "Maybe in the Create data stream yaml test, also check that mapping for the backing index of each data streams to have the correct mapping?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452078661", "createdAt": "2020-07-09T09:14:52Z", "author": {"login": "martijnvg"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/10_basic.yml", "diffHunk": "@@ -28,7 +24,7 @@ setup:\n             mappings:\n               properties:\n                 '@timestamp':\n-                  type: date\n+                  type: date_nanos", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcyNjk5MA=="}, "originalCommit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNjQ2MzM2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODowMzoyNlrOGuzeJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODoyMTowNFrOGu0DKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczMDk4MA==", "bodyText": "Shouldn't this be inside an if to only add this if the template has a data stream component defined?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r451730980", "createdAt": "2020-07-08T18:03:26Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -954,11 +964,14 @@ public static String findV2Template(Metadata metadata, String indexName, boolean\n             .map(ComponentTemplate::template)\n             .map(Template::mappings)\n             .filter(Objects::nonNull)\n-            .collect(Collectors.toList());\n+            .collect(Collectors.toCollection(LinkedList::new));\n         // Add the actual index template's mappings, since it takes the highest precedence\n         Optional.ofNullable(template.template())\n             .map(Template::mappings)\n             .ifPresent(mappings::add);\n+        // add a default mapping for the `@timestamp` field, at the lowest precedence, to make bootstrapping data streams more\n+        // straightforward\n+        mappings.add(0, new CompressedXContent(wrapMappingsIfNecessary(DEFAULT_TIMESTAMP_MAPPING, xContentRegistry)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc0MDQ1OA==", "bodyText": "I was under the impression we always wanted to add it, however I think you're right. Thanks, Lee", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r451740458", "createdAt": "2020-07-08T18:21:04Z", "author": {"login": "andreidan"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -954,11 +964,14 @@ public static String findV2Template(Metadata metadata, String indexName, boolean\n             .map(ComponentTemplate::template)\n             .map(Template::mappings)\n             .filter(Objects::nonNull)\n-            .collect(Collectors.toList());\n+            .collect(Collectors.toCollection(LinkedList::new));\n         // Add the actual index template's mappings, since it takes the highest precedence\n         Optional.ofNullable(template.template())\n             .map(Template::mappings)\n             .ifPresent(mappings::add);\n+        // add a default mapping for the `@timestamp` field, at the lowest precedence, to make bootstrapping data streams more\n+        // straightforward\n+        mappings.add(0, new CompressedXContent(wrapMappingsIfNecessary(DEFAULT_TIMESTAMP_MAPPING, xContentRegistry)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczMDk4MA=="}, "originalCommit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODYwODQ0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo1MzowNlrOGvH54g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMDoxMjo1MFrOGvKv8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2NTc2Mg==", "bodyText": "why linked list?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452065762", "createdAt": "2020-07-09T08:53:06Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -954,11 +964,16 @@ public static String findV2Template(Metadata metadata, String indexName, boolean\n             .map(ComponentTemplate::template)\n             .map(Template::mappings)\n             .filter(Objects::nonNull)\n-            .collect(Collectors.toList());\n+            .collect(Collectors.toCollection(LinkedList::new));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjExMjM3MA==", "bodyText": "because we insert a mapping on the first position below (adding the default @timestamp). That takes linear time with ArrayList as opposed to constant time with the LinkedList. We also don't random access the mappings list but always iterate it on, so it seems like the LinkedList is a better fit for the current use cases.", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452112370", "createdAt": "2020-07-09T10:12:50Z", "author": {"login": "andreidan"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -954,11 +964,16 @@ public static String findV2Template(Metadata metadata, String indexName, boolean\n             .map(ComponentTemplate::template)\n             .map(Template::mappings)\n             .filter(Objects::nonNull)\n-            .collect(Collectors.toList());\n+            .collect(Collectors.toCollection(LinkedList::new));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2NTc2Mg=="}, "originalCommit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODYyMTc5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo1NjoyNlrOGvICJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo1NjoyNlrOGvICJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2Nzg3Nw==", "bodyText": "I think we need to move this side the body of if (indexName.startsWith(DataStream.BACKING_INDEX_PREFIX)) {,\nbecause this should only be applied when a backing index is created (and otherwise a regular create index call and if a template matches with a 'data_stream' definition would get this mapping applied as well).", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452067877", "createdAt": "2020-07-09T08:56:26Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -954,11 +964,16 @@ public static String findV2Template(Metadata metadata, String indexName, boolean\n             .map(ComponentTemplate::template)\n             .map(Template::mappings)\n             .filter(Objects::nonNull)\n-            .collect(Collectors.toList());\n+            .collect(Collectors.toCollection(LinkedList::new));\n         // Add the actual index template's mappings, since it takes the highest precedence\n         Optional.ofNullable(template.template())\n             .map(Template::mappings)\n             .ifPresent(mappings::add);\n+        if (template.getDataStreamTemplate() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODY2OTkzOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateServiceTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOTowOTozMlrOGvIgGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOTowOTozMlrOGvIgGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA3NTU0NQ==", "bodyText": "These are good tests. Maybe also add another test that tests that a user adds a mapping for @timestamp in a composable index template?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452075545", "createdAt": "2020-07-09T09:09:32Z", "author": {"login": "martijnvg"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateServiceTests.java", "diffHunk": "@@ -795,6 +797,97 @@ public void testResolveMappings() throws Exception {\n             equalTo(Map.of(\"_doc\", Map.of(\"properties\", Map.of(\"field3\", Map.of(\"type\", \"integer\"))))));\n     }\n \n+    public void testDefinedTimestampMappingIsAddedForDataStreamTemplates() throws Exception {\n+        final MetadataIndexTemplateService service = getMetadataIndexTemplateService();\n+        ClusterState state = ClusterState.EMPTY_STATE;\n+\n+        ComponentTemplate ct1 = new ComponentTemplate(new Template(null,\n+            new CompressedXContent(\"{\\n\" +\n+                \"      \\\"properties\\\": {\\n\" +\n+                \"        \\\"field1\\\": {\\n\" +\n+                \"          \\\"type\\\": \\\"keyword\\\"\\n\" +\n+                \"        }\\n\" +\n+                \"      }\\n\" +\n+                \"    }\"), null), null, null);\n+\n+        state = service.addComponentTemplate(state, true, \"ct1\", ct1);\n+        ComposableIndexTemplate it = new ComposableIndexTemplate(List.of(\"i*\"),\n+            new Template(null,\n+                new CompressedXContent(\"{\\n\" +\n+                    \"    \\\"properties\\\": {\\n\" +\n+                    \"      \\\"field2\\\": {\\n\" +\n+                    \"        \\\"type\\\": \\\"integer\\\"\\n\" +\n+                    \"      }\\n\" +\n+                    \"    }\\n\" +\n+                    \"  }\"), null),\n+            List.of(\"ct1\"), 0L, 1L, null, new ComposableIndexTemplate.DataStreamTemplate(DEFAULT_TIMESTAMP_FIELD));\n+        state = service.addIndexTemplateV2(state, true, \"my-template\", it);\n+\n+        List<CompressedXContent> mappings = MetadataIndexTemplateService.collectMappings(state, \"my-template\", \"my-index\",\n+            xContentRegistry());\n+\n+        assertNotNull(mappings);\n+        assertThat(mappings.size(), equalTo(3));\n+        List<Map<String, Object>> parsedMappings = mappings.stream()\n+            .map(m -> {\n+                try {\n+                    return MapperService.parseMapping(new NamedXContentRegistry(List.of()), m.string());\n+                } catch (Exception e) {\n+                    logger.error(e);\n+                    fail(\"failed to parse mappings: \" + m.string());\n+                    return null;\n+                }\n+            })\n+            .collect(Collectors.toList());\n+\n+        assertThat(parsedMappings.get(0),\n+            equalTo(Map.of(\"_doc\", Map.of(\"properties\", Map.of(DEFAULT_TIMESTAMP_FIELD, Map.of(\"type\", \"date\"))))));\n+        assertThat(parsedMappings.get(1),\n+            equalTo(Map.of(\"_doc\", Map.of(\"properties\", Map.of(\"field1\", Map.of(\"type\", \"keyword\"))))));\n+        assertThat(parsedMappings.get(2),\n+            equalTo(Map.of(\"_doc\", Map.of(\"properties\", Map.of(\"field2\", Map.of(\"type\", \"integer\"))))));\n+    }\n+\n+    public void testUserDefinedMappingTakesPrecedenceOverDefault() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxODY3OTQyOnYy", "diffSide": "RIGHT", "path": "docs/reference/data-streams/set-up-a-data-stream.asciidoc", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxMjowNlrOGvIl9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxMjowNlrOGvIl9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA3NzA0Ng==", "bodyText": "maybe include the mapping snippet or that a date field with default options is then used?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452077046", "createdAt": "2020-07-09T09:12:06Z", "author": {"login": "martijnvg"}, "path": "docs/reference/data-streams/set-up-a-data-stream.asciidoc", "diffHunk": "@@ -134,16 +134,22 @@ this pattern.\n property. The `@timestamp` field must be included in every document indexed to\n the data stream.\n \n-* A <<date,`date`>> or <<date_nanos,`date_nanos`>> field mapping for the\n-`@timestamp` field.\n+The template can also contain:\n+\n+* An optional field mapping for the `@timestamp` field. Both the <<date,`date`>> and \n+<<date_nanos,`date_nanos`>> field data types are supported. If no mapping is specified,\n+the <<date,`date`>> field data type is used by default.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1892, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}