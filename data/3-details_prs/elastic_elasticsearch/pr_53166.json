{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0Mjg5NTIw", "number": 53166, "title": "Check for query cancellation during rewrite", "bodyText": "With ExitableDirectoryReader in place, check for query cancellation\nduring QueryPhase#preProcess where the query rewriting takes place.\nFollows: #52822", "createdAt": "2020-03-05T13:55:23Z", "url": "https://github.com/elastic/elasticsearch/pull/53166", "merged": true, "mergeCommit": {"oid": "0d38626d8e6e9e2620a7a446b617a2ac42852461"}, "closed": true, "closedAt": "2020-03-05T23:19:12Z", "author": {"login": "matriv"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKsA12AH2gAyMzg0Mjg5NTIwOmYwZDc3OGY5N2NhMjZiNTFjMjc1OWMxNTNlODA0ZWVmNWE3YTc4YmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKy7PUgH2gAyMzg0Mjg5NTIwOjEyNTMzMDEwNGI0MTM2NjVlNWJiM2ExZGJkZTc0OWE3NzUxYmJhYmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0d778f97ca26b51c2759c153e804eef5a7a78bd", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/f0d778f97ca26b51c2759c153e804eef5a7a78bd", "committedDate": "2020-03-05T14:02:04Z", "message": "Check for query cancellation during rewrite\n\nWith ExitableDirectoryReader in place, check for query cancellation\nduring QueryPhase#preProcess where the query rewriting takes place.\n\nFollows: #52822"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38a794e6c8dd3561146bb4f683e887b861deae54", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/38a794e6c8dd3561146bb4f683e887b861deae54", "committedDate": "2020-03-05T13:54:33Z", "message": "Check for query cancellation during rewrite\n\nWith ExitableDirectoryReader in place, check for query cancellation\nduring QueryPhase#preProcess where the query rewriting takes place.\n\nFollows: #52822"}, "afterCommit": {"oid": "f0d778f97ca26b51c2759c153e804eef5a7a78bd", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/f0d778f97ca26b51c2759c153e804eef5a7a78bd", "committedDate": "2020-03-05T14:02:04Z", "message": "Check for query cancellation during rewrite\n\nWith ExitableDirectoryReader in place, check for query cancellation\nduring QueryPhase#preProcess where the query rewriting takes place.\n\nFollows: #52822"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTkyODc2", "url": "https://github.com/elastic/elasticsearch/pull/53166#pullrequestreview-369592876", "createdAt": "2020-03-05T14:04:30Z", "commit": {"oid": "f0d778f97ca26b51c2759c153e804eef5a7a78bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d7076988955d34bc99a0a30df669c034a9214bf", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/3d7076988955d34bc99a0a30df669c034a9214bf", "committedDate": "2020-03-05T14:21:45Z", "message": "fix checktyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/301f0c21ed3b0f0bf2d107e22e05becfa32ddddd", "committedDate": "2020-03-05T17:21:23Z", "message": "use try-with-resources for reader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTA5NTIy", "url": "https://github.com/elastic/elasticsearch/pull/53166#pullrequestreview-369909522", "createdAt": "2020-03-05T20:59:15Z", "commit": {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDo1OToxNVrOFyj9Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMToxMDozMlrOFykRXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2MjIzNA==", "bodyText": "I think it's safe to ignore this parameter. Let's leave it for now but I wonder if we should simply remove this setting in a follow up. @jpountz what do you think ? I can open an issue if you think this deserves a full discussion.", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388562234", "createdAt": "2020-03-05T20:59:15Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -110,7 +109,23 @@ public QueryPhase() {\n \n     @Override\n     public void preProcess(SearchContext context) {\n-        context.preProcess(true);\n+        final Runnable cancellation;\n+        if (context.lowLevelCancellation()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2Njc5Nw==", "bodyText": "let's get the task once outside of the runnable like we do below ?", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388566797", "createdAt": "2020-03-05T21:09:21Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -110,7 +109,23 @@ public QueryPhase() {\n \n     @Override\n     public void preProcess(SearchContext context) {\n-        context.preProcess(true);\n+        final Runnable cancellation;\n+        if (context.lowLevelCancellation()) {\n+            cancellation = context.searcher().addQueryCancellation(() -> {\n+                if (context.getTask().isCancelled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2NzM5MA==", "bodyText": "I have a slight preference for this version. The task should never change during the execution of a search request.", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388567390", "createdAt": "2020-03-05T21:10:32Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -265,9 +280,8 @@ static boolean executeInternal(SearchContext searchContext) throws QueryPhaseExe\n             }\n \n             if (searchContext.lowLevelCancellation()) {\n-                SearchShardTask task = searchContext.getTask();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8615408cd9a4a5e5aa4626e02826fc35ed48666f", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/8615408cd9a4a5e5aa4626e02826fc35ed48666f", "committedDate": "2020-03-05T21:41:46Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "125330104b413665e5bb3a1dbde749a7751bbabc", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/125330104b413665e5bb3a1dbde749a7751bbabc", "committedDate": "2020-03-05T22:05:17Z", "message": "move task out of the runnable"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1794, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}