{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNzg4NzY0", "number": 53913, "title": "Disallow negative TimeValues", "bodyText": "This commit causes negative TimeValues, other than -1 which is sometimes used as\na sentinel value, to be rejected during parsing.\nAlso introduces a hack to allow ILM to load policies which were written to the\ncluster state with a negative min_age, treating those values as 0, which should\nmatch the behavior of prior versions.\nFixes #54041", "createdAt": "2020-03-21T00:20:04Z", "url": "https://github.com/elastic/elasticsearch/pull/53913", "merged": true, "mergeCommit": {"oid": "e9bc3e8234b4f1a3785101481a46e01541f8fdaf"}, "closed": true, "closedAt": "2020-03-26T15:22:09Z", "author": {"login": "gwbrown"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPpEWGAH2gAyMzkxNzg4NzY0OjhjMmE3NDJjN2Y2YmVhZDMxOTNkNTBkMWY4OTM5YWIwMDBjNGNhYmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRQQXUgH2gAyMzkxNzg4NzY0OmY4OTNlMTc1MGU0OTkyMzJjNzUzYTlkYjE0NzY5Zjc3ZjNiOTA3NTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c2a742c7f6bead3193d50d1f8939ab000c4cabd", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c2a742c7f6bead3193d50d1f8939ab000c4cabd", "committedDate": "2020-03-20T23:25:48Z", "message": "Disallow negative TimeValues\n\nThis commit causes negative TimeValues, other than -1 which is sometimes used as\na sentinel value, to be rejected during parsing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc2a587943c526e9620cc10ff7e024ae366f8cdb", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc2a587943c526e9620cc10ff7e024ae366f8cdb", "committedDate": "2020-03-21T00:01:14Z", "message": "Adjust error message for negative TimeValues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b4535730d36fbc9612531926c3206bdc044ff0e", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/8b4535730d36fbc9612531926c3206bdc044ff0e", "committedDate": "2020-03-21T00:02:11Z", "message": "Check for new message in tests for rejection of negative TimeValues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "025074ff6b43693fa04073450880742824feb0e2", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/025074ff6b43693fa04073450880742824feb0e2", "committedDate": "2020-03-23T22:40:19Z", "message": "Merge branch 'master' into fix-timevalue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df20456abf576728d265e1beb4a2cd666f04065a", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/df20456abf576728d265e1beb4a2cd666f04065a", "committedDate": "2020-03-23T23:22:30Z", "message": "Add workaround for ILM policies with negative min_age"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af86c3df51abdbfbb8b853357dec279260ce98a2", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/af86c3df51abdbfbb8b853357dec279260ce98a2", "committedDate": "2020-03-23T23:39:59Z", "message": "Add clarifying comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f2636ac4427e3f4dbf5c2716dd93d73db069d0e", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f2636ac4427e3f4dbf5c2716dd93d73db069d0e", "committedDate": "2020-03-24T00:07:00Z", "message": "Check for negative durations in constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5baf1f5bf717e886f83dc6864e92a9432c5b9143", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/5baf1f5bf717e886f83dc6864e92a9432c5b9143", "committedDate": "2020-03-24T00:14:35Z", "message": "Line length"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df6900e8a079bc02ec53bae8c47f6ee910aab937", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/df6900e8a079bc02ec53bae8c47f6ee910aab937", "committedDate": "2020-03-24T02:39:42Z", "message": "Fix a giant pile of tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f129e8747f4d903a20126b10805a6dec1a7b031", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f129e8747f4d903a20126b10805a6dec1a7b031", "committedDate": "2020-03-24T02:40:11Z", "message": "Merge branch 'master' into fix-timevalue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5OTYwMzMz", "url": "https://github.com/elastic/elasticsearch/pull/53913#pullrequestreview-379960333", "createdAt": "2020-03-24T02:30:35Z", "commit": {"oid": "5baf1f5bf717e886f83dc6864e92a9432c5b9143"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMjozMDozNlrOF6e-Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMjo0OTo0NFrOF6fRQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg2OTIxNA==", "bodyText": "Can you add an assert Version.CURRENT.major < 9 so that we remove this when we bump master to 9.0.0?", "url": "https://github.com/elastic/elasticsearch/pull/53913#discussion_r396869214", "createdAt": "2020-03-24T02:30:36Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/Phase.java", "diffHunk": "@@ -40,7 +44,19 @@\n                     .collect(Collectors.toMap(LifecycleAction::getWriteableName, Function.identity()))));\n     static {\n         PARSER.declareField(ConstructingObjectParser.optionalConstructorArg(),\n-                (p, c) -> TimeValue.parseTimeValue(p.text(), MIN_AGE.getPreferredName()), MIN_AGE, ValueType.VALUE);\n+            (ContextParser<String, Object>) (p, c) -> {\n+                // In earlier versions it was possible to create a Phase with a negative `min_age` which would then cause errors\n+                // when the phase is read from the cluster state during startup (even before negative timevalues were strictly\n+                // disallowed) so this is a hack to treat negative `min_age`s as 0 to prevent those errors.\n+                // They will be saved as `0` so this hack can be removed once we no longer have to read cluster states from 7.x.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5baf1f5bf717e886f83dc6864e92a9432c5b9143"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg3MTU2Mw==", "bodyText": "I'm not sure that I like that we are manually parsing settings here. I understand that we're doing it to have the full setting name. How about:\ndiff --git a/server/src/main/java/org/elasticsearch/monitor/jvm/JvmGcMonitorService.java b/server/src/main/java/org/elasticsearch/monitor/jvm/JvmGcMonitorService.java\nindex 5744814293f..cad01bd9856 100644\n--- a/server/src/main/java/org/elasticsearch/monitor/jvm/JvmGcMonitorService.java\n+++ b/server/src/main/java/org/elasticsearch/monitor/jvm/JvmGcMonitorService.java\n@@ -165,11 +165,15 @@ public class JvmGcMonitorService extends AbstractLifecycleComponent {\n     }\n \n     private static TimeValue getValidThreshold(Settings settings, String key, String level) {\n-        final String thresholdString = settings.get(level, null);\n-        if (thresholdString == null) {\n+        final TimeValue threshold;\n+        try {\n+            threshold = settings.getAsTime(level, null);\n+        } catch (final IllegalArgumentException e) {\n+            throw new IllegalArgumentException(\"failed to parse [\" + getThresholdName(key, level) + \"]\", e);\n+        }\n+        if (threshold == null) {\n             throw new IllegalArgumentException(\"missing gc_threshold for [\" + getThresholdName(key, level) + \"]\");\n         }\n-        TimeValue threshold = TimeValue.parseTimeValue(thresholdString, null, getThresholdName(key, level));\n         return threshold;\n     }\nand the necessary update to the test (assert the message, assert the cause, assert the message on the cause)?", "url": "https://github.com/elastic/elasticsearch/pull/53913#discussion_r396871563", "createdAt": "2020-03-24T02:40:06Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/monitor/jvm/JvmGcMonitorService.java", "diffHunk": "@@ -165,13 +165,11 @@ public JvmGcMonitorService(Settings settings, ThreadPool threadPool) {\n     }\n \n     private static TimeValue getValidThreshold(Settings settings, String key, String level) {\n-        TimeValue threshold = settings.getAsTime(level, null);\n-        if (threshold == null) {\n+        final String thresholdString = settings.get(level, null);\n+        if (thresholdString == null) {\n             throw new IllegalArgumentException(\"missing gc_threshold for [\" + getThresholdName(key, level) + \"]\");\n         }\n-        if (threshold.nanos() <= 0) {\n-            throw new IllegalArgumentException(\"invalid gc_threshold [\" + threshold + \"] for [\" + getThresholdName(key, level) + \"]\");\n-        }\n+        TimeValue threshold = TimeValue.parseTimeValue(thresholdString, null, getThresholdName(key, level));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5baf1f5bf717e886f83dc6864e92a9432c5b9143"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg3MzkzNg==", "bodyText": "Wait, this shouldn't be necessary? I see tests we are passing in -1? Those aren't realistic though, right?", "url": "https://github.com/elastic/elasticsearch/pull/53913#discussion_r396873936", "createdAt": "2020-03-24T02:49:19Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/index/shard/IndexingStats.java", "diffHunk": "@@ -133,7 +133,12 @@ public long getDeleteCount() {\n         /**\n          * The total amount of time spend on executing delete operations.\n          */\n-        public TimeValue getDeleteTime() { return new TimeValue(deleteTimeInMillis); }\n+        public TimeValue getDeleteTime() {\n+            if (deleteTimeInMillis >= -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f129e8747f4d903a20126b10805a6dec1a7b031"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg3Mzk4NQ==", "bodyText": "Wait, this shouldn't be necessary? I see tests we are passing in -1? Those aren't realistic though, right?", "url": "https://github.com/elastic/elasticsearch/pull/53913#discussion_r396873985", "createdAt": "2020-03-24T02:49:31Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/index/search/stats/SearchStats.java", "diffHunk": "@@ -190,7 +196,10 @@ public long getSuggestTimeInMillis() {\n         }\n \n         public TimeValue getSuggestTime() {\n-            return new TimeValue(suggestTimeInMillis);\n+            if (suggestTimeInMillis >= -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f129e8747f4d903a20126b10805a6dec1a7b031"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg3NDAzMQ==", "bodyText": "Wait, this shouldn't be necessary? I see tests we are passing in -1? Those aren't realistic though, right?", "url": "https://github.com/elastic/elasticsearch/pull/53913#discussion_r396874031", "createdAt": "2020-03-24T02:49:39Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/index/search/stats/SearchStats.java", "diffHunk": "@@ -170,7 +173,10 @@ public long getScrollCount() {\n         }\n \n         public TimeValue getScrollTime() {\n-            return new TimeValue(scrollTimeInMillis);\n+            if (scrollTimeInMillis >= -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f129e8747f4d903a20126b10805a6dec1a7b031"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg3NDA1MQ==", "bodyText": "Wait, this shouldn't be necessary? I see tests we are passing in -1? Those aren't realistic though, right?", "url": "https://github.com/elastic/elasticsearch/pull/53913#discussion_r396874051", "createdAt": "2020-03-24T02:49:44Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/index/search/stats/SearchStats.java", "diffHunk": "@@ -154,7 +154,10 @@ public long getFetchCount() {\n         }\n \n         public TimeValue getFetchTime() {\n-            return new TimeValue(fetchTimeInMillis);\n+            if (fetchTimeInMillis >= -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f129e8747f4d903a20126b10805a6dec1a7b031"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "222bd830d44f19132867f05e5b801a6de57362c9", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/222bd830d44f19132867f05e5b801a6de57362c9", "committedDate": "2020-03-24T21:16:42Z", "message": "Version assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcd33b8022083f83c78297d291a752215a26c382", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/bcd33b8022083f83c78297d291a752215a26c382", "committedDate": "2020-03-24T22:15:46Z", "message": "Adjust setting parsing per review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81e64581c3a49a4bdda590a5f1418c6f841d885a", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/81e64581c3a49a4bdda590a5f1418c6f841d885a", "committedDate": "2020-03-24T22:16:06Z", "message": "Merge branch 'master' into fix-timevalue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9bfb7312532159cca4e6e2cb6ef0fd09aec0e21", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9bfb7312532159cca4e6e2cb6ef0fd09aec0e21", "committedDate": "2020-03-24T22:38:37Z", "message": "Copy/paste ExplainResponse test fix from client to core"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5567b7adc157c7e9eae9a3c67860634da888be84", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/5567b7adc157c7e9eae9a3c67860634da888be84", "committedDate": "2020-03-24T23:31:57Z", "message": "Avoid negative TimeValues during serialization of incomplete snapshots"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzkxMDM1", "url": "https://github.com/elastic/elasticsearch/pull/53913#pullrequestreview-380791035", "createdAt": "2020-03-25T00:41:56Z", "commit": {"oid": "5567b7adc157c7e9eae9a3c67860634da888be84"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMDo0MTo1N1rOF7IQ7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwMDo0MTo1N1rOF7IQ7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzU0NTcxMA==", "bodyText": "Also, I'm wondering if the better long-term fix is to make the GC threshold settings not be group settings anymore, but affix settings. Then we would not need to resort this, as we'd get the proper setting named pushed down anyway, and this wrapping would be necessary. I think that would be a good follow up to this one.", "url": "https://github.com/elastic/elasticsearch/pull/53913#discussion_r397545710", "createdAt": "2020-03-25T00:41:57Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/monitor/jvm/JvmGcMonitorService.java", "diffHunk": "@@ -165,13 +165,20 @@ public JvmGcMonitorService(Settings settings, ThreadPool threadPool) {\n     }\n \n     private static TimeValue getValidThreshold(Settings settings, String key, String level) {\n-        TimeValue threshold = settings.getAsTime(level, null);\n+        final TimeValue threshold;\n+\n+        try {\n+            threshold = settings.getAsTime(level, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5567b7adc157c7e9eae9a3c67860634da888be84"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41c80954c00a6aa5d0334da5d0cfcf278e6cc6b6", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/41c80954c00a6aa5d0334da5d0cfcf278e6cc6b6", "committedDate": "2020-03-25T19:11:05Z", "message": "Copy/paste Enrich stats test fix from core to client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a29c6396937388314b3981ec7f3fd7fd4254471b", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/a29c6396937388314b3981ec7f3fd7fd4254471b", "committedDate": "2020-03-25T21:17:05Z", "message": "Undo stats serialization changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac9e0f4b71ed6eb078710e7f546cf5da08630e57", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/ac9e0f4b71ed6eb078710e7f546cf5da08630e57", "committedDate": "2020-03-25T21:27:18Z", "message": "Merge branch 'master' into fix-timevalue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "996b4a2c865a095baee1166956bb85bcfe78cdf6", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/996b4a2c865a095baee1166956bb85bcfe78cdf6", "committedDate": "2020-03-25T21:42:50Z", "message": "Replace unrealistic, breakage-causing -1s in test with 0s"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNTYyNzU2", "url": "https://github.com/elastic/elasticsearch/pull/53913#pullrequestreview-381562756", "createdAt": "2020-03-25T21:50:03Z", "commit": {"oid": "996b4a2c865a095baee1166956bb85bcfe78cdf6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo1MDowM1rOF7vtHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMTo1MDowM1rOF7vtHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE5MTkwMQ==", "bodyText": "Super minor nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"durations cannot be negative, was given [\" + duration + \"]\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"duration cannot be negative, was given [\" + duration + \"]\");", "url": "https://github.com/elastic/elasticsearch/pull/53913#discussion_r398191901", "createdAt": "2020-03-25T21:50:03Z", "author": {"login": "dakrone"}, "path": "libs/core/src/main/java/org/elasticsearch/common/unit/TimeValue.java", "diffHunk": "@@ -47,6 +47,9 @@ public TimeValue(long millis) {\n     }\n \n     public TimeValue(long duration, TimeUnit timeUnit) {\n+        if (duration < -1) {\n+            throw new IllegalArgumentException(\"durations cannot be negative, was given [\" + duration + \"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "996b4a2c865a095baee1166956bb85bcfe78cdf6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4ac3bd111571b06049ea00f1623f544474bd25b", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4ac3bd111571b06049ea00f1623f544474bd25b", "committedDate": "2020-03-25T23:25:49Z", "message": "Plural->singular per review\n\nCo-Authored-By: Lee Hinman <dakrone@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f893e1750e499232c753a9db14769f77f3b90751", "author": {"user": {"login": "gwbrown", "name": "Gordon Brown"}}, "url": "https://github.com/elastic/elasticsearch/commit/f893e1750e499232c753a9db14769f77f3b90751", "committedDate": "2020-03-25T23:39:09Z", "message": "Singular->plural in test as well"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1938, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}