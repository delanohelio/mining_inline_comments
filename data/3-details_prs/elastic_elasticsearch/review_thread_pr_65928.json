{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzNTM4MzU0", "number": 65928, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDozNDozNFrOFBtZyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwODoxNDoxOFrOFCL0Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MzM2Nzc2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDozNDozNFrOIAgNAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwNzo1ODo0N1rOIBL69A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM5ODUzMQ==", "bodyText": "config.getSyncConfig() is null for batch mode. Seems to make sense to\n\nbranch based on batch vs. continuous\nadd filter changeCollector.buildFilterQuery only if nextCheckpoint.getCheckpoint() > 1", "url": "https://github.com/elastic/elasticsearch/pull/65928#discussion_r537398531", "createdAt": "2020-12-07T10:34:34Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -875,23 +875,14 @@ private SearchSourceBuilder buildUpdateQuery(SearchSourceBuilder sourceBuilder)\n \n         function.buildSearchQuery(sourceBuilder, position != null ? position.getIndexerPosition() : null, pageSize);\n \n-        // if its either the 1st run or not continuous, do not apply extra filters\n-        if (nextCheckpoint.getCheckpoint() == 1 || isContinuous() == false) {\n-            sourceBuilder.query(queryBuilder);\n-            logger.debug(() -> new ParameterizedMessage(\"[{}] Querying for data: {}\", getJobId(), sourceBuilder));\n-\n-            return sourceBuilder;\n-        }\n-\n-        BoolQueryBuilder filteredQuery = new BoolQueryBuilder().filter(queryBuilder)\n-            .filter(config.getSyncConfig().getRangeQuery(nextCheckpoint));\n-\n-        QueryBuilder filter = changeCollector != null\n-            ? changeCollector.buildFilterQuery(lastCheckpoint.getTimeUpperBound(), nextCheckpoint.getTimeUpperBound())\n-            : null;\n-\n-        if (filter != null) {\n-            filteredQuery.filter(filter);\n+        BoolQueryBuilder filteredQuery =\n+            new BoolQueryBuilder()\n+                .filter(queryBuilder)\n+                .filter(config.getSyncConfig().getRangeQuery(nextCheckpoint));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "252dc4ec1e916d4c6723eefc9d4485070353dd64"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODExNDgwNA==", "bodyText": "Argh, this PR is missing one local commit :/\nOf course, that's how it should work.", "url": "https://github.com/elastic/elasticsearch/pull/65928#discussion_r538114804", "createdAt": "2020-12-08T07:58:47Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -875,23 +875,14 @@ private SearchSourceBuilder buildUpdateQuery(SearchSourceBuilder sourceBuilder)\n \n         function.buildSearchQuery(sourceBuilder, position != null ? position.getIndexerPosition() : null, pageSize);\n \n-        // if its either the 1st run or not continuous, do not apply extra filters\n-        if (nextCheckpoint.getCheckpoint() == 1 || isContinuous() == false) {\n-            sourceBuilder.query(queryBuilder);\n-            logger.debug(() -> new ParameterizedMessage(\"[{}] Querying for data: {}\", getJobId(), sourceBuilder));\n-\n-            return sourceBuilder;\n-        }\n-\n-        BoolQueryBuilder filteredQuery = new BoolQueryBuilder().filter(queryBuilder)\n-            .filter(config.getSyncConfig().getRangeQuery(nextCheckpoint));\n-\n-        QueryBuilder filter = changeCollector != null\n-            ? changeCollector.buildFilterQuery(lastCheckpoint.getTimeUpperBound(), nextCheckpoint.getTimeUpperBound())\n-            : null;\n-\n-        if (filter != null) {\n-            filteredQuery.filter(filter);\n+        BoolQueryBuilder filteredQuery =\n+            new BoolQueryBuilder()\n+                .filter(queryBuilder)\n+                .filter(config.getSyncConfig().getRangeQuery(nextCheckpoint));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM5ODUzMQ=="}, "originalCommit": {"oid": "252dc4ec1e916d4c6723eefc9d4485070353dd64"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3ODM1MDU0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwODoxNDoxOFrOIBMhKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjo1NDozOVrOIBZV9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODEyNDU4NQ==", "bodyText": "for batch transforms this creates an unnecessary bool clause.\nwhat about:\nQueryBuilder queryBuilder = config.getSource().getQueryConfig().getQuery();\n\nif (isContinuous()) {\n    BoolQueryBuilder filteredQuery = new BoolQueryBuilder().filter(queryBuilder).filter(config.getSyncConfig().getRangeQuery(nextCheckpoint));\n\n    // Only apply extra filter if its the subsequent run of the continuous transform\n    if (nextCheckpoint.getCheckpoint() > 1 && changeCollector != null) {\n        filteredQuery.filter(changeCollector.buildFilterQuery(lastCheckpoint.getTimeUpperBound(), nextCheckpoint.getTimeUpperBound()));\n    }\n    \n    queryBuilder = filteredQuery;\n}\n\n...\n\nsourceBuilder.query(queryBuilder);", "url": "https://github.com/elastic/elasticsearch/pull/65928#discussion_r538124585", "createdAt": "2020-12-08T08:14:18Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -875,23 +875,15 @@ private SearchSourceBuilder buildUpdateQuery(SearchSourceBuilder sourceBuilder)\n \n         function.buildSearchQuery(sourceBuilder, position != null ? position.getIndexerPosition() : null, pageSize);\n \n-        // if its either the 1st run or not continuous, do not apply extra filters\n-        if (nextCheckpoint.getCheckpoint() == 1 || isContinuous() == false) {\n-            sourceBuilder.query(queryBuilder);\n-            logger.debug(() -> new ParameterizedMessage(\"[{}] Querying for data: {}\", getJobId(), sourceBuilder));\n+        BoolQueryBuilder filteredQuery = new BoolQueryBuilder().filter(queryBuilder);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bb46df4d119b35bcb267eaddfb3ad786a2e008c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzNDcxMA==", "bodyText": "Good spot!\nDone.", "url": "https://github.com/elastic/elasticsearch/pull/65928#discussion_r538334710", "createdAt": "2020-12-08T12:54:39Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -875,23 +875,15 @@ private SearchSourceBuilder buildUpdateQuery(SearchSourceBuilder sourceBuilder)\n \n         function.buildSearchQuery(sourceBuilder, position != null ? position.getIndexerPosition() : null, pageSize);\n \n-        // if its either the 1st run or not continuous, do not apply extra filters\n-        if (nextCheckpoint.getCheckpoint() == 1 || isContinuous() == false) {\n-            sourceBuilder.query(queryBuilder);\n-            logger.debug(() -> new ParameterizedMessage(\"[{}] Querying for data: {}\", getJobId(), sourceBuilder));\n+        BoolQueryBuilder filteredQuery = new BoolQueryBuilder().filter(queryBuilder);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODEyNDU4NQ=="}, "originalCommit": {"oid": "7bb46df4d119b35bcb267eaddfb3ad786a2e008c"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1775, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}