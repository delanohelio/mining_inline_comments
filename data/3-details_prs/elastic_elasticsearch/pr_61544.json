{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczMzQyNjgy", "number": 61544, "title": "[ML] Recover data frame extraction search from latest sort key", "bodyText": "If a search failure occurs during data frame extraction we catch\nthe error and retry once. However, we retry another search that is\nidentical to the first one. This means we will re-fetch any docs\nthat were already processed. This may result either to training\na model using duplicate data or in the case of outlier detection to\nan error message that the process received more records than it\nexpected.\nThis commit fixes this issue by tracking the latest doc's sort key\nand then using that in a range query in case we restart the search\ndue to a failure.", "createdAt": "2020-08-25T17:09:25Z", "url": "https://github.com/elastic/elasticsearch/pull/61544", "merged": true, "mergeCommit": {"oid": "8fb18b6c888cfc9a09d42d14211c80db365bc28c"}, "closed": true, "closedAt": "2020-08-26T10:28:57Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCaRs4gH2gAyNDczMzQyNjgyOmY2NWQ3MzkxYTMxZjViZDU1NDg5ODk3NTM3NGIzNWViMTM1MDQ4Zjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCmjosAH2gAyNDczMzQyNjgyOmJkYWI2YWM3ZGE2Njg3NmExODNmYjZlMjFjYzU1NGJlZWI4M2RiYTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f65d7391a31f5bd554898975374b35eb135048f9", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/f65d7391a31f5bd554898975374b35eb135048f9", "committedDate": "2020-08-25T17:01:57Z", "message": "[ML] Recover data frame extraction search from latest sort key\n\nIf a search failure occurs during data frame extraction we catch\nthe error and retry once. However, we retry another search that is\nidentical to the first one. This means we will re-fetch any docs\nthat were already processed. This may result either to training\na model using duplicate data or in the case of outlier detection to\nan error message that the process received more records than it\nexpected.\n\nThis commit fixes this issue by tracking the latest doc's sort key\nand then using that in a range query in case we restart the search\ndue to a failure."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MTgwNjQ2", "url": "https://github.com/elastic/elasticsearch/pull/61544#pullrequestreview-475180646", "createdAt": "2020-08-26T06:18:08Z", "commit": {"oid": "f65d7391a31f5bd554898975374b35eb135048f9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwNjoxODowOFrOHG9XoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwNjoyMjowOFrOHG9dnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA1ODk3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    hit.sortValues(new String[] { sortValue}, new DocValueFormat[] { DocValueFormat.RAW });\n          \n          \n            \n                    hit.sortValues(new String[] { sortValue }, new DocValueFormat[] { DocValueFormat.RAW });", "url": "https://github.com/elastic/elasticsearch/pull/61544#discussion_r477058977", "createdAt": "2020-08-26T06:18:08Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/test/SearchHitBuilder.java", "diffHunk": "@@ -41,6 +42,11 @@ public SearchHitBuilder setSource(String sourceJson) {\n         return this;\n     }\n \n+    public SearchHitBuilder setStringSortValue(String sortValue) {\n+        hit.sortValues(new String[] { sortValue}, new DocValueFormat[] { DocValueFormat.RAW });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f65d7391a31f5bd554898975374b35eb135048f9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA2MDIxNg==", "bodyText": "Is hit.getSortValues() always non-empty?", "url": "https://github.com/elastic/elasticsearch/pull/61544#discussion_r477060216", "createdAt": "2020-08-26T06:21:22Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/extractor/DataFrameDataExtractor.java", "diffHunk": "@@ -426,5 +441,9 @@ public boolean isTraining() {\n         public int getChecksum() {\n             return Arrays.hashCode(values);\n         }\n+\n+        public String getSortKey() {\n+            return (String) hit.getSortValues()[0];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f65d7391a31f5bd554898975374b35eb135048f9"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA2MDUwOA==", "bodyText": "IMO hasSize matcher could be used here instead.", "url": "https://github.com/elastic/elasticsearch/pull/61544#discussion_r477060508", "createdAt": "2020-08-26T06:22:08Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/dataframe/extractor/DataFrameDataExtractorTests.java", "diffHunk": "@@ -196,6 +197,13 @@ public void testRecoveryFromErrorOnSearchAfterRetry() throws IOException {\n         List<String> capturedClearScrollRequests = getCapturedClearScrollIds();\n         assertThat(capturedClearScrollRequests.size(), equalTo(1));\n         assertThat(capturedClearScrollRequests.get(0), equalTo(lastAndEmptyResponse.getScrollId()));\n+\n+        // Notice we've done two searches here\n+        assertThat(dataExtractor.capturedSearchRequests.size(), equalTo(2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f65d7391a31f5bd554898975374b35eb135048f9"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dec047329b393c975ad0a1700e005a0e6c8ba6d", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/9dec047329b393c975ad0a1700e005a0e6c8ba6d", "committedDate": "2020-08-26T06:56:48Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MjAzODcw", "url": "https://github.com/elastic/elasticsearch/pull/61544#pullrequestreview-475203870", "createdAt": "2020-08-26T07:01:02Z", "commit": {"oid": "9dec047329b393c975ad0a1700e005a0e6c8ba6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdab6ac7da66876a183fb6e21cc554beeb83dba9", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/bdab6ac7da66876a183fb6e21cc554beeb83dba9", "committedDate": "2020-08-26T07:20:24Z", "message": "Merge branch 'master' into recover-df-extraction-search-from-latest-sort-key"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4548, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}