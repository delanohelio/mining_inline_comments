{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NzU2MDk3", "number": 66295, "title": "Bust the request cache when the mapping changes", "bodyText": "This makes sure that we only serve a hit from the request cache if it\nwas build using the same mapping and that the entire search phase is\nprocessed using the same mapping. These are both bugs that Elasticsearch\nhas had for a long, long time but now that we have runtime fields they\nare much more likely to matter because runtime fields can be changed\ndrastically from moment to moment.\nCloses #62033", "createdAt": "2020-12-14T19:44:01Z", "url": "https://github.com/elastic/elasticsearch/pull/66295", "merged": true, "mergeCommit": {"oid": "3e3152406a4fda2cebeceac3d7fdae4071ce7ea6"}, "closed": true, "closedAt": "2020-12-23T18:19:02Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 74, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfqdvTgH2gAyNTM5NzU2MDk3OjUyOGJmYzZiNDg4YmRmYTk5YWE3NzdmNGM4OGQ1ODc0ZTBmYWUwNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdpCnxfgFqTU1ODEzNjQwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "528bfc6b488bdfa99aa777f4c88d5874e0fae073", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/528bfc6b488bdfa99aa777f4c88d5874e0fae073", "committedDate": "2020-11-24T14:17:23Z", "message": "Bust the request cache when the mapping changes\n\nThis makes sure that we only serve a hit from the request cache if it\nwas build using the same mapping and that the entire search phase is\nprocessed using the same mapping. These are both bugs that Elasticsearch\nhas had for a long, long time but now that we have runtime fields they\nare much more likely to matter because runtime fields can be changed\n*drastically* from moment to moment.\n\nIt does by adding a counter to the local mapping that is incremented\nwhenever the mapping changes. This counter and the mapping is stored\nunder a single `volatile` variable that is updated to point to the new\nmapping whenever the mapping changes. When the search phase begins we\nread the contents of the `volatile` and use it to power the entire\nphase, and including the version counter into the cache key.\n\nBefore this change we'd go back to the `volatile` over and over again,\npotentially getting a new version of the mapping every time. This was\nconvenient but made it possible that we'd see the mapping update half\nway through the search phase which could cause trouble.\n\nMechanically, this creates a `snapshot()` method on `MapperService` to\ndo the volatile read of the current mapping. The snapshot does all of\nthe reading we need from here on out. I kept all of the methods on\n`MapperService` that read directly from the mapping but deprecated all\nof them because using them can lead to seeing the mapping updates when\nyou don't expect them. We can slowly remove the usages in follow up\nchanges. This change is big enough as is.\n\nSadly, the `Mapper`s are also mutable. Luckilly, we only mutate them\nbefore sticking them behind the `volatile` reference. Hopefully. There\nis a lot of code there and it is hard to be sure. But it looks like we\n*intend* to do this. We should make them properly immutable in a follow\nup change.\n\nCloses #62033"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c808e79fda2075bddd7c37f54c815753a1459ab", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c808e79fda2075bddd7c37f54c815753a1459ab", "committedDate": "2020-11-24T14:59:43Z", "message": "Refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fc61e8bbaf06775ea5b740b97dedd7032f83766", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/3fc61e8bbaf06775ea5b740b97dedd7032f83766", "committedDate": "2020-11-24T15:05:49Z", "message": "Refactor again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dedc0a8b809632d09b22bd7be78abfb730e3ca2", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1dedc0a8b809632d09b22bd7be78abfb730e3ca2", "committedDate": "2020-11-24T15:38:39Z", "message": "Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fddfdb09a29a15d7fcf51faf3d963f67a9c7e538", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/fddfdb09a29a15d7fcf51faf3d963f67a9c7e538", "committedDate": "2020-11-24T15:57:44Z", "message": "Moar javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b42f493e966b89d640d6d3fee212f353f57e9be4", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/b42f493e966b89d640d6d3fee212f353f57e9be4", "committedDate": "2020-11-24T17:34:24Z", "message": "Merge branch 'master' into cache_bust"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58af6feea5553003cf5e12b38248f438fabf5c52", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/58af6feea5553003cf5e12b38248f438fabf5c52", "committedDate": "2020-11-24T22:08:04Z", "message": "Add example in core"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f54e5bb0f89422b9b562e8b0a14bcc2e53b80be", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/5f54e5bb0f89422b9b562e8b0a14bcc2e53b80be", "committedDate": "2020-11-30T22:40:36Z", "message": "Merge branch 'master' into cache_bust"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "177e4d8509ab33d37408e9e90d8fb35372cefd57", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/177e4d8509ab33d37408e9e90d8fb35372cefd57", "committedDate": "2020-12-01T14:42:51Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e59716408d1899689565f8e48dd1826af7a9ec81", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e59716408d1899689565f8e48dd1826af7a9ec81", "committedDate": "2020-12-01T16:22:25Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72887cd830d6e6f51f42359f0df06f512ac304b7", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/72887cd830d6e6f51f42359f0df06f512ac304b7", "committedDate": "2020-12-09T18:43:10Z", "message": "Merge branch 'master' into cache_bust"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35873854c68b2aa71e11acc879ab3e2e3815c19e", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/35873854c68b2aa71e11acc879ab3e2e3815c19e", "committedDate": "2020-12-09T18:49:26Z", "message": "ooops:"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82b2a53c6b5d927473ccfd86f1d7138310c9b365", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/82b2a53c6b5d927473ccfd86f1d7138310c9b365", "committedDate": "2020-12-09T18:55:10Z", "message": "Compile plz"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d30da9aae2a5e3a5d6c8238597d2fb93aa971c24", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/d30da9aae2a5e3a5d6c8238597d2fb93aa971c24", "committedDate": "2020-12-09T19:28:30Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcd8e52922f93dd3b6022182c2ba69def0c2c5f2", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/bcd8e52922f93dd3b6022182c2ba69def0c2c5f2", "committedDate": "2020-12-09T20:14:46Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3ace97a77fcd32abd45432a048a5ba140c8377d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/c3ace97a77fcd32abd45432a048a5ba140c8377d", "committedDate": "2020-12-09T20:54:47Z", "message": "Merge branch 'master' into cache_bust"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81b9824e5ea80d26faf9c7ac19bc115e259203ea", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/81b9824e5ea80d26faf9c7ac19bc115e259203ea", "committedDate": "2020-12-14T17:46:47Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a36ea7fdf21ff60ca5e97811eb249d6fd4752bfd", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a36ea7fdf21ff60ca5e97811eb249d6fd4752bfd", "committedDate": "2020-12-14T17:48:26Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dde49961be732ae6bcbf8d4606ff906fbe99cb12", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/dde49961be732ae6bcbf8d4606ff906fbe99cb12", "committedDate": "2020-12-14T17:59:50Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7519d7787b2f0b8b49b02f60e138e5d28a0ed73d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7519d7787b2f0b8b49b02f60e138e5d28a0ed73d", "committedDate": "2020-12-14T18:14:51Z", "message": "Implement sourceEnabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56cc6472187f4fdc7376640ddbd1fecceebd021c", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/56cc6472187f4fdc7376640ddbd1fecceebd021c", "committedDate": "2020-12-14T19:03:37Z", "message": "Fixup test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a075886e13bb94c908c359bb53f71d6010d1890e", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a075886e13bb94c908c359bb53f71d6010d1890e", "committedDate": "2020-12-15T14:24:46Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76a512cd98f5079892593302cf785b7691212525", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/76a512cd98f5079892593302cf785b7691212525", "committedDate": "2020-12-15T14:31:31Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5769100e0f487244a9a0199bbfe801535fba7641", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/5769100e0f487244a9a0199bbfe801535fba7641", "committedDate": "2020-12-15T15:03:42Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4fe787a07b4f927d694f2b53c08e87d9233be34", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4fe787a07b4f927d694f2b53c08e87d9233be34", "committedDate": "2020-12-15T17:25:47Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1cf01b03391d58c451d3f4c0edb915d251ce137", "committedDate": "2020-12-15T17:26:02Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzM1MDk0", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-552735094", "createdAt": "2020-12-15T18:12:21Z", "commit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODoxMjoyMVrOIGZFxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMTozNTowN1rOIGg_VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3MzQ0NA==", "bodyText": "Changed to make testing easier.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543573444", "createdAt": "2020-12-15T18:12:21Z", "author": {"login": "nik9000"}, "path": "modules/parent-join/src/main/java/org/elasticsearch/join/mapper/MetaJoinFieldMapper.java", "diffHunk": "@@ -49,7 +49,7 @@\n \n         private final String joinField;\n \n-        private MetaJoinFieldType(String joinField) {\n+        public MetaJoinFieldType(String joinField) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3MzgyMg==", "bodyText": "Replaced with withJoinFields which allows us to use a non-mocked version.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543573822", "createdAt": "2020-12-15T18:12:52Z", "author": {"login": "nik9000"}, "path": "modules/parent-join/src/test/java/org/elasticsearch/join/aggregations/ChildrenToParentAggregatorTests.java", "diffHunk": "@@ -272,34 +265,14 @@ private static SortedDocValuesField createJoinField(String parentType, String id\n         return new SortedDocValuesField(\"join_field#\" + parentType, new BytesRef(id));\n     }\n \n-    @Override\n-    protected MapperService mapperServiceMock() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMDQ0OA==", "bodyText": "Moving to #66395.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543700448", "createdAt": "2020-12-15T21:30:46Z", "author": {"login": "nik9000"}, "path": "modules/parent-join/src/test/java/org/elasticsearch/join/aggregations/ChildrenToParentAggregatorTests.java", "diffHunk": "@@ -272,34 +265,14 @@ private static SortedDocValuesField createJoinField(String parentType, String id\n         return new SortedDocValuesField(\"join_field#\" + parentType, new BytesRef(id));\n     }\n \n-    @Override\n-    protected MapperService mapperServiceMock() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3MzgyMg=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMDkwNQ==", "bodyText": "I could pass just the MapperService here but then we'd often have to mock the mapper service just to return the lookup.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543700905", "createdAt": "2020-12-15T21:31:36Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/IndexService.java", "diffHunk": "@@ -604,9 +604,26 @@ public QueryShardContext newQueryShardContext(\n         final SearchIndexNameMatcher indexNameMatcher =\n             new SearchIndexNameMatcher(index().getName(), clusterAlias, clusterService, expressionResolver);\n         return new QueryShardContext(\n-            shardId, indexSettings, bigArrays, indexCache.bitsetFilterCache(), indexFieldData::getForField, mapperService(),\n-            similarityService(), scriptService, xContentRegistry, namedWriteableRegistry, client, searcher, nowInMillis, clusterAlias,\n-            indexNameMatcher, allowExpensiveQueries, valuesSourceRegistry, runtimeMappings);\n+            shardId,\n+            indexSettings,\n+            bigArrays,\n+            indexCache.bitsetFilterCache(),\n+            indexFieldData::getForField,\n+            mapperService(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMTMxNQ==", "bodyText": "The extra arguments are required so that MappingLookup can do all the things we need it to do now.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543701315", "createdAt": "2020-12-15T21:32:20Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -115,13 +113,13 @@ private DocumentMapper(IndexSettings indexSettings,\n         this.documentParser = documentParser;\n         this.indexSettings = indexSettings;\n         this.indexAnalyzers = indexAnalyzers;\n-        this.fieldMappers = MappingLookup.fromMapping(this.mapping);\n \n         try {\n             mappingSource = new CompressedXContent(this, XContentType.JSON, ToXContent.EMPTY_PARAMS);\n         } catch (Exception e) {\n             throw new ElasticsearchGenerationException(\"failed to serialize source for type [\" + type + \"]\", e);\n         }\n+        this.fieldMappers = MappingLookup.fromMapping(mapping, this::parse, w -> w.write(mappingSource.compressed()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMTU1NA==", "bodyText": "Probably should have javadoc.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543701554", "createdAt": "2020-12-15T21:32:44Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -399,30 +398,20 @@ public DocumentMapperForType documentMapperWithAutoCreate() {\n      * Given the full name of a field, returns its {@link MappedFieldType}.\n      */\n     public MappedFieldType fieldType(String fullName) {\n-        if (fullName.equals(TypeFieldType.NAME)) {\n-            return new TypeFieldType(this.mapper == null ? \"_doc\" : this.mapper.type());\n-        }\n-        return this.mapper == null ? null : this.mapper.mappers().fieldTypes().get(fullName);\n+        return lookup().fieldTypes().get(fullName);\n     }\n \n     /**\n      * Returns all the fields that match the given pattern. If the pattern is prefixed with a type\n      * then the fields will be returned with a type prefix.\n      */\n     public Set<String> simpleMatchToFullName(String pattern) {\n-        if (Regex.isSimpleMatchPattern(pattern) == false) {\n-            // no wildcards\n-            return Collections.singleton(pattern);\n-        }\n-        return this.mapper == null ? Collections.emptySet() : this.mapper.mappers().fieldTypes().simpleMatchToFullName(pattern);\n+        return lookup().simpleMatchToFullName(pattern);\n     }\n \n-    /**\n-     * Given a field name, returns its possible paths in the _source. For example,\n-     * the 'source path' for a multi-field is the path to its parent field.\n-     */\n-    public Set<String> sourcePath(String fullName) {\n-        return this.mapper == null ? Collections.emptySet() : this.mapper.mappers().fieldTypes().sourcePaths(fullName);\n+    public MappingLookup lookup() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMTcxOA==", "bodyText": "Instead of two volatile reads this method now does one. I think that is nice.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543701718", "createdAt": "2020-12-15T21:33:04Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -132,7 +131,7 @@ public MapperService(IndexSettings indexSettings, IndexAnalyzers indexAnalyzers,\n     }\n \n     public boolean hasNested() {\n-        return this.mapper != null && this.mapper.hasNestedObjects();\n+        return lookup().hasNested();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMjEwNw==", "bodyText": "All of this has been moved.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543702107", "createdAt": "2020-12-15T21:33:48Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DocumentFieldMapperTests.java", "diffHunk": "@@ -1,139 +0,0 @@\n-/*\n- * Licensed to Elasticsearch under one or more contributor\n- * license agreements. See the NOTICE file distributed with\n- * this work for additional information regarding copyright\n- * ownership. Elasticsearch licenses this file to you under\n- * the Apache License, Version 2.0 (the \"License\"); you may\n- * not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *    http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing,\n- * software distributed under the License is distributed on an\n- * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n- * KIND, either express or implied.  See the License for the\n- * specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package org.elasticsearch.index.mapper;\n-\n-import org.apache.lucene.analysis.Analyzer;\n-import org.apache.lucene.analysis.TokenStream;\n-import org.apache.lucene.analysis.Tokenizer;\n-import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;\n-import org.apache.lucene.util.LuceneTestCase;\n-import org.elasticsearch.index.analysis.AnalyzerScope;\n-import org.elasticsearch.index.analysis.NamedAnalyzer;\n-import org.elasticsearch.index.query.QueryShardContext;\n-\n-import java.io.IOException;\n-import java.io.StringReader;\n-import java.util.Arrays;\n-import java.util.Collections;\n-\n-public class DocumentFieldMapperTests extends LuceneTestCase {\n-\n-    private static class FakeAnalyzer extends Analyzer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMjg2OQ==", "bodyText": "This is required by this change because we can no longer mock anything and magic nested fields into place with any object that starts with nested_. Now tests that use nested fields need to declare them", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543702869", "createdAt": "2020-12-15T21:35:07Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -288,16 +296,24 @@ protected AggregationContext createAggregationContext(IndexSearcher indexSearche\n         );\n     }\n \n+    /**\n+     * {@link ObjectMapper}s to add to the lookup. By default we don't need\n+     * any {@link ObjectMapper}s but testing nested objects will require adding some.\n+     */\n+    protected List<ObjectMapper> objectMappers() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 160}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMzI2Njc1", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-553326675", "createdAt": "2020-12-16T03:16:28Z", "commit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMzoxNjoyOFrOIGrm0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNToxMzo0N1rOIGxBGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg3NjgxNw==", "bodyText": "I could be missing an important consideration, but could we key on some Java object related to MappingLookup instead of appending the serialized source? This would be consistent with what we do for DirectoryReader, where we use the object reader.getReaderCacheHelper().getKey().", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543876817", "createdAt": "2020-12-16T03:16:28Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/indices/IndicesService.java", "diffHunk": "@@ -1408,7 +1408,8 @@ public void loadIntoContext(ShardSearchRequest request, SearchContext context, Q\n         final DirectoryReader directoryReader = context.searcher().getDirectoryReader();\n \n         boolean[] loadedFromCache = new boolean[] { true };\n-        BytesReference bytesReference = cacheShardLevelResult(context.indexShard(), directoryReader, request.cacheKey(),\n+        BytesReference cacheKey = request.cacheKey(context.getQueryShardContext().mappingKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg4MDg1OQ==", "bodyText": "It would be really nice if we could remove MapperService here -- that way we'd be sure MappingLookup represents all the mapping configuration relevant to the search. We could look into removing the remaining references?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543880859", "createdAt": "2020-12-16T03:21:51Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -119,6 +123,7 @@ public QueryShardContext(\n         BitsetFilterCache bitsetFilterCache,\n         TriFunction<MappedFieldType, String, Supplier<SearchLookup>, IndexFieldData<?>> indexFieldDataLookup,\n         MapperService mapperService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk2NTQ2NA==", "bodyText": "I remembered that search analyzers can be reloaded which doesn't cause a mapping update but changes how fields are analyzed! This is also an important way in which MappingLookup is not immutable.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r543965464", "createdAt": "2020-12-16T05:13:47Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -444,18 +433,7 @@ public ObjectMapper getObjectMapper(String name) {\n      *                                  directly associated index-time analyzer\n      */\n     public NamedAnalyzer indexAnalyzer(String field, Function<String, NamedAnalyzer> unindexedFieldAnalyzer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6273512265704334aac49c6c77890b2c64af5096", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/6273512265704334aac49c6c77890b2c64af5096", "committedDate": "2020-12-16T18:18:15Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a359630f2ad2f0d2cef50b91b3a233832876e430", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a359630f2ad2f0d2cef50b91b3a233832876e430", "committedDate": "2020-12-16T18:21:17Z", "message": "Fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1335aab3556145ba98e7215fa26ca6003ed3a2f7", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1335aab3556145ba98e7215fa26ca6003ed3a2f7", "committedDate": "2020-12-16T18:25:52Z", "message": "Remove spacing change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9900fcbfafdc5649fddda931bf45401908df5eaf", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9900fcbfafdc5649fddda931bf45401908df5eaf", "committedDate": "2020-12-16T18:27:34Z", "message": "Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "501aea892b6c731e356f90cf8d819e4f67b1ad2e", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/501aea892b6c731e356f90cf8d819e4f67b1ad2e", "committedDate": "2020-12-16T19:38:12Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed582f4e3df951b065bf415116ccdf1270484279", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed582f4e3df951b065bf415116ccdf1270484279", "committedDate": "2020-12-16T20:33:51Z", "message": "Switch cache around"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTAzNjQ0", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-554103644", "createdAt": "2020-12-16T21:35:58Z", "commit": {"oid": "ed582f4e3df951b065bf415116ccdf1270484279"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMTozNTo1OFrOIHaLfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMTozNTo1OFrOIHaLfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYzOTg2OA==", "bodyText": "@javanna and I talked earlier today and we thought that this function hid a volatile read. I think it doesn't. It is genuinely weird to be able to parse documents at search time but that is how the percolator does its thing.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r544639868", "createdAt": "2020-12-16T21:35:58Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -28,19 +29,45 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.function.Function;\n import java.util.stream.Stream;\n \n-public final class MappingLookup {\n+public class MappingLookup {\n+    /**\n+     * Key for the lookup to be used in caches.\n+     */\n+    public class CacheKey {\n+        private CacheKey() {}\n+    }\n+\n+    /**\n+     * A lookup representing an empty mapping.\n+     */\n+    public static final MappingLookup EMPTY = new MappingLookup(\n+        \"_doc\",\n+        List.of(),\n+        List.of(),\n+        List.of(),\n+        List.of(),\n+        0,\n+        souceToParse -> null,\n+        false\n+    );\n+\n+    private final CacheKey cacheKey = new CacheKey();\n+\n     /** Full field name to mapper */\n     private final Map<String, Mapper> fieldMappers;\n     private final Map<String, ObjectMapper> objectMappers;\n     private final boolean hasNested;\n     private final FieldTypeLookup fieldTypeLookup;\n     private final int metadataFieldCount;\n     private final Map<String, NamedAnalyzer> indexAnalyzers = new HashMap<>();\n+    private final Function<SourceToParse, ParsedDocument> documentParser;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed582f4e3df951b065bf415116ccdf1270484279"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eed96df4f22ae8b6cf37ec2a7dae8140ee86b314", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/eed96df4f22ae8b6cf37ec2a7dae8140ee86b314", "committedDate": "2020-12-16T21:42:05Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b6fbce312c8fb54b5255a6a0ec053ce0f775f41", "committedDate": "2020-12-16T21:45:47Z", "message": "We use up to field 10!"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MzE3MzMz", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-556317333", "createdAt": "2020-12-21T11:37:34Z", "commit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "state": "COMMENTED", "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMTozNzozNFrOIJVYgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNToxNDo1MlrOIJbsCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY1ODQzMg==", "bodyText": "this can stay private right?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546658432", "createdAt": "2020-12-21T11:37:34Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -105,7 +103,7 @@ public DocumentMapper build() {\n     private final MetadataFieldMapper[] deleteTombstoneMetadataFieldMappers;\n     private final MetadataFieldMapper[] noopTombstoneMetadataFieldMappers;\n \n-    private DocumentMapper(IndexSettings indexSettings,\n+    protected DocumentMapper(IndexSettings indexSettings,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjcyNTQzMg==", "bodyText": "does it? we are within DocumentMapper, and we call parse on it, which calls DocumentParser#parse and passes this through. Where do we go through MapperService? I was under the impression that we always use the same DcoumentMapper instance", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546725432", "createdAt": "2020-12-21T14:09:03Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -115,13 +113,14 @@ private DocumentMapper(IndexSettings indexSettings,\n         this.documentParser = documentParser;\n         this.indexSettings = indexSettings;\n         this.indexAnalyzers = indexAnalyzers;\n-        this.fieldMappers = MappingLookup.fromMapping(this.mapping);\n \n         try {\n             mappingSource = new CompressedXContent(this, XContentType.JSON, ToXContent.EMPTY_PARAMS);\n         } catch (Exception e) {\n             throw new ElasticsearchGenerationException(\"failed to serialize source for type [\" + type + \"]\", e);\n         }\n+        // TODO this::parse performs a volatile read on mapping from MapperService. Yikes!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczMDI4Mw==", "bodyText": "I wonder if, instead of making FieldTypeLookup as well as its needed methods public, we should rather add these two/three methods to MappingLookup. I am not extremely sure, just thinking that while I like the FieldTypeLookup abstraction as it isolates dealing with field types, maybe it should not be exposed directly to consumers.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546730283", "createdAt": "2020-12-21T14:18:06Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldTypeLookup.java", "diffHunk": "@@ -124,7 +133,10 @@ MappedFieldType get(String field) {\n      *              should be a concrete field and *not* an alias.\n      * @return A set of paths in the _source that contain the field's values.\n      */\n-    Set<String> sourcePaths(String field) {\n+    public Set<String> sourcePaths(String field) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczMTU5Ng==", "bodyText": "along the lines of what I wrote above, maybe having lookup().getFieldType(fullName) would be nicer here.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546731596", "createdAt": "2020-12-21T14:20:40Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -399,30 +398,23 @@ public DocumentMapperForType documentMapperWithAutoCreate() {\n      * Given the full name of a field, returns its {@link MappedFieldType}.\n      */\n     public MappedFieldType fieldType(String fullName) {\n-        if (fullName.equals(TypeFieldType.NAME)) {\n-            return new TypeFieldType(this.mapper == null ? \"_doc\" : this.mapper.type());\n-        }\n-        return this.mapper == null ? null : this.mapper.mappers().fieldTypes().get(fullName);\n+        return lookup().fieldTypes().get(fullName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczMjcwNQ==", "bodyText": "maybe I would call it mappingLookup()", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546732705", "createdAt": "2020-12-21T14:22:51Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -399,30 +398,20 @@ public DocumentMapperForType documentMapperWithAutoCreate() {\n      * Given the full name of a field, returns its {@link MappedFieldType}.\n      */\n     public MappedFieldType fieldType(String fullName) {\n-        if (fullName.equals(TypeFieldType.NAME)) {\n-            return new TypeFieldType(this.mapper == null ? \"_doc\" : this.mapper.type());\n-        }\n-        return this.mapper == null ? null : this.mapper.mappers().fieldTypes().get(fullName);\n+        return lookup().fieldTypes().get(fullName);\n     }\n \n     /**\n      * Returns all the fields that match the given pattern. If the pattern is prefixed with a type\n      * then the fields will be returned with a type prefix.\n      */\n     public Set<String> simpleMatchToFullName(String pattern) {\n-        if (Regex.isSimpleMatchPattern(pattern) == false) {\n-            // no wildcards\n-            return Collections.singleton(pattern);\n-        }\n-        return this.mapper == null ? Collections.emptySet() : this.mapper.mappers().fieldTypes().simpleMatchToFullName(pattern);\n+        return lookup().simpleMatchToFullName(pattern);\n     }\n \n-    /**\n-     * Given a field name, returns its possible paths in the _source. For example,\n-     * the 'source path' for a multi-field is the path to its parent field.\n-     */\n-    public Set<String> sourcePath(String fullName) {\n-        return this.mapper == null ? Collections.emptySet() : this.mapper.mappers().fieldTypes().sourcePaths(fullName);\n+    public MappingLookup lookup() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMTU1NA=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczNjI4Nw==", "bodyText": "maybe this logic should be pushed down to FieldTypeLookup?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546736287", "createdAt": "2020-12-21T14:29:05Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -234,4 +274,116 @@ private static String parentObject(String field) {\n         }\n         return field.substring(0, lastDot);\n     }\n+\n+    public Set<String> simpleMatchToFullName(String pattern) {\n+        if (Regex.isSimpleMatchPattern(pattern) == false) {\n+            // no wildcards\n+            return Collections.singleton(pattern);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczNzYxNQ==", "bodyText": "given where this is used (QueryShardContext#hasMappings) and how, I wonder if this should rather be a comparison between this and EMPTY.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546737615", "createdAt": "2020-12-21T14:31:38Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -234,4 +274,116 @@ private static String parentObject(String field) {\n         }\n         return field.substring(0, lastDot);\n     }\n+\n+    public Set<String> simpleMatchToFullName(String pattern) {\n+        if (Regex.isSimpleMatchPattern(pattern) == false) {\n+            // no wildcards\n+            return Collections.singleton(pattern);\n+        }\n+        return fieldTypes().simpleMatchToFullName(pattern);\n+    }\n+\n+    public ParsedDocument parseDocument(SourceToParse source) {\n+        return documentParser.apply(source);\n+    }\n+\n+    public boolean isEmpty() {\n+        return objectMappers.isEmpty() && fieldTypeLookup.isEmpty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczODI0OA==", "bodyText": "want to make this a link?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546738248", "createdAt": "2020-12-21T14:32:50Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -234,4 +274,116 @@ private static String parentObject(String field) {\n         }\n         return field.substring(0, lastDot);\n     }\n+\n+    public Set<String> simpleMatchToFullName(String pattern) {\n+        if (Regex.isSimpleMatchPattern(pattern) == false) {\n+            // no wildcards\n+            return Collections.singleton(pattern);\n+        }\n+        return fieldTypes().simpleMatchToFullName(pattern);\n+    }\n+\n+    public ParsedDocument parseDocument(SourceToParse source) {\n+        return documentParser.apply(source);\n+    }\n+\n+    public boolean isEmpty() {\n+        return objectMappers.isEmpty() && fieldTypeLookup.isEmpty();\n+    }\n+\n+    public boolean isSourceEnabled() {\n+        return sourceEnabled;\n+    }\n+\n+    /**\n+     * Returns all nested object mappers which contain further nested object mappers\n+     *\n+     * Used by BitSetProducerWarmer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczOTYwNw==", "bodyText": "static?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546739607", "createdAt": "2020-12-21T14:35:18Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -28,19 +29,45 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.function.Function;\n import java.util.stream.Stream;\n \n-public final class MappingLookup {\n+public class MappingLookup {\n+    /**\n+     * Key for the lookup to be used in caches.\n+     */\n+    public class CacheKey {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc0MjkzOQ==", "bodyText": "would it make sense to add javadoc especially as it gets used more?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546742939", "createdAt": "2020-12-21T14:41:13Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -28,19 +29,45 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.function.Function;\n import java.util.stream.Stream;\n \n-public final class MappingLookup {\n+public class MappingLookup {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc0MzMyNA==", "bodyText": "getObjectMapper is now only used in tests, let's track that as a followup?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546743324", "createdAt": "2020-12-21T14:41:56Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -132,7 +131,7 @@ public MapperService(IndexSettings indexSettings, IndexAnalyzers indexAnalyzers,\n     }\n \n     public boolean hasNested() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc1MzY2NQ==", "bodyText": "This is the type of change that we could make as a follow-up to keep this one contained. If we made this separately, there would probably be other things that catch our eyes in DefaultSearchContext to address with it. Also, we are not after fixing the fetch phase, so what are the gains? Could we leave the method in SearchContext for now and retrieve the MappingLookup from the MapperService in this case, and file it as a followup?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546753665", "createdAt": "2020-12-21T15:00:31Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -111,7 +111,7 @@ public void execute(SearchContext context) {\n         SearchHit[] hits = new SearchHit[context.docIdsToLoadSize()];\n \n         List<FetchSubPhaseProcessor> processors = getProcessors(context.shardTarget(), fetchContext);\n-        NestedDocuments nestedDocuments = context.getNestedDocuments();\n+        NestedDocuments nestedDocuments = context.getQueryShardContext().getNestedDocuments();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc1NjczNA==", "bodyText": "s/Analyzes/Analyzers", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546756734", "createdAt": "2020-12-21T15:06:02Z", "author": {"login": "javanna"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/MappingLookupTests.java", "diffHunk": "@@ -53,20 +63,135 @@ public void testSubfieldOverride() {\n         MockFieldMapper fieldMapper = new MockFieldMapper(\"object.subfield\");\n         ObjectMapper objectMapper = new ObjectMapper(\"object\", \"object\", new Explicit<>(true, true), ObjectMapper.Nested.NO,\n             ObjectMapper.Dynamic.TRUE, Collections.singletonMap(\"object.subfield\", fieldMapper), Version.CURRENT);\n-        MappingLookup mappingLookup = new MappingLookup(Collections.singletonList(fieldMapper), Collections.singletonList(objectMapper),\n-            Collections.emptyList(), Collections.singletonList(new TestRuntimeField(\"object.subfield\", \"type\")), 0);\n+        MappingLookup mappingLookup = new MappingLookup(\n+            \"_doc\",\n+            Collections.singletonList(fieldMapper),\n+            Collections.singletonList(objectMapper),\n+            Collections.emptyList(),\n+            Collections.singletonList(new TestRuntimeField(\"object.subfield\", \"type\")),\n+            0,\n+            null,\n+            false\n+        );\n         assertThat(mappingLookup.getMapper(\"object.subfield\"), instanceOf(MockFieldMapper.class));\n         assertEquals(1, size(mappingLookup.fieldMappers()));\n         assertEquals(1, mappingLookup.objectMappers().size());\n         assertThat(mappingLookup.fieldTypes().get(\"object.subfield\"), instanceOf(TestRuntimeField.class));\n         assertEquals(1, size(mappingLookup.fieldTypes().filter(ft -> true)));\n     }\n \n+\n+    public void testAnalyzers() throws IOException {\n+        FakeFieldType fieldType1 = new FakeFieldType(\"field1\");\n+        FieldMapper fieldMapper1 = new FakeFieldMapper(fieldType1, \"index1\");\n+\n+        FakeFieldType fieldType2 = new FakeFieldType(\"field2\");\n+        FieldMapper fieldMapper2 = new FakeFieldMapper(fieldType2, \"index2\");\n+\n+        MappingLookup mappingLookup = new MappingLookup(\n+            \"_doc\",\n+            Arrays.asList(fieldMapper1, fieldMapper2),\n+            Collections.emptyList(),\n+            Collections.emptyList(),\n+            Collections.emptyList(),\n+            0,\n+            null,\n+            false\n+        );\n+\n+        assertAnalyzes(mappingLookup.indexAnalyzer(\"field1\", f -> null), \"field1\", \"index1\");\n+        assertAnalyzes(mappingLookup.indexAnalyzer(\"field2\", f -> null), \"field2\", \"index2\");\n+        expectThrows(IllegalArgumentException.class,\n+            () -> mappingLookup.indexAnalyzer(\"field3\", f -> {\n+                throw new IllegalArgumentException();\n+            }).tokenStream(\"field3\", \"blah\"));\n+    }\n+\n+    private void assertAnalyzes(Analyzer analyzer, String field, String output) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc2MTczOQ==", "bodyText": "Along the same lines, I wonder: if we avoid moving the method to QueryShardContext, do we still need to migrate NestedDocuments to MappingLookup, and to consequently move the method it uses from DocumentMapper to MappingLookup? It is a good change I think, but I don't see if it's required. In fact, QueryShardContext only needs hasNested which requires no changes as it's already part of MappingLookup? Am I missing anything?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r546761739", "createdAt": "2020-12-21T15:14:52Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -111,7 +111,7 @@ public void execute(SearchContext context) {\n         SearchHit[] hits = new SearchHit[context.docIdsToLoadSize()];\n \n         List<FetchSubPhaseProcessor> processors = getProcessors(context.shardTarget(), fetchContext);\n-        NestedDocuments nestedDocuments = context.getNestedDocuments();\n+        NestedDocuments nestedDocuments = context.getQueryShardContext().getNestedDocuments();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc1MzY2NQ=="}, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4621ff8d3ca63e343e0423fa6d4b3b66f501c16b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4621ff8d3ca63e343e0423fa6d4b3b66f501c16b", "committedDate": "2020-12-21T16:32:16Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9c19afaf77ffd5582eac54a745f83c184d887f3", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/d9c19afaf77ffd5582eac54a745f83c184d887f3", "committedDate": "2020-12-21T16:37:49Z", "message": "Fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "000ea6871d63cbf9db7fd23e6b597209e2b9c7ed", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/000ea6871d63cbf9db7fd23e6b597209e2b9c7ed", "committedDate": "2020-12-21T16:57:10Z", "message": "Iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e151e5d14d3061727d9326b57ab49dd00a0a99bb", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e151e5d14d3061727d9326b57ab49dd00a0a99bb", "committedDate": "2020-12-21T16:58:33Z", "message": "link to public"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de00a13b7357baf58fe2a3ff110235cfaea521c9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/de00a13b7357baf58fe2a3ff110235cfaea521c9", "committedDate": "2020-12-21T17:05:04Z", "message": "Revert cleanup of nested"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fafa83812939474b5e443dc3512dc7fccd7bab98", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/fafa83812939474b5e443dc3512dc7fccd7bab98", "committedDate": "2020-12-21T17:08:14Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ecd7813a3980996648ed445d0a9070c1f269fca", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4ecd7813a3980996648ed445d0a9070c1f269fca", "committedDate": "2020-12-21T17:20:04Z", "message": "Finish reverting nested change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ef65a7e048704580c48e20c0a03e996776e636b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/6ef65a7e048704580c48e20c0a03e996776e636b", "committedDate": "2020-12-21T17:21:43Z", "message": "Checkstyle, you loveable scamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc3ed96ac66294ce3d00c183c7dfdc94cd87224", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4fc3ed96ac66294ce3d00c183c7dfdc94cd87224", "committedDate": "2020-12-21T17:23:54Z", "message": "Probably not neeeded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/07c74b37ed7fbc137c5bef587a108289bb0fb7e2", "committedDate": "2020-12-21T17:32:22Z", "message": "Revert moar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcfdf441b03dacaa0c9fea9bd49d7f6a4c833ac5", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/dcfdf441b03dacaa0c9fea9bd49d7f6a4c833ac5", "committedDate": "2020-12-21T22:50:53Z", "message": "Document not fixed issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2Nzk2MDU4", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-556796058", "createdAt": "2020-12-22T03:27:41Z", "commit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMzozNTo0NFrOIJtMtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNToyMzowNlrOIJuxJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0ODYyOA==", "bodyText": "\"snapshot current mapping\" -> \"snapshot of the current mapping\"", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547048628", "createdAt": "2020-12-22T03:35:44Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -28,19 +28,49 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.function.Function;\n import java.util.stream.Stream;\n \n-public final class MappingLookup {\n+/**\n+ * A (mostly) immutable snapshot current mapping of an index with access", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0ODgwMQ==", "bodyText": "souceToParse -> sourceToParse", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547048801", "createdAt": "2020-12-22T03:36:19Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -28,19 +28,49 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.function.Function;\n import java.util.stream.Stream;\n \n-public final class MappingLookup {\n+/**\n+ * A (mostly) immutable snapshot current mapping of an index with access\n+ * to everything we need for the search phase.\n+ */\n+public class MappingLookup {\n+    /**\n+     * Key for the lookup to be used in caches.\n+     */\n+    public static class CacheKey {\n+        private CacheKey() {}\n+    }\n+\n+    /**\n+     * A lookup representing an empty mapping.\n+     */\n+    public static final MappingLookup EMPTY = new MappingLookup(\n+        \"_doc\",\n+        List.of(),\n+        List.of(),\n+        List.of(),\n+        List.of(),\n+        0,\n+        souceToParse -> null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0OTY5MA==", "bodyText": "Should we be removing this final?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547049690", "createdAt": "2020-12-22T03:40:07Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -309,7 +309,7 @@ protected void doXContentBody(XContentBuilder builder, boolean includeDefaults,\n \n     protected abstract String contentType();\n \n-    public final Map<String, NamedAnalyzer> indexAnalyzers() {\n+    public Map<String, NamedAnalyzer> indexAnalyzers() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MTQ3OQ==", "bodyText": "It's too bad we're adding back a type parameter here, but I see you're just moving existing logic around. Hopefully we'll be able to remove this from master soon as part of the types removal effort.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547051479", "createdAt": "2020-12-22T03:47:56Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldTypeLookup.java", "diffHunk": "@@ -43,11 +44,16 @@\n      * For convenience, the set of copied fields includes the field itself.\n      */\n     private final Map<String, Set<String>> fieldToCopiedFields = new HashMap<>();\n+    private final String type;\n     private final DynamicKeyFieldTypeLookup dynamicKeyLookup;\n \n-    FieldTypeLookup(Collection<FieldMapper> fieldMappers,\n-                    Collection<FieldAliasMapper> fieldAliasMappers,\n-                    Collection<RuntimeFieldType> runtimeFieldTypes) {\n+    FieldTypeLookup(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MzE1Ng==", "bodyText": "+1 it'd be nice to remove a few of these methods on MapperService and reroute callers to MappingLookup. That way we won't have the same method like simpleMatchToFullName in so many places.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547053156", "createdAt": "2020-12-22T03:54:06Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -132,7 +131,7 @@ public MapperService(IndexSettings indexSettings, IndexAnalyzers indexAnalyzers,\n     }\n \n     public boolean hasNested() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc0MzMyNA=="}, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MzU2Mg==", "bodyText": "I noticed some other places where we still refer to this.mapper.mappers() directly, for example getEagerGlobalOrdinalsFields. Should we switch these onto mappingLookup() too?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547053562", "createdAt": "2020-12-22T03:55:22Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -399,30 +398,23 @@ public DocumentMapperForType documentMapperWithAutoCreate() {\n      * Given the full name of a field, returns its {@link MappedFieldType}.\n      */\n     public MappedFieldType fieldType(String fullName) {\n-        if (fullName.equals(TypeFieldType.NAME)) {\n-            return new TypeFieldType(this.mapper == null ? \"_doc\" : this.mapper.type());\n-        }\n-        return this.mapper == null ? null : this.mapper.mappers().fieldTypes().get(fullName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1NDE0Nw==", "bodyText": "@nik9000 and I discussed offline, and decided we'd like to just document the behavior for now instead of trying to fix it in this PR. He also filed #66722 to track the issue.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547054147", "createdAt": "2020-12-22T03:57:12Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -444,18 +433,7 @@ public ObjectMapper getObjectMapper(String name) {\n      *                                  directly associated index-time analyzer\n      */\n     public NamedAnalyzer indexAnalyzer(String field, Function<String, NamedAnalyzer> unindexedFieldAnalyzer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk2NTQ2NA=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1NjM3OQ==", "bodyText": "I wonder if we could just use MockFieldMapper here instead of using mockito? It's pretty widely used.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547056379", "createdAt": "2020-12-22T04:06:32Z", "author": {"login": "jtibshirani"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MappingLookupUtils.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.elasticsearch.index.analysis.NamedAnalyzer;\n+import org.elasticsearch.index.mapper.FieldMapper.CopyTo;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static java.util.stream.Collectors.toList;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class MappingLookupUtils {\n+    public static MappingLookup fromTypes(MappedFieldType... types) {\n+        return fromTypes(Arrays.stream(types));\n+    }\n+    \n+    public static MappingLookup fromTypes(Stream<MappedFieldType> types) {\n+        List<FieldMapper> mappers = types.map(MappingLookupUtils::mockFieldMapper).collect(toList());\n+        //  Alias <name>-alias to <name> so we can test aliases\n+        return new MappingLookup(\n+            \"_doc\",\n+            mappers,\n+            List.of(),\n+            List.of(),\n+            List.of(),\n+            0,\n+            souceToParse -> null,\n+            true\n+        );\n+    }\n+\n+    public static FieldMapper mockFieldMapper(MappedFieldType type) {\n+        FieldMapper mapper = mock(FieldMapper.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1NjUyNw==", "bodyText": "souceToParse -> sourceToParse", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547056527", "createdAt": "2020-12-22T04:07:01Z", "author": {"login": "jtibshirani"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -227,38 +225,41 @@ protected AggregationContext createAggregationContext(IndexSearcher indexSearche\n          */\n         BigArrays bigArrays = new MockBigArrays(new MockPageCacheRecycler(Settings.EMPTY), breakerService).withCircuitBreaking();\n \n-        // TODO: now just needed for top_hits, this will need to be revised for other agg unit tests:\n-        MapperService mapperService = mock(MapperService.class);\n-        when(mapperService.getIndexSettings()).thenReturn(indexSettings);\n-        when(mapperService.hasNested()).thenReturn(false);\n-        when(mapperService.indexAnalyzer(anyString(), any())).thenReturn(Lucene.STANDARD_ANALYZER); // for significant text\n-        for (MappedFieldType type : fieldTypes) {\n-            String name = type.name();\n-            when(mapperService.fieldType(name)).thenReturn(type);\n-            // Alias each field to <name>-alias so everyone can test aliases\n-            when(mapperService.fieldType(name + \"-alias\")).thenReturn(type);\n-        }\n-        when(mapperService.getObjectMapper(anyString())).thenAnswer(invocation -> {\n-            String fieldName = (String) invocation.getArguments()[0];\n-            if (fieldName.startsWith(NESTEDFIELD_PREFIX)) {\n-                return new ObjectMapper.Builder(fieldName, Version.CURRENT).nested(Nested.newNested()).build(new ContentPath());\n-            }\n-            return null;\n-        });\n+        MappingLookup mappingLookup = new MappingLookup(\n+            \"_doc\",\n+            Arrays.stream(fieldTypes).map(MappingLookupUtils::mockFieldMapper).collect(toList()),\n+            objectMappers(),\n+            // Alias all fields to <name>-alias to test aliases\n+            Arrays.stream(fieldTypes)\n+                .map(ft -> new FieldAliasMapper(ft.name() + \"-alias\", ft.name() + \"-alias\", ft.name()))\n+                .collect(toList()),\n+            List.of(),\n+            0,\n+            souceToParse -> null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1OTU0OA==", "bodyText": "I didn't look into this deeply, but would it make any sense to mock MappingLookup in these tests to retain flexibility?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547059548", "createdAt": "2020-12-22T04:20:42Z", "author": {"login": "jtibshirani"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -288,16 +296,24 @@ protected AggregationContext createAggregationContext(IndexSearcher indexSearche\n         );\n     }\n \n+    /**\n+     * {@link ObjectMapper}s to add to the lookup. By default we don't need\n+     * any {@link ObjectMapper}s but testing nested objects will require adding some.\n+     */\n+    protected List<ObjectMapper> objectMappers() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMjg2OQ=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA3NDM0Mg==", "bodyText": "Thanks for adding this clarifying comment.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547074342", "createdAt": "2020-12-22T05:23:06Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/indices/IndicesRequestCache.java", "diffHunk": "@@ -128,6 +129,15 @@ BytesReference getOrCompute(CacheEntity cacheEntity, CheckedSupplier<BytesRefere\n                     ElasticsearchDirectoryReader.addReaderCloseListener(reader, cleanupKey);\n                 }\n             }\n+            /*\n+             * note that we don't use a closed listener for the mapping. Instead", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTg5NTQ5", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-556989549", "createdAt": "2020-12-22T10:50:23Z", "commit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMDo1MDoyM1rOIJ24yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMTo1NDoyN1rOIJ4nOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIwNzM3MA==", "bodyText": "do we still need this TODO considering that you opened an issue about it?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547207370", "createdAt": "2020-12-22T10:50:23Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -504,6 +485,7 @@ public boolean isMetadataField(String field) {\n                 reloadedAnalyzers.add(analyzerName);\n             }\n         }\n+        // TODO this should make a new MappingLookup to bust the cache", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIwOTc3NQ==", "bodyText": "Makes sense. These changes though are still required so that QueryShardContext goes through MappingLookup instead of MapperService as part of its indexAnalyzer method? Or should it be part of those leftover methods that we need to decide what to do about (that are not necessary to move over yet we want to remove MapperService access so we need to make up our minds)?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547209775", "createdAt": "2020-12-22T10:55:31Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -444,18 +433,7 @@ public ObjectMapper getObjectMapper(String name) {\n      *                                  directly associated index-time analyzer\n      */\n     public NamedAnalyzer indexAnalyzer(String field, Function<String, NamedAnalyzer> unindexedFieldAnalyzer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk2NTQ2NA=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxMjM4Mg==", "bodyText": "I am really on the fence about this. I also would like to remove references to MapperService, yet I don't see a contained way of doing it, and I would not want to add all kinds of methods to MappingLookup. I wonder if it would be acceptable to consider this a (very important) follow-up, meaning that 7.11 will still have direct MapperService access while we are going to think about a long term solution for 7.x and master moving forward.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547212382", "createdAt": "2020-12-22T11:00:58Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -119,6 +123,7 @@ public QueryShardContext(\n         BitsetFilterCache bitsetFilterCache,\n         TriFunction<MappedFieldType, String, Supplier<SearchLookup>, IndexFieldData<?>> indexFieldDataLookup,\n         MapperService mapperService,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg4MDg1OQ=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxMzYyMA==", "bodyText": "testMappingLookup?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547213620", "createdAt": "2020-12-22T11:03:36Z", "author": {"login": "javanna"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/MapperServiceTests.java", "diffHunk": "@@ -46,6 +47,17 @@ public void testPreflightUpdateDoesNotChangeMapping() throws Throwable {\n         assertThat(\"field was not created by mapping update\", mapperService.fieldType(\"field0\"), notNullValue());\n     }\n \n+    public void testLookup() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxNzY2Nw==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547217667", "createdAt": "2020-12-22T11:12:34Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MappingLookupUtils.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.elasticsearch.index.analysis.NamedAnalyzer;\n+import org.elasticsearch.index.mapper.FieldMapper.CopyTo;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static java.util.stream.Collectors.toList;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class MappingLookupUtils {\n+    public static MappingLookup fromTypes(MappedFieldType... types) {\n+        return fromTypes(Arrays.stream(types));\n+    }\n+    \n+    public static MappingLookup fromTypes(Stream<MappedFieldType> types) {\n+        List<FieldMapper> mappers = types.map(MappingLookupUtils::mockFieldMapper).collect(toList());\n+        //  Alias <name>-alias to <name> so we can test aliases\n+        return new MappingLookup(\n+            \"_doc\",\n+            mappers,\n+            List.of(),\n+            List.of(),\n+            List.of(),\n+            0,\n+            souceToParse -> null,\n+            true\n+        );\n+    }\n+\n+    public static FieldMapper mockFieldMapper(MappedFieldType type) {\n+        FieldMapper mapper = mock(FieldMapper.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1NjM3OQ=="}, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODE4MA==", "bodyText": "The way that this is used looks suspicious to me. I see it being used with runtime fields, which don't have a corresponding mapper normally. With this method they end up being exposed as ordinary fields to tests?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547218180", "createdAt": "2020-12-22T11:13:47Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MappingLookupUtils.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.elasticsearch.index.analysis.NamedAnalyzer;\n+import org.elasticsearch.index.mapper.FieldMapper.CopyTo;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static java.util.stream.Collectors.toList;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class MappingLookupUtils {\n+    public static MappingLookup fromTypes(MappedFieldType... types) {\n+        return fromTypes(Arrays.stream(types));\n+    }\n+    \n+    public static MappingLookup fromTypes(Stream<MappedFieldType> types) {\n+        List<FieldMapper> mappers = types.map(MappingLookupUtils::mockFieldMapper).collect(toList());\n+        //  Alias <name>-alias to <name> so we can test aliases\n+        return new MappingLookup(\n+            \"_doc\",\n+            mappers,\n+            List.of(),\n+            List.of(),\n+            List.of(),\n+            0,\n+            souceToParse -> null,\n+            true\n+        );\n+    }\n+\n+    public static FieldMapper mockFieldMapper(MappedFieldType type) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODYwOQ==", "bodyText": "There should be a separate code-path for creating runtime fields, that only provides them to MappingLookup without them causing the creation of field mappers.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547218609", "createdAt": "2020-12-22T11:14:48Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MappingLookupUtils.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.elasticsearch.index.analysis.NamedAnalyzer;\n+import org.elasticsearch.index.mapper.FieldMapper.CopyTo;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static java.util.stream.Collectors.toList;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class MappingLookupUtils {\n+    public static MappingLookup fromTypes(MappedFieldType... types) {\n+        return fromTypes(Arrays.stream(types));\n+    }\n+    \n+    public static MappingLookup fromTypes(Stream<MappedFieldType> types) {\n+        List<FieldMapper> mappers = types.map(MappingLookupUtils::mockFieldMapper).collect(toList());\n+        //  Alias <name>-alias to <name> so we can test aliases\n+        return new MappingLookup(\n+            \"_doc\",\n+            mappers,\n+            List.of(),\n+            List.of(),\n+            List.of(),\n+            0,\n+            souceToParse -> null,\n+            true\n+        );\n+    }\n+\n+    public static FieldMapper mockFieldMapper(MappedFieldType type) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxODE4MA=="}, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIyMDM3Nw==", "bodyText": "how bad would you feel about leaving this test as-is, and simply providing mapperService.mappingLookup() to the query shard context constructor? Would that work? I figured we'll get back to this anyways once we work on NestedDocuments access.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547220377", "createdAt": "2020-12-22T11:18:36Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -227,38 +225,41 @@ protected AggregationContext createAggregationContext(IndexSearcher indexSearche\n          */\n         BigArrays bigArrays = new MockBigArrays(new MockPageCacheRecycler(Settings.EMPTY), breakerService).withCircuitBreaking();\n \n-        // TODO: now just needed for top_hits, this will need to be revised for other agg unit tests:\n-        MapperService mapperService = mock(MapperService.class);\n-        when(mapperService.getIndexSettings()).thenReturn(indexSettings);\n-        when(mapperService.hasNested()).thenReturn(false);\n-        when(mapperService.indexAnalyzer(anyString(), any())).thenReturn(Lucene.STANDARD_ANALYZER); // for significant text\n-        for (MappedFieldType type : fieldTypes) {\n-            String name = type.name();\n-            when(mapperService.fieldType(name)).thenReturn(type);\n-            // Alias each field to <name>-alias so everyone can test aliases\n-            when(mapperService.fieldType(name + \"-alias\")).thenReturn(type);\n-        }\n-        when(mapperService.getObjectMapper(anyString())).thenAnswer(invocation -> {\n-            String fieldName = (String) invocation.getArguments()[0];\n-            if (fieldName.startsWith(NESTEDFIELD_PREFIX)) {\n-                return new ObjectMapper.Builder(fieldName, Version.CURRENT).nested(Nested.newNested()).build(new ContentPath());\n-            }\n-            return null;\n-        });\n+        MappingLookup mappingLookup = new MappingLookup(\n+            \"_doc\",\n+            Arrays.stream(fieldTypes).map(MappingLookupUtils::mockFieldMapper).collect(toList()),\n+            objectMappers(),\n+            // Alias all fields to <name>-alias to test aliases\n+            Arrays.stream(fieldTypes)\n+                .map(ft -> new FieldAliasMapper(ft.name() + \"-alias\", ft.name() + \"-alias\", ft.name()))\n+                .collect(toList()),\n+            List.of(),\n+            0,\n+            souceToParse -> null,\n+            true\n+        );\n \n         TriFunction<MappedFieldType, String, Supplier<SearchLookup>, IndexFieldData<?>> fieldDataBuilder = (\n             fieldType,\n             s,\n-            searchLookup) -> fieldType.fielddataBuilder(mapperService.getIndexSettings().getIndex().getName(), searchLookup)\n+            searchLookup) -> fieldType.fielddataBuilder(indexSettings.getIndex().getName(), searchLookup)\n                 .build(new IndexFieldDataCache.None(), breakerService);\n+        BitsetFilterCache bitsetFilterCache = new BitsetFilterCache(indexSettings, new BitsetFilterCache.Listener() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIyMjQzMw==", "bodyText": "these changes are great. They make what tests do much more readable, and also allow us to only plug in the needed behaviour. Before the field type lookup would always return the same field type regardless of the provided field name, which is not so easy to follow.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547222433", "createdAt": "2020-12-22T11:23:33Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authz/accesscontrol/SecurityIndexReaderWrapperIntegrationTests.java", "diffHunk": "@@ -182,15 +173,12 @@ protected IndicesAccessControl getIndicesAccessControl() {\n \n     public void testDLSWithLimitedPermissions() throws Exception {\n         ShardId shardId = new ShardId(\"_index\", \"_na_\", 0);\n-        MapperService mapperService = mock(MapperService.class);\n-        ScriptService  scriptService = mock(ScriptService.class);\n-        when(mapperService.documentMapper()).thenReturn(null);\n-        when(mapperService.simpleMatchToFullName(anyString()))\n-                .then(invocationOnMock -> Collections.singletonList((String) invocationOnMock.getArguments()[0]));\n-        when(mapperService.fieldType(Mockito.anyString())).then(invocation -> {\n-            final String fieldName = (String) invocation.getArguments()[0];\n-            return new KeywordFieldMapper.KeywordFieldType(fieldName);\n-        });\n+        MappingLookup mappingLookup = MappingLookupUtils.fromTypes(\n+            new KeywordFieldType(\"field\"),\n+            new KeywordFieldType(\"f1\"),\n+            new KeywordFieldType(\"f2\")\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIyMzYzOQ==", "bodyText": "This one throws me off: why do we need to mock hasNested now compared to before? It looks to me that these test changes are not strictly required and could be made as a follow-up. But I am probably missing something.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547223639", "createdAt": "2020-12-22T11:26:08Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -325,11 +333,13 @@ public boolean shouldCache(Query query) {\n         }\n         when(ctx.fetchPhase()).thenReturn(new FetchPhase(Arrays.asList(new FetchSourcePhase(), new FetchDocValuesPhase())));\n         when(ctx.getQueryShardContext()).thenReturn(queryShardContext);\n-        NestedDocuments nestedDocuments = new NestedDocuments(mapperService, bitsetFilterCache::getBitSetProducer);\n-        when(ctx.getNestedDocuments()).thenReturn(nestedDocuments);\n         IndexShard indexShard = mock(IndexShard.class);\n         when(indexShard.shardId()).thenReturn(new ShardId(\"test\", \"test\", 0));\n         when(ctx.indexShard()).thenReturn(indexShard);\n+        MapperService mapperService = mock(MapperService.class);\n+        when(mapperService.hasNested()).thenReturn(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 172}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIzMDYwMA==", "bodyText": "shouldn't we add mappingCacheKey to hashcode as well? Maybe we should expand IndicesRequestCacheTests so that it catches this?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547230600", "createdAt": "2020-12-22T11:42:05Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/indices/IndicesRequestCache.java", "diffHunk": "@@ -236,7 +248,8 @@ public boolean equals(Object o) {\n             if (this == o) return true;\n             if (o == null || getClass() != o.getClass()) return false;\n             Key key = (Key) o;\n-            if (Objects.equals(readerCacheKey, key.readerCacheKey) == false) return false;\n+            if (mappingCacheKey.equals(key.mappingCacheKey) == false) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIzMTA4NQ==", "bodyText": "could we simply use an empty mapping lookup here instead of calling fromTypes without providing any type?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547231085", "createdAt": "2020-12-22T11:43:20Z", "author": {"login": "javanna"}, "path": "server/src/test/java/org/elasticsearch/indices/IndicesRequestCacheTests.java", "diffHunk": "@@ -198,13 +203,93 @@ public void testCacheDifferentReaders() throws Exception {\n         assertEquals(0, requestCacheStats.stats().getEvictions());\n         assertTrue(loader.loadedFromCache);\n         assertEquals(0, cache.count());\n-        assertEquals(0, requestCacheStats.stats().getMemorySize().bytesAsInt());\n+        assertEquals(0L, requestCacheStats.stats().getMemorySize().getBytes());\n \n         IOUtils.close(secondReader, writer, dir, cache);\n         assertEquals(0, cache.numRegisteredCloseListeners());\n     }\n \n+    public void testCacheDifferentMapping() throws Exception {\n+        IndicesRequestCache cache = new IndicesRequestCache(Settings.EMPTY);\n+        MappingLookup.CacheKey mappingKey1 = MappingLookupUtils.fromTypes().cacheKey();\n+        MappingLookup.CacheKey mappingKey2 = MappingLookupUtils.fromTypes().cacheKey();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIzNTY0Mg==", "bodyText": "maybe I only need to get used to this approach, but I wonder if it is necessary to carry around this additional cache key. I guess it is no option to make it become part of the existing cacheKey that the request exposes or something along these lines?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547235642", "createdAt": "2020-12-22T11:54:27Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -603,15 +613,19 @@ public BigArrays bigArrays() {  // TODO this is only used in agg land, maybe rem\n         return bigArrays;\n     }\n \n-    private static Map<String, MappedFieldType> parseRuntimeMappings(\n-        Map<String, Object> runtimeMappings,\n-        MapperService mapperService\n-    ) {\n+    private static Map<String, MappedFieldType> parseRuntimeMappings(Map<String, Object> runtimeMappings, MapperService mapperService) {\n         Map<String, MappedFieldType> runtimeFieldTypes = new HashMap<>();\n         if (runtimeMappings.isEmpty() == false) {\n             RuntimeFieldType.parseRuntimeFields(new HashMap<>(runtimeMappings), mapperService.parserContext(),\n                 runtimeFieldType -> runtimeFieldTypes.put(runtimeFieldType.name(), runtimeFieldType));\n         }\n         return Collections.unmodifiableMap(runtimeFieldTypes);\n     }\n+\n+    /**\n+     * Cache key for current mapping.\n+     */\n+    public MappingLookup.CacheKey mappingCacheKey() {\n+        return mappingLookup.cacheKey();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 182}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67364828c4273a83df8ad074fdf6115bb8461cd0", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/67364828c4273a83df8ad074fdf6115bb8461cd0", "committedDate": "2020-12-22T12:51:23Z", "message": "words are hard"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65962e2fdd083fb54ac8ef53425216475cecc0dc", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/65962e2fdd083fb54ac8ef53425216475cecc0dc", "committedDate": "2020-12-22T12:57:51Z", "message": "Switch to MockFieldMapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f4adcca0e78c0889b172a9d91d6a4ee838157bb", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f4adcca0e78c0889b172a9d91d6a4ee838157bb", "committedDate": "2020-12-22T12:59:15Z", "message": "Speeling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "068e67d02a1861698d63411824eb7053e513753f", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/068e67d02a1861698d63411824eb7053e513753f", "committedDate": "2020-12-22T13:00:24Z", "message": "Add link in todo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b7cc2786da39c1e5e81435cbec1b5ed4cb15b07", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b7cc2786da39c1e5e81435cbec1b5ed4cb15b07", "committedDate": "2020-12-22T13:01:29Z", "message": "Finish rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83f9f30acfe3557643603d00444fd05ff48a1c42", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/83f9f30acfe3557643603d00444fd05ff48a1c42", "committedDate": "2020-12-22T13:14:13Z", "message": "Special handling of runtime fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc89ecbcb171eb9b5c60a6b6721ee6fb570bf91c", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/fc89ecbcb171eb9b5c60a6b6721ee6fb570bf91c", "committedDate": "2020-12-22T13:15:21Z", "message": "Extra casting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78d5b334f2526363f58dc35fd343239bd3225c48", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/78d5b334f2526363f58dc35fd343239bd3225c48", "committedDate": "2020-12-22T13:30:16Z", "message": "equals and hashcode for the key"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4795914b6dc5f888466e583ae22c0c85771c203", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4795914b6dc5f888466e583ae22c0c85771c203", "committedDate": "2020-12-22T13:35:24Z", "message": "Speeling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86575731d7c8c3e7b4732c593f8455c336cd9e88", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/86575731d7c8c3e7b4732c593f8455c336cd9e88", "committedDate": "2020-12-22T13:39:26Z", "message": "Start your paragraph with a capital letter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50ca0ef12bed7ee379ec91ba9a6c90553807bda8", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/50ca0ef12bed7ee379ec91ba9a6c90553807bda8", "committedDate": "2020-12-22T13:43:04Z", "message": "Not null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MDc5MjA3", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-557079207", "createdAt": "2020-12-22T13:29:57Z", "commit": {"oid": "78d5b334f2526363f58dc35fd343239bd3225c48"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMzoyOTo1N1rOIJ7N1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMzo0Mzo1NlrOIJ7nuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI3ODI5NQ==", "bodyText": "Given how folks received my last attempt at this I wanted to keep my change as small as I could manage. I think it is correct to switch them all to mappingLookup and my instinct is to do it now, while I'm here. But I don't want to make this harder to review.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547278295", "createdAt": "2020-12-22T13:29:57Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -399,30 +398,23 @@ public DocumentMapperForType documentMapperWithAutoCreate() {\n      * Given the full name of a field, returns its {@link MappedFieldType}.\n      */\n     public MappedFieldType fieldType(String fullName) {\n-        if (fullName.equals(TypeFieldType.NAME)) {\n-            return new TypeFieldType(this.mapper == null ? \"_doc\" : this.mapper.type());\n-        }\n-        return this.mapper == null ? null : this.mapper.mappers().fieldTypes().get(fullName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MzU2Mg=="}, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI3ODY5NQ==", "bodyText": "I did that sort of thing in my original cache busting change and it made the change too difficult to review. I'd like to save it for a follow up so we can get this one in.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547278695", "createdAt": "2020-12-22T13:30:53Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -132,7 +131,7 @@ public MapperService(IndexSettings indexSettings, IndexAnalyzers indexAnalyzers,\n     }\n \n     public boolean hasNested() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc0MzMyNA=="}, "originalCommit": {"oid": "2b6fbce312c8fb54b5255a6a0ec053ce0f775f41"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI3OTEwOA==", "bodyText": "These are required for QueryShardContext to get the snapshot, yeah.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547279108", "createdAt": "2020-12-22T13:31:43Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -444,18 +433,7 @@ public ObjectMapper getObjectMapper(String name) {\n      *                                  directly associated index-time analyzer\n      */\n     public NamedAnalyzer indexAnalyzer(String field, Function<String, NamedAnalyzer> unindexedFieldAnalyzer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk2NTQ2NA=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI3OTUyOQ==", "bodyText": "d479591", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547279529", "createdAt": "2020-12-22T13:32:43Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -28,19 +28,49 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.function.Function;\n import java.util.stream.Stream;\n \n-public final class MappingLookup {\n+/**\n+ * A (mostly) immutable snapshot current mapping of an index with access\n+ * to everything we need for the search phase.\n+ */\n+public class MappingLookup {\n+    /**\n+     * Key for the lookup to be used in caches.\n+     */\n+    public static class CacheKey {\n+        private CacheKey() {}\n+    }\n+\n+    /**\n+     * A lookup representing an empty mapping.\n+     */\n+    public static final MappingLookup EMPTY = new MappingLookup(\n+        \"_doc\",\n+        List.of(),\n+        List.of(),\n+        List.of(),\n+        List.of(),\n+        0,\n+        souceToParse -> null,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA0ODgwMQ=="}, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI4MDc0MQ==", "bodyText": "I'd like to delay this simply because we aren't sure we want this. I think its reasonable but I understand the argument of wanting the MapperService reference for the \"immutable stuff\". It just that MapperService lets you do the mutable read too and it'd be nice not to have to worry about accidentally doing it.\nIf we had a separate object or interface for the immutable stuff I think it'd be really compelling to keep them separate.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547280741", "createdAt": "2020-12-22T13:35:19Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -119,6 +123,7 @@ public QueryShardContext(\n         BitsetFilterCache bitsetFilterCache,\n         TriFunction<MappedFieldType, String, Supplier<SearchLookup>, IndexFieldData<?>> indexFieldDataLookup,\n         MapperService mapperService,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg4MDg1OQ=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI4MjIwNg==", "bodyText": "This isn't strictly required but the old method is deprecated and I figured I'd clean it up while I was here.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547282206", "createdAt": "2020-12-22T13:38:15Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/indices/IndicesRequestCacheTests.java", "diffHunk": "@@ -80,14 +85,14 @@ public void testBasicOperationsCache() throws Exception {\n         // cache hit\n         entity = new TestEntity(requestCacheStats, indexShard);\n         loader = new Loader(reader, 0);\n-        value = cache.getOrCompute(entity, loader, reader, termBytes);\n+        value = cache.getOrCompute(entity, loader, mappingKey, reader, termBytes);\n         assertEquals(\"foo\", value.streamInput().readString());\n         assertEquals(1, requestCacheStats.stats().getHitCount());\n         assertEquals(1, requestCacheStats.stats().getMissCount());\n         assertEquals(0, requestCacheStats.stats().getEvictions());\n         assertTrue(loader.loadedFromCache);\n         assertEquals(1, cache.count());\n-        assertTrue(requestCacheStats.stats().getMemorySize().bytesAsInt() > value.length());\n+        assertTrue(requestCacheStats.stats().getMemorySize().getBytes() > value.length());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78d5b334f2526363f58dc35fd343239bd3225c48"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI4NDM4Mg==", "bodyText": "We couldn't easily mock MappingLookup until yesterday because we exposed FieldTypeLookup. But now that we don't we could. I don't particularly want to though. I kind of like having a real lookup now. But maybe I've just gotten used to it.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547284382", "createdAt": "2020-12-22T13:42:52Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -288,16 +296,24 @@ protected AggregationContext createAggregationContext(IndexSearcher indexSearche\n         );\n     }\n \n+    /**\n+     * {@link ObjectMapper}s to add to the lookup. By default we don't need\n+     * any {@link ObjectMapper}s but testing nested objects will require adding some.\n+     */\n+    protected List<ObjectMapper> objectMappers() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzcwMjg2OQ=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI4NDkyMw==", "bodyText": "Previously we bumped into this behavior because of the defaults of mockito - it returns false unless you tell it otherwise. So I'm making this explicit....", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547284923", "createdAt": "2020-12-22T13:43:56Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -325,11 +333,13 @@ public boolean shouldCache(Query query) {\n         }\n         when(ctx.fetchPhase()).thenReturn(new FetchPhase(Arrays.asList(new FetchSourcePhase(), new FetchDocValuesPhase())));\n         when(ctx.getQueryShardContext()).thenReturn(queryShardContext);\n-        NestedDocuments nestedDocuments = new NestedDocuments(mapperService, bitsetFilterCache::getBitSetProducer);\n-        when(ctx.getNestedDocuments()).thenReturn(nestedDocuments);\n         IndexShard indexShard = mock(IndexShard.class);\n         when(indexShard.shardId()).thenReturn(new ShardId(\"test\", \"test\", 0));\n         when(ctx.indexShard()).thenReturn(indexShard);\n+        MapperService mapperService = mock(MapperService.class);\n+        when(mapperService.hasNested()).thenReturn(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIyMzYzOQ=="}, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 172}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "551ce49d863443b9d0e4cbd847b8fc81f0f6e9d6", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/551ce49d863443b9d0e4cbd847b8fc81f0f6e9d6", "committedDate": "2020-12-22T15:35:01Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MTY2MzU0", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-557166354", "createdAt": "2020-12-22T15:33:32Z", "commit": {"oid": "50ca0ef12bed7ee379ec91ba9a6c90553807bda8"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNTozMzozMlrOIJ_PnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNjozMzozM1rOIKBQVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0NDI4NQ==", "bodyText": "the request cache?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547344285", "createdAt": "2020-12-22T15:33:32Z", "author": {"login": "javanna"}, "path": "docs/reference/indices/apis/reload-analyzers.asciidoc", "diffHunk": "@@ -13,9 +13,17 @@ stream's backing indices.\n [source,console]\n --------------------------------------------------\n POST /my-index-000001/_reload_search_analyzers\n+POST /my-index-000001/_cache/clear?request=true\n --------------------------------------------------\n // TEST[setup:my_index]\n \n+IMPORTANT: After reloading the search analyzers you should clear the request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ca0ef12bed7ee379ec91ba9a6c90553807bda8"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0NDU2OQ==", "bodyText": "s/derrived/derived", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547344569", "createdAt": "2020-12-22T15:33:59Z", "author": {"login": "javanna"}, "path": "docs/reference/indices/apis/reload-analyzers.asciidoc", "diffHunk": "@@ -13,9 +13,17 @@ stream's backing indices.\n [source,console]\n --------------------------------------------------\n POST /my-index-000001/_reload_search_analyzers\n+POST /my-index-000001/_cache/clear?request=true\n --------------------------------------------------\n // TEST[setup:my_index]\n \n+IMPORTANT: After reloading the search analyzers you should clear the request\n+           to make sure it doesn't contain responses derrived from the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ca0ef12bed7ee379ec91ba9a6c90553807bda8"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1MDE1Nw==", "bodyText": "indeed, this looks odd, I am sure Alan would not like it :) at the same time, I don't see an alternative for now. Would be nice to remove DocumentMapper#type as least but there are other usages of it. And given types will be completely removed, we are sure this will go away.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547350157", "createdAt": "2020-12-22T15:43:52Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldTypeLookup.java", "diffHunk": "@@ -43,11 +44,16 @@\n      * For convenience, the set of copied fields includes the field itself.\n      */\n     private final Map<String, Set<String>> fieldToCopiedFields = new HashMap<>();\n+    private final String type;\n     private final DynamicKeyFieldTypeLookup dynamicKeyLookup;\n \n-    FieldTypeLookup(Collection<FieldMapper> fieldMappers,\n-                    Collection<FieldAliasMapper> fieldAliasMappers,\n-                    Collection<RuntimeFieldType> runtimeFieldTypes) {\n+    FieldTypeLookup(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MTQ3OQ=="}, "originalCommit": {"oid": "07c74b37ed7fbc137c5bef587a108289bb0fb7e2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1MTE0MQ==", "bodyText": "I get it. My question is: given that we are not fixing analyzers reloading, do we need query shard context to go through mapping lookup to get this? Or can we leave it on MapperService until we properly address it?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547351141", "createdAt": "2020-12-22T15:45:38Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -444,18 +433,7 @@ public ObjectMapper getObjectMapper(String name) {\n      *                                  directly associated index-time analyzer\n      */\n     public NamedAnalyzer indexAnalyzer(String field, Function<String, NamedAnalyzer> unindexedFieldAnalyzer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk2NTQ2NA=="}, "originalCommit": {"oid": "c1cf01b03391d58c451d3f4c0edb915d251ce137"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1Mzg2Ng==", "bodyText": "was this change necessary?", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547353866", "createdAt": "2020-12-22T15:50:31Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/indices/IndicesRequestCache.java", "diffHunk": "@@ -236,7 +248,8 @@ public boolean equals(Object o) {\n             if (this == o) return true;\n             if (o == null || getClass() != o.getClass()) return false;\n             Key key = (Key) o;\n-            if (Objects.equals(readerCacheKey, key.readerCacheKey) == false) return false;\n+            if (mappingCacheKey.equals(key.mappingCacheKey) == false) return false;\n+            if (readerCacheKey.equals(key.readerCacheKey) == false) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ca0ef12bed7ee379ec91ba9a6c90553807bda8"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM2MjEwNQ==", "bodyText": "we have EqualsHashCodeTestUtils, not sure it's worth using it here", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547362105", "createdAt": "2020-12-22T16:05:20Z", "author": {"login": "javanna"}, "path": "server/src/test/java/org/elasticsearch/indices/IndicesRequestCacheTests.java", "diffHunk": "@@ -441,19 +532,51 @@ public void testEqualsKey() throws IOException {\n         IndexReader reader2 = DirectoryReader.open(writer);\n         IndexReader.CacheKey rKey2 = reader2.getReaderCacheHelper().getKey();\n         IOUtils.close(reader1, reader2, writer, dir);\n-        IndicesRequestCache.Key key1 = new IndicesRequestCache.Key(new TestEntity(null, trueBoolean), rKey1, new TestBytesReference(1));\n-        IndicesRequestCache.Key key2 = new IndicesRequestCache.Key(new TestEntity(null, trueBoolean), rKey1, new TestBytesReference(1));\n-        IndicesRequestCache.Key key3 = new IndicesRequestCache.Key(new TestEntity(null, falseBoolean), rKey1, new TestBytesReference(1));\n-        IndicesRequestCache.Key key4 = new IndicesRequestCache.Key(new TestEntity(null, trueBoolean), rKey2, new TestBytesReference(1));\n-        IndicesRequestCache.Key key5 = new IndicesRequestCache.Key(new TestEntity(null, trueBoolean), rKey1, new TestBytesReference(2));\n-        String s = \"Some other random object\";\n-        assertEquals(key1, key1);\n+        List<IndicesRequestCache.Key> keys = new ArrayList<>();\n+        for (AtomicBoolean bool : new AtomicBoolean[] { trueBoolean, falseBoolean }) {\n+            for (MappingLookup.CacheKey mKey : new MappingLookup.CacheKey[] { mKey1, mKey2 }) {\n+                for (IndexReader.CacheKey rKey : new IndexReader.CacheKey[] { rKey1, rKey2 }) {\n+                    for (BytesReference requestKey : new BytesReference[] { new TestBytesReference(1), new TestBytesReference(2) }) {\n+                        keys.add(new IndicesRequestCache.Key(new TestEntity(null, bool), mKey, rKey, requestKey));\n+                    }\n+                }\n+            }\n+        }\n+        for (IndicesRequestCache.Key key : keys) {\n+            assertNotEquals(key, null);\n+            assertNotEquals(key, \"Some other random object\");\n+        }\n+        for (IndicesRequestCache.Key key1 : keys) {\n+            assertNotEquals(key1, null);\n+            for (IndicesRequestCache.Key key2 : keys) {\n+                if (key1 == key2) {\n+                    assertEquals(key1, key2);\n+                    assertEquals(key1.hashCode(), key2.hashCode());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ca0ef12bed7ee379ec91ba9a6c90553807bda8"}, "originalPosition": 401}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM3NzIzOQ==", "bodyText": "not a fan of this if either. I would rather do one of the following two things:\n\n\nsubclass MappingLookup and override only the needed methods, that way we don't have to create a field mapper at all. not sure if till work everywhere, but it's what were previously doing in QueryShardContextTests.\n\n\nhave a different method that accepts RuntimeFieldTypes. Along these lines I was wondering if the following method needs to be public, and if the analyzers logic is needed in all the callers or should be rather be pushed to the callers that need it, in which case we could make callers provide field mappers instead of mapped field types as they'd only need to do  new MockFieldMapper(fieldType).", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547377239", "createdAt": "2020-12-22T16:33:33Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MappingLookupUtils.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.elasticsearch.index.analysis.NamedAnalyzer;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class MappingLookupUtils {\n+    public static MappingLookup fromTypes(MappedFieldType... types) {\n+        return fromTypes(Arrays.asList(types));\n+    }\n+\n+    public static MappingLookup fromTypes(List<MappedFieldType> fields) {\n+        List<FieldMapper> mappers = new ArrayList<>();\n+        List<RuntimeFieldType> runtimeFields = new ArrayList<>();\n+        for (MappedFieldType type : fields) {\n+            if (type instanceof RuntimeFieldType) {\n+                runtimeFields.add((RuntimeFieldType) type);\n+            } else {\n+                mappers.add(mockFieldMapper(type));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50ca0ef12bed7ee379ec91ba9a6c90553807bda8"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "465e6a649b51ddd58e6bca20cc317bff92bc0963", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/465e6a649b51ddd58e6bca20cc317bff92bc0963", "committedDate": "2020-12-22T17:45:06Z", "message": "Try this"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3NDM1NDU2", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-557435456", "createdAt": "2020-12-23T00:08:50Z", "commit": {"oid": "ed582f4e3df951b065bf415116ccdf1270484279"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMDowODo1MFrOIKMzBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QwMDowOTowNVrOIKMzRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2NjM0Mg==", "bodyText": "I also don't think it hides a volatile read, but I do find the logic hard to follow: this function uses DocumentMapper, which is a holder object with more state. For this change I think it'd be cleanest to remove this function parameter and use MapperService directly to perform parsing: mapperService.documentMapper().parse(...). Then we can figure out how to remove this as we work through the other follow-ups.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547566342", "createdAt": "2020-12-23T00:08:50Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -28,19 +29,45 @@\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n import java.util.function.Function;\n import java.util.stream.Stream;\n \n-public final class MappingLookup {\n+public class MappingLookup {\n+    /**\n+     * Key for the lookup to be used in caches.\n+     */\n+    public class CacheKey {\n+        private CacheKey() {}\n+    }\n+\n+    /**\n+     * A lookup representing an empty mapping.\n+     */\n+    public static final MappingLookup EMPTY = new MappingLookup(\n+        \"_doc\",\n+        List.of(),\n+        List.of(),\n+        List.of(),\n+        List.of(),\n+        0,\n+        souceToParse -> null,\n+        false\n+    );\n+\n+    private final CacheKey cacheKey = new CacheKey();\n+\n     /** Full field name to mapper */\n     private final Map<String, Mapper> fieldMappers;\n     private final Map<String, ObjectMapper> objectMappers;\n     private final boolean hasNested;\n     private final FieldTypeLookup fieldTypeLookup;\n     private final int metadataFieldCount;\n     private final Map<String, NamedAnalyzer> indexAnalyzers = new HashMap<>();\n+    private final Function<SourceToParse, ParsedDocument> documentParser;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYzOTg2OA=="}, "originalCommit": {"oid": "ed582f4e3df951b065bf415116ccdf1270484279"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzU2NjQwNw==", "bodyText": "Piggy-backing off this comment: it'd be great to update the \"Cache invalidation\" section in request_cache.asciidoc with a line about mapping updates.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547566407", "createdAt": "2020-12-23T00:09:05Z", "author": {"login": "jtibshirani"}, "path": "docs/reference/indices/apis/reload-analyzers.asciidoc", "diffHunk": "@@ -13,9 +13,17 @@ stream's backing indices.\n [source,console]\n --------------------------------------------------\n POST /my-index-000001/_reload_search_analyzers\n+POST /my-index-000001/_cache/clear?request=true\n --------------------------------------------------\n // TEST[setup:my_index]\n \n+IMPORTANT: After reloading the search analyzers you should clear the request", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM0NDI4NQ=="}, "originalCommit": {"oid": "50ca0ef12bed7ee379ec91ba9a6c90553807bda8"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caba1497e62a25915b96505b02528c2f79565b4d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/caba1497e62a25915b96505b02528c2f79565b4d", "committedDate": "2020-12-23T14:04:24Z", "message": "Merge branch 'master' into cache_bust_take_two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27eef8b884a127a2ccfc0f0e9ff881186e608354", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/27eef8b884a127a2ccfc0f0e9ff881186e608354", "committedDate": "2020-12-23T14:17:03Z", "message": "Update cache invalidation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "629f510ea9db1212df07531509b098766703bc27", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/629f510ea9db1212df07531509b098766703bc27", "committedDate": "2020-12-23T14:17:56Z", "message": "Speeling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3OTEwNzU5", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-557910759", "createdAt": "2020-12-23T14:45:01Z", "commit": {"oid": "629f510ea9db1212df07531509b098766703bc27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNDo0NTowMVrOIKmyuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNDo0NTowMVrOIKmyuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk5MjI0OQ==", "bodyText": "s/ther eare/there are", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547992249", "createdAt": "2020-12-23T14:45:01Z", "author": {"login": "javanna"}, "path": "docs/reference/modules/indices/request_cache.asciidoc", "diffHunk": "@@ -32,14 +32,14 @@ Scripted queries that use the API calls which are non-deterministic, such as\n The cache is smart -- it keeps the same _near real-time_ promise as uncached\n search.\n \n-Cached results are invalidated automatically whenever the shard refreshes, but\n-only if the data in the shard has actually changed.  In other words, you will\n-always get the same results from the cache as you would for an uncached search\n-request.\n+Cached results are invalidated automatically whenever the shard refreshes to\n+pick up changes to the documents or when you update the mapping. In other\n+words you will always get the same results from the cache as you would for an\n+uncached search request.\n \n The longer the refresh interval, the longer that cached entries will remain\n-valid. If the cache is full, the least recently used cache keys will be\n-evicted.\n+valid even if ther eare changes to the documents. If the cache is full, the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "629f510ea9db1212df07531509b098766703bc27"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3OTE0MTE2", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-557914116", "createdAt": "2020-12-23T14:50:10Z", "commit": {"oid": "629f510ea9db1212df07531509b098766703bc27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNDo1MDoxMFrOIKm8bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNDo1MDoxMFrOIKm8bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk5NDczMg==", "bodyText": "the size of this class makes me now wonder if we should drop it in favour of an additional test constructor/method in MappingLookup.", "url": "https://github.com/elastic/elasticsearch/pull/66295#discussion_r547994732", "createdAt": "2020-12-23T14:50:10Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MappingLookupUtils.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static java.util.stream.Collectors.toList;\n+\n+public class MappingLookupUtils {\n+    public static MappingLookup fromTypes(MappedFieldType... types) {\n+        return fromTypes(Arrays.asList(types), List.of());\n+    }\n+\n+    public static MappingLookup fromTypes(List<MappedFieldType> concreteFields, List<RuntimeFieldType> runtimeFields) {\n+        List<FieldMapper> mappers = concreteFields.stream().map(MockFieldMapper::new).collect(toList());\n+        return new MappingLookup(\"_doc\", mappers, List.of(), List.of(), runtimeFields, 0, souceToParse -> null, true);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "629f510ea9db1212df07531509b098766703bc27"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f4efd64699b89dae240a2e3b1a929f8105942d5", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f4efd64699b89dae240a2e3b1a929f8105942d5", "committedDate": "2020-12-23T17:24:02Z", "message": "Typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MTM2NDA3", "url": "https://github.com/elastic/elasticsearch/pull/66295#pullrequestreview-558136407", "createdAt": "2020-12-23T17:31:23Z", "commit": {"oid": "4f4efd64699b89dae240a2e3b1a929f8105942d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4644, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}