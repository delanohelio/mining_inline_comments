{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1ODM1NDQz", "number": 51305, "title": "Expose API key name to the ingest pipeline", "bodyText": "API key name is an important piece of information for traceability when\ndata are being ingested from multiple agents.\nThis becomes more relevant with the incoming support of required\npipelines (#46847)\nResolves: #49106", "createdAt": "2020-01-22T12:47:06Z", "url": "https://github.com/elastic/elasticsearch/pull/51305", "merged": true, "mergeCommit": {"oid": "5c9f79534f4c493f254fc502da804e7da5cf9782"}, "closed": true, "closedAt": "2020-02-10T02:56:08Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb81BFIAH2gAyMzY1ODM1NDQzOjg4ZmYwMDFmMmMyYTA4ZTE4ZDllNzA0OTlmZTdlZGQ3NDYxOTkyNGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCyg5bgFqTM1NTY1MjYzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "88ff001f2c2a08e18d9e70499fe7edd74619924c", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/88ff001f2c2a08e18d9e70499fe7edd74619924c", "committedDate": "2020-01-22T12:36:32Z", "message": "WIP expose ApiKey name to ingest processor\n\nWorking code, pending tests and check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NzY4NTA5", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-347768509", "createdAt": "2020-01-24T06:27:41Z", "commit": {"oid": "88ff001f2c2a08e18d9e70499fe7edd74619924c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwNjoyNzo0MVrOFhU2Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwNjoyOTowOFrOFhU3bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ4ODkzNQ==", "bodyText": "We should take this opportunity to add other information to the processor at the same time.\nI'm thinking maybe:\n\nAPI Key Id\nAPI Key Realm\nAuthentication Realm (Name + Type)\nAuthentication Type (AuthenticationType)\n\nHowever, I suspect it's not worth having a separate property for every field, may just\n\nAPI_KEY (and we always populate the id, name and realm)\nREALM (which has realm name & type)\nAUTHENTICATION_TYPE (a single field)\n\nwe could merge realm and authc-type, but it's probably not worth it.", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r370488935", "createdAt": "2020-01-24T06:27:41Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessor.java", "diffHunk": "@@ -134,7 +141,8 @@ public SetSecurityUserProcessor create(Map<String, Processor.Factory> processorF\n         FULL_NAME,\n         EMAIL,\n         ROLES,\n-        METADATA;\n+        METADATA,\n+        API_KEY_NAME;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ff001f2c2a08e18d9e70499fe7edd74619924c"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ4OTE5Nw==", "bodyText": "See my other comment about wanting the id etc as well.\nI think this should be a nested object inside the user object.\nuser: {\n   username: \"...\",\n   api_key: {\n       name: \"...\", id: \"...\", \"realm\": \"...\"\n   }\n}", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r370489197", "createdAt": "2020-01-24T06:29:08Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessor.java", "diffHunk": "@@ -81,6 +82,12 @@ public IngestDocument execute(IngestDocument ingestDocument) throws Exception {\n                         userObject.put(\"metadata\", user.metadata());\n                     }\n                     break;\n+                case API_KEY_NAME:\n+                    Object apiKeyName = authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY);\n+                    if (apiKeyName != null) {\n+                        userObject.put(\"api_key_name\", apiKeyName);\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ff001f2c2a08e18d9e70499fe7edd74619924c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1592f87aafd774a9b22d05bf36fcdf19b962c7c", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1592f87aafd774a9b22d05bf36fcdf19b962c7c", "committedDate": "2020-01-29T03:54:48Z", "message": "Merge remote-tracking branch 'origin/master' into es-49106-apikey-name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "620554aa143aaa873063cc780785676dc80ea7c8", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/620554aa143aaa873063cc780785676dc80ea7c8", "committedDate": "2020-01-29T06:06:33Z", "message": "WIP: expose more info about auth object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2ac3f6f093424fa6636bc7b64cfb5708af9ad56", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2ac3f6f093424fa6636bc7b64cfb5708af9ad56", "committedDate": "2020-01-29T07:17:23Z", "message": "Use a more backwards compatible schema"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d481a56b8424aab34a54adde9a093d503b50cbfc", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/d481a56b8424aab34a54adde9a093d503b50cbfc", "committedDate": "2020-01-29T08:10:31Z", "message": "Fix broken tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29f33ce81eacc9f4d2cd5848a0d6987811611db0", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/29f33ce81eacc9f4d2cd5848a0d6987811611db0", "committedDate": "2020-01-29T10:48:14Z", "message": "Tidy up for tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b81c6e3352188b3b50cc013e39992ef961dcdbf4", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/b81c6e3352188b3b50cc013e39992ef961dcdbf4", "committedDate": "2020-01-29T10:48:55Z", "message": "Merge remote-tracking branch 'origin/master' into es-49106-apikey-name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDcxNTk1", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-350071595", "createdAt": "2020-01-29T12:33:37Z", "commit": {"oid": "b81c6e3352188b3b50cc013e39992ef961dcdbf4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMjozMzozN1rOFjG0HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMjozMzozN1rOFjG0HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NjEyNQ==", "bodyText": "Add a new field for realm type as discussed", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r372356125", "createdAt": "2020-01-29T12:33:37Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/resources/security-index-template-7.json", "diffHunk": "@@ -194,6 +194,9 @@\n             },\n             \"realm\" : {\n               \"type\" : \"keyword\"\n+            },\n+            \"realm_type\" : {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b81c6e3352188b3b50cc013e39992ef961dcdbf4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deb7ca989c066e47421330759a5d1b5cd203eaca", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/deb7ca989c066e47421330759a5d1b5cd203eaca", "committedDate": "2020-01-31T11:55:49Z", "message": "Merge branch 'master' into es-49106-apikey-name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d508a30aeba0d7c556fe20eec031330dfc90202", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/4d508a30aeba0d7c556fe20eec031330dfc90202", "committedDate": "2020-01-31T12:12:20Z", "message": "Update docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMDI3NDU2", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-352027456", "createdAt": "2020-02-03T05:32:02Z", "commit": {"oid": "4d508a30aeba0d7c556fe20eec031330dfc90202"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNTozMjowMlrOFkmu3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNTo0OTowM1rOFkm50A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyNzY0Ng==", "bodyText": "All this duplication bothers me. Can we just put a method like getRealmThatReallyResolvedTheUser() on Authentication?\nObviously there's some work to do on that name.", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r373927646", "createdAt": "2020-02-03T05:32:02Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/ApiKeyService.java", "diffHunk": "@@ -273,6 +275,8 @@ XContentBuilder newDocument(SecureString apiKey, String name, Authentication aut\n             .field(\"metadata\", authentication.getUser().metadata())\n             .field(\"realm\", authentication.getLookedUpBy() == null ?\n                 authentication.getAuthenticatedBy().getName() : authentication.getLookedUpBy().getName())\n+            .field(\"realm_type\", authentication.getLookedUpBy() == null ?\n+                authentication.getAuthenticatedBy().getType() : authentication.getLookedUpBy().getType())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d508a30aeba0d7c556fe20eec031330dfc90202"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyODI2MQ==", "bodyText": "Per #51454, if userObject has an api_key field already, and it's an object (Map) then we should add new fields to that object, not overwrite it.\nLikewise for realm.", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r373928261", "createdAt": "2020-02-03T05:35:49Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessor.java", "diffHunk": "@@ -85,6 +86,39 @@ public IngestDocument execute(IngestDocument ingestDocument) throws Exception {\n                         userObject.put(\"metadata\", user.metadata());\n                     }\n                     break;\n+                case API_KEY:\n+                    final HashMap<String, Object> apiKey = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d508a30aeba0d7c556fe20eec031330dfc90202"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyOTU2MQ==", "bodyText": "I think describing the realm property in the space of API Keys would lead some users to read it as only applying to API Keys. It would be better to say something like:\nThe `api_key` property is only applicable when the authentication is\nthrough API key. It is an object containing two fields, `id` and `name`.\n\nThe `realm` property is also an object with two fields, `name` and `type`.\nWhen using API key authentication, the `realm` property refers to the realm\nfrom which the API key is created. \n\nThat said, I think we ought to actually expand this whole section and give examples, etc.\nI'd be happy to see that in a followup PR though.", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r373929561", "createdAt": "2020-02-03T05:43:28Z", "author": {"login": "tvernum"}, "path": "docs/reference/ingest/processors/set-security-user.asciidoc", "diffHunk": "@@ -1,18 +1,23 @@\n [[ingest-node-set-security-user-processor]]\n === Set Security User Processor\n-Sets user-related details (such as `username`,  `roles`, `email`, `full_name`\n-and `metadata` ) from the current\n+Sets user-related details (such as `username`,  `roles`, `email`, `full_name`,\n+`metadata`, `api_key`, `realm` and `authentication_type`) from the current\n authenticated user to the current document by pre-processing the ingest.\n+The `api_key` property is only applicable when the authentication is\n+through API key. It is an object containing two fields, `id` and `name`.\n+When using API key authentication, the `realm` property refers to the realm\n+from which the API key is created. It is also an object with two fields,\n+`name` and `type`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d508a30aeba0d7c556fe20eec031330dfc90202"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMDQ0OA==", "bodyText": "I think there's a mismatch here.\nThe API Key service populates the API key creator realm based on the looked-up-by.\nBut the getCreatorRealm* methods return the authenticating realm, not the looked up realm.\nSo, if I do curl -u elastic -H \"es-security-runas-user: foo\" PUT /index/_doc/1 the pipeline will record the realm as reserved\nBut if I do curl -u elastic -H \"es-security-runas-user: foo\" PUT /_security/api_key ... and then curl -H \"Authorization: ApiKey .... PUT /index/_doc/1 it will have a realm of native.\nIt's not a big deal, but it's inconsistent. I think we want to always use the looked-up-by in the ingest processor, maybe with a flag of lookup: true or something like that if the authenticated realm was different.", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r373930448", "createdAt": "2020-02-03T05:49:03Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessor.java", "diffHunk": "@@ -85,6 +86,39 @@ public IngestDocument execute(IngestDocument ingestDocument) throws Exception {\n                         userObject.put(\"metadata\", user.metadata());\n                     }\n                     break;\n+                case API_KEY:\n+                    final HashMap<String, Object> apiKey = new HashMap<>();\n+                    Object apiKeyName = authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY);\n+                    if (apiKeyName != null) {\n+                        apiKey.put(\"name\", apiKeyName);\n+                    }\n+                    Object apiKeyId = authentication.getMetadata().get(ApiKeyService.API_KEY_ID_KEY);\n+                    if (apiKeyId != null) {\n+                        apiKey.put(\"id\", apiKeyId);\n+                    }\n+                    if (false == apiKey.isEmpty()) {\n+                        userObject.put(\"api_key\", apiKey);\n+                    }\n+                    break;\n+                case REALM:\n+                    final Object realmName = ApiKeyService.getCreatorRealmName(authentication);\n+                    final Object realmType = ApiKeyService.getCreatorRealmType(authentication);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d508a30aeba0d7c556fe20eec031330dfc90202"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "919edb129e543a0eb7248de541ac7d1f5ccb4ae7", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/919edb129e543a0eb7248de541ac7d1f5ccb4ae7", "committedDate": "2020-02-03T06:06:17Z", "message": "Merge remote-tracking branch 'origin/master' into es-49106-apikey-name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f7ca68e7d893f71554e685028ff29246d294d6f", "committedDate": "2020-02-03T13:14:30Z", "message": "Address feedback by Tim"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzI0MjUx", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-353324251", "createdAt": "2020-02-04T21:45:50Z", "commit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMTo0NTo1MFrOFlkkQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMTo0NTo1MFrOFlkkQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk0MDczNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            from which the API key is created.\n          \n          \n            \n            from which the API key is created.\n          \n          \n            \n            The valid values for the `authentication_type` property are: `REALM`, `API_KEY`, `TOKEN` and `ANONYMOUS`.", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r374940737", "createdAt": "2020-02-04T21:45:50Z", "author": {"login": "albertzaharovits"}, "path": "docs/reference/ingest/processors/set-security-user.asciidoc", "diffHunk": "@@ -1,18 +1,23 @@\n [[ingest-node-set-security-user-processor]]\n === Set Security User Processor\n-Sets user-related details (such as `username`,  `roles`, `email`, `full_name`\n-and `metadata` ) from the current\n+Sets user-related details (such as `username`,  `roles`, `email`, `full_name`,\n+`metadata`, `api_key`, `realm` and `authentication_type`) from the current\n authenticated user to the current document by pre-processing the ingest.\n+The `api_key` property is only applicable when the authentication is\n+through API key. It is an object containing two fields, `id` and `name`.\n+The `realm` property is also an object with two fields, `name` and `type`.\n+When using API key authentication, the `realm` property refers to the realm\n+from which the API key is created.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzI2NjA5", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-353326609", "createdAt": "2020-02-04T21:49:54Z", "commit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMTo0OTo1NFrOFlkrbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMTo0OTo1NFrOFlkrbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk0MjU3NQ==", "bodyText": "Rephrase suggestion:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The `api_key` property is only applicable when the authentication is\n          \n          \n            \n            through API key. It is an object containing two fields, `id` and `name`.\n          \n          \n            \n            The `api_key` property exists only if the user authenticated with an API key.\n          \n          \n            \n            It is an object containing the `id` and `name` properties of the API key.", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r374942575", "createdAt": "2020-02-04T21:49:54Z", "author": {"login": "albertzaharovits"}, "path": "docs/reference/ingest/processors/set-security-user.asciidoc", "diffHunk": "@@ -1,18 +1,23 @@\n [[ingest-node-set-security-user-processor]]\n === Set Security User Processor\n-Sets user-related details (such as `username`,  `roles`, `email`, `full_name`\n-and `metadata` ) from the current\n+Sets user-related details (such as `username`,  `roles`, `email`, `full_name`,\n+`metadata`, `api_key`, `realm` and `authentication_type`) from the current\n authenticated user to the current document by pre-processing the ingest.\n+The `api_key` property is only applicable when the authentication is\n+through API key. It is an object containing two fields, `id` and `name`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzI3NjU1", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-353327655", "createdAt": "2020-02-04T21:51:39Z", "commit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMTo1MTozOVrOFlkumw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMTo1MTozOVrOFlkumw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk0MzM4Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public RealmRef getNominalRealm() {\n          \n          \n            \n                public RealmRef getRealm() {", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r374943387", "createdAt": "2020-02-04T21:51:39Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/Authentication.java", "diffHunk": "@@ -76,6 +76,10 @@ public RealmRef getLookedUpBy() {\n         return lookedUpBy;\n     }\n \n+    public RealmRef getNominalRealm() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzM2Mzk0", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-353336394", "createdAt": "2020-02-04T22:06:55Z", "commit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDc3NDgw", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-353477480", "createdAt": "2020-02-05T05:43:40Z", "commit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNTo0Mzo0MFrOFlsX4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNTo0Mzo0MFrOFlsX4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA2ODY0MA==", "bodyText": "I think we need to really consider whether this is the change we want.\nIt's a fairly fundamental change to the ApiKey service, and it affects how the manage_own_api_key privilege would work.\nIt might be right, I'd need to think about it, but if it is, then we might consider it a breaking change.", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r375068640", "createdAt": "2020-02-05T05:43:40Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/ApiKeyService.java", "diffHunk": "@@ -886,7 +884,7 @@ public static String getCreatorRealmName(final Authentication authentication) {\n         if (authentication.getAuthenticatedBy().getType().equals(API_KEY_REALM_TYPE)) {\n             return (String) authentication.getMetadata().get(API_KEY_CREATOR_REALM_NAME);\n         } else {\n-            return authentication.getAuthenticatedBy().getName();\n+            return authentication.getNominalRealm().getName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f7ca68e7d893f71554e685028ff29246d294d6f"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac2efffad7f59c81d22f94ab2eda413071f80966", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/ac2efffad7f59c81d22f94ab2eda413071f80966", "committedDate": "2020-02-05T07:00:52Z", "message": "Address feedbacks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d488471a5ea29af0f6706a1c5b26f3e8b87044d5", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/d488471a5ea29af0f6706a1c5b26f3e8b87044d5", "committedDate": "2020-02-05T07:19:30Z", "message": "Merge remote-tracking branch 'origin/master' into es-49106-apikey-name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc63be71d0c2a53dbc800d76ff7b206fb60594a3", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc63be71d0c2a53dbc800d76ff7b206fb60594a3", "committedDate": "2020-02-06T03:33:50Z", "message": "Revert the logic of getCreatorRealm for backwards compatibility"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NTY4Mjc3", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-354568277", "createdAt": "2020-02-06T16:00:45Z", "commit": {"oid": "cc63be71d0c2a53dbc800d76ff7b206fb60594a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNjowMDo0NVrOFmgkvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNjowMDo0NVrOFmgkvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkyMzkwMg==", "bodyText": "In case you authenticate without an API Key, this gets you the authentication realm, although it should get the lookup realm, otherwise the set security user processor won't work as expected for run-as users.", "url": "https://github.com/elastic/elasticsearch/pull/51305#discussion_r375923902", "createdAt": "2020-02-06T16:00:45Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessor.java", "diffHunk": "@@ -85,6 +86,47 @@ public IngestDocument execute(IngestDocument ingestDocument) throws Exception {\n                         userObject.put(\"metadata\", user.metadata());\n                     }\n                     break;\n+                case API_KEY:\n+                    final String apiKey = \"api_key\";\n+                    final Object existingApiKeyField = userObject.get(apiKey);\n+                    @SuppressWarnings(\"unchecked\")\n+                    final Map<String, Object> apiKeyField =\n+                        existingApiKeyField instanceof Map ? (Map<String, Object>) existingApiKeyField : new HashMap<>();\n+                    Object apiKeyName = authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY);\n+                    if (apiKeyName != null) {\n+                        apiKeyField.put(\"name\", apiKeyName);\n+                    }\n+                    Object apiKeyId = authentication.getMetadata().get(ApiKeyService.API_KEY_ID_KEY);\n+                    if (apiKeyId != null) {\n+                        apiKeyField.put(\"id\", apiKeyId);\n+                    }\n+                    if (false == apiKeyField.isEmpty()) {\n+                        userObject.put(apiKey, apiKeyField);\n+                    }\n+                    break;\n+                case REALM:\n+                    final String realmKey = \"realm\";\n+                    final Object existingRealmField = userObject.get(realmKey);\n+                    @SuppressWarnings(\"unchecked\")\n+                    final Map<String, Object> realmField =\n+                        existingRealmField instanceof Map ? (Map<String, Object>) existingRealmField : new HashMap<>();\n+                    final Object realmName = ApiKeyService.getCreatorRealmName(authentication);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc63be71d0c2a53dbc800d76ff7b206fb60594a3"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7af393b9a215da3d0448777320cd5c4230034bb", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7af393b9a215da3d0448777320cd5c4230034bb", "committedDate": "2020-02-06T23:07:16Z", "message": "Address feedback to set lookedup realm for non-api auth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e1d8014c7d17bbefef9688ebe608d2e99cc9ca8", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/1e1d8014c7d17bbefef9688ebe608d2e99cc9ca8", "committedDate": "2020-02-07T00:13:01Z", "message": "Merge remote-tracking branch 'origin/master' into es-49106-apikey-name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44a77d3ad3704e948e98504ee260a6993b9be87c", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/44a77d3ad3704e948e98504ee260a6993b9be87c", "committedDate": "2020-02-08T14:18:41Z", "message": "Merge remote-tracking branch 'origin/master' into es-49106-apikey-name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NjUyNjM3", "url": "https://github.com/elastic/elasticsearch/pull/51305#pullrequestreview-355652637", "createdAt": "2020-02-10T01:05:07Z", "commit": {"oid": "44a77d3ad3704e948e98504ee260a6993b9be87c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2851, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}