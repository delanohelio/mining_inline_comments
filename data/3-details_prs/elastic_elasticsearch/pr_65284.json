{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MjAyNTAz", "number": 65284, "title": "Refactor deprecation plugin for easier extensibility", "bodyText": "This refactor for the deprecation plugin makes extending and adding more plugin settings deprecation checks simpler.", "createdAt": "2020-11-19T20:10:56Z", "url": "https://github.com/elastic/elasticsearch/pull/65284", "merged": true, "mergeCommit": {"oid": "d4d56cb5ffca1fc6f11e616ae54f4391333ea863"}, "closed": true, "closedAt": "2020-12-07T18:29:02Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeIdlVgH2gAyNTI0MjAyNTAzOmI5YWY3YTliYTNlYzY4OTFkM2ViNjNhMGVhNzVlNzE2ODQ3Y2QxOWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj4HGAgH2gAyNTI0MjAyNTAzOjUyNDFjNzBmMzc1YWIwOGUzNWE0MmUwMjZmYWQ5ZTgwOTAzYzY1ZjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b9af7a9ba3ec6891d3eb63a0ea75e716847cd19b", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9af7a9ba3ec6891d3eb63a0ea75e716847cd19b", "committedDate": "2020-11-19T20:06:31Z", "message": "Refactor deprecation plugin for easier extensibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb0eeb715f8d8c69923f9ae4b1ddba9f278a3b89", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/eb0eeb715f8d8c69923f9ae4b1ddba9f278a3b89", "committedDate": "2020-11-19T20:18:10Z", "message": "fixing style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fd6bb0f03ddd58f80321f0abae6c1a6553bb235", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/4fd6bb0f03ddd58f80321f0abae6c1a6553bb235", "committedDate": "2020-11-19T20:25:18Z", "message": "fixing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/6847af5e5b8293f7aea7926f2d58e2f3b24d62cf", "committedDate": "2020-11-30T16:12:37Z", "message": "Merge branch 'master' into feature/deprecation-plugin-refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzQzOTQz", "url": "https://github.com/elastic/elasticsearch/pull/65284#pullrequestreview-541343943", "createdAt": "2020-11-30T22:24:11Z", "commit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMjoyNDoxMVrOH8QQCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwMDoxNDoxOFrOH8S_Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0Mjg1OQ==", "bodyText": "I think we should verify that this map doesn't have keys that would conflict with cluster/node/index settings, given it's plumbed into the XContent via mapContents later.", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r532942859", "createdAt": "2020-11-30T22:24:11Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/deprecation/DeprecationInfoAction.java", "diffHunk": "@@ -81,24 +80,30 @@ private DeprecationInfoAction() {\n         private List<DeprecationIssue> clusterSettingsIssues;\n         private List<DeprecationIssue> nodeSettingsIssues;\n         private Map<String, List<DeprecationIssue>> indexSettingsIssues;\n-        private List<DeprecationIssue> mlSettingsIssues;\n+        private Map<String, List<DeprecationIssue>> pluginSettingsIssues;\n \n         public Response(StreamInput in) throws IOException {\n             super(in);\n             clusterSettingsIssues = in.readList(DeprecationIssue::new);\n             nodeSettingsIssues = in.readList(DeprecationIssue::new);\n             indexSettingsIssues = in.readMapOfLists(StreamInput::readString, DeprecationIssue::new);\n-            mlSettingsIssues = in.readList(DeprecationIssue::new);\n+            if (in.getVersion().before(Version.V_7_11_0)) {\n+                List<DeprecationIssue> mlIssues = in.readList(DeprecationIssue::new);\n+                pluginSettingsIssues = new HashMap<>();\n+                pluginSettingsIssues.put(\"ml_settings\", mlIssues);\n+            } else {\n+                pluginSettingsIssues = in.readMapOfLists(StreamInput::readString, DeprecationIssue::new);\n+            }\n         }\n \n         public Response(List<DeprecationIssue> clusterSettingsIssues,\n                         List<DeprecationIssue> nodeSettingsIssues,\n                         Map<String, List<DeprecationIssue>> indexSettingsIssues,\n-                        List<DeprecationIssue> mlSettingsIssues) {\n+                        Map<String, List<DeprecationIssue>> pluginSettingsIssues) {\n             this.clusterSettingsIssues = clusterSettingsIssues;\n             this.nodeSettingsIssues = nodeSettingsIssues;\n             this.indexSettingsIssues = indexSettingsIssues;\n-            this.mlSettingsIssues = mlSettingsIssues;\n+            this.pluginSettingsIssues = pluginSettingsIssues;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0NDI3MQ==", "bodyText": "Can we move the Version.V_7_11_0 to a constant? I find doing so makes the code clearer and less error-prone if we have to change the version on backport or similar.", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r532944271", "createdAt": "2020-11-30T22:27:17Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/deprecation/DeprecationInfoAction.java", "diffHunk": "@@ -81,24 +80,30 @@ private DeprecationInfoAction() {\n         private List<DeprecationIssue> clusterSettingsIssues;\n         private List<DeprecationIssue> nodeSettingsIssues;\n         private Map<String, List<DeprecationIssue>> indexSettingsIssues;\n-        private List<DeprecationIssue> mlSettingsIssues;\n+        private Map<String, List<DeprecationIssue>> pluginSettingsIssues;\n \n         public Response(StreamInput in) throws IOException {\n             super(in);\n             clusterSettingsIssues = in.readList(DeprecationIssue::new);\n             nodeSettingsIssues = in.readList(DeprecationIssue::new);\n             indexSettingsIssues = in.readMapOfLists(StreamInput::readString, DeprecationIssue::new);\n-            mlSettingsIssues = in.readList(DeprecationIssue::new);\n+            if (in.getVersion().before(Version.V_7_11_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk1NTE0OQ==", "bodyText": "Why make Components an interface? Unless I'm missing something, there's not really multiple ways to implement this interface, it's basically just a POJO - why not break the StandardComponents class out into its own file and just use that directly?", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r532955149", "createdAt": "2020-11-30T22:51:12Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/DeprecationChecker.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.xpack.core.deprecation.DeprecationIssue;\n+\n+import java.util.List;\n+\n+public interface DeprecationChecker {\n+\n+    interface Components {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4MDI0NA==", "bodyText": "It's very possible I've overlooked something, but couldn't this be done by building a chain of ListenableFutures in advance and only starting the first one here, which would reuse that well-tested common code for the concurrency bits, and also avoid the case where tasks can be modified while execution is in flight?\n(that case never comes up in this code as-written, but it could if this class is reused elsewhere - the lock is not held while waiting for the submitted AbstractRunnable to be executed by executionService)", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r532980244", "createdAt": "2020-11-30T23:53:09Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/TransportDeprecationInfoAction.java", "diffHunk": "@@ -106,15 +110,116 @@ protected final void masterOperation(Task task, final DeprecationInfoAction.Requ\n         }\n     }\n \n-    private void getDatafeedConfigs(ActionListener<List<DatafeedConfig>> listener) {\n-        if (XPackSettings.MACHINE_LEARNING_ENABLED.get(settings) == false) {\n-            listener.onResponse(Collections.emptyList());\n-        } else {\n-            ClientHelper.executeAsyncWithOrigin(client, ClientHelper.DEPRECATION_ORIGIN, GetDatafeedsAction.INSTANCE,\n-                    new GetDatafeedsAction.Request(GetDatafeedsAction.ALL), ActionListener.wrap(\n-                            datafeedsResponse -> listener.onResponse(datafeedsResponse.getResponse().results()),\n-                            listener::onFailure\n-                    ));\n+    static void pluginSettingIssues(List<DeprecationChecker> checkers,\n+                                    ExecutorService executorService,\n+                                    DeprecationChecker.Components components,\n+                                    ActionListener<Map<String, List<DeprecationIssue>>> listener) {\n+        NamedChainedExecutor<List<DeprecationIssue>> namedChainedExecutor = new NamedChainedExecutor<>(executorService);\n+        for (DeprecationChecker checker : checkers) {\n+            if (checker.enabled(components.settings())) {\n+                namedChainedExecutor.add(new NamedChainedExecutor.ChainTask<>() {\n+                    @Override\n+                    public void run(ActionListener<List<DeprecationIssue>> listener) {\n+                        checker.check(components, listener);\n+                    }\n+\n+                    @Override\n+                    public String name() {\n+                        return checker.getName();\n+                    }\n+                });\n+            }\n+        }\n+        namedChainedExecutor.execute(listener);\n+    }\n+\n+    static class StandardComponents implements DeprecationChecker.Components {\n+\n+        private final NamedXContentRegistry xContentRegistry;\n+        private final Settings settings;\n+        private final Client client;\n+\n+        StandardComponents(NamedXContentRegistry xContentRegistry, Settings settings, Client client) {\n+            this.xContentRegistry = xContentRegistry;\n+            this.settings = settings;\n+            this.client = client;\n+        }\n+\n+        @Override\n+        public NamedXContentRegistry xContentRegistry() {\n+            return xContentRegistry;\n+        }\n+\n+        @Override\n+        public Settings settings() {\n+            return settings;\n+        }\n+\n+        @Override\n+        public Client client() {\n+            return client;\n+        }\n+    }\n+\n+    static class NamedChainedExecutor<T> {\n+        public interface ChainTask<T> {\n+            void run(ActionListener<T> listener);\n+\n+            String name();\n+        }\n+\n+        private final ExecutorService executorService;\n+        private final LinkedList<ChainTask<T>> tasks = new LinkedList<>();\n+        private final Map<String, T> collectedResponses;\n+\n+        /**\n+         * Creates a new NamedChainedExecutor.\n+         * Each chainedTask is executed in order serially\n+         * @param executorService The service where to execute the tasks\n+         */\n+        NamedChainedExecutor(ExecutorService executorService) {\n+            this.executorService = Objects.requireNonNull(executorService);\n+            this.collectedResponses = new HashMap<>();\n+        }\n+\n+        public synchronized void add(ChainTask<T> task) {\n+            tasks.add(task);\n+        }\n+\n+        private synchronized void execute(String previousName, T previousValue, ActionListener<Map<String, T>> listener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4MjQ1MQ==", "bodyText": "Do we expect to have multiple implementations of this? If not, why is it an interface and not just a class?\nGoing a step further, if we don't expect to add more fields in the future, we could really simplify down and make tasks a LinkedHashMap<String, Consumer<ActionListener<T>>> and eliminate this interface/class entirely.", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r532982451", "createdAt": "2020-11-30T23:59:27Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/TransportDeprecationInfoAction.java", "diffHunk": "@@ -106,15 +110,116 @@ protected final void masterOperation(Task task, final DeprecationInfoAction.Requ\n         }\n     }\n \n-    private void getDatafeedConfigs(ActionListener<List<DatafeedConfig>> listener) {\n-        if (XPackSettings.MACHINE_LEARNING_ENABLED.get(settings) == false) {\n-            listener.onResponse(Collections.emptyList());\n-        } else {\n-            ClientHelper.executeAsyncWithOrigin(client, ClientHelper.DEPRECATION_ORIGIN, GetDatafeedsAction.INSTANCE,\n-                    new GetDatafeedsAction.Request(GetDatafeedsAction.ALL), ActionListener.wrap(\n-                            datafeedsResponse -> listener.onResponse(datafeedsResponse.getResponse().results()),\n-                            listener::onFailure\n-                    ));\n+    static void pluginSettingIssues(List<DeprecationChecker> checkers,\n+                                    ExecutorService executorService,\n+                                    DeprecationChecker.Components components,\n+                                    ActionListener<Map<String, List<DeprecationIssue>>> listener) {\n+        NamedChainedExecutor<List<DeprecationIssue>> namedChainedExecutor = new NamedChainedExecutor<>(executorService);\n+        for (DeprecationChecker checker : checkers) {\n+            if (checker.enabled(components.settings())) {\n+                namedChainedExecutor.add(new NamedChainedExecutor.ChainTask<>() {\n+                    @Override\n+                    public void run(ActionListener<List<DeprecationIssue>> listener) {\n+                        checker.check(components, listener);\n+                    }\n+\n+                    @Override\n+                    public String name() {\n+                        return checker.getName();\n+                    }\n+                });\n+            }\n+        }\n+        namedChainedExecutor.execute(listener);\n+    }\n+\n+    static class StandardComponents implements DeprecationChecker.Components {\n+\n+        private final NamedXContentRegistry xContentRegistry;\n+        private final Settings settings;\n+        private final Client client;\n+\n+        StandardComponents(NamedXContentRegistry xContentRegistry, Settings settings, Client client) {\n+            this.xContentRegistry = xContentRegistry;\n+            this.settings = settings;\n+            this.client = client;\n+        }\n+\n+        @Override\n+        public NamedXContentRegistry xContentRegistry() {\n+            return xContentRegistry;\n+        }\n+\n+        @Override\n+        public Settings settings() {\n+            return settings;\n+        }\n+\n+        @Override\n+        public Client client() {\n+            return client;\n+        }\n+    }\n+\n+    static class NamedChainedExecutor<T> {\n+        public interface ChainTask<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4MzEyNg==", "bodyText": "Testing this code path would be nice for completeness, especially if we add some validation logic to the plugin issues keys.", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r532983126", "createdAt": "2020-12-01T00:01:18Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/deprecation/DeprecationInfoActionResponseTests.java", "diffHunk": "@@ -101,9 +100,13 @@ public void testFrom() throws IOException {\n             emptyList());\n \n         DeprecationInfoAction.Request request = new DeprecationInfoAction.Request(Strings.EMPTY_ARRAY);\n-        DeprecationInfoAction.Response response = DeprecationInfoAction.Response.from(state, NamedXContentRegistry.EMPTY,\n-            resolver, request, datafeeds,\n-            nodeDeprecationIssues, indexSettingsChecks, clusterSettingsChecks, mlSettingsChecks);\n+        DeprecationInfoAction.Response response = DeprecationInfoAction.Response.from(state,\n+            resolver,\n+            request,\n+            nodeDeprecationIssues,\n+            indexSettingsChecks,\n+            clusterSettingsChecks,\n+            Collections.emptyMap());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4NTY5OA==", "bodyText": "Is there a benefit to mocking here over just doing new StandardComponents(null, Settings.EMPTY, null)? I'm not against mocks in general, but I prefer to use them as sparingly as possible, especially when it seems easy to avoid them.", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r532985698", "createdAt": "2020-12-01T00:08:31Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/deprecation/src/test/java/org/elasticsearch/xpack/deprecation/TransportDeprecationInfoActionTests.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.PlainActionFuture;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.threadpool.TestThreadPool;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.xpack.core.deprecation.DeprecationIssue;\n+import org.junit.After;\n+import org.junit.Before;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.empty;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class TransportDeprecationInfoActionTests extends ESTestCase {\n+\n+    private ThreadPool threadPool;\n+\n+    @Before\n+    public void startThreadPool() {\n+        threadPool = new TestThreadPool(\"TransportDeprecationInfoActionTests\");\n+    }\n+\n+    @After\n+    public void stopThreadPool() throws InterruptedException {\n+        terminate(threadPool);\n+    }\n+\n+    public void testPluginSettingIssues() {\n+        DeprecationChecker.Components components = mock(DeprecationChecker.Components.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4NzcxOA==", "bodyText": "I see why you did it this way - it allows us to make this change without breaking the API response format - but I think it would be worth coordinating with the ES UI team to see what would work best for them, as I believe currently any new keys here will just be ignored by the UI. This API is consumed most commonly through the UI, so it would definitely be nice if it could pick up any new plugin issue categories automatically.", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r532987718", "createdAt": "2020-12-01T00:14:18Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/deprecation/DeprecationInfoAction.java", "diffHunk": "@@ -132,7 +141,7 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n                 .array(\"node_settings\", nodeSettingsIssues.toArray())\n                 .field(\"index_settings\")\n                 .map(indexSettingsIssues)\n-                .array(\"ml_settings\", mlSettingsIssues.toArray())\n+                .mapContents(pluginSettingsIssues)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6847af5e5b8293f7aea7926f2d58e2f3b24d62cf"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db857d9aef0ab267dcbe690534428346fc28f412", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/db857d9aef0ab267dcbe690534428346fc28f412", "committedDate": "2020-12-01T18:20:46Z", "message": "checking for duplicate keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f768043b4207395c9fb78aeb2d8c485cbd2dc2d", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f768043b4207395c9fb78aeb2d8c485cbd2dc2d", "committedDate": "2020-12-01T20:02:26Z", "message": "refactoring to use grouped listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02c745abc31013223de598885e00a621607944c9", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/02c745abc31013223de598885e00a621607944c9", "committedDate": "2020-12-01T20:02:35Z", "message": "Merge branch 'feature/deprecation-plugin-refactor' of github.com:benwtrent/elasticsearch into feature/deprecation-plugin-refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzMyMDUz", "url": "https://github.com/elastic/elasticsearch/pull/65284#pullrequestreview-545332053", "createdAt": "2020-12-04T22:10:30Z", "commit": {"oid": "02c745abc31013223de598885e00a621607944c9"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMjoxMDozMVrOH_kEOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMjoyMzo0MFrOH_ka-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxMzI0Mw==", "bodyText": "Index names are nested under the index_settings key, so we don't need to include them in this check.", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r536413243", "createdAt": "2020-12-04T22:10:31Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/deprecation/DeprecationInfoAction.java", "diffHunk": "@@ -78,27 +81,44 @@ private DeprecationInfoAction() {\n     }\n \n     public static class Response extends ActionResponse implements ToXContentObject {\n+        private static final Set<String> RESERVED_NAMES = Sets.newHashSet(\"cluster_settings\", \"node_settings\");\n         private List<DeprecationIssue> clusterSettingsIssues;\n         private List<DeprecationIssue> nodeSettingsIssues;\n         private Map<String, List<DeprecationIssue>> indexSettingsIssues;\n-        private List<DeprecationIssue> mlSettingsIssues;\n+        private Map<String, List<DeprecationIssue>> pluginSettingsIssues;\n \n         public Response(StreamInput in) throws IOException {\n             super(in);\n             clusterSettingsIssues = in.readList(DeprecationIssue::new);\n             nodeSettingsIssues = in.readList(DeprecationIssue::new);\n             indexSettingsIssues = in.readMapOfLists(StreamInput::readString, DeprecationIssue::new);\n-            mlSettingsIssues = in.readList(DeprecationIssue::new);\n+            if (in.getVersion().before(Version.V_7_11_0)) {\n+                List<DeprecationIssue> mlIssues = in.readList(DeprecationIssue::new);\n+                pluginSettingsIssues = new HashMap<>();\n+                pluginSettingsIssues.put(\"ml_settings\", mlIssues);\n+            } else {\n+                pluginSettingsIssues = in.readMapOfLists(StreamInput::readString, DeprecationIssue::new);\n+            }\n         }\n \n         public Response(List<DeprecationIssue> clusterSettingsIssues,\n                         List<DeprecationIssue> nodeSettingsIssues,\n                         Map<String, List<DeprecationIssue>> indexSettingsIssues,\n-                        List<DeprecationIssue> mlSettingsIssues) {\n+                        Map<String, List<DeprecationIssue>> pluginSettingsIssues) {\n             this.clusterSettingsIssues = clusterSettingsIssues;\n             this.nodeSettingsIssues = nodeSettingsIssues;\n             this.indexSettingsIssues = indexSettingsIssues;\n-            this.mlSettingsIssues = mlSettingsIssues;\n+            Set<String> reservedNames = new HashSet<>(RESERVED_NAMES);\n+            reservedNames.addAll(indexSettingsIssues.keySet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02c745abc31013223de598885e00a621607944c9"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxNjMwNA==", "bodyText": "Not necessary but a super-minor cleanup we could do is move this into the DeprecationChecker interface as a sibling of CheckResult.\n(I forgot classes could be defined inside interfaces when I said to move this to its own file. Again, feel free to disregard this)", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r536416304", "createdAt": "2020-12-04T22:17:20Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/DeprecationCheckerComponents.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation;\n+\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+\n+public class DeprecationCheckerComponents {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02c745abc31013223de598885e00a621607944c9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQxOTA2NA==", "bodyText": "Is there a good reason not to construct the Components with an OriginSettingClient, so each plugin doesn't have to do this wrapping itself?", "url": "https://github.com/elastic/elasticsearch/pull/65284#discussion_r536419064", "createdAt": "2020-12-04T22:23:40Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/MlDeprecationChecker.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.XPackSettings;\n+import org.elasticsearch.xpack.core.deprecation.DeprecationIssue;\n+import org.elasticsearch.xpack.core.ml.action.GetDatafeedsAction;\n+import org.elasticsearch.xpack.core.ml.datafeed.DatafeedConfig;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;\n+\n+public class MlDeprecationChecker implements DeprecationChecker {\n+\n+    static Optional<DeprecationIssue> checkDataFeedQuery(DatafeedConfig datafeedConfig, NamedXContentRegistry xContentRegistry) {\n+        List<String> deprecations = datafeedConfig.getQueryDeprecations(xContentRegistry);\n+        if (deprecations.isEmpty()) {\n+            return Optional.empty();\n+        } else {\n+            return Optional.of(new DeprecationIssue(DeprecationIssue.Level.WARNING,\n+                \"Datafeed [\" + datafeedConfig.getId() + \"] uses deprecated query options\",\n+                \"https://www.elastic.co/guide/en/elasticsearch/reference/master/breaking-changes-7.0.html#breaking_70_search_changes\",\n+                deprecations.toString()));\n+        }\n+    }\n+\n+    static Optional<DeprecationIssue> checkDataFeedAggregations(DatafeedConfig datafeedConfig, NamedXContentRegistry xContentRegistry) {\n+        List<String> deprecations = datafeedConfig.getAggDeprecations(xContentRegistry);\n+        if (deprecations.isEmpty()) {\n+            return Optional.empty();\n+        } else {\n+            return Optional.of(new DeprecationIssue(DeprecationIssue.Level.WARNING,\n+                \"Datafeed [\" + datafeedConfig.getId() + \"] uses deprecated aggregation options\",\n+                \"https://www.elastic.co/guide/en/elasticsearch/reference/master/breaking-changes-7.0.html\" +\n+                    \"#breaking_70_aggregations_changes\", deprecations.toString()));\n+        }\n+    }\n+\n+    @Override\n+    public boolean enabled(Settings settings) {\n+        return XPackSettings.MACHINE_LEARNING_ENABLED.get(settings);\n+    }\n+\n+    @Override\n+    public void check(DeprecationCheckerComponents components, ActionListener<CheckResult> deprecationIssueListener) {\n+        if (XPackSettings.MACHINE_LEARNING_ENABLED.get(components.settings()) == false) {\n+            deprecationIssueListener.onResponse(new CheckResult(getName(), Collections.emptyList()));\n+        }\n+        Client client = components.client();\n+        ClientHelper.executeAsyncWithOrigin(client, ClientHelper.DEPRECATION_ORIGIN, GetDatafeedsAction.INSTANCE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02c745abc31013223de598885e00a621607944c9"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a457beb4f63421067532c9082510a09824e3620a", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/a457beb4f63421067532c9082510a09824e3620a", "committedDate": "2020-12-07T15:27:52Z", "message": "addressing pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07f09e6f086d0e5d43eacb36e982fa7ee495a806", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/07f09e6f086d0e5d43eacb36e982fa7ee495a806", "committedDate": "2020-12-07T15:28:25Z", "message": "Merge branch 'master' into feature/deprecation-plugin-refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "919d21194418c4d81680d370bef9db6bb951cbe7", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/919d21194418c4d81680d370bef9db6bb951cbe7", "committedDate": "2020-12-07T16:25:44Z", "message": "fixing style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5241c70f375ab08e35a42e026fad9e80903c65f5", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/5241c70f375ab08e35a42e026fad9e80903c65f5", "committedDate": "2020-12-07T16:27:01Z", "message": "Merge branch 'feature/deprecation-plugin-refactor' of github.com:benwtrent/elasticsearch into feature/deprecation-plugin-refactor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 888, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}