{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MTgwNzY0", "number": 62960, "title": "[ML] Delete dest index and reindex if incompatible", "bodyText": "Data frame analytics results format changed in version 7.10.0.\nIf existing jobs that were not completed are restarted, it is\npossible the destination index had already been created. That index's\nmappings are not suitable for the new results format.\nThis commit checks the version of the destination index and deletes\nit when the version is outdated. The job will then continue by\nrecreating the destination index and reindexing.\nRelates #61325", "createdAt": "2020-09-28T14:24:43Z", "url": "https://github.com/elastic/elasticsearch/pull/62960", "merged": true, "mergeCommit": {"oid": "0361758f3094d5abf13c55cce74f38ed481fd110"}, "closed": true, "closedAt": "2020-09-30T08:24:20Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNUZISAH2gAyNDk0MTgwNzY0OjJjZDU4YWIwZjZkODRmNTA3MGFmZWU4ZTE1OGVmNzEyMDEyZGE0MmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN2POKgFqTQ5OTEwMDcwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2cd58ab0f6d84f5070afee8e158ef712012da42c", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/2cd58ab0f6d84f5070afee8e158ef712012da42c", "committedDate": "2020-09-28T14:23:48Z", "message": "[ML] Delete dest index and reindex if incompatible\n\nData frame analytics results format changed in version `7.10.0`.\nIf existing jobs that were not completed are restarted, it is\npossible the destination index had already been created. That index's\nmappings are not suitable for the new results format.\n\nThis commit checks the version of the destination index and deletes\nit when the version is outdated. The job will then continue by\nrecreating the destination index and reindexing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NTgyMTgz", "url": "https://github.com/elastic/elasticsearch/pull/62960#pullrequestreview-497582183", "createdAt": "2020-09-28T14:38:44Z", "commit": {"oid": "2cd58ab0f6d84f5070afee8e158ef712012da42c"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDozODo0NFrOHZA0LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDo0ODozMlrOHZBQog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4OTgwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            ImmutableOpenMap<String, MappingMetadata> mappings = indexResponse.mappings();\n          \n          \n            \n                            Map<String, Object> sourceAsMap = mappings.valuesIt().next().getSourceAsMap();\n          \n      \n    \n    \n  \n\nSeems unused?", "url": "https://github.com/elastic/elasticsearch/pull/62960#discussion_r495989804", "createdAt": "2020-09-28T14:38:44Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java", "diffHunk": "@@ -304,6 +326,8 @@ private void reindexDataframeAndStartAnalysis(DataFrameAnalyticsTask task, DataF\n         // Create destination index if it does not exist\n         ActionListener<GetIndexResponse> destIndexListener = ActionListener.wrap(\n             indexResponse -> {\n+                ImmutableOpenMap<String, MappingMetadata> mappings = indexResponse.mappings();\n+                Map<String, Object> sourceAsMap = mappings.valuesIt().next().getSourceAsMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cd58ab0f6d84f5070afee8e158ef712012da42c"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5MDU2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        logger.debug(\"[{}] Destination index version [{}]\", jobId, destIndexVersion);\n          \n          \n            \n                        logger.debug(() -> new ParameterizedMessage(\"[{}] Destination index version [{}]\", jobId, destIndexVersion));", "url": "https://github.com/elastic/elasticsearch/pull/62960#discussion_r495990560", "createdAt": "2020-09-28T14:39:48Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DestinationIndex.java", "diffHunk": "@@ -220,4 +233,24 @@ private static void checkResultsFieldIsNotPresentInProperties(DataFrameAnalytics\n                 DataFrameAnalyticsDest.RESULTS_FIELD.getPreferredName());\n         }\n     }\n+\n+    public static boolean isCompatible(String jobId, MappingMetadata mappingMetadata) {\n+        try {\n+            Version destIndexVersion = getVersion(mappingMetadata);\n+            logger.debug(\"[{}] Destination index version [{}]\", jobId, destIndexVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cd58ab0f6d84f5070afee8e158ef712012da42c"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5NzA5MA==", "bodyText": "In my opinion (loosely held) it would be good to say \"index was created in version X, but minimum supported version is version Y. Starting from scratch\" or something.", "url": "https://github.com/elastic/elasticsearch/pull/62960#discussion_r495997090", "createdAt": "2020-09-28T14:48:32Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java", "diffHunk": "@@ -90,6 +93,25 @@ public void execute(DataFrameAnalyticsTask task, DataFrameAnalyticsState current\n         // With config in hand, determine action to take\n         ActionListener<DataFrameAnalyticsConfig> configListener = ActionListener.wrap(\n             config -> {\n+                // Check if existing destination index is incompatible.\n+                // If it is, we delete it and start from reindexing.\n+                IndexMetadata destIndex = clusterState.getMetadata().index(config.getDest().getIndex());\n+                if (destIndex != null) {\n+                    MappingMetadata destIndexMapping = clusterState.getMetadata().index(config.getDest().getIndex()).mapping();\n+                    if (DestinationIndex.isCompatible(config.getId(), destIndexMapping) == false) {\n+                        LOGGER.info(\"[{}] Destination index is out of date; will delete and reindex from scratch\", config.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cd58ab0f6d84f5070afee8e158ef712012da42c"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9226fe41c67e7d552b71128e3717c637fd3deb3", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/a9226fe41c67e7d552b71128e3717c637fd3deb3", "committedDate": "2020-09-28T15:24:14Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MTE2Njk1", "url": "https://github.com/elastic/elasticsearch/pull/62960#pullrequestreview-498116695", "createdAt": "2020-09-29T05:58:22Z", "commit": {"oid": "2cd58ab0f6d84f5070afee8e158ef712012da42c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4Mjc0NjMz", "url": "https://github.com/elastic/elasticsearch/pull/62960#pullrequestreview-498274633", "createdAt": "2020-09-29T09:20:30Z", "commit": {"oid": "2cd58ab0f6d84f5070afee8e158ef712012da42c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwOToyMDozMFrOHZkHLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwOToyMDozMFrOHZkHLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU2ODEwOA==", "bodyText": "As an aside, the created version is in index settings  (GET myindex/_settings) as far as I can tell that happens automatically.\n\n  \n    \n      elasticsearch/server/src/main/java/org/elasticsearch/cluster/metadata/IndexMetadata.java\n    \n    \n         Line 386\n      in\n      0ec40a0\n    \n    \n    \n    \n\n        \n          \n           private final Version indexCreatedVersion; \n        \n    \n  \n\n\nIs there a reason to prefer this usage?", "url": "https://github.com/elastic/elasticsearch/pull/62960#discussion_r496568108", "createdAt": "2020-09-29T09:20:30Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DestinationIndex.java", "diffHunk": "@@ -164,11 +176,12 @@ private static Integer findMaxSettingValue(GetSettingsResponse settingsResponse,\n         return properties;\n     }\n \n-    private static Map<String, Object> createMetadata(String analyticsId, Clock clock) {\n+    // Visible for testing\n+    static Map<String, Object> createMetadata(String analyticsId, Clock clock, Version version) {\n         Map<String, Object> metadata = new HashMap<>();\n         metadata.put(CREATION_DATE_MILLIS, clock.millis());\n         metadata.put(CREATED_BY, \"data-frame-analytics\");\n-        metadata.put(VERSION, Map.of(CREATED, Version.CURRENT));\n+        metadata.put(VERSION, Map.of(CREATED, version.toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cd58ab0f6d84f5070afee8e158ef712012da42c"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5ab73f3834795c3133d67ef092a6bfe7ac32982", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/d5ab73f3834795c3133d67ef092a6bfe7ac32982", "committedDate": "2020-09-29T10:18:33Z", "message": "Rework to ensure we don't delete a custom dest index"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MzY2MjMw", "url": "https://github.com/elastic/elasticsearch/pull/62960#pullrequestreview-498366230", "createdAt": "2020-09-29T11:22:46Z", "commit": {"oid": "d5ab73f3834795c3133d67ef092a6bfe7ac32982"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MzgzNjUy", "url": "https://github.com/elastic/elasticsearch/pull/62960#pullrequestreview-498383652", "createdAt": "2020-09-29T11:48:06Z", "commit": {"oid": "d5ab73f3834795c3133d67ef092a6bfe7ac32982"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMTo0ODowNlrOHZpRSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxMTo1MDowMFrOHZpVJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MjYxNg==", "bodyText": "Isn't interface with subclasses an overkill here?\nHow about turning Metadata into a POJO class with 2 fields: boolean hasMetadata and Version version?", "url": "https://github.com/elastic/elasticsearch/pull/62960#discussion_r496652616", "createdAt": "2020-09-29T11:48:06Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DestinationIndex.java", "diffHunk": "@@ -220,4 +235,77 @@ private static void checkResultsFieldIsNotPresentInProperties(DataFrameAnalytics\n                 DataFrameAnalyticsDest.RESULTS_FIELD.getPreferredName());\n         }\n     }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static Metadata readMetadata(String jobId, MappingMetadata mappingMetadata) {\n+        Map<String, Object> mappings = mappingMetadata.getSourceAsMap();\n+        Map<String, Object> meta = (Map<String, Object>) mappings.get(META);\n+        if (meta == null || DFA_CREATOR.equals(meta.get(CREATED_BY)) == false) {\n+            return new NoMetadata();\n+        }\n+        return new DestMetadata(getVersion(jobId, meta));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private static Version getVersion(String jobId, Map<String, Object> meta) {\n+        try {\n+            Map<String, Object> version = (Map<String, Object>) meta.get(VERSION);\n+            String createdVersionString = (String) version.get(CREATED);\n+            return Version.fromString(createdVersionString);\n+        } catch (Exception e) {\n+            logger.error(new ParameterizedMessage(\"[{}] Could not retrieve destination index version\", jobId), e);\n+            return null;\n+        }\n+    }\n+\n+    public interface Metadata {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ab73f3834795c3133d67ef092a6bfe7ac32982"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1Mjk0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (meta == null || DFA_CREATOR.equals(meta.get(CREATED_BY)) == false) {\n          \n          \n            \n                    if ((meta == null) || (DFA_CREATOR.equals(meta.get(CREATED_BY)) == false)) {", "url": "https://github.com/elastic/elasticsearch/pull/62960#discussion_r496652943", "createdAt": "2020-09-29T11:48:46Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DestinationIndex.java", "diffHunk": "@@ -220,4 +235,77 @@ private static void checkResultsFieldIsNotPresentInProperties(DataFrameAnalytics\n                 DataFrameAnalyticsDest.RESULTS_FIELD.getPreferredName());\n         }\n     }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static Metadata readMetadata(String jobId, MappingMetadata mappingMetadata) {\n+        Map<String, Object> mappings = mappingMetadata.getSourceAsMap();\n+        Map<String, Object> meta = (Map<String, Object>) mappings.get(META);\n+        if (meta == null || DFA_CREATOR.equals(meta.get(CREATED_BY)) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ab73f3834795c3133d67ef092a6bfe7ac32982"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MzYwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (metadata.hasMetadata() && metadata.isCompatible() == false) {\n          \n          \n            \n                                if (metadata.hasMetadata() && (metadata.isCompatible() == false)) {", "url": "https://github.com/elastic/elasticsearch/pull/62960#discussion_r496653607", "createdAt": "2020-09-29T11:50:00Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java", "diffHunk": "@@ -90,6 +92,28 @@ public void execute(DataFrameAnalyticsTask task, DataFrameAnalyticsState current\n         // With config in hand, determine action to take\n         ActionListener<DataFrameAnalyticsConfig> configListener = ActionListener.wrap(\n             config -> {\n+                // Check if existing destination index is incompatible.\n+                // If it is, we delete it and start from reindexing.\n+                IndexMetadata destIndex = clusterState.getMetadata().index(config.getDest().getIndex());\n+                if (destIndex != null) {\n+                    MappingMetadata destIndexMapping = clusterState.getMetadata().index(config.getDest().getIndex()).mapping();\n+                    DestinationIndex.Metadata metadata = DestinationIndex.readMetadata(config.getId(), destIndexMapping);\n+                    if (metadata.hasMetadata() && metadata.isCompatible() == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ab73f3834795c3133d67ef092a6bfe7ac32982"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b8ac35f3ef2104ce5b7f9e77d3066ff113fdcdb", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b8ac35f3ef2104ce5b7f9e77d3066ff113fdcdb", "committedDate": "2020-09-29T13:28:41Z", "message": "Update x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DestinationIndex.java\n\nCo-authored-by: Przemys\u0142aw Witek <przemyslaw.witek@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdc183ffba3c3c5e3b6eabcf8e2ca4c48306d196", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/cdc183ffba3c3c5e3b6eabcf8e2ca4c48306d196", "committedDate": "2020-09-29T13:28:48Z", "message": "Update x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java\n\nCo-authored-by: Przemys\u0142aw Witek <przemyslaw.witek@elastic.co>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MTAwNzAx", "url": "https://github.com/elastic/elasticsearch/pull/62960#pullrequestreview-499100701", "createdAt": "2020-09-30T05:49:45Z", "commit": {"oid": "cdc183ffba3c3c5e3b6eabcf8e2ca4c48306d196"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4656, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}