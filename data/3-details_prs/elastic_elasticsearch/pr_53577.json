{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4Mzk0MTg0", "number": 53577, "title": "Improve performance of shards limits decider", "bodyText": "On clusters with a large number of shards, the shards limits allocation decider can exhibit poor performance leading to timeouts applying cluster state updates. This occurs because for every shard, we do a loop to count the number of shards on the node, and the number of shards for the index of the shard. This is roughly quadratic in the number of shards. This loop is not necessary, since we already have a O(1) method to count the number of non-relocating shards on a node, and with this commit we add some infrastructure to RoutingNode to make counting the number of shards per index O(1).\nCloses #53559", "createdAt": "2020-03-14T18:31:52Z", "url": "https://github.com/elastic/elasticsearch/pull/53577", "merged": true, "mergeCommit": {"oid": "ca7a135e0892ce4ccd25635140f9c094ebe1b547"}, "closed": true, "closedAt": "2020-03-19T00:57:51Z", "author": {"login": "jasontedor"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNpPf4AH2gAyMzg4Mzk0MTg0Ojc0NTkzNTU3NzcyZWFiOWQ0Zjc1NDU2N2EyOTM2NmFhOTdhMWJjZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO9VlAAH2gAyMzg4Mzk0MTg0OjIwOTUwNGJjNTVkNTE1OTdjNDg1ODU3MTZiOWM5N2I5NDVjYTYzZjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "74593557772eab9d4f754567a29366aa97a1bcd4", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/74593557772eab9d4f754567a29366aa97a1bcd4", "committedDate": "2020-03-14T18:30:08Z", "message": "Improve performance of shards limits decider\n\nOn clusters with a large number of shards, the shards limits allocation\ndecider can exhibit poor performance leading to timeouts applying\ncluster state updates. This occurs because for every shard, we do a loop\nto count the number of shards on the node, and the number of shards for\nthe index of the shard. This is roughly quadratic in the number of\nshards. This loop is not necessary, since we already have a O(1) method\nto count the number of non-relocating shards on a node, and with this\ncommit we add some infrastructure to RoutingNode to make counting the\nnumber of shards per index O(1)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MTc4NDUz", "url": "https://github.com/elastic/elasticsearch/pull/53577#pullrequestreview-377178453", "createdAt": "2020-03-18T19:39:05Z", "commit": {"oid": "74593557772eab9d4f754567a29366aa97a1bcd4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOTozOTowNVrOF4UJHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxOTo0NzozOFrOF4UZsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5NDU4OA==", "bodyText": "Could we make this simpler by:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        shards.values().stream().collect(Collectors.groupingBy(ShardRouting::index));\n          \n          \n            \n                    assert shardsByIndex.size() == shardRoutingsByIndex.size();\n          \n          \n            \n                    assert shardsByIndex.keySet().containsAll(shardRoutingsByIndex.keySet());\n          \n          \n            \n                    assert shardsByIndex.entrySet().stream().allMatch(e -> e.getValue().size() == shardRoutingsByIndex.get(e.getKey()).size());\n          \n          \n            \n                    assert shardsByIndex.entrySet().stream().allMatch(e -> e.getValue().containsAll(shardRoutingsByIndex.get(e.getKey())));\n          \n          \n            \n                        shards.values().stream().collect(Collectors.groupingBy(ShardRouting::index, Collectors.toSet()));\n          \n          \n            \n                    assert shardRoutingsByIndex.equals(shardsByIndex);", "url": "https://github.com/elastic/elasticsearch/pull/53577#discussion_r394594588", "createdAt": "2020-03-18T19:39:05Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/routing/RoutingNode.java", "diffHunk": "@@ -316,6 +343,13 @@ private boolean invariant() {\n         assert relocatingShards.size() == shardRoutingsRelocating.size();\n         assert relocatingShards.containsAll(shardRoutingsRelocating);\n \n+        final Map<Index, List<ShardRouting>> shardRoutingsByIndex =\n+            shards.values().stream().collect(Collectors.groupingBy(ShardRouting::index));\n+        assert shardsByIndex.size() == shardRoutingsByIndex.size();\n+        assert shardsByIndex.keySet().containsAll(shardRoutingsByIndex.keySet());\n+        assert shardsByIndex.entrySet().stream().allMatch(e -> e.getValue().size() == shardRoutingsByIndex.get(e.getKey()).size());\n+        assert shardsByIndex.entrySet().stream().allMatch(e -> e.getValue().containsAll(shardRoutingsByIndex.get(e.getKey())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74593557772eab9d4f754567a29366aa97a1bcd4"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU5ODgzNA==", "bodyText": "nit: missing space\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        TestShardRouting.newShardRouting(\"test2\", 0, \"node-1\", \"node-2\",false, ShardRoutingState.RELOCATING);\n          \n          \n            \n                        TestShardRouting.newShardRouting(\"test2\", 0, \"node-1\", \"node-2\", false, ShardRoutingState.RELOCATING);", "url": "https://github.com/elastic/elasticsearch/pull/53577#discussion_r394598834", "createdAt": "2020-03-18T19:47:38Z", "author": {"login": "henningandersen"}, "path": "server/src/test/java/org/elasticsearch/cluster/routing/RoutingNodeTests.java", "diffHunk": "@@ -115,4 +116,17 @@ public void testNumberOfOwningShards() {\n         assertThat(routingNode.numberOfOwningShards(), equalTo(2));\n     }\n \n+    public void testNumberOfOwningShardsForIndex() {\n+        final ShardRouting test1Shard0 =\n+            TestShardRouting.newShardRouting(\"test1\", 0, \"node-1\", false, ShardRoutingState.STARTED);\n+        final ShardRouting test2Shard0 =\n+            TestShardRouting.newShardRouting(\"test2\", 0, \"node-1\", \"node-2\",false, ShardRoutingState.RELOCATING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74593557772eab9d4f754567a29366aa97a1bcd4"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1a1cd184705f0cb076657d6794f96761900d616", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/f1a1cd184705f0cb076657d6794f96761900d616", "committedDate": "2020-03-18T20:15:12Z", "message": "Update server/src/main/java/org/elasticsearch/cluster/routing/RoutingNode.java\n\nCo-Authored-By: Henning Andersen <33268011+henningandersen@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08c989428d54bc85eb691a2849bd90a61fd8b1c8", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/08c989428d54bc85eb691a2849bd90a61fd8b1c8", "committedDate": "2020-03-18T20:15:19Z", "message": "Update server/src/test/java/org/elasticsearch/cluster/routing/RoutingNodeTests.java\n\nCo-Authored-By: Henning Andersen <33268011+henningandersen@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92507c0b55127d17a52c86025f7e5e26720f109a", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/92507c0b55127d17a52c86025f7e5e26720f109a", "committedDate": "2020-03-18T20:18:47Z", "message": "Merge branch 'master' into shard-limits-allocation-decider-performance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "209504bc55d51597c48585716b9c97b945ca63f4", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/209504bc55d51597c48585716b9c97b945ca63f4", "committedDate": "2020-03-18T20:28:48Z", "message": "Fix compilation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1422, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}