{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNzE2NzU2", "number": 50987, "title": "Fix Infinite Retry Loop in loading RepositoryData", "bodyText": "We were running into an infinite loop when trying to load corrupted (or otherwise un-loadable)\nrepository data for a repo that uses best effort consistency (e.g. that was just freshly mounted\nas done in the test) because we kepy resetting to -1 on IOException, listing and finding the broken\ngeneration N and then interpreted the subsequent reset to -1 as a concurrent change to the repository.\nNon issue because this hasn't been released yet but serious issue otherwise.\nWithout this fix, any issue that leads to an index-N being listed but not readable results in an infinite retry loop when loading repository data.\ncc @albertzaharovits", "createdAt": "2020-01-14T16:09:20Z", "url": "https://github.com/elastic/elasticsearch/pull/50987", "merged": true, "mergeCommit": {"oid": "15a9fcd5ebec513a9a5b0dfb2b7ddec3dd683d3d"}, "closed": true, "closedAt": "2020-01-16T11:22:33Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6TN9lgH2gAyMzYyNzE2NzU2OjQyNTI1Mzg2OGIwMTU5ZjllNTY5MWY4ODNmMDkwYWFlMmY3MTE1ZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb61RzWgFqTM0MzcyMTgwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "425253868b0159f9e5691f883f090aae2f7115e0", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/425253868b0159f9e5691f883f090aae2f7115e0", "committedDate": "2020-01-14T16:05:59Z", "message": "Fix Infinite Retry Loop in loading RepositoryData\n\nWe were running into an infinite loop when trying to load corrupted (or otherwise un-loadable)\nrepository data for a repo that uses best effort consistency (e.g. that was just freshly mounted\nas done in the test) because we kepy resetting to `-1` on `IOException`, listing and finding the broken\ngeneration `N` and then interpreted the subsequent reset to `-1` as a concurrent change to the repository."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjUyOTM5", "url": "https://github.com/elastic/elasticsearch/pull/50987#pullrequestreview-342652939", "createdAt": "2020-01-14T16:11:21Z", "commit": {"oid": "425253868b0159f9e5691f883f090aae2f7115e0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoxMToyMVrOFddGqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoxMToyMVrOFddGqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyOTg2Ng==", "bodyText": "Fixed these spots because a.) it's just the right thing to not mix listener and throwing :) but also so that the exception properly bubbles up the listener chain in the test infrastructure that has to run this method off the test thread (because we assert that it only runs on the generic or snapshot pool)", "url": "https://github.com/elastic/elasticsearch/pull/50987#discussion_r366429866", "createdAt": "2020-01-14T16:11:21Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1058,7 +1061,9 @@ public void getRepositoryData(ActionListener<RepositoryData> listener) {\n                 try {\n                     generation = latestIndexBlobId();\n                 } catch (IOException ioe) {\n-                    throw new RepositoryException(metadata.name(), \"Could not determine repository generation from root blobs\", ioe);\n+                    listener.onFailure(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "425253868b0159f9e5691f883f090aae2f7115e0"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48c979b6912c052c447cffd2ac0f37d1236a13c7", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/48c979b6912c052c447cffd2ac0f37d1236a13c7", "committedDate": "2020-01-14T16:22:17Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-broken-repo-retry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bca82f4e29f22d7f3d1827c8808b381d0d8bb3f2", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/bca82f4e29f22d7f3d1827c8808b381d0d8bb3f2", "committedDate": "2020-01-14T16:35:43Z", "message": "add logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzIxODA3", "url": "https://github.com/elastic/elasticsearch/pull/50987#pullrequestreview-343721807", "createdAt": "2020-01-16T07:46:57Z", "commit": {"oid": "bca82f4e29f22d7f3d1827c8808b381d0d8bb3f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3065, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}