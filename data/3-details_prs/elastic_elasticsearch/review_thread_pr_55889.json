{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMzE3ODM3", "number": 55889, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMDoyMDoxM1rOD3XW8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMTowMTo0N1rOD3YQsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MzgwOTc4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldTypeLookup.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMDoyMDoxM1rOGNlV3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNjoyNTowMVrOGOG6Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg5NjQ3OA==", "bodyText": "I think you can set up copy_to the same field multiple times. I imagine this won't perfectly emulate that. But that is almost certainly ok.", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r416896478", "createdAt": "2020-04-28T20:20:13Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldTypeLookup.java", "diffHunk": "@@ -80,6 +94,17 @@ public FieldTypeLookup copyAndAddAll(Collection<FieldMapper> fieldMappers,\n             if (fieldMapper instanceof DynamicKeyFieldMapper) {\n                 dynamicKeyMappers.put(fieldName, (DynamicKeyFieldMapper) fieldMapper);\n             }\n+\n+            for (String targetField : fieldMapper.copyTo().copyToFields()) {\n+                Set<String> sourcePath = sourcePaths.get(targetField);\n+                if (sourcePath == null) {\n+                    sourcePaths = sourcePaths.copyAndPut(targetField, Set.of(targetField, fieldName));\n+                } else if (sourcePath.contains(fieldName) == false) {\n+                    Set<String> newSourcePath = new HashSet<>(sourcePath);\n+                    newSourcePath.add(fieldName);\n+                    sourcePaths = sourcePaths.copyAndPut(targetField, Collections.unmodifiableSet(newSourcePath));\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4339bfd9a86f8f2b61892f2ba07e36238022d6fc"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0NjQ0Ng==", "bodyText": "\ud83d\udc4d I also think it's okay not to emulate that.", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r417446446", "createdAt": "2020-04-29T16:25:01Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldTypeLookup.java", "diffHunk": "@@ -80,6 +94,17 @@ public FieldTypeLookup copyAndAddAll(Collection<FieldMapper> fieldMappers,\n             if (fieldMapper instanceof DynamicKeyFieldMapper) {\n                 dynamicKeyMappers.put(fieldName, (DynamicKeyFieldMapper) fieldMapper);\n             }\n+\n+            for (String targetField : fieldMapper.copyTo().copyToFields()) {\n+                Set<String> sourcePath = sourcePaths.get(targetField);\n+                if (sourcePath == null) {\n+                    sourcePaths = sourcePaths.copyAndPut(targetField, Set.of(targetField, fieldName));\n+                } else if (sourcePath.contains(fieldName) == false) {\n+                    Set<String> newSourcePath = new HashSet<>(sourcePath);\n+                    newSourcePath.add(fieldName);\n+                    sourcePaths = sourcePaths.copyAndPut(targetField, Collections.unmodifiableSet(newSourcePath));\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg5NjQ3OA=="}, "originalCommit": {"oid": "4339bfd9a86f8f2b61892f2ba07e36238022d6fc"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5Mzk1NzYzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMTowMTo0N1rOGNmxXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNjoyNzo1MlrOGOHBdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxOTkwMg==", "bodyText": "I wonder if this should return something that has an extractValue(SourceLookup) method on it. I'm just thinking of types constant_keyword and the formatting stuff we talked about over video. Not that now is the time to build that, but maybe this is the place to handle it.", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r416919902", "createdAt": "2020-04-28T21:01:47Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -602,6 +602,14 @@ public MappedFieldType fieldType(String fullName) {\n         return fieldTypes.simpleMatchToFullName(pattern);\n     }\n \n+    /**\n+     * Given a field name, returns its possible paths in the _source. For example,\n+     * the 'source path' for a multi-field is the path to its parent field.\n+     */\n+    public Set<String> sourcePath(String fullName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "129e0b7c2e703f7908be0471860856199f56f689"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0Njk5Ng==", "bodyText": "Will keep this in mind in the next PR where we'll handle field-specific behavior like formatting.", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r417446996", "createdAt": "2020-04-29T16:25:54Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -602,6 +602,14 @@ public MappedFieldType fieldType(String fullName) {\n         return fieldTypes.simpleMatchToFullName(pattern);\n     }\n \n+    /**\n+     * Given a field name, returns its possible paths in the _source. For example,\n+     * the 'source path' for a multi-field is the path to its parent field.\n+     */\n+    public Set<String> sourcePath(String fullName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxOTkwMg=="}, "originalCommit": {"oid": "129e0b7c2e703f7908be0471860856199f56f689"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ0ODMxMQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r417448311", "createdAt": "2020-04-29T16:27:52Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -602,6 +602,14 @@ public MappedFieldType fieldType(String fullName) {\n         return fieldTypes.simpleMatchToFullName(pattern);\n     }\n \n+    /**\n+     * Given a field name, returns its possible paths in the _source. For example,\n+     * the 'source path' for a multi-field is the path to its parent field.\n+     */\n+    public Set<String> sourcePath(String fullName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxOTkwMg=="}, "originalCommit": {"oid": "129e0b7c2e703f7908be0471860856199f56f689"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2481, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}