{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTE0MTk3", "number": 62728, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTozNDo0OVrOElz56g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNToxNjozNFrOEmIwEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDgzMTc4OnYy", "diffSide": "RIGHT", "path": "distribution/src/bin/elasticsearch-env", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTozNDo0OVrOHVfkOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTozNDo0OVrOHVfkOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI5OTMyMQ==", "bodyText": "debug?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492299321", "createdAt": "2020-09-21T19:34:49Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,41 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  echo check_glibc_version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de80305f724e874477a5099a400eb30fec1083ea"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDgzODE0OnYy", "diffSide": "RIGHT", "path": "distribution/src/bin/elasticsearch-env", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTozNjozOFrOHVfoFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTozNjozOFrOHVfoFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMDMwOA==", "bodyText": "this isn't portable. i think can avoid it altogether and only use getconf?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492300308", "createdAt": "2020-09-21T19:36:38Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,41 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  echo check_glibc_version\n+  if [[ -e /lib64/libc.so.6 ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de80305f724e874477a5099a400eb30fec1083ea"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDgzOTY3OnYy", "diffSide": "RIGHT", "path": "distribution/src/bin/elasticsearch-env", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTozNzowN1rOHVfpEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxOTozNzowN1rOHVfpEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMwMDU2MA==", "bodyText": "i think can can avoid all the fallbacks? just use getconf", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492300560", "createdAt": "2020-09-21T19:37:07Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,41 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  echo check_glibc_version\n+  if [[ -e /lib64/libc.so.6 ]]; then\n+    # We need to check the version of glibc, because JDK >=15 requires\n+    # glibc 2.14\n+    LIBC_VERSION=\"$( getconf GNU_LIBC_VERSION | awk '{ if ($2 ~ /^[0-9.]*$/) { print $2; exit 0 } else { exit 1 } }' )\"\n+    if [[ $? -ne 0 ]]; then\n+      LIBC_VERSION=\"$( ldd --version | head -1 | awk '{ if ($4 ~ /^[0-9.]*$/) { print $4; exit 0 } else { exit 1 } }' )\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de80305f724e874477a5099a400eb30fec1083ea"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDkzMzE0OnYy", "diffSide": "RIGHT", "path": "distribution/src/bin/elasticsearch-env", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDowNjowMVrOHVgjbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1ODo1NVrOHVwl7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNTUwMw==", "bodyText": "Does this work? I thought the $? would be the result of the assignment, not the inner command?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492315503", "createdAt": "2020-09-21T20:06:01Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,31 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  # We need to check the version of glibc, because JDK >=15 requires\n+  # glibc 2.14\n+  GLIBC_VERSION=\"$( getconf GNU_LIBC_VERSION 2>/dev/null | cut -d' ' -f2)\"\n+  if [[ $? -ne 0 ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "243a2066943392054cee0eb7ab4ba255d02f705a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMDUwNw==", "bodyText": "$? is the status of the most recent pipeline, and variable assignment is not a pipeline.\nSo, with respect to the assignment it works. e.g.\nbash -c 'False=$( false ) ; echo $? ; True=$(true) ; echo $?'\n1\n0\n\nHowever, it only works because the script sets pipefail, otherwise the status of getconf would be lost and we would be testing the status of cut (which would succeed).\nBack to lurk mode.\nSorry I spent years maintaining a system that had in excess of 10k lines of ksh code, some of this stuff is burned into my brain.", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492420507", "createdAt": "2020-09-22T00:39:53Z", "author": {"login": "tvernum"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,31 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  # We need to check the version of glibc, because JDK >=15 requires\n+  # glibc 2.14\n+  GLIBC_VERSION=\"$( getconf GNU_LIBC_VERSION 2>/dev/null | cut -d' ' -f2)\"\n+  if [[ $? -ne 0 ]]; then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNTUwMw=="}, "originalCommit": {"oid": "243a2066943392054cee0eb7ab4ba255d02f705a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3ODI4NA==", "bodyText": "Thanks Tim! I've reworked the script to be more cautious, and also to stop performing floating point comparisons.", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492578284", "createdAt": "2020-09-22T08:58:55Z", "author": {"login": "pugnascotia"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,31 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  # We need to check the version of glibc, because JDK >=15 requires\n+  # glibc 2.14\n+  GLIBC_VERSION=\"$( getconf GNU_LIBC_VERSION 2>/dev/null | cut -d' ' -f2)\"\n+  if [[ $? -ne 0 ]]; then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNTUwMw=="}, "originalCommit": {"oid": "243a2066943392054cee0eb7ab4ba255d02f705a"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDk0MTQzOnYy", "diffSide": "RIGHT", "path": "distribution/src/bin/elasticsearch-env", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDowODozOVrOHVgohQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDowODozOVrOHVgohQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMxNjgwNQ==", "bodyText": "Is this doing a numeric comparison? Is it casting $1 to a float? Are there any floating point precision issues possible?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492316805", "createdAt": "2020-09-21T20:08:39Z", "author": {"login": "rjernst"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,31 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+check_glibc_version() {\n+  # We need to check the version of glibc, because JDK >=15 requires\n+  # glibc 2.14\n+  GLIBC_VERSION=\"$( getconf GNU_LIBC_VERSION 2>/dev/null | cut -d' ' -f2)\"\n+  if [[ $? -ne 0 ]]; then\n+    # Must be on a POSIX system that isn't using glibc.\n+    return 0\n+  fi\n+\n+  if echo \"$GLIBC_VERSION\" | awk '{ if ($1 >= 2.14) { exit 1 } else { exit 0 } }'; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "243a2066943392054cee0eb7ab4ba255d02f705a"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NDI0NzIyOnYy", "diffSide": "RIGHT", "path": "distribution/src/bin/elasticsearch-env", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNToxNjozNVrOHV_Zsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzoyMToyN1rOHWEp8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyMDkxNA==", "bodyText": "Would this say 3.1 was unacceptable?", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492820914", "createdAt": "2020-09-22T15:16:35Z", "author": {"login": "droberts195"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,35 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+# On systems that are built upon glibc, We need to check the version of\n+# glibc because Elasticsearch bundles JDK 15, which requires glibc >= 2.14\n+check_glibc_version() {\n+  local GETCONF=\"$( getconf GNU_LIBC_VERSION 2>/dev/null )\"\n+  if [[ $? -ne 0 ]]; then\n+    # Must be on a POSIX system that isn't using glibc.\n+    return 0\n+  fi\n+\n+  local GLIBC_VERSION=\"$( echo \"$GETCONF\" | cut -d' ' -f2 )\"\n+  local MAJOR=\"$( echo $GLIBC_VERSION | cut -d. -f1 )\"\n+  local MINOR=\"$( echo $GLIBC_VERSION | cut -d. -f2 )\"\n+\n+  if [[ \"$MAJOR\" -lt 2 || \"$MINOR\" -lt 14 ]]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91307273d54df8dbc61f18352b749fee208dd77d"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkwNjk5NA==", "bodyText": "It would - I've reworked this logic.", "url": "https://github.com/elastic/elasticsearch/pull/62728#discussion_r492906994", "createdAt": "2020-09-22T17:21:27Z", "author": {"login": "pugnascotia"}, "path": "distribution/src/bin/elasticsearch-env", "diffHunk": "@@ -35,6 +35,35 @@ ES_HOME=`dirname \"$ES_HOME\"`\n # now set the classpath\n ES_CLASSPATH=\"$ES_HOME/lib/*\"\n \n+\n+# On systems that are built upon glibc, We need to check the version of\n+# glibc because Elasticsearch bundles JDK 15, which requires glibc >= 2.14\n+check_glibc_version() {\n+  local GETCONF=\"$( getconf GNU_LIBC_VERSION 2>/dev/null )\"\n+  if [[ $? -ne 0 ]]; then\n+    # Must be on a POSIX system that isn't using glibc.\n+    return 0\n+  fi\n+\n+  local GLIBC_VERSION=\"$( echo \"$GETCONF\" | cut -d' ' -f2 )\"\n+  local MAJOR=\"$( echo $GLIBC_VERSION | cut -d. -f1 )\"\n+  local MINOR=\"$( echo $GLIBC_VERSION | cut -d. -f2 )\"\n+\n+  if [[ \"$MAJOR\" -lt 2 || \"$MINOR\" -lt 14 ]]; then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyMDkxNA=="}, "originalCommit": {"oid": "91307273d54df8dbc61f18352b749fee208dd77d"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3400, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}