{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NTQzNjc0", "number": 63224, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjoyNjozNVrOEqLOqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjozNzowMFrOEqLXZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjU5NjI1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjoyNjozNVrOHcO-Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjoyNjozNVrOHcO-Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2NzUxOA==", "bodyText": "Nit: Can we move this field up to where id used to be, so that the order matches serialization?", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499367518", "createdAt": "2020-10-05T06:26:35Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequest.java", "diffHunk": "@@ -26,19 +28,24 @@\n \n     private final String realmName;\n     private final String userName;\n-    private final String id;\n     private final String name;\n     private final boolean ownedByAuthenticatedUser;\n+    private final String[] ids;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjYwMDM2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjoyODoxOVrOHcPAxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjoyODoxOVrOHcPAxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2ODEzMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        validationException = addValidationError(\"One of [api key id, api key name, username, realm name] must be specified if \" +\n          \n          \n            \n                        validationException = addValidationError(\"One of [api key id(s), api key name, username, realm name] must be specified if \" +", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499368133", "createdAt": "2020-10-05T06:28:19Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequest.java", "diffHunk": "@@ -141,12 +161,25 @@ public static InvalidateApiKeyRequest forOwnedApiKeys() {\n     @Override\n     public ActionRequestValidationException validate() {\n         ActionRequestValidationException validationException = null;\n-        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && Strings.hasText(id) == false\n+        if (ids != null) {\n+            if (ids.length == 0) {\n+                validationException = addValidationError(\"Field [ids] cannot be an empty array\", validationException);\n+            } else {\n+                final int[] idxOfBlankIds = IntStream.range(0, ids.length).filter(i -> Strings.hasText(ids[i]) == false).toArray();\n+                if (idxOfBlankIds.length > 0) {\n+                    validationException = addValidationError(\"Field [ids] must not contain blank id, but got blank \"\n+                        + (idxOfBlankIds.length == 1 ? \"id\" : \"ids\") + \" at index \"\n+                        + (idxOfBlankIds.length == 1 ? \"position\" : \"positions\") + \": \"\n+                        + Arrays.toString(idxOfBlankIds), validationException);\n+                }\n+            }\n+        }\n+        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && ids == null\n             && Strings.hasText(name) == false && ownedByAuthenticatedUser == false) {\n             validationException = addValidationError(\"One of [api key id, api key name, username, realm name] must be specified if \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjYwMjEyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjoyOTowOVrOHcPB0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjoyOTowOVrOHcPB0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2ODQwMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"username or realm name must not be specified when the api key id or api key name is specified\",\n          \n          \n            \n                                \"username or realm name must not be specified when the api key id(s) or api key name are specified\",", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499368402", "createdAt": "2020-10-05T06:29:09Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequest.java", "diffHunk": "@@ -141,12 +161,25 @@ public static InvalidateApiKeyRequest forOwnedApiKeys() {\n     @Override\n     public ActionRequestValidationException validate() {\n         ActionRequestValidationException validationException = null;\n-        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && Strings.hasText(id) == false\n+        if (ids != null) {\n+            if (ids.length == 0) {\n+                validationException = addValidationError(\"Field [ids] cannot be an empty array\", validationException);\n+            } else {\n+                final int[] idxOfBlankIds = IntStream.range(0, ids.length).filter(i -> Strings.hasText(ids[i]) == false).toArray();\n+                if (idxOfBlankIds.length > 0) {\n+                    validationException = addValidationError(\"Field [ids] must not contain blank id, but got blank \"\n+                        + (idxOfBlankIds.length == 1 ? \"id\" : \"ids\") + \" at index \"\n+                        + (idxOfBlankIds.length == 1 ? \"position\" : \"positions\") + \": \"\n+                        + Arrays.toString(idxOfBlankIds), validationException);\n+                }\n+            }\n+        }\n+        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && ids == null\n             && Strings.hasText(name) == false && ownedByAuthenticatedUser == false) {\n             validationException = addValidationError(\"One of [api key id, api key name, username, realm name] must be specified if \" +\n                 \"[owner] flag is false\", validationException);\n         }\n-        if (Strings.hasText(id) || Strings.hasText(name)) {\n+        if (ids != null || Strings.hasText(name)) {\n             if (Strings.hasText(realmName) || Strings.hasText(userName)) {\n                 validationException = addValidationError(\n                     \"username or realm name must not be specified when the api key id or api key name is specified\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjYxMDIyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequestTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjozMzowNFrOHcPGkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjozMzowNFrOHcPGkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2OTYxNw==", "bodyText": "Oh wow. I can't believe we need to have this. We definitely need to look at removing this class in a follow up PR.", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499369617", "createdAt": "2020-10-05T06:33:04Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequestTests.java", "diffHunk": "@@ -69,7 +110,15 @@ public void writeTo(StreamOutput out) throws IOException {\n                 super.writeTo(out);\n                 out.writeOptionalString(realm);\n                 out.writeOptionalString(user);\n-                out.writeOptionalString(apiKeyId);\n+                if (out.getVersion().onOrAfter(Version.V_7_10_0)) {\n+                    if (Strings.hasText(apiKeyId)) {\n+                        out.writeOptionalStringArray(new String[] { apiKeyId });\n+                    } else {\n+                        out.writeOptionalStringArray(null);\n+                    }\n+                } else {\n+                    out.writeOptionalString(apiKeyId);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyNjYxODYzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/api_key/10_basic.yml", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjozNzowMFrOHcPLXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMDo0Nzo1M1rOHcXiwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3MDg0Nw==", "bodyText": "Did you consider putting key _1 in here, and checking previously_invalidated_api_keys: 1 ?\nIt seems like a useful test of the error handling for multiple ids.", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499370847", "createdAt": "2020-10-05T06:37:00Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/api_key/10_basic.yml", "diffHunk": "@@ -214,10 +214,58 @@ teardown:\n       security.invalidate_api_key:\n         body:  >\n             {\n-              \"id\": \"${api_key_id}\"\n+              \"id\": \"${api_key_id_1}\"\n             }\n   - length: { \"invalidated_api_keys\" : 1 }\n-  - match: { \"invalidated_api_keys.0\" : \"${api_key_id}\" }\n+  - match: { \"invalidated_api_keys.0\" : \"${api_key_id_1}\" }\n+  - length: { \"previously_invalidated_api_keys\" : 0 }\n+  - match: { \"error_count\" : 0 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.create_api_key:\n+        body:  >\n+          {\n+            \"name\": \"my-api-key-2\",\n+            \"expiration\": \"1d\",\n+            \"role_descriptors\": {\n+            }\n+          }\n+  - match: { name: \"my-api-key-2\" }\n+  - is_true: id\n+  - is_true: api_key\n+  - is_true: expiration\n+  - set: { id: api_key_id_2 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.create_api_key:\n+        body:  >\n+          {\n+            \"name\": \"my-api-key-3\",\n+            \"expiration\": \"1d\",\n+            \"role_descriptors\": {\n+            }\n+          }\n+  - match: { name: \"my-api-key-3\" }\n+  - is_true: id\n+  - is_true: api_key\n+  - is_true: expiration\n+  - set: { id: api_key_id_3 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.invalidate_api_key:\n+        body:  >\n+          {\n+            \"ids\": [ \"${api_key_id_2}\", \"${api_key_id_3}\" ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQwNTI0OQ==", "bodyText": "Unfortunately no. The code filters out invalidated keys before calling indexInvalidate, i.e.\n\n  \n    \n      elasticsearch/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/ApiKeyService.java\n    \n    \n         Line 765\n      in\n      e3dd0a8\n    \n    \n    \n    \n\n        \n          \n           findApiKeysForUserRealmApiKeyIdAndNameCombination(realmName, username, apiKeyName, apiKeyId, true, false, \n        \n    \n  \n\n\nNot sure if it is intended?", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499405249", "createdAt": "2020-10-05T07:54:27Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/api_key/10_basic.yml", "diffHunk": "@@ -214,10 +214,58 @@ teardown:\n       security.invalidate_api_key:\n         body:  >\n             {\n-              \"id\": \"${api_key_id}\"\n+              \"id\": \"${api_key_id_1}\"\n             }\n   - length: { \"invalidated_api_keys\" : 1 }\n-  - match: { \"invalidated_api_keys.0\" : \"${api_key_id}\" }\n+  - match: { \"invalidated_api_keys.0\" : \"${api_key_id_1}\" }\n+  - length: { \"previously_invalidated_api_keys\" : 0 }\n+  - match: { \"error_count\" : 0 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.create_api_key:\n+        body:  >\n+          {\n+            \"name\": \"my-api-key-2\",\n+            \"expiration\": \"1d\",\n+            \"role_descriptors\": {\n+            }\n+          }\n+  - match: { name: \"my-api-key-2\" }\n+  - is_true: id\n+  - is_true: api_key\n+  - is_true: expiration\n+  - set: { id: api_key_id_2 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.create_api_key:\n+        body:  >\n+          {\n+            \"name\": \"my-api-key-3\",\n+            \"expiration\": \"1d\",\n+            \"role_descriptors\": {\n+            }\n+          }\n+  - match: { name: \"my-api-key-3\" }\n+  - is_true: id\n+  - is_true: api_key\n+  - is_true: expiration\n+  - set: { id: api_key_id_3 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.invalidate_api_key:\n+        body:  >\n+          {\n+            \"ids\": [ \"${api_key_id_2}\", \"${api_key_id_3}\" ]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3MDg0Nw=="}, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUwNzkwNA==", "bodyText": "I mean I will add key 1 here, but the response won't change.", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499507904", "createdAt": "2020-10-05T10:47:53Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/api_key/10_basic.yml", "diffHunk": "@@ -214,10 +214,58 @@ teardown:\n       security.invalidate_api_key:\n         body:  >\n             {\n-              \"id\": \"${api_key_id}\"\n+              \"id\": \"${api_key_id_1}\"\n             }\n   - length: { \"invalidated_api_keys\" : 1 }\n-  - match: { \"invalidated_api_keys.0\" : \"${api_key_id}\" }\n+  - match: { \"invalidated_api_keys.0\" : \"${api_key_id_1}\" }\n+  - length: { \"previously_invalidated_api_keys\" : 0 }\n+  - match: { \"error_count\" : 0 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.create_api_key:\n+        body:  >\n+          {\n+            \"name\": \"my-api-key-2\",\n+            \"expiration\": \"1d\",\n+            \"role_descriptors\": {\n+            }\n+          }\n+  - match: { name: \"my-api-key-2\" }\n+  - is_true: id\n+  - is_true: api_key\n+  - is_true: expiration\n+  - set: { id: api_key_id_2 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.create_api_key:\n+        body:  >\n+          {\n+            \"name\": \"my-api-key-3\",\n+            \"expiration\": \"1d\",\n+            \"role_descriptors\": {\n+            }\n+          }\n+  - match: { name: \"my-api-key-3\" }\n+  - is_true: id\n+  - is_true: api_key\n+  - is_true: expiration\n+  - set: { id: api_key_id_3 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.invalidate_api_key:\n+        body:  >\n+          {\n+            \"ids\": [ \"${api_key_id_2}\", \"${api_key_id_3}\" ]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3MDg0Nw=="}, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3173, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}