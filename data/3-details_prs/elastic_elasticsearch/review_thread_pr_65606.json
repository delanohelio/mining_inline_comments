{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NTYyNDYz", "number": 65606, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTozOToxOFrOE_HIQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0ODoxNFrOE_HUaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NjEyNTQ3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTozOToxOFrOH8ou_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTowODoyNVrOH9Q9aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0Mzk5Ng==", "bodyText": "It might be better to say object instead of map in this error message, as the user reading the message is thinking of the JSON structure rather than the Java structure.", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533343996", "createdAt": "2020-12-01T11:39:18Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java", "diffHunk": "@@ -824,6 +853,28 @@ void validateScriptFields() {\n             }\n         }\n \n+        /**\n+         * Perform a light check that the structure resembles runtime_mappings.\n+         * The full check cannot happen until search\n+         */\n+        void validateRuntimeMappings() {\n+            for (Map.Entry<String, Object> entry : runtimeMappings.entrySet()) {\n+                // top level objects are fields\n+                String fieldName = entry.getKey();\n+                if (entry.getValue() instanceof Map) {\n+                    @SuppressWarnings(\"unchecked\")\n+                    Map<String, Object> propNode = new HashMap<>(((Map<String, Object>) entry.getValue()));\n+                    Object typeNode = propNode.get(\"type\");\n+                    if (typeNode == null) {\n+                        throw ExceptionsHelper.badRequestException(\"No type specified for runtime field [\" + fieldName + \"]\");\n+                    }\n+                } else {\n+                    throw ExceptionsHelper.badRequestException(\"Expected map for runtime field [\" + fieldName + \"] \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 180}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQxODQxNw==", "bodyText": "map is consistent with the language used here\n\n  \n    \n      elasticsearch/server/src/main/java/org/elasticsearch/index/mapper/RuntimeFieldType.java\n    \n    \n         Line 91\n      in\n      af2f084\n    \n    \n    \n    \n\n        \n          \n           throw new MapperParsingException(\"Expected map for runtime field [\" + fieldName + \"] definition but got a \"", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533418417", "createdAt": "2020-12-01T13:47:19Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java", "diffHunk": "@@ -824,6 +853,28 @@ void validateScriptFields() {\n             }\n         }\n \n+        /**\n+         * Perform a light check that the structure resembles runtime_mappings.\n+         * The full check cannot happen until search\n+         */\n+        void validateRuntimeMappings() {\n+            for (Map.Entry<String, Object> entry : runtimeMappings.entrySet()) {\n+                // top level objects are fields\n+                String fieldName = entry.getKey();\n+                if (entry.getValue() instanceof Map) {\n+                    @SuppressWarnings(\"unchecked\")\n+                    Map<String, Object> propNode = new HashMap<>(((Map<String, Object>) entry.getValue()));\n+                    Object typeNode = propNode.get(\"type\");\n+                    if (typeNode == null) {\n+                        throw ExceptionsHelper.badRequestException(\"No type specified for runtime field [\" + fieldName + \"]\");\n+                    }\n+                } else {\n+                    throw ExceptionsHelper.badRequestException(\"Expected map for runtime field [\" + fieldName + \"] \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0Mzk5Ng=="}, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 180}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwMzA0OQ==", "bodyText": "It's still wrong - the word \"map\" does not appear anywhere in this page: https://www.json.org/json-en.html\nIt sounds like there is going to be a separate PR to correct this throughout the runtime fields code though, so all instances can be fixed in one go.", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r534003049", "createdAt": "2020-12-02T09:08:25Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java", "diffHunk": "@@ -824,6 +853,28 @@ void validateScriptFields() {\n             }\n         }\n \n+        /**\n+         * Perform a light check that the structure resembles runtime_mappings.\n+         * The full check cannot happen until search\n+         */\n+        void validateRuntimeMappings() {\n+            for (Map.Entry<String, Object> entry : runtimeMappings.entrySet()) {\n+                // top level objects are fields\n+                String fieldName = entry.getKey();\n+                if (entry.getValue() instanceof Map) {\n+                    @SuppressWarnings(\"unchecked\")\n+                    Map<String, Object> propNode = new HashMap<>(((Map<String, Object>) entry.getValue()));\n+                    Object typeNode = propNode.get(\"type\");\n+                    if (typeNode == null) {\n+                        throw ExceptionsHelper.badRequestException(\"No type specified for runtime field [\" + fieldName + \"]\");\n+                    }\n+                } else {\n+                    throw ExceptionsHelper.badRequestException(\"Expected map for runtime field [\" + fieldName + \"] \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0Mzk5Ng=="}, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 180}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NjEzMzQ3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedJobValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0MTozN1rOH8oz0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0MTozN1rOH8oz0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0NTIzMw==", "bodyText": "I think there should be a comment to say this is only checking search-time runtime fields.", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533345233", "createdAt": "2020-12-01T11:41:37Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedJobValidator.java", "diffHunk": "@@ -38,6 +40,8 @@ public static void validate(DatafeedConfig datafeedConfig, Job job, NamedXConten\n         if (delayedDataCheckConfig.isEnabled()) {\n             checkValidDelayedDataCheckConfig(bucketSpan, delayedDataCheckConfig);\n         }\n+\n+        checkTimeFieldIsNotARuntimeField(datafeedConfig, job.getDataDescription().getTimeField());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NjEzNDM1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedJobValidator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0MTo0OFrOH8o0RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0MTo0OFrOH8o0RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0NTM0OA==", "bodyText": "I think there should be a comment to say this is only checking search-time runtime fields.", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533345348", "createdAt": "2020-12-01T11:41:48Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedJobValidator.java", "diffHunk": "@@ -97,4 +101,16 @@ private static void checkFrequencyIsMultipleOfHistogramInterval(DatafeedConfig d\n             }\n         }\n     }\n+\n+    private static void checkTimeFieldIsNotARuntimeField(DatafeedConfig datafeedConfig, String timeField) {\n+        Map<String, Object> runtimeMappings = datafeedConfig.getRuntimeMappings();\n+        for (Map.Entry<String, Object> entry : runtimeMappings.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NjE0NjQwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/job/persistence/ElasticsearchMappingsTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0NToxNlrOH8o7iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0NToxNlrOH8o7iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0NzIwOQ==", "bodyText": "SearchSourceBuilder.RUNTIME_MAPPINGS_FIELD.getPreferredName()?", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533347209", "createdAt": "2020-12-01T11:45:16Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/job/persistence/ElasticsearchMappingsTests.java", "diffHunk": "@@ -75,7 +75,8 @@\n             ElasticsearchMappings.NESTED,\n             ElasticsearchMappings.PROPERTIES,\n             ElasticsearchMappings.TYPE,\n-            ElasticsearchMappings.WHITESPACE\n+            ElasticsearchMappings.WHITESPACE,\n+            \"runtime_mappings\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NjE1NjU5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0ODoxNFrOH8pBmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0ODoxNFrOH8pBmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0ODc2MQ==", "bodyText": "This shouldn't be necessary.  I thought we ignored the time format in the data description when using a datafeed.  If deleting this line makes the test fail then something unexpected is happening somewhere.", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533348761", "createdAt": "2020-12-01T11:48:14Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsIT.java", "diffHunk": "@@ -145,6 +152,68 @@ public void testLookbackOnlyDataStream() throws Exception {\n         waitUntilJobIsClosed(job.getId());\n     }\n \n+    public void testLookbackOnlyRuntimeMapping() throws Exception {\n+        client().admin().indices().prepareCreate(\"data-1\")\n+            .setMapping(\"time\", \"type=date\")\n+            .get();\n+        long numDocs = randomIntBetween(32, 2048);\n+        long now = System.currentTimeMillis();\n+        long oneWeekAgo = now - 604800000;\n+        long twoWeeksAgo = oneWeekAgo - 604800000;\n+        indexDocs(logger, \"data-1\", numDocs, twoWeeksAgo, oneWeekAgo);\n+\n+        DataDescription.Builder dataDescription = new DataDescription.Builder();\n+        dataDescription.setTimeFormat(\"yyyy-MM-dd HH:mm:ss\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1997, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}