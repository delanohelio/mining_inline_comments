{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNTk5MDEx", "number": 53879, "title": "Extract CacheBufferedIndexInput from CacheDirectory", "bodyText": "Following #53860, this pull request extracts the CacheBufferedIndexInput class from the CacheDirectory so that it can be merged with SearchableSnapshotDirectory.", "createdAt": "2020-03-20T15:38:07Z", "url": "https://github.com/elastic/elasticsearch/pull/53879", "merged": true, "mergeCommit": {"oid": "815c861741c2508cbd1638ba0a04af787fc12dcf"}, "closed": true, "closedAt": "2020-03-20T18:02:40Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPiV-JgH2gAyMzkxNTk5MDExOjkyMTVjY2VjODVlOWUwZTg0OWJmY2YyYTY2MDNmMjZmMTFjYjFiMzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPjRLNgH2gAyMzkxNTk5MDExOjI1MWU0YjM1YzkzN2Q2MmM3ZTQ4YzgxYjNmYjFmNTA2NGRiNWMxZjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/9215ccec85e9e0e849bfcf2a6603f26f11cb1b36", "committedDate": "2020-03-20T15:35:43Z", "message": "Extract CacheBufferedIndexInput"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTkzNTY5", "url": "https://github.com/elastic/elasticsearch/pull/53879#pullrequestreview-378593569", "createdAt": "2020-03-20T15:40:26Z", "commit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTo0MDoyNlrOF5Y7uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTo0MDoyNlrOF5Y7uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyMTY1Nw==", "bodyText": "This class has been extracted from CacheDirectory as is, with the following modification:\n\nlogger moved to the base class (previously at the CacheDirectory level)\nCOPY_BUFFER_SIZE moved within the CacheBufferedIndexInput class (previously at the CacheDirectory level)\nCacheFileReference now explicitely calls directory.createCacheKey() and directory.getCacheFile()", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395721657", "createdAt": "2020-03-20T15:40:26Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.searchablesnapshots.cache;\n+\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.lucene.store.AlreadyClosedException;\n+import org.apache.lucene.store.IOContext;\n+import org.apache.lucene.store.IndexInput;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.common.io.Channels;\n+import org.elasticsearch.common.util.concurrent.ReleasableLock;\n+import org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshot.FileInfo;\n+import org.elasticsearch.index.store.BaseSearchableSnapshotIndexInput;\n+\n+import java.io.EOFException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class CacheBufferedIndexInput extends BaseSearchableSnapshotIndexInput {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NjA3OTQ5", "url": "https://github.com/elastic/elasticsearch/pull/53879#pullrequestreview-378607949", "createdAt": "2020-03-20T15:56:33Z", "commit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTo1NjozM1rOF5Zleg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjoxNjozN1rOF5aWVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczMjM0Ng==", "bodyText": "I would rather use a distinct (private) logger for each class if possible -- makes it that much easier to track down where messages are coming from.", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395732346", "createdAt": "2020-03-20T15:56:33Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/BaseSearchableSnapshotIndexInput.java", "diffHunk": "@@ -19,6 +21,8 @@\n \n public abstract class BaseSearchableSnapshotIndexInput extends BufferedIndexInput {\n \n+    protected static final Logger logger = LogManager.getLogger(BaseSearchableSnapshotIndexInput.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczMjkwNQ==", "bodyText": "Thanks, that's very helpful :)", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395732905", "createdAt": "2020-03-20T15:57:25Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.searchablesnapshots.cache;\n+\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.lucene.store.AlreadyClosedException;\n+import org.apache.lucene.store.IOContext;\n+import org.apache.lucene.store.IndexInput;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.common.io.Channels;\n+import org.elasticsearch.common.util.concurrent.ReleasableLock;\n+import org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshot.FileInfo;\n+import org.elasticsearch.index.store.BaseSearchableSnapshotIndexInput;\n+\n+import java.io.EOFException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class CacheBufferedIndexInput extends BaseSearchableSnapshotIndexInput {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyMTY1Nw=="}, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc0NDg1Mg==", "bodyText": "Maybe make CacheFileReference a static class (top-level even) and pass the directory to its constructor? That would avoid needing to do this.", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395744852", "createdAt": "2020-03-20T16:16:37Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.searchablesnapshots.cache;\n+\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.lucene.store.AlreadyClosedException;\n+import org.apache.lucene.store.IOContext;\n+import org.apache.lucene.store.IndexInput;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.common.io.Channels;\n+import org.elasticsearch.common.util.concurrent.ReleasableLock;\n+import org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshot.FileInfo;\n+import org.elasticsearch.index.store.BaseSearchableSnapshotIndexInput;\n+\n+import java.io.EOFException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class CacheBufferedIndexInput extends BaseSearchableSnapshotIndexInput {\n+\n+    private static final int COPY_BUFFER_SIZE = 8192;\n+\n+    private final CacheDirectory directory;\n+    private final long offset;\n+    private final long end;\n+    private final CacheFileReference cacheFileReference;\n+    private final IndexInputStats stats;\n+\n+    // the following are only mutable so they can be adjusted after cloning\n+    private AtomicBoolean closed;\n+    private boolean isClone;\n+\n+    // last read position is kept around in order to detect (non)contiguous reads for stats\n+    private long lastReadPosition;\n+    // last seek position is kept around in order to detect forward/backward seeks for stats\n+    private long lastSeekPosition;\n+\n+    CacheBufferedIndexInput(CacheDirectory directory, FileInfo fileInfo, IOContext context, IndexInputStats stats) {\n+        this(\"CachedBufferedIndexInput(\" + fileInfo.physicalName() + \")\", directory, fileInfo, context, stats, 0L, fileInfo.length(),\n+            false, null);\n+        stats.incrementOpenCount();\n+    }\n+\n+    private CacheBufferedIndexInput(String resourceDesc, CacheDirectory directory, FileInfo fileInfo, IOContext context,\n+                                    IndexInputStats stats, long offset, long length, boolean isClone,\n+                                    @Nullable CacheFileReference cacheFileReference) {\n+        super(resourceDesc, directory.blobContainer(), fileInfo, context);\n+        this.directory = directory;\n+        this.offset = offset;\n+        this.stats = stats;\n+        this.end = offset + length;\n+        this.closed = new AtomicBoolean(false);\n+        this.isClone = isClone;\n+        this.cacheFileReference = Objects.requireNonNullElseGet(cacheFileReference,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9028f8aab9124bbb928669ad65282858f3cb5fee", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/9028f8aab9124bbb928669ad65282858f3cb5fee", "committedDate": "2020-03-20T16:28:14Z", "message": "apply feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NjQxNzc0", "url": "https://github.com/elastic/elasticsearch/pull/53879#pullrequestreview-378641774", "createdAt": "2020-03-20T16:38:22Z", "commit": {"oid": "9028f8aab9124bbb928669ad65282858f3cb5fee"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjozODoyMlrOF5bLbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjozODoyMlrOF5bLbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1ODQ0Ng==", "bodyText": "This isn't used? I mean it probably will be in future, but I think I'd prefer to add it when it's needed.", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395758446", "createdAt": "2020-03-20T16:38:22Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java", "diffHunk": "@@ -48,6 +50,8 @@\n  */\n public class SearchableSnapshotIndexInput extends BaseSearchableSnapshotIndexInput {\n \n+    private static final Logger logger = LogManager.getLogger(SearchableSnapshotIndexInput.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9028f8aab9124bbb928669ad65282858f3cb5fee"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "251e4b35c937d62c7e48c81b3fb1f5064db5c1f8", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/251e4b35c937d62c7e48c81b3fb1f5064db5c1f8", "committedDate": "2020-03-20T16:40:23Z", "message": "remove unused"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1915, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}