{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNTA2NjQ0", "number": 51957, "title": "Force execution of finish shard bulk request", "bodyText": "Currently the shard bulk request can be rejected by the write threadpool\nafter a mapping update. This introduces a scenario where the mapping\nlistener thread will attempt to finish the request and fsync. This\nthread can potentially be a transport thread. This commit fixes this\nissue by forcing the finish action to happen on the write threadpool.\nFixes #51904.", "createdAt": "2020-02-05T17:52:04Z", "url": "https://github.com/elastic/elasticsearch/pull/51957", "merged": true, "mergeCommit": {"oid": "0dd1ed814d09efe269d7e1f6c6b0d24847fa07a6"}, "closed": true, "closedAt": "2020-02-15T01:10:40Z", "author": {"login": "tbrooks8"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBZ4lHAH2gAyMzcxNTA2NjQ0OjVhMDJkMWE3NWVlYzEyYzhiYzc4MzY5N2U3NjM4ZDk3NzExMWQ4NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDnE8QgH2gAyMzcxNTA2NjQ0OjcyMjIzNmRhNzU3MTYyOTIxODVlYjQxZjkyY2NhZWFmNjllNmRjODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a02d1a75eec12c8bc783697e7638d977111d841", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a02d1a75eec12c8bc783697e7638d977111d841", "committedDate": "2020-02-05T17:49:26Z", "message": "Force execution of finish shard bulk request\n\nCurrently the shard bulk request can be rejected by the write threadpool\nafter a mapping update. This introduces a scenario where the mapping\nlistener thread will attempt to finish the request and fsync. This\nthread can potentially be a transport thread. This commit fixes this\nissue by forcing the finish action to happen on the write threadpool.\n\nFixes #51904."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzOTQ3MzQ3", "url": "https://github.com/elastic/elasticsearch/pull/51957#pullrequestreview-353947347", "createdAt": "2020-02-05T18:36:16Z", "commit": {"oid": "5a02d1a75eec12c8bc783697e7638d977111d841"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxODozNjoxNlrOFmCruw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxODozNjoxNlrOFmCruw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQzNDE3MQ==", "bodyText": "I was thinking that rather than scheduling only finishRequest on the write thread pool, we should execute the entirety of onRejection on the write thread pool (and still forcing execution, since rejecting execution here would be very bad): \n  \n    \n      elasticsearch/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java\n    \n    \n         Line 160\n      in\n      3ad8aa6\n    \n    \n    \n    \n\n        \n          \n           ActionListener.wrap(v -> executor.execute(this), this::onRejection)) == false) { \n        \n    \n  \n\n\nThe reason I think this is because we're still doing work in onRejection that is linear in the number of documents in the bulk request. It seems we'd want to get that off of the networking/cluster state applier thread too given that we're going to fork anyway.", "url": "https://github.com/elastic/elasticsearch/pull/51957#discussion_r375434171", "createdAt": "2020-02-05T18:36:16Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java", "diffHunk": "@@ -179,7 +179,20 @@ public void onRejection(Exception e) {\n                             e, primary, docWriteRequest.opType() == DocWriteRequest.OpType.DELETE, docWriteRequest.version()),\n                         context, null);\n                 }\n-                finishRequest();\n+\n+                // Force the execution to finish the request\n+                executor.execute(new ActionRunnable<>(listener) {\n+\n+                    @Override\n+                    protected void doRun() {\n+                        finishRequest();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a02d1a75eec12c8bc783697e7638d977111d841"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b0b0ebb8c254d37ba1cf351c46a706750c8ce54", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b0b0ebb8c254d37ba1cf351c46a706750c8ce54", "committedDate": "2020-02-05T19:13:44Z", "message": "Dispatch everything"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MDMzMjQy", "url": "https://github.com/elastic/elasticsearch/pull/51957#pullrequestreview-354033242", "createdAt": "2020-02-05T20:54:43Z", "commit": {"oid": "4b0b0ebb8c254d37ba1cf351c46a706750c8ce54"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDo1NDo0M1rOFmG1mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMDo1NDo0M1rOFmG1mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwMjIzNQ==", "bodyText": "It's probably worth a comment here why we fork to the executor (since it's not obvious from the code).", "url": "https://github.com/elastic/elasticsearch/pull/51957#discussion_r375502235", "createdAt": "2020-02-05T20:54:43Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java", "diffHunk": "@@ -170,16 +170,28 @@ protected void doRun() throws Exception {\n \n             @Override\n             public void onRejection(Exception e) {\n-                // Fail all operations after a bulk rejection hit an action that waited for a mapping update and finish the request\n-                while (context.hasMoreOperationsToExecute()) {\n-                    context.setRequestToExecute(context.getCurrent());\n-                    final DocWriteRequest<?> docWriteRequest = context.getRequestToExecute();\n-                    onComplete(\n-                        exceptionToResult(\n-                            e, primary, docWriteRequest.opType() == DocWriteRequest.OpType.DELETE, docWriteRequest.version()),\n-                        context, null);\n-                }\n-                finishRequest();\n+                // Force the execution to finish the request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b0b0ebb8c254d37ba1cf351c46a706750c8ce54"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae403e787122a040e3dce40ad3cbc39ed526e729", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae403e787122a040e3dce40ad3cbc39ed526e729", "committedDate": "2020-02-11T16:54:09Z", "message": "Comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07135b261596d902b6c8bcdc32d9c6ca2ff5d8c3", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/07135b261596d902b6c8bcdc32d9c6ca2ff5d8c3", "committedDate": "2020-02-11T16:54:20Z", "message": "Merge remote-tracking branch 'upstream/master' into force_shard_finish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "722236da75716292185eb41f92ccaeaf69e6dc85", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/722236da75716292185eb41f92ccaeaf69e6dc85", "committedDate": "2020-02-12T14:19:33Z", "message": "Merge remote-tracking branch 'upstream/master' into force_shard_finish"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2838, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}