{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0OTMyNTg5", "number": 51233, "title": "Add validation for dynamic templates", "bodyText": "Today misconfiguration of dynamic templates are discovered when indexing a document with an unmapped field. With this change the misconfiguration will be known when creating an index.\nThe validation logic tries to load a Mapper instance for the mapping snippet of a dynamic template. This should catch things like using an analyzer that is undefined or mapping attributes that are unused.\nThis is best effort:\n\nIf {{name}} placeholder is used in the mapping snippet then validation is skipped.\nIf match_mapping_type is not specified then validation is performed for all mapping types. If parsing succeeds with a single mapping type then this the dynamic mapping is considered valid.\n\nIf is detected that a dynamic template mapping snippet is invalid at mapping update time then the mapping update is failed for indices created on 8.0.0-alpha1 and later. For indices created\non prior version a deprecation warning is emitted instead. In 7.x clusters the mapping update\nwill never fail in case of an invalid dynamic template mapping snippet and a deprecation warning will always be omitted.\nCloses #17411\nCloses #24419", "createdAt": "2020-01-20T17:08:12Z", "url": "https://github.com/elastic/elasticsearch/pull/51233", "merged": true, "mergeCommit": {"oid": "31b29875c9d13bcf6e4851141886b0511c7340bb"}, "closed": true, "closedAt": "2020-02-27T10:52:28Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCDnXxgFqTM1NTM0NjI1MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIWXhmgH2gAyMzY0OTMyNTg5OjQ0ZmRkMWU4ZjYyYjQwMGM4NTU1OTcxY2VlYTI2ZjgxODUzMjU0M2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MzQ2MjUw", "url": "https://github.com/elastic/elasticsearch/pull/51233#pullrequestreview-355346250", "createdAt": "2020-02-07T18:21:51Z", "commit": {"oid": "b8b04df83504d45f44f4904eaa5ace23fec86773"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxODoyMTo1MVrOFnF9Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxODoyNjoyNFrOFnGFtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUzNjQyMg==", "bodyText": "do we need to check {dynamic_type} too?", "url": "https://github.com/elastic/elasticsearch/pull/51233#discussion_r376536422", "createdAt": "2020-02-07T18:21:51Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/RootObjectMapper.java", "diffHunk": "@@ -330,4 +338,106 @@ protected void doXContent(XContentBuilder builder, ToXContent.Params params) thr\n             builder.field(\"numeric_detection\", numericDetection.value());\n         }\n     }\n+\n+    public void validateDynamicTemplates(Mapper.TypeParser.ParserContext parserContext) {\n+        for (DynamicTemplate dynamicTemplate : dynamicTemplates.value()) {\n+            validateDynamicTemplate(parserContext, dynamicTemplate);\n+        }\n+    }\n+\n+    private static void validateDynamicTemplate(Mapper.TypeParser.ParserContext parserContext,\n+                                                DynamicTemplate dynamicTemplate) {\n+\n+        if (containsSnippet(dynamicTemplate.getMapping(), \"{name}\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8b04df83504d45f44f4904eaa5ace23fec86773"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUzODU0OA==", "bodyText": "This seems to only validate dynamic templates at creation time, should we move validation to MapperService#merge to make sure we cover all cases, including mapping updates that add dynamic templates on existing indices?", "url": "https://github.com/elastic/elasticsearch/pull/51233#discussion_r376538548", "createdAt": "2020-02-07T18:26:24Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataCreateIndexService.java", "diffHunk": "@@ -621,6 +621,7 @@ private static void updateIndexMappingsAndBuildSortOrder(IndexService indexServi\n         if (!mappings.isEmpty()) {\n             assert mappings.size() == 1 : mappings;\n             mapperService.merge(MapperService.SINGLE_MAPPING_NAME, mappings, MergeReason.MAPPING_UPDATE);\n+            mapperService.validateDynamicTemplates();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8b04df83504d45f44f4904eaa5ace23fec86773"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13adc7935c3f1aec915def84c2db93122ff77ef7", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/13adc7935c3f1aec915def84c2db93122ff77ef7", "committedDate": "2020-02-11T08:36:10Z", "message": "Add validation for dynamic templates.\n\nTries to load a `Mapper.Builder` instance for the mapping snippet of a dynamic template.\nThis should catch things like using a analyzer that is undefined or mapping attributes that are unused.\n\nThis is best effort:\n* If `{{name}}` placeholder is used in the mapping snippet then validation is skipped.\n* If `match_mapping_type` is not specified then validation is performed for all mapping types.\n  If parsing succeeds with a single mapping type then this the dynamic mapping is considered valid.\n\nThis validation can be enabled on indices created on a master node with version 8.0.0 or higher.\nFor 7.x a deprecation warning can be omitted instead.\n\nCloses #17411\nCloses #24419"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca7ed5ac79934c9d34a99b24df705280440a52a5", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca7ed5ac79934c9d34a99b24df705280440a52a5", "committedDate": "2020-02-11T08:36:11Z", "message": "moved validation logic to a better place"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d047b8f76090451c7e33557cfc1ed4e104973063", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/d047b8f76090451c7e33557cfc1ed4e104973063", "committedDate": "2020-02-11T08:36:11Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8c10793c9f43be13e00de2df1b0b14017e40aa4", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8c10793c9f43be13e00de2df1b0b14017e40aa4", "committedDate": "2020-02-14T10:54:06Z", "message": "* Moved validation of dynamic templates to where dynamic templates are parsed.\n* Added tests and updated the documentation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8b04df83504d45f44f4904eaa5ace23fec86773", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b8b04df83504d45f44f4904eaa5ace23fec86773", "committedDate": "2020-01-21T07:57:37Z", "message": "iter"}, "afterCommit": {"oid": "a8c10793c9f43be13e00de2df1b0b14017e40aa4", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8c10793c9f43be13e00de2df1b0b14017e40aa4", "committedDate": "2020-02-14T10:54:06Z", "message": "* Moved validation of dynamic templates to where dynamic templates are parsed.\n* Added tests and updated the documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a63f1935890470e649f1f294b1a4d2bb46d8b12a", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a63f1935890470e649f1f294b1a4d2bb46d8b12a", "committedDate": "2020-02-14T11:49:57Z", "message": "Merge remote-tracking branch 'es/master' into validate_dynamic_templates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjA2NDY1", "url": "https://github.com/elastic/elasticsearch/pull/51233#pullrequestreview-359206465", "createdAt": "2020-02-14T20:40:21Z", "commit": {"oid": "a63f1935890470e649f1f294b1a4d2bb46d8b12a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDo0MDoyMVrOFqDDcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQyMDo0NToyM1rOFqDLNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNDU0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            If an provided mapping contains an invalid mapping snippet then that results in\n          \n          \n            \n            If a provided mapping contains an invalid mapping snippet then that results in", "url": "https://github.com/elastic/elasticsearch/pull/51233#discussion_r379634547", "createdAt": "2020-02-14T20:40:21Z", "author": {"login": "jpountz"}, "path": "docs/reference/mapping/dynamic/templates.asciidoc", "diffHunk": "@@ -37,6 +37,10 @@ Dynamic templates are specified as an array of named objects:\n <2> The match conditions can include any of : `match_mapping_type`, `match`, `match_pattern`, `unmatch`, `path_match`, `path_unmatch`.\n <3> The mapping that the matched field should use.\n \n+If an provided mapping contains an invalid mapping snippet then that results in", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a63f1935890470e649f1f294b1a4d2bb46d8b12a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzNjUzMw==", "bodyText": "I think some fields might do extra validation when calling builder.build(), should we try to build the mapper too?", "url": "https://github.com/elastic/elasticsearch/pull/51233#discussion_r379636533", "createdAt": "2020-02-14T20:45:23Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/RootObjectMapper.java", "diffHunk": "@@ -333,4 +342,111 @@ protected void doXContent(XContentBuilder builder, ToXContent.Params params) thr\n             builder.field(\"numeric_detection\", numericDetection.value());\n         }\n     }\n+\n+    private static void validateDynamicTemplate(Mapper.TypeParser.ParserContext parserContext,\n+                                                DynamicTemplate dynamicTemplate) {\n+\n+        if (containsSnippet(dynamicTemplate.getMapping(), \"{name}\")) {\n+            // Can't validate template, because field names can't be guessed up front.\n+            return;\n+        }\n+\n+        final XContentFieldType[] types;\n+        if (dynamicTemplate.getXContentFieldType() != null) {\n+            types = new XContentFieldType[]{dynamicTemplate.getXContentFieldType()};\n+        } else {\n+            types = XContentFieldType.values();\n+        }\n+\n+        Exception lastError = null;\n+        boolean dynamicTemplateInvalid = true;\n+\n+        for (XContentFieldType contentFieldType : types) {\n+            String defaultDynamicType = contentFieldType.defaultMappingType();\n+            String mappingType = dynamicTemplate.mappingType(defaultDynamicType);\n+            Mapper.TypeParser typeParser = parserContext.typeParser(mappingType);\n+            if (typeParser == null) {\n+                lastError = new IllegalArgumentException(\"No mapper found for type [\" + mappingType + \"]\");\n+                continue;\n+            }\n+\n+            Map<String, Object> fieldTypeConfig = dynamicTemplate.mappingForName(\"__dummy__\", defaultDynamicType);\n+            fieldTypeConfig.remove(\"type\");\n+            try {\n+                Mapper.Builder<?, ?> dummyBuilder = typeParser.parse(\"__dummy__\", fieldTypeConfig, parserContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a63f1935890470e649f1f294b1a4d2bb46d8b12a"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbce91c5fb24ef8f70a6f3b388aaf2556b21fa46", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/dbce91c5fb24ef8f70a6f3b388aaf2556b21fa46", "committedDate": "2020-02-24T06:36:56Z", "message": "fix typo in docs\n\nCo-Authored-By: Adrien Grand <jpountz@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5df937764d45a6223f4e98e49cd2d687f20f7e3", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c5df937764d45a6223f4e98e49cd2d687f20f7e3", "committedDate": "2020-02-26T08:02:23Z", "message": "Merge remote-tracking branch 'es/master' into validate_dynamic_templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28f6d5ec153f33253d8497f5405a52c9b94c0e9b", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/28f6d5ec153f33253d8497f5405a52c9b94c0e9b", "committedDate": "2020-02-26T08:16:14Z", "message": "Also build the actual mapper instance to ensure that validation\nthat occurs during construction of a mapper instance is executed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4ccb679f134d9420e814839396d264a4a9f0471", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4ccb679f134d9420e814839396d264a4a9f0471", "committedDate": "2020-02-26T09:17:40Z", "message": "adjusted the wording about when and how a template is validated at mapping update time."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTY4NDIy", "url": "https://github.com/elastic/elasticsearch/pull/51233#pullrequestreview-364968422", "createdAt": "2020-02-26T14:58:29Z", "commit": {"oid": "a4ccb679f134d9420e814839396d264a4a9f0471"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44fdd1e8f62b400c8555971ceea26f818532543e", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/44fdd1e8f62b400c8555971ceea26f818532543e", "committedDate": "2020-02-27T07:41:05Z", "message": "Merge remote-tracking branch 'es/master' into validate_dynamic_templates"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3057, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}