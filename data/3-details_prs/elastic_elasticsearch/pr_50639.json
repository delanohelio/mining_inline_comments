{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NDUwMzUy", "number": 50639, "title": "Use single directory for metadata", "bodyText": "Earlier PRs for #48701 introduced a separate directory for the cluster state. This is not needed though, and introduces an additional unnecessary cognitive burden to the users.", "createdAt": "2020-01-06T08:53:21Z", "url": "https://github.com/elastic/elasticsearch/pull/50639", "merged": true, "mergeCommit": {"oid": "0830b7dc12160ffa042fab699c4cb55ece02bf93"}, "closed": true, "closedAt": "2020-01-08T13:06:16Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3D49xAH2gAyMzU5NDUwMzUyOmY2OTU2NjkzOTNmOTQwNTZmOWI3OWI0YjcxNTJhMGZkNjU0MWZlODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4U9xwAH2gAyMzU5NDUwMzUyOjk0YWZmNjk2OGUyYzMxZmZkMjY4MDljNjcwNTVjMjk0M2EzNGJlOGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f695669393f94056f9b79b4b7152a0fd6541fe83", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/f695669393f94056f9b79b4b7152a0fd6541fe83", "committedDate": "2020-01-04T14:32:42Z", "message": "Use single directory for metadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTI2NjQ4", "url": "https://github.com/elastic/elasticsearch/pull/50639#pullrequestreview-338526648", "createdAt": "2020-01-06T08:55:02Z", "commit": {"oid": "f695669393f94056f9b79b4b7152a0fd6541fe83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwODo1NTowMlrOFaYPxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwODo1NTowMlrOFaYPxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNDU1MQ==", "bodyText": "while not strictly part of the logic in this PR, this fixes the testCannotJoinClusterWithDifferentUUID test that was occasionally failing without this being properly implemented.", "url": "https://github.com/elastic/elasticsearch/pull/50639#discussion_r363204551", "createdAt": "2020-01-06T08:55:02Z", "author": {"login": "ywelsch"}, "path": "test/framework/src/main/java/org/elasticsearch/cluster/coordination/AbstractCoordinatorTestCase.java", "diffHunk": "@@ -740,12 +742,14 @@ public void close() {\n                     if (oldState.nodeEnvironment != null) {\n                         nodeEnvironment = oldState.nodeEnvironment;\n                         final MetaData updatedMetaData = adaptGlobalMetaData.apply(oldState.getLastAcceptedState().metaData());\n-                        if (updatedMetaData != oldState.getLastAcceptedState().metaData()) {\n-                            throw new AssertionError(\"TODO adapting persistent metadata is not supported yet\");\n-                        }\n                         final long updatedTerm = adaptCurrentTerm.apply(oldState.getCurrentTerm());\n-                        if (updatedTerm != oldState.getCurrentTerm()) {\n-                            throw new AssertionError(\"TODO adapting persistent current term is not supported yet\");\n+                        if (updatedMetaData != oldState.getLastAcceptedState().metaData() || updatedTerm != oldState.getCurrentTerm()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f695669393f94056f9b79b4b7152a0fd6541fe83"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5ODE4NDE2", "url": "https://github.com/elastic/elasticsearch/pull/50639#pullrequestreview-339818416", "createdAt": "2020-01-08T12:00:03Z", "commit": {"oid": "f695669393f94056f9b79b4b7152a0fd6541fe83"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjowMDowM1rOFbU0sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjowNDo0MFrOFbU6bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE5NzA0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static void deleteAll(Path[] dataPaths) throws IOException {\n          \n          \n            \n                /**\n          \n          \n            \n                 * Remove all persisted cluster states from the given data paths, for use in tests. Should only be called when there is no open\n          \n          \n            \n                 * {@link Writer} on these paths.\n          \n          \n            \n                 */\n          \n          \n            \n                public static void deleteAll(Path[] dataPaths) throws IOException {", "url": "https://github.com/elastic/elasticsearch/pull/50639#discussion_r364197041", "createdAt": "2020-01-08T12:00:03Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/gateway/PersistedClusterStateService.java", "diffHunk": "@@ -177,6 +178,12 @@ public Writer createWriter() throws IOException {\n         return new Writer(metaDataIndexWriters, nodeId, bigArrays);\n     }\n \n+    public static void deleteAll(Path[] dataPaths) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f695669393f94056f9b79b4b7152a0fd6541fe83"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE5ODUwOQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/50639#discussion_r364198509", "createdAt": "2020-01-08T12:04:40Z", "author": {"login": "DaveCTurner"}, "path": "test/framework/src/main/java/org/elasticsearch/cluster/coordination/AbstractCoordinatorTestCase.java", "diffHunk": "@@ -740,12 +742,14 @@ public void close() {\n                     if (oldState.nodeEnvironment != null) {\n                         nodeEnvironment = oldState.nodeEnvironment;\n                         final MetaData updatedMetaData = adaptGlobalMetaData.apply(oldState.getLastAcceptedState().metaData());\n-                        if (updatedMetaData != oldState.getLastAcceptedState().metaData()) {\n-                            throw new AssertionError(\"TODO adapting persistent metadata is not supported yet\");\n-                        }\n                         final long updatedTerm = adaptCurrentTerm.apply(oldState.getCurrentTerm());\n-                        if (updatedTerm != oldState.getCurrentTerm()) {\n-                            throw new AssertionError(\"TODO adapting persistent current term is not supported yet\");\n+                        if (updatedMetaData != oldState.getLastAcceptedState().metaData() || updatedTerm != oldState.getCurrentTerm()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIwNDU1MQ=="}, "originalCommit": {"oid": "f695669393f94056f9b79b4b7152a0fd6541fe83"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94aff6968e2c31ffd26809c67055c2943a34be8c", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/94aff6968e2c31ffd26809c67055c2943a34be8c", "committedDate": "2020-01-08T13:00:16Z", "message": "Update server/src/main/java/org/elasticsearch/gateway/PersistedClusterStateService.java\r\n\r\njavadoc\n\nCo-Authored-By: David Turner <david.turner@elastic.co>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3827, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}