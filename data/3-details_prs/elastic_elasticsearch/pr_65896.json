{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNjMyMjMx", "number": 65896, "title": "Add minimum compatibility version to SearchRequest", "bodyText": "Adds a minimum version request parameter to SearchRequest. The minimum version helps failing a request if any shards involved in the search do not meet the compatibility requirements (all shards need to have a version equal or later than the minimum version provided).\nRelates to #63304.", "createdAt": "2020-12-04T16:12:50Z", "url": "https://github.com/elastic/elasticsearch/pull/65896", "merged": true, "mergeCommit": {"oid": "e3386e155c2e3702e272a11d7d46c3367c17a9cd"}, "closed": true, "closedAt": "2021-01-12T22:50:31Z", "author": {"login": "astefan"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi6C6SAH2gAyNTMyNjMyMjMxOjFjNDFhOWMwN2I3NjQwOTAyNjBiODI2NzdkYmI1NTAzZGJkZWQxYTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdviXRYAH2gAyNTMyNjMyMjMxOjZlYWRiZGUyNzZjYzI4YmFiOGVhYmUzMGNkYzA2Zjk1Yjg3NzUxZDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c41a9c07b764090260b82677dbb5503dbded1a3", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c41a9c07b764090260b82677dbb5503dbded1a3", "committedDate": "2020-12-04T16:08:20Z", "message": "Adds a minimum version parameter to the SearchRequest, not exposed\nto REST. The minimum version helps failing a request if any shards\ninvolved in the search do not meet the compatibility requirements\n(all shards need to have a version equal or later than the minimum\nversion provided)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MzMzMjky", "url": "https://github.com/elastic/elasticsearch/pull/65896#pullrequestreview-546333292", "createdAt": "2020-12-07T16:45:13Z", "commit": {"oid": "1c41a9c07b764090260b82677dbb5503dbded1a3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNjo0NToxM1rOIAv-TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNjo0OTo0NlrOIAwMow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY1NjkwOQ==", "bodyText": "Can you move this to AbstractSearchAsyncAction#getConnection ?  There's nothing that prevents to check the version there.", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r537656909", "createdAt": "2020-12-07T16:45:13Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java", "diffHunk": "@@ -80,7 +84,11 @@ protected void executePhaseOnShard(final SearchShardIterator shardIt,\n                                        final SearchShardTarget shard,\n                                        final SearchActionListener<SearchPhaseResult> listener) {\n         ShardSearchRequest request = rewriteShardSearchRequest(super.buildShardSearchRequest(shardIt));\n-        getSearchTransport().sendExecuteQuery(getConnection(shard.getClusterAlias(), shard.getNodeId()), request, getTask(), listener);\n+        Transport.Connection conn = getConnection(shard.getClusterAlias(), shard.getNodeId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c41a9c07b764090260b82677dbb5503dbded1a3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY1Nzc0MQ==", "bodyText": "conn can be null too so you'll need to handle this case.", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r537657741", "createdAt": "2020-12-07T16:46:20Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java", "diffHunk": "@@ -80,7 +84,11 @@ protected void executePhaseOnShard(final SearchShardIterator shardIt,\n                                        final SearchShardTarget shard,\n                                        final SearchActionListener<SearchPhaseResult> listener) {\n         ShardSearchRequest request = rewriteShardSearchRequest(super.buildShardSearchRequest(shardIt));\n-        getSearchTransport().sendExecuteQuery(getConnection(shard.getClusterAlias(), shard.getNodeId()), request, getTask(), listener);\n+        Transport.Connection conn = getConnection(shard.getClusterAlias(), shard.getNodeId());\n+        if (minVersion != null && conn.getVersion().before(minVersion)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c41a9c07b764090260b82677dbb5503dbded1a3"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY1ODg1MQ==", "bodyText": "You need to start with 8.0.0 and adapt the checks after the backport", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r537658851", "createdAt": "2020-12-07T16:47:35Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchRequest.java", "diffHunk": "@@ -214,6 +226,9 @@ public SearchRequest(StreamInput in) throws IOException {\n             finalReduce = true;\n         }\n         ccsMinimizeRoundtrips = in.readBoolean();\n+        if (in.getVersion().onOrAfter(Version.V_7_11_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c41a9c07b764090260b82677dbb5503dbded1a3"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY1ODk0NA==", "bodyText": "same here", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r537658944", "createdAt": "2020-12-07T16:47:42Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchRequest.java", "diffHunk": "@@ -241,7 +256,9 @@ public void writeTo(StreamOutput out) throws IOException {\n             out.writeBoolean(finalReduce);\n         }\n         out.writeBoolean(ccsMinimizeRoundtrips);\n-\n+        if (out.getVersion().onOrAfter(Version.V_7_11_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c41a9c07b764090260b82677dbb5503dbded1a3"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY1OTk3OQ==", "bodyText": "You don't need to check the minimum version if it's equal to the minimum compatible version (default value).", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r537659979", "createdAt": "2020-12-07T16:49:03Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java", "diffHunk": "@@ -210,6 +210,10 @@ public final void run() {\n                     throw new SearchPhaseExecutionException(getName(), msg, null, ShardSearchFailure.EMPTY_ARRAY);\n                 }\n             }\n+            if (checkMinimumVersion(shardsIts) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c41a9c07b764090260b82677dbb5503dbded1a3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2MDU3OQ==", "bodyText": "For now it's just a 8.0.0 exception, you'll need to adapt the version after the backport", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r537660579", "createdAt": "2020-12-07T16:49:46Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/ElasticsearchException.java", "diffHunk": "@@ -1047,7 +1047,12 @@ public String toString() {\n                 org.elasticsearch.transport.NoSeedNodeLeftException.class,\n                 org.elasticsearch.transport.NoSeedNodeLeftException::new,\n                 160,\n-                Version.V_7_10_0);\n+                Version.V_7_10_0),\n+        VERSION_MISMATCH_EXCEPTION(\n+                org.elasticsearch.action.search.VersionMismatchException.class,\n+                org.elasticsearch.action.search.VersionMismatchException::new,\n+                161,\n+                Version.V_7_11_0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c41a9c07b764090260b82677dbb5503dbded1a3"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bcb4aad4ed2c63f3fe23017da5fdd6b3bb9df88", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/2bcb4aad4ed2c63f3fe23017da5fdd6b3bb9df88", "committedDate": "2020-12-07T23:02:03Z", "message": "Address reviews"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df89dccf95b0a5a1ed20b66f627ff32459b0b492", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/df89dccf95b0a5a1ed20b66f627ff32459b0b492", "committedDate": "2020-12-07T23:07:58Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 63304_part1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5410f2612ff331afa3c06fc9ca96afa40899072a", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/5410f2612ff331afa3c06fc9ca96afa40899072a", "committedDate": "2020-12-08T00:15:47Z", "message": "Adjustment after merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2ODk1NTA1", "url": "https://github.com/elastic/elasticsearch/pull/65896#pullrequestreview-546895505", "createdAt": "2020-12-08T09:01:56Z", "commit": {"oid": "5410f2612ff331afa3c06fc9ca96afa40899072a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTowMTo1NlrOIBObaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOToxNDo0N1rOIBO-1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE1NTg4MA==", "bodyText": "You could reuse the subSearchRequest above and just add a nullable minCompatibleShardNode argument ? That makes sense to me because we need to set ccsMinimizeRoundtrips to false there too and these sub search requests are meant for internal use (using the transport client only).\nShould we add also a check that the min version is greater or equals than the minimum compatibility version ?", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r538155880", "createdAt": "2020-12-08T09:01:56Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchRequest.java", "diffHunk": "@@ -157,6 +159,16 @@ static SearchRequest subSearchRequest(SearchRequest originalSearchRequest, Strin\n         return new SearchRequest(originalSearchRequest, indices, clusterAlias, absoluteStartMillis, finalReduce);\n     }\n \n+    public static SearchRequest withMinimumVersion(SearchRequest searchRequest, Version minVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5410f2612ff331afa3c06fc9ca96afa40899072a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE1ODI1Mg==", "bodyText": "We should also ensure that ccsMinimizeRoundtrips is set to false, otherwise the check will not be applied on the remote cluster. We can force the value here searchRequest.cssMinimizeRountrips(false) but we should also verify the final value in SearchRequest#validate.", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r538158252", "createdAt": "2020-12-08T09:05:20Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchRequest.java", "diffHunk": "@@ -157,6 +159,16 @@ static SearchRequest subSearchRequest(SearchRequest originalSearchRequest, Strin\n         return new SearchRequest(originalSearchRequest, indices, clusterAlias, absoluteStartMillis, finalReduce);\n     }\n \n+    public static SearchRequest withMinimumVersion(SearchRequest searchRequest, Version minVersion) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE1NTg4MA=="}, "originalCommit": {"oid": "5410f2612ff331afa3c06fc9ca96afa40899072a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE2NDk0OQ==", "bodyText": "Maybe rename to something more explicit: minCompatibleShardNode ?", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r538164949", "createdAt": "2020-12-08T09:14:47Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchRequest.java", "diffHunk": "@@ -319,6 +336,9 @@ long getAbsoluteStartMillis() {\n         return absoluteStartMillis;\n     }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5410f2612ff331afa3c06fc9ca96afa40899072a"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "137c089c279992563141f6e8ec00d31c9c21e160", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/137c089c279992563141f6e8ec00d31c9c21e160", "committedDate": "2021-01-04T13:29:03Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 63304_part1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c262054708d2ed0b343a0b15b7aa91731c1e6d9c", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/c262054708d2ed0b343a0b15b7aa91731c1e6d9c", "committedDate": "2021-01-04T13:31:58Z", "message": "Add min_compatible_shard_node as request parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c6ab18b46496268a40562f729fa25f970964c94", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c6ab18b46496268a40562f729fa25f970964c94", "committedDate": "2021-01-04T16:16:26Z", "message": "Small fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTgxMzky", "url": "https://github.com/elastic/elasticsearch/pull/65896#pullrequestreview-561181392", "createdAt": "2021-01-04T16:52:44Z", "commit": {"oid": "7c6ab18b46496268a40562f729fa25f970964c94"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNjo1Mjo0NFrOIN5I-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxNjo1Mjo0NFrOIN5I-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQzODU4Nw==", "bodyText": "Should we switch to a Boolean with a default value of null ? This way we can decide the default value depending on whether the minCompatibleShardNode is set or not ? It feels wrong that you have to explicitly disable this option when using minCompatibleShardNode. It should be done automatically unless the user sets the ccsMinimizeRoundtrips value explicitly.", "url": "https://github.com/elastic/elasticsearch/pull/65896#discussion_r551438587", "createdAt": "2021-01-04T16:52:44Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchRequest.java", "diffHunk": "@@ -97,6 +97,9 @@\n \n     private boolean ccsMinimizeRoundtrips = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c6ab18b46496268a40562f729fa25f970964c94"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e677515ac8434089adb584b68a078d695be7e3c3", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/e677515ac8434089adb584b68a078d695be7e3c3", "committedDate": "2021-01-05T15:31:49Z", "message": "Address reviews"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e85c0b53d39180dba1c13b0b143cb13100830846", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/e85c0b53d39180dba1c13b0b143cb13100830846", "committedDate": "2021-01-05T16:11:09Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 63304_part1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMzAxOTc3", "url": "https://github.com/elastic/elasticsearch/pull/65896#pullrequestreview-563301977", "createdAt": "2021-01-07T08:46:56Z", "commit": {"oid": "e85c0b53d39180dba1c13b0b143cb13100830846"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a9a919757489493fc98b87b89d1bdbfeb5072b0", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a9a919757489493fc98b87b89d1bdbfeb5072b0", "committedDate": "2021-01-12T17:07:45Z", "message": "Differentiate between pre 7.12.0 mixed version cluster tests and post."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1acef2ca2f3c267959ae75df1e06f3952087b18", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/b1acef2ca2f3c267959ae75df1e06f3952087b18", "committedDate": "2021-01-12T17:15:20Z", "message": "Disable bwc tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ef1cd093a77524cd3c50da4957056e92d73d8aa", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ef1cd093a77524cd3c50da4957056e92d73d8aa", "committedDate": "2021-01-12T17:15:52Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 63304_part1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d51a352fd7cdad48f561b17ae6ab89bee88b9094", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/d51a352fd7cdad48f561b17ae6ab89bee88b9094", "committedDate": "2021-01-12T17:39:13Z", "message": "Re-enable bwc tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54365b78becf3f0431b4e6e723f4c65adb867469", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/54365b78becf3f0431b4e6e723f4c65adb867469", "committedDate": "2021-01-12T21:53:23Z", "message": "Just to please the bwc checks, since the code is not in 7.x yet,\nuse 8.0.0 as the version to test against."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eadbde276cc28bab8eabe30cdc06f95b87751d4", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/6eadbde276cc28bab8eabe30cdc06f95b87751d4", "committedDate": "2021-01-12T21:53:52Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 63304_part1"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3995, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}