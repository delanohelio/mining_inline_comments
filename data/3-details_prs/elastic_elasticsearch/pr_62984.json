{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NDA1MjM4", "number": 62984, "title": "System index auto-creation should not be disabled by user settings", "bodyText": "By default, Elasticsearch auto-creates indices when a document is submitted to a non-existent index. There is a setting that allows users to disable this behavior. However, this setting should not apply to system indices, so that Elasticsearch modules and plugins are able to use auto-create behavior whether or not it is exposed to users.\nThis commit constructs the AutoCreateIndex object with a reference to the SystemIndices object so that we bypass the check for the user-facing autocreate setting when it's a system index that is being autocreated.\nWe also modify the logic in TransportBulkAction to make sure that if a system index is included in a bulk request, we don't skip the autocreation step.\nCloses #61642\nNote that this PR touches the same code as #61858, which should probably be merged first.\nTodo:\n\n write additional tests?", "createdAt": "2020-09-28T21:13:00Z", "url": "https://github.com/elastic/elasticsearch/pull/62984", "merged": true, "mergeCommit": {"oid": "5f7a15168f61299447dffa1564811ef8c5022027"}, "closed": true, "closedAt": "2020-10-01T18:17:31Z", "author": {"login": "williamrandolph"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNaCyxAH2gAyNDk0NDA1MjM4Ojg3MmFmMmU4Zjc2MzA0NDNkZWJhOTVkYzNhYTk1NTE4NmEwZGU2ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOU9owAFqTUwMDU3NDcwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "872af2e8f7630443deba95dc3aa955186a0de688", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/872af2e8f7630443deba95dc3aa955186a0de688", "committedDate": "2020-09-28T20:58:50Z", "message": "Add System Indices check to AutoCreateIndex\n\nBy default, Elasticsearch auto-creates indices when a document is\nsubmitted to a non-existent index. There is a setting that allows users\nto disable this behavior. However, this setting should not apply to\nsystem indices, so that Elasticsearch modules and plugins are able to\nuse auto-create behavior whether or not it is exposed to users.\n\nThis commit constructs the AutoCreateIndex object with a reference to\nthe SystemIndices object so that we bypass the check for the user-facing\nautocreate setting when it's a system index that is being autocreated.\n\nWe also modify the logic in TransportBulkAction to make sure that if a\nsystem index is included in a bulk request, we don't skip the\nautocreation step."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "339124729be2d4dc919fda12c818dd1286b86285", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/339124729be2d4dc919fda12c818dd1286b86285", "committedDate": "2020-09-29T15:18:43Z", "message": "Make sure to use system indices when constructing autocreateindex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c906cfeade7063c8d115bb800d0377530edd0ee", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c906cfeade7063c8d115bb800d0377530edd0ee", "committedDate": "2020-09-29T16:10:36Z", "message": "Refactor duplicated logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4Nzk4NzU1", "url": "https://github.com/elastic/elasticsearch/pull/62984#pullrequestreview-498798755", "createdAt": "2020-09-29T19:10:24Z", "commit": {"oid": "7c906cfeade7063c8d115bb800d0377530edd0ee"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxOToxMDoyNFrOHZ86PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxOTozMTowM1rOHZ-A4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3NDM5Ng==", "bodyText": "Nitpick: I'd recommend changing the name some something like .test-system-index, just to make it a bit more immediately obvious what's going on rather than using a generic .foo here because this is shared across tests.", "url": "https://github.com/elastic/elasticsearch/pull/62984#discussion_r496974396", "createdAt": "2020-09-29T19:10:24Z", "author": {"login": "gwbrown"}, "path": "server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java", "diffHunk": "@@ -201,8 +210,9 @@ private static ClusterState buildClusterState(String... indices) {\n     }\n \n     private AutoCreateIndex newAutoCreateIndex(Settings settings) {\n+        SystemIndices systemIndices = new SystemIndices(Map.of(\"plugin\", List.of(new SystemIndexDescriptor(\".foo\", \"\"))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c906cfeade7063c8d115bb800d0377530edd0ee"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk3ODg0NQ==", "bodyText": "You've already noted in this in the PR description, but this is going to conflict with https://github.com/elastic/elasticsearch/pull/61858/files?file-filters%5B%5D=.java#diff-7c2a294c3d25c427072ee6c64983b560L227 specifically. I think this is the only place they'll meaningfully conflict, though.", "url": "https://github.com/elastic/elasticsearch/pull/62984#discussion_r496978845", "createdAt": "2020-09-29T19:15:35Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -224,7 +224,9 @@ protected void doInternalExecute(Task task, BulkRequest bulkRequest, String exec\n             return;\n         }\n \n-        if (needToCheck()) {\n+        final boolean includesSystem = includesSystem(bulkRequest, clusterService.state().metadata().getIndicesLookup(), systemIndices);\n+\n+        if (includesSystem || needToCheck()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c906cfeade7063c8d115bb800d0377530edd0ee"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk5MjQ4MQ==", "bodyText": "Another good unit test would be a pattern specifically excluding the system index, e.g. action.auto_create_index=*,-.foo. We still want system indices to be auto-created in that case, I think, and it would be good to double check.", "url": "https://github.com/elastic/elasticsearch/pull/62984#discussion_r496992481", "createdAt": "2020-09-29T19:31:03Z", "author": {"login": "gwbrown"}, "path": "server/src/test/java/org/elasticsearch/action/support/AutoCreateIndexTests.java", "diffHunk": "@@ -89,6 +91,12 @@ public void testAutoCreationDisabled() {\n         assertEquals(\"no such index [\" + randomIndex + \"] and [action.auto_create_index] is [false]\", e.getMessage());\n     }\n \n+    public void testSystemIndexWithAutoCreationDisabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c906cfeade7063c8d115bb800d0377530edd0ee"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cac0e245c666aac693ac70325c5bffc1410a75de", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/cac0e245c666aac693ac70325c5bffc1410a75de", "committedDate": "2020-09-30T11:12:19Z", "message": "Rename shared test index for clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "288822f3234d88cc5380eb02fb6952e8c853309e", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/288822f3234d88cc5380eb02fb6952e8c853309e", "committedDate": "2020-09-30T20:20:43Z", "message": "Auto-create disable pattern shouldn't apply to system index"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNTc0NzA3", "url": "https://github.com/elastic/elasticsearch/pull/62984#pullrequestreview-500574707", "createdAt": "2020-10-01T17:37:36Z", "commit": {"oid": "288822f3234d88cc5380eb02fb6952e8c853309e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4506, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}