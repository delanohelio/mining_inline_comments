{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NzUyOTYz", "number": 57319, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMTo1NjozM1rOEAsHaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo0NTo0N1rOECPO5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MTU4MjQ4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/qa/server/security/with-ssl/build.gradle", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMTo1NjozM1rOGcII1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwNjo1NToxM1rOGcQ3fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0NjY0NA==", "bodyText": "Won't this aggressively realize all tasks? I think we need configureEach?", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r432146644", "createdAt": "2020-05-28T21:56:33Z", "author": {"login": "rjernst"}, "path": "x-pack/plugin/sql/qa/server/security/with-ssl/build.gradle", "diffHunk": "@@ -148,6 +29,29 @@ integTest.runner {\n   }\n }\n \n+\n+// location of generated keystores and certificates\n+File keystoreDir = new File(project.buildDir, 'keystore')\n+\n+// Generate the node's keystore\n+File nodeKeystore = file(\"$keystoreDir/test-node.jks\")\n+\n+// Generate the client's keystore\n+File clientKeyStore = file(\"$keystoreDir/test-client.jks\")\n+\n+tasks.register(\"resolveKeyStores\") {\n+  inputs.files(configurations.nodeKeystores)\n+  inputs.files(configurations.clientKeyStores)\n+  doLast {\n+    Files.copy(nodeKeystores.files.singleFile.toPath(), nodeKeystore.toPath())\n+    Files.copy(clientKeyStores.files.singleFile.toPath(), clientKeyStore.toPath())\n+  }\n+}\n+\n+tasks.withType(org.elasticsearch.gradle.testclusters.TestClustersAware){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a24883f3aa557ec0d23a2c91d85f1df0f309f6dd"}, "originalPosition": 176}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjI4OTY2Mw==", "bodyText": "good catch. \ud83d\udc40 . Fixed", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r432289663", "createdAt": "2020-05-29T06:55:13Z", "author": {"login": "breskeby"}, "path": "x-pack/plugin/sql/qa/server/security/with-ssl/build.gradle", "diffHunk": "@@ -148,6 +29,29 @@ integTest.runner {\n   }\n }\n \n+\n+// location of generated keystores and certificates\n+File keystoreDir = new File(project.buildDir, 'keystore')\n+\n+// Generate the node's keystore\n+File nodeKeystore = file(\"$keystoreDir/test-node.jks\")\n+\n+// Generate the client's keystore\n+File clientKeyStore = file(\"$keystoreDir/test-client.jks\")\n+\n+tasks.register(\"resolveKeyStores\") {\n+  inputs.files(configurations.nodeKeystores)\n+  inputs.files(configurations.clientKeyStores)\n+  doLast {\n+    Files.copy(nodeKeystores.files.singleFile.toPath(), nodeKeystore.toPath())\n+    Files.copy(clientKeyStores.files.singleFile.toPath(), clientKeyStore.toPath())\n+  }\n+}\n+\n+tasks.withType(org.elasticsearch.gradle.testclusters.TestClustersAware){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE0NjY0NA=="}, "originalCommit": {"oid": "a24883f3aa557ec0d23a2c91d85f1df0f309f6dd"}, "originalPosition": 176}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNTk5Njc1OnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODo1ODowM1rOGeSkSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjozOTowMlrOGekWWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQxNDY2NA==", "bodyText": "Alternatively, We could reuse the buildResources task. I have no strong opinion but my thinking of using a new task here is to detangle this logic from other uses of  buildResources within the elasticsearch build logic.", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434414664", "createdAt": "2020-06-03T08:58:03Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaPlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51d752d5bc77c6b5470ef166891463ed41ade17a"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwNjAxMQ==", "bodyText": "Yes. In fact, @rjernst's recent work has removed that global task in favor of individual per-plugin tasks so this is the correct approach going forward.", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434706011", "createdAt": "2020-06-03T16:39:02Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaPlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQxNDY2NA=="}, "originalCommit": {"oid": "51d752d5bc77c6b5470ef166891463ed41ade17a"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNjc2NTAwOnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMjo0NjowM1rOGeaJsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDoxOToxMlrOGeeGkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzODkzMA==", "bodyText": "nit: It doesn't really matter but can we rename the suffices to crt instead ?", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434538930", "createdAt": "2020-06-03T12:46:03Z", "author": {"login": "jkakavas"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwMzY2Nw==", "bodyText": "done", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434603667", "createdAt": "2020-06-03T14:19:12Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUzODkzMA=="}, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNjc5NzQ2OnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMjo1NDo0MFrOGead6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDo0NDozMVrOGefQ8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0NDEwNg==", "bodyText": "Can we also get the private keys into test/ssl/test-X.pem ? In general , given the applicability that this plugin has in so many projects in our security and core tests, I wonder if we can do a little more up front:\n\nSetup a CA key and certificate\nGenerate test-node private key and certificate signed by that CA\nGenerate test-client private key and certificate signed by that CA\nMake all the above available as PEM files ( x.crt and x.key ) and in JKS / PKCS12 keystores\nCopy all of them as extra config files", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434544106", "createdAt": "2020-06-03T12:54:40Z", "author": {"login": "jkakavas"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.cert\");\n+                t.copy(\"test/ssl/test-node.jks\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNzU5Ng==", "bodyText": "@jkakavas I think we should be able to do that. Can you raise a separate issue for this? I'd like to keep this PR small and focussed.", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434607596", "createdAt": "2020-06-03T14:24:16Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.cert\");\n+                t.copy(\"test/ssl/test-node.jks\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0NDEwNg=="}, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMjcwNg==", "bodyText": "raised #57606", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434622706", "createdAt": "2020-06-03T14:44:31Z", "author": {"login": "jkakavas"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.cert\");\n+                t.copy(\"test/ssl/test-node.jks\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0NDEwNg=="}, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNjgwMDAzOnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMjo1NToxOVrOGeafpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDoxODoxMFrOGeeDqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0NDU1MQ==", "bodyText": "Can I override/overwrite this in the build.gradle file of a subproject where I use this new plugin ?", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434544551", "createdAt": "2020-06-03T12:55:19Z", "author": {"login": "jkakavas"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.cert\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)\n+                .configureEach(clusterAware -> clusterAware.dependsOn(exportKeyStore));\n+\n+            // Tell the tests we're running with ssl enabled\n+            project.getTasks()\n+                .withType(RestIntegTestTask.class)\n+                .configureEach(integTest -> integTest.runner.systemProperty(\"tests.ssl.enabled\", \"true\"));\n+        });\n+\n+        project.getPlugins().withType(TestClustersPlugin.class).configureEach(clustersPlugin -> {\n+            File keystoreDir = new File(project.getBuildDir(), \"keystore/test/ssl\");\n+            File nodeKeystore = new File(keystoreDir, \"test-node.jks\");\n+            File clientKeyStore = new File(keystoreDir, \"test-client.jks\");\n+            NamedDomainObjectContainer<ElasticsearchCluster> clusters = (NamedDomainObjectContainer<ElasticsearchCluster>) project\n+                .getExtensions()\n+                .getByName(TestClustersPlugin.EXTENSION_NAME);\n+            clusters.all(c -> {\n+                // ceremony to set up ssl\n+                c.setting(\"xpack.security.transport.ssl.keystore.path\", \"test-node.jks\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwMjkyMg==", "bodyText": "yes, you can override them in the build script after applying the plugin", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434602922", "createdAt": "2020-06-03T14:18:10Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.cert\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)\n+                .configureEach(clusterAware -> clusterAware.dependsOn(exportKeyStore));\n+\n+            // Tell the tests we're running with ssl enabled\n+            project.getTasks()\n+                .withType(RestIntegTestTask.class)\n+                .configureEach(integTest -> integTest.runner.systemProperty(\"tests.ssl.enabled\", \"true\"));\n+        });\n+\n+        project.getPlugins().withType(TestClustersPlugin.class).configureEach(clustersPlugin -> {\n+            File keystoreDir = new File(project.getBuildDir(), \"keystore/test/ssl\");\n+            File nodeKeystore = new File(keystoreDir, \"test-node.jks\");\n+            File clientKeyStore = new File(keystoreDir, \"test-client.jks\");\n+            NamedDomainObjectContainer<ElasticsearchCluster> clusters = (NamedDomainObjectContainer<ElasticsearchCluster>) project\n+                .getExtensions()\n+                .getByName(TestClustersPlugin.EXTENSION_NAME);\n+            clusters.all(c -> {\n+                // ceremony to set up ssl\n+                c.setting(\"xpack.security.transport.ssl.keystore.path\", \"test-node.jks\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0NDU1MQ=="}, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNjgwODMxOnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/resources/test/ssl/README.md", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMjo1NzoyN1rOGealFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDozNjo1MlrOGee7jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0NTk0MQ==", "bodyText": "I think we can go with something closer to 10 years here instead of 2. We don't gain anything by shorter lifetime. Maybe also add a note in the README with the date these certificates expire so that is more probable someone catches this and updates them before they expire and tests start failing?", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434545941", "createdAt": "2020-06-03T12:57:27Z", "author": {"login": "jkakavas"}, "path": "buildSrc/src/main/resources/test/ssl/README.md", "diffHunk": "@@ -0,0 +1,19 @@\n+This directory contains test certificates used for testing ssl handling.\n+\n+These keystores and certificates can be used via applying the `elasticsearch.test-with-ssl` plugin.\n+\n+The certificates are generated using catch-all SAN in the following procedure:\n+\n+1. Generate the node's keystore:\n+   `keytool -genkey -alias test-node -keystore test-node.jks -keyalg RSA -keysize 2048 -validity 712 -dname CN=\"Elasticsearch Build Test Infrastructure\" -keypass keypass -storepass keypass -ext san=dns:localhost,dns:localhost.localdomain,dns:localhost4,dns:localhost4.localdomain4,dns:localhost6,dns:localhost6.localdomain6,ip:127.0.0.1,ip:0:0:0:0:0:0:0:1`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYxNzIzMA==", "bodyText": "done", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434617230", "createdAt": "2020-06-03T14:36:52Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/resources/test/ssl/README.md", "diffHunk": "@@ -0,0 +1,19 @@\n+This directory contains test certificates used for testing ssl handling.\n+\n+These keystores and certificates can be used via applying the `elasticsearch.test-with-ssl` plugin.\n+\n+The certificates are generated using catch-all SAN in the following procedure:\n+\n+1. Generate the node's keystore:\n+   `keytool -genkey -alias test-node -keystore test-node.jks -keyalg RSA -keysize 2048 -validity 712 -dname CN=\"Elasticsearch Build Test Infrastructure\" -keypass keypass -storepass keypass -ext san=dns:localhost,dns:localhost.localdomain,dns:localhost4,dns:localhost4.localdomain4,dns:localhost6,dns:localhost6.localdomain6,ip:127.0.0.1,ip:0:0:0:0:0:0:0:1`", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0NTk0MQ=="}, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNjgyODA5OnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMzowMjo1MFrOGeax5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDo0MjozOVrOGefL1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0OTIyMQ==", "bodyText": "Could we also have a conditional here that if we are inFipsJvm() it would use key and certificate PEM files to set up TLS instead of keystores so that it can work even when the subproject that uses this plugin is running tests in fips mode ? i.e.\n*.ssl.key\n*.ssl.secure_key_passphrase\n*.ssl.certificate\n\ninstead of\n*.ssl.keystore.path\n*.ssl.keystore.secure_password\n\nand\n*.ssl.certificate_authorities\n\ninstead of\n*.ssl.keystore.path\n\nor\n*.ssl.truststore.path", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434549221", "createdAt": "2020-06-03T13:02:50Z", "author": {"login": "jkakavas"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.cert\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)\n+                .configureEach(clusterAware -> clusterAware.dependsOn(exportKeyStore));\n+\n+            // Tell the tests we're running with ssl enabled\n+            project.getTasks()\n+                .withType(RestIntegTestTask.class)\n+                .configureEach(integTest -> integTest.runner.systemProperty(\"tests.ssl.enabled\", \"true\"));\n+        });\n+\n+        project.getPlugins().withType(TestClustersPlugin.class).configureEach(clustersPlugin -> {\n+            File keystoreDir = new File(project.getBuildDir(), \"keystore/test/ssl\");\n+            File nodeKeystore = new File(keystoreDir, \"test-node.jks\");\n+            File clientKeyStore = new File(keystoreDir, \"test-client.jks\");\n+            NamedDomainObjectContainer<ElasticsearchCluster> clusters = (NamedDomainObjectContainer<ElasticsearchCluster>) project\n+                .getExtensions()\n+                .getByName(TestClustersPlugin.EXTENSION_NAME);\n+            clusters.all(c -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwODg1Nw==", "bodyText": "@jkakavas same as above. Would like to tackle this in a separate story", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434608857", "createdAt": "2020-06-03T14:25:56Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.cert\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)\n+                .configureEach(clusterAware -> clusterAware.dependsOn(exportKeyStore));\n+\n+            // Tell the tests we're running with ssl enabled\n+            project.getTasks()\n+                .withType(RestIntegTestTask.class)\n+                .configureEach(integTest -> integTest.runner.systemProperty(\"tests.ssl.enabled\", \"true\"));\n+        });\n+\n+        project.getPlugins().withType(TestClustersPlugin.class).configureEach(clustersPlugin -> {\n+            File keystoreDir = new File(project.getBuildDir(), \"keystore/test/ssl\");\n+            File nodeKeystore = new File(keystoreDir, \"test-node.jks\");\n+            File clientKeyStore = new File(keystoreDir, \"test-client.jks\");\n+            NamedDomainObjectContainer<ElasticsearchCluster> clusters = (NamedDomainObjectContainer<ElasticsearchCluster>) project\n+                .getExtensions()\n+                .getByName(TestClustersPlugin.EXTENSION_NAME);\n+            clusters.all(c -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0OTIyMQ=="}, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMTM5Nw==", "bodyText": "I'm fine with that as long as we don't apply this plugin to any other subproject until we have the fips handling because it will start failing in CI. ( sql is fine because we mute the tests in fips eitherway )", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434621397", "createdAt": "2020-06-03T14:42:39Z", "author": {"login": "jkakavas"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.cert\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.cert\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)\n+                .configureEach(clusterAware -> clusterAware.dependsOn(exportKeyStore));\n+\n+            // Tell the tests we're running with ssl enabled\n+            project.getTasks()\n+                .withType(RestIntegTestTask.class)\n+                .configureEach(integTest -> integTest.runner.systemProperty(\"tests.ssl.enabled\", \"true\"));\n+        });\n+\n+        project.getPlugins().withType(TestClustersPlugin.class).configureEach(clustersPlugin -> {\n+            File keystoreDir = new File(project.getBuildDir(), \"keystore/test/ssl\");\n+            File nodeKeystore = new File(keystoreDir, \"test-node.jks\");\n+            File clientKeyStore = new File(keystoreDir, \"test-client.jks\");\n+            NamedDomainObjectContainer<ElasticsearchCluster> clusters = (NamedDomainObjectContainer<ElasticsearchCluster>) project\n+                .getExtensions()\n+                .getByName(TestClustersPlugin.EXTENSION_NAME);\n+            clusters.all(c -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDU0OTIyMQ=="}, "originalCommit": {"oid": "75db1baafbad9054811f608fa545b640095799a6"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzI2NTg5OnYy", "diffSide": "RIGHT", "path": "buildSrc/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDo0MToyMVrOGefILw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDo0NzowNlrOGefYYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMDQ2Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                exclude '**/*.cert'\n          \n          \n            \n                exclude '**/*.crt'", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434620463", "createdAt": "2020-06-03T14:41:21Z", "author": {"login": "jkakavas"}, "path": "buildSrc/build.gradle", "diffHunk": "@@ -222,6 +222,8 @@ if (project != rootProject) {\n   forbiddenPatterns {\n     exclude '**/*.wav'\n     exclude '**/*.p12'\n+    exclude '**/*.jks'\n+    exclude '**/*.cert'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7782b0965f97d11685de3af80cd1673841090d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyNDYxMA==", "bodyText": "fixed", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434624610", "createdAt": "2020-06-03T14:47:06Z", "author": {"login": "breskeby"}, "path": "buildSrc/build.gradle", "diffHunk": "@@ -222,6 +222,8 @@ if (project != rootProject) {\n   forbiddenPatterns {\n     exclude '**/*.wav'\n     exclude '**/*.p12'\n+    exclude '**/*.jks'\n+    exclude '**/*.cert'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyMDQ2Mw=="}, "originalCommit": {"oid": "4a7782b0965f97d11685de3af80cd1673841090d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzgwODczOnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo0MjozOVrOGekfVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzoyMDowOVrOGel3ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwODMxMQ==", "bodyText": "How does this compare to project.getPluginManager().withPlugin()?", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434708311", "createdAt": "2020-06-03T16:42:39Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.crt\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.crt\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e7240babaea9e2125c38a8b067e379e8af86bfc"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczMDg1Mw==", "bodyText": "getPluginManager() doesn't allow configuration by plugin type (class) which I usually prefer when coding. also depending on your environment it used to be better when doing safer when refactorings etc instead of relying on plugin ids. PluginManager provides access to AppliedPlugin which we do not need here.", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434730853", "createdAt": "2020-06-03T17:20:09Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.crt\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.crt\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwODMxMQ=="}, "originalCommit": {"oid": "3e7240babaea9e2125c38a8b067e379e8af86bfc"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzgxMjMwOnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo0MzoyN1rOGekhlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzozMDowNlrOGemOkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwODg4Nw==", "bodyText": "We can use Util.getJavaTestSourceSet().", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434708887", "createdAt": "2020-06-03T16:43:27Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.crt\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.crt\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e7240babaea9e2125c38a8b067e379e8af86bfc"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczNjc4NQ==", "bodyText": "done", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434736785", "createdAt": "2020-06-03T17:30:06Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.crt\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.crt\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwODg4Nw=="}, "originalCommit": {"oid": "3e7240babaea9e2125c38a8b067e379e8af86bfc"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzgxNTc5OnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo0NDoyM1rOGekj5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzozMDoxMlrOGemOyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwOTQ3Ng==", "bodyText": "Do we have to use the fully qualified name here? Can we add an import?", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434709476", "createdAt": "2020-06-03T16:44:23Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.crt\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.crt\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e7240babaea9e2125c38a8b067e379e8af86bfc"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczNjg0Mw==", "bodyText": "done", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434736843", "createdAt": "2020-06-03T17:30:12Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.crt\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.crt\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcwOTQ3Ng=="}, "originalCommit": {"oid": "3e7240babaea9e2125c38a8b067e379e8af86bfc"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNzgyMTgzOnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNjo0NTo0N1rOGeknqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzozMTowN1rOGemQ4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcxMDQ0MA==", "bodyText": "We should instead configure all tasks of RestTestRunnerTask type. There can be instances where we create these directly w/o creating a RestIntegTestTask. Also, the latter will hopefully dissapear soon.", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434710440", "createdAt": "2020-06-03T16:45:47Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.crt\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.crt\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)\n+                .configureEach(clusterAware -> clusterAware.dependsOn(exportKeyStore));\n+\n+            // Tell the tests we're running with ssl enabled\n+            project.getTasks()\n+                .withType(RestIntegTestTask.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e7240babaea9e2125c38a8b067e379e8af86bfc"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcxMDc2NA==", "bodyText": "Also, would we not want this for unit tests as well? Or is this very specific to integration tests?", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434710764", "createdAt": "2020-06-03T16:46:19Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.crt\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.crt\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)\n+                .configureEach(clusterAware -> clusterAware.dependsOn(exportKeyStore));\n+\n+            // Tell the tests we're running with ssl enabled\n+            project.getTasks()\n+                .withType(RestIntegTestTask.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcxMDQ0MA=="}, "originalCommit": {"oid": "3e7240babaea9e2125c38a8b067e379e8af86bfc"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDczNzM3OA==", "bodyText": "changed to use RestTestRunnerTask. So far I don't think we have unit tests for this kind of testing. I don't see how this would look like tbh.", "url": "https://github.com/elastic/elasticsearch/pull/57319#discussion_r434737378", "createdAt": "2020-06-03T17:31:07Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/TestWithSslPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test;\n+\n+import org.elasticsearch.gradle.ExportElasticsearchBuildResourcesTask;\n+import org.elasticsearch.gradle.precommit.ForbiddenPatternsTask;\n+import org.elasticsearch.gradle.testclusters.ElasticsearchCluster;\n+import org.elasticsearch.gradle.testclusters.TestClustersPlugin;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.SourceSetContainer;\n+import org.gradle.api.tasks.TaskProvider;\n+\n+import java.io.File;\n+\n+public class TestWithSslPlugin implements Plugin<Project> {\n+\n+    @Override\n+    public void apply(Project project) {\n+        File keyStoreDir = new File(project.getBuildDir(), \"keystore\");\n+        TaskProvider<ExportElasticsearchBuildResourcesTask> exportKeyStore = project.getTasks()\n+            .register(\"copyTestCertificates\", ExportElasticsearchBuildResourcesTask.class, (t) -> {\n+                t.copy(\"test/ssl/test-client.crt\");\n+                t.copy(\"test/ssl/test-client.jks\");\n+                t.copy(\"test/ssl/test-node.crt\");\n+                t.copy(\"test/ssl/test-node.jks\");\n+                t.setOutputDir(keyStoreDir);\n+            });\n+\n+        project.getPlugins().withType(StandaloneRestTestPlugin.class).configureEach(restTestPlugin -> {\n+            SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+            SourceSet testSourceSet = sourceSets.getByName(\"test\");\n+            testSourceSet.getResources().srcDir(new File(keyStoreDir, \"test/ssl\"));\n+            testSourceSet.compiledBy(exportKeyStore);\n+\n+            project.getTasks()\n+                .withType(org.elasticsearch.gradle.testclusters.TestClustersAware.class)\n+                .configureEach(clusterAware -> clusterAware.dependsOn(exportKeyStore));\n+\n+            // Tell the tests we're running with ssl enabled\n+            project.getTasks()\n+                .withType(RestIntegTestTask.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDcxMDQ0MA=="}, "originalCommit": {"oid": "3e7240babaea9e2125c38a8b067e379e8af86bfc"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3864, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}