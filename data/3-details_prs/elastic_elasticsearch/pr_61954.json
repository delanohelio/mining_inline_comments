{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MjExNTAx", "number": 61954, "title": "Add snapshot only test modules", "bodyText": "This commit adds external test modules. These are modules meant for\nexternal systems to test edge cases in elasticsearch, but only within\nsnapshots. They are not meant to be used in production, so protections\nare also added from their accidental inclusion in release builds.\nNote that this commit does not actually add any new modules, it only\nadds the infrastructure for the new modules, under\ntest/external-modules.", "createdAt": "2020-09-04T02:47:11Z", "url": "https://github.com/elastic/elasticsearch/pull/61954", "merged": true, "mergeCommit": {"oid": "a56952a29915f4b515132bb8c040c9386ddda8ba"}, "closed": true, "closedAt": "2020-09-04T23:34:56Z", "author": {"login": "rjernst"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFcAJ3AH2gAyNDc5MjExNTAxOjg1MWEyZjg1MTIwNWY3MzI3NTU3YmM4OWQzNjQzNjE3NTIyNjk2YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFqa_YgH2gAyNDc5MjExNTAxOjhkOTMzNGZhYWEwOTVjM2JkM2UyY2FlYjJhOTFlM2VkODc3MGIwZjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "851a2f851205f7327557bc89d3643617522696a5", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/851a2f851205f7327557bc89d3643617522696a5", "committedDate": "2020-09-04T02:44:22Z", "message": "Add snapshot only test modules\n\nThis commit adds external test modules. These are modules meant for\nexternal systems to test edge cases in elasticsearch, but only within\nsnapshots. They are not meant to be used in production, so protections\nare also added from their accidental inclusion in release builds.\n\nNote that this commit does not actually add any new modules, it only\nadds the infrastructure for the new modules, under\n`test/external-modules`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7806f87ed510e6c81437217298c733e4196fb4b7", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/7806f87ed510e6c81437217298c733e4196fb4b7", "committedDate": "2020-09-04T02:56:00Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/ceb46cc19aec20b740407068c29f955696d69446", "committedDate": "2020-09-04T03:13:43Z", "message": "fix brokenness"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNzU3NTU2", "url": "https://github.com/elastic/elasticsearch/pull/61954#pullrequestreview-482757556", "createdAt": "2020-09-04T15:35:20Z", "commit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTozNToyMFrOHNSe2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTo0MToyMFrOHNS0bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5NjM0NQ==", "bodyText": "Why is this no longer needed?", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483696345", "createdAt": "2020-09-04T15:35:20Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java", "diffHunk": "@@ -55,32 +53,6 @@ static RestIntegTestTask setupTask(Project project, String sourceSetName) {\n     static void setupRunnerTask(Project project, RestIntegTestTask testTask, SourceSet sourceSet) {\n         testTask.setTestClassesDirs(sourceSet.getOutput().getClassesDirs());\n         testTask.setClasspath(sourceSet.getRuntimeClasspath());\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5ODc3NQ==", "bodyText": "We should open an issue to use artifact transforms for this stuff as well so we don't have to keep doing this zipTree and singleFile nonsense. This is the same as the stuff @breskeby is working on to avoid a lot of unnecessary packing/unpacking in build processes.", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483698775", "createdAt": "2020-09-04T15:38:00Z", "author": {"login": "mark-vieira"}, "path": "distribution/build.gradle", "diffHunk": "@@ -139,11 +145,22 @@ tasks.register(\"buildTransportModules\") {\n   dependsOn \"processTransportOutputs\"\n   outputs.dir \"${transportOutputs}/modules\"\n }\n+tasks.register(\"buildExternalTestModules\") {\n+  dependsOn \"processExternalTestOutputs\"\n+  outputs.dir \"${externalTestOutputs}/modules\"\n+}\n+\n+Configuration moduleZip(Project module) {\n+  Dependency dep = project.dependencies.project(path: module.path, configuration: 'zip')\n+  Configuration config = project.configurations.detachedConfiguration(dep)\n+  return config\n+}\n \n void copyModule(Sync copyTask, Project module) {\n+  Configuration moduleConfig = moduleZip(module)\n   copyTask.configure {\n-    dependsOn \"${module.path}:bundlePlugin\"\n-    from({ zipTree(module.bundlePlugin.outputs.files.singleFile) }) {\n+    dependsOn moduleConfig\n+    from({ zipTree(moduleConfig.singleFile) }) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcwMTg3MQ==", "bodyText": "Seems basing this on name is a little brittle. Is there no way to add arbitrary metadata to modules?", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483701871", "createdAt": "2020-09-04T15:41:20Z", "author": {"login": "mark-vieira"}, "path": "server/src/main/java/org/elasticsearch/plugins/PluginsService.java", "diffHunk": "@@ -367,6 +368,9 @@ private static Bundle readPluginBundle(final Set<Bundle> bundles, final Path plu\n         if (bundles.add(bundle) == false) {\n             throw new IllegalStateException(\"duplicate \" + type + \": \" + info);\n         }\n+        if (type.equals(\"module\") && info.getName().startsWith(\"test-\") && Build.CURRENT.isSnapshot() == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0245722a34959bfbf5c9fd326fc4aa901e64792", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0245722a34959bfbf5c9fd326fc4aa901e64792", "committedDate": "2020-09-04T18:28:22Z", "message": "Merge branch 'master' into build_test_modules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bec0040048b96b92276af24645f1ec1a9669059a", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/bec0040048b96b92276af24645f1ec1a9669059a", "committedDate": "2020-09-04T19:23:39Z", "message": "add back"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d9334faaa095c3bd3e2caeb2a91e3ed8770b0f9", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/8d9334faaa095c3bd3e2caeb2a91e3ed8770b0f9", "committedDate": "2020-09-04T19:32:21Z", "message": "checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4853, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}