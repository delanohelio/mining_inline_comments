{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxNzg2MjMy", "number": 65814, "title": "[ML] Simplify reverting to snapshot while datafeed is reassigning", "bodyText": "Previously, we were trying to compare that the job had gone past\nits current model snapshot in order to determine whether we\nshould perform recovery. However, this is not necessary. We can\ninstead simply always perform recovery if the opening job\nhas a running datafeed task. This greatly simplifies the code.\nRelates #65630\nFixes #65710", "createdAt": "2020-12-03T13:41:22Z", "url": "https://github.com/elastic/elasticsearch/pull/65814", "merged": true, "mergeCommit": {"oid": "0a5596bc973c7d9f09b25c033f47f43f79bf82d2"}, "closed": true, "closedAt": "2020-12-04T10:46:01Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdijUfRgH2gAyNTMxNzg2MjMyOjBmNDNiMDNlM2FlNWYxZjhmNGE5MTYxMzViYTY4NzZmZDYyZjg5ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi0ZEFAFqTU0NDc5MjM5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f43b03e3ae5f1f8f4a916135ba6876fd62f8984", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f43b03e3ae5f1f8f4a916135ba6876fd62f8984", "committedDate": "2020-12-03T13:39:43Z", "message": "[ML] Simplify reverting to snapshot while datafeed is reassigning\n\nPreviously, we were trying to compare that the job had gone past\nits current model snapshot in order to determine whether we\nshould perform recovery. However, this is not necessary. We can\ninstead simply always perform recovery if the opening job\nhas a running datafeed task. This greatly simplifies the code.\n\nRelates #65630\n\nFixes #65710"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzOTkxNTI0", "url": "https://github.com/elastic/elasticsearch/pull/65814#pullrequestreview-543991524", "createdAt": "2020-12-03T14:12:39Z", "commit": {"oid": "0f43b03e3ae5f1f8f4a916135ba6876fd62f8984"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e87b968a0bac4222536eed835d82f5cebc75b2a7", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/e87b968a0bac4222536eed835d82f5cebc75b2a7", "committedDate": "2020-12-03T15:04:58Z", "message": "Merge branch 'master' into simplify-reverting-to-snapshot-while-datafeed-is-reassigning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MDYxMDQ0", "url": "https://github.com/elastic/elasticsearch/pull/65814#pullrequestreview-544061044", "createdAt": "2020-12-03T15:18:32Z", "commit": {"oid": "e87b968a0bac4222536eed835d82f5cebc75b2a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToxODozMlrOH-hfvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNToxODozMlrOH-hfvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMyMjU1OQ==", "bodyText": "Can you change \"performing recovery\" to something like \"reverting to last good model snapshot [X]\"\nBut only if modelSnapshotId != ModelSnapshot.EMPTY_SNAPSHOT_ID", "url": "https://github.com/elastic/elasticsearch/pull/65814#discussion_r535322559", "createdAt": "2020-12-03T15:18:32Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/task/OpenJobPersistentTasksExecutor.java", "diffHunk": "@@ -200,16 +201,15 @@ private void runJob(JobTask jobTask, JobState jobState, OpenJobAction.JobParams\n             return;\n         }\n \n-        ActionListener<DatafeedContext> datafeedContextListener = ActionListener.wrap(\n-            datafeedContext -> {\n-                if (datafeedContext != null && datafeedContext.shouldRecoverFromCurrentSnapshot()) {\n-                    // This job has a datafeed attached to it and the job had advanced past the current model snapshot.\n+        ActionListener<Boolean> hasRunningDatafeedTaskListener = ActionListener.wrap(\n+            hasRunningDatafeed -> {\n+                if (hasRunningDatafeed) {\n+                    // This job has a running datafeed attached to it.\n                     // In order to prevent gaps in the model we revert to the current snapshot deleting intervening results.\n-                    ModelSnapshot modelSnapshot = datafeedContext.getModelSnapshot() == null ?\n-                        ModelSnapshot.emptySnapshot(jobTask.getJobId()) : datafeedContext.getModelSnapshot();\n-                    logger.info(\"[{}] job had advanced past its current model snapshot [{}]; performing recovery\",\n-                        jobTask.getJobId(), modelSnapshot.getSnapshotId());\n-                    revertToSnapshot(modelSnapshot, ActionListener.wrap(\n+                    String modelSnapshotId = params.getJob().getModelSnapshotId() == null ?\n+                        ModelSnapshot.EMPTY_SNAPSHOT_ID : params.getJob().getModelSnapshotId();\n+                    logger.info(\"[{}] job has running datafeed task; performing recovery\", jobTask.getJobId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e87b968a0bac4222536eed835d82f5cebc75b2a7"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09e25b6f15b8b6f2b1f6309d16fc760ed4e41f14", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/09e25b6f15b8b6f2b1f6309d16fc760ed4e41f14", "committedDate": "2020-12-03T16:10:31Z", "message": "Return when no datafeed exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a376f9a13e2cb4330cd1487e14e196e448dd3d9", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/3a376f9a13e2cb4330cd1487e14e196e448dd3d9", "committedDate": "2020-12-03T19:56:02Z", "message": "Refetch job before checking its model snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4796cb243fcbfe32cbdfa4e4b8a1e4af1d70814f", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/4796cb243fcbfe32cbdfa4e4b8a1e4af1d70814f", "committedDate": "2020-12-03T19:56:50Z", "message": "Merge branch 'master' into simplify-reverting-to-snapshot-while-datafeed-is-reassigning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9e75a417db80a457f90649e67ffdc4fe0675fe5", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9e75a417db80a457f90649e67ffdc4fe0675fe5", "committedDate": "2020-12-04T09:06:45Z", "message": "Improve log message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1208f5996fe4a39c4651b95a896c8cd2f190d82", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a1208f5996fe4a39c4651b95a896c8cd2f190d82", "committedDate": "2020-12-04T09:32:23Z", "message": "Merge branch 'master' into simplify-reverting-to-snapshot-while-datafeed-is-reassigning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NzkyMzk1", "url": "https://github.com/elastic/elasticsearch/pull/65814#pullrequestreview-544792395", "createdAt": "2020-12-04T09:33:06Z", "commit": {"oid": "a1208f5996fe4a39c4651b95a896c8cd2f190d82"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4154, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}