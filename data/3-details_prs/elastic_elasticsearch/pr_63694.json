{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNTM3Mzk2", "number": 63694, "title": "EQL: Fix translation of bool fields", "bodyText": "This commit fixes two issues in dealing with bool fields in EQL:\n\navoid simplifications of field == true expressions\nadding comparison to clauses on fields missing logic (where bool)\n\nFix #63693", "createdAt": "2020-10-14T17:41:52Z", "url": "https://github.com/elastic/elasticsearch/pull/63694", "merged": true, "mergeCommit": {"oid": "d10a5d0e842bbd4e0031834de948ceb24da3872b"}, "closed": true, "closedAt": "2020-10-15T11:22:28Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSgy5xAH2gAyNTAzNTM3Mzk2OmFiNzcyYjExYjZlOTIzNDFlMzFmZDc1MmRjNjM3ODU5MjQ0ZTk0YjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdStTYPAFqTUwOTExOTcyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ab772b11b6e92341e31fd752dc637859244e94b1", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab772b11b6e92341e31fd752dc637859244e94b1", "committedDate": "2020-10-14T17:40:26Z", "message": "EQL: Fix translation of bool fields\n\nThis commit fixes two issues in dealing with bool fields in EQL:\n- avoid simplifications of field == true expressions\n- adding comparison to clauses on fields missing logic (where bool)\n\nFix #63693"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODAyODE0", "url": "https://github.com/elastic/elasticsearch/pull/63694#pullrequestreview-508802814", "createdAt": "2020-10-14T22:05:06Z", "commit": {"oid": "ab772b11b6e92341e31fd752dc637859244e94b1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjowNTowNlrOHhnGlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQyMjowNTowNlrOHhnGlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwNTcxOA==", "bodyText": "Shouldn't this be enough? why do we need to check the top level separately?", "url": "https://github.com/elastic/elasticsearch/pull/63694#discussion_r505005718", "createdAt": "2020-10-14T22:05:06Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/optimizer/Optimizer.java", "diffHunk": "@@ -99,7 +104,34 @@ public LogicalPlan optimize(LogicalPlan verified) {\n         Batch label = new Batch(\"Set as Optimized\", Limiter.ONCE,\n                 new SetAsOptimized());\n \n-        return Arrays.asList(substitutions, operators, constraints, operators, ordering, local, label);\n+        return asList(substitutions, syntactic, operators, constraints, operators, ordering, local, label);\n+    }\n+\n+    private static class AddMissingEquals extends OptimizerRule<Filter> {\n+\n+        @Override\n+        protected LogicalPlan rule(Filter filter) {\n+            // check the condition itself\n+            Expression condition = replaceRawBoolFieldWithEquals(filter.condition());\n+            // otherwise look for binary logic\n+            if (condition == filter.condition()) {\n+                condition = condition.transformUp(b ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab772b11b6e92341e31fd752dc637859244e94b1"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MTE5NzIz", "url": "https://github.com/elastic/elasticsearch/pull/63694#pullrequestreview-509119723", "createdAt": "2020-10-15T08:06:00Z", "commit": {"oid": "ab772b11b6e92341e31fd752dc637859244e94b1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODowNjowMFrOHh5qOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODowNjowMFrOHh5qOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMwOTc1Mw==", "bodyText": "Can you add more from the actual query DSL. The fact that there is a bool must and a term with true doesn't mean the actual query is entirely correct, more like how we do it with SQL (where the entire query is checked for correctness). For term at least, there is the new parameter that Mark H. added that makes it case insensitive or not.", "url": "https://github.com/elastic/elasticsearch/pull/63694#discussion_r505309753", "createdAt": "2020-10-15T08:06:00Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/resources/queryfolder_tests.txt", "diffHunk": "@@ -145,6 +145,49 @@ process where endsWith(user_name, \"c\")\n {\"wildcard\":{\"user_name\":{\"wildcard\":\"*c\",\"boost\":1.0}}}],\"boost\":1.0}}\n ;\n \n+fieldNoEquals\n+process where bool\n+;\n+{\"bool\":{\"must\":[\n+{\"term\":{\"bool\":{\"value\":true,\n+;\n+\n+fieldNoEqualsInExpression\n+process where length(file_name) > 0 and bool\n+;\n+{\"bool\":{\"must\":[", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab772b11b6e92341e31fd752dc637859244e94b1"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3956, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}