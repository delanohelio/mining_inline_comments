{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MjY1NzIw", "number": 66112, "title": "Extend dynamic templates to make them define runtime fields", "bodyText": "Runtime fields are defined as part of the runtime section in the mappings. Dynamic templates allow to specify mappings for fields that are getting automatically created. With this change, we allow users to create dynamic under the runtime section, and optionally define their mappings.\nThe following is an example of dynamic template that matches any incoming long field as runtime field, meaning they will all be evaluated at runtime. When a script is not specified, runtime fields are loaded from a field with the same name in _source.\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n      {\n        \"long_as_runtime\": {\n          \"match_mapping_type\": \"long\",\n          \"runtime\": {\n\n          }\n        }\n      }\n    ]\n  }\n}", "createdAt": "2020-12-09T15:33:58Z", "url": "https://github.com/elastic/elasticsearch/pull/66112", "merged": true, "mergeCommit": {"oid": "616098e4417c220e5c3fb44d8cf71c76a49d2361"}, "closed": true, "closedAt": "2020-12-10T10:33:13Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkgW3ngH2gAyNTM1MjY1NzIwOmRjYmM1YzI2NTk0ZTUxYjBhMzVlODg4YmMwZDMwOTM1Y2JhOTkwMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkws2-gFqTU0OTAzMDAyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dcbc5c26594e51b0a35e888bc0d30935cba99019", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/dcbc5c26594e51b0a35e888bc0d30935cba99019", "committedDate": "2020-12-09T15:20:27Z", "message": "Extend dynamic templates to make them define runtime fields\n\nRuntime fields are defined as part of the runtime section in the mappings. Dynamic templates allow to specify mappings for fields that are getting automatically created. With this change, we allow users to create dynamic under the runtime section, and optionally define their mappings.\n\nThe following is an example of dynamic template that matches any incoming long field as runtime field, meaning they will all be evaluated at runtime. When a script is not specified, runtime fields are loaded from a field with the same name in _source.\n\n```\n{\n  \"mappings\": {\n    \"dynamic_templates\": [\n      {\n        \"long_as_runtime\": {\n          \"match_mapping_type\": \"long\",\n          \"runtime\": {\n\n          }\n        }\n      }\n    ]\n  }\n}\n```"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ec9cc87564a1a740db79b021322a382651cd0e8", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ec9cc87564a1a740db79b021322a382651cd0e8", "committedDate": "2020-12-09T16:18:10Z", "message": "Merge branch 'master' into enhancement/dynamic_templates_runtime"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTc4MjEz", "url": "https://github.com/elastic/elasticsearch/pull/66112#pullrequestreview-548578213", "createdAt": "2020-12-09T20:25:46Z", "commit": {"oid": "5ec9cc87564a1a740db79b021322a382651cd0e8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTcwODE4", "url": "https://github.com/elastic/elasticsearch/pull/66112#pullrequestreview-548970818", "createdAt": "2020-12-10T08:52:47Z", "commit": {"oid": "5ec9cc87564a1a740db79b021322a382651cd0e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwODo1Mjo0N1rOIC-C4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwODo1Mjo0N1rOIC-C4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk4NDYwOQ==", "bodyText": "In hindsight, we may want to rework the DynamicRuntimeFieldsBuilder interface that plugins have to implement for the dynamic runtime mode. Given that the notion of runtime field is added to XContentFieldType, we could tie the two together, as there is now some more subtle link between the two. I will do some more thinking around this as a follow-up", "url": "https://github.com/elastic/elasticsearch/pull/66112#discussion_r539984609", "createdAt": "2020-12-10T08:52:47Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DynamicTemplate.java", "diffHunk": "@@ -72,12 +73,8 @@ public static MatchType fromString(String value) {\n     public enum XContentFieldType {\n         OBJECT {\n             @Override\n-            public String defaultMappingType() {\n-                return ObjectMapper.CONTENT_TYPE;\n-            }\n-            @Override\n-            public String toString() {\n-                return \"object\";\n+            boolean supportsRuntimeField() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ec9cc87564a1a740db79b021322a382651cd0e8"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MDMwMDI0", "url": "https://github.com/elastic/elasticsearch/pull/66112#pullrequestreview-549030024", "createdAt": "2020-12-10T10:01:54Z", "commit": {"oid": "5ec9cc87564a1a740db79b021322a382651cd0e8"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMDowMTo1NFrOIDBB6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMDoyMjoxMVrOIDB-RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDAzMzUxNQ==", "bodyText": "++, I was thinking as I was reading this that it would be nice to move most of applyMatchingTemplate into the dynamic template itself", "url": "https://github.com/elastic/elasticsearch/pull/66112#discussion_r540033515", "createdAt": "2020-12-10T10:01:54Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DynamicTemplate.java", "diffHunk": "@@ -72,12 +73,8 @@ public static MatchType fromString(String value) {\n     public enum XContentFieldType {\n         OBJECT {\n             @Override\n-            public String defaultMappingType() {\n-                return ObjectMapper.CONTENT_TYPE;\n-            }\n-            @Override\n-            public String toString() {\n-                return \"object\";\n+            boolean supportsRuntimeField() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk4NDYwOQ=="}, "originalCommit": {"oid": "5ec9cc87564a1a740db79b021322a382651cd0e8"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA0NzM1Mg==", "bodyText": "FYI - this will clash with a test I'm adding in #66030 so depending on who gets there first one of us will need to update :)", "url": "https://github.com/elastic/elasticsearch/pull/66112#discussion_r540047352", "createdAt": "2020-12-10T10:19:57Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/TestRuntimeField.java", "diffHunk": "@@ -61,7 +61,7 @@ public Query termQuery(Object value, QueryShardContext context) {\n         @Override\n         public Map<String, Parser> getRuntimeFieldTypes() {\n             return Map.of(\n-                \"string\", (name, node, parserContext) -> new TestRuntimeField(name, \"string\"),\n+                \"keyword\", (name, node, parserContext) -> new TestRuntimeField(name, \"keyword\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ec9cc87564a1a740db79b021322a382651cd0e8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA0ODk2NQ==", "bodyText": "This all makes me think that we need to extend the XContentMapValues functions to take predicates or lambdas or something, we have a lot of repeated 'descend through json objects' code here and elsewhere.  But that can be for later, we don't need it for this PR.", "url": "https://github.com/elastic/elasticsearch/pull/66112#discussion_r540048965", "createdAt": "2020-12-10T10:22:11Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/RootObjectMapper.java", "diffHunk": "@@ -476,21 +480,21 @@ private static boolean containsSnippet(Map<?, ?> map, String snippet) {\n \n     private static boolean containsSnippet(List<?> list, String snippet) {\n         for (Object value : list) {\n-            if (value instanceof Map) {\n-                if (containsSnippet((Map<?, ?>) value, snippet)) {\n-                    return true;\n-                }\n-            } else if (value instanceof List) {\n-                if (containsSnippet((List<?>) value, snippet)) {\n-                    return true;\n-                }\n-            } else if (value instanceof String) {\n-                String valueString = (String) value;\n-                if (valueString.contains(snippet)) {\n-                    return true;\n-                }\n+            if (containsSnippet(value, snippet)) {\n+                return true;\n             }\n         }\n         return false;\n     }\n+\n+    private static boolean containsSnippet(Object value, String snippet) {\n+        if (value instanceof Map) {\n+            return containsSnippet((Map<?, ?>) value, snippet);\n+        } else if (value instanceof List) {\n+            return containsSnippet((List<?>) value, snippet);\n+        } else if (value instanceof String) {\n+            return ((String) value).contains(snippet);\n+        }\n+        return false;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ec9cc87564a1a740db79b021322a382651cd0e8"}, "originalPosition": 166}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4682, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}