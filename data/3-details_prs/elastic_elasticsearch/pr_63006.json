{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0ODIyOTE1", "number": 63006, "title": "[Transform] fix issue in TransformIndexerStateTests.testStopAtCheckpoint", "bodyText": "fix a test issue by improving counting the number of times the deferred listener is called\nfixes #62996\nNote: The test failed for a certain seed that called _stop_at_checkpoint=false all 6 times. I run this test with -Dtests.iters and could not spot another corner case", "createdAt": "2020-09-29T13:15:51Z", "url": "https://github.com/elastic/elasticsearch/pull/63006", "merged": true, "mergeCommit": {"oid": "9b9f33eeeac78115c176101cc5feb2f24ca46995"}, "closed": true, "closedAt": "2020-09-30T06:51:01Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNn7QGAH2gAyNDk0ODIyOTE1OjNhOTgwYmI5MTA3Y2UxNmFlMGRhMTJlOTUzOGMwYTMwNGE4MmZmMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNpne2gH2gAyNDk0ODIyOTE1OmZkMDNmYmY5N2U2YjU5MTdkYWM0M2EyZDFjMGYxMWZjZGRjNmYxMWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3a980bb9107ce16ae0da12e9538c0a304a82ff35", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/3a980bb9107ce16ae0da12e9538c0a304a82ff35", "committedDate": "2020-09-29T13:09:16Z", "message": "improve counting the number of times the deferred listener is called\n\nfixes #62996"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NTE2NTg0", "url": "https://github.com/elastic/elasticsearch/pull/63006#pullrequestreview-498516584", "createdAt": "2020-09-29T14:14:09Z", "commit": {"oid": "3a980bb9107ce16ae0da12e9538c0a304a82ff35"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNDoxNDowOVrOHZvXNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNDoxNDozN1rOHZvYtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1MjQzNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);\n          \n          \n            \n                            timesStopAtCheckpointChanged += (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);", "url": "https://github.com/elastic/elasticsearch/pull/63006#discussion_r496752437", "createdAt": "2020-09-29T14:14:09Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/transforms/TransformIndexerStateTests.java", "diffHunk": "@@ -412,20 +412,29 @@ public void testStopAtCheckpoint() throws Exception {\n             CountDownLatch searchLatch = indexer.createAwaitForSearchLatch(1);\n \n             List<CountDownLatch> responseLatches = new ArrayList<>();\n+            int timesStopAtCheckpointChanged = 0;\n+            // default stopAtCheckpoint is false\n+            boolean previousStopAtCheckpoint = false;\n+\n             for (int i = 0; i < 3; ++i) {\n                 CountDownLatch latch = new CountDownLatch(1);\n                 boolean stopAtCheckpoint = randomBoolean();\n+                timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a980bb9107ce16ae0da12e9538c0a304a82ff35"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1MjgyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);\n          \n          \n            \n                            timesStopAtCheckpointChanged += (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);", "url": "https://github.com/elastic/elasticsearch/pull/63006#discussion_r496752822", "createdAt": "2020-09-29T14:14:37Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/transforms/TransformIndexerStateTests.java", "diffHunk": "@@ -412,20 +412,29 @@ public void testStopAtCheckpoint() throws Exception {\n             CountDownLatch searchLatch = indexer.createAwaitForSearchLatch(1);\n \n             List<CountDownLatch> responseLatches = new ArrayList<>();\n+            int timesStopAtCheckpointChanged = 0;\n+            // default stopAtCheckpoint is false\n+            boolean previousStopAtCheckpoint = false;\n+\n             for (int i = 0; i < 3; ++i) {\n                 CountDownLatch latch = new CountDownLatch(1);\n                 boolean stopAtCheckpoint = randomBoolean();\n+                timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);\n+                previousStopAtCheckpoint = stopAtCheckpoint;\n                 countResponse(listener -> setStopAtCheckpoint(indexer, stopAtCheckpoint, listener), latch);\n                 responseLatches.add(latch);\n             }\n \n             // now let the indexer run again\n             searchLatch.countDown();\n \n-            // this time call it 3 times\n-            assertResponse(listener -> setStopAtCheckpoint(indexer, randomBoolean(), listener));\n-            assertResponse(listener -> setStopAtCheckpoint(indexer, randomBoolean(), listener));\n-            assertResponse(listener -> setStopAtCheckpoint(indexer, randomBoolean(), listener));\n+            // call it 3 times again\n+            for (int i = 0; i < 3; ++i) {\n+                boolean stopAtCheckpoint = randomBoolean();\n+                timesStopAtCheckpointChanged = timesStopAtCheckpointChanged + (stopAtCheckpoint == previousStopAtCheckpoint ? 0 : 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a980bb9107ce16ae0da12e9538c0a304a82ff35"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf166b0e894c06a62416fbf21d97acc26652030b", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/bf166b0e894c06a62416fbf21d97acc26652030b", "committedDate": "2020-09-29T15:07:22Z", "message": "Update x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/transforms/TransformIndexerStateTests.java\n\nCo-authored-by: Benjamin Trent <ben.w.trent@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd03fbf97e6b5917dac43a2d1c0f11fcddc6f11b", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd03fbf97e6b5917dac43a2d1c0f11fcddc6f11b", "committedDate": "2020-09-29T15:07:29Z", "message": "Update x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/transforms/TransformIndexerStateTests.java\n\nCo-authored-by: Benjamin Trent <ben.w.trent@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4517, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}