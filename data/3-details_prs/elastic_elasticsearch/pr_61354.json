{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNjczMzkz", "number": 61354, "title": "[API keys] Add full_name and email to API key doc and use them to populate authing User", "bodyText": "The API key document currently doesn't include the user's full_name or email attributes, and as a result, when those attributes return null when hitting GETing  /_security/_authenticate, and in the SAML response from the IdP Plugin.\nThis changeset adds those fields to the document and extracts them to fill in the User when authenticating. They're effectively going to be a snapshot of the User from when the key was created, but this is in line with roles and metadata as well.", "createdAt": "2020-08-20T05:42:16Z", "url": "https://github.com/elastic/elasticsearch/pull/61354", "merged": true, "mergeCommit": {"oid": "d135f5da4f7787ef875ae92ba199b4ec163bbbf6"}, "closed": true, "closedAt": "2020-08-20T11:10:56Z", "author": {"login": "lloydmeta"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdApxtFAH2gAyNDcwNjczMzkzOjE4ZmEwMjJiMjAwZWNkZGU5ZTQwNTEzNGVjZjc4YTc2NTljMDI0ZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA7EYOgFqTQ3MjA5NjgyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "18fa022b200ecdde9e405134ecf78a7659c024fb", "author": {"user": {"login": "lloydmeta", "name": "Lloyd"}}, "url": "https://github.com/elastic/elasticsearch/commit/18fa022b200ecdde9e405134ecf78a7659c024fb", "committedDate": "2020-08-20T05:57:38Z", "message": "[API keys] Add full_name and email to API key doc and use them to populate user\n\nThe API key document currently doesn't include the user's full_name or\nemail attributes.\n\nThis changeset adds those fields to the document and extracts them to fill\nin the User when authenticating. They're effectively going to be a snapshot\nof the User from when the key was created, but this is in line with roles\nand metadata as well.\n\nSigned-off-by: lloydmeta <lloydmeta@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b620dff20286a2b5a7e8e1413b6ada355638787f", "author": {"user": {"login": "lloydmeta", "name": "Lloyd"}}, "url": "https://github.com/elastic/elasticsearch/commit/b620dff20286a2b5a7e8e1413b6ada355638787f", "committedDate": "2020-08-20T05:53:26Z", "message": "* Add new fields to mapping\n\nSigned-off-by: lloydmeta <lloydmeta@gmail.com>"}, "afterCommit": {"oid": "18fa022b200ecdde9e405134ecf78a7659c024fb", "author": {"user": {"login": "lloydmeta", "name": "Lloyd"}}, "url": "https://github.com/elastic/elasticsearch/commit/18fa022b200ecdde9e405134ecf78a7659c024fb", "committedDate": "2020-08-20T05:57:38Z", "message": "[API keys] Add full_name and email to API key doc and use them to populate user\n\nThe API key document currently doesn't include the user's full_name or\nemail attributes.\n\nThis changeset adds those fields to the document and extracts them to fill\nin the User when authenticating. They're effectively going to be a snapshot\nof the User from when the key was created, but this is in line with roles\nand metadata as well.\n\nSigned-off-by: lloydmeta <lloydmeta@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b960e4e4b26cbb9dcd9eb4226e3f55cbf2b44b8", "author": {"user": {"login": "lloydmeta", "name": "Lloyd"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b960e4e4b26cbb9dcd9eb4226e3f55cbf2b44b8", "committedDate": "2020-08-20T06:58:28Z", "message": "* Checkstyle formatting fix.\n\nSigned-off-by: lloydmeta <lloydmeta@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDAxNjUy", "url": "https://github.com/elastic/elasticsearch/pull/61354#pullrequestreview-471401652", "createdAt": "2020-08-20T09:03:52Z", "commit": {"oid": "18fa022b200ecdde9e405134ecf78a7659c024fb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOTowMzo1M1rOHD15gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwOTowMzo1M1rOHD15gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc5MDg0OQ==", "bodyText": "nit: use Bruce Baner, or anything else for that matter so that it's easier to spot it's different from the principal, in the eventual case of troubleshooting a test failure", "url": "https://github.com/elastic/elasticsearch/pull/61354#discussion_r473790849", "createdAt": "2020-08-20T09:03:53Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/ApiKeyServiceTests.java", "diffHunk": "@@ -196,16 +196,18 @@ public void testAuthenticateWithApiKey() throws Exception {\n \n         final User user;\n         if (randomBoolean()) {\n-            user = new User(\"hulk\", new String[] { \"superuser\" }, new User(\"authenticated_user\", new String[] { \"other\" }));\n+            user = new User(new User(\"hulk\", new String[]{\"superuser\"}, \"hulk\", \"hulk@test.com\", Map.of(), true), new User(\"authenticated_user\", new String[]{\"other\"}));\n         } else {\n-            user = new User(\"hulk\", new String[] { \"superuser\" });\n+            user = new User(\"hulk\", new String[]{\"superuser\"}, \"hulk\", \"hulk@test.com\", Map.of(), true);\n         }\n         mockKeyDocument(service, id, key, user);\n \n         final AuthenticationResult auth = tryAuthenticate(service, id, key);\n         assertThat(auth.getStatus(), is(AuthenticationResult.Status.SUCCESS));\n         assertThat(auth.getUser(), notNullValue());\n         assertThat(auth.getUser().principal(), is(\"hulk\"));\n+        assertThat(auth.getUser().fullName(), is(\"hulk\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18fa022b200ecdde9e405134ecf78a7659c024fb"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a13a122ac6d41d4ce702e51ab7f1cf6e5a0eff8e", "author": {"user": {"login": "lloydmeta", "name": "Lloyd"}}, "url": "https://github.com/elastic/elasticsearch/commit/a13a122ac6d41d4ce702e51ab7f1cf6e5a0eff8e", "committedDate": "2020-08-20T09:49:53Z", "message": "Fix name in test\n\nSigned-off-by: lloydmeta <lloydmeta@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "135cbc040878a5e2e91e55a0e3b8afdc568db3c2", "author": {"user": {"login": "lloydmeta", "name": "Lloyd"}}, "url": "https://github.com/elastic/elasticsearch/commit/135cbc040878a5e2e91e55a0e3b8afdc568db3c2", "committedDate": "2020-08-20T09:48:16Z", "message": "* Checkstyle formatting fix.\n\nSigned-off-by: lloydmeta <lloydmeta@gmail.com>"}, "afterCommit": {"oid": "a13a122ac6d41d4ce702e51ab7f1cf6e5a0eff8e", "author": {"user": {"login": "lloydmeta", "name": "Lloyd"}}, "url": "https://github.com/elastic/elasticsearch/commit/a13a122ac6d41d4ce702e51ab7f1cf6e5a0eff8e", "committedDate": "2020-08-20T09:49:53Z", "message": "Fix name in test\n\nSigned-off-by: lloydmeta <lloydmeta@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDk2ODI0", "url": "https://github.com/elastic/elasticsearch/pull/61354#pullrequestreview-472096824", "createdAt": "2020-08-21T02:06:25Z", "commit": {"oid": "a13a122ac6d41d4ce702e51ab7f1cf6e5a0eff8e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4788, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}