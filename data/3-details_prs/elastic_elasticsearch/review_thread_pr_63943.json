{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2ODQyMjcx", "number": 63943, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDoyMTo0OFrOEvzmMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNzozNDo0OFrOEyA1UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTYzODkwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/stats/TransportClusterStatsAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDoyMTo0OFrOHk_img==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDoyMTo0OFrOHk_img==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU1MTgzNA==", "bodyText": "Obviously this isn't sticky but in practice this will mostly be called on master by monitoring and the overhead of this is small. And even if this is less helpful for the stats REST API it's going to often help anyway statistically speaking I'd expect it to \"often\" help still.", "url": "https://github.com/elastic/elasticsearch/pull/63943#discussion_r508551834", "createdAt": "2020-10-20T14:21:48Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/stats/TransportClusterStatsAction.java", "diffHunk": "@@ -55,13 +58,21 @@\n public class TransportClusterStatsAction extends TransportNodesAction<ClusterStatsRequest, ClusterStatsResponse,\n         TransportClusterStatsAction.ClusterStatsNodeRequest, ClusterStatsNodeResponse> {\n \n+    private static final Logger logger = LogManager.getLogger(TransportClusterStatsAction.class);\n+\n     private static final CommonStatsFlags SHARD_STATS_FLAGS = new CommonStatsFlags(CommonStatsFlags.Flag.Docs, CommonStatsFlags.Flag.Store,\n         CommonStatsFlags.Flag.FieldData, CommonStatsFlags.Flag.QueryCache,\n         CommonStatsFlags.Flag.Completion, CommonStatsFlags.Flag.Segments);\n \n     private final NodeService nodeService;\n     private final IndicesService indicesService;\n \n+    // guards #mappingStats, #analysisStats and #metaVersion\n+    private final Object statsMutex = new Object();\n+\n+    private MappingStats mappingStats;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "937e71b53fbb8b8e504e6b42a7b8282551b38be0"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTgwMzY3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/stats/TransportClusterStatsAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDo1Mjo0OVrOHlBKMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNToyMTozN1rOHlCnLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3ODM1Mg==", "bodyText": "I'm absolutely out of practice here, so please do correct me if I'm wrong, but should metaVersion be volatile?", "url": "https://github.com/elastic/elasticsearch/pull/63943#discussion_r508578352", "createdAt": "2020-10-20T14:52:49Z", "author": {"login": "joegallo"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/stats/TransportClusterStatsAction.java", "diffHunk": "@@ -55,13 +58,21 @@\n public class TransportClusterStatsAction extends TransportNodesAction<ClusterStatsRequest, ClusterStatsResponse,\n         TransportClusterStatsAction.ClusterStatsNodeRequest, ClusterStatsNodeResponse> {\n \n+    private static final Logger logger = LogManager.getLogger(TransportClusterStatsAction.class);\n+\n     private static final CommonStatsFlags SHARD_STATS_FLAGS = new CommonStatsFlags(CommonStatsFlags.Flag.Docs, CommonStatsFlags.Flag.Store,\n         CommonStatsFlags.Flag.FieldData, CommonStatsFlags.Flag.QueryCache,\n         CommonStatsFlags.Flag.Completion, CommonStatsFlags.Flag.Segments);\n \n     private final NodeService nodeService;\n     private final IndicesService indicesService;\n \n+    // guards #mappingStats, #analysisStats and #metaVersion\n+    private final Object statsMutex = new Object();\n+\n+    private MappingStats mappingStats;\n+    private AnalysisStats analysisStats;\n+    private long metaVersion = -1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "937e71b53fbb8b8e504e6b42a7b8282551b38be0"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYwMjE1Nw==", "bodyText": "No need for that. We only ever touch that field under the statsMutex so we are guaranteed to always have a consistent view of it.", "url": "https://github.com/elastic/elasticsearch/pull/63943#discussion_r508602157", "createdAt": "2020-10-20T15:21:37Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/stats/TransportClusterStatsAction.java", "diffHunk": "@@ -55,13 +58,21 @@\n public class TransportClusterStatsAction extends TransportNodesAction<ClusterStatsRequest, ClusterStatsResponse,\n         TransportClusterStatsAction.ClusterStatsNodeRequest, ClusterStatsNodeResponse> {\n \n+    private static final Logger logger = LogManager.getLogger(TransportClusterStatsAction.class);\n+\n     private static final CommonStatsFlags SHARD_STATS_FLAGS = new CommonStatsFlags(CommonStatsFlags.Flag.Docs, CommonStatsFlags.Flag.Store,\n         CommonStatsFlags.Flag.FieldData, CommonStatsFlags.Flag.QueryCache,\n         CommonStatsFlags.Flag.Completion, CommonStatsFlags.Flag.Segments);\n \n     private final NodeService nodeService;\n     private final IndicesService indicesService;\n \n+    // guards #mappingStats, #analysisStats and #metaVersion\n+    private final Object statsMutex = new Object();\n+\n+    private MappingStats mappingStats;\n+    private AnalysisStats analysisStats;\n+    private long metaVersion = -1L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3ODM1Mg=="}, "originalCommit": {"oid": "937e71b53fbb8b8e504e6b42a7b8282551b38be0"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwODc3OTA1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/stats/TransportClusterStatsAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNzozNDo0OFrOHoa57w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNzozNDo0OFrOHoa57w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE0NTkwMw==", "bodyText": "Just a drive-by comment (I'll leave the full review to Dan), but can you rename these variables? I think shadowing class variables (outside of constructors) can lead to bugs for people who reference it not realizing which one they're getting", "url": "https://github.com/elastic/elasticsearch/pull/63943#discussion_r512145903", "createdAt": "2020-10-26T17:34:48Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/stats/TransportClusterStatsAction.java", "diffHunk": "@@ -77,14 +88,43 @@ protected ClusterStatsResponse newResponse(ClusterStatsRequest request,\n                                                List<ClusterStatsNodeResponse> responses, List<FailedNodeException> failures) {\n         assert Transports.assertNotTransportThread(\"Constructor of ClusterStatsResponse runs expensive computations on mappings found in\" +\n                 \" the cluster state that are too slow for a transport thread\");\n-        ClusterState state = clusterService.state();\n+        final ClusterState state = clusterService.state();\n+        final Metadata metadata = state.metadata();\n+        MappingStats mappingStats = null;\n+        AnalysisStats analysisStats = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "937e71b53fbb8b8e504e6b42a7b8282551b38be0"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4344, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}