{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MjIyNzk1", "number": 62617, "title": "Prepare Snapshot Shard State Update Logic For Clone Logic", "bodyText": "Small refactoring to shorten the diff with the clone logic in #61839:\n\nSince clones will create a different kind of shard state update that\nisn't the same request sent by the snapshot shards service (and cannot be\nthe same request because we have no ShardId) base the shard state updates\non a different class that can be extended to be general enough to accomodate\nshard clones as well.\nMake the update executor a singleton (can't make it an inline lambda as that\nwould break CS update batching because the executor is used as a map key but\nthis change still makes it crystal clear that there's no internal state to the\nexecutor)\nMake shard state update responses a singleton (can't use TransportResponse.Empty because\nwe need an action response but still it makes it clear that there's no actual\nresponse with content here)", "createdAt": "2020-09-18T10:22:32Z", "url": "https://github.com/elastic/elasticsearch/pull/62617", "merged": true, "mergeCommit": {"oid": "6ab28e5b22df2c37fc4fa7f802696a743d55fe38"}, "closed": true, "closedAt": "2020-09-18T12:58:28Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKC1qTAH2gAyNDg5MjIyNzk1OjU1NTE1OWY5YTA2YTNhNWU0YWM3ZGM3Y2UyMzY2NGNiYWY1OGRhYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKE9ergFqTQ5MTQyODg3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "555159f9a06a3a5e4ac7dc7ce23664cbaf58dabf", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/555159f9a06a3a5e4ac7dc7ce23664cbaf58dabf", "committedDate": "2020-09-18T10:14:54Z", "message": "Prepare Snapshot Shard State Update Logic For Clone Logic\n\nSmall refactoring to shorten the diff with the clone logic in #61839:\n\n* Since clones will create a different kind of shard state update that\nisn't the same request sent by the snapshot shards service (and cannot be\nthe same request because we have no `ShardId`) base the shard state updates\non a different class that can be extended to be general enough to accomodate\nshard clones as well.\n* Make the update executor a singleton (can't make it an inline lambda as that\nwould break CS update batching because the executor is used as a map key but\nthis change still makes it crystal clear that there's no internal state to the\nexecutor)\n* Make shard state update responses a singleton (can't use TransportResponse.Empty because\nwe need an action response but still it makes it clear that there's no actual\nresponse with content here)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMzM4MjQw", "url": "https://github.com/elastic/elasticsearch/pull/62617#pullrequestreview-491338240", "createdAt": "2020-09-18T10:23:24Z", "commit": {"oid": "555159f9a06a3a5e4ac7dc7ce23664cbaf58dabf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMDoyMzoyNFrOHUHJkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMDoyMzoyNFrOHUHJkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1MDcwNg==", "bodyText": "Note for review: there's no logical changes here whatsoever, just indent changes and the type change for the tasks.", "url": "https://github.com/elastic/elasticsearch/pull/62617#discussion_r490850706", "createdAt": "2020-09-18T10:23:24Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -1909,101 +1908,130 @@ public boolean assertAllListenersResolved() {\n         return true;\n     }\n \n-    private static class SnapshotStateExecutor implements ClusterStateTaskExecutor<UpdateIndexShardSnapshotStatusRequest> {\n-\n-        @Override\n-        public ClusterTasksResult<UpdateIndexShardSnapshotStatusRequest>\n-                        execute(ClusterState currentState, List<UpdateIndexShardSnapshotStatusRequest> tasks) {\n-            int changedCount = 0;\n-            int startedCount = 0;\n-            final List<SnapshotsInProgress.Entry> entries = new ArrayList<>();\n-            // Tasks to check for updates for running snapshots.\n-            final List<UpdateIndexShardSnapshotStatusRequest> unconsumedTasks = new ArrayList<>(tasks);\n-            // Tasks that were used to complete an existing in-progress shard snapshot\n-            final Set<UpdateIndexShardSnapshotStatusRequest> executedTasks = new HashSet<>();\n-            for (SnapshotsInProgress.Entry entry : currentState.custom(SnapshotsInProgress.TYPE, SnapshotsInProgress.EMPTY).entries()) {\n-                if (entry.state().completed()) {\n-                    entries.add(entry);\n+    private static final ClusterStateTaskExecutor<ShardSnapshotUpdate> SHARD_STATE_EXECUTOR = (currentState, tasks) -> {\n+        int changedCount = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "555159f9a06a3a5e4ac7dc7ce23664cbaf58dabf"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNDI4ODc4", "url": "https://github.com/elastic/elasticsearch/pull/62617#pullrequestreview-491428878", "createdAt": "2020-09-18T12:43:16Z", "commit": {"oid": "555159f9a06a3a5e4ac7dc7ce23664cbaf58dabf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4773, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}