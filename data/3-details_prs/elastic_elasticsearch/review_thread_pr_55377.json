{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MDQ2MzYx", "number": 55377, "reviewThreads": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDo0Mjo1N1rOD09kug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzozMzozMVrOD7PcOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODYxMzcwOnYy", "diffSide": "RIGHT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/30_auto_create_data_stream.yml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDo0Mjo1N1rOGKKxXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToyNToxNVrOGKMgrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMxNTQyMg==", "bodyText": "Do we not need to remove this ITv2 at the end of the test?", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r413315422", "createdAt": "2020-04-22T20:42:57Z", "author": {"login": "danhermann"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/30_auto_create_data_stream.yml", "diffHunk": "@@ -0,0 +1,51 @@\n+---\n+\"Put index template\":\n+  - skip:\n+      version: \" - 7.9.99\"\n+      reason: \"not yet backported\"\n+      features: allowed_warnings\n+\n+  - do:\n+      allowed_warnings:\n+        - \"index template [test] has index patterns [test-*] matching patterns from existing older templates [global] with patterns (global => [*]); this template [test] will take precedence during new index creation\"\n+      indices.put_index_template:\n+        name: generic_logs_template", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec137e2b72b73331ee8c7fd466c7f30634729bb5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0MzkxOA==", "bodyText": "V2 templates are removed at the end of each test automatically, so shouldn't be a concern", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r413343918", "createdAt": "2020-04-22T21:25:15Z", "author": {"login": "dakrone"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/30_auto_create_data_stream.yml", "diffHunk": "@@ -0,0 +1,51 @@\n+---\n+\"Put index template\":\n+  - skip:\n+      version: \" - 7.9.99\"\n+      reason: \"not yet backported\"\n+      features: allowed_warnings\n+\n+  - do:\n+      allowed_warnings:\n+        - \"index template [test] has index patterns [test-*] matching patterns from existing older templates [global] with patterns (global => [*]); this template [test] will take precedence during new index creation\"\n+      indices.put_index_template:\n+        name: generic_logs_template", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMxNTQyMg=="}, "originalCommit": {"oid": "ec137e2b72b73331ee8c7fd466c7f30634729bb5"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODYyNjEwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDo0NDo1MFrOGKK5qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDo0NDo1MFrOGKK5qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMxNzU0Nw==", "bodyText": "Duplicates code in the onFailure handler in the doExecute method. Might be worth consolidating.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r413317547", "createdAt": "2020-04-22T20:44:50Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -272,6 +296,64 @@ public void onFailure(Exception e) {\n         }\n     }\n \n+    static Map<String, IndexTemplateV2.DataStreamTemplate> resolveAutoCreateDataStreams(Metadata metadata,\n+                                                                                        Set<String> autoCreateIndices) {\n+        Map<String, IndexTemplateV2.DataStreamTemplate> autoCreateDataStreams = new HashMap<>();\n+        Iterator<String> autoCreateIndicesIterator = autoCreateIndices.iterator();\n+        while (autoCreateIndicesIterator.hasNext()) {\n+            String indexName = autoCreateIndicesIterator.next();\n+            String v2Template = MetadataIndexTemplateService.findV2Template(metadata, indexName, false);\n+            if (v2Template != null) {\n+                IndexTemplateV2 indexTemplateV2 = metadata.templatesV2().get(v2Template);\n+                if (indexTemplateV2.getDataStreamTemplate() != null) {\n+                    autoCreateIndicesIterator.remove();\n+                    autoCreateDataStreams.put(indexName, indexTemplateV2.getDataStreamTemplate());\n+                }\n+            }\n+        }\n+        return autoCreateDataStreams;\n+    }\n+\n+    void autoCreateDataStreams(final Task task,\n+                               final BulkRequest bulkRequest,\n+                               final long startTimeNanos,\n+                               final ActionListener<BulkResponse> listener,\n+                               final AtomicArray<BulkItemResponse> responses,\n+                               final Map<String, IndexTemplateV2.DataStreamTemplate> autoCreateDataStreams,\n+                               final Map<String, IndexNotFoundException> indicesThatCannotBeCreated) {\n+        final AtomicInteger counter = new AtomicInteger(autoCreateDataStreams.size());\n+        for (Map.Entry<String, IndexTemplateV2.DataStreamTemplate> entry : autoCreateDataStreams.entrySet()) {\n+            final String name = entry.getKey();\n+\n+            CreateDataStreamAction.Request request = new CreateDataStreamAction.Request(name);\n+            request.setTimestampFieldName(entry.getValue().getTimestampField());\n+            CheckedConsumer<AcknowledgedResponse, ? extends Exception> onResponse = response -> {\n+                if (counter.decrementAndGet() == 0) {\n+                    threadPool.executor(ThreadPool.Names.WRITE).execute(\n+                        () -> executeBulk(task, bulkRequest, startTimeNanos, listener, responses, indicesThatCannotBeCreated));\n+                }\n+            };\n+            Consumer<Exception> onFailure = e -> {\n+                if (!(ExceptionsHelper.unwrapCause(e) instanceof ResourceAlreadyExistsException)) {\n+                    // fail all requests involving this index, if create didn't work\n+                    for (int i = 0; i < bulkRequest.requests.size(); i++) {\n+                        DocWriteRequest<?> item = bulkRequest.requests.get(i);\n+                        if (item != null && setResponseFailureIfIndexMatches(responses, i, item, name, e)) {\n+                            bulkRequest.requests.set(i, null);\n+                        }\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec137e2b72b73331ee8c7fd466c7f30634729bb5"}, "originalPosition": 141}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODYzNDE4OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDo0NTo1OVrOGKK_Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDo0NTo1OVrOGKK_Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMxODkxOA==", "bodyText": "Would this variable be better named autoCreateDataStreams?", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r413318918", "createdAt": "2020-04-22T20:45:59Z", "author": {"login": "danhermann"}, "path": "server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionTests.java", "diffHunk": "@@ -287,4 +298,44 @@ public void testResolveRequestOrDefaultPipelineAndFinalPipeline() {\n             assertThat(indexRequest.getFinalPipeline(), equalTo(\"final-pipeline\"));\n         }\n     }\n+\n+    public void testResolveAutoCreateDataStreams() {\n+        Metadata metadata;\n+        {\n+            Metadata.Builder mdBuilder = new Metadata.Builder();\n+            DataStreamTemplate dataStreamTemplate = new DataStreamTemplate(\"@timestamp\");\n+            mdBuilder.put(\"1\", new IndexTemplateV2(List.of(\"legacy-logs-*\"), null, null, 10L, null, null, null));\n+            mdBuilder.put(\"2\", new IndexTemplateV2(List.of(\"logs-*\"), null, null, 20L, null, null, dataStreamTemplate));\n+            mdBuilder.put(\"3\", new IndexTemplateV2(List.of(\"logs-foobar\"), null, null, 30L, null, null, dataStreamTemplate));\n+            metadata = mdBuilder.build();\n+        }\n+\n+        Map<String, DataStreamTemplate> result = TransportBulkAction.resolveAutoCreateDataStreams(metadata, Set.of());\n+        assertThat(result, anEmptyMap());\n+\n+        Set<String> autoCreateIndices = new HashSet<>(Set.of(\"logs-foobar\", \"logs-barbaz\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec137e2b72b73331ee8c7fd466c7f30634729bb5"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MTA5MjgyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwOTo1Mjo1OFrOGKg2kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMToyNzowN1rOGKkaXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY3NzIwMA==", "bodyText": "Unfortunately, resolving this here on the coordinator is slightly trappy in that the coordinator could be disconnected while the request could still succeed. It may thus create an index if it does not see the template.\nI think we could (and should) repair this by checking when creating indices if the template is for a data stream and if so, reject the request. But I also think it would be better to do the switching on master instead by adding a new action that handles the auto-creation of indices/streams. This would also be a good hook for security to validate auto_create privilege against anyway. I also think it could simplify the code in this class a fair bit.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r413677200", "createdAt": "2020-04-23T09:52:58Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -272,6 +296,64 @@ public void onFailure(Exception e) {\n         }\n     }\n \n+    static Map<String, IndexTemplateV2.DataStreamTemplate> resolveAutoCreateDataStreams(Metadata metadata,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec137e2b72b73331ee8c7fd466c7f30634729bb5"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzczNTUxNw==", "bodyText": "That is trappy indeed, thanks for spotting this. I will update the PR, so that most of the auto create logic here is moved to the to be built auto create action.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r413735517", "createdAt": "2020-04-23T11:27:07Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -272,6 +296,64 @@ public void onFailure(Exception e) {\n         }\n     }\n \n+    static Map<String, IndexTemplateV2.DataStreamTemplate> resolveAutoCreateDataStreams(Metadata metadata,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY3NzIwMA=="}, "originalCommit": {"oid": "ec137e2b72b73331ee8c7fd466c7f30634729bb5"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MTIyMjc5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMDoyMzo1OVrOGKiFpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMDoyMzo1OVrOGKiFpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzY5NzQ0NQ==", "bodyText": "I think this means that if you have both v1 and v2 templates matching the same pattern and the v2 one is a data stream, it takes precedence even when prefer_v2_templates=false. I think this will cause some confusion and I would prefer to stick to respecting the option.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r413697445", "createdAt": "2020-04-23T10:23:59Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -272,6 +296,64 @@ public void onFailure(Exception e) {\n         }\n     }\n \n+    static Map<String, IndexTemplateV2.DataStreamTemplate> resolveAutoCreateDataStreams(Metadata metadata,\n+                                                                                        Set<String> autoCreateIndices) {\n+        Map<String, IndexTemplateV2.DataStreamTemplate> autoCreateDataStreams = new HashMap<>();\n+        Iterator<String> autoCreateIndicesIterator = autoCreateIndices.iterator();\n+        while (autoCreateIndicesIterator.hasNext()) {\n+            String indexName = autoCreateIndicesIterator.next();\n+            String v2Template = MetadataIndexTemplateService.findV2Template(metadata, indexName, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec137e2b72b73331ee8c7fd466c7f30634729bb5"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDU2NjE1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/AutoCreateAction.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDozNDowOFrOGQjhiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMDo1MTo0N1rOGRNkxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxMjQyNw==", "bodyText": "Given that we are in auto-create, the meta-data check seems strange? Should never be true AFAICS?", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420012427", "createdAt": "2020-05-05T10:34:08Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/AutoCreateAction.java", "diffHunk": "@@ -84,4 +107,21 @@ protected ClusterBlockException checkBlock(CreateIndexRequest request, ClusterSt\n         }\n     }\n \n+    static DataStreamTemplate resolveAutoCreateDataStream(CreateIndexRequest request, Metadata metadata) {\n+        String v2Template = MetadataIndexTemplateService.findV2Template(metadata, request.index(), false);\n+        if (v2Template != null && resolvePreferV2Templates(request)) {\n+            IndexTemplateV2 indexTemplateV2 = metadata.templatesV2().get(v2Template);\n+            if (indexTemplateV2.getDataStreamTemplate() != null) {\n+                return indexTemplateV2.getDataStreamTemplate();\n+            }\n+        }\n+\n+        return null;\n+    }\n+\n+    private static boolean resolvePreferV2Templates(CreateIndexRequest request) {\n+        return request.preferV2Templates() == null ?\n+            IndexMetadata.PREFER_V2_TEMPLATES_SETTING.get(request.settings()) : request.preferV2Templates();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY5OTAxOQ==", "bodyText": "True, the settings in the request are always empty.  However via this way we can ensure that we always rely on prefer_v2_templates default, also when this change gets backported to 7.x.\nShould we use Settings.EMPTY here instead of request.settings()?", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420699019", "createdAt": "2020-05-06T10:47:14Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/AutoCreateAction.java", "diffHunk": "@@ -84,4 +107,21 @@ protected ClusterBlockException checkBlock(CreateIndexRequest request, ClusterSt\n         }\n     }\n \n+    static DataStreamTemplate resolveAutoCreateDataStream(CreateIndexRequest request, Metadata metadata) {\n+        String v2Template = MetadataIndexTemplateService.findV2Template(metadata, request.index(), false);\n+        if (v2Template != null && resolvePreferV2Templates(request)) {\n+            IndexTemplateV2 indexTemplateV2 = metadata.templatesV2().get(v2Template);\n+            if (indexTemplateV2.getDataStreamTemplate() != null) {\n+                return indexTemplateV2.getDataStreamTemplate();\n+            }\n+        }\n+\n+        return null;\n+    }\n+\n+    private static boolean resolvePreferV2Templates(CreateIndexRequest request) {\n+        return request.preferV2Templates() == null ?\n+            IndexMetadata.PREFER_V2_TEMPLATES_SETTING.get(request.settings()) : request.preferV2Templates();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxMjQyNw=="}, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDcwMTM4Mw==", "bodyText": "Sure, that makes the expectation a bit clearer. Probably a good idea to add a comment too.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420701383", "createdAt": "2020-05-06T10:51:47Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/AutoCreateAction.java", "diffHunk": "@@ -84,4 +107,21 @@ protected ClusterBlockException checkBlock(CreateIndexRequest request, ClusterSt\n         }\n     }\n \n+    static DataStreamTemplate resolveAutoCreateDataStream(CreateIndexRequest request, Metadata metadata) {\n+        String v2Template = MetadataIndexTemplateService.findV2Template(metadata, request.index(), false);\n+        if (v2Template != null && resolvePreferV2Templates(request)) {\n+            IndexTemplateV2 indexTemplateV2 = metadata.templatesV2().get(v2Template);\n+            if (indexTemplateV2.getDataStreamTemplate() != null) {\n+                return indexTemplateV2.getDataStreamTemplate();\n+            }\n+        }\n+\n+        return null;\n+    }\n+\n+    private static boolean resolvePreferV2Templates(CreateIndexRequest request) {\n+        return request.preferV2Templates() == null ?\n+            IndexMetadata.PREFER_V2_TEMPLATES_SETTING.get(request.settings()) : request.preferV2Templates();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxMjQyNw=="}, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDU2ODQxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/AutoCreateAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDozNDo1MlrOGQji7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDozNDo1MlrOGQji7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxMjc4Mg==", "bodyText": "I think we should check the resolvePreferV2Templates method before calling findV2Template?", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420012782", "createdAt": "2020-05-05T10:34:52Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/AutoCreateAction.java", "diffHunk": "@@ -84,4 +107,21 @@ protected ClusterBlockException checkBlock(CreateIndexRequest request, ClusterSt\n         }\n     }\n \n+    static DataStreamTemplate resolveAutoCreateDataStream(CreateIndexRequest request, Metadata metadata) {\n+        String v2Template = MetadataIndexTemplateService.findV2Template(metadata, request.index(), false);\n+        if (v2Template != null && resolvePreferV2Templates(request)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDU3MzAzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/AutoCreateAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDozNjoyMVrOGQjlvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMjo1ODo0MlrOGRRuPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxMzUwMw==", "bodyText": "Would it be possible to move this check inside the cluster state update?\nAlternatively, we need to double check that the template does create an index or data stream inside the two cluster state updates and throw an exception if not (race condition).", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420013503", "createdAt": "2020-05-05T10:36:21Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/AutoCreateAction.java", "diffHunk": "@@ -75,7 +85,20 @@ protected void masterOperation(Task task,\n                                        CreateIndexRequest request,\n                                        ClusterState state,\n                                        ActionListener<CreateIndexResponse> listener) {\n-            TransportCreateIndexAction.innerCreateIndex(request, listener, indexNameExpressionResolver, createIndexService);\n+            DataStreamTemplate dataStreamTemplate = resolveAutoCreateDataStream(request, state.metadata());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2OTM0Mw==", "bodyText": "Let's do this check and auto creating an index or data stream in a single cluster state update. Then we don't need to verify after the fact that an index or data stream has been created.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420769343", "createdAt": "2020-05-06T12:58:42Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/create/AutoCreateAction.java", "diffHunk": "@@ -75,7 +85,20 @@ protected void masterOperation(Task task,\n                                        CreateIndexRequest request,\n                                        ClusterState state,\n                                        ActionListener<CreateIndexResponse> listener) {\n-            TransportCreateIndexAction.innerCreateIndex(request, listener, indexNameExpressionResolver, createIndexService);\n+            DataStreamTemplate dataStreamTemplate = resolveAutoCreateDataStream(request, state.metadata());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxMzUwMw=="}, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDU4MDMxOnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDozODo0NVrOGQjqMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDozODo0NVrOGQjqMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxNDY0Mg==", "bodyText": "Following looks like white-space only changes, I wonder if that is a left-over from previous iterations?", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420014642", "createdAt": "2020-05-05T10:38:45Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -247,29 +245,29 @@ public void onResponse(CreateIndexResponse result) {\n                             }\n                         }\n \n-                        @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDYwNjEwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo0NjoxMVrOGQj5mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNDoxMjoyMFrOGRVChQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxODU4NQ==", "bodyText": "When auto-creating the index (and just creating indices), we wait for active shards. I think we need something similar when creating data streams (for the first backing index).\nThat can be done here or separately. I think we need it before merging since otherwise we risk test failures because the shard is not ready when bulk indexing continues after having created the data stream?", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420018585", "createdAt": "2020-05-05T10:46:11Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.cluster.metadata;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexClusterStateUpdateRequest;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.ClusterStateUpdateTask;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Priority;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+\n+import java.util.List;\n+import java.util.Locale;\n+\n+public class MetadataCreateDataStreamService {\n+\n+    private static final Logger logger = LogManager.getLogger(MetadataCreateDataStreamService.class);\n+\n+    private final ClusterService clusterService;\n+    private final MetadataCreateIndexService metadataCreateIndexService;\n+\n+    public MetadataCreateDataStreamService(ClusterService clusterService, MetadataCreateIndexService metadataCreateIndexService) {\n+        this.clusterService = clusterService;\n+        this.metadataCreateIndexService = metadataCreateIndexService;\n+    }\n+\n+    public void createDataStream(CreateDataSteamClusterStateUpdateRequest request,\n+                                 ActionListener<AcknowledgedResponse> listener) {\n+        clusterService.submitStateUpdateTask(\"create-data-stream [\" + request.name + \"]\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgyMzY4NQ==", "bodyText": "Yes, tests could fail if a coordinating/data node has a stale cluster state for too long.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420823685", "createdAt": "2020-05-06T14:12:20Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.cluster.metadata;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexClusterStateUpdateRequest;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.ClusterStateUpdateTask;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Priority;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+\n+import java.util.List;\n+import java.util.Locale;\n+\n+public class MetadataCreateDataStreamService {\n+\n+    private static final Logger logger = LogManager.getLogger(MetadataCreateDataStreamService.class);\n+\n+    private final ClusterService clusterService;\n+    private final MetadataCreateIndexService metadataCreateIndexService;\n+\n+    public MetadataCreateDataStreamService(ClusterService clusterService, MetadataCreateIndexService metadataCreateIndexService) {\n+        this.clusterService = clusterService;\n+        this.metadataCreateIndexService = metadataCreateIndexService;\n+    }\n+\n+    public void createDataStream(CreateDataSteamClusterStateUpdateRequest request,\n+                                 ActionListener<AcknowledgedResponse> listener) {\n+        clusterService.submitStateUpdateTask(\"create-data-stream [\" + request.name + \"]\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxODU4NQ=="}, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDYyNjU1OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1MjoyNlrOGQkGJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1MjoyNlrOGQkGJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyMTc5Nw==", "bodyText": "Maybe randomly add a v1 template for logs-bar*?\nAlso, randomly set preferV2Templates on the requests.\nAnd also, randomly add a conflicting v1 template, but then forcing preferV2Templates true.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420021797", "createdAt": "2020-05-05T10:52:26Z", "author": {"login": "henningandersen"}, "path": "server/src/test/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java", "diffHunk": "@@ -200,4 +214,56 @@ public void testDeleteIndexWhileIndexing() throws Exception {\n             assertFalse(thread.isAlive());\n         }\n     }\n+\n+    public void testMixedAutoCreate() {\n+        PutIndexTemplateV2Action.Request createTemplateRequest = new PutIndexTemplateV2Action.Request(\"logs-foo\");\n+        createTemplateRequest.indexTemplate(new IndexTemplateV2(List.of(\"logs-foo*\"), null, null, null, null, null,\n+            new IndexTemplateV2.DataStreamTemplate(\"@timestamp\")));\n+        client().execute(PutIndexTemplateV2Action.INSTANCE, createTemplateRequest).actionGet();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDY0NzgzOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/cluster/metadata/ToAndFromJsonMetadataTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1OToxM1rOGQkS-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDo1OToxM1rOGQkS-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNTA4Mw==", "bodyText": "Should we randomly add a random data stream instance here?", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420025083", "createdAt": "2020-05-05T10:59:13Z", "author": {"login": "henningandersen"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/ToAndFromJsonMetadataTests.java", "diffHunk": "@@ -77,7 +77,7 @@ public void testSimpleJsonFromAndTo() throws IOException {\n                     Collections.singletonList(\"component_template\"),\n                     5L,\n                     4L,\n-                    Collections.singletonMap(\"my_meta\", Collections.singletonMap(\"potato\", \"chicken\"))))\n+                    Collections.singletonMap(\"my_meta\", Collections.singletonMap(\"potato\", \"chicken\")), null))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDY1MTgxOnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/ClusterServiceUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTowMDozMFrOGQkVUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTowMDozMFrOGQkVUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNTY4Mg==", "bodyText": "I am not sure this is used?", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420025682", "createdAt": "2020-05-05T11:00:30Z", "author": {"login": "henningandersen"}, "path": "test/framework/src/main/java/org/elasticsearch/test/ClusterServiceUtils.java", "diffHunk": "@@ -100,8 +100,12 @@ public void onFailure(String source, Exception e) {\n     }\n \n     public static ClusterService createClusterService(ThreadPool threadPool) {\n+        return createClusterService(threadPool, Version.CURRENT);\n+    }\n+\n+    public static ClusterService createClusterService(ThreadPool threadPool, Version nodeVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDY2MzgyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexTemplateV2.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTowNDoxN1rOGQkcbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNDoxOTo1OFrOGRVZTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNzUwMA==", "bodyText": "Since this is part of the HLRC, I wonder if we should stay backwards compatible with the original constructor, i.e., have both variants? Not sure of the exact policy on that subject though.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420027500", "createdAt": "2020-05-05T11:04:17Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexTemplateV2.java", "diffHunk": "@@ -88,13 +95,15 @@ public static IndexTemplateV2 parse(XContentParser parser) throws IOException {\n     }\n \n     public IndexTemplateV2(List<String> indexPatterns, @Nullable Template template, @Nullable List<String> componentTemplates,\n-                           @Nullable Long priority, @Nullable Long version, @Nullable Map<String, Object> metadata) {\n+                           @Nullable Long priority, @Nullable Long version, @Nullable Map<String, Object> metadata,\n+                           @Nullable DataStreamTemplate dataStreamTemplate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0NDE4MA==", "bodyText": "I think changing this constructor now is okay, because index templates v2 is experimental in 7.8? I don't think we have a real policy regarding hlrc bwc.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420744180", "createdAt": "2020-05-06T12:16:54Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexTemplateV2.java", "diffHunk": "@@ -88,13 +95,15 @@ public static IndexTemplateV2 parse(XContentParser parser) throws IOException {\n     }\n \n     public IndexTemplateV2(List<String> indexPatterns, @Nullable Template template, @Nullable List<String> componentTemplates,\n-                           @Nullable Long priority, @Nullable Long version, @Nullable Map<String, Object> metadata) {\n+                           @Nullable Long priority, @Nullable Long version, @Nullable Map<String, Object> metadata,\n+                           @Nullable DataStreamTemplate dataStreamTemplate) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNzUwMA=="}, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgyOTUxNw==", "bodyText": "I added the constructor:  5ed50fe", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r420829517", "createdAt": "2020-05-06T14:19:58Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexTemplateV2.java", "diffHunk": "@@ -88,13 +95,15 @@ public static IndexTemplateV2 parse(XContentParser parser) throws IOException {\n     }\n \n     public IndexTemplateV2(List<String> indexPatterns, @Nullable Template template, @Nullable List<String> componentTemplates,\n-                           @Nullable Long priority, @Nullable Long version, @Nullable Map<String, Object> metadata) {\n+                           @Nullable Long priority, @Nullable Long version, @Nullable Map<String, Object> metadata,\n+                           @Nullable DataStreamTemplate dataStreamTemplate) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAyNzUwMA=="}, "originalCommit": {"oid": "6448582bb24ddd6dd7e962d00d680defa301a9c8"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzU0ODcxOnYy", "diffSide": "RIGHT", "path": "server/src/internalClusterTest/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwOToxNDoyOVrOGTTtBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwODoxMDoyMVrOGT7C6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5ODk0OQ==", "bodyText": "This probably works in master, but will break in 7.x. I think we need to add preferV2Templates=true in this block? OK to just do this in backport (or before, up to you).", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r422898949", "createdAt": "2020-05-11T09:14:29Z", "author": {"login": "henningandersen"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java", "diffHunk": "@@ -200,4 +217,104 @@ public void testDeleteIndexWhileIndexing() throws Exception {\n             assertFalse(thread.isAlive());\n         }\n     }\n+\n+    public void testMixedAutoCreate() {\n+        Settings settings = Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0).build();\n+\n+        PutIndexTemplateV2Action.Request createTemplateRequest = new PutIndexTemplateV2Action.Request(\"logs-foo\");\n+        createTemplateRequest.indexTemplate(\n+            new IndexTemplateV2(\n+                List.of(\"logs-foo*\"),\n+                new Template(settings, null, null),\n+                null, null, null, null,\n+                new IndexTemplateV2.DataStreamTemplate(\"@timestamp\"))\n+        );\n+        client().execute(PutIndexTemplateV2Action.INSTANCE, createTemplateRequest).actionGet();\n+\n+        Boolean preferV2Templates = randomBoolean() ? null : true;\n+        if (randomBoolean()) {\n+            PutIndexTemplateRequest v1Request = new PutIndexTemplateRequest(\"logs-foo\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "395587cea082433cde15f991488c60526f5d4795"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0MzUzMQ==", "bodyText": "I will remove this randomization now that the prefer flag has been removed.", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r423543531", "createdAt": "2020-05-12T08:10:21Z", "author": {"login": "martijnvg"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/action/bulk/BulkIntegrationIT.java", "diffHunk": "@@ -200,4 +217,104 @@ public void testDeleteIndexWhileIndexing() throws Exception {\n             assertFalse(thread.isAlive());\n         }\n     }\n+\n+    public void testMixedAutoCreate() {\n+        Settings settings = Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0).build();\n+\n+        PutIndexTemplateV2Action.Request createTemplateRequest = new PutIndexTemplateV2Action.Request(\"logs-foo\");\n+        createTemplateRequest.indexTemplate(\n+            new IndexTemplateV2(\n+                List.of(\"logs-foo*\"),\n+                new Template(settings, null, null),\n+                null, null, null, null,\n+                new IndexTemplateV2.DataStreamTemplate(\"@timestamp\"))\n+        );\n+        client().execute(PutIndexTemplateV2Action.INSTANCE, createTemplateRequest).actionGet();\n+\n+        Boolean preferV2Templates = randomBoolean() ? null : true;\n+        if (randomBoolean()) {\n+            PutIndexTemplateRequest v1Request = new PutIndexTemplateRequest(\"logs-foo\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5ODk0OQ=="}, "originalCommit": {"oid": "395587cea082433cde15f991488c60526f5d4795"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzcxMDk0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwOTo1NjoxN1rOGTVPtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwOTo1NjoxN1rOGTVPtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkyNDIxMg==", "bodyText": "The class name is missing an 'r', should be CreateDataStreamClusterStateUpdateRequest", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r422924212", "createdAt": "2020-05-11T09:56:17Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.cluster.metadata;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexClusterStateUpdateRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.action.support.ActiveShardsObserver;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.cluster.AckedClusterStateUpdateTask;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.ack.ClusterStateUpdateRequest;\n+import org.elasticsearch.cluster.ack.ClusterStateUpdateResponse;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Priority;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class MetadataCreateDataStreamService {\n+\n+    private static final Logger logger = LogManager.getLogger(MetadataCreateDataStreamService.class);\n+\n+    private final ClusterService clusterService;\n+    private final ActiveShardsObserver activeShardsObserver;\n+    private final MetadataCreateIndexService metadataCreateIndexService;\n+\n+    public MetadataCreateDataStreamService(ThreadPool threadPool,\n+                                           ClusterService clusterService,\n+                                           MetadataCreateIndexService metadataCreateIndexService) {\n+        this.clusterService = clusterService;\n+        this.activeShardsObserver = new ActiveShardsObserver(clusterService, threadPool);\n+        this.metadataCreateIndexService = metadataCreateIndexService;\n+    }\n+\n+    public void createDataStream(CreateDataSteamClusterStateUpdateRequest request,\n+                                 ActionListener<AcknowledgedResponse> finalListener) {\n+        AtomicReference<String> firstBackingIndexRef = new AtomicReference<>();\n+        ActionListener<ClusterStateUpdateResponse> listener = ActionListener.wrap(\n+            response -> {\n+                if (response.isAcknowledged()) {\n+                    String firstBackingIndexName = firstBackingIndexRef.get();\n+                    assert finalListener != null;\n+                    activeShardsObserver.waitForActiveShards(\n+                        new String[]{firstBackingIndexName},\n+                        ActiveShardCount.DEFAULT,\n+                        request.masterNodeTimeout(),\n+                        shardsAcked -> {\n+                            finalListener.onResponse(new AcknowledgedResponse(true));\n+                        },\n+                        finalListener::onFailure);\n+                } else {\n+                    finalListener.onResponse(new AcknowledgedResponse(false));\n+                }\n+            },\n+            finalListener::onFailure\n+        );\n+        clusterService.submitStateUpdateTask(\"create-data-stream [\" + request.name + \"]\",\n+            new AckedClusterStateUpdateTask<>(Priority.HIGH, request, listener) {\n+\n+                @Override\n+                public ClusterState execute(ClusterState currentState) throws Exception {\n+                    ClusterState clusterState = createDataStream(metadataCreateIndexService, currentState, request);\n+                    firstBackingIndexRef.set(clusterState.metadata().dataStreams().get(request.name).getIndices().get(0).getName());\n+                    return clusterState;\n+                }\n+\n+                @Override\n+                protected ClusterStateUpdateResponse newResponse(boolean acknowledged) {\n+                    return new ClusterStateUpdateResponse(acknowledged);\n+                }\n+            });\n+    }\n+\n+    public ClusterState createDataStream(CreateDataSteamClusterStateUpdateRequest request, ClusterState current) throws Exception {\n+        return createDataStream(metadataCreateIndexService, current, request);\n+    }\n+\n+    public static final class CreateDataSteamClusterStateUpdateRequest extends ClusterStateUpdateRequest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "395587cea082433cde15f991488c60526f5d4795"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNDQ1NTYwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzozMzozMVrOGTccXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMzozMzozMVrOGTccXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA0MjE0Mw==", "bodyText": "typo?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                assert finalListener != null;\n          \n          \n            \n                                assert firstBackingIndexName != null;", "url": "https://github.com/elastic/elasticsearch/pull/55377#discussion_r423042143", "createdAt": "2020-05-11T13:33:31Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.cluster.metadata;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexClusterStateUpdateRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.action.support.ActiveShardsObserver;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.cluster.AckedClusterStateUpdateTask;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.ack.ClusterStateUpdateRequest;\n+import org.elasticsearch.cluster.ack.ClusterStateUpdateResponse;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.Priority;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class MetadataCreateDataStreamService {\n+\n+    private static final Logger logger = LogManager.getLogger(MetadataCreateDataStreamService.class);\n+\n+    private final ClusterService clusterService;\n+    private final ActiveShardsObserver activeShardsObserver;\n+    private final MetadataCreateIndexService metadataCreateIndexService;\n+\n+    public MetadataCreateDataStreamService(ThreadPool threadPool,\n+                                           ClusterService clusterService,\n+                                           MetadataCreateIndexService metadataCreateIndexService) {\n+        this.clusterService = clusterService;\n+        this.activeShardsObserver = new ActiveShardsObserver(clusterService, threadPool);\n+        this.metadataCreateIndexService = metadataCreateIndexService;\n+    }\n+\n+    public void createDataStream(CreateDataSteamClusterStateUpdateRequest request,\n+                                 ActionListener<AcknowledgedResponse> finalListener) {\n+        AtomicReference<String> firstBackingIndexRef = new AtomicReference<>();\n+        ActionListener<ClusterStateUpdateResponse> listener = ActionListener.wrap(\n+            response -> {\n+                if (response.isAcknowledged()) {\n+                    String firstBackingIndexName = firstBackingIndexRef.get();\n+                    assert finalListener != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "395587cea082433cde15f991488c60526f5d4795"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 990, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}