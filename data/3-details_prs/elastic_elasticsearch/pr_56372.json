{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0ODI3MzE3", "number": 56372, "title": "Clean up DocValuesIndexFieldData", "bodyText": "This PR removes some confusing class hierarchy behavior around DocValuesIndexFieldData (henceforth referred to as DVIFD).  The javadoc for DVIFD said that it implemented IndexFieldData, but in fact it did not do so directly.  Instead, subclasses of DVIFD would declare themselves to implement IndexFieldData, then rely on methods inherited from DVIFD to do so.  The resulting situation was very difficult to reason about.\nAdditionally, DVIFD provided a builder class, which would build one of three possible implementations.  This builder had three fields on it, but setting more than one would be an error.  Which field was set determined which subclass to build.  This made the specific implementation selection look more dynamic than it actually is.  I've replaced this by just letting each field mapper call the appropriate subclass directly.\nAll of this lays the ground work for what I actually want to do, which is put ValuesSourceType on IndexFieldData, so that the ValuesSourceConfig can get both with one call.  That will be done in a follow up, since this clean up is independent of it.", "createdAt": "2020-05-07T17:38:56Z", "url": "https://github.com/elastic/elasticsearch/pull/56372", "merged": true, "mergeCommit": {"oid": "954afd94fe859209522a6d63fcb15dd9ef6c9df2"}, "closed": true, "closedAt": "2020-05-13T14:09:39Z", "author": {"login": "not-napoleon"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcevLYngH2gAyNDE0ODI3MzE3OmUyYjViZGE2MGE0OWI2ODJjM2Q3NmEzMWExY2FlZmI1YmViY2E4NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg4tNBgH2gAyNDE0ODI3MzE3OmZlMWY1MjczMzg1ODAwMDNjZjIxNzQ4NzIyOTVhZTIyMTMzMmI0YjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e2b5bda60a49b682c3d76a31a1caefb5bebca849", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/e2b5bda60a49b682c3d76a31a1caefb5bebca849", "committedDate": "2020-05-06T21:01:47Z", "message": "extract SortedNumericDVIndexFieldData builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4c76427c2a7f4749ad7bace34828aac05468069", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4c76427c2a7f4749ad7bace34828aac05468069", "committedDate": "2020-05-06T21:53:03Z", "message": "Inline the remaining uses of DocValuesIndexFieldData.Builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2cf8d56739a7f4c9e34aa31bf2b14c18865d10a", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2cf8d56739a7f4c9e34aa31bf2b14c18865d10a", "committedDate": "2020-05-07T17:20:44Z", "message": "Remove DocValuesIndexFieldData"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3Njk1Nzgx", "url": "https://github.com/elastic/elasticsearch/pull/56372#pullrequestreview-407695781", "createdAt": "2020-05-07T17:42:29Z", "commit": {"oid": "b2cf8d56739a7f4c9e34aa31bf2b14c18865d10a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzo0MjoyOVrOGSJU_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzo0NDozOFrOGSJZ-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY4MDM4Mg==", "bodyText": "Is numericType required? Maybe it can be final a ctor arg?", "url": "https://github.com/elastic/elasticsearch/pull/56372#discussion_r421680382", "createdAt": "2020-05-07T17:42:29Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/fielddata/plain/SortedNumericDVIndexFieldData.java", "diffHunk": "@@ -53,21 +59,58 @@\n import java.io.IOException;\n import java.util.Collection;\n import java.util.Collections;\n+import java.util.Objects;\n import java.util.function.LongUnaryOperator;\n \n /**\n  * FieldData backed by {@link LeafReader#getSortedNumericDocValues(String)}\n  * @see DocValuesType#SORTED_NUMERIC\n  */\n-public class SortedNumericDVIndexFieldData extends DocValuesIndexFieldData implements IndexNumericFieldData {\n-    private final NumericType numericType;\n+public class SortedNumericDVIndexFieldData implements IndexNumericFieldData {\n+    public static class Builder implements IndexFieldData.Builder {\n+\n+        private NumericType numericType;\n+        public Builder numericType(NumericType type) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2cf8d56739a7f4c9e34aa31bf2b14c18865d10a"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY4MDkxMw==", "bodyText": "I wonder if all of these sorts of args can be ctor args.", "url": "https://github.com/elastic/elasticsearch/pull/56372#discussion_r421680913", "createdAt": "2020-05-07T17:43:21Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/fielddata/plain/SortedNumericDVIndexFieldData.java", "diffHunk": "@@ -53,21 +59,58 @@\n import java.io.IOException;\n import java.util.Collection;\n import java.util.Collections;\n+import java.util.Objects;\n import java.util.function.LongUnaryOperator;\n \n /**\n  * FieldData backed by {@link LeafReader#getSortedNumericDocValues(String)}\n  * @see DocValuesType#SORTED_NUMERIC\n  */\n-public class SortedNumericDVIndexFieldData extends DocValuesIndexFieldData implements IndexNumericFieldData {\n-    private final NumericType numericType;\n+public class SortedNumericDVIndexFieldData implements IndexNumericFieldData {\n+    public static class Builder implements IndexFieldData.Builder {\n+\n+        private NumericType numericType;\n+        public Builder numericType(NumericType type) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY4MDM4Mg=="}, "originalCommit": {"oid": "b2cf8d56739a7f4c9e34aa31bf2b14c18865d10a"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY4MTY1OA==", "bodyText": "I see what you mean about copying method around and maybe making an abstract base class at some point. But the copying is fine by me as an intermediate step to untwisting all of this.", "url": "https://github.com/elastic/elasticsearch/pull/56372#discussion_r421681658", "createdAt": "2020-05-07T17:44:38Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/query/VectorDVIndexFieldData.java", "diffHunk": "@@ -26,10 +25,29 @@\n import org.elasticsearch.search.sort.SortOrder;\n \n \n-public class VectorDVIndexFieldData extends DocValuesIndexFieldData implements IndexFieldData<VectorDVLeafFieldData> {\n+public class VectorDVIndexFieldData implements IndexFieldData<VectorDVLeafFieldData> {\n+\n+    protected final Index index;\n+    protected final String fieldName;\n \n     public VectorDVIndexFieldData(Index index, String fieldName) {\n-        super(index, fieldName);\n+        this.index = index;\n+        this.fieldName = fieldName;\n+    }\n+\n+    @Override\n+    public final String getFieldName() {\n+        return fieldName;\n+    }\n+\n+    @Override\n+    public final void clear() {\n+        // can't do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2cf8d56739a7f4c9e34aa31bf2b14c18865d10a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NzA5Nzky", "url": "https://github.com/elastic/elasticsearch/pull/56372#pullrequestreview-407709792", "createdAt": "2020-05-07T18:01:14Z", "commit": {"oid": "b2cf8d56739a7f4c9e34aa31bf2b14c18865d10a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODowMToxNFrOGSKBcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODowMToxNFrOGSKBcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5MTc2Mw==", "bodyText": "What would you think about removing 'DV' from all of these class names? Now that they don't extend DocValuesIndexFieldData, I think it's a bit confusing/ unclear what 'DV' refers to.", "url": "https://github.com/elastic/elasticsearch/pull/56372#discussion_r421691763", "createdAt": "2020-05-07T18:01:14Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/fielddata/plain/AbstractLatLonPointDVIndexFieldData.java", "diffHunk": "@@ -41,10 +41,29 @@\n import org.elasticsearch.search.sort.BucketedSort;\n import org.elasticsearch.search.sort.SortOrder;\n \n-public abstract class AbstractLatLonPointDVIndexFieldData extends DocValuesIndexFieldData\n-    implements IndexGeoPointFieldData {\n+public abstract class AbstractLatLonPointDVIndexFieldData implements IndexGeoPointFieldData {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2cf8d56739a7f4c9e34aa31bf2b14c18865d10a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af6c4ef9cd033c197c7396ce878467fae775c4f4", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/af6c4ef9cd033c197c7396ce878467fae775c4f4", "committedDate": "2020-05-07T21:20:24Z", "message": "Response to PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f12e2e36a5a588755d9b9e9b61416e5e9510907", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f12e2e36a5a588755d9b9e9b61416e5e9510907", "committedDate": "2020-05-08T13:43:46Z", "message": "Merge branch 'master' into vs-refactor-field-cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Mjk4ODY5", "url": "https://github.com/elastic/elasticsearch/pull/56372#pullrequestreview-408298869", "createdAt": "2020-05-08T14:56:32Z", "commit": {"oid": "2f12e2e36a5a588755d9b9e9b61416e5e9510907"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNDo1NjozM1rOGSohyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNDo1NzowNlrOGSoi_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5MTU2MA==", "bodyText": "Could the builder return a IndexNumericFieldData?", "url": "https://github.com/elastic/elasticsearch/pull/56372#discussion_r422191560", "createdAt": "2020-05-08T14:56:33Z", "author": {"login": "nik9000"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/ScaledFloatFieldMapper.java", "diffHunk": "@@ -289,8 +289,9 @@ public Query rangeQuery(Object lowerTerm, Object upperTerm, boolean includeLower\n                 @Override\n                 public IndexFieldData<?> build(IndexSettings indexSettings, MappedFieldType fieldType, IndexFieldDataCache cache,\n                         CircuitBreakerService breakerService, MapperService mapperService) {\n-                    final IndexNumericFieldData scaledValues = (IndexNumericFieldData) new DocValuesIndexFieldData.Builder()\n-                            .numericType(IndexNumericFieldData.NumericType.LONG)\n+                    final IndexNumericFieldData scaledValues = (IndexNumericFieldData) new SortedNumericIndexFieldData.Builder(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f12e2e36a5a588755d9b9e9b61416e5e9510907"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5MTg2OA==", "bodyText": "Like, not all the builders can, but I'm fairly sure the SortedNumericIndexFieldData builder will only ever build numeric field data.", "url": "https://github.com/elastic/elasticsearch/pull/56372#discussion_r422191868", "createdAt": "2020-05-08T14:57:06Z", "author": {"login": "nik9000"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/ScaledFloatFieldMapper.java", "diffHunk": "@@ -289,8 +289,9 @@ public Query rangeQuery(Object lowerTerm, Object upperTerm, boolean includeLower\n                 @Override\n                 public IndexFieldData<?> build(IndexSettings indexSettings, MappedFieldType fieldType, IndexFieldDataCache cache,\n                         CircuitBreakerService breakerService, MapperService mapperService) {\n-                    final IndexNumericFieldData scaledValues = (IndexNumericFieldData) new DocValuesIndexFieldData.Builder()\n-                            .numericType(IndexNumericFieldData.NumericType.LONG)\n+                    final IndexNumericFieldData scaledValues = (IndexNumericFieldData) new SortedNumericIndexFieldData.Builder(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjE5MTU2MA=="}, "originalCommit": {"oid": "2f12e2e36a5a588755d9b9e9b61416e5e9510907"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bf349db3b294cf3de0e606fa37a4b71be1b0fa4", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/2bf349db3b294cf3de0e606fa37a4b71be1b0fa4", "committedDate": "2020-05-08T17:20:05Z", "message": "Response to PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38c21ccb0dada08175b9acbaa85d71888863e14f", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/38c21ccb0dada08175b9acbaa85d71888863e14f", "committedDate": "2020-05-12T17:11:52Z", "message": "Merge branch 'master' into vs-refactor-field-cleanup\n\n Conflicts:\n\tserver/src/main/java/org/elasticsearch/index/mapper/GeoPointFieldMapper.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe1f527338580003cf2174872295ae221332b4b6", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe1f527338580003cf2174872295ae221332b4b6", "committedDate": "2020-05-13T13:15:43Z", "message": "Merge branch 'master' into vs-refactor-field-cleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 237, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}