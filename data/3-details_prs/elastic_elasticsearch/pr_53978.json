{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMzk3MzE1", "number": 53978, "title": "Reduce performance impact of ExitableDirectoryReader", "bodyText": "Benchmarking showed that the effect of the ExitableDirectoryReader\nis reduced considerably when checking every 8191 docs. Moreover,\nset the cancellable task before calling QueryPhase#preProcess()\nand make sure we don't wrap with an ExitableDirectoryReader at all\nwhen lowLevelCancellation is set to false to avoid completely any\nperformance impact.\nFollows: #52822\nFollows: #53166\nFollows: #53496", "createdAt": "2020-03-23T13:48:49Z", "url": "https://github.com/elastic/elasticsearch/pull/53978", "merged": true, "mergeCommit": {"oid": "cdc377e8e74d3ca6c231c36dc5e80621aab47c69"}, "closed": true, "closedAt": "2020-03-23T18:49:33Z", "author": {"login": "matriv"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQeudTAFqTM3OTQ0ODczNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQha8XAH2gAyMzkyMzk3MzE1OmYzMjQ5MTk0OWQ2OTk4MjNlNzg0ZDA2ZjBhMmIxZGEyMjA1NmQyYTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDQ4NzM0", "url": "https://github.com/elastic/elasticsearch/pull/53978#pullrequestreview-379448734", "createdAt": "2020-03-23T13:53:21Z", "commit": {"oid": "828ca8a13796219890be46aa914061ada0a106e6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMzo1MzoyMlrOF6GZrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMzo1NjozM1rOF6GivA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2NjYwNA==", "bodyText": "I don't think we should throttle this. We don't have enough evidence that it's slowing down the request so I'd keep it as is for now.", "url": "https://github.com/elastic/elasticsearch/pull/53978#discussion_r396466604", "createdAt": "2020-03-23T13:53:22Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/internal/ExitableDirectoryReader.java", "diffHunk": "@@ -276,7 +276,7 @@ public void visit(int docID, byte[] packedValue) throws IOException {\n \n         @Override\n         public PointValues.Relation compare(byte[] minPackedValue, byte[] maxPackedValue) {\n-            queryCancellation.checkCancelled();\n+            checkAndThrowWithSampling();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "828ca8a13796219890be46aa914061ada0a106e6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2ODkyNA==", "bodyText": "We use the cancellable  even if the low level cancellation is set to false (query timeout option and bulk scorer) so we should never set the cancellable to null ?", "url": "https://github.com/elastic/elasticsearch/pull/53978#discussion_r396468924", "createdAt": "2020-03-23T13:56:33Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/internal/ContextIndexSearcher.java", "diffHunk": "@@ -82,18 +82,14 @@\n     private MutableQueryTimeout cancellable;\n \n     public ContextIndexSearcher(IndexReader reader, Similarity similarity,\n-                                QueryCache queryCache, QueryCachingPolicy queryCachingPolicy) throws IOException {\n-        this(reader, similarity, queryCache, queryCachingPolicy, new MutableQueryTimeout());\n+                                QueryCache queryCache, QueryCachingPolicy queryCachingPolicy,\n+                                boolean wrapWithExitableDirReader) throws IOException {\n+        this(reader, similarity, queryCache, queryCachingPolicy, wrapWithExitableDirReader ? new MutableQueryTimeout() : null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "828ca8a13796219890be46aa914061ada0a106e6"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f23bc76a7cab3840bd9d9861066bb48f56054bd", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f23bc76a7cab3840bd9d9861066bb48f56054bd", "committedDate": "2020-03-23T16:35:38Z", "message": "Reduce performance impact of ExitableDirectoryReader\n\nBenchmarking showed that the effect of the ExitableDirectoryReader\nis reduced considerably when checking every 4095 docs. Moreover,\nset the cancellable task before calling QueryPhase.preProcess()\nand make sure we don't wrap with an ExitableDirectoryReader at all\nwhen lowLevelCancellation() is set to false to avoid completely any\nperformance impact.\n\nFollows: #52822\nFollows: #53166\nFollows: #53496"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "701af61782113f3d4d032575da63f5413bbae4eb", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/701af61782113f3d4d032575da63f5413bbae4eb", "committedDate": "2020-03-23T15:46:34Z", "message": "fixup! fixup! fixup! Reduce performance impact of ExitableDirectoryReader"}, "afterCommit": {"oid": "8f23bc76a7cab3840bd9d9861066bb48f56054bd", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f23bc76a7cab3840bd9d9861066bb48f56054bd", "committedDate": "2020-03-23T16:35:38Z", "message": "Reduce performance impact of ExitableDirectoryReader\n\nBenchmarking showed that the effect of the ExitableDirectoryReader\nis reduced considerably when checking every 4095 docs. Moreover,\nset the cancellable task before calling QueryPhase.preProcess()\nand make sure we don't wrap with an ExitableDirectoryReader at all\nwhen lowLevelCancellation() is set to false to avoid completely any\nperformance impact.\n\nFollows: #52822\nFollows: #53166\nFollows: #53496"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f62cd42f6d1c4be0f4bd1574a6edf14beddcfea", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f62cd42f6d1c4be0f4bd1574a6edf14beddcfea", "committedDate": "2020-03-23T16:53:26Z", "message": "revert throttling in compare"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NjI5OTc0", "url": "https://github.com/elastic/elasticsearch/pull/53978#pullrequestreview-379629974", "createdAt": "2020-03-23T17:00:23Z", "commit": {"oid": "8f62cd42f6d1c4be0f4bd1574a6edf14beddcfea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f32491949d699823e784d06f0a2b1da22056d2a8", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/f32491949d699823e784d06f0a2b1da22056d2a8", "committedDate": "2020-03-23T17:05:10Z", "message": "change to 8191"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1786, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}