{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwODM2OTM3", "number": 54953, "title": "Check for negative \"from\" values in search request body", "bodyText": "Today we already disallow negative values for the \"from\" parameter in the search\nAPI when it is set as a request parameter and setting it on the\nSearchSourceBuilder, but it is still parsed without complaint from a search\nbody, leading to different, confusing exceptions later on. This PR changes\nthis behavior to be the same regardless of setting the value directly, as url\nparameter or in the search body. Values of -1 are still allowed as the current\ndefault, meaning an unset value, in order not to break existing searches and\ntemplates using this.\nCloses #54897", "createdAt": "2020-04-08T13:06:56Z", "url": "https://github.com/elastic/elasticsearch/pull/54953", "merged": true, "mergeCommit": {"oid": "3d4f9fedafde4450582372f9d66d2f3a2953867b"}, "closed": true, "closedAt": "2020-05-28T14:25:20Z", "author": {"login": "cbuescher"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVnkatAH2gAyNDAwODM2OTM3OjI4NTllNTFkNTFjODcwOWU2NjkwN2RjYmQ2MmVkZTVjNzhkYjFjODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcluU-AgFqTQyMDEzNjM5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2859e51d51c8709e66907dcbd62ede5c78db1c89", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/2859e51d51c8709e66907dcbd62ede5c78db1c89", "committedDate": "2020-04-08T13:04:34Z", "message": "Forbid negative \"from\" in search request body\n\nToday we already disallow negative values for the \"from\" parameter in the search\nAPI when it is set as a request parameter and setting it on the\nSearchSourceBuilder, but it is still parsed without complaint from a search\nbody, leading to differing exceptions later. This PR changes this behavior to be\nthe same regardless of setting the value directly, as url parameter or in the\nsearch body. Values of -1 are still allowed as the current default, meaning an\nunset value, in order not to break existing searches and templates using this.\n\nCloses #54897"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b9784c100f52eaa7f0d9a822e50f2a316361f3d", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b9784c100f52eaa7f0d9a822e50f2a316361f3d", "committedDate": "2020-04-08T13:26:59Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c696cc882edbb8ffa21625e6b6750e72c1ae318c", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/c696cc882edbb8ffa21625e6b6750e72c1ae318c", "committedDate": "2020-04-08T13:32:59Z", "message": "skip on mixed cluster for now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e631cb2713da3448f65bf33f2a52c23774727b3", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e631cb2713da3448f65bf33f2a52c23774727b3", "committedDate": "2020-04-08T15:31:45Z", "message": "Merge branch 'master' into fix-54897"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTk5ODcx", "url": "https://github.com/elastic/elasticsearch/pull/54953#pullrequestreview-390199871", "createdAt": "2020-04-08T17:51:51Z", "commit": {"oid": "9e631cb2713da3448f65bf33f2a52c23774727b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo1MTo1MVrOGC6Wkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo1MjoxNlrOGC6XVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNjM4Ng==", "bodyText": "Can we try to address this ? For instance we could set the default value directly rather than delaying this to the creation of the search context ?", "url": "https://github.com/elastic/elasticsearch/pull/54953#discussion_r405706386", "createdAt": "2020-04-08T17:51:51Z", "author": {"login": "jimczi"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "diffHunk": "@@ -26,14 +26,49 @@ setup:\n         from: 10000\n \n ---\n-\"Request with negative from value\":\n+\"Request with negative from value url parameter\":\n+\n+  - skip:\n+      version: \" - 7.9.99\"\n+      reason: waiting for backport\n+\n   - do:\n-      catch:      /\\[from\\] parameter cannot be negative/\n+      search:\n+        rest_total_hits_as_int: true\n+        index: test_1\n+        # value of -1 should be accepted as unset value\n+        from: -1\n+\n+  - do:\n+      catch:      /\\[from\\] parameter cannot be negative but was \\[-2\\]/\n       search:\n         rest_total_hits_as_int: true\n         index: test_1\n         from: -2\n \n+---\n+\"Request with negative from value in body\":\n+\n+  - skip:\n+      version: \" - 7.9.99\"\n+      reason: waiting for backport\n+\n+  - do:\n+      search:\n+        rest_total_hits_as_int: true\n+        index: test_1\n+        # value of -1 should be accepted as unset value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e631cb2713da3448f65bf33f2a52c23774727b3"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNjU4MQ==", "bodyText": "Can we set the default early so that we can refuse any negative values ?", "url": "https://github.com/elastic/elasticsearch/pull/54953#discussion_r405706581", "createdAt": "2020-04-08T17:52:16Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/builder/SearchSourceBuilder.java", "diffHunk": "@@ -336,10 +336,13 @@ public QueryBuilder postFilter() {\n \n     /**\n      * From index to start the search from. Defaults to {@code 0}.\n+     * A value of -1 is interpreted as an unset value equivalent to 0.\n+     * Any other negative value is forbidden.\n      */\n     public SearchSourceBuilder from(int from) {\n-        if (from < 0) {\n-            throw new IllegalArgumentException(\"[from] parameter cannot be negative\");\n+        // accept -1 as the default unset value without error", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e631cb2713da3448f65bf33f2a52c23774727b3"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMjgyNjg5", "url": "https://github.com/elastic/elasticsearch/pull/54953#pullrequestreview-390282689", "createdAt": "2020-04-08T19:52:04Z", "commit": {"oid": "9e631cb2713da3448f65bf33f2a52c23774727b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOTo1MjowNFrOGC-f-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxOTo1MjowNFrOGC-f-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc3NDMzMA==", "bodyText": "Small comment, I think 'Neither value can be negative.' would be clearer.", "url": "https://github.com/elastic/elasticsearch/pull/54953#discussion_r405774330", "createdAt": "2020-04-08T19:52:04Z", "author": {"login": "jtibshirani"}, "path": "docs/reference/search/request/from-size.asciidoc", "diffHunk": "@@ -6,9 +6,9 @@ parameters. The `from` parameter defines the offset from the first\n result you want to fetch. The `size` parameter allows you to configure\n the maximum amount of hits to be returned.\n \n-Though `from` and `size` can be set as request parameters, they can also\n-be set within the search body. `from` defaults to `0`, and `size`\n-defaults to `10`.\n+Though `from` and `size` can be set as request parameters, they can also be set\n+within the search body. `from` defaults to `0`, and `size` defaults to `10`.\n+Both values cannot be negative.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e631cb2713da3448f65bf33f2a52c23774727b3"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d1602ae4683138e8fbf42a7336d31cae6822f9f", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d1602ae4683138e8fbf42a7336d31cae6822f9f", "committedDate": "2020-04-09T10:50:21Z", "message": "change wording"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa1efcfae8de551dca9f54ef400e14e6e470ec5d", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa1efcfae8de551dca9f54ef400e14e6e470ec5d", "committedDate": "2020-05-27T13:04:51Z", "message": "Merge branch 'master' into fix-54897"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33838e03cbbb01a262e77cddb77e8ca309c337d0", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/33838e03cbbb01a262e77cddb77e8ca309c337d0", "committedDate": "2020-05-27T16:51:49Z", "message": "Make -1 an invalid  parameter setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2ddd1fd67c91fb949d931b8f3f97e1ca6eef3c4", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a2ddd1fd67c91fb949d931b8f3f97e1ca6eef3c4", "committedDate": "2020-05-28T09:03:52Z", "message": "Merge branch 'master' into fix-54897"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTM2Mzk1", "url": "https://github.com/elastic/elasticsearch/pull/54953#pullrequestreview-420136395", "createdAt": "2020-05-28T13:59:49Z", "commit": {"oid": "a2ddd1fd67c91fb949d931b8f3f97e1ca6eef3c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3597, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}