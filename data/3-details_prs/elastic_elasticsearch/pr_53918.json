{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxODYzMTI2", "number": 53918, "title": "[ML] Introduce a \"starting\" datafeed state for lazy jobs", "bodyText": "It is possible for ML jobs to open lazily if the \"allow_lazy_open\"\noption in the job config is set to true.  Such jobs wait in the\n\"opening\" state until a node has sufficient capacity to run them.\nThis commit fixes the bug that prevented datafeeds for jobs lazily\nwaiting assignment from being started.  The state of such datafeeds\nis \"starting\", and they can be stopped by the stop datafeed API\nwhile in this state with or without force.\nFixes #53763", "createdAt": "2020-03-21T14:09:43Z", "url": "https://github.com/elastic/elasticsearch/pull/53918", "merged": true, "mergeCommit": {"oid": "cbe063a074787960d198c12f9f93886745f01618"}, "closed": true, "closedAt": "2020-03-24T10:01:14Z", "author": {"login": "droberts195"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcP1nRygH2gAyMzkxODYzMTI2OmMzODZkYzIwMzBkNTkyM2VlMTQzOTQ4NDBmNTE5NTEyODJlM2ZjNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQgMkvAH2gAyMzkxODYzMTI2Ojg1ZTVmYmM4ZmYzMGM2ZjMzOWUyMTYzMTdmNDZhNjMwYzU2ZjhiZGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c386dc2030d5923ee14394840f51951282e3fc5f", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/c386dc2030d5923ee14394840f51951282e3fc5f", "committedDate": "2020-03-21T14:02:49Z", "message": "[ML] Introduce a \"starting\" datafeed state for lazy jobs\n\nIt is possible for ML jobs to open lazily if the \"allow_lazy_open\"\noption in the job config is set to true.  Such jobs wait in the\n\"opening\" state until a node has sufficient capacity to run them.\n\nThis commit fixes the bug that prevented datafeeds for jobs lazily\nwaiting assignment from being started.  The state of such datafeeds\nis \"starting\", and they can be stopped by the stop datafeed API\nwhile in this state with or without force.\n\nRelates #53763"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4OTIxNDAy", "url": "https://github.com/elastic/elasticsearch/pull/53918#pullrequestreview-378921402", "createdAt": "2020-03-21T14:12:03Z", "commit": {"oid": "c386dc2030d5923ee14394840f51951282e3fc5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNDoxMjowNFrOF5pqzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNDoxMjowNFrOF5pqzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NTg1NA==", "bodyText": "The stopping state is not introduced by this PR - it has existed for a couple of years.  But I thought I'd add it while I was modifying the list.\n(This PR exposes the starting state externally for the first time, so it's understandable it wasn't previously documented.)", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r395995854", "createdAt": "2020-03-21T14:12:04Z", "author": {"login": "droberts195"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -1388,7 +1388,10 @@ tag::state-datafeed[]\n The status of the {dfeed}, which can be one of the following values:\n +\n --\n+* `starting`: The {dfeed} has been requested to start but has not yet started.\n * `started`: The {dfeed} is actively receiving data.\n+* `stopping`: The {dfeed} has been requested to stop gracefully and is\n+completing its final action.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c386dc2030d5923ee14394840f51951282e3fc5f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a08fda32aa7b60d881b46b54ec9fad3a550cd639", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/a08fda32aa7b60d881b46b54ec9fad3a550cd639", "committedDate": "2020-03-21T14:39:25Z", "message": "Lazy open/start needs to return true for UI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4OTcwNzA3", "url": "https://github.com/elastic/elasticsearch/pull/53918#pullrequestreview-378970707", "createdAt": "2020-03-22T04:12:06Z", "commit": {"oid": "a08fda32aa7b60d881b46b54ec9fad3a550cd639"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwNDoxMjowN1rOF5tH5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMlQwNDoxMjowN1rOF5tH5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjA1MjQ1Mg==", "bodyText": "Do we want to return \"opened\": true even though the job is not in the opened state yet?", "url": "https://github.com/elastic/elasticsearch/pull/53918#discussion_r396052452", "createdAt": "2020-03-22T04:12:07Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportOpenJobAction.java", "diffHunk": "@@ -554,6 +554,7 @@ public boolean test(PersistentTasksCustomMetaData.PersistentTask<?> persistentTa\n \n                 // This means we are awaiting a new node to be spun up, ok to return back to the user to await node creation\n                 if (assignment != null && assignment.equals(JobNodeSelector.AWAITING_LAZY_ASSIGNMENT)) {\n+                    opened = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a08fda32aa7b60d881b46b54ec9fad3a550cd639"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23e48cfa54ffa44cd128237f2c780a3228914f5f", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/23e48cfa54ffa44cd128237f2c780a3228914f5f", "committedDate": "2020-03-23T12:04:21Z", "message": "Adjust test result"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDU0MTc1", "url": "https://github.com/elastic/elasticsearch/pull/53918#pullrequestreview-379454175", "createdAt": "2020-03-23T13:59:14Z", "commit": {"oid": "23e48cfa54ffa44cd128237f2c780a3228914f5f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e31bea92ab7cb43cd154fa875b67cd8bf7c62870", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/e31bea92ab7cb43cd154fa875b67cd8bf7c62870", "committedDate": "2020-03-23T14:08:03Z", "message": "Revert test response format change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85e5fbc8ff30c6f339e216317f46a630c56f8bda", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/85e5fbc8ff30c6f339e216317f46a630c56f8bda", "committedDate": "2020-03-23T15:39:34Z", "message": "opened is now pointless as it's just the inverse of shouldCancel"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1739, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}