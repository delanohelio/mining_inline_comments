{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NTQzNjc0", "number": 63224, "title": "Bulk invalidate API keys using a list of IDs", "bodyText": "Following discussions in #47609, I am reverting back to the approach of adding a new ids field to support bulk invalidation by specifying an array of API key ids.\nThis PR intentionally keeps the existing id field as is on the API level. Deprecation may as well be introduced for it in the future. But it is not done in this PR to reduce the scope.\nI would also like to raise the priority of this PR because of #59376, where a new cache is introduced for API key document. The new cache requires a cache clear call to be issued after API key invalidation. It is helpful if the cache clear call is issued for a collection of API key ids instead of one for each of them. Hence being able to specifiying multiple IDs for invalidation improves the efficiency of the cache clearing call.\nResolves: #47609\nSupersedes: #63081, #63127", "createdAt": "2020-10-05T02:19:06Z", "url": "https://github.com/elastic/elasticsearch/pull/63224", "merged": true, "mergeCommit": {"oid": "472efefc8052dbbb3b2b4f46a2792fed6be17788"}, "closed": true, "closedAt": "2020-10-06T10:54:43Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPaCXggH2gAyNDk3NTQzNjc0OmIyZThmMDc0OTZmODRlNDA0NDM1NTQyYjI1NDNlOWFlMjM2Y2I3OTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP1UgcAFqTUwMjc3MTE0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b2e8f07496f84e404435542b2543e9ae236cb790", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2e8f07496f84e404435542b2543e9ae236cb790", "committedDate": "2020-10-05T02:06:13Z", "message": "Add ids field to API key invalidation request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2ce92a4cf32e6ee23b1fbd6c7109be7c77cd7b1", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2ce92a4cf32e6ee23b1fbd6c7109be7c77cd7b1", "committedDate": "2020-10-05T02:59:55Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/e9eec11b43b00c2ad0be8aca077cd639578a7f6b", "committedDate": "2020-10-05T05:45:36Z", "message": "Add yaml test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNzQ5NTc5", "url": "https://github.com/elastic/elasticsearch/pull/63224#pullrequestreview-501749579", "createdAt": "2020-10-05T06:26:35Z", "commit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjoyNjozNVrOHcO-Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjozNzowMFrOHcPLXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2NzUxOA==", "bodyText": "Nit: Can we move this field up to where id used to be, so that the order matches serialization?", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499367518", "createdAt": "2020-10-05T06:26:35Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequest.java", "diffHunk": "@@ -26,19 +28,24 @@\n \n     private final String realmName;\n     private final String userName;\n-    private final String id;\n     private final String name;\n     private final boolean ownedByAuthenticatedUser;\n+    private final String[] ids;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2ODEzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        validationException = addValidationError(\"One of [api key id, api key name, username, realm name] must be specified if \" +\n          \n          \n            \n                        validationException = addValidationError(\"One of [api key id(s), api key name, username, realm name] must be specified if \" +", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499368133", "createdAt": "2020-10-05T06:28:19Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequest.java", "diffHunk": "@@ -141,12 +161,25 @@ public static InvalidateApiKeyRequest forOwnedApiKeys() {\n     @Override\n     public ActionRequestValidationException validate() {\n         ActionRequestValidationException validationException = null;\n-        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && Strings.hasText(id) == false\n+        if (ids != null) {\n+            if (ids.length == 0) {\n+                validationException = addValidationError(\"Field [ids] cannot be an empty array\", validationException);\n+            } else {\n+                final int[] idxOfBlankIds = IntStream.range(0, ids.length).filter(i -> Strings.hasText(ids[i]) == false).toArray();\n+                if (idxOfBlankIds.length > 0) {\n+                    validationException = addValidationError(\"Field [ids] must not contain blank id, but got blank \"\n+                        + (idxOfBlankIds.length == 1 ? \"id\" : \"ids\") + \" at index \"\n+                        + (idxOfBlankIds.length == 1 ? \"position\" : \"positions\") + \": \"\n+                        + Arrays.toString(idxOfBlankIds), validationException);\n+                }\n+            }\n+        }\n+        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && ids == null\n             && Strings.hasText(name) == false && ownedByAuthenticatedUser == false) {\n             validationException = addValidationError(\"One of [api key id, api key name, username, realm name] must be specified if \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2ODQwMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"username or realm name must not be specified when the api key id or api key name is specified\",\n          \n          \n            \n                                \"username or realm name must not be specified when the api key id(s) or api key name are specified\",", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499368402", "createdAt": "2020-10-05T06:29:09Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequest.java", "diffHunk": "@@ -141,12 +161,25 @@ public static InvalidateApiKeyRequest forOwnedApiKeys() {\n     @Override\n     public ActionRequestValidationException validate() {\n         ActionRequestValidationException validationException = null;\n-        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && Strings.hasText(id) == false\n+        if (ids != null) {\n+            if (ids.length == 0) {\n+                validationException = addValidationError(\"Field [ids] cannot be an empty array\", validationException);\n+            } else {\n+                final int[] idxOfBlankIds = IntStream.range(0, ids.length).filter(i -> Strings.hasText(ids[i]) == false).toArray();\n+                if (idxOfBlankIds.length > 0) {\n+                    validationException = addValidationError(\"Field [ids] must not contain blank id, but got blank \"\n+                        + (idxOfBlankIds.length == 1 ? \"id\" : \"ids\") + \" at index \"\n+                        + (idxOfBlankIds.length == 1 ? \"position\" : \"positions\") + \": \"\n+                        + Arrays.toString(idxOfBlankIds), validationException);\n+                }\n+            }\n+        }\n+        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && ids == null\n             && Strings.hasText(name) == false && ownedByAuthenticatedUser == false) {\n             validationException = addValidationError(\"One of [api key id, api key name, username, realm name] must be specified if \" +\n                 \"[owner] flag is false\", validationException);\n         }\n-        if (Strings.hasText(id) || Strings.hasText(name)) {\n+        if (ids != null || Strings.hasText(name)) {\n             if (Strings.hasText(realmName) || Strings.hasText(userName)) {\n                 validationException = addValidationError(\n                     \"username or realm name must not be specified when the api key id or api key name is specified\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2OTYxNw==", "bodyText": "Oh wow. I can't believe we need to have this. We definitely need to look at removing this class in a follow up PR.", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499369617", "createdAt": "2020-10-05T06:33:04Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/action/InvalidateApiKeyRequestTests.java", "diffHunk": "@@ -69,7 +110,15 @@ public void writeTo(StreamOutput out) throws IOException {\n                 super.writeTo(out);\n                 out.writeOptionalString(realm);\n                 out.writeOptionalString(user);\n-                out.writeOptionalString(apiKeyId);\n+                if (out.getVersion().onOrAfter(Version.V_7_10_0)) {\n+                    if (Strings.hasText(apiKeyId)) {\n+                        out.writeOptionalStringArray(new String[] { apiKeyId });\n+                    } else {\n+                        out.writeOptionalStringArray(null);\n+                    }\n+                } else {\n+                    out.writeOptionalString(apiKeyId);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3MDg0Nw==", "bodyText": "Did you consider putting key _1 in here, and checking previously_invalidated_api_keys: 1 ?\nIt seems like a useful test of the error handling for multiple ids.", "url": "https://github.com/elastic/elasticsearch/pull/63224#discussion_r499370847", "createdAt": "2020-10-05T06:37:00Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/api_key/10_basic.yml", "diffHunk": "@@ -214,10 +214,58 @@ teardown:\n       security.invalidate_api_key:\n         body:  >\n             {\n-              \"id\": \"${api_key_id}\"\n+              \"id\": \"${api_key_id_1}\"\n             }\n   - length: { \"invalidated_api_keys\" : 1 }\n-  - match: { \"invalidated_api_keys.0\" : \"${api_key_id}\" }\n+  - match: { \"invalidated_api_keys.0\" : \"${api_key_id_1}\" }\n+  - length: { \"previously_invalidated_api_keys\" : 0 }\n+  - match: { \"error_count\" : 0 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.create_api_key:\n+        body:  >\n+          {\n+            \"name\": \"my-api-key-2\",\n+            \"expiration\": \"1d\",\n+            \"role_descriptors\": {\n+            }\n+          }\n+  - match: { name: \"my-api-key-2\" }\n+  - is_true: id\n+  - is_true: api_key\n+  - is_true: expiration\n+  - set: { id: api_key_id_2 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.create_api_key:\n+        body:  >\n+          {\n+            \"name\": \"my-api-key-3\",\n+            \"expiration\": \"1d\",\n+            \"role_descriptors\": {\n+            }\n+          }\n+  - match: { name: \"my-api-key-3\" }\n+  - is_true: id\n+  - is_true: api_key\n+  - is_true: expiration\n+  - set: { id: api_key_id_3 }\n+\n+  - do:\n+      headers:\n+        Authorization: \"Basic YXBpX2tleV91c2VyOngtcGFjay10ZXN0LXBhc3N3b3Jk\" # api_key_user\n+      security.invalidate_api_key:\n+        body:  >\n+          {\n+            \"ids\": [ \"${api_key_id_2}\", \"${api_key_id_3}\" ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9eec11b43b00c2ad0be8aca077cd639578a7f6b"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a2fc5c9a996c1c224a39a7844be7babdb372168", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a2fc5c9a996c1c224a39a7844be7babdb372168", "committedDate": "2020-10-05T07:49:39Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20a1d8aeec2464cee2becee82c4444b400067941", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/20a1d8aeec2464cee2becee82c4444b400067941", "committedDate": "2020-10-05T10:47:35Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Tim Vernum <tim@adjective.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9129e931858c6ba001cb7ad9009e6120f704f8e8", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/9129e931858c6ba001cb7ad9009e6120f704f8e8", "committedDate": "2020-10-05T10:52:16Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96c32832caa77f89e371ec56a89936d8caa528c3", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/96c32832caa77f89e371ec56a89936d8caa528c3", "committedDate": "2020-10-05T11:45:19Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzcxMTQx", "url": "https://github.com/elastic/elasticsearch/pull/63224#pullrequestreview-502771141", "createdAt": "2020-10-06T09:53:28Z", "commit": {"oid": "96c32832caa77f89e371ec56a89936d8caa528c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4391, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}