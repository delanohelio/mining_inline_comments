{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1OTczOTE5", "number": 64632, "title": "Revert Serializing Outbound Transport Messages on IO Threads", "bodyText": "Serializing outbound transport message on the IO loop was introduced in #56961. Unfortunately it turns out that this is incompatible with assumptions made by CCR code here: \n  \n    \n      elasticsearch/x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/repositories/GetCcrRestoreFileChunkAction.java\n    \n    \n        Lines 60 to 61\n      in\n      f22ddf8\n    \n    \n    \n    \n\n        \n          \n           // This is currently safe to do because calling `onResponse` will serialize the bytes to the network layer data \n        \n\n        \n          \n           // structure on the same thread. So the bytes will be copied before the reference is released. \n        \n    \n  \n\n and that are not easy to work around on short notice.\nRaising reverting this move (as a temporary solution, it's still a valuable change long-term) as a blocker therefore as this seriously affects the stability of the initial phase of the CCR following by causing corrupted bytes to be send to the follower.", "createdAt": "2020-11-05T10:55:02Z", "url": "https://github.com/elastic/elasticsearch/pull/64632", "merged": true, "mergeCommit": {"oid": "9b4a151005143a1d6a9e9b18603635863ca49215"}, "closed": true, "closedAt": "2020-11-05T13:41:31Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZf6UfAH2gAyNTE1OTczOTE5OmJlODNmMzJjM2M2MGNiNjYzZjAzOWU2ODRmODkyNTc0NWJjMzdlYWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZiELugFqTUyNDI0MDIwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "be83f32c3c60cb663f039e684f8925745bc37eab", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/be83f32c3c60cb663f039e684f8925745bc37eab", "committedDate": "2020-11-05T10:36:06Z", "message": "Revert \"Serialize Outbound Message on Flush (#57084)\"\n\nThis reverts commit beb3e493f3a198a480464ff8edda95332ae3c6ba."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4143b66167e0ea196f787caa4e0442da0e50e98", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b4143b66167e0ea196f787caa4e0442da0e50e98", "committedDate": "2020-11-05T10:48:30Z", "message": "Revert \"Serialize Outbound Messages on IO Threads (#56961)\"\n\nThis reverts commit 2a8b5787466c1e2e478c266db76bd2fba580c1ce."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MjIyMTk4", "url": "https://github.com/elastic/elasticsearch/pull/64632#pullrequestreview-524222198", "createdAt": "2020-11-05T12:43:06Z", "commit": {"oid": "b4143b66167e0ea196f787caa4e0442da0e50e98"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMjo0MzowNlrOHuBi7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMjo0MzozOFrOHuBkQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyMTg3MA==", "bodyText": "Think we can keep this assertion? It relates to #57792.", "url": "https://github.com/elastic/elasticsearch/pull/64632#discussion_r518021870", "createdAt": "2020-11-05T12:43:06Z", "author": {"login": "DaveCTurner"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/netty4/Netty4MessageChannelHandler.java", "diffHunk": "@@ -93,15 +91,14 @@ public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {\n \n     @Override\n     public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {\n-        assert msg instanceof OutboundHandler.SendContext;\n-        assert Transports.assertDefaultThreadContext(transport.getThreadPool().getThreadContext());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4143b66167e0ea196f787caa4e0442da0e50e98"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODAyMjIxMA==", "bodyText": "Think we can keep this comment? It relates to #57792.", "url": "https://github.com/elastic/elasticsearch/pull/64632#discussion_r518022210", "createdAt": "2020-11-05T12:43:38Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/transport/OutboundHandler.java", "diffHunk": "@@ -115,17 +120,16 @@ private void sendMessage(TcpChannel channel, OutboundMessage networkMessage, Act\n         internalSend(channel, sendContext);\n     }\n \n-    private void internalSend(TcpChannel channel, SendContext sendContext) {\n+    private void internalSend(TcpChannel channel, SendContext sendContext) throws IOException {\n         channel.getChannelStats().markAccessed(threadPool.relativeTimeInMillis());\n-        // stash thread context so that channel event loop is not polluted by thread context", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4143b66167e0ea196f787caa4e0442da0e50e98"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec417d1ed39a6393c1bd84f5ded7cd9cd8bfc336", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/ec417d1ed39a6393c1bd84f5ded7cd9cd8bfc336", "committedDate": "2020-11-05T12:52:44Z", "message": "CR: comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MjQwMjA2", "url": "https://github.com/elastic/elasticsearch/pull/64632#pullrequestreview-524240206", "createdAt": "2020-11-05T13:06:41Z", "commit": {"oid": "ec417d1ed39a6393c1bd84f5ded7cd9cd8bfc336"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1294, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}