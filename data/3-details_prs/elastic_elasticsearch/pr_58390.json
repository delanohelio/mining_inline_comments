{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NDI2ODEz", "number": 58390, "title": "Fix Incorrect Snapshot Shar Status for DONE Shards in Running Snapshots", "bodyText": "Minor bugs/inconsistencies:\nIf a shard hasn't changed at all we were reporting 0 for total size and total file count\nwhile it was ongoing.\nIf a data node restarts/drops out during snapshot creation the fallback logic did not load the correct statistic from the repository but just created a status with 0 counts from the snapshot state in the CS. Added a fallback to reading from the repository in this case.", "createdAt": "2020-06-20T15:40:40Z", "url": "https://github.com/elastic/elasticsearch/pull/58390", "merged": true, "mergeCommit": {"oid": "84f7e54b48c6114f928d42c2d1b48b1ddb1a353d"}, "closed": true, "closedAt": "2020-06-26T12:37:04Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctJhkQgH2gAyNDM3NDI2ODEzOjVkYTIyODJjY2JkYzA1MTAyOWJhNDkwM2M5NTdkODU5OGFhNWY4ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvAx_2AH2gAyNDM3NDI2ODEzOmEyMmVlOTQyYWY0MWJmZmExYjFiNjM5MzNlNmQyMjZhM2Y3NTg1Zjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5da2282ccbdc051029ba4903c957d8598aa5f8df", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/5da2282ccbdc051029ba4903c957d8598aa5f8df", "committedDate": "2020-06-20T15:38:29Z", "message": "Fix Incorrect Snapshot Shard Level Status for Unchanged Shard Snapshots\n\nMinor bug:\nIf a shard hasn't changed at all we were reporting `0` for total size and total file count\nwhile it was ongoing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "052b4942cef7e0d7da1000a750cbd13cc78586f1", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/052b4942cef7e0d7da1000a750cbd13cc78586f1", "committedDate": "2020-06-20T15:52:41Z", "message": "enhance tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3832aee3bfa354611d485f84f64e00243aec7635", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/3832aee3bfa354611d485f84f64e00243aec7635", "committedDate": "2020-06-20T17:12:51Z", "message": "fix other spot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDk0NjY1", "url": "https://github.com/elastic/elasticsearch/pull/58390#pullrequestreview-436494665", "createdAt": "2020-06-24T09:50:26Z", "commit": {"oid": "3832aee3bfa354611d485f84f64e00243aec7635"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc805a747d34c22f5e34cfe8774dd5b40d6e5332", "committedDate": "2020-06-25T18:46:18Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-total-file-counts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MTc0Nzc2", "url": "https://github.com/elastic/elasticsearch/pull/58390#pullrequestreview-438174776", "createdAt": "2020-06-26T10:07:32Z", "commit": {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDowNzozMlrOGpbW6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDoxNDo0NVrOGpbj3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5MzAzMg==", "bodyText": "why create a copy here?", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446093032", "createdAt": "2020-06-26T10:07:32Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/status/TransportSnapshotsStatusAction.java", "diffHunk": "@@ -199,7 +204,20 @@ private void buildResponse(SnapshotsInProgress snapshotsInProgress, SnapshotsSta\n                         default:\n                             throw new IllegalArgumentException(\"Unknown snapshot state \" + shardEntry.value.state());\n                     }\n-                    SnapshotIndexShardStatus shardStatus = new SnapshotIndexShardStatus(shardEntry.key, stage);\n+                    final SnapshotIndexShardStatus shardStatus;\n+                    if (stage == SnapshotIndexShardStage.DONE) {\n+                        // Shard snapshot completed successfully so we should be able to load the exact statistics for this\n+                        // shard from the repository already.\n+                        if (indexIdLookup == null) {\n+                            indexIdLookup = entry.indices().stream().collect(Collectors.toMap(IndexId::getName, Function.identity()));\n+                        }\n+                        final ShardId shardId = shardEntry.key;\n+                        shardStatus = new SnapshotIndexShardStatus(shardId, repositoriesService.repository(entry.repository())\n+                            .getShardSnapshotStatus(entry.snapshot().getSnapshotId(), indexIdLookup.get(shardId.getIndexName()),\n+                                shardId).asCopy());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5MzkwMA==", "bodyText": "space missing", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446093900", "createdAt": "2020-06-26T10:09:26Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1796,6 +1796,10 @@ public void snapshotShard(Store store, MapperService mapperService, SnapshotId s\n                     }\n                 }\n             } else {\n+                for (BlobStoreIndexShardSnapshot.FileInfo fileInfo : filesFromSegmentInfos) {\n+                    indexTotalNumberOfFiles++;\n+                    indexTotalFileSize+= fileInfo.length();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5NjM0OQ==", "bodyText": "can you add some javadocs to this method to describe what exact situation is being tested here? There are a large number of steps in the test, and it might be easier to have a high-level  description of what's  going on  here.", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446096349", "createdAt": "2020-06-26T10:14:45Z", "author": {"login": "ywelsch"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotStatusApisIT.java", "diffHunk": "@@ -189,4 +193,102 @@ public void testGetSnapshotsWithoutIndices() {\n         assertThat(found.snapshotId(), is(snapshotInfo.snapshotId()));\n         assertThat(found.state(), is(SnapshotState.SUCCESS));\n     }\n+\n+    public void testCorrectCountsForDoneShards() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "445c608b99d15c2ac1eb933dc8b4a21567e40e2f", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/445c608b99d15c2ac1eb933dc8b4a21567e40e2f", "committedDate": "2020-06-26T10:28:38Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-total-file-counts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a22ee942af41bffa1b1b63933e6d226a3f7585f9", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a22ee942af41bffa1b1b63933e6d226a3f7585f9", "committedDate": "2020-06-26T10:35:08Z", "message": "javadocs + format"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 325, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}