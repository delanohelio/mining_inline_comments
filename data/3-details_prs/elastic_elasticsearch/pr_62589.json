{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4OTY4NzI1", "number": 62589, "title": "Add index.routing.allocation.include._tier_preference setting", "bodyText": "This commit adds the index.routing.allocation.include._tier_preference setting to the\nDataTierAllocationDecider. This special-purpose allocation setting lets a user specify a\npreference-based list of tiers for an index to be assigned to. For example, if the setting were set\nto:\n\"index.routing.allocation.include._tier_preference\": \"data_hot,data_warm,data_content\"\n\nIf the cluster contains any nodes with the data_hot role, the decider will only allow them to be\nallocated on the data_hot node(s). If there are no data_hot nodes, but there are data_warm and\ndata_content nodes, then the index will be allowed to be allocated on data_warm nodes.\nThis allows us to specify an index's preference for tier(s) without causing the index to be\nunassigned if no nodes of a preferred tier are available.\nSubsequent work will change the ILM migration to make additional use of this setting.\nRelates to #60848", "createdAt": "2020-09-17T22:43:49Z", "url": "https://github.com/elastic/elasticsearch/pull/62589", "merged": true, "mergeCommit": {"oid": "0c3599577e18a04e3d29b24f8c5c2f801b9a7585"}, "closed": true, "closedAt": "2020-09-18T20:49:59Z", "author": {"login": "dakrone"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ44PYAH2gAyNDg4OTY4NzI1Ojg3MmY1ZTdmOGQ3NzExYWNiYzA5MzBlYWVhYjJhYTk2NTFiMzZiZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKLaI1gFqTQ5MTc1MzkwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "872f5e7f8d7711acbc0930eaeab2aa9651b36bf6", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/872f5e7f8d7711acbc0930eaeab2aa9651b36bf6", "committedDate": "2020-09-17T22:38:40Z", "message": "Add index.routing.allocation.prefer._tier setting\n\nThis commit adds the `index.routing.allocation.prefer._tier` setting to the\n`DataTierAllocationDecider`. This special-purpose allocation setting lets a user specify a\npreference-based list of tiers for an index to be assigned to. For example, if the setting were set\nto:\n\n```\n\"index.routing.allocation.prefer._tier\": \"data_hot,data_warm,data_content\"\n```\n\nIf the cluster contains any nodes with the `data_hot` role, the decider will only allow them to be\nallocated on the `data_hot` node(s). If there are no `data_hot` nodes, but there are `data_warm` and\n`data_content` nodes, then the index will be allowed to be allocated on `data_warm` nodes.\n\nThis allows us to specify an index's preference for tier(s) without causing the index to be\nunassigned if no nodes of a preferred tier are available.\n\nSubsequent work will change the ILM migration to make additional use of this setting.\n\nRelates to #60848"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNDU2NDQw", "url": "https://github.com/elastic/elasticsearch/pull/62589#pullrequestreview-491456440", "createdAt": "2020-09-18T13:19:28Z", "commit": {"oid": "872f5e7f8d7711acbc0930eaeab2aa9651b36bf6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMzoxOToyOFrOHUMzhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMzoyMjozMVrOHUM6_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk0MzM2NA==", "bodyText": "would this be better named as preferedAvailableTier or preferedPresentTier?", "url": "https://github.com/elastic/elasticsearch/pull/62589#discussion_r490943364", "createdAt": "2020-09-18T13:19:28Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/cluster/routing/allocation/DataTierAllocationDecider.java", "diffHunk": "@@ -186,6 +231,29 @@ private Decision shouldClusterFilter(DiscoveryNode node, RoutingAllocation alloc\n         OR\n     }\n \n+    /**\n+     * Given a string of comma-separated prioritized tiers (highest priority\n+     * first) and an allocation, find the highest priority tier for which nodes\n+     * exist. If no nodes for any of the tiers are available, returns an empty\n+     * {@code Optional<String>}.\n+     */\n+    private static Optional<String> preferredTier(String prioritizedTiers, RoutingAllocation allocation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "872f5e7f8d7711acbc0930eaeab2aa9651b36bf6"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk0NTI3OA==", "bodyText": "should we make both these methods as default visible and add unit tests?", "url": "https://github.com/elastic/elasticsearch/pull/62589#discussion_r490945278", "createdAt": "2020-09-18T13:22:31Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/cluster/routing/allocation/DataTierAllocationDecider.java", "diffHunk": "@@ -186,6 +231,29 @@ private Decision shouldClusterFilter(DiscoveryNode node, RoutingAllocation alloc\n         OR\n     }\n \n+    /**\n+     * Given a string of comma-separated prioritized tiers (highest priority\n+     * first) and an allocation, find the highest priority tier for which nodes\n+     * exist. If no nodes for any of the tiers are available, returns an empty\n+     * {@code Optional<String>}.\n+     */\n+    private static Optional<String> preferredTier(String prioritizedTiers, RoutingAllocation allocation) {\n+        String[] tiers = Strings.tokenizeToStringArray(prioritizedTiers, \",\");\n+        return Arrays.stream(tiers).filter(tier -> tierNodesPresent(tier, allocation)).findFirst();\n+    }\n+\n+    private static boolean tierNodesPresent(String singleTier, RoutingAllocation allocation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "872f5e7f8d7711acbc0930eaeab2aa9651b36bf6"}, "originalPosition": 115}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55ae5ea48b3c335a031859d5d4dbf6147fdbff73", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/55ae5ea48b3c335a031859d5d4dbf6147fdbff73", "committedDate": "2020-09-18T16:00:49Z", "message": "Rename setting to `index.routing.allocation.include._tier_preference`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e7897a37d234d2bfb503519cdb5c21e93b7c7ba", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/5e7897a37d234d2bfb503519cdb5c21e93b7c7ba", "committedDate": "2020-09-18T16:24:23Z", "message": "Add unit tests for static methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f88f2e2be81374aa6e995f7d4603eefb13860e0", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/3f88f2e2be81374aa6e995f7d4603eefb13860e0", "committedDate": "2020-09-18T16:36:03Z", "message": "Add unit tests for integration between preference and include/require/exclude"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0401cb75ca4830acc2a0fcb39b027998ad0fc0d8", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/0401cb75ca4830acc2a0fcb39b027998ad0fc0d8", "committedDate": "2020-09-18T17:01:33Z", "message": "Merge branch 'master' into dt-allow-preference-for-tier"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5bdfa4a6778a92e59a42fe0ce76644caf63a9f8", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/d5bdfa4a6778a92e59a42fe0ce76644caf63a9f8", "committedDate": "2020-09-18T17:42:14Z", "message": "Fix tests\n\nDiscoveryNodeFilters needs to ignore all _tier* attributes, not just _tier"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b79e6523fee7e4cce12fe8473710cb312701daf5", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/b79e6523fee7e4cce12fe8473710cb312701daf5", "committedDate": "2020-09-18T18:10:44Z", "message": "Fix tests for setting rename"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzUzOTA0", "url": "https://github.com/elastic/elasticsearch/pull/62589#pullrequestreview-491753904", "createdAt": "2020-09-18T20:13:59Z", "commit": {"oid": "b79e6523fee7e4cce12fe8473710cb312701daf5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4761, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}