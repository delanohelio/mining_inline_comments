{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MzYyMzY2", "number": 54752, "title": "[ML] inference only persist if there are stats", "bodyText": "We needlessly send documents to be persisted. If there are no stats added, then we should not attempt to persist them.\ncloses #54786", "createdAt": "2020-04-03T20:07:01Z", "url": "https://github.com/elastic/elasticsearch/pull/54752", "merged": true, "mergeCommit": {"oid": "942e688075755cd2472c410dfa4d81affa8610af"}, "closed": true, "closedAt": "2020-04-13T16:55:13Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUGnL8AH2gAyMzk4MzYyMzY2OjZmZTg0MmM5YjRmNmM5ZDE5MTY0YTMyY2Y4NzQ1ZjQwYjg4ZGU2OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXPWICgFqTM5MjE2MDY4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6fe842c9b4f6c9d19164a32cf8745f40b88de693", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/6fe842c9b4f6c9d19164a32cf8745f40b88de693", "committedDate": "2020-04-03T20:06:48Z", "message": "[ML] only persist if there are stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93872143be4d9c3e2535ac533efd50be58a57de5", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/93872143be4d9c3e2535ac533efd50be58a57de5", "committedDate": "2020-04-03T20:16:12Z", "message": "Merge branch 'master' into feature/ml-inference-only-persist-if-there-are-stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb77503ab4f54f732df6ebaf0c5abe8186d955c2", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/eb77503ab4f54f732df6ebaf0c5abe8186d955c2", "committedDate": "2020-04-03T20:43:04Z", "message": "removing unecessary assertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24085b098a9cb37d3a8a3b12d71488b26b561092", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/24085b098a9cb37d3a8a3b12d71488b26b561092", "committedDate": "2020-04-03T20:43:28Z", "message": "Merge branch 'feature/ml-inference-only-persist-if-there-are-stats' of github.com:benwtrent/elasticsearch into feature/ml-inference-only-persist-if-there-are-stats"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3OTk2NjQy", "url": "https://github.com/elastic/elasticsearch/pull/54752#pullrequestreview-387996642", "createdAt": "2020-04-06T07:33:58Z", "commit": {"oid": "24085b098a9cb37d3a8a3b12d71488b26b561092"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4637a1269d5c92acd7fad5d54447f2d5b38693a", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4637a1269d5c92acd7fad5d54447f2d5b38693a", "committedDate": "2020-04-13T11:40:20Z", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-inference-only-persist-if-there-are-stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1933bf9a0f7e1582cf68275083ff1926f2f21f7", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1933bf9a0f7e1582cf68275083ff1926f2f21f7", "committedDate": "2020-04-13T13:32:23Z", "message": "fixing test, timestamp calculation, concurrency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMTQ4Nzgy", "url": "https://github.com/elastic/elasticsearch/pull/54752#pullrequestreview-392148782", "createdAt": "2020-04-13T13:38:41Z", "commit": {"oid": "c1933bf9a0f7e1582cf68275083ff1926f2f21f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMzozODo0MVrOGEmveQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMzozODo0MVrOGEmveQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4MjIzMw==", "bodyText": "Is it possible for timestamp to be an invalid number here?", "url": "https://github.com/elastic/elasticsearch/pull/54752#discussion_r407482233", "createdAt": "2020-04-13T13:38:41Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java", "diffHunk": "@@ -550,7 +551,9 @@ private InferenceStats handleMultiNodeStatsResponse(SearchResponse response, Str\n             failures == null ? 0L : Double.valueOf(failures.getValue()).longValue(),\n             modelId,\n             null,\n-            timeStamp == null ? Instant.now() : Instant.ofEpochMilli(Double.valueOf(timeStamp.getValue()).longValue())\n+            timeStamp == null || (Numbers.isValidDouble(timeStamp.getValue()) == false) ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1933bf9a0f7e1582cf68275083ff1926f2f21f7"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMTU0ODc3", "url": "https://github.com/elastic/elasticsearch/pull/54752#pullrequestreview-392154877", "createdAt": "2020-04-13T13:49:07Z", "commit": {"oid": "c1933bf9a0f7e1582cf68275083ff1926f2f21f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMzo0OTowN1rOGEnCnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxMzo0OTowN1rOGEnCnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ4NzEzMw==", "bodyText": "Are we missing InferenceStats.MISSING_ALL_FIELDS_COUNT here?", "url": "https://github.com/elastic/elasticsearch/pull/54752#discussion_r407487133", "createdAt": "2020-04-13T13:49:07Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "diffHunk": "@@ -47,12 +48,16 @@\n     private static final Logger logger = LogManager.getLogger(TrainedModelStatsService.class);\n     private static final TimeValue PERSISTENCE_INTERVAL = TimeValue.timeValueSeconds(1);\n \n+    private static final String STATS_UPDATE_SCRIPT_TEMPLATE = \"\" +\n+        \"    ctx._source.{0} += params.{0};\\n\" +\n+        \"    ctx._source.{1} += params.{1};\\n\" +\n+        \"    ctx._source.{2} += params.{2};\\n\" +\n+        \"    ctx._source.{3} = params.{3};\";\n     // Script to only update if stats have increased since last persistence\n-    private static final String STATS_UPDATE_SCRIPT = \"\" +\n-        \"    ctx._source.missing_all_fields_count += params.missing_all_fields_count;\\n\" +\n-        \"    ctx._source.inference_count += params.inference_count;\\n\" +\n-        \"    ctx._source.failure_count += params.failure_count;\\n\" +\n-        \"    ctx._source.time_stamp = params.time_stamp;\";\n+    private static final String STATS_UPDATE_SCRIPT = Messages.getMessage(STATS_UPDATE_SCRIPT_TEMPLATE,\n+        InferenceStats.INFERENCE_COUNT.getPreferredName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1933bf9a0f7e1582cf68275083ff1926f2f21f7"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51058d97bd1fc6cdb146b7e0e8715135969e469f", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/51058d97bd1fc6cdb146b7e0e8715135969e469f", "committedDate": "2020-04-13T13:52:32Z", "message": "fixing update script"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMTYwNjgw", "url": "https://github.com/elastic/elasticsearch/pull/54752#pullrequestreview-392160680", "createdAt": "2020-04-13T13:59:05Z", "commit": {"oid": "51058d97bd1fc6cdb146b7e0e8715135969e469f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3819, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}