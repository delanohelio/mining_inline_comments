{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NzI5Mzk4", "number": 61932, "title": "Improve error messages on bad [format] and [null_value] params for date mapper", "bodyText": "Currently, if an incorrectly formatted date is passed as a null_value for a date field mapper\nconfiguration, you get a vague error:\nFailed to parse mapping [_doc]: cannot parse empty date\n\nSimilarly, if you pass an incorrect format, you get the error:\nFailed to parse mapping [_doc]: Invalid format [...]\n\nThis commit improves both these errors by including the mapper name and parameter that\nare misconfigured.\nFixes #61712", "createdAt": "2020-09-03T15:55:13Z", "url": "https://github.com/elastic/elasticsearch/pull/61932", "merged": true, "mergeCommit": {"oid": "50a74f972a771945868b870cb57c9009987ba4b1"}, "closed": true, "closedAt": "2020-09-04T13:02:19Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFSpnOAH2gAyNDc4NzI5Mzk4OmRhOTgwNmI2NWUyY2VjYWQ4NmQ0OGQwZDZiODYzOTIyOGE0YzM3ZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFj20wgH2gAyNDc4NzI5Mzk4OjE1YjZiZDVkZTIyMTQ2MjcxOWU3YWYwNTkxYjQxZjk2ZWUxNWRiOTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "da9806b65e2cecad86d48d0d6b8639228a4c37fd", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/da9806b65e2cecad86d48d0d6b8639228a4c37fd", "committedDate": "2020-09-03T15:50:36Z", "message": "Improve error messages on bad [format] and [null_value] params for date mapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1150090dc95b64ff34ca51116e7fa2e03cbe433d", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/1150090dc95b64ff34ca51116e7fa2e03cbe433d", "committedDate": "2020-09-03T16:22:03Z", "message": "imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMTM3NzM5", "url": "https://github.com/elastic/elasticsearch/pull/61932#pullrequestreview-482137739", "createdAt": "2020-09-03T19:25:17Z", "commit": {"oid": "1150090dc95b64ff34ca51116e7fa2e03cbe433d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxOToyNToxN1rOHM0fKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxOTozMjo0OFrOHM0tZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwNDkwNg==", "bodyText": "Small comment, maybe we should scope the try/ catch down to avoid rewrapping an IllegalArgumentException from the constructor call ? It doesn't seem like a concern for this specific constructor, but seems like good practice.", "url": "https://github.com/elastic/elasticsearch/pull/61932#discussion_r483204906", "createdAt": "2020-09-03T19:25:17Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -213,21 +213,38 @@ public Builder(String name, Resolution resolution, DateFormatter dateFormatter,\n         }\n \n         protected DateFieldType setupFieldType(BuilderContext context) {\n-            DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n-            return new DateFieldType(buildFullName(context), index.getValue(), docValues.getValue(),\n-                dateTimeFormatter, resolution, meta.getValue());\n+            try {\n+                DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1150090dc95b64ff34ca51116e7fa2e03cbe433d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIwODU0OQ==", "bodyText": "Small comment, catch is usually on same line as previous brace.\nNot relevant for this PR, but reading this made me notice that we parse null_value dates different from ones that appear in documents. Specifically, I wonder why we don't use DateFieldType#parse here ?", "url": "https://github.com/elastic/elasticsearch/pull/61932#discussion_r483208549", "createdAt": "2020-09-03T19:32:48Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -213,21 +213,38 @@ public Builder(String name, Resolution resolution, DateFormatter dateFormatter,\n         }\n \n         protected DateFieldType setupFieldType(BuilderContext context) {\n-            DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n-            return new DateFieldType(buildFullName(context), index.getValue(), docValues.getValue(),\n-                dateTimeFormatter, resolution, meta.getValue());\n+            try {\n+                DateFormatter dateTimeFormatter = DateFormatter.forPattern(format.getValue()).withLocale(locale.getValue());\n+                return new DateFieldType(buildFullName(context), index.getValue(), docValues.getValue(),\n+                    dateTimeFormatter, resolution, meta.getValue());\n+            }\n+            catch (IllegalArgumentException e) {\n+                throw new IllegalArgumentException(\"Error parsing [format] on field [\" + name() + \"]: \" + e.getMessage(), e);\n+            }\n         }\n \n         @Override\n         protected List<Parameter<?>> getParameters() {\n             return List.of(index, docValues, store, format, locale, nullValue, ignoreMalformed, boost, meta);\n         }\n \n+        private Long parseNullValue(DateFormatter formatter) {\n+            if (nullValue.getValue() == null) {\n+                return null;\n+            }\n+            try {\n+                return formatter.parseMillis(nullValue.getValue());\n+            }\n+            catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1150090dc95b64ff34ca51116e7fa2e03cbe433d"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5ee4d0e8f39f6e1e3599a35538075c21b6a59ec", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/c5ee4d0e8f39f6e1e3599a35538075c21b6a59ec", "committedDate": "2020-09-04T10:49:09Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15b6bd5de221462719e7af0591b41f96ee15db92", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/15b6bd5de221462719e7af0591b41f96ee15db92", "committedDate": "2020-09-04T11:53:25Z", "message": "Merge branch 'master' into mapper/empty-null-value"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4833, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}