{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MDY4Mjg5", "number": 52248, "title": "EQL: Add integration tests harness to test EQL feature parity with original implementation", "bodyText": "The tests use the original test queries from\nhttps://github.com/endgameinc/eql/blob/master/eql/etc/test_queries.toml\nfor EQL implementation correctness validation.\nThe file test_queries_unsupported.toml serves as a \"blacklist\" for the\nqueries that we do not support. Currently all of the queries are\nblacklisted. Over the time the expectation is to eventually have an\nempty \"blacklist\" when all of the queries are fully supported.\nThe tests use the original test vector from\nhttps://raw.githubusercontent.com/endgameinc/eql/master/eql/etc/test_data.json\nthat was translated to ECS format that matches the latest mapping being\nused for Endgame platform event streaming and is loaded from endgame.dat\nfile. The endgame.json file contains the matching index\nmappings/setting.\nOnly one EQL spec response is stubbed for now to match the expected\noutput for that spec query. This part would need some tweaking after EQL is\nfully wired.\nThe input .toml file is parsed by hand for now, which is sufficient for\nour purposes and avoids introducing another dependency just for this\nparticular test case.\nRelated to #49581\n@imotov could you take a look first before I promote this from draft PR?\nThanks!", "createdAt": "2020-02-12T02:55:45Z", "url": "https://github.com/elastic/elasticsearch/pull/52248", "merged": true, "mergeCommit": {"oid": "e06f2afa7e51f0052ba02a78b848669152262edb"}, "closed": true, "closedAt": "2020-02-22T14:02:48Z", "author": {"login": "aleksmaus"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDnb78ABqjMwMzEwODg0MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGnWVLgH2gAyMzc0MDY4Mjg5OjU0MDM1YjE5ZTE5ODU0ZTlkMTNiOTVkMDc0ZjgzZWVjMzFlYWU0OTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f944369cd5c8d429aa8c008a29dd29297c5815a7", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/f944369cd5c8d429aa8c008a29dd29297c5815a7", "committedDate": "2020-02-12T02:50:41Z", "message": "EQL: Add integration tests harness to test EQL feature parity with original implementation\n\nThe tests use the original test queries from\nhttps://github.com/endgameinc/eql/blob/master/eql/etc/test_queries.toml\nfor EQL implementation correctness validation.\nThe file test_queries_unsupported.toml serves as a \"blacklist\" for the\nqueries that we do not support. Currently all of the queries are\nblacklisted. Over the time the expectation is to eventually have an\nempty \"blacklist\" when all of the queries are fully supported.\n\nThe tests use the original test vector from\nhttps://raw.githubusercontent.com/endgameinc/eql/master/eql/etc/test_data.json\nthat was translated to ECS format that matches the latest mapping being\nused for Endgame platform event streaming and is loaded from endgame.dat\nfile. The endgame.json file contains the matching index\nmappings/setting.\n\nOnly one EQL and the response is stubbed for now to match the expected\noutput from that query. This part would need some tweaking after EQL is\nfully wired.\n\nThe input .toml file is parsed by hand for now, which is sufficient for\nour purposes and avoids introducing another dependency just for this\nparticular test case.\n\nRelated to https://github.com/elastic/elasticsearch/issues/49581"}, "afterCommit": {"oid": "032b6996df3bb1a1267ebf6a1811e9799094ef90", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/032b6996df3bb1a1267ebf6a1811e9799094ef90", "committedDate": "2020-02-12T14:44:05Z", "message": "EQL: Add integration tests harness to test EQL feature parity with original implementation\n\nThe tests use the original test queries from\nhttps://github.com/endgameinc/eql/blob/master/eql/etc/test_queries.toml\nfor EQL implementation correctness validation.\nThe file test_queries_unsupported.toml serves as a \"blacklist\" for the\nqueries that we do not support. Currently all of the queries are\nblacklisted. Over the time the expectation is to eventually have an\nempty \"blacklist\" when all of the queries are fully supported.\n\nThe tests use the original test vector from\nhttps://raw.githubusercontent.com/endgameinc/eql/master/eql/etc/test_data.json\nthat was translated to ECS format that matches the latest mapping being\nused for Endgame platform event streaming and is loaded from endgame.dat\nfile. The endgame.json file contains the matching index\nmappings/setting.\n\nOnly one EQL and the response is stubbed for now to match the expected\noutput from that query. This part would need some tweaking after EQL is\nfully wired.\n\nThe input .toml file is parsed by hand for now, which is sufficient for\nour purposes and avoids introducing another dependency just for this\nparticular test case.\n\nRelated to https://github.com/elastic/elasticsearch/issues/49581"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47aaef7ee16f7244d8ceaaad0ba74c5bdcdb3889", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/47aaef7ee16f7244d8ceaaad0ba74c5bdcdb3889", "committedDate": "2020-02-12T15:08:13Z", "message": "EQL: Add integration tests harness to test EQL feature parity with original implementation\n\nThe tests use the original test queries from\nhttps://github.com/endgameinc/eql/blob/master/eql/etc/test_queries.toml\nfor EQL implementation correctness validation.\nThe file test_queries_unsupported.toml serves as a \"blacklist\" for the\nqueries that we do not support. Currently all of the queries are\nblacklisted. Over the time the expectation is to eventually have an\nempty \"blacklist\" when all of the queries are fully supported.\n\nThe tests use the original test vector from\nhttps://raw.githubusercontent.com/endgameinc/eql/master/eql/etc/test_data.json\nthat was translated to ECS format that matches the latest mapping being\nused for Endgame platform event streaming and is loaded from endgame.dat\nfile. The endgame.json file contains the matching index\nmappings/setting.\n\nOnly one EQL and the response is stubbed for now to match the expected\noutput from that query. This part would need some tweaking after EQL is\nfully wired.\n\nThe input .toml file is parsed by hand for now, which is sufficient for\nour purposes and avoids introducing another dependency just for this\nparticular test case.\n\nRelated to https://github.com/elastic/elasticsearch/issues/49581"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "032b6996df3bb1a1267ebf6a1811e9799094ef90", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/032b6996df3bb1a1267ebf6a1811e9799094ef90", "committedDate": "2020-02-12T14:44:05Z", "message": "EQL: Add integration tests harness to test EQL feature parity with original implementation\n\nThe tests use the original test queries from\nhttps://github.com/endgameinc/eql/blob/master/eql/etc/test_queries.toml\nfor EQL implementation correctness validation.\nThe file test_queries_unsupported.toml serves as a \"blacklist\" for the\nqueries that we do not support. Currently all of the queries are\nblacklisted. Over the time the expectation is to eventually have an\nempty \"blacklist\" when all of the queries are fully supported.\n\nThe tests use the original test vector from\nhttps://raw.githubusercontent.com/endgameinc/eql/master/eql/etc/test_data.json\nthat was translated to ECS format that matches the latest mapping being\nused for Endgame platform event streaming and is loaded from endgame.dat\nfile. The endgame.json file contains the matching index\nmappings/setting.\n\nOnly one EQL and the response is stubbed for now to match the expected\noutput from that query. This part would need some tweaking after EQL is\nfully wired.\n\nThe input .toml file is parsed by hand for now, which is sufficient for\nour purposes and avoids introducing another dependency just for this\nparticular test case.\n\nRelated to https://github.com/elastic/elasticsearch/issues/49581"}, "afterCommit": {"oid": "47aaef7ee16f7244d8ceaaad0ba74c5bdcdb3889", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/47aaef7ee16f7244d8ceaaad0ba74c5bdcdb3889", "committedDate": "2020-02-12T15:08:13Z", "message": "EQL: Add integration tests harness to test EQL feature parity with original implementation\n\nThe tests use the original test queries from\nhttps://github.com/endgameinc/eql/blob/master/eql/etc/test_queries.toml\nfor EQL implementation correctness validation.\nThe file test_queries_unsupported.toml serves as a \"blacklist\" for the\nqueries that we do not support. Currently all of the queries are\nblacklisted. Over the time the expectation is to eventually have an\nempty \"blacklist\" when all of the queries are fully supported.\n\nThe tests use the original test vector from\nhttps://raw.githubusercontent.com/endgameinc/eql/master/eql/etc/test_data.json\nthat was translated to ECS format that matches the latest mapping being\nused for Endgame platform event streaming and is loaded from endgame.dat\nfile. The endgame.json file contains the matching index\nmappings/setting.\n\nOnly one EQL and the response is stubbed for now to match the expected\noutput from that query. This part would need some tweaking after EQL is\nfully wired.\n\nThe input .toml file is parsed by hand for now, which is sufficient for\nour purposes and avoids introducing another dependency just for this\nparticular test case.\n\nRelated to https://github.com/elastic/elasticsearch/issues/49581"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NTUzNDYy", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-357553462", "createdAt": "2020-02-12T15:36:33Z", "commit": {"oid": "47aaef7ee16f7244d8ceaaad0ba74c5bdcdb3889"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNTozNjozM1rOFozanQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNTozNjozM1rOFozanQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyOTc1Nw==", "bodyText": "two q's\n\nwhy the .dat extension?\nI don't think this needs to be in ECS, other than the event.category field. Otherwise all of the queries need to be rewritten", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r378329757", "createdAt": "2020-02-12T15:36:33Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/src/test/resources/endgame.dat", "diffHunk": "@@ -0,0 +1,102 @@\n+{\"user\":{\"group\":{}},\"host\":{\"os\":{\"platform\":\"windows\",\"name\":\"Windows\"},\"ip\":\"127.0.0.1\",\"hostname\":\"localhost\",\"name\":\"localhost\"},\"event\":{\"module\":\"endgame\",\"dataset\":\"esensor\",\"action\":\"already_running\",\"category\":\"process\",\"kind\":\"event\"},\"labels\":{\"account_id\":\"f6c123dc-b6d9-4849-937b-08c444ce7d96\",\"endpoint_id\":\"6a19472c-f0ab-4f3a-b83d-dc3698a5ff66\"},\"agent\":{\"type\":\"endgame\",\"id\":\"6a19472c-f0ab-4f3a-b83d-dc3698a5ff66\",\"version\":\"3.54.0\"},\"ecs\":{\"version\":\"1.1.0\"},\"@timestamp\":0,\"process\":{\"thread\":{},\"parent\":{},\"hash\":{},\"name\":\"System Idle Process\"},\"endgame\":{\"name\":\"localhost\",\"eid\":\"6a19472c-f0ab-4f3a-b83d-dc3698a5ff66\",\"MID\":\"\",\"ip\":\"127.0.0.1\",\"sver\":\"3.54.0\",\"os_type\":\"windows\",\"serial_event_id\":1,\"opcode\":3,\"event_type_full\":\"process_event\",\"event_subtype_full\":\"already_running\",\"timestamp\":116444736000000000,\"process_name\":\"System Idle Process\",\"unique_pid\":1,\"xml_message\":\"\",\"provider_name\":\"\",\"provider_guid\":\"\",\"channel_name\":\"\",\"subject_user_sid\":\"\",\"subject_user_name\":\"\",\"subject_domain_name\":\"\",\"subject_logon_id\":\"\",\"target_domain_name\":\"\",\"target_user_name\":\"\",\"target_logon_id\":\"\",\"ip_address\":\"\",\"computer_name\":\"\",\"privilege_list\":\"\",\"logon_type\":null,\"system_thread_id\":null,\"system_pid\":null,\"system_process_name\":\"\",\"query_name\":\"\",\"query_type\":null,\"query_results\":null,\"metadata\":{\"collection_time\":0}}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47aaef7ee16f7244d8ceaaad0ba74c5bdcdb3889"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NTU2MDMz", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-357556033", "createdAt": "2020-02-12T15:39:28Z", "commit": {"oid": "47aaef7ee16f7244d8ceaaad0ba74c5bdcdb3889"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNTozOToyOVrOFoziGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNTozOToyOVrOFoziGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMzMTY3NQ==", "bodyText": "this one is supported", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r378331675", "createdAt": "2020-02-12T15:39:29Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/src/test/resources/test_queries_unsupported.toml", "diffHunk": "@@ -0,0 +1,1300 @@\n+# This file is populated with currently unsupported queries.\n+# Serves as a blacklist, until our implementation starts supporting a specific query\n+# This file is expected to become empty once the feature parity is reached with the\n+# official EQL implementation\n+\n+[[queries]]\n+query = 'process where serial_event_id < 4'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47aaef7ee16f7244d8ceaaad0ba74c5bdcdb3889"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86313844217e1b9c3c79b1b9208140e2c2478a07", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/86313844217e1b9c3c79b1b9208140e2c2478a07", "committedDate": "2020-02-12T15:53:54Z", "message": "Rollback this PR change that caused the failure in telemetry checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd4a55d83e3227018bde92c92f71a481352392aa", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/cd4a55d83e3227018bde92c92f71a481352392aa", "committedDate": "2020-02-13T03:08:54Z", "message": "Fix code formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c", "committedDate": "2020-02-13T14:50:57Z", "message": "Test the Andrei's suggested change to still support telemetry and put the plugin actions behind the feature flag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b14a36b347ac2232b220e7ffb579d65991ed4d9", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b14a36b347ac2232b220e7ffb579d65991ed4d9", "committedDate": "2020-02-13T14:44:22Z", "message": "Test the Andrei's suggested change to still support telemetry and put the plugin actions behind the feature flag"}, "afterCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c", "committedDate": "2020-02-13T14:50:57Z", "message": "Test the Andrei's suggested change to still support telemetry and put the plugin actions behind the feature flag"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjAxNTg4", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-358601588", "createdAt": "2020-02-13T22:35:13Z", "commit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMjozNToxM1rOFpl9yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMzowMzowOFrOFpmlTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE1Nzk2MQ==", "bodyText": "We typically use *.json for that, even though *.ndjson is probably a better choice.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379157961", "createdAt": "2020-02-13T22:35:13Z", "author": {"login": "imotov"}, "path": "x-pack/plugin/eql/src/test/resources/endgame.dat", "diffHunk": "@@ -0,0 +1,102 @@\n+{\"user\":{\"group\":{}},\"host\":{\"os\":{\"platform\":\"windows\",\"name\":\"Windows\"},\"ip\":\"127.0.0.1\",\"hostname\":\"localhost\",\"name\":\"localhost\"},\"event\":{\"module\":\"endgame\",\"dataset\":\"esensor\",\"action\":\"already_running\",\"category\":\"process\",\"kind\":\"event\"},\"labels\":{\"account_id\":\"f6c123dc-b6d9-4849-937b-08c444ce7d96\",\"endpoint_id\":\"6a19472c-f0ab-4f3a-b83d-dc3698a5ff66\"},\"agent\":{\"type\":\"endgame\",\"id\":\"6a19472c-f0ab-4f3a-b83d-dc3698a5ff66\",\"version\":\"3.54.0\"},\"ecs\":{\"version\":\"1.1.0\"},\"@timestamp\":0,\"process\":{\"thread\":{},\"parent\":{},\"hash\":{},\"name\":\"System Idle Process\"},\"endgame\":{\"name\":\"localhost\",\"eid\":\"6a19472c-f0ab-4f3a-b83d-dc3698a5ff66\",\"MID\":\"\",\"ip\":\"127.0.0.1\",\"sver\":\"3.54.0\",\"os_type\":\"windows\",\"serial_event_id\":1,\"opcode\":3,\"event_type_full\":\"process_event\",\"event_subtype_full\":\"already_running\",\"timestamp\":116444736000000000,\"process_name\":\"System Idle Process\",\"unique_pid\":1,\"xml_message\":\"\",\"provider_name\":\"\",\"provider_guid\":\"\",\"channel_name\":\"\",\"subject_user_sid\":\"\",\"subject_user_name\":\"\",\"subject_domain_name\":\"\",\"subject_logon_id\":\"\",\"target_domain_name\":\"\",\"target_user_name\":\"\",\"target_logon_id\":\"\",\"ip_address\":\"\",\"computer_name\":\"\",\"privilege_list\":\"\",\"logon_type\":null,\"system_thread_id\":null,\"system_pid\":null,\"system_process_name\":\"\",\"query_name\":\"\",\"query_type\":null,\"query_results\":null,\"metadata\":{\"collection_time\":0}}}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyOTc1Nw=="}, "originalCommit": {"oid": "47aaef7ee16f7244d8ceaaad0ba74c5bdcdb3889"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2ODA3Nw==", "bodyText": "I don't think we need this anymore.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379168077", "createdAt": "2020-02-13T23:03:08Z", "author": {"login": "imotov"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlActionIT.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import org.elasticsearch.Build;\n+import org.elasticsearch.action.bulk.BulkRequestBuilder;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.search.SearchHit;\n+import org.junit.BeforeClass;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+\n+import static org.elasticsearch.test.StreamsUtils.copyToStringFromClasspath;\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class EqlActionIT extends AbstractEqlIntegTestCase {\n+\n+    @BeforeClass\n+    public static void checkForSnapshot() {\n+        assumeTrue(\"Only works on snapshot builds for now\", Build.CURRENT.isSnapshot());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTc2OTY3", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-358976967", "createdAt": "2020-02-14T14:27:46Z", "commit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTk0MzUw", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-358994350", "createdAt": "2020-02-14T14:52:19Z", "commit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNDo1MjoxOVrOFp5G5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTowODozNVrOFp5qkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3MTU5MQ==", "bodyText": "Why format the above?\nIn general, PRs should touch only lines that were modified not format the entire file. Both IntelliJ and Eclipse have this option.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379471591", "createdAt": "2020-02-14T14:52:19Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/EqlPlugin.java", "diffHunk": "@@ -69,31 +72,27 @@\n         Setting.Property.NodeScope\n     );\n \n+    public EqlPlugin(final Settings settings) {\n+        this.enabled = EQL_ENABLED_SETTING.get(settings);\n+    }\n+\n     @Override\n-    public Collection<Object> createComponents(Client client, ClusterService clusterService, ThreadPool threadPool,\n-            ResourceWatcherService resourceWatcherService, ScriptService scriptService, NamedXContentRegistry xContentRegistry,\n-            Environment environment, NodeEnvironment nodeEnvironment, NamedWriteableRegistry namedWriteableRegistry) {\n+    public Collection<Object> createComponents(Client client, ClusterService clusterService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3Mzg0Nw==", "bodyText": "I'm confused about why the method was moved...", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379473847", "createdAt": "2020-02-14T14:56:14Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/EqlPlugin.java", "diffHunk": "@@ -103,9 +102,24 @@\n     public List<Setting<?>> getSettings() {\n         if (isSnapshot() || EQL_FEATURE_FLAG_REGISTERED) {\n             return List.of(EQL_ENABLED_SETTING);\n-        } else {\n-            return List.of();\n         }\n+        return List.of();\n+    }\n+\n+    @Override\n+    public List<ActionHandler<? extends ActionRequest, ? extends ActionResponse>> getActions() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3NTg0MA==", "bodyText": "If EQL is disabled, why register an action for it?\nAlso if these two actions are returned always, I would put them in a list and only add the extra 2 if enabled:\nList<> actions = Arrays.asList(1,2)\nif (enabled) {\n   actions.add(3);\n   actions.add(4);\n}\nreturn list\n\nIf you really want it immutable, it can be wrapped inside another collection but considering its for internal consumption it's no need imo.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379475840", "createdAt": "2020-02-14T14:59:41Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/EqlPlugin.java", "diffHunk": "@@ -103,9 +102,24 @@\n     public List<Setting<?>> getSettings() {\n         if (isSnapshot() || EQL_FEATURE_FLAG_REGISTERED) {\n             return List.of(EQL_ENABLED_SETTING);\n-        } else {\n-            return List.of();\n         }\n+        return List.of();\n+    }\n+\n+    @Override\n+    public List<ActionHandler<? extends ActionRequest, ? extends ActionResponse>> getActions() {\n+        if (enabled) {\n+            return List.of(\n+                new ActionHandler<>(EqlSearchAction.INSTANCE, TransportEqlSearchAction.class),\n+                new ActionHandler<>(EqlStatsAction.INSTANCE, TransportEqlStatsAction.class),\n+                new ActionHandler<>(XPackUsageFeatureAction.EQL, EqlUsageTransportAction.class),\n+                new ActionHandler<>(XPackInfoFeatureAction.EQL, EqlInfoTransportAction.class)\n+            );\n+        }\n+        return List.of(\n+            new ActionHandler<>(XPackUsageFeatureAction.EQL, EqlUsageTransportAction.class),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3Nzc4Mw==", "bodyText": "Either we use enabled or this method. On one hand enabled checks the property presence statically but this method tries to do it dynamic when a class is instantiated.\nThere's there are multiple pieces of isSnapshot in this class that need simplification.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379477783", "createdAt": "2020-02-14T15:03:12Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/EqlPlugin.java", "diffHunk": "@@ -103,9 +102,24 @@\n     public List<Setting<?>> getSettings() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3ODI0Mw==", "bodyText": "Same as above, formatting on non-modified lines is noise.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379478243", "createdAt": "2020-02-14T15:04:06Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/TransportEqlSearchAction.java", "diffHunk": "@@ -41,7 +40,7 @@\n \n     @Inject\n     public TransportEqlSearchAction(Settings settings, ClusterService clusterService, TransportService transportService,\n-            ThreadPool threadPool, ActionFilters actionFilters, PlanExecutor planExecutor) {\n+                                    ThreadPool threadPool, ActionFilters actionFilters, PlanExecutor planExecutor) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3OTcyMg==", "bodyText": "nit: the preference in general is not to negate but instead use == false for clarity.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379479722", "createdAt": "2020-02-14T15:06:44Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlSpecLoader.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import io.netty.util.internal.StringUtil;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class EqlSpecLoader {\n+    public static List<EqlSpec> load(String path, boolean supported) throws Exception {\n+        try (InputStream is = EqlSpecLoader.class.getResourceAsStream(path)) {\n+            return readFromStream(is, supported);\n+        }\n+    }\n+\n+    private static int[] readExpectedEventIds(String line, BufferedReader reader) throws Exception {\n+        String arr[] = readArray(line);\n+        int ids[] = new int[arr.length];\n+\n+        for (int i = 0; i < arr.length; i++) {\n+            ids[i] = Integer.parseInt(arr[i]);\n+        }\n+        return ids;\n+    }\n+\n+    private static String[] readTags(String line) throws Exception {\n+        String arr[] = readArray(line);\n+        for (int i = 0; i < arr.length; i++) {\n+            String s = arr[i];\n+            if (s.startsWith(\"\\\"\") || s.startsWith(\"'\")) {\n+                s = s.substring(1);\n+            }\n+            if (s.endsWith(\"\\\"\") || s.endsWith(\"'\")) {\n+                s = s.substring(0, s.length() - 1);\n+            }\n+            arr[i] = s.trim();\n+        }\n+        return arr;\n+    }\n+\n+    private static String readValueLine(String line) throws Exception {\n+        int idx = line.indexOf(\"=\");\n+        if (idx == -1) {\n+            throw new IllegalArgumentException(\"Invalid string value: \" + line);\n+        }\n+        return line.substring(idx + 1).trim();\n+    }\n+\n+    private static String[] readArray(String line) throws Exception {\n+        line = readValueLine(line);\n+        if (!line.startsWith(\"[\") && !line.endsWith(\"]\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ4MDcyMw==", "bodyText": "Why?", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379480723", "createdAt": "2020-02-14T15:08:35Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/build.gradle", "diffHunk": "@@ -26,6 +26,10 @@ configurations {\n \n archivesBaseName = 'x-pack-sql'\n \n+test {\n+  testLogging.showStandardStreams = true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MDYyNTE0", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-359062514", "createdAt": "2020-02-14T16:26:31Z", "commit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoyNjozMlrOFp8UBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjoyNjozMlrOFp8UBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUyNDEwMg==", "bodyText": "I think this test should use @ParametersFactory so each example becomes a test that we can address individually.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379524102", "createdAt": "2020-02-14T16:26:32Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlActionIT.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import org.elasticsearch.Build;\n+import org.elasticsearch.action.bulk.BulkRequestBuilder;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.search.SearchHit;\n+import org.junit.BeforeClass;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+\n+import static org.elasticsearch.test.StreamsUtils.copyToStringFromClasspath;\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class EqlActionIT extends AbstractEqlIntegTestCase {\n+\n+    @BeforeClass\n+    public static void checkForSnapshot() {\n+        assumeTrue(\"Only works on snapshot builds for now\", Build.CURRENT.isSnapshot());\n+    }\n+\n+    public void testEqlSearchAction() throws Exception {\n+        final String indexPrefix = \"endgame\";\n+        final String testIndexName = indexPrefix + \"-1.4.0\";\n+        final String testIndexPattern = indexPrefix + \"-*\";\n+\n+        String endgame = copyToStringFromClasspath(\"/endgame.json\");\n+        endgame = endgame.replace(\"[index_pattern_placeholder]\", testIndexPattern);\n+\n+        assertAcked(client().admin().indices().preparePutTemplate(testIndexName)\n+            .setSource(endgame.getBytes(StandardCharsets.UTF_8), XContentType.JSON).get());\n+\n+        // Insert test data\n+        InputStream is = EqlActionIT.class.getResourceAsStream(\"/endgame.dat\");\n+        BulkRequestBuilder bulkBuilder = client().prepareBulk();\n+        try (BufferedReader reader = new BufferedReader(\n+            new InputStreamReader(is, StandardCharsets.UTF_8))) {\n+\n+            String line;\n+            while ((line = reader.readLine()) != null) {\n+                bulkBuilder.add(new IndexRequest(testIndexName).source(line.trim(), XContentType.JSON));\n+            }\n+            BulkResponse response = bulkBuilder.setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE).get();\n+            assertThat(response.hasFailures() ? response.buildFailureMessage() : \"\", response.hasFailures(), equalTo(false));\n+        }\n+\n+        ensureYellow(testIndexName);\n+\n+        // Load EQL validation specs\n+        List<EqlSpec> specs = EqlSpecLoader.load(\"/test_queries.toml\", true);\n+        List<EqlSpec> unsupportedSpecs = EqlSpecLoader.load(\"/test_queries_unsupported.toml\", false);\n+\n+        // Validate only currently supported specs\n+        for (EqlSpec spec : specs) {\n+            boolean supported = true;\n+            // Check if spec is supported, simple iteration, cause the list is short.\n+            for (EqlSpec unSpec : unsupportedSpecs) {\n+                if (spec.query.equals(unSpec.query)) {\n+                    supported = false;\n+                    break;\n+                }\n+            }\n+\n+            if (supported) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzY5OTE3", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-358369917", "createdAt": "2020-02-13T16:35:40Z", "commit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "state": "COMMENTED", "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjozNTo0MVrOFpa7eQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNjozMDo1MlrOFp8dHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3NzE0NQ==", "bodyText": "Is this method used anywhere?", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r378977145", "createdAt": "2020-02-13T16:35:41Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/EqlTestUtils.java", "diffHunk": "@@ -16,19 +18,33 @@\n \n public final class EqlTestUtils {\n \n-    private EqlTestUtils() {}\n+    private EqlTestUtils() {\n+    }\n \n-    public static final Configuration TEST_CFG = new Configuration(new String[] { \"none\" }, org.elasticsearch.xpack.ql.util.DateUtils.UTC,\n-            \"nobody\", \"cluster\", null, TimeValue.timeValueSeconds(30), false, \"\");\n+    public static final Configuration TEST_CFG = new Configuration(new String[]{\"none\"}, org.elasticsearch.xpack.ql.util.DateUtils.UTC,\n+        \"nobody\", \"cluster\", null, TimeValue.timeValueSeconds(30), false, \"\");\n \n     public static Configuration randomConfiguration() {\n-        return new Configuration(new String[] {randomAlphaOfLength(16)},\n-                randomZone(),\n-                randomAlphaOfLength(16),\n-                randomAlphaOfLength(16),\n-                null,\n-                new TimeValue(randomNonNegativeLong()),\n-                randomBoolean(),\n-                randomAlphaOfLength(16));\n+        return new Configuration(new String[]{randomAlphaOfLength(16)},\n+            randomZone(),\n+            randomAlphaOfLength(16),\n+            randomAlphaOfLength(16),\n+            null,\n+            new TimeValue(randomNonNegativeLong()),\n+            randomBoolean(),\n+            randomAlphaOfLength(16));\n+    }\n+\n+    public static Tuple<String, String> pathAndName(String string) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3NjAyOQ==", "bodyText": "At one point we'll have to test EQL in a security enabled context as well, right?", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379476029", "createdAt": "2020-02-14T15:00:04Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/AbstractEqlIntegTestCase.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.eql.action;\n+\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.license.LicenseService;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.test.ESIntegTestCase;\n+import org.elasticsearch.xpack.core.XPackSettings;\n+import org.elasticsearch.xpack.eql.plugin.EqlPlugin;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static org.elasticsearch.test.ESIntegTestCase.Scope.SUITE;\n+\n+@ESIntegTestCase.ClusterScope(scope = SUITE, numDataNodes = 0, numClientNodes = 0, maxNumDataNodes = 0)\n+public abstract class AbstractEqlIntegTestCase extends ESIntegTestCase {\n+\n+    @Override\n+    protected Settings nodeSettings(int nodeOrdinal) {\n+        Settings.Builder settings = Settings.builder().put(super.nodeSettings(nodeOrdinal));\n+        settings.put(XPackSettings.SECURITY_ENABLED.getKey(), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ5Nzk2NA==", "bodyText": "@costin see #52328 for why those two action have to be registered. At least, for the moment.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379497964", "createdAt": "2020-02-14T15:38:51Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/EqlPlugin.java", "diffHunk": "@@ -103,9 +102,24 @@\n     public List<Setting<?>> getSettings() {\n         if (isSnapshot() || EQL_FEATURE_FLAG_REGISTERED) {\n             return List.of(EQL_ENABLED_SETTING);\n-        } else {\n-            return List.of();\n         }\n+        return List.of();\n+    }\n+\n+    @Override\n+    public List<ActionHandler<? extends ActionRequest, ? extends ActionResponse>> getActions() {\n+        if (enabled) {\n+            return List.of(\n+                new ActionHandler<>(EqlSearchAction.INSTANCE, TransportEqlSearchAction.class),\n+                new ActionHandler<>(EqlStatsAction.INSTANCE, TransportEqlStatsAction.class),\n+                new ActionHandler<>(XPackUsageFeatureAction.EQL, EqlUsageTransportAction.class),\n+                new ActionHandler<>(XPackInfoFeatureAction.EQL, EqlInfoTransportAction.class)\n+            );\n+        }\n+        return List.of(\n+            new ActionHandler<>(XPackUsageFeatureAction.EQL, EqlUsageTransportAction.class),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ3NTg0MA=="}, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ5OTc1Mg==", "bodyText": "Doesn't this line fit on the try ( one?", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379499752", "createdAt": "2020-02-14T15:42:05Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlActionIT.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import org.elasticsearch.Build;\n+import org.elasticsearch.action.bulk.BulkRequestBuilder;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.search.SearchHit;\n+import org.junit.BeforeClass;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+\n+import static org.elasticsearch.test.StreamsUtils.copyToStringFromClasspath;\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class EqlActionIT extends AbstractEqlIntegTestCase {\n+\n+    @BeforeClass\n+    public static void checkForSnapshot() {\n+        assumeTrue(\"Only works on snapshot builds for now\", Build.CURRENT.isSnapshot());\n+    }\n+\n+    public void testEqlSearchAction() throws Exception {\n+        final String indexPrefix = \"endgame\";\n+        final String testIndexName = indexPrefix + \"-1.4.0\";\n+        final String testIndexPattern = indexPrefix + \"-*\";\n+\n+        String endgame = copyToStringFromClasspath(\"/endgame.json\");\n+        endgame = endgame.replace(\"[index_pattern_placeholder]\", testIndexPattern);\n+\n+        assertAcked(client().admin().indices().preparePutTemplate(testIndexName)\n+            .setSource(endgame.getBytes(StandardCharsets.UTF_8), XContentType.JSON).get());\n+\n+        // Insert test data\n+        InputStream is = EqlActionIT.class.getResourceAsStream(\"/endgame.dat\");\n+        BulkRequestBuilder bulkBuilder = client().prepareBulk();\n+        try (BufferedReader reader = new BufferedReader(\n+            new InputStreamReader(is, StandardCharsets.UTF_8))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxMjUzOQ==", "bodyText": "Import static for IMMEDIATE?", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379512539", "createdAt": "2020-02-14T16:04:33Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlActionIT.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import org.elasticsearch.Build;\n+import org.elasticsearch.action.bulk.BulkRequestBuilder;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.search.SearchHit;\n+import org.junit.BeforeClass;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+\n+import static org.elasticsearch.test.StreamsUtils.copyToStringFromClasspath;\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class EqlActionIT extends AbstractEqlIntegTestCase {\n+\n+    @BeforeClass\n+    public static void checkForSnapshot() {\n+        assumeTrue(\"Only works on snapshot builds for now\", Build.CURRENT.isSnapshot());\n+    }\n+\n+    public void testEqlSearchAction() throws Exception {\n+        final String indexPrefix = \"endgame\";\n+        final String testIndexName = indexPrefix + \"-1.4.0\";\n+        final String testIndexPattern = indexPrefix + \"-*\";\n+\n+        String endgame = copyToStringFromClasspath(\"/endgame.json\");\n+        endgame = endgame.replace(\"[index_pattern_placeholder]\", testIndexPattern);\n+\n+        assertAcked(client().admin().indices().preparePutTemplate(testIndexName)\n+            .setSource(endgame.getBytes(StandardCharsets.UTF_8), XContentType.JSON).get());\n+\n+        // Insert test data\n+        InputStream is = EqlActionIT.class.getResourceAsStream(\"/endgame.dat\");\n+        BulkRequestBuilder bulkBuilder = client().prepareBulk();\n+        try (BufferedReader reader = new BufferedReader(\n+            new InputStreamReader(is, StandardCharsets.UTF_8))) {\n+\n+            String line;\n+            while ((line = reader.readLine()) != null) {\n+                bulkBuilder.add(new IndexRequest(testIndexName).source(line.trim(), XContentType.JSON));\n+            }\n+            BulkResponse response = bulkBuilder.setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxMzUyNA==", "bodyText": "Any reason why not making query private inside EqlSpec and provide a query() accessor method?", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379513524", "createdAt": "2020-02-14T16:06:23Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlActionIT.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import org.elasticsearch.Build;\n+import org.elasticsearch.action.bulk.BulkRequestBuilder;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.search.SearchHit;\n+import org.junit.BeforeClass;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+\n+import static org.elasticsearch.test.StreamsUtils.copyToStringFromClasspath;\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class EqlActionIT extends AbstractEqlIntegTestCase {\n+\n+    @BeforeClass\n+    public static void checkForSnapshot() {\n+        assumeTrue(\"Only works on snapshot builds for now\", Build.CURRENT.isSnapshot());\n+    }\n+\n+    public void testEqlSearchAction() throws Exception {\n+        final String indexPrefix = \"endgame\";\n+        final String testIndexName = indexPrefix + \"-1.4.0\";\n+        final String testIndexPattern = indexPrefix + \"-*\";\n+\n+        String endgame = copyToStringFromClasspath(\"/endgame.json\");\n+        endgame = endgame.replace(\"[index_pattern_placeholder]\", testIndexPattern);\n+\n+        assertAcked(client().admin().indices().preparePutTemplate(testIndexName)\n+            .setSource(endgame.getBytes(StandardCharsets.UTF_8), XContentType.JSON).get());\n+\n+        // Insert test data\n+        InputStream is = EqlActionIT.class.getResourceAsStream(\"/endgame.dat\");\n+        BulkRequestBuilder bulkBuilder = client().prepareBulk();\n+        try (BufferedReader reader = new BufferedReader(\n+            new InputStreamReader(is, StandardCharsets.UTF_8))) {\n+\n+            String line;\n+            while ((line = reader.readLine()) != null) {\n+                bulkBuilder.add(new IndexRequest(testIndexName).source(line.trim(), XContentType.JSON));\n+            }\n+            BulkResponse response = bulkBuilder.setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE).get();\n+            assertThat(response.hasFailures() ? response.buildFailureMessage() : \"\", response.hasFailures(), equalTo(false));\n+        }\n+\n+        ensureYellow(testIndexName);\n+\n+        // Load EQL validation specs\n+        List<EqlSpec> specs = EqlSpecLoader.load(\"/test_queries.toml\", true);\n+        List<EqlSpec> unsupportedSpecs = EqlSpecLoader.load(\"/test_queries_unsupported.toml\", false);\n+\n+        // Validate only currently supported specs\n+        for (EqlSpec spec : specs) {\n+            boolean supported = true;\n+            // Check if spec is supported, simple iteration, cause the list is short.\n+            for (EqlSpec unSpec : unsupportedSpecs) {\n+                if (spec.query.equals(unSpec.query)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxNzI3Mg==", "bodyText": "Will this method be used in the future? (atm it isn't)", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379517272", "createdAt": "2020-02-14T16:13:40Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlSpecLoader.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import io.netty.util.internal.StringUtil;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class EqlSpecLoader {\n+    public static List<EqlSpec> load(String path, boolean supported) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUxODE5Mw==", "bodyText": "Imo, it would help to see a method comment containing sample line(s) these read* methods are expected to handle.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379518193", "createdAt": "2020-02-14T16:15:26Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlSpecLoader.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import io.netty.util.internal.StringUtil;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class EqlSpecLoader {\n+    public static List<EqlSpec> load(String path, boolean supported) throws Exception {\n+        try (InputStream is = EqlSpecLoader.class.getResourceAsStream(path)) {\n+            return readFromStream(is, supported);\n+        }\n+    }\n+\n+    private static int[] readExpectedEventIds(String line, BufferedReader reader) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUyMTE0MQ==", "bodyText": "Why are all these read* methods trimming the values they are reading? For example, readTags gets its values from readArray which is already trimming the values returned as array...\nAre all these trim() calls really needed or they are added just \"to be safe\"?", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379521141", "createdAt": "2020-02-14T16:20:51Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlSpecLoader.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import io.netty.util.internal.StringUtil;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class EqlSpecLoader {\n+    public static List<EqlSpec> load(String path, boolean supported) throws Exception {\n+        try (InputStream is = EqlSpecLoader.class.getResourceAsStream(path)) {\n+            return readFromStream(is, supported);\n+        }\n+    }\n+\n+    private static int[] readExpectedEventIds(String line, BufferedReader reader) throws Exception {\n+        String arr[] = readArray(line);\n+        int ids[] = new int[arr.length];\n+\n+        for (int i = 0; i < arr.length; i++) {\n+            ids[i] = Integer.parseInt(arr[i]);\n+        }\n+        return ids;\n+    }\n+\n+    private static String[] readTags(String line) throws Exception {\n+        String arr[] = readArray(line);\n+        for (int i = 0; i < arr.length; i++) {\n+            String s = arr[i];\n+            if (s.startsWith(\"\\\"\") || s.startsWith(\"'\")) {\n+                s = s.substring(1);\n+            }\n+            if (s.endsWith(\"\\\"\") || s.endsWith(\"'\")) {\n+                s = s.substring(0, s.length() - 1);\n+            }\n+            arr[i] = s.trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUyMTc5NQ==", "bodyText": "I don't think this initialization is necessary. A simple String delim; should be enough.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379521795", "createdAt": "2020-02-14T16:22:08Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlSpecLoader.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import io.netty.util.internal.StringUtil;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class EqlSpecLoader {\n+    public static List<EqlSpec> load(String path, boolean supported) throws Exception {\n+        try (InputStream is = EqlSpecLoader.class.getResourceAsStream(path)) {\n+            return readFromStream(is, supported);\n+        }\n+    }\n+\n+    private static int[] readExpectedEventIds(String line, BufferedReader reader) throws Exception {\n+        String arr[] = readArray(line);\n+        int ids[] = new int[arr.length];\n+\n+        for (int i = 0; i < arr.length; i++) {\n+            ids[i] = Integer.parseInt(arr[i]);\n+        }\n+        return ids;\n+    }\n+\n+    private static String[] readTags(String line) throws Exception {\n+        String arr[] = readArray(line);\n+        for (int i = 0; i < arr.length; i++) {\n+            String s = arr[i];\n+            if (s.startsWith(\"\\\"\") || s.startsWith(\"'\")) {\n+                s = s.substring(1);\n+            }\n+            if (s.endsWith(\"\\\"\") || s.endsWith(\"'\")) {\n+                s = s.substring(0, s.length() - 1);\n+            }\n+            arr[i] = s.trim();\n+        }\n+        return arr;\n+    }\n+\n+    private static String readValueLine(String line) throws Exception {\n+        int idx = line.indexOf(\"=\");\n+        if (idx == -1) {\n+            throw new IllegalArgumentException(\"Invalid string value: \" + line);\n+        }\n+        return line.substring(idx + 1).trim();\n+    }\n+\n+    private static String[] readArray(String line) throws Exception {\n+        line = readValueLine(line);\n+        if (!line.startsWith(\"[\") && !line.endsWith(\"]\")) {\n+            throw new IllegalArgumentException(\"Invalid array string value: \" + line);\n+        }\n+        String arr[] = line.substring(1, line.length() - 1).split(\",\");\n+\n+        ArrayList<String> res = new ArrayList<>();\n+        for (String s : arr) {\n+            s = s.trim();\n+            if (!s.isEmpty()) {\n+                res.add(s);\n+            }\n+        }\n+\n+        return res.toArray(new String[res.size()]);\n+    }\n+\n+    private static String readString(String line, BufferedReader reader) throws Exception {\n+        line = readValueLine(line);\n+        String delim = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUyMjUyMg==", "bodyText": "Single try() line.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379522522", "createdAt": "2020-02-14T16:23:29Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlSpecLoader.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import io.netty.util.internal.StringUtil;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class EqlSpecLoader {\n+    public static List<EqlSpec> load(String path, boolean supported) throws Exception {\n+        try (InputStream is = EqlSpecLoader.class.getResourceAsStream(path)) {\n+            return readFromStream(is, supported);\n+        }\n+    }\n+\n+    private static int[] readExpectedEventIds(String line, BufferedReader reader) throws Exception {\n+        String arr[] = readArray(line);\n+        int ids[] = new int[arr.length];\n+\n+        for (int i = 0; i < arr.length; i++) {\n+            ids[i] = Integer.parseInt(arr[i]);\n+        }\n+        return ids;\n+    }\n+\n+    private static String[] readTags(String line) throws Exception {\n+        String arr[] = readArray(line);\n+        for (int i = 0; i < arr.length; i++) {\n+            String s = arr[i];\n+            if (s.startsWith(\"\\\"\") || s.startsWith(\"'\")) {\n+                s = s.substring(1);\n+            }\n+            if (s.endsWith(\"\\\"\") || s.endsWith(\"'\")) {\n+                s = s.substring(0, s.length() - 1);\n+            }\n+            arr[i] = s.trim();\n+        }\n+        return arr;\n+    }\n+\n+    private static String readValueLine(String line) throws Exception {\n+        int idx = line.indexOf(\"=\");\n+        if (idx == -1) {\n+            throw new IllegalArgumentException(\"Invalid string value: \" + line);\n+        }\n+        return line.substring(idx + 1).trim();\n+    }\n+\n+    private static String[] readArray(String line) throws Exception {\n+        line = readValueLine(line);\n+        if (!line.startsWith(\"[\") && !line.endsWith(\"]\")) {\n+            throw new IllegalArgumentException(\"Invalid array string value: \" + line);\n+        }\n+        String arr[] = line.substring(1, line.length() - 1).split(\",\");\n+\n+        ArrayList<String> res = new ArrayList<>();\n+        for (String s : arr) {\n+            s = s.trim();\n+            if (!s.isEmpty()) {\n+                res.add(s);\n+            }\n+        }\n+\n+        return res.toArray(new String[res.size()]);\n+    }\n+\n+    private static String readString(String line, BufferedReader reader) throws Exception {\n+        line = readValueLine(line);\n+        String delim = \"\";\n+        if (line.startsWith(\"\\\"\") || line.startsWith(\"'\")) {\n+            delim = line.substring(0, 1);\n+            if (line.startsWith(\"\\\"\\\"\\\"\") || line.startsWith(\"'''\")) {\n+                delim = line.substring(0, 3);\n+            }\n+        }\n+\n+        if (StringUtil.isNullOrEmpty(delim)) {\n+            throw new IllegalArgumentException(\"Invalid string format, should start with ' or \\\" at least: \" + line);\n+        }\n+\n+        // Trim start delimiter\n+        if (line.startsWith(delim)) {\n+            line = line.substring(delim.length());\n+        }\n+\n+        // Read multiline string\n+        if (!line.endsWith(delim)) {\n+            String s;\n+            while ((s = reader.readLine()) != null) {\n+                line += \" \" + s.trim();\n+                if (line.endsWith(delim)) {\n+                    break;\n+                }\n+            }\n+        }\n+\n+        // Trim end delimiter\n+        if (line.endsWith(delim)) {\n+            line = line.substring(0, line.length() - delim.length());\n+        }\n+\n+        return line.trim();\n+    }\n+\n+    private static void validateAndAddSpec(List<EqlSpec> specs, EqlSpec spec, boolean supported) throws Exception {\n+        if (StringUtil.isNullOrEmpty(spec.query)) {\n+            throw new IllegalArgumentException(\"Read a test without a query value\");\n+        }\n+\n+        if (supported && spec.expectedEventIds == null) {\n+            throw new IllegalArgumentException(\"Read a test without a expected_event_ids value\");\n+        }\n+\n+        specs.add(spec);\n+    }\n+\n+    // Simple .toml spec parsing of the original EQL spec\n+    // to avoid adding dependency on any actual toml library for now.\n+    private static List<EqlSpec> readFromStream(InputStream is, boolean supported) throws Exception {\n+        Map<String, Integer> testNames = new LinkedHashMap<>();\n+        List<EqlSpec> testSpecs = new ArrayList<>();\n+\n+        EqlSpec spec = null;\n+        try (BufferedReader reader = new BufferedReader(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUyNDgwMQ==", "bodyText": "There is a class org.elasticsearch.common.Strings that has the same method and I think we prefer that one.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379524801", "createdAt": "2020-02-14T16:27:49Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlSpecLoader.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import io.netty.util.internal.StringUtil;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class EqlSpecLoader {\n+    public static List<EqlSpec> load(String path, boolean supported) throws Exception {\n+        try (InputStream is = EqlSpecLoader.class.getResourceAsStream(path)) {\n+            return readFromStream(is, supported);\n+        }\n+    }\n+\n+    private static int[] readExpectedEventIds(String line, BufferedReader reader) throws Exception {\n+        String arr[] = readArray(line);\n+        int ids[] = new int[arr.length];\n+\n+        for (int i = 0; i < arr.length; i++) {\n+            ids[i] = Integer.parseInt(arr[i]);\n+        }\n+        return ids;\n+    }\n+\n+    private static String[] readTags(String line) throws Exception {\n+        String arr[] = readArray(line);\n+        for (int i = 0; i < arr.length; i++) {\n+            String s = arr[i];\n+            if (s.startsWith(\"\\\"\") || s.startsWith(\"'\")) {\n+                s = s.substring(1);\n+            }\n+            if (s.endsWith(\"\\\"\") || s.endsWith(\"'\")) {\n+                s = s.substring(0, s.length() - 1);\n+            }\n+            arr[i] = s.trim();\n+        }\n+        return arr;\n+    }\n+\n+    private static String readValueLine(String line) throws Exception {\n+        int idx = line.indexOf(\"=\");\n+        if (idx == -1) {\n+            throw new IllegalArgumentException(\"Invalid string value: \" + line);\n+        }\n+        return line.substring(idx + 1).trim();\n+    }\n+\n+    private static String[] readArray(String line) throws Exception {\n+        line = readValueLine(line);\n+        if (!line.startsWith(\"[\") && !line.endsWith(\"]\")) {\n+            throw new IllegalArgumentException(\"Invalid array string value: \" + line);\n+        }\n+        String arr[] = line.substring(1, line.length() - 1).split(\",\");\n+\n+        ArrayList<String> res = new ArrayList<>();\n+        for (String s : arr) {\n+            s = s.trim();\n+            if (!s.isEmpty()) {\n+                res.add(s);\n+            }\n+        }\n+\n+        return res.toArray(new String[res.size()]);\n+    }\n+\n+    private static String readString(String line, BufferedReader reader) throws Exception {\n+        line = readValueLine(line);\n+        String delim = \"\";\n+        if (line.startsWith(\"\\\"\") || line.startsWith(\"'\")) {\n+            delim = line.substring(0, 1);\n+            if (line.startsWith(\"\\\"\\\"\\\"\") || line.startsWith(\"'''\")) {\n+                delim = line.substring(0, 3);\n+            }\n+        }\n+\n+        if (StringUtil.isNullOrEmpty(delim)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUyNTA2Mw==", "bodyText": "Same here about Strings class.", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379525063", "createdAt": "2020-02-14T16:28:17Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/action/EqlSpecLoader.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.action;\n+\n+import io.netty.util.internal.StringUtil;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class EqlSpecLoader {\n+    public static List<EqlSpec> load(String path, boolean supported) throws Exception {\n+        try (InputStream is = EqlSpecLoader.class.getResourceAsStream(path)) {\n+            return readFromStream(is, supported);\n+        }\n+    }\n+\n+    private static int[] readExpectedEventIds(String line, BufferedReader reader) throws Exception {\n+        String arr[] = readArray(line);\n+        int ids[] = new int[arr.length];\n+\n+        for (int i = 0; i < arr.length; i++) {\n+            ids[i] = Integer.parseInt(arr[i]);\n+        }\n+        return ids;\n+    }\n+\n+    private static String[] readTags(String line) throws Exception {\n+        String arr[] = readArray(line);\n+        for (int i = 0; i < arr.length; i++) {\n+            String s = arr[i];\n+            if (s.startsWith(\"\\\"\") || s.startsWith(\"'\")) {\n+                s = s.substring(1);\n+            }\n+            if (s.endsWith(\"\\\"\") || s.endsWith(\"'\")) {\n+                s = s.substring(0, s.length() - 1);\n+            }\n+            arr[i] = s.trim();\n+        }\n+        return arr;\n+    }\n+\n+    private static String readValueLine(String line) throws Exception {\n+        int idx = line.indexOf(\"=\");\n+        if (idx == -1) {\n+            throw new IllegalArgumentException(\"Invalid string value: \" + line);\n+        }\n+        return line.substring(idx + 1).trim();\n+    }\n+\n+    private static String[] readArray(String line) throws Exception {\n+        line = readValueLine(line);\n+        if (!line.startsWith(\"[\") && !line.endsWith(\"]\")) {\n+            throw new IllegalArgumentException(\"Invalid array string value: \" + line);\n+        }\n+        String arr[] = line.substring(1, line.length() - 1).split(\",\");\n+\n+        ArrayList<String> res = new ArrayList<>();\n+        for (String s : arr) {\n+            s = s.trim();\n+            if (!s.isEmpty()) {\n+                res.add(s);\n+            }\n+        }\n+\n+        return res.toArray(new String[res.size()]);\n+    }\n+\n+    private static String readString(String line, BufferedReader reader) throws Exception {\n+        line = readValueLine(line);\n+        String delim = \"\";\n+        if (line.startsWith(\"\\\"\") || line.startsWith(\"'\")) {\n+            delim = line.substring(0, 1);\n+            if (line.startsWith(\"\\\"\\\"\\\"\") || line.startsWith(\"'''\")) {\n+                delim = line.substring(0, 3);\n+            }\n+        }\n+\n+        if (StringUtil.isNullOrEmpty(delim)) {\n+            throw new IllegalArgumentException(\"Invalid string format, should start with ' or \\\" at least: \" + line);\n+        }\n+\n+        // Trim start delimiter\n+        if (line.startsWith(delim)) {\n+            line = line.substring(delim.length());\n+        }\n+\n+        // Read multiline string\n+        if (!line.endsWith(delim)) {\n+            String s;\n+            while ((s = reader.readLine()) != null) {\n+                line += \" \" + s.trim();\n+                if (line.endsWith(delim)) {\n+                    break;\n+                }\n+            }\n+        }\n+\n+        // Trim end delimiter\n+        if (line.endsWith(delim)) {\n+            line = line.substring(0, line.length() - delim.length());\n+        }\n+\n+        return line.trim();\n+    }\n+\n+    private static void validateAndAddSpec(List<EqlSpec> specs, EqlSpec spec, boolean supported) throws Exception {\n+        if (StringUtil.isNullOrEmpty(spec.query)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUyNjQzMA==", "bodyText": "Can you remove this, please?", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r379526430", "createdAt": "2020-02-14T16:30:52Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/action/EqlSearchResponse.java", "diffHunk": "@@ -71,6 +70,7 @@\n  *         EqlSearchResponse.Hits hits = new EqlSearchResponse.Hits(null, null, counts, totals);\n  *         EqlSearchResponse response = new EqlSearchResponse(hits, 5, false);\n  */\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7edf6c7c793ca1ca5625ba53c0c524f18b10dc4c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6b7f53e14a2caa887adf3f956811b64138fbce4", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/b6b7f53e14a2caa887adf3f956811b64138fbce4", "committedDate": "2020-02-18T19:44:30Z", "message": "Addressed code review. Replaced manual toml parser with Apache licensed toml parser library"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "595f316a1511292efe8d415d9b269a900b4d96b6", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/595f316a1511292efe8d415d9b269a900b4d96b6", "committedDate": "2020-02-19T02:15:25Z", "message": "Merge branch 'master' into feature/eql_validation_tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMjUyNDY1", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-361252465", "createdAt": "2020-02-19T16:43:00Z", "commit": {"oid": "595f316a1511292efe8d415d9b269a900b4d96b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo0MzowMVrOFruxew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo0MzowMVrOFruxew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM5OTQxOQ==", "bodyText": "nit: a more descriptive filename. i.e. endgame_mappings.json", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r381399419", "createdAt": "2020-02-19T16:43:01Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/src/test/resources/endgame.json", "diffHunk": "@@ -0,0 +1,2531 @@\n+{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "595f316a1511292efe8d415d9b269a900b4d96b6"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMjU0NTA4", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-361254508", "createdAt": "2020-02-19T16:45:19Z", "commit": {"oid": "595f316a1511292efe8d415d9b269a900b4d96b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo0NToxOVrOFru3wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjo0NToxOVrOFru3wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQwMTAyNQ==", "bodyText": "the mappings are consistent with the data, but the queries are not. EQL is independent of ECS, so I think it's okay to leave the data in the same schema that it was in", "url": "https://github.com/elastic/elasticsearch/pull/52248#discussion_r381401025", "createdAt": "2020-02-19T16:45:19Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/src/test/resources/endgame.ndjson", "diffHunk": "@@ -0,0 +1,102 @@\n+{\"user\":{\"group\":{}},\"host\":{\"os\":{\"platform\":\"windows\",\"name\":\"Windows\"},\"ip\":\"127.0.0.1\",\"hostname\":\"localhost\",\"name\":\"localhost\"},\"event\":{\"module\":\"endgame\",\"dataset\":\"esensor\",\"action\":\"already_running\",\"category\":\"process\",\"kind\":\"event\"},\"labels\":{\"account_id\":\"f6c123dc-b6d9-4849-937b-08c444ce7d96\",\"endpoint_id\":\"6a19472c-f0ab-4f3a-b83d-dc3698a5ff66\"},\"agent\":{\"type\":\"endgame\",\"id\":\"6a19472c-f0ab-4f3a-b83d-dc3698a5ff66\",\"version\":\"3.54.0\"},\"ecs\":{\"version\":\"1.1.0\"},\"@timestamp\":0,\"process\":{\"thread\":{},\"parent\":{},\"hash\":{},\"name\":\"System Idle Process\"},\"endgame\":{\"name\":\"localhost\",\"eid\":\"6a19472c-f0ab-4f3a-b83d-dc3698a5ff66\",\"MID\":\"\",\"ip\":\"127.0.0.1\",\"sver\":\"3.54.0\",\"os_type\":\"windows\",\"serial_event_id\":1,\"opcode\":3,\"event_type_full\":\"process_event\",\"event_subtype_full\":\"already_running\",\"timestamp\":116444736000000000,\"process_name\":\"System Idle Process\",\"unique_pid\":1,\"xml_message\":\"\",\"provider_name\":\"\",\"provider_guid\":\"\",\"channel_name\":\"\",\"subject_user_sid\":\"\",\"subject_user_name\":\"\",\"subject_domain_name\":\"\",\"subject_logon_id\":\"\",\"target_domain_name\":\"\",\"target_user_name\":\"\",\"target_logon_id\":\"\",\"ip_address\":\"\",\"computer_name\":\"\",\"privilege_list\":\"\",\"logon_type\":null,\"system_thread_id\":null,\"system_pid\":null,\"system_process_name\":\"\",\"query_name\":\"\",\"query_type\":null,\"query_results\":null,\"metadata\":{\"collection_time\":0}}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "595f316a1511292efe8d415d9b269a900b4d96b6"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f3da81ff2595a0b0753ad986cfa3d99966c8488", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f3da81ff2595a0b0753ad986cfa3d99966c8488", "committedDate": "2020-02-19T19:21:54Z", "message": "Replace the ECS test data with the flat json test data from origin EQL implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09260e685f970ea46a7f4cc2702c45acb54e485b", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/09260e685f970ea46a7f4cc2702c45acb54e485b", "committedDate": "2020-02-19T20:16:41Z", "message": "Convert EqlActionIT to parameterized test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d6111fe5a2f770ccfbc2d5379c25279d0348090", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d6111fe5a2f770ccfbc2d5379c25279d0348090", "committedDate": "2020-02-20T02:34:50Z", "message": "Merge branch 'master' into feature/eql_validation_tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6db4617e64cb95d3616d0c98b6f3ae8eab4ccd3b", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/6db4617e64cb95d3616d0c98b6f3ae8eab4ccd3b", "committedDate": "2020-02-20T03:11:52Z", "message": "Adjust the HL client test for a change in emulated EQL search response.\n\nThe fake response change was done in order to test the EQL validation harness imlementation.\nThis code will be replaced once we have the actualy EQL implementation wired."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "384cfd8cd74817088c36c6f34d3d17f3d8d47843", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/384cfd8cd74817088c36c6f34d3d17f3d8d47843", "committedDate": "2020-02-20T15:04:26Z", "message": "Addressed Ross' remaining code review comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efb551b8a47aef3faff4ebb8f15c0965df15028d", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/efb551b8a47aef3faff4ebb8f15c0965df15028d", "committedDate": "2020-02-20T15:03:05Z", "message": "Addressed Ross' remaining code review comment"}, "afterCommit": {"oid": "384cfd8cd74817088c36c6f34d3d17f3d8d47843", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/384cfd8cd74817088c36c6f34d3d17f3d8d47843", "committedDate": "2020-02-20T15:04:26Z", "message": "Addressed Ross' remaining code review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNTk4NTg0", "url": "https://github.com/elastic/elasticsearch/pull/52248#pullrequestreview-362598584", "createdAt": "2020-02-21T12:33:57Z", "commit": {"oid": "384cfd8cd74817088c36c6f34d3d17f3d8d47843"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54035b19e19854e9d13b95d074f83eec31eae495", "author": {"user": {"login": "aleksmaus", "name": "Aleksandr Maus"}}, "url": "https://github.com/elastic/elasticsearch/commit/54035b19e19854e9d13b95d074f83eec31eae495", "committedDate": "2020-02-21T22:20:19Z", "message": "Merge branch 'master' into feature/eql_validation_tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2597, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}