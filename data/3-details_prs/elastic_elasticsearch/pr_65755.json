{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMDg5Mjkw", "number": 65755, "title": "[ML] Fix snapshot upgrader so that if state is not fully written or parseable the task fails", "bodyText": "It is possible that snapshot upgrader execution path continues before the old\nmodel state is fully read by the native process.\nTo prevent this, a flush request is made after the state is loaded. This is to verify that the all the state\nhas been read by the native process. This allows the task to fail if reading the state fails and prevents some\nstrange race conditions.\ncloses #65699", "createdAt": "2020-12-02T15:18:45Z", "url": "https://github.com/elastic/elasticsearch/pull/65755", "merged": true, "mergeCommit": {"oid": "dd50520f9d8bd2480a68e85bb28c49aafa6b7119"}, "closed": true, "closedAt": "2020-12-03T14:16:06Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiAlY9AH2gAyNTMxMDg5MjkwOmZmNDVmYzIwMGE0N2JjZDFhY2IxZDc0OTlmNWZmMDE5ZGIwMTc4MGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdigPEggFqTU0Mzc2NTYwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff45fc200a47bcd1acb1d7499f5ff019db01780f", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff45fc200a47bcd1acb1d7499f5ff019db01780f", "committedDate": "2020-12-01T21:11:30Z", "message": "[ML] allow snapshot upgrader task to fail if state streamer fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d13d3bb2191fb4f75d1334d7d2f397908691cad0", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/d13d3bb2191fb4f75d1334d7d2f397908691cad0", "committedDate": "2020-12-02T13:32:15Z", "message": "attempting to catch flush"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43a423acca69465abd422bda52124bf395a082fd", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/43a423acca69465abd422bda52124bf395a082fd", "committedDate": "2020-12-02T13:32:31Z", "message": "Merge remote-tracking branch 'upstream/master' into test/ml-fix-snapshot-upgrader-it-tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9074c0920cd63ac7cc252d98fdeafd35159cb80", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9074c0920cd63ac7cc252d98fdeafd35159cb80", "committedDate": "2020-12-02T14:09:47Z", "message": "updating to handle flush"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "468aea5259e824cb80d6c7058a1291e7a5c5da46", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/468aea5259e824cb80d6c7058a1291e7a5c5da46", "committedDate": "2020-12-02T15:15:07Z", "message": "simplify"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNzY1NjAx", "url": "https://github.com/elastic/elasticsearch/pull/65755#pullrequestreview-543765601", "createdAt": "2020-12-03T09:37:17Z", "commit": {"oid": "468aea5259e824cb80d6c7058a1291e7a5c5da46"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTozNzoxN1rOH-OiVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTozNzoxN1rOH-OiVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTAxMTkyNw==", "bodyText": "I think the old single line version was more readable", "url": "https://github.com/elastic/elasticsearch/pull/65755#discussion_r535011927", "createdAt": "2020-12-03T09:37:17Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/JobModelSnapshotUpgrader.java", "diffHunk": "@@ -97,7 +100,9 @@ void start() {\n             params,\n             autodetectExecutorService,\n             (reason) -> {\n-                setTaskToFailed(reason, ActionListener.wrap(t -> {}, f -> {}));\n+                setTaskToFailed(reason, ActionListener.wrap(t -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "468aea5259e824cb80d6c7058a1291e7a5c5da46"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4105, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}