{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3ODI5NDk3", "number": 63239, "title": "Replace some usages of QueryShardContext#getMapperService", "bodyText": "QueryShardContext has a getter that allows to have access to MapperService. In many cases, it is misused to lookup field types which QueryShardContext has a specific method for. This commit replaces those usages with a function String -> MappedFieldType.\nThere are also a few other places where MapperService is retrieved to call methods that are also available directly on QueryShardContext, which are replaced as part of this PR too.", "createdAt": "2020-10-05T12:48:56Z", "url": "https://github.com/elastic/elasticsearch/pull/63239", "merged": true, "mergeCommit": {"oid": "cf130f386e5a83e35508f08a1c75352d3b071a08"}, "closed": true, "closedAt": "2020-10-05T16:02:56Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPjNS_AH2gAyNDk3ODI5NDk3OjY4N2RkYjMzZjgzZDk3NmU0MTFmMjEyNDBhZGY3MmNlNzlhZGE3NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPlQwEgFqTUwMjE1Njg2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "687ddb33f83d976e411f21240adf72ce79ada762", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/687ddb33f83d976e411f21240adf72ce79ada762", "committedDate": "2020-10-05T12:47:18Z", "message": "Replace some usages of QueryShardContext#getMapperService\n\nQueryShardContext a getter that allows to have access to the MapperService. In many cases, it is misused to lookup field types which QueryShardContext has a specific method for. This commit replaces those usages with a function String -> MappedFieldType ."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDQzNDU2", "url": "https://github.com/elastic/elasticsearch/pull/63239#pullrequestreview-502043456", "createdAt": "2020-10-05T13:15:57Z", "commit": {"oid": "687ddb33f83d976e411f21240adf72ce79ada762"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzoxNTo1N1rOHcchlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzoyMDoxMlrOHcctMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4OTUyNg==", "bodyText": "Maybe we should rename this fieldType rather than fieldMapper?", "url": "https://github.com/elastic/elasticsearch/pull/63239#discussion_r499589526", "createdAt": "2020-10-05T13:15:57Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/query/functionscore/FieldValueFactorFunctionBuilder.java", "diffHunk": "@@ -144,7 +144,7 @@ protected int doHashCode() {\n \n     @Override\n     protected ScoreFunction doToFunction(QueryShardContext context) {\n-        MappedFieldType fieldType = context.getMapperService().fieldType(field);\n+        MappedFieldType fieldType = context.fieldMapper(field);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "687ddb33f83d976e411f21240adf72ce79ada762"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4OTU5Mg==", "bodyText": "I do wonder if we can remove this step entirely, or replace it with the ValueFetcher functionality somehow - for a followup though.", "url": "https://github.com/elastic/elasticsearch/pull/63239#discussion_r499589592", "createdAt": "2020-10-05T13:16:04Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "diffHunk": "@@ -87,9 +87,9 @@ public Status needsField(FieldInfo fieldInfo) {\n                 : Status.NO;\n     }\n \n-    public void postProcess(MapperService mapperService) {\n+    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "687ddb33f83d976e411f21240adf72ce79ada762"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU5MjQ5Nw==", "bodyText": "So this doesn't do anything to the _id, _source or _routing fields, so I think we can remove the call to it entirely from LuceneChangesSnapshot and possibly a few other places as well.", "url": "https://github.com/elastic/elasticsearch/pull/63239#discussion_r499592497", "createdAt": "2020-10-05T13:20:12Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "diffHunk": "@@ -87,9 +87,9 @@ public Status needsField(FieldInfo fieldInfo) {\n                 : Status.NO;\n     }\n \n-    public void postProcess(MapperService mapperService) {\n+    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU4OTU5Mg=="}, "originalCommit": {"oid": "687ddb33f83d976e411f21240adf72ce79ada762"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb8b9dadcb7f917006a7b30465875e38c5e7203e", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb8b9dadcb7f917006a7b30465875e38c5e7203e", "committedDate": "2020-10-05T13:57:04Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aee74d6bbdbf612921820bc90e52e2221b80016", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/8aee74d6bbdbf612921820bc90e52e2221b80016", "committedDate": "2020-10-05T14:33:07Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac58f01e2bf5caf0a5cb98a112a95276ca1f26af", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/ac58f01e2bf5caf0a5cb98a112a95276ca1f26af", "committedDate": "2020-10-05T14:44:42Z", "message": "mapper service may be null for closed indices"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTU2ODY4", "url": "https://github.com/elastic/elasticsearch/pull/63239#pullrequestreview-502156868", "createdAt": "2020-10-05T15:10:53Z", "commit": {"oid": "ac58f01e2bf5caf0a5cb98a112a95276ca1f26af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4406, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}