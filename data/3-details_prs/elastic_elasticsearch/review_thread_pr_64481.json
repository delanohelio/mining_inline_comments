{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MTEyMjA0", "number": 64481, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo1MTo0N1rOE6SKRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzoxODoyNFrOE7oe6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NTUwNDA3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo1MTo0N1rOH1QNTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo1MTo0N1rOH1QNTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwMjEyNw==", "bodyText": "nit: can we use Version.CURRENT.minimumRestCompatibilityVersion() instead of Version.CURRENT.major -1 ? (to help encapsulate the logic)", "url": "https://github.com/elastic/elasticsearch/pull/64481#discussion_r525602127", "createdAt": "2020-11-17T23:51:47Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.compat;\n+\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.xcontent.MediaType;\n+import org.elasticsearch.common.xcontent.ParsedMediaType;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.RestCompatibilityPlugin;\n+import org.elasticsearch.rest.RestStatus;\n+\n+public class CompatibleVersionPlugin extends Plugin implements RestCompatibilityPlugin {\n+\n+    @Override\n+    public Version getCompatibleVersion(\n+        @Nullable ParsedMediaType acceptHeader,\n+        @Nullable ParsedMediaType contentTypeHeader,\n+        boolean hasContent\n+    ) {\n+        Byte aVersion = parseVersion(acceptHeader);\n+        byte acceptVersion = aVersion == null ? Version.CURRENT.major : Integer.valueOf(aVersion).byteValue();\n+        Byte cVersion = parseVersion(contentTypeHeader);\n+        byte contentTypeVersion = cVersion == null ? Version.CURRENT.major : Integer.valueOf(cVersion).byteValue();\n+\n+        // accept version must be current or prior\n+        if (acceptVersion > Version.CURRENT.major || acceptVersion < Version.CURRENT.major - 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16a1b837a8b1edd04188017f0acc7aec23781f8c"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NTUxMzMyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo1NToxOFrOH1QSkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo1NToxOFrOH1QSkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwMzQ3NA==", "bodyText": "nit: rather then saying \"must be equal or less then the current version\" , can it say \"must be either version {} or {}, but found {}. Accept={}\" ,  Version.CURRENT.major, Version.CURRENT.minimumRestCompatibilityVersion() , acceptVersion, acceptHeader (no need to put content-type here)", "url": "https://github.com/elastic/elasticsearch/pull/64481#discussion_r525603474", "createdAt": "2020-11-17T23:55:18Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.compat;\n+\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.xcontent.MediaType;\n+import org.elasticsearch.common.xcontent.ParsedMediaType;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.RestCompatibilityPlugin;\n+import org.elasticsearch.rest.RestStatus;\n+\n+public class CompatibleVersionPlugin extends Plugin implements RestCompatibilityPlugin {\n+\n+    @Override\n+    public Version getCompatibleVersion(\n+        @Nullable ParsedMediaType acceptHeader,\n+        @Nullable ParsedMediaType contentTypeHeader,\n+        boolean hasContent\n+    ) {\n+        Byte aVersion = parseVersion(acceptHeader);\n+        byte acceptVersion = aVersion == null ? Version.CURRENT.major : Integer.valueOf(aVersion).byteValue();\n+        Byte cVersion = parseVersion(contentTypeHeader);\n+        byte contentTypeVersion = cVersion == null ? Version.CURRENT.major : Integer.valueOf(cVersion).byteValue();\n+\n+        // accept version must be current or prior\n+        if (acceptVersion > Version.CURRENT.major || acceptVersion < Version.CURRENT.major - 1) {\n+            throw new ElasticsearchStatusException(\n+                \"Compatible version must be equal or less then the current version. Accept={}} Content-Type={}}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16a1b837a8b1edd04188017f0acc7aec23781f8c"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NTUxNjkzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo1Njo1N1rOH1QU1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo1Njo1N1rOH1QU1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwNDA1Mw==", "bodyText": "same nitpicks as above... use the minumRestCompatibltyVersion and tweak the error message to be more precise (and no need for the accept header here)", "url": "https://github.com/elastic/elasticsearch/pull/64481#discussion_r525604053", "createdAt": "2020-11-17T23:56:57Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.compat;\n+\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.xcontent.MediaType;\n+import org.elasticsearch.common.xcontent.ParsedMediaType;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.RestCompatibilityPlugin;\n+import org.elasticsearch.rest.RestStatus;\n+\n+public class CompatibleVersionPlugin extends Plugin implements RestCompatibilityPlugin {\n+\n+    @Override\n+    public Version getCompatibleVersion(\n+        @Nullable ParsedMediaType acceptHeader,\n+        @Nullable ParsedMediaType contentTypeHeader,\n+        boolean hasContent\n+    ) {\n+        Byte aVersion = parseVersion(acceptHeader);\n+        byte acceptVersion = aVersion == null ? Version.CURRENT.major : Integer.valueOf(aVersion).byteValue();\n+        Byte cVersion = parseVersion(contentTypeHeader);\n+        byte contentTypeVersion = cVersion == null ? Version.CURRENT.major : Integer.valueOf(cVersion).byteValue();\n+\n+        // accept version must be current or prior\n+        if (acceptVersion > Version.CURRENT.major || acceptVersion < Version.CURRENT.major - 1) {\n+            throw new ElasticsearchStatusException(\n+                \"Compatible version must be equal or less then the current version. Accept={}} Content-Type={}}\",\n+                RestStatus.BAD_REQUEST,\n+                acceptHeader,\n+                contentTypeHeader\n+            );\n+        }\n+        if (hasContent) {\n+\n+            // content-type version must be current or prior\n+            if (contentTypeVersion > Version.CURRENT.major || contentTypeVersion < Version.CURRENT.major - 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16a1b837a8b1edd04188017f0acc7aec23781f8c"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NTUyNDI5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDowMDowMVrOH1QZGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDowMDowMVrOH1QZGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwNTE0Ng==", "bodyText": "nit: A compatible version is required on both Content-Type and Accept headers if either one has requested a compatible version. Accept={}, Content-Type={}", "url": "https://github.com/elastic/elasticsearch/pull/64481#discussion_r525605146", "createdAt": "2020-11-18T00:00:01Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.compat;\n+\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.xcontent.MediaType;\n+import org.elasticsearch.common.xcontent.ParsedMediaType;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.RestCompatibilityPlugin;\n+import org.elasticsearch.rest.RestStatus;\n+\n+public class CompatibleVersionPlugin extends Plugin implements RestCompatibilityPlugin {\n+\n+    @Override\n+    public Version getCompatibleVersion(\n+        @Nullable ParsedMediaType acceptHeader,\n+        @Nullable ParsedMediaType contentTypeHeader,\n+        boolean hasContent\n+    ) {\n+        Byte aVersion = parseVersion(acceptHeader);\n+        byte acceptVersion = aVersion == null ? Version.CURRENT.major : Integer.valueOf(aVersion).byteValue();\n+        Byte cVersion = parseVersion(contentTypeHeader);\n+        byte contentTypeVersion = cVersion == null ? Version.CURRENT.major : Integer.valueOf(cVersion).byteValue();\n+\n+        // accept version must be current or prior\n+        if (acceptVersion > Version.CURRENT.major || acceptVersion < Version.CURRENT.major - 1) {\n+            throw new ElasticsearchStatusException(\n+                \"Compatible version must be equal or less then the current version. Accept={}} Content-Type={}}\",\n+                RestStatus.BAD_REQUEST,\n+                acceptHeader,\n+                contentTypeHeader\n+            );\n+        }\n+        if (hasContent) {\n+\n+            // content-type version must be current or prior\n+            if (contentTypeVersion > Version.CURRENT.major || contentTypeVersion < Version.CURRENT.major - 1) {\n+                throw new ElasticsearchStatusException(\n+                    \"Compatible version must be equal or less then the current version. Accept={} Content-Type={}\",\n+                    RestStatus.BAD_REQUEST,\n+                    acceptHeader,\n+                    contentTypeHeader,\n+                    RestStatus.BAD_REQUEST\n+                );\n+            }\n+            // if both accept and content-type are sent, the version must match\n+            if (contentTypeVersion != acceptVersion) {\n+                throw new ElasticsearchStatusException(\n+                    \"Content-Type and Accept version requests have to match. Accept={} Content-Type={}\",\n+                    RestStatus.BAD_REQUEST,\n+                    acceptHeader,\n+                    contentTypeHeader\n+                );\n+            }\n+            // both headers should be versioned or none\n+            if ((cVersion == null && aVersion != null) || (aVersion == null && cVersion != null)) {\n+                throw new ElasticsearchStatusException(\n+                    \"Versioning is required on both Content-Type and Accept headers. Accept={} Content-Type={}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16a1b837a8b1edd04188017f0acc7aec23781f8c"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NTUyOTgyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDowMjoyMVrOH1QcXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDowMjoyMVrOH1QcXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwNTk4Mw==", "bodyText": "nit: A compatible version is required on both Content-Type and Accept headers if either one has requested a compatible version and the compatible versions must match. Accept={}, Content-Type={}", "url": "https://github.com/elastic/elasticsearch/pull/64481#discussion_r525605983", "createdAt": "2020-11-18T00:02:21Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.compat;\n+\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.xcontent.MediaType;\n+import org.elasticsearch.common.xcontent.ParsedMediaType;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.RestCompatibilityPlugin;\n+import org.elasticsearch.rest.RestStatus;\n+\n+public class CompatibleVersionPlugin extends Plugin implements RestCompatibilityPlugin {\n+\n+    @Override\n+    public Version getCompatibleVersion(\n+        @Nullable ParsedMediaType acceptHeader,\n+        @Nullable ParsedMediaType contentTypeHeader,\n+        boolean hasContent\n+    ) {\n+        Byte aVersion = parseVersion(acceptHeader);\n+        byte acceptVersion = aVersion == null ? Version.CURRENT.major : Integer.valueOf(aVersion).byteValue();\n+        Byte cVersion = parseVersion(contentTypeHeader);\n+        byte contentTypeVersion = cVersion == null ? Version.CURRENT.major : Integer.valueOf(cVersion).byteValue();\n+\n+        // accept version must be current or prior\n+        if (acceptVersion > Version.CURRENT.major || acceptVersion < Version.CURRENT.major - 1) {\n+            throw new ElasticsearchStatusException(\n+                \"Compatible version must be equal or less then the current version. Accept={}} Content-Type={}}\",\n+                RestStatus.BAD_REQUEST,\n+                acceptHeader,\n+                contentTypeHeader\n+            );\n+        }\n+        if (hasContent) {\n+\n+            // content-type version must be current or prior\n+            if (contentTypeVersion > Version.CURRENT.major || contentTypeVersion < Version.CURRENT.major - 1) {\n+                throw new ElasticsearchStatusException(\n+                    \"Compatible version must be equal or less then the current version. Accept={} Content-Type={}\",\n+                    RestStatus.BAD_REQUEST,\n+                    acceptHeader,\n+                    contentTypeHeader,\n+                    RestStatus.BAD_REQUEST\n+                );\n+            }\n+            // if both accept and content-type are sent, the version must match\n+            if (contentTypeVersion != acceptVersion) {\n+                throw new ElasticsearchStatusException(\n+                    \"Content-Type and Accept version requests have to match. Accept={} Content-Type={}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16a1b837a8b1edd04188017f0acc7aec23781f8c"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5NTUzMzkzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDowNDoyMlrOH1Qe6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNDoxOTo1MlrOH1v9_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwNjYzNQ==", "bodyText": "Can this ever evaluate true ? wouldn't the above if catch any this case ?", "url": "https://github.com/elastic/elasticsearch/pull/64481#discussion_r525606635", "createdAt": "2020-11-18T00:04:22Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.compat;\n+\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.xcontent.MediaType;\n+import org.elasticsearch.common.xcontent.ParsedMediaType;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.RestCompatibilityPlugin;\n+import org.elasticsearch.rest.RestStatus;\n+\n+public class CompatibleVersionPlugin extends Plugin implements RestCompatibilityPlugin {\n+\n+    @Override\n+    public Version getCompatibleVersion(\n+        @Nullable ParsedMediaType acceptHeader,\n+        @Nullable ParsedMediaType contentTypeHeader,\n+        boolean hasContent\n+    ) {\n+        Byte aVersion = parseVersion(acceptHeader);\n+        byte acceptVersion = aVersion == null ? Version.CURRENT.major : Integer.valueOf(aVersion).byteValue();\n+        Byte cVersion = parseVersion(contentTypeHeader);\n+        byte contentTypeVersion = cVersion == null ? Version.CURRENT.major : Integer.valueOf(cVersion).byteValue();\n+\n+        // accept version must be current or prior\n+        if (acceptVersion > Version.CURRENT.major || acceptVersion < Version.CURRENT.major - 1) {\n+            throw new ElasticsearchStatusException(\n+                \"Compatible version must be equal or less then the current version. Accept={}} Content-Type={}}\",\n+                RestStatus.BAD_REQUEST,\n+                acceptHeader,\n+                contentTypeHeader\n+            );\n+        }\n+        if (hasContent) {\n+\n+            // content-type version must be current or prior\n+            if (contentTypeVersion > Version.CURRENT.major || contentTypeVersion < Version.CURRENT.major - 1) {\n+                throw new ElasticsearchStatusException(\n+                    \"Compatible version must be equal or less then the current version. Accept={} Content-Type={}\",\n+                    RestStatus.BAD_REQUEST,\n+                    acceptHeader,\n+                    contentTypeHeader,\n+                    RestStatus.BAD_REQUEST\n+                );\n+            }\n+            // if both accept and content-type are sent, the version must match\n+            if (contentTypeVersion != acceptVersion) {\n+                throw new ElasticsearchStatusException(\n+                    \"Content-Type and Accept version requests have to match. Accept={} Content-Type={}\",\n+                    RestStatus.BAD_REQUEST,\n+                    acceptHeader,\n+                    contentTypeHeader\n+                );\n+            }\n+            // both headers should be versioned or none\n+            if ((cVersion == null && aVersion != null) || (aVersion == null && cVersion != null)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16a1b837a8b1edd04188017f0acc7aec23781f8c"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjEyMjQ5Mg==", "bodyText": "the above if             if (contentTypeVersion != acceptVersion) { would not catch the scenario when one of the headers is set to compatible-with=8 (current in general) and the other is not set (defaults to current)\n   expectThrows(\n            ElasticsearchStatusException.class,\n            () -> requestWith(acceptHeader(CURRENT_VERSION), contentTypeHeader(null), bodyPresent())\n        );\n\nexpectThrows(\n            ElasticsearchStatusException.class,\n            () -> requestWith(acceptHeader(null), contentTypeHeader(CURRENT_VERSION), bodyPresent())\n        );", "url": "https://github.com/elastic/elasticsearch/pull/64481#discussion_r526122492", "createdAt": "2020-11-18T14:19:52Z", "author": {"login": "pgomulka"}, "path": "x-pack/plugin/rest-compatibility/src/main/java/org/elasticsearch/compat/CompatibleVersionPlugin.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.compat;\n+\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.xcontent.MediaType;\n+import org.elasticsearch.common.xcontent.ParsedMediaType;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.RestCompatibilityPlugin;\n+import org.elasticsearch.rest.RestStatus;\n+\n+public class CompatibleVersionPlugin extends Plugin implements RestCompatibilityPlugin {\n+\n+    @Override\n+    public Version getCompatibleVersion(\n+        @Nullable ParsedMediaType acceptHeader,\n+        @Nullable ParsedMediaType contentTypeHeader,\n+        boolean hasContent\n+    ) {\n+        Byte aVersion = parseVersion(acceptHeader);\n+        byte acceptVersion = aVersion == null ? Version.CURRENT.major : Integer.valueOf(aVersion).byteValue();\n+        Byte cVersion = parseVersion(contentTypeHeader);\n+        byte contentTypeVersion = cVersion == null ? Version.CURRENT.major : Integer.valueOf(cVersion).byteValue();\n+\n+        // accept version must be current or prior\n+        if (acceptVersion > Version.CURRENT.major || acceptVersion < Version.CURRENT.major - 1) {\n+            throw new ElasticsearchStatusException(\n+                \"Compatible version must be equal or less then the current version. Accept={}} Content-Type={}}\",\n+                RestStatus.BAD_REQUEST,\n+                acceptHeader,\n+                contentTypeHeader\n+            );\n+        }\n+        if (hasContent) {\n+\n+            // content-type version must be current or prior\n+            if (contentTypeVersion > Version.CURRENT.major || contentTypeVersion < Version.CURRENT.major - 1) {\n+                throw new ElasticsearchStatusException(\n+                    \"Compatible version must be equal or less then the current version. Accept={} Content-Type={}\",\n+                    RestStatus.BAD_REQUEST,\n+                    acceptHeader,\n+                    contentTypeHeader,\n+                    RestStatus.BAD_REQUEST\n+                );\n+            }\n+            // if both accept and content-type are sent, the version must match\n+            if (contentTypeVersion != acceptVersion) {\n+                throw new ElasticsearchStatusException(\n+                    \"Content-Type and Accept version requests have to match. Accept={} Content-Type={}\",\n+                    RestStatus.BAD_REQUEST,\n+                    acceptHeader,\n+                    contentTypeHeader\n+                );\n+            }\n+            // both headers should be versioned or none\n+            if ((cVersion == null && aVersion != null) || (aVersion == null && cVersion != null)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwNjYzNQ=="}, "originalCommit": {"oid": "16a1b837a8b1edd04188017f0acc7aec23781f8c"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwOTY0NzE1OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/node/NodeTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzoxODoyNFrOH3Y2uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNzoxODoyNFrOH3Y2uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg0MDk1Mw==", "bodyText": "can you check the message? We've had tests like this before and didn't check the message and there was some other cause of the exception rather than the true cause.", "url": "https://github.com/elastic/elasticsearch/pull/64481#discussion_r527840953", "createdAt": "2020-11-20T17:18:24Z", "author": {"login": "jaymode"}, "path": "server/src/test/java/org/elasticsearch/node/NodeTests.java", "diffHunk": "@@ -339,4 +343,55 @@ public void setCircuitBreaker(CircuitBreaker circuitBreaker) {\n             myCircuitBreaker.set(circuitBreaker);\n         }\n     }\n+\n+    public static class TestRestCompatibility1 extends Plugin implements RestCompatibilityPlugin {\n+        @Override\n+        public Version getCompatibleVersion(ParsedMediaType acceptHeader, ParsedMediaType contentTypeHeader, boolean hasContent) {\n+            return Version.CURRENT.previousMajor();\n+        }\n+    }\n+\n+    public static class TestRestCompatibility2 extends Plugin implements RestCompatibilityPlugin {\n+        @Override\n+        public Version getCompatibleVersion(ParsedMediaType acceptHeader, ParsedMediaType contentTypeHeader, boolean hasContent) {\n+            return null;\n+        }\n+    }\n+\n+    public void testLoadingMultipleRestCompatibilityPlugins() throws IOException {\n+        Settings.Builder settings = baseSettings();\n+\n+        // throw an exception when two plugins are registered\n+        List<Class<? extends Plugin>> plugins = basePlugins();\n+        plugins.add(TestRestCompatibility1.class);\n+        plugins.add(TestRestCompatibility2.class);\n+\n+        expectThrows(IllegalStateException.class, () -> new MockNode(settings.build(), plugins));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b7b511c3c6ecc11924cee036aa294cc1d64853"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4147, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}