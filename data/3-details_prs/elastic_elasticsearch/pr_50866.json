{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNTYyNTEy", "number": 50866, "title": "QL: Extend NodeSubclass to read classes from jars", "bodyText": "As the test classes are spread across more than one project, the Gradle\nclasspath contains not just folders but also jars.\nThis commit allows the test class to explore the archive content and\nload matching classes from said source.\nWith the fix in place, two test classes affected by this (around 600 tests) are now enabled.", "createdAt": "2020-01-10T18:03:11Z", "url": "https://github.com/elastic/elasticsearch/pull/50866", "merged": true, "mergeCommit": {"oid": "25ad74928afcbf286dc58f7d430491b0af662f04"}, "closed": true, "closedAt": "2020-01-15T09:05:53Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5CcmuAH2gAyMzYxNTYyNTEyOjRlOGZmYTFhZGQ3ODY4NDFiYTM4MTlmYTc1MDc0YThkNGRhMzMwZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6W3ybgH2gAyMzYxNTYyNTEyOmUwYzE0NjJhMmUwMWI4ODk5MDkyMTEwMzUyN2Q2ZjllNmY1ODlhNzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4e8ffa1add786841ba3819fa75074a8d4da330d2", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/4e8ffa1add786841ba3819fa75074a8d4da330d2", "committedDate": "2020-01-10T17:59:40Z", "message": "Extend NodeSubclass to read classes from jars\n\nAs the test classes are spread across more than one project, the Gradle\nclasspath contains not just folders but also jars.\nThis commit allows the test class to explore the archive content and\nload matching classes from said source."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9386b26b9b7c82de0dff59a5ba63150dcda1fef", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/a9386b26b9b7c82de0dff59a5ba63150dcda1fef", "committedDate": "2020-01-10T19:25:43Z", "message": "Fix forbiddenApi"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzc4MjY5", "url": "https://github.com/elastic/elasticsearch/pull/50866#pullrequestreview-342378269", "createdAt": "2020-01-14T09:08:59Z", "commit": {"oid": "a9386b26b9b7c82de0dff59a5ba63150dcda1fef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwOTowODo1OVrOFdQV8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwOTowODo1OVrOFdQV8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIyMDc4NQ==", "bodyText": "Is !/ intended as a visual marker in the path? The location is later only used for the message in the Exception, so I guess so, but curious about it.", "url": "https://github.com/elastic/elasticsearch/pull/50866#discussion_r366220785", "createdAt": "2020-01-14T09:08:59Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/tree/NodeSubclassTests.java", "diffHunk": "@@ -618,45 +622,77 @@ protected boolean hasAtLeastTwoChildren(Class<? extends Node<?>> toBuildClass) {\n         for (String path: paths) {\n             Path root = PathUtils.get(path);\n             int rootLength = root.toString().length() + 1;\n-            Files.walkFileTree(root, new SimpleFileVisitor<Path>() {\n-\n-                @Override\n-                public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {\n-                    if (Files.isRegularFile(file) && file.getFileName().toString().endsWith(\".class\")) {\n-                        String className = file.toString();\n-                        // Chop off the root and file extension\n-                        className = className.substring(rootLength, className.length() - \".class\".length());\n-                        // Go from \"path\" style to class style\n-                        className = className.replace(PathUtils.getDefaultFileSystem().getSeparator(), \".\");\n-\n-                        // filter the class that are not interested\n-                        // (and IDE folders like eclipse)\n-                        if (!className.startsWith(\"org.elasticsearch.xpack.ql\") && !className.startsWith(\"org.elasticsearch.xpack.sql\")) {\n-                            return FileVisitResult.CONTINUE;\n-                        }\n-\n-                        Class<?> c;\n-                        try {\n-                            c = Class.forName(className);\n-                        } catch (ClassNotFoundException e) {\n-                            throw new IOException(\"Couldn't find \" + file, e);\n-                        }\n \n-                        if (false == Modifier.isAbstract(c.getModifiers())\n-                                && false == c.isAnonymousClass()\n-                                && clazz.isAssignableFrom(c)) {\n-                            Class<? extends T> s = c.asSubclass(clazz);\n-                            results.add(s);\n+            // load classes from jar files\n+            // NIO FileSystem API is not used since it trips the SecurityManager\n+            // https://bugs.openjdk.java.net/browse/JDK-8160798\n+            // so iterate the jar \"by hand\"\n+            if (path.endsWith(\".jar\") && path.contains(\"x-pack-ql\")) {\n+                try (JarInputStream jar = jarStream(root)) {\n+                    JarEntry je = null;\n+                    while ((je = jar.getNextJarEntry()) != null) {\n+                        String name = je.getName();\n+                        if (name.endsWith(\".class\")) {\n+                            String className = name.substring(0, name.length() - \".class\".length()).replace(\"/\", \".\");\n+                            maybeLoadClass(clazz, className, root + \"!/\" + name, results);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9386b26b9b7c82de0dff59a5ba63150dcda1fef"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzc4MzMw", "url": "https://github.com/elastic/elasticsearch/pull/50866#pullrequestreview-342378330", "createdAt": "2020-01-14T09:09:05Z", "commit": {"oid": "a9386b26b9b7c82de0dff59a5ba63150dcda1fef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwOTowOTowNlrOFdQWHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwOTowOTowNlrOFdQWHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjIyMDgzMQ==", "bodyText": "Maybe attemptClassLoad()?", "url": "https://github.com/elastic/elasticsearch/pull/50866#discussion_r366220831", "createdAt": "2020-01-14T09:09:06Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/tree/NodeSubclassTests.java", "diffHunk": "@@ -618,45 +622,77 @@ protected boolean hasAtLeastTwoChildren(Class<? extends Node<?>> toBuildClass) {\n         for (String path: paths) {\n             Path root = PathUtils.get(path);\n             int rootLength = root.toString().length() + 1;\n-            Files.walkFileTree(root, new SimpleFileVisitor<Path>() {\n-\n-                @Override\n-                public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {\n-                    if (Files.isRegularFile(file) && file.getFileName().toString().endsWith(\".class\")) {\n-                        String className = file.toString();\n-                        // Chop off the root and file extension\n-                        className = className.substring(rootLength, className.length() - \".class\".length());\n-                        // Go from \"path\" style to class style\n-                        className = className.replace(PathUtils.getDefaultFileSystem().getSeparator(), \".\");\n-\n-                        // filter the class that are not interested\n-                        // (and IDE folders like eclipse)\n-                        if (!className.startsWith(\"org.elasticsearch.xpack.ql\") && !className.startsWith(\"org.elasticsearch.xpack.sql\")) {\n-                            return FileVisitResult.CONTINUE;\n-                        }\n-\n-                        Class<?> c;\n-                        try {\n-                            c = Class.forName(className);\n-                        } catch (ClassNotFoundException e) {\n-                            throw new IOException(\"Couldn't find \" + file, e);\n-                        }\n \n-                        if (false == Modifier.isAbstract(c.getModifiers())\n-                                && false == c.isAnonymousClass()\n-                                && clazz.isAssignableFrom(c)) {\n-                            Class<? extends T> s = c.asSubclass(clazz);\n-                            results.add(s);\n+            // load classes from jar files\n+            // NIO FileSystem API is not used since it trips the SecurityManager\n+            // https://bugs.openjdk.java.net/browse/JDK-8160798\n+            // so iterate the jar \"by hand\"\n+            if (path.endsWith(\".jar\") && path.contains(\"x-pack-ql\")) {\n+                try (JarInputStream jar = jarStream(root)) {\n+                    JarEntry je = null;\n+                    while ((je = jar.getNextJarEntry()) != null) {\n+                        String name = je.getName();\n+                        if (name.endsWith(\".class\")) {\n+                            String className = name.substring(0, name.length() - \".class\".length()).replace(\"/\", \".\");\n+                            maybeLoadClass(clazz, className, root + \"!/\" + name, results);\n                         }\n                     }\n-                    return FileVisitResult.CONTINUE;\n                 }\n-            });\n+            }\n+            // for folders, just use the FileSystems API\n+            else {\n+                Files.walkFileTree(root, new SimpleFileVisitor<Path>() {\n+                    @Override\n+                    public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {\n+                        if (Files.isRegularFile(file) && file.getFileName().toString().endsWith(\".class\")) {\n+                            String fileName = file.toString();\n+                            // Chop off the root and file extension\n+                            String className = fileName.substring(rootLength, fileName.length() - \".class\".length());\n+                            // Go from \"path\" style to class style\n+                            className = className.replace(PathUtils.getDefaultFileSystem().getSeparator(), \".\");\n+                            maybeLoadClass(clazz, className, fileName, results);\n+                        }\n+                        return FileVisitResult.CONTINUE;\n+                    }\n+                });\n+            }\n         }\n         subclassCache.put(clazz, results);\n         return results;\n     }\n \n+    @SuppressForbidden(reason = \"test reads from jar\")\n+    private static JarInputStream jarStream(Path path) throws IOException {\n+        return new JarInputStream(path.toUri().toURL().openStream());\n+    }\n+\n+    /**\n+     * Load classes from predefined packages (hack to limit the scope) and if they match the hierarchy, add them to the cache\n+     */\n+    private static <T> void maybeLoadClass(Class<T> clazz, String className, String location, List<Class<? extends T>> results)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9386b26b9b7c82de0dff59a5ba63150dcda1fef"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzc4NTY1", "url": "https://github.com/elastic/elasticsearch/pull/50866#pullrequestreview-342378565", "createdAt": "2020-01-14T09:09:28Z", "commit": {"oid": "a9386b26b9b7c82de0dff59a5ba63150dcda1fef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMzk5MTQy", "url": "https://github.com/elastic/elasticsearch/pull/50866#pullrequestreview-342399142", "createdAt": "2020-01-14T09:42:22Z", "commit": {"oid": "a9386b26b9b7c82de0dff59a5ba63150dcda1fef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjU2NDg5", "url": "https://github.com/elastic/elasticsearch/pull/50866#pullrequestreview-342656489", "createdAt": "2020-01-14T16:15:44Z", "commit": {"oid": "a9386b26b9b7c82de0dff59a5ba63150dcda1fef"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoxNTo0NVrOFddRDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoxNTo0NVrOFddRDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQzMjUyNg==", "bodyText": "Shouldn't the results be a Set instead of List?", "url": "https://github.com/elastic/elasticsearch/pull/50866#discussion_r366432526", "createdAt": "2020-01-14T16:15:45Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/tree/NodeSubclassTests.java", "diffHunk": "@@ -618,45 +622,77 @@ protected boolean hasAtLeastTwoChildren(Class<? extends Node<?>> toBuildClass) {\n         for (String path: paths) {\n             Path root = PathUtils.get(path);\n             int rootLength = root.toString().length() + 1;\n-            Files.walkFileTree(root, new SimpleFileVisitor<Path>() {\n-\n-                @Override\n-                public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {\n-                    if (Files.isRegularFile(file) && file.getFileName().toString().endsWith(\".class\")) {\n-                        String className = file.toString();\n-                        // Chop off the root and file extension\n-                        className = className.substring(rootLength, className.length() - \".class\".length());\n-                        // Go from \"path\" style to class style\n-                        className = className.replace(PathUtils.getDefaultFileSystem().getSeparator(), \".\");\n-\n-                        // filter the class that are not interested\n-                        // (and IDE folders like eclipse)\n-                        if (!className.startsWith(\"org.elasticsearch.xpack.ql\") && !className.startsWith(\"org.elasticsearch.xpack.sql\")) {\n-                            return FileVisitResult.CONTINUE;\n-                        }\n-\n-                        Class<?> c;\n-                        try {\n-                            c = Class.forName(className);\n-                        } catch (ClassNotFoundException e) {\n-                            throw new IOException(\"Couldn't find \" + file, e);\n-                        }\n \n-                        if (false == Modifier.isAbstract(c.getModifiers())\n-                                && false == c.isAnonymousClass()\n-                                && clazz.isAssignableFrom(c)) {\n-                            Class<? extends T> s = c.asSubclass(clazz);\n-                            results.add(s);\n+            // load classes from jar files\n+            // NIO FileSystem API is not used since it trips the SecurityManager\n+            // https://bugs.openjdk.java.net/browse/JDK-8160798\n+            // so iterate the jar \"by hand\"\n+            if (path.endsWith(\".jar\") && path.contains(\"x-pack-ql\")) {\n+                try (JarInputStream jar = jarStream(root)) {\n+                    JarEntry je = null;\n+                    while ((je = jar.getNextJarEntry()) != null) {\n+                        String name = je.getName();\n+                        if (name.endsWith(\".class\")) {\n+                            String className = name.substring(0, name.length() - \".class\".length()).replace(\"/\", \".\");\n+                            maybeLoadClass(clazz, className, root + \"!/\" + name, results);\n                         }\n                     }\n-                    return FileVisitResult.CONTINUE;\n                 }\n-            });\n+            }\n+            // for folders, just use the FileSystems API\n+            else {\n+                Files.walkFileTree(root, new SimpleFileVisitor<Path>() {\n+                    @Override\n+                    public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {\n+                        if (Files.isRegularFile(file) && file.getFileName().toString().endsWith(\".class\")) {\n+                            String fileName = file.toString();\n+                            // Chop off the root and file extension\n+                            String className = fileName.substring(rootLength, fileName.length() - \".class\".length());\n+                            // Go from \"path\" style to class style\n+                            className = className.replace(PathUtils.getDefaultFileSystem().getSeparator(), \".\");\n+                            maybeLoadClass(clazz, className, fileName, results);\n+                        }\n+                        return FileVisitResult.CONTINUE;\n+                    }\n+                });\n+            }\n         }\n         subclassCache.put(clazz, results);\n         return results;\n     }\n \n+    @SuppressForbidden(reason = \"test reads from jar\")\n+    private static JarInputStream jarStream(Path path) throws IOException {\n+        return new JarInputStream(path.toUri().toURL().openStream());\n+    }\n+\n+    /**\n+     * Load classes from predefined packages (hack to limit the scope) and if they match the hierarchy, add them to the cache\n+     */\n+    private static <T> void maybeLoadClass(Class<T> clazz, String className, String location, List<Class<? extends T>> results)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9386b26b9b7c82de0dff59a5ba63150dcda1fef"}, "originalPosition": 106}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ef7c2b5283505589112f5e59955eb29260f4e7b", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ef7c2b5283505589112f5e59955eb29260f4e7b", "committedDate": "2020-01-14T20:09:35Z", "message": "Keep the results in a Set (instead of List)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3be7fbd558a204229cc4ba29b2638866933b949d", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/3be7fbd558a204229cc4ba29b2638866933b949d", "committedDate": "2020-01-14T19:24:55Z", "message": "Keep the results in a Set (instead of List)"}, "afterCommit": {"oid": "9ef7c2b5283505589112f5e59955eb29260f4e7b", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ef7c2b5283505589112f5e59955eb29260f4e7b", "committedDate": "2020-01-14T20:09:35Z", "message": "Keep the results in a Set (instead of List)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0c1462a2e01b88990921103527d6f9e6f589a74", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/e0c1462a2e01b88990921103527d6f9e6f589a74", "committedDate": "2020-01-14T20:21:23Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into ql/fix-test-jar-classpath"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3784, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}