{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMzg5NzAy", "number": 61348, "title": "Detect noop of update index settings", "bodyText": "This optimization is more relevant in the context of CCR. When a node in the follower leaves, we reallocate the shard-follow tasks on that node to other nodes. The new tasks will overwhelm the follower cluster with many put-mapping, update-settings requests, although most of them are noop. This change detects and optimizes for noop update-settings requests.", "createdAt": "2020-08-19T19:19:35Z", "url": "https://github.com/elastic/elasticsearch/pull/61348", "merged": true, "mergeCommit": {"oid": "30e0edbac68c117d0fca92d18cd2fda6d78241e1"}, "closed": true, "closedAt": "2020-08-20T19:56:16Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAgerDAH2gAyNDcwMzg5NzAyOjA3Mjk2MTZmNjExMmI3YjNlNzAwZmFkZjIyNzcxZWUxMmJkN2YwYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAzHXFAH2gAyNDcwMzg5NzAyOmY0M2MyZWFkNDQ0NDgyZWViYmQ0MDI3NzNlODQ3ZWIxYTllMDg2YjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0729616f6112b7b3e700fadf22771ee12bd7f0b2", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/0729616f6112b7b3e700fadf22771ee12bd7f0b2", "committedDate": "2020-08-19T19:07:42Z", "message": "Detect noop of index setting update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNTY2MjEw", "url": "https://github.com/elastic/elasticsearch/pull/61348#pullrequestreview-471566210", "createdAt": "2020-08-20T12:55:40Z", "commit": {"oid": "0729616f6112b7b3e700fadf22771ee12bd7f0b2"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMjo1NTo0MFrOHD_d9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxMjo1NjozMlrOHD_f8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0NzYzNw==", "bodyText": "Is there a reason we do not want this to be the same? With the block already in place, this could be a no-op?", "url": "https://github.com/elastic/elasticsearch/pull/61348#discussion_r473947637", "createdAt": "2020-08-20T12:55:40Z", "author": {"login": "henningandersen"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/settings/UpdateSettingsIT.java", "diffHunk": "@@ -687,4 +690,40 @@ private void runTestDefaultNumberOfReplicasTest(final boolean closeIndex) {\n         assertThat(IndexMetadata.INDEX_NUMBER_OF_REPLICAS_SETTING.get(response.getIndexToSettings().get(\"test\")), equalTo(1));\n     }\n \n+    public void testNoopUpdate() {\n+        internalCluster().ensureAtLeastNumDataNodes(2);\n+        final ClusterService clusterService = internalCluster().getMasterNodeInstance(ClusterService.class);\n+        assertAcked(client().admin().indices().prepareCreate(\"test\")\n+            .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 2)));\n+        client().admin().cluster().prepareHealth()\n+            .setWaitForNoInitializingShards(true)\n+            .setWaitForEvents(Priority.LANGUID)\n+            .setTimeout(TimeValue.MAX_VALUE)\n+            .get();\n+\n+        ClusterState currentState = clusterService.state();\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)));\n+        assertNotSame(currentState, clusterService.state());\n+        currentState = clusterService.state();\n+\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)));\n+        assertSame(clusterService.state(), currentState);\n+\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder().putNull(IndexMetadata.SETTING_NUMBER_OF_REPLICAS)));\n+        assertSame(clusterService.state(), currentState);\n+\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder()\n+                .put(SETTING_BLOCKS_READ, true)\n+                .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 1)));\n+        assertNotSame(currentState, clusterService.state());\n+        currentState = clusterService.state();\n+\n+        assertAcked(client().admin().indices().prepareUpdateSettings(\"test\")\n+            .setSettings(Settings.builder().put(SETTING_BLOCKS_READ, true)));\n+        assertNotSame(currentState, clusterService.state());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0729616f6112b7b3e700fadf22771ee12bd7f0b2"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk0ODE0NQ==", "bodyText": "This sets changed=true regardless of whether block was in place or not. I think we should handle that too - mainly for completeness more than necessity.", "url": "https://github.com/elastic/elasticsearch/pull/61348#discussion_r473948145", "createdAt": "2020-08-20T12:56:32Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataUpdateSettingsService.java", "diffHunk": "@@ -304,8 +311,10 @@ private static void maybeUpdateClusterBlock(String[] actualIndices, ClusterBlock\n                 } else {\n                     blocks.removeIndexBlock(index, block);\n                 }\n+                changed = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0729616f6112b7b3e700fadf22771ee12bd7f0b2"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5d5f3b6e2f3aa4b76deeadd556b1df0b1e4b65e", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5d5f3b6e2f3aa4b76deeadd556b1df0b1e4b65e", "committedDate": "2020-08-20T15:30:36Z", "message": "Merge branch 'master' into noop-update-index"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f43c2ead444482eebbd402773e847eb1a9e086b6", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f43c2ead444482eebbd402773e847eb1a9e086b6", "committedDate": "2020-08-20T16:50:26Z", "message": "detect noop in blocks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4780, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}