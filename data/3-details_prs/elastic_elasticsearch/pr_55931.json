{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNjk0MDA4", "number": 55931, "title": "Make SAME Pool on DeterministicTaskQueue more Realistic", "bodyText": "By forking off the SAME pool tasks and executing them in random order,\nwe are actually creating unrealistic scenarios and missing the actual order\nof operations (whatever task that puts the task on the SAME queue will always\nrun before the SAME queued task will be executed currently).\nAlso, added caching for the executors. It doesn't matter much, but saves some objects\nand makes debugging a little easier because executor object ids make more sense.", "createdAt": "2020-04-29T12:53:09Z", "url": "https://github.com/elastic/elasticsearch/pull/55931", "merged": true, "mergeCommit": {"oid": "2f251c3f1dae2d4e14cefe82503c1c9f4c596a84"}, "closed": true, "closedAt": "2020-04-30T07:51:13Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccX6vGAH2gAyNDEwNjk0MDA4Ojc4YTczZjYyZjI3NWYzM2IzOTZjMDZlM2M0NTA1MmExZWU5ZDM3ZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcccwpFAH2gAyNDEwNjk0MDA4OmExZWVjMDE1Yjk1ZDA2NGM5ZTg4NTYzMWMxNDhhNzE0OWMzZTljMmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "78a73f62f275f33b396c06e3c45052a1ee9d37de", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/78a73f62f275f33b396c06e3c45052a1ee9d37de", "committedDate": "2020-04-29T12:47:56Z", "message": "Make SAME Pool on DeterministicTaskQueue more Realistic\n\nBy forking off the `SAME` pool tasks and executing them in random order,\nwe are actually creating unrealisticc scenarios and missing the actual order\nof operations (whatever task that puts the task on the `SAME` queue will always\nrun before the `SAME` queued task will be executed currently).\nAlso, added caching for the executors. It doesn't matter much, but saves some objects\nand makes debugging a little easier because executor object ids make more sense."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNjU5MzAy", "url": "https://github.com/elastic/elasticsearch/pull/55931#pullrequestreview-402659302", "createdAt": "2020-04-29T13:22:41Z", "commit": {"oid": "78a73f62f275f33b396c06e3c45052a1ee9d37de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMzoyMjo0MVrOGN-iNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMzoyMjo0MVrOGN-iNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMwOTIzOA==", "bodyText": "Could we instead return EsExecutors.newDirectExecutorService(); if Names.SAME.equals(name)?\nShould we also return the same (non-direct) executor service each time too rather than constructing a new one each time?", "url": "https://github.com/elastic/elasticsearch/pull/55931#discussion_r417309238", "createdAt": "2020-04-29T13:22:41Z", "author": {"login": "DaveCTurner"}, "path": "test/framework/src/main/java/org/elasticsearch/cluster/coordination/DeterministicTaskQueue.java", "diffHunk": "@@ -323,12 +326,13 @@ public ThreadPoolStats stats() {\n \n             @Override\n             public ExecutorService generic() {\n-                return getExecutorService(runnableWrapper);\n+                return executor(Names.GENERIC);\n             }\n \n             @Override\n             public ExecutorService executor(String name) {\n-                return getExecutorService(runnableWrapper);\n+                return executors.computeIfAbsent(name, key -> getExecutorService(runnableWrapper,\n+                        Names.SAME.equals(key) ? Runnable::run : DeterministicTaskQueue.this::scheduleNow));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78a73f62f275f33b396c06e3c45052a1ee9d37de"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d5c57e13e434c927cf15c09b542e81d5b12b43c", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d5c57e13e434c927cf15c09b542e81d5b12b43c", "committedDate": "2020-04-29T13:31:19Z", "message": "CR: simpler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNjY5Nzgz", "url": "https://github.com/elastic/elasticsearch/pull/55931#pullrequestreview-402669783", "createdAt": "2020-04-29T13:33:44Z", "commit": {"oid": "2d5c57e13e434c927cf15c09b542e81d5b12b43c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMzozMzo0NFrOGN_B8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxMzozMzo0NFrOGN_B8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzMxNzM2Mg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/55931#discussion_r417317362", "createdAt": "2020-04-29T13:33:44Z", "author": {"login": "DaveCTurner"}, "path": "test/framework/src/main/java/org/elasticsearch/cluster/coordination/DeterministicTaskQueue.java", "diffHunk": "@@ -323,12 +325,12 @@ public ThreadPoolStats stats() {\n \n             @Override\n             public ExecutorService generic() {\n-                return getExecutorService(runnableWrapper);\n+                return executor(Names.GENERIC);\n             }\n \n             @Override\n             public ExecutorService executor(String name) {\n-                return getExecutorService(runnableWrapper);\n+                return Names.SAME.equals(name) ? EsExecutors.newDirectExecutorService() : forkingExecutor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d5c57e13e434c927cf15c09b542e81d5b12b43c"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37b2d895c1cadd31a2a3f4a0ed67b68987c43c68", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/37b2d895c1cadd31a2a3f4a0ed67b68987c43c68", "committedDate": "2020-04-29T13:34:54Z", "message": "Merge remote-tracking branch 'elastic/master' into same-on-deterministic-queue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7e25e0065ccc2bc58847c71e5885ec063ec05e5", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a7e25e0065ccc2bc58847c71e5885ec063ec05e5", "committedDate": "2020-04-29T13:40:04Z", "message": "CR: test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNjgyODM5", "url": "https://github.com/elastic/elasticsearch/pull/55931#pullrequestreview-402682839", "createdAt": "2020-04-29T13:47:34Z", "commit": {"oid": "a7e25e0065ccc2bc58847c71e5885ec063ec05e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1eec015b95d064c9e885631c148a7149c3e9c2b", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a1eec015b95d064c9e885631c148a7149c3e9c2b", "committedDate": "2020-04-29T18:26:26Z", "message": "Merge remote-tracking branch 'elastic/master' into same-on-deterministic-queue"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 279, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}