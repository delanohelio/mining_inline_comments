{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNDYwMTY5", "number": 65139, "title": "add the ability to retrieve the fieldnames an aggregation creates from the builder", "bodyText": "add a (optional) getOutputFieldNames method to aggregationbuilder to\nretrieve the names of the fields the aggregation produces\nreplaces #64637\nThe method is now optional and has a default implementation that returns Optional.empty():\npublic Optional<Set<String>> getOutputFieldNames()\n\nThe reason for Optional: We identified that we a) do not know the output field names for every case (e.g. scripted_metric and top_hits)\ncopied over from #65139\nSummary of slack discussion:\n\nWe think this is a useful feature that will help with validating pipeline bucket paths as well as transforms\nTypes are a much harder problem than field names, and are somewhat less useful for the pipeline case.  For a v1, let's just do field names\nProposed prototype:\n\n/** Return the field names this aggregation creates*/\n    public Optional<Set<String>> getOutputFieldNames() {\n        return Optional.empty();\n    }\n\n\nWe like the idea of defaulting to returning Optional.empty() for a first pass.", "createdAt": "2020-11-17T14:39:27Z", "url": "https://github.com/elastic/elasticsearch/pull/65139", "merged": true, "mergeCommit": {"oid": "c8dcbe7687b56d8da234db313f583e76d9683614"}, "closed": true, "closedAt": "2021-01-14T08:12:25Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddaogigFqTUzMjQzMTkwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdv0hr6AH2gAyNTIyNDYwMTY5OjNlMDc2MmM5OTFiODVlODc3MWIxM2NkNWFjN2YzNGI1ZDY3ZWI2MTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNDMxOTAz", "url": "https://github.com/elastic/elasticsearch/pull/65139#pullrequestreview-532431903", "createdAt": "2020-11-17T14:42:48Z", "commit": {"oid": "0c2837eafcdc42f70c02c7aff3e1d82691bdb544"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNDo0Mjo0OVrOH04Gsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNDo0Mjo0OVrOH04Gsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIwNzIxOQ==", "bodyText": "this is not related to this PR, but fixes an issue I found. I can move this into a separate PR if you prefer.", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r525207219", "createdAt": "2020-11-17T14:42:49Z", "author": {"login": "hendrikmuhs"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/InternalExtendedStats.java", "diffHunk": "@@ -115,6 +120,11 @@ public double value(String name) {\n         return super.value(name);\n     }\n \n+    @Override\n+    public Iterable<String> valueNames() {\n+        return metricNames;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c2837eafcdc42f70c02c7aff3e1d82691bdb544"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNDY0MTQy", "url": "https://github.com/elastic/elasticsearch/pull/65139#pullrequestreview-532464142", "createdAt": "2020-11-17T15:11:30Z", "commit": {"oid": "0c2837eafcdc42f70c02c7aff3e1d82691bdb544"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNToxMTozMVrOH05l2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNToxMzo0NlrOH05stA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzMTU3Nw==", "bodyText": "Is it just the ..._as_string fields we ignore?  or are there other \"convenience\" fields?  I'm also worried this will make it hard to test.  I would think we should be able to just run the aggregation and compare the actual output to this field list.", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r525231577", "createdAt": "2020-11-17T15:11:31Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregationBuilder.java", "diffHunk": "@@ -65,6 +67,18 @@ public String getName() {\n         return name;\n     }\n \n+    /**\n+     * Return the field names this aggregation creates.\n+     *\n+     * This method is a optional helper for clients that need to know the output field names.\n+     *\n+     * @return The set of output field names this aggregation produces without sub-aggregation and\n+     * convenience outputs (\"..._as_string\") or Optional.empty() if unknown or not implemented.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c2837eafcdc42f70c02c7aff3e1d82691bdb544"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzMzMzMg==", "bodyText": "This should probably not be mutable, and definitely not public mutable.  Same for other aggs.", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r525233332", "createdAt": "2020-11-17T15:13:46Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/InternalExtendedStats.java", "diffHunk": "@@ -41,6 +44,8 @@ public static Metrics resolve(String name) {\n         }\n     }\n \n+    public static Set<String> metricNames = Stream.of(Metrics.values()).map(Metrics::name).collect(Collectors.toSet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c2837eafcdc42f70c02c7aff3e1d82691bdb544"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcd3afa2bf475449092e736ca7f5ca64d165b70a", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/dcd3afa2bf475449092e736ca7f5ca64d165b70a", "committedDate": "2020-12-22T14:24:37Z", "message": "add a (optional) getOutputFieldNames method to aggregationbuilder to\nretrieve the names of the fields the aggregation produces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39849670620323b6f1ec1856716e378e68c24856", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/39849670620323b6f1ec1856716e378e68c24856", "committedDate": "2020-12-22T14:24:37Z", "message": "make metric names final where possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e357cf075f43a4988c22119870b4b56ab8dcb881", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/e357cf075f43a4988c22119870b4b56ab8dcb881", "committedDate": "2020-12-22T14:24:37Z", "message": "implement test to verify output field names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c2837eafcdc42f70c02c7aff3e1d82691bdb544", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c2837eafcdc42f70c02c7aff3e1d82691bdb544", "committedDate": "2020-11-17T13:56:35Z", "message": "add a (optional) getOutputFieldNames method to aggregationbuilder to\nretrieve the names of the fields the aggregation produces"}, "afterCommit": {"oid": "e357cf075f43a4988c22119870b4b56ab8dcb881", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/e357cf075f43a4988c22119870b4b56ab8dcb881", "committedDate": "2020-12-22T14:24:37Z", "message": "implement test to verify output field names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2NjEyMDQx", "url": "https://github.com/elastic/elasticsearch/pull/65139#pullrequestreview-566612041", "createdAt": "2021-01-12T19:20:28Z", "commit": {"oid": "e357cf075f43a4988c22119870b4b56ab8dcb881"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQxOToyMDoyOFrOISQhRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQxOTozMzozN1rOISRLIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAxNTk0MA==", "bodyText": "@nik9000 did you want to distinguish between \"not implemented\" and \"we can't know the output fields\", using null for one of them?", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556015940", "createdAt": "2021-01-12T19:20:28Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregationBuilder.java", "diffHunk": "@@ -65,6 +67,17 @@ public String getName() {\n         return name;\n     }\n \n+    /**\n+     * Return the field names this aggregation creates.\n+     *\n+     * This method is a optional helper for clients that need to know the output field names.\n+     *\n+     * @return The set of output field names this aggregation produces or Optional.empty() if unknown or not implemented.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e357cf075f43a4988c22119870b4b56ab8dcb881"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAyMTk0Mw==", "bodyText": "I'd feel better if we returned an immutable version or a copy here.  Or maybe just make METRIC_NAMES immutable to begin with.", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556021943", "createdAt": "2021-01-12T19:28:02Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/InternalExtendedStats.java", "diffHunk": "@@ -115,6 +120,11 @@ public double value(String name) {\n         return super.value(name);\n     }\n \n+    @Override\n+    public Iterable<String> valueNames() {\n+        return METRIC_NAMES;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e357cf075f43a4988c22119870b4b56ab8dcb881"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAyNjY1OA==", "bodyText": "Why do we need this instanceof check?", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556026658", "createdAt": "2021-01-12T19:33:37Z", "author": {"login": "not-napoleon"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -496,6 +501,24 @@ protected void withAggregator(\n         }\n     }\n \n+    protected <T extends AggregationBuilder, V extends InternalAggregation> void verifyOutputFieldNames(T aggregationBuilder, V agg)\n+        throws IOException {\n+        if (aggregationBuilder.getOutputFieldNames().isEmpty()) {\n+            // aggregation does not support output field names yet\n+            return;\n+        }\n+\n+        if (agg instanceof NumericMetricsAggregation.MultiValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e357cf075f43a4988c22119870b4b56ab8dcb881"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe4efcd4ba4cfc55501b6897f9cc43e32e0c4a1d", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe4efcd4ba4cfc55501b6897f9cc43e32e0c4a1d", "committedDate": "2021-01-13T13:57:30Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3096faeacde85e284e4861b0bf814277e93429b9", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/3096faeacde85e284e4861b0bf814277e93429b9", "committedDate": "2021-01-13T15:44:26Z", "message": "make more fieldname sets immutable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fad26d163ff6e56e880b96138470189371a4c9c", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/7fad26d163ff6e56e880b96138470189371a4c9c", "committedDate": "2021-01-13T16:06:15Z", "message": "Merge branch 'master' into aggs-output-fields-2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3NDE5NzQy", "url": "https://github.com/elastic/elasticsearch/pull/65139#pullrequestreview-567419742", "createdAt": "2021-01-13T16:46:45Z", "commit": {"oid": "7fad26d163ff6e56e880b96138470189371a4c9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3NDI4NTgz", "url": "https://github.com/elastic/elasticsearch/pull/65139#pullrequestreview-567428583", "createdAt": "2021-01-13T16:56:05Z", "commit": {"oid": "7fad26d163ff6e56e880b96138470189371a4c9c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNjo1NjowNVrOIS5DFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxNjo1NjowNVrOIS5DFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjY3OTk1OQ==", "bodyText": "Much better, thank you!", "url": "https://github.com/elastic/elasticsearch/pull/65139#discussion_r556679959", "createdAt": "2021-01-13T16:56:05Z", "author": {"login": "not-napoleon"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -560,15 +560,15 @@ protected void withAggregator(\n             return;\n         }\n \n-        if (agg instanceof NumericMetricsAggregation.MultiValue) {\n-            NumericMetricsAggregation.MultiValue multiValueAgg = (NumericMetricsAggregation.MultiValue) agg;\n-            Set<String> valueNames = new HashSet<>();\n-            for (String name : multiValueAgg.valueNames()) {\n-                valueNames.add(name);\n-            }\n+        assert agg instanceof NumericMetricsAggregation.MultiValue : \"only multi value aggs are supported\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fad26d163ff6e56e880b96138470189371a4c9c"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dabd4560affc0c8152e15befc6283b078aa2f75", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/1dabd4560affc0c8152e15befc6283b078aa2f75", "committedDate": "2021-01-13T18:45:39Z", "message": "Update server/src/main/java/org/elasticsearch/search/aggregations/AggregationBuilder.java\n\nCo-authored-by: Mark Tozzi <mark.tozzi@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e0762c991b85e8771b13cd5ac7f34b5d67eb612", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/3e0762c991b85e8771b13cd5ac7f34b5d67eb612", "committedDate": "2021-01-13T19:03:32Z", "message": "checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 962, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}