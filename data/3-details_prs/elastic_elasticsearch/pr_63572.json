{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNzI2MjU4", "number": 63572, "title": "Use ValueFetcher when loading text snippets to highlight", "bodyText": "HighlighterUtils.loadFieldValues() loads values directly from the source, and\nthen callers have to deal with filtering out values that would have been removed\nby an ignore_above filter on keyword fields.  Instead, we can use the\nValueFetcher for the relevant field, which handles all this logic for us.\nCloses #59931.", "createdAt": "2020-10-12T18:00:56Z", "url": "https://github.com/elastic/elasticsearch/pull/63572", "merged": true, "mergeCommit": {"oid": "d088171a872d90e16b65a31754c39f13f908097e"}, "closed": true, "closedAt": "2020-11-24T16:09:38Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR30SHAH2gAyNTAxNzI2MjU4OjQ4YmY0YjY4M2Y3ODZlNjhjODU3NmIyYWJhYTJjZGZhZDA4ZGZlNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfr-5FAFqTUzNzY2ODQ4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "48bf4b683f786e68c8576b2abaa2cdfad08dfe68", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/48bf4b683f786e68c8576b2abaa2cdfad08dfe68", "committedDate": "2020-10-12T17:55:50Z", "message": "Use ValueFetcher when loading text snippets to highlight"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODMxNzkx", "url": "https://github.com/elastic/elasticsearch/pull/63572#pullrequestreview-506831791", "createdAt": "2020-10-12T18:24:31Z", "commit": {"oid": "48bf4b683f786e68c8576b2abaa2cdfad08dfe68"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODoyNDozMVrOHgI_hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxODoyNjowNVrOHgJCBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2MzgxMg==", "bodyText": "null looks is going to cause this to fail on runtime fields. Do we filter those out other places?", "url": "https://github.com/elastic/elasticsearch/pull/63572#discussion_r503463812", "createdAt": "2020-10-12T18:24:31Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/HighlightUtils.java", "diffHunk": "@@ -46,24 +43,10 @@ private HighlightUtils() {\n      * Load field values for highlighting.\n      */\n     public static List<Object> loadFieldValues(MappedFieldType fieldType,\n-                                               FetchSubPhase.HitContext hitContext,\n-                                               boolean forceSource) throws IOException {\n-        //percolator needs to always load from source, thus it sets the global force source to true\n-        List<Object> textsToHighlight;\n-        if (forceSource == false && fieldType.isStored()) {\n-            CustomFieldsVisitor fieldVisitor = new CustomFieldsVisitor(singleton(fieldType.name()), false);\n-            hitContext.reader().document(hitContext.docId(), fieldVisitor);\n-            textsToHighlight = fieldVisitor.fields().get(fieldType.name());\n-            if (textsToHighlight == null) {\n-                // Can happen if the document doesn't have the field to highlight\n-                textsToHighlight = Collections.emptyList();\n-            }\n-        } else {\n-            SourceLookup sourceLookup = hitContext.sourceLookup();\n-            textsToHighlight = sourceLookup.extractRawValues(fieldType.name());\n-        }\n-        assert textsToHighlight != null;\n-        return textsToHighlight;\n+                                               MapperService mapperService,\n+                                               FetchSubPhase.HitContext hitContext) throws IOException {\n+        ValueFetcher fetcher = fieldType.valueFetcher(mapperService, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48bf4b683f786e68c8576b2abaa2cdfad08dfe68"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ2NDQ1Mg==", "bodyText": "Dropping this is a behavior change - this behavior of defaulting to stored fields was something folks were really keen on historically.", "url": "https://github.com/elastic/elasticsearch/pull/63572#discussion_r503464452", "createdAt": "2020-10-12T18:26:05Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/HighlightUtils.java", "diffHunk": "@@ -46,24 +43,10 @@ private HighlightUtils() {\n      * Load field values for highlighting.\n      */\n     public static List<Object> loadFieldValues(MappedFieldType fieldType,\n-                                               FetchSubPhase.HitContext hitContext,\n-                                               boolean forceSource) throws IOException {\n-        //percolator needs to always load from source, thus it sets the global force source to true\n-        List<Object> textsToHighlight;\n-        if (forceSource == false && fieldType.isStored()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48bf4b683f786e68c8576b2abaa2cdfad08dfe68"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODQzNDc5", "url": "https://github.com/elastic/elasticsearch/pull/63572#pullrequestreview-506843479", "createdAt": "2020-10-12T18:47:27Z", "commit": {"oid": "48bf4b683f786e68c8576b2abaa2cdfad08dfe68"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36469e3966afc9ee9282bd8b974601de03a3bdb3", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/36469e3966afc9ee9282bd8b974601de03a3bdb3", "committedDate": "2020-10-13T07:58:14Z", "message": "Add back stored-fields branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "972a635210ce44c8c50bf9fcd0e296e8622063a7", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/972a635210ce44c8c50bf9fcd0e296e8622063a7", "committedDate": "2020-10-13T07:58:29Z", "message": "Merge remote-tracking branch 'origin/master' into highlight/fetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b72b8bddcbe09cc6c73a19cba497485090a4e97", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b72b8bddcbe09cc6c73a19cba497485090a4e97", "committedDate": "2020-11-19T14:19:19Z", "message": "Merge remote-tracking branch 'origin/master' into highlight/fetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3baf24b5eba540425f2fc0e550339f72b08d49e", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a3baf24b5eba540425f2fc0e550339f72b08d49e", "committedDate": "2020-11-19T14:27:41Z", "message": "Check for nulls in tokencount"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c28877ca19adbb799d58139d345b4874df27e4b", "committedDate": "2020-11-19T14:50:40Z", "message": "test for copy_to highlighting; check *all* source paths"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NTQwMTg3", "url": "https://github.com/elastic/elasticsearch/pull/63572#pullrequestreview-534540187", "createdAt": "2020-11-19T15:06:19Z", "commit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNTowNjoxOVrOH2jBYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNTowNjoxOVrOH2jBYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1ODk0NA==", "bodyText": "This was a bug - if the first of multiple source paths didn't have any values, we returned early instead of continuing to check further paths.", "url": "https://github.com/elastic/elasticsearch/pull/63572#discussion_r526958944", "createdAt": "2020-11-19T15:06:19Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/SourceValueFetcher.java", "diffHunk": "@@ -60,7 +60,7 @@ public SourceValueFetcher(String fieldName, QueryShardContext context, Object nu\n         for (String path : sourcePaths) {\n             Object sourceValue = lookup.extractValue(path, nullValue);\n             if (sourceValue == null) {\n-                return List.of();\n+                continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NTQzMDE4", "url": "https://github.com/elastic/elasticsearch/pull/63572#pullrequestreview-534543018", "createdAt": "2020-11-19T15:09:00Z", "commit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNTowOTowMVrOH2jJpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNTowOTowMVrOH2jJpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk2MTA2Mw==", "bodyText": "Another option here would be to pass the Fetch-phase search lookup through all the highlighting code to HighlightUtils.loadValues(), and I think we probably will want to do that eventually, but it's not really ready yet given our uncertainty around how that lookup is built and passed around anyway.", "url": "https://github.com/elastic/elasticsearch/pull/63572#discussion_r526961063", "createdAt": "2020-11-19T15:09:01Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptFieldType.java", "diffHunk": "@@ -198,6 +199,9 @@ protected final void checkAllowExpensiveQueries(QueryShardContext context) {\n \n     @Override\n     public ValueFetcher valueFetcher(QueryShardContext context, SearchLookup lookup, String format) {\n+        if (lookup == null) {\n+            return v -> Collections.emptyList();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0ODM5Njg4", "url": "https://github.com/elastic/elasticsearch/pull/63572#pullrequestreview-534839688", "createdAt": "2020-11-19T20:50:10Z", "commit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDo1MDoxMVrOH2xFhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDo1OToxMlrOH2xY2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE4OTM4Mw==", "bodyText": "Thank you for catching this! Maybe we could fix this in a separate PR (with a quick test) to keep this one scoped to highlighting?", "url": "https://github.com/elastic/elasticsearch/pull/63572#discussion_r527189383", "createdAt": "2020-11-19T20:50:11Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/SourceValueFetcher.java", "diffHunk": "@@ -60,7 +60,7 @@ public SourceValueFetcher(String fieldName, QueryShardContext context, Object nu\n         for (String path : sourcePaths) {\n             Object sourceValue = lookup.extractValue(path, nullValue);\n             if (sourceValue == null) {\n-                return List.of();\n+                continue;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk1ODk0NA=="}, "originalCommit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE5NDMyOA==", "bodyText": "To me it'd be best to keep the original forceSource name and value -- it matches the  force_source REST option that this value comes and avoids having mixed concepts in the code.", "url": "https://github.com/elastic/elasticsearch/pull/63572#discussion_r527194328", "createdAt": "2020-11-19T20:59:12Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/HighlightUtils.java", "diffHunk": "@@ -46,24 +48,17 @@ private HighlightUtils() {\n      * Load field values for highlighting.\n      */\n     public static List<Object> loadFieldValues(MappedFieldType fieldType,\n+                                               QueryShardContext qsc,\n                                                FetchSubPhase.HitContext hitContext,\n-                                               boolean forceSource) throws IOException {\n-        //percolator needs to always load from source, thus it sets the global force source to true\n-        List<Object> textsToHighlight;\n-        if (forceSource == false && fieldType.isStored()) {\n+                                               boolean storedFieldsAvailable) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MDM5OTI1", "url": "https://github.com/elastic/elasticsearch/pull/63572#pullrequestreview-535039925", "createdAt": "2020-11-20T03:04:33Z", "commit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMzowNDozM1rOH27v1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMzowNDozM1rOH27v1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM2NDA1NA==", "bodyText": "I just opened #65292 -- if we like the direction and it gets merged, then MappedFieldType#valueFetcher won't need a dedicated SearchLookup at all. I think highlighting on runtime fields would 'just work' here (although it'd be worth a test!)", "url": "https://github.com/elastic/elasticsearch/pull/63572#discussion_r527364054", "createdAt": "2020-11-20T03:04:33Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/HighlightUtils.java", "diffHunk": "@@ -46,24 +48,17 @@ private HighlightUtils() {\n      * Load field values for highlighting.\n      */\n     public static List<Object> loadFieldValues(MappedFieldType fieldType,\n+                                               QueryShardContext qsc,\n                                                FetchSubPhase.HitContext hitContext,\n-                                               boolean forceSource) throws IOException {\n-        //percolator needs to always load from source, thus it sets the global force source to true\n-        List<Object> textsToHighlight;\n-        if (forceSource == false && fieldType.isStored()) {\n+                                               boolean storedFieldsAvailable) throws IOException {\n+        if (storedFieldsAvailable && fieldType.isStored()) {\n             CustomFieldsVisitor fieldVisitor = new CustomFieldsVisitor(singleton(fieldType.name()), false);\n             hitContext.reader().document(hitContext.docId(), fieldVisitor);\n-            textsToHighlight = fieldVisitor.fields().get(fieldType.name());\n-            if (textsToHighlight == null) {\n-                // Can happen if the document doesn't have the field to highlight\n-                textsToHighlight = Collections.emptyList();\n-            }\n-        } else {\n-            SourceLookup sourceLookup = hitContext.sourceLookup();\n-            textsToHighlight = sourceLookup.extractRawValues(fieldType.name());\n+            List<Object> textsToHighlight = fieldVisitor.fields().get(fieldType.name());\n+            return Objects.requireNonNullElse(textsToHighlight, Collections.emptyList());\n         }\n-        assert textsToHighlight != null;\n-        return textsToHighlight;\n+        ValueFetcher fetcher = fieldType.valueFetcher(qsc, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ea506de64a10a5bd3c56c126d4204f166a5d086", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ea506de64a10a5bd3c56c126d4204f166a5d086", "committedDate": "2020-11-23T15:16:01Z", "message": "Merge remote-tracking branch 'origin/master' into highlight/fetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b3ecee4c4b47cb4529cbae29df4b89dd9473cff", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b3ecee4c4b47cb4529cbae29df4b89dd9473cff", "committedDate": "2020-11-23T15:20:08Z", "message": "Call it forceSource again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70e68809a342eb7531852c24c7935d28359965d6", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/70e68809a342eb7531852c24c7935d28359965d6", "committedDate": "2020-11-23T15:41:06Z", "message": "change test expectation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NzQwMTc0", "url": "https://github.com/elastic/elasticsearch/pull/63572#pullrequestreview-536740174", "createdAt": "2020-11-23T18:28:21Z", "commit": {"oid": "70e68809a342eb7531852c24c7935d28359965d6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc7585591e0957937d29929f123b36983d002d10", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc7585591e0957937d29929f123b36983d002d10", "committedDate": "2020-11-24T13:48:52Z", "message": "Merge remote-tracking branch 'origin/master' into highlight/fetcher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjY4NDg2", "url": "https://github.com/elastic/elasticsearch/pull/63572#pullrequestreview-537668486", "createdAt": "2020-11-24T16:03:30Z", "commit": {"oid": "dc7585591e0957937d29929f123b36983d002d10"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4064, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}