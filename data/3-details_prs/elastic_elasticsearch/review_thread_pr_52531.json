{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3MzMwNDMx", "number": 52531, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDowMzo1NFrODhiTXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo0MjowMlrODjJxGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDkxNjEyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/ensemble/LogisticRegression.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDowMzo1NFrOFsUfaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNTozMTozM1rOFsYBYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAxNzM4NQ==", "bodyText": "This isn't quite right: we turn the set of values into a collection of predicted probabilities via the softmax function, i.e. the i'th predicted probability is exp(values[i]) / sum_j{ exp(values[j]) }. I think it is also worthwhile dividing through by k = exp(max_j{ values[j] }) to handle the case the exp overflows: whence exp(values[i] - k) / sum_j{ (exp(values[j] - k)) }.", "url": "https://github.com/elastic/elasticsearch/pull/52531#discussion_r382017385", "createdAt": "2020-02-20T14:03:54Z", "author": {"login": "tveasey"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/ensemble/LogisticRegression.java", "diffHunk": "@@ -78,31 +78,29 @@ public Integer expectedValueSize() {\n     }\n \n     @Override\n-    public List<Double> processValues(List<Double> values) {\n+    public double[] processValues(double[][] values) {\n         Objects.requireNonNull(values, \"values must not be null\");\n-        if (weights != null && values.size() != weights.length) {\n+        assert values[0].length == 1;\n+        if (weights != null && values.length != weights.length) {\n             throw new IllegalArgumentException(\"values must be the same length as weights.\");\n         }\n         double summation = weights == null ?\n-            values.stream().mapToDouble(Double::valueOf).sum() :\n-            IntStream.range(0, weights.length).mapToDouble(i -> values.get(i) * weights[i]).sum();\n+            Arrays.stream(values).mapToDouble(vs -> vs[0]).sum() :\n+            IntStream.range(0, weights.length).mapToDouble(i -> values[i][0] * weights[i]).sum();\n         double probOfClassOne = sigmoid(summation);\n         assert 0.0 <= probOfClassOne && probOfClassOne <= 1.0;\n-        return Arrays.asList(1.0 - probOfClassOne, probOfClassOne);\n+        return new double[] {1.0 - probOfClassOne, probOfClassOne};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34fa2a0957d6c36313586a3038bf46ecb968d337"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA3NTIzMw==", "bodyText": "@tveasey I will adjust to allow logistic_regression to be binomial and multinomial.\nYour concerns about overflow are handled in the already existing Statistics#softMax function.\nThanks for the feedback!", "url": "https://github.com/elastic/elasticsearch/pull/52531#discussion_r382075233", "createdAt": "2020-02-20T15:31:33Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/ensemble/LogisticRegression.java", "diffHunk": "@@ -78,31 +78,29 @@ public Integer expectedValueSize() {\n     }\n \n     @Override\n-    public List<Double> processValues(List<Double> values) {\n+    public double[] processValues(double[][] values) {\n         Objects.requireNonNull(values, \"values must not be null\");\n-        if (weights != null && values.size() != weights.length) {\n+        assert values[0].length == 1;\n+        if (weights != null && values.length != weights.length) {\n             throw new IllegalArgumentException(\"values must be the same length as weights.\");\n         }\n         double summation = weights == null ?\n-            values.stream().mapToDouble(Double::valueOf).sum() :\n-            IntStream.range(0, weights.length).mapToDouble(i -> values.get(i) * weights[i]).sum();\n+            Arrays.stream(values).mapToDouble(vs -> vs[0]).sum() :\n+            IntStream.range(0, weights.length).mapToDouble(i -> values[i][0] * weights[i]).sum();\n         double probOfClassOne = sigmoid(summation);\n         assert 0.0 <= probOfClassOne && probOfClassOne <= 1.0;\n-        return Arrays.asList(1.0 - probOfClassOne, probOfClassOne);\n+        return new double[] {1.0 - probOfClassOne, probOfClassOne};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAxNzM4NQ=="}, "originalCommit": {"oid": "34fa2a0957d6c36313586a3038bf46ecb968d337"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTg2Nzc2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/tree/TreeNode.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo0MjowMlrOFuzS-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOToyODozMVrOFu5CLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYxOTI1Nw==", "bodyText": "I am not sure about this.  To what extent does it cause a problem for the receiving node?  Could it cause problems for the reading of a subsequent wire transfer?  I don't know the serialisation code well enough to say whether this is OK or not.\nAlso, would it make sense to an end user who saw it?  I guess they'd see a remote transport exception from a 7.6 coordinating node wrapping this exception.  But which endpoint would they have called?  Would leaf_value make sense to somebody who had called that endpoint?\nFinally, maybe we can defend against this at an earlier stage by banning creation of multi-class classification jobs until all nodes in the cluster are on version 7.7.", "url": "https://github.com/elastic/elasticsearch/pull/52531#discussion_r384619257", "createdAt": "2020-02-26T16:42:02Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/tree/TreeNode.java", "diffHunk": "@@ -190,7 +196,18 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeInt(splitFeature);\n         out.writeDouble(splitGain);\n         out.writeVInt(nodeIndex);\n-        out.writeDouble(leafValue);\n+        if (out.getVersion().onOrAfter(Version.V_7_7_0)) {\n+            out.writeDoubleArray(leafValue);\n+        } else {\n+            if (leafValue.length > 1) {\n+                throw new IOException(\"[leaf_value] only supports multiple values after version 7.7.0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f3611eb3a332befb77f3d63ca53d1d721cd780f"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcxMzI2MQ==", "bodyText": "To what extent does it cause a problem for the receiving node?\n\nReceiver node gets an exception. The serialization fails.\nThis type of thing is done in aggregations as well https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/CompositeValuesSourceParserHelper.java#L72\nI think throwing here is OK.\nAs for the message, I will fix it. I think something like Multi-class classification model attempted to serialize to node before version X. Multi-class classification is only supported if the node is greater than version X\n\nmaybe we can defend against this at an earlier stage by banning creation of multi-class classification jobs until all nodes in the cluster are on version 7.7.\n\nI agree, right now it is not possible to create a multi-class model via the analytics process. Once it is, we should defend against it there.\nAdditionally, on PUT I can verify the minimum node version", "url": "https://github.com/elastic/elasticsearch/pull/52531#discussion_r384713261", "createdAt": "2020-02-26T19:28:31Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/tree/TreeNode.java", "diffHunk": "@@ -190,7 +196,18 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeInt(splitFeature);\n         out.writeDouble(splitGain);\n         out.writeVInt(nodeIndex);\n-        out.writeDouble(leafValue);\n+        if (out.getVersion().onOrAfter(Version.V_7_7_0)) {\n+            out.writeDoubleArray(leafValue);\n+        } else {\n+            if (leafValue.length > 1) {\n+                throw new IOException(\"[leaf_value] only supports multiple values after version 7.7.0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYxOTI1Nw=="}, "originalCommit": {"oid": "9f3611eb3a332befb77f3d63ca53d1d721cd780f"}, "originalPosition": 76}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3818, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}