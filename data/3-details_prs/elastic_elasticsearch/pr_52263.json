{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MzUyNzQ0", "number": 52263, "title": "Add S3 integration tests for searchable snapshots", "bodyText": "This pull request adds REST-based integration tests that test the searchable snapshots feature on S3.\nMore precisely, this pull request:\n\nadds a new AbstractSearchableSnapshotsRestTestCase class that provides a generic test case for searchable snapshots\nadds a new FsSearchableSnapshotsIT that tests the previous test case using a filesystem repository. This test is added in the already existing qa:rest project\nadds a new S3SearchableSnapshotsIT that tests the previous test case using a S3 repository. This test is added in a new qa:s3 project that takes care of setting up an S3 fixture for the test. This test can also be run against an external service if the appropriate environment variables are provided", "createdAt": "2020-02-12T14:54:08Z", "url": "https://github.com/elastic/elasticsearch/pull/52263", "merged": true, "mergeCommit": {"oid": "5b115fb3f6414ce13be6730e9cb0c7a8b214d728"}, "closed": true, "closedAt": "2020-02-18T16:32:24Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDnQELAH2gAyMzc0MzUyNzQ0OmFlMGYzYjY4NWQ0M2Y4YWI2NTViZmQwYTQ0NTJmNDZlMDE1YmU2NTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFkhuDgFqTM2MDQ4NjA2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae0f3b685d43f8ab655bfd0a4452f46e015be659", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae0f3b685d43f8ab655bfd0a4452f46e015be659", "committedDate": "2020-02-12T14:31:42Z", "message": "Add S3 integration tests for searchable snapshots"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NzE1NjM1", "url": "https://github.com/elastic/elasticsearch/pull/52263#pullrequestreview-357715635", "createdAt": "2020-02-12T19:12:40Z", "commit": {"oid": "ae0f3b685d43f8ab655bfd0a4452f46e015be659"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxOToxMjo0MFrOFo7JuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxOToxMjo0MFrOFo7JuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQ1NjUwNQ==", "bodyText": "It's not clear to me why all this is required. We seem to be effectively defining a new test fixture here. Why isn't we can't just use the existing s3-fixture like we do for other tests?\n\n  \n    \n      elasticsearch/plugins/repository-s3/build.gradle\n    \n    \n         Line 217\n      in\n      88ff69b\n    \n    \n    \n    \n\n        \n          \n           testFixtures.useFixture(':test:fixtures:s3-fixture')", "url": "https://github.com/elastic/elasticsearch/pull/52263#discussion_r378456505", "createdAt": "2020-02-12T19:12:40Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/searchable-snapshots/qa/s3/build.gradle", "diffHunk": "@@ -0,0 +1,82 @@\n+import org.elasticsearch.gradle.info.BuildParams\n+\n+import static org.elasticsearch.gradle.PropertyNormalization.IGNORE_VALUE\n+\n+apply plugin: 'elasticsearch.standalone-rest-test'\n+apply plugin: 'elasticsearch.rest-test'\n+apply plugin: 'elasticsearch.test.fixtures'\n+\n+final Project fixture = project(':test:fixtures:s3-fixture')\n+final Project repositoryPlugin = project(':plugins:repository-s3')\n+\n+dependencies {\n+  testCompile project(path: xpackModule('searchable-snapshots'), configuration: 'testArtifacts')\n+  testCompile repositoryPlugin\n+  testCompile fixture\n+}\n+\n+boolean useFixture = false\n+String s3AccessKey = System.getenv(\"amazon_s3_access_key\")\n+String s3SecretKey = System.getenv(\"amazon_s3_secret_key\")\n+String s3Bucket = System.getenv(\"amazon_s3_bucket\")\n+String s3BasePath = System.getenv(\"amazon_s3_base_path\")\n+\n+if (!s3AccessKey && !s3SecretKey && !s3Bucket && !s3BasePath) {\n+  s3AccessKey = 'access_key'\n+  s3SecretKey = 'secret_key'\n+  s3Bucket = 'bucket'\n+  s3BasePath = 'base_path'\n+  useFixture = true\n+\n+} else if (!s3AccessKey || !s3SecretKey || !s3Bucket || !s3BasePath) {\n+  throw new IllegalArgumentException(\"not all options specified to run against external S3 service are present\")\n+}\n+\n+if (useFixture) {\n+  preProcessFixture {\n+    dependsOn fixture.jar\n+    doLast {\n+      file(\"${testFixturesDir}/shared\").mkdirs()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae0f3b685d43f8ab655bfd0a4452f46e015be659"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "331408ad382e2dbebb50d4b7f7de204b54e5a913", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/331408ad382e2dbebb50d4b7f7de204b54e5a913", "committedDate": "2020-02-14T10:00:57Z", "message": "apply feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTcyNDUw", "url": "https://github.com/elastic/elasticsearch/pull/52263#pullrequestreview-359172450", "createdAt": "2020-02-14T19:34:15Z", "commit": {"oid": "331408ad382e2dbebb50d4b7f7de204b54e5a913"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxOTozNDoxNVrOFqBcLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxOTozNjoxMVrOFqBfgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwODEwOA==", "bodyText": "Does the s3-fixture actually need to be on the test classpath? As far as I can tell there are not references to that code and the fixture is just something running in a Docker container which we talk to over an API.", "url": "https://github.com/elastic/elasticsearch/pull/52263#discussion_r379608108", "createdAt": "2020-02-14T19:34:15Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/searchable-snapshots/qa/s3/build.gradle", "diffHunk": "@@ -0,0 +1,69 @@\n+import org.elasticsearch.gradle.info.BuildParams\n+\n+import static org.elasticsearch.gradle.PropertyNormalization.IGNORE_VALUE\n+\n+apply plugin: 'elasticsearch.standalone-rest-test'\n+apply plugin: 'elasticsearch.rest-test'\n+\n+final Project fixture = project(':test:fixtures:s3-fixture')\n+final Project repositoryPlugin = project(':plugins:repository-s3')\n+\n+dependencies {\n+  testCompile project(path: xpackModule('searchable-snapshots'), configuration: 'testArtifacts')\n+  testCompile repositoryPlugin\n+  testCompile fixture", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331408ad382e2dbebb50d4b7f7de204b54e5a913"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwODcyOA==", "bodyText": "Is this filter strictly required? This opens up potential issues with test cases referencing other classes in the test source set that don't match this pattern and causing things to explode at runtime.", "url": "https://github.com/elastic/elasticsearch/pull/52263#discussion_r379608728", "createdAt": "2020-02-14T19:35:40Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/searchable-snapshots/build.gradle", "diffHunk": "@@ -27,3 +27,17 @@ gradle.projectsEvaluated {\n     .findAll { it.path.startsWith(project.path + \":qa\") }\n     .each { check.dependsOn it.check }\n }\n+\n+configurations {\n+  testArtifacts.extendsFrom testRuntime\n+}\n+\n+task testJar(type: Jar) {\n+  appendix 'test'\n+  from sourceSets.test.output\n+  include '**/*TestCase.class'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331408ad382e2dbebb50d4b7f7de204b54e5a913"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYwODk2MQ==", "bodyText": "Perhaps s3-fixture-searchable-snapshots?", "url": "https://github.com/elastic/elasticsearch/pull/52263#discussion_r379608961", "createdAt": "2020-02-14T19:36:11Z", "author": {"login": "mark-vieira"}, "path": "test/fixtures/s3-fixture/docker-compose.yml", "diffHunk": "@@ -15,6 +15,21 @@ services:\n     ports:\n       - \"80\"\n \n+  s3-fixture-other:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331408ad382e2dbebb50d4b7f7de204b54e5a913"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b83512dd616473336abc2fa806a80630b2a50e58", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/b83512dd616473336abc2fa806a80630b2a50e58", "committedDate": "2020-02-17T08:49:18Z", "message": "apply feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDg2MDY0", "url": "https://github.com/elastic/elasticsearch/pull/52263#pullrequestreview-360486064", "createdAt": "2020-02-18T16:29:07Z", "commit": {"oid": "b83512dd616473336abc2fa806a80630b2a50e58"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2618, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}