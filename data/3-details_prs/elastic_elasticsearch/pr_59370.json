{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NzYzNzA5", "number": 59370, "title": "SQL: fix NPE on ambiguous GROUP BY", "bodyText": "This PR fixes a NPE occurring when an ambiguous alias is used for grouping.\nContinues #56489.\nFixes #46396.\nCo-authored-by: Nikita Verkhovin verkhovin13@gmail.com", "createdAt": "2020-07-11T12:44:09Z", "url": "https://github.com/elastic/elasticsearch/pull/59370", "merged": true, "mergeCommit": {"oid": "9ba70a3483f0f4987229bec231cdc004f51b88a5"}, "closed": true, "closedAt": "2020-07-20T14:46:06Z", "author": {"login": "bpintea"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfucKsAH2gAyNDQ3NzYzNzA5OjFhYzRhYWY3N2RkYzljMjk5NTY5MDMxOTAwNjZmMDhhYzcyOWE4YTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0jzV3AFqTQ0NzM5NzY1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ac4aaf77ddc9c29956903190066f08ac729a8a0", "author": {"user": {"login": "verkhovin", "name": "Nikita Verkhovin"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ac4aaf77ddc9c29956903190066f08ac729a8a0", "committedDate": "2020-05-09T22:44:08Z", "message": "#46396 fix npe on ambiguous group by"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "250fee4a61bcf81c94b2abbda76ccbbd4dd93561", "author": {"user": {"login": "verkhovin", "name": "Nikita Verkhovin"}}, "url": "https://github.com/elastic/elasticsearch/commit/250fee4a61bcf81c94b2abbda76ccbbd4dd93561", "committedDate": "2020-05-11T13:21:49Z", "message": "#46396 add tests for aggregates and group by, add quotes to error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7d87104563c69255b4575775215080c96a20082", "author": {"user": {"login": "verkhovin", "name": "Nikita Verkhovin"}}, "url": "https://github.com/elastic/elasticsearch/commit/f7d87104563c69255b4575775215080c96a20082", "committedDate": "2020-05-12T04:49:17Z", "message": "#46396 add more cases for Group By ambiguity test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "378e0875bc7fdf03ef5a22110c3e881ca143c19d", "author": {"user": {"login": "verkhovin", "name": "Nikita Verkhovin"}}, "url": "https://github.com/elastic/elasticsearch/commit/378e0875bc7fdf03ef5a22110c3e881ca143c19d", "committedDate": "2020-05-12T04:51:51Z", "message": "make test to pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8ea65539b44f0bdeef55f665d363179ea1afce", "author": {"user": {"login": "verkhovin", "name": "Nikita Verkhovin"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae8ea65539b44f0bdeef55f665d363179ea1afce", "committedDate": "2020-05-12T16:13:09Z", "message": "change error messages for rield ambiguity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99ecbed2029cdfe23644bef94f981be98a8bab69", "author": {"user": {"login": "verkhovin", "name": "Nikita Verkhovin"}}, "url": "https://github.com/elastic/elasticsearch/commit/99ecbed2029cdfe23644bef94f981be98a8bab69", "committedDate": "2020-05-20T15:32:48Z", "message": "Revert \"change error messages for rield ambiguity\"\n\nThis reverts commit ae8ea655"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbe4c64f410eaba2c8e2822c9caf57410c866fae", "author": {"user": {"login": "verkhovin", "name": "Nikita Verkhovin"}}, "url": "https://github.com/elastic/elasticsearch/commit/cbe4c64f410eaba2c8e2822c9caf57410c866fae", "committedDate": "2020-05-20T16:45:06Z", "message": "change collection aliases aproach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69afda9776f8316b6847bfc00d3332e8acb6df8e", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/69afda9776f8316b6847bfc00d3332e8acb6df8e", "committedDate": "2020-05-21T07:56:47Z", "message": "Merge branch 'master' into fix_npe_on_ambiguous_group_by"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f393faa13e5a10cf6cc38c38fb02cd6b7dd18bf8", "author": {"user": {"login": "verkhovin", "name": "Nikita Verkhovin"}}, "url": "https://github.com/elastic/elasticsearch/commit/f393faa13e5a10cf6cc38c38fb02cd6b7dd18bf8", "committedDate": "2020-05-21T18:59:13Z", "message": "add locations of attributes for ambiguous grouping error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c1419e5cff4ac5b941067b35c63edf668ca6b3e", "author": {"user": {"login": "verkhovin", "name": "Nikita Verkhovin"}}, "url": "https://github.com/elastic/elasticsearch/commit/5c1419e5cff4ac5b941067b35c63edf668ca6b3e", "committedDate": "2020-05-21T19:00:20Z", "message": "Merge branch 'fix_npe_on_ambiguous_group_by' of https://github.com/verkhovin/elasticsearch into fix_npe_on_ambiguous_group_by"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cc778f9555194fbed1d61e56ae7a10b21c86d1b", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/7cc778f9555194fbed1d61e56ae7a10b21c86d1b", "committedDate": "2020-07-09T09:51:10Z", "message": "Merge commit 'refs/pull/56489/head' of github.com:elastic/elasticsearch into fix/fix_npe_on_ambiguous_group_by"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9492796b23504a2b2e4343e4ab7c886e1ed51c17", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/9492796b23504a2b2e4343e4ab7c886e1ed51c17", "committedDate": "2020-07-11T12:33:04Z", "message": "Adress review comments\n\n- remove Comparable implementations from Attribute and Location;\n- add ad-hoc comparator for sorting locations in ambiguity message;\n- remove added AttributeAlias class with Touple;\n- add code comment to explain issue with Location overwriting."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d425b9568b2a5b8895f23ac59855144967d727b", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/0d425b9568b2a5b8895f23ac59855144967d727b", "committedDate": "2020-07-11T14:57:53Z", "message": "Adress review comments\n\n- remove Comparable implementations from Attribute and Location;\n- add ad-hoc comparator for sorting locations in ambiguity message;\n- remove added AttributeAlias class with Touple;\n- add code comment to explain issue with Location overwriting."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b479f6de03bf850a9329805d9584ef3387698e78", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/b479f6de03bf850a9329805d9584ef3387698e78", "committedDate": "2020-07-12T13:05:38Z", "message": "Fix c&p error in location ref generation comparator\n\nFix copy&paste error in dedicated comparator used for sorting ambiguity\nlocation references.\nSlightly increase its readability."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/06e80643cbaac564e1048437a5d622e950e6f2bb", "committedDate": "2020-07-12T13:15:53Z", "message": "Merge branch 'master' into fix/fix_npe_on_ambiguous_group_by"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDQzNTY2", "url": "https://github.com/elastic/elasticsearch/pull/59370#pullrequestreview-447043566", "createdAt": "2020-07-13T08:40:20Z", "commit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODo0MDoyMVrOGwepZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODo0MDoyMVrOGwepZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4Njk0OA==", "bodyText": "Could you please replace this with a Tuple<Attribute, Expression>?\n\nAttributeAlias replaced with Tuple<Attribute, Expression>?", "url": "https://github.com/elastic/elasticsearch/pull/59370#discussion_r453486948", "createdAt": "2020-07-13T08:40:21Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/expression/Expressions.java", "diffHunk": "@@ -164,14 +163,15 @@ public static boolean equalsAsAttribute(Expression left, Expression right) {\n         return true;\n     }\n \n-    public static AttributeMap<Expression> aliases(List<? extends NamedExpression> named) {\n-        Map<Attribute, Expression> aliasMap = new LinkedHashMap<>();\n+    public static List<Tuple<Attribute, Expression>> aliases(List<? extends NamedExpression> named) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDQzNzQ1", "url": "https://github.com/elastic/elasticsearch/pull/59370#pullrequestreview-447043745", "createdAt": "2020-07-13T08:40:32Z", "commit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODo0MDozMlrOGweqBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODo0MDozMlrOGweqBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4NzEwOA==", "bodyText": "Why removing it from here and adding it only if matches.size() == 1?\n\nAttribute#withLocation() will \"overwrite\" any pre-existing location, which is not desirable if the existing locations need to be kept in order to be reported in an error message.", "url": "https://github.com/elastic/elasticsearch/pull/59370#discussion_r453487108", "createdAt": "2020-07-13T08:40:32Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Analyzer.java", "diffHunk": "@@ -192,16 +192,21 @@ private static Attribute resolveAgainstList(UnresolvedAttribute u, Collection<At\n         }\n \n         if (matches.size() == 1) {\n-            return handleSpecialFields(u, matches.get(0), allowCompound);\n+            // only add the location if the match is univocal; b/c otherwise adding the location will overwrite any preexisting one\n+            return handleSpecialFields(u, matches.get(0).withLocation(u.source()), allowCompound);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDQzODQ4", "url": "https://github.com/elastic/elasticsearch/pull/59370#pullrequestreview-447043848", "createdAt": "2020-07-13T08:40:38Z", "commit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODo0MDozOVrOGweqWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODo0MDozOVrOGweqWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4NzE5NQ==", "bodyText": "Please remove the comparison implementation from here and use a custom comparator to sort the ambiguous attributes.\n\nImplementations of Comparable removed.", "url": "https://github.com/elastic/elasticsearch/pull/59370#discussion_r453487195", "createdAt": "2020-07-13T08:40:39Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Analyzer.java", "diffHunk": "@@ -192,16 +192,21 @@ private static Attribute resolveAgainstList(UnresolvedAttribute u, Collection<At\n         }\n \n         if (matches.size() == 1) {\n-            return handleSpecialFields(u, matches.get(0), allowCompound);\n+            // only add the location if the match is univocal; b/c otherwise adding the location will overwrite any preexisting one\n+            return handleSpecialFields(u, matches.get(0).withLocation(u.source()), allowCompound);\n         }\n \n-        return u.withUnresolvedMessage(\"Reference [\" + u.qualifiedName()\n-                + \"] is ambiguous (to disambiguate use quotes or qualifiers); matches any of \" +\n-                 matches.stream()\n-                 .map(a -> \"\\\"\" + a.qualifier() + \"\\\".\\\"\" + a.name() + \"\\\"\")\n-                 .sorted()\n-                 .collect(toList())\n-                );\n+        List<String> refs = matches.stream()\n+            .sorted((a, b) -> {\n+                int lineDiff = a.sourceLocation().getLineNumber() - b.sourceLocation().getLineNumber();\n+                int colDiff = a.sourceLocation().getColumnNumber() - b.sourceLocation().getColumnNumber();\n+                return lineDiff != 0 ? lineDiff : (colDiff != 0 ? colDiff : a.qualifiedName().compareTo(b.qualifiedName()));\n+            })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDQzOTI5", "url": "https://github.com/elastic/elasticsearch/pull/59370#pullrequestreview-447043929", "createdAt": "2020-07-13T08:40:44Z", "commit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODo0MDo0NFrOGweqpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODo0MDo0NFrOGweqpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4NzI3MA==", "bodyText": "Imho, it would be better to use a for loop to increase readability.\n\nThe stream construction seems a bit more compact and readable IMO and inline with other usages (like the current Analyzer#resolveAgainstList()), but I can still change it if desired.", "url": "https://github.com/elastic/elasticsearch/pull/59370#discussion_r453487270", "createdAt": "2020-07-13T08:40:44Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Analyzer.java", "diffHunk": "@@ -327,22 +332,31 @@ else if (plan instanceof Aggregate) {\n                     return new Aggregate(a.source(), a.child(), a.groupings(),\n                             expandProjections(a.aggregates(), a.child()));\n                 }\n-                // if the grouping is unresolved but the aggs are, use the former to resolve the latter\n-                // solves the case of queries declaring an alias in SELECT and referring to it in GROUP BY\n+                // if the grouping is unresolved but the aggs are, use the latter to resolve the former.\n+                // solves the case of queries declaring an alias in SELECT and referring to it in GROUP BY.\n                 // e.g. SELECT x AS a ... GROUP BY a\n                 if (!a.expressionsResolved() && Resolvables.resolved(a.aggregates())) {\n                     List<Expression> groupings = a.groupings();\n                     List<Expression> newGroupings = new ArrayList<>();\n-                    AttributeMap<Expression> resolved = Expressions.aliases(a.aggregates());\n+                    List<Tuple<Attribute, Expression>> resolvedAliases = Expressions.aliases(a.aggregates());\n \n                     boolean changed = false;\n                     for (Expression grouping : groupings) {\n                         if (grouping instanceof UnresolvedAttribute) {\n-                            Attribute maybeResolved = resolveAgainstList((UnresolvedAttribute) grouping, resolved.keySet());\n+                            Attribute maybeResolved = resolveAgainstList((UnresolvedAttribute) grouping,\n+                                resolvedAliases.stream().map(Tuple::v1).collect(toList()));\n                             if (maybeResolved != null) {\n                                 changed = true;\n-                                // use the matched expression (not its attribute)\n-                                grouping = resolved.get(maybeResolved);\n+                                if (maybeResolved.resolved()) {\n+                                    grouping = resolvedAliases.stream()\n+                                        .filter(t -> t.v1().equals(maybeResolved))\n+                                        // use the matched expression (not its attribute)\n+                                        .map(Tuple::v2)\n+                                        .findAny()\n+                                        .get(); // there should always be exactly one match", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb"}, "originalPosition": 84}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3Mzk3NjUz", "url": "https://github.com/elastic/elasticsearch/pull/59370#pullrequestreview-447397653", "createdAt": "2020-07-13T16:12:54Z", "commit": {"oid": "06e80643cbaac564e1048437a5d622e950e6f2bb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2163, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}