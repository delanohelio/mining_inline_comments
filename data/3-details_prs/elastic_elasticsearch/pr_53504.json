{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MzkwMzU5", "number": 53504, "title": "Fix Term Vectors with artificial docs and keyword fields", "bodyText": "Previously, Term Vectors API was returning empty results for\nartificial documents with keyword fields. Checking only for string()\non IndexableField is not enough, since for KeywordFieldType\nbinaryValue() must be used instead.\nFixes #53494", "createdAt": "2020-03-12T17:59:44Z", "url": "https://github.com/elastic/elasticsearch/pull/53504", "merged": true, "mergeCommit": {"oid": "1fc3fe3d32f41eab2101c0536751b7c47e63cc48"}, "closed": true, "closedAt": "2020-03-13T15:17:31Z", "author": {"login": "matriv"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM_h4aAH2gAyMzg3MzkwMzU5OmZiMDU4YzZkZDhjNmM3M2Q3YTRiYjY3OTA1ZDg0MDVmNjc1ZDZhZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNRAxyAH2gAyMzg3MzkwMzU5OjM4ZDFlZWI0OWFiNTQwYTFmMDgwOGRmNzM0Mzg1ZDk0YjlhODRiNTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fb058c6dd8c6c73d7a4bb67905d8405f675d6aeb", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb058c6dd8c6c73d7a4bb67905d8405f675d6aeb", "committedDate": "2020-03-12T17:54:12Z", "message": "Fix Term Vectors with artificial docs and keyword fields\n\nPreviously, Term Vectors API was returning empty results for\nartificial documents with keyword fields. Checking only for `string()`\non `IndexableField` is not enough, since for `KeywordFieldType`\n`binaryValue()` must be used instead.\n\nFixes #53494"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczODcwNDg0", "url": "https://github.com/elastic/elasticsearch/pull/53504#pullrequestreview-373870484", "createdAt": "2020-03-12T20:15:06Z", "commit": {"oid": "fb058c6dd8c6c73d7a4bb67905d8405f675d6aeb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMDoxNTowNlrOF1t4FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQyMDoxNTowNlrOF1t4FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg3MDQ4NQ==", "bodyText": "We cannot use the binary value without checking the type of the field. It could be a real binary field that doesn't store utf8 bytes. Since this function is only used in the terms vector service, can you move it there and adds a check to extract binary values only if the field is of type keyword ?", "url": "https://github.com/elastic/elasticsearch/pull/53504#discussion_r391870485", "createdAt": "2020-03-12T20:15:06Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ParseContext.java", "diffHunk": "@@ -131,8 +131,12 @@ public IndexableField getByKey(Object key) {\n         public final String[] getValues(String name) {\n             List<String> result = new ArrayList<>();\n             for (IndexableField field : fields) {\n-                if (field.name().equals(name) && field.stringValue() != null) {\n-                    result.add(field.stringValue());\n+                if (field.name().equals(name)) {\n+                    if (field.stringValue() != null) {\n+                        result.add(field.stringValue());\n+                    } else if (field.binaryValue() != null) { // KeywordFieldType", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb058c6dd8c6c73d7a4bb67905d8405f675d6aeb"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c6b6ec2e89322ac7436f028c7714b8c4cfc22b7", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/5c6b6ec2e89322ac7436f028c7714b8c4cfc22b7", "committedDate": "2020-03-12T22:26:29Z", "message": "Merge remote-tracking branch 'upstream/master' into fix-53494"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fd234c03ef48167b7e45914f4e72de8c95631ce", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/7fd234c03ef48167b7e45914f4e72de8c95631ce", "committedDate": "2020-03-12T22:53:38Z", "message": "move getValues to TermVectorsService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MjA2Nzcy", "url": "https://github.com/elastic/elasticsearch/pull/53504#pullrequestreview-374206772", "createdAt": "2020-03-13T10:51:29Z", "commit": {"oid": "7fd234c03ef48167b7e45914f4e72de8c95631ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDo1MToyOVrOF1_UTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDo1MToyOVrOF1_UTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE1NjIzOA==", "bodyText": "I think that this will create duplicates due to doc values field that also use a binary value (SortedSetDocValuesField). You should change this to something like:\nif (field.fieldType() instanceof KeywordFieldMapper.KeywordFieldType) {\n  result.add(field.binaryValue().utf8ToString());\n} else if (field.fieldType() instanceof StringFieldType) {\n  result.add(field.stringValue());\n}", "url": "https://github.com/elastic/elasticsearch/pull/53504#discussion_r392156238", "createdAt": "2020-03-13T10:51:29Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/termvectors/TermVectorsService.java", "diffHunk": "@@ -313,14 +314,33 @@ private static Fields generateTermVectorsFromDoc(IndexShard indexShard, TermVect\n             else {\n                 seenFields.add(field.name());\n             }\n-            String[] values = doc.getValues(field.name());\n+            String[] values = getValues(doc.getFields(field.name()));\n             documentFields.add(new DocumentField(field.name(), Arrays.asList((Object[]) values)));\n         }\n         return generateTermVectors(indexShard,\n             XContentHelper.convertToMap(parsedDocument.source(), true, request.xContentType()).v2(), documentFields,\n                 request.offsets(), request.perFieldAnalyzer(), seenFields);\n     }\n \n+    /**\n+     * Returns an array of values of the field specified as the method parameter.\n+     * This method returns an empty array when there are no\n+     * matching fields.  It never returns null.\n+     * @param fields The <code>IndexableField</code> to get the values from\n+     * @return a <code>String[]</code> of field values\n+     */\n+    public static String[] getValues(IndexableField[] fields) {\n+        List<String> result = new ArrayList<>();\n+        for (IndexableField field : fields) {\n+            if (field.stringValue() != null) {\n+                result.add(field.stringValue());\n+            } else if (field.binaryValue() != null) { // KeywordFieldType", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fd234c03ef48167b7e45914f4e72de8c95631ce"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea1a4ef0bebe1c55b2681d55951452e120d33d34", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea1a4ef0bebe1c55b2681d55951452e120d33d34", "committedDate": "2020-03-13T12:56:42Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea87219370f56020e5ded04b321c0127ae9e884c", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea87219370f56020e5ded04b321c0127ae9e884c", "committedDate": "2020-03-13T12:56:51Z", "message": "Merge remote-tracking branch 'upstream/master' into fix-53494"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MjkwMTQy", "url": "https://github.com/elastic/elasticsearch/pull/53504#pullrequestreview-374290142", "createdAt": "2020-03-13T13:17:15Z", "commit": {"oid": "ea87219370f56020e5ded04b321c0127ae9e884c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd1ac91d2eabcbce680cce9799cf31d5fb684a7", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/ffd1ac91d2eabcbce680cce9799cf31d5fb684a7", "committedDate": "2020-03-13T13:41:48Z", "message": "Merge remote-tracking branch 'upstream/master' into fix-53494"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1b69af926c54af7f5d30fb4d76a7c2014055d35", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/f1b69af926c54af7f5d30fb4d76a7c2014055d35", "committedDate": "2020-03-13T13:47:02Z", "message": "add import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38d1eeb49ab540a1f0808df734385d94b9a84b58", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/38d1eeb49ab540a1f0808df734385d94b9a84b58", "committedDate": "2020-03-13T14:16:20Z", "message": "fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1358, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}