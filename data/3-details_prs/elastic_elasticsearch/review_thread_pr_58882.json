{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzMDIyNDYw", "number": 58882, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjo1MjoyMVrOEKr6Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjo1Mjo0NlrOEKr6bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjQwNTk5OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjo1MjoyMVrOGr3zGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMDoxNzozNFrOGr5STQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjE1NA==", "bodyText": "should the other test code use this too?", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448656154", "createdAt": "2020-07-01T22:52:21Z", "author": {"login": "talevy"}, "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "diffHunk": "@@ -39,4 +43,30 @@ public MockScriptService(Settings settings, Map<String, ScriptEngine> engines, M\n     boolean compilationLimitsEnabled() {\n         return false;\n     }\n+\n+    public static <T> MockScriptService singleContext(ScriptContext<T> context, Function<String, T> compile,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9d23354cc1ba239d4481309f29b298b204ead6a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY3OTI4Ng==", "bodyText": "It can, but I wanted to keep this PR small. We can migrate other uses to this later as necessary.", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448679286", "createdAt": "2020-07-02T00:12:46Z", "author": {"login": "rjernst"}, "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "diffHunk": "@@ -39,4 +43,30 @@ public MockScriptService(Settings settings, Map<String, ScriptEngine> engines, M\n     boolean compilationLimitsEnabled() {\n         return false;\n     }\n+\n+    public static <T> MockScriptService singleContext(ScriptContext<T> context, Function<String, T> compile,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjE1NA=="}, "originalCommit": {"oid": "a9d23354cc1ba239d4481309f29b298b204ead6a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MDUyNQ==", "bodyText": "\ud83d\udc4d was mostly wondering, as it seemed convenient", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448680525", "createdAt": "2020-07-02T00:17:34Z", "author": {"login": "talevy"}, "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "diffHunk": "@@ -39,4 +43,30 @@ public MockScriptService(Settings settings, Map<String, ScriptEngine> engines, M\n     boolean compilationLimitsEnabled() {\n         return false;\n     }\n+\n+    public static <T> MockScriptService singleContext(ScriptContext<T> context, Function<String, T> compile,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjE1NA=="}, "originalCommit": {"oid": "a9d23354cc1ba239d4481309f29b298b204ead6a"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjQwNjg0OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjo1Mjo0NlrOGr3zmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjo1Mjo0NlrOGr3zmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjI4Mw==", "bodyText": "compilation issue here?", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448656283", "createdAt": "2020-07-01T22:52:46Z", "author": {"login": "talevy"}, "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "diffHunk": "@@ -39,4 +43,30 @@ public MockScriptService(Settings settings, Map<String, ScriptEngine> engines, M\n     boolean compilationLimitsEnabled() {\n         return false;\n     }\n+\n+    public static <T> MockScriptService singleContext(ScriptContext<T> context, Function<String, T> compile,\n+                                                      Map<String, StoredScriptSource> storedLookup) {\n+        ScriptEngine engine = new ScriptEngine() {\n+            @Override\n+            public String getType() {\n+                return \"lang\";\n+            }\n+\n+            @Override\n+            public <FactoryType> FactoryType compile(String name, String code, ScriptContext<FactoryType> context, Map<String, String> params) {\n+                return context.factoryClazz.cast(compile.apply(code));\n+            }\n+\n+            @Override\n+            public Set<ScriptContext<?>> getSupportedContexts() {\n+                return Set.of(context);\n+            }\n+        };\n+        return new MockScriptService(Settings.EMPTY, Map.of(\"lang\", engine), Map.of(context.name, context)) {\n+            @Override\n+            public StoredScriptSource getScriptFromClusterState(String id) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9d23354cc1ba239d4481309f29b298b204ead6a"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2123, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}