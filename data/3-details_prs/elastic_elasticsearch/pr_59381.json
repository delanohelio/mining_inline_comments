{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MDkwMjQ0", "number": 59381, "title": "Continue to accept unused 'universal' params in <8.0 indexes", "bodyText": "We have a number of parameters which are universally parsed by almost all\nmappers, whether or not they make sense.  Migrating the binary and boolean\nmappers to the new style of declaring their parameters explicitly has meant\nthat these universal parameters stopped being accepted, which would break\nexisting mappings.\nThis commit adds some extra logic to ParametrizedFieldMapper that checks\nfor the existence of these universal parameters, and issues a warning on\n7x indexes if it finds them.  Indexes created in 8.0 and beyond will throw an\nerror.\nFixes #59359", "createdAt": "2020-07-13T08:27:20Z", "url": "https://github.com/elastic/elasticsearch/pull/59381", "merged": true, "mergeCommit": {"oid": "33630489dbfaf36044843ca7a54f5fd9856e6b98"}, "closed": true, "closedAt": "2020-07-13T10:07:53Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0dEhmAH2gAyNDQ4MDkwMjQ0OmMxODA2N2U3ODFiMDdhYmFiODUzNGQxMjk0NjZlYTEwMjVjNzY4ODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0dtAagH2gAyNDQ4MDkwMjQ0OmY4NzBlMmU3OWZlYmQxZGVhNjhmMzlmNzgyMTBlZDU2YzVlYjZjOTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c18067e781b07abab8534d129466ea1025c76882", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/c18067e781b07abab8534d129466ea1025c76882", "committedDate": "2020-07-13T08:22:20Z", "message": "Continue to accept unused 'universal' params in <8.0 indexes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDM3MTUy", "url": "https://github.com/elastic/elasticsearch/pull/59381#pullrequestreview-447037152", "createdAt": "2020-07-13T08:32:45Z", "commit": {"oid": "c18067e781b07abab8534d129466ea1025c76882"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODozMjo0NlrOGweW3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwODozNTo0MFrOGwed7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MjIwNQ==", "bodyText": "maybe saying \"has no effect\" would be clearer to users?", "url": "https://github.com/elastic/elasticsearch/pull/59381#discussion_r453482205", "createdAt": "2020-07-13T08:32:46Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ParametrizedFieldMapper.java", "diffHunk": "@@ -330,6 +335,12 @@ public final void parse(String name, TypeParser.ParserContext parserContext, Map\n                 }\n                 Parameter<?> parameter = paramsMap.get(propName);\n                 if (parameter == null) {\n+                    if (checkForDeprecatedParameter(propName, parserContext.indexVersionCreated())) {\n+                        deprecationLogger.deprecate(propName,\n+                            \"Parameter [{}] is unused on type [{}] and will be removed in future\", propName, type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18067e781b07abab8534d129466ea1025c76882"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MjY1Mw==", "bodyText": "should this be static?", "url": "https://github.com/elastic/elasticsearch/pull/59381#discussion_r453482653", "createdAt": "2020-07-13T08:33:30Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ParametrizedFieldMapper.java", "diffHunk": "@@ -341,5 +352,18 @@ public final void parse(String name, TypeParser.ParserContext parserContext, Map\n                 iterator.remove();\n             }\n         }\n+\n+        // These parameters were previously *always* parsed by TypeParsers#parseField(), even if they\n+        // made no sense; if we've got here, that means that they're not declared on a current mapper,\n+        // and so we emit a deprecation warning rather than failing a previously working mapping.\n+        private static final Set<String> DEPRECATED_PARAMS\n+            = Set.of(\"store\", \"meta\", \"index\", \"doc_values\", \"boost\", \"index_options\", \"similarity\");\n+\n+        private boolean checkForDeprecatedParameter(String propName, Version indexCreatedVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c18067e781b07abab8534d129466ea1025c76882"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4NDAxMw==", "bodyText": "also should we rename to isDeprecatedParameter? I find check more ambiguous in what it does.", "url": "https://github.com/elastic/elasticsearch/pull/59381#discussion_r453484013", "createdAt": "2020-07-13T08:35:40Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ParametrizedFieldMapper.java", "diffHunk": "@@ -341,5 +352,18 @@ public final void parse(String name, TypeParser.ParserContext parserContext, Map\n                 iterator.remove();\n             }\n         }\n+\n+        // These parameters were previously *always* parsed by TypeParsers#parseField(), even if they\n+        // made no sense; if we've got here, that means that they're not declared on a current mapper,\n+        // and so we emit a deprecation warning rather than failing a previously working mapping.\n+        private static final Set<String> DEPRECATED_PARAMS\n+            = Set.of(\"store\", \"meta\", \"index\", \"doc_values\", \"boost\", \"index_options\", \"similarity\");\n+\n+        private boolean checkForDeprecatedParameter(String propName, Version indexCreatedVersion) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ4MjY1Mw=="}, "originalCommit": {"oid": "c18067e781b07abab8534d129466ea1025c76882"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "018f5083db9279715a6bb921f933a75bac439d1e", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/018f5083db9279715a6bb921f933a75bac439d1e", "committedDate": "2020-07-13T08:43:10Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f870e2e79febd1dea68f39f78210ed56c5eb6c92", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/f870e2e79febd1dea68f39f78210ed56c5eb6c92", "committedDate": "2020-07-13T09:06:33Z", "message": "Merge branch 'master' into bug/deprecated-params"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4514, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}