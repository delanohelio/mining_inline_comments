{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNDk5Nzcw", "number": 61407, "title": "Rework test cluster distribution handling", "bodyText": "Driven by this issue #60969 (comment) we apply some rework on how we handle distributions in our test cluster setups:\n\nIf no custom modules, plugins or extra jar files are declared we do not create a cluster\nspecific distro folder and use the origin distribution folder instead.\nIf a custom distribution folder is required, we fallback to file copy when hard linking\nis not supported.\n\nThis is a prerequisite to get #60969 back in master / 7.x that was reverted due to the issue we faced with handling links on CI as described above.", "createdAt": "2020-08-21T08:43:09Z", "url": "https://github.com/elastic/elasticsearch/pull/61407", "merged": true, "mergeCommit": {"oid": "03e06ff4e1022ede6e11d1c92dfa7d2a85fcaec3"}, "closed": true, "closedAt": "2020-08-26T05:37:52Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBIm2VAFqTQ3MjY4MDk1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCde-lAFqTQ3NDg2MDczNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjgwOTU5", "url": "https://github.com/elastic/elasticsearch/pull/61407#pullrequestreview-472680959", "createdAt": "2020-08-21T17:52:50Z", "commit": {"oid": "baa6a609a8a1d24e0a551af13257e060640d4168"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNzo1Mjo1MFrOHE2H5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNzo1Mjo1MFrOHE2H5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDg0MzEwOQ==", "bodyText": "The duplication of this fake archive (src/integTest/... vs. src/testkit...) will disappear once the distribution resolution via artifact transforms is back on the branch", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r474843109", "createdAt": "2020-08-21T17:52:50Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/integTest/groovy/org/elasticsearch/gradle/fixtures/DistributionDownloadFixture.groovy", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.fixtures\n+\n+import org.elasticsearch.gradle.ElasticsearchDistribution\n+import org.elasticsearch.gradle.VersionProperties\n+import org.gradle.testkit.runner.BuildResult\n+import org.gradle.testkit.runner.GradleRunner\n+\n+class DistributionDownloadFixture {\n+\n+    public static final String INIT_SCRIPT = \"repositories-init.gradle\"\n+\n+    static BuildResult withMockedDistributionDownload(GradleRunner gradleRunner, Closure<BuildResult> buildRunClosure) {\n+        String urlPath = urlPath();\n+        return WiremockFixture.withWireMock(urlPath, filebytes(urlPath)) { server ->\n+            File initFile = new File(gradleRunner.getProjectDir(), INIT_SCRIPT)\n+            initFile.text = \"\"\"allprojects { p ->\n+                p.repositories.all { repo ->\n+                    repo.allowInsecureProtocol = true\n+                    repo.setUrl('${server.baseUrl()}')\n+                }\n+            }\"\"\"\n+            List<String> givenArguments = gradleRunner.getArguments()\n+            GradleRunner effectiveRunner = gradleRunner.withArguments(givenArguments + ['-I', initFile.getAbsolutePath()])\n+            return buildRunClosure.call(effectiveRunner)\n+        }\n+    }\n+\n+    private static String urlPath() {\n+        String version = VersionProperties.getElasticsearch()\n+        ElasticsearchDistribution.Platform platform = ElasticsearchDistribution.CURRENT_PLATFORM\n+        String fileType = ((ElasticsearchDistribution.CURRENT_PLATFORM == ElasticsearchDistribution.Platform.LINUX ||\n+                ElasticsearchDistribution.CURRENT_PLATFORM == ElasticsearchDistribution.Platform.DARWIN)) ? \"tar.gz\" : \"zip\"\n+        \"/downloads/elasticsearch/elasticsearch-${version}-${platform}-x86_64.$fileType\"\n+    }\n+\n+    private static byte[] filebytes(String urlPath) throws IOException {\n+        String suffix = urlPath.endsWith(\"zip\") ? \"zip\" : \"tar.gz\";\n+        return DistributionDownloadFixture.getResourceAsStream(\"/org/elasticsearch/gradle/fake_elasticsearch.\" + suffix).getBytes()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baa6a609a8a1d24e0a551af13257e060640d4168"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNzk0Mzk1", "url": "https://github.com/elastic/elasticsearch/pull/61407#pullrequestreview-473794395", "createdAt": "2020-08-24T19:29:18Z", "commit": {"oid": "baa6a609a8a1d24e0a551af13257e060640d4168"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxOToyOToxOFrOHFzQIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxOToyOToxOFrOHFzQIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0NDY0Mw==", "bodyText": "Is there a reason we can't just change the implementation of getDistroDir() to return this value? In what scenario would we use both?", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475844643", "createdAt": "2020-08-24T19:29:18Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -782,6 +787,10 @@ private void startElasticsearchProcess() {\n         reaper.registerPid(toString(), esProcess.pid());\n     }\n \n+    private Path getEffectiveDistroDir() {\n+        return canUseSharedDistribution() ? getExtractedDistributionDir().toFile().listFiles()[0].toPath() : getDistroDir();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baa6a609a8a1d24e0a551af13257e060640d4168"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNzk4OTgy", "url": "https://github.com/elastic/elasticsearch/pull/61407#pullrequestreview-473798982", "createdAt": "2020-08-24T19:36:25Z", "commit": {"oid": "baa6a609a8a1d24e0a551af13257e060640d4168"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxOTozNjoyNVrOHFzekA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxOTozNzozMlrOHFzgog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODMzNg==", "bodyText": "Unlike creating a symlink, this is a costly operation so how do we handle scenarios in tests where we do things like restart nodes. Since this is called in the start() method do we do this copy every time?", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475848336", "createdAt": "2020-08-24T19:36:25Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -1011,6 +1031,27 @@ private void createWorkingDir(Path distroExtractDir) throws IOException {\n      * @param destinationRoot destination to link to\n      */\n     private void syncWithLinks(Path sourceRoot, Path destinationRoot) {\n+        sync(sourceRoot, destinationRoot, (Path d, Path s) -> {\n+            try {\n+                Files.createLink(d, s);\n+            } catch (IOException e) {\n+                // Note does not work for network drives, e.g. Vagrant\n+                throw new LinkCreationException(\"Failed to create hard link \" + d + \" pointing to \" + s, e);\n+            }\n+        });\n+    }\n+\n+    private void syncWithCopy(Path sourceRoot, Path destinationRoot) {\n+        sync(sourceRoot, destinationRoot, (Path d, Path s) -> {\n+            try {\n+                Files.copy(s, d);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baa6a609a8a1d24e0a551af13257e060640d4168"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODY4Mw==", "bodyText": "Is this additional config required for some reason?", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475848683", "createdAt": "2020-08-24T19:37:07Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -1127,9 +1165,38 @@ private void createConfiguration() {\n         } catch (IOException e) {\n             throw new UncheckedIOException(\"Could not write config file: \" + configFile, e);\n         }\n+\n+        tweakJvmOptions(configFileRoot);\n         LOGGER.info(\"Written config file:{} for {}\", configFile, this);\n     }\n \n+    private void tweakJvmOptions(Path configFileRoot) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baa6a609a8a1d24e0a551af13257e060640d4168"}, "originalPosition": 180}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg0ODg2Ng==", "bodyText": "nit: canUseSharedDistribtuion() == false", "url": "https://github.com/elastic/elasticsearch/pull/61407#discussion_r475848866", "createdAt": "2020-08-24T19:37:32Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/testclusters/ElasticsearchNode.java", "diffHunk": "@@ -990,8 +999,19 @@ private void waitForProcessToExit(ProcessHandle processHandle) {\n     }\n \n     private void createWorkingDir(Path distroExtractDir) throws IOException {\n-        if (Files.exists(getDistroDir()) == false) {\n-            syncWithLinks(distroExtractDir, getDistroDir());\n+        if (!canUseSharedDistribution()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baa6a609a8a1d24e0a551af13257e060640d4168"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2838d0ae6630f04b19d30df81e6aef6d1b0ef249", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/2838d0ae6630f04b19d30df81e6aef6d1b0ef249", "committedDate": "2020-08-25T17:48:13Z", "message": "Rework test cluster distribution handling\n\nDriven by this issue https://github.com/elastic/elasticsearch/pull/60969#issuecomment-674962158\nwe apply some rework on how we handle distributions in our test cluster setups:\n\n- If no custom modules, plugins or extra jar files are declared we do not create a cluster\nspecific distro folder and use the origin distribution folder instead.\n- If a custom distribution folder is required, we fallback to file copy when hard linking\nis not supported"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6851abeec51ae2f8b35ee22adef2bfe063a7e033", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/6851abeec51ae2f8b35ee22adef2bfe063a7e033", "committedDate": "2020-08-25T17:48:14Z", "message": "Fix compile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6648cbceb36131a816b6a212a3880183edf77c9", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d6648cbceb36131a816b6a212a3880183edf77c9", "committedDate": "2020-08-25T17:48:14Z", "message": "Fix plugin func tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "089ffbe986ce3e805ecf6050c953db5446517139", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/089ffbe986ce3e805ecf6050c953db5446517139", "committedDate": "2020-08-25T17:48:14Z", "message": "Add more coverage for custom distros"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "215173f389803a647e9ba43644c3971f25c79c48", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/215173f389803a647e9ba43644c3971f25c79c48", "committedDate": "2020-08-25T17:48:14Z", "message": "TestClustersPlugin func tests do not work on windows yet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ff22f8f0e4a8d9839cdafcd8cfe08109296f76e", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ff22f8f0e4a8d9839cdafcd8cfe08109296f76e", "committedDate": "2020-08-25T17:48:14Z", "message": "Apply review feedback (just keep distroDir)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9737345c699340d28ebbca0d2a74b7992669ee86", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/9737345c699340d28ebbca0d2a74b7992669ee86", "committedDate": "2020-08-25T17:48:15Z", "message": "Only copy distro once if node is restarted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a74d72f810f7c1e05fed063816ebb9fd9bc05893", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/a74d72f810f7c1e05fed063816ebb9fd9bc05893", "committedDate": "2020-08-25T17:48:15Z", "message": "Fix typo in distro setup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f41f9fe04b191f74e637fbfbf37aeeea385f61f", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/5f41f9fe04b191f74e637fbfbf37aeeea385f61f", "committedDate": "2020-08-25T17:05:29Z", "message": "Fix typo in distro setup"}, "afterCommit": {"oid": "a74d72f810f7c1e05fed063816ebb9fd9bc05893", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/a74d72f810f7c1e05fed063816ebb9fd9bc05893", "committedDate": "2020-08-25T17:48:15Z", "message": "Fix typo in distro setup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c86e16c39930af855189103383cfb8b5939d505", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c86e16c39930af855189103383cfb8b5939d505", "committedDate": "2020-08-25T18:23:27Z", "message": "Always check if distro needs to be recreated\n\n- necessary for changing distribution versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0ODYwNzM2", "url": "https://github.com/elastic/elasticsearch/pull/61407#pullrequestreview-474860736", "createdAt": "2020-08-25T20:46:10Z", "commit": {"oid": "4c86e16c39930af855189103383cfb8b5939d505"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4835, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}