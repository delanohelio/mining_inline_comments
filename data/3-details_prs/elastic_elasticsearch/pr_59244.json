{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2Mzk3MjUy", "number": 59244, "title": "Composable templates: add a default mapping for @timestamp", "bodyText": "This adds a low precedence mapping for the @timestamp field with\ntype date.\nThis will aid with the bootstrapping of data streams as a timestamp\nmapping can be omitted when nanos precision is not needed.\nRelates to #53100", "createdAt": "2020-07-08T17:55:57Z", "url": "https://github.com/elastic/elasticsearch/pull/59244", "merged": true, "mergeCommit": {"oid": "4e72f43d62edfe52a934367ce9809b5efbcdb531"}, "closed": true, "closedAt": "2020-07-14T08:19:01Z", "author": {"login": "andreidan"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy-QPegH2gAyNDQ2Mzk3MjUyOmM1ZTczYjc3Njg4NGJlNGViZDViYTg3Yzc4M2JjZjVlMGExNjI2NDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0mLq4gH2gAyNDQ2Mzk3MjUyOjliZjg5ZjgxNDI4ZmIyZjVjZTI5YjA1ZmQ0MzJkYzQ3ZmVhOTQwOGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/c5e73b776884be4ebd5ba87c783bcf5e0a162644", "committedDate": "2020-07-08T17:54:09Z", "message": "Composable templates: add a default mapping for @timestamp\n\nThis adds a low precendece mapping for the `@timestamp` field with\ntype `date`.\nThis will aid with the bootstrapping of data streams as a timestamp\nmapping can be omitted when nanos precision is not needed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDAzMTc5", "url": "https://github.com/elastic/elasticsearch/pull/59244#pullrequestreview-445003179", "createdAt": "2020-07-08T17:56:36Z", "commit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzo1NjozNlrOGuzOjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzo1NjozNlrOGuzOjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcyNjk5MA==", "bodyText": "This is changed to exemplify a custom @timestamp mapping", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r451726990", "createdAt": "2020-07-08T17:56:36Z", "author": {"login": "andreidan"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/10_basic.yml", "diffHunk": "@@ -28,7 +24,7 @@ setup:\n             mappings:\n               properties:\n                 '@timestamp':\n-                  type: date\n+                  type: date_nanos", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b414ed4dee5d59091af3cc91b02a0e8ecb157f1a", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/b414ed4dee5d59091af3cc91b02a0e8ecb157f1a", "committedDate": "2020-07-08T18:02:45Z", "message": "Add precedence test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13ab97b08d0723fdb0a0f2817aa7e441c67c2caa", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/13ab97b08d0723fdb0a0f2817aa7e441c67c2caa", "committedDate": "2020-07-08T18:04:37Z", "message": "Fix line length"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDA4MzMx", "url": "https://github.com/elastic/elasticsearch/pull/59244#pullrequestreview-445008331", "createdAt": "2020-07-08T18:03:25Z", "commit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODowMzoyNlrOGuzeJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxODowMzoyNlrOGuzeJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTczMDk4MA==", "bodyText": "Shouldn't this be inside an if to only add this if the template has a data stream component defined?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r451730980", "createdAt": "2020-07-08T18:03:26Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -954,11 +964,14 @@ public static String findV2Template(Metadata metadata, String indexName, boolean\n             .map(ComponentTemplate::template)\n             .map(Template::mappings)\n             .filter(Objects::nonNull)\n-            .collect(Collectors.toList());\n+            .collect(Collectors.toCollection(LinkedList::new));\n         // Add the actual index template's mappings, since it takes the highest precedence\n         Optional.ofNullable(template.template())\n             .map(Template::mappings)\n             .ifPresent(mappings::add);\n+        // add a default mapping for the `@timestamp` field, at the lowest precedence, to make bootstrapping data streams more\n+        // straightforward\n+        mappings.add(0, new CompressedXContent(wrapMappingsIfNecessary(DEFAULT_TIMESTAMP_MAPPING, xContentRegistry)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fc65c772f4f01e0ae9b25cd9f107488c27c25fb", "author": {"user": {"login": "jrodewig", "name": "James Rodewig"}}, "url": "https://github.com/elastic/elasticsearch/commit/6fc65c772f4f01e0ae9b25cd9f107488c27c25fb", "committedDate": "2020-07-08T18:14:45Z", "message": "Merge branch 'master' into composable-templates-default-timestamp-mapping"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDE3NzUy", "url": "https://github.com/elastic/elasticsearch/pull/59244#pullrequestreview-445017752", "createdAt": "2020-07-08T18:17:00Z", "commit": {"oid": "6fc65c772f4f01e0ae9b25cd9f107488c27c25fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed622209bd7123653a420125461b1690805e98f4", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed622209bd7123653a420125461b1690805e98f4", "committedDate": "2020-07-08T18:27:22Z", "message": "Add default timestamp only when datastream is defined in template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4ea34cab36342ac3019aa7cba88732afe4a6253", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/c4ea34cab36342ac3019aa7cba88732afe4a6253", "committedDate": "2020-07-09T07:17:49Z", "message": "Merge branch 'master' into composable-templates-default-timestamp-mapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6de98d4b3c48a140d62b020e9c72d19d01b9dd4", "committedDate": "2020-07-09T08:33:51Z", "message": "Disable tests in 7.9 until after we backport"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDE3MTM4", "url": "https://github.com/elastic/elasticsearch/pull/59244#pullrequestreview-445417138", "createdAt": "2020-07-09T08:53:06Z", "commit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo1MzowNlrOGvH54g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxNDo1MlrOGvIsRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2NTc2Mg==", "bodyText": "why linked list?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452065762", "createdAt": "2020-07-09T08:53:06Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -954,11 +964,16 @@ public static String findV2Template(Metadata metadata, String indexName, boolean\n             .map(ComponentTemplate::template)\n             .map(Template::mappings)\n             .filter(Objects::nonNull)\n-            .collect(Collectors.toList());\n+            .collect(Collectors.toCollection(LinkedList::new));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2Nzg3Nw==", "bodyText": "I think we need to move this side the body of if (indexName.startsWith(DataStream.BACKING_INDEX_PREFIX)) {,\nbecause this should only be applied when a backing index is created (and otherwise a regular create index call and if a template matches with a 'data_stream' definition would get this mapping applied as well).", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452067877", "createdAt": "2020-07-09T08:56:26Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -954,11 +964,16 @@ public static String findV2Template(Metadata metadata, String indexName, boolean\n             .map(ComponentTemplate::template)\n             .map(Template::mappings)\n             .filter(Objects::nonNull)\n-            .collect(Collectors.toList());\n+            .collect(Collectors.toCollection(LinkedList::new));\n         // Add the actual index template's mappings, since it takes the highest precedence\n         Optional.ofNullable(template.template())\n             .map(Template::mappings)\n             .ifPresent(mappings::add);\n+        if (template.getDataStreamTemplate() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA3NTU0NQ==", "bodyText": "These are good tests. Maybe also add another test that tests that a user adds a mapping for @timestamp in a composable index template?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452075545", "createdAt": "2020-07-09T09:09:32Z", "author": {"login": "martijnvg"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateServiceTests.java", "diffHunk": "@@ -795,6 +797,97 @@ public void testResolveMappings() throws Exception {\n             equalTo(Map.of(\"_doc\", Map.of(\"properties\", Map.of(\"field3\", Map.of(\"type\", \"integer\"))))));\n     }\n \n+    public void testDefinedTimestampMappingIsAddedForDataStreamTemplates() throws Exception {\n+        final MetadataIndexTemplateService service = getMetadataIndexTemplateService();\n+        ClusterState state = ClusterState.EMPTY_STATE;\n+\n+        ComponentTemplate ct1 = new ComponentTemplate(new Template(null,\n+            new CompressedXContent(\"{\\n\" +\n+                \"      \\\"properties\\\": {\\n\" +\n+                \"        \\\"field1\\\": {\\n\" +\n+                \"          \\\"type\\\": \\\"keyword\\\"\\n\" +\n+                \"        }\\n\" +\n+                \"      }\\n\" +\n+                \"    }\"), null), null, null);\n+\n+        state = service.addComponentTemplate(state, true, \"ct1\", ct1);\n+        ComposableIndexTemplate it = new ComposableIndexTemplate(List.of(\"i*\"),\n+            new Template(null,\n+                new CompressedXContent(\"{\\n\" +\n+                    \"    \\\"properties\\\": {\\n\" +\n+                    \"      \\\"field2\\\": {\\n\" +\n+                    \"        \\\"type\\\": \\\"integer\\\"\\n\" +\n+                    \"      }\\n\" +\n+                    \"    }\\n\" +\n+                    \"  }\"), null),\n+            List.of(\"ct1\"), 0L, 1L, null, new ComposableIndexTemplate.DataStreamTemplate(DEFAULT_TIMESTAMP_FIELD));\n+        state = service.addIndexTemplateV2(state, true, \"my-template\", it);\n+\n+        List<CompressedXContent> mappings = MetadataIndexTemplateService.collectMappings(state, \"my-template\", \"my-index\",\n+            xContentRegistry());\n+\n+        assertNotNull(mappings);\n+        assertThat(mappings.size(), equalTo(3));\n+        List<Map<String, Object>> parsedMappings = mappings.stream()\n+            .map(m -> {\n+                try {\n+                    return MapperService.parseMapping(new NamedXContentRegistry(List.of()), m.string());\n+                } catch (Exception e) {\n+                    logger.error(e);\n+                    fail(\"failed to parse mappings: \" + m.string());\n+                    return null;\n+                }\n+            })\n+            .collect(Collectors.toList());\n+\n+        assertThat(parsedMappings.get(0),\n+            equalTo(Map.of(\"_doc\", Map.of(\"properties\", Map.of(DEFAULT_TIMESTAMP_FIELD, Map.of(\"type\", \"date\"))))));\n+        assertThat(parsedMappings.get(1),\n+            equalTo(Map.of(\"_doc\", Map.of(\"properties\", Map.of(\"field1\", Map.of(\"type\", \"keyword\"))))));\n+        assertThat(parsedMappings.get(2),\n+            equalTo(Map.of(\"_doc\", Map.of(\"properties\", Map.of(\"field2\", Map.of(\"type\", \"integer\"))))));\n+    }\n+\n+    public void testUserDefinedMappingTakesPrecedenceOverDefault() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA3NzA0Ng==", "bodyText": "maybe include the mapping snippet or that a date field with default options is then used?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452077046", "createdAt": "2020-07-09T09:12:06Z", "author": {"login": "martijnvg"}, "path": "docs/reference/data-streams/set-up-a-data-stream.asciidoc", "diffHunk": "@@ -134,16 +134,22 @@ this pattern.\n property. The `@timestamp` field must be included in every document indexed to\n the data stream.\n \n-* A <<date,`date`>> or <<date_nanos,`date_nanos`>> field mapping for the\n-`@timestamp` field.\n+The template can also contain:\n+\n+* An optional field mapping for the `@timestamp` field. Both the <<date,`date`>> and \n+<<date_nanos,`date_nanos`>> field data types are supported. If no mapping is specified,\n+the <<date,`date`>> field data type is used by default.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6de98d4b3c48a140d62b020e9c72d19d01b9dd4"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA3ODY2MQ==", "bodyText": "Maybe in the Create data stream yaml test, also check that mapping for the backing index of each data streams to have the correct mapping?", "url": "https://github.com/elastic/elasticsearch/pull/59244#discussion_r452078661", "createdAt": "2020-07-09T09:14:52Z", "author": {"login": "martijnvg"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/indices.data_stream/10_basic.yml", "diffHunk": "@@ -28,7 +24,7 @@ setup:\n             mappings:\n               properties:\n                 '@timestamp':\n-                  type: date\n+                  type: date_nanos", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcyNjk5MA=="}, "originalCommit": {"oid": "c5e73b776884be4ebd5ba87c783bcf5e0a162644"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae6dab8005984f27bda2448a3c4efcbfe5df0d67", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae6dab8005984f27bda2448a3c4efcbfe5df0d67", "committedDate": "2020-07-09T10:58:49Z", "message": "Add @timestamp mapping only for backing indices"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57403c350f2c356ac1bb022f4bb470bfd69d1899", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/57403c350f2c356ac1bb022f4bb470bfd69d1899", "committedDate": "2020-07-09T11:00:49Z", "message": "DOCS: mention the default date field used has the default options"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d24c886f34a075530600ea3139a4c5f6d16d2d6a", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/d24c886f34a075530600ea3139a4c5f6d16d2d6a", "committedDate": "2020-07-09T11:53:09Z", "message": "YAML test: assert timestamp field mapping type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDYxNzU5", "url": "https://github.com/elastic/elasticsearch/pull/59244#pullrequestreview-447061759", "createdAt": "2020-07-13T09:01:32Z", "commit": {"oid": "d24c886f34a075530600ea3139a4c5f6d16d2d6a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "009dc356d4613a23ab800df7986708cb5bf0800c", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/009dc356d4613a23ab800df7986708cb5bf0800c", "committedDate": "2020-07-13T16:36:24Z", "message": "Merge branch 'master' into composable-templates-default-timestamp-mapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b3c0663e4de1f2ef0b930a7f9905144f342270c", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b3c0663e4de1f2ef0b930a7f9905144f342270c", "committedDate": "2020-07-13T17:20:53Z", "message": "Fix merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20343bed1b2ce84752e63d3f81596038afabc51a", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/20343bed1b2ce84752e63d3f81596038afabc51a", "committedDate": "2020-07-13T17:29:50Z", "message": "Fix test after merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d254ea6e7b467dbd8918cd72f6cbbd0d46114084", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/d254ea6e7b467dbd8918cd72f6cbbd0d46114084", "committedDate": "2020-07-13T17:42:47Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97a2a59870aeb4b34e3ac222d72d958fc8139f91", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/97a2a59870aeb4b34e3ac222d72d958fc8139f91", "committedDate": "2020-07-13T18:56:06Z", "message": "Merge branch 'master' into composable-templates-default-timestamp-mapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bf89f81428fb2f5ce29b05fd432dc47fea9408a", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/9bf89f81428fb2f5ce29b05fd432dc47fea9408a", "committedDate": "2020-07-13T18:59:17Z", "message": "Disable bwc tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2063, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}