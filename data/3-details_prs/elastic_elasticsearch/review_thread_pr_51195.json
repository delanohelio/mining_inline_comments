{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NTM0NTc3", "number": 51195, "reviewThreads": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjo0ODoyM1rODZHIbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNTo0Mjo1MFrODbG1qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjU3ODM2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjo0ODoyM1rOFfUu1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMjoyMToyOFrOFfcqKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTg0Ng==", "bodyText": "I would prefer the order be a primitive, and we resolve the order from the settings in the original constructor.\nBehaviours around if this parameter is null, do this other thing can end up getting quite confusing in a large code base.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368389846", "createdAt": "2020-01-20T06:48:23Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n-        this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        if (order != null) {\n+            this.order = order;\n+        } else if (order == null && hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"\n+            );\n+        } else {\n+            this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5MjYxNw==", "bodyText": "I agree null is a hack. But there is no easy way to tell whether a primitive value is indeed missing.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368392617", "createdAt": "2020-01-20T07:00:30Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n-        this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        if (order != null) {\n+            this.order = order;\n+        } else if (order == null && hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"\n+            );\n+        } else {\n+            this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTg0Ng=="}, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxOTcyMA==", "bodyText": "Changed to int.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368519720", "createdAt": "2020-01-20T12:21:28Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n-        this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        if (order != null) {\n+            this.order = order;\n+        } else if (order == null && hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"\n+            );\n+        } else {\n+            this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTg0Ng=="}, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjU3ODgzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjo0ODo0MVrOFfUvHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNzowNTo0MFrOFfU-Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTkxNg==", "bodyText": "I think it would be better for this constructor to be  protected, and update the tests to pass through real Settings object with an order config.\nI know that's going to be a pain - so please feel free to convince me if you feel otherwise.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368389916", "createdAt": "2020-01-20T06:48:41Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5MjgxNA==", "bodyText": "Are you suggesting the caller should create a Settings object that actually includes an order? In this case, this constructor is no longer necessary? Am I getting this right?", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368392814", "createdAt": "2020-01-20T07:01:25Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTkxNg=="}, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5Mzc1NQ==", "bodyText": "I initially actual prefer to not adding another constructor. But the number of call site changes made me change my mind. But I am happy to drop the constructor and make more call site changes if you favour this approach. Please let me know. Thanks", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368393755", "createdAt": "2020-01-20T07:05:40Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTkxNg=="}, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjU4ODYzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjo1NToyOFrOFfU1Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMjoyMDo0NFrOFfco6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5MTQ0Ng==", "bodyText": "Do we have a test for this validation (e.g. RealmSettingsTests) ?\nI can't see one, but given the number of tests changes, I may have missed it.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368391446", "createdAt": "2020-01-20T06:55:28Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n-        this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        if (order != null) {\n+            this.order = order;\n+        } else if (order == null && hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5MzExNA==", "bodyText": "I haven't added the tests yet mainly because I was not sure how the change will turn out (e.g. the above discussion may result in implementation change). I'll add them once I am certain about the changes.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368393114", "createdAt": "2020-01-20T07:02:36Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n-        this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        if (order != null) {\n+            this.order = order;\n+        } else if (order == null && hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5MTQ0Ng=="}, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUxOTQwMA==", "bodyText": "Tests added.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368519400", "createdAt": "2020-01-20T12:20:44Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n-        this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        if (order != null) {\n+            this.order = order;\n+        } else if (order == null && hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5MTQ0Ng=="}, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjM4MjI0OnYy", "diffSide": "RIGHT", "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMjo1OTo0M1rOFgLp0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMjo1OTo0M1rOFgLp0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4OTY4MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            specified for each explicitly configured realms. Their values must be unique.\n          \n          \n            \n            specified for each explicitly configured realm. Each value must be unique.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369289681", "createdAt": "2020-01-21T22:59:43Z", "author": {"login": "lcawl"}, "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "diffHunk": "@@ -6,6 +6,29 @@\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[float]\n+==== The realm `order` setting is required\n+\n+The `xpack.security.authc.realms.*.*.order` setting is now required and must be\n+specified for each explicitly configured realms. Their values must be unique.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0edef24288aa20268d3425aa5a165265a115e54b"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjQyMTQ5OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzoxODozNlrOFgMCJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzoyOToxOFrOFgMP1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI5NTkxMA==", "bodyText": "There's another line in this file that I think should be changed:\n\nIf you are configuring multiple realms, you should also explicitly set the order attribute ....\n\nI think it should be changed to \"you must also explicitly set the order attribute\".", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369295910", "createdAt": "2020-01-21T23:18:36Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "diffHunk": "@@ -206,6 +206,7 @@ xpack:\n       realms:\n         ldap:\n           ldap1:\n+            order: 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b439a49c8a68cf6dad8823261db77c44b7361326"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI5OTQxMg==", "bodyText": "Good catch. Will update. Thanks", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369299412", "createdAt": "2020-01-21T23:29:18Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "diffHunk": "@@ -206,6 +206,7 @@ xpack:\n       realms:\n         ldap:\n           ldap1:\n+            order: 0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI5NTkxMA=="}, "originalCommit": {"oid": "b439a49c8a68cf6dad8823261db77c44b7361326"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjY2Mzk5OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMTozOTozM1rOFgOTvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMzoxMDozOVrOFgPdXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzMzE4MQ==", "bodyText": "This page also has the following:\n\nIf you are configuring multiple realms, you should explicitly set the order attribute.\n\n... which I think should be changed to \"you must explicitly set the order attribute...\"", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369333181", "createdAt": "2020-01-22T01:39:33Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -61,6 +61,7 @@ xpack:\n       realms:\n         pki:\n           pki1:\n+            order: 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a74482efa5defac9be29c193e7bc60a0426a9f31"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1MDI4Mw==", "bodyText": "Thanks. It's updated now. I also searched through the documentations to make sure there is no similar situation like this anymore.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369350283", "createdAt": "2020-01-22T03:01:10Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -61,6 +61,7 @@ xpack:\n       realms:\n         pki:\n           pki1:\n+            order: 1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzMzE4MQ=="}, "originalCommit": {"oid": "a74482efa5defac9be29c193e7bc60a0426a9f31"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1MjAxNQ==", "bodyText": "Here are the similar changes that are made based on above search result", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369352015", "createdAt": "2020-01-22T03:10:32Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -61,6 +61,7 @@ xpack:\n       realms:\n         pki:\n           pki1:\n+            order: 1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzMzE4MQ=="}, "originalCommit": {"oid": "a74482efa5defac9be29c193e7bc60a0426a9f31"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTM1MjAzMA==", "bodyText": "994c0af", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369352030", "createdAt": "2020-01-22T03:10:39Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -61,6 +61,7 @@ xpack:\n       realms:\n         pki:\n           pki1:\n+            order: 1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzMzE4MQ=="}, "originalCommit": {"oid": "a74482efa5defac9be29c193e7bc60a0426a9f31"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NzU0NTU5OnYy", "diffSide": "RIGHT", "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMjo0NzozM1rOFg88AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMTo1ODozMFrOFhOA_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NzE1Mw==", "bodyText": "typo: \"relams\" -> \"realms\" (ditto underneath)", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370097153", "createdAt": "2020-01-23T12:47:33Z", "author": {"login": "albertzaharovits"}, "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "diffHunk": "@@ -6,6 +6,29 @@\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[float]\n+==== The realm `order` setting is required\n+\n+The `xpack.security.authc.realms.*.*.order` setting is now required and must be\n+specified for each explicitly configured realm. Each value must be unique.\n+The cluster will fail to start if the requirements are not met.\n+\n+For example, the following configuration is invalid:\n+[source,yaml]\n+--------------------------------------------------\n+xpack.security.authc.relams.kerberos.kerb1:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM3Njk1OQ==", "bodyText": "Good catch thanks!", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370376959", "createdAt": "2020-01-23T21:58:30Z", "author": {"login": "ywangd"}, "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "diffHunk": "@@ -6,6 +6,29 @@\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[float]\n+==== The realm `order` setting is required\n+\n+The `xpack.security.authc.realms.*.*.order` setting is now required and must be\n+specified for each explicitly configured realm. Each value must be unique.\n+The cluster will fail to start if the requirements are not met.\n+\n+For example, the following configuration is invalid:\n+[source,yaml]\n+--------------------------------------------------\n+xpack.security.authc.relams.kerberos.kerb1:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NzE1Mw=="}, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODEwMTY5OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/security/authentication/configuring-active-directory-realm.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNToyMzo0NlrOFhCNQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMTo1OToxOFrOFhOCZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4MzQ5MA==", "bodyText": "Technically, you must set the order even if not configuring multiple realms. I would remove this phrase altogether. (same in other places too)", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370183490", "createdAt": "2020-01-23T15:23:46Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/configuring-active-directory-realm.asciidoc", "diffHunk": "@@ -4,7 +4,7 @@ realm and map Active Directory users and groups to roles in the role mapping fil\n . Add a realm configuration of type `active_directory` to `elasticsearch.yml`\n under the `xpack.security.authc.realms.active_directory` namespace.\n At a minimum, you must specify the Active Directory `domain_name`.\n-If you are configuring multiple realms, you should also \n+If you are configuring multiple realms, you must also \n explicitly set the `order` attribute to control the order in which the realms \n are consulted during authentication. \n +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM3NzMxNg==", "bodyText": "Makes sense will do", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370377316", "createdAt": "2020-01-23T21:59:18Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authentication/configuring-active-directory-realm.asciidoc", "diffHunk": "@@ -4,7 +4,7 @@ realm and map Active Directory users and groups to roles in the role mapping fil\n . Add a realm configuration of type `active_directory` to `elasticsearch.yml`\n under the `xpack.security.authc.realms.active_directory` namespace.\n At a minimum, you must specify the Active Directory `domain_name`.\n-If you are configuring multiple realms, you should also \n+If you are configuring multiple realms, you must also \n explicitly set the `order` attribute to control the order in which the realms \n are consulted during authentication. \n +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4MzQ5MA=="}, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODM1NjQ3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjozMjowOFrOFhEvEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzo0Mzo1MFrOFiLmPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNDkxNA==", "bodyText": "I would've probably made a different choice of where to place this check because we pass RealmConfigs around in too many places. For example, this:\n\nwill throw an exception in InternalRealms.getBootstrapChecks so the stacktrace for it is funky.\nwill throw an exception in the SamlMetadataCommand which is not nice, although it might not happen in practice too often.\n\nI would've probably removed the order and enabled local vars and do the checks in Realms#initRealms. But there might be subtle problems in that case as well.\nNevertheless, this does the job, and looks OK, to me.\nNit: we use the reverse form for negative condition, i.e. false == <function> (unless we are in some few older files that use a different convention in which case we blend with the background).", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370224914", "createdAt": "2020-01-23T16:32:08Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -27,9 +27,24 @@ public RealmConfig(RealmIdentifier identifier, Settings settings, Environment en\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n+        this.threadContext = threadContext;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        if (hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxODU2MQ==", "bodyText": "I am also tempted to move the logic into Reamls#initRealms (see below) comments for details. But your examples show that by itself is not sufficient. Both of the two examples are not covered if the logic is just in Realms#initRealms, while they do get covered if the logic is in RealmConfig. I am now again unsure about what would be the better approach.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370418561", "createdAt": "2020-01-24T00:04:51Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -27,9 +27,24 @@ public RealmConfig(RealmIdentifier identifier, Settings settings, Environment en\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n+        this.threadContext = threadContext;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        if (hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNDkxNA=="}, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4NTkxNg==", "bodyText": "Maybe I've not made myself clear\n\nwill throw an exception in InternalRealms.getBootstrapChecks so the stacktrace for it is funky.\n\nI mean that there is a minor inconvenience that the validation that the order parameter is defined is performed inside a different code than the code that deals with realm construction.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371385916", "createdAt": "2020-01-27T17:43:50Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -27,9 +27,24 @@ public RealmConfig(RealmIdentifier identifier, Settings settings, Environment en\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n+        this.threadContext = threadContext;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        if (hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNDkxNA=="}, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODM4MjIwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjozODo1MlrOFhE-wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxODoyNToyOFrOFiMzwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyODkyOA==", "bodyText": "Not to dwell on it too much, but just because we need this new constructor is a smell. In this case, the order local var is sometimes the value from the settings, and sometimes a different one passed by this constructor. I know this is only used in tests, but it's still not nice to have to deal with it (Integer.MAX_VALUE).", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370228928", "createdAt": "2020-01-23T16:38:52Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -27,9 +27,24 @@ public RealmConfig(RealmIdentifier identifier, Settings settings, Environment en\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n+        this.threadContext = threadContext;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        if (hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"\n+            );\n+        }\n         this.order = getSetting(RealmSettings.ORDER_SETTING);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, int order) {\n+        this.identifier = identifier;\n+        this.settings = settings;\n+        this.env = env;\n         this.threadContext = threadContext;\n+        this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        this.order = order;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM3NDY1NQ==", "bodyText": "The new constructor is mostly used by test code, but it is also used by production code, see Realms and ReservedRealm.\nI also think adding a new constructor is not ideal due to some of the concerns you mention. It however seems to be a better choice comparing to the other choice, i.e. Add order into the settings parameter on caller side so that it can just keep using the existing constructor.\nThis approach should work fine for tests. But in production code, the settings object is referenced in many other classes, e.g. Environment, Realms, etc. So when adding FileRealm (in Realms.java), if we modify the settings object to add order, we will need to do something like the follows:\nvar newSettings = Settings.Builder().put(settings).build();\n... new RealmConfig(..., newSetings, ...), ...;\nSo the newSettings is now passed into RealmConfig which will store a reference to it. Now we have two Settings object across the application. They are mostly identical, only differs in the order parameter. And this is just FileRealm, the same applies to native realm, for which we will have a third settings. I personally think this is worse than adding a new constructor. That is why the new constructor is added so we can avoid manipulating the settings object.\nWith above being said, I realise it is making an assumption that the logic for mandating the order setting resides in the RealmConfig class. If we can move away from this assumption, like you suggested, enforce the logic in Realms.initRealms, we can probably make the change set much smaller.\nInitially I thought about adding the logic into Security but that was too high level. So we decided to add it in RealmConfig itself, where it is low level the logic is close to its natural owner. But maybe we need something in between. Realms could be the right candidate especially it is where the order uniqueness is enforced.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370374655", "createdAt": "2020-01-23T21:52:46Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -27,9 +27,24 @@ public RealmConfig(RealmIdentifier identifier, Settings settings, Environment en\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n+        this.threadContext = threadContext;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        if (hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"\n+            );\n+        }\n         this.order = getSetting(RealmSettings.ORDER_SETTING);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, int order) {\n+        this.identifier = identifier;\n+        this.settings = settings;\n+        this.env = env;\n         this.threadContext = threadContext;\n+        this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        this.order = order;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyODkyOA=="}, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQwNTc2MQ==", "bodyText": "My choice would also be to only inspect the order setting inRealms#initRealms (where the order value duplication is checked). That's because the order is only really used in that place, specifying the initial order in the realm chain (which would then change as we reorder the chain during authentications), so it's not suitable as a final local variable.\nThis way we would also avoid having to specify the order parameter for the \"default\" realms (file and native) which is simply ignored anyways.\nYour approach works as well and I can't argue strongly against it, so this LGTM to me even though I would've approached it differently.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371405761", "createdAt": "2020-01-27T18:25:28Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -27,9 +27,24 @@ public RealmConfig(RealmIdentifier identifier, Settings settings, Environment en\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n+        this.threadContext = threadContext;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        if (hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"\n+            );\n+        }\n         this.order = getSetting(RealmSettings.ORDER_SETTING);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, int order) {\n+        this.identifier = identifier;\n+        this.settings = settings;\n+        this.env = env;\n         this.threadContext = threadContext;\n+        this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        this.order = order;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyODkyOA=="}, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODM5ODc4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjo0MzozMVrOFhFI9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMDowNjowOVrOFhQk4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzMTU0Mg==", "bodyText": "I think the error message that you're building downstream calls for realm names, and not for setting keys.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370231542", "createdAt": "2020-01-23T16:43:31Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -218,9 +219,13 @@ public Realm realm(String name) {\n             Realm realm = factory.create(config);\n             nameToRealmIdentifier.computeIfAbsent(realm.name(), k ->\n                 new HashSet<>()).add(RealmSettings.realmSettingPrefix(realm.type()) + realm.name());\n+            orderToRealmIdentifier.computeIfAbsent(realm.order(), k -> new HashSet<>())\n+                .add(RealmSettings.realmSettingPrefix(realm.type()) + realm.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxODkxNQ==", "bodyText": "Good point. I'll make them consistent.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370418915", "createdAt": "2020-01-24T00:06:09Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -218,9 +219,13 @@ public Realm realm(String name) {\n             Realm realm = factory.create(config);\n             nameToRealmIdentifier.computeIfAbsent(realm.name(), k ->\n                 new HashSet<>()).add(RealmSettings.realmSettingPrefix(realm.type()) + realm.name());\n+            orderToRealmIdentifier.computeIfAbsent(realm.order(), k -> new HashSet<>())\n+                .add(RealmSettings.realmSettingPrefix(realm.type()) + realm.name());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzMTU0Mg=="}, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODQxODEwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/test/SecuritySettingsSource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjo0OTowMVrOFhFUwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMDowODozMFrOFhQnZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzNDU2MQ==", "bodyText": "Why is this necessary? If it isn't, I would steer clear of such changes, it's not productive to start contingent discussions on other topics than the scope of this PR.\nIf you wish we discuss the topic of negative values for the order argument we should do so under a new issue.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370234561", "createdAt": "2020-01-23T16:49:01Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/test/SecuritySettingsSource.java", "diffHunk": "@@ -141,8 +141,8 @@ public Settings nodeSettings(int nodeOrdinal) {\n                 .put(LoggingAuditTrail.EMIT_HOST_NAME_SETTING.getKey(), randomBoolean())\n                 .put(LoggingAuditTrail.EMIT_NODE_NAME_SETTING.getKey(), randomBoolean())\n                 .put(LoggingAuditTrail.EMIT_NODE_ID_SETTING.getKey(), randomBoolean())\n-                .put(\"xpack.security.authc.realms.\" + FileRealmSettings.TYPE + \".file.order\", 0)\n-                .put(\"xpack.security.authc.realms.\" + NativeRealmSettings.TYPE + \".index.order\", \"1\")\n+                .put(\"xpack.security.authc.realms.\" + FileRealmSettings.TYPE + \".file.order\", Integer.MIN_VALUE)\n+                .put(\"xpack.security.authc.realms.\" + NativeRealmSettings.TYPE + \".index.order\", String.valueOf(Integer.MIN_VALUE + 1))\n                 .put(\"xpack.license.self_generated.type\", \"trial\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQxOTU1OQ==", "bodyText": "You are right. I think I edited the wrong file. Nevermind, I'll get rid of them. Thanks", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370419559", "createdAt": "2020-01-24T00:08:30Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/test/SecuritySettingsSource.java", "diffHunk": "@@ -141,8 +141,8 @@ public Settings nodeSettings(int nodeOrdinal) {\n                 .put(LoggingAuditTrail.EMIT_HOST_NAME_SETTING.getKey(), randomBoolean())\n                 .put(LoggingAuditTrail.EMIT_NODE_NAME_SETTING.getKey(), randomBoolean())\n                 .put(LoggingAuditTrail.EMIT_NODE_ID_SETTING.getKey(), randomBoolean())\n-                .put(\"xpack.security.authc.realms.\" + FileRealmSettings.TYPE + \".file.order\", 0)\n-                .put(\"xpack.security.authc.realms.\" + NativeRealmSettings.TYPE + \".index.order\", \"1\")\n+                .put(\"xpack.security.authc.realms.\" + FileRealmSettings.TYPE + \".file.order\", Integer.MIN_VALUE)\n+                .put(\"xpack.security.authc.realms.\" + NativeRealmSettings.TYPE + \".index.order\", String.valueOf(Integer.MIN_VALUE + 1))\n                 .put(\"xpack.license.self_generated.type\", \"trial\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzNDU2MQ=="}, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTkwOTAwOnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzowOToxNFrOFiKglA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMjo0MDozNVrOFiT_eQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2ODA4NA==", "bodyText": "This last phrase doesn't make sense, I would avoid describing again what order does.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371368084", "createdAt": "2020-01-27T17:09:14Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "diffHunk": "@@ -21,10 +21,9 @@ However, multiple bind operations might be needed to find the correct user DN.\n \n .. Add a realm configuration of to `elasticsearch.yml` under the\n `xpack.security.authc.realms.ldap` namespace. At a minimum, you must specify\n-the `url` of the LDAP server, and set `user_search.base_dn` to the container DN\n-where the users are searched for.\n-If you are configuring multiple realms, you should also explicitly set the\n-`order` attribute to control the order in which the realms are consulted during \n+the `url` and `order` of the LDAP server, and set `user_search.base_dn` to the\n+container DN where the users are searched for.\n+The `order` attribute to control the order in which the realms are consulted during \n authentication. See <<ref-ldap-settings>> for all of the options you can set for ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMzQ0OQ==", "bodyText": "Will do thanks", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371523449", "createdAt": "2020-01-27T22:40:35Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "diffHunk": "@@ -21,10 +21,9 @@ However, multiple bind operations might be needed to find the correct user DN.\n \n .. Add a realm configuration of to `elasticsearch.yml` under the\n `xpack.security.authc.realms.ldap` namespace. At a minimum, you must specify\n-the `url` of the LDAP server, and set `user_search.base_dn` to the container DN\n-where the users are searched for.\n-If you are configuring multiple realms, you should also explicitly set the\n-`order` attribute to control the order in which the realms are consulted during \n+the `url` and `order` of the LDAP server, and set `user_search.base_dn` to the\n+container DN where the users are searched for.\n+The `order` attribute to control the order in which the realms are consulted during \n authentication. See <<ref-ldap-settings>> for all of the options you can set for ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2ODA4NA=="}, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTkxMjI4OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxMDoyMVrOFiKimw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMjo0MDoxOFrOFiT_BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2ODYwMw==", "bodyText": "I would remove\n\nIf you are configuring multiple realms, you must ...\n\naltogether.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371368603", "createdAt": "2020-01-27T17:10:21Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "diffHunk": "@@ -73,7 +72,7 @@ realms you specify are used for authentication. If you also want to use the\n .. Add a realm configuration to `elasticsearch.yml` in the\n `xpack.security.authc.realms.ldap` namespace. At a minimum, you must specify\n the `url` of the LDAP server, and specify at least one template with the\n-`user_dn_templates` option. If you are configuring multiple realms, you should\n+`user_dn_templates` option. If you are configuring multiple realms, you must\n also explicitly set the `order` attribute to control the order in which the\n realms are consulted during authentication.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUyMzMzMg==", "bodyText": "Somehow missed this occurrence ... Will remove. Thanks", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371523332", "createdAt": "2020-01-27T22:40:18Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "diffHunk": "@@ -73,7 +72,7 @@ realms you specify are used for authentication. If you also want to use the\n .. Add a realm configuration to `elasticsearch.yml` in the\n `xpack.security.authc.realms.ldap` namespace. At a minimum, you must specify\n the `url` of the LDAP server, and specify at least one template with the\n-`user_dn_templates` option. If you are configuring multiple realms, you should\n+`user_dn_templates` option. If you are configuring multiple realms, you must\n also explicitly set the `order` attribute to control the order in which the\n realms are consulted during authentication.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2ODYwMw=="}, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTkxNzY5OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/security/authentication/custom-realm.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxMjowM1rOFiKmEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxMjowM1rOFiKmEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2OTQ4OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            that two or more realms have the same `order`, the cluster will fail to start.\n          \n          \n            \n            that two or more realms have the same `order`, the node will fail to start.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371369488", "createdAt": "2020-01-27T17:12:03Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/custom-realm.asciidoc", "diffHunk": "@@ -89,11 +89,10 @@ under the `xpack.security.authc.realms` namespace.\n You must define your realm within the namespace that matchesto the type defined\n by the extension.\n The options you can set depend on the settings exposed by the custom realm.\n-If you are configuring multiple realms, you should also explicitly set the\n-`order` attribute to control the order in which the realms are consulted during\n-authentication. You should make sure each configured realm has a distinct\n-`order` setting. In the event that two or more realms have the same `order`,\n-they will be processed in realm `name` order.\n+At a minimum, you must explicitly set the `order` attribute to control the\n+order in which the realms are consulted during authentication. You must also\n+make sure each configured realm has a distinct `order` setting. In the event\n+that two or more realms have the same `order`, the cluster will fail to start.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTkxOTM2OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/security/authentication/realm-chains.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxMjozMlrOFiKnCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxMjozMlrOFiKnCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2OTczNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            the cluster will fail to start.\n          \n          \n            \n            the node will fail to start.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371369737", "createdAt": "2020-01-27T17:12:32Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/realm-chains.asciidoc", "diffHunk": "@@ -5,9 +5,9 @@\n <<realms,Realms>> live within a _realm chain_. It is essentially a prioritized\n list of configured realms (typically of various types). Realms are consulted in\n ascending order (that is to say, the realm with the lowest `order` value is\n-consulted first). You should make sure each configured realm has a distinct\n+consulted first). You must make sure each configured realm has a distinct\n `order` setting. In the event that two or more realms have the same `order`,\n-they are processed in `name` order.\n+the cluster will fail to start.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzQ5NjYwOnYy", "diffSide": "RIGHT", "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNTozODoyN1rOFiZuyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNTozODoyN1rOFiZuyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxNzQ4MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The `xpack.security.authc.realms.*.*.order` setting is now required and must be\n          \n          \n            \n            The `xpack.security.authc.realms.{type}.{name}.order` setting is now required and must be", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371617480", "createdAt": "2020-01-28T05:38:27Z", "author": {"login": "tvernum"}, "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "diffHunk": "@@ -6,6 +6,29 @@\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[float]\n+==== The realm `order` setting is required\n+\n+The `xpack.security.authc.realms.*.*.order` setting is now required and must be", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43fffa3b1f5fdb979dc1b6676732340ed3f0ca17"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzUwMTg2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNTo0Mjo1MFrOFiZxxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNTo0Mjo1MFrOFiZxxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxODI0Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Found multiple realms configured with the same order: \" + duplicateOrders + \"\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"Found multiple realms configured with the same order: \" + duplicateOrders);", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371618247", "createdAt": "2020-01-28T05:42:50Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -305,15 +310,34 @@ public void usageStats(ActionListener<Map<String, Object>> listener) {\n     private void addNativeRealms(List<Realm> realms) throws Exception {\n         Realm.Factory fileRealm = factories.get(FileRealmSettings.TYPE);\n         if (fileRealm != null) {\n+            var realmIdentifier = new RealmConfig.RealmIdentifier(FileRealmSettings.TYPE, \"default_\" + FileRealmSettings.TYPE);\n             realms.add(fileRealm.create(new RealmConfig(\n-                    new RealmConfig.RealmIdentifier(FileRealmSettings.TYPE, \"default_\" + FileRealmSettings.TYPE),\n-                    settings, env, threadContext)));\n+                realmIdentifier,\n+                ensureOrderSetting(settings, realmIdentifier, Integer.MIN_VALUE + 1),\n+                env, threadContext)));\n         }\n         Realm.Factory indexRealmFactory = factories.get(NativeRealmSettings.TYPE);\n         if (indexRealmFactory != null) {\n+            var realmIdentifier = new RealmConfig.RealmIdentifier(NativeRealmSettings.TYPE, \"default_\" + NativeRealmSettings.TYPE);\n             realms.add(indexRealmFactory.create(new RealmConfig(\n-                    new RealmConfig.RealmIdentifier(NativeRealmSettings.TYPE, \"default_\" + NativeRealmSettings.TYPE),\n-                    settings, env, threadContext)));\n+                realmIdentifier,\n+                ensureOrderSetting(settings, realmIdentifier, Integer.MIN_VALUE + 2),\n+                env, threadContext)));\n+        }\n+    }\n+\n+    private Settings ensureOrderSetting(Settings settings, RealmConfig.RealmIdentifier realmIdentifier, int order) {\n+        String orderSettingKey = RealmSettings.realmSettingPrefix(realmIdentifier) + \"order\";\n+        return Settings.builder().put(settings).put(orderSettingKey, order).build();\n+    }\n+\n+    private void checkUniqueOrders(Map<Integer, Set<String>> orderToRealmName) {\n+        String duplicateOrders = orderToRealmName.entrySet().stream()\n+            .filter(entry -> entry.getValue().size() > 1)\n+            .map(entry -> entry.getKey() + \": \" + entry.getValue())\n+            .collect(Collectors.joining(\"; \"));\n+        if (Strings.hasText(duplicateOrders)) {\n+            throw new IllegalArgumentException(\"Found multiple realms configured with the same order: \" + duplicateOrders + \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43fffa3b1f5fdb979dc1b6676732340ed3f0ca17"}, "originalPosition": 57}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4554, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}