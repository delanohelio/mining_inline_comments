{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MzA2NjMy", "number": 55592, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOTozNDoyM1rOD1cQVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOTozNToxOVrOD1cRoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzY0MDUyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleInitialisationTests.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOTozNDoyM1rOGK4wrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxNTowNzozOFrOGLcNLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2ODkwOQ==", "bodyText": "Can you explain this change, just so I can better understand?", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414068909", "createdAt": "2020-04-23T19:34:23Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleInitialisationTests.java", "diffHunk": "@@ -44,7 +45,7 @@ public static void setupRepositoryPath() {\n     @Override\n     protected Settings nodeSettings() {\n         Settings.Builder settings = Settings.builder().put(super.nodeSettings());\n-        settings.put(XPackSettings.INDEX_LIFECYCLE_ENABLED.getKey(), false);\n+        settings.put(LifecycleSettings.LIFECYCLE_HISTORY_INDEX_ENABLED_SETTING.getKey(), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEzNzQzNQ==", "bodyText": "The idea is that the lifecycle history index is irrelevant to these tests, so it's less setup and teardown.", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414137435", "createdAt": "2020-04-23T21:30:09Z", "author": {"login": "williamrandolph"}, "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleInitialisationTests.java", "diffHunk": "@@ -44,7 +45,7 @@ public static void setupRepositoryPath() {\n     @Override\n     protected Settings nodeSettings() {\n         Settings.Builder settings = Settings.builder().put(super.nodeSettings());\n-        settings.put(XPackSettings.INDEX_LIFECYCLE_ENABLED.getKey(), false);\n+        settings.put(LifecycleSettings.LIFECYCLE_HISTORY_INDEX_ENABLED_SETTING.getKey(), false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2ODkwOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY0OTY0NQ==", "bodyText": "The tests run fine with this setting enabled, so I'll drop this line.", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414649645", "createdAt": "2020-04-24T15:07:38Z", "author": {"login": "williamrandolph"}, "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleInitialisationTests.java", "diffHunk": "@@ -44,7 +45,7 @@ public static void setupRepositoryPath() {\n     @Override\n     protected Settings nodeSettings() {\n         Settings.Builder settings = Settings.builder().put(super.nodeSettings());\n-        settings.put(XPackSettings.INDEX_LIFECYCLE_ENABLED.getKey(), false);\n+        settings.put(LifecycleSettings.LIFECYCLE_HISTORY_INDEX_ENABLED_SETTING.getKey(), false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2ODkwOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzY0Mzg0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "isResolved": false, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOTozNToxOVrOGK4ytQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwNjoxMDozMFrOGMSULg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ==", "bodyText": "Can we remove ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM and STATS_TEMPLATE_NO_ILM now?", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414069429", "createdAt": "2020-04-23T19:35:19Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEzODQ3OA==", "bodyText": "I will reach out to someone from ML to see if this change is OK, but I would guess that we will be able to remove those templates.\n\n get feedback from someone on ML for removing NO_ILM templates", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414138478", "createdAt": "2020-04-23T21:32:04Z", "author": {"login": "williamrandolph"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY0NTUyOA==", "bodyText": "@dimitris-athanasiou and @przemekwitek have confirmed that these templates can be removed.", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414645528", "createdAt": "2020-04-24T15:02:08Z", "author": {"login": "williamrandolph"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY0NzEwMA==", "bodyText": "(Przemek from ML team): I think it is ok to remove the non-ILM versions.\nOnce only ILM versions exist, it would be good to inline the variables into the .json files but if you don't feel like doing it, I can do it as a followup PR.", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414647100", "createdAt": "2020-04-24T15:04:16Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDcwMDE4Mw==", "bodyText": "@przemekwitek Do you mean like this?\n    private static IndexTemplateConfig stateTemplate() {\n        Map<String, String> variables = new HashMap<>();\n        variables.put(VERSION_ID_PATTERN, String.valueOf(Version.CURRENT.id));\n        variables.put(\"xpack.ml.index.lifecycle.name\", ML_SIZE_BASED_ILM_POLICY_NAME);\n        variables.put(\"xpack.ml.index.rollover_alias.name\", AnomalyDetectorsIndex.jobStateIndexWriteAlias());\n\n        return new IndexTemplateConfig(AnomalyDetectorsIndexFields.STATE_INDEX_PREFIX,\n            ANOMALY_DETECTION_PATH + \"state_index_template.json\",\n            Version.CURRENT.id, VERSION_PATTERN,\n            variables);\n    }\n\n\u2026with this in the template json file?\n  \"settings\" : {\n    \"index\" : {\n      \"auto_expand_replicas\" : \"0-1\",\n      \"hidden\": true\n    },\n    \"index.lifecycle.name\": \"${xpack.ml.index.lifecycle.name}\",\n    \"index.lifecycle.rollover_alias\": \"${xpack.ml.index.rollover_alias.name}\"\n  },\n\nOr should the actual values be inlined as well?", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414700183", "createdAt": "2020-04-24T16:20:00Z", "author": {"login": "williamrandolph"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczMTA2NQ==", "bodyText": "Any of these 2 solutions work for me.\nIt's most important for me to get rid of syntax tokens (like comma \",\") which were just a hack to allow enabled/disabled duality.\nThe first one is more flexible so my preference goes there.", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414731065", "createdAt": "2020-04-24T17:09:41Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0Mjg3MA==", "bodyText": "I've pushed a commit with the first, more flexible strategy. Thanks for the feedback!", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414742870", "createdAt": "2020-04-24T17:28:50Z", "author": {"login": "williamrandolph"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0OTgxMg==", "bodyText": "Could you make the variable name the same for both templates?\nI.e. xpack.ml.index.lifecycle.name and xpack.ml.index.lifecycle.rollover_alias for both state and stats templates?", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r414749812", "createdAt": "2020-04-24T17:40:26Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE4NDY5Mg==", "bodyText": "Good catch. This is done.", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r415184692", "createdAt": "2020-04-26T01:27:07Z", "author": {"login": "williamrandolph"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTUzNjE3NA==", "bodyText": "Thank you!", "url": "https://github.com/elastic/elasticsearch/pull/55592#discussion_r415536174", "createdAt": "2020-04-27T06:10:30Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -125,15 +124,14 @@ private static IndexTemplateConfig statsTemplate(boolean ilmEnabled) {\n     public MlIndexTemplateRegistry(Settings nodeSettings, ClusterService clusterService, ThreadPool threadPool, Client client,\n                                    NamedXContentRegistry xContentRegistry) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        boolean ilmEnabled = XPackSettings.INDEX_LIFECYCLE_ENABLED.get(settings);\n         templatesToUse = Arrays.asList(\n             ANOMALY_DETECTION_RESULTS_TEMPLATE,\n-            ilmEnabled ? ANOMALY_DETECTION_STATE_TEMPLATE : ANOMALY_DETECTION_STATE_TEMPLATE_NO_ILM,\n+            ANOMALY_DETECTION_STATE_TEMPLATE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA2OTQyOQ=="}, "originalCommit": {"oid": "ad7186f1df3167f78e39054d5f9c6538c7dd328f"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2809, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}