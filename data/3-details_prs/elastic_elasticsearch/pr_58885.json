{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzMTI0MjQ0", "number": 58885, "title": "Implement rejections in `WriteMemoryLimits`", "bodyText": "This commit adds rejections when the indexing memory limits are\nexceeded for primary or coordinating operations. The amount of bytes\nallow for indexing is controlled by a new setting\nindices.write.limit.\nRelates #59263", "createdAt": "2020-07-02T00:51:30Z", "url": "https://github.com/elastic/elasticsearch/pull/58885", "merged": true, "mergeCommit": {"oid": "611fb03f6281852ce441bc9ffab18bb1d8911d89"}, "closed": true, "closedAt": "2020-07-08T17:01:29Z", "author": {"login": "tbrooks8"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwwMH-AH2gAyNDQzMTI0MjQ0OjM5N2Y3OGRlNzZjMzhkMGVkMjZmZGEwYWFlY2NjM2FhMzdkNzliMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy8huPAH2gAyNDQzMTI0MjQ0OjI0M2RlMzU5MmY4YTdhNGM2NDk1MzI5ZGJhOWVhNWE5Y2Y2YjUxYjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "397f78de76c38d0ed26fda0aaeccc3aa37d79b1b", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/397f78de76c38d0ed26fda0aaeccc3aa37d79b1b", "committedDate": "2020-07-01T20:23:08Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d7057034ba73bef8b56ca6c7143c6c1f7e44c8", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/00d7057034ba73bef8b56ca6c7143c6c1f7e44c8", "committedDate": "2020-07-02T00:48:49Z", "message": "Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57fab742edaba0700f263b31198f85af97f21912", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/57fab742edaba0700f263b31198f85af97f21912", "committedDate": "2020-07-02T01:58:05Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1292822b9404500b188df1c14c8f5c9c0b520cfa", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/1292822b9404500b188df1c14c8f5c9c0b520cfa", "committedDate": "2020-07-02T16:39:49Z", "message": "Changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMzAwNDI5", "url": "https://github.com/elastic/elasticsearch/pull/58885#pullrequestreview-442300429", "createdAt": "2020-07-03T10:00:40Z", "commit": {"oid": "1292822b9404500b188df1c14c8f5c9c0b520cfa"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMDowMDo0MVrOGsrI-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMDowNjo0N1rOGsrUQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ5NzMzOQ==", "bodyText": "While I think that this should be ok for now, it's critical to confirm though that our accounting is not completely off with some tests/benchmarks.\nA first test to ensure that we are not vastly underaccounting should have a high indices.write.limit (e.g. 80%) and check that we don't hit the real-memory circuit breaker when we are filling up the node (should probably block requests from being processed), but rather the indices.write.limit instead.\nA second test to ensure that we are not vastly overaccounting should have a low indices.write.limit, for example (e.g. 100MB), and show that we can still put a decently large number of requests to the system (i.e. send bulks that are in total making up 80MB in input size) without reaching the limit.\nThird we need to check what the overhead of primaries is to wait on replica responses (i.e. memory consumed by listeners etc.). For that we should block processing on a replica, and fill up a primary and see how much memory is being consumed.", "url": "https://github.com/elastic/elasticsearch/pull/58885#discussion_r449497339", "createdAt": "2020-07-03T10:00:41Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/index/IndexRequest.java", "diffHunk": "@@ -697,6 +697,6 @@ public long getAutoGeneratedTimestamp() {\n \n     @Override\n     public long ramBytesUsed() {\n-        return SHALLOW_SIZE + RamUsageEstimator.sizeOf(id) + (source == null ? 0 : source.ramBytesUsed());\n+        return SHALLOW_SIZE + RamUsageEstimator.sizeOf(id) + (source == null ? 0 : source.length());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1292822b9404500b188df1c14c8f5c9c0b520cfa"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ5OTM2MA==", "bodyText": "I discussed this with Henning, and we think that a second replica limit would be useful here (e.g. defaulting to 1,5 times the indices.write.limit). In the past we have been rejecting replica operations at the real-memory circuit breaker limit (i.e. 95%), which can have adverse effects on the rest of the system. We should have another limit for replicas much lower than that. It won't solve all problems with handling primary vs replica bytes, but it puts an additional safeguard into the system.", "url": "https://github.com/elastic/elasticsearch/pull/58885#discussion_r449499360", "createdAt": "2020-07-03T10:04:51Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/WriteMemoryLimits.java", "diffHunk": "@@ -20,17 +20,50 @@\n package org.elasticsearch.action.bulk;\n \n import org.elasticsearch.common.lease.Releasable;\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n+import org.elasticsearch.common.util.concurrent.EsRejectedExecutionException;\n \n import java.util.concurrent.atomic.AtomicLong;\n \n public class WriteMemoryLimits {\n \n+    // TODO: Adjust\n+    public static final Setting<ByteSizeValue> MAX_INDEXING_BYTES =\n+        Setting.memorySizeSetting(\"indices.write.limit\", \"10%\", Setting.Property.NodeScope, Setting.Property.Dynamic);\n+\n     private final AtomicLong writeBytes = new AtomicLong(0);\n     private final AtomicLong replicaWriteBytes = new AtomicLong(0);\n+    private volatile long writeLimits;\n+\n+    public WriteMemoryLimits(Settings settings, ClusterSettings clusterSettings) {\n+        this.writeLimits = MAX_INDEXING_BYTES.get(settings).getBytes();\n+        clusterSettings.addSettingsUpdateConsumer(MAX_INDEXING_BYTES, value -> writeLimits = value.getBytes());\n+    }\n \n     public Releasable markWriteOperationStarted(long bytes) {\n-        writeBytes.addAndGet(bytes);\n-        return () -> writeBytes.getAndAdd(-bytes);\n+        return markWriteOperationStarted(bytes, false);\n+    }\n+\n+    public Releasable markWriteOperationStarted(long bytes, boolean forceExecution) {\n+        long writeBytes = this.writeBytes.addAndGet(bytes);\n+        long replicaWriteBytes = this.replicaWriteBytes.get();\n+        long totalBytes = writeBytes + replicaWriteBytes;\n+        long localWriteLimits = this.writeLimits;\n+        if (forceExecution == false && totalBytes > localWriteLimits) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1292822b9404500b188df1c14c8f5c9c0b520cfa"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTUwMDIyNw==", "bodyText": "10% can be quite a lot for a system with a big heap (i.e. 3GB for a 32GB heap). Should we put an upper bound on this number? Can we run some benchmarks to determine what a good limit would look like (e.g. by checking the lowest limit we can get away with using our current Rally benchmarks).", "url": "https://github.com/elastic/elasticsearch/pull/58885#discussion_r449500227", "createdAt": "2020-07-03T10:06:47Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/WriteMemoryLimits.java", "diffHunk": "@@ -20,17 +20,50 @@\n package org.elasticsearch.action.bulk;\n \n import org.elasticsearch.common.lease.Releasable;\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n+import org.elasticsearch.common.util.concurrent.EsRejectedExecutionException;\n \n import java.util.concurrent.atomic.AtomicLong;\n \n public class WriteMemoryLimits {\n \n+    // TODO: Adjust\n+    public static final Setting<ByteSizeValue> MAX_INDEXING_BYTES =\n+        Setting.memorySizeSetting(\"indices.write.limit\", \"10%\", Setting.Property.NodeScope, Setting.Property.Dynamic);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1292822b9404500b188df1c14c8f5c9c0b520cfa"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c75598990254b65185cf01d5286ebc86dc6cd534", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/c75598990254b65185cf01d5286ebc86dc6cd534", "committedDate": "2020-07-06T15:57:01Z", "message": "Merge remote-tracking branch 'upstream/master' into reject_based_on_write_limits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbab82ffa81d1e8e780333f74674ef00190d1ad8", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/dbab82ffa81d1e8e780333f74674ef00190d1ad8", "committedDate": "2020-07-06T17:12:01Z", "message": "Changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba3bb15fe1e7c61727574f6c296d9f0f85ab656", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/cba3bb15fe1e7c61727574f6c296d9f0f85ab656", "committedDate": "2020-07-06T23:04:10Z", "message": "Change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40b1eb786546f38e755152aa7cd6b10869a757c6", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/40b1eb786546f38e755152aa7cd6b10869a757c6", "committedDate": "2020-07-08T13:56:52Z", "message": "Merge remote-tracking branch 'upstream/master' into reject_based_on_write_limits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0Nzc2NjYy", "url": "https://github.com/elastic/elasticsearch/pull/58885#pullrequestreview-444776662", "createdAt": "2020-07-08T13:42:19Z", "commit": {"oid": "cba3bb15fe1e7c61727574f6c296d9f0f85ab656"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMzo0MjoyMFrOGuoopQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMzo0OTowOFrOGuo8FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU1MzQ0NQ==", "bodyText": "As discussed, let's make this a non-dynamic node setting. We also need to discuss whether we should white-list this setting in Cloud (so that users can change it there).\nI think that we should not pick a setting name that is under the  \"indices\" namespace, but perhaps introduce something completely new, for example indexing_limits.memory.limit", "url": "https://github.com/elastic/elasticsearch/pull/58885#discussion_r451553445", "createdAt": "2020-07-08T13:42:20Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/WriteMemoryLimits.java", "diffHunk": "@@ -20,26 +20,68 @@\n package org.elasticsearch.action.bulk;\n \n import org.elasticsearch.common.lease.Releasable;\n+import org.elasticsearch.common.settings.ClusterSettings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n+import org.elasticsearch.common.util.concurrent.EsRejectedExecutionException;\n \n import java.util.concurrent.atomic.AtomicLong;\n \n public class WriteMemoryLimits {\n \n+    // TODO: Adjust\n+    public static final Setting<ByteSizeValue> MAX_INDEXING_BYTES =\n+        Setting.memorySizeSetting(\"indices.write.limit\", \"10%\", Setting.Property.NodeScope, Setting.Property.Dynamic);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cba3bb15fe1e7c61727574f6c296d9f0f85ab656"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU1ODQyMQ==", "bodyText": "As we discussed, we eventually want to have a test that also covers the rest layer.", "url": "https://github.com/elastic/elasticsearch/pull/58885#discussion_r451558421", "createdAt": "2020-07-08T13:49:08Z", "author": {"login": "ywelsch"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/action/bulk/WriteMemoryLimitsIT.java", "diffHunk": "@@ -210,16 +185,242 @@ public void testWriteBytesAreIncremented() throws Exception {\n             if (replicationSendPointReached.getCount() > 0) {\n                 replicationSendPointReached.countDown();\n             }\n-            while (newActionsSendPointReached.getCount() > 0) {\n-                newActionsSendPointReached.countDown();\n-            }\n+            replicaRelease.close();\n             if (latchBlockingReplicationSend.getCount() > 0) {\n                 latchBlockingReplicationSend.countDown();\n             }\n-            if (latchBlockingReplication.getCount() > 0) {\n-                latchBlockingReplication.countDown();\n-            }\n+            replicaRelease.close();\n             primaryTransportService.clearAllRules();\n         }\n     }\n+\n+    public void testWriteCanBeRejectedAtCoordinatingLevel() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cba3bb15fe1e7c61727574f6c296d9f0f85ab656"}, "originalPosition": 138}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cde58b93f8e91939ef75a2fcc37a022712216a52", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/cde58b93f8e91939ef75a2fcc37a022712216a52", "committedDate": "2020-07-08T14:10:39Z", "message": "Setting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODI1MzQ0", "url": "https://github.com/elastic/elasticsearch/pull/58885#pullrequestreview-444825344", "createdAt": "2020-07-08T14:30:29Z", "commit": {"oid": "cde58b93f8e91939ef75a2fcc37a022712216a52"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "243de3592f8a7a4c6495329dba9ea5a9cf6b51b0", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/243de3592f8a7a4c6495329dba9ea5a9cf6b51b0", "committedDate": "2020-07-08T15:53:26Z", "message": "Fix tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2365, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}