{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNjk3OTI5", "number": 57870, "title": "Add data stream support to the reindex api.", "bodyText": "Relates to #53100 and #57788\nWith this change reindex get index into a data stream if op_type=create is specified in the reindex request body. This is required otherwise a validation error occurs that data stream only accepts index request with create op type.", "createdAt": "2020-06-09T10:36:07Z", "url": "https://github.com/elastic/elasticsearch/pull/57870", "merged": true, "mergeCommit": {"oid": "05b277552ab2137a1af97b9332e7ddb34f611c30"}, "closed": true, "closedAt": "2020-06-11T06:38:58Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpihfmAH2gAyNDMxNjk3OTI5OmM3NDE0NzJmMGQ2ODk5NmE2YTBmNzA0NjkxNjdlYjM4YzIzYTY1ZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqHshaAH2gAyNDMxNjk3OTI5OmMyMTYyYjgwODliYmZkMTk1MzNiZWQ2NTAyMDIxYTA0Y2Y2ZmZmYjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c741472f0d68996a6a0f70469167eb38c23a65d2", "committedDate": "2020-06-09T10:30:20Z", "message": "Add data stream support to the reindex api.\n\nRelates to #53100 and #57788"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDExMjYz", "url": "https://github.com/elastic/elasticsearch/pull/57870#pullrequestreview-427011263", "createdAt": "2020-06-09T10:37:35Z", "commit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDozNzozNVrOGhDXkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDozNzozNVrOGhDXkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA==", "bodyText": "According to the reindex docs, op_type is a valid argument. However it was currently not supported, as the op_type wasn't copied over from the destination index request template to the actual index requests that reindex api generates.", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r437311378", "createdAt": "2020-06-09T10:37:35Z", "author": {"login": "martijnvg"}, "path": "modules/reindex/src/main/java/org/elasticsearch/index/reindex/Reindexer.java", "diffHunk": "@@ -265,7 +266,11 @@ protected void finishHim(Exception failure, List<BulkItemResponse.Failure> index\n              */\n             index.routing(mainRequest.getDestination().routing());\n             index.setPipeline(mainRequest.getDestination().getPipeline());\n-            // OpType is synthesized from version so it is handled when we copy version above.\n+            // Only copy the op_type if it has been set to CREATE.\n+            // (INDEX is the default and UPDATE and DELETE are invalid values)\n+            if (mainRequest.getDestination().opType() == DocWriteRequest.OpType.CREATE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDExNjc2", "url": "https://github.com/elastic/elasticsearch/pull/57870#pullrequestreview-427011676", "createdAt": "2020-06-09T10:38:11Z", "commit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDozODoxMVrOGhDYzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDozODoxMVrOGhDYzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTY5NQ==", "bodyText": "This change is required for #57788, but in order to that all other changes in this pr are needed.", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r437311695", "createdAt": "2020-06-09T10:38:11Z", "author": {"login": "martijnvg"}, "path": "docs/reference/indices/rollover-index.asciidoc", "diffHunk": "@@ -254,7 +254,7 @@ POST /my-data-stream/_rollover <2>\n --------------------------------------------------\n // TEST[continued]\n // TEST[setup:huge_twitter]\n-// TEST[s/# Add > 1000 documents to my-data-stream/POST _reindex?refresh\\n{\"source\":{\"index\":\"twitter\"},\"dest\":{\"index\":\".ds-my-data-stream-000001\"}}/]\n+// TEST[s/# Add > 1000 documents to my-data-stream/POST _reindex?refresh\\n{\"source\":{\"index\":\"twitter\"},\"dest\":{\"index\":\"my-data-stream\",\"op_type\":\"create\"}}/]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTgzNTE5", "url": "https://github.com/elastic/elasticsearch/pull/57870#pullrequestreview-427183519", "createdAt": "2020-06-09T14:02:53Z", "commit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fd430c78e070ad9d7cf9e6e08eeee4c3fa8fdfa", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1fd430c78e070ad9d7cf9e6e08eeee4c3fa8fdfa", "committedDate": "2020-06-10T13:07:10Z", "message": "adjusted comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MzQ2NTU5", "url": "https://github.com/elastic/elasticsearch/pull/57870#pullrequestreview-428346559", "createdAt": "2020-06-10T19:02:48Z", "commit": {"oid": "1fd430c78e070ad9d7cf9e6e08eeee4c3fa8fdfa"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxOTowMjo0OFrOGiCfDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxOTowMjo0OFrOGiCfDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM0NTQ4Nw==", "bodyText": "I would be inclined to remove the comment. It seems quite natural to copy the op-type and the comment mostly explains history I think.", "url": "https://github.com/elastic/elasticsearch/pull/57870#discussion_r438345487", "createdAt": "2020-06-10T19:02:48Z", "author": {"login": "henningandersen"}, "path": "modules/reindex/src/main/java/org/elasticsearch/index/reindex/Reindexer.java", "diffHunk": "@@ -265,7 +266,11 @@ protected void finishHim(Exception failure, List<BulkItemResponse.Failure> index\n              */\n             index.routing(mainRequest.getDestination().routing());\n             index.setPipeline(mainRequest.getDestination().getPipeline());\n-            // OpType is synthesized from version so it is handled when we copy version above.\n+            // Only copy the op_type if it has been set to CREATE.\n+            // (INDEX is the default and UPDATE and DELETE are invalid values)\n+            if (mainRequest.getDestination().opType() == DocWriteRequest.OpType.CREATE) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMxMTM3OA=="}, "originalCommit": {"oid": "c741472f0d68996a6a0f70469167eb38c23a65d2"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8906504e2e2cb5b8d1bd8842fc17e0c35b95a1ee", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/8906504e2e2cb5b8d1bd8842fc17e0c35b95a1ee", "committedDate": "2020-06-11T05:48:36Z", "message": "add this comment to final commit message:\n\n// (For ensuring no document exists, the op_type create doesn't need to be copied, since Versions.MATCH_DELETED\n            //  will copied from the 'mainRequest.getDestination().version()' a few lines back)\n            // (In order to be able to index into a data stream, the op_type must be create. So in order to support that\n            //  the op_type must be copied)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2162b8089bbfd19533bed6502021a04cf6fffb8", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c2162b8089bbfd19533bed6502021a04cf6fffb8", "committedDate": "2020-06-11T05:48:52Z", "message": "Merge remote-tracking branch 'es/master' into add_data_stream_support_to_reindex"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 817, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}