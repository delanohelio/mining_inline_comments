{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNzY4Mzc0", "number": 52101, "title": "SQL: Fix issue with timezone when paginating", "bodyText": "Previously, when the specified (or default) fetchSize led to\nsubsequent HTTP requests and the usage of cursors, those subsequent\nwere no longer using the client timezone specified in the initial\nSQL query. As a consequence, Even though the query is executed once\n(with the correct timezone) the processing of the query results by\nthe HitExtractors in the next pages was done using the default\ntimezone Z. This could lead to incorrect results.\nFix the issue by correctly using the initially specified timezone,\nwhich is found in the deserialisation of the cursor string.\nFixes: #51258", "createdAt": "2020-02-08T23:09:07Z", "url": "https://github.com/elastic/elasticsearch/pull/52101", "merged": true, "mergeCommit": {"oid": "8f7afbdeb9295999b48a6c36db5b31cbe0cee432"}, "closed": true, "closedAt": "2020-02-11T13:59:07Z", "author": {"login": "matriv"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCb8ErgH2gAyMzcyNzY4Mzc0OmE0ODg1MTJlM2FiZDgzYjhkZTk1ZWYwY2JmY2Q5YjJhZGMyYjhhODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDRTS5gH2gAyMzcyNzY4Mzc0OmU5NTYyOGE4Mjk2ZTBiYzcxMmVjYWVjZTUxMmU2NjFkMjAyYTQwODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a488512e3abd83b8de95ef0cbfcd9b2adc2b8a86", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/a488512e3abd83b8de95ef0cbfcd9b2adc2b8a86", "committedDate": "2020-02-08T22:46:59Z", "message": "SQL: Fix issue with timezone when paginating\n\nPreviously, when the specified (or default) fetchSize led to\nsubsequent HTTP requests and the usage of cursors, those subsequent\nwere no longer using the client timezone specified in the initial\nSQL query. As a consequence, Even though the query is executed once\n(with the correct timezone) the processing of the query results by\nthe HitExtractors in the next pages was done using the default\ntimezone `Z`. This could lead to incorrect results.\n\nFix the issue by correctly using the initially specified timezone,\nwhich is found in the deserialisation of the cursor string.\n\nFixes: #51258"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NjE1ODMw", "url": "https://github.com/elastic/elasticsearch/pull/52101#pullrequestreview-355615830", "createdAt": "2020-02-09T15:50:39Z", "commit": {"oid": "a488512e3abd83b8de95ef0cbfcd9b2adc2b8a86"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxNTo1MDozOVrOFnVrvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxNjo0Mzo1NVrOFnV6Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc5NDA0Ng==", "bodyText": "Can't you move this part in the if (i==0) {} else {} above?", "url": "https://github.com/elastic/elasticsearch/pull/52101#discussion_r376794046", "createdAt": "2020-02-09T15:50:39Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/rest/RestSqlTestCase.java", "diffHunk": "@@ -151,6 +155,74 @@ public void testNextPage() throws IOException {\n                 ContentType.APPLICATION_JSON), StringUtils.EMPTY, mode));\n     }\n \n+    public void testNextPageWithDatetimeAndTimezoneParam() throws IOException {\n+        Request request = new Request(\"PUT\", \"/test_date_timezone\");\n+        XContentBuilder createIndex = JsonXContent.contentBuilder().startObject();\n+        createIndex.startObject(\"mappings\");\n+        {\n+            createIndex.startObject(\"properties\");\n+            {\n+                createIndex.startObject(\"date\").field(\"type\", \"date\").field(\"format\", \"epoch_millis\");\n+                createIndex.endObject();\n+            }\n+            createIndex.endObject();\n+        }\n+        createIndex.endObject().endObject();\n+        request.setJsonEntity(Strings.toString(createIndex));\n+        client().performRequest(request);\n+\n+        request = new Request(\"PUT\", \"/test_date_timezone/_bulk\");\n+        request.addParameter(\"refresh\", \"true\");\n+        StringBuilder bulk = new StringBuilder();\n+        long[] datetimes = new long[] { 1_000, 10_000, 100_000, 1_000_000, 10_000_000 };\n+        for (long datetime : datetimes) {\n+            bulk.append(\"{\\\"index\\\":{}}\\n\");\n+            bulk.append(\"{\\\"date\\\":\").append(datetime).append(\"}\\n\");\n+        }\n+        request.setJsonEntity(bulk.toString());\n+        assertEquals(200, client().performRequest(request).getStatusLine().getStatusCode());\n+\n+        ZoneId zoneId = randomZone();\n+        String mode = randomMode();\n+        String sqlRequest =\n+                \"{\\\"query\\\":\\\"SELECT DATE_PART('TZOFFSET', date) AS tz FROM test_date_timezone ORDER BY date\\\",\"\n+                        + \"\\\"time_zone\\\":\\\"\" + zoneId.getId() + \"\\\", \"\n+                        + \"\\\"mode\\\":\\\"\" + mode + \"\\\", \"\n+                        + \"\\\"fetch_size\\\":2}\";\n+\n+        String cursor = null;\n+        for (int i = 0; i <= datetimes.length; i += 2) {\n+            Map<String, Object> response;\n+            if (i == 0) {\n+                response = runSql(new StringEntity(sqlRequest, ContentType.APPLICATION_JSON), \"\", mode);\n+            } else {\n+                response = runSql(new StringEntity(\"{\\\"cursor\\\":\\\"\" + cursor + \"\\\"\" + mode(mode) + \"}\",\n+                        ContentType.APPLICATION_JSON), StringUtils.EMPTY, mode);\n+            }\n+\n+            Map<String, Object> expected = new HashMap<>();\n+            if (i == 0) {\n+                expected.put(\"columns\", singletonList(\n+                        columnInfo(mode, \"tz\", \"integer\", JDBCType.INTEGER, 11)));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a488512e3abd83b8de95ef0cbfcd9b2adc2b8a86"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc5NzczNQ==", "bodyText": "Can you move this line on the above one?", "url": "https://github.com/elastic/elasticsearch/pull/52101#discussion_r376797735", "createdAt": "2020-02-09T16:43:55Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/FetchSizeTestCase.java", "diffHunk": "@@ -102,6 +107,51 @@ public void testIncompleteScroll() throws Exception {\n         assertNoSearchContexts();\n     }\n \n+    public void testScrollWithDatetimeAndTimezoneParam() throws IOException, SQLException {\n+        Request request = new Request(\"PUT\", \"/test_date_timezone\");\n+        XContentBuilder createIndex = JsonXContent.contentBuilder().startObject();\n+        createIndex.startObject(\"mappings\");\n+        {\n+            createIndex.startObject(\"properties\");\n+            {\n+                createIndex.startObject(\"date\").field(\"type\", \"date\").field(\"format\", \"epoch_millis\");\n+                createIndex.endObject();\n+            }\n+            createIndex.endObject();\n+        }\n+        createIndex.endObject().endObject();\n+        request.setJsonEntity(Strings.toString(createIndex));\n+        client().performRequest(request);\n+\n+        request = new Request(\"PUT\", \"/test_date_timezone/_bulk\");\n+        request.addParameter(\"refresh\", \"true\");\n+        StringBuilder bulk = new StringBuilder();\n+        long[] datetimes = new long[] { 1_000, 10_000, 100_000, 1_000_000, 10_000_000 };\n+        for (long datetime : datetimes) {\n+            bulk.append(\"{\\\"index\\\":{}}\\n\");\n+            bulk.append(\"{\\\"date\\\":\").append(datetime).append(\"}\\n\");\n+        }\n+        request.setJsonEntity(bulk.toString());\n+        assertEquals(200, client().performRequest(request).getStatusLine().getStatusCode());\n+\n+        ZoneId zoneId = randomZone();\n+        Properties connectionProperties = connectionProperties();\n+        connectionProperties.put(JDBC_TIMEZONE, zoneId.toString());\n+        try (Connection c = esJdbc(connectionProperties);\n+             Statement s = c.createStatement()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a488512e3abd83b8de95ef0cbfcd9b2adc2b8a86"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c891567c397e9a88c3adc6d8b2a67036e0ee5efb", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/c891567c397e9a88c3adc6d8b2a67036e0ee5efb", "committedDate": "2020-02-09T17:06:50Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1Nzc5MzA5", "url": "https://github.com/elastic/elasticsearch/pull/52101#pullrequestreview-355779309", "createdAt": "2020-02-10T09:14:19Z", "commit": {"oid": "c891567c397e9a88c3adc6d8b2a67036e0ee5efb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwOToxNDoxOVrOFnehvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwOToxNDoxOVrOFnehvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkzODk0MA==", "bodyText": "I think it's perfectly fine as is, but was curious about the reason - if any - for choosing a fetch_size of 2, vs. 1, which would simplify the test just a bit.", "url": "https://github.com/elastic/elasticsearch/pull/52101#discussion_r376938940", "createdAt": "2020-02-10T09:14:19Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/rest/RestSqlTestCase.java", "diffHunk": "@@ -151,6 +155,70 @@ public void testNextPage() throws IOException {\n                 ContentType.APPLICATION_JSON), StringUtils.EMPTY, mode));\n     }\n \n+    public void testNextPageWithDatetimeAndTimezoneParam() throws IOException {\n+        Request request = new Request(\"PUT\", \"/test_date_timezone\");\n+        XContentBuilder createIndex = JsonXContent.contentBuilder().startObject();\n+        createIndex.startObject(\"mappings\");\n+        {\n+            createIndex.startObject(\"properties\");\n+            {\n+                createIndex.startObject(\"date\").field(\"type\", \"date\").field(\"format\", \"epoch_millis\");\n+                createIndex.endObject();\n+            }\n+            createIndex.endObject();\n+        }\n+        createIndex.endObject().endObject();\n+        request.setJsonEntity(Strings.toString(createIndex));\n+        client().performRequest(request);\n+\n+        request = new Request(\"PUT\", \"/test_date_timezone/_bulk\");\n+        request.addParameter(\"refresh\", \"true\");\n+        StringBuilder bulk = new StringBuilder();\n+        long[] datetimes = new long[] { 1_000, 10_000, 100_000, 1_000_000, 10_000_000 };\n+        for (long datetime : datetimes) {\n+            bulk.append(\"{\\\"index\\\":{}}\\n\");\n+            bulk.append(\"{\\\"date\\\":\").append(datetime).append(\"}\\n\");\n+        }\n+        request.setJsonEntity(bulk.toString());\n+        assertEquals(200, client().performRequest(request).getStatusLine().getStatusCode());\n+\n+        ZoneId zoneId = randomZone();\n+        String mode = randomMode();\n+        String sqlRequest =\n+                \"{\\\"query\\\":\\\"SELECT DATE_PART('TZOFFSET', date) AS tz FROM test_date_timezone ORDER BY date\\\",\"\n+                        + \"\\\"time_zone\\\":\\\"\" + zoneId.getId() + \"\\\", \"\n+                        + \"\\\"mode\\\":\\\"\" + mode + \"\\\", \"\n+                        + \"\\\"fetch_size\\\":2}\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c891567c397e9a88c3adc6d8b2a67036e0ee5efb"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1Nzc5Nzc4", "url": "https://github.com/elastic/elasticsearch/pull/52101#pullrequestreview-355779778", "createdAt": "2020-02-10T09:15:05Z", "commit": {"oid": "c891567c397e9a88c3adc6d8b2a67036e0ee5efb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1OTU0OTE0", "url": "https://github.com/elastic/elasticsearch/pull/52101#pullrequestreview-355954914", "createdAt": "2020-02-10T13:58:26Z", "commit": {"oid": "c891567c397e9a88c3adc6d8b2a67036e0ee5efb"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo1ODoyN1rOFnm_Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMzo1OToxNlrOFnnA5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3NzU0Mw==", "bodyText": "Is Cursors.decodeFromString used anywhere else ? It might be that decoding a tuple of timezone or adding it as a property in the Cursor class should be the default.", "url": "https://github.com/elastic/elasticsearch/pull/52101#discussion_r377077543", "createdAt": "2020-02-10T13:58:27Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TransportSqlQueryAction.java", "diffHunk": "@@ -80,13 +83,14 @@ public static void operation(PlanExecutor planExecutor, SqlQueryRequest request,\n             planExecutor.sql(cfg, request.query(), request.params(),\n                     wrap(p -> listener.onResponse(createResponseWithSchema(request, p)), listener::onFailure));\n         } else {\n-            planExecutor.nextPage(cfg, Cursors.decodeFromString(request.cursor()),\n-                    wrap(p -> listener.onResponse(createResponse(request, null, p)),\n+            Tuple<Cursor, ZoneId> decoded = Cursors.decodeFromStringWithZone(request.cursor());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c891567c397e9a88c3adc6d8b2a67036e0ee5efb"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3Nzk5MA==", "bodyText": "Nit: why make it private ? I think this will make things a bit harded in debug project.", "url": "https://github.com/elastic/elasticsearch/pull/52101#discussion_r377077990", "createdAt": "2020-02-10T13:59:16Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TransportSqlQueryAction.java", "diffHunk": "@@ -68,7 +71,7 @@ protected void doExecute(Task task, SqlQueryRequest request, ActionListener<SqlQ\n     /**\n      * Actual implementation of the action. Statically available to support embedded mode.\n      */\n-    public static void operation(PlanExecutor planExecutor, SqlQueryRequest request, ActionListener<SqlQueryResponse> listener,\n+    private static void operation(PlanExecutor planExecutor, SqlQueryRequest request, ActionListener<SqlQueryResponse> listener,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c891567c397e9a88c3adc6d8b2a67036e0ee5efb"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81605e862fc02d3c55550b4f8d8d0e8748352376", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/81605e862fc02d3c55550b4f8d8d0e8748352376", "committedDate": "2020-02-10T18:21:18Z", "message": "revert private on operation()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01203570d98db00e4cbaf696c7790e6203f8f4ce", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/01203570d98db00e4cbaf696c7790e6203f8f4ce", "committedDate": "2020-02-10T19:01:47Z", "message": "Merge remote-tracking branch 'upstream/master' into fix-51258"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e95628a8296e0bc712ecaece512e661d202a4085", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/e95628a8296e0bc712ecaece512e661d202a4085", "committedDate": "2020-02-11T12:57:19Z", "message": "make sure decodefromstringWithZone is always used"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2723, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}