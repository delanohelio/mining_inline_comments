{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNzc5MTk0", "number": 58062, "title": "QL: wildcard field type support", "bodyText": "This PR adds support for wildcard data type following its addition in Elasticsearch with #49993.\nThere is one issue that will need to be addressed afterwards: there is a slightly different behavior between wildcard and the other text based data types (ie keyword) when it comes to Painless scripting. As soon as #58044 is fixed, the workaround in InternalQlScriptUtils needs to be reverted.\nAddresses #54184.", "createdAt": "2020-06-12T16:28:47Z", "url": "https://github.com/elastic/elasticsearch/pull/58062", "merged": true, "mergeCommit": {"oid": "c874e6cdd3e051ce599b50c18642de038b84105f"}, "closed": true, "closedAt": "2020-08-17T13:00:47Z", "author": {"login": "astefan"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqkiwlgH2gAyNDMzNzc5MTk0OjMxOTIwNTk0OWJiYzdlMTRjZDViZWYxZWRkYmJhZjg3MjMyMDYyNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_x3dRAFqTQ2ODQzMTUyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "319205949bbc7e14cd5bef1eddbbaf8723206240", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/319205949bbc7e14cd5bef1eddbbaf8723206240", "committedDate": "2020-06-12T15:25:27Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45a94c872c959459543c6433c4efa5f479969e84", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/45a94c872c959459543c6433c4efa5f479969e84", "committedDate": "2020-06-12T16:10:14Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 54184_impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07451948c91c88eccd1caefd422dfe0c565df805", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/07451948c91c88eccd1caefd422dfe0c565df805", "committedDate": "2020-06-12T16:21:18Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNjM2MzEx", "url": "https://github.com/elastic/elasticsearch/pull/58062#pullrequestreview-430636311", "createdAt": "2020-06-15T13:20:56Z", "commit": {"oid": "07451948c91c88eccd1caefd422dfe0c565df805"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMzoyMDo1NlrOGjx2yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMzoyNjozMVrOGjyEYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3MDE4NQ==", "bodyText": "The issues seems fixed, can you remove the workaround?", "url": "https://github.com/elastic/elasticsearch/pull/58062#discussion_r440170185", "createdAt": "2020-06-15T13:20:56Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/expression/function/scalar/whitelist/InternalQlScriptUtils.java", "diffHunk": "@@ -32,7 +33,9 @@\n         if (doc.containsKey(fieldName)) {\n             ScriptDocValues<T> docValues = doc.get(fieldName);\n             if (!docValues.isEmpty()) {\n-                return docValues.get(0);\n+                T value = docValues.get(0);\n+                // FIXME temporary workaround until https://github.com/elastic/elasticsearch/issues/58044 gets fixed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07451948c91c88eccd1caefd422dfe0c565df805"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3MzQ2MA==", "bodyText": "Wouldn't groupBy be more appropriate?", "url": "https://github.com/elastic/elasticsearch/pull/58062#discussion_r440173460", "createdAt": "2020-06-15T13:26:12Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/server/src/main/resources/wildcard.csv-spec", "diffHunk": "@@ -0,0 +1,236 @@\n+// To mute tests follow example in file: example.csv-spec\n+\n+//\n+// Tests testing wildcard field type (introduced in ES 7.9?)\n+//\n+\n+// filtering\n+\n+filterEquals\n+SELECT last_name, first_name, wildcard_name FROM test_emp_copy WHERE wildcard_name = 'Saniya Kalloufi';\n+\n+   last_name:s |  first_name:s |wildcard_name:s \n+---------------+---------------+---------------\n+Kalloufi       |Saniya         |Saniya Kalloufi\n+;\n+\n+filterNotEquals\n+SELECT COUNT(*) AS c FROM \"test_emp_copy\" WHERE wildcard_name <> 'Saniya Kalloufi';\n+\n+    c:l     \n+---------------\n+99\n+;\n+\n+aggWithNullFilter\n+SELECT COUNT(*) count FROM test_emp_copy WHERE wildcard_name IS NOT NULL;\n+\n+     count:l     \n+---------------\n+90\n+;\n+\n+aggWithNullFilter\n+SELECT COUNT(*) count FROM test_emp_copy WHERE wildcard_name IS NULL;\n+\n+     count:l     \n+---------------\n+10\n+;\n+\n+functionOverAlias\n+SELECT BIT_LENGTH(wildcard_name) bit, wildcard_name, length(wildcard_name) l FROM test_emp_copy ORDER BY bit DESC LIMIT 10;\n+\n+      bit      |    wildcard_name     |       l       \n+---------------+----------------------+---------------\n+176            |Sudharsan Flasterstein|22             \n+168            |Arumugam Ossenbruggen |21             \n+168            |Sreekrishna Servieres |21             \n+160            |Kazuhito Cappelletti  |20             \n+160            |Breannda Billingsley  |20             \n+152            |Cristinel Bouloucos   |19             \n+144            |Duangkaew Piveteau    |18             \n+144            |Patricio Bridgland    |18             \n+144            |Guoxiang Nooteboom    |18             \n+144            |Alejandro McAlpine    |18             \n+;\n+\n+\n+singlePercentile", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07451948c91c88eccd1caefd422dfe0c565df805"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDE3MzY2NA==", "bodyText": "and here complexGroupBy ?", "url": "https://github.com/elastic/elasticsearch/pull/58062#discussion_r440173664", "createdAt": "2020-06-15T13:26:31Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/server/src/main/resources/wildcard.csv-spec", "diffHunk": "@@ -0,0 +1,236 @@\n+// To mute tests follow example in file: example.csv-spec\n+\n+//\n+// Tests testing wildcard field type (introduced in ES 7.9?)\n+//\n+\n+// filtering\n+\n+filterEquals\n+SELECT last_name, first_name, wildcard_name FROM test_emp_copy WHERE wildcard_name = 'Saniya Kalloufi';\n+\n+   last_name:s |  first_name:s |wildcard_name:s \n+---------------+---------------+---------------\n+Kalloufi       |Saniya         |Saniya Kalloufi\n+;\n+\n+filterNotEquals\n+SELECT COUNT(*) AS c FROM \"test_emp_copy\" WHERE wildcard_name <> 'Saniya Kalloufi';\n+\n+    c:l     \n+---------------\n+99\n+;\n+\n+aggWithNullFilter\n+SELECT COUNT(*) count FROM test_emp_copy WHERE wildcard_name IS NOT NULL;\n+\n+     count:l     \n+---------------\n+90\n+;\n+\n+aggWithNullFilter\n+SELECT COUNT(*) count FROM test_emp_copy WHERE wildcard_name IS NULL;\n+\n+     count:l     \n+---------------\n+10\n+;\n+\n+functionOverAlias\n+SELECT BIT_LENGTH(wildcard_name) bit, wildcard_name, length(wildcard_name) l FROM test_emp_copy ORDER BY bit DESC LIMIT 10;\n+\n+      bit      |    wildcard_name     |       l       \n+---------------+----------------------+---------------\n+176            |Sudharsan Flasterstein|22             \n+168            |Arumugam Ossenbruggen |21             \n+168            |Sreekrishna Servieres |21             \n+160            |Kazuhito Cappelletti  |20             \n+160            |Breannda Billingsley  |20             \n+152            |Cristinel Bouloucos   |19             \n+144            |Duangkaew Piveteau    |18             \n+144            |Patricio Bridgland    |18             \n+144            |Guoxiang Nooteboom    |18             \n+144            |Alejandro McAlpine    |18             \n+;\n+\n+\n+singlePercentile\n+SELECT wildcard_name AS w, PERCENTILE(emp_no, 97) p1 FROM test_emp_copy GROUP BY wildcard_name LIMIT 10;\n+\n+          w:s        |      p1:d       \n+---------------------+---------------\n+null                 |10039.0        \n+Alejandro McAlpine   |10059.0        \n+Amabile Gomatam      |10091.0        \n+Anneke Preusig       |10006.0        \n+Anoosh Peyn          |10062.0        \n+Arumugam Ossenbruggen|10094.0        \n+Basil Tramer         |10049.0        \n+Berhard McFarlin     |10058.0        \n+Berni Genin          |10014.0        \n+Bezalel Simmel       |10002.0        \n+;\n+\n+complexPercentile", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07451948c91c88eccd1caefd422dfe0c565df805"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDYzOTU4", "url": "https://github.com/elastic/elasticsearch/pull/58062#pullrequestreview-431463958", "createdAt": "2020-06-16T12:45:31Z", "commit": {"oid": "07451948c91c88eccd1caefd422dfe0c565df805"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDk0OTY0", "url": "https://github.com/elastic/elasticsearch/pull/58062#pullrequestreview-431494964", "createdAt": "2020-06-16T13:21:32Z", "commit": {"oid": "07451948c91c88eccd1caefd422dfe0c565df805"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4dfed9525a3ebc3d3b4c65ed7595b1c6e2b8c4f", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/c4dfed9525a3ebc3d3b4c65ed7595b1c6e2b8c4f", "committedDate": "2020-06-17T14:59:01Z", "message": "w"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31f5b19f5f404a416eb89d4d424292a9da83318e", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/31f5b19f5f404a416eb89d4d424292a9da83318e", "committedDate": "2020-06-17T15:00:31Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 54184_impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f3e16920265dd760f1a48fa526650d707387d4c", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/7f3e16920265dd760f1a48fa526650d707387d4c", "committedDate": "2020-07-31T14:27:44Z", "message": "Remove the wildcard field data type. Take 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf72022789a56c4de558c96e9ba49ff2bd0870b3", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/bf72022789a56c4de558c96e9ba49ff2bd0870b3", "committedDate": "2020-07-31T14:40:59Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 54184_impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0e60d341ffd6beb7534ba05fb9b63b6c95e6022", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/c0e60d341ffd6beb7534ba05fb9b63b6c95e6022", "committedDate": "2020-07-31T14:53:37Z", "message": "More fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8759d6cafcbf8ae2af5d6f14c108c866a7367906", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/8759d6cafcbf8ae2af5d6f14c108c866a7367906", "committedDate": "2020-08-03T11:27:16Z", "message": "Tests fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a5786c33345dabc21a95dc437a40147edc62845", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a5786c33345dabc21a95dc437a40147edc62845", "committedDate": "2020-08-03T11:27:33Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 54184_impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDMxMzIx", "url": "https://github.com/elastic/elasticsearch/pull/58062#pullrequestreview-468431321", "createdAt": "2020-08-17T12:48:56Z", "commit": {"oid": "5a5786c33345dabc21a95dc437a40147edc62845"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMjo0ODo1NlrOHBnUug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMjo0ODo1NlrOHBnUug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ1NDkwNg==", "bodyText": "Why is this needed? Aren't wildcard returned as keywords? Or is this using a different API/source?", "url": "https://github.com/elastic/elasticsearch/pull/58062#discussion_r471454906", "createdAt": "2020-08-17T12:48:56Z", "author": {"login": "costin"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/type/Types.java", "diffHunk": "@@ -48,8 +48,12 @@\n \n     private static DataType getType(DataTypeRegistry typeRegistry, Map<String, Object> content) {\n         if (content.containsKey(\"type\")) {\n+            String typeName = content.get(\"type\").toString();\n+            if (\"wildcard\".equals(typeName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a5786c33345dabc21a95dc437a40147edc62845"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDMxNTI3", "url": "https://github.com/elastic/elasticsearch/pull/58062#pullrequestreview-468431527", "createdAt": "2020-08-17T12:49:14Z", "commit": {"oid": "5a5786c33345dabc21a95dc437a40147edc62845"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 649, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}