{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MjUxMTI1", "number": 57607, "title": "Share same existsQuery impl throughout mappers", "bodyText": "Most of our field types have the same implementation for their existsQuery method which relies on doc_values if present, otherwise it queries norms if available or uses a term query against the _field_names meta field. This standard implementation is repeated in many different mappers.\nThere are field types that only query doc_values, because they always have them, and field types that always query _field_names, because they never have norms nor doc_values. We could apply the same standard logic to all of these field types as MappedFieldType has the knowledge about what data structures are available.\nThis commit introduces a standard implementation that does the right thing depending on the data structure that is available. With that only field types that require a different behaviour need to override the existsQuery method.\nAt the same time, this no longer forces subclasses to override existsQuery, which could be forgotten when needed. To address this we introduced a new test method in MapperTestCase that verifies the existsQuery being generated and its consistency with the available data structures.", "createdAt": "2020-06-03T14:45:08Z", "url": "https://github.com/elastic/elasticsearch/pull/57607", "merged": true, "mergeCommit": {"oid": "daade441741f7cc10f1b552d2c1a294755b7592d"}, "closed": true, "closedAt": "2020-09-23T06:58:10Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnqlXIgBqjM0MDI1Mzg2MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLcKaXgH2gAyNDI3MjUxMTI1OjM5Y2FjODdhNDViNTJlNjVhNTcwYWNmMWVkZDkwMzUwM2RjNDQwMGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "373c232e695dc2bdf22cf95ebaefdd8ae0b9291d", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/373c232e695dc2bdf22cf95ebaefdd8ae0b9291d", "committedDate": "2020-06-03T14:28:49Z", "message": "Most of our field types have the same implementation for their `existsQuery` method which relies on doc_values if present, otherwise it uses a term query against the `_field_names` meta field. This standard implementation is repeated in many different mappers. In a few other mappers, we also rely on norms when they are available.\n\nIdeally, we could have a standard implementation that does the right thing by querying the fastest data structure available (doc_values, norms, otherwise _field_names). This is based on the assumption that fields where we do the query on norms are the few fields that may have norms enabled, and that there is no reason for e.g. querying _field_names when doc_values are available or querying `_field_names` when norms are available. This allows us to remove the same or similar implementation for the `existsQuery` method from many mappers.\n\nOne advantage of having `existsQuery` implemented in each mapper may have been that each mapper also decides whether to create or not the `_field_names` field. Though `_field_names` should only be created whenever `doc_values` are turned off: this assumption is now enforced through an assertion."}, "afterCommit": {"oid": "a83f39b97763047316a602c283bc80c94e0a6be2", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/a83f39b97763047316a602c283bc80c94e0a6be2", "committedDate": "2020-06-03T14:45:39Z", "message": "Most of our field types have the same implementation for their `existsQuery` method which relies on doc_values if present, otherwise it uses a term query against the `_field_names` meta field. This standard implementation is repeated in many different mappers. In a few other mappers, we also rely on norms when they are available.\n\nIdeally, we could have a standard implementation that does the right thing by querying the fastest data structure available (doc_values, norms, otherwise _field_names). This is based on the assumption that fields where we do the query on norms are the few fields that may have norms enabled, and that there is no reason for e.g. querying _field_names when doc_values are available or querying `_field_names` when norms are available. This allows us to remove the same or similar implementation for the `existsQuery` method from many mappers.\n\nOne advantage of having `existsQuery` implemented in each mapper may have been that each mapper also decides whether to create or not the `_field_names` field. Though `_field_names` should only be created whenever `doc_values` are turned off: this assumption is now enforced through an assertion."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "293b1296469278da15f36897bf43b374c9b18565", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/293b1296469278da15f36897bf43b374c9b18565", "committedDate": "2020-06-03T15:32:59Z", "message": "unused imports"}, "afterCommit": {"oid": "f492369bb6673078fbc0d59ffa44910fb4e005c7", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/f492369bb6673078fbc0d59ffa44910fb4e005c7", "committedDate": "2020-06-03T15:51:00Z", "message": "    Most of our field types have the same implementation for their `existsQuery` method which relies on doc_values if present, otherwise it uses a term query against the `_field_names` meta field. This standard implementation is repeated in many different mappers. In a few other mappers, we also rely on norms when they are available.\n\n    Ideally, we could have a standard implementation that does the right thing by querying the fastest data structure available (doc_values, norms, otherwise _field_names). This is based on the assumption that fields where we do the query on norms are the few fields that may have norms enabled, and that there is no reason for e.g. querying _field_names when doc_values are available or querying `_field_names` when norms are available. This allows us to remove the same or similar implementation for the `existsQuery` method from many mappers.\n\n    One advantage of having `existsQuery` implemented in each mapper may have been that each mapper also decides whether to create or not the `_field_names` field. Though `_field_names` should only be created whenever `doc_values` are turned off: this assumption is now enforced through an assertion."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MzEzMTk0", "url": "https://github.com/elastic/elasticsearch/pull/57607#pullrequestreview-424313194", "createdAt": "2020-06-04T10:34:27Z", "commit": {"oid": "8336618ab9a513aa77a3dc1bfa1969de1b98572d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMDozNDoyN1rOGe_zcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMDozNDoyN1rOGe_zcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE1NTgyNw==", "bodyText": "I believe it should be omitNorms() || indexOptions() != IndexOptions.NONE", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r435155827", "createdAt": "2020-06-04T10:34:27Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -312,7 +314,21 @@ public Query regexpQuery(String value, int flags, int maxDeterminizedStates, @Nu\n             + \"] which is of type [\" + typeName() + \"]\");\n     }\n \n-    public abstract Query existsQuery(QueryShardContext context);\n+    /**\n+     * Create a query that matches any document that contains this field.\n+     * The default implementation works for most of the field types and creates a {@link DocValuesFieldExistsQuery} when doc_values\n+     * are available, otherwise a {@link NormsFieldExistsQuery} when norms are available, and in the worst case scenario it consists\n+     * of a {@link TermQuery} against the {@link FieldNamesFieldMapper}.\n+     */\n+    public Query existsQuery(QueryShardContext context) {\n+        if (hasDocValues()) {\n+            return new DocValuesFieldExistsQuery(name());\n+        } else if (omitNorms()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8336618ab9a513aa77a3dc1bfa1969de1b98572d"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8336618ab9a513aa77a3dc1bfa1969de1b98572d", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/8336618ab9a513aa77a3dc1bfa1969de1b98572d", "committedDate": "2020-06-03T16:25:17Z", "message": "update root flat field type test, it should be ok to rely on norms although it did not before."}, "afterCommit": {"oid": "896c74c48afe7bf7d2e7f2fc73768071ddc9ebd4", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/896c74c48afe7bf7d2e7f2fc73768071ddc9ebd4", "committedDate": "2020-06-15T22:17:08Z", "message": "Most of our field types have the same implementation for their existsQuery method which relies on doc_values if present, otherwise it uses a term query against the _field_names meta field. This standard implementation is repeated in many different mappers.\n\nThis commit introduces a standard implementation that does the right thing by querying doc_values when available, _field_names otherwise. With that only field types that require a different behaviour need to override the existsQuery method.\n\nOne advantage of having existsQuery implemented in each mapper may have been that each mapper also decides whether to create or not the _field_names field. Though _field_names should only be created whenever doc_values are turned off: this assumption is now enforced through an assertion."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjA3MjYw", "url": "https://github.com/elastic/elasticsearch/pull/57607#pullrequestreview-431207260", "createdAt": "2020-06-16T06:53:46Z", "commit": {"oid": "57ac97673f7d22e3947878904ad39cfebfa282a4"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c8111020091826f9e5775dc810415f2f5a382a1", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/3c8111020091826f9e5775dc810415f2f5a382a1", "committedDate": "2020-09-17T12:43:59Z", "message": "Share same existsQuery impl throughout mappers\n\nMost of our field types have the same implementation for their existsQuery method which relies on doc_values if present, otherwise it queries norms if available or uses a term query against the _field_names meta field. This standard implementation is repeated in many different mappers.\n\nThere are field types that only query doc_values, because they always have them, and field types that always query _field_names, because they never have norms nor doc_values. We could apply the same standard logic to all of these field types.\n\nThis commit introduces a standard implementation that does the right thing depending on the data structure that is available. With that only field types that require a different behaviour need to override the existsQuery method.\n\nOne advantage of having existsQuery implemented in each mapper may have been that each mapper also decides whether to create or not the _field_names field. Though _field_names should only be created whenever doc_values are turned off: this assumption is now enforced through an assertion."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57ac97673f7d22e3947878904ad39cfebfa282a4", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/57ac97673f7d22e3947878904ad39cfebfa282a4", "committedDate": "2020-06-15T22:28:18Z", "message": "iter"}, "afterCommit": {"oid": "3c8111020091826f9e5775dc810415f2f5a382a1", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/3c8111020091826f9e5775dc810415f2f5a382a1", "committedDate": "2020-09-17T12:43:59Z", "message": "Share same existsQuery impl throughout mappers\n\nMost of our field types have the same implementation for their existsQuery method which relies on doc_values if present, otherwise it queries norms if available or uses a term query against the _field_names meta field. This standard implementation is repeated in many different mappers.\n\nThere are field types that only query doc_values, because they always have them, and field types that always query _field_names, because they never have norms nor doc_values. We could apply the same standard logic to all of these field types.\n\nThis commit introduces a standard implementation that does the right thing depending on the data structure that is available. With that only field types that require a different behaviour need to override the existsQuery method.\n\nOne advantage of having existsQuery implemented in each mapper may have been that each mapper also decides whether to create or not the _field_names field. Though _field_names should only be created whenever doc_values are turned off: this assumption is now enforced through an assertion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91605ecf345c314df86387a50be0e968264311d8", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/91605ecf345c314df86387a50be0e968264311d8", "committedDate": "2020-09-17T13:50:33Z", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e412dce830823088b963badaaf2badf30fca8f04", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/e412dce830823088b963badaaf2badf30fca8f04", "committedDate": "2020-09-17T14:01:56Z", "message": "address KeywordFieldTypeTests#testexistsQuery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea244b88ab4d5c80757b2d81a64e3f75bbdbb121", "committedDate": "2020-09-17T18:46:43Z", "message": "Try out a new base class for the shared existsQuery"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjUxOTIw", "url": "https://github.com/elastic/elasticsearch/pull/57607#pullrequestreview-491251920", "createdAt": "2020-09-18T08:23:00Z", "commit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODoyMzowMFrOHUDDaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODoyNzo0MFrOHUDOJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MzU5NQ==", "bodyText": "This looks like a bug in HistogramFieldMapper, can you open a separate issue for it? I wonder if we should revisit how we build the field names field, and maybe add something to MapperTestCase to ensure that it is always added properly.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490783595", "createdAt": "2020-09-18T08:23:00Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/mapper/HistogramFieldMapper.java", "diffHunk": "@@ -285,6 +285,8 @@ public Query existsQuery(QueryShardContext context) {\n             if (hasDocValues()) {\n                 return new DocValuesFieldExistsQuery(name());\n             } else {\n+                //TODO this field differs from all other fields as it never goes into _field_names, so the default impl would not work\n+                //though changing this is problematic for existing indices that don't have this field in _field_names?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDc5OA==", "bodyText": "The vector is stored in a BinaryDocValuesField, so I think this is fine.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490784798", "createdAt": "2020-09-18T08:24:59Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "diffHunk": "@@ -126,6 +126,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NTMxMg==", "bodyText": "Same as above", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490785312", "createdAt": "2020-09-18T08:25:53Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/SparseVectorFieldMapper.java", "diffHunk": "@@ -104,6 +104,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ==", "bodyText": "Can you add some javadoc just to explain why we need this intermediate class?", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490786341", "createdAt": "2020-09-18T08:27:40Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ConcreteMappedFieldType.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.apache.lucene.index.Term;\n+import org.apache.lucene.search.DocValuesFieldExistsQuery;\n+import org.apache.lucene.search.NormsFieldExistsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.TermQuery;\n+import org.elasticsearch.index.query.QueryShardContext;\n+\n+import java.util.Map;\n+\n+public abstract class ConcreteMappedFieldType extends MappedFieldType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86e16a28fceddb79534378ecf29e733a7a7a6e7a", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/86e16a28fceddb79534378ecf29e733a7a7a6e7a", "committedDate": "2020-09-21T07:34:26Z", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/07b114d95673b3e4ce809c4d208ad93127004251", "committedDate": "2020-09-21T09:45:01Z", "message": "test existsQuery behaviour"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNDQ1NjE4", "url": "https://github.com/elastic/elasticsearch/pull/57607#pullrequestreview-492445618", "createdAt": "2020-09-21T10:03:54Z", "commit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDowMzo1NVrOHVIvsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDoyODo0MVrOHVJnOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNTQyNg==", "bodyText": "I don't think you need to index the document, you can just look at the fields in the parsed doc?", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491925426", "createdAt": "2020-09-21T10:03:55Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");\n+        fieldValue(builder);\n+    }\n+\n+    protected abstract void fieldValue(XContentBuilder builder) throws IOException;\n+\n+    public final void testExistsQuery() throws IOException {\n+        MapperService mapperService = createMapperService(fieldMapping(this::minimalMapping));\n+        ParsedDocument doc = mapperService.documentMapper().parse(source(this::field));\n+        withLuceneIndex(mapperService, iw -> iw.addDocument(doc.rootDoc()), reader -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMzI0MA==", "bodyText": "I think you can change this to just take MapperService.  Then we have the default testExistsQuery impl which calls this with a minimal mapping; and mappers which have norms or doc_values settings can then have their own tests that call this with the relevant configuration.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491933240", "createdAt": "2020-09-21T10:16:22Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");\n+        fieldValue(builder);\n+    }\n+\n+    protected abstract void fieldValue(XContentBuilder builder) throws IOException;\n+\n+    public final void testExistsQuery() throws IOException {\n+        MapperService mapperService = createMapperService(fieldMapping(this::minimalMapping));\n+        ParsedDocument doc = mapperService.documentMapper().parse(source(this::field));\n+        withLuceneIndex(mapperService, iw -> iw.addDocument(doc.rootDoc()), reader -> {\n+            QueryShardContext queryShardContext = createQueryShardContext(mapperService);\n+            MappedFieldType fieldType = mapperService.fieldType(\"field\");\n+            assertExistsQuery(fieldType, queryShardContext, reader);\n+        });\n+        assertParseMinimalWarnings();\n+    }\n+\n+    protected void assertExistsQuery(MappedFieldType fieldType, QueryShardContext queryShardContext, IndexReader reader) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzOTY0Mg==", "bodyText": "I think the only mappers that need to override this are ones that do not extend ConcreteFieldType, so maybe we can add a check in the test and take a different branch if we know we need to do something different here?", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491939642", "createdAt": "2020-09-21T10:28:41Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "569487729232c370681a74210d95f7b0f1d52013", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/569487729232c370681a74210d95f7b0f1d52013", "committedDate": "2020-09-21T13:49:05Z", "message": "expand tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "297b5fa803d45d2cba3b61fc770806fde336f9dc", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/297b5fa803d45d2cba3b61fc770806fde336f9dc", "committedDate": "2020-09-22T14:36:01Z", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbe15de2c6404c2aa8f5e2ce2817b71f873c84fd", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/fbe15de2c6404c2aa8f5e2ce2817b71f873c84fd", "committedDate": "2020-09-22T14:42:56Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7cd370a8076264a15f12c376d290614eb8adf52", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7cd370a8076264a15f12c376d290614eb8adf52", "committedDate": "2020-09-22T14:52:26Z", "message": "add javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478d270de64afb0d2c6e57186acf2124bff2e2f5", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/478d270de64afb0d2c6e57186acf2124bff2e2f5", "committedDate": "2020-09-22T14:58:13Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "886d3d08b21fc7bfaee1687aa8f8977992fd0513", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/886d3d08b21fc7bfaee1687aa8f8977992fd0513", "committedDate": "2020-09-22T15:21:25Z", "message": "remove ConcreteMappedFieldType.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa310f6bcebf46297b9a7d47803d432818f217fe", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa310f6bcebf46297b9a7d47803d432818f217fe", "committedDate": "2020-09-22T15:30:17Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTYwNzQx", "url": "https://github.com/elastic/elasticsearch/pull/57607#pullrequestreview-493560741", "createdAt": "2020-09-22T15:04:05Z", "commit": {"oid": "478d270de64afb0d2c6e57186acf2124bff2e2f5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNTowNDowNVrOHV-tnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNTowNDowNVrOHV-tnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwOTYyOQ==", "bodyText": "It's annoying that neither this nor ParentJoinFieldMapper actually have tests for existsQuery, but they'll get them once we convert their test classes to MapperTestCase and it works by inspection now.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492809629", "createdAt": "2020-09-22T15:04:05Z", "author": {"login": "romseygeek"}, "path": "modules/parent-join/src/main/java/org/elasticsearch/join/mapper/ParentIdFieldMapper.java", "diffHunk": "@@ -123,11 +121,6 @@ public Object valueForDisplay(Object value) {\n             BytesRef binaryValue = (BytesRef) value;\n             return binaryValue.utf8ToString();\n         }\n-\n-        @Override\n-        public Query existsQuery(QueryShardContext context) {\n-            return new DocValuesFieldExistsQuery(name());\n-        }\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "478d270de64afb0d2c6e57186acf2124bff2e2f5"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee2a2b6320327474343f1de12e5c440ffcb85886", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/ee2a2b6320327474343f1de12e5c440ffcb85886", "committedDate": "2020-09-22T15:56:59Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7da2140b31a9c6961e688a009f17b950e88603d1", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/7da2140b31a9c6961e688a009f17b950e88603d1", "committedDate": "2020-09-22T15:57:14Z", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39cac87a45b52e65a570acf1edd903503dc4400c", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/39cac87a45b52e65a570acf1edd903503dc4400c", "committedDate": "2020-09-22T18:19:07Z", "message": "Merge branch 'master' into enhancement/mappers_same_exists_query"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3852, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}