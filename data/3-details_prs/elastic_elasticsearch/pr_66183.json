{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MTE3MjM2", "number": 66183, "title": "EQL: Enforce validation of key compatibility", "bodyText": "Currently the engine allows keys with different types to be specified\nfor joining.\nThis is problematic since it suggest there is an implicit normalization\nbeing applied which is not the case and further, might not be what the\nuser expects.\nInstead of letting this silent behavior in, the verifier now validates\nthat at least the types are compatible.\nDo note that this requires a follow-up for text vs strings.", "createdAt": "2020-12-10T17:41:12Z", "url": "https://github.com/elastic/elasticsearch/pull/66183", "merged": true, "mergeCommit": {"oid": "fcfb05be3870fccc560f5fd0e91237a5a9d8d12e"}, "closed": true, "closedAt": "2020-12-14T07:55:32Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk28bPgH2gAyNTM2MTE3MjM2OmJkMjA0ODFhN2Q0MDYyM2I4MzY4ZGI3MGI2MDYwYzcxM2JlNTNlNTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmAIS0gH2gAyNTM2MTE3MjM2OjM4NzUwMzI1ODJhNTE5OTVmNjRiYzliMzg5MDI2MzI2MTFmMjY2MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bd20481a7d40623b8368db70b6060c713be53e59", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd20481a7d40623b8368db70b6060c713be53e59", "committedDate": "2020-12-10T17:39:23Z", "message": "EQL: Enforce validation of key compatibility\n\nCurrently the engine allows keys with different types to be specified\nfor joining.\nThis is problematic since it suggest there is an implicit normalization\nbeing applied which is not the case and further, might not be what the\nuser expects.\nInstead of letting this silent behavior in, the verifier now validates\nthat at least the types are compatible.\nDo note that this requires a follow-up for text vs strings."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NDk2MTI0", "url": "https://github.com/elastic/elasticsearch/pull/66183#pullrequestreview-549496124", "createdAt": "2020-12-10T18:41:22Z", "commit": {"oid": "bd20481a7d40623b8368db70b6060c713be53e59"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwODYxMjcy", "url": "https://github.com/elastic/elasticsearch/pull/66183#pullrequestreview-550861272", "createdAt": "2020-12-12T20:51:06Z", "commit": {"oid": "bd20481a7d40623b8368db70b6060c713be53e59"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQyMDo1MTowNlrOIErhOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQyMDo1MTowNlrOIErhOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTc3ODIzNA==", "bodyText": "I would have chosen a slightly different error message, something that would made clearer that the incompatible types are to blame: key [X] type [Y] has an incompatible type with key [A] type [B].", "url": "https://github.com/elastic/elasticsearch/pull/66183#discussion_r541778234", "createdAt": "2020-12-12T20:51:06Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/analysis/Verifier.java", "diffHunk": "@@ -236,4 +244,35 @@ public Verifier(Metrics metrics) {\n \n         return failures;\n     }\n-}\n\\ No newline at end of file\n+\n+    private void checkJoinKeyTypes(LogicalPlan plan, Set<Failure> localFailures) {\n+        if (plan instanceof Join) {\n+            Join join = (Join) plan;\n+            List<KeyedFilter> queries = join.queries();\n+            KeyedFilter until = join.until();\n+            // pick first query and iterate its keys\n+            KeyedFilter first = queries.get(0);\n+            List<? extends NamedExpression> keys = first.keys();\n+            for (int keyIndex = 0; keyIndex < keys.size(); keyIndex++) {\n+                NamedExpression currentKey = keys.get(keyIndex);\n+                for (int i = 1; i < queries.size(); i++) {\n+                    KeyedFilter filter = queries.get(i);\n+                    doCheckKeyTypes(join, localFailures, currentKey, filter.keys().get(keyIndex));\n+                    if (until.keys().isEmpty() == false) {\n+                        doCheckKeyTypes(join, localFailures, currentKey, until.keys().get(keyIndex));\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    private static void doCheckKeyTypes(Join join, Set<Failure> localFailures, NamedExpression expectedKey, NamedExpression currentKey) {\n+        if (DataTypes.areCompatible(expectedKey.dataType(), currentKey.dataType()) == false) {\n+            localFailures.add(fail(currentKey, \"{} key [{}] type [{}] is incompatible with key [{}] type [{}]\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd20481a7d40623b8368db70b6060c713be53e59"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTc5OTUw", "url": "https://github.com/elastic/elasticsearch/pull/66183#pullrequestreview-550979950", "createdAt": "2020-12-14T00:16:44Z", "commit": {"oid": "bd20481a7d40623b8368db70b6060c713be53e59"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTgwMDAw", "url": "https://github.com/elastic/elasticsearch/pull/66183#pullrequestreview-550980000", "createdAt": "2020-12-14T00:17:01Z", "commit": {"oid": "bd20481a7d40623b8368db70b6060c713be53e59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3875032582a51995f64bc9b38902632611f26620", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/3875032582a51995f64bc9b38902632611f26620", "committedDate": "2020-12-14T06:55:25Z", "message": "Merge branch 'master' into eql/verify-key-types"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4568, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}