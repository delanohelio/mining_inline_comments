{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMjI0MzI1", "number": 60722, "title": "Fail searchable snapshot shards on invalid license", "bodyText": "Implements license degradation behavior for searchable snapshots. Snapshot-backed shards are failed when the license becomes invalid, and shards won't be reallocated. After valid license is put in place again, shards are allocated again.", "createdAt": "2020-08-05T08:15:34Z", "url": "https://github.com/elastic/elasticsearch/pull/60722", "merged": true, "mergeCommit": {"oid": "77d3f33a1750c72b952d8a966f4e82fed2d7625b"}, "closed": true, "closedAt": "2020-08-05T11:06:22Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc72sAKgH2gAyNDYzMjI0MzI1OjdkM2EwYzBkMjc3N2E3NTUxZDhlNDBhYmFkNjE2ZjAwYzc3NDAyMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc75CYMAFqTQ2MTU1MTY3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7d3a0c0d2777a7551d8e40abad616f00c7740223", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d3a0c0d2777a7551d8e40abad616f00c7740223", "committedDate": "2020-08-05T08:10:33Z", "message": "Fail searchable snapshot shards on invalid license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNDkyODc5", "url": "https://github.com/elastic/elasticsearch/pull/60722#pullrequestreview-461492879", "createdAt": "2020-08-05T09:27:08Z", "commit": {"oid": "7d3a0c0d2777a7551d8e40abad616f00c7740223"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwOToyNzowOVrOG8Bqcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwOToyODowM1rOG8BsfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU5NDk5NQ==", "bodyText": "failShard() does a lot of things, some of them involving IO, and we're doing this under the same mutex as the IndexEventListener methods which are called during cluster state updates. Are you sure that's ok?", "url": "https://github.com/elastic/elasticsearch/pull/60722#discussion_r465594995", "createdAt": "2020-08-05T09:27:09Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/FailShardsOnInvalidLicenseClusterListener.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.searchablesnapshots;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.lucene.store.AlreadyClosedException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.routing.RerouteService;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.Priority;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.shard.IndexEventListener;\n+import org.elasticsearch.index.shard.IndexShard;\n+import org.elasticsearch.index.shard.ShardId;\n+import org.elasticsearch.license.LicenseStateListener;\n+import org.elasticsearch.license.XPackLicenseState;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+public class FailShardsOnInvalidLicenseClusterListener implements LicenseStateListener, IndexEventListener {\n+\n+    private static final Logger logger = LogManager.getLogger(FailShardsOnInvalidLicenseClusterListener.class);\n+\n+    private final XPackLicenseState xPackLicenseState;\n+\n+    private final RerouteService rerouteService;\n+\n+    final Set<IndexShard> shardsToFail = new HashSet<>();\n+\n+    private boolean allowed;\n+\n+    public FailShardsOnInvalidLicenseClusterListener(XPackLicenseState xPackLicenseState, RerouteService rerouteService) {\n+        this.xPackLicenseState = xPackLicenseState;\n+        this.rerouteService = rerouteService;\n+        this.allowed = xPackLicenseState.isAllowed(XPackLicenseState.Feature.SEARCHABLE_SNAPSHOTS);\n+        xPackLicenseState.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void afterIndexShardStarted(IndexShard indexShard) {\n+        shardsToFail.add(indexShard);\n+        failActiveShardsIfNecessary();\n+    }\n+\n+    @Override\n+    public synchronized void beforeIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard, Settings indexSettings) {\n+        if (indexShard != null) {\n+            shardsToFail.remove(indexShard);\n+        }\n+    }\n+\n+    @Override\n+    public synchronized void licenseStateChanged() {\n+        final boolean allowed = xPackLicenseState.isAllowed(XPackLicenseState.Feature.SEARCHABLE_SNAPSHOTS);\n+        if (allowed && this.allowed == false) {\n+            rerouteService.reroute(\"reroute after license activation\", Priority.NORMAL, new ActionListener<ClusterState>() {\n+                @Override\n+                public void onResponse(ClusterState clusterState) {\n+                    logger.trace(\"successful reroute after license activation\");\n+                }\n+\n+                @Override\n+                public void onFailure(Exception e) {\n+                    logger.debug(\"unsuccessful reroute after license activation\");\n+                }\n+            });\n+        }\n+        this.allowed = allowed;\n+        failActiveShardsIfNecessary();\n+    }\n+\n+    private void failActiveShardsIfNecessary() {\n+        assert Thread.holdsLock(this);\n+        if (allowed == false) {\n+            for (IndexShard indexShard : shardsToFail) {\n+                try {\n+                    indexShard.failShard(\"invalid license\", null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d3a0c0d2777a7551d8e40abad616f00c7740223"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU5NTExOA==", "bodyText": "Perhaps name the shard in the message here?", "url": "https://github.com/elastic/elasticsearch/pull/60722#discussion_r465595118", "createdAt": "2020-08-05T09:27:22Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/FailShardsOnInvalidLicenseClusterListener.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.searchablesnapshots;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.lucene.store.AlreadyClosedException;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.routing.RerouteService;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.Priority;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.shard.IndexEventListener;\n+import org.elasticsearch.index.shard.IndexShard;\n+import org.elasticsearch.index.shard.ShardId;\n+import org.elasticsearch.license.LicenseStateListener;\n+import org.elasticsearch.license.XPackLicenseState;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+public class FailShardsOnInvalidLicenseClusterListener implements LicenseStateListener, IndexEventListener {\n+\n+    private static final Logger logger = LogManager.getLogger(FailShardsOnInvalidLicenseClusterListener.class);\n+\n+    private final XPackLicenseState xPackLicenseState;\n+\n+    private final RerouteService rerouteService;\n+\n+    final Set<IndexShard> shardsToFail = new HashSet<>();\n+\n+    private boolean allowed;\n+\n+    public FailShardsOnInvalidLicenseClusterListener(XPackLicenseState xPackLicenseState, RerouteService rerouteService) {\n+        this.xPackLicenseState = xPackLicenseState;\n+        this.rerouteService = rerouteService;\n+        this.allowed = xPackLicenseState.isAllowed(XPackLicenseState.Feature.SEARCHABLE_SNAPSHOTS);\n+        xPackLicenseState.addListener(this);\n+    }\n+\n+    @Override\n+    public synchronized void afterIndexShardStarted(IndexShard indexShard) {\n+        shardsToFail.add(indexShard);\n+        failActiveShardsIfNecessary();\n+    }\n+\n+    @Override\n+    public synchronized void beforeIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard, Settings indexSettings) {\n+        if (indexShard != null) {\n+            shardsToFail.remove(indexShard);\n+        }\n+    }\n+\n+    @Override\n+    public synchronized void licenseStateChanged() {\n+        final boolean allowed = xPackLicenseState.isAllowed(XPackLicenseState.Feature.SEARCHABLE_SNAPSHOTS);\n+        if (allowed && this.allowed == false) {\n+            rerouteService.reroute(\"reroute after license activation\", Priority.NORMAL, new ActionListener<ClusterState>() {\n+                @Override\n+                public void onResponse(ClusterState clusterState) {\n+                    logger.trace(\"successful reroute after license activation\");\n+                }\n+\n+                @Override\n+                public void onFailure(Exception e) {\n+                    logger.debug(\"unsuccessful reroute after license activation\");\n+                }\n+            });\n+        }\n+        this.allowed = allowed;\n+        failActiveShardsIfNecessary();\n+    }\n+\n+    private void failActiveShardsIfNecessary() {\n+        assert Thread.holdsLock(this);\n+        if (allowed == false) {\n+            for (IndexShard indexShard : shardsToFail) {\n+                try {\n+                    indexShard.failShard(\"invalid license\", null);\n+                } catch (AlreadyClosedException ignored) {\n+                    // ignore\n+                } catch (Exception e) {\n+                    logger.warn(\"Could not close index service due to invalid license\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d3a0c0d2777a7551d8e40abad616f00c7740223"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU5NTUxNg==", "bodyText": "Would prefer to invent an exception rather than passing null to failShard() here.", "url": "https://github.com/elastic/elasticsearch/pull/60722#discussion_r465595516", "createdAt": "2020-08-05T09:28:03Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/cluster/action/shard/ShardStateAction.java", "diffHunk": "@@ -395,6 +395,7 @@ public void clusterStatePublished(ClusterChangedEvent clusterChangedEvent) {\n         final String allocationId;\n         final long primaryTerm;\n         final String message;\n+        @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d3a0c0d2777a7551d8e40abad616f00c7740223"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1bba92263ca83426618e566f75221c1e754f498", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/b1bba92263ca83426618e566f75221c1e754f498", "committedDate": "2020-08-05T09:41:50Z", "message": "improve log message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98ccc9b9a214e5cd259023ef942b9300f962c35b", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/98ccc9b9a214e5cd259023ef942b9300f962c35b", "committedDate": "2020-08-05T09:53:14Z", "message": "fix testt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b8b5a85d4e7ad6fa5ecb32bd0b4a471a5c3e4ac", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b8b5a85d4e7ad6fa5ecb32bd0b4a471a5c3e4ac", "committedDate": "2020-08-05T09:54:00Z", "message": "Merge remote-tracking branch 'elastic/master' into license-degrad-searchsnap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c41fc9e0cc0ad67158a48f7dc67ee51668945914", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/c41fc9e0cc0ad67158a48f7dc67ee51668945914", "committedDate": "2020-08-05T10:06:43Z", "message": "jesus"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTUxNjc1", "url": "https://github.com/elastic/elasticsearch/pull/60722#pullrequestreview-461551675", "createdAt": "2020-08-05T10:54:48Z", "commit": {"oid": "c41fc9e0cc0ad67158a48f7dc67ee51668945914"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3526, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}