{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NTI5MTQ5", "number": 58518, "title": "Migrate plugin packaging tests to java", "bodyText": "This commit converts the bats tests for the plugin cli into the java\npackaging test framework. The new tests only use the example plugin to\ntest the plugin cli. The tests for each individual plugin's contents\nafter being installed are handled by a new unit test for the plugin\ninstaller added in #58287.", "createdAt": "2020-06-24T21:28:33Z", "url": "https://github.com/elastic/elasticsearch/pull/58518", "merged": true, "mergeCommit": {"oid": "2671ff7572d356932b4c42322e4cde3b2c2032df"}, "closed": true, "closedAt": "2020-06-25T20:38:41Z", "author": {"login": "rjernst"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcug6IFgH2gAyNDM5NTI5MTQ5OjkxOWFiMWI0MTdlNTliOTIwODFjZDA1YzcxNDhhOTE1YzM0ZmU1YWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcu0DKbgH2gAyNDM5NTI5MTQ5OjZkMTQ5MTMzN2RlOGQ0M2YzNWYyY2E5MDI1NTVjNTAxZDEwYWQ5NDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "919ab1b417e59b92081cd05c7148a915c34fe5ac", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/919ab1b417e59b92081cd05c7148a915c34fe5ac", "committedDate": "2020-06-24T21:27:03Z", "message": "Migrate plugin packaging tests to java\n\nThis commit converts the bats tests for the plugin cli into the java\npackaging test framework. The new tests only use the example plugin to\ntest the plugin cli. The tests for each individual plugin's contents\nafter being installed are handled by a new unit test for the plugin\ninstaller added in #58287."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7472717b2ff100c1a39ccf4aefe3d841388e1e1d", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/7472717b2ff100c1a39ccf4aefe3d841388e1e1d", "committedDate": "2020-06-24T21:30:00Z", "message": "remove debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3ad5fe6164e24f1b055b25fcd8da92afe162815", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/a3ad5fe6164e24f1b055b25fcd8da92afe162815", "committedDate": "2020-06-24T21:34:32Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76cc6045f816799b221360dcaf650f86b6e73e0c", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/76cc6045f816799b221360dcaf650f86b6e73e0c", "committedDate": "2020-06-24T22:20:03Z", "message": "use random hostname"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDYxNDEx", "url": "https://github.com/elastic/elasticsearch/pull/58518#pullrequestreview-437061411", "createdAt": "2020-06-24T22:57:26Z", "commit": {"oid": "76cc6045f816799b221360dcaf650f86b6e73e0c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa7e9c585757d420b9d5246de801f0af3cf697da", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa7e9c585757d420b9d5246de801f0af3cf697da", "committedDate": "2020-06-24T23:08:28Z", "message": "adjust for windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efb748c4e16a07b6026b64277bd30085dca6c077", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/efb748c4e16a07b6026b64277bd30085dca6c077", "committedDate": "2020-06-24T23:49:14Z", "message": "use uri for path"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NjQ3OTQ2", "url": "https://github.com/elastic/elasticsearch/pull/58518#pullrequestreview-437647946", "createdAt": "2020-06-25T16:11:20Z", "commit": {"oid": "efb748c4e16a07b6026b64277bd30085dca6c077"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjoxMToyMFrOGpBzUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjoxNToyNFrOGpB-cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3NDMyMA==", "bodyText": "Leftover?", "url": "https://github.com/elastic/elasticsearch/pull/58518#discussion_r445674320", "createdAt": "2020-06-25T16:11:20Z", "author": {"login": "nik9000"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Shell.java", "diffHunk": "@@ -200,9 +216,9 @@ private Result runScriptIgnoreExitCode(String[] command) {\n     private String readFileIfExists(Path path) throws IOException {\n         if (Files.exists(path)) {\n             long size = Files.size(path);\n-            if (size > 100 * 1024) {\n+            /*if (size > 100 * 1024) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efb748c4e16a07b6026b64277bd30085dca6c077"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3NzE3MQ==", "bodyText": "I don't remember why some of them booted ES and asserted that the example plugin looks good and some didn't. I think what you have here is fine though, just asserting that the installer didn't blow up is probably good enough in these cases so long as we have a single test that asserts that it did indeed install the plugin in all the way. And you have that above.\n\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/58518#discussion_r445677171", "createdAt": "2020-06-25T16:15:24Z", "author": {"login": "nik9000"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/PluginCliTests.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.packaging.test;\n+\n+import org.apache.http.client.fluent.Request;\n+import org.elasticsearch.packaging.util.Distribution;\n+import org.elasticsearch.packaging.util.Installation;\n+import org.elasticsearch.packaging.util.Platforms;\n+import org.elasticsearch.packaging.util.Shell;\n+import org.junit.Before;\n+\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+import static org.elasticsearch.packaging.util.ServerUtils.makeRequest;\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.junit.Assume.assumeTrue;\n+\n+public class PluginCliTests extends PackagingTestCase {\n+\n+    private static final String EXAMPLE_PLUGIN_NAME = \"custom-settings\";\n+    private static final Path EXAMPLE_PLUGIN_ZIP;\n+    static {\n+        // re-read before each test so the plugin path can be manipulated within tests\n+        EXAMPLE_PLUGIN_ZIP = Paths.get(System.getProperty(\"tests.example-plugin\"));\n+    }\n+\n+    @Before\n+    public void filterDistros() {\n+        assumeTrue(\"no docker\", distribution.packaging != Distribution.Packaging.DOCKER);\n+    }\n+\n+    @FunctionalInterface\n+    public interface PluginAction {\n+        void run(Shell.Result installResult) throws Exception;\n+    }\n+\n+    private Shell.Result assertWithPlugin(Installation.Executable pluginTool, Path pluginZip, String pluginName, PluginAction action)\n+        throws Exception {\n+        Shell.Result installResult = pluginTool.run(\"install --batch \\\"\" + pluginZip.toUri().toString() + \"\\\"\");\n+        action.run(installResult);\n+        return pluginTool.run(\"remove \" + pluginName);\n+    }\n+\n+    private void assertWithExamplePlugin(PluginAction action) throws Exception {\n+        assertWithPlugin(installation.executables().pluginTool, EXAMPLE_PLUGIN_ZIP, EXAMPLE_PLUGIN_NAME, action);\n+    }\n+\n+    public void test10Install() throws Exception {\n+        install();\n+    }\n+\n+    public void test20SymlinkPluginsDir() throws Exception {\n+        Path pluginsDir = installation.plugins;\n+        Path stashedPluginsDir = createTempDir(\"stashed-plugins\");\n+\n+        Files.delete(stashedPluginsDir); // delete so we can replace it\n+        Files.move(pluginsDir, stashedPluginsDir);\n+        Path linkedPlugins = createTempDir(\"symlinked-plugins\");\n+        Platforms.onLinux(() -> sh.run(\"chown elasticsearch:elasticsearch \" + linkedPlugins.toString()));\n+        Files.createSymbolicLink(pluginsDir, linkedPlugins);\n+        assertWithExamplePlugin(installResult -> {\n+            assertWhileRunning(() -> {\n+                final String pluginsResponse = makeRequest(Request.Get(\"http://localhost:9200/_cat/plugins?h=component\")).strip();\n+                assertThat(pluginsResponse, equalTo(EXAMPLE_PLUGIN_NAME));\n+\n+                String settingsPath = \"_cluster/settings?include_defaults&filter_path=defaults.custom.simple\";\n+                final String settingsResponse = makeRequest(Request.Get(\"http://localhost:9200/\" + settingsPath)).strip();\n+                assertThat(settingsResponse, equalTo(\"{\\\"defaults\\\":{\\\"custom\\\":{\\\"simple\\\":\\\"foo\\\"}}}\"));\n+            });\n+        });\n+\n+        Files.delete(pluginsDir);\n+        Files.move(stashedPluginsDir, pluginsDir);\n+    }\n+\n+    public void test21CustomConfDir() throws Exception {\n+        withCustomConfig(confPath -> assertWithExamplePlugin(installResult -> {}));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efb748c4e16a07b6026b64277bd30085dca6c077"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b6703d7e83d9927955a472cb152e331d1d3c740", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b6703d7e83d9927955a472cb152e331d1d3c740", "committedDate": "2020-06-25T16:35:34Z", "message": "set hostname for rpm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "784606128052e1e058cd0ccba8b50b9e805fbf10", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/784606128052e1e058cd0ccba8b50b9e805fbf10", "committedDate": "2020-06-25T16:45:37Z", "message": "make windows happy with quoted command path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6b662731b1cf38de3e3b9357b932b3ab83d95ce", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/d6b662731b1cf38de3e3b9357b932b3ab83d95ce", "committedDate": "2020-06-25T16:50:47Z", "message": "uncomment debugging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NzY4NDc1", "url": "https://github.com/elastic/elasticsearch/pull/58518#pullrequestreview-437768475", "createdAt": "2020-06-25T18:49:21Z", "commit": {"oid": "d6b662731b1cf38de3e3b9357b932b3ab83d95ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d1491337de8d43f35f2ca902555c501d10ad945", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/6d1491337de8d43f35f2ca902555c501d10ad945", "committedDate": "2020-06-25T19:45:07Z", "message": "better windows commands"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 421, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}