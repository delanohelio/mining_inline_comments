{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzOTI5NjUz", "number": 64461, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMDo0OTo0NVrOE0U3QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMjo1ODo1NlrOE0XgFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMzAzMjMzOnYy", "diffSide": "RIGHT", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMDo0OTo0NVrOHr_Uog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMTozNzowM1rOHsA3Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg4ODI5MA==", "bodyText": "This setting name might be confusing.  I would rename to max_number_of_snapshots.", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515888290", "createdAt": "2020-11-02T10:49:45Z", "author": {"login": "fcofdez"}, "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`size_limit`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a290c841b9a77cb86bec63fa402593b328f8059"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTkxMzQ4Mw==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515913483", "createdAt": "2020-11-02T11:37:03Z", "author": {"login": "original-brownbear"}, "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`size_limit`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg4ODI5MA=="}, "originalCommit": {"oid": "4a290c841b9a77cb86bec63fa402593b328f8059"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMzQ1Mjc3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMjo1NTo0MVrOHsDNYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMjo1NTo0MVrOHsDNYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MTk2OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +\n          \n          \n            \n                            listener.onFailure(new RepositoryException(metadata.name(), \"Cannot add another snapshot to this repository as it \" +", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515951968", "createdAt": "2020-11-02T12:55:41Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1081,6 +1094,14 @@ public void finalizeSnapshot(final ShardGenerations shardGenerations,\n         final StepListener<RepositoryData> repoDataListener = new StepListener<>();\n         getRepositoryData(repoDataListener);\n         repoDataListener.whenComplete(existingRepositoryData -> {\n+            final int existingSnapshotCount = existingRepositoryData.getSnapshotIds().size();\n+            if (existingSnapshotCount >= maxSnapshotCount) {\n+                listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMzQ1NjU0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMjo1Njo0N1rOHsDPug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMzoxMzo0OFrOHsD06g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MjU3MA==", "bodyText": "I think we should name the setting in the message (as done here) but think we shouldn't recommend increasing it if you hit the limit and should instead suggest deleting some snapshots and/or adjusting retention settings to bring the snapshot count below the limit.", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515952570", "createdAt": "2020-11-02T12:56:47Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1081,6 +1094,14 @@ public void finalizeSnapshot(final ShardGenerations shardGenerations,\n         final StepListener<RepositoryData> repoDataListener = new StepListener<>();\n         getRepositoryData(repoDataListener);\n         repoDataListener.whenComplete(existingRepositoryData -> {\n+            final int existingSnapshotCount = existingRepositoryData.getSnapshotIds().size();\n+            if (existingSnapshotCount >= maxSnapshotCount) {\n+                listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +\n+                        \"already contains [\" + existingSnapshotCount + \"] snapshots and is configured to hold up to [\" + maxSnapshotCount +\n+                        \"] snapshots only. Please increase repository setting [\" + MAX_SNAPSHOTS_SETTING.getKey() +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk2MjA5MA==", "bodyText": "++ adjusted the exception message", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515962090", "createdAt": "2020-11-02T13:13:48Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1081,6 +1094,14 @@ public void finalizeSnapshot(final ShardGenerations shardGenerations,\n         final StepListener<RepositoryData> repoDataListener = new StepListener<>();\n         getRepositoryData(repoDataListener);\n         repoDataListener.whenComplete(existingRepositoryData -> {\n+            final int existingSnapshotCount = existingRepositoryData.getSnapshotIds().size();\n+            if (existingSnapshotCount >= maxSnapshotCount) {\n+                listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +\n+                        \"already contains [\" + existingSnapshotCount + \"] snapshots and is configured to hold up to [\" + maxSnapshotCount +\n+                        \"] snapshots only. Please increase repository setting [\" + MAX_SNAPSHOTS_SETTING.getKey() +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MjU3MA=="}, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMzQ2MDAzOnYy", "diffSide": "RIGHT", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMjo1NzozNVrOHsDRtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMjo1NzozNVrOHsDRtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MzA3OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting\n          \n          \n            \n            scale indefinitely in size and might lead to master node performance and stability issues if they grow past a certain size. We do not recommend increasing this setting.", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515953078", "createdAt": "2020-11-02T12:57:35Z", "author": {"login": "DaveCTurner"}, "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`max_number_of_snapshots`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not\n+scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMzQ2NDU1OnYy", "diffSide": "RIGHT", "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMjo1ODo1NlrOHsDUfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMzowMjoxNVrOHsDbnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1Mzc5MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            is generally not advisable and should be weighted carefully against alternatives such as deleting older snapshots or creating multiple repositories.\n          \n          \n            \n            Instead you should delete older snapshots or use multiple repositories.\n          \n      \n    \n    \n  \n\nIs creating multiple repositories really a solution?", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515953791", "createdAt": "2020-11-02T12:58:56Z", "author": {"login": "DaveCTurner"}, "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`max_number_of_snapshots`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not\n+scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting\n+is generally not advisable and should be weighted carefully against alternatives such as deleting older snapshots or creating multiple repositories.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1NTYxMg==", "bodyText": "I guess technically yes, not a great one but you could run two (or more) SLM policies that take turns creating snapshots I suppose. That way you could have a much longer retention time at high resolution.\nAlso, if you just want certain snapshots to live for a long time maybe it's a solution.\n... certainly all of these aren't super ergonomically but I guess for some use-cases these are valid?", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515955612", "createdAt": "2020-11-02T13:02:15Z", "author": {"login": "original-brownbear"}, "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`max_number_of_snapshots`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not\n+scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting\n+is generally not advisable and should be weighted carefully against alternatives such as deleting older snapshots or creating multiple repositories.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1Mzc5MQ=="}, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4136, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}