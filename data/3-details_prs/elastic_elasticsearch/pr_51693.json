{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MjA5NzIx", "number": 51693, "title": "Wire PercentileRanks aggregator into new VS framework ", "bodyText": "Depends on #51639, so no need to review until that PR merges :)\nTakes the same approach as #51639 and consolidates the factories into a single factory.  Reuses the PercentilesConfig object to pass around algo-specific settings, and reuses the PercentilesAggregatorSupplier because the constructor parameters are the same.", "createdAt": "2020-01-30T17:57:23Z", "url": "https://github.com/elastic/elasticsearch/pull/51693", "merged": true, "mergeCommit": {"oid": "52de1e80c371010c011495ddc9964bac8b60a9aa"}, "closed": true, "closedAt": "2020-03-03T18:30:55Z", "author": {"login": "polyfractal"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_JPXMgH2gAyMzY5MjA5NzIxOmE5NTRiMTUwMDU5ZDhjNDA5MGM1ZWY1MDY0YTYwZDgxMjQ2ZWQ3MWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKFKFgAH2gAyMzY5MjA5NzIxOmRjZjAxNGJhZTQ3YzZkZmEzOGU1YTVhNWY1MmMwMzI0ODg1NGU0OTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a954b150059d8c4090c5ef5064a60d81246ed71c", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/a954b150059d8c4090c5ef5064a60d81246ed71c", "committedDate": "2020-01-29T17:18:05Z", "message": "Wire Percentiles aggregator into new VS framework\n\nThis required a bit of a refactor to percentiles itself.  Before,\nthe Builder would switch on the chosen algo to generate an\nalgo-specific factory.  This doesn't work (or at least, would be\ndifficult) in the new VS framework.\n\nThis refactor consolidates both factories together and introduces\na PercentilesConfig object to act as a standardized way to pass\nalgo-specific parameters through the factory.  This object\nis then used when deciding which kind of aggregator to create\n\nNote: CoreValuesSourceType.HISTOGRAM still lives in core, and will\nbe moved in a subsequent PR."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad19003291f41b9c9218058bddda9d6e2f1983ac", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/ad19003291f41b9c9218058bddda9d6e2f1983ac", "committedDate": "2020-01-30T17:52:23Z", "message": "Wire PercentileRanks aggregator into new VS framework\n\nLike Percentiles, this refactors consolidates both factories\ntogether, using PercentilesConfig object to act as a standardized\nway to pass algo-specific parameters through the factory."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d89f70f3f40c9187fec3687227b217c6764d19ee", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/d89f70f3f40c9187fec3687227b217c6764d19ee", "committedDate": "2020-01-31T18:15:35Z", "message": "Merge branch 'feature/extensible-values-source' into vs_percentile_ranks_refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d70449879ac2b5beb66e855562ef312760fe374f", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/d70449879ac2b5beb66e855562ef312760fe374f", "committedDate": "2020-01-31T18:17:40Z", "message": "Throw IllegalStateException for bad methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMzcwNjM1", "url": "https://github.com/elastic/elasticsearch/pull/51693#pullrequestreview-352370635", "createdAt": "2020-02-03T16:07:24Z", "commit": {"oid": "d70449879ac2b5beb66e855562ef312760fe374f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNjowNzoyNFrOFk20cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNjoxMTo1N1rOFk2_Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE5MTIxOA==", "bodyText": "In conjunction with my comment below, I think it makes sense for the config object to live with the PercentilesMethod enum, rather than one of the builders.  Kind of arbitrary which builder it lands on.", "url": "https://github.com/elastic/elasticsearch/pull/51693#discussion_r374191218", "createdAt": "2020-02-03T16:07:24Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentileRanksAggregationBuilder.java", "diffHunk": "@@ -30,19 +30,22 @@\n import org.elasticsearch.search.aggregations.AggregationBuilder;\n import org.elasticsearch.search.aggregations.AggregatorFactories.Builder;\n import org.elasticsearch.search.aggregations.AggregatorFactory;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesAggregationBuilder.PercentilesConfig;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d70449879ac2b5beb66e855562ef312760fe374f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE5MzkyMg==", "bodyText": "We've got this same cascading if in two places now, and cascading if or switch blocks on enums are kind of dodgy to begin with.  I propose a method on PercentilesMethod that takes two args, compression and number of significant digits, ignores whichever doesn't apply to that method, and returns the config.  This has the added benefit that we don't need the unreachable throw block here (unreachable since it would have already thrown trying to parse the bad method name)", "url": "https://github.com/elastic/elasticsearch/pull/51693#discussion_r374193922", "createdAt": "2020-02-03T16:11:57Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentileRanksAggregationBuilder.java", "diffHunk": "@@ -246,16 +256,17 @@ public PercentilesMethod method() {\n     @Override\n     protected ValuesSourceAggregatorFactory innerBuild(QueryShardContext queryShardContext, ValuesSourceConfig config,\n                                                        AggregatorFactory parent, Builder subFactoriesBuilder) throws IOException {\n-        switch (method) {\n-        case TDIGEST:\n-            return new TDigestPercentileRanksAggregatorFactory(name, config, values, compression, keyed, queryShardContext, parent,\n-                    subFactoriesBuilder, metaData);\n-        case HDR:\n-            return new HDRPercentileRanksAggregatorFactory(name, config, values, numberOfSignificantValueDigits, keyed, queryShardContext,\n-                    parent, subFactoriesBuilder, metaData);\n-        default:\n+        PercentilesConfig percentilesConfig;\n+        if (method.equals(PercentilesMethod.TDIGEST)) {\n+            percentilesConfig = new PercentilesConfig.TDigestConfig(compression);\n+        } else if (method.equals(PercentilesMethod.HDR)) {\n+            percentilesConfig = new PercentilesConfig.HdrHistoConfig(numberOfSignificantValueDigits);\n+        } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d70449879ac2b5beb66e855562ef312760fe374f"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a536eda62b3ff742d05062e8ca861b1d44a3b16", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a536eda62b3ff742d05062e8ca861b1d44a3b16", "committedDate": "2020-02-12T19:01:11Z", "message": "Merge branch 'feature/extensible-values-source' into vs_percentile_ranks_refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDQxODU2", "url": "https://github.com/elastic/elasticsearch/pull/51693#pullrequestreview-360441856", "createdAt": "2020-02-18T15:38:28Z", "commit": {"oid": "8a536eda62b3ff742d05062e8ca861b1d44a3b16"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTozODoyOFrOFrHRMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTo0MTowNlrOFrHYVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1MjE3Nw==", "bodyText": "Nit: Inconsistent indentation", "url": "https://github.com/elastic/elasticsearch/pull/51693#discussion_r380752177", "createdAt": "2020-02-18T15:38:28Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/SearchModule.java", "diffHunk": "@@ -360,7 +360,8 @@ private void registerAggregations(List<SearchPlugin> plugins) {\n         registerAggregation(new AggregationSpec(PercentileRanksAggregationBuilder.NAME, PercentileRanksAggregationBuilder::new,\n                 PercentileRanksAggregationBuilder::parse)\n                         .addResultReader(InternalTDigestPercentileRanks.NAME, InternalTDigestPercentileRanks::new)\n-                        .addResultReader(InternalHDRPercentileRanks.NAME, InternalHDRPercentileRanks::new));\n+                        .addResultReader(InternalHDRPercentileRanks.NAME, InternalHDRPercentileRanks::new)\n+                .setAggregatorRegistrar(PercentileRanksAggregationBuilder::registerAggregators));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a536eda62b3ff742d05062e8ca861b1d44a3b16"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc1NDAwNQ==", "bodyText": "Are we intentionally not supporting dates here? Do we allow percentile ranks over date fields now?  I'm actually not sure, but we should probably make sure we're not losing functionality by accident.", "url": "https://github.com/elastic/elasticsearch/pull/51693#discussion_r380754005", "createdAt": "2020-02-18T15:41:06Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/PercentileRanksAggregatorFactory.java", "diffHunk": "@@ -39,6 +44,22 @@\n     private final PercentilesConfig percentilesConfig;\n     private final boolean keyed;\n \n+    static void registerAggregators(ValuesSourceRegistry valuesSourceRegistry) {\n+        valuesSourceRegistry.register(PercentileRanksAggregationBuilder.NAME,\n+            List.of(CoreValuesSourceType.NUMERIC, CoreValuesSourceType.HISTOGRAM),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a536eda62b3ff742d05062e8ca861b1d44a3b16"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e032424911e5229e72cca5d8e2fc0e53552ef73a", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/e032424911e5229e72cca5d8e2fc0e53552ef73a", "committedDate": "2020-03-02T20:42:04Z", "message": "Merge branch 'feature/extensible-values-source' into vs_percentile_ranks_refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc6693e2e0d96d54e8554146a4f1c8c655a5d902", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc6693e2e0d96d54e8554146a4f1c8c655a5d902", "committedDate": "2020-03-02T21:27:51Z", "message": "Adjust supported types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f607c3a4e2c992e1c97c12249fd91ac8e530ed7", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f607c3a4e2c992e1c97c12249fd91ac8e530ed7", "committedDate": "2020-03-02T21:37:31Z", "message": "Fix formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NTk4ODIz", "url": "https://github.com/elastic/elasticsearch/pull/51693#pullrequestreview-367598823", "createdAt": "2020-03-02T23:13:28Z", "commit": {"oid": "1f607c3a4e2c992e1c97c12249fd91ac8e530ed7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcf014bae47c6dfa38e5a5a5f52c03248854e493", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/dcf014bae47c6dfa38e5a5a5f52c03248854e493", "committedDate": "2020-03-03T16:45:52Z", "message": "Merge branch 'feature/extensible-values-source' into vs_percentile_ranks_refactor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3114, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}