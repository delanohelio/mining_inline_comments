{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjY2NDI0", "number": 65775, "title": "[7.x] [ML] adding ml autoscaling integration test (#65638)", "bodyText": "Backports the following commits to 7.x:\n\n[ML] adding ml autoscaling integration test (#65638)", "createdAt": "2020-12-02T20:18:22Z", "url": "https://github.com/elastic/elasticsearch/pull/65775", "merged": true, "mergeCommit": {"oid": "4d8bba37d47d32bce66161ba78759e4be6ad90b8"}, "closed": true, "closedAt": "2020-12-03T14:20:21Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiUVdWAH2gAyNTMxMjY2NDI0OjU4OGZmZjQ2ZDFkZmMwOGY2YThiNTU0NjUzZWJjZmVmZWY2NGM0ZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkeh4UAFqTU0ODE2NzY1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "588fff46d1dfc08f6a8b554653ebcfefef64c4f6", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/588fff46d1dfc08f6a8b554653ebcfefef64c4f6", "committedDate": "2020-12-02T20:12:12Z", "message": "[ML] adding ml autoscaling integration test (#65638)\n\nThis adds ml autoscaling integration tests.\n\nThe test verifies that the scaling requirements adjust according to the current real load\non the cluster given machine learning jobs of various sizes.\n\nAdditionally, there was a bug in the ml scaling service settings. This commit addresses the bug."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e33ced7312a94822abcf2468d631263f1b9bc6bb", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/e33ced7312a94822abcf2468d631263f1b9bc6bb", "committedDate": "2020-12-03T12:14:11Z", "message": "attempting to fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4e990bc20a9137957dd48f0eb3b5c9b37d66db6", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4e990bc20a9137957dd48f0eb3b5c9b37d66db6", "committedDate": "2020-12-03T13:39:40Z", "message": "fixing tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTY3NjU5", "url": "https://github.com/elastic/elasticsearch/pull/65775#pullrequestreview-548167659", "createdAt": "2020-12-09T13:12:39Z", "commit": {"oid": "d4e990bc20a9137957dd48f0eb3b5c9b37d66db6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzoxMjo0MFrOICT62g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzoxMjo0MFrOICT62g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5NDQyNg==", "bodyText": "@benwtrent do you know why this did not work? It is preventing me from getting #66082 merged.", "url": "https://github.com/elastic/elasticsearch/pull/65775#discussion_r539294426", "createdAt": "2020-12-09T13:12:40Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/AutoscalingIT.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.integration;\n+\n+import org.elasticsearch.action.admin.cluster.node.info.NodeInfo;\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.autoscaling.Autoscaling;\n+import org.elasticsearch.xpack.autoscaling.action.GetAutoscalingCapacityAction;\n+import org.elasticsearch.xpack.autoscaling.action.PutAutoscalingPolicyAction;\n+import org.elasticsearch.xpack.autoscaling.capacity.AutoscalingDeciderResult;\n+import org.elasticsearch.xpack.autoscaling.capacity.AutoscalingDeciderResults;\n+import org.elasticsearch.xpack.core.ml.job.config.AnalysisConfig;\n+import org.elasticsearch.xpack.core.ml.job.config.AnalysisLimits;\n+import org.elasticsearch.xpack.core.ml.job.config.DataDescription;\n+import org.elasticsearch.xpack.core.ml.job.config.Detector;\n+import org.elasticsearch.xpack.core.ml.job.config.Job;\n+import org.elasticsearch.xpack.ml.MachineLearning;\n+import org.elasticsearch.xpack.ml.autoscaling.MlAutoscalingDeciderService;\n+import org.elasticsearch.xpack.ml.autoscaling.NativeMemoryCapacity;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+import java.util.TreeSet;\n+import java.util.stream.Collectors;\n+\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasKey;\n+\n+public class AutoscalingIT extends MlNativeAutodetectIntegTestCase {\n+\n+    private static final long BASIC_REQUIREMENT_MB = 10;\n+    private static final long NATIVE_PROCESS_OVERHEAD_MB = 30;\n+    private static final long BASELINE_OVERHEAD_MB = BASIC_REQUIREMENT_MB + NATIVE_PROCESS_OVERHEAD_MB;\n+\n+    // This test assumes that xpack.ml.max_machine_memory_percent is 30\n+    // and that xpack.ml.use_auto_machine_memory_percent is false\n+    public void testMLAutoscalingCapacity() {\n+        SortedMap<String, Settings> deciders = new TreeMap<>();\n+        deciders.put(MlAutoscalingDeciderService.NAME,\n+            Settings.builder().put(MlAutoscalingDeciderService.DOWN_SCALE_DELAY.getKey(), TimeValue.ZERO).build());\n+        final PutAutoscalingPolicyAction.Request request = new PutAutoscalingPolicyAction.Request(\n+            \"ml_test\",\n+            new TreeSet<>(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4e990bc20a9137957dd48f0eb3b5c9b37d66db6"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4115, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}