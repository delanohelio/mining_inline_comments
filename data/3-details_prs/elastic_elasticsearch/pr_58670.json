{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNDE3NTQ2", "number": 58670, "title": "Accounting for model size when models are not cached.", "bodyText": "When a model is loaded the amount of memory it uses is registered with the circuit breaker. If the model is evicted from the ModelLoadingService cache it still uses memory and that memory should not be removed from the circuit breaker until there are no users of the model.\nThis is achieved with simple reference counting. When a model is retrieved from the ModelLoadingService the count is incremented. It is dependant on the user decrementing the count when the model is not longer required. LocalModels are created with a reference count of 1 because of reference held by the ModelLoadingService cache. When the model is evicted from the cache the cache decrements the count.\nNote a reference count of 0 does not mean the model has been garbage collected this is best effort circuit breaker accounting not real memory usage.\nThe Model interface wasn't serving much of a purpose, the only class implementing it is LocalModel and some of the methods were unused so I deleted it. We have lots of classes named SomeKindOfModel, conceptually this is one less class to think about", "createdAt": "2020-06-29T13:33:04Z", "url": "https://github.com/elastic/elasticsearch/pull/58670", "merged": true, "mergeCommit": {"oid": "836e4f938910bfe9c86471c7372094ffe80043e7"}, "closed": true, "closedAt": "2020-07-13T16:26:25Z", "author": {"login": "davidkyle"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwCLBpAFqTQzOTE4MjM2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0jUB9AFqTQ0NzM2OTA1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MTgyMzY3", "url": "https://github.com/elastic/elasticsearch/pull/58670#pullrequestreview-439182367", "createdAt": "2020-06-29T14:09:56Z", "commit": {"oid": "c2ca0c55d0734f92b7707577870a1076413a21fd"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDowOTo1NlrOGqSwnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo0NjowOFrOGqUZ2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAwMDczNQ==", "bodyText": "We might want to make this package private. It seems that if we want to make sure that the circuit breaker stuff is handled correctly, that only things within this package should be able to ctor the model", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r447000735", "createdAt": "2020-06-29T14:09:56Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -39,14 +50,17 @@\n     private volatile long persistenceQuotient = 100;\n     private final LongAdder currentInferenceCount;\n     private final InferenceConfig inferenceConfig;\n+    private final CircuitBreaker trainedModelCircuitBreaker;\n+    private final AtomicLong referenceCount;\n \n     public LocalModel(String modelId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ca0c55d0734f92b7707577870a1076413a21fd"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAwMDg2OA==", "bodyText": "What do you think of adding a check on referenceCount to throw if it is 0?", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r447000868", "createdAt": "2020-06-29T14:10:07Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -97,7 +97,6 @@ void persistStats(boolean flush) {\n         }\n     }\n \n-    @Override\n     public void infer(Map<String, Object> fields, InferenceConfigUpdate update, ActionListener<InferenceResults> listener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ca0c55d0734f92b7707577870a1076413a21fd"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAwMjg0Mg==", "bodyText": "think we need a test here or something?\nWe might also want some tests to verify that our circuit breaker ends up back as zero. (Could be this same test).", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r447002842", "createdAt": "2020-06-29T14:12:48Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingServiceTests.java", "diffHunk": "@@ -451,6 +451,10 @@ public void testCircuitBreakerBreak() throws Exception {\n         });\n     }\n \n+    public void testReferenceCounting() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ca0c55d0734f92b7707577870a1076413a21fd"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAwMzc5Mw==", "bodyText": "package private? The only way to \"get\" a trained model object should be through a known code path. so, we should restrict their construction and restrict this method as well.", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r447003793", "createdAt": "2020-06-29T14:14:17Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -135,4 +134,39 @@ public void infer(Map<String, Object> fields, InferenceConfigUpdate update, Acti\n         }\n     }\n \n+    public long acquire() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ca0c55d0734f92b7707577870a1076413a21fd"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAwNzEyNA==", "bodyText": "referenceCount.incrementAndGet() should always be > 1 correct? Do we want to prevent an acquire if the reference count has already reached zero?", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r447007124", "createdAt": "2020-06-29T14:18:39Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -135,4 +134,39 @@ public void infer(Map<String, Object> fields, InferenceConfigUpdate update, Acti\n         }\n     }\n \n+    public long acquire() {\n+        return referenceCount.incrementAndGet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ca0c55d0734f92b7707577870a1076413a21fd"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAxMjIxNw==", "bodyText": "I wish our ActionListener classes had a finally clause....Not to signal the listener but to do things like our release or close here.", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r447012217", "createdAt": "2020-06-29T14:25:34Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportInternalInferModelAction.java", "diffHunk": "@@ -65,9 +65,14 @@ protected void doExecute(Task task, Request request, ActionListener<Response> li\n                         model.infer(stringObjectMap, request.getUpdate(), chainedTask)));\n \n                 typedChainTaskExecutor.execute(ActionListener.wrap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ca0c55d0734f92b7707577870a1076413a21fd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAyNzY3NA==", "bodyText": "This might have a race condition (will think more)\n\nModel is grabbed from cache in 203. Model has a ref count of 1\nModel is evicted from cache due to size or something\nRef count is now 0\nModel is attempted to acquire again but ref count 0 and the bytes are already removed from the breaker", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r447027674", "createdAt": "2020-06-29T14:46:08Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingService.java", "diffHunk": "@@ -193,10 +199,11 @@ public void getModelForSearch(String modelId, ActionListener<Model> modelActionL\n      * @param consumer            which feature is requesting the model\n      * @param modelActionListener the listener to alert when the model has been retrieved.\n      */\n-    private void getModel(String modelId, Consumer consumer, ActionListener<Model> modelActionListener) {\n+    private void getModel(String modelId, Consumer consumer, ActionListener<LocalModel> modelActionListener) {\n         ModelAndConsumer cachedModel = localModelCache.get(modelId);\n         if (cachedModel != null) {\n             cachedModel.consumers.add(consumer);\n+            cachedModel.model.acquire();\n             modelActionListener.onResponse(cachedModel.model);\n             logger.trace(() -> new ParameterizedMessage(\"[{}] loaded from cache\", modelId));\n             return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2ca0c55d0734f92b7707577870a1076413a21fd"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2ca0c55d0734f92b7707577870a1076413a21fd", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/c2ca0c55d0734f92b7707577870a1076413a21fd", "committedDate": "2020-06-29T13:16:37Z", "message": "Add javadoc"}, "afterCommit": {"oid": "6920e9a57e3da6128701a547fef8ab8eb0812b3b", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/6920e9a57e3da6128701a547fef8ab8eb0812b3b", "committedDate": "2020-07-01T08:04:23Z", "message": "Add javadoc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6920e9a57e3da6128701a547fef8ab8eb0812b3b", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/6920e9a57e3da6128701a547fef8ab8eb0812b3b", "committedDate": "2020-07-01T08:04:23Z", "message": "Add javadoc"}, "afterCommit": {"oid": "26801a5e2d6e9ca59ca2e1823af0360647b11396", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/26801a5e2d6e9ca59ca2e1823af0360647b11396", "committedDate": "2020-07-13T12:03:47Z", "message": "Reference counting tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MjYwNTg2", "url": "https://github.com/elastic/elasticsearch/pull/58670#pullrequestreview-447260586", "createdAt": "2020-07-13T13:40:58Z", "commit": {"oid": "26801a5e2d6e9ca59ca2e1823af0360647b11396"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo0MDo1OVrOGwpDIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo0MDo1OVrOGwpDIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1NzM3Nw==", "bodyText": "The diff is bad. The change here is this line then indenting everything", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r453657377", "createdAt": "2020-07-13T13:40:59Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregator.java", "diffHunk": "@@ -49,69 +49,74 @@ public InferencePipelineAggregator(String name, Map<String,\n     @Override\n     public InternalAggregation reduce(InternalAggregation aggregation, InternalAggregation.ReduceContext reduceContext) {\n \n-        InternalMultiBucketAggregation<InternalMultiBucketAggregation, InternalMultiBucketAggregation.InternalBucket> originalAgg =\n-            (InternalMultiBucketAggregation<InternalMultiBucketAggregation, InternalMultiBucketAggregation.InternalBucket>) aggregation;\n-        List<? extends InternalMultiBucketAggregation.InternalBucket> buckets = originalAgg.getBuckets();\n-\n-        List<InternalMultiBucketAggregation.InternalBucket> newBuckets = new ArrayList<>();\n-        for (InternalMultiBucketAggregation.InternalBucket bucket : buckets) {\n-            Map<String, Object> inputFields = new HashMap<>();\n-\n-            if (bucket.getDocCount() == 0) {\n-                // ignore this empty bucket unless the doc count is used\n-                if (bucketPathMap.containsKey(\"_count\") == false) {\n-                    newBuckets.add(bucket);\n-                    continue;\n+        try (model) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26801a5e2d6e9ca59ca2e1823af0360647b11396"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzA0OTM3", "url": "https://github.com/elastic/elasticsearch/pull/58670#pullrequestreview-447304937", "createdAt": "2020-07-13T14:29:43Z", "commit": {"oid": "fb2073f0bd69868b46f4e80089ee1ccb83183dc7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDoyOTo0M1rOGwrILg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDo0MjoyNlrOGwrssw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY5MTQzOA==", "bodyText": "Do we need this with the call to updateCircuitBreakerEstimate", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r453691438", "createdAt": "2020-07-13T14:29:43Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingService.java", "diffHunk": "@@ -256,8 +274,16 @@ private void loadModel(String modelId, Consumer consumer) {\n                 trainedModelCircuitBreaker.addEstimateBytesAndMaybeBreak(trainedModelConfig.getEstimatedHeapMemory(), modelId);\n                 provider.getTrainedModelForInference(modelId, ActionListener.wrap(\n                     inferenceDefinition -> {\n-                        // Since we have used the previously stored estimate to help guard against OOM we need to adjust the memory\n-                        // So that the memory this model uses in the circuit breaker is the most accurate estimate.\n+                        try {\n+                            // Since we have used the previously stored estimate to help guard against OOM we need\n+                            // to adjust the memory so that the memory this model uses in the circuit breaker\n+                            // is the most accurate estimate.\n+                            updateCircuitBreakerEstimate(modelId, inferenceDefinition, trainedModelConfig);\n+                        } catch (CircuitBreakingException ex) {\n+                            handleLoadFailure(modelId, ex);\n+                            return;\n+                        }\n+\n                         long estimateDiff = inferenceDefinition.ramBytesUsed() - trainedModelConfig.getEstimatedHeapMemory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2073f0bd69868b46f4e80089ee1ccb83183dc7"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY5ODQ1Ng==", "bodyText": "\ud83e\udd14\nacquire() could throw.\nI know it is rare, but there is nothing preventing the model being evicted from cache before these listeners are notified.\nMaybe call acquire before putting in cache.\nThen, outside the sync block, calling loadedModel.release() once all the listeners have been notified?\nIt seems funky, but it guarantees the acquire in the listener loop will not throw as it will never reach 0.", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r453698456", "createdAt": "2020-07-13T14:39:18Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingService.java", "diffHunk": "@@ -337,19 +385,21 @@ private void handleLoadSuccess(String modelId,\n             trainedModelConfig.getInput(),\n             trainedModelConfig.getDefaultFieldMap(),\n             inferenceConfig,\n-            modelStatsService);\n+            modelStatsService,\n+            trainedModelCircuitBreaker);\n         synchronized (loadingListeners) {\n             listeners = loadingListeners.remove(modelId);\n             // If there is no loadingListener that means the loading was canceled and the listener was already notified as such\n             // Consequently, we should not store the retrieved model\n             if (listeners == null) {\n-                trainedModelCircuitBreaker.addWithoutBreaking(-inferenceDefinition.ramBytesUsed());\n+                loadedModel.release();\n                 return;\n             }\n             localModelCache.put(modelId, new ModelAndConsumer(loadedModel, consumer));\n             shouldNotAudit.remove(modelId);\n         } // synchronized (loadingListeners)\n         for (ActionListener<LocalModel> listener = listeners.poll(); listener != null; listener = listeners.poll()) {\n+            loadedModel.acquire();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2073f0bd69868b46f4e80089ee1ccb83183dc7"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcwMDQ1Nw==", "bodyText": "Could you add a comment about how this is to protect the reference race condition where release was called but then it was acquired again?", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r453700457", "createdAt": "2020-07-13T14:41:58Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -169,4 +188,33 @@ public static void mapFieldsIfNecessary(Map<String, Object> fields, Map<String,\n             });\n         }\n     }\n+\n+    long acquire() {\n+        long count = referenceCount.incrementAndGet();\n+        if (count == 1) {\n+            trainedModelCircuitBreaker.addEstimateBytesAndMaybeBreak(trainedModelDefinition.ramBytesUsed(), modelId);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2073f0bd69868b46f4e80089ee1ccb83183dc7"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcwMDc4Nw==", "bodyText": "should we prevent release from ever decrementing below 0?", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r453700787", "createdAt": "2020-07-13T14:42:26Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -169,4 +188,33 @@ public static void mapFieldsIfNecessary(Map<String, Object> fields, Map<String,\n             });\n         }\n     }\n+\n+    long acquire() {\n+        long count = referenceCount.incrementAndGet();\n+        if (count == 1) {\n+            trainedModelCircuitBreaker.addEstimateBytesAndMaybeBreak(trainedModelDefinition.ramBytesUsed(), modelId);\n+        }\n+        return count;\n+    }\n+\n+    public long getReferenceCount() {\n+        return referenceCount.get();\n+    }\n+\n+    public long release() {\n+        if (referenceCount.decrementAndGet() == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb2073f0bd69868b46f4e80089ee1ccb83183dc7"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84647658e1ad55010f90dd946f3f5ab4c39a5776", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/84647658e1ad55010f90dd946f3f5ab4c39a5776", "committedDate": "2020-07-13T14:51:59Z", "message": "Add reference counting to LocalModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "325c3992a3cfcd5fef1ffbf7c19805a6b1c21edb", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/325c3992a3cfcd5fef1ffbf7c19805a6b1c21edb", "committedDate": "2020-07-13T14:51:59Z", "message": "Remove the Model interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8ffd813f8ee9a308a82455b666811ae93098baa", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/b8ffd813f8ee9a308a82455b666811ae93098baa", "committedDate": "2020-07-13T14:51:59Z", "message": "Add javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc76cfe3e5191c70b75364a0f6bfd967da49ecaf", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/fc76cfe3e5191c70b75364a0f6bfd967da49ecaf", "committedDate": "2020-07-13T14:51:59Z", "message": "Better accounting and tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "895d8f5b856566622941785ab0554ec67fc47e5d", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/895d8f5b856566622941785ab0554ec67fc47e5d", "committedDate": "2020-07-13T14:51:59Z", "message": "Close the model used in pipeline agg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6793176018a96542152c71409d605adc1c8d9dff", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/6793176018a96542152c71409d605adc1c8d9dff", "committedDate": "2020-07-13T14:51:59Z", "message": "Release model used in pipeline agg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62a9b83888b42c0c36113b708c01d8102e91e6f2", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/62a9b83888b42c0c36113b708c01d8102e91e6f2", "committedDate": "2020-07-13T14:51:59Z", "message": "Reference counting tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ed04a0fbceb16c1b48da4f62db426a6121fd34d", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ed04a0fbceb16c1b48da4f62db426a6121fd34d", "committedDate": "2020-07-13T14:51:59Z", "message": "tidy up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a922826cfe4fd29020c6c5f2df3d785bcaea1500", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/a922826cfe4fd29020c6c5f2df3d785bcaea1500", "committedDate": "2020-07-13T15:17:51Z", "message": "review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb2073f0bd69868b46f4e80089ee1ccb83183dc7", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb2073f0bd69868b46f4e80089ee1ccb83183dc7", "committedDate": "2020-07-13T13:49:43Z", "message": "tidy up"}, "afterCommit": {"oid": "a922826cfe4fd29020c6c5f2df3d785bcaea1500", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/a922826cfe4fd29020c6c5f2df3d785bcaea1500", "committedDate": "2020-07-13T15:17:51Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzU5MjE4", "url": "https://github.com/elastic/elasticsearch/pull/58670#pullrequestreview-447359218", "createdAt": "2020-07-13T15:28:28Z", "commit": {"oid": "a922826cfe4fd29020c6c5f2df3d785bcaea1500"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNToyODoyOVrOGwtv-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNToyODoyOVrOGwtv-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzczNDM5NA==", "bodyText": "I am not sure about calling listener.onResponse(loadedModel); while locked.\nWe have no control over what listener.onResponse executes.\nDo you think it is OK?", "url": "https://github.com/elastic/elasticsearch/pull/58670#discussion_r453734394", "createdAt": "2020-07-13T15:28:29Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingService.java", "diffHunk": "@@ -339,21 +375,23 @@ private void handleLoadSuccess(String modelId,\n             trainedModelConfig.getDefaultFieldMap(),\n             inferenceConfig,\n             trainedModelConfig.getLicenseLevel(),\n-            modelStatsService);\n+            modelStatsService,\n+            trainedModelCircuitBreaker);\n         synchronized (loadingListeners) {\n             listeners = loadingListeners.remove(modelId);\n             // If there is no loadingListener that means the loading was canceled and the listener was already notified as such\n             // Consequently, we should not store the retrieved model\n             if (listeners == null) {\n-                trainedModelCircuitBreaker.addWithoutBreaking(-inferenceDefinition.ramBytesUsed());\n+                loadedModel.release();\n                 return;\n             }\n+            for (ActionListener<LocalModel> listener = listeners.poll(); listener != null; listener = listeners.poll()) {\n+                loadedModel.acquire();\n+                listener.onResponse(loadedModel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a922826cfe4fd29020c6c5f2df3d785bcaea1500"}, "originalPosition": 147}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "051f35edc1dab7f9c3a969a2f900b7f936bc90ec", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/051f35edc1dab7f9c3a969a2f900b7f936bc90ec", "committedDate": "2020-07-13T15:36:57Z", "message": "rework"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzY5MDU4", "url": "https://github.com/elastic/elasticsearch/pull/58670#pullrequestreview-447369058", "createdAt": "2020-07-13T15:38:42Z", "commit": {"oid": "051f35edc1dab7f9c3a969a2f900b7f936bc90ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2535, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}