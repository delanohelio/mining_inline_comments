{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0OTg2MzMy", "number": 56398, "title": "Fix test failure of file role store auto-reload ", "bodyText": "Ensure file content is replaced atomically to prevent file watcher from reading imcomplete/empty file.\nResolves: #52955", "createdAt": "2020-05-08T00:35:51Z", "url": "https://github.com/elastic/elasticsearch/pull/56398", "merged": true, "mergeCommit": {"oid": "23095d42f98eef6327dafdcdeb351c083002af50"}, "closed": true, "closedAt": "2020-05-13T06:08:20Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfGtThgH2gAyNDE0OTg2MzMyOmYzYzhhYmJkZDBiMjBhNjZlZjk0Zjg1YmUxNzM0NjIyY2I2ZDViZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgv16YgH2gAyNDE0OTg2MzMyOmFiMzczOTIxZDEzNjNmNzFiNWJhYzhlZjA1OWE2Y2JjZWZkZDY2MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3c8abbdd0b20a66ef94f85be1734622cb6d5bd7", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/f3c8abbdd0b20a66ef94f85be1734622cb6d5bd7", "committedDate": "2020-05-08T00:26:39Z", "message": "Fix file role store reload test failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86e6262d0809123be09b57a2c8b0b1b248a98fbd", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/86e6262d0809123be09b57a2c8b0b1b248a98fbd", "committedDate": "2020-05-08T00:27:01Z", "message": "Merge remote-tracking branch 'origin/master' into es-25955-file-role-store-test-failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b34e45a11562150334423782611d6309f7a8e95e", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/b34e45a11562150334423782611d6309f7a8e95e", "committedDate": "2020-05-08T00:37:03Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7445bec5306d2253c93711f5661344c43bc7b69a", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/7445bec5306d2253c93711f5661344c43bc7b69a", "committedDate": "2020-05-08T00:49:05Z", "message": "Remove forbidden API usage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDcxNDEx", "url": "https://github.com/elastic/elasticsearch/pull/56398#pullrequestreview-409071411", "createdAt": "2020-05-11T11:02:26Z", "commit": {"oid": "7445bec5306d2253c93711f5661344c43bc7b69a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86ff9f5c50a6528106260dabdec27e17760d075a", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/86ff9f5c50a6528106260dabdec27e17760d075a", "committedDate": "2020-05-12T11:37:11Z", "message": "address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7578138095ded5c6818f0964081895b7b1ab6ac", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7578138095ded5c6818f0964081895b7b1ab6ac", "committedDate": "2020-05-12T11:55:28Z", "message": "Merge remote-tracking branch 'origin/master' into es-25955-file-role-store-test-failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTc5Njkx", "url": "https://github.com/elastic/elasticsearch/pull/56398#pullrequestreview-409979691", "createdAt": "2020-05-12T12:15:53Z", "commit": {"oid": "b7578138095ded5c6818f0964081895b7b1ab6ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff8aa946a2aede6152f4e8ca982406d5ae3ba2a4", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff8aa946a2aede6152f4e8ca982406d5ae3ba2a4", "committedDate": "2020-05-12T12:45:52Z", "message": "Use marker role for better semantics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDEwNzA4", "url": "https://github.com/elastic/elasticsearch/pull/56398#pullrequestreview-410410708", "createdAt": "2020-05-12T20:49:13Z", "commit": {"oid": "ff8aa946a2aede6152f4e8ca982406d5ae3ba2a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMDo0OToxM1rOGUYZlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMDo0OToxM1rOGUYZlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAyNDQ2OA==", "bodyText": "Not a big deal but you can maintain the modifiedFileRolesModified.addAll(roleSet); from before and assert it contains role5.", "url": "https://github.com/elastic/elasticsearch/pull/56398#discussion_r424024468", "createdAt": "2020-05-12T20:49:13Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/store/FileRolesStoreTests.java", "diffHunk": "@@ -394,48 +394,56 @@ public void testAutoReload() throws Exception {\n             assertThat(role.cluster().check(\"cluster:admin/foo/bar\", request, authentication), is(false));\n \n             // truncate to remove some\n-            final Set<String> truncatedFileRolesModified = new HashSet<>();\n+            // Not asserting exact content of the role change set since file truncation and subsequent are not\n+            // atomic and hence can result in different change set to be reported.\n             final CountDownLatch truncateLatch = new CountDownLatch(1);\n             store = new FileRolesStore(settings, env, watcherService, roleSet -> {\n-                truncatedFileRolesModified.addAll(roleSet);\n-                truncateLatch.countDown();\n+                if (roleSet.contains(\"dummy1\")) {\n+                    truncateLatch.countDown();\n+                }\n             }, new XPackLicenseState(Settings.EMPTY), xContentRegistry());\n \n             final Set<String> allRolesPreTruncate = store.getAllRoleNames();\n+            assertTrue(allRolesPreTruncate.contains(\"role5\"));\n+            // Use a marker role so that when the countdown latch is triggered,\n+            // we are sure it is triggered by the new file content instead of the initial truncation\n             try (BufferedWriter writer = Files.newBufferedWriter(tmp, StandardCharsets.UTF_8, StandardOpenOption.TRUNCATE_EXISTING)) {\n                 writer.append(\"role5:\").append(System.lineSeparator());\n                 writer.append(\"  cluster:\").append(System.lineSeparator());\n-                writer.append(\"    - 'MONITOR'\");\n+                writer.append(\"    - 'MONITOR'\").append(System.lineSeparator());\n+                writer.append(\"dummy1:\").append(System.lineSeparator());\n+                writer.append(\"  cluster:\").append(System.lineSeparator());\n+                writer.append(\"    - 'ALL'\");\n             }\n \n-            truncateLatch.await();\n-            assertEquals(allRolesPreTruncate.size() - 1, truncatedFileRolesModified.size());\n-            assertTrue(allRolesPreTruncate.contains(\"role5\"));\n-            assertFalse(truncatedFileRolesModified.contains(\"role5\"));\n+            assertTrue(truncateLatch.await(5, TimeUnit.SECONDS));\n             descriptors = store.roleDescriptors(Collections.singleton(\"role5\"));\n             assertThat(descriptors, notNullValue());\n             assertEquals(1, descriptors.size());\n+            assertArrayEquals(new String[]{\"MONITOR\"}, descriptors.iterator().next().getClusterPrivileges());\n \n             // modify\n-            final Set<String> modifiedFileRolesModified = new HashSet<>();\n             final CountDownLatch modifyLatch = new CountDownLatch(1);\n             store = new FileRolesStore(settings, env, watcherService, roleSet -> {\n-                modifiedFileRolesModified.addAll(roleSet);\n-                modifyLatch.countDown();\n+                if (roleSet.contains(\"dummy2\")) {\n+                    modifyLatch.countDown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff8aa946a2aede6152f4e8ca982406d5ae3ba2a4"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f20dc0ac0bcd8008e61090c33b570e74001e91a", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f20dc0ac0bcd8008e61090c33b570e74001e91a", "committedDate": "2020-05-13T02:39:29Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab373921d1363f71b5bac8ef059a6cbcefdd6622", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab373921d1363f71b5bac8ef059a6cbcefdd6622", "committedDate": "2020-05-13T02:56:05Z", "message": "Merge branch 'master' into es-25955-file-role-store-test-failure"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 251, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}