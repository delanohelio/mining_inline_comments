{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NzU4Nzc0", "number": 61938, "title": "Stop runtime script from emitting too many values", "bodyText": "This prevent keyword valued runtime scripts from emitting too many\nvalues or values that take up too much space. Without this you can put\nallocate a ton of memory with the script by sticking it into a tight\nloop. Painless has some protections against this but:\n\nI don't want to rely on them out of sheer paranoia\nThey don't really kick in when the script uses callbacks like we do\nanyway.\n\nRelates to #59332", "createdAt": "2020-09-03T16:45:54Z", "url": "https://github.com/elastic/elasticsearch/pull/61938", "merged": true, "mergeCommit": {"oid": "7f542e03806b6dd2be16163a23a3e1e8c260763c"}, "closed": true, "closedAt": "2020-09-09T15:51:31Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFTZRBgH2gAyNDc4NzU4Nzc0OjRmYTIxY2ZkOTA2OTI1NzkxOTJkYTk1MTljNzhlODQ2ZDU5MTk5MjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHOA_6AFqTQ4NTEzNTkyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4fa21cfd90692579192da9519c78e846d5919924", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4fa21cfd90692579192da9519c78e846d5919924", "committedDate": "2020-09-03T16:42:39Z", "message": "Stop runtime script from emitting too many values\n\nThis prevent `keyword` valued runtime scripts from emitting too many\nvalues or values that take up too much space. Without this you can put\nallocate a ton of memory with the script by sticking it into a tight\nloop. Painless has some protections against this but:\n1. I don't want to rely on them out of sheer paranoia\n2. They don't really kick in when the script uses callbacks like we do\n   anyway.\n\nRelates to #59332"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNTAxODQ0", "url": "https://github.com/elastic/elasticsearch/pull/61938#pullrequestreview-482501844", "createdAt": "2020-09-04T09:27:17Z", "commit": {"oid": "4fa21cfd90692579192da9519c78e846d5919924"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOToyNzoxN1rOHNGk7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOTozMToxMFrOHNGtDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMTI5Mw==", "bodyText": "this seems high", "url": "https://github.com/elastic/elasticsearch/pull/61938#discussion_r483501293", "createdAt": "2020-09-04T09:27:17Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/AbstractScriptFieldScript.java", "diffHunk": "@@ -27,6 +27,11 @@\n  * {@link AggregationScript} but hopefully with less historical baggage.\n  */\n public abstract class AbstractScriptFieldScript {\n+    /**\n+     * The maximum number of values a script should be allowed to emit.\n+     */\n+    public static final int MAX_VALUES = 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fa21cfd90692579192da9519c78e846d5919924"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMjg1NQ==", "bodyText": "could the max values check be shared in the base class, and could we then unify the error message to something like \"Runtime field [field] is emitting [1500] values while the maximum number of values allowed is [1000]\"?", "url": "https://github.com/elastic/elasticsearch/pull/61938#discussion_r483502855", "createdAt": "2020-09-04T09:30:14Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/StringScriptFieldScript.java", "diffHunk": "@@ -49,12 +55,20 @@ public StringScriptFieldScript(Map<String, Object> params, SearchLookup searchLo\n      */\n     public final List<String> resultsForDoc(int docId) {\n         results.clear();\n+        chars = 0;\n         setDocument(docId);\n         execute();\n         return results;\n     }\n \n     protected final void emitValue(String v) {\n+        if (results.size() >= MAX_VALUES) {\n+            throw new IllegalArgumentException(\"too many runtime values\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fa21cfd90692579192da9519c78e846d5919924"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMzM3Mg==", "bodyText": "Runtime field [field] is emitting [1500] characters while the maximum number of characters allowed is [1000]\"?", "url": "https://github.com/elastic/elasticsearch/pull/61938#discussion_r483503372", "createdAt": "2020-09-04T09:31:10Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/StringScriptFieldScript.java", "diffHunk": "@@ -49,12 +55,20 @@ public StringScriptFieldScript(Map<String, Object> params, SearchLookup searchLo\n      */\n     public final List<String> resultsForDoc(int docId) {\n         results.clear();\n+        chars = 0;\n         setDocument(docId);\n         execute();\n         return results;\n     }\n \n     protected final void emitValue(String v) {\n+        if (results.size() >= MAX_VALUES) {\n+            throw new IllegalArgumentException(\"too many runtime values\");\n+        }\n+        chars += v.length();\n+        if (chars >= MAX_CHARS) {\n+            throw new IllegalArgumentException(\"too many characters in runtime values [\" + chars + \"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fa21cfd90692579192da9519c78e846d5919924"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "510fa50400cca023e446e10f17d1fb1a7878d437", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/510fa50400cca023e446e10f17d1fb1a7878d437", "committedDate": "2020-09-04T14:46:07Z", "message": "Merge branch 'master' into script_field_too_many_keywords_take_three"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb5abb9995283c5b491fc8d9194198f91fe68dc9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb5abb9995283c5b491fc8d9194198f91fe68dc9", "committedDate": "2020-09-04T15:25:43Z", "message": "Name name name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MzgwODEy", "url": "https://github.com/elastic/elasticsearch/pull/61938#pullrequestreview-484380812", "createdAt": "2020-09-08T18:10:58Z", "commit": {"oid": "bb5abb9995283c5b491fc8d9194198f91fe68dc9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxODoxMDo1OFrOHOoi-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxODoxMDo1OFrOHOoi-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEwNjQyNw==", "bodyText": "is there a chance that we have some standard emitValue in the base class that calls this method? Otherwise all impls should call it but now only string does?", "url": "https://github.com/elastic/elasticsearch/pull/61938#discussion_r485106427", "createdAt": "2020-09-08T18:10:58Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/AbstractScriptFieldScript.java", "diffHunk": "@@ -93,5 +101,19 @@ public final void setDocument(int docId) {\n         return leafSearchLookup.doc();\n     }\n \n+    protected final void checkMaxSize(int currentSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb5abb9995283c5b491fc8d9194198f91fe68dc9"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "166cb7ed77a9578ddb325737037425231f18dacf", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/166cb7ed77a9578ddb325737037425231f18dacf", "committedDate": "2020-09-09T13:53:30Z", "message": "Merge branch 'master' into script_field_too_many_keywords_take_three"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "563b2b7473249c5a54f0e995ff8a91097a39ce33", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/563b2b7473249c5a54f0e995ff8a91097a39ce33", "committedDate": "2020-09-09T14:35:54Z", "message": "check limits all places"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MTM1OTI2", "url": "https://github.com/elastic/elasticsearch/pull/61938#pullrequestreview-485135926", "createdAt": "2020-09-09T15:34:28Z", "commit": {"oid": "563b2b7473249c5a54f0e995ff8a91097a39ce33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4836, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}