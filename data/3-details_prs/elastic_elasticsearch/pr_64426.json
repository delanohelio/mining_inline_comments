{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTE2NzA2", "number": 64426, "title": "[DOCS] Updating doc level security limitations", "bodyText": "Updates doc level security limitations, adds cross links, and clarifies usage of the query parameter.\nCloses #64405", "createdAt": "2020-10-30T16:17:03Z", "url": "https://github.com/elastic/elasticsearch/pull/64426", "merged": true, "mergeCommit": {"oid": "c29cdefa411675293b06b47c7c990e2657006463"}, "closed": true, "closedAt": "2020-11-05T15:51:12Z", "author": {"login": "lockewritesdocs"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXpLLwgH2gAyNTEzMTE2NzA2OmZmZWI5NWYzOTA2MDg0OTQwMzc5NTVjNWFjZjQ3ZjA0NjU1ZTM3ODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZSY5xAH2gAyNTEzMTE2NzA2OjA3ODIzNzBhMTNkNWYzMWY4ZTI5ZTdkYmRlOTMwMzhmNmM2YzI5ZTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ffeb95f390608494037955c5acf47f04655e3783", "author": {"user": {"login": "lockewritesdocs", "name": "Adam Locke"}}, "url": "https://github.com/elastic/elasticsearch/commit/ffeb95f390608494037955c5acf47f04655e3783", "committedDate": "2020-10-30T16:15:49Z", "message": "Updating doc level security limitations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMjc4NDEy", "url": "https://github.com/elastic/elasticsearch/pull/64426#pullrequestreview-521278412", "createdAt": "2020-11-02T00:16:40Z", "commit": {"oid": "ffeb95f390608494037955c5acf47f04655e3783"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwMDoxNjo0MFrOHrzZjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwMDoyOTo0NFrOHrzflg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5Mjk0MQ==", "bodyText": "It accepts both string and nested JSON, e.g. following synatx also works:\nPOST _security/role/click_role\n{\n  \"indices\": [\n    {\n      \"names\": [\n        \"events-*\"\n      ],\n      \"privileges\": [\n        \"read\"\n      ],\n      \"query\": {\n        \"match\": {\n          \"category\": \"click\"\n        }\n      }\n    }\n  ]\n}\nThe second example of this page shows an example of using nested JSON format as well.", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r515692941", "createdAt": "2020-11-02T00:16:40Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authorization/document-level-security.asciidoc", "diffHunk": "@@ -3,14 +3,24 @@\n === Document level security\n \n Document level security restricts the documents that users have read access to.\n-In particular, it restricts which documents can be accessed from document-based \n-read APIs. \n+In particular, it restricts which documents can be accessed from document-based\n+read APIs.\n \n To enable document level security, you use a query to specify the documents that\n-each role can access. The document query is associated with a particular data\n+each role can access. The document `query` is associated with a particular data\n stream, index, or wildcard (`*`) pattern and operates in conjunction with the\n privileges specified for the data streams and indices.\n \n+The specified `query`:\n+\n+* Expects the same format as if it was defined in the search request\n+* Accepts queries written as string values", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeb95f390608494037955c5acf47f04655e3783"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5MzI0NQ==", "bodyText": "This is mostly true except it can also use a templated query. However this feature is not documented on this page, but on the other page of \"Setting up field and document level security\". It is cross-linked at the end of this page.", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r515693245", "createdAt": "2020-11-02T00:19:22Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authorization/document-level-security.asciidoc", "diffHunk": "@@ -3,14 +3,24 @@\n === Document level security\n \n Document level security restricts the documents that users have read access to.\n-In particular, it restricts which documents can be accessed from document-based \n-read APIs. \n+In particular, it restricts which documents can be accessed from document-based\n+read APIs.\n \n To enable document level security, you use a query to specify the documents that\n-each role can access. The document query is associated with a particular data\n+each role can access. The document `query` is associated with a particular data\n stream, index, or wildcard (`*`) pattern and operates in conjunction with the\n privileges specified for the data streams and indices.\n \n+The specified `query`:\n+\n+* Expects the same format as if it was defined in the search request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeb95f390608494037955c5acf47f04655e3783"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5MzUxMg==", "bodyText": "\ud83d\udc4d I think we can also cross link to Field Level Security in the previous paragraph.", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r515693512", "createdAt": "2020-11-02T00:21:24Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/limitations.asciidoc", "diffHunk": "@@ -51,7 +52,7 @@ When a user's role enables document or field level security for a data stream or\n ** Update requests included in bulk requests aren't supported.\n * The request cache is disabled for search requests.\n \n-When a user's role enables document level security for a data stream or index:\n+When a user's role enables <<document-level-security,document level security>> for a data stream or index:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeb95f390608494037955c5acf47f04655e3783"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY5NDQ4Ng==", "bodyText": "Date math does not make remote calls. So it should not be nested under the title of \"query that makes remote calls\". Also I don't think we have an official name of \"date_math_expr range query\". The relevant doc page describes it as \"using the range query with date fields. So maybe we could say something like:\nDate math expressions cannot contain now in range query with date fields.", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r515694486", "createdAt": "2020-11-02T00:29:44Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/limitations.asciidoc", "diffHunk": "@@ -62,11 +63,12 @@ When a user's role enables document level security for a data stream or index:\n * The `has_child` and `has_parent` queries aren't supported as query in the\n   role definition. The `has_child` and `has_parent` queries can be used in the\n   search API with document level security enabled.\n-* Any query that makes remote calls to fetch data to query by isn't supported.\n-  The following queries aren't supported:\n-** The `terms` query with terms lookup isn't supported.\n-** The `geo_shape` query with indexed shapes isn't supported.\n-** The `percolate` query isn't supported.\n+* Any query that makes remote calls to fetch query data isn't supported,\n+including the following queries:\n+** `terms` query with terms lookup\n+** `geo_shape` query with indexed shapes\n+** `percolate` query\n+** `date_math_expr` range query that includes `now`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeb95f390608494037955c5acf47f04655e3783"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxODQ0MDYx", "url": "https://github.com/elastic/elasticsearch/pull/64426#pullrequestreview-521844061", "createdAt": "2020-11-02T17:23:44Z", "commit": {"oid": "ffeb95f390608494037955c5acf47f04655e3783"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNzoyMzo0NVrOHsOZlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNzoyMzo0NVrOHsOZlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEzNTMxNw==", "bodyText": "@ywangd, the field stats API was deprecated in 5.4.0. Should we instead list the field capabilities API as an example?", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516135317", "createdAt": "2020-11-02T17:23:45Z", "author": {"login": "lockewritesdocs"}, "path": "x-pack/docs/en/security/limitations.asciidoc", "diffHunk": "@@ -51,7 +52,7 @@ When a user's role enables document or field level security for a data stream or\n ** Update requests included in bulk requests aren't supported.\n * The request cache is disabled for search requests.\n \n-When a user's role enables document level security for a data stream or index:\n+When a user's role enables <<document-level-security,document level security>> for a data stream or index:\n \n * Document level security isn't applied for APIs that aren't document based.\n   An example is the field stats API.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffeb95f390608494037955c5acf47f04655e3783"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "159acfa7c6afaf545668b4902d6a6a010bc7d58d", "author": {"user": {"login": "lockewritesdocs", "name": "Adam Locke"}}, "url": "https://github.com/elastic/elasticsearch/commit/159acfa7c6afaf545668b4902d6a6a010bc7d58d", "committedDate": "2020-11-02T17:37:15Z", "message": "Incorporating review feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDQ4MTUx", "url": "https://github.com/elastic/elasticsearch/pull/64426#pullrequestreview-522448151", "createdAt": "2020-11-03T12:30:24Z", "commit": {"oid": "159acfa7c6afaf545668b4902d6a6a010bc7d58d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjozMDoyNFrOHssqfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjozODoyOFrOHss7ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzMTE2Ng==", "bodyText": "Nit: Sorry I know this snippet is copied from my previous comment, but I think it would look better and easier to spot the difference if we keep this part consistent to the previous example, i.e.:\n      ...\n      \"names\": [ \"events-* ],\n      \"privileges\": [ \"read\" ],\n      ...\nThe content of the query field looks fine as it signifies the nested structure.", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516631166", "createdAt": "2020-11-03T12:30:24Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authorization/document-level-security.asciidoc", "diffHunk": "@@ -26,19 +37,37 @@ POST /_security/role/click_role\n     }\n   ]\n }\n---------------------------------------------------\n+----\n \n-NOTE: Omitting the `query` entry entirely disables document level security for\n-      the respective indices permission entry.\n+You can write this same query using nested JSON syntax:\n \n-The specified `query` expects the same format as if it was defined in the\n-search request and supports the full {es} <<query-dsl,query DSL>>.\n+[source,console]\n+----\n+POST _security/role/click_role\n+{\n+  \"indices\": [\n+    {\n+      \"names\": [\n+        \"events-*\"\n+      ],\n+      \"privileges\": [\n+        \"read\"\n+      ],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "159acfa7c6afaf545668b4902d6a6a010bc7d58d"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzNTU4Nw==", "bodyText": "We could talk about the actual info that can be accessed instead of just giving out a variable name, something like:\n* Supports <<templating-role-query,templating>> that can access the details of the current authenticated user", "url": "https://github.com/elastic/elasticsearch/pull/64426#discussion_r516635587", "createdAt": "2020-11-03T12:38:28Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/security/authorization/document-level-security.asciidoc", "diffHunk": "@@ -3,19 +3,30 @@\n === Document level security\n \n Document level security restricts the documents that users have read access to.\n-In particular, it restricts which documents can be accessed from document-based \n-read APIs. \n+In particular, it restricts which documents can be accessed from document-based\n+read APIs.\n \n To enable document level security, you use a query to specify the documents that\n-each role can access. The document query is associated with a particular data\n+each role can access. The document `query` is associated with a particular data\n stream, index, or wildcard (`*`) pattern and operates in conjunction with the\n privileges specified for the data streams and indices.\n \n+The specified document `query`:\n+\n+* Expects the same format as if it was defined in the search request\n+* Supports <<templating-role-query,templating>> for `_user` variables", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "159acfa7c6afaf545668b4902d6a6a010bc7d58d"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8348f9c034c9c83826f708741ad70fbbec124642", "author": {"user": {"login": "lockewritesdocs", "name": "Adam Locke"}}, "url": "https://github.com/elastic/elasticsearch/commit/8348f9c034c9c83826f708741ad70fbbec124642", "committedDate": "2020-11-03T17:17:44Z", "message": "Changes from review feedback."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9523f43eaf63029821eb847dc38f3759b706e85", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d9523f43eaf63029821eb847dc38f3759b706e85", "committedDate": "2020-11-04T15:57:45Z", "message": "Merge branch 'master' into docs__update-doc-level-security"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9edf0403de1f006f67aaf3148277375d9c5aec8e", "author": {"user": {"login": "lockewritesdocs", "name": "Adam Locke"}}, "url": "https://github.com/elastic/elasticsearch/commit/9edf0403de1f006f67aaf3148277375d9c5aec8e", "committedDate": "2020-11-04T18:50:21Z", "message": "Remove statement about the stats API."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0782370a13d5f31f8e29e7dbde93038f6c6c29e3", "author": {"user": {"login": "lockewritesdocs", "name": "Adam Locke"}}, "url": "https://github.com/elastic/elasticsearch/commit/0782370a13d5f31f8e29e7dbde93038f6c6c29e3", "committedDate": "2020-11-04T18:50:50Z", "message": "Merge branch 'docs__update-doc-level-security' of github.com:lockewritesdocs/elasticsearch into docs__update-doc-level-security"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 883, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}