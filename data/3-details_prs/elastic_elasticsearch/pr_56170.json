{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjMxNjEz", "number": 56170, "title": "Validate V2 templates more strictly", "bodyText": "This commit changes the validation for V2 index and component templates to re-use the same\nvalidation that V1 templates used. This includes things like invalid template names, index patterns,\netc.\nThis also adds validation that template names do not contain * and index patterns do not contain\n: (index names can't contain this regardless).\nSupercedes #53970\nRelates to #53101\nResolves #43737\nResolves #46045", "createdAt": "2020-05-04T23:10:21Z", "url": "https://github.com/elastic/elasticsearch/pull/56170", "merged": true, "mergeCommit": {"oid": "ed271a6752f52d2f5198b857128c08c2ee711eab"}, "closed": true, "closedAt": "2020-05-05T15:24:47Z", "author": {"login": "dakrone"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceHyU9gH2gAyNDEzMjMxNjEzOjZlOWRhMjI3YTI3MzE0NGMwYzgyOWRkOGJlOTlhODM0OGQyNmI2MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceVFbqgH2gAyNDEzMjMxNjEzOjM1MjFkMzEwZTMyNWVlNmNlZTUyNGRlMTE4NTljYjgyNjNhYTJmMjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6e9da227a273144c0c829dd8be99a8348d26b618", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e9da227a273144c0c829dd8be99a8348d26b618", "committedDate": "2020-05-04T23:08:07Z", "message": "Validate V2 templates more strictly\n\nThis commit changes the validation for V2 index and component templates to re-use the same\nvalidation that V1 templates used. This includes things like invalid template names, index patterns,\netc.\n\nThis also adds validation that template names do not contain `*`.\n\nSupercedes #53970\nRelates to #53101"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/25ee3ced9469205c234a0c900900963b324d01f2", "committedDate": "2020-05-04T23:14:50Z", "message": "Disallow ':' in index patterns also"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjI4NDYx", "url": "https://github.com/elastic/elasticsearch/pull/56170#pullrequestreview-405628461", "createdAt": "2020-05-05T09:31:43Z", "commit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozMTo0M1rOGQhgHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozMTo0M1rOGQhgHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3OTI5Mg==", "bodyText": "Would it make sense to extract this in a separate method and use it in both validate CT/TemplateV2 methods?", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r419979292", "createdAt": "2020-05-05T09:31:43Z", "author": {"login": "andreidan"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {\n+        validate(name,\n+            template.template().settings(),\n+            Collections.emptyList(),\n+            Optional.ofNullable(template.template().aliases())\n+                .map(aliases -> aliases.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(String name, IndexTemplateV2 template) {\n+        Optional<Template> maybeTemplate = Optional.ofNullable(template.template());\n+        validate(name,\n+            maybeTemplate.map(Template::settings).orElse(Settings.EMPTY),\n+            template.indexPatterns(),\n+            maybeTemplate\n+                .map(Template::aliases)\n+                .map(aliasMap -> aliasMap.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjMxMjMx", "url": "https://github.com/elastic/elasticsearch/pull/56170#pullrequestreview-405631231", "createdAt": "2020-05-05T09:35:45Z", "commit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozNTo0NVrOGQhpTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1MTowNlrOGQiKYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4MTY0NA==", "bodyText": "These two methods are nearly identical so they can be refactored to avoid duplication\nprivate void validate(String name, ComponentTemplate template) {\n    validate(name, template.template(), Collections.emptyList());\n}\n\nprivate void validate(String name, IndexTemplateV2 template) {\n    validate(name, template.template(), template.indexPatterns());\n}\n\nprivate void validate(String name, Template template1, List<String> indexPatterns) {\n    Optional<Template> maybeTemplate = Optional.ofNullable(template1);\n    validate(name,\n        maybeTemplate.map(Template::settings).orElse(Settings.EMPTY),\n        indexPatterns,\n        maybeTemplate.map(Template::aliases)\n            .orElse(Collections.emptyMap())\n            .values().stream()\n            .map(this::toAlias)\n            .collect(Collectors.toList()));\n}\n\nprivate Alias toAlias(AliasMetadata aliasMeta) {\n    Alias a = new Alias(aliasMeta.alias());\n    if (aliasMeta.filter() != null) {\n        a.filter(aliasMeta.filter().string());\n    }\n    a.searchRouting(aliasMeta.searchRouting());\n    a.indexRouting(aliasMeta.indexRouting());\n    a.isHidden(aliasMeta.isHidden());\n    a.writeIndex(aliasMeta.writeIndex());\n    return a;\n}", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r419981644", "createdAt": "2020-05-05T09:35:45Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4MTgzMQ==", "bodyText": "This block should be refactored to its own method", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r419981831", "createdAt": "2020-05-05T09:36:07Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {\n+        validate(name,\n+            template.template().settings(),\n+            Collections.emptyList(),\n+            Optional.ofNullable(template.template().aliases())\n+                .map(aliases -> aliases.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MDExNA==", "bodyText": "This code can be made less nested if we get out of Optional early\n.map(Template::aliases)\n.orElse(Collections.emptyMap())", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r419990114", "createdAt": "2020-05-05T09:51:06Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {\n+        validate(name,\n+            template.template().settings(),\n+            Collections.emptyList(),\n+            Optional.ofNullable(template.template().aliases())\n+                .map(aliases -> aliases.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(String name, IndexTemplateV2 template) {\n+        Optional<Template> maybeTemplate = Optional.ofNullable(template.template());\n+        validate(name,\n+            maybeTemplate.map(Template::settings).orElse(Settings.EMPTY),\n+            template.indexPatterns(),\n+            maybeTemplate\n+                .map(Template::aliases)\n+                .map(aliasMap -> aliasMap.values().stream()\n+                    .map(aliasMeta -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NzAzNDM1", "url": "https://github.com/elastic/elasticsearch/pull/56170#pullrequestreview-405703435", "createdAt": "2020-05-05T11:34:08Z", "commit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTozNDowOFrOGQlTKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTozNDowOFrOGQlTKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0MTUxMw==", "bodyText": "Sorry for drive-by commenting, but this might touch another small issue I recently read (#55606) which points out that we allow asterisks in index patterns, the error message contaisn the character though (\"template must not contain the following characters [ , \", *, , <, |, ,, >, /, ?];]\") because we use Strings.INVALID_FILENAME_CHARS without removing the asterisk here. Might be worth fixing as well, just wanted to point it out.", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r420041513", "createdAt": "2020-05-05T11:34:08Z", "author": {"login": "cbuescher"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {\n+        validate(name,\n+            template.template().settings(),\n+            Collections.emptyList(),\n+            Optional.ofNullable(template.template().aliases())\n+                .map(aliases -> aliases.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(String name, IndexTemplateV2 template) {\n+        Optional<Template> maybeTemplate = Optional.ofNullable(template.template());\n+        validate(name,\n+            maybeTemplate.map(Template::settings).orElse(Settings.EMPTY),\n+            template.indexPatterns(),\n+            maybeTemplate\n+                .map(Template::aliases)\n+                .map(aliasMap -> aliasMap.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(PutRequest putRequest) {\n+        validate(putRequest.name, putRequest.settings, putRequest.indexPatterns, putRequest.aliases);\n+    }\n+\n+    private void validate(String name, @Nullable Settings settings, List<String> indexPatterns, List<Alias> aliases) {\n         List<String> validationErrors = new ArrayList<>();\n-        if (request.name.contains(\" \")) {\n+        if (name.contains(\" \")) {\n             validationErrors.add(\"name must not contain a space\");\n         }\n-        if (request.name.contains(\",\")) {\n+        if (name.contains(\",\")) {\n             validationErrors.add(\"name must not contain a ','\");\n         }\n-        if (request.name.contains(\"#\")) {\n+        if (name.contains(\"#\")) {\n             validationErrors.add(\"name must not contain a '#'\");\n         }\n-        if (request.name.startsWith(\"_\")) {\n+        if (name.contains(\"*\")) {\n+            validationErrors.add(\"name must not contain a '*'\");\n+        }\n+        if (name.startsWith(\"_\")) {\n             validationErrors.add(\"name must not start with '_'\");\n         }\n-        if (!request.name.toLowerCase(Locale.ROOT).equals(request.name)) {\n+        if (name.toLowerCase(Locale.ROOT).equals(name) == false) {\n             validationErrors.add(\"name must be lower cased\");\n         }\n-        for(String indexPattern : request.indexPatterns) {\n+        for(String indexPattern : indexPatterns) {\n             if (indexPattern.contains(\" \")) {\n-                validationErrors.add(\"template must not contain a space\");\n+                validationErrors.add(\"index_patterns [\" + indexPattern + \"] must not contain a space\");\n             }\n             if (indexPattern.contains(\",\")) {\n-                validationErrors.add(\"template must not contain a ','\");\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not contain a ','\");\n             }\n             if (indexPattern.contains(\"#\")) {\n-                validationErrors.add(\"template must not contain a '#'\");\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not contain a '#'\");\n+            }\n+            if (indexPattern.contains(\":\")) {\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not contain a ':'\");\n             }\n             if (indexPattern.startsWith(\"_\")) {\n-                validationErrors.add(\"template must not start with '_'\");\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not start with '_'\");\n             }\n-            if (!Strings.validFileNameExcludingAstrix(indexPattern)) {\n-                validationErrors.add(\"template must not contain the following characters \" + Strings.INVALID_FILENAME_CHARS);\n+            if (Strings.validFileNameExcludingAstrix(indexPattern) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 117}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ce90bb6c8d2d70eff498fe58f01a5bc97a75d22", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ce90bb6c8d2d70eff498fe58f01a5bc97a75d22", "committedDate": "2020-05-05T14:15:35Z", "message": "Refactor validation methods to DRY them up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3521d310e325ee6cee524de11859cb8263aa2f23", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/3521d310e325ee6cee524de11859cb8263aa2f23", "committedDate": "2020-05-05T14:37:45Z", "message": "Merge branch 'master' into itv2-enhance-template-validation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 89, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}