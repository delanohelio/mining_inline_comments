{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2OTA2MTMw", "number": 52498, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMToxNDoxOFrODhR2vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMzo0MzozNlrODhVv6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MjIyMTQwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/script/ContextCompiler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMToxNDoxOFrOFr9Wlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMDoxMjowOFrOFshm7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzODI5NQ==", "bodyText": "some basic javadocs please", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r381638295", "createdAt": "2020-02-20T01:14:18Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ContextCompiler.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.script;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.breaker.CircuitBreaker;\n+import org.elasticsearch.common.breaker.CircuitBreakingException;\n+import org.elasticsearch.common.cache.Cache;\n+import org.elasticsearch.common.cache.CacheBuilder;\n+import org.elasticsearch.common.cache.RemovalListener;\n+import org.elasticsearch.common.cache.RemovalNotification;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.unit.TimeValue;\n+\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class ContextCompiler {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIzMjMwMQ==", "bodyText": "Added and renamed to ScriptCache.", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r382232301", "createdAt": "2020-02-20T20:12:08Z", "author": {"login": "stu-elastic"}, "path": "server/src/main/java/org/elasticsearch/script/ContextCompiler.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.script;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.breaker.CircuitBreaker;\n+import org.elasticsearch.common.breaker.CircuitBreakingException;\n+import org.elasticsearch.common.cache.Cache;\n+import org.elasticsearch.common.cache.CacheBuilder;\n+import org.elasticsearch.common.cache.RemovalListener;\n+import org.elasticsearch.common.cache.RemovalNotification;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.unit.TimeValue;\n+\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class ContextCompiler {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzODI5NQ=="}, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MjgyODkwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMzozNjoyOVrOFsCDXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMDoxMjozNlrOFshnuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxNTI5NQ==", "bodyText": "Can you please add a comment explaining this is overridden for the test infrastructure?", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r381715295", "createdAt": "2020-02-20T03:36:29Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -213,29 +200,23 @@ public ScriptService(Settings settings, Map<String, ScriptEngine> engines, Map<S\n             }\n         }\n \n-        int cacheMaxSize = SCRIPT_CACHE_SIZE_SETTING.get(settings);\n-\n-        CacheBuilder<CacheKey, Object> cacheBuilder = CacheBuilder.builder();\n-        if (cacheMaxSize >= 0) {\n-            cacheBuilder.setMaximumWeight(cacheMaxSize);\n-        }\n-\n-        TimeValue cacheExpire = SCRIPT_CACHE_EXPIRE_SETTING.get(settings);\n-        if (cacheExpire.getNanos() != 0) {\n-            cacheBuilder.setExpireAfterAccess(cacheExpire);\n-        }\n-\n-        logger.debug(\"using script cache with max_size [{}], expire [{}]\", cacheMaxSize, cacheExpire);\n-        this.cache = cacheBuilder.removalListener(new ScriptCacheRemovalListener()).build();\n-\n-        this.lastInlineCompileTime = System.nanoTime();\n         this.setMaxSizeInBytes(SCRIPT_MAX_SIZE_IN_BYTES.get(settings));\n-        this.setMaxCompilationRate(SCRIPT_MAX_COMPILATIONS_RATE.get(settings));\n+        compiler = new ContextCompiler(\n+                    SCRIPT_CACHE_SIZE_SETTING.get(settings),\n+                    SCRIPT_CACHE_EXPIRE_SETTING.get(settings),\n+                    compilationLimitsEnabled() ?\n+                        SCRIPT_MAX_COMPILATIONS_RATE.get(settings):\n+                        new Tuple<>(0, TimeValue.ZERO)\n+                    );\n+    }\n+\n+    boolean compilationLimitsEnabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIzMjUwNw==", "bodyText": "Added.", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r382232507", "createdAt": "2020-02-20T20:12:36Z", "author": {"login": "stu-elastic"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -213,29 +200,23 @@ public ScriptService(Settings settings, Map<String, ScriptEngine> engines, Map<S\n             }\n         }\n \n-        int cacheMaxSize = SCRIPT_CACHE_SIZE_SETTING.get(settings);\n-\n-        CacheBuilder<CacheKey, Object> cacheBuilder = CacheBuilder.builder();\n-        if (cacheMaxSize >= 0) {\n-            cacheBuilder.setMaximumWeight(cacheMaxSize);\n-        }\n-\n-        TimeValue cacheExpire = SCRIPT_CACHE_EXPIRE_SETTING.get(settings);\n-        if (cacheExpire.getNanos() != 0) {\n-            cacheBuilder.setExpireAfterAccess(cacheExpire);\n-        }\n-\n-        logger.debug(\"using script cache with max_size [{}], expire [{}]\", cacheMaxSize, cacheExpire);\n-        this.cache = cacheBuilder.removalListener(new ScriptCacheRemovalListener()).build();\n-\n-        this.lastInlineCompileTime = System.nanoTime();\n         this.setMaxSizeInBytes(SCRIPT_MAX_SIZE_IN_BYTES.get(settings));\n-        this.setMaxCompilationRate(SCRIPT_MAX_COMPILATIONS_RATE.get(settings));\n+        compiler = new ContextCompiler(\n+                    SCRIPT_CACHE_SIZE_SETTING.get(settings),\n+                    SCRIPT_CACHE_EXPIRE_SETTING.get(settings),\n+                    compilationLimitsEnabled() ?\n+                        SCRIPT_MAX_COMPILATIONS_RATE.get(settings):\n+                        new Tuple<>(0, TimeValue.ZERO)\n+                    );\n+    }\n+\n+    boolean compilationLimitsEnabled() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxNTI5NQ=="}, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MjgzODU3OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/script/ScriptServiceTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMzozODo1MFrOFsCHtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMDoxMzowNVrOFshofw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxNjQwNQ==", "bodyText": "This seems like a series of unit tests on ContextCompiler, not a test of ScriptService.  Can we add a ContextCompilerTests, and move this test there?", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r381716405", "createdAt": "2020-02-20T03:38:50Z", "author": {"login": "rjernst"}, "path": "server/src/test/java/org/elasticsearch/script/ScriptServiceTests.java", "diffHunk": "@@ -102,25 +101,25 @@ StoredScriptSource getScriptFromClusterState(String id) {\n     // simply by multiplying by five, so even setting it to one, requires five compilations to break\n     public void testCompilationCircuitBreaking() throws Exception {\n         buildScriptService(Settings.EMPTY);\n-        scriptService.setMaxCompilationRate(Tuple.tuple(1, TimeValue.timeValueMinutes(1)));\n-        scriptService.checkCompilationLimit(); // should pass\n-        expectThrows(CircuitBreakingException.class, () -> scriptService.checkCompilationLimit());\n-        scriptService.setMaxCompilationRate(Tuple.tuple(2, TimeValue.timeValueMinutes(1)));\n-        scriptService.checkCompilationLimit(); // should pass\n-        scriptService.checkCompilationLimit(); // should pass\n-        expectThrows(CircuitBreakingException.class, () -> scriptService.checkCompilationLimit());\n+        scriptService.compiler.setMaxCompilationRate(Tuple.tuple(1, TimeValue.timeValueMinutes(1)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIzMjcwMw==", "bodyText": "Moved to ScriptCacheTests.", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r382232703", "createdAt": "2020-02-20T20:13:05Z", "author": {"login": "stu-elastic"}, "path": "server/src/test/java/org/elasticsearch/script/ScriptServiceTests.java", "diffHunk": "@@ -102,25 +101,25 @@ StoredScriptSource getScriptFromClusterState(String id) {\n     // simply by multiplying by five, so even setting it to one, requires five compilations to break\n     public void testCompilationCircuitBreaking() throws Exception {\n         buildScriptService(Settings.EMPTY);\n-        scriptService.setMaxCompilationRate(Tuple.tuple(1, TimeValue.timeValueMinutes(1)));\n-        scriptService.checkCompilationLimit(); // should pass\n-        expectThrows(CircuitBreakingException.class, () -> scriptService.checkCompilationLimit());\n-        scriptService.setMaxCompilationRate(Tuple.tuple(2, TimeValue.timeValueMinutes(1)));\n-        scriptService.checkCompilationLimit(); // should pass\n-        scriptService.checkCompilationLimit(); // should pass\n-        expectThrows(CircuitBreakingException.class, () -> scriptService.checkCompilationLimit());\n+        scriptService.compiler.setMaxCompilationRate(Tuple.tuple(1, TimeValue.timeValueMinutes(1)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxNjQwNQ=="}, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2Mjg1OTI4OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/node/MockNode.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMzo0MzozNlrOFsCRHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMDozOTo0OVrOFsiYsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxODgxMg==", "bodyText": "We need to actually add this test plugin to the mock plugins. See ESIntegTestCase.getMockPlugins() and ESSingleNodeTestCase.newNode(). For now we can probably just always add it.", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r381718812", "createdAt": "2020-02-20T03:43:36Z", "author": {"login": "rjernst"}, "path": "test/framework/src/main/java/org/elasticsearch/node/MockNode.java", "diffHunk": "@@ -134,6 +138,14 @@ protected SearchService newSearchService(ClusterService clusterService, IndicesS\n             bigArrays, fetchPhase, circuitBreakerService);\n     }\n \n+    @Override\n+    protected ScriptService newScriptService(Settings settings, Map<String, ScriptEngine> engines, Map<String, ScriptContext<?>> contexts) {\n+        if (getPluginsService().filterPlugins(MockScriptService.TestPlugin.class).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI0NTA0Mg==", "bodyText": "Added.", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r382245042", "createdAt": "2020-02-20T20:39:49Z", "author": {"login": "stu-elastic"}, "path": "test/framework/src/main/java/org/elasticsearch/node/MockNode.java", "diffHunk": "@@ -134,6 +138,14 @@ protected SearchService newSearchService(ClusterService clusterService, IndicesS\n             bigArrays, fetchPhase, circuitBreakerService);\n     }\n \n+    @Override\n+    protected ScriptService newScriptService(Settings settings, Map<String, ScriptEngine> engines, Map<String, ScriptContext<?>> contexts) {\n+        if (getPluginsService().filterPlugins(MockScriptService.TestPlugin.class).isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxODgxMg=="}, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3969, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}