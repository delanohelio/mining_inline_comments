{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NzU0MzIx", "number": 54825, "title": " Merge feature/searchable-snapshots branch into 7.x (#54803) ", "bodyText": "This is a backport of #54803 for 7.x.\nThis pull request cherry picks the squashed commit from #54803 with the additional commits:\n\n6f50c92 which adjusts master code to 7.x\na114549 to mute a failing ILM test (#54818)\n48cbca1 and 50186b2 that cleans up and unmutes the previous test\naae12bb that adds a missing feature flag (#54861)\n6f330e3 that adds missing serialization bits (#54864)\nbf72c02 that adjust the version in YAML tests\na51955f that adds some plumbing for the transport client used in integration tests", "createdAt": "2020-04-06T16:15:06Z", "url": "https://github.com/elastic/elasticsearch/pull/54825", "merged": true, "mergeCommit": {"oid": "4d36917e526113c0dff628c36269c25a9664af9d"}, "closed": true, "closedAt": "2020-04-07T11:28:54Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVAD2lAH2gAyMzk5NzU0MzIxOmYxMDhlYjExOGEyN2EwYmMxZjEzNmYwZmYzMDdkMTRmODA0YTBmYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVRkLwAFqTM4OTAyMzgwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f108eb118a27a0bc1f136f0ff307d14f804a0fb7", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/f108eb118a27a0bc1f136f0ff307d14f804a0fb7", "committedDate": "2020-04-06T15:02:42Z", "message": "Merge feature/searchable-snapshots branch into master (#54803)\n\nThis commit merges the searchable-snapshots feature branch into master.\nSee #54803 for the complete list of squashed commits.\n\nCo-authored-by: David Turner <david.turner@elastic.co>\nCo-authored-by: Yannick Welsch <yannick@welsch.lu>\nCo-authored-by: Lee Hinman <dakrone@users.noreply.github.com>\nCo-authored-by: Andrei Dan <andrei.dan@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f50c92d692b2b75c630ee0e892d5188caad20c1", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/6f50c92d692b2b75c630ee0e892d5188caad20c1", "committedDate": "2020-04-06T16:05:54Z", "message": "Fix stuff after cherry-picking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a114549697dc92f5f46a76c4ec71b2d398515f8d", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/a114549697dc92f5f46a76c4ec71b2d398515f8d", "committedDate": "2020-04-06T16:06:35Z", "message": "Mute testDeleteActionDeletesSearchableSnapshot (#54818)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48cbca1de43357e71f0a3f4d905e12be28235ec4", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/48cbca1de43357e71f0a3f4d905e12be28235ec4", "committedDate": "2020-04-06T20:35:27Z", "message": "Tests: only build the IndexMetadata once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50186b25808001d6b94cef17bc4e3492f679450a", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/50186b25808001d6b94cef17bc4e3492f679450a", "committedDate": "2020-04-06T21:17:22Z", "message": "Fix TimeSeriesLifecycleActionsIT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aae12bb7a299da5ac7206d1504537dbeb0823586", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/aae12bb7a299da5ac7206d1504537dbeb0823586", "committedDate": "2020-04-07T09:08:00Z", "message": "Set missing feature flag in searchable snapshots QA Azure test (#54861)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f330e3a0b5f83190f1a2a89b845e05279d61a85", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/6f330e3a0b5f83190f1a2a89b845e05279d61a85", "committedDate": "2020-04-07T09:10:59Z", "message": "Fix serialization bug in SearchableSnapshotsStatsResponse (#54864)\n\nSearchableSnapshotsStatsResponse is missing the serialization of \r\nthe list of SearchableSnapshotShardStats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf72c02644164c707253b0f9636081efb9b5b2b1", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/bf72c02644164c707253b0f9636081efb9b5b2b1", "committedDate": "2020-04-07T09:13:45Z", "message": "Adjust skip versions in YAML tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a51955f3b5823b7f8017576b6f1026e2ea149316", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/a51955f3b5823b7f8017576b6f1026e2ea149316", "committedDate": "2020-04-07T09:13:56Z", "message": "Adjust Transport client settings and plugins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4OTY5Njgz", "url": "https://github.com/elastic/elasticsearch/pull/54825#pullrequestreview-388969683", "createdAt": "2020-04-07T10:04:51Z", "commit": {"oid": "a51955f3b5823b7f8017576b6f1026e2ea149316"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDowNDo1MVrOGB8VPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDowNDo1MVrOGB8VPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5MDIzNg==", "bodyText": "@andreidan Version has been adjusted here", "url": "https://github.com/elastic/elasticsearch/pull/54825#discussion_r404690236", "createdAt": "2020-04-07T10:04:51Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/DeleteAction.java", "diffHunk": "@@ -5,38 +5,63 @@\n  */\n package org.elasticsearch.xpack.core.ilm;\n \n+import org.elasticsearch.Version;\n import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.ParseField;\n import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n-import org.elasticsearch.common.xcontent.ObjectParser;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n import org.elasticsearch.common.xcontent.XContentBuilder;\n import org.elasticsearch.common.xcontent.XContentParser;\n \n import java.io.IOException;\n import java.util.Arrays;\n import java.util.List;\n+import java.util.Objects;\n \n /**\n  * A {@link LifecycleAction} which deletes the index.\n  */\n public class DeleteAction implements LifecycleAction {\n     public static final String NAME = \"delete\";\n \n-    private static final ObjectParser<DeleteAction, Void> PARSER = new ObjectParser<>(NAME, DeleteAction::new);\n+    public static final ParseField DELETE_SEARCHABLE_SNAPSHOT_FIELD = new ParseField(\"delete_searchable_snapshot\");\n+\n+    private static final ConstructingObjectParser<DeleteAction, Void> PARSER = new ConstructingObjectParser<>(NAME,\n+        a -> new DeleteAction(a[0] == null ? true : (boolean) a[0]));\n+\n+    static {\n+        PARSER.declareBoolean(ConstructingObjectParser.optionalConstructorArg(), DELETE_SEARCHABLE_SNAPSHOT_FIELD);\n+    }\n \n     public static DeleteAction parse(XContentParser parser) {\n         return PARSER.apply(parser, null);\n     }\n \n+    private final boolean deleteSearchableSnapshot;\n+\n     public DeleteAction() {\n+        this(true);\n+    }\n+\n+    public DeleteAction(boolean deleteSearchableSnapshot) {\n+        this.deleteSearchableSnapshot = deleteSearchableSnapshot;\n     }\n \n     public DeleteAction(StreamInput in) throws IOException {\n+        if (in.getVersion().onOrAfter(Version.V_7_8_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a51955f3b5823b7f8017576b6f1026e2ea149316"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4OTY5Nzk5", "url": "https://github.com/elastic/elasticsearch/pull/54825#pullrequestreview-388969799", "createdAt": "2020-04-07T10:05:02Z", "commit": {"oid": "a51955f3b5823b7f8017576b6f1026e2ea149316"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDowNTowMlrOGB8Vnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDowNTowMlrOGB8Vnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5MDMzNQ==", "bodyText": "@andreidan Version has been adjusted here", "url": "https://github.com/elastic/elasticsearch/pull/54825#discussion_r404690335", "createdAt": "2020-04-07T10:05:02Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/DeleteAction.java", "diffHunk": "@@ -5,38 +5,63 @@\n  */\n package org.elasticsearch.xpack.core.ilm;\n \n+import org.elasticsearch.Version;\n import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.ParseField;\n import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n-import org.elasticsearch.common.xcontent.ObjectParser;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n import org.elasticsearch.common.xcontent.XContentBuilder;\n import org.elasticsearch.common.xcontent.XContentParser;\n \n import java.io.IOException;\n import java.util.Arrays;\n import java.util.List;\n+import java.util.Objects;\n \n /**\n  * A {@link LifecycleAction} which deletes the index.\n  */\n public class DeleteAction implements LifecycleAction {\n     public static final String NAME = \"delete\";\n \n-    private static final ObjectParser<DeleteAction, Void> PARSER = new ObjectParser<>(NAME, DeleteAction::new);\n+    public static final ParseField DELETE_SEARCHABLE_SNAPSHOT_FIELD = new ParseField(\"delete_searchable_snapshot\");\n+\n+    private static final ConstructingObjectParser<DeleteAction, Void> PARSER = new ConstructingObjectParser<>(NAME,\n+        a -> new DeleteAction(a[0] == null ? true : (boolean) a[0]));\n+\n+    static {\n+        PARSER.declareBoolean(ConstructingObjectParser.optionalConstructorArg(), DELETE_SEARCHABLE_SNAPSHOT_FIELD);\n+    }\n \n     public static DeleteAction parse(XContentParser parser) {\n         return PARSER.apply(parser, null);\n     }\n \n+    private final boolean deleteSearchableSnapshot;\n+\n     public DeleteAction() {\n+        this(true);\n+    }\n+\n+    public DeleteAction(boolean deleteSearchableSnapshot) {\n+        this.deleteSearchableSnapshot = deleteSearchableSnapshot;\n     }\n \n     public DeleteAction(StreamInput in) throws IOException {\n+        if (in.getVersion().onOrAfter(Version.V_7_8_0)) {\n+            this.deleteSearchableSnapshot = in.readBoolean();\n+        } else {\n+            this.deleteSearchableSnapshot = true;\n+        }\n     }\n \n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n+        if (out.getVersion().onOrAfter(Version.V_7_8_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a51955f3b5823b7f8017576b6f1026e2ea149316"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4OTczNzg0", "url": "https://github.com/elastic/elasticsearch/pull/54825#pullrequestreview-388973784", "createdAt": "2020-04-07T10:10:33Z", "commit": {"oid": "a51955f3b5823b7f8017576b6f1026e2ea149316"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxMDozM1rOGB8ilQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxMDozM1rOGB8ilQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5MzY1Mw==", "bodyText": "This change means that we register these actions whether the feature flag is enabled or not, which I think we should avoid. Can we revert this?", "url": "https://github.com/elastic/elasticsearch/pull/54825#discussion_r404693653", "createdAt": "2020-04-07T10:10:33Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshots.java", "diffHunk": "@@ -237,15 +237,11 @@ public void onIndexModule(IndexModule indexModule) {\n \n     @Override\n     public List<ActionHandler<? extends ActionRequest, ? extends ActionResponse>> getActions() {\n-        if (SEARCHABLE_SNAPSHOTS_FEATURE_ENABLED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a51955f3b5823b7f8017576b6f1026e2ea149316"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba13d20c41222472c67fe1758c9a3815f02bdec", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/cba13d20c41222472c67fe1758c9a3815f02bdec", "committedDate": "2020-04-07T10:34:41Z", "message": "apply feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDIzMTMw", "url": "https://github.com/elastic/elasticsearch/pull/54825#pullrequestreview-389023130", "createdAt": "2020-04-07T11:25:34Z", "commit": {"oid": "cba13d20c41222472c67fe1758c9a3815f02bdec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDIzODAz", "url": "https://github.com/elastic/elasticsearch/pull/54825#pullrequestreview-389023803", "createdAt": "2020-04-07T11:26:24Z", "commit": {"oid": "cba13d20c41222472c67fe1758c9a3815f02bdec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3694, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}