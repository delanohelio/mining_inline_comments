{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MTIwNTA2", "number": 56870, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNjowMjo1N1rOD9LbIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNjowMjo1N1rOD9LbIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NDc2ODk3OnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNjowMjo1N1rOGWh46w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwOToyNDoyMVrOGWuyjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzA5OQ==", "bodyText": "Maybe just remove this condition as it's obviously always false and keep the rest the same (maybe also inline delta like we have in the \"add\" case). Seems to me that makes the logic easiest to digest if we want to change it?", "url": "https://github.com/elastic/elasticsearch/pull/56870#discussion_r426277099", "createdAt": "2020-05-17T16:02:57Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java", "diffHunk": "@@ -472,19 +474,12 @@ public Builder updateNumberOfReplicas(final int numberOfReplicas, final String[]\n                 for (IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {\n                     builder.addIndexShard(indexShardRoutingTable);\n                 }\n-                if (currentNumberOfReplicas < numberOfReplicas) {\n-                    // now, add \"empty\" ones\n-                    for (int i = 0; i < (numberOfReplicas - currentNumberOfReplicas); i++) {\n+                int delta = Math.abs(numberOfReplicas - currentNumberOfReplicas);\n+                for (int i = 0; i < delta; i++) {\n+                    if (currentNumberOfReplicas < numberOfReplicas) {\n                         builder.addReplica();\n-                    }\n-                } else if (currentNumberOfReplicas > numberOfReplicas) {\n-                    int delta = currentNumberOfReplicas - numberOfReplicas;\n-                    if (delta <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bafe90483ccabf268b56b4556a7c1e2de66d86e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNzg1Mw==", "bodyText": "@original-brownbear Thanks for checking, I think we could pre-compute the delta and seperate the add and remove operation. Please help to review the update.", "url": "https://github.com/elastic/elasticsearch/pull/56870#discussion_r426337853", "createdAt": "2020-05-18T02:07:26Z", "author": {"login": "howardhuanghua"}, "path": "server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java", "diffHunk": "@@ -472,19 +474,12 @@ public Builder updateNumberOfReplicas(final int numberOfReplicas, final String[]\n                 for (IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {\n                     builder.addIndexShard(indexShardRoutingTable);\n                 }\n-                if (currentNumberOfReplicas < numberOfReplicas) {\n-                    // now, add \"empty\" ones\n-                    for (int i = 0; i < (numberOfReplicas - currentNumberOfReplicas); i++) {\n+                int delta = Math.abs(numberOfReplicas - currentNumberOfReplicas);\n+                for (int i = 0; i < delta; i++) {\n+                    if (currentNumberOfReplicas < numberOfReplicas) {\n                         builder.addReplica();\n-                    }\n-                } else if (currentNumberOfReplicas > numberOfReplicas) {\n-                    int delta = currentNumberOfReplicas - numberOfReplicas;\n-                    if (delta <= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzA5OQ=="}, "originalCommit": {"oid": "6bafe90483ccabf268b56b4556a7c1e2de66d86e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ4Mjg2OA==", "bodyText": "I'm with @original-brownbear here, using Math.abs(expr) and then branching on the sign of expr looks weird to me. Let's avoid the use of Math#abs (and therefore the super-broad @SuppressForbidden annotation).", "url": "https://github.com/elastic/elasticsearch/pull/56870#discussion_r426482868", "createdAt": "2020-05-18T09:15:25Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java", "diffHunk": "@@ -472,19 +474,12 @@ public Builder updateNumberOfReplicas(final int numberOfReplicas, final String[]\n                 for (IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {\n                     builder.addIndexShard(indexShardRoutingTable);\n                 }\n-                if (currentNumberOfReplicas < numberOfReplicas) {\n-                    // now, add \"empty\" ones\n-                    for (int i = 0; i < (numberOfReplicas - currentNumberOfReplicas); i++) {\n+                int delta = Math.abs(numberOfReplicas - currentNumberOfReplicas);\n+                for (int i = 0; i < delta; i++) {\n+                    if (currentNumberOfReplicas < numberOfReplicas) {\n                         builder.addReplica();\n-                    }\n-                } else if (currentNumberOfReplicas > numberOfReplicas) {\n-                    int delta = currentNumberOfReplicas - numberOfReplicas;\n-                    if (delta <= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzA5OQ=="}, "originalCommit": {"oid": "6bafe90483ccabf268b56b4556a7c1e2de66d86e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ4ODQ2MQ==", "bodyText": "OK. I removed abs method. Thank you @DaveCTurner .", "url": "https://github.com/elastic/elasticsearch/pull/56870#discussion_r426488461", "createdAt": "2020-05-18T09:24:21Z", "author": {"login": "howardhuanghua"}, "path": "server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java", "diffHunk": "@@ -472,19 +474,12 @@ public Builder updateNumberOfReplicas(final int numberOfReplicas, final String[]\n                 for (IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {\n                     builder.addIndexShard(indexShardRoutingTable);\n                 }\n-                if (currentNumberOfReplicas < numberOfReplicas) {\n-                    // now, add \"empty\" ones\n-                    for (int i = 0; i < (numberOfReplicas - currentNumberOfReplicas); i++) {\n+                int delta = Math.abs(numberOfReplicas - currentNumberOfReplicas);\n+                for (int i = 0; i < delta; i++) {\n+                    if (currentNumberOfReplicas < numberOfReplicas) {\n                         builder.addReplica();\n-                    }\n-                } else if (currentNumberOfReplicas > numberOfReplicas) {\n-                    int delta = currentNumberOfReplicas - numberOfReplicas;\n-                    if (delta <= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzA5OQ=="}, "originalCommit": {"oid": "6bafe90483ccabf268b56b4556a7c1e2de66d86e"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 320, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}