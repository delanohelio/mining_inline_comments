{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MzQ5MzQy", "number": 62258, "title": "Fix projects that failed to build within Intellij", "bodyText": "This commit address some build failures from the perspective of Intellij.\nThese changes include:\n\nchanging an order of a dependency definition that seems to can cause Intellij build to fail.\nintroduction of an abstract class out of the test source set (seems to be an issue sharing\nclasses cross projects with non-standard source sets.\na couple of missing dependency definitions (not sure how the command line worked prior to this)\n\nThis has been tested to work with\n-> a clean checkout (clean -xdf) -> restart and invalidate cache -> rebuild project and no errors.", "createdAt": "2020-09-10T21:30:17Z", "url": "https://github.com/elastic/elasticsearch/pull/62258", "merged": true, "mergeCommit": {"oid": "86660b0cbe41c80d40b0e2ade3594971573ebce3"}, "closed": true, "closedAt": "2020-09-15T17:52:11Z", "author": {"login": "jakelandis"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHlEMBAH2gAyNDg0MzQ5MzQyOmVhYmNiNDJkYTYxMzA4OTQ1Mjg5ZmVjNzhkYjk2NDRiMTYyYWZjZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJK-DbgFqTQ4ODg5MjI3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eabcb42da61308945289fec78db9644b162afce4", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/eabcb42da61308945289fec78db9644b162afce4", "committedDate": "2020-09-10T18:25:46Z", "message": "iniitial fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "933852c75f496a17e8f1f23c33ad983c2bdc028f", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/933852c75f496a17e8f1f23c33ad983c2bdc028f", "committedDate": "2020-09-10T20:53:04Z", "message": "xperamint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0b5b365cd3d79b52e7b187d025d383881df8db5", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/b0b5b365cd3d79b52e7b187d025d383881df8db5", "committedDate": "2020-09-10T21:09:33Z", "message": "move xpack rest test back to test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e71f397799b5051c82f240e585d90e8b8220c3e0", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/e71f397799b5051c82f240e585d90e8b8220c3e0", "committedDate": "2020-09-10T21:13:03Z", "message": "minor typo fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a273b94469ed00dcc3f3885134804b1da6c4f388", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/a273b94469ed00dcc3f3885134804b1da6c4f388", "committedDate": "2020-09-10T21:25:56Z", "message": "fix x-pack rest testss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c952a0e02f10c11cbff85b03ed71e8f02e500a2", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c952a0e02f10c11cbff85b03ed71e8f02e500a2", "committedDate": "2020-09-10T21:29:02Z", "message": "fix over reaching intellij refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6760bfa26bb90793383a9c669bffd0a2814d6fa5", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/6760bfa26bb90793383a9c669bffd0a2814d6fa5", "committedDate": "2020-09-10T21:31:39Z", "message": "fix name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6b3090d4521edb21d5dc17d4179d462a29c3164", "committedDate": "2020-09-10T21:43:07Z", "message": "attempt to preserve git history and fix jar hell"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzM0NzUx", "url": "https://github.com/elastic/elasticsearch/pull/62258#pullrequestreview-486334751", "createdAt": "2020-09-10T21:49:27Z", "commit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo0OToyN1rOHQG80w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo0OToyN1rOHQG80w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1MzEzOQ==", "bodyText": "There are not any actual changes to this file...just renamed and moved back to the test source set.\nI think this change this makes sense since independent of any other reason since there are a few runners that extend this... however the real reason i am introducing this is that I could not figure out how to get Intellij to share classes x-project and x-non-standard source set...it works fine from the test sourceset, but when shared from the custom source set (yamlRestTest) Intellij seems to have issues (the command line works fine).", "url": "https://github.com/elastic/elasticsearch/pull/62258#discussion_r486653139", "createdAt": "2020-09-10T21:49:27Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/src/test/java/org/elasticsearch/xpack/test/rest/AbstractXPackRestTest.java", "diffHunk": "@@ -0,0 +1,285 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.test.rest;\n+\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import com.carrotsearch.randomizedtesting.annotations.TimeoutSuite;\n+import org.apache.http.HttpStatus;\n+import org.apache.lucene.util.TimeUnits;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.common.CheckedFunction;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.common.xcontent.support.XContentMapValues;\n+import org.elasticsearch.plugins.MetadataUpgrader;\n+import org.elasticsearch.test.SecuritySettingsSourceField;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n+import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n+import org.elasticsearch.test.rest.yaml.ClientYamlTestResponse;\n+import org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase;\n+import org.elasticsearch.xpack.core.ml.MlConfigIndex;\n+import org.elasticsearch.xpack.core.ml.MlMetaIndex;\n+import org.elasticsearch.xpack.core.ml.integration.MlRestTestStateCleaner;\n+import org.elasticsearch.xpack.core.ml.job.persistence.AnomalyDetectorsIndex;\n+import org.elasticsearch.xpack.core.ml.job.persistence.AnomalyDetectorsIndexFields;\n+import org.elasticsearch.xpack.core.ml.notifications.NotificationsIndex;\n+import org.elasticsearch.xpack.core.rollup.job.RollupJob;\n+import org.elasticsearch.xpack.core.transform.transforms.persistence.TransformInternalIndexConstants;\n+import org.junit.After;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.Supplier;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.Collections.singletonMap;\n+import static org.elasticsearch.common.xcontent.support.XContentMapValues.extractValue;\n+import static org.elasticsearch.rest.action.search.RestSearchAction.TOTAL_HITS_AS_INT_PARAM;\n+import static org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken.basicAuthHeaderValue;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasSize;\n+\n+/** Runs rest tests against external cluster */\n+// TODO: Remove this timeout increase once this test suite is broken up\n+@TimeoutSuite(millis = 60 * TimeUnits.MINUTE)\n+public class AbstractXPackRestTest extends ESClientYamlSuiteTestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzM1NzI1", "url": "https://github.com/elastic/elasticsearch/pull/62258#pullrequestreview-486335725", "createdAt": "2020-09-10T21:51:22Z", "commit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo1MToyMlrOHQHAEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo1MToyMlrOHQHAEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1Mzk2OA==", "bodyText": "I am pretty sure the only reason we expose this is for the yaml tests and the custom parent runner, both of which are (now) in the test source set...so only expose that in the jar and testArtifact config.", "url": "https://github.com/elastic/elasticsearch/pull/62258#discussion_r486653968", "createdAt": "2020-09-10T21:51:22Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/build.gradle", "diffHunk": "@@ -37,10 +34,8 @@ artifacts {\n \n def testJar = tasks.register(\"testJar\", Jar) {\n   appendix 'test'\n-  duplicatesStrategy = DuplicatesStrategy.INCLUDE\n   from sourceSets.test.output\n-  from sourceSets.yamlRestTest.output\n-  from sourceSets.javaRestTest.output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzM2NDkx", "url": "https://github.com/elastic/elasticsearch/pull/62258#pullrequestreview-486336491", "createdAt": "2020-09-10T21:52:50Z", "commit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo1Mjo1MFrOHQHCiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo1Mjo1MFrOHQHCiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1NDYwMA==", "bodyText": "this doesn't seem to have any functional impact, just noticed I missed this before and I think it is a bit more correct.", "url": "https://github.com/elastic/elasticsearch/pull/62258#discussion_r486654600", "createdAt": "2020-09-10T21:52:50Z", "author": {"login": "jakelandis"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/util/GradleUtils.java", "diffHunk": "@@ -155,7 +155,7 @@ public static void setupIdeForTestSourceSet(Project project, SourceSet testSourc\n         project.getPluginManager().withPlugin(\"idea\", p -> {\n             IdeaModel idea = project.getExtensions().getByType(IdeaModel.class);\n             idea.getModule().setTestSourceDirs(testSourceSet.getJava().getSrcDirs());\n-            idea.getModule().getScopes().put(\"TEST\", Map.of(\"plus\", List.of(runtimeClasspathConfiguration)));\n+            idea.getModule().getScopes().put(testSourceSet.getName(), Map.of(\"plus\", List.of(runtimeClasspathConfiguration)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzM4MTU5", "url": "https://github.com/elastic/elasticsearch/pull/62258#pullrequestreview-486338159", "createdAt": "2020-09-10T21:56:09Z", "commit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo1NjoxMFrOHQHH3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo1NjoxMFrOHQHH3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1NTk2Nw==", "bodyText": "wierd dependency ordering thing...likely a subtle in Intellij", "url": "https://github.com/elastic/elasticsearch/pull/62258#discussion_r486655967", "createdAt": "2020-09-10T21:56:10Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/ml/qa/ml-with-security/build.gradle", "diffHunk": "@@ -1,8 +1,8 @@\n apply plugin: 'elasticsearch.yaml-rest-test'\n \n dependencies {\n-  yamlRestTestImplementation project(path: xpackModule('core'), configuration: 'testArtifacts')\n   yamlRestTestImplementation project(path: xpackModule('core'))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzgzMzY2", "url": "https://github.com/elastic/elasticsearch/pull/62258#pullrequestreview-486383366", "createdAt": "2020-09-10T23:46:50Z", "commit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo0Njo1MFrOHQJaDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo0Njo1MFrOHQJaDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5MzM5MA==", "bodyText": "This might be why intellij gets confused. Instead we should add sourcets.main.runtimeClasspath to sourcesets.javaRestTest.runtimeClasspath rather than wire this up as a filecollection dependency. Basically, we should use GradleUtils.extendSourceSet() here if we need javaRestTest to \"extend from\" main.", "url": "https://github.com/elastic/elasticsearch/pull/62258#discussion_r486693390", "createdAt": "2020-09-10T23:46:50Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/ilm/qa/multi-node/build.gradle", "diffHunk": "@@ -2,6 +2,8 @@ apply plugin: 'elasticsearch.java-rest-test'\n \n dependencies {\n   javaRestTestImplementation project(path: xpackProject('plugin').path, configuration: 'testArtifacts')\n+  // let the javaRestTest see the classpath of main\n+  javaRestTestImplementation project.sourceSets.main.runtimeClasspath", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6b3090d4521edb21d5dc17d4179d462a29c3164"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87c2493a517df0373e2a94331464e385e5e79db8", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/87c2493a517df0373e2a94331464e385e5e79db8", "committedDate": "2020-09-14T20:59:18Z", "message": "use GradleUtils.extendSourceSet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2aceefdca367551f18857514e13cad68f55636a", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2aceefdca367551f18857514e13cad68f55636a", "committedDate": "2020-09-14T22:26:27Z", "message": "add support to extend eager test task classpaths"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61f288d7c507c51f50d7f23f3119141d9dd1a275", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/61f288d7c507c51f50d7f23f3119141d9dd1a275", "committedDate": "2020-09-14T22:30:06Z", "message": "undo example"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54b3373c1e2c352171831f1f08cb01780b658663", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/54b3373c1e2c352171831f1f08cb01780b658663", "committedDate": "2020-09-14T22:32:12Z", "message": "Merge remote-tracking branch 'upstream/master' into fix_intellij_build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4ODkyMjcy", "url": "https://github.com/elastic/elasticsearch/pull/62258#pullrequestreview-488892272", "createdAt": "2020-09-15T17:09:24Z", "commit": {"oid": "54b3373c1e2c352171831f1f08cb01780b658663"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4706, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}