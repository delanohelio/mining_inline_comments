{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMDM4MTI2", "number": 52917, "title": "[APM] Allow kibana to collect APM telemetry in background task", "bodyText": "Required for elastic/kibana#50757. Allows the kibana user to collect APM telemetry in a background task by giving the kibana_system reserved role the read, read_cross_cluster, view_index_metadata privileges on apm-*", "createdAt": "2020-02-27T19:45:43Z", "url": "https://github.com/elastic/elasticsearch/pull/52917", "merged": true, "mergeCommit": {"oid": "41ba99361d716c122a04ce0d84c60f2904858daa"}, "closed": true, "closedAt": "2020-03-24T15:46:04Z", "author": {"login": "ogupte"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIrJxWABqjMwODA4NTI0MDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ0tXSgFqTM4MDQyOTY2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e3e83f9a99837ffbdd48aa0aa9829d737c8c094", "author": {"user": {"login": "ogupte", "name": "Oliver Gupte"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e3e83f9a99837ffbdd48aa0aa9829d737c8c094", "committedDate": "2020-02-27T19:39:36Z", "message": "Required for elastic/kibana#50757.\nAllows the kibana user to collect APM telemetry in a background task."}, "afterCommit": {"oid": "a959378ac8d12e1c319d3fdf52f435d3b4bb30ac", "author": {"user": {"login": "ogupte", "name": "Oliver Gupte"}}, "url": "https://github.com/elastic/elasticsearch/commit/a959378ac8d12e1c319d3fdf52f435d3b4bb30ac", "committedDate": "2020-02-28T07:53:23Z", "message": "Required for elastic/kibana#50757.\nAllows the kibana user to collect APM telemetry in a background task."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a959378ac8d12e1c319d3fdf52f435d3b4bb30ac", "author": {"user": {"login": "ogupte", "name": "Oliver Gupte"}}, "url": "https://github.com/elastic/elasticsearch/commit/a959378ac8d12e1c319d3fdf52f435d3b4bb30ac", "committedDate": "2020-02-28T07:53:23Z", "message": "Required for elastic/kibana#50757.\nAllows the kibana user to collect APM telemetry in a background task."}, "afterCommit": {"oid": "c8f26084d1bda8e1450f14041752f4e516a63f55", "author": {"user": {"login": "ogupte", "name": "Oliver Gupte"}}, "url": "https://github.com/elastic/elasticsearch/commit/c8f26084d1bda8e1450f14041752f4e516a63f55", "committedDate": "2020-03-10T05:06:22Z", "message": "Required for elastic/kibana#50757.\nAllows the kibana user to collect APM telemetry in a background task."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjU2MzUw", "url": "https://github.com/elastic/elasticsearch/pull/52917#pullrequestreview-375656350", "createdAt": "2020-03-16T23:53:43Z", "commit": {"oid": "c8f26084d1bda8e1450f14041752f4e516a63f55"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMzo1Mzo0NFrOF3JnWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMzo1Mzo0NFrOF3JnWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3MzUzMA==", "bodyText": "Most of the indices referenced in this file is prefixed with a dot. So just wanna make sure this one is indeed without it.", "url": "https://github.com/elastic/elasticsearch/pull/52917#discussion_r393373530", "createdAt": "2020-03-16T23:53:44Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/store/ReservedRolesStore.java", "diffHunk": "@@ -124,11 +124,19 @@\n                                         .indices(\".monitoring-*\").privileges(\"read\", \"read_cross_cluster\").build(),\n                                 RoleDescriptor.IndicesPrivileges.builder()\n                                         .indices(\".management-beats\").privileges(\"create_index\", \"read\", \"write\").build(),\n-                                // .apm-* is for APM's agent configuration and custom link index creation\n+                                // APM agent configuration\n                                 RoleDescriptor.IndicesPrivileges.builder()\n                                         .indices(\".apm-agent-configuration\").privileges(\"all\").build(),\n+                                // APM custom link index creation\n                                 RoleDescriptor.IndicesPrivileges.builder()\n                                         .indices(\".apm-custom-link\").privileges(\"all\").build(),\n+                                // APM telemetry queries APM & ML anomalies indices in kibana task runner\n+                                RoleDescriptor.IndicesPrivileges.builder()\n+                                    .indices(\"apm-*\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8f26084d1bda8e1450f14041752f4e516a63f55"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1OTM1OTM5", "url": "https://github.com/elastic/elasticsearch/pull/52917#pullrequestreview-375935939", "createdAt": "2020-03-17T11:08:35Z", "commit": {"oid": "c8f26084d1bda8e1450f14041752f4e516a63f55"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MDYzNDcw", "url": "https://github.com/elastic/elasticsearch/pull/52917#pullrequestreview-376063470", "createdAt": "2020-03-17T14:03:32Z", "commit": {"oid": "c8f26084d1bda8e1450f14041752f4e516a63f55"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDowMzozM1rOF3dqZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDozNzozOVrOF3fMqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcwMTk4OQ==", "bodyText": "@ogupte In a previous discussion, of which you have been part of, see #50051 (comment), Brandon laid out the design of security privileges.\nAccording to it, system roles such as kibana_system, which are used by Kibana system tasks/jobs for internal house keeping, must not be granted privileges against end user data. The administrator must at all times be in control of which users and services have access to the end user's data.\nIf a system task needs to deal with user data, it must get consent from the user, and afterwards obtain API keys on the user's behalf (see #52886). The end users should be able to revoke the system user's access to his data at any time.\nIIUC this PR grants privileges to user data to the kibana_system role, going against the restrictions described above.", "url": "https://github.com/elastic/elasticsearch/pull/52917#discussion_r393701989", "createdAt": "2020-03-17T14:03:33Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/store/ReservedRolesStore.java", "diffHunk": "@@ -124,11 +124,19 @@\n                                         .indices(\".monitoring-*\").privileges(\"read\", \"read_cross_cluster\").build(),\n                                 RoleDescriptor.IndicesPrivileges.builder()\n                                         .indices(\".management-beats\").privileges(\"create_index\", \"read\", \"write\").build(),\n-                                // .apm-* is for APM's agent configuration and custom link index creation\n+                                // APM agent configuration\n                                 RoleDescriptor.IndicesPrivileges.builder()\n                                         .indices(\".apm-agent-configuration\").privileges(\"all\").build(),\n+                                // APM custom link index creation\n                                 RoleDescriptor.IndicesPrivileges.builder()\n                                         .indices(\".apm-custom-link\").privileges(\"all\").build(),\n+                                // APM telemetry queries APM & ML anomalies indices in kibana task runner\n+                                RoleDescriptor.IndicesPrivileges.builder()\n+                                    .indices(\"apm-*\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM3MzUzMA=="}, "originalCommit": {"oid": "c8f26084d1bda8e1450f14041752f4e516a63f55"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyNzE0Ng==", "bodyText": "I also don't think the kibana_system user should access ML data directly, but I need more context.\nInstead I propose, similarly to the above, the the APM kibana system user calls the ML APIs using the credentials of the user (via an API key). That's because ML users do get access to the .ml-anomalies* indices which indicates that the .ml-anomalies* indices contain user data.\nMaybe @droberts195 has a better suggestion of how APM should access ML data ?", "url": "https://github.com/elastic/elasticsearch/pull/52917#discussion_r393727146", "createdAt": "2020-03-17T14:37:39Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/store/ReservedRolesStore.java", "diffHunk": "@@ -124,11 +124,19 @@\n                                         .indices(\".monitoring-*\").privileges(\"read\", \"read_cross_cluster\").build(),\n                                 RoleDescriptor.IndicesPrivileges.builder()\n                                         .indices(\".management-beats\").privileges(\"create_index\", \"read\", \"write\").build(),\n-                                // .apm-* is for APM's agent configuration and custom link index creation\n+                                // APM agent configuration\n                                 RoleDescriptor.IndicesPrivileges.builder()\n                                         .indices(\".apm-agent-configuration\").privileges(\"all\").build(),\n+                                // APM custom link index creation\n                                 RoleDescriptor.IndicesPrivileges.builder()\n                                         .indices(\".apm-custom-link\").privileges(\"all\").build(),\n+                                // APM telemetry queries APM & ML anomalies indices in kibana task runner\n+                                RoleDescriptor.IndicesPrivileges.builder()\n+                                    .indices(\"apm-*\")\n+                                    .privileges(\"read\", \"read_cross_cluster\", \"view_index_metadata\").build(),\n+                                RoleDescriptor.IndicesPrivileges.builder()\n+                                    .indices(\".ml-anomalies-*\")\n+                                    .privileges(\"read\", \"read_cross_cluster\", \"view_index_metadata\").build(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8f26084d1bda8e1450f14041752f4e516a63f55"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0ee239cd1981c6700cd06777619aabee308ee39", "author": {"user": {"login": "ogupte", "name": "Oliver Gupte"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0ee239cd1981c6700cd06777619aabee308ee39", "committedDate": "2020-03-19T06:37:40Z", "message": "Required for elastic/kibana#50757.\nAllows the kibana user to collect APM telemetry in a background task."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efa09632c0bb5230353d28fdc0c32cbe59b81f02", "author": {"user": {"login": "ogupte", "name": "Oliver Gupte"}}, "url": "https://github.com/elastic/elasticsearch/commit/efa09632c0bb5230353d28fdc0c32cbe59b81f02", "committedDate": "2020-03-19T06:51:56Z", "message": "removed unnecessary priviledges on `.ml-anomalies-*` for the `kibana_system` reserved role"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8f26084d1bda8e1450f14041752f4e516a63f55", "author": {"user": {"login": "ogupte", "name": "Oliver Gupte"}}, "url": "https://github.com/elastic/elasticsearch/commit/c8f26084d1bda8e1450f14041752f4e516a63f55", "committedDate": "2020-03-10T05:06:22Z", "message": "Required for elastic/kibana#50757.\nAllows the kibana user to collect APM telemetry in a background task."}, "afterCommit": {"oid": "efa09632c0bb5230353d28fdc0c32cbe59b81f02", "author": {"user": {"login": "ogupte", "name": "Oliver Gupte"}}, "url": "https://github.com/elastic/elasticsearch/commit/efa09632c0bb5230353d28fdc0c32cbe59b81f02", "committedDate": "2020-03-19T06:51:56Z", "message": "removed unnecessary priviledges on `.ml-anomalies-*` for the `kibana_system` reserved role"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5OTIzNTk3", "url": "https://github.com/elastic/elasticsearch/pull/52917#pullrequestreview-379923597", "createdAt": "2020-03-24T00:29:59Z", "commit": {"oid": "efa09632c0bb5230353d28fdc0c32cbe59b81f02"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDI5NjY1", "url": "https://github.com/elastic/elasticsearch/pull/52917#pullrequestreview-380429665", "createdAt": "2020-03-24T15:33:29Z", "commit": {"oid": "efa09632c0bb5230353d28fdc0c32cbe59b81f02"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2056, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}