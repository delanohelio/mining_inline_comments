{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyOTYzNDgy", "number": 60683, "title": "Replace AggregatorTestCase#search with AggregatorTestCase#searchAndReduce", "bodyText": "This commit removes the ability to test the top level result of an aggregator\nbefore it runs the final reduce. All aggregator tests that use AggregatorTestCase#search\nare rewritten with AggregatorTestCase#searchAndReduce in order to ensure that we test\nthe final output (the one sent to the end user) rather than an intermediary result\nthat could be different.\nThis change also removes spurious commits triggered on top of a random index writer.\nThese commits slow down the tests and are redundant with the commits that the\nrandom index writer performs.", "createdAt": "2020-08-04T19:26:31Z", "url": "https://github.com/elastic/elasticsearch/pull/60683", "merged": true, "mergeCommit": {"oid": "5de0ed9432f4b41b697c9f3bc28953834cd3eae1"}, "closed": true, "closedAt": "2020-08-06T12:08:27Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7rvEygH2gAyNDYyOTYzNDgyOmNmMjQyMjE1NGZhYTM5MmI2MDhjZDg2MGM1OTk5ZjA5MGY1NWI4NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8A5kSgFqTQ2MTk4MzYyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf2422154faa392b608cd860c5999f090f55b863", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/cf2422154faa392b608cd860c5999f090f55b863", "committedDate": "2020-08-04T19:24:57Z", "message": "Replace AggregatorTestCase#search with AggregatorTestCase#searchAndReduce\n\nThis commit removes the ability to test the top level result of an aggregator\nbefore it runs the final reduce. All aggregator tests that use AggregatorTestCase#search\nare rewritten with AggregatorTestCase#searchAndReduce in order to ensure that we test\nthe final output (the one sent to the end user) rather than an intermediary result\nthat could be different.\nThis change also removes spurious commits triggered on top of a random index writer.\nThese commits slow down the tests and are redundant with the commits that the\nrandom index writer performs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5453d7e6f9bc722fbeec10e0e427b0895b49198e", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/5453d7e6f9bc722fbeec10e0e427b0895b49198e", "committedDate": "2020-08-04T20:36:27Z", "message": "fix additional tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTQ0MDU2", "url": "https://github.com/elastic/elasticsearch/pull/60683#pullrequestreview-461144056", "createdAt": "2020-08-04T20:20:10Z", "commit": {"oid": "cf2422154faa392b608cd860c5999f090f55b863"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDoyMDoxMFrOG7wFRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMDo1MDoxMlrOG7xA1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwNjk1MQ==", "bodyText": "Is this an actual bug you found while making this change?", "url": "https://github.com/elastic/elasticsearch/pull/60683#discussion_r465306951", "createdAt": "2020-08-04T20:20:10Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/InternalVariableWidthHistogram.java", "diffHunk": "@@ -451,7 +450,8 @@ private void mergeBucketsWithPlan(List<Bucket> buckets, List<BucketRange> plan,\n             }\n             toMerge.add(buckets.get(startIdx)); // Don't remove the startIdx bucket because it will be replaced by the merged bucket\n \n-            reduceContext.consumeBucketsAndMaybeBreak(- (toMerge.size() - 1));\n+            int toRemove = toMerge.stream().mapToInt(b -> countInnerBucket(b)+1).sum();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2422154faa392b608cd860c5999f090f55b863"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMwNzc1Nw==", "bodyText": "I think we can remove the entire if block here, and the doReduce for loop.", "url": "https://github.com/elastic/elasticsearch/pull/60683#discussion_r465307757", "createdAt": "2020-08-04T20:21:36Z", "author": {"login": "not-napoleon"}, "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/filter/FilterAggregatorTests.java", "diffHunk": "@@ -104,7 +104,7 @@ public void testRandom() throws Exception {\n                     response = searchAndReduce(indexSearcher, new MatchAllDocsQuery(), builder,\n                         fieldType);\n                 } else {\n-                    response = search(indexSearcher, new MatchAllDocsQuery(), builder, fieldType);\n+                    response = searchAndReduce(indexSearcher, new MatchAllDocsQuery(), builder, fieldType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2422154faa392b608cd860c5999f090f55b863"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyMjE5Nw==", "bodyText": "let's either update the comment to match the new range, or just delete the comments.  And in the later tests as well.", "url": "https://github.com/elastic/elasticsearch/pull/60683#discussion_r465322197", "createdAt": "2020-08-04T20:50:12Z", "author": {"login": "not-napoleon"}, "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/histogram/RangeHistogramAggregatorTests.java", "diffHunk": "@@ -57,7 +57,7 @@ public void testDoubles() throws Exception {\n                 new RangeFieldMapper.Range(rangeType, 1.0D, 5.0D, true, true), // bucket 0 5\n                 new RangeFieldMapper.Range(rangeType, -3.1, 4.2, true, true), // bucket -5, 0\n                 new RangeFieldMapper.Range(rangeType, 4.2, 13.3, true, true), // bucket 0, 5, 10\n-                new RangeFieldMapper.Range(rangeType, 42.5, 49.3, true, true), // bucket 40, 45\n+                new RangeFieldMapper.Range(rangeType, 22.5, 29.3, true, true), // bucket 40, 45", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5453d7e6f9bc722fbeec10e0e427b0895b49198e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dd98d16f924040dc870ab26c8feee62ad65e3ab", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/1dd98d16f924040dc870ab26c8feee62ad65e3ab", "committedDate": "2020-08-04T22:53:49Z", "message": "address review and fix another test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f11a8cfdefe270f95d36411796ba0759d4c1eb73", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f11a8cfdefe270f95d36411796ba0759d4c1eb73", "committedDate": "2020-08-05T05:43:11Z", "message": "Merge branch 'master' into aggregator_tests_search_and_reduce"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTgzNjI3", "url": "https://github.com/elastic/elasticsearch/pull/60683#pullrequestreview-461983627", "createdAt": "2020-08-05T20:04:25Z", "commit": {"oid": "f11a8cfdefe270f95d36411796ba0759d4c1eb73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3516, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}