{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNDg5NDIy", "number": 55015, "title": "Handle v2 template with index.hidden setting", "bodyText": "This validates that if the winner v2 template is a global one, it doesn't specify the\nindex.hidden setting.", "createdAt": "2020-04-09T15:24:49Z", "url": "https://github.com/elastic/elasticsearch/pull/55015", "merged": true, "mergeCommit": {"oid": "19a97f76aac73e0455053097e5391165a9357427"}, "closed": true, "closedAt": "2020-04-17T13:29:34Z", "author": {"login": "andreidan"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV-JcJgH2gAyNDAxNDg5NDIyOjMyMWY3NGE2MDYwMzM4MmE4OGQ1MzM1YmJjZDE3YzBkMzE4NTQwYWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYggffgH2gAyNDAxNDg5NDIyOjVmYzNmZWMxMTgwZDY0OTRiZTY3ZDBhZTk1NDdkOTAyYjYzYjY3ZGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "321f74a60603382a88d5335bbcd17c0d318540aa", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/321f74a60603382a88d5335bbcd17c0d318540aa", "committedDate": "2020-04-09T15:22:55Z", "message": "Handle v2 template with index.hidden setting\n\nThis commit handles the case where the user request doesn't explicitly set\nthe index as hidden but a mathcing template has the `index.hidden` setting\nconfigured to true. In this case the global templates need to be excluded."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTA1NjY1", "url": "https://github.com/elastic/elasticsearch/pull/55015#pullrequestreview-390905665", "createdAt": "2020-04-09T15:36:07Z", "commit": {"oid": "321f74a60603382a88d5335bbcd17c0d318540aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNTozNjowN1rOGDeMgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNTozNjowN1rOGDeMgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI5MzYzNQ==", "bodyText": "#55010 guards against this when creating a v2 template", "url": "https://github.com/elastic/elasticsearch/pull/55015#discussion_r406293635", "createdAt": "2020-04-09T15:36:07Z", "author": {"login": "andreidan"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -663,6 +663,27 @@ public static String findV2Template(Metadata metadata, String indexName, @Nullab\n             return null;\n         }\n \n+        // this is complex but if the index is not hidden in the create request but is hidden as the result of template application,\n+        // then we need to exclude global templates\n+        if (isHidden == null) {\n+            final Optional<Map.Entry<IndexTemplateV2, String>> templateWithHiddenSetting = matchedTemplates.entrySet().stream()\n+                .filter(entry -> IndexMetadata.INDEX_HIDDEN_SETTING.exists(resolveSettings(metadata, entry.getValue()))).findFirst();\n+            if (templateWithHiddenSetting.isPresent()) {\n+                Map.Entry<IndexTemplateV2, String> indexTemplateV2ToNameEntry = templateWithHiddenSetting.get();\n+                final boolean templateIsHidden =\n+                    IndexMetadata.INDEX_HIDDEN_SETTING.get(resolveSettings(metadata, indexTemplateV2ToNameEntry.getValue()));\n+                if (templateIsHidden) {\n+                    // remove the global templates\n+                    matchedTemplates.keySet().removeIf(current -> current.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern));\n+                }\n+                // validate that hidden didn't change\n+                if (matchedTemplates.containsKey(indexTemplateV2ToNameEntry.getKey()) == false) {\n+                    throw new IllegalStateException(\"A global index V2 template [\" + indexTemplateV2ToNameEntry.getValue() +\n+                        \"] defined the index hidden setting, which is not allowed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "321f74a60603382a88d5335bbcd17c0d318540aa"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTExOTQ0", "url": "https://github.com/elastic/elasticsearch/pull/55015#pullrequestreview-391111944", "createdAt": "2020-04-09T20:32:52Z", "commit": {"oid": "321f74a60603382a88d5335bbcd17c0d318540aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDozMjo1MlrOGDoYmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDozMjo1MlrOGDoYmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2MDU2OQ==", "bodyText": "So this brings a question:\n\nShould we throw an error (the error below for validation) on index creation for a template that won't actually \"win\" for the creation?\n\nIf the answer is yes, then I think rather than returning only the first one, it would be good to return all templates (in the error message I mean) that exhibit this behavior.\nIf the answer is no, then we can move this check to be below the candidate sorting and only check the winner template.\nWhat do you think?", "url": "https://github.com/elastic/elasticsearch/pull/55015#discussion_r406460569", "createdAt": "2020-04-09T20:32:52Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -663,6 +663,27 @@ public static String findV2Template(Metadata metadata, String indexName, @Nullab\n             return null;\n         }\n \n+        // this is complex but if the index is not hidden in the create request but is hidden as the result of template application,\n+        // then we need to exclude global templates\n+        if (isHidden == null) {\n+            final Optional<Map.Entry<IndexTemplateV2, String>> templateWithHiddenSetting = matchedTemplates.entrySet().stream()\n+                .filter(entry -> IndexMetadata.INDEX_HIDDEN_SETTING.exists(resolveSettings(metadata, entry.getValue()))).findFirst();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "321f74a60603382a88d5335bbcd17c0d318540aa"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTU2NTk4", "url": "https://github.com/elastic/elasticsearch/pull/55015#pullrequestreview-391156598", "createdAt": "2020-04-09T21:50:51Z", "commit": {"oid": "321f74a60603382a88d5335bbcd17c0d318540aa"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMTo1MDo1MVrOGDqrLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMjowMDo1NVrOGDq7GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ5ODA5NQ==", "bodyText": "For me the answer is no and we should only be interested in winning template - index can became hidden only by the means of the winner, doesn't matter what is in other templates.\nSo I'd move the code after winner is selected.\nI'd also change sorting to linear min selection to avoid creating new list and sorting candidates that won't win:\nIndexTemplateV2 winner = matchedTemplates.keySet().stream().min(Comparator.comparing(IndexTemplateV2::priority,\n            Comparator.nullsLast(Comparator.reverseOrder()))).get();", "url": "https://github.com/elastic/elasticsearch/pull/55015#discussion_r406498095", "createdAt": "2020-04-09T21:50:51Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -663,6 +663,27 @@ public static String findV2Template(Metadata metadata, String indexName, @Nullab\n             return null;\n         }\n \n+        // this is complex but if the index is not hidden in the create request but is hidden as the result of template application,\n+        // then we need to exclude global templates\n+        if (isHidden == null) {\n+            final Optional<Map.Entry<IndexTemplateV2, String>> templateWithHiddenSetting = matchedTemplates.entrySet().stream()\n+                .filter(entry -> IndexMetadata.INDEX_HIDDEN_SETTING.exists(resolveSettings(metadata, entry.getValue()))).findFirst();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2MDU2OQ=="}, "originalCommit": {"oid": "321f74a60603382a88d5335bbcd17c0d318540aa"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUwMjE2OQ==", "bodyText": "This can be simplified to something like this:\nif (isHidden == null) {\n    matchedTemplates.entrySet().stream()\n        .filter(entry -> IndexMetadata.INDEX_HIDDEN_SETTING.get(resolveSettings(metadata, entry.getValue())))\n        // relies on the fact that default for INDEX_HIDDEN_SETTING is false\n        .findAny()\n        .ifPresent(indexTemplateV2ToNameEntry -> {\n            matchedTemplates.keySet().removeIf(current -> current.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern));\n            if (matchedTemplates.containsKey(indexTemplateV2ToNameEntry.getKey()) == false) {\n                throw new IllegalStateException(\"A global index V2 template [\" + indexTemplateV2ToNameEntry.getValue() +\n                    \"] defined the index hidden setting, which is not allowed\");\n            }\n        });\n}", "url": "https://github.com/elastic/elasticsearch/pull/55015#discussion_r406502169", "createdAt": "2020-04-09T22:00:55Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -663,6 +663,27 @@ public static String findV2Template(Metadata metadata, String indexName, @Nullab\n             return null;\n         }\n \n+        // this is complex but if the index is not hidden in the create request but is hidden as the result of template application,\n+        // then we need to exclude global templates\n+        if (isHidden == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "321f74a60603382a88d5335bbcd17c0d318540aa"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b54661a1b6363d63a8098bb83f6f50a928065d0", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b54661a1b6363d63a8098bb83f6f50a928065d0", "committedDate": "2020-04-16T13:30:08Z", "message": "Merge branch 'master' into itv2-null-isHidden-flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f2393714392a14f429e0a73e7ceefc341cb678", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/d7f2393714392a14f429e0a73e7ceefc341cb678", "committedDate": "2020-04-16T15:47:21Z", "message": "Validate the winner template when isHidden is null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8239490d6670089c134cd4fc15d7b7a9385e141e", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/8239490d6670089c134cd4fc15d7b7a9385e141e", "committedDate": "2020-04-16T16:03:38Z", "message": "Check if winner is a global template"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0ODI0NTk5", "url": "https://github.com/elastic/elasticsearch/pull/55015#pullrequestreview-394824599", "createdAt": "2020-04-16T16:55:59Z", "commit": {"oid": "8239490d6670089c134cd4fc15d7b7a9385e141e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNjo1NjowMFrOGGuk3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNjo1Njo1OFrOGGunMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwNzc0MQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/55015#discussion_r409707741", "createdAt": "2020-04-16T16:56:00Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -268,7 +268,7 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n     }\n \n     /**\n-     * Add the given component template to the cluster state. If {@code create} is true, an\n+     * Add the given index template to the cluster state. If {@code create} is true, an", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8239490d6670089c134cd4fc15d7b7a9385e141e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwODMzOA==", "bodyText": "Super minor nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new IllegalStateException(\"A global index V2 template [\" + winnerName + \"], composed of component templates [\" +\n          \n          \n            \n                            throw new IllegalStateException(\"global index template [\" + winnerName + \"], composed of component templates [\" +", "url": "https://github.com/elastic/elasticsearch/pull/55015#discussion_r409708338", "createdAt": "2020-04-16T16:56:58Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -696,7 +696,21 @@ public static String findV2Template(Metadata metadata, String indexName, @Nullab\n \n         assert candidates.size() > 0 : \"we should have returned early with no candidates\";\n         IndexTemplateV2 winner = candidates.get(0);\n-        return matchedTemplates.get(winner);\n+        String winnerName = matchedTemplates.get(winner);\n+\n+        // if the index is not hidden in the create request but the winner template is a global template that specifies the `index.hidden`\n+        // setting (which is not allowed, so it'd be due to a restored index cluster state that modified a component template used by this\n+        // global template such that it has this setting) we will fail and the user will have to update the index template and remove\n+        // this setting or update the corresponding component template that contributes to the index template resolved settings\n+        if (isHidden == null) {\n+            if (winner.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern) &&\n+                IndexMetadata.INDEX_HIDDEN_SETTING.exists(resolveSettings(metadata, winnerName))) {\n+                throw new IllegalStateException(\"A global index V2 template [\" + winnerName + \"], composed of component templates [\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8239490d6670089c134cd4fc15d7b7a9385e141e"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b11c6f297cf81075a1bca304c044522074ea6dda", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/b11c6f297cf81075a1bca304c044522074ea6dda", "committedDate": "2020-04-16T17:00:49Z", "message": "Update exception message\n\nCo-Authored-By: Lee Hinman <dakrone@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cb83b8a608fe2e5f13dd75a0f2f0609a3b6f4fe", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/5cb83b8a608fe2e5f13dd75a0f2f0609a3b6f4fe", "committedDate": "2020-04-17T09:09:06Z", "message": "Remve the isHidden flag null check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Mjk0NDI3", "url": "https://github.com/elastic/elasticsearch/pull/55015#pullrequestreview-395294427", "createdAt": "2020-04-17T09:18:42Z", "commit": {"oid": "5cb83b8a608fe2e5f13dd75a0f2f0609a3b6f4fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66ba8016201e34f65f7b7706b1c349a07adf31ee", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/66ba8016201e34f65f7b7706b1c349a07adf31ee", "committedDate": "2020-04-17T09:20:48Z", "message": "Merge branch 'master' into itv2-null-isHidden-flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "819c9cf23f961f7e8e22a388368bdffcd0fa789c", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/819c9cf23f961f7e8e22a388368bdffcd0fa789c", "committedDate": "2020-04-17T09:43:50Z", "message": "Merge branch 'master' into itv2-null-isHidden-flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc3fec1180d6494be67d0ae9547d902b63b67de", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/5fc3fec1180d6494be67d0ae9547d902b63b67de", "committedDate": "2020-04-17T12:32:43Z", "message": "Merge branch 'master' into itv2-null-isHidden-flag"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3660, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}