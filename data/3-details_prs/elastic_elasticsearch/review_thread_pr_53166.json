{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0Mjg5NTIw", "number": 53166, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDo1OToxNVrODllaJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMToxMDozMlrODllmjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzM2ODA0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDo1OToxNVrOFyj9Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwODo0NTo1MlrOFyxAlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2MjIzNA==", "bodyText": "I think it's safe to ignore this parameter. Let's leave it for now but I wonder if we should simply remove this setting in a follow up. @jpountz what do you think ? I can open an issue if you think this deserves a full discussion.", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388562234", "createdAt": "2020-03-05T20:59:15Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -110,7 +109,23 @@ public QueryPhase() {\n \n     @Override\n     public void preProcess(SearchContext context) {\n-        context.preProcess(true);\n+        final Runnable cancellation;\n+        if (context.lowLevelCancellation()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3NjA4NQ==", "bodyText": "In the long term, I agree that we should remove it. The thing that isn't clear to me is how much it hurts terms-dict-intensive queries like fuzzy queries.", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388776085", "createdAt": "2020-03-06T08:45:52Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -110,7 +109,23 @@ public QueryPhase() {\n \n     @Override\n     public void preProcess(SearchContext context) {\n-        context.preProcess(true);\n+        final Runnable cancellation;\n+        if (context.lowLevelCancellation()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2MjIzNA=="}, "originalCommit": {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzM5NjIyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTowOToyMVrOFykPDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTowOToyMVrOFykPDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2Njc5Nw==", "bodyText": "let's get the task once outside of the runnable like we do below ?", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388566797", "createdAt": "2020-03-05T21:09:21Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -110,7 +109,23 @@ public QueryPhase() {\n \n     @Override\n     public void preProcess(SearchContext context) {\n-        context.preProcess(true);\n+        final Runnable cancellation;\n+        if (context.lowLevelCancellation()) {\n+            cancellation = context.searcher().addQueryCancellation(() -> {\n+                if (context.getTask().isCancelled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzM5OTgwOnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMToxMDozMlrOFykRXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMToxMDozMlrOFykRXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2NzM5MA==", "bodyText": "I have a slight preference for this version. The task should never change during the execution of a search request.", "url": "https://github.com/elastic/elasticsearch/pull/53166#discussion_r388567390", "createdAt": "2020-03-05T21:10:32Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -265,9 +280,8 @@ static boolean executeInternal(SearchContext searchContext) throws QueryPhaseExe\n             }\n \n             if (searchContext.lowLevelCancellation()) {\n-                SearchShardTask task = searchContext.getTask();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "301f0c21ed3b0f0bf2d107e22e05becfa32ddddd"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3434, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}