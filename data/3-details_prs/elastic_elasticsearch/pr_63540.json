{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNDUyNjY5", "number": 63540, "title": "add copy_from parameter for set ingest processor", "bodyText": "Relates to #55682 and #51046, and refractor the code of #56985.\nThe main point of this PR is adding a copy_from parameter for set ingest processor to support copy the value of one field to another. We can copy boolean, number, array, object and other data types by the parameter copy_from instead of using template snippet which only produces string value.\nWhy adding a new parameter to implement the copy function but not modifying the template snippet so that it can produce object or array value ? I think we can make it compatible with older versions, users can still use template snippet to copy the produced string value to other field, but also can use copy_from to copy object or array value from one field to another.\nThe main changes are:\n\nAdd copy_from parameter for set ingest processor.\nAdd unit test and yml test for the change.\nUpdate the set processor's document.", "createdAt": "2020-10-12T09:36:52Z", "url": "https://github.com/elastic/elasticsearch/pull/63540", "merged": true, "mergeCommit": {"oid": "b17ce85f13223aedb7d0c3a51a500e7e88eafd36"}, "closed": true, "closedAt": "2020-11-02T16:40:06Z", "author": {"login": "gaobinlong"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRwRBZgH2gAyNTAxNDUyNjY5OjA0NmQyN2I1ZTRlNzA5YWFhZDI0ODcwZjZkYTMxNjY3MTNhZDJiZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYlL0igH2gAyNTAxNDUyNjY5OjQ2ZDJmMmZhZjQ5ZDczOGFhNjNlMTkxMWE2N2E4Mzc0Mjc2OTJjZTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "046d27b5e4e709aaad24870f6da3166713ad2be3", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/046d27b5e4e709aaad24870f6da3166713ad2be3", "committedDate": "2020-10-12T09:07:59Z", "message": "add copy_from parameter for set ingest processor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c5921b2c712974b2aa024c0973a0d03c4aee472", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/6c5921b2c712974b2aa024c0973a0d03c4aee472", "committedDate": "2020-10-30T15:52:45Z", "message": "Merge branch 'master' into setprocessor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDM2MTAw", "url": "https://github.com/elastic/elasticsearch/pull/63540#pullrequestreview-521036100", "createdAt": "2020-10-30T21:06:18Z", "commit": {"oid": "6c5921b2c712974b2aa024c0973a0d03c4aee472"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMTowNjoxOVrOHrgezw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMToxNTozM1rOHrgsBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4Mjk5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            | `value` | no       | -        | The value to be set for the field. Supports <<accessing-template-fields,template snippets>>.\n          \n          \n            \n            | `value` | yes*     | -        | The value to be set for the field. Supports <<accessing-template-fields,template snippets>>. May specify only one of `value` or `copy_from`.", "url": "https://github.com/elastic/elasticsearch/pull/63540#discussion_r515382991", "createdAt": "2020-10-30T21:06:19Z", "author": {"login": "danhermann"}, "path": "docs/reference/ingest/processors/set.asciidoc", "diffHunk": "@@ -13,7 +13,8 @@ its value will be replaced with the provided one.\n |======\n | Name       | Required  | Default  | Description\n | `field` | yes       | -        | The field to insert, upsert, or update. Supports <<accessing-template-fields,template snippets>>.\n-| `value` | yes       | -        | The value to be set for the field. Supports <<accessing-template-fields,template snippets>>.\n+| `value` | no       | -        | The value to be set for the field. Supports <<accessing-template-fields,template snippets>>.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c5921b2c712974b2aa024c0973a0d03c4aee472"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4NDYxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            As `template snippets` only produces string value, we can copy an array from one field to another by using `copy_from`:\n          \n          \n            \n            The contents of a field including complex values such as arrays and objects can be copied to another field using `copy_from`:", "url": "https://github.com/elastic/elasticsearch/pull/63540#discussion_r515384616", "createdAt": "2020-10-30T21:10:47Z", "author": {"login": "danhermann"}, "path": "docs/reference/ingest/processors/set.asciidoc", "diffHunk": "@@ -87,3 +88,54 @@ Result:\n }\n --------------------------------------------------\n // TESTRESPONSE[s/2019-03-11T21:54:37.909224Z/$body.docs.0.doc._ingest.timestamp/]\n+As `template snippets` only produces string value, we can copy an array from one field to another by using `copy_from`:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c5921b2c712974b2aa024c0973a0d03c4aee472"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4NTgxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw newConfigurationException(TYPE, processorTag, \"copy_from\", \"cannot set `copy_from` while also setting `value`\");\n          \n          \n            \n                                throw newConfigurationException(TYPE, processorTag, \"copy_from\", \"cannot set both `copy_from` and `value` in the same processor\");", "url": "https://github.com/elastic/elasticsearch/pull/63540#discussion_r515385819", "createdAt": "2020-10-30T21:14:00Z", "author": {"login": "danhermann"}, "path": "modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/SetProcessor.java", "diffHunk": "@@ -96,16 +109,29 @@ public Factory(ScriptService scriptService) {\n         public SetProcessor create(Map<String, Processor.Factory> registry, String processorTag,\n                                    String description, Map<String, Object> config) throws Exception {\n             String field = ConfigurationUtils.readStringProperty(TYPE, processorTag, config, \"field\");\n-            Object value = ConfigurationUtils.readObject(TYPE, processorTag, config, \"value\");\n+            String copyFrom = ConfigurationUtils.readOptionalStringProperty(TYPE, processorTag, config, \"copy_from\");\n+            ValueSource valueSource = null;\n+            if (copyFrom == null) {\n+                Object value = ConfigurationUtils.readObject(TYPE, processorTag, config, \"value\");\n+                valueSource = ValueSource.wrap(value, scriptService);\n+            } else {\n+                Object value = config.remove(\"value\");\n+                if (value != null) {\n+                    throw newConfigurationException(TYPE, processorTag, \"copy_from\", \"cannot set `copy_from` while also setting `value`\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c5921b2c712974b2aa024c0973a0d03c4aee472"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM4NjM3NA==", "bodyText": "Can you make a second test method for this test case to make it clear that setting both value and copy_from is an error that should be caught by the factory at creation time?", "url": "https://github.com/elastic/elasticsearch/pull/63540#discussion_r515386374", "createdAt": "2020-10-30T21:15:33Z", "author": {"login": "danhermann"}, "path": "modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/SetProcessorFactoryTests.java", "diffHunk": "@@ -112,4 +112,21 @@ public void testInvalidMustacheTemplate() throws Exception {\n         assertThat(exception.getMetadata(\"es.processor_tag\").get(0), equalTo(processorTag));\n     }\n \n+    public void testCreateWithCopyFrom() throws Exception {\n+        Map<String, Object> config = new HashMap<>();\n+        config.put(\"field\", \"field1\");\n+        config.put(\"copy_from\", \"field2\");\n+        String processorTag = randomAlphaOfLength(10);\n+        SetProcessor setProcessor = factory.create(null, processorTag, null, config);\n+        assertThat(setProcessor.getTag(), equalTo(processorTag));\n+        assertThat(setProcessor.getField().newInstance(Collections.emptyMap()).execute(), equalTo(\"field1\"));\n+        assertThat(setProcessor.getCopyFrom(), equalTo(\"field2\"));\n+\n+        config.put(\"field\", \"field1\");\n+        config.put(\"value\", \"value1\");\n+        config.put(\"copy_from\", \"field2\");\n+        ElasticsearchException exception = expectThrows(ElasticsearchException.class,\n+            () -> factory.create(null, processorTag, null, config));\n+        assertThat(exception.getMessage(), equalTo(\"[copy_from] cannot set `copy_from` while also setting `value`\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c5921b2c712974b2aa024c0973a0d03c4aee472"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81cda1b7bc1eb0d8b92fc1ee153093b3aa1bede4", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/81cda1b7bc1eb0d8b92fc1ee153093b3aa1bede4", "committedDate": "2020-10-31T12:49:51Z", "message": "Update docs/reference/ingest/processors/set.asciidoc\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6ee123347dc4a6beae2b2d932987bb5971a4b2c", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6ee123347dc4a6beae2b2d932987bb5971a4b2c", "committedDate": "2020-10-31T12:50:16Z", "message": "Update docs/reference/ingest/processors/set.asciidoc\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2818c809961b8457b84e1881c788ce02999cdadd", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/2818c809961b8457b84e1881c788ce02999cdadd", "committedDate": "2020-10-31T12:50:33Z", "message": "Update modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/SetProcessor.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31e02872239aba0b9e8655e25ae7c82f8ebaa842", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/31e02872239aba0b9e8655e25ae7c82f8ebaa842", "committedDate": "2020-10-31T12:59:49Z", "message": "Split the test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3926d8b10af03ea871cc0e7dde97371c0169738c", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/3926d8b10af03ea871cc0e7dde97371c0169738c", "committedDate": "2020-10-31T13:01:19Z", "message": "Merge remote-tracking branch 'origin/master' into setprocessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87c5b022e24e0c5948a1bdc3df36e17399978a31", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/87c5b022e24e0c5948a1bdc3df36e17399978a31", "committedDate": "2020-11-02T11:01:17Z", "message": "Merge remote-tracking branch 'origin/master' into setprocessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e9b9fe240df216a26fb3c764403a215131a1232", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/4e9b9fe240df216a26fb3c764403a215131a1232", "committedDate": "2020-11-02T13:44:39Z", "message": "format the code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11c12fff6dd0b8721b76afe2e66525a36b53e7c6", "author": {"user": {"login": "gaobinlong", "name": "bellengao"}}, "url": "https://github.com/elastic/elasticsearch/commit/11c12fff6dd0b8721b76afe2e66525a36b53e7c6", "committedDate": "2020-11-02T13:51:16Z", "message": "Merge remote-tracking branch 'origin/master' into setprocessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46d2f2faf49d738aa63e1911a67a837427692ce7", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/46d2f2faf49d738aa63e1911a67a837427692ce7", "committedDate": "2020-11-02T14:10:49Z", "message": "Merge branch 'master' into setprocessor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4039, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}