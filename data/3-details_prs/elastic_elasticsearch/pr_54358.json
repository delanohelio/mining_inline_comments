{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0ODY4NTc5", "number": 54358, "title": "Add Azure support for ranged read blob operations", "bodyText": "This pull request adds support for ranged read blob operations to the repository azure plugin. It adds the necessary plumbing down to the Azure SDK with additionnal unit tests and also adds a QA test for searchable snapshots.\nRelates #50999", "createdAt": "2020-03-27T17:00:50Z", "url": "https://github.com/elastic/elasticsearch/pull/54358", "merged": true, "mergeCommit": {"oid": "f8792684c9ab671804ab16a0606d87783ec5d7e2"}, "closed": true, "closedAt": "2020-04-01T09:58:38Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRzt0cAH2gAyMzk0ODY4NTc5OjU3NWUzMDZmOGZlYTg2Zjc1YzM4MDAxYTUxMzkwNjQ4OTBkOTI2ZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTTRfwgH2gAyMzk0ODY4NTc5OmUyMTg0ODg3OTI0MjUyOTE3NWEwMDQ5ZjMwN2VlOWZlMmNmM2RkN2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "575e306f8fea86f75c38001a5139064890d926f4", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/575e306f8fea86f75c38001a5139064890d926f4", "committedDate": "2020-03-27T16:58:00Z", "message": "Add Azure support for ranged read blob operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29823c7e14a869e6350c96fc00532b39e0f11c10", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/29823c7e14a869e6350c96fc00532b39e0f11c10", "committedDate": "2020-03-30T08:20:11Z", "message": "Revert something that should not have been commited"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1835d5126a477044e27d51648e240099b3402dd", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/f1835d5126a477044e27d51648e240099b3402dd", "committedDate": "2020-03-30T08:20:20Z", "message": "Speed up tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d25d74f1516b02f856f0ae8b41bbf704b2ab7e9", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/8d25d74f1516b02f856f0ae8b41bbf704b2ab7e9", "committedDate": "2020-03-30T09:11:45Z", "message": "Merge branch 'feature/searchable-snapshots' into add-azure-range-blob-dl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNzQyNjQ4", "url": "https://github.com/elastic/elasticsearch/pull/54358#pullrequestreview-383742648", "createdAt": "2020-03-30T10:58:13Z", "commit": {"oid": "8d25d74f1516b02f856f0ae8b41bbf704b2ab7e9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMDo1ODoxM1rOF9kVpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMTowMjo0OFrOF9kfJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwMjgyMQ==", "bodyText": "Why make this way more aggressive? I don't see the harm in doing so ... seems like we don't need these long timeout here, just wondering? :)", "url": "https://github.com/elastic/elasticsearch/pull/54358#discussion_r400102821", "createdAt": "2020-03-30T10:58:13Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/test/java/org/elasticsearch/repositories/azure/AzureBlobContainerRetriesTests.java", "diffHunk": "@@ -128,7 +135,7 @@ private BlobContainer createBlobContainer(final int maxRetries) {\n         final AzureStorageService service = new AzureStorageService(clientSettings.build()) {\n             @Override\n             RetryPolicyFactory createRetryPolicy(final AzureStorageSettings azureStorageSettings) {\n-                return new RetryExponentialRetry(1, 100, 500, azureStorageSettings.getMaxRetries());\n+                return new RetryExponentialRetry(1, 10, 100, azureStorageSettings.getMaxRetries());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d25d74f1516b02f856f0ae8b41bbf704b2ab7e9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDEwNTI1NQ==", "bodyText": "Maybe try { ... } finally { exchange.close()} around the whole handler so we don't get weird exceptions from the REST mock if an assertion trips?", "url": "https://github.com/elastic/elasticsearch/pull/54358#discussion_r400105255", "createdAt": "2020-03-30T11:02:48Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/test/java/org/elasticsearch/repositories/azure/AzureBlobContainerRetriesTests.java", "diffHunk": "@@ -198,6 +214,57 @@ public void testReadBlobWithRetries() throws Exception {\n         }\n     }\n \n+    public void testReadRangeBlobWithRetries() throws Exception {\n+        final int maxRetries = randomIntBetween(1, 5);\n+        final CountDown countDownHead = new CountDown(maxRetries);\n+        final CountDown countDownGet = new CountDown(maxRetries);\n+        final byte[] bytes = randomBlobContent();\n+        httpServer.createContext(\"/container/read_range_blob_max_retries\", exchange -> {\n+            Streams.readFully(exchange.getRequestBody());\n+            if (\"HEAD\".equals(exchange.getRequestMethod())) {\n+                if (countDownHead.countDown()) {\n+                    exchange.getResponseHeaders().add(\"Content-Type\", \"application/octet-stream\");\n+                    exchange.getResponseHeaders().add(\"x-ms-blob-content-length\", String.valueOf(bytes.length));\n+                    exchange.getResponseHeaders().add(\"x-ms-blob-type\", \"blockblob\");\n+                    exchange.sendResponseHeaders(RestStatus.OK.getStatus(), -1);\n+                    exchange.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d25d74f1516b02f856f0ae8b41bbf704b2ab7e9"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8792f29d6891bb384566a852ac732edcb1de2c42", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/8792f29d6891bb384566a852ac732edcb1de2c42", "committedDate": "2020-03-31T11:46:18Z", "message": "apply feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e21848879242529175a0049f307ee9fe2cf3dd7b", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/e21848879242529175a0049f307ee9fe2cf3dd7b", "committedDate": "2020-04-01T08:17:57Z", "message": "Merge branch 'feature/searchable-snapshots' into add-azure-range-blob-dl"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1450, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}