{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMjMxODE0", "number": 55163, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNDo1OTo1MVrODxr96Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwODoxODowOVrODzmrCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDI3MTc3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceStats.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNDo1OTo1MVrOGFS8bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNDo1OTo1MVrOGFS8bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwNjQ0NQ==", "bodyText": "Why is this lock() statement inside the try block?", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r408206445", "createdAt": "2020-04-14T14:59:51Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceStats.java", "diffHunk": "@@ -226,24 +234,67 @@ public Accumulator merge(InferenceStats otherStats) {\n         }\n \n         public Accumulator incMissingFields() {\n-            this.missingFieldsAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.missingFieldsAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n         public Accumulator incInference() {\n-            this.inferenceAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.inferenceAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n         public Accumulator incFailure() {\n-            this.failureCountAccumulator.increment();\n-            return this;\n+            try {\n+                readWriteLock.readLock().lock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7b30fce203247159dd0ef0db97328b81c064543"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzNDI4NjkxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceStats.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTowMjo1NFrOGFTF-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTowMjo1NFrOGFTF-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwODg4OQ==", "bodyText": "There is only one place where this method is called so I think it could be inlined there.", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r408208889", "createdAt": "2020-04-14T15:02:54Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceStats.java", "diffHunk": "@@ -226,24 +234,67 @@ public Accumulator merge(InferenceStats otherStats) {\n         }\n \n         public Accumulator incMissingFields() {\n-            this.missingFieldsAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.missingFieldsAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n         public Accumulator incInference() {\n-            this.inferenceAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.inferenceAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n         public Accumulator incFailure() {\n-            this.failureCountAccumulator.increment();\n-            return this;\n+            try {\n+                readWriteLock.readLock().lock();\n+                this.failureCountAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n-        public InferenceStats currentStats() {\n+        private InferenceStats currentStats() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7b30fce203247159dd0ef0db97328b81c064543"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjczNDY1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceStats.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjowNjozNVrOGHLVIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMzozOTo1M1rOGHOZ0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE3ODg0OA==", "bodyText": "nit: make public InferenceStats currentStats(Instant timeStamp) private as it is only called here and not protected by the lock otherwise", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410178848", "createdAt": "2020-04-17T12:06:35Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceStats.java", "diffHunk": "@@ -226,22 +234,52 @@ public Accumulator merge(InferenceStats otherStats) {\n         }\n \n         public Accumulator incMissingFields() {\n-            this.missingFieldsAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.missingFieldsAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n         public Accumulator incInference() {\n-            this.inferenceAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.inferenceAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n         public Accumulator incFailure() {\n-            this.failureCountAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.failureCountAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n-        public InferenceStats currentStats() {\n-            return currentStats(Instant.now());\n+        /**\n+         * Thread safe.\n+         *\n+         * Returns the current stats and resets the values of all the counters.\n+         * @return The current stats\n+         */\n+        public InferenceStats currentStatsAndReset() {\n+            readWriteLock.writeLock().lock();\n+            try {\n+                InferenceStats stats = currentStats(Instant.now());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIyOTIwMg==", "bodyText": "Actually, it is thread safe and it is used in the stats service.\ngetting the longValue without resetting is perfectly safe. Its guaranteed to get the latest count on the stats.\nAnd since where it is used, no more updates are occurring, it should be safe.", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410229202", "createdAt": "2020-04-17T13:39:53Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceStats.java", "diffHunk": "@@ -226,22 +234,52 @@ public Accumulator merge(InferenceStats otherStats) {\n         }\n \n         public Accumulator incMissingFields() {\n-            this.missingFieldsAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.missingFieldsAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n         public Accumulator incInference() {\n-            this.inferenceAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.inferenceAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n         public Accumulator incFailure() {\n-            this.failureCountAccumulator.increment();\n-            return this;\n+            readWriteLock.readLock().lock();\n+            try {\n+                this.failureCountAccumulator.increment();\n+                return this;\n+            } finally {\n+                readWriteLock.readLock().unlock();\n+            }\n         }\n \n-        public InferenceStats currentStats() {\n-            return currentStats(Instant.now());\n+        /**\n+         * Thread safe.\n+         *\n+         * Returns the current stats and resets the values of all the counters.\n+         * @return The current stats\n+         */\n+        public InferenceStats currentStatsAndReset() {\n+            readWriteLock.writeLock().lock();\n+            try {\n+                InferenceStats stats = currentStats(Instant.now());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE3ODg0OA=="}, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0Njc1MTY5OnYy", "diffSide": "LEFT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoxMjo0MlrOGHLftA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMzozNToxOFrOGHOONg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4MTU1Ng==", "bodyText": "nit: rename method createBothModels()  -> setLogging() or setup() as no longer creating models here", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410181556", "createdAt": "2020-04-17T12:12:42Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -44,16 +46,19 @@\n \n     private static final String BASIC_AUTH_VALUE_SUPER_USER =\n         basicAuthHeaderValue(\"x_pack_rest_user\", SecuritySettingsSourceField.TEST_PASSWORD_SECURE_STRING);\n+    private List<String> createdModels = new ArrayList<>();\n \n     @Before\n     public void createBothModels() throws Exception {\n-        Request request = new Request(\"PUT\", \"_ml/inference/test_classification\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIyNjIzMA==", "bodyText": "yep yep!", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410226230", "createdAt": "2020-04-17T13:35:18Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -44,16 +46,19 @@\n \n     private static final String BASIC_AUTH_VALUE_SUPER_USER =\n         basicAuthHeaderValue(\"x_pack_rest_user\", SecuritySettingsSourceField.TEST_PASSWORD_SECURE_STRING);\n+    private List<String> createdModels = new ArrayList<>();\n \n     @Before\n     public void createBothModels() throws Exception {\n-        Request request = new Request(\"PUT\", \"_ml/inference/test_classification\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4MTU1Ng=="}, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0Njc1MjgxOnYy", "diffSide": "LEFT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsProcessManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoxMzowNFrOGHLgYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoxMzowNFrOGHLgYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4MTcyOA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410181728", "createdAt": "2020-04-17T12:13:04Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsProcessManager.java", "diffHunk": "@@ -267,10 +266,6 @@ private void writeHeaderRecord(DataFrameDataExtractor dataExtractor, AnalyticsPr\n         process.writeRecord(headerRecord);\n     }\n \n-    private void indexDataCounts(DataCounts dataCounts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0Njc3NTkxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoyMDo0N1rOGHLupA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoyMDo0N1rOGHLupA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4NTM4MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (stats.hasStats() == false) {\n          \n          \n            \n                        if (flush) {\n          \n          \n            \n                            threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(this::updateStats);\n          \n          \n            \n                        }\n          \n          \n            \n                        return;\n          \n          \n            \n                    }\n          \n          \n            \n                    statsQueue.compute(InferenceStats.docId(stats.getModelId(), stats.getNodeId()),\n          \n          \n            \n                        (k, previousStats) -> previousStats == null ?\n          \n          \n            \n                            stats :\n          \n          \n            \n                            InferenceStats.accumulator(stats).merge(previousStats).currentStats(stats.getTimeStamp()));\n          \n          \n            \n                    if (flush) {\n          \n          \n            \n                        threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(this::updateStats);\n          \n          \n            \n                    }\n          \n          \n            \n                    if (stats.hasStats()) {        \n          \n          \n            \n                        statsQueue.compute(InferenceStats.docId(stats.getModelId(), stats.getNodeId()),\n          \n          \n            \n                            (k, previousStats) -> previousStats == null ?\n          \n          \n            \n                                stats :\n          \n          \n            \n                                InferenceStats.accumulator(stats).merge(previousStats).currentStats(stats.getTimeStamp()));\n          \n          \n            \n                    }        \n          \n          \n            \n                    if (flush) {\n          \n          \n            \n                        threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(this::updateStats);\n          \n          \n            \n                    }", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410185380", "createdAt": "2020-04-17T12:20:47Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "diffHunk": "@@ -97,11 +103,26 @@ public void beforeStop() {\n         clusterService.addListener((event) -> this.clusterState = event.state());\n     }\n \n-    public void queueStats(InferenceStats stats) {\n+    /**\n+     * Queues the stats for storing.\n+     * @param stats The stats to store or increment\n+     * @param flush When `true`, this indicates that stats should be written as soon as possible.\n+     *              If `false`, stats are not persisted until the next periodic persistence action.\n+     */\n+    public void queueStats(InferenceStats stats, boolean flush) {\n+        if (stats.hasStats() == false) {\n+            if (flush) {\n+                threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(this::updateStats);\n+            }\n+            return;\n+        }\n         statsQueue.compute(InferenceStats.docId(stats.getModelId(), stats.getNodeId()),\n             (k, previousStats) -> previousStats == null ?\n                 stats :\n                 InferenceStats.accumulator(stats).merge(previousStats).currentStats(stats.getTimeStamp()));\n+        if (flush) {\n+            threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(this::updateStats);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0Njg5ODQ4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjo1OTowMVrOGHM65A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNjo1MDo0NFrOGHVllw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIwNDkwMA==", "bodyText": "2 threads could be calling updateStats at the same time, one invoked here and the other from the the scheduler. Is that safe? Both threads will be iterating and removing entries from the map, maybe use an iterator on the entrySet", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410204900", "createdAt": "2020-04-17T12:59:01Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "diffHunk": "@@ -97,11 +103,26 @@ public void beforeStop() {\n         clusterService.addListener((event) -> this.clusterState = event.state());\n     }\n \n-    public void queueStats(InferenceStats stats) {\n+    /**\n+     * Queues the stats for storing.\n+     * @param stats The stats to store or increment\n+     * @param flush When `true`, this indicates that stats should be written as soon as possible.\n+     *              If `false`, stats are not persisted until the next periodic persistence action.\n+     */\n+    public void queueStats(InferenceStats stats, boolean flush) {\n+        if (stats.hasStats() == false) {\n+            if (flush) {\n+                threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(this::updateStats);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIyNTkyOA==", "bodyText": "It should be safe. I make a copy of the entry set and iterate removals. If the key does not exist, it would return null. So, only one of the two threads would end up having the update.", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410225928", "createdAt": "2020-04-17T13:34:49Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "diffHunk": "@@ -97,11 +103,26 @@ public void beforeStop() {\n         clusterService.addListener((event) -> this.clusterState = event.state());\n     }\n \n-    public void queueStats(InferenceStats stats) {\n+    /**\n+     * Queues the stats for storing.\n+     * @param stats The stats to store or increment\n+     * @param flush When `true`, this indicates that stats should be written as soon as possible.\n+     *              If `false`, stats are not persisted until the next periodic persistence action.\n+     */\n+    public void queueStats(InferenceStats stats, boolean flush) {\n+        if (stats.hasStats() == false) {\n+            if (flush) {\n+                threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(this::updateStats);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIwNDkwMA=="}, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIzMzIwMg==", "bodyText": "More verbose reply.\nThe iteration code is here:\nSet<String> keys = new HashSet<>(statsQueue.keySet());\nfor(String k : keys) {\n    InferenceStats inferenceStats = statsQueue.remove(k);\n    if (inferenceStats != null) {\n        stats.add(inferenceStats);\n    }\n}\n\nThis gets the latest known view of the keySet and makes a copy. This way if keys are added AFTER the remove, it does not double count the stats (I think the keySet view is updated when keys are added...so I opted to not use it directly in iteration).\nconcurrent map remove is thread safe. So if one thread removes an item from the hashmap, the other thread won't see it and get null. So, it won't add it to its request payload.", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410233202", "createdAt": "2020-04-17T13:46:12Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "diffHunk": "@@ -97,11 +103,26 @@ public void beforeStop() {\n         clusterService.addListener((event) -> this.clusterState = event.state());\n     }\n \n-    public void queueStats(InferenceStats stats) {\n+    /**\n+     * Queues the stats for storing.\n+     * @param stats The stats to store or increment\n+     * @param flush When `true`, this indicates that stats should be written as soon as possible.\n+     *              If `false`, stats are not persisted until the next periodic persistence action.\n+     */\n+    public void queueStats(InferenceStats stats, boolean flush) {\n+        if (stats.hasStats() == false) {\n+            if (flush) {\n+                threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(this::updateStats);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIwNDkwMA=="}, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0NjkwMw==", "bodyText": "\ud83d\udc4d it was the double removal I was worried about", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410346903", "createdAt": "2020-04-17T16:50:44Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "diffHunk": "@@ -97,11 +103,26 @@ public void beforeStop() {\n         clusterService.addListener((event) -> this.clusterState = event.state());\n     }\n \n-    public void queueStats(InferenceStats stats) {\n+    /**\n+     * Queues the stats for storing.\n+     * @param stats The stats to store or increment\n+     * @param flush When `true`, this indicates that stats should be written as soon as possible.\n+     *              If `false`, stats are not persisted until the next periodic persistence action.\n+     */\n+    public void queueStats(InferenceStats stats, boolean flush) {\n+        if (stats.hasStats() == false) {\n+            if (flush) {\n+                threadPool.executor(MachineLearning.UTILITY_THREAD_POOL_NAME).execute(this::updateStats);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIwNDkwMA=="}, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NzIyNzMxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModelTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDoyNTo1M1rOGHQNXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDoyNTo1M1rOGHQNXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1ODc4MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    }),anyBoolean());\n          \n          \n            \n                    }), anyBoolean());", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410258780", "createdAt": "2020-04-17T14:25:53Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModelTests.java", "diffHunk": "@@ -273,7 +274,7 @@ public void testInferPersistsStatsAfterNumberOfCalls() throws Exception {\n             public boolean matches(Object o) {\n                 return ((InferenceStats)o).getInferenceCount() == 99L;\n             }\n-        }));\n+        }),anyBoolean());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008e73821a7204684c841870c970d9ba1486b7db"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NzI5NzU2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDo0MzozNVrOGHQ6uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDo0MzozNVrOGHQ6uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MDM5Mw==", "bodyText": "s/pathalogical/pathological/", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410270393", "createdAt": "2020-04-17T14:43:35Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -64,19 +68,33 @@ protected Settings restClientSettings() {\n     @After\n     public void cleanUpData() throws Exception {\n         new MlRestTestStateCleaner(logger, adminClient()).clearMlMetadata();\n+        client().performRequest(new Request(\"DELETE\", InferenceIndexConstants.INDEX_PATTERN));\n+        client().performRequest(new Request(\"DELETE\", MlStatsIndex.indexPattern()));\n+        Request loggingSettings = new Request(\"PUT\", \"_cluster/settings\");\n+        loggingSettings.setJsonEntity(\"\" +\n+            \"{\" +\n+            \"\\\"transient\\\" : {\\n\" +\n+            \"        \\\"logger.org.elasticsearch.xpack.ml.inference\\\" : null\\n\" +\n+            \"    }\" +\n+            \"}\");\n+        client().performRequest(loggingSettings);\n         ESRestTestCase.waitForPendingTasks(adminClient());\n-        client().performRequest(new Request(\"DELETE\", \"_ml/inference/test_classification\"));\n-        client().performRequest(new Request(\"DELETE\", \"_ml/inference/test_regression\"));\n     }\n \n     public void testPathologicalPipelineCreationAndDeletion() throws Exception {\n+        String classificationModelId = \"test_pathalogical_classification\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2aa965f328302b5d5b03a332e5852ec7d085e8de"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NzMxNDYzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDo0ODowNFrOGHRF4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDo0ODowNFrOGHRF4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MzI1MQ==", "bodyText": "I think you could replace it with IndicesOptions.LENIENT_EXPAND_OPEN_HIDDEN", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r410273251", "createdAt": "2020-04-17T14:48:04Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "diffHunk": "@@ -153,12 +175,47 @@ void updateStats() {\n         if (bulkRequest.requests().isEmpty()) {\n             return;\n         }\n+        if (stopped) {\n+            return;\n+        }\n         resultsPersisterService.bulkIndexWithRetry(bulkRequest,\n             stats.stream().map(InferenceStats::getModelId).collect(Collectors.joining(\",\")),\n             () -> stopped == false,\n             (msg) -> {});\n     }\n \n+    private static boolean verifyIndicesPrimaryShardsAreActive(ClusterState clusterState, IndexNameExpressionResolver expressionResolver) {\n+        String[] indices = expressionResolver.concreteIndexNames(clusterState,\n+            new IndicesOptions(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2aa965f328302b5d5b03a332e5852ec7d085e8de"}, "originalPosition": 137}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDM3NTc2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwODoxODowOVrOGIIq1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwODoxODowOVrOGIIq1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE4MzgyOQ==", "bodyText": "Shouldn't this \"catch\" clause call \"Assert.fail()\"?\nIf it doesn't I think the whole block won't be retried when the ResponseException happens...", "url": "https://github.com/elastic/elasticsearch/pull/55163#discussion_r411183829", "createdAt": "2020-04-20T08:18:09Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/InferenceIngestIT.java", "diffHunk": "@@ -94,13 +112,29 @@ public void testPathologicalPipelineCreationAndDeletion() throws Exception {\n                     QueryBuilders.existsQuery(\"ml.inference.classification.predicted_value\"))));\n \n         assertThat(EntityUtils.toString(searchResponse.getEntity()), containsString(\"\\\"value\\\":10\"));\n+        assertBusy(() -> {\n+            try {\n+                Response statsResponse = client().performRequest(new Request(\"GET\",\n+                    \"_ml/inference/\" + classificationModelId + \"/_stats\"));\n+                assertThat(EntityUtils.toString(statsResponse.getEntity()), containsString(\"\\\"inference_count\\\":10\"));\n+                statsResponse = client().performRequest(new Request(\"GET\", \"_ml/inference/\" + regressionModelId + \"/_stats\"));\n+                assertThat(EntityUtils.toString(statsResponse.getEntity()), containsString(\"\\\"inference_count\\\":10\"));\n+            } catch (ResponseException ex) {\n+                //this could just mean shard failures.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "419be4c841164edd065f93e7f844a14241d8f0c8"}, "originalPosition": 85}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1156, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}