{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MzAzMDUx", "number": 62974, "title": "Move FieldMapper#valueFetcher to MappedFieldType", "bodyText": "For runtime fields, we will want to do all search-time interaction with\na field definition via a MappedFieldType, rather than a FieldMapper, to\navoid interfering with the logic of document parsing.  Currently, fetching\nvalues for runtime scripts and for building top hits responses need to\ncall a method on FieldMapper.  This commit moves this method to\nMappedFieldType, incidentally simplifying the current call sites and freeing\nus up to implement runtime fields as pure MappedFieldType objects.", "createdAt": "2020-09-28T17:41:38Z", "url": "https://github.com/elastic/elasticsearch/pull/62974", "merged": true, "mergeCommit": {"oid": "ce649d07d772a17d5b5b3506044a408f6bef72c6"}, "closed": true, "closedAt": "2020-10-04T09:47:04Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNQ1FjgH2gAyNDk0MzAzMDUxOjViNzRkZGU2NDI0YzYzOTJmNzg3MTQ4ZTdiOTMzMGRjMjhmOGQ1MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP8ZxOgFqTUwMzIzMDYzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5b74dde6424c6392f787148e7b9330dc28f8d516", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b74dde6424c6392f787148e7b9330dc28f8d516", "committedDate": "2020-09-28T10:14:43Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b13f4c56c2177ff581933a150a4652e2ad4766d", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b13f4c56c2177ff581933a150a4652e2ad4766d", "committedDate": "2020-09-28T15:15:22Z", "message": "Move valueFetcher() from FieldMapper to MappedFieldType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f750b9cb5fcedc9f43bd4511b771d6369e6cda1", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f750b9cb5fcedc9f43bd4511b771d6369e6cda1", "committedDate": "2020-09-28T15:16:34Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/valuefetcher-ft"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d450600079f018d18f130178bad6bc63546daf99", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/d450600079f018d18f130178bad6bc63546daf99", "committedDate": "2020-09-28T17:35:55Z", "message": "tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d4ec994bddc44f59d835cd695fe20b7a7724580", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/1d4ec994bddc44f59d835cd695fe20b7a7724580", "committedDate": "2020-09-29T07:58:59Z", "message": "test jar hell; unsigned long null values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cfc51ddd1772c18e3100d9988942dd851f2744e", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/4cfc51ddd1772c18e3100d9988942dd851f2744e", "committedDate": "2020-09-29T08:05:01Z", "message": "spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzYxNjcw", "url": "https://github.com/elastic/elasticsearch/pull/62974#pullrequestreview-497761670", "createdAt": "2020-09-28T17:46:53Z", "commit": {"oid": "d450600079f018d18f130178bad6bc63546daf99"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzo0Njo1M1rOHZJPAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzo1MDo0NFrOHZJXRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyNzc0NA==", "bodyText": "These telescoping constructors are getting too complicated now - one idea I have for a follow-up is to add a FieldCharacteristics wrapper object that takes the (indexed, docvales, stored, meta) tuple, analogous to TextSearchInfo, and give both of these 'holder' objects constructors that take Parameter sets directly, so that you can go FieldCharacteristics.build(index, hasDocValues, stored, meta) directly in build and remove some of the ceremony.", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496127744", "createdAt": "2020-09-28T17:46:53Z", "author": {"login": "romseygeek"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/ScaledFloatFieldMapper.java", "diffHunk": "@@ -122,7 +122,7 @@ Builder nullValue(double nullValue) {\n         @Override\n         public ScaledFloatFieldMapper build(BuilderContext context) {\n             ScaledFloatFieldType type = new ScaledFloatFieldType(buildFullName(context), indexed.getValue(), stored.getValue(),\n-                hasDocValues.getValue(), meta.getValue(), scalingFactor.getValue());\n+                hasDocValues.getValue(), meta.getValue(), scalingFactor.getValue(), nullValue.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d450600079f018d18f130178bad6bc63546daf99"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyOTI5NA==", "bodyText": "I think we can wrap this up more nicely as well in a followup, passing a Function<Object, String> parsing object here that is shared with the FieldMapper impl so that we don't need to a) pass nullValue and ignoreAbove and b) duplicate the relevant logic.", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496129294", "createdAt": "2020-09-28T17:49:45Z", "author": {"login": "romseygeek"}, "path": "plugins/analysis-icu/src/main/java/org/elasticsearch/index/mapper/ICUCollationKeywordFieldMapper.java", "diffHunk": "@@ -68,31 +68,52 @@\n             FIELD_TYPE.freeze();\n         }\n \n-        public static final String NULL_VALUE = null;\n         public static final int IGNORE_ABOVE = Integer.MAX_VALUE;\n     }\n \n     public static final class CollationFieldType extends StringFieldType {\n         private final Collator collator;\n+        private final String nullValue;\n+        private final int ignoreAbove;\n \n         public CollationFieldType(String name, boolean isSearchable, boolean isStored, boolean hasDocValues,\n-                                  Collator collator, Map<String, String> meta) {\n+                                  Collator collator, String nullValue, int ignoreAbove, Map<String, String> meta) {\n             super(name, isSearchable, isStored, hasDocValues, TextSearchInfo.SIMPLE_MATCH_ONLY, meta);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d450600079f018d18f130178bad6bc63546daf99"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyOTg2Mw==", "bodyText": "And indeed, we can probably add a factory function to SourceValueFetcher that takes a parsing function as well and further reduce the boilerplate.", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496129863", "createdAt": "2020-09-28T17:50:44Z", "author": {"login": "romseygeek"}, "path": "plugins/analysis-icu/src/main/java/org/elasticsearch/index/mapper/ICUCollationKeywordFieldMapper.java", "diffHunk": "@@ -68,31 +68,52 @@\n             FIELD_TYPE.freeze();\n         }\n \n-        public static final String NULL_VALUE = null;\n         public static final int IGNORE_ABOVE = Integer.MAX_VALUE;\n     }\n \n     public static final class CollationFieldType extends StringFieldType {\n         private final Collator collator;\n+        private final String nullValue;\n+        private final int ignoreAbove;\n \n         public CollationFieldType(String name, boolean isSearchable, boolean isStored, boolean hasDocValues,\n-                                  Collator collator, Map<String, String> meta) {\n+                                  Collator collator, String nullValue, int ignoreAbove, Map<String, String> meta) {\n             super(name, isSearchable, isStored, hasDocValues, TextSearchInfo.SIMPLE_MATCH_ONLY, meta);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyOTI5NA=="}, "originalCommit": {"oid": "d450600079f018d18f130178bad6bc63546daf99"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/3a7494a436e07f31cdcf081c1f5acb4f2c633ccd", "committedDate": "2020-09-29T08:34:43Z", "message": "const keyword tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NTMxMDE2", "url": "https://github.com/elastic/elasticsearch/pull/62974#pullrequestreview-498531016", "createdAt": "2020-09-29T14:27:15Z", "commit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNDoyNzoxNlrOHZwBig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNTowMTo1N1rOHZxwWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc2MzI3NA==", "bodyText": "how have we replaced three methods that throw with two that throw and one that does stuff?", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496763274", "createdAt": "2020-09-29T14:27:16Z", "author": {"login": "javanna"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java", "diffHunk": "@@ -270,6 +270,19 @@ private ShingleFieldType shingleFieldForPositions(int positions) {\n             return shingleFields[Math.min(indexFromShingleSize, shingleFields.length - 1)];\n         }\n \n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            if (format != null) {\n+                throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] doesn't support formats.\");\n+            }\n+            return new SourceValueFetcher(name(), mapperService, false) {\n+                @Override\n+                protected Object parseSourceValue(Object value) {\n+                    return value.toString();\n+                }\n+            };\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc3MDM2NQ==", "bodyText": "this is an existing issue, so I would not address it now and you are probably already on it, but it looks like this same implementation is duplicated in quite some places? Or are there subtle differences?", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496770365", "createdAt": "2020-09-29T14:36:00Z", "author": {"login": "javanna"}, "path": "plugins/mapper-murmur3/src/main/java/org/elasticsearch/index/mapper/murmur3/Murmur3FieldMapper.java", "diffHunk": "@@ -111,6 +111,19 @@ public String typeName() {\n             return new SortedNumericIndexFieldData.Builder(name(), NumericType.LONG);\n         }\n \n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            if (format != null) {\n+                throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] doesn't support formats.\");\n+            }\n+            return new SourceValueFetcher(name(), mapperService, false) {\n+                @Override\n+                protected String parseSourceValue(Object value) {\n+                    return value.toString();\n+                }\n+            };\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc3NDAxNw==", "bodyText": "we don't have a base class for metadata field types, yet they have commonalities, is it worth to add one at some point? Thinking out loud, not sure about it.", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496774017", "createdAt": "2020-09-29T14:40:33Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldNamesFieldMapper.java", "diffHunk": "@@ -129,6 +130,11 @@ public boolean isEnabled() {\n             return enabled;\n         }\n \n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup lookup, String format) {\n+            throw new UnsupportedOperationException(\"Cannot fetch values for internal field [\" + name() + \"].\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc3NTAwOA==", "bodyText": "wasn't this throwing before based on MetadataFieldMapper#valueFetcher ?", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496775008", "createdAt": "2020-09-29T14:41:44Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/IndexFieldMapper.java", "diffHunk": "@@ -71,6 +71,11 @@ public Query existsQuery(QueryShardContext context) {\n         public IndexFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName, Supplier<SearchLookup> searchLookup) {\n             return new ConstantIndexFieldData.Builder(mapperService -> fullyQualifiedIndexName, name(), CoreValuesSourceType.BYTES);\n         }\n+\n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            return lookup -> Collections.singletonList(mapperService.index().getName());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc4MjMyNw==", "bodyText": "could this be fetched before?", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496782327", "createdAt": "2020-09-29T14:50:34Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/SeqNoFieldMapper.java", "diffHunk": "@@ -121,6 +122,11 @@ private long parse(Object value) {\n             return Long.parseLong(value.toString());\n         }\n \n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup lookup, String format) {\n+            return new DocValueFetcher(DocValueFormat.RAW, lookup.doc().getForField(this));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc4NDE5Nw==", "bodyText": "weren't these two throwing exception before?", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496784197", "createdAt": "2020-09-29T14:52:52Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java", "diffHunk": "@@ -415,6 +420,11 @@ public Query existsQuery(QueryShardContext context) {\n             this.hasPositions = hasPositions;\n         }\n \n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            return parentField.valueFetcher(mapperService, searchLookup, format);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc4NDU3MA==", "bodyText": "could this be fetched before?", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496784570", "createdAt": "2020-09-29T14:53:21Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/TypeFieldMapper.java", "diffHunk": "@@ -76,6 +76,11 @@ public Query existsQuery(QueryShardContext context) {\n             return new ConstantIndexFieldData.Builder(typeFunction, name(), CoreValuesSourceType.BYTES);\n         }\n \n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            return lookup -> Collections.singletonList(mapperService.documentMapper().type());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc4NDk3MQ==", "bodyText": "could this be fetched before?", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496784971", "createdAt": "2020-09-29T14:53:49Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/VersionFieldMapper.java", "diffHunk": "@@ -53,6 +55,11 @@ public String typeName() {\n         public Query termQuery(Object value, QueryShardContext context) {\n             throw new QueryShardException(context, \"The _version field is not searchable\");\n         }\n+\n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup lookup, String format) {\n+            return new DocValueFetcher(DocValueFormat.RAW, lookup.doc().getForField(this));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc4NjI0NA==", "bodyText": "so, we skip metadata fields but some of them are now supporting fetch? What am I missing?", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496786244", "createdAt": "2020-09-29T14:55:18Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FieldFetcher.java", "diffHunk": "@@ -55,19 +52,11 @@ public static FieldFetcher create(MapperService mapperService,\n \n             Collection<String> concreteFields = mapperService.simpleMatchToFullName(fieldPattern);\n             for (String field : concreteFields) {\n-                Mapper mapper = fieldMappers.getMapper(field);\n-                if (mapper == null || mapperService.isMetadataField(field)) {\n+                MappedFieldType ft = mapperService.fieldType(field);\n+                if (ft == null || mapperService.isMetadataField(field)) {\n                     continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5MTY0MA==", "bodyText": "I was wondering the same, or even if we should do so. when would this field type be looked up compared to the other one that implements valueFetcher?", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r496791640", "createdAt": "2020-09-29T15:01:57Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/mapper-flattened/src/main/java/org/elasticsearch/xpack/flattened/mapper/FlatObjectFieldMapper.java", "diffHunk": "@@ -319,6 +320,11 @@ public BytesRef indexedValueForSearch(Object value) {\n             failIfNoDocValues();\n             return new KeyedFlatObjectFieldData.Builder(name(), key, CoreValuesSourceType.BYTES);\n         }\n+\n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            throw new UnsupportedOperationException();  // TODO can we implement this?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a7494a436e07f31cdcf081c1f5acb4f2c633ccd"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab26af50462ac7b678c3d37db3c21fd157b54449", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab26af50462ac7b678c3d37db3c21fd157b54449", "committedDate": "2020-09-29T16:18:14Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/valuefetcher-ft"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "477b48bc93e4cbd9c921f29bf52c9113a30a8639", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/477b48bc93e4cbd9c921f29bf52c9113a30a8639", "committedDate": "2020-09-29T16:23:14Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11c4fb17cee43cb62097f314a143a5577f12ff78", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/11c4fb17cee43cb62097f314a143a5577f12ff78", "committedDate": "2020-09-29T19:53:58Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/valuefetcher-ft"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc8b9a315fef4cc37fe7fcc3ba4ebe9af56015b", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/adc8b9a315fef4cc37fe7fcc3ba4ebe9af56015b", "committedDate": "2020-09-30T08:07:51Z", "message": "compilation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NzEzMzky", "url": "https://github.com/elastic/elasticsearch/pull/62974#pullrequestreview-499713392", "createdAt": "2020-09-30T18:42:50Z", "commit": {"oid": "adc8b9a315fef4cc37fe7fcc3ba4ebe9af56015b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d25eeb733a36fab6525f5bd03f5c59136f96118", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/1d25eeb733a36fab6525f5bd03f5c59136f96118", "committedDate": "2020-10-03T15:50:54Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/valuefetcher-ft"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMjgyMzk2", "url": "https://github.com/elastic/elasticsearch/pull/62974#pullrequestreview-502282396", "createdAt": "2020-10-05T17:45:13Z", "commit": {"oid": "1d25eeb733a36fab6525f5bd03f5c59136f96118"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzo0NToxM1rOHcnY6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzo0NjoxNVrOHcnbFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2NzUzMQ==", "bodyText": "After this change, I think value parsing will always fail -- since it uses NumberFieldType, it will attempt to parse a piece of text as a number.", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r499767531", "createdAt": "2020-10-05T17:45:13Z", "author": {"login": "jtibshirani"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/TokenCountFieldMapper.java", "diffHunk": "@@ -129,20 +130,6 @@ protected void parseCreateField(ParseContext context) throws IOException {\n         );\n     }\n \n-    @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d25eeb733a36fab6525f5bd03f5c59136f96118"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2ODA4Nw==", "bodyText": "Very happy we removed this \ud83c\udf89", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r499768087", "createdAt": "2020-10-05T17:46:15Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FieldFetcher.java", "diffHunk": "@@ -55,19 +52,11 @@ public static FieldFetcher create(MapperService mapperService,\n \n             Collection<String> concreteFields = mapperService.simpleMatchToFullName(fieldPattern);\n             for (String field : concreteFields) {\n-                Mapper mapper = fieldMappers.getMapper(field);\n-                if (mapper == null || mapperService.isMetadataField(field)) {\n+                MappedFieldType ft = mapperService.fieldType(field);\n+                if (ft == null || mapperService.isMetadataField(field)) {\n                     continue;\n                 }\n-\n-                if (mapper instanceof FieldAliasMapper) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d25eeb733a36fab6525f5bd03f5c59136f96118"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjMwNjM2", "url": "https://github.com/elastic/elasticsearch/pull/62974#pullrequestreview-503230636", "createdAt": "2020-10-06T18:08:33Z", "commit": {"oid": "1d25eeb733a36fab6525f5bd03f5c59136f96118"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODowODozM1rOHdT7NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODowODozM1rOHdT7NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5NzIwNA==", "bodyText": "One other change I noticed -- previously we always passed the result of FieldMapper#parsesArrayValue instead of hard-coding the booleans. Now there is nothing really tying this to parsesArrayValue and it could be easily overlooked. I wonder how we could make this more robust.\nAn update: I opened #63354 with a small improvement.", "url": "https://github.com/elastic/elasticsearch/pull/62974#discussion_r500497204", "createdAt": "2020-10-06T18:08:33Z", "author": {"login": "jtibshirani"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeatureFieldMapper.java", "diffHunk": "@@ -113,6 +113,19 @@ public Query existsQuery(QueryShardContext context) {\n             throw new IllegalArgumentException(\"[rank_feature] fields do not support sorting, scripting or aggregating\");\n         }\n \n+        @Override\n+        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+            if (format != null) {\n+                throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] doesn't support formats.\");\n+            }\n+            return new SourceValueFetcher(name(), mapperService, false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d25eeb733a36fab6525f5bd03f5c59136f96118"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4496, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}