{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNTU0MzI1", "number": 56208, "title": "Add list of defered aggregations to the profiler", "bodyText": "This adds a few things to the breakdown of the profiler:\n\nhistogram aggregations now contain total_buckets which is the\ncount of buckets that they collected. This could be useful when\ndebugging a histogram inside of another bucketing agg that is fairly\nselective.\nAll bucketing aggs that can delay their sub-aggregations will now add\na list of delayed sub-aggregations. This is useful because we\nsometimes have fairly involved logic around which sub-aggregations get\ndelayed and this will save you from having to guess.\nAggregtations wrapped in the MultiBucketAggregatorWrapper can't\naccurately add anything to the breakdown. Instead they the wrapper\nadds a marker entry \"multi_bucket_aggregator_wrapper\": true so we\ncan be quickly pick out such aggregations when debugging.\n\nIt also fixes a bug where _count breakdown entries were contributing\nto the overall time_in_nanos. They didn't add a large amount of time\nso it is unlikely that this caused a big problem, but I was there.\nTo support the arbitrary breakdown data this reworks the profiler so\nthat the breakdown can contain any data that is supported by\nStreamOutput#writeGenericValue(Object) and\nXContentBuilder#value(Object).", "createdAt": "2020-05-05T14:32:38Z", "url": "https://github.com/elastic/elasticsearch/pull/56208", "merged": true, "mergeCommit": {"oid": "4a8d93f55b3907253d28c3b66eb04c1a4021755e"}, "closed": true, "closedAt": "2020-05-13T12:30:39Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceU21GAH2gAyNDEzNTU0MzI1OjgyMGYzYTNmMGE3ZDcwZTRiNmM2YWE1NzU4ZDg4ZGVkMjA1Y2JlMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgWtkygFqTQwOTU1MDcyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "820f3a3f0a7d70e4b6c6aa5758d88ded205cbe11", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/820f3a3f0a7d70e4b6c6aa5758d88ded205cbe11", "committedDate": "2020-05-05T14:21:48Z", "message": "Add list of defered aggregations to the profiler\n\nThis adds a few things to the `breakdown` of the profiler:\n* `histogram` aggregations now contain `total_buckets` which is the\n  count of buckets that they collected. This could be useful when\n  debugging a histogram inside of another bucketing agg that is fairly\n  selective.\n* All bucketing aggs that can delay their sub-aggregations will now add\n  a list of delayed sub-aggregations. This is useful because we\n  sometimes have fairly involved logic around which sub-aggregations get\n  delayed and this will save you from having to guess.\n* Aggregtations wrapped in the `MultiBucketAggregatorWrapper` can't\n  accurately add anything to the breakdown. Instead they the wrapper\n  adds a marker entry `\"multi_bucket_aggregator_wrapper\": true` so we\n  can be quickly pick out such aggregations when debugging.\n\nIt also fixes a bug where `_count` breakdown entries were contributing\nto the overall `time_in_nanos`. They didn't add a large amount of time\nso it is unlikely that this caused a big problem, but I was there.\n\nTo support the arbitrary breakdown data this reworks the profiler so\nthat the `breakdown` can contain any data that is supported by\n`StreamOutput#writeGenericValue(Object)` and\n`XContentBuilder#value(Object)`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4df4b8c851cc08593f79ca2b7d54cb36d8e12c21", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4df4b8c851cc08593f79ca2b7d54cb36d8e12c21", "committedDate": "2020-05-05T15:01:56Z", "message": "Fix name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MTY1NTMz", "url": "https://github.com/elastic/elasticsearch/pull/56208#pullrequestreview-406165533", "createdAt": "2020-05-05T21:23:05Z", "commit": {"oid": "4df4b8c851cc08593f79ca2b7d54cb36d8e12c21"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa0e2696beaf2ba730691d94bb09f0f584308659", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa0e2696beaf2ba730691d94bb09f0f584308659", "committedDate": "2020-05-05T22:08:08Z", "message": "Merge branch 'master' into agg_debug_data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c584607c3d412db8fe427f457c3a2b1dbe78978", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c584607c3d412db8fe427f457c3a2b1dbe78978", "committedDate": "2020-05-05T23:44:27Z", "message": "Merge branch 'master' into agg_debug_data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1de6d13b9cddd1ca4f04d4ab8aebdeb8b943e29", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a1de6d13b9cddd1ca4f04d4ab8aebdeb8b943e29", "committedDate": "2020-05-06T00:03:56Z", "message": "Update docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NTgyNzYw", "url": "https://github.com/elastic/elasticsearch/pull/56208#pullrequestreview-406582760", "createdAt": "2020-05-06T12:55:28Z", "commit": {"oid": "a1de6d13b9cddd1ca4f04d4ab8aebdeb8b943e29"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMjo1NToyOFrOGRRlyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMjo1NToyOFrOGRRlyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2NzE3OA==", "bodyText": "This is the change the breaks BWC. I'm not 100% sure it is ok. I'm hunting.\nThe effects will be that versions of the high level rest client that don't have this won't be able to read breakdowns that include non-numbers. They'll blow up at:\nensureExpectedToken(XContentParser.Token.VALUE_NUMBER, parser.nextToken(), parser::getTokenLocation);", "url": "https://github.com/elastic/elasticsearch/pull/56208#discussion_r420767178", "createdAt": "2020-05-06T12:55:28Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/profile/ProfileResult.java", "diffHunk": "@@ -49,26 +51,25 @@\n  * \"children\" queries if applicable\n  */\n public final class ProfileResult implements Writeable, ToXContentObject {\n-\n     static final ParseField TYPE = new ParseField(\"type\");\n     static final ParseField DESCRIPTION = new ParseField(\"description\");\n+    static final ParseField BREAKDOWN = new ParseField(\"breakdown\");\n     static final ParseField NODE_TIME = new ParseField(\"time\");\n     static final ParseField NODE_TIME_RAW = new ParseField(\"time_in_nanos\");\n     static final ParseField CHILDREN = new ParseField(\"children\");\n-    static final ParseField BREAKDOWN = new ParseField(\"breakdown\");\n \n     private final String type;\n     private final String description;\n-    private final Map<String, Long> timings;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1de6d13b9cddd1ca4f04d4ab8aebdeb8b943e29"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cc9a7194468da33338b2193f5bc853033d207df", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/5cc9a7194468da33338b2193f5bc853033d207df", "committedDate": "2020-05-06T16:19:11Z", "message": "Don't break bwc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98df9cfcdec1ed29ee02afd81ad8ad0718082af9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/98df9cfcdec1ed29ee02afd81ad8ad0718082af9", "committedDate": "2020-05-06T17:39:11Z", "message": "Finish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcefe4de7a956218d88485d9e84047d1817b551b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/fcefe4de7a956218d88485d9e84047d1817b551b", "committedDate": "2020-05-06T17:55:08Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62171d32aace12d597f015a921fab796449e839e", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/62171d32aace12d597f015a921fab796449e839e", "committedDate": "2020-05-06T21:16:21Z", "message": "Merge branch 'master' into agg_debug_data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "572ed0e0c55e0923f7c9db666d8e9162631d6c33", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/572ed0e0c55e0923f7c9db666d8e9162631d6c33", "committedDate": "2020-05-06T21:40:00Z", "message": "Merge branch 'master' into agg_debug_data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "266f2de4ab719c7592cdbd7be98fb4333f7cfe62", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/266f2de4ab719c7592cdbd7be98fb4333f7cfe62", "committedDate": "2020-05-06T22:04:02Z", "message": "Test cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5Mjc4NjIw", "url": "https://github.com/elastic/elasticsearch/pull/56208#pullrequestreview-409278620", "createdAt": "2020-05-11T15:24:17Z", "commit": {"oid": "266f2de4ab719c7592cdbd7be98fb4333f7cfe62"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNToyNDoxN1rOGThRHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNToyNDoxN1rOGThRHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEyMTE4Mg==", "bodyText": "Is there not a way to fetch the names out of collectors later when we need them?", "url": "https://github.com/elastic/elasticsearch/pull/56208#discussion_r423121182", "createdAt": "2020-05-11T15:24:17Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/DeferableBucketAggregator.java", "diffHunk": "@@ -30,10 +30,12 @@\n import java.util.ArrayList;\n import java.util.List;\n import java.util.Map;\n+import java.util.function.BiConsumer;\n \n public abstract class DeferableBucketAggregator extends BucketsAggregator {\n \n     private DeferringBucketCollector recordingWrapper;\n+    private List<String> deferredAggregationNames;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "266f2de4ab719c7592cdbd7be98fb4333f7cfe62"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5784c7d74e9b045e08aab01fc922ef772e6d3349", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/5784c7d74e9b045e08aab01fc922ef772e6d3349", "committedDate": "2020-05-11T19:02:49Z", "message": "Merge branch 'master' into agg_debug_data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffc435c4fd44bf0b3c7873fcb39801ac111e06f4", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/ffc435c4fd44bf0b3c7873fcb39801ac111e06f4", "committedDate": "2020-05-11T19:51:11Z", "message": "Merge branch 'master' into agg_debug_data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6748e08934bd6186dd86e8d49c0b63fa5249634", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/c6748e08934bd6186dd86e8d49c0b63fa5249634", "committedDate": "2020-05-11T20:15:01Z", "message": "Fix after merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b74e5c8d35a6d34ca64fa0c1f8c279fb23c9fb0", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b74e5c8d35a6d34ca64fa0c1f8c279fb23c9fb0", "committedDate": "2020-05-11T20:27:24Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTUwNzIy", "url": "https://github.com/elastic/elasticsearch/pull/56208#pullrequestreview-409550722", "createdAt": "2020-05-11T21:39:21Z", "commit": {"oid": "4b74e5c8d35a6d34ca64fa0c1f8c279fb23c9fb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 111, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}