{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NDI1MjA1", "number": 55797, "title": "[ML] Do not fail DFA task when it's stopped whilst reindexing", "bodyText": "Adding to #55659, we missed another way we could set the task to\nfailed due to task cancellation. CI revealed that we might also\nget a SearchPhaseExecutionException whose cause is a\nTaskCancelledException. That exception is not wrapped so\nunwrapping it will not return the underlying TaskCancelledException.\nThus to be complete in catching this, we also need to check the\nerror's cause.\nCloses #55068", "createdAt": "2020-04-27T11:04:02Z", "url": "https://github.com/elastic/elasticsearch/pull/55797", "merged": true, "mergeCommit": {"oid": "ffe574c3a6f59134f0cc05d73a7555e95421101e"}, "closed": true, "closedAt": "2020-04-27T12:17:21Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbtKBrgH2gAyNDA5NDI1MjA1OmEzZmU5OWJhZjk3NWZiYjJhNzFkYjFjNDJmYWVlZTRlNjAzZjRmZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbtdLRAH2gAyNDA5NDI1MjA1OjcwNWFkZWI4YWE5YWRmNTdjNDNlZmFkMGNjM2U1M2JjNjZjNjUyN2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a3fe99baf975fbb2a71db1c42faeee4e603f4ff4", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/a3fe99baf975fbb2a71db1c42faeee4e603f4ff4", "committedDate": "2020-04-27T10:58:43Z", "message": "[ML] Do not fail DFA task when it's stopped whilst reindexing\n\nAdding to #55659, we missed another way we could set the task to\nfailed due to task cancellation. CI revealed that we might also\nget a `SearchPhaseExecutionException` whose cause is a\n`TaskCancelledException`. That exception is not wrapped so\nunwrapping it will not return the underlying `TaskCancelledException`.\nThus to be complete in catching this, we also need to check the\nerror's cause.\n\nCloses #55068"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwODQ5MDUy", "url": "https://github.com/elastic/elasticsearch/pull/55797#pullrequestreview-400849052", "createdAt": "2020-04-27T11:07:46Z", "commit": {"oid": "a3fe99baf975fbb2a71db1c42faeee4e603f4ff4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMTowNzo0N1rOGMdi5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMTowNzo0N1rOGMdi5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcyMDE2Ng==", "bodyText": "static", "url": "https://github.com/elastic/elasticsearch/pull/55797#discussion_r415720166", "createdAt": "2020-04-27T11:07:47Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java", "diffHunk": "@@ -294,6 +294,10 @@ private void reindexDataframeAndStartAnalysis(DataFrameAnalyticsTask task, DataF\n                 new GetIndexRequest().indices(config.getDest().getIndex()), destIndexListener);\n     }\n \n+    private boolean isTaskCancelledException(Exception error) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3fe99baf975fbb2a71db1c42faeee4e603f4ff4"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwODUzNDQw", "url": "https://github.com/elastic/elasticsearch/pull/55797#pullrequestreview-400853440", "createdAt": "2020-04-27T11:14:50Z", "commit": {"oid": "a3fe99baf975fbb2a71db1c42faeee4e603f4ff4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMToxNDo1MFrOGMdzGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxMToxNDo1MFrOGMdzGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTcyNDMxMg==", "bodyText": "I wonder if it's also worth unwrapping the cause?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return ExceptionsHelper.unwrapCause(error) instanceof TaskCancelledException || error.getCause() instanceof TaskCancelledException;\n          \n          \n            \n                    return ExceptionsHelper.unwrapCause(error) instanceof TaskCancelledException || ExceptionsHelper.unwrapCause(error.getCause()) instanceof TaskCancelledException;\n          \n      \n    \n    \n  \n\nWhether this is worth it or not depending on whether the nested exception could be a remote transport exception, or whether only the outermost exception can be.  If you don't know the answer it's probably better to add the extra unwrap call.", "url": "https://github.com/elastic/elasticsearch/pull/55797#discussion_r415724312", "createdAt": "2020-04-27T11:14:50Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java", "diffHunk": "@@ -294,6 +294,10 @@ private void reindexDataframeAndStartAnalysis(DataFrameAnalyticsTask task, DataF\n                 new GetIndexRequest().indices(config.getDest().getIndex()), destIndexListener);\n     }\n \n+    private boolean isTaskCancelledException(Exception error) {\n+        return ExceptionsHelper.unwrapCause(error) instanceof TaskCancelledException || error.getCause() instanceof TaskCancelledException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3fe99baf975fbb2a71db1c42faeee4e603f4ff4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aecabcf992e78e378699da3109b88a2018892974", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/aecabcf992e78e378699da3109b88a2018892974", "committedDate": "2020-04-27T11:18:36Z", "message": "Make method static"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "705adeb8aa9adf57c43efad0cc3e53bc66c6527e", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/705adeb8aa9adf57c43efad0cc3e53bc66c6527e", "committedDate": "2020-04-27T11:19:38Z", "message": "Also unwrap cause"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 431, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}