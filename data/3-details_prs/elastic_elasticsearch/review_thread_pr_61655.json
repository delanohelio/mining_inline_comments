{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0OTIyOTU1", "number": 61655, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo1Mjo1NFrOEfG4RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzozNDozOFrOEfHbbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDU0MDIwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo1Mjo1NFrOHLK8Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNToyNTo0OFrOHURyYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NTYwMg==", "bodyText": "Why can't this be simplified to just abstraction.isSystem()?", "url": "https://github.com/elastic/elasticsearch/pull/61655#discussion_r481475602", "createdAt": "2020-09-01T22:52:54Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -336,6 +345,18 @@ static void prohibitCustomRoutingOnDataStream(DocWriteRequest<?> writeRequest, M\n         }\n     }\n \n+    boolean isOnlySystem(BulkRequest request, SortedMap<String, IndexAbstraction> indicesLookup, SystemIndices systemIndices) {\n+        final boolean onlySystem = request.getIndices().stream().allMatch(indexName -> {\n+            final IndexAbstraction abstraction = indicesLookup.get(indexName);\n+            if (abstraction != null) {\n+                return abstraction.isSystem();\n+            } else {\n+                return systemIndices.isSystemIndex(indexName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7460e0b570e407cbcf447b2552fa5569b35c4c8"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAyNDk5Mw==", "bodyText": "At the point when we need to call this, we cannot guarantee that all system indices have been created :(", "url": "https://github.com/elastic/elasticsearch/pull/61655#discussion_r491024993", "createdAt": "2020-09-18T15:25:48Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -336,6 +345,18 @@ static void prohibitCustomRoutingOnDataStream(DocWriteRequest<?> writeRequest, M\n         }\n     }\n \n+    boolean isOnlySystem(BulkRequest request, SortedMap<String, IndexAbstraction> indicesLookup, SystemIndices systemIndices) {\n+        final boolean onlySystem = request.getIndices().stream().allMatch(indexName -> {\n+            final IndexAbstraction abstraction = indicesLookup.get(indexName);\n+            if (abstraction != null) {\n+                return abstraction.isSystem();\n+            } else {\n+                return systemIndices.isSystemIndex(indexName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NTYwMg=="}, "originalCommit": {"oid": "b7460e0b570e407cbcf447b2552fa5569b35c4c8"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDU1NzAzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzowMDozMFrOHLLF7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzowMDozMFrOHLLF7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3ODEyNg==", "bodyText": "Nitpick: the name executor isn't really right now that it's actually a function to get an executor.", "url": "https://github.com/elastic/elasticsearch/pull/61655#discussion_r481478126", "createdAt": "2020-09-01T23:00:30Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java", "diffHunk": "@@ -61,21 +62,25 @@\n         > extends TransportReplicationAction<Request, ReplicaRequest, Response> {\n \n     private final IndexingPressure indexingPressure;\n-    private final String executor;\n+    private final Function<IndexShard, String> executor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7460e0b570e407cbcf447b2552fa5569b35c4c8"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDYzMDIwOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionIngestTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzozNDozOFrOHLLwuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMzozNDozOFrOHLLwuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ4OTA4Mw==", "bodyText": "There are a number of instances where we now verify that we're using the WRITE threadpool here. Could we add a test here to check the logic that determines when to use SYSTEM_WRITE?", "url": "https://github.com/elastic/elasticsearch/pull/61655#discussion_r481489083", "createdAt": "2020-09-01T23:34:38Z", "author": {"login": "gwbrown"}, "path": "server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionIngestTests.java", "diffHunk": "@@ -274,7 +276,7 @@ public void testIngestLocal() throws Exception {\n         assertFalse(responseCalled.get());\n         assertFalse(failureCalled.get());\n         verify(ingestService).executeBulkRequest(eq(bulkRequest.numberOfActions()), bulkDocsItr.capture(),\n-            failureHandler.capture(), completionHandler.capture(), any());\n+            failureHandler.capture(), completionHandler.capture(), any(), eq(Names.WRITE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7460e0b570e407cbcf447b2552fa5569b35c4c8"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 757, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}