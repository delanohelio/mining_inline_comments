{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwODYyODk2", "number": 51866, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjowMzo1MVrODiTYKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoxMzoyOFrODiUjXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3Mjk1NjU4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshots.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjowMzo1MVrOFteU8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjowMzo1MVrOFteU8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIyNzEyMA==", "bodyText": "Using System::nanoTime since we need finer resolution than ThreadPool::relativeTimeInNanos offers.", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383227120", "createdAt": "2020-02-24T12:03:51Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshots.java", "diffHunk": "@@ -106,7 +106,7 @@ public void onRepositoriesModule(RepositoriesModule repositoriesModule) {\n     @Override\n     public Map<String, DirectoryFactory> getDirectoryFactories() {\n         return Map.of(SearchableSnapshotRepository.SNAPSHOT_DIRECTORY_FACTORY_KEY,\n-            SearchableSnapshotRepository.newDirectoryFactory(repositoriesService::get, cacheService::get));\n+            SearchableSnapshotRepository.newDirectoryFactory(repositoriesService::get, cacheService::get, System::nanoTime));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e634b7890fb5276e2c30d816793359104ffa9295"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzEyMDA4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzowNDo0M1rOFtf3ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzo1OToyN1rOFthg9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MjQxOQ==", "bodyText": "builder.timeField(String, String, long) does not produce what we want here?", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383252419", "createdAt": "2020-02-24T13:04:43Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -395,4 +396,55 @@ public int hashCode() {\n             return Objects.hash(count, total, min, max);\n         }\n     }\n+\n+    public static class TimedCounter extends Counter {\n+\n+        private final long totalNanoseconds;\n+\n+        public TimedCounter(long count, long total, long min, long max, long totalNanoseconds) {\n+            super(count, total, min, max);\n+            this.totalNanoseconds = totalNanoseconds;\n+        }\n+\n+        TimedCounter(StreamInput in) throws IOException {\n+            super(in);\n+            totalNanoseconds = in.readZLong();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            super.writeTo(out);\n+            out.writeZLong(totalNanoseconds);\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+            builder.startObject();\n+            {\n+                builder.field(\"count\", getCount());\n+                builder.field(\"sum\", getTotal());\n+                builder.field(\"min\", getMin());\n+                builder.field(\"max\", getMax());\n+                builder.field(\"time\", TimeValue.timeValueNanos(totalNanoseconds));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3MjYxNA==", "bodyText": "No, I don't think so, this formats an absolute time in milliseconds-since-the-unix-epoch as a date, whereas here we have a relative time in nanoseconds.\nIt did, however, highlight that I should respect the ?human parameter -- see 5b26f66.", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383272614", "createdAt": "2020-02-24T13:46:21Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -395,4 +396,55 @@ public int hashCode() {\n             return Objects.hash(count, total, min, max);\n         }\n     }\n+\n+    public static class TimedCounter extends Counter {\n+\n+        private final long totalNanoseconds;\n+\n+        public TimedCounter(long count, long total, long min, long max, long totalNanoseconds) {\n+            super(count, total, min, max);\n+            this.totalNanoseconds = totalNanoseconds;\n+        }\n+\n+        TimedCounter(StreamInput in) throws IOException {\n+            super(in);\n+            totalNanoseconds = in.readZLong();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            super.writeTo(out);\n+            out.writeZLong(totalNanoseconds);\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+            builder.startObject();\n+            {\n+                builder.field(\"count\", getCount());\n+                builder.field(\"sum\", getTotal());\n+                builder.field(\"min\", getMin());\n+                builder.field(\"max\", getMax());\n+                builder.field(\"time\", TimeValue.timeValueNanos(totalNanoseconds));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MjQxOQ=="}, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3OTM0OQ==", "bodyText": "Right, I just checked the code. Thanks for supporting the human readable parameter.", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383279349", "createdAt": "2020-02-24T13:59:27Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -395,4 +396,55 @@ public int hashCode() {\n             return Objects.hash(count, total, min, max);\n         }\n     }\n+\n+    public static class TimedCounter extends Counter {\n+\n+        private final long totalNanoseconds;\n+\n+        public TimedCounter(long count, long total, long min, long max, long totalNanoseconds) {\n+            super(count, total, min, max);\n+            this.totalNanoseconds = totalNanoseconds;\n+        }\n+\n+        TimedCounter(StreamInput in) throws IOException {\n+            super(in);\n+            totalNanoseconds = in.readZLong();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            super.writeTo(out);\n+            out.writeZLong(totalNanoseconds);\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+            builder.startObject();\n+            {\n+                builder.field(\"count\", getCount());\n+                builder.field(\"sum\", getTotal());\n+                builder.field(\"min\", getMin());\n+                builder.field(\"max\", getMax());\n+                builder.field(\"time\", TimeValue.timeValueNanos(totalNanoseconds));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MjQxOQ=="}, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzEyMzg3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/qa/rest/src/test/resources/rest-api-spec/test/stats.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzowNjowMVrOFtf59w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzo0NzozNFrOFthJGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1Mjk4Mw==", "bodyText": "I'm wondering if we should check that it's greater than 0?", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383252983", "createdAt": "2020-02-24T13:06:01Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/qa/rest/src/test/resources/rest-api-spec/test/stats.yml", "diffHunk": "@@ -167,11 +167,15 @@ teardown:\n   - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.sum: 0 }\n   - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.min: 0 }\n   - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.max: 0 }\n+  - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.time_in_nanos: 0 }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3MzI0Mg==", "bodyText": "No, we can't assert that since System::nanoTime might not be accurate enough to advance while we're watching it -- see e.g. #27371.", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383273242", "createdAt": "2020-02-24T13:47:34Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/qa/rest/src/test/resources/rest-api-spec/test/stats.yml", "diffHunk": "@@ -167,11 +167,15 @@ teardown:\n   - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.sum: 0 }\n   - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.min: 0 }\n   - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.max: 0 }\n+  - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.time_in_nanos: 0 }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1Mjk4Mw=="}, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzEzNjkwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheDirectory.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoxMDozNFrOFtgB1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzo1NjoyMVrOFthamg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1NDk5Ng==", "bodyText": "Interestingly, this captures the start time after the initial blob read request has been made. I'm wondering if we should capture it before the openInput() which sends the underlying S3 request and update the stats in a finally block?", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383254996", "createdAt": "2020-02-24T13:10:34Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheDirectory.java", "diffHunk": "@@ -274,6 +278,7 @@ void writeCacheFile(FileChannel fc, long start, long end) throws IOException {\n             int bytesCopied = 0;\n             try (IndexInput input = in.openInput(cacheFileReference.getFileName(), ioContext)) {\n                 stats.incrementInnerOpenCount();\n+                final long startTimeNanos = currentTimeNanosSupplier.getAsLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3NTg1Mw==", "bodyText": "I'm perhaps missing something here, because I think that we don't interact with the blob store until the first readBytes call. We certainly shouldn't start reading before we've called seek since seeks mean we must discard some work. Are you sure we do anything worth timing in openInput()?", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383275853", "createdAt": "2020-02-24T13:52:37Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheDirectory.java", "diffHunk": "@@ -274,6 +278,7 @@ void writeCacheFile(FileChannel fc, long start, long end) throws IOException {\n             int bytesCopied = 0;\n             try (IndexInput input = in.openInput(cacheFileReference.getFileName(), ioContext)) {\n                 stats.incrementInnerOpenCount();\n+                final long startTimeNanos = currentTimeNanosSupplier.getAsLong();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1NDk5Ng=="}, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3NzcyMg==", "bodyText": "Oh no you're perfectly right, I confused the openInput() method with the readBlob() \ud83e\udd26\u200d\u2642\ufe0f  Sorry for the noise.", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383277722", "createdAt": "2020-02-24T13:56:21Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheDirectory.java", "diffHunk": "@@ -274,6 +278,7 @@ void writeCacheFile(FileChannel fc, long start, long end) throws IOException {\n             int bytesCopied = 0;\n             try (IndexInput input = in.openInput(cacheFileReference.getFileName(), ioContext)) {\n                 stats.incrementInnerOpenCount();\n+                final long startTimeNanos = currentTimeNanosSupplier.getAsLong();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1NDk5Ng=="}, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzE0OTA4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoxMzoyOFrOFtgIig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzo1Mjo1MFrOFthTug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1NjcxNA==", "bodyText": "Maybe define an empty innerToXContent(XContentBuilder, Params) to the Counter class and overrides it here to only add the time field? That's what we do for other XContent implementations.", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383256714", "createdAt": "2020-02-24T13:13:28Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -395,4 +396,55 @@ public int hashCode() {\n             return Objects.hash(count, total, min, max);\n         }\n     }\n+\n+    public static class TimedCounter extends Counter {\n+\n+        private final long totalNanoseconds;\n+\n+        public TimedCounter(long count, long total, long min, long max, long totalNanoseconds) {\n+            super(count, total, min, max);\n+            this.totalNanoseconds = totalNanoseconds;\n+        }\n+\n+        TimedCounter(StreamInput in) throws IOException {\n+            super(in);\n+            totalNanoseconds = in.readZLong();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            super.writeTo(out);\n+            out.writeZLong(totalNanoseconds);\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3NTk2Mg==", "bodyText": "Nice, thanks for the tip. Done in 5b26f66.", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383275962", "createdAt": "2020-02-24T13:52:50Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -395,4 +396,55 @@ public int hashCode() {\n             return Objects.hash(count, total, min, max);\n         }\n     }\n+\n+    public static class TimedCounter extends Counter {\n+\n+        private final long totalNanoseconds;\n+\n+        public TimedCounter(long count, long total, long min, long max, long totalNanoseconds) {\n+            super(count, total, min, max);\n+            this.totalNanoseconds = totalNanoseconds;\n+        }\n+\n+        TimedCounter(StreamInput in) throws IOException {\n+            super(in);\n+            totalNanoseconds = in.readZLong();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            super.writeTo(out);\n+            out.writeZLong(totalNanoseconds);\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1NjcxNA=="}, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 79}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 75, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}