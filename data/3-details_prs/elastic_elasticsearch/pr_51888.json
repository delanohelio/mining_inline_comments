{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMDQyMDc4", "number": 51888, "title": "[ML] allow close/stop for jobs/datafeeds with missing configs", "bodyText": "If the configs are removed (by some horrific means), we should still allow tasks to be cleaned up easily.\nThis PR allows _close?force=true and _stop?force=true to work when the configuration is not able to be found.\nAdditionally, on Jobstats, I opted to return the tasks stats even if the config is missing.", "createdAt": "2020-02-04T20:45:28Z", "url": "https://github.com/elastic/elasticsearch/pull/51888", "merged": true, "mergeCommit": {"oid": "20d4bc8a5f424fd5d253c57b906c0cea1b6aaff0"}, "closed": true, "closedAt": "2020-02-06T12:48:11Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBGW8jAH2gAyMzcxMDQyMDc4OjRiODI1YTY4NDViZmYyMGJjYjZjODRlMTY1MzFiYjk4ZDUxNmE3MjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBonmoAFqTM1NDM2MzgwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4b825a6845bff20bcb6c84e16531bb98d516a723", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b825a6845bff20bcb6c84e16531bb98d516a723", "committedDate": "2020-02-04T19:04:30Z", "message": "[ML] allow close/stop for jobs/datafeeds with missing configs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f6ccc67c5a6fdcd7bafc5118fcfe0d4931b61c", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/51f6ccc67c5a6fdcd7bafc5118fcfe0d4931b61c", "committedDate": "2020-02-04T21:13:52Z", "message": "Merge branch 'master' into feature/ml-improve-behavior-if-configs-are-missing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11388d440057551b321e686d29172ced8fd76af3", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/11388d440057551b321e686d29172ced8fd76af3", "committedDate": "2020-02-05T12:11:00Z", "message": "Merge branch 'master' into feature/ml-improve-behavior-if-configs-are-missing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjgzOTE1", "url": "https://github.com/elastic/elasticsearch/pull/51888#pullrequestreview-353683915", "createdAt": "2020-02-05T12:39:48Z", "commit": {"oid": "11388d440057551b321e686d29172ced8fd76af3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjozOTo0OFrOFl2UJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMzoxMjoyM1rOFl3L_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMTUyNA==", "bodyText": "I found the name of this method confusing, as I wondered why we only want started datafeeds, not all datafeeds with tasks.\nAfter investigating further I found that it does mean all datafeeds with tasks, whether they're started, stopping or failed, and that the naming is copied from the poorly named pre-existing method MlTasks.startedDatafeedIds().  But I don't think it's a good idea to propagate this poor naming any further, so please can you rename this to something along the lines of matchingDatafeedIdsWithTasks.\nI think it would also be clearer to rename datafeedIds to datafeedIdPatterns or datafeedIdsToMatch.  I found myself having to look at the calling code to find what datafeedIds was expected to contain.", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375231524", "createdAt": "2020-02-05T12:39:48Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/persistence/DatafeedConfigProvider.java", "diffHunk": "@@ -478,6 +491,30 @@ private QueryBuilder buildDatafeedIdQuery(String [] tokens) {\n         return boolQueryBuilder;\n     }\n \n+    static Collection<String> matchingStartedDatafeedIds(String[] datafeedIds, PersistentTasksCustomMetaData tasksMetaData) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11388d440057551b321e686d29172ced8fd76af3"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0NTM5OQ==", "bodyText": "I think it would be good to add a test of getting jobs stats for all jobs in a situation where one job has a config and the another doesn't.  It would be really bad if in the future a job with a task but no config caused a stats request for all jobs to completely fail.  This would make the jobs list in the UI go blank.", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375245399", "createdAt": "2020-02-05T13:11:21Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/JobAndDatafeedResilienceIT.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.ml.integration;\n+\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.xpack.core.ml.MlTasks;\n+import org.elasticsearch.xpack.core.ml.action.CloseJobAction;\n+import org.elasticsearch.xpack.core.ml.action.StopDatafeedAction;\n+import org.elasticsearch.xpack.core.ml.datafeed.DatafeedConfig;\n+import org.elasticsearch.xpack.core.ml.job.config.AnalysisConfig;\n+import org.elasticsearch.xpack.core.ml.job.config.DataDescription;\n+import org.elasticsearch.xpack.core.ml.job.config.Detector;\n+import org.elasticsearch.xpack.core.ml.job.config.Job;\n+import org.elasticsearch.xpack.core.ml.job.persistence.AnomalyDetectorsIndexFields;\n+import org.junit.After;\n+\n+import java.util.Collections;\n+\n+import static org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase.createDatafeedBuilder;\n+import static org.hamcrest.CoreMatchers.equalTo;\n+\n+public class JobAndDatafeedResilienceIT extends MlNativeAutodetectIntegTestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11388d440057551b321e686d29172ced8fd76af3"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI0NTgyMg==", "bodyText": "This logic isn't used in TransportGetDatafeedsStats.  Is there a good reason for that?", "url": "https://github.com/elastic/elasticsearch/pull/51888#discussion_r375245822", "createdAt": "2020-02-05T13:12:23Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportGetJobsStatsAction.java", "diffHunk": "@@ -75,7 +75,10 @@ public TransportGetJobsStatsAction(TransportService transportService, ActionFilt\n     protected void doExecute(Task task, GetJobsStatsAction.Request request, ActionListener<GetJobsStatsAction.Response> finalListener) {\n         logger.debug(\"Get stats for job [{}]\", request.getJobId());\n \n-        jobConfigProvider.expandJobsIds(request.getJobId(), request.allowNoJobs(), true, ActionListener.wrap(\n+        ClusterState state = clusterService.state();\n+        PersistentTasksCustomMetaData tasks = state.getMetaData().custom(PersistentTasksCustomMetaData.TYPE);\n+        // If there are deleted configs, but the task is still around, we probably want to return the tasks in the stats call", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11388d440057551b321e686d29172ced8fd76af3"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfb1a4946fcab6c1d5867ca4cd9a8184d9bc08dd", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/cfb1a4946fcab6c1d5867ca4cd9a8184d9bc08dd", "committedDate": "2020-02-05T17:31:22Z", "message": "making datafeed stats return tasks without configs as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0a022f7534e6a31862382ab98e710cb79f1e570", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0a022f7534e6a31862382ab98e710cb79f1e570", "committedDate": "2020-02-05T17:31:30Z", "message": "erge branch 'feature/ml-improve-behavior-if-configs-are-missing' of github.com:benwtrent/elasticsearch into feature/ml-improve-behavior-if-configs-are-missing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec932d24d181d76775743fc6290a3c38bdd36ae5", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/ec932d24d181d76775743fc6290a3c38bdd36ae5", "committedDate": "2020-02-05T17:34:07Z", "message": "removing extraneous logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MzYzODA4", "url": "https://github.com/elastic/elasticsearch/pull/51888#pullrequestreview-354363808", "createdAt": "2020-02-06T10:59:28Z", "commit": {"oid": "ec932d24d181d76775743fc6290a3c38bdd36ae5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2782, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}