{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NzI4Mjk4", "number": 59667, "title": "Use different G1GC options for small heaps", "bodyText": "Our benchmarks have demonstrated that Elasticsearch performs better with -XX:G1HeapRegionSize=4M and -XX:G1ReservePercent=15 options for the small heap sizes. With this commit we ergonomically choose different G1GC options for heap sizes smaller than (not including) 8GB.\nCo-authored-by: Daniel Mitterdorfer daniel.mitterdorfer@elastic.co", "createdAt": "2020-07-15T20:50:17Z", "url": "https://github.com/elastic/elasticsearch/pull/59667", "merged": true, "mergeCommit": {"oid": "b29423f6a0488805fbed31f7b91b13d0e4ee1c72"}, "closed": true, "closedAt": "2020-10-06T18:59:10Z", "author": {"login": "ebadyano"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1Q8JpgH2gAyNDQ5NzI4Mjk4OjdkOTg3YmExNDI1ZTlhOGExM2VmYjdiMzUyN2MyZDBjNmE5MmE1NWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP7IVUAFqTUwMzE1ODkzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c", "committedDate": "2020-07-15T20:48:15Z", "message": "Use the parallel collector for small heaps\n\n    Our benchmarks have demonstrated that Elasticsearch performs better with\n    the parallel collector than with the default G1 collector when the heap\n    size is small. With this commit we ergonomically choose the parallel\n    collector for heap sizes smaller than (and including) 4GB and turn real\n    memory circuit breaker off when running with  ParallelGC.\nCo-authored-by: Evgenia Badiyanova <evgenia.badiyanova@elastic.co>\nCo-authored-by: Daniel Mitterdorfer <daniel.mitterdorfer@elastic.co>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzMwNTYw", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-449330560", "createdAt": "2020-07-15T21:06:18Z", "commit": {"oid": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMTowNjoxOFrOGyQEVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMTowNjoxOFrOGyQEVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM0NTIzOQ==", "bodyText": "Drive by comment (sorry!), but the comment in jvm.options would be incorrect after this change, since the user would no longer be uncommenting the lines to use G1", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r455345239", "createdAt": "2020-07-15T21:06:18Z", "author": {"login": "dakrone"}, "path": "distribution/src/config/jvm.options", "diffHunk": "@@ -42,7 +42,6 @@\n # following three lines to your version of the JDK", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzOTU0NjU3", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-453954657", "createdAt": "2020-07-23T09:07:30Z", "commit": {"oid": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwOTowNzozMFrOG2COzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwOTowNzozMFrOG2COzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxMjg0Ng==", "bodyText": "Drive-by comment, feel free to ignore - should we pass Pattern.COMMENTS here so that we can break up the regex with whitespace, to make it easier to read?", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r459312846", "createdAt": "2020-07-23T09:07:30Z", "author": {"login": "pugnascotia"}, "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,53 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        // Use ParallelGC for heaps <= 4GB unless the user has explicitly set the garbage collector\n+        JvmOption g1 = finalJvmOptions.get(\"UseG1GC\");\n+        if (heapSize <= 4 * 1024 * 1024 * 1024 && g1.getMandatoryValue().equals(\"true\") && g1.isCommandLineOrigin() == false) {\n+            ergonomicChoices.add(\"-XX:+UseParallelGC\");\n+        }\n+        System.out.println(\"HEre inn\");\n         return ergonomicChoices;\n     }\n \n     private static final Pattern OPTION = Pattern.compile(\n-        \"^\\\\s*\\\\S+\\\\s+(?<flag>\\\\S+)\\\\s+:?=\\\\s+(?<value>\\\\S+)?\\\\s+\\\\{[^}]+?\\\\}\\\\s+\\\\{[^}]+}\"\n+        \"^\\\\s*\\\\S+\\\\s+(?<flag>\\\\S+)\\\\s+:?=\\\\s+(?<value>\\\\S+)?\\\\s+\\\\{[^}]+?\\\\}\\\\s+\\\\{(?<origin>[^}]+)}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTM0Mzc2", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-451934376", "createdAt": "2020-07-20T20:27:12Z", "commit": {"oid": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDoyNzoxMlrOG0eEuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNzozMDo1NlrOG4XHPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MTg2NQ==", "bodyText": "Can we use Booleans.parseBoolean? Also, please use == false for negation.", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r457671865", "createdAt": "2020-07-20T20:27:12Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/indices/breaker/HierarchyCircuitBreakerService.java", "diffHunk": "@@ -69,7 +69,10 @@\n     private final Map<String, CircuitBreaker> breakers;\n \n     public static final Setting<Boolean> USE_REAL_MEMORY_USAGE_SETTING =\n-        Setting.boolSetting(\"indices.breaker.total.use_real_memory\", true, Property.NodeScope);\n+        Setting.boolSetting(\"indices.breaker.total.use_real_memory\", settings -> {\n+            // turn real memory circuit breaker off for ParallelGC\n+            return String.valueOf(!JvmInfo.jvmInfo().useParallelGC().equals(\"true\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MjEyNQ==", "bodyText": "Isn't the point fo the change to make ergonomics choose which GC to use? It doesn't just have to be based on small heaps, it can be based on java version as well?", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r461752125", "createdAt": "2020-07-28T17:30:56Z", "author": {"login": "rjernst"}, "path": "distribution/src/config/jvm.options", "diffHunk": "@@ -42,7 +42,6 @@\n # following three lines to your version of the JDK", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTM0NTIzOQ=="}, "originalCommit": {"oid": "7d987ba1425e9a8a13efb7b3527c2d0c6a92a55c"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab6059d28d8b14f2c7ed2ef7b1abfa50df9effa9", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab6059d28d8b14f2c7ed2ef7b1abfa50df9effa9", "committedDate": "2020-07-28T23:48:10Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2655315881e80def2ac3dc30a29ee6b0523e0181", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/2655315881e80def2ac3dc30a29ee6b0523e0181", "committedDate": "2020-07-29T13:34:03Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2003331d318cc37610d512c8c5f71e50913032a6", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/2003331d318cc37610d512c8c5f71e50913032a6", "committedDate": "2020-07-29T18:48:41Z", "message": "Addressed some comments and fixed tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c05949b26dc81ba7e26a0f772c4a84cefba73ec", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/3c05949b26dc81ba7e26a0f772c4a84cefba73ec", "committedDate": "2020-07-29T23:51:49Z", "message": "Fix precomit erorrs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "818226a63d0b78d1ac408b38b7dace41adabf5e0", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/818226a63d0b78d1ac408b38b7dace41adabf5e0", "committedDate": "2020-07-30T00:24:19Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f14d2cdb234b3ed56a63dbeb269c28747b56d6e6", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/f14d2cdb234b3ed56a63dbeb269c28747b56d6e6", "committedDate": "2020-07-31T16:18:55Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d033a498deaf7081b1e93fb54dd0a273da753ee", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/4d033a498deaf7081b1e93fb54dd0a273da753ee", "committedDate": "2020-07-31T16:19:34Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MzUwMDA1", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-459350005", "createdAt": "2020-07-31T17:43:35Z", "commit": {"oid": "4d033a498deaf7081b1e93fb54dd0a273da753ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNzo0MzozNlrOG6Qu1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNzo0MzozNlrOG6Qu1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc0NDcyNQ==", "bodyText": "won't these G1 options break the system if parallelGC is selected?", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r463744725", "createdAt": "2020-07-31T17:43:36Z", "author": {"login": "rjernst"}, "path": "distribution/src/config/jvm.options", "diffHunk": "@@ -38,13 +38,16 @@\n 8-13:-XX:+UseCMSInitiatingOccupancyOnly\n \n ## G1GC Configuration\n-# to use G1GC, uncomment the next two lines and update the version on the\n-# following three lines to your version of the JDK\n+# to use G1GC (ParallelGC for heaps smaller than 4G),\n+# uncomment the next three lines and update the version on the\n+# following two lines to your version of the JDK\n # 8-13:-XX:-UseConcMarkSweepGC\n # 8-13:-XX:-UseCMSInitiatingOccupancyOnly\n-14-:-XX:+UseG1GC\n 14-:-XX:G1ReservePercent=25", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d033a498deaf7081b1e93fb54dd0a273da753ee"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTQ5MDU5", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-460549059", "createdAt": "2020-08-04T07:07:57Z", "commit": {"oid": "4d033a498deaf7081b1e93fb54dd0a273da753ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzowNzo1N1rOG7T0hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzowNzo1N1rOG7T0hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg0MzkwOQ==", "bodyText": "In #46751, a check is made purely against the parent breaker, relying on this being the real memory circuit breaker. This PR disables that PR by default for small heaps.\nI seem to remember seeing that approach (just checking the parent breaker, now that we have real memory circuit breaker) has come up a few times.", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r464843909", "createdAt": "2020-08-04T07:07:57Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/indices/breaker/HierarchyCircuitBreakerService.java", "diffHunk": "@@ -69,7 +69,10 @@\n     private final Map<String, CircuitBreaker> breakers;\n \n     public static final Setting<Boolean> USE_REAL_MEMORY_USAGE_SETTING =\n-        Setting.boolSetting(\"indices.breaker.total.use_real_memory\", true, Property.NodeScope);\n+        Setting.boolSetting(\"indices.breaker.total.use_real_memory\", settings -> {\n+            // turn real memory circuit breaker off for ParallelGC\n+            return String.valueOf(Booleans.parseBoolean(JvmInfo.jvmInfo().useParallelGC()) == false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d033a498deaf7081b1e93fb54dd0a273da753ee"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9008ede953098e9ce1df646848f27880238270ec", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/9008ede953098e9ce1df646848f27880238270ec", "committedDate": "2020-09-22T22:47:07Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0e34fe0630ceb28e4370523cac174ca58cda87a", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/d0e34fe0630ceb28e4370523cac174ca58cda87a", "committedDate": "2020-09-29T12:37:51Z", "message": "Changed the ergonomics heuristic to use G1GC  with tuned options instead\nof ParallelGC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70b4de9c0a15165532e92d3ebaf3645d99ccb1d9", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/70b4de9c0a15165532e92d3ebaf3645d99ccb1d9", "committedDate": "2020-09-29T12:38:21Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6f5302e8910fbf259854b1f9fe81a18d855b845", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/a6f5302e8910fbf259854b1f9fe81a18d855b845", "committedDate": "2020-09-29T15:17:04Z", "message": "fix precomit errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffec016f0f63c877fdee1d12a288002db52731c0", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/ffec016f0f63c877fdee1d12a288002db52731c0", "committedDate": "2020-09-29T15:48:21Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80b713b170e56d89a59ac4faa9755123e7505d59", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/80b713b170e56d89a59ac4faa9755123e7505d59", "committedDate": "2020-09-29T16:01:40Z", "message": "Fix precomit errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "411cfd422de27ffe6eb1e406c1d105793f75bf75", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/411cfd422de27ffe6eb1e406c1d105793f75bf75", "committedDate": "2020-10-01T14:19:03Z", "message": "Fix indentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTkzNzc3", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-501193777", "createdAt": "2020-10-02T14:39:20Z", "commit": {"oid": "411cfd422de27ffe6eb1e406c1d105793f75bf75"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNDozOToyMFrOHbwNAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTowNzozMlrOHbxQ0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MzM2MQ==", "bodyText": "I think we should turn the heap size check into heapSize < 8L << 30, since java before version 15 will round the region size down, causing a 7.99GB heap to have a region size of 2MB.", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r498863361", "createdAt": "2020-10-02T14:39:20Z", "author": {"login": "henningandersen"}, "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -116,12 +146,30 @@ private JvmErgonomics() {\n     }\n \n     // package private for testing\n-    static Long extractHeapSize(final Map<String, Optional<String>> finalJvmOptions) {\n-        return Long.parseLong(finalJvmOptions.get(\"MaxHeapSize\").get());\n+    static Long extractHeapSize(final Map<String, JvmOption> finalJvmOptions) {\n+        return Long.parseLong(finalJvmOptions.get(\"MaxHeapSize\").getMandatoryValue());\n+    }\n+\n+    static long extractMaxDirectMemorySize(final Map<String, JvmOption> finalJvmOptions) {\n+        return Long.parseLong(finalJvmOptions.get(\"MaxDirectMemorySize\").getMandatoryValue());\n+    }\n+\n+    // Tune G1GC options for heaps <= 4GB unless the user has explicitly set G1HeapRegionSize\n+    static boolean tuneG1GCForSmallHeap(final Map<String, JvmOption> finalJvmOptions, final long heapSize) {\n+        JvmOption g1GC = finalJvmOptions.get(\"UseG1GC\");\n+        JvmOption g1GCHeapRegion = finalJvmOptions.get(\"G1HeapRegionSize\");\n+        return (heapSize <= 4L << 30 && g1GC.getMandatoryValue().equals(\"true\") && g1GCHeapRegion.isCommandLineOrigin() == false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "411cfd422de27ffe6eb1e406c1d105793f75bf75"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg4MDcyMw==", "bodyText": "As mentioned on another channel, I think we should make reserve pct 15 rather than the default 10 - to stay safely clear of real memory circuit breaker exceptions.\nI also think we should add in the IHOP always if it is not defined, just to be safe. It should not matter for performance since G1 will adaptively adjust the value.", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r498880723", "createdAt": "2020-10-02T15:07:32Z", "author": {"login": "henningandersen"}, "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,55 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        final boolean tuneG1GCForSmallHeap = tuneG1GCForSmallHeap(finalJvmOptions, heapSize);\n+        final boolean tuneG1GCForLargeHeap = tuneG1GCForLargeHeap(finalJvmOptions, heapSize);\n+        if (tuneG1GCForSmallHeap) {\n+            ergonomicChoices.add(\"-XX:G1HeapRegionSize=4m\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "411cfd422de27ffe6eb1e406c1d105793f75bf75"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMzI0NTk2", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-501324596", "createdAt": "2020-10-02T17:37:26Z", "commit": {"oid": "411cfd422de27ffe6eb1e406c1d105793f75bf75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzozNzoyNlrOHb2BNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNzozNzoyNlrOHb2BNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk1ODY0Ng==", "bodyText": "Since we are not choosing the actual GC implementation in ergonomics, doesn't this need to stay uncommented?", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r498958646", "createdAt": "2020-10-02T17:37:26Z", "author": {"login": "rjernst"}, "path": "distribution/src/config/jvm.options", "diffHunk": "@@ -42,9 +42,7 @@\n # following three lines to your version of the JDK\n # 8-13:-XX:-UseConcMarkSweepGC\n # 8-13:-XX:-UseCMSInitiatingOccupancyOnly\n-14-:-XX:+UseG1GC\n-14-:-XX:G1ReservePercent=25\n-14-:-XX:InitiatingHeapOccupancyPercent=30\n+# 14-:-XX:+UseG1GC", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "411cfd422de27ffe6eb1e406c1d105793f75bf75"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec2b8917bb3dd04759466ed6cc5c3a5aefabcb0c", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/ec2b8917bb3dd04759466ed6cc5c3a5aefabcb0c", "committedDate": "2020-10-02T20:32:07Z", "message": "Addressed Henning's and Ryan's comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6", "committedDate": "2020-10-02T23:25:33Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into master-ergonomics-parallelgc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzQwNjYy", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-502340662", "createdAt": "2020-10-05T19:06:33Z", "commit": {"oid": "8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOTowNjozNFrOHcqDWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOToxNjoyOFrOHcqXfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxMTE2Mw==", "bodyText": "I think we should use 30 in this case too.", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r499811163", "createdAt": "2020-10-05T19:06:34Z", "author": {"login": "henningandersen"}, "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,57 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        final boolean tuneG1GCForSmallHeap = tuneG1GCForSmallHeap(finalJvmOptions, heapSize);\n+        final boolean tuneG1GCForLargeHeap = tuneG1GCForLargeHeap(finalJvmOptions, heapSize);\n+        if (tuneG1GCForSmallHeap) {\n+            ergonomicChoices.add(\"-XX:G1HeapRegionSize=4m\");\n+            ergonomicChoices.add(\"-XX:G1ReservePercent=15\");\n+            ergonomicChoices.add(\"-XX:InitiatingHeapOccupancyPercent=45\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxNTc3NA==", "bodyText": "I think it is surprising that if you manually specify any of the 3 parameters you loose all 3. For instance if they decide to raise G1ReservePercent to 20, the region size adjustment is lost.\nI think the check in tuneG1GCForSmallHeap should only check heap size and maybe that G1 is in use.\nThe code below should then only add options where there is no existing command line origin option.\nAlternatively (to the last part), we could swap the two lines here:\n\n  \n    \n      elasticsearch/distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmOptionsParser.java\n    \n    \n         Line 144\n      in\n      01dc110\n    \n    \n    \n    \n\n        \n          \n           finalJvmOptions.addAll(substitutedJvmOptions); \n        \n    \n  \n\n\nto be:\n        finalJvmOptions.addAll(ergonomicJvmOptions);\n        finalJvmOptions.addAll(substitutedJvmOptions);\n\nsince that would ensure that the original command line options override the ergonomics picked here.", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r499815774", "createdAt": "2020-10-05T19:15:26Z", "author": {"login": "henningandersen"}, "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,57 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        final boolean tuneG1GCForSmallHeap = tuneG1GCForSmallHeap(finalJvmOptions, heapSize);\n+        final boolean tuneG1GCForLargeHeap = tuneG1GCForLargeHeap(finalJvmOptions, heapSize);\n+        if (tuneG1GCForSmallHeap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgxNjMxOQ==", "bodyText": "Same comment as above, is surprising that if one of them is specified you loose the other. In particular if IHOP is specified, it seems quite dangerous to no longer set G1ReservePercent.", "url": "https://github.com/elastic/elasticsearch/pull/59667#discussion_r499816319", "createdAt": "2020-10-05T19:16:28Z", "author": {"login": "henningandersen"}, "path": "distribution/tools/launchers/src/main/java/org/elasticsearch/tools/launchers/JvmErgonomics.java", "diffHunk": "@@ -53,25 +53,57 @@ private JvmErgonomics() {\n      */\n     static List<String> choose(final List<String> userDefinedJvmOptions) throws InterruptedException, IOException {\n         final List<String> ergonomicChoices = new ArrayList<>();\n-        final Map<String, Optional<String>> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n+        final Map<String, JvmOption> finalJvmOptions = finalJvmOptions(userDefinedJvmOptions);\n         final long heapSize = extractHeapSize(finalJvmOptions);\n         final long maxDirectMemorySize = extractMaxDirectMemorySize(finalJvmOptions);\n         if (maxDirectMemorySize == 0) {\n             ergonomicChoices.add(\"-XX:MaxDirectMemorySize=\" + heapSize / 2);\n         }\n+        final boolean tuneG1GCForSmallHeap = tuneG1GCForSmallHeap(finalJvmOptions, heapSize);\n+        final boolean tuneG1GCForLargeHeap = tuneG1GCForLargeHeap(finalJvmOptions, heapSize);\n+        if (tuneG1GCForSmallHeap) {\n+            ergonomicChoices.add(\"-XX:G1HeapRegionSize=4m\");\n+            ergonomicChoices.add(\"-XX:G1ReservePercent=15\");\n+            ergonomicChoices.add(\"-XX:InitiatingHeapOccupancyPercent=45\");\n+        } else if (tuneG1GCForLargeHeap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3c734c0d21861f2fc11f3ec0baa994e8d2dee6"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac9a5686bfe5c1b475a72d9f13ca8ce12e27905c", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/ac9a5686bfe5c1b475a72d9f13ca8ce12e27905c", "committedDate": "2020-10-05T20:16:03Z", "message": "Address Henning's comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f326f5ba3c5f0811dd7ee6bde8f999c19638b028", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/f326f5ba3c5f0811dd7ee6bde8f999c19638b028", "committedDate": "2020-10-05T20:27:02Z", "message": "address Henning's comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ddb619f1a2a3d9d0b1b2997485e48cd211b6d9f", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ddb619f1a2a3d9d0b1b2997485e48cd211b6d9f", "committedDate": "2020-10-05T20:41:31Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d628ff90dba6492fca680c3523bcd2b973ac03d8", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/d628ff90dba6492fca680c3523bcd2b973ac03d8", "committedDate": "2020-10-05T20:59:33Z", "message": "Fix precommit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8a38403c2a5e213367eb1a64ea6bcfac05d1163", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8a38403c2a5e213367eb1a64ea6bcfac05d1163", "committedDate": "2020-10-05T21:19:51Z", "message": "Fix logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzAzOTc4", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-502703978", "createdAt": "2020-10-06T08:32:22Z", "commit": {"oid": "d8a38403c2a5e213367eb1a64ea6bcfac05d1163"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2e999acdaf1a27117a30636b026d1c277b2edb0", "author": {"user": {"login": "ebadyano", "name": "Evgenia Badyanova"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2e999acdaf1a27117a30636b026d1c277b2edb0", "committedDate": "2020-10-06T14:15:36Z", "message": "Add an extra test for when non G1GC policy is set"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTU4OTMw", "url": "https://github.com/elastic/elasticsearch/pull/59667#pullrequestreview-503158930", "createdAt": "2020-10-06T16:39:37Z", "commit": {"oid": "f2e999acdaf1a27117a30636b026d1c277b2edb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4264, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}