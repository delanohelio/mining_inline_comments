{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MTMxMzMz", "number": 60969, "title": "Simplify distribution download and extraction", "bodyText": "We leverage artifact transforms now when downloading and unpacking elasticsearch distributions.\nThis has the benefit of\n\nhandcrafted extract tasks on the root project are not required. The general tight coupling to the root project\nhas been removed.\nThe overall required configurations required to handle a distribution have been reduced\nElasticsearchDistribution has been simplified by making Extracted an ordinary Configuration\ndownloaded and unpacked external distributions are reused in later builds by been cached\nin the gradle user home.\n\nDistributionDownloadPlugin functional tests have been extended and ported\nto DistributionDownloadPluginFuncTest.\nHere's a comparison of how the timeline looks like for running the :run task before and after this change:\nbefore: https://gradle-enterprise.elastic.co/s/4l6o5jagmmuu6/timeline\nafter: https://gradle-enterprise.elastic.co/s/sv4vjua2svl6a/timeline\nThis brings us one step closer to #61095", "createdAt": "2020-08-11T14:12:08Z", "url": "https://github.com/elastic/elasticsearch/pull/60969", "merged": true, "mergeCommit": {"oid": "b61f71875d99804c34c0acc38d52adfd0f0dd663"}, "closed": true, "closedAt": "2020-08-17T06:27:48Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-LRWzABqjM2NDc2Njc0NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_iGfDABqjM2NTk1MjI1MDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68795f98894cd7b0c23c470c439657d7b4bf2870", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/68795f98894cd7b0c23c470c439657d7b4bf2870", "committedDate": "2020-08-12T10:20:24Z", "message": "Fix conflicting transforms"}, "afterCommit": {"oid": "e88254ac24457bc079d81c2399b640ef5f4f8ad6", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/e88254ac24457bc079d81c2399b640ef5f4f8ad6", "committedDate": "2020-08-12T13:16:59Z", "message": "Do not rely on Extraced.toString"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODM2ODQw", "url": "https://github.com/elastic/elasticsearch/pull/60969#pullrequestreview-467836840", "createdAt": "2020-08-14T19:48:58Z", "commit": {"oid": "b771fc289249cce9dac121ec68196984a9b31a37"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxOTo0ODo1OFrOHBBeJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMDoxOTozMVrOHBCPIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNDcyNA==", "bodyText": "Would it better to pass a parameter to the transform indicating the prefix expression to trim off vs having multiple implementations? I'm wondering if that capability might be useful for any other use case. If not, this pattern seems fine to me.", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470834724", "createdAt": "2020-08-14T19:48:58Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/transform/JdkUnzipTransform.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.transform;\n+\n+import org.apache.tools.zip.ZipEntry;\n+import org.elasticsearch.gradle.util.ArchiveUtils;\n+\n+import java.nio.file.Path;\n+\n+public abstract class JdkUnzipTransform extends UnzipTransform {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b771fc289249cce9dac121ec68196984a9b31a37"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDgzNzY4MQ==", "bodyText": "Just to clear my confusion, this can be resolved but not consumed which just means it can't be used by another project, right?", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470837681", "createdAt": "2020-08-14T19:55:58Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/JdkDownloadPlugin.java", "diffHunk": "@@ -41,22 +43,34 @@\n \n     @Override\n     public void apply(Project project) {\n+        Attribute<Boolean> jdkAttribute = Attribute.of(\"jdk\", Boolean.class);\n+        project.getDependencies().getAttributesSchema().attribute(jdkAttribute);\n         project.getDependencies().getArtifactTypes().maybeCreate(ArtifactTypeDefinition.ZIP_TYPE);\n-        project.getDependencies().registerTransform(UnzipTransform.class, transformSpec -> {\n-            transformSpec.getFrom().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.ZIP_TYPE);\n-            transformSpec.getTo().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+        project.getDependencies().registerTransform(JdkUnzipTransform.class, transformSpec -> {\n+            transformSpec.getFrom()\n+                .attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.ZIP_TYPE)\n+                .attribute(jdkAttribute, true);\n+            transformSpec.getTo()\n+                .attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE)\n+                .attribute(jdkAttribute, true);\n+            ;\n         });\n \n         ArtifactTypeDefinition tarArtifactTypeDefinition = project.getDependencies().getArtifactTypes().maybeCreate(\"tar.gz\");\n-        project.getDependencies().registerTransform(SymbolicLinkPreservingUntarTransform.class, transformSpec -> {\n-            transformSpec.getFrom().attribute(ArtifactAttributes.ARTIFACT_FORMAT, tarArtifactTypeDefinition.getName());\n-            transformSpec.getTo().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+        project.getDependencies().registerTransform(JdkSymbolicLinkPreservingUntarTransform.class, transformSpec -> {\n+            transformSpec.getFrom()\n+                .attribute(ArtifactAttributes.ARTIFACT_FORMAT, tarArtifactTypeDefinition.getName())\n+                .attribute(jdkAttribute, true);\n+            transformSpec.getTo()\n+                .attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE)\n+                .attribute(jdkAttribute, true);\n         });\n \n         NamedDomainObjectContainer<Jdk> jdksContainer = project.container(Jdk.class, name -> {\n             Configuration configuration = project.getConfigurations().create(\"jdk_\" + name);\n             configuration.setCanBeConsumed(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b771fc289249cce9dac121ec68196984a9b31a37"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0MDk4OQ==", "bodyText": "Man, it's awesome that we don't need this mess anymore.", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470840989", "createdAt": "2020-08-14T20:03:55Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java", "diffHunk": "@@ -142,51 +140,6 @@ private Object resolveDependencyNotation(Project p, ElasticsearchDistribution di\n             .orElseGet(() -> dependencyNotation(distribution));\n     }\n \n-    private void setupRootDownload(Project rootProject, ElasticsearchDistribution distribution) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b771fc289249cce9dac121ec68196984a9b31a37"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0MTQ4MA==", "bodyText": "Can we not implicitly rely on the version bundled with Gradle or is that filtered out from the buildsrc classpath?", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470841480", "createdAt": "2020-08-14T20:05:10Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/build.gradle", "diffHunk": "@@ -93,7 +93,7 @@ dependencies {\n \n   api 'commons-codec:commons-codec:1.12'\n   api 'org.apache.commons:commons-compress:1.19'\n-\n+  api 'org.apache.ant:ant:1.10.8'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b771fc289249cce9dac121ec68196984a9b31a37"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0NjEyOA==", "bodyText": "Should we do a clean inbetween build runs here to ensure it's actually getting \"cached\" or is that irrelevant since we aren't talking about task output here?", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470846128", "createdAt": "2020-08-14T20:16:40Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/integTest/groovy/org/elasticsearch/gradle/JdkDownloadPluginFuncTest.groovy", "diffHunk": "@@ -185,8 +185,8 @@ class JdkDownloadPluginFuncTest extends AbstractGradleFuncTest {\n \n         where:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b771fc289249cce9dac121ec68196984a9b31a37"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg0NzI2NA==", "bodyText": "Should we reference the class simpleName here like we've done elsewhere to make refactoring less painful?", "url": "https://github.com/elastic/elasticsearch/pull/60969#discussion_r470847264", "createdAt": "2020-08-14T20:19:31Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/integTest/groovy/org/elasticsearch/gradle/JdkDownloadPluginFuncTest.groovy", "diffHunk": "@@ -132,7 +132,7 @@ class JdkDownloadPluginFuncTest extends AbstractGradleFuncTest {\n         }\n \n         then:\n-        result.tasks.size() == 10\n+        result.tasks.size() == 3\n         result.output.count(\"Unpacking linux-12.0.2-x64.tar.gz using SymbolicLinkPreservingUntarTransform.\") == 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b771fc289249cce9dac121ec68196984a9b31a37"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "273660be85e92f8dac2fcacaebe8e6207a5d0e24", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/273660be85e92f8dac2fcacaebe8e6207a5d0e24", "committedDate": "2020-08-16T18:26:46Z", "message": "(WIP) Simplify distribution download and extraction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d15cba91096c72d7c559e658323bf15d1469329", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/4d15cba91096c72d7c559e658323bf15d1469329", "committedDate": "2020-08-16T18:26:47Z", "message": "Minor cleanup\n\n- remove unused code\n- fix jdk download func tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "435dc74f755f0f690c4d8905a17545a501d5c32d", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/435dc74f755f0f690c4d8905a17545a501d5c32d", "committedDate": "2020-08-16T18:26:47Z", "message": "Fix integTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b72a6442c18b087f4ea45fa0bf4efc3d326467f6", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b72a6442c18b087f4ea45fa0bf4efc3d326467f6", "committedDate": "2020-08-16T18:26:47Z", "message": "Port func test to spock specification"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ff95d55bbf1dd9b0f8e361ff2e1a2c34684de77", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ff95d55bbf1dd9b0f8e361ff2e1a2c34684de77", "committedDate": "2020-08-16T18:26:47Z", "message": "Fix conflicting transforms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7467104b06de75d0fefe82bbccc4d4c6ac386e5c", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/7467104b06de75d0fefe82bbccc4d4c6ac386e5c", "committedDate": "2020-08-16T18:26:47Z", "message": "Do not rely on Extraced.toString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "035c78e4e9875e6ccd2303c2faf0bd10074557ad", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/035c78e4e9875e6ccd2303c2faf0bd10074557ad", "committedDate": "2020-08-16T18:26:48Z", "message": "Fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb5d80db4a85e465f86f4fe8fb7cbe1fa0e28a4a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb5d80db4a85e465f86f4fe8fb7cbe1fa0e28a4a", "committedDate": "2020-08-16T18:26:48Z", "message": "Fix permissions handling in unzip transform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38679fe9915040d1ffcd41e27f500971046068ba", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/38679fe9915040d1ffcd41e27f500971046068ba", "committedDate": "2020-08-16T18:26:48Z", "message": "Fix artifact type for bwc publications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b380d3a99d06d89c60e8ffeb48c87b286c706583", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b380d3a99d06d89c60e8ffeb48c87b286c706583", "committedDate": "2020-08-16T18:26:48Z", "message": "Fix build-tool tests and jdk transformation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "152c3df403293652082347fa175fa1e83bd964f4", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/152c3df403293652082347fa175fa1e83bd964f4", "committedDate": "2020-08-16T18:26:48Z", "message": "Fix conflicting unzip transforms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21fae36e5d5d6e5af6c413e7daff324d6bf8de81", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/21fae36e5d5d6e5af6c413e7daff324d6bf8de81", "committedDate": "2020-08-16T18:26:48Z", "message": "Fix handling of chmod on windows in UnzipTransform"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d95c52f11e1f8a8934f60589dee6b401bfb3f48d", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d95c52f11e1f8a8934f60589dee6b401bfb3f48d", "committedDate": "2020-08-16T18:26:49Z", "message": "Polishing\n\n- make ant dependency explicit\n- share permission handling across unzip and untar transforms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4dd2d2a36950c16c818d93bf13300a2906e1408", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4dd2d2a36950c16c818d93bf13300a2906e1408", "committedDate": "2020-08-16T18:26:49Z", "message": "Extends test coverage and polishing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6dc749e0dca15152b34e58620c5ad13e7e0d158", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6dc749e0dca15152b34e58620c5ad13e7e0d158", "committedDate": "2020-08-16T18:26:49Z", "message": "Polish test coverage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd237c99c9a98e9942f2e4eb84f6665370353731", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd237c99c9a98e9942f2e4eb84f6665370353731", "committedDate": "2020-08-16T18:26:49Z", "message": "Cleanup ElasticsearchDistribution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d453ded0100800c657776c8e955b23baa57c0cd", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/0d453ded0100800c657776c8e955b23baa57c0cd", "committedDate": "2020-08-16T18:26:49Z", "message": "Fix formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e13442dbc608f18c15e779c8d9f87cee71366e60", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/e13442dbc608f18c15e779c8d9f87cee71366e60", "committedDate": "2020-08-16T18:26:49Z", "message": "Minor polishing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdb8ad25727d158f041bf148f27b878a86edf937", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdb8ad25727d158f041bf148f27b878a86edf937", "committedDate": "2020-08-16T18:26:50Z", "message": "Leverage transform parameters\n\n- apply review feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90e2b3fa803bbecd48cc6b40e3998cef9a869c63", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/90e2b3fa803bbecd48cc6b40e3998cef9a869c63", "committedDate": "2020-08-15T07:24:11Z", "message": "Leverage transform parameters\n\n- apply review feedback"}, "afterCommit": {"oid": "fdb8ad25727d158f041bf148f27b878a86edf937", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdb8ad25727d158f041bf148f27b878a86edf937", "committedDate": "2020-08-16T18:26:50Z", "message": "Leverage transform parameters\n\n- apply review feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3399, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}