{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MTEwMjA2", "number": 53254, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNzowMzoyMFrODl__IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjoyNzozN1rODnsYbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTcyMjU3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/support/SamlAuthenticationState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwNzowMzoyMFrOFzM-hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOToyODo0OVrOFzf37w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzNDMwOA==", "bodyText": "This ended up bothering me quite a bit but I raised the PR as is to discuss it. If this ends up in a cookie, a malicious user could forge the inResponseTo of  a SAML Response. This in itself is not a additional threat as it wouldn't allow any attack vectors that are not already mitigated by other means ( signature validation etc. )\nThe requestedNameIdFormat can also be forged after the NameIdPolicy is validated but then again the only attack vector this enables is that a malicious user could i.e.have a persistent NameID generated for an SP that only needs/handles transient ones.\nFinally the entityId is used only for the SamlInitiateSingleSignOnResponse and could easiliy be even omitted , and the requestedAcsUrl can potentially be forged to send SAML Response messages to attacker controlled URLs.\nAlthough we could accept the risk these potential issues carry, it makes me think: Is this user facing state control the right trade off to satisfy the API design ( the split between /validate and /init ) and the interplay between them ?\nIs the alternative of having the /validate API require secondary authentication too and able to respond with SAML Responses worth it ?That would mean that the user needs to be authenticated before the AuthnRequest will be parsed and validated. It would also mean that we would respond with authentication failure even if i.e. there is also an error and we can't satisfy the NameIdPolicy ( one might argue that in these cases we should reply with InvalidNameIdPolicy regardless of auhtn failure because even if the authentication was correct, we would still fail )", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389234308", "createdAt": "2020-03-07T07:03:20Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/support/SamlAuthenticationState.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.idp.saml.support;\n+\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.ValidationException;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.xcontent.ObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+/**\n+ * Represents a state object that can be used during an SP initiated flow in order to pass necessary parameters from the response of the\n+ * /validate API to the /init API. State properties are not integrity protected, might end up in a cookie on the user's side and as such\n+ * are treated as tainted parameters for informational purposes only. No authentication/authorization decisions should be made based on\n+ * these.\n+ */\n+public class SamlAuthenticationState implements Writeable, ToXContentObject {\n+    private String entityId;\n+    private String requestedAcsUrl;\n+    @Nullable\n+    private String requestedNameidFormat;\n+    @Nullable\n+    private String authnRequestId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e55a461e18ffeb9eed8d633f509e1029edccf527"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MzkxOQ==", "bodyText": "We discussed this in person and determined that we want to keep the distinction as is for the reasons that originally lead us to this design ( mainly extensibility and spec conformance ).\nThe SamlAuthenticationState will not make it to a cookie for phase 1 and we will make it clear in the docs and code that this should be integrity protected if it ever needs to be shared in a format that is editable by the end user", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389543919", "createdAt": "2020-03-09T09:28:49Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/support/SamlAuthenticationState.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.idp.saml.support;\n+\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.ValidationException;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.xcontent.ObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+/**\n+ * Represents a state object that can be used during an SP initiated flow in order to pass necessary parameters from the response of the\n+ * /validate API to the /init API. State properties are not integrity protected, might end up in a cookie on the user's side and as such\n+ * are treated as tainted parameters for informational purposes only. No authentication/authorization decisions should be made based on\n+ * these.\n+ */\n+public class SamlAuthenticationState implements Writeable, ToXContentObject {\n+    private String entityId;\n+    private String requestedAcsUrl;\n+    @Nullable\n+    private String requestedNameidFormat;\n+    @Nullable\n+    private String authnRequestId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzNDMwOA=="}, "originalCommit": {"oid": "e55a461e18ffeb9eed8d633f509e1029edccf527"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzUxODgwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjoxNzozN1rOFzb4lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjoxNzozN1rOFzb4lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3ODU0OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"for this Service Provider which is [{}]\", requestedFormat, sp.getAllowedNameIdFormat());\n          \n          \n            \n                                    \" for this Service Provider which is [{}]\", requestedFormat, sp.getAllowedNameIdFormat());", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389478549", "createdAt": "2020-03-09T06:17:37Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -172,36 +170,34 @@ private void validateAuthnRequest(AuthnRequest authnRequest, SamlServiceProvider\n                 return;\n             }\n         }\n-\n+        final Map<String, Object> authnState = new HashMap<>();\n         checkDestination(authnRequest);\n-        checkAcs(authnRequest, sp);\n-\n-        Map<String, Object> authnState = buildAuthnState(authnRequest, sp);\n+        checkAcs(authnRequest, sp, authnState);\n+        validateNameIdPolicy(authnRequest, sp, authnState);\n+        authnState.put(SamlAuthenticationState.Fields.ENTITY_ID.getPreferredName(), sp.getEntityId());\n+        authnState.put(SamlAuthenticationState.Fields.AUTHN_REQUEST_ID.getPreferredName(), authnRequest.getID());\n         final SamlValidateAuthnRequestResponse response = new SamlValidateAuthnRequestResponse(sp.getEntityId(),\n             authnRequest.isForceAuthn(), authnState);\n         logger.trace(new ParameterizedMessage(\"Validated AuthnResponse from queryString [{}] and extracted [{}]\",\n             parsedQueryString.queryString, response));\n         listener.onResponse(response);\n     }\n \n-    private Map<String, Object> buildAuthnState(AuthnRequest request, SamlServiceProvider sp) {\n-        Map<String, Object> authnState = new HashMap<>();\n+    private void validateNameIdPolicy(AuthnRequest request, SamlServiceProvider sp, Map<String, Object> authnState) {\n         final NameIDPolicy nameIDPolicy = request.getNameIDPolicy();\n         if (null != nameIDPolicy) {\n             final String requestedFormat = request.getNameIDPolicy().getFormat();\n+            final String allowedFormat = sp.getAllowedNameIdFormat();\n             if (Strings.hasText(requestedFormat)) {\n-                authnState.put(\"nameid_format\", requestedFormat);\n-                // we should not throw an error. Pass this as additional data so that the /saml/init API can\n-                // return a SAML response with the appropriate status (3.4.1.1 in the core spec)\n-                if (requestedFormat.equals(UNSPECIFIED) == false && sp.getAllowedNameIdFormats().contains(requestedFormat) == false) {\n-                    logger.warn(() ->\n-                        new ParameterizedMessage(\"The requested NameID format [{}] doesn't match the allowed NameID formats\" +\n-                            \"for this Service Provider are {}\", requestedFormat, sp.getAllowedNameIdFormats()));\n-                    authnState.put(\"error\", \"invalid_nameid_policy\");\n+                if (allowedFormat != null && requestedFormat.equals(UNSPECIFIED) == false\n+                    && requestedFormat.equals(allowedFormat) == false) {\n+                    throw new ElasticsearchSecurityException(\"The requested NameID format [{}] doesn't match the allowed NameID format\" +\n+                        \"for this Service Provider which is [{}]\", requestedFormat, sp.getAllowedNameIdFormat());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a46ee7f2af181c4537950979f8363c7641f6f40f"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzUyMTk5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjoxOTo1OFrOFzb6gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOTozMzowNVrOFzgAmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTA0Mw==", "bodyText": "Is this for template support? Or for concurrency?\nGiven we know that it must equal the SP's registered ACS, it seems unnecessary here (but I'm not objecting, just trying to understand).", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389479043", "createdAt": "2020-03-09T06:19:58Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -264,6 +260,7 @@ private void checkAcs(AuthnRequest request, SamlServiceProvider sp) {\n             throw new ElasticsearchSecurityException(\"The registered ACS URL for this Service Provider is [{}] but the authentication \" +\n                 \"request contained [{}]\", sp.getAssertionConsumerService(), acs);\n         }\n+        authnState.put(SamlAuthenticationState.Fields.ACS_URL.getPreferredName(), acs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a46ee7f2af181c4537950979f8363c7641f6f40f"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0NjEzNw==", "bodyText": "As we discussed in person, this is needed so that we can potentially return SAML Responses that indicate failure in the /init API, even if we/something fails before we reconstruct the SP object there", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389546137", "createdAt": "2020-03-09T09:33:05Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -264,6 +260,7 @@ private void checkAcs(AuthnRequest request, SamlServiceProvider sp) {\n             throw new ElasticsearchSecurityException(\"The registered ACS URL for this Service Provider is [{}] but the authentication \" +\n                 \"request contained [{}]\", sp.getAssertionConsumerService(), acs);\n         }\n+        authnState.put(SamlAuthenticationState.Fields.ACS_URL.getPreferredName(), acs);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTA0Mw=="}, "originalCommit": {"oid": "a46ee7f2af181c4537950979f8363c7641f6f40f"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzUyNTIwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SuccessfulAuthenticationResponseMessageBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjoyMTo0NVrOFzb8TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjoyMTo0NVrOFzb8TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTUwMA==", "bodyText": "Nit: Extra line.", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389479500", "createdAt": "2020-03-09T06:21:45Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SuccessfulAuthenticationResponseMessageBuilder.java", "diffHunk": "@@ -215,4 +212,16 @@ private Status buildStatus() {\n \n         return status;\n     }\n+\n+    private NameID buildNameId(SamlServiceProvider serviceProvider, @Nullable SamlAuthenticationState authnState) {\n+        final NameID nameID = samlFactory.object(NameID.class, NameID.DEFAULT_ELEMENT_NAME);\n+        if (authnState != null && authnState.getRequestedNameidFormat() != null) {\n+            nameID.setFormat(authnState.getRequestedNameidFormat());\n+        } else {\n+            nameID.setFormat(serviceProvider.getAllowedNameIdFormat() != null ? serviceProvider.getAllowedNameIdFormat() :\n+                idp.getServiceProviderDefaults().nameIdFormat);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a46ee7f2af181c4537950979f8363c7641f6f40f"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzUyNTYzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SuccessfulAuthenticationResponseMessageBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjoyMjoxNFrOFzb8ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjoyMjoxNFrOFzb8ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTU4Mg==", "bodyText": "No Value for the NameID? If that's intentional, can we add a TODO here to set it?", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389479582", "createdAt": "2020-03-09T06:22:14Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SuccessfulAuthenticationResponseMessageBuilder.java", "diffHunk": "@@ -215,4 +212,16 @@ private Status buildStatus() {\n \n         return status;\n     }\n+\n+    private NameID buildNameId(SamlServiceProvider serviceProvider, @Nullable SamlAuthenticationState authnState) {\n+        final NameID nameID = samlFactory.object(NameID.class, NameID.DEFAULT_ELEMENT_NAME);\n+        if (authnState != null && authnState.getRequestedNameidFormat() != null) {\n+            nameID.setFormat(authnState.getRequestedNameidFormat());\n+        } else {\n+            nameID.setFormat(serviceProvider.getAllowedNameIdFormat() != null ? serviceProvider.getAllowedNameIdFormat() :\n+                idp.getServiceProviderDefaults().nameIdFormat);\n+\n+        }\n+        return nameID;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a46ee7f2af181c4537950979f8363c7641f6f40f"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzUyODIyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProviderDocument.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjoyMzo1MFrOFzb-Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNjoyMzo1MFrOFzb-Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTk2Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public String nameIdFormat;\n          \n          \n            \n                @Nullable\n          \n          \n            \n                public String nameIdFormat;", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389479967", "createdAt": "2020-03-09T06:23:50Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProviderDocument.java", "diffHunk": "@@ -242,11 +242,12 @@ public int hashCode() {\n \n     public String acs;\n \n+    public String nameIdFormat;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a46ee7f2af181c4537950979f8363c7641f6f40f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTcwMTcxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo1NDoyNFrOF1RNuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo1NDoyNFrOF1RNuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMDg4OA==", "bodyText": "Can't this be handled in the validation on the request? Why would we do it inside the action?", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391400888", "createdAt": "2020-03-12T04:54:24Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -49,34 +52,68 @@ public TransportSamlInitiateSingleSignOnAction(TransportService transportService\n     @Override\n     protected void doExecute(Task task, SamlInitiateSingleSignOnRequest request,\n                              ActionListener<SamlInitiateSingleSignOnResponse> listener) {\n+        final SamlAuthenticationState authenticationState = request.getSamlAuthenticationState();\n+        if (authenticationState != null) {\n+            final ValidationException validationException = authenticationState.validate();\n+            if (validationException != null) {\n+                listener.onFailure(validationException);\n+                return;\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7b077d226d852b9b971b50ee7b54ade190d76b2"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTcwNTY0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo1NzowOVrOF1RQCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDoyMTowMFrOF1gqow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMTQ4Mw==", "bodyText": "I feel like it would be good (in a follow up probably) to actually indicate to the caller (in the JSON response) that this a failure rather than success.", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391401483", "createdAt": "2020-03-12T04:57:09Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -49,34 +52,68 @@ public TransportSamlInitiateSingleSignOnAction(TransportService transportService\n     @Override\n     protected void doExecute(Task task, SamlInitiateSingleSignOnRequest request,\n                              ActionListener<SamlInitiateSingleSignOnResponse> listener) {\n+        final SamlAuthenticationState authenticationState = request.getSamlAuthenticationState();\n+        if (authenticationState != null) {\n+            final ValidationException validationException = authenticationState.validate();\n+            if (validationException != null) {\n+                listener.onFailure(validationException);\n+                return;\n+            }\n+        }\n         identityProvider.getRegisteredServiceProvider(request.getSpEntityId(), ActionListener.wrap(\n             sp -> {\n-                try {\n-                    if (null == sp) {\n-                        final String message = \"Service Provider with Entity ID [\" + request.getSpEntityId()\n-                            + \"] is not registered with this Identity Provider\";\n-                        logger.debug(message);\n-                        listener.onFailure(new IllegalArgumentException(message));\n+                if (null == sp) {\n+                    final String message = \"Service Provider with Entity ID [\" + request.getSpEntityId()\n+                        + \"] is not registered with this Identity Provider\";\n+                    logger.debug(message);\n+                    listener.onFailure(new IllegalArgumentException(message));\n+                    return;\n+                }\n+                final SecondaryAuthentication secondaryAuthentication = SecondaryAuthentication.readFromContext(securityContext);\n+                if (secondaryAuthentication == null) {\n+                    if (authenticationState != null) {\n+                        final FailedAuthenticationResponseMessageBuilder builder =\n+                            new FailedAuthenticationResponseMessageBuilder(samlFactory, Clock.systemUTC(), identityProvider)\n+                                .setInResponseTo(authenticationState.getAuthnRequestId())\n+                                .setAcsUrl(authenticationState.getRequestedAcsUrl())\n+                                .setPrimaryStatusCode(StatusCode.REQUESTER)\n+                                .setSecondaryStatusCode(StatusCode.AUTHN_FAILED);\n+                        final Response response = builder.build();\n+                        listener.onResponse(new SamlInitiateSingleSignOnResponse(\n+                            authenticationState.getRequestedAcsUrl(),\n+                            samlFactory.getXmlContent(response),\n+                            authenticationState.getEntityId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7b077d226d852b9b971b50ee7b54ade190d76b2"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1NDA1MQ==", "bodyText": "Marked this as a todo and will take care of it in a follow up", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391654051", "createdAt": "2020-03-12T14:21:00Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -49,34 +52,68 @@ public TransportSamlInitiateSingleSignOnAction(TransportService transportService\n     @Override\n     protected void doExecute(Task task, SamlInitiateSingleSignOnRequest request,\n                              ActionListener<SamlInitiateSingleSignOnResponse> listener) {\n+        final SamlAuthenticationState authenticationState = request.getSamlAuthenticationState();\n+        if (authenticationState != null) {\n+            final ValidationException validationException = authenticationState.validate();\n+            if (validationException != null) {\n+                listener.onFailure(validationException);\n+                return;\n+            }\n+        }\n         identityProvider.getRegisteredServiceProvider(request.getSpEntityId(), ActionListener.wrap(\n             sp -> {\n-                try {\n-                    if (null == sp) {\n-                        final String message = \"Service Provider with Entity ID [\" + request.getSpEntityId()\n-                            + \"] is not registered with this Identity Provider\";\n-                        logger.debug(message);\n-                        listener.onFailure(new IllegalArgumentException(message));\n+                if (null == sp) {\n+                    final String message = \"Service Provider with Entity ID [\" + request.getSpEntityId()\n+                        + \"] is not registered with this Identity Provider\";\n+                    logger.debug(message);\n+                    listener.onFailure(new IllegalArgumentException(message));\n+                    return;\n+                }\n+                final SecondaryAuthentication secondaryAuthentication = SecondaryAuthentication.readFromContext(securityContext);\n+                if (secondaryAuthentication == null) {\n+                    if (authenticationState != null) {\n+                        final FailedAuthenticationResponseMessageBuilder builder =\n+                            new FailedAuthenticationResponseMessageBuilder(samlFactory, Clock.systemUTC(), identityProvider)\n+                                .setInResponseTo(authenticationState.getAuthnRequestId())\n+                                .setAcsUrl(authenticationState.getRequestedAcsUrl())\n+                                .setPrimaryStatusCode(StatusCode.REQUESTER)\n+                                .setSecondaryStatusCode(StatusCode.AUTHN_FAILED);\n+                        final Response response = builder.build();\n+                        listener.onResponse(new SamlInitiateSingleSignOnResponse(\n+                            authenticationState.getRequestedAcsUrl(),\n+                            samlFactory.getXmlContent(response),\n+                            authenticationState.getEntityId()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMTQ4Mw=="}, "originalCommit": {"oid": "e7b077d226d852b9b971b50ee7b54ade190d76b2"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTcwODA0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo1OTowMVrOF1RReg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo1OTowMVrOF1RReg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMTg1MA==", "bodyText": "Nit, extra space.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Processes a SAML AuthnRequest, validates it,  extracts necessary information and returns a {@link SamlValidateAuthnRequestResponse}\n          \n          \n            \n             * Processes a SAML AuthnRequest, validates it, extracts necessary information and returns a {@link SamlValidateAuthnRequestResponse}", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391401850", "createdAt": "2020-03-12T04:59:01Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -50,8 +51,8 @@\n import static org.opensaml.saml.common.xml.SAMLConstants.SAML2_REDIRECT_BINDING_URI;\n import static org.opensaml.saml.saml2.core.NameIDType.UNSPECIFIED;\n \n-/*\n- * Processes a SAML AuthnRequest, validates it and extracts necessary information\n+/**\n+ * Processes a SAML AuthnRequest, validates it,  extracts necessary information and returns a {@link SamlValidateAuthnRequestResponse}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7b077d226d852b9b971b50ee7b54ade190d76b2"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTcwODkwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo1OTo1NFrOF1RSIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNDo1OTo1NFrOF1RSIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMjAxNg==", "bodyText": "For completeness, it would probably be worth putting the sp entity id in the message.\nThe caller should know it, but the logger won't.", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391402016", "createdAt": "2020-03-12T04:59:54Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -150,17 +151,14 @@ private void validateAuthnRequest(AuthnRequest authnRequest, SamlServiceProvider\n                 }\n                 final Set<X509Credential> spSigningCredentials = sp.getSpSigningCredentials();\n                 if (spSigningCredentials == null || spSigningCredentials.isEmpty()) {\n-                    logAndRespond(\n-                        \"Unable to validate signature of authentication request, \" +\n-                            \"Service Provider hasn't registered signing credentials\",\n-                        listener);\n+                    logAndRespond(\"Unable to validate signature of authentication request, \" +\n+                        \"Service Provider hasn't registered signing credentials\", listener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7b077d226d852b9b971b50ee7b54ade190d76b2"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyOTQ4MDkyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjoyNjo0M1rOF11paQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjoyNjo0M1rOF11paQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5NzgwMQ==", "bodyText": "Since this only handles a failure response, I think it's worth naming it accordingly.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void possiblyReplyWithSamlResponse(SamlAuthenticationState authenticationState, String statusCode, Exception e,\n          \n          \n            \n                private void possiblyReplyWithSamlFailure(SamlAuthenticationState authenticationState, String statusCode, Exception e,", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391997801", "createdAt": "2020-03-13T02:26:43Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -140,4 +123,23 @@ private void buildUserFromAuthentication(SecondaryAuthentication secondaryAuthen\n             }\n         );\n     }\n+\n+    private void possiblyReplyWithSamlResponse(SamlAuthenticationState authenticationState, String statusCode, Exception e,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4816d77cf2e48a5525b9cfb8c90308fec6165d0e"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyOTQ4MjA2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjoyNzozN1rOF11qGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjoyNzozN1rOF11qGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5Nzk3Ng==", "bodyText": "Should we log too? (it can be part of the TODO)", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391997976", "createdAt": "2020-03-13T02:27:37Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -140,4 +123,23 @@ private void buildUserFromAuthentication(SecondaryAuthentication secondaryAuthen\n             }\n         );\n     }\n+\n+    private void possiblyReplyWithSamlResponse(SamlAuthenticationState authenticationState, String statusCode, Exception e,\n+                                               ActionListener<SamlInitiateSingleSignOnResponse> listener) {\n+        if (authenticationState != null) {\n+            final FailedAuthenticationResponseMessageBuilder builder =\n+                new FailedAuthenticationResponseMessageBuilder(samlFactory, Clock.systemUTC(), identityProvider)\n+                    .setInResponseTo(authenticationState.getAuthnRequestId())\n+                    .setAcsUrl(authenticationState.getRequestedAcsUrl())\n+                    .setPrimaryStatusCode(statusCode);\n+            final Response response = builder.build();\n+            //TODO: Indicate SAML Response status is failure in the response", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4816d77cf2e48a5525b9cfb8c90308fec6165d0e"}, "originalPosition": 131}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3351, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}