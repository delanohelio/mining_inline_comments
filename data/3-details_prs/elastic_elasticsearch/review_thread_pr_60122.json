{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NzE5Mjk5", "number": 60122, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTozODoyMlrOES3z7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzowNjoxN1rOETH2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjI0MjM5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTozODoyMlrOG4SrFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoyMzowOFrOG4UjrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3OTM4MA==", "bodyText": "Should this be randomBoolean() instead of false?", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461679380", "createdAt": "2020-07-28T15:38:22Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -126,7 +133,14 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n         assertThat(snapshotInfo.successfulShards(), greaterThan(0));\n         assertThat(snapshotInfo.successfulShards(), equalTo(snapshotInfo.totalShards()));\n \n-        assertAcked(client().admin().indices().prepareDelete(indexName));\n+        assertShardFolders(indexName, false);\n+\n+        final boolean deletedBeforeMount = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e87fcb1888f482e9b1a50435c470a9cce4b662cf"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMDI1Mg==", "bodyText": "indeed. Leftover from manual testing", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461710252", "createdAt": "2020-07-28T16:23:08Z", "author": {"login": "ywelsch"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -126,7 +133,14 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n         assertThat(snapshotInfo.successfulShards(), greaterThan(0));\n         assertThat(snapshotInfo.successfulShards(), equalTo(snapshotInfo.totalShards()));\n \n-        assertAcked(client().admin().indices().prepareDelete(indexName));\n+        assertShardFolders(indexName, false);\n+\n+        final boolean deletedBeforeMount = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3OTM4MA=="}, "originalCommit": {"oid": "e87fcb1888f482e9b1a50435c470a9cce4b662cf"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjI4MDI0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTo0NzowMFrOG4TCnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoyMzoxNlrOG4Uj-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY4NTQwNA==", "bodyText": "Can we assert that we actually asserted this on the right number of nodes (or at least one node)? Just to make sure this isn't vacuous.", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461685404", "createdAt": "2020-07-28T15:47:00Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -275,6 +292,29 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n \n     }\n \n+    private void assertShardFolders(String indexName, boolean snapshotDirectory) throws IOException {\n+        final Index restoredIndex = resolveIndex(indexName);\n+        final ShardId shardId = new ShardId(restoredIndex, 0);\n+        for (String node : internalCluster().getNodeNames()) {\n+            final NodeEnvironment service = internalCluster().getInstance(NodeEnvironment.class, node);\n+            final ShardPath shardPath = ShardPath.loadShardPath(logger, service, shardId, null);\n+            if (shardPath != null && Files.exists(shardPath.getDataPath())) {\n+                assertEquals(snapshotDirectory, Files.notExists(shardPath.resolveIndex()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e87fcb1888f482e9b1a50435c470a9cce4b662cf"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMDMzMQ==", "bodyText": "good idea", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461710331", "createdAt": "2020-07-28T16:23:16Z", "author": {"login": "ywelsch"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -275,6 +292,29 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n \n     }\n \n+    private void assertShardFolders(String indexName, boolean snapshotDirectory) throws IOException {\n+        final Index restoredIndex = resolveIndex(indexName);\n+        final ShardId shardId = new ShardId(restoredIndex, 0);\n+        for (String node : internalCluster().getNodeNames()) {\n+            final NodeEnvironment service = internalCluster().getInstance(NodeEnvironment.class, node);\n+            final ShardPath shardPath = ShardPath.loadShardPath(logger, service, shardId, null);\n+            if (shardPath != null && Files.exists(shardPath.getDataPath())) {\n+                assertEquals(snapshotDirectory, Files.notExists(shardPath.resolveIndex()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY4NTQwNA=="}, "originalCommit": {"oid": "e87fcb1888f482e9b1a50435c470a9cce4b662cf"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDg2OTYyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzowNjoxN1rOG4rV_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODoxNzozOFrOG4tskQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4MzU4MQ==", "bodyText": "Ah sorry another lost randomBoolean() here, and I'm guessing that deletedBeforeMount doesn't make sense if restoring into a different index name.", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r462083581", "createdAt": "2020-07-29T07:06:17Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -77,7 +84,7 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n         final String fsRepoName = randomAlphaOfLength(10);\n         final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n         final String aliasName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n-        final String restoredIndexName = randomBoolean() ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String restoredIndexName = true ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "445fca95e8abc3db546e6353005461f04baa281c"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEyMjEyOQ==", "bodyText": "Thanks, I've updated and fixed the test to take all situations properly into account. I've also left the deletedBeforeMount + different index name situation in there (just for completeness, even if it's not the most interesting scenario to test).", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r462122129", "createdAt": "2020-07-29T08:17:38Z", "author": {"login": "ywelsch"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -77,7 +84,7 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n         final String fsRepoName = randomAlphaOfLength(10);\n         final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n         final String aliasName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n-        final String restoredIndexName = randomBoolean() ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String restoredIndexName = true ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4MzU4MQ=="}, "originalCommit": {"oid": "445fca95e8abc3db546e6353005461f04baa281c"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2148, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}