{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMzE3ODM3", "number": 55889, "title": "In field retrieval API, handle non-standard source paths.", "bodyText": "This commit adds the capability to FieldTypeLookup to retrieve a field's\npaths in the _source. When retrieving a field's values, we consult these\nsource paths to make sure we load the relevant values. This allows us to handle\nrequests for field aliases and multi-fields.\nWe also retrieve values that were copied into the field through copy_to. To me\nthis is what users would expect out of the API, and it's consistent with what\ncomes back from docvalues_fields and stored_fields. However it does add\nsome complexity, and was not something flagged as important from any of the\nclients I spoke to about this API. I'm looking for feedback on this point.\nRelates to #55363.", "createdAt": "2020-04-28T19:36:32Z", "url": "https://github.com/elastic/elasticsearch/pull/55889", "merged": true, "mergeCommit": {"oid": "e471834e8aad668055611bb74c9fc50f62c916ae"}, "closed": true, "closedAt": "2020-04-29T20:03:58Z", "author": {"login": "jtibshirani"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccKDc9gH2gAyNDEwMzE3ODM3OjEyOWUwYjdjMmU3MDNmNzkwOGJlMDQ3MTg2MDg1NjE5OWY1NmY2ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccbEaUgFqTQwMjgzNjU4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "129e0b7c2e703f7908be0471860856199f56f689", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/129e0b7c2e703f7908be0471860856199f56f689", "committedDate": "2020-04-28T20:38:47Z", "message": "Resolve field aliases and multi-fields.\n\nAlso handle values that have been copied into the field through copy_to."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4339bfd9a86f8f2b61892f2ba07e36238022d6fc", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/4339bfd9a86f8f2b61892f2ba07e36238022d6fc", "committedDate": "2020-04-28T19:34:39Z", "message": "Resolve field aliases and multi-fields.\n\nAlso handle values that have been copied into the field through copy_to."}, "afterCommit": {"oid": "129e0b7c2e703f7908be0471860856199f56f689", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/129e0b7c2e703f7908be0471860856199f56f689", "committedDate": "2020-04-28T20:38:47Z", "message": "Resolve field aliases and multi-fields.\n\nAlso handle values that have been copied into the field through copy_to."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMTgwODE5", "url": "https://github.com/elastic/elasticsearch/pull/55889#pullrequestreview-402180819", "createdAt": "2020-04-28T20:20:13Z", "commit": {"oid": "4339bfd9a86f8f2b61892f2ba07e36238022d6fc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMDoyMDoxM1rOGNlV3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQyMTowMTo0N1rOGNmxXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg5NjQ3OA==", "bodyText": "I think you can set up copy_to the same field multiple times. I imagine this won't perfectly emulate that. But that is almost certainly ok.", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r416896478", "createdAt": "2020-04-28T20:20:13Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldTypeLookup.java", "diffHunk": "@@ -80,6 +94,17 @@ public FieldTypeLookup copyAndAddAll(Collection<FieldMapper> fieldMappers,\n             if (fieldMapper instanceof DynamicKeyFieldMapper) {\n                 dynamicKeyMappers.put(fieldName, (DynamicKeyFieldMapper) fieldMapper);\n             }\n+\n+            for (String targetField : fieldMapper.copyTo().copyToFields()) {\n+                Set<String> sourcePath = sourcePaths.get(targetField);\n+                if (sourcePath == null) {\n+                    sourcePaths = sourcePaths.copyAndPut(targetField, Set.of(targetField, fieldName));\n+                } else if (sourcePath.contains(fieldName) == false) {\n+                    Set<String> newSourcePath = new HashSet<>(sourcePath);\n+                    newSourcePath.add(fieldName);\n+                    sourcePaths = sourcePaths.copyAndPut(targetField, Collections.unmodifiableSet(newSourcePath));\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4339bfd9a86f8f2b61892f2ba07e36238022d6fc"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkxOTkwMg==", "bodyText": "I wonder if this should return something that has an extractValue(SourceLookup) method on it. I'm just thinking of types constant_keyword and the formatting stuff we talked about over video. Not that now is the time to build that, but maybe this is the place to handle it.", "url": "https://github.com/elastic/elasticsearch/pull/55889#discussion_r416919902", "createdAt": "2020-04-28T21:01:47Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -602,6 +602,14 @@ public MappedFieldType fieldType(String fullName) {\n         return fieldTypes.simpleMatchToFullName(pattern);\n     }\n \n+    /**\n+     * Given a field name, returns its possible paths in the _source. For example,\n+     * the 'source path' for a multi-field is the path to its parent field.\n+     */\n+    public Set<String> sourcePath(String fullName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "129e0b7c2e703f7908be0471860856199f56f689"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyODM2NTgy", "url": "https://github.com/elastic/elasticsearch/pull/55889#pullrequestreview-402836582", "createdAt": "2020-04-29T16:28:13Z", "commit": {"oid": "129e0b7c2e703f7908be0471860856199f56f689"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 241, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}