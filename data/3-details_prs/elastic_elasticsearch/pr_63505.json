{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwMDg4OTE5", "number": 63505, "title": "Flush translog writer before adding new operation", "bodyText": "Currently we flush the Translog buffer when a new operation causes the\nbuffer to breach 1MB. This introduces a scenario where an exception is\nthrown AFTER the writer has accepted the operation. To avoid this, this\ncommit flushes the Translog in an #add call before adding a new\noperation.\nThis fixes #63299.", "createdAt": "2020-10-08T17:51:12Z", "url": "https://github.com/elastic/elasticsearch/pull/63505", "merged": true, "mergeCommit": {"oid": "dc5dbbbfe299ca125cf85850239523e3a2669af6"}, "closed": true, "closedAt": "2020-10-08T19:55:49Z", "author": {"login": "tbrooks8"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQlT05AH2gAyNTAwMDg4OTE5Ojc5YTU2MGFjMTY2N2M5OGY1MWIxY2E1ZDE3NzJkMmZmMjJjYmFjY2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQmDuUgH2gAyNTAwMDg4OTE5OjJhNjhlZjU1YjBkMjQ3NGQ2MTUxMDhkZDlhZTU1NTZmMDE4MDllMTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "79a560ac1667c98f51b1ca5d1772d2ff22cbaccf", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/79a560ac1667c98f51b1ca5d1772d2ff22cbaccf", "committedDate": "2020-10-08T17:48:10Z", "message": "Flush translog writer before adding new operation\n\nCurrently we flush the Translog buffer when a new operation causes the\nbuffer to breach 1MB. This introduces a scenario where an exception is\nthrown AFTER the writer has accepted the operation. To avoid this, this\ncommit flushes the Translog in an #add call before adding a new\noperation.\n\nThis fixes #63299."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MDUwMjEz", "url": "https://github.com/elastic/elasticsearch/pull/63505#pullrequestreview-505050213", "createdAt": "2020-10-08T18:21:19Z", "commit": {"oid": "79a560ac1667c98f51b1ca5d1772d2ff22cbaccf"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxODoyMToxOVrOHerAYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxODoyMToxOVrOHerAYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkyMzkzNg==", "bodyText": "Would it make sense to add:\nassert bufferedBytes == buffer.size()\n\n(3 lines down).", "url": "https://github.com/elastic/elasticsearch/pull/63505#discussion_r501923936", "createdAt": "2020-10-08T18:21:19Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java", "diffHunk": "@@ -185,8 +186,12 @@ private synchronized void closeWithTragicEvent(final Exception ex) {\n      * @throws IOException if writing to the translog resulted in an I/O exception\n      */\n     public Translog.Location add(final BytesReference data, final long seqNo) throws IOException {\n+        long bufferedBytesBeforeAdd = this.bufferedBytes;\n+        if (bufferedBytesBeforeAdd >= forceWriteThreshold) {\n+            writeBufferedOps(Long.MAX_VALUE, bufferedBytesBeforeAdd >= forceWriteThreshold * 4);\n+        }\n+\n         final Translog.Location location;\n-        final long bytesBufferedAfterAdd;\n         synchronized (this) {\n             ensureOpen();\n             if (buffer == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79a560ac1667c98f51b1ca5d1772d2ff22cbaccf"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a68ef55b0d2474d615108dd9ae5556f01809e13", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a68ef55b0d2474d615108dd9ae5556f01809e13", "committedDate": "2020-10-08T18:40:29Z", "message": "Add assertion"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4246, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}