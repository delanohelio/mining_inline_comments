{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMjc3MzE4", "number": 57084, "title": "Serialize Outbound Message on Flush", "bodyText": "Follow up to #56961:\nWe can be a little more efficient than just serializing at the IO loop by serializing\nonly when we flush to a channel. This has the advantage that we don't serialize a long\nqueue of messages for a channel that isn't writable for a longer period of time (unstable network,\nactually writing large volumes of data, etc.).\nAlso, this further reduces the time for which we hold on to the write buffer for a message,\nmaking allocations because of an empty page cache recycler pool less likely.", "createdAt": "2020-05-23T13:52:30Z", "url": "https://github.com/elastic/elasticsearch/pull/57084", "merged": true, "mergeCommit": {"oid": "beb3e493f3a198a480464ff8edda95332ae3c6ba"}, "closed": true, "closedAt": "2020-05-27T11:31:01Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckHMadgH2gAyNDIyMjc3MzE4OmU3MTBmZjJiM2QyYjNjODFmZTY5ZmI3MDg5NWNkODY5Mjc4YjlhYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclWyTQAH2gAyNDIyMjc3MzE4OjY0M2VlNTVmNGQzMjBiMjY5YjI3ZDE5MDdmYThhNWVmOTQxOTBjMDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e710ff2b3d2b3c81fe69fb70895cd869278b9aba", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e710ff2b3d2b3c81fe69fb70895cd869278b9aba", "committedDate": "2020-05-23T13:50:15Z", "message": "Serialize Outbound Message on Flush\n\nFollow up to #56961:\n\nWe can be a little more efficient than just serializing at the IO loop by serializing\nonly when we flush to a channel. This has the advantage that we don't serialize a long\nqueue of messages for a channel that isn't writable for a longer period of time (unstable network,\nactually writing large volumes of data, etc.).\nAlso, this further reduces the time for which we hold on to the write buffer for a message,\nmaking allocations because of an empty page cache recycler pool less likely."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MDQxNjMy", "url": "https://github.com/elastic/elasticsearch/pull/57084#pullrequestreview-419041632", "createdAt": "2020-05-27T10:01:33Z", "commit": {"oid": "e710ff2b3d2b3c81fe69fb70895cd869278b9aba"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMDowMTozM1rOGbCRPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMDowMTozM1rOGbCRPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAwMTkxOA==", "bodyText": "Can we assert context == null here?", "url": "https://github.com/elastic/elasticsearch/pull/57084#discussion_r431001918", "createdAt": "2020-05-27T10:01:33Z", "author": {"login": "DaveCTurner"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/netty4/Netty4MessageChannelHandler.java", "diffHunk": "@@ -190,13 +190,23 @@ private void failQueuedWrites() {\n \n     private static final class WriteOperation {\n \n-        private final ByteBuf buf;\n+        private ByteBuf buf;\n+\n+        private OutboundHandler.SendContext context;\n \n         private final ChannelPromise promise;\n \n-        WriteOperation(ByteBuf buf, ChannelPromise promise) {\n-            this.buf = buf;\n+        WriteOperation(OutboundHandler.SendContext context, ChannelPromise promise) {\n+            this.context = context;\n             this.promise = promise;\n         }\n+\n+        ByteBuf buffer() throws IOException {\n+            if (buf == null) {\n+                buf = Netty4Utils.toByteBuf(context.get());\n+                context = null;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e710ff2b3d2b3c81fe69fb70895cd869278b9aba"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42e64f2a22733d1efc50dff659bad225f43ad0a4", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/42e64f2a22733d1efc50dff659bad225f43ad0a4", "committedDate": "2020-05-27T10:26:40Z", "message": "Merge remote-tracking branch 'elastic/master' into even-lazier-writes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f376491c45f7a73d97a1973efed749d802a89981", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/f376491c45f7a73d97a1973efed749d802a89981", "committedDate": "2020-05-27T10:27:07Z", "message": "Merge remote-tracking branch 'elastic/master' into even-lazier-writes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "643ee55f4d320b269b27d1907fa8a5ef94190c03", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/643ee55f4d320b269b27d1907fa8a5ef94190c03", "committedDate": "2020-05-27T10:34:08Z", "message": "CR: add assertion"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4234, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}