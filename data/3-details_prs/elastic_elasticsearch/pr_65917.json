{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMTc2MDcw", "number": 65917, "title": "Do not mmap() or preload files just for the footer", "bodyText": "Today during replica shard allocation we read the checksum footer for\nevery file (#56933). By default some of these files are opened using\nmmap() and are subject to preloading if preloading is configured. This\nis rather wasteful.\nThis commit switches these open-and-read-footer operations to use\nNIOFSDirectory avoiding the unnecessary preloading step even if it is\nconfigured. This somewhat mitigates #56933, but does not resolve it\nfully since even after this change we still open many more files than we\nreally need to.", "createdAt": "2020-12-06T10:48:52Z", "url": "https://github.com/elastic/elasticsearch/pull/65917", "merged": true, "mergeCommit": {"oid": "a5b780f969ce77d409f73a3312728aafcb92c894"}, "closed": true, "closedAt": "2020-12-07T08:42:39Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjekIUAH2gAyNTMzMTc2MDcwOjFhZmEzMzgyNDAzYWRhMWJhNzgyZDM2Y2FhMmI0NDA2YzUxNjdjZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjxiZNAFqTU0NTkzMzgzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1afa3382403ada1ba782d36caa2b4406c5167ce3", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/1afa3382403ada1ba782d36caa2b4406c5167ce3", "committedDate": "2020-12-06T10:41:12Z", "message": "Do not mmap() or preload files just for the footer\n\nToday during replica shard allocation we read the checksum footer for\nevery file (#56933). By default some of these files are opened using\n`mmap()` and are subject to preloading if preloading is configured. This\nis rather wasteful.\n\nThis commit switches these open-and-read-footer operations to use\n`NIOFSDirectory` avoiding the unnecessary preloading step even if it is\nconfigured. This somewhat mitigates #56933, but does not resolve it\nfully since even after this change we still open many more files than we\nreally need to."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTI5NDk0", "url": "https://github.com/elastic/elasticsearch/pull/65917#pullrequestreview-545929494", "createdAt": "2020-12-07T08:41:09Z", "commit": {"oid": "1afa3382403ada1ba782d36caa2b4406c5167ce3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTMzODM3", "url": "https://github.com/elastic/elasticsearch/pull/65917#pullrequestreview-545933837", "createdAt": "2020-12-07T08:47:11Z", "commit": {"oid": "1afa3382403ada1ba782d36caa2b4406c5167ce3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODo0NzoxMlrOIAbzgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwODo0NzoxMlrOIAbzgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzMyNjQ2NQ==", "bodyText": "Nice to see this context useful :)", "url": "https://github.com/elastic/elasticsearch/pull/65917#discussion_r537326465", "createdAt": "2020-12-07T08:47:12Z", "author": {"login": "tlrx"}, "path": "server/src/main/java/org/elasticsearch/index/store/FsDirectoryFactory.java", "diffHunk": "@@ -149,7 +149,13 @@ public void close() throws IOException {\n             IOUtils.close(super::close, delegate);\n         }\n \n-        boolean useDelegate(String name) {\n+        boolean useDelegate(String name, IOContext ioContext) {\n+            if (ioContext == Store.READONCE_CHECKSUM) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1afa3382403ada1ba782d36caa2b4406c5167ce3"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4022, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}