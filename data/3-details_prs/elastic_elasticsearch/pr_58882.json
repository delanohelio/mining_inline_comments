{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzMDIyNDYw", "number": 58882, "title": "Eagerly compile condition script at processor creation", "bodyText": "Ingest script processors were changed to eagerly compile their scripts\nwhen the ingest pipeline is saved, but conditional scripts were missed.\nThis commit adds eager compilation to ingest conditional scripts, which\nwill help surface errors before runtime, as well as adds tests for each\ncase we might encounter between inline and stored script compilation\nfailures.", "createdAt": "2020-07-01T22:17:42Z", "url": "https://github.com/elastic/elasticsearch/pull/58882", "merged": true, "mergeCommit": {"oid": "a5d2f8b55aad172a166dbaf6fb0c90ff46ad5ad0"}, "closed": true, "closedAt": "2020-07-02T17:10:35Z", "author": {"login": "rjernst"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwx0OFAH2gAyNDQzMDIyNDYwOjM3ZmMzNTdkMjY5YTVjNzQ4ZGJkM2M2YjY5YjY5MmI4NjkzNjNkMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwzMqPAH2gAyNDQzMDIyNDYwOjhjOTE3OWJiNTkzYzRjMmQ4NGI3NmNlNWNjOTIwNGIxZTg3ZTAyNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "37fc357d269a5c748dbd3c6b69b692b869363d22", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/37fc357d269a5c748dbd3c6b69b692b869363d22", "committedDate": "2020-07-01T22:16:50Z", "message": "Eagerly compile condition script at processor creation\n\nIngest script processors were changed to eagerly compile their scripts\nwhen the ingest pipeline is saved, but conditional scripts were missed.\nThis commit adds eager compilation to ingest conditional scripts, which\nwill help surface errors before runtime, as well as adds tests for each\ncase we might encounter between inline and stored script compilation\nfailures.\n\ncloses #58864"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9d23354cc1ba239d4481309f29b298b204ead6a", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/a9d23354cc1ba239d4481309f29b298b204ead6a", "committedDate": "2020-07-01T22:28:12Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjQ0NTEy", "url": "https://github.com/elastic/elasticsearch/pull/58882#pullrequestreview-441244512", "createdAt": "2020-07-01T22:52:21Z", "commit": {"oid": "a9d23354cc1ba239d4481309f29b298b204ead6a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjo1MjoyMVrOGr3zGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjo1Mjo0NlrOGr3zmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjE1NA==", "bodyText": "should the other test code use this too?", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448656154", "createdAt": "2020-07-01T22:52:21Z", "author": {"login": "talevy"}, "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "diffHunk": "@@ -39,4 +43,30 @@ public MockScriptService(Settings settings, Map<String, ScriptEngine> engines, M\n     boolean compilationLimitsEnabled() {\n         return false;\n     }\n+\n+    public static <T> MockScriptService singleContext(ScriptContext<T> context, Function<String, T> compile,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9d23354cc1ba239d4481309f29b298b204ead6a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY1NjI4Mw==", "bodyText": "compilation issue here?", "url": "https://github.com/elastic/elasticsearch/pull/58882#discussion_r448656283", "createdAt": "2020-07-01T22:52:46Z", "author": {"login": "talevy"}, "path": "test/framework/src/main/java/org/elasticsearch/script/MockScriptService.java", "diffHunk": "@@ -39,4 +43,30 @@ public MockScriptService(Settings settings, Map<String, ScriptEngine> engines, M\n     boolean compilationLimitsEnabled() {\n         return false;\n     }\n+\n+    public static <T> MockScriptService singleContext(ScriptContext<T> context, Function<String, T> compile,\n+                                                      Map<String, StoredScriptSource> storedLookup) {\n+        ScriptEngine engine = new ScriptEngine() {\n+            @Override\n+            public String getType() {\n+                return \"lang\";\n+            }\n+\n+            @Override\n+            public <FactoryType> FactoryType compile(String name, String code, ScriptContext<FactoryType> context, Map<String, String> params) {\n+                return context.factoryClazz.cast(compile.apply(code));\n+            }\n+\n+            @Override\n+            public Set<ScriptContext<?>> getSupportedContexts() {\n+                return Set.of(context);\n+            }\n+        };\n+        return new MockScriptService(Settings.EMPTY, Map.of(\"lang\", engine), Map.of(context.name, context)) {\n+            @Override\n+            public StoredScriptSource getScriptFromClusterState(String id) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9d23354cc1ba239d4481309f29b298b204ead6a"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16f54aa31b0137f3e6886c569eaad05cf1d64b6b", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/16f54aa31b0137f3e6886c569eaad05cf1d64b6b", "committedDate": "2020-07-01T23:08:22Z", "message": "fix test compile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c9179bb593c4c2d84b76ce5cc9204b1e87e0246", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c9179bb593c4c2d84b76ce5cc9204b1e87e0246", "committedDate": "2020-07-01T23:53:26Z", "message": "checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2361, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}