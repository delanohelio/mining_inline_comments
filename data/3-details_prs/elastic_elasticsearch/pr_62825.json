{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxNzUwNzE1", "number": 62825, "title": "Fail with correct error if first backing index exists when auto creating data stream", "bodyText": "Today if a data stream is auto created, but an index with same name as the\nfirst backing index already exists then internally that error is ignored,\nwhich then later results in the execution of a bulk request, the\nbulk item fails due to that the data stream hasn't been auto created.\nThis situation can only occur if an index with same is created that\nwill be the backing index of a data stream prior to the creation\nof the data stream.\nI think this erroneous situation is an edge case, but irregardless of that\nI think the correct error should be returned.", "createdAt": "2020-09-23T12:38:38Z", "url": "https://github.com/elastic/elasticsearch/pull/62825", "merged": true, "mergeCommit": {"oid": "bd8da2ae9f180d4e2c030923795272ae27c91575"}, "closed": true, "closedAt": "2020-09-24T12:48:24Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLr27bgH2gAyNDkxNzUwNzE1OjdjNTBiNmU5N2YxMGIyZjU3ZTFiYmVkOGE2Y2ExYWFkYTE3OTFjYTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL9yisgH2gAyNDkxNzUwNzE1OjgyODE4ZWI1MTBmMzcxNDU4MDk4ZDUwZTc0NDE4Y2NmZmM3OWYxMzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c50b6e97f10b2f57e1bbed8a6ca1aada1791ca8", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c50b6e97f10b2f57e1bbed8a6ca1aada1791ca8", "committedDate": "2020-09-23T12:36:19Z", "message": "Fail with correct error if first backing index exists when auto creating data stream.\n\nToday if a data stream is auto created, but an index with same name as the\nfirst backing index already exists then internally that error is ignored,\nwhich then result that later in the execution of a bulk request, the\nbulk item fails due to that the data stream hasn't been auto created.\n\nThis situation can only occur if an index with same is created that\nwill be the backing index of a data stream prior to the creation\nof the data stream."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0Njc1NjY1", "url": "https://github.com/elastic/elasticsearch/pull/62825#pullrequestreview-494675665", "createdAt": "2020-09-23T13:44:32Z", "commit": {"oid": "7c50b6e97f10b2f57e1bbed8a6ca1aada1791ca8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMzo0NDozMlrOHWvLxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMzo0NDozMlrOHWvLxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYwMzc4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new ElasticsearchStatusException(\"data stream could not be created, because backing index [{}] already exists\",\n          \n          \n            \n                        throw new ElasticsearchStatusException(\"data stream could not be created because backing index [{}] already exists\",", "url": "https://github.com/elastic/elasticsearch/pull/62825#discussion_r493603782", "createdAt": "2020-09-23T13:44:32Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateDataStreamService.java", "diffHunk": "@@ -147,7 +149,15 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n             new CreateIndexClusterStateUpdateRequest(\"initialize_data_stream\", firstBackingIndexName, firstBackingIndexName)\n                 .dataStreamName(request.name)\n                 .settings(Settings.builder().put(\"index.hidden\", true).build());\n-        currentState = metadataCreateIndexService.applyCreateIndexRequest(currentState, createIndexRequest, false);\n+        try {\n+            currentState = metadataCreateIndexService.applyCreateIndexRequest(currentState, createIndexRequest, false);\n+        } catch (ResourceAlreadyExistsException e) {\n+            // Rethrow as ElasticsearchStatusException, so that bulk transport action doesn't ignore it during\n+            // auto index/data stream creation.\n+            // (otherwise bulk execution fails later, because data stream will also not have been created)\n+            throw new ElasticsearchStatusException(\"data stream could not be created, because backing index [{}] already exists\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c50b6e97f10b2f57e1bbed8a6ca1aada1791ca8"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac9e06cab0b41869070dbc6f70b1f74519bf343c", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/ac9e06cab0b41869070dbc6f70b1f74519bf343c", "committedDate": "2020-09-23T14:00:43Z", "message": "adjust wording of the exception message\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a59b21c55f57b42e41c90aceb7e50da73ffb7e88", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a59b21c55f57b42e41c90aceb7e50da73ffb7e88", "committedDate": "2020-09-23T14:06:28Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b124fd4d44e77b55b7736688f8bdd235a0da861", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1b124fd4d44e77b55b7736688f8bdd235a0da861", "committedDate": "2020-09-23T14:06:44Z", "message": "Merge remote-tracking branch 'es/master' into fail_with_descriptive_error_if_backing_index_already_exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd27530d5e928011ad9a98aefd5eca3e760051b4", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd27530d5e928011ad9a98aefd5eca3e760051b4", "committedDate": "2020-09-23T14:30:42Z", "message": "adjust tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "422742e99df726a9ed18e9d91a4481b3dade59b5", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/422742e99df726a9ed18e9d91a4481b3dade59b5", "committedDate": "2020-09-23T14:35:48Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4496245ebb7727723ce675abd22f26f0dfe81cc", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4496245ebb7727723ce675abd22f26f0dfe81cc", "committedDate": "2020-09-24T08:24:35Z", "message": "Merge branch 'master' into fail_with_descriptive_error_if_backing_index_already_exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82818eb510f371458098d50e74418ccffc79f133", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/82818eb510f371458098d50e74418ccffc79f133", "committedDate": "2020-09-24T09:29:49Z", "message": "Merge branch 'master' into fail_with_descriptive_error_if_backing_index_already_exists"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4743, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}