{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MjQ0MDQy", "number": 53572, "title": "[Transform] enhance the output of preview to return full destination index details", "bodyText": "changes the output format of preview regarding deduced mappings and enhances it to return all the details about auto-index creation. This allows the user to customize the index creation. Using HLRC you can create a index request from the output of the response. Long term this allows us to add UI support, see elastic/kibana#57059 and/or improve setting defaults.\nThe output of the preview itself is not affected. The UI does not use/display mappings at the moment (CC @walterra )\nBreaking:\n\nsupported:\n\nmixed clusters internal communication, all versions\nHLRC >=7.7 <-> <7.7\n\n\nnot supported:\n\nHRLC <7.7  <-> >=7.7 (mappings are parsed as empty)\n\n\n\nNew format:\n{ \n    \"preview\": [\n       ...\n    ],\n    \"generated_dest_index\": {\n        \"mappings\" : {\n        ...\n        },\n        \"settings\": {\n            \"index\" : {\n                \"number_of_shards\" : 1,\n                \"auto_expand_replicas\" : \"0-1\",\n                ...\n            }\n        },\n        \"aliases\": {}\n    }\n}\n\nPlease raise concerns about the naming: generated_dest_index.\nOld format:\n{ \n    \"preview\": [\n       ...\n    ],\n    \"mappings\" : {\n       ...\n    }\n}", "createdAt": "2020-03-14T10:04:03Z", "url": "https://github.com/elastic/elasticsearch/pull/53572", "merged": true, "mergeCommit": {"oid": "fa6d197e7bea7b7bd39731883d81f41d0cafd13e"}, "closed": true, "closedAt": "2020-03-17T20:05:51Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNiC9RAH2gAyMzg4MjQ0MDQyOmI0NjZmYjA1OGJhNTlhYjM5ZDRjMTk4NjVjYjJhZTE4YzZjZWVlNGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOOhBtAH2gAyMzg4MjQ0MDQyOjU5MGM4YjdhNWRlNzVhMjUyZjJjZjVmNjJhNWYzZDI4NWNhYjM3YWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b466fb058ba59ab39d4c19865cb2ae18c6ceee4b", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/b466fb058ba59ab39d4c19865cb2ae18c6ceee4b", "committedDate": "2020-03-14T10:07:06Z", "message": "expose all details about destination index creation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5dd8013e06740b92f992ec2bd2472f5ea15b26a2", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/5dd8013e06740b92f992ec2bd2472f5ea15b26a2", "committedDate": "2020-03-13T21:02:48Z", "message": "re-activate test"}, "afterCommit": {"oid": "b466fb058ba59ab39d4c19865cb2ae18c6ceee4b", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/b466fb058ba59ab39d4c19865cb2ae18c6ceee4b", "committedDate": "2020-03-14T10:07:06Z", "message": "expose all details about destination index creation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTM3NjYw", "url": "https://github.com/elastic/elasticsearch/pull/53572#pullrequestreview-375137660", "createdAt": "2020-03-16T11:52:22Z", "commit": {"oid": "b466fb058ba59ab39d4c19865cb2ae18c6ceee4b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMTo1MjoyMlrOF2wiiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMTo1MjoyMlrOF2wiiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk2MjY5OQ==", "bodyText": "This feels like debug to me.", "url": "https://github.com/elastic/elasticsearch/pull/53572#discussion_r392962699", "createdAt": "2020-03-16T11:52:22Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/persistence/TransformIndex.java", "diffHunk": "@@ -10,99 +10,135 @@\n import org.apache.logging.log4j.Logger;\n import org.elasticsearch.Version;\n import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.admin.indices.alias.Alias;\n import org.elasticsearch.action.admin.indices.create.CreateIndexAction;\n import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n import org.elasticsearch.client.Client;\n import org.elasticsearch.cluster.metadata.IndexMetaData;\n import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.common.xcontent.XContentBuilder;\n import org.elasticsearch.xpack.core.transform.TransformField;\n import org.elasticsearch.xpack.core.transform.TransformMessages;\n import org.elasticsearch.xpack.core.transform.transforms.TransformConfig;\n+import org.elasticsearch.xpack.core.transform.transforms.TransformDestIndexSettings;\n \n-import java.io.IOException;\n import java.time.Clock;\n+import java.util.HashMap;\n import java.util.Map;\n-import java.util.Map.Entry;\n-\n-import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n-import static org.elasticsearch.index.mapper.MapperService.SINGLE_MAPPING_NAME;\n+import java.util.Set;\n \n public final class TransformIndex {\n     private static final Logger logger = LogManager.getLogger(TransformIndex.class);\n \n     private static final String PROPERTIES = \"properties\";\n-    private static final String TYPE = \"type\";\n     private static final String META = \"_meta\";\n \n-    private TransformIndex() {\n-    }\n+    private TransformIndex() {}\n \n-    public static void createDestinationIndex(Client client,\n-                                              Clock clock,\n-                                              TransformConfig transformConfig,\n-                                              Map<String, String> mappings,\n-                                              ActionListener<Boolean> listener) {\n+    public static void createDestinationIndex(\n+        Client client,\n+        TransformConfig transformConfig,\n+        TransformDestIndexSettings destIndexSettings,\n+        ActionListener<Boolean> listener\n+    ) {\n         CreateIndexRequest request = new CreateIndexRequest(transformConfig.getDestination().getIndex());\n \n-        // TODO: revisit number of shards, number of replicas\n-        request.settings(Settings.builder() // <1>\n-                .put(IndexMetaData.SETTING_NUMBER_OF_SHARDS, 1)\n-                .put(IndexMetaData.SETTING_AUTO_EXPAND_REPLICAS, \"0-1\"));\n-\n-        request.mapping(createMappingXContent(mappings, transformConfig.getId(), clock));\n-\n-        client.execute(CreateIndexAction.INSTANCE, request, ActionListener.wrap(createIndexResponse -> {\n-            listener.onResponse(true);\n-        }, e -> {\n-            String message = TransformMessages.getMessage(TransformMessages.FAILED_TO_CREATE_DESTINATION_INDEX,\n-                    transformConfig.getDestination().getIndex(), transformConfig.getId());\n-            logger.error(message);\n-            listener.onFailure(new RuntimeException(message, e));\n-        }));\n-    }\n-\n-    private static XContentBuilder createMappingXContent(Map<String, String> mappings,\n-                                                         String id,\n-                                                         Clock clock) {\n-        try {\n-            XContentBuilder builder = jsonBuilder().startObject();\n-            builder.startObject(SINGLE_MAPPING_NAME);\n-            addProperties(builder, mappings);\n-            addMetaData(builder, id, clock);\n-            builder.endObject(); // _doc type\n-            return builder.endObject();\n-        } catch (IOException e) {\n-            throw new RuntimeException(e);\n+        request.settings(destIndexSettings.getSettings());\n+        request.mapping(destIndexSettings.getMappings());\n+        for (Alias alias : destIndexSettings.getAliases()) {\n+            request.alias(alias);\n         }\n+\n+        client.execute(\n+            CreateIndexAction.INSTANCE,\n+            request,\n+            ActionListener.wrap(createIndexResponse -> { listener.onResponse(true); }, e -> {\n+                String message = TransformMessages.getMessage(\n+                    TransformMessages.FAILED_TO_CREATE_DESTINATION_INDEX,\n+                    transformConfig.getDestination().getIndex(),\n+                    transformConfig.getId()\n+                );\n+                logger.error(message);\n+                listener.onFailure(new RuntimeException(message, e));\n+            })\n+        );\n     }\n \n-    private static XContentBuilder addProperties(XContentBuilder builder,\n-                                                 Map<String, String> mappings) throws IOException {\n-        builder.startObject(PROPERTIES);\n-        for (Entry<String, String> field : mappings.entrySet()) {\n-            String fieldName = field.getKey();\n-            String fieldType = field.getValue();\n+    public static TransformDestIndexSettings createTransformDestIndexSettings(Map<String, String> mappings, String id, Clock clock) {\n+        Map<String, Object> indexMappings = new HashMap<>();\n+        indexMappings.put(PROPERTIES, createMappingsFromStringMap(mappings));\n+        indexMappings.put(META, createMetaData(id, clock));\n \n-            builder.startObject(fieldName);\n-            builder.field(TYPE, fieldType);\n+        Settings settings = createSettings();\n \n-            builder.endObject();\n-        }\n-        builder.endObject(); // PROPERTIES\n-        return builder;\n+        // transform does not create aliases, however the user might customize this in future\n+        Set<Alias> aliases = null;\n+        logger.info(\"mapping {} setting {}\", indexMappings, settings);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b466fb058ba59ab39d4c19865cb2ae18c6ceee4b"}, "originalPosition": 121}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "590c8b7a5de75a252f2cf5f62a5f3d285cab37ae", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/590c8b7a5de75a252f2cf5f62a5f3d285cab37ae", "committedDate": "2020-03-16T13:55:46Z", "message": "fix tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1414, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}