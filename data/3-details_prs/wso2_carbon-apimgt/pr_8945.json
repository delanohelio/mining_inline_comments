{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MzkyNTgy", "number": 8945, "title": "Provide the ability to configure gateway startup", "bodyText": "Goal:\n\n\nResolves wso2/product-apim#8611\n\n\nRelated to wso2/product-apim#8246\n\n\nAdding a config of gateway_startup\n\n\nApproach:\n\n\nBy default gateway Startup will be in a Synchronous manner. Here the server will wait until all the APIs been deployed. If there is any failure in the deployment, it will again be triggered for n times where n is the maximum retry count. If the APIs are not deployed even in n retries then the server will start with un deployed API artifacts.\n\n\nIf the user wants to switch the startup mode to an Asynchronous mode then he needs to specify it in the configs as gateway_startup= \"async\". Here the server will be up, independent of the deployment of synapse artifacts in gateway.", "createdAt": "2020-07-07T12:52:18Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8945", "merged": true, "mergeCommit": {"oid": "c76fdc7771a0891417782dc7e67df2c67dec8701"}, "closed": true, "closedAt": "2020-07-10T08:39:23Z", "author": {"login": "Sarangan0219"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyi0lLAH2gAyNDQ1MzkyNTgyOmMxYTA4OTEzOWUwMjAyZjYyM2FjZDU4NGQyNzM0MTk4YzM1OTYxODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczfg7zgFqTQ0NjIyNDc0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c1a089139e0202f623acd584d2734198c3596186", "author": {"user": {"login": "Sarangan0219", "name": "Sarangan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/c1a089139e0202f623acd584d2734198c3596186", "committedDate": "2020-07-07T09:56:30Z", "message": "Adding a validation for Artifact synchrnonizer feature in gateway Startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ced4e3722b46202905cbeebdefc7b1437cca06d", "author": {"user": {"login": "Sarangan0219", "name": "Sarangan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/7ced4e3722b46202905cbeebdefc7b1437cca06d", "committedDate": "2020-07-07T12:39:37Z", "message": "Adding a config for gatway startup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTEwNDYw", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#pullrequestreview-444110460", "createdAt": "2020-07-07T17:36:56Z", "commit": {"oid": "7ced4e3722b46202905cbeebdefc7b1437cca06d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzozNjo1NlrOGuI4Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo0MjowN1rOGuJDyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMzE2Nw==", "bodyText": "equals otherway", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#discussion_r451033167", "createdAt": "2020-07-07T17:36:56Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -69,13 +70,22 @@ private boolean deployArtifactsAtStartup() {\n         boolean flag = false;\n         if (gatewayArtifactSynchronizerProperties.isRetrieveFromStorageEnabled()) {\n             InMemoryAPIDeployer inMemoryAPIDeployer = new InMemoryAPIDeployer();\n-            flag = inMemoryAPIDeployer.deployAllAPIsAtGatewayStartup(gatewayArtifactSynchronizerProperties.getGatewayLabels());\n+            flag = inMemoryAPIDeployer.deployAllAPIsAtGatewayStartup(gatewayArtifactSynchronizerProperties\n+                    .getGatewayLabels());\n         }\n         return flag;\n     }\n \n     @Override\n     public void completedServerStartup() {\n+        if (gatewayArtifactSynchronizerProperties.isRetrieveFromStorageEnabled()) {\n+            if (gatewayArtifactSynchronizerProperties.getGatewayStartup()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ced4e3722b46202905cbeebdefc7b1437cca06d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMzMxNA==", "bodyText": "constant.equals", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#discussion_r451033314", "createdAt": "2020-07-07T17:37:10Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -69,13 +70,22 @@ private boolean deployArtifactsAtStartup() {\n         boolean flag = false;\n         if (gatewayArtifactSynchronizerProperties.isRetrieveFromStorageEnabled()) {\n             InMemoryAPIDeployer inMemoryAPIDeployer = new InMemoryAPIDeployer();\n-            flag = inMemoryAPIDeployer.deployAllAPIsAtGatewayStartup(gatewayArtifactSynchronizerProperties.getGatewayLabels());\n+            flag = inMemoryAPIDeployer.deployAllAPIsAtGatewayStartup(gatewayArtifactSynchronizerProperties\n+                    .getGatewayLabels());\n         }\n         return flag;\n     }\n \n     @Override\n     public void completedServerStartup() {\n+        if (gatewayArtifactSynchronizerProperties.isRetrieveFromStorageEnabled()) {\n+            if (gatewayArtifactSynchronizerProperties.getGatewayStartup()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMzE2Nw=="}, "originalCommit": {"oid": "7ced4e3722b46202905cbeebdefc7b1437cca06d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMzkyMA==", "bodyText": "does this needed", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#discussion_r451033920", "createdAt": "2020-07-07T17:38:13Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -38,6 +39,7 @@\n     private JMSTransportHandler jmsTransportHandlerForTrafficManager;\n     private JMSTransportHandler jmsTransportHandlerForEventHub;\n     private GatewayArtifactSynchronizerProperties gatewayArtifactSynchronizerProperties;\n+    private boolean isAPIsDeployedInSyncMode = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ced4e3722b46202905cbeebdefc7b1437cca06d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzNDM4NA==", "bodyText": "no need to have if condition since it decided to go in sync.", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#discussion_r451034384", "createdAt": "2020-07-07T17:39:04Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -84,7 +94,14 @@ public void completedServerStartup() {\n                 new APIMgtGatewayCacheMessageListener());\n         jmsTransportHandlerForEventHub\n                 .subscribeForJmsEvents(APIConstants.TopicNames.TOPIC_NOTIFICATION, new GatewayJMSMessageListener());\n+    }\n \n+    private void deployAPIsInSyncMode() {\n+        isAPIsDeployedInSyncMode = deployArtifactsAtStartup();\n+        if (!isAPIsDeployedInSyncMode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ced4e3722b46202905cbeebdefc7b1437cca06d"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzNTQzNA==", "bodyText": "startupConfigElement -> Retrieval Mode ?\n@pubudu538 ?", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#discussion_r451035434", "createdAt": "2020-07-07T17:40:54Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIManagerConfiguration.java", "diffHunk": "@@ -1677,6 +1677,15 @@ private void setRuntimeArtifactsSyncGatewayConfig (OMElement omElement){\n             log.debug(\"Retry Duration Element is not set. Set to default duaration\");\n         }\n \n+        OMElement startupConfigElement = omElement.getFirstChildWithName(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ced4e3722b46202905cbeebdefc7b1437cca06d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzNjEwNQ==", "bodyText": "gateway_startup -> mode ?", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#discussion_r451036105", "createdAt": "2020-07-07T17:42:07Z", "author": {"login": "tharindu1st"}, "path": "features/apimgt/org.wso2.carbon.apimgt.core.feature/src/main/resources/conf_templates/templates/repository/conf/api-manager.xml.j2", "diffHunk": "@@ -1247,6 +1247,9 @@\n         {% if apim.sync_runtime_artifacts.gateway.deployment_retry_duartion is defined %}\n         <RetryDuration>{{apim.sync_runtime_artifacts.gateway.deployment_retry_duartion}}</RetryDuration>\n         {% endif %}\n+        {% if apim.sync_runtime_artifacts.gateway.gateway_startup is defined %}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ced4e3722b46202905cbeebdefc7b1437cca06d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bbfb8183a8e67798e75c4b43436bb9c833a4c31", "author": {"user": {"login": "Sarangan0219", "name": "Sarangan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/8bbfb8183a8e67798e75c4b43436bb9c833a4c31", "committedDate": "2020-07-08T03:31:17Z", "message": "refractor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "617f40f555c67d89b6ac37cbe6717829ae62ae90", "author": {"user": {"login": "Sarangan0219", "name": "Sarangan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/617f40f555c67d89b6ac37cbe6717829ae62ae90", "committedDate": "2020-07-08T03:38:28Z", "message": "refractor code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1", "author": {"user": {"login": "Sarangan0219", "name": "Sarangan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1", "committedDate": "2020-07-08T10:50:10Z", "message": "rename config variable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NjU2Mjc2", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#pullrequestreview-444656276", "createdAt": "2020-07-08T11:34:01Z", "commit": {"oid": "dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjM3MjI4", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#pullrequestreview-445637228", "createdAt": "2020-07-09T13:52:21Z", "commit": {"oid": "dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzo1MjoyMVrOGvSKSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzo1MjoyMVrOGvSKSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIzMzgwMg==", "bodyText": "Since this method gets called multiple times, need to put some logs to identify how many times it was called.", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#discussion_r452233802", "createdAt": "2020-07-09T13:52:21Z", "author": {"login": "jaadds"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -84,7 +93,14 @@ public void completedServerStartup() {\n                 new APIMgtGatewayCacheMessageListener());\n         jmsTransportHandlerForEventHub\n                 .subscribeForJmsEvents(APIConstants.TopicNames.TOPIC_NOTIFICATION, new GatewayJMSMessageListener());\n+    }\n \n+    private void deployAPIsInSyncMode() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjM5Njgy", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#pullrequestreview-445639682", "createdAt": "2020-07-09T13:55:02Z", "commit": {"oid": "dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzo1NTowMlrOGvSReA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzo1NTowMlrOGvSReA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIzNTY0MA==", "bodyText": "I feel we need to configure a retry limit rather than retrying indefinitely. With infinite retrying there'd be a constant load on the underlying storage and a few failed APIs can exhaust the storage fairly quickly.", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#discussion_r452235640", "createdAt": "2020-07-09T13:55:02Z", "author": {"login": "jaadds"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -84,7 +93,14 @@ public void completedServerStartup() {\n                 new APIMgtGatewayCacheMessageListener());\n         jmsTransportHandlerForEventHub\n                 .subscribeForJmsEvents(APIConstants.TopicNames.TOPIC_NOTIFICATION, new GatewayJMSMessageListener());\n+    }\n \n+    private void deployAPIsInSyncMode() {\n+        isAPIsDeployedInSyncMode = deployArtifactsAtStartup();\n+        if (!isAPIsDeployedInSyncMode) {\n+            log.error(\"Unable to deploy synapse artifacts at gateway\");\n+            deployAPIsInSyncMode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzExMDMz", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#pullrequestreview-445711033", "createdAt": "2020-07-09T15:08:50Z", "commit": {"oid": "dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNTowODo1MFrOGvVlNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNTowODo1MFrOGvVlNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI4OTg0NA==", "bodyText": "As discussed offline let's limit the retries and proceed with startup in case of a failure.", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#discussion_r452289844", "createdAt": "2020-07-09T15:08:50Z", "author": {"login": "jaadds"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/listeners/GatewayStartupListener.java", "diffHunk": "@@ -84,7 +93,14 @@ public void completedServerStartup() {\n                 new APIMgtGatewayCacheMessageListener());\n         jmsTransportHandlerForEventHub\n                 .subscribeForJmsEvents(APIConstants.TopicNames.TOPIC_NOTIFICATION, new GatewayJMSMessageListener());\n+    }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzU3NTk0", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#pullrequestreview-445757594", "createdAt": "2020-07-09T16:00:40Z", "commit": {"oid": "dfeccf937e8c48b78ccfe0de83e8e04686c1b1f1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae40fd8c53d3812a64ea9c97d69bb8600ff81a52", "author": {"user": {"login": "Sarangan0219", "name": "Sarangan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/ae40fd8c53d3812a64ea9c97d69bb8600ff81a52", "committedDate": "2020-07-10T04:28:52Z", "message": "Adding retry limit for sync deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e62c1fcc3a0891eaf379eff1e191d80648f6a14", "author": {"user": {"login": "Sarangan0219", "name": "Sarangan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/1e62c1fcc3a0891eaf379eff1e191d80648f6a14", "committedDate": "2020-07-10T04:32:21Z", "message": "Adding logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MTg3OTAx", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#pullrequestreview-446187901", "createdAt": "2020-07-10T07:40:50Z", "commit": {"oid": "1e62c1fcc3a0891eaf379eff1e191d80648f6a14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MjI0NzQx", "url": "https://github.com/wso2/carbon-apimgt/pull/8945#pullrequestreview-446224741", "createdAt": "2020-07-10T08:39:15Z", "commit": {"oid": "1e62c1fcc3a0891eaf379eff1e191d80648f6a14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2562, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}