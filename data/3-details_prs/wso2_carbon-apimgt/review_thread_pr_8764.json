{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MTcyMzky", "number": 8764, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNTo0NjoyM1rOEGM6JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNTo1Mjo0MVrOEGM_QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0OTM4NDA0OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/kmclient/model/BearerInterceptor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNTo0NjoyM1rOGk2c3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNTo0NjoyM1rOGk2c3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI5NDA0NA==", "bodyText": "we could use constants in the APIConstant class. AUTHORIZATION_HEADER_DEFAULT, AUTHORIZATION_BEARER are there", "url": "https://github.com/wso2/carbon-apimgt/pull/8764#discussion_r441294044", "createdAt": "2020-06-17T05:46:23Z", "author": {"login": "chamilaadhi"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/kmclient/model/BearerInterceptor.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package org.wso2.carbon.apimgt.impl.kmclient.model;\n+\n+import feign.RequestInterceptor;\n+import feign.RequestTemplate;\n+import org.wso2.carbon.apimgt.impl.APIConstants;\n+import org.wso2.carbon.apimgt.impl.recommendationmgt.AccessTokenGenerator;\n+\n+public class BearerInterceptor implements RequestInterceptor {\n+\n+    private AccessTokenGenerator accessTokenGenerator;\n+\n+    public BearerInterceptor(AccessTokenGenerator accessTokenGenerator) {\n+\n+        this.accessTokenGenerator = accessTokenGenerator;\n+    }\n+\n+    @Override\n+    public void apply(RequestTemplate requestTemplate) {\n+\n+        String accessToken = accessTokenGenerator.getAccessToken(APIConstants.KEY_MANAGER_OAUTH2_REST_API_MGT_SCOPES);\n+        requestTemplate.header(\"Authorization\", \"Bearer \" + accessToken);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "815de6f460727cc71b9054aeab3ce71f4792c2f0"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0OTM5NzEzOnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/AMDefaultKeyManagerImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNTo1Mjo0MVrOGk2k0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwNzoyOTo1M1rOGmK9Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI5NjA4Mg==", "bodyText": "I think having the version hardcorded in the URL could cause some maintenance issues. (will have to change this every release)", "url": "https://github.com/wso2/carbon-apimgt/pull/8764#discussion_r441296082", "createdAt": "2020-06-17T05:52:41Z", "author": {"login": "chamilaadhi"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/AMDefaultKeyManagerImpl.java", "diffHunk": "@@ -515,86 +445,94 @@ private OAuthApplicationInfo buildDTOFromClientInfo(ClientInfo appResponse,\n         return oAuthApplicationInfo;\n     }\n \n-    /**\n-     * This method initialize the HTTP Client and Connection Manager to call services in KeyManager.\n-     *\n-     * @throws APIManagementException if an error occurs while initializing HttpClient\n-     */\n-    protected void initializeHttpClient() throws APIManagementException {\n-\n-        try {\n-            String authServerURL = (String) configuration.getParameter(APIConstants.AUTHSERVER_URL);\n-            java.net.URL keyManagerURL = new java.net.URL(authServerURL);\n-            int keyManagerPort = keyManagerURL.getPort();\n-            String keyManagerProtocol = keyManagerURL.getProtocol();\n-            this.kmHttpClient = (CloseableHttpClient) APIUtil.getHttpClient(keyManagerPort, keyManagerProtocol);\n-        } catch (MalformedURLException e) {\n-            throw new APIManagementException(\"Error while initializing HttpClient due to malformed URL\", e);\n-        }\n-    }\n-\n     @Override\n     public void loadConfiguration(KeyManagerConfiguration configuration) throws APIManagementException {\n+\n         this.configuration = configuration;\n-        //Initialize a Http Client and Connection Manager using the ServerURL of KM\n-        initializeHttpClient();\n \n         String consumerKey = (String) configuration.getParameter(APIConstants.KEY_MANAGER_CONSUMER_KEY);\n         String consumerSecret = (String) configuration.getParameter(APIConstants.KEY_MANAGER_CONSUMER_SECRET);\n         String keyManagerServiceUrl = (String) configuration.getParameter(APIConstants.AUTHSERVER_URL);\n-        String tokenEndpoint = keyManagerServiceUrl.split(\"/\" + APIConstants.SERVICES_URL_RELATIVE_PATH)[0].concat(\n-                \"/oauth2/token\");\n-        String revokeEndpoint = keyManagerServiceUrl.split(\"/\" + APIConstants.SERVICES_URL_RELATIVE_PATH)[0].concat(\n-                \"/oauth2/revoke\");\n-        accessTokenGenerator = new AccessTokenGenerator(tokenEndpoint,revokeEndpoint,consumerKey,consumerSecret);\n \n-        try {\n-            java.net.URL keyManagerServicesURL = new java.net.URL(keyManagerServiceUrl);\n-            int keyManagerPort = keyManagerServicesURL.getPort();\n-            String keyManagerProtocol = keyManagerServicesURL.getProtocol();\n-            String keyManagerHost = keyManagerServicesURL.getHost();\n-            String keyManagerURL = keyManagerProtocol.concat(\"://\").concat(keyManagerHost);\n-            if (keyManagerPort != 0) {\n-                keyManagerURL = keyManagerURL.concat(\":\").concat(Integer.toString(keyManagerPort));\n-            }\n-            String authEndpoint = tokenEndpoint.replace(\"/token\", \"\");\n-            revokeEndpoint = revokeEndpoint.replace(\"/revoke\", \"\");\n-\n-            dcrClient = Feign.builder()\n-                    .client(new OkHttpClient())\n-                    .encoder(new GsonEncoder())\n-                    .decoder(new GsonDecoder())\n-                    .logger(new Slf4jLogger())\n-                    .errorDecoder(new KMClientErrorDecoder())\n-                    .target(DCRClient.class, keyManagerURL);\n-            authClient = Feign.builder()\n-                    .client(new OkHttpClient())\n-                    .encoder(new GsonEncoder())\n-                    .decoder(new GsonDecoder())\n-                    .logger(new Slf4jLogger())\n-                    .errorDecoder(new KMClientErrorDecoder()    )\n-                    .encoder(new FormEncoder())\n-                    .target(AuthClient.class, authEndpoint);\n-            revokeClient = Feign.builder()\n-                    .client(new OkHttpClient())\n-                    .encoder(new GsonEncoder())\n-                    .decoder(new GsonDecoder())\n-                    .logger(new Slf4jLogger())\n-                    .errorDecoder(new KMClientErrorDecoder()    )\n-                    .encoder(new FormEncoder())\n-                    .target(AuthClient.class, revokeEndpoint);\n-            introspectionClient = Feign.builder()\n-                    .client(new OkHttpClient())\n-                    .encoder(new GsonEncoder())\n-                    .decoder(new GsonDecoder())\n-                    .logger(new Slf4jLogger())\n-                    .errorDecoder(new KMClientErrorDecoder())\n-                    .encoder(new FormEncoder())\n-                    .target(IntrospectionClient.class, keyManagerURL.concat(\"/oauth2/introspect\"));\n-\n-        } catch (MalformedURLException e) {\n-            log.error(\"Error in parsing the Key Validator URL provided: \" + keyManagerServiceUrl, e);\n+        String dcrEndpoint;\n+        if (configuration.getParameter(APIConstants.KeyManager.CLIENT_REGISTRATION_ENDPOINT) != null) {\n+            dcrEndpoint = (String) configuration.getParameter(APIConstants.KeyManager.CLIENT_REGISTRATION_ENDPOINT);\n+        } else {\n+            dcrEndpoint = keyManagerServiceUrl.split(\"/\" + APIConstants.SERVICES_URL_RELATIVE_PATH)[0]\n+                    .concat(getTenantAwareContext().trim()).concat(\"/api/identity/oauth2/dcr/v1.1/register\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "815de6f460727cc71b9054aeab3ce71f4792c2f0"}, "originalPosition": 307}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjY3ODU5OQ==", "bodyText": "this might be ok since we have option to read from configuration", "url": "https://github.com/wso2/carbon-apimgt/pull/8764#discussion_r442678599", "createdAt": "2020-06-19T07:29:53Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/AMDefaultKeyManagerImpl.java", "diffHunk": "@@ -515,86 +445,94 @@ private OAuthApplicationInfo buildDTOFromClientInfo(ClientInfo appResponse,\n         return oAuthApplicationInfo;\n     }\n \n-    /**\n-     * This method initialize the HTTP Client and Connection Manager to call services in KeyManager.\n-     *\n-     * @throws APIManagementException if an error occurs while initializing HttpClient\n-     */\n-    protected void initializeHttpClient() throws APIManagementException {\n-\n-        try {\n-            String authServerURL = (String) configuration.getParameter(APIConstants.AUTHSERVER_URL);\n-            java.net.URL keyManagerURL = new java.net.URL(authServerURL);\n-            int keyManagerPort = keyManagerURL.getPort();\n-            String keyManagerProtocol = keyManagerURL.getProtocol();\n-            this.kmHttpClient = (CloseableHttpClient) APIUtil.getHttpClient(keyManagerPort, keyManagerProtocol);\n-        } catch (MalformedURLException e) {\n-            throw new APIManagementException(\"Error while initializing HttpClient due to malformed URL\", e);\n-        }\n-    }\n-\n     @Override\n     public void loadConfiguration(KeyManagerConfiguration configuration) throws APIManagementException {\n+\n         this.configuration = configuration;\n-        //Initialize a Http Client and Connection Manager using the ServerURL of KM\n-        initializeHttpClient();\n \n         String consumerKey = (String) configuration.getParameter(APIConstants.KEY_MANAGER_CONSUMER_KEY);\n         String consumerSecret = (String) configuration.getParameter(APIConstants.KEY_MANAGER_CONSUMER_SECRET);\n         String keyManagerServiceUrl = (String) configuration.getParameter(APIConstants.AUTHSERVER_URL);\n-        String tokenEndpoint = keyManagerServiceUrl.split(\"/\" + APIConstants.SERVICES_URL_RELATIVE_PATH)[0].concat(\n-                \"/oauth2/token\");\n-        String revokeEndpoint = keyManagerServiceUrl.split(\"/\" + APIConstants.SERVICES_URL_RELATIVE_PATH)[0].concat(\n-                \"/oauth2/revoke\");\n-        accessTokenGenerator = new AccessTokenGenerator(tokenEndpoint,revokeEndpoint,consumerKey,consumerSecret);\n \n-        try {\n-            java.net.URL keyManagerServicesURL = new java.net.URL(keyManagerServiceUrl);\n-            int keyManagerPort = keyManagerServicesURL.getPort();\n-            String keyManagerProtocol = keyManagerServicesURL.getProtocol();\n-            String keyManagerHost = keyManagerServicesURL.getHost();\n-            String keyManagerURL = keyManagerProtocol.concat(\"://\").concat(keyManagerHost);\n-            if (keyManagerPort != 0) {\n-                keyManagerURL = keyManagerURL.concat(\":\").concat(Integer.toString(keyManagerPort));\n-            }\n-            String authEndpoint = tokenEndpoint.replace(\"/token\", \"\");\n-            revokeEndpoint = revokeEndpoint.replace(\"/revoke\", \"\");\n-\n-            dcrClient = Feign.builder()\n-                    .client(new OkHttpClient())\n-                    .encoder(new GsonEncoder())\n-                    .decoder(new GsonDecoder())\n-                    .logger(new Slf4jLogger())\n-                    .errorDecoder(new KMClientErrorDecoder())\n-                    .target(DCRClient.class, keyManagerURL);\n-            authClient = Feign.builder()\n-                    .client(new OkHttpClient())\n-                    .encoder(new GsonEncoder())\n-                    .decoder(new GsonDecoder())\n-                    .logger(new Slf4jLogger())\n-                    .errorDecoder(new KMClientErrorDecoder()    )\n-                    .encoder(new FormEncoder())\n-                    .target(AuthClient.class, authEndpoint);\n-            revokeClient = Feign.builder()\n-                    .client(new OkHttpClient())\n-                    .encoder(new GsonEncoder())\n-                    .decoder(new GsonDecoder())\n-                    .logger(new Slf4jLogger())\n-                    .errorDecoder(new KMClientErrorDecoder()    )\n-                    .encoder(new FormEncoder())\n-                    .target(AuthClient.class, revokeEndpoint);\n-            introspectionClient = Feign.builder()\n-                    .client(new OkHttpClient())\n-                    .encoder(new GsonEncoder())\n-                    .decoder(new GsonDecoder())\n-                    .logger(new Slf4jLogger())\n-                    .errorDecoder(new KMClientErrorDecoder())\n-                    .encoder(new FormEncoder())\n-                    .target(IntrospectionClient.class, keyManagerURL.concat(\"/oauth2/introspect\"));\n-\n-        } catch (MalformedURLException e) {\n-            log.error(\"Error in parsing the Key Validator URL provided: \" + keyManagerServiceUrl, e);\n+        String dcrEndpoint;\n+        if (configuration.getParameter(APIConstants.KeyManager.CLIENT_REGISTRATION_ENDPOINT) != null) {\n+            dcrEndpoint = (String) configuration.getParameter(APIConstants.KeyManager.CLIENT_REGISTRATION_ENDPOINT);\n+        } else {\n+            dcrEndpoint = keyManagerServiceUrl.split(\"/\" + APIConstants.SERVICES_URL_RELATIVE_PATH)[0]\n+                    .concat(getTenantAwareContext().trim()).concat(\"/api/identity/oauth2/dcr/v1.1/register\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI5NjA4Mg=="}, "originalCommit": {"oid": "815de6f460727cc71b9054aeab3ce71f4792c2f0"}, "originalPosition": 307}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3279, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}