{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMDY4NTYx", "number": 8873, "title": "Added REST API to update scope mapping.", "bodyText": "Fix wso2/product-apim#8201", "createdAt": "2020-06-28T14:58:07Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8873", "merged": true, "mergeCommit": {"oid": "7388d4a8876fd36dc8ca4c094ed567e750353040"}, "closed": true, "closedAt": "2020-07-13T04:08:50Z", "author": {"login": "Meruja"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvtrt0AH2gAyNDQxMDY4NTYxOjllYjdlMTRkMDBiMGRmMGZkNjM3NTZiM2EwMzAwYzRiMzQ3MGE1ZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0ZcSUAFqTQ0Njk2OTQyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/9eb7e14d00b0df0fd63756b3a0300c4b3470a5de", "committedDate": "2020-06-28T14:54:00Z", "message": "Added REST API to update scope mapping."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5Njk1NTI4", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-439695528", "createdAt": "2020-06-30T06:08:18Z", "commit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjowODoxOFrOGqtDRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjowODoxOFrOGqtDRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQzMTQ5NA==", "bodyText": "Remove additional line", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r447431494", "createdAt": "2020-06-30T06:08:18Z", "author": {"login": "HiranyaKavishani"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +80,47 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext) throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(RestApiUtil.getLoggedInUsername());\n+        //read from tenant-conf.json\n+        JsonObject existingTenantConfObject = new JsonObject();\n+        try {\n+            APIMRegistryService apimRegistryService = new APIMRegistryServiceImpl();\n+            String existingTenantConf = apimRegistryService.getConfigRegistryResourceContent(tenantDomain,\n+                    APIConstants.API_TENANT_CONF_LOCATION);\n+             existingTenantConfObject = new JsonParser().parse(existingTenantConf).getAsJsonObject();\n+        } catch (RegistryException | UserStoreException e) {\n+            APIUtil.handleException(\"Couldn't read tenant configuration from tenant registry\", e);\n+        }\n+        try {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5Njk2NjE0", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-439696614", "createdAt": "2020-06-30T06:10:57Z", "commit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjoxMDo1N1rOGqtG1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjoxMDo1N1rOGqtG1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQzMjQwNw==", "bodyText": "Why return null here?", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r447432407", "createdAt": "2020-06-30T06:10:57Z", "author": {"login": "HiranyaKavishani"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +80,47 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext) throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(RestApiUtil.getLoggedInUsername());\n+        //read from tenant-conf.json\n+        JsonObject existingTenantConfObject = new JsonObject();\n+        try {\n+            APIMRegistryService apimRegistryService = new APIMRegistryServiceImpl();\n+            String existingTenantConf = apimRegistryService.getConfigRegistryResourceContent(tenantDomain,\n+                    APIConstants.API_TENANT_CONF_LOCATION);\n+             existingTenantConfObject = new JsonParser().parse(existingTenantConf).getAsJsonObject();\n+        } catch (RegistryException | UserStoreException e) {\n+            APIUtil.handleException(\"Couldn't read tenant configuration from tenant registry\", e);\n+        }\n+        try {\n+\n+            JSONObject responseJson = new JSONObject();\n+            JSONArray scopeJson = new JSONArray();\n+\n+            for(int i = 0; i < body.getList().size(); i++) {\n+                JSONObject scopeRoleJson = new JSONObject();\n+                scopeRoleJson.put(\"Name\", body.getList().get(i).getName());\n+                scopeRoleJson.put(\"Roles\", body.getList().get(i).getRoles());\n+                scopeJson.put(scopeRoleJson);\n+            }\n+\n+            responseJson.put(\"Scope\", scopeJson);\n+            //Here we are removing RESTAPIScopes from the existing tenant-conf\n+            // Adding new RESTAPIScopes to the existing tenant-conf.\n+            existingTenantConfObject.remove(\"RESTAPIScopes\");\n+            Gson gson = new Gson();\n+            existingTenantConfObject.add(\"RESTAPIScopes\",\n+                    gson.fromJson(responseJson.toString(), JsonElement.class));\n+            APIUtil.updateTenantConf(existingTenantConfObject.toString(),tenantDomain);\n+            Map<String, String> scopeRoleMapping = APIUtil.getRESTAPIScopesForTenant(MultitenantUtils\n+                    .getTenantDomain(RestApiUtil.getLoggedInUsername()));\n+            ScopeListDTO scopeListDTO = SystemScopesMappingUtil.fromScopeListToScopeListDTO(scopeRoleMapping);\n+            return Response.ok().entity(scopeListDTO).build();\n+        } catch (APIManagementException e) {\n+            String errorMessage = \"Error when updating the list of scopes-role mapping.\";\n+            RestApiUtil.handleInternalServerError(errorMessage, e, log);\n+        }\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5Njk3NzA1", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-439697705", "createdAt": "2020-06-30T06:13:16Z", "commit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjoxMzoxNlrOGqtKUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjoxMzoxNlrOGqtKUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQzMzI5OA==", "bodyText": "Use a For-each loop", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r447433298", "createdAt": "2020-06-30T06:13:16Z", "author": {"login": "HiranyaKavishani"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +80,47 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext) throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(RestApiUtil.getLoggedInUsername());\n+        //read from tenant-conf.json\n+        JsonObject existingTenantConfObject = new JsonObject();\n+        try {\n+            APIMRegistryService apimRegistryService = new APIMRegistryServiceImpl();\n+            String existingTenantConf = apimRegistryService.getConfigRegistryResourceContent(tenantDomain,\n+                    APIConstants.API_TENANT_CONF_LOCATION);\n+             existingTenantConfObject = new JsonParser().parse(existingTenantConf).getAsJsonObject();\n+        } catch (RegistryException | UserStoreException e) {\n+            APIUtil.handleException(\"Couldn't read tenant configuration from tenant registry\", e);\n+        }\n+        try {\n+\n+            JSONObject responseJson = new JSONObject();\n+            JSONArray scopeJson = new JSONArray();\n+\n+            for(int i = 0; i < body.getList().size(); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzAxOTk0", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-439701994", "createdAt": "2020-06-30T06:22:34Z", "commit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjoyMjozNFrOGqtZCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjoyMjozNFrOGqtZCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQzNzA2Ng==", "bodyText": "Can't we do this without using gson library?", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r447437066", "createdAt": "2020-06-30T06:22:34Z", "author": {"login": "HiranyaKavishani"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +80,47 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext) throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(RestApiUtil.getLoggedInUsername());\n+        //read from tenant-conf.json\n+        JsonObject existingTenantConfObject = new JsonObject();\n+        try {\n+            APIMRegistryService apimRegistryService = new APIMRegistryServiceImpl();\n+            String existingTenantConf = apimRegistryService.getConfigRegistryResourceContent(tenantDomain,\n+                    APIConstants.API_TENANT_CONF_LOCATION);\n+             existingTenantConfObject = new JsonParser().parse(existingTenantConf).getAsJsonObject();\n+        } catch (RegistryException | UserStoreException e) {\n+            APIUtil.handleException(\"Couldn't read tenant configuration from tenant registry\", e);\n+        }\n+        try {\n+\n+            JSONObject responseJson = new JSONObject();\n+            JSONArray scopeJson = new JSONArray();\n+\n+            for(int i = 0; i < body.getList().size(); i++) {\n+                JSONObject scopeRoleJson = new JSONObject();\n+                scopeRoleJson.put(\"Name\", body.getList().get(i).getName());\n+                scopeRoleJson.put(\"Roles\", body.getList().get(i).getRoles());\n+                scopeJson.put(scopeRoleJson);\n+            }\n+\n+            responseJson.put(\"Scope\", scopeJson);\n+            //Here we are removing RESTAPIScopes from the existing tenant-conf\n+            // Adding new RESTAPIScopes to the existing tenant-conf.\n+            existingTenantConfObject.remove(\"RESTAPIScopes\");\n+            Gson gson = new Gson();\n+            existingTenantConfObject.add(\"RESTAPIScopes\",\n+                    gson.fromJson(responseJson.toString(), JsonElement.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODYzODY1", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-439863865", "createdAt": "2020-06-30T10:01:57Z", "commit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDowMTo1OFrOGq1OyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDowMTo1OFrOGq1OyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU2NTUxMg==", "bodyText": "We don't need to catch APIManagementException from the REST API layer. Throw it from the method", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r447565512", "createdAt": "2020-06-30T10:01:58Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +80,47 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext) throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(RestApiUtil.getLoggedInUsername());\n+        //read from tenant-conf.json\n+        JsonObject existingTenantConfObject = new JsonObject();\n+        try {\n+            APIMRegistryService apimRegistryService = new APIMRegistryServiceImpl();\n+            String existingTenantConf = apimRegistryService.getConfigRegistryResourceContent(tenantDomain,\n+                    APIConstants.API_TENANT_CONF_LOCATION);\n+             existingTenantConfObject = new JsonParser().parse(existingTenantConf).getAsJsonObject();\n+        } catch (RegistryException | UserStoreException e) {\n+            APIUtil.handleException(\"Couldn't read tenant configuration from tenant registry\", e);\n+        }\n+        try {\n+\n+            JSONObject responseJson = new JSONObject();\n+            JSONArray scopeJson = new JSONArray();\n+\n+            for(int i = 0; i < body.getList().size(); i++) {\n+                JSONObject scopeRoleJson = new JSONObject();\n+                scopeRoleJson.put(\"Name\", body.getList().get(i).getName());\n+                scopeRoleJson.put(\"Roles\", body.getList().get(i).getRoles());\n+                scopeJson.put(scopeRoleJson);\n+            }\n+\n+            responseJson.put(\"Scope\", scopeJson);\n+            //Here we are removing RESTAPIScopes from the existing tenant-conf\n+            // Adding new RESTAPIScopes to the existing tenant-conf.\n+            existingTenantConfObject.remove(\"RESTAPIScopes\");\n+            Gson gson = new Gson();\n+            existingTenantConfObject.add(\"RESTAPIScopes\",\n+                    gson.fromJson(responseJson.toString(), JsonElement.class));\n+            APIUtil.updateTenantConf(existingTenantConfObject.toString(),tenantDomain);\n+            Map<String, String> scopeRoleMapping = APIUtil.getRESTAPIScopesForTenant(MultitenantUtils\n+                    .getTenantDomain(RestApiUtil.getLoggedInUsername()));\n+            ScopeListDTO scopeListDTO = SystemScopesMappingUtil.fromScopeListToScopeListDTO(scopeRoleMapping);\n+            return Response.ok().entity(scopeListDTO).build();\n+        } catch (APIManagementException e) {\n+            String errorMessage = \"Error when updating the list of scopes-role mapping.\";\n+            RestApiUtil.handleInternalServerError(errorMessage, e, log);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODY0NDQ3", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-439864447", "createdAt": "2020-06-30T10:02:46Z", "commit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDowMjo0NlrOGq1QiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDowMjo0NlrOGq1QiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU2NTk2MQ==", "bodyText": "Formatting issue", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r447565961", "createdAt": "2020-06-30T10:02:46Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +80,47 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext) throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(RestApiUtil.getLoggedInUsername());\n+        //read from tenant-conf.json\n+        JsonObject existingTenantConfObject = new JsonObject();\n+        try {\n+            APIMRegistryService apimRegistryService = new APIMRegistryServiceImpl();\n+            String existingTenantConf = apimRegistryService.getConfigRegistryResourceContent(tenantDomain,\n+                    APIConstants.API_TENANT_CONF_LOCATION);\n+             existingTenantConfObject = new JsonParser().parse(existingTenantConf).getAsJsonObject();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODcwMzIx", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-439870321", "createdAt": "2020-06-30T10:10:52Z", "commit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDoxMDo1M1rOGq1ieQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDoxMDo1M1rOGq1ieQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU3MDU1Mw==", "bodyText": "Can you create a new class SystemScopeMappingUtils and move this logic there and use it from the REST API Layer. This is the typical flow we follow. We should not merge REST API and business logics and include in the same method", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r447570553", "createdAt": "2020-06-30T10:10:53Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +80,47 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext) throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(RestApiUtil.getLoggedInUsername());\n+        //read from tenant-conf.json\n+        JsonObject existingTenantConfObject = new JsonObject();\n+        try {\n+            APIMRegistryService apimRegistryService = new APIMRegistryServiceImpl();\n+            String existingTenantConf = apimRegistryService.getConfigRegistryResourceContent(tenantDomain,\n+                    APIConstants.API_TENANT_CONF_LOCATION);\n+             existingTenantConfObject = new JsonParser().parse(existingTenantConf).getAsJsonObject();\n+        } catch (RegistryException | UserStoreException e) {\n+            APIUtil.handleException(\"Couldn't read tenant configuration from tenant registry\", e);\n+        }\n+        try {\n+\n+            JSONObject responseJson = new JSONObject();\n+            JSONArray scopeJson = new JSONArray();\n+\n+            for(int i = 0; i < body.getList().size(); i++) {\n+                JSONObject scopeRoleJson = new JSONObject();\n+                scopeRoleJson.put(\"Name\", body.getList().get(i).getName());\n+                scopeRoleJson.put(\"Roles\", body.getList().get(i).getRoles());\n+                scopeJson.put(scopeRoleJson);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODczMzY4", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-439873368", "createdAt": "2020-06-30T10:15:14Z", "commit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDoxNToxNFrOGq1sGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDoxNToxNFrOGq1sGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU3MzAxNg==", "bodyText": "When updating the tenant conf in the registry, make sure to update with a formatted version.", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r447573016", "createdAt": "2020-06-30T10:15:14Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +80,47 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext) throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(RestApiUtil.getLoggedInUsername());\n+        //read from tenant-conf.json\n+        JsonObject existingTenantConfObject = new JsonObject();\n+        try {\n+            APIMRegistryService apimRegistryService = new APIMRegistryServiceImpl();\n+            String existingTenantConf = apimRegistryService.getConfigRegistryResourceContent(tenantDomain,\n+                    APIConstants.API_TENANT_CONF_LOCATION);\n+             existingTenantConfObject = new JsonParser().parse(existingTenantConf).getAsJsonObject();\n+        } catch (RegistryException | UserStoreException e) {\n+            APIUtil.handleException(\"Couldn't read tenant configuration from tenant registry\", e);\n+        }\n+        try {\n+\n+            JSONObject responseJson = new JSONObject();\n+            JSONArray scopeJson = new JSONArray();\n+\n+            for(int i = 0; i < body.getList().size(); i++) {\n+                JSONObject scopeRoleJson = new JSONObject();\n+                scopeRoleJson.put(\"Name\", body.getList().get(i).getName());\n+                scopeRoleJson.put(\"Roles\", body.getList().get(i).getRoles());\n+                scopeJson.put(scopeRoleJson);\n+            }\n+\n+            responseJson.put(\"Scope\", scopeJson);\n+            //Here we are removing RESTAPIScopes from the existing tenant-conf\n+            // Adding new RESTAPIScopes to the existing tenant-conf.\n+            existingTenantConfObject.remove(\"RESTAPIScopes\");\n+            Gson gson = new Gson();\n+            existingTenantConfObject.add(\"RESTAPIScopes\",\n+                    gson.fromJson(responseJson.toString(), JsonElement.class));\n+            APIUtil.updateTenantConf(existingTenantConfObject.toString(),tenantDomain);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb7e14d00b0df0fd63756b3a0300c4b3470a5de"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb70f77436644437fd4b9c5bc9bb61b39453e8ed", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/bb70f77436644437fd4b9c5bc9bb61b39453e8ed", "committedDate": "2020-07-01T09:28:38Z", "message": "Fixed review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTkxMjcz", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-444591273", "createdAt": "2020-07-08T09:55:34Z", "commit": {"oid": "bb70f77436644437fd4b9c5bc9bb61b39453e8ed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDk4ODky", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-445098892", "createdAt": "2020-07-08T20:19:09Z", "commit": {"oid": "bb70f77436644437fd4b9c5bc9bb61b39453e8ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDoxOTowOVrOGu3y_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDoxOTowOVrOGu3y_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgwMTg1NA==", "bodyText": "Let's not omit 'e' please. Shall we include it in the thrown APIManagementException?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new APIManagementException(\"Error while formatting tenant-conf.json of tenant \");\n          \n          \n            \n                        throw new APIManagementException(\"Error while formatting tenant-conf.json of tenant\", e);", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r451801854", "createdAt": "2020-07-08T20:19:09Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +85,44 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext)\n+            throws APIManagementException {\n+        String tenantDomain = MultitenantUtils.getTenantDomain(RestApiUtil.getLoggedInUsername());\n+        //read from tenant-conf.json\n+        JsonObject existingTenantConfObject = new JsonObject();\n+        try {\n+            APIMRegistryService apimRegistryService = new APIMRegistryServiceImpl();\n+            String existingTenantConf = apimRegistryService.getConfigRegistryResourceContent(tenantDomain,\n+                    APIConstants.API_TENANT_CONF_LOCATION);\n+            existingTenantConfObject = new JsonParser().parse(existingTenantConf).getAsJsonObject();\n+        } catch (RegistryException | UserStoreException e) {\n+            APIUtil.handleException(\"Couldn't read tenant configuration from tenant registry\", e);\n+        }\n+        JSONObject responseJson = SystemScopesMappingUtil.createJsonObjectOfScopeMapping(body);\n+        //Here we are removing RESTAPIScopes from the existing tenant-conf\n+        // Adding new RESTAPIScopes to the existing tenant-conf.\n+        existingTenantConfObject.remove(APIConstants.REST_API_SCOPES_CONFIG);\n+        JsonElement jsonElement = new JsonParser().parse(responseJson.toJSONString());\n+        existingTenantConfObject.add(APIConstants.REST_API_SCOPES_CONFIG, jsonElement);\n+        try {\n+            ObjectMapper mapper = new ObjectMapper();\n+            String formattedTenantConf = mapper.writerWithDefaultPrettyPrinter()\n+                    .writeValueAsString(existingTenantConfObject.toString());\n+            APIUtil.updateTenantConf(existingTenantConfObject.toString(), tenantDomain);\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Finalized tenant-conf.json: \" + formattedTenantConf);\n+            }\n+        } catch (JsonProcessingException e) {\n+            throw new APIManagementException(\"Error while formatting tenant-conf.json of tenant \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb70f77436644437fd4b9c5bc9bb61b39453e8ed"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTAwMDkz", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-445100093", "createdAt": "2020-07-08T20:21:05Z", "commit": {"oid": "bb70f77436644437fd4b9c5bc9bb61b39453e8ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDoyMTowNVrOGu32tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDoyMTowNVrOGu32tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgwMjgwNg==", "bodyText": "This is too much business logic into the REST API layer. Shall we think of splitting this into core methods and calling them from here and reduce the number of lines in here?", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r451802806", "createdAt": "2020-07-08T20:21:05Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -71,4 +85,44 @@ public Response systemScopesGet(MessageContext messageContext) throws APIManagem\n         }\n         return null;\n     }\n+\n+    public Response updateRolesForScope(ScopeListDTO body, MessageContext messageContext)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb70f77436644437fd4b9c5bc9bb61b39453e8ed"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7a380e28a58e5361d16cff9129b80e4a51fae2b", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/a7a380e28a58e5361d16cff9129b80e4a51fae2b", "committedDate": "2020-07-10T08:32:02Z", "message": "Fixed review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTU3MDM4", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-446957038", "createdAt": "2020-07-13T03:14:43Z", "commit": {"oid": "a7a380e28a58e5361d16cff9129b80e4a51fae2b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMzoxNDo0M1rOGwaI6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMzoxNTowOVrOGwaJYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQxMzA5OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void editTenantConfOfRoleScopeMapping(JSONObject responseJson, String username)\n          \n          \n            \n                public void updateTenantConfScopeRoleMapping(JSONObject newScopeRoleJson, String username)", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r453413099", "createdAt": "2020-07-13T03:14:43Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -8890,4 +8893,42 @@ private JSONObject getSecurityAuditConfigurationProperties(String tenantDomain)\n         }\n         return removedReusedResources;\n     }\n+\n+    @Override\n+    public void editTenantConfOfRoleScopeMapping(JSONObject responseJson, String username)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7a380e28a58e5361d16cff9129b80e4a51fae2b"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQxMzIxNg==", "bodyText": "Let's move this method to APIUtil.java as a static method", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r453413216", "createdAt": "2020-07-13T03:15:09Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -8890,4 +8893,42 @@ private JSONObject getSecurityAuditConfigurationProperties(String tenantDomain)\n         }\n         return removedReusedResources;\n     }\n+\n+    @Override\n+    public void editTenantConfOfRoleScopeMapping(JSONObject responseJson, String username)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQxMzA5OQ=="}, "originalCommit": {"oid": "a7a380e28a58e5361d16cff9129b80e4a51fae2b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7898dfbfc4b5b82408bcd356b2b6a4716ea663b", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/b7898dfbfc4b5b82408bcd356b2b6a4716ea663b", "committedDate": "2020-07-13T03:37:20Z", "message": "Moved the method to util class."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTY0OTU0", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-446964954", "createdAt": "2020-07-13T03:49:39Z", "commit": {"oid": "29b3575f99639d4cd2ad8e9d5f10336a2dade6c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMzo0OTozOVrOGwalJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMzo0OTozOVrOGwalJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyMDMyNA==", "bodyText": "Remove imports", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r453420324", "createdAt": "2020-07-13T03:49:39Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -21,6 +21,9 @@\n import com.fasterxml.jackson.core.JsonProcessingException;\n import com.fasterxml.jackson.databind.ObjectMapper;\n import com.google.gson.Gson;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonParser;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b3575f99639d4cd2ad8e9d5f10336a2dade6c3"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTY1MDI5", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-446965029", "createdAt": "2020-07-13T03:50:01Z", "commit": {"oid": "29b3575f99639d4cd2ad8e9d5f10336a2dade6c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMzo1MDowMVrOGwalZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwMzo1MDowMVrOGwalZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyMDM5MA==", "bodyText": "Remove import", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#discussion_r453420390", "createdAt": "2020-07-13T03:50:01Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SystemScopesApiServiceImpl.java", "diffHunk": "@@ -17,14 +32,14 @@\n import org.wso2.carbon.apimgt.rest.api.admin.v1.dto.ScopeSettingsDTO;\n import org.wso2.carbon.apimgt.rest.api.admin.v1.utils.mappings.SystemScopesMappingUtil;\n import org.wso2.carbon.apimgt.rest.api.util.utils.RestApiUtil;\n+import org.wso2.carbon.registry.core.exceptions.RegistryException;\n+import org.wso2.carbon.user.api.UserStoreException;\n import org.wso2.carbon.utils.multitenancy.MultitenantUtils;\n \n import java.util.Base64;\n-import java.util.List;\n-\n-import java.io.InputStream;\n import java.util.Map;\n \n+import javax.cache.Caching;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b3575f99639d4cd2ad8e9d5f10336a2dade6c3"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d65d6584f817c1441320ef2a21757e2dc56eaf4", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/5d65d6584f817c1441320ef2a21757e2dc56eaf4", "committedDate": "2020-07-13T04:03:12Z", "message": "Removed unnecessary imports."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29b3575f99639d4cd2ad8e9d5f10336a2dade6c3", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/29b3575f99639d4cd2ad8e9d5f10336a2dade6c3", "committedDate": "2020-07-13T03:38:54Z", "message": "Merge branch 'master' into admin-rest-api"}, "afterCommit": {"oid": "5d65d6584f817c1441320ef2a21757e2dc56eaf4", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/5d65d6584f817c1441320ef2a21757e2dc56eaf4", "committedDate": "2020-07-13T04:03:12Z", "message": "Removed unnecessary imports."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "699394c4a6264e87239272c4d63d4109995b6174", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/699394c4a6264e87239272c4d63d4109995b6174", "committedDate": "2020-07-13T04:05:26Z", "message": "Merge branch 'master' into admin-rest-api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTY5NDI4", "url": "https://github.com/wso2/carbon-apimgt/pull/8873#pullrequestreview-446969428", "createdAt": "2020-07-13T04:08:40Z", "commit": {"oid": "699394c4a6264e87239272c4d63d4109995b6174"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2613, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}