{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMTEzNjc5", "number": 8999, "title": "Fix throttling issue in websocket APIs when using JWT tokens", "bodyText": "Fixes wso2/product-apim#8718", "createdAt": "2020-07-17T13:08:47Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8999", "merged": true, "mergeCommit": {"oid": "358cf72474718907403d916970ac3f166a88baac"}, "closed": true, "closedAt": "2020-07-21T03:55:24Z", "author": {"login": "ChamodDamitha"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1zjDjgH2gAyNDUxMTEzNjc5OjNhYWUzNjQ4YmEzOTVkMDY0Mzg5YjBkZTE0YTIwNTc3ZTBhMTFiNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc2wHiSAFqTQ1MTUyODY5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3aae3648ba395d064389b0de14a20577e0a11b44", "author": {"user": {"login": "ChamodDamitha", "name": "Chamod Damitha Samarajeewa"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/3aae3648ba395d064389b0de14a20577e0a11b44", "committedDate": "2020-07-17T13:07:31Z", "message": "Fix throttling issue in websocket APIs when using JWT tokens"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNDk5MjA0", "url": "https://github.com/wso2/carbon-apimgt/pull/8999#pullrequestreview-451499204", "createdAt": "2020-07-20T10:52:01Z", "commit": {"oid": "3aae3648ba395d064389b0de14a20577e0a11b44"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMDo1MjowMVrOG0F34A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMDo1NjowMVrOG0GB3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzI3NTM2MA==", "bodyText": "can we append the km name here?", "url": "https://github.com/wso2/carbon-apimgt/pull/8999#discussion_r457275360", "createdAt": "2020-07-20T10:52:01Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java", "diffHunk": "@@ -322,64 +322,34 @@ public AuthenticationContext authenticateForWebSocket(SignedJWT jwtToken, String\n         }\n \n         if (jwtValidationInfo != null && jwtValidationInfo.isValid()) {\n-            net.minidev.json.JSONObject api =\n-                    GatewayUtils.validateAPISubscription(apiContext, apiVersion, jwtValidationInfo,\n-                            jwtHeader, true);\n-            if (api == null) {\n-                boolean validateSubscriptionViaKM = Boolean.parseBoolean(\n-                        ServiceReferenceHolder.getInstance().getAPIManagerConfiguration()\n-                                .getFirstProperty(APIConstants.JWT_AUTHENTICATION_SUBSCRIPTION_VALIDATION)\n-                                                                        );\n-                if (validateSubscriptionViaKM) {\n-                    log.debug(\"Begin subscription validation via Key Manager\");\n-                    APIKeyValidationInfoDTO apiKeyValidationInfoDTO = validateSubscriptionUsingKeyManager(apiContext,\n-                            apiVersion, jwtValidationInfo);\n-\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(\"Subscription validation via Key Manager. Status: \" +\n-                                apiKeyValidationInfoDTO.isAuthorized());\n-                    }\n-                    if (apiKeyValidationInfoDTO.isAuthorized()) {\n-                        log.debug(\"JWT authentication successful.\");\n-                        String endUserToken;\n-                        if (jwtGenerationEnabled) {\n-                            JWTInfoDto jwtInfoDto;\n-                            try {\n-                                jwtInfoDto =\n-                                        GatewayUtils.generateJWTInfoDto(jwtValidationInfo, api, apiKeyValidationInfoDTO,\n-                                                apiContext, apiVersion);\n-                                endUserToken = generateAndRetrieveJWTToken(tokenSignature, jwtInfoDto);\n-                                return GatewayUtils\n-                                        .generateAuthenticationContext(tokenSignature, jwtValidationInfo, null,\n-                                                apiKeyValidationInfoDTO, getApiLevelPolicy(), endUserToken, true);\n-                            } catch (ParseException e) {\n-                                throw new APISecurityException(APISecurityConstants.API_AUTH_GENERAL_ERROR,\n-                                        APISecurityConstants.API_AUTH_GENERAL_ERROR_MESSAGE);\n-                            }\n-                        }\n-                    } else {\n-                        log.debug(\"User is NOT authorized to access the Resource. API Subscription validation failed.\");\n-                        throw new APISecurityException(apiKeyValidationInfoDTO.getValidationStatus(),\n-                                \"User is NOT authorized to access the Resource. API Subscription validation failed.\");\n-                    }\n-                }\n-                log.debug(\"Ignored subscription validation\");\n+            log.debug(\"Begin subscription validation via Key Manager\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aae3648ba395d064389b0de14a20577e0a11b44"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzI3NTUwMw==", "bodyText": "here as well", "url": "https://github.com/wso2/carbon-apimgt/pull/8999#discussion_r457275503", "createdAt": "2020-07-20T10:52:15Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java", "diffHunk": "@@ -322,64 +322,34 @@ public AuthenticationContext authenticateForWebSocket(SignedJWT jwtToken, String\n         }\n \n         if (jwtValidationInfo != null && jwtValidationInfo.isValid()) {\n-            net.minidev.json.JSONObject api =\n-                    GatewayUtils.validateAPISubscription(apiContext, apiVersion, jwtValidationInfo,\n-                            jwtHeader, true);\n-            if (api == null) {\n-                boolean validateSubscriptionViaKM = Boolean.parseBoolean(\n-                        ServiceReferenceHolder.getInstance().getAPIManagerConfiguration()\n-                                .getFirstProperty(APIConstants.JWT_AUTHENTICATION_SUBSCRIPTION_VALIDATION)\n-                                                                        );\n-                if (validateSubscriptionViaKM) {\n-                    log.debug(\"Begin subscription validation via Key Manager\");\n-                    APIKeyValidationInfoDTO apiKeyValidationInfoDTO = validateSubscriptionUsingKeyManager(apiContext,\n-                            apiVersion, jwtValidationInfo);\n-\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(\"Subscription validation via Key Manager. Status: \" +\n-                                apiKeyValidationInfoDTO.isAuthorized());\n-                    }\n-                    if (apiKeyValidationInfoDTO.isAuthorized()) {\n-                        log.debug(\"JWT authentication successful.\");\n-                        String endUserToken;\n-                        if (jwtGenerationEnabled) {\n-                            JWTInfoDto jwtInfoDto;\n-                            try {\n-                                jwtInfoDto =\n-                                        GatewayUtils.generateJWTInfoDto(jwtValidationInfo, api, apiKeyValidationInfoDTO,\n-                                                apiContext, apiVersion);\n-                                endUserToken = generateAndRetrieveJWTToken(tokenSignature, jwtInfoDto);\n-                                return GatewayUtils\n-                                        .generateAuthenticationContext(tokenSignature, jwtValidationInfo, null,\n-                                                apiKeyValidationInfoDTO, getApiLevelPolicy(), endUserToken, true);\n-                            } catch (ParseException e) {\n-                                throw new APISecurityException(APISecurityConstants.API_AUTH_GENERAL_ERROR,\n-                                        APISecurityConstants.API_AUTH_GENERAL_ERROR_MESSAGE);\n-                            }\n-                        }\n-                    } else {\n-                        log.debug(\"User is NOT authorized to access the Resource. API Subscription validation failed.\");\n-                        throw new APISecurityException(apiKeyValidationInfoDTO.getValidationStatus(),\n-                                \"User is NOT authorized to access the Resource. API Subscription validation failed.\");\n-                    }\n-                }\n-                log.debug(\"Ignored subscription validation\");\n+            log.debug(\"Begin subscription validation via Key Manager\");\n+            APIKeyValidationInfoDTO apiKeyValidationInfoDTO = validateSubscriptionUsingKeyManager(apiContext,\n+                    apiVersion, jwtValidationInfo);\n+\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Subscription validation via Key Manager. Status: \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aae3648ba395d064389b0de14a20577e0a11b44"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzI3NzEyNA==", "bodyText": "can we append the username/any other info here?", "url": "https://github.com/wso2/carbon-apimgt/pull/8999#discussion_r457277124", "createdAt": "2020-07-20T10:54:49Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java", "diffHunk": "@@ -322,64 +322,34 @@ public AuthenticationContext authenticateForWebSocket(SignedJWT jwtToken, String\n         }\n \n         if (jwtValidationInfo != null && jwtValidationInfo.isValid()) {\n-            net.minidev.json.JSONObject api =\n-                    GatewayUtils.validateAPISubscription(apiContext, apiVersion, jwtValidationInfo,\n-                            jwtHeader, true);\n-            if (api == null) {\n-                boolean validateSubscriptionViaKM = Boolean.parseBoolean(\n-                        ServiceReferenceHolder.getInstance().getAPIManagerConfiguration()\n-                                .getFirstProperty(APIConstants.JWT_AUTHENTICATION_SUBSCRIPTION_VALIDATION)\n-                                                                        );\n-                if (validateSubscriptionViaKM) {\n-                    log.debug(\"Begin subscription validation via Key Manager\");\n-                    APIKeyValidationInfoDTO apiKeyValidationInfoDTO = validateSubscriptionUsingKeyManager(apiContext,\n-                            apiVersion, jwtValidationInfo);\n-\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(\"Subscription validation via Key Manager. Status: \" +\n-                                apiKeyValidationInfoDTO.isAuthorized());\n-                    }\n-                    if (apiKeyValidationInfoDTO.isAuthorized()) {\n-                        log.debug(\"JWT authentication successful.\");\n-                        String endUserToken;\n-                        if (jwtGenerationEnabled) {\n-                            JWTInfoDto jwtInfoDto;\n-                            try {\n-                                jwtInfoDto =\n-                                        GatewayUtils.generateJWTInfoDto(jwtValidationInfo, api, apiKeyValidationInfoDTO,\n-                                                apiContext, apiVersion);\n-                                endUserToken = generateAndRetrieveJWTToken(tokenSignature, jwtInfoDto);\n-                                return GatewayUtils\n-                                        .generateAuthenticationContext(tokenSignature, jwtValidationInfo, null,\n-                                                apiKeyValidationInfoDTO, getApiLevelPolicy(), endUserToken, true);\n-                            } catch (ParseException e) {\n-                                throw new APISecurityException(APISecurityConstants.API_AUTH_GENERAL_ERROR,\n-                                        APISecurityConstants.API_AUTH_GENERAL_ERROR_MESSAGE);\n-                            }\n-                        }\n-                    } else {\n-                        log.debug(\"User is NOT authorized to access the Resource. API Subscription validation failed.\");\n-                        throw new APISecurityException(apiKeyValidationInfoDTO.getValidationStatus(),\n-                                \"User is NOT authorized to access the Resource. API Subscription validation failed.\");\n-                    }\n-                }\n-                log.debug(\"Ignored subscription validation\");\n+            log.debug(\"Begin subscription validation via Key Manager\");\n+            APIKeyValidationInfoDTO apiKeyValidationInfoDTO = validateSubscriptionUsingKeyManager(apiContext,\n+                    apiVersion, jwtValidationInfo);\n+\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Subscription validation via Key Manager. Status: \" +\n+                        apiKeyValidationInfoDTO.isAuthorized());\n             }\n-            log.debug(\"JWT authentication successful.\");\n-            String endUserToken = null;\n-            try {\n-                if (jwtGenerationEnabled) {\n-                    JWTInfoDto jwtInfoDto =\n-                            GatewayUtils.generateJWTInfoDto(jwtValidationInfo, api, null, apiContext, apiVersion);\n-                    endUserToken = generateAndRetrieveJWTToken(tokenSignature, jwtInfoDto);\n+            if (apiKeyValidationInfoDTO.isAuthorized()) {\n+                log.debug(\"JWT authentication successful.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aae3648ba395d064389b0de14a20577e0a11b44"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzI3NzkxOA==", "bodyText": "we can use a constant for the error message and reuse in the exception", "url": "https://github.com/wso2/carbon-apimgt/pull/8999#discussion_r457277918", "createdAt": "2020-07-20T10:56:01Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java", "diffHunk": "@@ -322,64 +322,34 @@ public AuthenticationContext authenticateForWebSocket(SignedJWT jwtToken, String\n         }\n \n         if (jwtValidationInfo != null && jwtValidationInfo.isValid()) {\n-            net.minidev.json.JSONObject api =\n-                    GatewayUtils.validateAPISubscription(apiContext, apiVersion, jwtValidationInfo,\n-                            jwtHeader, true);\n-            if (api == null) {\n-                boolean validateSubscriptionViaKM = Boolean.parseBoolean(\n-                        ServiceReferenceHolder.getInstance().getAPIManagerConfiguration()\n-                                .getFirstProperty(APIConstants.JWT_AUTHENTICATION_SUBSCRIPTION_VALIDATION)\n-                                                                        );\n-                if (validateSubscriptionViaKM) {\n-                    log.debug(\"Begin subscription validation via Key Manager\");\n-                    APIKeyValidationInfoDTO apiKeyValidationInfoDTO = validateSubscriptionUsingKeyManager(apiContext,\n-                            apiVersion, jwtValidationInfo);\n-\n-                    if (log.isDebugEnabled()) {\n-                        log.debug(\"Subscription validation via Key Manager. Status: \" +\n-                                apiKeyValidationInfoDTO.isAuthorized());\n-                    }\n-                    if (apiKeyValidationInfoDTO.isAuthorized()) {\n-                        log.debug(\"JWT authentication successful.\");\n-                        String endUserToken;\n-                        if (jwtGenerationEnabled) {\n-                            JWTInfoDto jwtInfoDto;\n-                            try {\n-                                jwtInfoDto =\n-                                        GatewayUtils.generateJWTInfoDto(jwtValidationInfo, api, apiKeyValidationInfoDTO,\n-                                                apiContext, apiVersion);\n-                                endUserToken = generateAndRetrieveJWTToken(tokenSignature, jwtInfoDto);\n-                                return GatewayUtils\n-                                        .generateAuthenticationContext(tokenSignature, jwtValidationInfo, null,\n-                                                apiKeyValidationInfoDTO, getApiLevelPolicy(), endUserToken, true);\n-                            } catch (ParseException e) {\n-                                throw new APISecurityException(APISecurityConstants.API_AUTH_GENERAL_ERROR,\n-                                        APISecurityConstants.API_AUTH_GENERAL_ERROR_MESSAGE);\n-                            }\n-                        }\n-                    } else {\n-                        log.debug(\"User is NOT authorized to access the Resource. API Subscription validation failed.\");\n-                        throw new APISecurityException(apiKeyValidationInfoDTO.getValidationStatus(),\n-                                \"User is NOT authorized to access the Resource. API Subscription validation failed.\");\n-                    }\n-                }\n-                log.debug(\"Ignored subscription validation\");\n+            log.debug(\"Begin subscription validation via Key Manager\");\n+            APIKeyValidationInfoDTO apiKeyValidationInfoDTO = validateSubscriptionUsingKeyManager(apiContext,\n+                    apiVersion, jwtValidationInfo);\n+\n+            if (log.isDebugEnabled()) {\n+                log.debug(\"Subscription validation via Key Manager. Status: \" +\n+                        apiKeyValidationInfoDTO.isAuthorized());\n             }\n-            log.debug(\"JWT authentication successful.\");\n-            String endUserToken = null;\n-            try {\n-                if (jwtGenerationEnabled) {\n-                    JWTInfoDto jwtInfoDto =\n-                            GatewayUtils.generateJWTInfoDto(jwtValidationInfo, api, null, apiContext, apiVersion);\n-                    endUserToken = generateAndRetrieveJWTToken(tokenSignature, jwtInfoDto);\n+            if (apiKeyValidationInfoDTO.isAuthorized()) {\n+                log.debug(\"JWT authentication successful.\");\n+                String endUserToken = null;\n+                JWTInfoDto jwtInfoDto;\n+                try {\n+                    if (jwtGenerationEnabled) {\n+                        jwtInfoDto = GatewayUtils.generateJWTInfoDto(jwtValidationInfo, null,\n+                                apiKeyValidationInfoDTO, apiContext, apiVersion);\n+                        endUserToken = generateAndRetrieveJWTToken(tokenSignature, jwtInfoDto);\n+                    }\n+                    return GatewayUtils.generateAuthenticationContext(tokenSignature, jwtValidationInfo, null,\n+                            apiKeyValidationInfoDTO, getApiLevelPolicy(), endUserToken, true);\n+                } catch (ParseException e) {\n+                    throw new APISecurityException(APISecurityConstants.API_AUTH_GENERAL_ERROR,\n+                            APISecurityConstants.API_AUTH_GENERAL_ERROR_MESSAGE, e);\n                 }\n-                return GatewayUtils\n-                        .generateAuthenticationContext(tokenSignature, jwtValidationInfo, api, null,\n-                                getApiLevelPolicy(),\n-                                endUserToken, true);\n-            } catch (ParseException e) {\n-                throw new APISecurityException(APISecurityConstants.API_AUTH_GENERAL_ERROR,\n-                        APISecurityConstants.API_AUTH_GENERAL_ERROR_MESSAGE);\n+            } else {\n+                log.debug(\"User is NOT authorized to access the Resource. API Subscription validation failed.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3aae3648ba395d064389b0de14a20577e0a11b44"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83d8083bf4fdd8144025e55cdf9c2c0259d88850", "author": {"user": {"login": "ChamodDamitha", "name": "Chamod Damitha Samarajeewa"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/83d8083bf4fdd8144025e55cdf9c2c0259d88850", "committedDate": "2020-07-20T11:37:31Z", "message": "Fix review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de48a28366785e64e7aa0e6351b77bb5b1885a9f", "author": {"user": {"login": "ChamodDamitha", "name": "Chamod Damitha Samarajeewa"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/de48a28366785e64e7aa0e6351b77bb5b1885a9f", "committedDate": "2020-07-20T11:35:05Z", "message": "Fix review comments"}, "afterCommit": {"oid": "83d8083bf4fdd8144025e55cdf9c2c0259d88850", "author": {"user": {"login": "ChamodDamitha", "name": "Chamod Damitha Samarajeewa"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/83d8083bf4fdd8144025e55cdf9c2c0259d88850", "committedDate": "2020-07-20T11:37:31Z", "message": "Fix review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTI4Njk0", "url": "https://github.com/wso2/carbon-apimgt/pull/8999#pullrequestreview-451528694", "createdAt": "2020-07-20T11:41:40Z", "commit": {"oid": "83d8083bf4fdd8144025e55cdf9c2c0259d88850"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2581, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}