{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NDQ0OTQw", "number": 9149, "title": "Map and inject Mgw throttling Extensions To Default extensions when importing an API definition", "bodyText": "Purpose\nWhen importing OpenAPI definitions via API controller or via publisher portal, those definitions have resource level throttling defined inside them. Currently, this throttling level extension is supported only with x-throttling-tier when defining resource level throttling. But there is a use case from the micro gateway which defines these throttling tiers with x-wso2-throttling-tier in resource level. This PR will provide that support\nGoals\nFixes wso2/product-apim#8974\nFixes wso2/product-apim#8975\nApproach\nIn OASParsers of APIM, there are methods to preprocess swagger definitions before actually processing and creating API objects. On that level, the OAS parsers can map x-wso2-throttling-tier extension values into x-throttling-tier in OAS parsers before creating API objects using these OpenAPI definitions.\nUser stories\nImport API via API Controller.\nImport API via Publisher Portal\nDocumentation\nNo doc changes required.\nTest environment\nUbuntu 20.04 LTS\nJava JDK 1.8_241\nAPIM 3.2.0\nAPICTL 3.2.0", "createdAt": "2020-08-07T07:32:55Z", "url": "https://github.com/wso2/carbon-apimgt/pull/9149", "merged": true, "mergeCommit": {"oid": "70b1bfaf065fbc44217908f4c4596c1ccc5e434b"}, "closed": true, "closedAt": "2020-09-02T11:31:04Z", "author": {"login": "Chamindu36"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8X5bggH2gAyNDY0NDQ0OTQwOmI0ZDg4YjE5YzFjY2M0NzhhZGUzMDRiYjMwMmE2MDI2YmE2MmZiMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8i3p5AFqTQ2MzI0MzQyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b4d88b19c1ccc478ade304bb302a6026ba62fb00", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/b4d88b19c1ccc478ade304bb302a6026ba62fb00", "committedDate": "2020-08-06T22:52:05Z", "message": "Support mutual ssl mandatory option with vendor extensions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2498dd4b615305a1103a08602e8e086a18d15826", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/2498dd4b615305a1103a08602e8e086a18d15826", "committedDate": "2020-08-06T22:52:05Z", "message": "Map and inject Mgw Throttling Extensions To Default extensions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTQ5Mjky", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#pullrequestreview-463149292", "createdAt": "2020-08-07T08:58:04Z", "commit": {"oid": "2498dd4b615305a1103a08602e8e086a18d15826"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODo1ODowNFrOG9SJew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODo1ODozMVrOG9SKZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzY1OQ==", "bodyText": "Shall we move this to \n  \n    \n      carbon-apimgt/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OASParserUtil.java\n    \n    \n        Lines 1325 to 1329\n      in\n      62dbf8e\n    \n    \n    \n    \n\n        \n          \n           public static String preProcess(String swaggerContent) throws APIManagementException { \n        \n\n        \n          \n               //Load required properties from swagger to the API \n        \n\n        \n          \n               APIDefinition apiDefinition = getOASParser(swaggerContent); \n        \n\n        \n          \n               return apiDefinition.processOtherSchemeScopes(swaggerContent); \n        \n\n        \n          \n           }", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913659", "createdAt": "2020-08-07T08:58:04Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1276,6 +1276,7 @@ private boolean isDefaultGiven(String swaggerContent) throws APIManagementExcept\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         if (!isDefaultGiven(swaggerContent)) {\n             Swagger swagger = getSwagger(swaggerContent);\n+            swagger = injectMgwThrottlingExtensionsToDefault(swagger);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2498dd4b615305a1103a08602e8e086a18d15826"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzc5MA==", "bodyText": "make it an interface method of API definition and implement it here.\nSo you can call it from preProcess method above", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913790", "createdAt": "2020-08-07T08:58:19Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1284,6 +1285,36 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns swagger definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in swagger file(Swagger version 2)\n+     *\n+     * @param swagger Swagger\n+     * @return Swagger\n+     * @throws APIManagementException\n+     */\n+    private Swagger injectMgwThrottlingExtensionsToDefault(Swagger swagger) throws APIManagementException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2498dd4b615305a1103a08602e8e086a18d15826"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzg5NA==", "bodyText": "same here", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913894", "createdAt": "2020-08-07T08:58:31Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "diffHunk": "@@ -1344,6 +1347,7 @@ private boolean isDefaultGiven(String swaggerContent) throws APIManagementExcept\n     @Override\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         OpenAPI openAPI = getOpenAPI(swaggerContent);\n+        openAPI = injectMgwThrottlingExtensionsToDefault(openAPI);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2498dd4b615305a1103a08602e8e086a18d15826"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "committedDate": "2020-08-07T09:44:14Z", "message": "Adding suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTkxOTA0", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#pullrequestreview-463191904", "createdAt": "2020-08-07T10:03:34Z", "commit": {"oid": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMDowMzozNFrOG9UIPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMDowMzo0NVrOG9UIfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk0NjEwOQ==", "bodyText": "Do we need these 3 lines?", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466946109", "createdAt": "2020-08-07T10:03:34Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1284,6 +1284,38 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns swagger definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in swagger file(Swagger version 2)\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String injectMgwThrottlingExtensionsToDefault(String swaggerContent) throws APIManagementException {\n+        Swagger swagger = getSwagger(swaggerContent);\n+        Map<String, Path> paths = swagger.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<HttpMethod, Operation> operationsMap = paths.get(pathKey).getOperationMap();\n+            for (Map.Entry<HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> extensions = operation.getVendorExtensions();\n+                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {\n+                    Object tier = extensions.get(APIConstants.X_WSO2_THROTTLING_TIER);\n+                    extensions.remove(APIConstants.X_WSO2_THROTTLING_TIER);\n+                    extensions.put(APIConstants.SWAGGER_X_THROTTLING_TIER, tier);\n+                }\n+                operation.setVendorExtensions(extensions);\n+                entry.setValue(operation);\n+                operationsMap.put(entry.getKey(), operation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk0NjE3NA==", "bodyText": "same here.", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466946174", "createdAt": "2020-08-07T10:03:45Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "diffHunk": "@@ -1378,6 +1381,38 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns openAPI definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in openAPI file(openAPI version 3)\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String injectMgwThrottlingExtensionsToDefault(String swaggerContent) throws APIManagementException {\n+        OpenAPI openAPI = getOpenAPI(swaggerContent);\n+        Paths paths = openAPI.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<PathItem.HttpMethod, Operation> operationsMap = paths.get(pathKey).readOperationsMap();\n+            for (Map.Entry<PathItem.HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> extensions = operation.getExtensions();\n+                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7745658f173c640098add6907c5d8f6404084586", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/7745658f173c640098add6907c5d8f6404084586", "committedDate": "2020-08-07T10:48:15Z", "message": "Fixing commented reviews"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMjQzNDIw", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#pullrequestreview-463243420", "createdAt": "2020-08-07T11:39:06Z", "commit": {"oid": "7745658f173c640098add6907c5d8f6404084586"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2476, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}