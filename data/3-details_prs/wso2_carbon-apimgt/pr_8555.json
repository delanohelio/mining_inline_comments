{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxODE0MTUx", "number": 8555, "title": "Adding Event Notifier base component", "bodyText": "Methodology\nAdding event notifier interfaces which can be used to send various events data such as creation,updation,deletion of Subscriptions, Applications, APIs, Policies, Keys to Pilot node.", "createdAt": "2020-05-22T09:23:53Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8555", "merged": true, "mergeCommit": {"oid": "5830f1cd4e816bcb3ca5de641986e5e5ebf053d8"}, "closed": true, "closedAt": "2020-05-27T06:59:39Z", "author": {"login": "CrowleyRajapakse"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckdBDOgFqTQxNzM2NzQ2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABclTNCZgBqjMzNzY1NzQxODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MzY3NDYy", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#pullrequestreview-417367462", "createdAt": "2020-05-24T15:15:19Z", "commit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNToxNToxOVrOGZvjwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNToxNTo0MVrOGZvj7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0Njc4NQ==", "bodyText": "These Events need to send after subscription approved", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429646785", "createdAt": "2020-05-24T15:15:19Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java", "diffHunk": "@@ -3188,6 +3195,12 @@ public void removeSubscription(SubscribedAPI subscription) throws APIManagementE\n                         + \") removed from app \" + appName;\n                 log.debug(logMessage);\n             }\n+\n+            SubscriptionEvent subscriptionEvent = new SubscriptionEvent(UUID.randomUUID().toString(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0NjgzMA==", "bodyText": "same goes here as well", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429646830", "createdAt": "2020-05-24T15:15:41Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java", "diffHunk": "@@ -3408,6 +3421,12 @@ public int addApplication(Application application, String userId)\n             Thread recommendationThread = new Thread(extractor);\n             recommendationThread.start();\n         }\n+\n+        ApplicationEvent applicationEvent = new ApplicationEvent(UUID.randomUUID().toString(), System.currentTimeMillis()\n+                , APIConstants.EventType.APPLICATION_CREATE.name(), tenantId, applicationId, application.getName(), application.getTokenType(),\n+                application.getTier());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3Mzk5NDc3", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#pullrequestreview-417399477", "createdAt": "2020-05-24T23:05:10Z", "commit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQyMzowNToxMFrOGZx0Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQyMzo0NjozMVrOGZyBuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4Mzc5OQ==", "bodyText": "change * to exact class names", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429683799", "createdAt": "2020-05-24T23:05:10Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java", "diffHunk": "@@ -85,6 +85,7 @@\n import org.wso2.carbon.apimgt.impl.dto.TierPermissionDTO;\n import org.wso2.carbon.apimgt.impl.dto.WorkflowDTO;\n import org.wso2.carbon.apimgt.impl.factory.KeyManagerHolder;\n+import org.wso2.carbon.apimgt.impl.notifier.events.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4NTAxMQ==", "bodyText": "this event has to go to completeApplicationRegistration", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429685011", "createdAt": "2020-05-24T23:20:17Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java", "diffHunk": "@@ -3906,6 +3936,11 @@ else if (APIConstants.API_KEY_TYPE_SANDBOX.equals(tokenType)) { // if\n             APIUtil.logAuditMessage(APIConstants.AuditLogConstants.APPLICATION, appLogObject.toString(),\n                     APIConstants.AuditLogConstants.UPDATED, this.username);\n \n+            ApplicationRegistrationEvent applicationRegistrationEvent = new ApplicationRegistrationEvent(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4NTAyNw==", "bodyText": "this as well", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429685027", "createdAt": "2020-05-24T23:20:33Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIConsumerImpl.java", "diffHunk": "@@ -4050,6 +4085,12 @@ else if (APIConstants.API_KEY_TYPE_SANDBOX.equals(tokenType)) {\n             appLogObject.put(\"Generated keys for application\", application.getName());\n             APIUtil.logAuditMessage(APIConstants.AuditLogConstants.APPLICATION, appLogObject.toString(),\n                     APIConstants.AuditLogConstants.UPDATED, this.username);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4NTI2Mg==", "bodyText": "change to absolute imports", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429685262", "createdAt": "2020-05-24T23:23:17Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/internal/APIManagerComponent.java", "diffHunk": "@@ -49,6 +49,8 @@\n import org.wso2.carbon.apimgt.impl.factory.KeyManagerHolder;\n import org.wso2.carbon.apimgt.impl.factory.SQLConstantManagerFactory;\n import org.wso2.carbon.apimgt.impl.handlers.UserPostSelfRegistrationHandler;\n+import org.wso2.carbon.apimgt.impl.notifier.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4NTQ5MQ==", "bodyText": "we can merge these two lines\nbundleContext.registerService(Notifier.class.getName(), new SubscriptionsNotifier(), null);", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429685491", "createdAt": "2020-05-24T23:25:55Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/internal/APIManagerComponent.java", "diffHunk": "@@ -169,6 +172,19 @@ protected void activate(ComponentContext componentContext) throws Exception {\n             bundleContext.registerService(Axis2ConfigurationContextObserver.class.getName(), tenantLoadMessageSender, null);\n             KeyMgtConfigDeployer keyMgtConfigDeployer = new KeyMgtConfigDeployer();\n             bundleContext.registerService(Axis2ConfigurationContextObserver.class.getName(), keyMgtConfigDeployer, null);\n+\n+            //Registering Notifiers\n+            Notifier subscriptionsNotifier = new SubscriptionsNotifier();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4NTkwOA==", "bodyText": "shouldn't this be removeNotifiers?", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429685908", "createdAt": "2020-05-24T23:30:55Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/internal/APIManagerComponent.java", "diffHunk": "@@ -731,5 +747,25 @@ private void setupAccessTokenGenerator(){\n             ServiceReferenceHolder.getInstance().setAccessTokenGenerator(accessTokenGenerator);\n         }\n     }\n+\n+    @Reference(\n+            name = \"notifier.component\",\n+            service = Notifier.class,\n+            cardinality = ReferenceCardinality.MULTIPLE,\n+            policy = ReferencePolicy.DYNAMIC,\n+            unbind = \"removeNotifier\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4NjE3MA==", "bodyText": "Shall we change this to builder pattern?", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429686170", "createdAt": "2020-05-24T23:34:21Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/notifier/events/APIEvent.java", "diffHunk": "@@ -0,0 +1,123 @@\n+package org.wso2.carbon.apimgt.impl.notifier.events;\n+\n+import java.util.Objects;\n+\n+public class APIEvent extends Event {\n+\n+    private String apiName;\n+    private int apiId;\n+    private String apiVersion;\n+    private String apiContext;\n+    private String apiProvider;\n+    private String apiType;\n+    private String apiStatus;\n+\n+    public APIEvent(String eventId, long timestamp, String type, int tenantId, String apiName, int apiId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4NjUyNQ==", "bodyText": "We need the group_id as well.", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429686525", "createdAt": "2020-05-24T23:38:43Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/notifier/events/ApplicationEvent.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.wso2.carbon.apimgt.impl.notifier.events;\n+\n+import java.util.Objects;\n+\n+public class ApplicationEvent extends Event {\n+    private int applicationId;\n+    private String applicationName;\n+    private String tokenType;\n+    private String applicationPolicy;\n+\n+    public ApplicationEvent(String eventId, long timestamp, String type, int tenantId,int applicationId,\n+                            String applicationName, String tokenType, String applicationPolicy) {\n+        this.eventId = eventId;\n+        this.timeStamp = timestamp;\n+        this.type = type;\n+        this.tenantId = tenantId;\n+        this.applicationId = applicationId;\n+        this.applicationName = applicationName;\n+        this.tokenType = tokenType;\n+        this.applicationPolicy = applicationPolicy;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY4NzIyNQ==", "bodyText": "need the space after the .", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#discussion_r429687225", "createdAt": "2020-05-24T23:46:31Z", "author": {"login": "isharac"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -539,6 +535,23 @@ public static void updateAPIProductDependencies(API api, Registry registry) thro\n         }\n     }\n \n+    /**\n+     * This method used to send Notifications\n+     *\n+     * @param event        Event object\n+     * @param notifierType eventType\n+     */\n+    public static void sendNotification(org.wso2.carbon.apimgt.impl.notifier.events.Event event, String notifierType) {\n+        List<Notifier> notifierList = ServiceReferenceHolder.getInstance().getNotifiersMap().get(notifierType);\n+        notifierList.forEach((notifier) -> {\n+            try {\n+                notifier.publishEvent(event);\n+            } catch (NotifierException e) {\n+                log.error(\"Error when publish \" + event + \" through notifier:\" + notifierType + \" .Error:\" + e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/82c3e214a4f10e24d7ac461141ac9fbb3eae9f3a", "committedDate": "2020-05-22T09:18:17Z", "message": "Adding event notifier base component"}, "afterCommit": {"oid": "4643b428cdfb27800502e2b41f007e8af350f389", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/4643b428cdfb27800502e2b41f007e8af350f389", "committedDate": "2020-05-26T06:49:09Z", "message": "Adding event notifier base component"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4643b428cdfb27800502e2b41f007e8af350f389", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/4643b428cdfb27800502e2b41f007e8af350f389", "committedDate": "2020-05-26T06:49:09Z", "message": "Adding event notifier base component"}, "afterCommit": {"oid": "411130f4094660c4d5fda44edc0798b39bc8019e", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/411130f4094660c4d5fda44edc0798b39bc8019e", "committedDate": "2020-05-26T13:19:29Z", "message": "Adding event notifier base component"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "411130f4094660c4d5fda44edc0798b39bc8019e", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/411130f4094660c4d5fda44edc0798b39bc8019e", "committedDate": "2020-05-26T13:19:29Z", "message": "Adding event notifier base component"}, "afterCommit": {"oid": "d618cb7ef5cc58a627ce65e93919d4f22c24dc83", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/d618cb7ef5cc58a627ce65e93919d4f22c24dc83", "committedDate": "2020-05-27T03:51:54Z", "message": "Adding event notifier base component"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d618cb7ef5cc58a627ce65e93919d4f22c24dc83", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/d618cb7ef5cc58a627ce65e93919d4f22c24dc83", "committedDate": "2020-05-27T03:51:54Z", "message": "Adding event notifier base component"}, "afterCommit": {"oid": "efb26ea42ba9c417e5aa952aeb64402d8d33b3a7", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/efb26ea42ba9c417e5aa952aeb64402d8d33b3a7", "committedDate": "2020-05-27T05:05:03Z", "message": "Adding event notifier base component"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODcxMjY2", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#pullrequestreview-418871266", "createdAt": "2020-05-27T05:42:32Z", "commit": {"oid": "efb26ea42ba9c417e5aa952aeb64402d8d33b3a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODc3MTU4", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#pullrequestreview-418877158", "createdAt": "2020-05-27T05:58:22Z", "commit": {"oid": "efb26ea42ba9c417e5aa952aeb64402d8d33b3a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODgxMDI4", "url": "https://github.com/wso2/carbon-apimgt/pull/8555#pullrequestreview-418881028", "createdAt": "2020-05-27T06:08:01Z", "commit": {"oid": "efb26ea42ba9c417e5aa952aeb64402d8d33b3a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fe0ef401b6cf67118bf786dd799fa4511e3b0a4", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/0fe0ef401b6cf67118bf786dd799fa4511e3b0a4", "committedDate": "2020-05-27T06:23:07Z", "message": "Adding event notifier base component"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efb26ea42ba9c417e5aa952aeb64402d8d33b3a7", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/efb26ea42ba9c417e5aa952aeb64402d8d33b3a7", "committedDate": "2020-05-27T05:05:03Z", "message": "Adding event notifier base component"}, "afterCommit": {"oid": "0fe0ef401b6cf67118bf786dd799fa4511e3b0a4", "author": {"user": {"login": "CrowleyRajapakse", "name": "Crowley Rajapakse"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/0fe0ef401b6cf67118bf786dd799fa4511e3b0a4", "committedDate": "2020-05-27T06:23:07Z", "message": "Adding event notifier base component"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2785, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}