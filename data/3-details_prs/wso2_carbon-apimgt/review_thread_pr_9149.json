{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NDQ0OTQw", "number": 9149, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODo1ODowNFrOEWIu0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMDowMzo0NVrOEWKAfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjQ3MTg0OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODo1ODowNFrOG9SJew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODo1ODowNFrOG9SJew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzY1OQ==", "bodyText": "Shall we move this to \n  \n    \n      carbon-apimgt/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OASParserUtil.java\n    \n    \n        Lines 1325 to 1329\n      in\n      62dbf8e\n    \n    \n    \n    \n\n        \n          \n           public static String preProcess(String swaggerContent) throws APIManagementException { \n        \n\n        \n          \n               //Load required properties from swagger to the API \n        \n\n        \n          \n               APIDefinition apiDefinition = getOASParser(swaggerContent); \n        \n\n        \n          \n               return apiDefinition.processOtherSchemeScopes(swaggerContent); \n        \n\n        \n          \n           }", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913659", "createdAt": "2020-08-07T08:58:04Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1276,6 +1276,7 @@ private boolean isDefaultGiven(String swaggerContent) throws APIManagementExcept\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         if (!isDefaultGiven(swaggerContent)) {\n             Swagger swagger = getSwagger(swaggerContent);\n+            swagger = injectMgwThrottlingExtensionsToDefault(swagger);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2498dd4b615305a1103a08602e8e086a18d15826"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjQ3MjYyOnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODo1ODoxOVrOG9SJ_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODo1ODoxOVrOG9SJ_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzc5MA==", "bodyText": "make it an interface method of API definition and implement it here.\nSo you can call it from preProcess method above", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913790", "createdAt": "2020-08-07T08:58:19Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1284,6 +1285,36 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns swagger definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in swagger file(Swagger version 2)\n+     *\n+     * @param swagger Swagger\n+     * @return Swagger\n+     * @throws APIManagementException\n+     */\n+    private Swagger injectMgwThrottlingExtensionsToDefault(Swagger swagger) throws APIManagementException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2498dd4b615305a1103a08602e8e086a18d15826"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjQ3MzM1OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODo1ODozMVrOG9SKZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QwODo1ODozMVrOG9SKZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzg5NA==", "bodyText": "same here", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913894", "createdAt": "2020-08-07T08:58:31Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "diffHunk": "@@ -1344,6 +1347,7 @@ private boolean isDefaultGiven(String swaggerContent) throws APIManagementExcept\n     @Override\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         OpenAPI openAPI = getOpenAPI(swaggerContent);\n+        openAPI = injectMgwThrottlingExtensionsToDefault(openAPI);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2498dd4b615305a1103a08602e8e086a18d15826"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjY4MDQ3OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMDowMzozNFrOG9UIPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMDowMzozNFrOG9UIPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk0NjEwOQ==", "bodyText": "Do we need these 3 lines?", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466946109", "createdAt": "2020-08-07T10:03:34Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1284,6 +1284,38 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns swagger definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in swagger file(Swagger version 2)\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String injectMgwThrottlingExtensionsToDefault(String swaggerContent) throws APIManagementException {\n+        Swagger swagger = getSwagger(swaggerContent);\n+        Map<String, Path> paths = swagger.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<HttpMethod, Operation> operationsMap = paths.get(pathKey).getOperationMap();\n+            for (Map.Entry<HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> extensions = operation.getVendorExtensions();\n+                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {\n+                    Object tier = extensions.get(APIConstants.X_WSO2_THROTTLING_TIER);\n+                    extensions.remove(APIConstants.X_WSO2_THROTTLING_TIER);\n+                    extensions.put(APIConstants.SWAGGER_X_THROTTLING_TIER, tier);\n+                }\n+                operation.setVendorExtensions(extensions);\n+                entry.setValue(operation);\n+                operationsMap.put(entry.getKey(), operation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxNjY4MDk0OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMDowMzo0NVrOG9UIfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMDowMzo0NVrOG9UIfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk0NjE3NA==", "bodyText": "same here.", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466946174", "createdAt": "2020-08-07T10:03:45Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "diffHunk": "@@ -1378,6 +1381,38 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns openAPI definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in openAPI file(openAPI version 3)\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String injectMgwThrottlingExtensionsToDefault(String swaggerContent) throws APIManagementException {\n+        OpenAPI openAPI = getOpenAPI(swaggerContent);\n+        Paths paths = openAPI.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<PathItem.HttpMethod, Operation> operationsMap = paths.get(pathKey).readOperationsMap();\n+            for (Map.Entry<PathItem.HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> extensions = operation.getExtensions();\n+                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3057, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}