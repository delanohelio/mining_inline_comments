{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MDc0NTg3", "number": 8359, "title": "Make API provider name optional when exporting an API", "bodyText": "Purpose\nDuring the API export process, the API Provider is a mandatory value. But when having more API providers, it is hard to define the correct API provider for each export request.\nFixes: wso2/product-apim-tooling#173\nGoals\nThis fix makes API Provider optional by considering the logged-in user's tenant domain and checking it with the API provider's tenant.\nApproach\n\nGet currently logged in user name.\nGet currently logged in user\u2019s tenant domain (API requester domain).\nIf the command was executed without the provider name (since it was made optional), get the API provider name using the API name, version which matches with the API requester domain. If such API provider was not found, display an error message.\nIf the command was executed with the provider name, steps should be carried out which were done before implementing this fix.\n\nUser stories\nFour user stories will be covered. (Assume two tenants as test1.com and test2.com were created, and an API was imported by user admin1@test1.com)\n\nExport an API using a tenant user (by specifying the provider name) - API is in the same tenant\napictl export-api -n SwaggerPetstore -r admin1@test1.com -v 1.0.3 -e production -k\nThis works when a user who belongs to the same tenant executes the above command.\n\nExport an API using a tenant user (without specifying the provider name) - API is in the same tenant\napictl export-api -n SwaggerPetstore -v 1.0.3 -e production -k\nThis works when a user who belongs to the same tenant executes the above command.\n\nExport an API using a tenant user (by specifying the provider name) - API is in a different tenant\napictl export-api -n SwaggerPetstore -r admin1@test1.com -v 1.0.3 -e production -k\nThis does not work when a user who belongs to another tenant executes the above command.\nExport an API using a tenant user (without specifying the provider name) - API is in a different tenant\napictl export-api -n SwaggerPetstore -v 1.0.3 -e production -k\nThis does not work when a user who belongs to another tenant executes the above command.\n\n\nRelease note\nWhen exporting an API using API Controller (apictl), --provider (-r) flag is optional\nDocumentation\nDocs should change here: https://github.com/wso2/docs-apim/blob/master/en/docs/learn/api-controller/migrating-apis-to-different-environments.md#export-an-api\n!!! info Flags: section should change like below by adding --provider as an optional flag\n        -    Required :  \n            `--name` or `-n` : Name of the API to be exported  \n            `--version` or `-v` : Version of the API to be exported   \n            `--environment` or `-e` : Environment to which the API should be exported  \n        -   Optional :  \n            `--provider` or `-r` : Provider of the API        \n            `--preserveStatus` : Preserve API status when exporting. Otherwise, the API will be exported in the `CREATED` status. The default value is `true`.  \n            `--format` : File format of exported archive (JSON or YAML). The default value is YAML.\n\n!!! example section should change like below (remove \"-r admin\" in the first example)\ngo apictl export-api -n PhoneVerification -v 1.0.0 -e dev -k \ngo apictl export-api -n PizzaShackAPI -v 1.0.0 -r Alice -e dev --preserveStatus=true --format JSON -k \nTest environment\n\nJDK 1.8.0_241\nUbuntu 18.04.4 LTS", "createdAt": "2020-03-16T08:40:35Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8359", "merged": true, "mergeCommit": {"oid": "43a202ad4fe8fdd85e391ed83e770e9ffbd9bd9a"}, "closed": true, "closedAt": "2020-03-18T06:39:34Z", "author": {"login": "wasuradananjith"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOKO9qgFqTM3NTAxNDU5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOxd27gFqTM3NjU5NTc4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDE0NTkw", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#pullrequestreview-375014590", "createdAt": "2020-03-16T08:56:25Z", "commit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwODo1NjoyNVrOF2qmeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwODo1NjoyNVrOF2qmeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg2NTQwMA==", "bodyText": "Please fix the small formatting issue here (line 77 and 83). Space required between ) and {", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#discussion_r392865400", "createdAt": "2020-03-16T08:56:25Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.util/src/main/java/org/wso2/carbon/apimgt/rest/api/util/impl/ExportApiUtil.java", "diffHunk": "@@ -60,19 +60,35 @@ public Response exportApiByParams(String name, String version, String providerNa\n         //If not specified status is preserved by default\n         boolean isStatusPreserved = preserveStatus == null || preserveStatus;\n \n-        if (name == null || version == null || providerName == null) {\n-            RestApiUtil.handleBadRequest(\"'name', 'version' or 'provider' should not be null\", log);\n+        if (name == null || version == null) {\n+            RestApiUtil.handleBadRequest(\"'name' or 'version' should not be null\", log);\n         }\n \n         try {\n             //Default export format is YAML\n             exportFormat = StringUtils.isNotEmpty(format) ? ExportFormat.valueOf(format.toUpperCase()) :\n                     ExportFormat.YAML;\n \n+            // Get currently logged in user's username and the domain\n             userName = RestApiUtil.getLoggedInUsername();\n+            apiRequesterDomain = RestApiUtil.getLoggedInUserTenantDomain();\n+\n+            // If provider name is not given\n+            if (providerName.isEmpty()){\n+                // Retrieve the provider who is in same tenant domain and who owns the same API (by comparing\n+                // API name and the version)\n+                providerName = APIUtil.getAPIProviderFromAPINameVersionTenant(name, version, apiRequesterDomain);\n+\n+                // If there is no provider in current domain, the API cannot be exported\n+                if (providerName == null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDE2OTAy", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#pullrequestreview-375016902", "createdAt": "2020-03-16T08:59:57Z", "commit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwODo1OTo1N1rOF2qtlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwODo1OTo1N1rOF2qtlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg2NzIyMw==", "bodyText": "Shall we use StringUtils.isBlank - [1] here?\n[1] http://commons.apache.org/proper/commons-lang/javadocs/api-2.6/org/apache/commons/lang/StringUtils.html#isBlank(java.lang.String)", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#discussion_r392867223", "createdAt": "2020-03-16T08:59:57Z", "author": {"login": "vithu30"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.util/src/main/java/org/wso2/carbon/apimgt/rest/api/util/impl/ExportApiUtil.java", "diffHunk": "@@ -60,19 +60,35 @@ public Response exportApiByParams(String name, String version, String providerNa\n         //If not specified status is preserved by default\n         boolean isStatusPreserved = preserveStatus == null || preserveStatus;\n \n-        if (name == null || version == null || providerName == null) {\n-            RestApiUtil.handleBadRequest(\"'name', 'version' or 'provider' should not be null\", log);\n+        if (name == null || version == null) {\n+            RestApiUtil.handleBadRequest(\"'name' or 'version' should not be null\", log);\n         }\n \n         try {\n             //Default export format is YAML\n             exportFormat = StringUtils.isNotEmpty(format) ? ExportFormat.valueOf(format.toUpperCase()) :\n                     ExportFormat.YAML;\n \n+            // Get currently logged in user's username and the domain\n             userName = RestApiUtil.getLoggedInUsername();\n+            apiRequesterDomain = RestApiUtil.getLoggedInUserTenantDomain();\n+\n+            // If provider name is not given\n+            if (providerName.isEmpty()){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDMxNzYz", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#pullrequestreview-375031763", "createdAt": "2020-03-16T09:22:35Z", "commit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOToyMjozNVrOF2rbig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOToyMjozNVrOF2rbig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg3ODk4Ng==", "bodyText": "Please fix the small formatting issue", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#discussion_r392878986", "createdAt": "2020-03-16T09:22:35Z", "author": {"login": "HiranyaKavishani"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin/src/gen/java/org/wso2/carbon/apimgt/rest/api/admin/ExportApi.java", "diffHunk": "@@ -40,11 +40,11 @@\n \n     public Response exportApiGet(@ApiParam(value = \"API Name\\n\",required=true) @QueryParam(\"name\")  String name,\n     @ApiParam(value = \"Version of the API\\n\",required=true) @QueryParam(\"version\")  String version,\n-    @ApiParam(value = \"Provider name of the API\\n\",required=true) @QueryParam(\"providerName\")  String providerName,\n     @ApiParam(value = \"Format of output documents. Can be YAML or JSON.\\n\",required=true, allowableValues=\"{values=[JSON, YAML]}\") @QueryParam(\"format\")  String format,\n+    @ApiParam(value = \"Provider name of the API\\n\") @QueryParam(\"providerName\")  String providerName,\n     @ApiParam(value = \"Preserve API Status on export\\n\") @QueryParam(\"preserveStatus\")  Boolean preserveStatus)\n     {\n-    return delegate.exportApiGet(name,version,providerName,format,preserveStatus);\n+    return delegate.exportApiGet(name,version,format,providerName,preserveStatus);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDMyMzI2", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#pullrequestreview-375032326", "createdAt": "2020-03-16T09:23:22Z", "commit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOToyMzoyMlrOF2rdZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOToyMzoyMlrOF2rdZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg3OTQ2MA==", "bodyText": "Please fix the small formatting issue", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#discussion_r392879460", "createdAt": "2020-03-16T09:23:22Z", "author": {"login": "HiranyaKavishani"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin/src/gen/java/org/wso2/carbon/apimgt/rest/api/admin/ExportApiService.java", "diffHunk": "@@ -14,7 +14,7 @@\n import javax.ws.rs.core.Response;\n \n public abstract class ExportApiService {\n-    public abstract Response exportApiGet(String name,String version,String providerName,String format,Boolean preserveStatus);\n+    public abstract Response exportApiGet(String name,String version,String format,String providerName,Boolean preserveStatus);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDU0Mzgy", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#pullrequestreview-375054382", "createdAt": "2020-03-16T09:54:43Z", "commit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOTo1NDo0M1rOF2siiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOTo1NDo0M1rOF2siiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg5NzE2Mw==", "bodyText": "Shall We print the context information (name and version) in the log message", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#discussion_r392897163", "createdAt": "2020-03-16T09:54:43Z", "author": {"login": "prasa7"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.util/src/main/java/org/wso2/carbon/apimgt/rest/api/util/impl/ExportApiUtil.java", "diffHunk": "@@ -60,19 +60,35 @@ public Response exportApiByParams(String name, String version, String providerNa\n         //If not specified status is preserved by default\n         boolean isStatusPreserved = preserveStatus == null || preserveStatus;\n \n-        if (name == null || version == null || providerName == null) {\n-            RestApiUtil.handleBadRequest(\"'name', 'version' or 'provider' should not be null\", log);\n+        if (name == null || version == null) {\n+            RestApiUtil.handleBadRequest(\"'name' or 'version' should not be null\", log);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3641ced1f7342ca5b700683d589658c0e3a19f73", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/3641ced1f7342ca5b700683d589658c0e3a19f73", "committedDate": "2020-03-16T11:10:06Z", "message": "make provider name optional when exporting an api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a4d1253af2109fc8811b4c525f85330807373e2", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/9a4d1253af2109fc8811b4c525f85330807373e2", "committedDate": "2020-03-16T11:10:06Z", "message": "change formatting and print context inf in log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/4f9ddf280270c9679cac2a2b9b55e2a6c2c1bf08", "committedDate": "2020-03-15T09:13:20Z", "message": "make provider name optional when exporting an api"}, "afterCommit": {"oid": "9a4d1253af2109fc8811b4c525f85330807373e2", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/9a4d1253af2109fc8811b4c525f85330807373e2", "committedDate": "2020-03-16T11:10:06Z", "message": "change formatting and print context inf in log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTYyMDY0", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#pullrequestreview-376562064", "createdAt": "2020-03-18T04:47:46Z", "commit": {"oid": "9a4d1253af2109fc8811b4c525f85330807373e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDo0Nzo0NlrOF32Pvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNDo0Nzo0NlrOF32Pvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwNDc2Nw==", "bodyText": "Do we need this info log?", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#discussion_r394104767", "createdAt": "2020-03-18T04:47:46Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.util/src/main/java/org/wso2/carbon/apimgt/rest/api/util/impl/ExportApiUtil.java", "diffHunk": "@@ -60,19 +60,38 @@ public Response exportApiByParams(String name, String version, String providerNa\n         //If not specified status is preserved by default\n         boolean isStatusPreserved = preserveStatus == null || preserveStatus;\n \n-        if (name == null || version == null || providerName == null) {\n-            RestApiUtil.handleBadRequest(\"'name', 'version' or 'provider' should not be null\", log);\n+        // Print context information (name and version of the API) in the log\n+        log.info(\"API name: \"+ name + \", version: \"+ version);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a4d1253af2109fc8811b4c525f85330807373e2"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1f0ad7a24502795d7515b40c05cf9e7f5376cf3", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/c1f0ad7a24502795d7515b40c05cf9e7f5376cf3", "committedDate": "2020-03-18T06:34:43Z", "message": "change the api name and version null log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTk1Nzg1", "url": "https://github.com/wso2/carbon-apimgt/pull/8359#pullrequestreview-376595785", "createdAt": "2020-03-18T06:38:59Z", "commit": {"oid": "c1f0ad7a24502795d7515b40c05cf9e7f5376cf3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2865, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}