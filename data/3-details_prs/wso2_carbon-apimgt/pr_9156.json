{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MzA4MTk0", "number": 9156, "title": "[Improvement] Add support for \"x-wso2-disable-security\" mgw extension in API level ", "bodyText": "Purpose\nWhen importing OpenAPI definitions via API controller or via publisher portal, those definitions have resource level security defined inside them. Currently, this security extension is supported only with x-auth-type when defining resource level security. But there is a extension  in the micro gateway which can uses to disable any type of security for any resource in API definition. That is the  x-wso2-disable-security extension. This extension can be provided in API level to disable security for all resources and define in resource level to disable security for single resource. This PR will provide that support for both cases.\nGoals\nImprove the extension support which are used by micro gateway.\nFixes wso2/product-apim#9343 for master branch\nApproach\nIn OASParsers of APIM, there are methods to preprocess swagger definitions before actually processing and creating API objects. On that level, the OAS parsers can map x-wso2-disable-security extension values into x-auth-typein OAS parsers before creating API objects using these OpenAPI definitions.\nUser stories\nImport API via API Controller.\nImport API via Publisher Portal\nDocumentation\nNo doc changes required.\nTest environment\nUbuntu 20.04 LTS\nJava JDK 1.8_241\nAPIM 3.2.0\nAPICTL 3.2.0", "createdAt": "2020-08-10T06:32:58Z", "url": "https://github.com/wso2/carbon-apimgt/pull/9156", "merged": true, "mergeCommit": {"oid": "6eb9d8562b04145c6045e0344600c622c302762d"}, "closed": true, "closedAt": "2020-09-16T06:15:43Z", "author": {"login": "Chamindu36"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJAjjLgFqTQ4ODMyNjAwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxQV1JgFqTU3MDE4OTc2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MzI2MDAz", "url": "https://github.com/wso2/carbon-apimgt/pull/9156#pullrequestreview-488326003", "createdAt": "2020-09-15T05:01:08Z", "commit": {"oid": "d5c5898e04542722059b18b4a566424bb6b19184"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwNTowMTowOFrOHRwwXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwNTowMTowOFrOHRwwXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM4NjY1Mg==", "bodyText": "Is this whole segment duplicated with the latter class?", "url": "https://github.com/wso2/carbon-apimgt/pull/9156#discussion_r488386652", "createdAt": "2020-09-15T05:01:08Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1543,4 +1543,50 @@ public API setExtensionsToAPI(String apiDefinition, API api) throws APIManagemen\n         return api;\n     }\n \n+    /**\n+     * This method will extractX-WSO2-disable-security extension provided in API level\n+     * by mgw and inject that extension to all resources in OAS file\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String processDisableSecurityExtension(String swaggerContent) throws APIManagementException {\n+        Swagger swagger = getSwagger(swaggerContent);\n+        Map<String, Object> apiExtensions = swagger.getVendorExtensions();\n+        if (apiExtensions == null) {\n+            return swaggerContent;\n+        }\n+        //Check Disable Security is enabled in API level\n+        boolean apiLevelDisableSecurity = OASParserUtil.getDisableSecurity(apiExtensions);\n+        Map<String, Path> paths = swagger.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<HttpMethod, Operation> operationsMap = paths.get(pathKey).getOperationMap();\n+            for (Map.Entry<HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> resourceExtensions = operation.getVendorExtensions();\n+                boolean extensionsAreEmpty = false;\n+                if (apiLevelDisableSecurity) {\n+                    if (resourceExtensions == null) {\n+                        resourceExtensions = new HashMap<>();\n+                        extensionsAreEmpty = true;\n+                    }\n+                    resourceExtensions.put(APIConstants.SWAGGER_X_AUTH_TYPE, \"None\");\n+                    if (extensionsAreEmpty) {\n+                        operation.setVendorExtensions(resourceExtensions);\n+                    }\n+                } else if (resourceExtensions != null && resourceExtensions.containsKey(APIConstants.X_WSO2_DISABLE_SECURITY)) {\n+                    //Check Disable Security is enabled in resource level\n+                    boolean resourceLevelDisableSecurity = Boolean.parseBoolean(String.valueOf(resourceExtensions.get(APIConstants.X_WSO2_DISABLE_SECURITY)));\n+                    if (resourceLevelDisableSecurity) {\n+                        resourceExtensions.put(APIConstants.SWAGGER_X_AUTH_TYPE, \"None\");\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5c5898e04542722059b18b4a566424bb6b19184"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53a8fb7f7a253e390317dc24ae29cf42b4a27373", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/53a8fb7f7a253e390317dc24ae29cf42b4a27373", "committedDate": "2020-09-15T05:35:56Z", "message": "Add support for x-wso2-disable security mgw extension in API level"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5c5898e04542722059b18b4a566424bb6b19184", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/d5c5898e04542722059b18b4a566424bb6b19184", "committedDate": "2020-09-02T18:20:50Z", "message": "Merge branch 'master' into chamindu_fixes_2"}, "afterCommit": {"oid": "53a8fb7f7a253e390317dc24ae29cf42b4a27373", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/53a8fb7f7a253e390317dc24ae29cf42b4a27373", "committedDate": "2020-09-15T05:35:56Z", "message": "Add support for x-wso2-disable security mgw extension in API level"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d80f9ac9aa52f71a4108574d8c7417db07df80af", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/d80f9ac9aa52f71a4108574d8c7417db07df80af", "committedDate": "2020-09-15T05:44:18Z", "message": "Resolve conflicts"}, "afterCommit": {"oid": "ebe511e96af45789548b1c4231f1531695bca23a", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/ebe511e96af45789548b1c4231f1531695bca23a", "committedDate": "2020-09-15T05:46:15Z", "message": "Resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "222c0a8afca247cac828fd125bdfbb4ac8a7abda", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/222c0a8afca247cac828fd125bdfbb4ac8a7abda", "committedDate": "2020-09-15T06:11:24Z", "message": "Resolve conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ebe511e96af45789548b1c4231f1531695bca23a", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/ebe511e96af45789548b1c4231f1531695bca23a", "committedDate": "2020-09-15T05:46:15Z", "message": "Resolve conflicts"}, "afterCommit": {"oid": "222c0a8afca247cac828fd125bdfbb4ac8a7abda", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/222c0a8afca247cac828fd125bdfbb4ac8a7abda", "committedDate": "2020-09-15T06:11:24Z", "message": "Resolve conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MzAzNzky", "url": "https://github.com/wso2/carbon-apimgt/pull/9156#pullrequestreview-489303792", "createdAt": "2020-09-16T06:15:29Z", "commit": {"oid": "222c0a8afca247cac828fd125bdfbb4ac8a7abda"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwMTg5NzYz", "url": "https://github.com/wso2/carbon-apimgt/pull/9156#pullrequestreview-570189763", "createdAt": "2021-01-18T06:01:51Z", "commit": {"oid": "222c0a8afca247cac828fd125bdfbb4ac8a7abda"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQwNjowMTo1MVrOIVa-bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQwNjowMTo1MVrOIVa-bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTMzMjk3NQ==", "bodyText": "Shall we split it into two lines? Seems the length exceeded", "url": "https://github.com/wso2/carbon-apimgt/pull/9156#discussion_r559332975", "createdAt": "2021-01-18T06:01:51Z", "author": {"login": "vithu30"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1568,4 +1568,50 @@ public API setExtensionsToAPI(String apiDefinition, API api) throws APIManagemen\n         return api;\n     }\n \n+    /**\n+     * This method will extractX-WSO2-disable-security extension provided in API level\n+     * by mgw and inject that extension to all resources in OAS file\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String processDisableSecurityExtension(String swaggerContent) throws APIManagementException {\n+        Swagger swagger = getSwagger(swaggerContent);\n+        Map<String, Object> apiExtensions = swagger.getVendorExtensions();\n+        if (apiExtensions == null) {\n+            return swaggerContent;\n+        }\n+        //Check Disable Security is enabled in API level\n+        boolean apiLevelDisableSecurity = OASParserUtil.getDisableSecurity(apiExtensions);\n+        Map<String, Path> paths = swagger.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<HttpMethod, Operation> operationsMap = paths.get(pathKey).getOperationMap();\n+            for (Map.Entry<HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> resourceExtensions = operation.getVendorExtensions();\n+                boolean extensionsAreEmpty = false;\n+                if (apiLevelDisableSecurity) {\n+                    if (resourceExtensions == null) {\n+                        resourceExtensions = new HashMap<>();\n+                        extensionsAreEmpty = true;\n+                    }\n+                    resourceExtensions.put(APIConstants.SWAGGER_X_AUTH_TYPE, \"None\");\n+                    if (extensionsAreEmpty) {\n+                        operation.setVendorExtensions(resourceExtensions);\n+                    }\n+                } else if (resourceExtensions != null && resourceExtensions.containsKey(APIConstants.X_WSO2_DISABLE_SECURITY)) {\n+                    //Check Disable Security is enabled in resource level\n+                    boolean resourceLevelDisableSecurity = Boolean.parseBoolean(String.valueOf(resourceExtensions.get(APIConstants.X_WSO2_DISABLE_SECURITY)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222c0a8afca247cac828fd125bdfbb4ac8a7abda"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2480, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}