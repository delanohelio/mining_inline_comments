{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NDY2OTQ4", "number": 8984, "title": "Enabling custom URL for APIM Publisher", "bodyText": "Purpose\nFixes: wso2/product-apim#8677\nGoals\nProvide custom URL support for API publisher.\nApproach\nFrontporting wso2-support/carbon-apimgt#2147 and wso2-support/carbon-apimgt#2187 by cherry-pick", "createdAt": "2020-07-15T13:03:12Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8984", "merged": true, "mergeCommit": {"oid": "9d51feb316406f312ee23f031c8f1d396321c6b3"}, "closed": true, "closedAt": "2020-07-22T12:42:14Z", "author": {"login": "wasuradananjith"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1YkarAFqTQ0OTUyMDc4MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvoe8wgFqTU2Njg5NDM3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NTIwNzgx", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#pullrequestreview-449520781", "createdAt": "2020-07-16T05:41:34Z", "commit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDUzMjYy", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#pullrequestreview-453053262", "createdAt": "2020-07-22T07:16:39Z", "commit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxNjozOVrOG1VvZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxNjozOVrOG1VvZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4MzkwOA==", "bodyText": "slight formatting issue.", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r458583908", "createdAt": "2020-07-22T07:16:39Z", "author": {"login": "ruks"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/login/idp.jag", "diffHunk": "@@ -45,8 +45,16 @@\n     var erroLogin = serverUrl + app.context +\"/error-pages?code=\"\n \n     var dcrUrl = appUtils.getLoopbackOrigin() + DCR_URL_SUFFIX;\n-    var loginCallbackUrl = serverUrl + app.context + LOGIN_CALLBACK_URL_SUFFIX;\n-    var logoutCallbackUrl = serverUrl + app.context + LOGOUT_CALLBACK_URL_SUFFIX;\n+    var loginCallbackUrl = appUtils.getTenantBasedLoginCallBack();\n+    if (loginCallbackUrl == null) {\n+\t    loginCallbackUrl = serverUrl + app.context + LOGIN_CALLBACK_URL_SUFFIX;\n+    }\n+\n+    var logoutCallbackUrl = appUtils.getTenantBasedLogoutCallBack();\n+    if (logoutCallbackUrl == null) {\n+         logoutCallbackUrl = serverUrl + app.context + LOGOUT_CALLBACK_URL_SUFFIX;\n+     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDU0MzMy", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#pullrequestreview-453054332", "createdAt": "2020-07-22T07:18:24Z", "commit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxODoyNFrOG1Vytw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxODoyNFrOG1Vytw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4NDc1OQ==", "bodyText": "better to add spaces", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r458584759", "createdAt": "2020-07-22T07:18:24Z", "author": {"login": "ruks"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/utils.js", "diffHunk": "@@ -31,10 +32,72 @@ var getLoopbackOrigin = function() {\n     return origin; // Unless there is a port offset this is https://localhost:9443\n };\n \n-function getIDPOrigin(){\n+function getIDPOrigin() {\n     return utils.getExternalIDPOrigin();\n }\n \n-function getIDPCheckSessionEndpoint(){\n+function getIDPCheckSessionEndpoint() {\n     return utils.getExternalIDPCheckSessionEndpoint();\n }\n+\n+var getTenantBasePublisherContext = function() {\n+    var tenantDomain = getTenantDomain();\n+    var tenantContext = utils.getTenantBasedPublisherContext(tenantDomain);\n+    if (tenantContext != null && tenantContext != \" \") {\n+        return tenantContext\n+    } else {\n+        return app.context;\n+    }\n+};\n+\n+var getTenantBasedLoginCallBack = function() {\n+    var tenantDomain = getTenantDomain();\n+    var publisherDomainMapping = utils.getTenantBasedPublisherDomainMapping(tenantDomain);\n+    if (publisherDomainMapping != null) {\n+        if (publisherDomainMapping.get('login') != null) {\n+            return publisherDomainMapping.get('login');\n+        }\n+        return \"https://\"+publisherDomainMapping.get('customUrl') + LOGIN_CALLBACK_URL_SUFFIX;\n+    }else{\n+        return null;\n+    }\n+};\n+\n+var getTenantBasedLogoutCallBack = function() {\n+    var tenantDomain = getTenantDomain();\n+    var publisherDomainMapping = utils.getTenantBasedPublisherDomainMapping(tenantDomain);\n+    if (publisherDomainMapping != null) {\n+        if (publisherDomainMapping.get('logout') != null) {\n+            return publisherDomainMapping.get('logout');\n+        }\n+        return \"https://\"+publisherDomainMapping.get('customUrl') + LOGOUT_CALLBACK_URL_SUFFIX;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDU1MTgz", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#pullrequestreview-453055183", "createdAt": "2020-07-22T07:19:47Z", "commit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxOTo0N1rOG1V1hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxOTo0N1rOG1V1hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4NTQ3Nw==", "bodyText": "Better not to catch ClassCastException. Ideally, you should check the instance type and continue.", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r458585477", "createdAt": "2020-07-22T07:19:47Z", "author": {"login": "ruks"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -10557,6 +10557,69 @@ public static Map getTenantBasedStoreDomainMapping(String tenantDomain) throws A\n         return null;\n     }\n \n+    public static Map getTenantBasedPublisherDomainMapping(String tenantDomain) throws APIManagementException {\n+\n+        try {\n+            Registry registry = ServiceReferenceHolder.getInstance().getRegistryService().\n+                    getGovernanceSystemRegistry();\n+            String resourcePath = APIConstants.API_DOMAIN_MAPPINGS.replace(APIConstants.API_DOMAIN_MAPPING_TENANT_ID_IDENTIFIER, tenantDomain);\n+            if (registry.resourceExists(resourcePath)) {\n+                Resource resource = registry.get(resourcePath);\n+                String content = new String((byte[]) resource.getContent(), Charset.defaultCharset());\n+                JSONParser parser = new JSONParser();\n+                JSONObject mappings = (JSONObject) parser.parse(content);\n+                if (mappings.containsKey(APIConstants.API_DOMAIN_MAPPINGS_PUBLISHER)) {\n+                    return (Map) mappings.get(APIConstants.API_DOMAIN_MAPPINGS_PUBLISHER);\n+                }\n+            }\n+        } catch (RegistryException e) {\n+            String msg = \"Error while retrieving publisher domain mappings from registry\";\n+            throw new APIManagementException(msg, e);\n+        } catch (ClassCastException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f711741d2e3a555ec96c725a24db78d28533f61", "author": {"user": {"login": "mpmunasinghe", "name": "Malith Munasinghe"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/5f711741d2e3a555ec96c725a24db78d28533f61", "committedDate": "2020-07-22T09:50:52Z", "message": "APIUtil implementation for Publisher Custom URl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c4855c6aca049dec1f2c1772ae954c710c2cb8f", "author": {"user": {"login": "mpmunasinghe", "name": "Malith Munasinghe"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/1c4855c6aca049dec1f2c1772ae954c710c2cb8f", "committedDate": "2020-07-22T09:50:52Z", "message": "Publisher custom url jaggery changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "469259fd743af41bf0fb4f7f3aaab35ae035a093", "author": {"user": {"login": "mpmunasinghe", "name": "Malith Munasinghe"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/469259fd743af41bf0fb4f7f3aaab35ae035a093", "committedDate": "2020-07-22T09:50:52Z", "message": "Publisher custom url jaggery changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aebea8c1cba81bb8b649e266aef8c4f3f441ac9d", "author": {"user": {"login": "mpmunasinghe", "name": "Malith Munasinghe"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/aebea8c1cba81bb8b649e266aef8c4f3f441ac9d", "committedDate": "2020-07-22T09:50:53Z", "message": "Fixing review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b012dcd48f9ee083067cffcd38390049127b5f10", "author": {"user": {"login": "mpmunasinghe", "name": "Malith Munasinghe"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/b012dcd48f9ee083067cffcd38390049127b5f10", "committedDate": "2020-07-22T09:50:53Z", "message": "Fixing publisher custom url mapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4b625fbc36f5a8d6896d40490e4a8822fd707c0", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/d4b625fbc36f5a8d6896d40490e4a8822fd707c0", "committedDate": "2020-07-22T09:50:53Z", "message": "Fix formatting issues in cherry-picked commits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e", "author": {"user": {"login": "mpmunasinghe", "name": "Malith Munasinghe"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e", "committedDate": "2020-07-15T12:25:33Z", "message": "Fixing publisher custom url mapping"}, "afterCommit": {"oid": "d4b625fbc36f5a8d6896d40490e4a8822fd707c0", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/d4b625fbc36f5a8d6896d40490e4a8822fd707c0", "committedDate": "2020-07-22T09:50:53Z", "message": "Fix formatting issues in cherry-picked commits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjA0ODQy", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#pullrequestreview-453204842", "createdAt": "2020-07-22T10:49:58Z", "commit": {"oid": "d4b625fbc36f5a8d6896d40490e4a8822fd707c0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMDo0OTo1OVrOG1dIUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMDo0OTo1OVrOG1dIUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwNDk3OA==", "bodyText": "Shall we remove the duplicate entry?", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r458704978", "createdAt": "2020-07-22T10:49:59Z", "author": {"login": "Arshardh"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/site/public/pages/index.jag", "diffHunk": "@@ -25,6 +25,10 @@\n     var swaggerKey = 'swaggerWorkerInit.js';\n     var indexBundle = manifest[indexKey].split(\"dist/\")[1];\n     var swaggerBundle = manifest[swaggerKey].split(\"dist/\")[1];\n+    var appUtils = require(\"/services/utils.js\");\n+    app.context = appUtils.getTenantBasePublisherContext();\n+    var appUtils = require(\"/services/utils.js\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4b625fbc36f5a8d6896d40490e4a8822fd707c0"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4508d94313e2a62e9bcbf832a060624a7fac357d", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/4508d94313e2a62e9bcbf832a060624a7fac357d", "committedDate": "2020-07-22T11:05:56Z", "message": "Remove duplicate code segments in cherry-picked code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjM1MzMw", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#pullrequestreview-453235330", "createdAt": "2020-07-22T11:40:10Z", "commit": {"oid": "4508d94313e2a62e9bcbf832a060624a7fac357d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2ODk0Mzcx", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#pullrequestreview-566894371", "createdAt": "2021-01-13T05:01:41Z", "commit": {"oid": "4508d94313e2a62e9bcbf832a060624a7fac357d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwNTowMTo0MVrOISfoyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwNTowMTo0MVrOISfoyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjI2MzYyNQ==", "bodyText": "fix formatting", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r556263625", "createdAt": "2021-01-13T05:01:41Z", "author": {"login": "praminda"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/utils.js", "diffHunk": "@@ -38,3 +39,65 @@ function getIDPOrigin() {\n function getIDPCheckSessionEndpoint() {\n     return utils.getExternalIDPCheckSessionEndpoint();\n }\n+\n+var getTenantBasePublisherContext = function() {\n+    var tenantDomain = getTenantDomain();\n+    var tenantContext = utils.getTenantBasedPublisherContext(tenantDomain);\n+    if (tenantContext != null && tenantContext != \" \") {\n+        return tenantContext\n+    } else {\n+        return app.context;\n+    }\n+};\n+\n+var getTenantBasedLoginCallBack = function() {\n+    var tenantDomain = getTenantDomain();\n+    var publisherDomainMapping = utils.getTenantBasedPublisherDomainMapping(tenantDomain);\n+    if (publisherDomainMapping != null) {\n+        if (publisherDomainMapping.get('login') != null) {\n+            return publisherDomainMapping.get('login');\n+        }\n+        return \"https://\"+publisherDomainMapping.get('customUrl') + LOGIN_CALLBACK_URL_SUFFIX;\n+    }else{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4508d94313e2a62e9bcbf832a060624a7fac357d"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2576, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}