{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMDMyMjU5", "number": 8728, "title": "Update API-Service-Catalog-Entry-Mapping to support LoadBalanced/Failover endpoints", "bodyText": "Endpoint from Service Catalog\n{\n  \"endpoint_type\":\"catalog\",\n  \"sandbox_endpoints\": {\n    \"id\":\"dev:entry:1.0.0\"\n  },\n  \"production_endpoints\": {\n    \"id\":\"dev:sand:1.0.0\"\n  }\n}\n\nLoadbalanced Endpoint(with service catalog entries)\n{\n  \"endpoint_type\": \"load_balance\",\n  \"algoCombo\": \"org.apache.synapse.endpoints.algorithms.RoundRobin\",\n  \"sessionManagement\": \"\",\n  \"sandbox_endpoints\": [\n    {\n      \"url\": \"https://localhost:9443/am/sample/pizzashack/v1/api/1\"\n    },\n    {\n      \"endpoint_type\": \"catalog\",\n      \"id\": \"sand:abc:1.0\"\n    }\n  ],\n  \"production_endpoints\": [\n    {\n      \"url\": \"https://localhost:9443/am/sample/pizzashack/v1/api/3\"\n    },\n    {\n      \"endpoint_type\": \"catalog\",\n      \"id\": \"prod:abc:1.0\"\n    }\n  ],\n  \"sessionTimeOut\": \"\",\n  \"algoClassName\": \"org.apache.synapse.endpoints.algorithms.RoundRobin\"\n}            \n\nFailover Endpoint(with service catalog entries)\n{\n  \"production_failovers\": [\n    {\n      \"endpoint_type\": \"catalog\",\n      \"id\": \"cat1:abc:2.0\"\n    }\n  ],\n  \"endpoint_type\": \"failover\",\n  \"sandbox_endpoints\": {\n    \"url\": \"https://localhost:9443/am/sample/pizzashack/v1/api/2\"\n  },\n  \"production_endpoints\": {\n    \"url\": \"https://localhost:9443/am/sample/pizzashack/v1/api/3\"\n  },\n  \"sandbox_failovers\": [\n    {\n      \"endpoint_type\": \"catalog\",\n      \"id\": \"cat1:xyz:2.0\"\n    }\n  ]\n}", "createdAt": "2020-06-11T12:07:52Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8728", "merged": true, "mergeCommit": {"oid": "4e381abe0fa2b6af5cd1a5ab93546ece06a6b734"}, "closed": true, "closedAt": "2020-06-12T03:41:02Z", "author": {"login": "ChamodDamitha"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqNODYgH2gAyNDMzMDMyMjU5OmI4MjVmOWJmYWUwODM1YWVhZjU1ZjYzYmU0ZjJhZGQ4NjcwNWI2MWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqadvVgFqTQyOTQ0MTIwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d", "author": {"user": {"login": "ChamodDamitha", "name": "Chamod Damitha Samarajeewa"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/b825f9bfae0835aeaf55f63be4f2add86705b61d", "committedDate": "2020-06-11T12:15:01Z", "message": "Update API-Service-Catalog-Entry-Mapping to support LoadBalanced/Failover endpoints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7301ebb7f79352f6a79fe41ef9f89cee0a7dc5e", "author": {"user": {"login": "ChamodDamitha", "name": "Chamod Damitha Samarajeewa"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/a7301ebb7f79352f6a79fe41ef9f89cee0a7dc5e", "committedDate": "2020-06-11T12:05:52Z", "message": "Update API-Service-Catalog-Entry-Mapping to support LoadBalanced/Failover endpoints"}, "afterCommit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d", "author": {"user": {"login": "ChamodDamitha", "name": "Chamod Damitha Samarajeewa"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/b825f9bfae0835aeaf55f63be4f2add86705b61d", "committedDate": "2020-06-11T12:15:01Z", "message": "Update API-Service-Catalog-Entry-Mapping to support LoadBalanced/Failover endpoints"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODUyMjM4", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#pullrequestreview-428852238", "createdAt": "2020-06-11T12:18:41Z", "commit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjoxODo0MlrOGian9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjoxODo0MlrOGian9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc0MDk4MA==", "bodyText": "change naming in description", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#discussion_r438740980", "createdAt": "2020-06-11T12:18:42Z", "author": {"login": "fazlan-nazeem"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -10825,29 +10825,49 @@ public static KeyManagerConnectorConfiguration getKeyManagerConnectorConfigurati\n \n     /**\n      * Extract Endpoint Registry Entry information\n-     * @param endpointConfig\n-     * @return Map\n+     *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODU1ODc0", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#pullrequestreview-428855874", "createdAt": "2020-06-11T12:24:08Z", "commit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjoyNDowOFrOGiaycQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjoyNDowOFrOGiaycQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc0MzY2NQ==", "bodyText": "create to uppercase?", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#discussion_r438743665", "createdAt": "2020-06-11T12:24:08Z", "author": {"login": "fazlan-nazeem"}, "path": "features/apimgt/org.wso2.carbon.apimgt.core.feature/src/main/resources/sql/h2.sql", "diffHunk": "@@ -1876,11 +1876,12 @@ CREATE TABLE IF NOT EXISTS SERVICE_CATALOG_ENTRY (\n   FOREIGN KEY (CATALOG_ID) REFERENCES SERVICE_CATALOG (ID) ON DELETE CASCADE\n );\n \n-CREATE TABLE IF NOT EXISTS AM_API_ENDPOINT_REG_ENTRY_MAPPING (\n+create TABLE IF NOT EXISTS AM_API_SERVICE_CATALOG_ENTRY_MAPPING (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODU4Mzc5", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#pullrequestreview-428858379", "createdAt": "2020-06-11T12:27:42Z", "commit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjoyNzo0MlrOGia5lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjoyNzo0MlrOGia5lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc0NTQ5Mg==", "bodyText": "since \"validCatalogEndpoints\" is used repetitively, shall we add it to a constant field?", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#discussion_r438745492", "createdAt": "2020-06-11T12:27:42Z", "author": {"login": "fazlan-nazeem"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.publisher.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/publisher/v1/impl/ApisApiServiceImpl.java", "diffHunk": "@@ -4319,21 +4299,64 @@ public static ApiEndpointValidationResponseDTO sendHttpHEADRequest(String urlVal\n         return apiEndpointValidationResponseDTO;\n     }\n \n-    private boolean validateServiceCatalogEntries(LinkedHashMap endpointConfig) {\n-        Object productionCatalogEntry = null;\n-        Object sandboxCatalogEntry = null;\n-        LinkedHashMap productionEps = (LinkedHashMap) endpointConfig.get(\"production_endpoints\");\n-        LinkedHashMap sandboxEps = (LinkedHashMap) endpointConfig.get(\"sandbox_endpoints\");\n-        if (productionEps == null && sandboxEps == null) {\n+    private void validateServiceCatalogEntries(LinkedHashMap endpointConfig) {\n+\n+        Map<String, Boolean> productionEndpointStatus =\n+                validateServiceCatalogEndpoint(endpointConfig, APIConstants.API_DATA_PRODUCTION_ENDPOINTS);\n+        Map<String, Boolean> sandboxEndpointStatus =\n+                validateServiceCatalogEndpoint(endpointConfig, APIConstants.API_DATA_SANDBOX_ENDPOINTS);\n+        Map<String, Boolean> productionFailoverStatus =\n+                validateServiceCatalogEndpoint(endpointConfig, APIConstants.ENDPOINT_PRODUCTION_FAILOVERS);\n+        Map<String, Boolean> sandboxFailoverStatus =\n+                validateServiceCatalogEndpoint(endpointConfig, APIConstants.ENDPOINT_SANDBOX_FAILOVERS);\n+\n+        if (!productionEndpointStatus.get(\"hasEndpoints\") && !sandboxEndpointStatus.get(\"hasEndpoints\")) {\n             RestApiUtil.handleBadRequest(\"At least one endpoint from Production Endpoint or \" +\n                     \"Sandbox Endpoint must be defined.\", log);\n         }\n-        if (productionEps != null) {\n-            productionCatalogEntry = productionEps.get(\"id\");\n+        if (!(productionEndpointStatus.get(\"validCatalogEndpoints\") &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODYwMzcy", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#pullrequestreview-428860372", "createdAt": "2020-06-11T12:30:35Z", "commit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjozMDozNVrOGia_Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjozMDozNVrOGia_Bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc0Njg4Nw==", "bodyText": "change variable naming here?", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#discussion_r438746887", "createdAt": "2020-06-11T12:30:35Z", "author": {"login": "fazlan-nazeem"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -881,9 +880,9 @@ private void addAPI(API api, int tenantId) throws APIManagementException {\n         int apiId = apiMgtDAO.addAPI(api, tenantId);\n         addLocalScopes(api.getId(), tenantId, api.getUriTemplates());\n         addURITemplates(apiId, api, tenantId);\n-        Map endpointRegistryEntries = APIUtil.extractEndpointRegistryEntries(api.getEndpointConfig());\n-        if (endpointRegistryEntries != null) {\n-            apiMgtDAO.addAPIRegistryEntryMappings(apiId, endpointRegistryEntries, null);\n+        HashSet<String> endpointRegistryEntries = APIUtil.extractEndpointRegistryEntries(api.getEndpointConfig());\n+        if (!endpointRegistryEntries.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODYzMTgz", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#pullrequestreview-428863183", "createdAt": "2020-06-11T12:34:35Z", "commit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjozNDozNVrOGibHJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMjozNDozNVrOGibHJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc0ODk2Ng==", "bodyText": "Update Javadocs, The set contains failover and sandbox endpoint Ids, right?", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#discussion_r438748966", "createdAt": "2020-06-11T12:34:35Z", "author": {"login": "vithu30"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -14928,28 +14928,30 @@ public void addAPIRegistryEntryMappings(int apiId, Map endpointRegistryEntries,\n     }\n \n     /**\n-     * @param apiId                   ID of the API created using the Endpoint Registry Entry\n-     * @param endpointRegistryEntries Map contains production and sandbox endpoint ID\n-     * @throws APIManagementException\n+     * @param apiId                   ID of the API created using the Service Catalog Entry\n+     * @param endpointRegistryEntries HashSet contains production and sandbox endpoint IDs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b825f9bfae0835aeaf55f63be4f2add86705b61d"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "216e08f31573e70a482b6f9e3235b139d06c07bf", "author": {"user": {"login": "ChamodDamitha", "name": "Chamod Damitha Samarajeewa"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/216e08f31573e70a482b6f9e3235b139d06c07bf", "committedDate": "2020-06-11T12:58:05Z", "message": "Fix review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDQxMjAx", "url": "https://github.com/wso2/carbon-apimgt/pull/8728#pullrequestreview-429441201", "createdAt": "2020-06-12T03:40:55Z", "commit": {"oid": "216e08f31573e70a482b6f9e3235b139d06c07bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2632, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}