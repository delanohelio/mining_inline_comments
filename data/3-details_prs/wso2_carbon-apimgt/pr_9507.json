{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5MzUwMjE0", "number": 9507, "title": "Support new directory structure when bundling Deployment directory when importing APIs [APIM]", "bodyText": "Purpose\n\nThe proposal is to be able to maintain deployment-specific resources external to the API project in its folder structure so that it can be maintained in its deployment repo. So the same API Project can be paired with different deployment data by the deployment job in a CI/CD pipeline.\nThis is more of a best practice guideline that we are providing for separately maintain project data and deployment data so that it can be leveraged by apictl to deploy to across multiple environments effectively.\n\nGoals\nFixes wso2/product-apim-tooling#545\nApproach\nThe resource artefact to be passed with publisher/v1/api/import REST API calls a single zip artefact. Therefore the folder structure based on the use case that user is referring should be identified and the packaging of the information should be handled in the client-side. To achieve this the 3 use cases will have three different folder structures and contents inside the zip artefact to be imported.\nThen at the server-side, the zip will be resolved and the folder structure of the extracted file will be checked. Based on the differences at that folder structure the server will detect the path to proceed with further with the given use case.\n1.Import API without an external parameter file\n\u2514\u2500\u2500 temp_directory\n   \u2514\u2500\u2500 CustomerInfo-V1 (Source file)\n    \u251c\u2500\u2500 api.yaml\n    \u251c\u2500\u2500 Docs\n    \u2502   \u2514\u2500\u2500 Doc1\n    \u2502       \u2514\u2500\u2500 document.yaml\n    \u251c\u2500\u2500 Image\n    \u2502   \u2514\u2500\u2500 icon.png\n    \u251c\u2500\u2500 Definitions\n    \u2502   \u2514\u2500\u2500 swagger.yaml\n    \u2514\u2500\u2500 Sequences\n\n2.Import API with external parameters.yaml configurations file.\n\u2514\u2500\u2500 temp_directory\n   \u2514\u2500\u2500 CustomerInfo-V1.zip **(Source file)**\n   \u2514\u2500\u2500 api_params.yaml\n\n3. Import API with deployment repository directory which contains all the environment-related parameters.\n\u2514\u2500\u2500 temp_directory\n   \u2514\u2500\u2500 CustomerInfo-V1.zip **(Source file)**\n   \u2514\u2500\u2500 deploy **(deployment directory)**\n    \u251c\u2500\u2500 api_params.yaml\n    \u251c\u2500\u2500 Scripts\n    \u2502   \u2514\u2500\u2500 Script_migrate\n    \u2502       \u2514\u2500\u2500 script1.sh\n    \u251c\u2500\u2500 configMaps\n    \u2502   \u2514\u2500\u2500 map1.yaml\n    \u2502   \u2514\u2500\u2500 map2.yaml\n    \u251c\u2500\u2500 certificates\n    \u2502   \u2514\u2500\u2500 endpoint1.crt\n    \u2502   \u2514\u2500\u2500 endpoint2.crt\n    \u2502   \u2514\u2500\u2500 mutualssl.crt\n    \u2514\u2500\u2500 readMes\n\n** This temp_directory is the one to be zipped as a single directory or consolidated directory before passing as a resource via REST API call when importing APIs.\nUser stories\nThe deployment repository and source repository both have to transfer to the APIM Server-side using the single resource that is used in publisher/v1/api/import REST API call. There will be 3 use cases to consider when implementing this feature.\n1. Import API without external parameters file.\nIn here the source repository directory will be the only one import and transfer to the apim-server. There won\u2019t be any consolidated bundle created as an intermediate step.\napictl import api -f /home/chamindu/.wso2apictl/exported/apis/dev1/customer-info_1.0.0.zip  -e dev1  \n2. Import API with external parameters.yaml configurations file.\nIn here the configurations related to the environment will be defined in a single params.yaml file without any external references (such as certificates) and that file will be provided as the input for --params flag when importing the API.\napictl import api -f /home/chamindu/.wso2apictl/exported/apis/dev1/customer-info_1.0.0.zip  -e dev1 --params deploy_directory/env_params.yaml \n3. Import API with deployment  directory which contains all the environment-related parameters.\nIn here the configuration related to deployment will store in a separate directory (which will be the deployment repository directory) and inside that repository, the certificates, api_params.yaml file and all the other contents should be included. Then that directory will be provided as the input for --params flag when importing the API.\napictl import api -f /home/chamindu/.wso2apictl/exported/apis/dev1/customer-info_1.0.0.zip  -e dev1 --params deploy_directory \nDocumentation\nDocs need to be changed\nRelated PRs\nwso2/product-apim-tooling#553\nTest environment\nOS - Ubuntu 20.04 LTS\nJava - JDK 1.8_252\nAPIM - Latest Master branch version", "createdAt": "2020-12-14T10:45:37Z", "url": "https://github.com/wso2/carbon-apimgt/pull/9507", "merged": true, "mergeCommit": {"oid": "e6c16144d2efdcb86eeeed34b9504392baf47988"}, "closed": true, "closedAt": "2020-12-16T06:18:32Z", "author": {"login": "Chamindu36"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlaJLBgH2gAyNTM5MzUwMjE0OmU2ZjNhZTYyM2VmZDkxYjYwNmRlYTVhMWY1MmI2ZTAzZWRmNWFkYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdx-i9_AFqTU3MjE0NDIxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e6f3ae623efd91b606dea5a1f52b6e03edf5adae", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/e6f3ae623efd91b606dea5a1f52b6e03edf5adae", "committedDate": "2020-12-12T10:39:59Z", "message": "Change default endpoint value usage and add missing exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03ef57514517b09622d21813ba317510fcdf6a14", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/03ef57514517b09622d21813ba317510fcdf6a14", "committedDate": "2020-12-12T10:44:09Z", "message": "Implement deployment directory related flows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97e6bb7b7e46483304ef04f654692c8e787d236d", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/97e6bb7b7e46483304ef04f654692c8e787d236d", "committedDate": "2020-12-12T10:56:56Z", "message": "Change certificate handling flow using deployment directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d28f593c10f5ecd78308e6e00fefc12987b8ec6", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/4d28f593c10f5ecd78308e6e00fefc12987b8ec6", "committedDate": "2020-12-12T10:58:29Z", "message": "Applying new directory structure processing flow into API import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "113444aa167b8719fe22c58fad6939714b885e6f", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/113444aa167b8719fe22c58fad6939714b885e6f", "committedDate": "2020-12-15T10:13:09Z", "message": "Add new exception code for api_param related exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27f21bd4ad4ed1b9b742885eed2a9eec82e016f4", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/27f21bd4ad4ed1b9b742885eed2a9eec82e016f4", "committedDate": "2020-12-15T15:26:08Z", "message": "Change path of the destination when copying api_params.yaml file"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f9f506163c22c2cdf96ca9f0d198bdc7f7483e5", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/1f9f506163c22c2cdf96ca9f0d198bdc7f7483e5", "committedDate": "2020-12-15T12:50:55Z", "message": "Change path of the destination when copying api_params.yaml file"}, "afterCommit": {"oid": "27f21bd4ad4ed1b9b742885eed2a9eec82e016f4", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/27f21bd4ad4ed1b9b742885eed2a9eec82e016f4", "committedDate": "2020-12-15T15:26:08Z", "message": "Change path of the destination when copying api_params.yaml file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMzg1MjAw", "url": "https://github.com/wso2/carbon-apimgt/pull/9507#pullrequestreview-553385200", "createdAt": "2020-12-16T06:18:18Z", "commit": {"oid": "27f21bd4ad4ed1b9b742885eed2a9eec82e016f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyMTQ0MjEx", "url": "https://github.com/wso2/carbon-apimgt/pull/9507#pullrequestreview-572144211", "createdAt": "2021-01-20T11:51:49Z", "commit": {"oid": "27f21bd4ad4ed1b9b742885eed2a9eec82e016f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxMTo1MTo0OVrOIW6vDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxMTo1MTo0OVrOIW6vDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDkwMTkwMw==", "bodyText": "Shall we remove this extra line?", "url": "https://github.com/wso2/carbon-apimgt/pull/9507#discussion_r560901903", "createdAt": "2021-01-20T11:51:49Z", "author": {"login": "hisanhunais"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/importexport/utils/CommonUtil.java", "diffHunk": "@@ -373,4 +374,38 @@ public static void moveFile(String source, String dest) throws APIManagementExce\n             throw new APIManagementException(errorMessage, e);\n         }\n     }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27f21bd4ad4ed1b9b742885eed2a9eec82e016f4"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3044, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}