{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NjEwNTc4", "number": 9059, "title": "Fix for https://github.com/wso2/product-apim-tooling/issues/418", "bodyText": "Purpose\nWhen importing An Application using API Controller it gives an error when that importing application has an active subscription with an API Product. This PR will solve this issue and remove the above mentioned blocker\nGoals\nFixes wso2/product-apim-tooling#418\nApproach\nWhen search query executed on REST API, it will return a map of objects which are equal to the given search query. But the latest new feature support of API products from APICTL tool this map will return both API and API Product objects. Currently this import application method only assert the subscriptions of API objects only.\nSo this PR will provide the ability to detect the type of the returning object (API or APIProduct) and assert that object. Then necessary steps will be executed the import Application based on type of subscriptions that has with Applications.\nUser stories\nImporting an Application using the API Controller tool which has active subscriptions with APIs and APIProducts.\nTest environment\nOS - Ubuntu 20.04 LTS\nJava - JDK 1.8_252\nAPIM - 3.2.0\nGO - 1.14\nAPICTL- 3.1.3", "createdAt": "2020-07-25T12:38:17Z", "url": "https://github.com/wso2/carbon-apimgt/pull/9059", "merged": true, "mergeCommit": {"oid": "8da5382d7d54f5a12e8e97a1e465c228915134e7"}, "closed": true, "closedAt": "2020-07-28T11:35:49Z", "author": {"login": "Chamindu36"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4QFpAgH2gAyNDU2NjEwNTc4OmMzMmNlYjNiYjM3ODQwMDVkMGUyMGQyZmQ3ZmZjNWUzNjEyMmQ3ZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5JRpPgFqTQ1NjE2OTYyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c32ceb3bb3784005d0e20d2fd7ffc5e36122d7ec", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/c32ceb3bb3784005d0e20d2fd7ffc5e36122d7ec", "committedDate": "2020-07-25T03:30:29Z", "message": "Provide support for application import with API product subscriptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b416ba16311b4c6a7d5f717b02de5693c32a48b9", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/b416ba16311b4c6a7d5f717b02de5693c32a48b9", "committedDate": "2020-07-25T08:02:25Z", "message": "Adding doc comments and formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1Mjg2NTIx", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#pullrequestreview-455286521", "createdAt": "2020-07-25T13:55:30Z", "commit": {"oid": "b416ba16311b4c6a7d5f717b02de5693c32a48b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQxMzo1NTozMFrOG3FCFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQxMzo1NTozMFrOG3FCFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNzMxNw==", "bodyText": "I think we can remove the duplicated code segments from 145 to 163 and 165 to 186 as below. Just check and do the required changes.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                //Check whether the object is an ApiProduct\n          \n          \n            \n                                if (isApiProduct(type)) {\n          \n          \n            \n                                    //Handle Api Product subscriptions\n          \n          \n            \n                                    APIProduct apiProduct = (APIProduct) apiSet.iterator().next();\n          \n          \n            \n                                    //tier of the imported subscription\n          \n          \n            \n                                    Tier tier = subscribedAPI.getTier();\n          \n          \n            \n                                    //checking whether the target tier is available\n          \n          \n            \n                                    if (isTierAvailableForProduct(tier, apiProduct) && apiProduct.getState() != null &&\n          \n          \n            \n                                            APIConstants.PUBLISHED.equals(apiProduct.getState())) {\n          \n          \n            \n                                        ApiTypeWrapper apiTypeWrapper = new ApiTypeWrapper(apiProduct);\n          \n          \n            \n                                        apiTypeWrapper.setTier(tier.getName());\n          \n          \n            \n                                        // add subscription if update flag is not specified\n          \n          \n            \n                                        // it will throw an error if subscriber already exists\n          \n          \n            \n                                        if (update == null || !update) {\n          \n          \n            \n                                            apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n          \n          \n            \n                                        } else if (!apiConsumer.isSubscribedToApp(subscribedAPI.getApiId(), userId, appId)) {\n          \n          \n            \n                                            // on update skip subscriptions that already exists\n          \n          \n            \n                                            apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n          \n          \n            \n                                        }\n          \n          \n            \n                                    } else {\n          \n          \n            \n                                        log.error(\"Failed to import Subscription as API \" + name + \"-\" + version +\n          \n          \n            \n                                                \" as one or more tiers may be unavailable or the API may not have been published \");\n          \n          \n            \n                                        skippedAPIList.add(subscribedAPI.getApiId());\n          \n          \n            \n                                ApiTypeWrapper apiTypeWrapper = null;\n          \n          \n            \n                                if (isApiProduct(type)) {\n          \n          \n            \n                                    APIProduct apiProduct = (APIProduct) apiSet.iterator().next();\n          \n          \n            \n                                    apiTypeWrapper = new ApiTypeWrapper(apiProduct);\n          \n          \n            \n                                } else {\n          \n          \n            \n                                    API api = (API) apiSet.iterator().next();\n          \n          \n            \n                                    apiTypeWrapper = new ApiTypeWrapper(api);\n          \n          \n            \n                                }\n          \n          \n            \n                                //tier of the imported subscription\n          \n          \n            \n                                Tier tier = subscribedAPI.getTier();\n          \n          \n            \n                                //checking whether the target tier is available\n          \n          \n            \n                                if (isTierAvailable(tier, apiTypeWrapper) && apiTypeWrapper.getStatus() != null &&\n          \n          \n            \n                                        APIConstants.PUBLISHED.equals(apiTypeWrapper.getStatus())) {\n          \n          \n            \n                                        apiTypeWrapper.setTier(tier.getName());\n          \n          \n            \n                                        // add subscription if update flag is not specified\n          \n          \n            \n                                        // it will throw an error if subscriber already exists\n          \n          \n            \n                                        if (update == null || !update) {\n          \n          \n            \n                                            apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n          \n          \n            \n                                        } else if (!apiConsumer.isSubscribedToApp(subscribedAPI.getApiId(), userId, appId)) {\n          \n          \n            \n                                            // on update skip subscriptions that already exists\n          \n          \n            \n                                            apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n          \n          \n            \n                                        }\n          \n          \n            \n                                } else {\n          \n          \n            \n                                        log.error(\"Failed to import Subscription as API/API Product \" + name + \"-\" + version +\n          \n          \n            \n                                        \" as one or more tiers may be unavailable or the API/API Product may not have been published \");\n          \n          \n            \n                                        skippedAPIList.add(subscribedAPI.getApiId());\n          \n          \n            \n                                }", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#discussion_r460407317", "createdAt": "2020-07-25T13:55:30Z", "author": {"login": "wasuradananjith"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/ApplicationImportExportManager.java", "diffHunk": "@@ -134,28 +134,56 @@ public boolean isOwnerAvailable(String userId) throws APIManagementException {\n                 matchedAPIs = apiConsumer.searchPaginatedAPIs(searchQuery.toString(), tenantDomain, 0,\n                         Integer.MAX_VALUE,\n                         false);\n-                Set<API> apiSet = (Set<API>) matchedAPIs.get(\"apis\");\n+                Set<Object> apiSet = (Set<Object>) matchedAPIs.get(\"apis\");\n                 if (apiSet != null && !apiSet.isEmpty()) {\n-                    API api = apiSet.iterator().next();\n-                    //tier of the imported subscription\n-                    Tier tier = subscribedAPI.getTier();\n-                    //checking whether the target tier is available\n-                    if (isTierAvailable(tier, api) && api.getStatus() != null &&\n-                            APIConstants.PUBLISHED.equals(api.getStatus())) {\n-                        ApiTypeWrapper apiTypeWrapper = new ApiTypeWrapper(api);\n-                        apiTypeWrapper.setTier(tier.getName());\n-                        // add subscription if update flag is not specified\n-                        // it will throw an error if subscriber already exists\n-                        if (update == null || !update) {\n-                            apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n-                        } else if (!apiConsumer.isSubscribedToApp(subscribedAPI.getApiId(), userId, appId)) {\n-                            // on update skip subscriptions that already exists\n-                            apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n+                    Object type = apiSet.iterator().next();\n+                    //Check whether the object is an ApiProduct\n+                    if (isApiProduct(type)) {\n+                        //Handle Api Product subscriptions\n+                        APIProduct apiProduct = (APIProduct) apiSet.iterator().next();\n+                        //tier of the imported subscription\n+                        Tier tier = subscribedAPI.getTier();\n+                        //checking whether the target tier is available\n+                        if (isTierAvailableForProduct(tier, apiProduct) && apiProduct.getState() != null &&\n+                                APIConstants.PUBLISHED.equals(apiProduct.getState())) {\n+                            ApiTypeWrapper apiTypeWrapper = new ApiTypeWrapper(apiProduct);\n+                            apiTypeWrapper.setTier(tier.getName());\n+                            // add subscription if update flag is not specified\n+                            // it will throw an error if subscriber already exists\n+                            if (update == null || !update) {\n+                                apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n+                            } else if (!apiConsumer.isSubscribedToApp(subscribedAPI.getApiId(), userId, appId)) {\n+                                // on update skip subscriptions that already exists\n+                                apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n+                            }\n+                        } else {\n+                            log.error(\"Failed to import Subscription as API \" + name + \"-\" + version +\n+                                    \" as one or more tiers may be unavailable or the API may not have been published \");\n+                            skippedAPIList.add(subscribedAPI.getApiId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b416ba16311b4c6a7d5f717b02de5693c32a48b9"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1Mjg2NTk5", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#pullrequestreview-455286599", "createdAt": "2020-07-25T13:56:55Z", "commit": {"oid": "b416ba16311b4c6a7d5f717b02de5693c32a48b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQxMzo1Njo1NVrOG3FCkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQxMzo1Njo1NVrOG3FCkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNzQ0MA==", "bodyText": "I think we can remove this whole else part.", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#discussion_r460407440", "createdAt": "2020-07-25T13:56:55Z", "author": {"login": "wasuradananjith"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/ApplicationImportExportManager.java", "diffHunk": "@@ -134,28 +134,56 @@ public boolean isOwnerAvailable(String userId) throws APIManagementException {\n                 matchedAPIs = apiConsumer.searchPaginatedAPIs(searchQuery.toString(), tenantDomain, 0,\n                         Integer.MAX_VALUE,\n                         false);\n-                Set<API> apiSet = (Set<API>) matchedAPIs.get(\"apis\");\n+                Set<Object> apiSet = (Set<Object>) matchedAPIs.get(\"apis\");\n                 if (apiSet != null && !apiSet.isEmpty()) {\n-                    API api = apiSet.iterator().next();\n-                    //tier of the imported subscription\n-                    Tier tier = subscribedAPI.getTier();\n-                    //checking whether the target tier is available\n-                    if (isTierAvailable(tier, api) && api.getStatus() != null &&\n-                            APIConstants.PUBLISHED.equals(api.getStatus())) {\n-                        ApiTypeWrapper apiTypeWrapper = new ApiTypeWrapper(api);\n-                        apiTypeWrapper.setTier(tier.getName());\n-                        // add subscription if update flag is not specified\n-                        // it will throw an error if subscriber already exists\n-                        if (update == null || !update) {\n-                            apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n-                        } else if (!apiConsumer.isSubscribedToApp(subscribedAPI.getApiId(), userId, appId)) {\n-                            // on update skip subscriptions that already exists\n-                            apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n+                    Object type = apiSet.iterator().next();\n+                    //Check whether the object is an ApiProduct\n+                    if (isApiProduct(type)) {\n+                        //Handle Api Product subscriptions\n+                        APIProduct apiProduct = (APIProduct) apiSet.iterator().next();\n+                        //tier of the imported subscription\n+                        Tier tier = subscribedAPI.getTier();\n+                        //checking whether the target tier is available\n+                        if (isTierAvailableForProduct(tier, apiProduct) && apiProduct.getState() != null &&\n+                                APIConstants.PUBLISHED.equals(apiProduct.getState())) {\n+                            ApiTypeWrapper apiTypeWrapper = new ApiTypeWrapper(apiProduct);\n+                            apiTypeWrapper.setTier(tier.getName());\n+                            // add subscription if update flag is not specified\n+                            // it will throw an error if subscriber already exists\n+                            if (update == null || !update) {\n+                                apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n+                            } else if (!apiConsumer.isSubscribedToApp(subscribedAPI.getApiId(), userId, appId)) {\n+                                // on update skip subscriptions that already exists\n+                                apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n+                            }\n+                        } else {\n+                            log.error(\"Failed to import Subscription as API \" + name + \"-\" + version +\n+                                    \" as one or more tiers may be unavailable or the API may not have been published \");\n+                            skippedAPIList.add(subscribedAPI.getApiId());\n                         }\n                     } else {\n-                        log.error(\"Failed to import Subscription as API \" + name + \"-\" + version +\n-                                \" as one or more tiers may be unavailable or the API may not have been published \");\n-                        skippedAPIList.add(subscribedAPI.getApiId());\n+                        //Handle API subscriptions\n+                        API api = (API) apiSet.iterator().next();\n+                        //tier of the imported subscription\n+                        Tier tier = subscribedAPI.getTier();\n+                        //checking whether the target tier is available\n+                        if (isTierAvailable(tier, api) && api.getStatus() != null &&\n+                                APIConstants.PUBLISHED.equals(api.getStatus())) {\n+                            ApiTypeWrapper apiTypeWrapper = new ApiTypeWrapper(api);\n+                            apiTypeWrapper.setTier(tier.getName());\n+                            // add subscription if update flag is not specified\n+                            // it will throw an error if subscriber already exists\n+                            if (update == null || !update) {\n+                                apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n+                            } else if (!apiConsumer.isSubscribedToApp(subscribedAPI.getApiId(), userId, appId)) {\n+                                // on update skip subscriptions that already exists\n+                                apiConsumer.addSubscription(apiTypeWrapper, userId, appId);\n+                            }\n+                        } else {\n+                            log.error(\"Failed to import Subscription as API \" + name + \"-\" + version +\n+                                    \" as one or more tiers may be unavailable or the API may not have been published \");\n+                            skippedAPIList.add(subscribedAPI.getApiId());\n+                        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b416ba16311b4c6a7d5f717b02de5693c32a48b9"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1Mjg2NzI4", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#pullrequestreview-455286728", "createdAt": "2020-07-25T13:59:29Z", "commit": {"oid": "b416ba16311b4c6a7d5f717b02de5693c32a48b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQxMzo1OToyOVrOG3FDRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNVQxMzo1OToyOVrOG3FDRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNzYyMw==", "bodyText": "I think we don't need another function like this. We can modify the existing isTierAvailable function as below. Just check the feasibility whether we can do like this.\nprivate boolean isTierAvailable(Tier targetTier, ApiTypeWrapper apiTypeWrapper) {\n\tSet<Tier> availableTiers = null;\n\tif (!apiTypeWrapper.isAPIProduct()) {\n\t\tAPIIdentifier apiId = apiTypeWrapper.getApi().getId();\n\t\tavailableTiers = api.getAvailableTiers();\n\t} else {\n\t\tAPIProductIdentifier apiProductId = apiTypeWrapper.getApiProduct().getId();\n\t\tavailableTiers = apiProductId.getAvailableTiers();\n\t}\n        if (availableTiers.contains(targetTier)) {\n            return true;\n        } else {\n            log.error(\"Tier:\" + targetTier.getName() + \" is not available for API \" + apiId.getApiName() + \"-\" +\n                    apiId.getVersion());\n            return false;\n        }\n}", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#discussion_r460407623", "createdAt": "2020-07-25T13:59:29Z", "author": {"login": "wasuradananjith"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/ApplicationImportExportManager.java", "diffHunk": "@@ -188,6 +216,41 @@ private boolean isTierAvailable(Tier targetTier, API api) {\n         }\n     }\n \n+    /**\n+     * Check whether the object is a type of ApiProduct\n+     *\n+     * @param object        - {@link Object}\n+     * @return true, if the object is an ApiProduct, otherwise false\n+     */\n+    private boolean isApiProduct(Object object) {\n+        try {\n+            //Cast object to ApiProduct\n+            APIProduct apiProduct = (APIProduct) object;\n+            return (apiProduct != null) ? true : false;\n+        } catch (Exception e) {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Check whether a target Tier is available to subscribe\n+     *\n+     * @param targetTier Target Tier\n+     * @param apiProduct - {@link APIProduct}\n+     * @return true, if the target tier is available\n+     */\n+    private boolean isTierAvailableForProduct(Tier targetTier, APIProduct apiProduct) {\n+        APIProductIdentifier apiProductId = apiProduct.getId();\n+        Set<Tier> availableTiers = apiProduct.getAvailableTiers();\n+        if (availableTiers.contains(targetTier)) {\n+            return true;\n+        } else {\n+            log.error(\"Tier:\" + targetTier.getName() + \" is not available for API Product \" + apiProductId.getName() + \"-\" +\n+                    apiProductId.getVersion());\n+            return false;\n+        }\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b416ba16311b4c6a7d5f717b02de5693c32a48b9"}, "originalPosition": 123}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dc9adee472b9d8583783358639137d2206b5b86", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/5dc9adee472b9d8583783358639137d2206b5b86", "committedDate": "2020-07-25T16:29:47Z", "message": "Fixing reviews and adding suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1Mjk5MzI1", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#pullrequestreview-455299325", "createdAt": "2020-07-25T17:44:36Z", "commit": {"oid": "5dc9adee472b9d8583783358639137d2206b5b86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NDQ0MDI3", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#pullrequestreview-455444027", "createdAt": "2020-07-27T02:56:54Z", "commit": {"oid": "5dc9adee472b9d8583783358639137d2206b5b86"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMjo1Njo1NFrOG3SHAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMjo1Njo1NFrOG3SHAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYyMTU3MA==", "bodyText": "can't we use instanceOf?\nAlso, don't catch generic \"Exception\"s unless there is a really specific need.", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#discussion_r460621570", "createdAt": "2020-07-27T02:56:54Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/ApplicationImportExportManager.java", "diffHunk": "@@ -172,18 +180,47 @@ public boolean isOwnerAvailable(String userId) throws APIManagementException {\n     /**\n      * Check whether a target Tier is available to subscribe\n      *\n-     * @param targetTier Target Tier\n-     * @param api        - {@link API}\n+     * @param targetTier     Target Tier\n+     * @param apiTypeWrapper - {@link ApiTypeWrapper}\n      * @return true, if the target tier is available\n      */\n-    private boolean isTierAvailable(Tier targetTier, API api) {\n-        APIIdentifier apiId = api.getId();\n-        Set<Tier> availableTiers = api.getAvailableTiers();\n+    private boolean isTierAvailable(Tier targetTier, ApiTypeWrapper apiTypeWrapper) {\n+        Set<Tier> availableTiers = null;\n+        API api = null;\n+        APIProduct apiProduct = null;\n+        if (!apiTypeWrapper.isAPIProduct()) {\n+            api = apiTypeWrapper.getApi();\n+            availableTiers = api.getAvailableTiers();\n+        } else {\n+            apiProduct = apiTypeWrapper.getApiProduct();\n+            availableTiers = apiProduct.getAvailableTiers();\n+        }\n         if (availableTiers.contains(targetTier)) {\n             return true;\n         } else {\n-            log.error(\"Tier:\" + targetTier.getName() + \" is not available for API \" + apiId.getApiName() + \"-\" +\n-                    apiId.getVersion());\n+            if (!apiTypeWrapper.isAPIProduct()) {\n+                log.error(\"Tier:\" + targetTier.getName() + \" is not available for API \" + api.getId().getApiName() + \"-\" +\n+                        api.getId().getVersion());\n+            } else {\n+                log.error(\"Tier:\" + targetTier.getName() + \" is not available for API Product \" + apiProduct.getId().getName() + \"-\" +\n+                        apiProduct.getId().getVersion());\n+            }\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Check whether the object is a type of ApiProduct\n+     *\n+     * @param object        - {@link Object}\n+     * @return true, if the object is an ApiProduct, otherwise false\n+     */\n+    private boolean isApiProduct(Object object) {\n+        try {\n+            //Cast object to ApiProduct\n+            APIProduct apiProduct = (APIProduct) object;\n+            return (apiProduct != null) ? true : false;\n+        } catch (Exception e) {\n             return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5dc9adee472b9d8583783358639137d2206b5b86"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06a96a827b1ad7cb32f57fbbb5323ff8b6307884", "author": {"user": {"login": "Chamindu36", "name": "Chamindu Udakara"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/06a96a827b1ad7cb32f57fbbb5323ff8b6307884", "committedDate": "2020-07-27T05:11:54Z", "message": "Changing isApiProduct Function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NTI5NTE4", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#pullrequestreview-455529518", "createdAt": "2020-07-27T07:23:16Z", "commit": {"oid": "06a96a827b1ad7cb32f57fbbb5323ff8b6307884"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTY5NjIy", "url": "https://github.com/wso2/carbon-apimgt/pull/9059#pullrequestreview-456169622", "createdAt": "2020-07-27T22:08:11Z", "commit": {"oid": "06a96a827b1ad7cb32f57fbbb5323ff8b6307884"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2535, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}