{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzODg4NjU2", "number": 8914, "title": "Generate backend jwt using claims from external rest api", "bodyText": "This PR is to get user claims from external service and generated the backend JWT token using that", "createdAt": "2020-07-03T07:00:54Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8914", "merged": true, "mergeCommit": {"oid": "a1ba6abdb3623cb051f0e984abb85016759bb7bb"}, "closed": true, "closedAt": "2020-07-05T16:33:36Z", "author": {"login": "chamilaadhi"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxJh2_AH2gAyNDQzODg4NjU2OjdlNWFiN2ViNDdmMmY5NmQ0ODBhZDNmMTY1ZWNhMTM5Y2MzZDg5ZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcx9yyLgH2gAyNDQzODg4NjU2OjEyMDZkM2Q3NDU0M2JlMGYzMDc4NjhjY2YxM2Y5MWFmZWM2ZTRhMTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e5ab7eb47f2f96d480ad3f165eca139cc3d89fc", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/7e5ab7eb47f2f96d480ad3f165eca139cc3d89fc", "committedDate": "2020-07-03T01:54:30Z", "message": "Add feign client to retrieve claim"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcd710cf8d3b1ed7e2bd31118135ee278fe910d4", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/dcd710cf8d3b1ed7e2bd31118135ee278fe910d4", "committedDate": "2020-07-03T02:07:58Z", "message": "Update client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29a03bd78e977613a326b3520dec826d087d7850", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/29a03bd78e977613a326b3520dec826d087d7850", "committedDate": "2020-07-03T02:37:48Z", "message": "Add method to retrieve claims"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db57f90de4f70bc997e62c59a7342208a661a0e2", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/db57f90de4f70bc997e62c59a7342208a661a0e2", "committedDate": "2020-07-03T02:57:16Z", "message": "Add generator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9537e1997c13ed841386a48d5f6654b809c2891e", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/9537e1997c13ed841386a48d5f6654b809c2891e", "committedDate": "2020-07-03T04:10:24Z", "message": "Remove unncessary teset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1ae292ac5a3d9174aad64bc13edc006f04bc086", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/b1ae292ac5a3d9174aad64bc13edc006f04bc086", "committedDate": "2020-07-03T05:51:59Z", "message": "Refactor logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e6082b1c73538a29b09bebca03aa010905245f7", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/6e6082b1c73538a29b09bebca03aa010905245f7", "committedDate": "2020-07-03T06:56:42Z", "message": "Fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjMzNjY0", "url": "https://github.com/wso2/carbon-apimgt/pull/8914#pullrequestreview-442233664", "createdAt": "2020-07-03T08:19:32Z", "commit": {"oid": "6e6082b1c73538a29b09bebca03aa010905245f7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwODoxOTozMlrOGsoBeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwODoyMjozNVrOGsoHSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0NjI2NQ==", "bodyText": "this line doesn't needed", "url": "https://github.com/wso2/carbon-apimgt/pull/8914#discussion_r449446265", "createdAt": "2020-07-03T08:19:32Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/AMDefaultKeyManagerImpl.java", "diffHunk": "@@ -965,5 +987,38 @@ private void addKeyManagerConfigsAsSystemProperties(String serviceUrl) {\n             log.error(\"Exception While resolving KeyManager Server URL or Port \" + e.getMessage(), e);\n         }\n     }\n+    \n+    @Override\n+    public Map<String, String> getUserClaims(String username, Map<String, Object> properties)\n+            throws APIManagementException {\n \n+        Map<String, String> map = new HashMap<String, String>();\n+        String tenantAwareUserName = MultitenantUtils.getTenantAwareUsername(username);\n+        UserInfoDTO userinfo = new UserInfoDTO();\n+        userinfo.setUsername(tenantAwareUserName);\n+        if (tenantAwareUserName.contains(APIConstants.DOMAIN_SEPARATOR)) {\n+            userinfo.setDomain(tenantAwareUserName.split(APIConstants.DOMAIN_SEPARATOR)[0]);\n+        }\n+        if (properties.containsKey(APIConstants.KeyManager.AUTH_CODE)) {\n+            userinfo.setAuthCode(properties.get(APIConstants.KeyManager.AUTH_CODE).toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e6082b1c73538a29b09bebca03aa010905245f7"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ0Nzc1NQ==", "bodyText": "this one doesn't need since done in webapp", "url": "https://github.com/wso2/carbon-apimgt/pull/8914#discussion_r449447755", "createdAt": "2020-07-03T08:22:35Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/token/JWTGenerator.java", "diffHunk": "@@ -126,75 +130,43 @@\n     public Map<String, String> populateCustomClaims(TokenValidationContext validationContext)\n             throws APIManagementException {\n \n-        ClaimsRetriever claimsRetriever = getClaimsRetriever();\n-        if (claimsRetriever != null) {\n-            Map<ClaimMapping, String> customClaimsWithMapping = new HashMap<>();\n-            Map<String, String> customClaims;\n-            //fix for https://github.com/wso2/product-apim/issues/4112\n-            String accessToken = validationContext.getAccessToken();\n-            String authCode = validationContext.getAuthorizationCode();\n-            if (accessToken != null) {\n-                AuthorizationGrantCacheEntry cacheEntry = AuthorizationGrantCache.getInstance()\n-                        .getValueFromCacheByToken(new AuthorizationGrantCacheKey(accessToken));\n-                if (cacheEntry != null) {\n-                    customClaimsWithMapping.putAll(cacheEntry.getUserAttributes());\n-                }\n-            } else if (authCode != null) {\n-                AuthorizationGrantCacheEntry cacheEntry = AuthorizationGrantCache.getInstance()\n-                        .getValueFromCacheByCode(new AuthorizationGrantCacheKey(authCode));\n-                if (cacheEntry != null) {\n-                    customClaimsWithMapping.putAll(cacheEntry.getUserAttributes());\n-                }\n-            } else {\n-                customClaimsWithMapping.putAll(validationContext.getUser().getUserAttributes());\n-            }\n-            String username = validationContext.getValidationInfoDTO().getEndUserName();\n-            int tenantId = APIUtil.getTenantId(username);\n-\n-            customClaims = convertClaimMap(customClaimsWithMapping, username);\n-\n-            if (isNotEmpty(customClaims)) {\n-                if (log.isDebugEnabled()) {\n-                    log.debug(\"The custom claims are retrieved from AuthorizationGrantCache for user : \" +\n-                            validationContext.getValidationInfoDTO().getEndUserName());\n-                }\n-            } else {\n-                if (log.isDebugEnabled()) {\n-                    log.debug(\"Custom claims are not available in the AuthorizationGrantCache. Hence will be \" +\n-                            \"retrieved from the user store for user : \" +\n-                            validationContext.getValidationInfoDTO().getEndUserName());\n-                }\n-            }\n-            // If claims are not found in AuthorizationGrantCache, they will be retrieved from the userstore.\n+        Map<ClaimMapping, String> customClaimsWithMapping = new HashMap<>();\n+        Map<String, String> customClaims;\n+        Map<String, Object> properties = new HashMap<String, Object>();\n \n-            try {\n+        String accessToken = validationContext.getAccessToken();\n+        String authCode = validationContext.getAuthorizationCode();\n+        if (accessToken != null) {\n+            properties.put(APIConstants.KeyManager.ACCESS_TOKEN, accessToken);\n+        } else if (authCode != null) {\n+            properties.put(APIConstants.KeyManager.AUTH_CODE, authCode);\n+        } else {\n+            customClaimsWithMapping.putAll(validationContext.getUser().getUserAttributes());\n+        }\n+        String username = validationContext.getValidationInfoDTO().getEndUserName();\n+        int tenantId = APIUtil.getTenantId(username);\n \n-                if (tenantId != -1) {\n-                    UserStoreManager manager = ServiceReferenceHolder.getInstance().\n-                            getRealmService().getTenantUserRealm(tenantId).getUserStoreManager();\n+        customClaims = convertClaimMap(customClaimsWithMapping, username);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e6082b1c73538a29b09bebca03aa010905245f7"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ae8b48cb775d2d8d85d277bafa6ca25d69897a7", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/2ae8b48cb775d2d8d85d277bafa6ca25d69897a7", "committedDate": "2020-07-03T09:10:40Z", "message": "Add review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjc4OTUx", "url": "https://github.com/wso2/carbon-apimgt/pull/8914#pullrequestreview-442278951", "createdAt": "2020-07-03T09:27:12Z", "commit": {"oid": "2ae8b48cb775d2d8d85d277bafa6ca25d69897a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed1cc02280bd65f128c55b49a2dd3903fca1a29d", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/ed1cc02280bd65f128c55b49a2dd3903fca1a29d", "committedDate": "2020-07-05T14:03:01Z", "message": "Add DefaultClaimsRetriever back and omit it from the jwt generator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64462732a576179bb5ad1ba0f6cef7b20c4918c6", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/64462732a576179bb5ad1ba0f6cef7b20c4918c6", "committedDate": "2020-07-05T14:37:46Z", "message": "Add default claims retriever back"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36b2c4c985a4de340a8da2c9aa496ff11493ecb4", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/36b2c4c985a4de340a8da2c9aa496ff11493ecb4", "committedDate": "2020-07-05T14:38:17Z", "message": "Add extended claim retriever"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1206d3d74543be0f307868ccf13f91afec6e4a17", "author": {"user": {"login": "chamilaadhi", "name": "Chamila Adhikarinayake"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/1206d3d74543be0f307868ccf13f91afec6e4a17", "committedDate": "2020-07-05T14:48:03Z", "message": "Add to default json"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2625, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}