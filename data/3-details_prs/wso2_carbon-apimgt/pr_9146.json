{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MjA4OTMz", "number": 9146, "title": "Fix multiple issues", "bodyText": "fix Websocket authentication in opaque\nfix JWT doesn't contain application attributed and application uuid\nfix APIKey throttling", "createdAt": "2020-08-06T18:59:59Z", "url": "https://github.com/wso2/carbon-apimgt/pull/9146", "merged": true, "mergeCommit": {"oid": "2e495604cc884e233d4f972ce5fc6c40748712f0"}, "closed": true, "closedAt": "2020-08-07T10:56:01Z", "author": {"login": "tharindu1st"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8U8ipAFqTQ2MjgwOTQyOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8iEhbgBqjM2MzI3MzI0Mjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyODA5NDI5", "url": "https://github.com/wso2/carbon-apimgt/pull/9146#pullrequestreview-462809429", "createdAt": "2020-08-06T19:21:17Z", "commit": {"oid": "c77f2ff833e544825cf1fb6b776cbdbc93c4defc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxOToyMToxOFrOG9BECw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxOToyNDo0MFrOG9BKpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYzMzczOQ==", "bodyText": "can make 1 string.", "url": "https://github.com/wso2/carbon-apimgt/pull/9146#discussion_r466633739", "createdAt": "2020-08-06T19:21:18Z", "author": {"login": "bhathiya"}, "path": "components/apimgt/org.wso2.carbon.apimgt.gateway/src/main/java/org/wso2/carbon/apimgt/gateway/handlers/security/jwt/JWTValidator.java", "diffHunk": "@@ -151,7 +151,13 @@ public AuthenticationContext authenticate(SignedJWTInfo signedJWTInfo, MessageCo\n                     log.debug(\"Subscription validation via Key Manager. Status: \"\n                             + apiKeyValidationInfoDTO.isAuthorized());\n                 }\n+                if (!apiKeyValidationInfoDTO.isAuthorized()){\n+                    log.debug(\n+                            \"User is NOT authorized to access the Resource. API Subscription validation \" + \"failed.\");\n+                    throw new APISecurityException(apiKeyValidationInfoDTO.getValidationStatus(),\n+                            \"User is NOT authorized to access the Resource. API Subscription validation \" + \"failed.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c77f2ff833e544825cf1fb6b776cbdbc93c4defc"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYzNTQyOA==", "bodyText": "why a * here?", "url": "https://github.com/wso2/carbon-apimgt/pull/9146#discussion_r466635428", "createdAt": "2020-08-06T19:24:40Z", "author": {"login": "bhathiya"}, "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/service/APIKeyValidationService.java", "diffHunk": "@@ -484,63 +482,32 @@ public APIKeyValidationInfoDTO validateKeyforHandshake(String context, String ve\n         KeyValidationHandler keyValidationHandler =\r\n                 ServiceReferenceHolder.getInstance().getKeyValidationHandler(tenantDomain);\r\n         boolean state = keyValidationHandler.validateToken(validationContext);\r\n-        ApiMgtDAO dao = ApiMgtDAO.getInstance();\r\n         if (state) {\r\n-            info.setAuthorized(true);\r\n-            info.setValidityPeriod(validationContext.getTokenInfo().getValidityPeriod());\r\n-            info.setIssuedTime(validationContext.getTokenInfo().getIssuedTime());\r\n-            info.setKeyManager(validationContext.getValidationInfoDTO().getKeyManager());\r\n-            String def_version = isDefaultVersionInvoked(validationContext.getContext());\r\n-            if (def_version != null) {\r\n-                defaultVersionInvoked = true;\r\n-                version = def_version;\r\n-                context += \"/\" + def_version;\r\n-                validationContext.setVersion(version);\r\n-                validationContext.setContext(context);\r\n-            }\r\n-            info = dao.validateSubscriptionDetails(info, validationContext.getContext(), validationContext.getVersion(),\r\n-                    validationContext.getTokenInfo().getConsumerKey(), info.getKeyManager(),\r\n-                    defaultVersionInvoked);\r\n-\r\n-            if (defaultVersionInvoked) {\r\n-                info.setApiName(info.getApiName() + \"*\" + version);\r\n-            }\r\n-\r\n-            if (APIKeyMgtDataHolder.isJwtGenerationEnabled() &&\r\n-                    validationContext.getValidationInfoDTO().getEndUserName() != null\r\n-                    && !validationContext.isCacheHit()) {\r\n-                Application application = APIUtil.getApplicationByClientId(validationContext.getValidationInfoDTO()\r\n-                        .getConsumerKey());\r\n-                validationContext.getValidationInfoDTO().setApplicationId(String.valueOf(application.getId()));\r\n-                validationContext.getValidationInfoDTO().setApplicationTier(application.getTier());\r\n-                keyValidationHandler.generateConsumerToken(validationContext);\r\n-                info.setEndUserToken(validationContext.getValidationInfoDTO().getEndUserToken());\r\n+            state = keyValidationHandler.validateSubscription(validationContext);\r\n+            if (state) {\r\n+                if (APIConstants.DEFAULT_WEBSOCKET_VERSION.equals(version)) {\r\n+                    version = info.getApiVersion();\r\n+                    defaultVersionInvoked = true;\r\n+                }\r\n+                if (defaultVersionInvoked) {\r\n+                    validationContext.getValidationInfoDTO().setApiName(info.getApiName() + \"*\" + version);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c77f2ff833e544825cf1fb6b776cbdbc93c4defc"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyODE0MTc2", "url": "https://github.com/wso2/carbon-apimgt/pull/9146#pullrequestreview-462814176", "createdAt": "2020-08-06T19:28:28Z", "commit": {"oid": "c77f2ff833e544825cf1fb6b776cbdbc93c4defc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3cad379a39665d21db7e7603a6be2eb6e3b83f7", "author": {"user": {"login": "tharindu1st", "name": "Tharindu Dasun Dharmarathna"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/c3cad379a39665d21db7e7603a6be2eb6e3b83f7", "committedDate": "2020-08-07T10:42:57Z", "message": "fix Opaque token validation issue on websocket in distributed\nfix JWT doesn't contains application attributed and application uuid\nfix APIKey throttling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c77f2ff833e544825cf1fb6b776cbdbc93c4defc", "author": {"user": {"login": "tharindu1st", "name": "Tharindu Dasun Dharmarathna"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/c77f2ff833e544825cf1fb6b776cbdbc93c4defc", "committedDate": "2020-08-06T18:54:33Z", "message": "fix Opaque token validation issue on websocket in distributed\nfix JWT doesn't contains application attributed and application uuid\nfix APIKey throttling"}, "afterCommit": {"oid": "c3cad379a39665d21db7e7603a6be2eb6e3b83f7", "author": {"user": {"login": "tharindu1st", "name": "Tharindu Dasun Dharmarathna"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/c3cad379a39665d21db7e7603a6be2eb6e3b83f7", "committedDate": "2020-08-07T10:42:57Z", "message": "fix Opaque token validation issue on websocket in distributed\nfix JWT doesn't contains application attributed and application uuid\nfix APIKey throttling"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2474, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}