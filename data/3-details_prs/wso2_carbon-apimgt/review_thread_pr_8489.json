{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NTI5ODU1", "number": 8489, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzozOTo0MFrOD7hzMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzo0NTo0M1rOD7h7cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzQ2MzU0OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SQLConstants.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzozOTo0MFrOGT57gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwODoxMzowOFrOGT7JPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTI0OQ==", "bodyText": "is there an issue in doing a getEndpointRegistryByUUID instead of introducing a new SQL query to check the existance?", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423525249", "createdAt": "2020-05-12T07:39:40Z", "author": {"login": "fazlan-nazeem"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SQLConstants.java", "diffHunk": "@@ -1429,10 +1428,16 @@\n                     \"FROM ENDPOINT_REG_ENTRY AS E, ENDPOINT_REG AS R \" +\n                     \"WHERE E.REG_ID=R.ID AND R.UUID=?\";\n \n+    public static final String ADD_ENDPOINT_REGISTRY_ENTRY_SQL =\n+            \"INSERT INTO ENDPOINT_REG_ENTRY (UUID, ENTRY_NAME, SERVICE_URL, DEFINITION_TYPE, DEFINITION_URL, METADATA,\" +\n+                    \"SERVICE_TYPE, ENDPOINT_DEFINITION, REG_ID) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\";\n \n     public static final String IS_ENDPOINT_REGISTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS ENDPOINT_REGISTRY_COUNT\" +\n             \" FROM ENDPOINT_REG WHERE LOWER(REG_NAME) = LOWER(?) AND TENANT_ID = ?\";\n \n+    public static final String IS_ENDPOINT_REGISTRY_ENTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS REGISTRY_ENTRY_COUNT\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzODU2MA==", "bodyText": "This query is to check whether the given entry name already exists.", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423538560", "createdAt": "2020-05-12T08:02:02Z", "author": {"login": "vithu30"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SQLConstants.java", "diffHunk": "@@ -1429,10 +1428,16 @@\n                     \"FROM ENDPOINT_REG_ENTRY AS E, ENDPOINT_REG AS R \" +\n                     \"WHERE E.REG_ID=R.ID AND R.UUID=?\";\n \n+    public static final String ADD_ENDPOINT_REGISTRY_ENTRY_SQL =\n+            \"INSERT INTO ENDPOINT_REG_ENTRY (UUID, ENTRY_NAME, SERVICE_URL, DEFINITION_TYPE, DEFINITION_URL, METADATA,\" +\n+                    \"SERVICE_TYPE, ENDPOINT_DEFINITION, REG_ID) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\";\n \n     public static final String IS_ENDPOINT_REGISTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS ENDPOINT_REGISTRY_COUNT\" +\n             \" FROM ENDPOINT_REG WHERE LOWER(REG_NAME) = LOWER(?) AND TENANT_ID = ?\";\n \n+    public static final String IS_ENDPOINT_REGISTRY_ENTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS REGISTRY_ENTRY_COUNT\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTI0OQ=="}, "originalCommit": {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0MDg2Ng==", "bodyText": "getEndpointRegistryByUUID method cannot be used for this purpose I think. Here, the existence of the entry is checked using its' name not using UUID. Validating the unique constraint of (ENTRY_NAME, REG_ID).", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423540866", "createdAt": "2020-05-12T08:06:04Z", "author": {"login": "ChamodDamitha"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SQLConstants.java", "diffHunk": "@@ -1429,10 +1428,16 @@\n                     \"FROM ENDPOINT_REG_ENTRY AS E, ENDPOINT_REG AS R \" +\n                     \"WHERE E.REG_ID=R.ID AND R.UUID=?\";\n \n+    public static final String ADD_ENDPOINT_REGISTRY_ENTRY_SQL =\n+            \"INSERT INTO ENDPOINT_REG_ENTRY (UUID, ENTRY_NAME, SERVICE_URL, DEFINITION_TYPE, DEFINITION_URL, METADATA,\" +\n+                    \"SERVICE_TYPE, ENDPOINT_DEFINITION, REG_ID) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\";\n \n     public static final String IS_ENDPOINT_REGISTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS ENDPOINT_REGISTRY_COUNT\" +\n             \" FROM ENDPOINT_REG WHERE LOWER(REG_NAME) = LOWER(?) AND TENANT_ID = ?\";\n \n+    public static final String IS_ENDPOINT_REGISTRY_ENTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS REGISTRY_ENTRY_COUNT\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTI0OQ=="}, "originalCommit": {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0NTE1MA==", "bodyText": "got it.", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423545150", "createdAt": "2020-05-12T08:13:08Z", "author": {"login": "fazlan-nazeem"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SQLConstants.java", "diffHunk": "@@ -1429,10 +1428,16 @@\n                     \"FROM ENDPOINT_REG_ENTRY AS E, ENDPOINT_REG AS R \" +\n                     \"WHERE E.REG_ID=R.ID AND R.UUID=?\";\n \n+    public static final String ADD_ENDPOINT_REGISTRY_ENTRY_SQL =\n+            \"INSERT INTO ENDPOINT_REG_ENTRY (UUID, ENTRY_NAME, SERVICE_URL, DEFINITION_TYPE, DEFINITION_URL, METADATA,\" +\n+                    \"SERVICE_TYPE, ENDPOINT_DEFINITION, REG_ID) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\";\n \n     public static final String IS_ENDPOINT_REGISTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS ENDPOINT_REGISTRY_COUNT\" +\n             \" FROM ENDPOINT_REG WHERE LOWER(REG_NAME) = LOWER(?) AND TENANT_ID = ?\";\n \n+    public static final String IS_ENDPOINT_REGISTRY_ENTRY_NAME_EXISTS = \"SELECT COUNT(UUID) AS REGISTRY_ENTRY_COUNT\" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTI0OQ=="}, "originalCommit": {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzQ2NzAwOnYy", "diffSide": "LEFT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzo0MDozNFrOGT59tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzo1ODo1NVrOGT6ogA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTgxNQ==", "bodyText": "why removed?", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423525815", "createdAt": "2020-05-12T07:40:34Z", "author": {"login": "fazlan-nazeem"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -14869,8 +14870,6 @@ public EndpointRegistryEntry getEndpointRegistryEntryByUUID(String registryEntry\n                     endpointRegistryEntry.setServiceType(rs.getString(\"SERVICE_TYPE\"));\n                     endpointRegistryEntry.setServiceURL(rs.getString(\"SERVICE_URL\"));\n                     endpointRegistryEntry.setMetaData(rs.getString(\"METADATA\"));\n-                    ResourceFile resourceFile = new ResourceFile(rs.getBinaryStream(\"ENDPOINT_DEFINITION\"),\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUzNjc2OA==", "bodyText": "It is added only here, the SQL query does not have ENDPOINT_DEFINITION. We are not retrieving the definitionFile in the SQL query - [1]. Do we need to return the definition file with the method getRegistryEntryByUUID?\n[1] https://github.com/wso2/carbon-apimgt/blob/master/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SQLConstants.java#L1417", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423536768", "createdAt": "2020-05-12T07:58:55Z", "author": {"login": "vithu30"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/ApiMgtDAO.java", "diffHunk": "@@ -14869,8 +14870,6 @@ public EndpointRegistryEntry getEndpointRegistryEntryByUUID(String registryEntry\n                     endpointRegistryEntry.setServiceType(rs.getString(\"SERVICE_TYPE\"));\n                     endpointRegistryEntry.setServiceURL(rs.getString(\"SERVICE_URL\"));\n                     endpointRegistryEntry.setMetaData(rs.getString(\"METADATA\"));\n-                    ResourceFile resourceFile = new ResourceFile(rs.getBinaryStream(\"ENDPOINT_DEFINITION\"),\"\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyNTgxNQ=="}, "originalCommit": {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzQ4NDY3OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwNzo0NTo0M1rOGT6JIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwODoxNzoxNlrOGT7Tow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyODczNg==", "bodyText": "do we store the content type in the db? do we need it for any purpose?", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423528736", "createdAt": "2020-05-12T07:45:43Z", "author": {"login": "fazlan-nazeem"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java", "diffHunk": "@@ -126,7 +127,28 @@ public Response addRegistry(RegistryDTO body, MessageContext messageContext) {\n     @Override\n     public Response createRegistryEntry(String registryId, RegistryEntryDTO registryEntry, InputStream\n             definitionFileInputStream, Attachment definitionFileDetail, MessageContext messageContext) {\n-        return Response.ok().entity(registryEntry).build();\n+        EndpointRegistry registryProvider = new EndpointRegistryImpl();\n+        EndpointRegistryEntry createdEntry = null;\n+        try {\n+            EndpointRegistryInfo endpointRegistry = registryProvider.getEndpointRegistryByUUID(registryId);\n+            if (endpointRegistry == null) {\n+                RestApiUtil.handleResourceNotFoundError(\"Endpoint registry with the id: \" + registryId +\n+                        \" is not found\", log);\n+            }\n+            ResourceFile definitionFile = new ResourceFile(definitionFileInputStream, definitionFileDetail", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0MjgxOQ==", "bodyText": "No, it is not stored. Up to now, we haven't use the content-type field. Added ResourcFile instead of InputStream for definition file, in case it is needed in the future", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423542819", "createdAt": "2020-05-12T08:09:15Z", "author": {"login": "vithu30"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java", "diffHunk": "@@ -126,7 +127,28 @@ public Response addRegistry(RegistryDTO body, MessageContext messageContext) {\n     @Override\n     public Response createRegistryEntry(String registryId, RegistryEntryDTO registryEntry, InputStream\n             definitionFileInputStream, Attachment definitionFileDetail, MessageContext messageContext) {\n-        return Response.ok().entity(registryEntry).build();\n+        EndpointRegistry registryProvider = new EndpointRegistryImpl();\n+        EndpointRegistryEntry createdEntry = null;\n+        try {\n+            EndpointRegistryInfo endpointRegistry = registryProvider.getEndpointRegistryByUUID(registryId);\n+            if (endpointRegistry == null) {\n+                RestApiUtil.handleResourceNotFoundError(\"Endpoint registry with the id: \" + registryId +\n+                        \" is not found\", log);\n+            }\n+            ResourceFile definitionFile = new ResourceFile(definitionFileInputStream, definitionFileDetail", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyODczNg=="}, "originalCommit": {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU0NzgxMQ==", "bodyText": "does this content-type mean xml, json, yaml etc?", "url": "https://github.com/wso2/carbon-apimgt/pull/8489#discussion_r423547811", "createdAt": "2020-05-12T08:17:16Z", "author": {"login": "fazlan-nazeem"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.endpoint.registry/src/main/java/org/wso2/carbon/apimgt/rest/api/endpoint/registry/impl/RegistriesApiServiceImpl.java", "diffHunk": "@@ -126,7 +127,28 @@ public Response addRegistry(RegistryDTO body, MessageContext messageContext) {\n     @Override\n     public Response createRegistryEntry(String registryId, RegistryEntryDTO registryEntry, InputStream\n             definitionFileInputStream, Attachment definitionFileDetail, MessageContext messageContext) {\n-        return Response.ok().entity(registryEntry).build();\n+        EndpointRegistry registryProvider = new EndpointRegistryImpl();\n+        EndpointRegistryEntry createdEntry = null;\n+        try {\n+            EndpointRegistryInfo endpointRegistry = registryProvider.getEndpointRegistryByUUID(registryId);\n+            if (endpointRegistry == null) {\n+                RestApiUtil.handleResourceNotFoundError(\"Endpoint registry with the id: \" + registryId +\n+                        \" is not found\", log);\n+            }\n+            ResourceFile definitionFile = new ResourceFile(definitionFileInputStream, definitionFileDetail", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzUyODczNg=="}, "originalCommit": {"oid": "4fa06ad511c80776ea0b2ef7fffce3732695acf6"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3520, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}