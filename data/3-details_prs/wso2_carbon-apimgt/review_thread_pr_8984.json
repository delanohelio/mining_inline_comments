{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NDY2OTQ4", "number": 8984, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxNjozOVrOEQ64dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwNTowMTo0MVrOFN_JPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MTc3Mzk4OnYy", "diffSide": "RIGHT", "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/login/idp.jag", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxNjozOVrOG1VvZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxNjozOVrOG1VvZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4MzkwOA==", "bodyText": "slight formatting issue.", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r458583908", "createdAt": "2020-07-22T07:16:39Z", "author": {"login": "ruks"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/login/idp.jag", "diffHunk": "@@ -45,8 +45,16 @@\n     var erroLogin = serverUrl + app.context +\"/error-pages?code=\"\n \n     var dcrUrl = appUtils.getLoopbackOrigin() + DCR_URL_SUFFIX;\n-    var loginCallbackUrl = serverUrl + app.context + LOGIN_CALLBACK_URL_SUFFIX;\n-    var logoutCallbackUrl = serverUrl + app.context + LOGOUT_CALLBACK_URL_SUFFIX;\n+    var loginCallbackUrl = appUtils.getTenantBasedLoginCallBack();\n+    if (loginCallbackUrl == null) {\n+\t    loginCallbackUrl = serverUrl + app.context + LOGIN_CALLBACK_URL_SUFFIX;\n+    }\n+\n+    var logoutCallbackUrl = appUtils.getTenantBasedLogoutCallBack();\n+    if (logoutCallbackUrl == null) {\n+         logoutCallbackUrl = serverUrl + app.context + LOGOUT_CALLBACK_URL_SUFFIX;\n+     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MTc3OTQ1OnYy", "diffSide": "RIGHT", "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/utils.js", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxODoyNFrOG1Vytw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxODoyNFrOG1Vytw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4NDc1OQ==", "bodyText": "better to add spaces", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r458584759", "createdAt": "2020-07-22T07:18:24Z", "author": {"login": "ruks"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/utils.js", "diffHunk": "@@ -31,10 +32,72 @@ var getLoopbackOrigin = function() {\n     return origin; // Unless there is a port offset this is https://localhost:9443\n };\n \n-function getIDPOrigin(){\n+function getIDPOrigin() {\n     return utils.getExternalIDPOrigin();\n }\n \n-function getIDPCheckSessionEndpoint(){\n+function getIDPCheckSessionEndpoint() {\n     return utils.getExternalIDPCheckSessionEndpoint();\n }\n+\n+var getTenantBasePublisherContext = function() {\n+    var tenantDomain = getTenantDomain();\n+    var tenantContext = utils.getTenantBasedPublisherContext(tenantDomain);\n+    if (tenantContext != null && tenantContext != \" \") {\n+        return tenantContext\n+    } else {\n+        return app.context;\n+    }\n+};\n+\n+var getTenantBasedLoginCallBack = function() {\n+    var tenantDomain = getTenantDomain();\n+    var publisherDomainMapping = utils.getTenantBasedPublisherDomainMapping(tenantDomain);\n+    if (publisherDomainMapping != null) {\n+        if (publisherDomainMapping.get('login') != null) {\n+            return publisherDomainMapping.get('login');\n+        }\n+        return \"https://\"+publisherDomainMapping.get('customUrl') + LOGIN_CALLBACK_URL_SUFFIX;\n+    }else{\n+        return null;\n+    }\n+};\n+\n+var getTenantBasedLogoutCallBack = function() {\n+    var tenantDomain = getTenantDomain();\n+    var publisherDomainMapping = utils.getTenantBasedPublisherDomainMapping(tenantDomain);\n+    if (publisherDomainMapping != null) {\n+        if (publisherDomainMapping.get('logout') != null) {\n+            return publisherDomainMapping.get('logout');\n+        }\n+        return \"https://\"+publisherDomainMapping.get('customUrl') + LOGOUT_CALLBACK_URL_SUFFIX;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MTc4NDE1OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxOTo0N1rOG1V1hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNzoxOTo0N1rOG1V1hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4NTQ3Nw==", "bodyText": "Better not to catch ClassCastException. Ideally, you should check the instance type and continue.", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r458585477", "createdAt": "2020-07-22T07:19:47Z", "author": {"login": "ruks"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -10557,6 +10557,69 @@ public static Map getTenantBasedStoreDomainMapping(String tenantDomain) throws A\n         return null;\n     }\n \n+    public static Map getTenantBasedPublisherDomainMapping(String tenantDomain) throws APIManagementException {\n+\n+        try {\n+            Registry registry = ServiceReferenceHolder.getInstance().getRegistryService().\n+                    getGovernanceSystemRegistry();\n+            String resourcePath = APIConstants.API_DOMAIN_MAPPINGS.replace(APIConstants.API_DOMAIN_MAPPING_TENANT_ID_IDENTIFIER, tenantDomain);\n+            if (registry.resourceExists(resourcePath)) {\n+                Resource resource = registry.get(resourcePath);\n+                String content = new String((byte[]) resource.getContent(), Charset.defaultCharset());\n+                JSONParser parser = new JSONParser();\n+                JSONObject mappings = (JSONObject) parser.parse(content);\n+                if (mappings.containsKey(APIConstants.API_DOMAIN_MAPPINGS_PUBLISHER)) {\n+                    return (Map) mappings.get(APIConstants.API_DOMAIN_MAPPINGS_PUBLISHER);\n+                }\n+            }\n+        } catch (RegistryException e) {\n+            String msg = \"Error while retrieving publisher domain mappings from registry\";\n+            throw new APIManagementException(msg, e);\n+        } catch (ClassCastException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "245720d90aaae7b3e5d3f6a2b5ff5371d7b98b9e"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MjU0Mzk0OnYy", "diffSide": "RIGHT", "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/site/public/pages/index.jag", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMDo0OTo1OVrOG1dIUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMTowNjo0OVrOG1doZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwNDk3OA==", "bodyText": "Shall we remove the duplicate entry?", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r458704978", "createdAt": "2020-07-22T10:49:59Z", "author": {"login": "Arshardh"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/site/public/pages/index.jag", "diffHunk": "@@ -25,6 +25,10 @@\n     var swaggerKey = 'swaggerWorkerInit.js';\n     var indexBundle = manifest[indexKey].split(\"dist/\")[1];\n     var swaggerBundle = manifest[swaggerKey].split(\"dist/\")[1];\n+    var appUtils = require(\"/services/utils.js\");\n+    app.context = appUtils.getTenantBasePublisherContext();\n+    var appUtils = require(\"/services/utils.js\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4b625fbc36f5a8d6896d40490e4a8822fd707c0"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcxMzE4OA==", "bodyText": "Sure", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r458713188", "createdAt": "2020-07-22T11:06:49Z", "author": {"login": "wasuradananjith"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/site/public/pages/index.jag", "diffHunk": "@@ -25,6 +25,10 @@\n     var swaggerKey = 'swaggerWorkerInit.js';\n     var indexBundle = manifest[indexKey].split(\"dist/\")[1];\n     var swaggerBundle = manifest[swaggerKey].split(\"dist/\")[1];\n+    var appUtils = require(\"/services/utils.js\");\n+    app.context = appUtils.getTenantBasePublisherContext();\n+    var appUtils = require(\"/services/utils.js\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcwNDk3OA=="}, "originalCommit": {"oid": "d4b625fbc36f5a8d6896d40490e4a8822fd707c0"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMjEwMzY3OnYy", "diffSide": "RIGHT", "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/utils.js", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwNTowMTo0MVrOISfoyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxODowMTozOVrOIXK3QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjI2MzYyNQ==", "bodyText": "fix formatting", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r556263625", "createdAt": "2021-01-13T05:01:41Z", "author": {"login": "praminda"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/utils.js", "diffHunk": "@@ -38,3 +39,65 @@ function getIDPOrigin() {\n function getIDPCheckSessionEndpoint() {\n     return utils.getExternalIDPCheckSessionEndpoint();\n }\n+\n+var getTenantBasePublisherContext = function() {\n+    var tenantDomain = getTenantDomain();\n+    var tenantContext = utils.getTenantBasedPublisherContext(tenantDomain);\n+    if (tenantContext != null && tenantContext != \" \") {\n+        return tenantContext\n+    } else {\n+        return app.context;\n+    }\n+};\n+\n+var getTenantBasedLoginCallBack = function() {\n+    var tenantDomain = getTenantDomain();\n+    var publisherDomainMapping = utils.getTenantBasedPublisherDomainMapping(tenantDomain);\n+    if (publisherDomainMapping != null) {\n+        if (publisherDomainMapping.get('login') != null) {\n+            return publisherDomainMapping.get('login');\n+        }\n+        return \"https://\"+publisherDomainMapping.get('customUrl') + LOGIN_CALLBACK_URL_SUFFIX;\n+    }else{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4508d94313e2a62e9bcbf832a060624a7fac357d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTE2NjE0NA==", "bodyText": "Fixed via bcfd5cf", "url": "https://github.com/wso2/carbon-apimgt/pull/8984#discussion_r561166144", "createdAt": "2021-01-20T18:01:39Z", "author": {"login": "wasuradananjith"}, "path": "features/apimgt/org.wso2.carbon.apimgt.publisher.feature/src/main/resources/publisher/services/utils.js", "diffHunk": "@@ -38,3 +39,65 @@ function getIDPOrigin() {\n function getIDPCheckSessionEndpoint() {\n     return utils.getExternalIDPCheckSessionEndpoint();\n }\n+\n+var getTenantBasePublisherContext = function() {\n+    var tenantDomain = getTenantDomain();\n+    var tenantContext = utils.getTenantBasedPublisherContext(tenantDomain);\n+    if (tenantContext != null && tenantContext != \" \") {\n+        return tenantContext\n+    } else {\n+        return app.context;\n+    }\n+};\n+\n+var getTenantBasedLoginCallBack = function() {\n+    var tenantDomain = getTenantDomain();\n+    var publisherDomainMapping = utils.getTenantBasedPublisherDomainMapping(tenantDomain);\n+    if (publisherDomainMapping != null) {\n+        if (publisherDomainMapping.get('login') != null) {\n+            return publisherDomainMapping.get('login');\n+        }\n+        return \"https://\"+publisherDomainMapping.get('customUrl') + LOGIN_CALLBACK_URL_SUFFIX;\n+    }else{", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjI2MzYyNQ=="}, "originalCommit": {"oid": "4508d94313e2a62e9bcbf832a060624a7fac357d"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3173, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}