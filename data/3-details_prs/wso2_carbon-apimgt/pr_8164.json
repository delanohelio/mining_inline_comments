{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyOTI4NjA4", "number": 8164, "title": "Add support for role mapping in tenant-conf.json ", "bodyText": "Fixes wso2/product-apim#6605\nUI changes done in Admin portal webapp :", "createdAt": "2020-02-10T04:04:27Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8164", "merged": true, "mergeCommit": {"oid": "68eeff1d1195d24060b00263936577a6edcd65d9"}, "closed": true, "closedAt": "2020-02-10T05:04:04Z", "author": {"login": "msm1992"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC0-J4gH2gAyMzcyOTI4NjA4OjIyNTgxMWUzYjRmYjVmZmRiYjFmMDIyM2QyN2UyZmFkMWRkYjNlN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcC15ewgH2gAyMzcyOTI4NjA4OjFiZmZkMDM0ZWNmNDZjZmY5N2E3ZmY4MjRiNmI5YzcxYjA3NTQ2OTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "225811e3b4fb5ffdbb1f0223d27e2fad1ddb3e7a", "author": {"user": {"login": "msm1992", "name": "Sachini De Silva"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/225811e3b4fb5ffdbb1f0223d27e2fad1ddb3e7a", "committedDate": "2020-02-10T03:56:53Z", "message": "Add support for role mapping in tenant-conf.json"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9fd7b606b732efdf08fc48c880be3d1b8a8027e", "author": {"user": {"login": "msm1992", "name": "Sachini De Silva"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/f9fd7b606b732efdf08fc48c880be3d1b8a8027e", "committedDate": "2020-02-10T04:01:23Z", "message": "Refactor code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NjkwNjky", "url": "https://github.com/wso2/carbon-apimgt/pull/8164#pullrequestreview-355690692", "createdAt": "2020-02-10T04:52:49Z", "commit": {"oid": "f9fd7b606b732efdf08fc48c880be3d1b8a8027e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNDo1Mjo0OVrOFnaMlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNDo1Mjo0OVrOFnaMlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njg2Nzk5MA==", "bodyText": "Are you trying to do below?\nscopeRoles = String.join(\",\", mappedRoles);", "url": "https://github.com/wso2/carbon-apimgt/pull/8164#discussion_r376867990", "createdAt": "2020-02-10T04:52:49Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -7225,16 +7281,38 @@ public static JSONObject getTenantDefaultRoles(String tenantDomain) throws APIMa\n     }\n \n     /**\n-     * @param config JSON configuration object with scopes and associated roles\n+     * @param scopesConfig JSON configuration object with scopes and associated roles\n+     * @param roleMappings JSON Configuration object with role mappings\n      * @return Map of scopes which contains scope names and associated role list\n      */\n-    public static Map<String, String> getRESTAPIScopesFromConfig(JSONObject config) {\n+    public static Map<String, String> getRESTAPIScopesFromConfig(JSONObject scopesConfig, JSONObject roleMappings) {\n         Map<String, String> scopes = new HashMap<String, String>();\n-        JSONArray scopesArray = (JSONArray) config.get(\"Scope\");\n+        JSONArray scopesArray = (JSONArray) scopesConfig.get(\"Scope\");\n         for (Object scopeObj : scopesArray) {\n             JSONObject scope = (JSONObject) scopeObj;\n             String scopeName = scope.get(APIConstants.REST_API_SCOPE_NAME).toString();\n             String scopeRoles = scope.get(APIConstants.REST_API_SCOPE_ROLE).toString();\n+            if (roleMappings != null) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"REST API scope role mappings exist. Hence proceeding to swap original scope roles \"\n+                            + \"for mapped scope roles.\");\n+                }\n+                //split role list string read using comma separator\n+                List<String> originalRoles = Arrays.asList(scopeRoles.split(\"\\\\s*,\\\\s*\"));\n+                List<String> mappedRoles = new ArrayList<String>();\n+                for (String role : originalRoles) {\n+                    String mappedRole = (String) roleMappings.get(role);\n+                    if (mappedRole != null) {\n+                        if (log.isDebugEnabled()) {\n+                            log.debug(role + \" was mapped to \" + mappedRole);\n+                        }\n+                        mappedRoles.add(mappedRole);\n+                    } else {\n+                        mappedRoles.add(role);\n+                    }\n+                }\n+                scopeRoles = mappedRoles.toString().replace(\"[\", \"\").replace(\"]\", \"\").replace(\" \", \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9fd7b606b732efdf08fc48c880be3d1b8a8027e"}, "originalPosition": 136}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NjkwOTM2", "url": "https://github.com/wso2/carbon-apimgt/pull/8164#pullrequestreview-355690936", "createdAt": "2020-02-10T04:54:14Z", "commit": {"oid": "f9fd7b606b732efdf08fc48c880be3d1b8a8027e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bffd034ecf46cff97a7ff824b6b9c71b0754698", "author": {"user": {"login": "msm1992", "name": "Sachini De Silva"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/1bffd034ecf46cff97a7ff824b6b9c71b0754698", "committedDate": "2020-02-10T05:01:41Z", "message": "Add review fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2987, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}