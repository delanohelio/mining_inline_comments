{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyMjkyNjQw", "number": 8283, "title": "Fix https://github.com/wso2/product-apim/issues/7523", "bodyText": "", "createdAt": "2020-03-02T10:12:21Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8283", "merged": true, "mergeCommit": {"oid": "3ca70babae07a6b9cc063e07cc66e57989a162bd"}, "closed": true, "closedAt": "2020-03-03T13:37:29Z", "author": {"login": "shilmyhasan"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIVNlLgH2gAyMzgyMjkyNjQwOjJkNDVjNmY3M2YyZGY5OWRmMDIyMTE5ZmE3MDMyOGRhNDJlNThiZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKCdfmgFqTM2Nzk4MjEwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2d45c6f73f2df99df022119fa70328da42e58bee", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/2d45c6f73f2df99df022119fa70328da42e58bee", "committedDate": "2020-02-27T06:20:19Z", "message": "Merge branch 'master' of https://github.com/wso2/carbon-apimgt into master-scopeIssuer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b76ea27415572e99eb85949bae2a496128881d82", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/b76ea27415572e99eb85949bae2a496128881d82", "committedDate": "2020-03-02T07:30:20Z", "message": "get monetization usage record"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4aa491fdb9856778db37734adb820d13d20d937", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/e4aa491fdb9856778db37734adb820d13d20d937", "committedDate": "2020-03-02T10:03:27Z", "message": "fix constant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5848af5112c579fc3d5b6bedcf1c2871e2c829b4", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/5848af5112c579fc3d5b6bedcf1c2871e2c829b4", "committedDate": "2020-03-02T10:07:21Z", "message": "Merge branch 'master' of https://github.com/wso2/carbon-apimgt into master-scopeIssuer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3ODI2MTE0", "url": "https://github.com/wso2/carbon-apimgt/pull/8283#pullrequestreview-367826114", "createdAt": "2020-03-03T09:38:24Z", "commit": {"oid": "5848af5112c579fc3d5b6bedcf1c2871e2c829b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3ODMzMTIw", "url": "https://github.com/wso2/carbon-apimgt/pull/8283#pullrequestreview-367833120", "createdAt": "2020-03-03T09:47:50Z", "commit": {"oid": "5848af5112c579fc3d5b6bedcf1c2871e2c829b4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwOTo0Nzo1MFrOFw-wjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwOTo0Nzo1MFrOFw-wjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwNDIwNw==", "bodyText": "JsonObject can be null", "url": "https://github.com/wso2/carbon-apimgt/pull/8283#discussion_r386904207", "createdAt": "2020-03-03T09:47:50Z", "author": {"login": "tharindu1st"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -9158,6 +9158,55 @@ public static JSONObject executeQueryOnStreamProcessor(String appName, String qu\n \n     }\n \n+    /**\n+     * Implemented to get the API usage count for monetization.\n+     *\n+     * @param from : the start timestamp of the query.\n+     * @param to   : the end timestamp of the query.\n+     * @return JSON Object.\n+     */\n+    public static JSONObject getUsageCountForMonetization(long from, long to)\n+            throws APIManagementException {\n+\n+        JSONObject jsonObject = null;\n+        String granularity = null;\n+        APIManagerConfiguration configuration = ServiceReferenceHolder.getInstance().getAPIManagerConfigurationService()\n+                .getAPIManagerConfiguration();\n+        granularity = configuration.getFirstProperty(\n+                APIConstants.Monetization.USAGE_PUBLISHER_GRANULARITY);\n+        if (StringUtils.isEmpty(granularity)) {\n+            //set the default granularity to days, if it is not set in configuration\n+            granularity = APIConstants.Monetization.USAGE_PUBLISH_DEFAULT_GRANULARITY;\n+        }\n+        StringBuilder query = new StringBuilder(\n+                \"from \" + APIConstants.Monetization.MONETIZATION_USAGE_RECORD_AGG\n+                        + \" within \" + from\n+                        + \"L, \" + to + \"L per '\" + granularity\n+                        + \"' select \"\n+                        + APIConstants.Analytics.API_NAME + \", \"\n+                        + APIConstants.Analytics.API_VERSION + \", \"\n+                        + APIConstants.Analytics.API_CREATOR + \", \"\n+                        + APIConstants.Analytics.API_CREATOR_TENANT_DOMAIN + \", \"\n+                        + APIConstants.Analytics.APPLICATION_ID + \", \"\n+                        + \"sum (requestCount) as requestCount \"\n+                        + \"group by \"\n+                        + APIConstants.Analytics.API_NAME + \", \"\n+                        + APIConstants.Analytics.API_VERSION + \", \"\n+                        + APIConstants.Analytics.API_CREATOR + \", \"\n+                        + APIConstants.Analytics.API_CREATOR_TENANT_DOMAIN + \", \"\n+                        + APIConstants.Analytics.APPLICATION_ID\n+        );\n+        try {\n+            jsonObject = APIUtil.executeQueryOnStreamProcessor(\n+                    APIConstants.Monetization.MONETIZATION_USAGE_RECORD_APP,\n+                    query.toString());\n+        } catch (APIManagementException ex) {\n+            String msg = \"Unable to Retrieve monetization usage records\";\n+            handleException(msg, ex);\n+        }\n+        return jsonObject;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5848af5112c579fc3d5b6bedcf1c2871e2c829b4"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a129c3ec166bfd118842b18f7cbadb695d40f206", "author": {"user": {"login": "shilmyhasan", "name": "Silmy Hasan"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/a129c3ec166bfd118842b18f7cbadb695d40f206", "committedDate": "2020-03-03T13:34:26Z", "message": "create empty jsonobject"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3OTgyMTA1", "url": "https://github.com/wso2/carbon-apimgt/pull/8283#pullrequestreview-367982105", "createdAt": "2020-03-03T13:37:21Z", "commit": {"oid": "a129c3ec166bfd118842b18f7cbadb695d40f206"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2950, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}