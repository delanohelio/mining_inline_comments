{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNjg3Nzgx", "number": 9240, "title": "Merging the scope-role mappings when updating the role permissions (from Admin portal)", "bodyText": "Purpose\nFixes: wso2/product-apim#9152\nGoals\nWhen updating the scope-role mapping in the tenant-conf, merging should be done instead of overriding.\nApproach\n\nWrote a new function mergeTenantConfScopes which takes the existing scope-role mappings and the new scope-role mappings and merge those two.\nModified the prettifying tenant-conf code in the functions updateTenantConfOfRoleScopeMapping and updateTenantConfRoleAliasMapping.\n\nUser stories\nWhen you update/save the roles and permissions from the Admin portal the scopes related to APIM Analytics will be not be removed from the tenant_conf.json as mentioned in wso2/product-apim#9152.\nTest environment\n\nJDK 1.8.0_251\nUbuntu 20.04 LTS", "createdAt": "2020-08-21T15:02:59Z", "url": "https://github.com/wso2/carbon-apimgt/pull/9240", "merged": true, "mergeCommit": {"oid": "1f0b31b0daf0ace590aab9def094b750556392d6"}, "closed": true, "closedAt": "2020-08-25T11:14:10Z", "author": {"login": "wasuradananjith"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBFl7pgH2gAyNDcxNjg3NzgxOjJmMWYwZWVhY2M1YWU2MGVkZjYzMDU2NjRjZDNkZDM0ZjYwYWY5NGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCVS9eAFqTQ3NDM3NTU2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2f1f0eeacc5ae60edf6305664cd3dd34f60af94d", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/2f1f0eeacc5ae60edf6305664cd3dd34f60af94d", "committedDate": "2020-08-21T14:22:07Z", "message": "Modify updateTenantConfOfRoleScopeMapping function to merge mappings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTA5ODg1", "url": "https://github.com/wso2/carbon-apimgt/pull/9240#pullrequestreview-472909885", "createdAt": "2020-08-22T09:06:51Z", "commit": {"oid": "2f1f0eeacc5ae60edf6305664cd3dd34f60af94d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwOTowNjo1MVrOHFDwbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwOTowNjo1MVrOHFDwbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2NjQ3OA==", "bodyText": "Assigning newTenantConfScopesArray into mergedTenantConfScopesArray will just keep references.\nAfter adding an element to mergedTenantConfScopesArray, that will also appear in newTenantConfScopesArray.\nShould we take a copy and assign instead?\neg:\nJsonElement newTenantConfScopes = new JsonParser().parse(newScopeRoleJson.toJSONString());", "url": "https://github.com/wso2/carbon-apimgt/pull/9240#discussion_r475066478", "createdAt": "2020-08-22T09:06:51Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -11525,28 +11527,68 @@ public static void updateTenantConfOfRoleScopeMapping(JSONObject newScopeRoleJso\n         } catch (UserStoreException e) {\n             APIUtil.handleException(\"Couldn't read tenant configuration from user-store\", e);\n         }\n-        //Here we are removing RESTAPIScopes from the existing tenant-conf\n-        // Adding new RESTAPIScopes to the existing tenant-conf.\n+        JsonElement existingTenantConfScopes = existingTenantConfObject.get(APIConstants.REST_API_SCOPES_CONFIG);\n+        JsonElement newTenantConfScopes = new JsonParser().parse(newScopeRoleJson.toJSONString());\n+        JsonObject mergedTenantConfScopes = mergeTenantConfScopes(existingTenantConfScopes, newTenantConfScopes);\n+\n+        // Removing the old RESTAPIScopes config from the existing tenant-conf\n         existingTenantConfObject.remove(APIConstants.REST_API_SCOPES_CONFIG);\n-        JsonElement jsonElement = new JsonParser().parse(newScopeRoleJson.toJSONString());\n-        existingTenantConfObject.add(APIConstants.REST_API_SCOPES_CONFIG, jsonElement);\n-        try {\n-            ObjectMapper mapper = new ObjectMapper();\n-            String formattedTenantConf = mapper.writerWithDefaultPrettyPrinter()\n-                    .writeValueAsString(existingTenantConfObject.toString());\n-            APIUtil.updateTenantConf(existingTenantConfObject.toString(), tenantDomain);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Finalized tenant-conf.json: \" + formattedTenantConf);\n-            }\n-        } catch (JsonProcessingException e) {\n-            throw new APIManagementException(\"Error while formatting tenant-conf.json of tenant\", e);\n+        // Adding the merged RESTAPIScopes config to the tenant-conf\n+        existingTenantConfObject.add(APIConstants.REST_API_SCOPES_CONFIG, mergedTenantConfScopes);\n+\n+        // Prettify the tenant-conf\n+        Gson gson = new GsonBuilder().setPrettyPrinting().create();\n+        String formattedTenantConf = gson.toJson(existingTenantConfObject);\n+\n+        APIUtil.updateTenantConf(formattedTenantConf, tenantDomain);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Finalized tenant-conf.json: \" + formattedTenantConf);\n         }\n         // Invalidate Cache\n         Caching.getCacheManager(APIConstants.API_MANAGER_CACHE_MANAGER)\n                 .getCache(APIConstants.REST_API_SCOPE_CACHE)\n                 .put(tenantDomain, null);\n     }\n \n+    /**\n+     * Merge the existing and new scope-role mappings (RESTAPIScopes config) in the tenant-conf\n+     *\n+     * @param existingTenantConfScopes Existing (old) scope-role mappings\n+     * @param newTenantConfScopes      Modified (new) scope-role mappings\n+     */\n+    public static JsonObject mergeTenantConfScopes(JsonElement existingTenantConfScopes, JsonElement newTenantConfScopes) {\n+        JsonArray existingTenantConfScopesArray = (JsonArray) existingTenantConfScopes.getAsJsonObject().\n+                get(APIConstants.REST_API_SCOPE);\n+        JsonArray newTenantConfScopesArray = (JsonArray) newTenantConfScopes.getAsJsonObject().\n+                get(APIConstants.REST_API_SCOPE);\n+        JsonArray mergedTenantConfScopesArray = newTenantConfScopesArray;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f1f0eeacc5ae60edf6305664cd3dd34f60af94d"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTA5OTI5", "url": "https://github.com/wso2/carbon-apimgt/pull/9240#pullrequestreview-472909929", "createdAt": "2020-08-22T09:07:48Z", "commit": {"oid": "2f1f0eeacc5ae60edf6305664cd3dd34f60af94d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwOTowNzo0OFrOHFDwwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQwOTowNzo0OFrOHFDwwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2NjU2MA==", "bodyText": "See the previous comment regarding this line(11584) and 11575", "url": "https://github.com/wso2/carbon-apimgt/pull/9240#discussion_r475066560", "createdAt": "2020-08-22T09:07:48Z", "author": {"login": "malinthaprasan"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/utils/APIUtil.java", "diffHunk": "@@ -11525,28 +11527,68 @@ public static void updateTenantConfOfRoleScopeMapping(JSONObject newScopeRoleJso\n         } catch (UserStoreException e) {\n             APIUtil.handleException(\"Couldn't read tenant configuration from user-store\", e);\n         }\n-        //Here we are removing RESTAPIScopes from the existing tenant-conf\n-        // Adding new RESTAPIScopes to the existing tenant-conf.\n+        JsonElement existingTenantConfScopes = existingTenantConfObject.get(APIConstants.REST_API_SCOPES_CONFIG);\n+        JsonElement newTenantConfScopes = new JsonParser().parse(newScopeRoleJson.toJSONString());\n+        JsonObject mergedTenantConfScopes = mergeTenantConfScopes(existingTenantConfScopes, newTenantConfScopes);\n+\n+        // Removing the old RESTAPIScopes config from the existing tenant-conf\n         existingTenantConfObject.remove(APIConstants.REST_API_SCOPES_CONFIG);\n-        JsonElement jsonElement = new JsonParser().parse(newScopeRoleJson.toJSONString());\n-        existingTenantConfObject.add(APIConstants.REST_API_SCOPES_CONFIG, jsonElement);\n-        try {\n-            ObjectMapper mapper = new ObjectMapper();\n-            String formattedTenantConf = mapper.writerWithDefaultPrettyPrinter()\n-                    .writeValueAsString(existingTenantConfObject.toString());\n-            APIUtil.updateTenantConf(existingTenantConfObject.toString(), tenantDomain);\n-            if (log.isDebugEnabled()) {\n-                log.debug(\"Finalized tenant-conf.json: \" + formattedTenantConf);\n-            }\n-        } catch (JsonProcessingException e) {\n-            throw new APIManagementException(\"Error while formatting tenant-conf.json of tenant\", e);\n+        // Adding the merged RESTAPIScopes config to the tenant-conf\n+        existingTenantConfObject.add(APIConstants.REST_API_SCOPES_CONFIG, mergedTenantConfScopes);\n+\n+        // Prettify the tenant-conf\n+        Gson gson = new GsonBuilder().setPrettyPrinting().create();\n+        String formattedTenantConf = gson.toJson(existingTenantConfObject);\n+\n+        APIUtil.updateTenantConf(formattedTenantConf, tenantDomain);\n+        if (log.isDebugEnabled()) {\n+            log.debug(\"Finalized tenant-conf.json: \" + formattedTenantConf);\n         }\n         // Invalidate Cache\n         Caching.getCacheManager(APIConstants.API_MANAGER_CACHE_MANAGER)\n                 .getCache(APIConstants.REST_API_SCOPE_CACHE)\n                 .put(tenantDomain, null);\n     }\n \n+    /**\n+     * Merge the existing and new scope-role mappings (RESTAPIScopes config) in the tenant-conf\n+     *\n+     * @param existingTenantConfScopes Existing (old) scope-role mappings\n+     * @param newTenantConfScopes      Modified (new) scope-role mappings\n+     */\n+    public static JsonObject mergeTenantConfScopes(JsonElement existingTenantConfScopes, JsonElement newTenantConfScopes) {\n+        JsonArray existingTenantConfScopesArray = (JsonArray) existingTenantConfScopes.getAsJsonObject().\n+                get(APIConstants.REST_API_SCOPE);\n+        JsonArray newTenantConfScopesArray = (JsonArray) newTenantConfScopes.getAsJsonObject().\n+                get(APIConstants.REST_API_SCOPE);\n+        JsonArray mergedTenantConfScopesArray = newTenantConfScopesArray;\n+\n+        // Iterating the existing (old) scope-role mappings\n+        for (int i = 0; i < existingTenantConfScopesArray.size(); i++) {\n+            JsonObject existingScopeRoleMapping = existingTenantConfScopesArray.get(i).getAsJsonObject();\n+            String existingScopeName = existingScopeRoleMapping.get(APIConstants.REST_API_SCOPE_NAME).getAsString();\n+            Boolean isExist = false;\n+            // Iterating the modified (new) scope-role mappings and add the old scope mappings\n+            // if those are not present in the list (merging)\n+            for (int j = 0; j < newTenantConfScopesArray.size(); j++) {\n+                JsonObject newScopeRoleMapping = newTenantConfScopesArray.get(j).getAsJsonObject();\n+                String newScopeName = newScopeRoleMapping.get(APIConstants.REST_API_SCOPE_NAME).getAsString();\n+                if (StringUtils.equals(existingScopeName, newScopeName)) {\n+                    // If a particular mapping is already there, skip it\n+                    isExist = true;\n+                    break;\n+                }\n+            }\n+            // If the particular old mapping does not exist in the new list, add it to the new list\n+            if (!isExist) {\n+                mergedTenantConfScopesArray.add(existingTenantConfScopesArray.get(i));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f1f0eeacc5ae60edf6305664cd3dd34f60af94d"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4ae8e86470316815eaf552cd929bd3dc958062c", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/e4ae8e86470316815eaf552cd929bd3dc958062c", "committedDate": "2020-08-22T11:17:10Z", "message": "Take a copy of the newTenantConfScopesArray properly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc9e710358bca075f31257c8f24dba8427f8a185", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/fc9e710358bca075f31257c8f24dba8427f8a185", "committedDate": "2020-08-25T09:24:51Z", "message": "Modify java doc comments and restructure loops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d11f0734fef2c3d9006b16c0e0824b1b164c34e7", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/d11f0734fef2c3d9006b16c0e0824b1b164c34e7", "committedDate": "2020-08-25T09:20:05Z", "message": "Modify java doc comments and restructure loops"}, "afterCommit": {"oid": "fc9e710358bca075f31257c8f24dba8427f8a185", "author": {"user": {"login": "wasuradananjith", "name": "Wasura Wattearachchi"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/fc9e710358bca075f31257c8f24dba8427f8a185", "committedDate": "2020-08-25T09:24:51Z", "message": "Modify java doc comments and restructure loops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Mzc1NTYy", "url": "https://github.com/wso2/carbon-apimgt/pull/9240#pullrequestreview-474375562", "createdAt": "2020-08-25T11:13:48Z", "commit": {"oid": "fc9e710358bca075f31257c8f24dba8427f8a185"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2450, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}