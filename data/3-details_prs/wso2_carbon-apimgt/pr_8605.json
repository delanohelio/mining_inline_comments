{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0ODg3Mjcx", "number": 8605, "title": "Added REST API to validate a given user has a particular scope.", "bodyText": "Fix wso2/product-apim#7975 (wso2/product-apim#7954)\nScenario: When transferring ownership of an application to a user, that user should hold the role Internal/subscriber\nThere are two required parameters used to validate the existence of scope.\n\n\nusername(query)\n\n\nscope(path)\n\n\nThe scope will be returned if the user has the particular scope else empty list will be returned.\nAnd 404 will be thrown if the user name or scope name does not exist.\nSample cURL request and response:\nRequest: curl -k -X GET \"https://localhost:9443/api/am/admin/v1/settings/scopes/apim:subscribe?username=john\" -H \"accept: application/json\" -H \"Authorization: Bearer e2fd27f7-cdf4-36ae-9b32-db4a47dcb14a\"\nResponse: {\"name\":\"apim:subscribe\"}\nRequest: curl -k -X GET \"https://localhost:9443/api/am/admin/v1/settings/scopes/apim:api_view?username=john\" -H \"accept: application/json\" -H \"Authorization: Bearer e2fd27f7-cdf4-36ae-9b32-db4a47dcb14a\"\nResponse: {\"name\":null}\nTested Scenarios :", "createdAt": "2020-05-29T05:04:42Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8605", "merged": true, "mergeCommit": {"oid": "962a00425ab7a89bfbc1e0a6efaa8d85133a1aa9"}, "closed": true, "closedAt": "2020-06-02T07:02:53Z", "author": {"login": "Meruja"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcl6DfNgH2gAyNDI0ODg3MjcxOjU0NzM3YzljOGQ1YzEyOTBkYTk3MmM3ODNhNWYyNDhlZjhlM2NhNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyNBKiAFqTQ0Mjg3NjA0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54737c9c8d5c1290da972c783a5f248ef8e3ca44", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/54737c9c8d5c1290da972c783a5f248ef8e3ca44", "committedDate": "2020-05-29T03:39:35Z", "message": "Added REST API to validate the scope."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "774875487fc29e0396e2c0c67324cfd2561eaf37", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/774875487fc29e0396e2c0c67324cfd2561eaf37", "committedDate": "2020-05-29T19:10:03Z", "message": "Modified scope name as path parameter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/3343b30ba7de5360c87229c7a0c33c89d11348b8", "committedDate": "2020-05-29T19:18:29Z", "message": "Corrected the cURL request sample."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTk5MTc2", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#pullrequestreview-421599176", "createdAt": "2020-06-01T05:23:47Z", "commit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyMzo0N1rOGc_DuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyMzo0N1rOGc_DuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjQ1Nw==", "bodyText": "add username in the log", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433046457", "createdAt": "2020-06-01T05:23:47Z", "author": {"login": "tgtshanika"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SettingsApiServiceImpl.java", "diffHunk": "@@ -51,4 +55,38 @@ public Response settingsGet(MessageContext messageContext) {\n         }\n         return null;\n     }\n+\n+    /**\n+     * Get all scopes of a user\n+     *\n+     * @param username Search query\n+     * @return Scope list\n+     */\n+    @Override\n+    public Response settingsScopesScopeGet(String username, String scopeName, MessageContext messageContext) {\n+        String[] userRoles;\n+        ScopeSettingsDTO scopeSettingsDTO = new ScopeSettingsDTO();\n+        ErrorDTO errorDTO = new ErrorDTO();\n+\n+        try {\n+            if (APIUtil.isUserExist(username) && APIUtil.getRESTAPIScopesForTenant(MultitenantUtils\n+                    .getTenantDomain(username)).containsKey(scopeName)) {\n+                userRoles = APIUtil.getListOfRoles(username);\n+                SettingsMappingUtil settingsMappingUtil = new SettingsMappingUtil();\n+\n+                if (settingsMappingUtil.GetRoleScopeList(userRoles, username).contains(scopeName)) {\n+                    scopeSettingsDTO.setName(scopeName);\n+                }\n+            } else {\n+                errorDTO.setCode(404l);\n+                errorDTO.description(\"Username or Scope does not exist\");\n+                errorDTO.setMessage(\"Not Found\");\n+                return Response.ok().entity(errorDTO).build();\n+            }\n+        } catch (APIManagementException e) {\n+            String errorMessage = \"Error when getting the list of scopes\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTk5NTMx", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#pullrequestreview-421599531", "createdAt": "2020-06-01T05:25:08Z", "commit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyNTowOFrOGc_E0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyNTowOFrOGc_E0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjczOQ==", "bodyText": "We are retrieving the scopes twice.", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433046739", "createdAt": "2020-06-01T05:25:08Z", "author": {"login": "tgtshanika"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "diffHunk": "@@ -67,4 +71,27 @@ public SettingsDTO fromSettingstoDTO(Boolean isUserAvailable) throws APIManageme\n         }\n         return scopeList;\n     }\n+\n+    public List<String> GetRoleScopeList(String[] userRoles, String username) {\n+        List<String> userRoleList;\n+        List<String> authorizedScopes = new ArrayList<>();\n+\n+        if (userRoles == null || userRoles.length == 0) {\n+            userRoles = new String[0];\n+        }\n+\n+        userRoleList = Arrays.asList(userRoles);\n+        Map<String, String> scopeRoleMapping =\n+                APIUtil.getRESTAPIScopesForTenant(MultitenantUtils.getTenantDomain(username));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTk5ODkz", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#pullrequestreview-421599893", "createdAt": "2020-06-01T05:26:24Z", "commit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyNjoyNFrOGc_F8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyNjoyNFrOGc_F8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NzAyNQ==", "bodyText": "possible NPE?", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433047025", "createdAt": "2020-06-01T05:26:24Z", "author": {"login": "tgtshanika"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "diffHunk": "@@ -67,4 +71,27 @@ public SettingsDTO fromSettingstoDTO(Boolean isUserAvailable) throws APIManageme\n         }\n         return scopeList;\n     }\n+\n+    public List<String> GetRoleScopeList(String[] userRoles, String username) {\n+        List<String> userRoleList;\n+        List<String> authorizedScopes = new ArrayList<>();\n+\n+        if (userRoles == null || userRoles.length == 0) {\n+            userRoles = new String[0];\n+        }\n+\n+        userRoleList = Arrays.asList(userRoles);\n+        Map<String, String> scopeRoleMapping =\n+                APIUtil.getRESTAPIScopesForTenant(MultitenantUtils.getTenantDomain(username));\n+        Iterator<Map.Entry<String, String>> iterator = scopeRoleMapping.entrySet().iterator();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5510d27701692c0e352ff2194d6a95d43c49d3ea", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/5510d27701692c0e352ff2194d6a95d43c49d3ea", "committedDate": "2020-06-02T05:57:52Z", "message": "Corrected review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzkzMzE1", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#pullrequestreview-422393315", "createdAt": "2020-06-02T07:01:16Z", "commit": {"oid": "5510d27701692c0e352ff2194d6a95d43c49d3ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzk0MTY2", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#pullrequestreview-422394166", "createdAt": "2020-06-02T07:02:45Z", "commit": {"oid": "5510d27701692c0e352ff2194d6a95d43c49d3ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODc2MDQz", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#pullrequestreview-442876043", "createdAt": "2020-07-06T08:32:19Z", "commit": {"oid": "5510d27701692c0e352ff2194d6a95d43c49d3ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODozMjoxOVrOGtN2qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODozMjoxOVrOGtN2qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA2NjA5MQ==", "bodyText": "let's have a habit to mention the x-wso2-request in this format in future PRs. https://github.com/Meruja/carbon-apimgt/blob/5510d27701692c0e352ff2194d6a95d43c49d3ea/components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/resources/admin-api.yaml#L2301-L2303.  It is more clear.", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r450066091", "createdAt": "2020-07-06T08:32:19Z", "author": {"login": "rmsamitha"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/resources/admin-api.yaml", "diffHunk": "@@ -2965,11 +2965,72 @@ paths:\n           schema:\n             $ref: '#/definitions/Error'\n \n+  /settings/scopes/{scope}:\n+    #-----------------------------------------------------\n+    # Retrieve scope settings\n+    #-----------------------------------------------------\n+    get:\n+      security:\n+        - OAuth2Security:\n+            - apim:admin_settings\n+      x-wso2-curl: \"curl -k -X GET \\\"https://localhost:9443/api/am/admin/v1/settings/scopes/apim:subscribe?username=john\\\" -H \\\"accept: application/json\\\" -H \\\"Authorization: Bearer 8e8edc50-4a70-3fec-af00-ce08097012ab\"\n+      x-wso2-request: \"GET https://localhost:9443/api/am/admin/v1/settings/scopes/apim:subscribe?username=john Authorization: Bearer 8e8edc50-4a70-3fec-af00-ce08097012ab\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5510d27701692c0e352ff2194d6a95d43c49d3ea"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2676, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}