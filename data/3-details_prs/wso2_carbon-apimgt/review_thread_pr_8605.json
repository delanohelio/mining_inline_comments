{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0ODg3Mjcx", "number": 8605, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyMzo0N1rOEBP4yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODozMjoxOVrOELl1gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzQ0MzMwOnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SettingsApiServiceImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyMzo0N1rOGc_DuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNjowNDozMlrOGdjORA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjQ1Nw==", "bodyText": "add username in the log", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433046457", "createdAt": "2020-06-01T05:23:47Z", "author": {"login": "tgtshanika"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SettingsApiServiceImpl.java", "diffHunk": "@@ -51,4 +55,38 @@ public Response settingsGet(MessageContext messageContext) {\n         }\n         return null;\n     }\n+\n+    /**\n+     * Get all scopes of a user\n+     *\n+     * @param username Search query\n+     * @return Scope list\n+     */\n+    @Override\n+    public Response settingsScopesScopeGet(String username, String scopeName, MessageContext messageContext) {\n+        String[] userRoles;\n+        ScopeSettingsDTO scopeSettingsDTO = new ScopeSettingsDTO();\n+        ErrorDTO errorDTO = new ErrorDTO();\n+\n+        try {\n+            if (APIUtil.isUserExist(username) && APIUtil.getRESTAPIScopesForTenant(MultitenantUtils\n+                    .getTenantDomain(username)).containsKey(scopeName)) {\n+                userRoles = APIUtil.getListOfRoles(username);\n+                SettingsMappingUtil settingsMappingUtil = new SettingsMappingUtil();\n+\n+                if (settingsMappingUtil.GetRoleScopeList(userRoles, username).contains(scopeName)) {\n+                    scopeSettingsDTO.setName(scopeName);\n+                }\n+            } else {\n+                errorDTO.setCode(404l);\n+                errorDTO.description(\"Username or Scope does not exist\");\n+                errorDTO.setMessage(\"Not Found\");\n+                return Response.ok().entity(errorDTO).build();\n+            }\n+        } catch (APIManagementException e) {\n+            String errorMessage = \"Error when getting the list of scopes\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYzODk4MA==", "bodyText": "Fixed with 5510d27", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433638980", "createdAt": "2020-06-02T06:04:32Z", "author": {"login": "Meruja"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/impl/SettingsApiServiceImpl.java", "diffHunk": "@@ -51,4 +55,38 @@ public Response settingsGet(MessageContext messageContext) {\n         }\n         return null;\n     }\n+\n+    /**\n+     * Get all scopes of a user\n+     *\n+     * @param username Search query\n+     * @return Scope list\n+     */\n+    @Override\n+    public Response settingsScopesScopeGet(String username, String scopeName, MessageContext messageContext) {\n+        String[] userRoles;\n+        ScopeSettingsDTO scopeSettingsDTO = new ScopeSettingsDTO();\n+        ErrorDTO errorDTO = new ErrorDTO();\n+\n+        try {\n+            if (APIUtil.isUserExist(username) && APIUtil.getRESTAPIScopesForTenant(MultitenantUtils\n+                    .getTenantDomain(username)).containsKey(scopeName)) {\n+                userRoles = APIUtil.getListOfRoles(username);\n+                SettingsMappingUtil settingsMappingUtil = new SettingsMappingUtil();\n+\n+                if (settingsMappingUtil.GetRoleScopeList(userRoles, username).contains(scopeName)) {\n+                    scopeSettingsDTO.setName(scopeName);\n+                }\n+            } else {\n+                errorDTO.setCode(404l);\n+                errorDTO.description(\"Username or Scope does not exist\");\n+                errorDTO.setMessage(\"Not Found\");\n+                return Response.ok().entity(errorDTO).build();\n+            }\n+        } catch (APIManagementException e) {\n+            String errorMessage = \"Error when getting the list of scopes\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjQ1Nw=="}, "originalCommit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzQ0NTI2OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyNTowOFrOGc_E0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNjowNDoyMFrOGdjOAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjczOQ==", "bodyText": "We are retrieving the scopes twice.", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433046739", "createdAt": "2020-06-01T05:25:08Z", "author": {"login": "tgtshanika"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "diffHunk": "@@ -67,4 +71,27 @@ public SettingsDTO fromSettingstoDTO(Boolean isUserAvailable) throws APIManageme\n         }\n         return scopeList;\n     }\n+\n+    public List<String> GetRoleScopeList(String[] userRoles, String username) {\n+        List<String> userRoleList;\n+        List<String> authorizedScopes = new ArrayList<>();\n+\n+        if (userRoles == null || userRoles.length == 0) {\n+            userRoles = new String[0];\n+        }\n+\n+        userRoleList = Arrays.asList(userRoles);\n+        Map<String, String> scopeRoleMapping =\n+                APIUtil.getRESTAPIScopesForTenant(MultitenantUtils.getTenantDomain(username));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYzODkxMw==", "bodyText": "Fixed with 5510d27", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433638913", "createdAt": "2020-06-02T06:04:20Z", "author": {"login": "Meruja"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "diffHunk": "@@ -67,4 +71,27 @@ public SettingsDTO fromSettingstoDTO(Boolean isUserAvailable) throws APIManageme\n         }\n         return scopeList;\n     }\n+\n+    public List<String> GetRoleScopeList(String[] userRoles, String username) {\n+        List<String> userRoleList;\n+        List<String> authorizedScopes = new ArrayList<>();\n+\n+        if (userRoles == null || userRoles.length == 0) {\n+            userRoles = new String[0];\n+        }\n+\n+        userRoleList = Arrays.asList(userRoles);\n+        Map<String, String> scopeRoleMapping =\n+                APIUtil.getRESTAPIScopesForTenant(MultitenantUtils.getTenantDomain(username));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NjczOQ=="}, "originalCommit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NzQ0NzA1OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNToyNjoyNFrOGc_F8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwODozNTo0N1rOGdC54A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NzAyNQ==", "bodyText": "possible NPE?", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433047025", "createdAt": "2020-06-01T05:26:24Z", "author": {"login": "tgtshanika"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "diffHunk": "@@ -67,4 +71,27 @@ public SettingsDTO fromSettingstoDTO(Boolean isUserAvailable) throws APIManageme\n         }\n         return scopeList;\n     }\n+\n+    public List<String> GetRoleScopeList(String[] userRoles, String username) {\n+        List<String> userRoleList;\n+        List<String> authorizedScopes = new ArrayList<>();\n+\n+        if (userRoles == null || userRoles.length == 0) {\n+            userRoles = new String[0];\n+        }\n+\n+        userRoleList = Arrays.asList(userRoles);\n+        Map<String, String> scopeRoleMapping =\n+                APIUtil.getRESTAPIScopesForTenant(MultitenantUtils.getTenantDomain(username));\n+        Iterator<Map.Entry<String, String>> iterator = scopeRoleMapping.entrySet().iterator();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEwOTQ3Mg==", "bodyText": "Since we are getting all the scopes from the tenant and extract the scopes that mapped with the user's roles. There would be scope for all roles as per scopeIssuer. In this case, we won't get NPE.", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r433109472", "createdAt": "2020-06-01T08:35:47Z", "author": {"login": "Meruja"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/java/org/wso2/carbon/apimgt/rest/api/admin/v1/utils/mappings/SettingsMappingUtil.java", "diffHunk": "@@ -67,4 +71,27 @@ public SettingsDTO fromSettingstoDTO(Boolean isUserAvailable) throws APIManageme\n         }\n         return scopeList;\n     }\n+\n+    public List<String> GetRoleScopeList(String[] userRoles, String username) {\n+        List<String> userRoleList;\n+        List<String> authorizedScopes = new ArrayList<>();\n+\n+        if (userRoles == null || userRoles.length == 0) {\n+            userRoles = new String[0];\n+        }\n+\n+        userRoleList = Arrays.asList(userRoles);\n+        Map<String, String> scopeRoleMapping =\n+                APIUtil.getRESTAPIScopesForTenant(MultitenantUtils.getTenantDomain(username));\n+        Iterator<Map.Entry<String, String>> iterator = scopeRoleMapping.entrySet().iterator();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA0NzAyNQ=="}, "originalCommit": {"oid": "3343b30ba7de5360c87229c7a0c33c89d11348b8"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNTg5Njk5OnYy", "diffSide": "RIGHT", "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/resources/admin-api.yaml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODozMjoxOVrOGtN2qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODozMjoxOVrOGtN2qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA2NjA5MQ==", "bodyText": "let's have a habit to mention the x-wso2-request in this format in future PRs. https://github.com/Meruja/carbon-apimgt/blob/5510d27701692c0e352ff2194d6a95d43c49d3ea/components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/resources/admin-api.yaml#L2301-L2303.  It is more clear.", "url": "https://github.com/wso2/carbon-apimgt/pull/8605#discussion_r450066091", "createdAt": "2020-07-06T08:32:19Z", "author": {"login": "rmsamitha"}, "path": "components/apimgt/org.wso2.carbon.apimgt.rest.api.admin.v1/src/main/resources/admin-api.yaml", "diffHunk": "@@ -2965,11 +2965,72 @@ paths:\n           schema:\n             $ref: '#/definitions/Error'\n \n+  /settings/scopes/{scope}:\n+    #-----------------------------------------------------\n+    # Retrieve scope settings\n+    #-----------------------------------------------------\n+    get:\n+      security:\n+        - OAuth2Security:\n+            - apim:admin_settings\n+      x-wso2-curl: \"curl -k -X GET \\\"https://localhost:9443/api/am/admin/v1/settings/scopes/apim:subscribe?username=john\\\" -H \\\"accept: application/json\\\" -H \\\"Authorization: Bearer 8e8edc50-4a70-3fec-af00-ce08097012ab\"\n+      x-wso2-request: \"GET https://localhost:9443/api/am/admin/v1/settings/scopes/apim:subscribe?username=john Authorization: Bearer 8e8edc50-4a70-3fec-af00-ce08097012ab\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5510d27701692c0e352ff2194d6a95d43c49d3ea"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3300, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}