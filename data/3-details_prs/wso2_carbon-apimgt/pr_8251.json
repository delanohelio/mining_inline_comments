{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NTIxMjM5", "number": 8251, "title": "Adding visibility of docs when API is made public from the restricted by roles", "bodyText": "Fix wso2/product-apim/issues/7448", "createdAt": "2020-02-25T11:21:02Z", "url": "https://github.com/wso2/carbon-apimgt/pull/8251", "merged": true, "mergeCommit": {"oid": "2f197d4570d306aadcbd5da94086c8c5efabf483"}, "closed": true, "closedAt": "2020-02-26T04:33:50Z", "author": {"login": "Meruja"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHwMxqgH2gAyMzc5NTIxMjM5OmRhNTkzZWYyZmJmZjQ1ZjE0OTZiMjA1YWQ1OTI4ZTRiOTU1MmY4MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyMn8RgFqTQ0Mjg1NjY2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "da593ef2fbff45f1496b205ad5928e4b9552f801", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/da593ef2fbff45f1496b205ad5928e4b9552f801", "committedDate": "2020-02-25T11:12:57Z", "message": "Added visibility of doc when API is made public from restricted by roles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c1fc4019ef8da12ce9548410f03ecd9708a948d", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/2c1fc4019ef8da12ce9548410f03ecd9708a948d", "committedDate": "2020-02-25T11:19:11Z", "message": "Removed commented lines."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1ac162ed3524cadebf35d38f9754f17c8e7f313", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/e1ac162ed3524cadebf35d38f9754f17c8e7f313", "committedDate": "2020-02-25T11:35:14Z", "message": "Reformatted."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MTU1MTk2", "url": "https://github.com/wso2/carbon-apimgt/pull/8251#pullrequestreview-364155196", "createdAt": "2020-02-25T13:52:40Z", "commit": {"oid": "e1ac162ed3524cadebf35d38f9754f17c8e7f313"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMzo1Mjo0MFrOFuG02w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxMzo1Mjo0MFrOFuG02w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg5MDY1MQ==", "bodyText": "Shall we make this a constant?", "url": "https://github.com/wso2/carbon-apimgt/pull/8251#discussion_r383890651", "createdAt": "2020-02-25T13:52:40Z", "author": {"login": "mushthaq33"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/test/java/org/wso2/carbon/apimgt/impl/APIProviderImplTest.java", "diffHunk": "@@ -2282,6 +2281,23 @@ public void testUpdateAPI_InCreatedState() throws RegistryException, UserStoreEx\n \n \n         List<Documentation> documentationList = getDocumentationList();\n+        Documentation documentation = documentationList.get(1);\n+        Mockito.when(APIUtil.getAPIDocPath(api.getId())).thenReturn(documentation.getFilePath());\n+        APIProviderImplWrapper apiProviderImplWrapper = new APIProviderImplWrapper(apimgtDAO, null, null);\n+        Resource docResource = Mockito.mock(Resource.class);\n+        Mockito.when(docResource.getUUID()).thenReturn(documentation.getId());\n+        Mockito.when(apiProviderImplWrapper.registry.get(documentation.getFilePath())).thenReturn(docResource);\n+\n+        GenericArtifact docArtifact = Mockito.mock(GenericArtifact.class);\n+        Mockito.when(artifactManager.getGenericArtifact(documentation.getId())).thenReturn(docArtifact);\n+        Mockito.when(APIUtil.getDocumentation(docArtifact)).thenReturn(documentation);\n+        Mockito.when(docArtifact.getPath()).thenReturn(\"artifact/path\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1ac162ed3524cadebf35d38f9754f17c8e7f313"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f49c9d3f081876d70d326565a7a5ea85b31633df", "author": {"user": {"login": "Meruja", "name": "Meruja Selvamanikkam"}}, "url": "https://github.com/wso2/carbon-apimgt/commit/f49c9d3f081876d70d326565a7a5ea85b31633df", "committedDate": "2020-02-26T03:47:26Z", "message": "Added constant."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NjA5MzQ5", "url": "https://github.com/wso2/carbon-apimgt/pull/8251#pullrequestreview-364609349", "createdAt": "2020-02-26T03:56:43Z", "commit": {"oid": "f49c9d3f081876d70d326565a7a5ea85b31633df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODU0OTA2", "url": "https://github.com/wso2/carbon-apimgt/pull/8251#pullrequestreview-442854906", "createdAt": "2020-07-06T08:02:05Z", "commit": {"oid": "f49c9d3f081876d70d326565a7a5ea85b31633df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODowMjowNVrOGtM2rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODowMjowNVrOGtM2rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA0OTcwOA==", "bodyText": "Add context information to error logs", "url": "https://github.com/wso2/carbon-apimgt/pull/8251#discussion_r450049708", "createdAt": "2020-07-06T08:02:05Z", "author": {"login": "tgtshanika"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -3154,6 +3163,57 @@ public void addDocumentationContent(API api, String documentationName, String te\n         }\n     }\n \n+    /**\n+     * Updates a visibility of the documentation\n+     *\n+     * @param api               API\n+     * @param documentation    Documentation\n+     * @throws APIManagementException if failed to update visibility\n+     */\n+    private void updateDocVisibility(API api, Documentation documentation) throws APIManagementException {\n+        try {\n+            GenericArtifactManager artifactManager = APIUtil.getArtifactManager(registry,APIConstants.DOCUMENTATION_KEY);\n+            if (artifactManager == null) {\n+                String errorMessage = \"Artifact manager is null when updating documentation of API \" +\n+                        api.getId().getApiName();\n+                throw new APIManagementException(errorMessage);\n+            }\n+\n+            GenericArtifact artifact = artifactManager.getGenericArtifact(documentation.getId());\n+            String[] authorizedRoles = new String[0];\n+            String visibleRolesList = api.getVisibleRoles();\n+            if (visibleRolesList != null) {\n+                authorizedRoles = visibleRolesList.split(\",\");\n+            }\n+\n+            int tenantId;\n+            String tenantDomain =\n+                    MultitenantUtils.getTenantDomain(APIUtil.replaceEmailDomainBack(api.getId().getProviderName()));\n+            try {\n+                tenantId = getTenantId(tenantDomain);\n+\n+                GenericArtifact updateApiArtifact = APIUtil.createDocArtifactContent(artifact, api.getId(), documentation);\n+                artifactManager.updateGenericArtifact(updateApiArtifact);\n+                APIUtil.clearResourcePermissions(artifact.getPath(), api.getId(), tenantId);\n+\n+                APIUtil.setResourcePermissions(api.getId().getProviderName(), api.getVisibility(), authorizedRoles,\n+                        artifact.getPath(), registry);\n+\n+                String docFilePath = artifact.getAttribute(APIConstants.DOC_FILE_PATH);\n+                if (org.apache.commons.lang.StringUtils.isEmpty(docFilePath)) {\n+                    int startIndex = docFilePath.indexOf(\"governance\") + \"governance\".length();\n+                    String filePath = docFilePath.substring(startIndex, docFilePath.length());\n+                    APIUtil.setResourcePermissions(api.getId().getProviderName(), api.getVisibility(),\n+                            authorizedRoles, filePath, registry);\n+                }\n+            } catch (UserStoreException e) {\n+                throw new APIManagementException(\"Error in retrieving Tenant Information while adding api :\"\n+                        + api.getId().getApiName(), e);\n+            }\n+        } catch (RegistryException e) {\n+            handleException(\"Failed to update visibility of documentation\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f49c9d3f081876d70d326565a7a5ea85b31633df"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODU2NjYw", "url": "https://github.com/wso2/carbon-apimgt/pull/8251#pullrequestreview-442856660", "createdAt": "2020-07-06T08:04:46Z", "commit": {"oid": "f49c9d3f081876d70d326565a7a5ea85b31633df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODowNDo0N1rOGtM7lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODowNDo0N1rOGtM7lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA1MDk2Ng==", "bodyText": "This operation is not related to API creation right? This is related to doc visibility update. Please modify the error messages accrdingly.", "url": "https://github.com/wso2/carbon-apimgt/pull/8251#discussion_r450050966", "createdAt": "2020-07-06T08:04:47Z", "author": {"login": "tgtshanika"}, "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/APIProviderImpl.java", "diffHunk": "@@ -3154,6 +3163,57 @@ public void addDocumentationContent(API api, String documentationName, String te\n         }\n     }\n \n+    /**\n+     * Updates a visibility of the documentation\n+     *\n+     * @param api               API\n+     * @param documentation    Documentation\n+     * @throws APIManagementException if failed to update visibility\n+     */\n+    private void updateDocVisibility(API api, Documentation documentation) throws APIManagementException {\n+        try {\n+            GenericArtifactManager artifactManager = APIUtil.getArtifactManager(registry,APIConstants.DOCUMENTATION_KEY);\n+            if (artifactManager == null) {\n+                String errorMessage = \"Artifact manager is null when updating documentation of API \" +\n+                        api.getId().getApiName();\n+                throw new APIManagementException(errorMessage);\n+            }\n+\n+            GenericArtifact artifact = artifactManager.getGenericArtifact(documentation.getId());\n+            String[] authorizedRoles = new String[0];\n+            String visibleRolesList = api.getVisibleRoles();\n+            if (visibleRolesList != null) {\n+                authorizedRoles = visibleRolesList.split(\",\");\n+            }\n+\n+            int tenantId;\n+            String tenantDomain =\n+                    MultitenantUtils.getTenantDomain(APIUtil.replaceEmailDomainBack(api.getId().getProviderName()));\n+            try {\n+                tenantId = getTenantId(tenantDomain);\n+\n+                GenericArtifact updateApiArtifact = APIUtil.createDocArtifactContent(artifact, api.getId(), documentation);\n+                artifactManager.updateGenericArtifact(updateApiArtifact);\n+                APIUtil.clearResourcePermissions(artifact.getPath(), api.getId(), tenantId);\n+\n+                APIUtil.setResourcePermissions(api.getId().getProviderName(), api.getVisibility(), authorizedRoles,\n+                        artifact.getPath(), registry);\n+\n+                String docFilePath = artifact.getAttribute(APIConstants.DOC_FILE_PATH);\n+                if (org.apache.commons.lang.StringUtils.isEmpty(docFilePath)) {\n+                    int startIndex = docFilePath.indexOf(\"governance\") + \"governance\".length();\n+                    String filePath = docFilePath.substring(startIndex, docFilePath.length());\n+                    APIUtil.setResourcePermissions(api.getId().getProviderName(), api.getVisibility(),\n+                            authorizedRoles, filePath, registry);\n+                }\n+            } catch (UserStoreException e) {\n+                throw new APIManagementException(\"Error in retrieving Tenant Information while adding api :\"\n+                        + api.getId().getApiName(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f49c9d3f081876d70d326565a7a5ea85b31633df"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2932, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}