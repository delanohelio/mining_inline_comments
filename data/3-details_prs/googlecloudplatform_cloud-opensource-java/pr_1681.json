{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMTIzNjY1", "number": 1681, "title": "ReturnTypeChangedProblem's error message should clarify the expected and actual return types", "bodyText": "Fixes #1541.\nThis implements Elliotte's idea:\n\nThis strikes me as overly verbose. If the problem is that the method is found but the return type has changed, then that's what we should say. We shouldn't say the method is missing at all.", "createdAt": "2020-09-25T14:44:02Z", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681", "merged": true, "mergeCommit": {"oid": "48cabf06fed288da1f27b4eb13e2a0bfcec9a396"}, "closed": true, "closedAt": "2020-09-28T12:03:26Z", "author": {"login": "suztomo"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMW1HJgH2gAyNDkzMTIzNjY1OjE0NTlkNDM5NjBhMWVkMDUwNjYzMjM5ZThjMWYxMGQ5MDUyN2Y4ZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNRaHrAFqTQ5NzM5OTc5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1459d43960a1ed050663239e8c1f10d90527f8f3", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/1459d43960a1ed050663239e8c1f10d90527f8f3", "committedDate": "2020-09-25T14:40:15Z", "message": "Fixes #1541"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/1aad4f6e75c03b4f6bf10a5a108de4ea10450d99", "committedDate": "2020-09-25T14:43:27Z", "message": "format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NDkwMDYx", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#pullrequestreview-496490061", "createdAt": "2020-09-25T14:45:27Z", "commit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDo0NToyN1rOHYGvKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDo0Njo1M1rOHYGyjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzODI0OA==", "bodyText": "\"is not found\" message is gone.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495038248", "createdAt": "2020-09-25T14:45:27Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ReturnTypeChangedProblem.java", "diffHunk": "@@ -24,15 +26,32 @@\n  * actualTypeName}).\n  */\n class ReturnTypeChangedProblem extends LinkageProblem {\n+  private String actualType;\n+\n   ReturnTypeChangedProblem(\n       ClassFile sourceClass,\n       @Nullable ClassFile targetClass,\n       MethodSymbol expectedMethodSymbol,\n       String actualType) {\n     super(\n-        \"is not found. The expected return type does not match the actual type \" + actualType,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzODUxMQ==", "bodyText": "Because of the missing equals method, this test was not using correct expected value.\nThe last argument of ReturnTypeChangedProblem is the actual type. protobuf-java 3.12.4 expects flip() method to return java.nio.CharBuffer but in JDK 8 the method actually has return type java.nio.Buffer.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495038511", "createdAt": "2020-09-25T14:45:54Z", "author": {"login": "suztomo"}, "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerTest.java", "diffHunk": "@@ -1145,7 +1145,7 @@ public void testFindLinkageProblems_referenceToJava11Method() throws IOException\n             new ClassFile(jars.get(0), \"com.google.protobuf.TextFormat\"),\n             null,\n             methodSymbol,\n-            \"java.nio.CharBuffer\");\n+            \"java.nio.Buffer\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzOTExOQ==", "bodyText": "This is the effect of this PR.\n(The backslash at the end is not to break the line there.)", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495039119", "createdAt": "2020-09-25T14:46:53Z", "author": {"login": "suztomo"}, "path": "enforcer-rules/src/it/return-type-mismatch/verify.groovy", "diffHunk": "@@ -0,0 +1,16 @@\n+def buildLog = new File(basedir, \"build.log\").text.replaceAll(\"\\\\r\\\\n\", \"\\n\")\n+\n+// protobuf-java 3.12.4 has wrong reference to ByteBuffer's methods that are unavailable in Java 8.\n+// In this message below, the expectation is wrong.\n+assert buildLog.contains('''\\\n+java.nio.ByteBuffer's method position(int) is expected to return java.nio.ByteBuffer\\\n+ but the actual type is java.nio.Buffer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NDk0ODYw", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#pullrequestreview-496494860", "createdAt": "2020-09-25T14:50:53Z", "commit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDo1MDo1NFrOHYG8vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDo1MDo1NFrOHYG8vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0MTcyNQ==", "bodyText": "These overrides have been missing and allowed testFindLinkageProblems_referenceToJava11Method to ignore the actualType field.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495041725", "createdAt": "2020-09-25T14:50:54Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ReturnTypeChangedProblem.java", "diffHunk": "@@ -24,15 +26,32 @@\n  * actualTypeName}).\n  */\n class ReturnTypeChangedProblem extends LinkageProblem {\n+  private String actualType;\n+\n   ReturnTypeChangedProblem(\n       ClassFile sourceClass,\n       @Nullable ClassFile targetClass,\n       MethodSymbol expectedMethodSymbol,\n       String actualType) {\n     super(\n-        \"is not found. The expected return type does not match the actual type \" + actualType,\n+        \"is expected to return \"\n+            + Utility.methodSignatureReturnType(expectedMethodSymbol.getDescriptor())\n+            + \" but the actual type is \"\n+            + actualType,\n         sourceClass,\n         expectedMethodSymbol,\n         targetClass);\n+    this.actualType = actualType;\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    return Objects.hash(super.hashCode(), actualType);\n+  }\n+\n+  @Override\n+  public boolean equals(Object other) {\n+    return super.equals(other) // this checks the class equality\n+        && Objects.equals(actualType, ((ReturnTypeChangedProblem) other).actualType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NjQxOTQy", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#pullrequestreview-496641942", "createdAt": "2020-09-25T18:12:30Z", "commit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxODoxMjozMFrOHYNyJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxODoxNDowOFrOHYN1IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE1MzcwMQ==", "bodyText": "why a com.sun class?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495153701", "createdAt": "2020-09-25T18:12:30Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ReturnTypeChangedProblem.java", "diffHunk": "@@ -16,6 +16,8 @@\n \n package com.google.cloud.tools.opensource.classpath;\n \n+import com.sun.org.apache.bcel.internal.classfile.Utility;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE1NDAzOQ==", "bodyText": "\"the actual type is\" --> but instead returns", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495154039", "createdAt": "2020-09-25T18:13:11Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ReturnTypeChangedProblem.java", "diffHunk": "@@ -24,15 +26,32 @@\n  * actualTypeName}).\n  */\n class ReturnTypeChangedProblem extends LinkageProblem {\n+  private String actualType;\n+\n   ReturnTypeChangedProblem(\n       ClassFile sourceClass,\n       @Nullable ClassFile targetClass,\n       MethodSymbol expectedMethodSymbol,\n       String actualType) {\n     super(\n-        \"is not found. The expected return type does not match the actual type \" + actualType,\n+        \"is expected to return \"\n+            + Utility.methodSignatureReturnType(expectedMethodSymbol.getDescriptor())\n+            + \" but the actual type is \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE1NDQ2NQ==", "bodyText": "Good catch. The equals method in the supertype should perhaps be testing for class equality.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495154465", "createdAt": "2020-09-25T18:14:08Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ReturnTypeChangedProblem.java", "diffHunk": "@@ -24,15 +26,32 @@\n  * actualTypeName}).\n  */\n class ReturnTypeChangedProblem extends LinkageProblem {\n+  private String actualType;\n+\n   ReturnTypeChangedProblem(\n       ClassFile sourceClass,\n       @Nullable ClassFile targetClass,\n       MethodSymbol expectedMethodSymbol,\n       String actualType) {\n     super(\n-        \"is not found. The expected return type does not match the actual type \" + actualType,\n+        \"is expected to return \"\n+            + Utility.methodSignatureReturnType(expectedMethodSymbol.getDescriptor())\n+            + \" but the actual type is \"\n+            + actualType,\n         sourceClass,\n         expectedMethodSymbol,\n         targetClass);\n+    this.actualType = actualType;\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    return Objects.hash(super.hashCode(), actualType);\n+  }\n+\n+  @Override\n+  public boolean equals(Object other) {\n+    return super.equals(other) // this checks the class equality\n+        && Objects.equals(actualType, ((ReturnTypeChangedProblem) other).actualType);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0MTcyNQ=="}, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2ba7c748f18f793d1f9e9c1fca59a5b69c6aeb3", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/b2ba7c748f18f793d1f9e9c1fca59a5b69c6aeb3", "committedDate": "2020-09-25T19:06:47Z", "message": "Applied review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "789f017cd36655efb8b82378b2c1264a35816472", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/789f017cd36655efb8b82378b2c1264a35816472", "committedDate": "2020-09-25T19:44:51Z", "message": "Added test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NzE0MDIz", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#pullrequestreview-496714023", "createdAt": "2020-09-25T19:04:58Z", "commit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOTowNDo1OVrOHYPVBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOTowNjozN1rOHYPYIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3OTAxNA==", "bodyText": "Fixed. It was fetching the class from rt.jar. Interesting.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495179014", "createdAt": "2020-09-25T19:04:59Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ReturnTypeChangedProblem.java", "diffHunk": "@@ -16,6 +16,8 @@\n \n package com.google.cloud.tools.opensource.classpath;\n \n+import com.sun.org.apache.bcel.internal.classfile.Utility;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE1MzcwMQ=="}, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3OTQ1Mw==", "bodyText": "Nice. Updated.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495179453", "createdAt": "2020-09-25T19:05:52Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ReturnTypeChangedProblem.java", "diffHunk": "@@ -24,15 +26,32 @@\n  * actualTypeName}).\n  */\n class ReturnTypeChangedProblem extends LinkageProblem {\n+  private String actualType;\n+\n   ReturnTypeChangedProblem(\n       ClassFile sourceClass,\n       @Nullable ClassFile targetClass,\n       MethodSymbol expectedMethodSymbol,\n       String actualType) {\n     super(\n-        \"is not found. The expected return type does not match the actual type \" + actualType,\n+        \"is expected to return \"\n+            + Utility.methodSignatureReturnType(expectedMethodSymbol.getDescriptor())\n+            + \" but the actual type is \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE1NDAzOQ=="}, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE3OTgwOQ==", "bodyText": "Added test with ReturnTypeChangedProblem.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495179809", "createdAt": "2020-09-25T19:06:37Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ReturnTypeChangedProblem.java", "diffHunk": "@@ -24,15 +26,32 @@\n  * actualTypeName}).\n  */\n class ReturnTypeChangedProblem extends LinkageProblem {\n+  private String actualType;\n+\n   ReturnTypeChangedProblem(\n       ClassFile sourceClass,\n       @Nullable ClassFile targetClass,\n       MethodSymbol expectedMethodSymbol,\n       String actualType) {\n     super(\n-        \"is not found. The expected return type does not match the actual type \" + actualType,\n+        \"is expected to return \"\n+            + Utility.methodSignatureReturnType(expectedMethodSymbol.getDescriptor())\n+            + \" but the actual type is \"\n+            + actualType,\n         sourceClass,\n         expectedMethodSymbol,\n         targetClass);\n+    this.actualType = actualType;\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    return Objects.hash(super.hashCode(), actualType);\n+  }\n+\n+  @Override\n+  public boolean equals(Object other) {\n+    return super.equals(other) // this checks the class equality\n+        && Objects.equals(actualType, ((ReturnTypeChangedProblem) other).actualType);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0MTcyNQ=="}, "originalCommit": {"oid": "1aad4f6e75c03b4f6bf10a5a108de4ea10450d99"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2ODcxNjc3", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#pullrequestreview-496871677", "createdAt": "2020-09-25T21:24:06Z", "commit": {"oid": "789f017cd36655efb8b82378b2c1264a35816472"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMToyNDowN1rOHYTJHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMToyNDowN1rOHYTJHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI0MTUwMg==", "bodyText": "sort imports", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#discussion_r495241502", "createdAt": "2020-09-25T21:24:07Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ReturnTypeChangedProblem.java", "diffHunk": "@@ -16,6 +16,8 @@\n \n package com.google.cloud.tools.opensource.classpath;\n \n+import org.apache.bcel.classfile.Utility;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "789f017cd36655efb8b82378b2c1264a35816472"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45f8e92ac198588c6250b63e927f5f5709895181", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/45f8e92ac198588c6250b63e927f5f5709895181", "committedDate": "2020-09-25T22:30:21Z", "message": "Sorting import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "255eee250c92d471440215a810496c19c72f1c1b", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/255eee250c92d471440215a810496c19c72f1c1b", "committedDate": "2020-09-25T22:30:47Z", "message": "Merge remote-tracking branch 'origin/master' into return_type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3Mzk5Nzk1", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1681#pullrequestreview-497399795", "createdAt": "2020-09-28T10:55:10Z", "commit": {"oid": "255eee250c92d471440215a810496c19c72f1c1b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 155, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}