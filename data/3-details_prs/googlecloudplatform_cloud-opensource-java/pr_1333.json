{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MzY3ODk5", "number": 1333, "title": "LinkageCheckerMain to have option to write linkage errors as exclusion file.", "bodyText": "Fixes #1276 .\n\nExclusionFiles have parse and write methods to operate on the exclusion files.", "createdAt": "2020-04-03T20:20:45Z", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333", "merged": true, "mergeCommit": {"oid": "ae1e46433f501cf9138b6561eb83f358436b79b5"}, "closed": true, "closedAt": "2020-04-16T19:34:28Z", "author": {"login": "suztomo"}, "timelineItems": {"totalCount": 45, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUFi7xgH2gAyMzk4MzY3ODk5OmE3MDg5MWYyMTliZWExYjc5MzdjZmE2YTA3YjZlYTczOTk5MmExNjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYPJfAAH2gAyMzk4MzY3ODk5OjQ0YTRmNTFmZGQ0M2E5NDlmNzBiNzY2YzRkMTk4Zjc5YzQwNWE4NzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a70891f219bea1b7937cfa6a07b6ea739992a164", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/a70891f219bea1b7937cfa6a07b6ea739992a164", "committedDate": "2020-04-03T18:52:15Z", "message": "Started XmlOutputFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b9c5b4e7e7b6781c764f6fbc426328c30f06e79", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/0b9c5b4e7e7b6781c764f6fbc426328c30f06e79", "committedDate": "2020-04-03T19:18:46Z", "message": "Merge remote-tracking branch 'origin/master' into i1276"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b61a4b4884339b66668509643e5bc3f81887307", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4b61a4b4884339b66668509643e5bc3f81887307", "committedDate": "2020-04-03T20:14:21Z", "message": "Trying to use XMLEventFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/6ccb1a93031facab0c39bbaf66d2f421c422a4b8", "committedDate": "2020-04-03T20:19:28Z", "message": "Not working"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTY3MTEz", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#pullrequestreview-387567113", "createdAt": "2020-04-03T20:41:37Z", "commit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMDo0MTozOFrOGAoqDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMDo0NjoxNlrOGAo3fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxOTMxMA==", "bodyText": "exclusion-file", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r403319310", "createdAt": "2020-04-03T20:41:38Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerArguments.java", "diffHunk": "@@ -170,6 +170,14 @@ private static Options configureOptions() {\n             .build();\n     options.addOption(exclusionFile);\n \n+    Option writeAsExclusionFile =\n+        Option.builder(\"w\")\n+            .longOpt(\"write-as-exclusion-file\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMDE0Ng==", "bodyText": "delete", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r403320146", "createdAt": "2020-04-03T20:42:43Z", "author": {"login": "elharo"}, "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriterTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import static com.google.cloud.tools.opensource.classpath.TestHelper.classPathEntryOfResource;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSetMultimap;\n+import com.google.common.truth.Truth;\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import javax.xml.stream.XMLStreamException;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.junit.Test;\n+import org.xml.sax.SAXException;\n+\n+public class ExclusionFileWriterTest {\n+  @Test\n+  public void testExclusionFileCreation()\n+      throws IOException, XMLStreamException, VerifierConfigurationException, SAXException {\n+\n+    Path output = Files.createTempFile(\"output\", \".xml\");\n+\n+    SymbolProblem methodSymbolProblem =\n+        new SymbolProblem(\n+            new MethodSymbol(\n+                \"io.grpc.protobuf.ProtoUtils.marshaller\",\n+                \"marshaller\",\n+                \"(Lcom/google/protobuf/Message;)Lio/grpc/MethodDescriptor$Marshaller;\",\n+                false),\n+            ErrorType.SYMBOL_NOT_FOUND,\n+            new ClassFile(new ClassPathEntry(Paths.get(\"dummy.jar\")), \"java.lang.Object\"));\n+\n+    SymbolProblem classSymbolProblem =\n+        new SymbolProblem(new ClassSymbol(\"java.lang.Integer\"), ErrorType.CLASS_NOT_FOUND, null);\n+    ImmutableSetMultimap<SymbolProblem, ClassFile> linkageErrors =\n+        ImmutableSetMultimap.of(\n+            methodSymbolProblem, new ClassFile(new ClassPathEntry(Paths.get(\"source.jar\")), \"com.foo.Source1\"),\n+            classSymbolProblem,  new ClassFile(new ClassPathEntry(Paths.get(\"source.jar\")), \"com.foo.Source2\")\n+        );\n+    ExclusionFileWriter.write(output, linkageErrors);\n+\n+    System.out.println(\"Output\" + output);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMDQ1Mw==", "bodyText": "can you use try with resources here?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r403320453", "createdAt": "2020-04-03T20:43:08Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  /** Writes {@code linkageErrors} as exclusion rules into to {@code outputFile}. */\n+  static void write(Path outputFile, Multimap<SymbolProblem, ClassFile> linkageErrors)\n+      throws IOException, XMLStreamException {\n+\n+    XMLEventWriter writer = null;\n+    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMTE0Mg==", "bodyText": "delete \"to\"", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r403321142", "createdAt": "2020-04-03T20:44:02Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  /** Writes {@code linkageErrors} as exclusion rules into to {@code outputFile}. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMjc1MA==", "bodyText": "It might be reasonable to combine the writing and the parsing into a single class.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r403322750", "createdAt": "2020-04-03T20:46:16Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54aeedcf33593fe1189b41d93bec29a40db56bdb", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/54aeedcf33593fe1189b41d93bec29a40db56bdb", "committedDate": "2020-04-03T21:02:15Z", "message": "Test fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afda55f1d39fae187aac00e0475c7b145d07ce28", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/afda55f1d39fae187aac00e0475c7b145d07ce28", "committedDate": "2020-04-03T21:11:10Z", "message": "assertion for different types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4701cb92bbda62c94bcb11725d10e0b092095f0a", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4701cb92bbda62c94bcb11725d10e0b092095f0a", "committedDate": "2020-04-03T21:11:24Z", "message": "format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTc4ODQw", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#pullrequestreview-387578840", "createdAt": "2020-04-03T21:03:10Z", "commit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMTowMzoxMVrOGApk1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMToxNDoyMlrOGAp31w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNDM1Nw==", "bodyText": "Fixed.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r403334357", "createdAt": "2020-04-03T21:03:11Z", "author": {"login": "suztomo"}, "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriterTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import static com.google.cloud.tools.opensource.classpath.TestHelper.classPathEntryOfResource;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSetMultimap;\n+import com.google.common.truth.Truth;\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import javax.xml.stream.XMLStreamException;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.junit.Test;\n+import org.xml.sax.SAXException;\n+\n+public class ExclusionFileWriterTest {\n+  @Test\n+  public void testExclusionFileCreation()\n+      throws IOException, XMLStreamException, VerifierConfigurationException, SAXException {\n+\n+    Path output = Files.createTempFile(\"output\", \".xml\");\n+\n+    SymbolProblem methodSymbolProblem =\n+        new SymbolProblem(\n+            new MethodSymbol(\n+                \"io.grpc.protobuf.ProtoUtils.marshaller\",\n+                \"marshaller\",\n+                \"(Lcom/google/protobuf/Message;)Lio/grpc/MethodDescriptor$Marshaller;\",\n+                false),\n+            ErrorType.SYMBOL_NOT_FOUND,\n+            new ClassFile(new ClassPathEntry(Paths.get(\"dummy.jar\")), \"java.lang.Object\"));\n+\n+    SymbolProblem classSymbolProblem =\n+        new SymbolProblem(new ClassSymbol(\"java.lang.Integer\"), ErrorType.CLASS_NOT_FOUND, null);\n+    ImmutableSetMultimap<SymbolProblem, ClassFile> linkageErrors =\n+        ImmutableSetMultimap.of(\n+            methodSymbolProblem, new ClassFile(new ClassPathEntry(Paths.get(\"source.jar\")), \"com.foo.Source1\"),\n+            classSymbolProblem,  new ClassFile(new ClassPathEntry(Paths.get(\"source.jar\")), \"com.foo.Source2\")\n+        );\n+    ExclusionFileWriter.write(output, linkageErrors);\n+\n+    System.out.println(\"Output\" + output);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMDE0Ng=="}, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNDQyOQ==", "bodyText": "Deleted.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r403334429", "createdAt": "2020-04-03T21:03:20Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  /** Writes {@code linkageErrors} as exclusion rules into to {@code outputFile}. */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMTE0Mg=="}, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNDUwMA==", "bodyText": "It did not work. XMLEventWriter is not Autocloseable.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r403334500", "createdAt": "2020-04-03T21:03:27Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  /** Writes {@code linkageErrors} as exclusion rules into to {@code outputFile}. */\n+  static void write(Path outputFile, Multimap<SymbolProblem, ClassFile> linkageErrors)\n+      throws IOException, XMLStreamException {\n+\n+    XMLEventWriter writer = null;\n+    try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMDQ1Mw=="}, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzOTIyMw==", "bodyText": "This option is different from specifying exclusion file to filter linkage errors. Did you mean something further than that?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r403339223", "createdAt": "2020-04-03T21:14:22Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerArguments.java", "diffHunk": "@@ -170,6 +170,14 @@ private static Options configureOptions() {\n             .build();\n     options.addOption(exclusionFile);\n \n+    Option writeAsExclusionFile =\n+        Option.builder(\"w\")\n+            .longOpt(\"write-as-exclusion-file\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxOTMxMA=="}, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ce28323fefa8122568bbc06545703a4babccac5", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/3ce28323fefa8122568bbc06545703a4babccac5", "committedDate": "2020-04-03T21:24:18Z", "message": "static variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7bbcf73e44e7a40da9182fbcaa7591f43ff3c12", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/c7bbcf73e44e7a40da9182fbcaa7591f43ff3c12", "committedDate": "2020-04-03T21:25:54Z", "message": "closing tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b4ed641fe4ef01bc360585b7fabec7a7c8e2a1b", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/0b4ed641fe4ef01bc360585b7fabec7a7c8e2a1b", "committedDate": "2020-04-03T21:59:00Z", "message": "in the middle of jaxb."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90a8152676b3b51fcacdd0e29463a0f592bbd534", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/90a8152676b3b51fcacdd0e29463a0f592bbd534", "committedDate": "2020-04-03T22:14:51Z", "message": "indent by transformer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80ce12b48b19e40b9cb24d59ab91904497d5c590", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/80ce12b48b19e40b9cb24d59ab91904497d5c590", "committedDate": "2020-04-06T19:28:11Z", "message": "Merge remote-tracking branch 'origin/master' into i1276"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1cf90f8fea93acdf0653fb9d6791dcff9b10aa5", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/d1cf90f8fea93acdf0653fb9d6791dcff9b10aa5", "committedDate": "2020-04-06T21:08:07Z", "message": "Test to ensure indentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjE5NzQ5", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#pullrequestreview-388619749", "createdAt": "2020-04-06T21:10:38Z", "commit": {"oid": "d1cf90f8fea93acdf0653fb9d6791dcff9b10aa5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMToxMDozOFrOGBqBlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMToxMDozOFrOGBqBlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5MDI5NQ==", "bodyText": "The writer and the parser do not share logic. But I'm also ok to combine the two into ExclusionFiles. Do you think it's good idea?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r404390295", "createdAt": "2020-04-06T21:10:38Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMjc1MA=="}, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4358d0b24f4cb46c04bca16e47372663fb14627d", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4358d0b24f4cb46c04bca16e47372663fb14627d", "committedDate": "2020-04-06T21:15:01Z", "message": "try and autocloseable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7c0d03ad4ca34cf9aa482e84226c1fbedb80cbc", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/d7c0d03ad4ca34cf9aa482e84226c1fbedb80cbc", "committedDate": "2020-04-07T14:27:34Z", "message": "integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f246cab262270af461e4c4e782e40034590a434f", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/f246cab262270af461e4c4e782e40034590a434f", "committedDate": "2020-04-07T14:35:44Z", "message": "Catch throwable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80b0102f46c47962e747a0c7b50d26d90d80114e", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/80b0102f46c47962e747a0c7b50d26d90d80114e", "committedDate": "2020-04-07T14:46:38Z", "message": "print debug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MjAyOTEz", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#pullrequestreview-389202913", "createdAt": "2020-04-07T14:58:11Z", "commit": {"oid": "80b0102f46c47962e747a0c7b50d26d90d80114e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNDo1ODoxMVrOGCHu2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNDo1ODoxMVrOGCHu2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg3NzAxNw==", "bodyText": "Got\nbytes length:0\nXML input: \nInputStream available: 0\n\nhttps://fusion.corp.google.com/invocation/88f8ef04-b8e5-447d-8ee1-c6e9f553ab7a/buildlogs?target=cloud-opensource-java%2Fgcp_windows%2Fpresubmit&drilldownTab=tests", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r404877017", "createdAt": "2020-04-07T14:58:11Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -94,9 +94,15 @@ static void write(Path outputFile, Multimap<SymbolProblem, ClassFile> linkageErr\n       // Add new line character after doctype declaration\n       indentTransformer.setOutputProperty(OutputKeys.DOCTYPE_PUBLIC, \"yes\");\n \n+      byte[] bytes = buffer.toByteArray();\n+      System.out.println(\"bytes length:\" + bytes.length);\n+      System.out.println(\"XML input: \" + new String(bytes));\n+      ByteArrayInputStream inputStream = new ByteArrayInputStream(bytes);\n+      System.out.println(\"InputStream available: \" + inputStream.available());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80b0102f46c47962e747a0c7b50d26d90d80114e"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f70c9e782d8d3a1682e00bd6a48d09f85f5d6276", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/f70c9e782d8d3a1682e00bd6a48d09f85f5d6276", "committedDate": "2020-04-07T14:59:22Z", "message": "Close writer before reading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "881c9d1a33528e0ae9b289e36ecb539ff55a616f", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/881c9d1a33528e0ae9b289e36ecb539ff55a616f", "committedDate": "2020-04-07T15:09:44Z", "message": "Removed debug print"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d27b8042b21307d34cf9683da4096fd8516a5319", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/d27b8042b21307d34cf9683da4096fd8516a5319", "committedDate": "2020-04-07T15:15:21Z", "message": "Merge branch 'i1276' into exclusion_file_writer_integration_test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34bc1445010fe626cef8a7680b88b7dcf7768e7d", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/34bc1445010fe626cef8a7680b88b7dcf7768e7d", "committedDate": "2020-04-07T15:34:13Z", "message": "Integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d85d071c3c1d33408b1c7e5fd127e0f5e2c5a4d0", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/d85d071c3c1d33408b1c7e5fd127e0f5e2c5a4d0", "committedDate": "2020-04-07T15:34:27Z", "message": "Write in main"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f50a203f40d24260494e6f2482cd660f034c966d", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/f50a203f40d24260494e6f2482cd660f034c966d", "committedDate": "2020-04-07T15:34:48Z", "message": "Merge branch 'i1276' into exclusion_file_writer_integration_test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3515070051d52b3391482f28db80220c980928f0", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/3515070051d52b3391482f28db80220c980928f0", "committedDate": "2020-04-07T15:37:31Z", "message": "use temp file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTM1MTE2", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#pullrequestreview-390135116", "createdAt": "2020-04-08T16:25:30Z", "commit": {"oid": "3515070051d52b3391482f28db80220c980928f0"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjoyNTozMFrOGC3Eqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjozNzowM1rOGC3iYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1MjY1MQ==", "bodyText": "ExclusionFiles.write sounds better than ExclusionFilesWriter.write so yes.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405652651", "createdAt": "2020-04-08T16:25:30Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMjc1MA=="}, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1Mjg1Ng==", "bodyText": "private", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405652856", "createdAt": "2020-04-08T16:25:43Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import javax.xml.namespace.QName;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515070051d52b3391482f28db80220c980928f0"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1NzQyNg==", "bodyText": "I think we need to stop using multimaps. We need a better data type here.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405657426", "createdAt": "2020-04-08T16:32:38Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import javax.xml.namespace.QName;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  private static final QName LINKAGE_CHECKER_FILTER_TAG = QName.valueOf(\"LinkageCheckerFilter\");\n+  private static final QName CLASS_TAG = QName.valueOf(\"Class\");\n+  private static final QName LINKAGE_ERROR_TAG = QName.valueOf(\"LinkageError\");\n+  private static final QName TARGET_TAG = QName.valueOf(\"Target\");\n+  private static final QName SOURCE_TAG = QName.valueOf(\"Source\");\n+  private static final QName METHOD_TAG = QName.valueOf(\"Method\");\n+  private static final QName FIELD_TAG = QName.valueOf(\"Field\");\n+\n+  /** Writes {@code linkageErrors} as exclusion rules into {@code outputFile}. */\n+  static void write(Path outputFile, Multimap<SymbolProblem, ClassFile> linkageErrors)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515070051d52b3391482f28db80220c980928f0"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1OTE5OQ==", "bodyText": "You shouldn't need to do this. It should be enough to set that system property to point to the class you want.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405659199", "createdAt": "2020-04-08T16:35:21Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import javax.xml.namespace.QName;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  private static final QName LINKAGE_CHECKER_FILTER_TAG = QName.valueOf(\"LinkageCheckerFilter\");\n+  private static final QName CLASS_TAG = QName.valueOf(\"Class\");\n+  private static final QName LINKAGE_ERROR_TAG = QName.valueOf(\"LinkageError\");\n+  private static final QName TARGET_TAG = QName.valueOf(\"Target\");\n+  private static final QName SOURCE_TAG = QName.valueOf(\"Source\");\n+  private static final QName METHOD_TAG = QName.valueOf(\"Method\");\n+  private static final QName FIELD_TAG = QName.valueOf(\"Field\");\n+\n+  /** Writes {@code linkageErrors} as exclusion rules into {@code outputFile}. */\n+  static void write(Path outputFile, Multimap<SymbolProblem, ClassFile> linkageErrors)\n+      throws IOException, XMLStreamException, TransformerException {\n+\n+    ByteArrayOutputStream buffer = new ByteArrayOutputStream();\n+    XMLEventWriter writer = null;\n+    try {\n+      writer = XMLOutputFactory.newInstance().createXMLEventWriter(buffer);\n+\n+      writer.add(eventFactory.createStartDocument());\n+      writer.add(eventFactory.createStartElement(LINKAGE_CHECKER_FILTER_TAG, null, null));\n+\n+      for (SymbolProblem symbolProblem : linkageErrors.keySet()) {\n+        for (ClassFile classFile : linkageErrors.get(symbolProblem)) {\n+          writeXmlEvents(writer, symbolProblem, classFile);\n+        }\n+      }\n+\n+      writer.add(eventFactory.createEndElement(LINKAGE_CHECKER_FILTER_TAG, null));\n+      writer.add(eventFactory.createEndDocument());\n+\n+    } finally {\n+      if (writer != null) {\n+        writer.close();\n+      }\n+    }\n+\n+    try (OutputStream outputStream = Files.newOutputStream(outputFile)) {\n+      insertIndent(new ByteArrayInputStream(buffer.toByteArray()), outputStream);\n+    }\n+  }\n+\n+  private static void insertIndent(InputStream inputStream, OutputStream outputStream)\n+      throws TransformerException {\n+    if (System.getProperty(\"javax.xml.transform.TransformerFactory\") == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515070051d52b3391482f28db80220c980928f0"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MDI1Ng==", "bodyText": "OK. Didn't realize we were already using exclusion-file. Still write-as-exclusion-file isn't clear. Other names?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405660256", "createdAt": "2020-04-08T16:37:03Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerArguments.java", "diffHunk": "@@ -170,6 +170,14 @@ private static Options configureOptions() {\n             .build();\n     options.addOption(exclusionFile);\n \n+    Option writeAsExclusionFile =\n+        Option.builder(\"w\")\n+            .longOpt(\"write-as-exclusion-file\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxOTMxMA=="}, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed448ad55b85dbc8769fc0f829196c882f8da949", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/ed448ad55b85dbc8769fc0f829196c882f8da949", "committedDate": "2020-04-08T17:02:21Z", "message": "Merged Parser and Writer to ExclusionFiles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c900cbd3b6122643359c23493044fea1c2733e0b", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/c900cbd3b6122643359c23493044fea1c2733e0b", "committedDate": "2020-04-08T17:08:33Z", "message": "Simplified Xml indent logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3186264edc952b082771e71b41d93762f08e33de", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/3186264edc952b082771e71b41d93762f08e33de", "committedDate": "2020-04-08T17:15:01Z", "message": "Argument option \"o\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTU3MzAy", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#pullrequestreview-390157302", "createdAt": "2020-04-08T16:54:13Z", "commit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjo1NDoxM1rOGC4N2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzoxMTowMVrOGC43xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3MTM4NQ==", "bodyText": "Updated as output-linkage-errors-as-exclusion-file.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405671385", "createdAt": "2020-04-08T16:54:13Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerArguments.java", "diffHunk": "@@ -170,6 +170,14 @@ private static Options configureOptions() {\n             .build();\n     options.addOption(exclusionFile);\n \n+    Option writeAsExclusionFile =\n+        Option.builder(\"w\")\n+            .longOpt(\"write-as-exclusion-file\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMxOTMxMA=="}, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3MTcxMA==", "bodyText": "Merged the two files into ExclusionFiles.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405671710", "createdAt": "2020-04-08T16:54:42Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Iterator;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyMjc1MA=="}, "originalCommit": {"oid": "6ccb1a93031facab0c39bbaf66d2f421c422a4b8"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3MTgwMg==", "bodyText": "Fixed.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405671802", "createdAt": "2020-04-08T16:54:48Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import javax.xml.namespace.QName;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1Mjg1Ng=="}, "originalCommit": {"oid": "3515070051d52b3391482f28db80220c980928f0"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY3NjA3Ng==", "bodyText": "How about LinkageErrors class that has a field Multimap<SymbolProblem, ClassFile> errors? Anyway, such change is outside the scope of this PR.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405676076", "createdAt": "2020-04-08T17:01:08Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import javax.xml.namespace.QName;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  private static final QName LINKAGE_CHECKER_FILTER_TAG = QName.valueOf(\"LinkageCheckerFilter\");\n+  private static final QName CLASS_TAG = QName.valueOf(\"Class\");\n+  private static final QName LINKAGE_ERROR_TAG = QName.valueOf(\"LinkageError\");\n+  private static final QName TARGET_TAG = QName.valueOf(\"Target\");\n+  private static final QName SOURCE_TAG = QName.valueOf(\"Source\");\n+  private static final QName METHOD_TAG = QName.valueOf(\"Method\");\n+  private static final QName FIELD_TAG = QName.valueOf(\"Field\");\n+\n+  /** Writes {@code linkageErrors} as exclusion rules into {@code outputFile}. */\n+  static void write(Path outputFile, Multimap<SymbolProblem, ClassFile> linkageErrors)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1NzQyNg=="}, "originalCommit": {"oid": "3515070051d52b3391482f28db80220c980928f0"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4MjExNw==", "bodyText": "Removed the unnecessary logic.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405682117", "createdAt": "2020-04-08T17:11:01Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFileWriter.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import javax.xml.namespace.QName;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+\n+/** Writer for Linkage Checker exclusion files. */\n+class ExclusionFileWriter {\n+\n+  static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  private static final QName LINKAGE_CHECKER_FILTER_TAG = QName.valueOf(\"LinkageCheckerFilter\");\n+  private static final QName CLASS_TAG = QName.valueOf(\"Class\");\n+  private static final QName LINKAGE_ERROR_TAG = QName.valueOf(\"LinkageError\");\n+  private static final QName TARGET_TAG = QName.valueOf(\"Target\");\n+  private static final QName SOURCE_TAG = QName.valueOf(\"Source\");\n+  private static final QName METHOD_TAG = QName.valueOf(\"Method\");\n+  private static final QName FIELD_TAG = QName.valueOf(\"Field\");\n+\n+  /** Writes {@code linkageErrors} as exclusion rules into {@code outputFile}. */\n+  static void write(Path outputFile, Multimap<SymbolProblem, ClassFile> linkageErrors)\n+      throws IOException, XMLStreamException, TransformerException {\n+\n+    ByteArrayOutputStream buffer = new ByteArrayOutputStream();\n+    XMLEventWriter writer = null;\n+    try {\n+      writer = XMLOutputFactory.newInstance().createXMLEventWriter(buffer);\n+\n+      writer.add(eventFactory.createStartDocument());\n+      writer.add(eventFactory.createStartElement(LINKAGE_CHECKER_FILTER_TAG, null, null));\n+\n+      for (SymbolProblem symbolProblem : linkageErrors.keySet()) {\n+        for (ClassFile classFile : linkageErrors.get(symbolProblem)) {\n+          writeXmlEvents(writer, symbolProblem, classFile);\n+        }\n+      }\n+\n+      writer.add(eventFactory.createEndElement(LINKAGE_CHECKER_FILTER_TAG, null));\n+      writer.add(eventFactory.createEndDocument());\n+\n+    } finally {\n+      if (writer != null) {\n+        writer.close();\n+      }\n+    }\n+\n+    try (OutputStream outputStream = Files.newOutputStream(outputFile)) {\n+      insertIndent(new ByteArrayInputStream(buffer.toByteArray()), outputStream);\n+    }\n+  }\n+\n+  private static void insertIndent(InputStream inputStream, OutputStream outputStream)\n+      throws TransformerException {\n+    if (System.getProperty(\"javax.xml.transform.TransformerFactory\") == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1OTE5OQ=="}, "originalCommit": {"oid": "3515070051d52b3391482f28db80220c980928f0"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTk2MTIy", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#pullrequestreview-390196122", "createdAt": "2020-04-08T17:46:37Z", "commit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo0NjozN1rOGC6KeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo1Mjo0NVrOGC6YeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwMzI4OQ==", "bodyText": "By convention this file name would end in .rng; that is, \"linkage-checker-exclusion.rng\"\nhttps://en.wikipedia.org/wiki/RELAX_NG#Filename_extensions", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405703289", "createdAt": "2020-04-08T17:46:37Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFiles.java", "diffHunk": "@@ -0,0 +1,256 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import javax.xml.namespace.QName;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/**\n+ * Utility for Linkage Checker exclusion files.\n+ *\n+ * <p>The exclusion file for Linkage Checker is an XML file. Its top-level element is\n+ * LinkageCheckerFilter. The XML file contains the following structure:\n+ *\n+ * <ul>\n+ *   <li>A LinkageCheckerFilter element has zero or more LinkageError elements.\n+ *   <li>A LinkageError element has at least one of Target element and Source element.\n+ *   <li>A Target element has a Package, Class, Method, or Field element. A Source element has an\n+ *       Artifact, Package, or Class element.\n+ *   <li>Method and Field elements have \u201cclassName\u201d attribute.\n+ * </ul>\n+ *\n+ * <p>Each type of the element works as a corresponding matcher, such as LinkageErrorMatcher for a\n+ * LinkageError element and SourceMatcher for Source element. Given a linkage error, they work as\n+ * below:\n+ *\n+ * <ul>\n+ *   <li>A LinkageErrorMatcher matches when all of its child elements match the linkage error.\n+ *   <li>A SourceMatcher matches a linkage error when the source class of the error matches its\n+ *       child element.\n+ *   <li>A TargetMatcher matches a linkage error when the target symbol (class, method, or field) of\n+ *       the error matches its child element.\n+ *   <li>A PackageMatcher matches the classes that have Java package specified by its name field.\n+ *       Prefix to specify child packages.\n+ *   <li>A ClassMatcher matches the class specified by its name attribute. ArtifactMatcher,\n+ *       PackageMatcher, and ClassMatcher also match methods and fields on their matching classes.\n+ *   <li>A MethodMatcher matches method symbol specified by className and name attribute.\n+ *   <li>A FieldMatcher matches field symbol specified by className and name attribute.\n+ * </ul>\n+ */\n+class ExclusionFiles {\n+  private static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  private static final QName LINKAGE_CHECKER_FILTER_TAG = QName.valueOf(\"LinkageCheckerFilter\");\n+  private static final QName CLASS_TAG = QName.valueOf(\"Class\");\n+  private static final QName LINKAGE_ERROR_TAG = QName.valueOf(\"LinkageError\");\n+  private static final QName TARGET_TAG = QName.valueOf(\"Target\");\n+  private static final QName SOURCE_TAG = QName.valueOf(\"Source\");\n+  private static final QName METHOD_TAG = QName.valueOf(\"Method\");\n+  private static final QName FIELD_TAG = QName.valueOf(\"Field\");\n+\n+  static ImmutableList<LinkageErrorMatcher> parse(Path exclusionFile)\n+      throws SAXException, IOException, VerifierConfigurationException {\n+\n+    InputSource inputSource = new InputSource(Files.newInputStream(exclusionFile));\n+    inputSource.setSystemId(exclusionFile.toUri().toString());\n+\n+    return parse(inputSource);\n+  }\n+\n+  static ImmutableList<LinkageErrorMatcher> parse(URL exclusionFile)\n+      throws SAXException, IOException, VerifierConfigurationException {\n+\n+    InputSource inputSource = new InputSource(exclusionFile.openStream());\n+    inputSource.setSystemId(exclusionFile.toString());\n+\n+    return parse(inputSource);\n+  }\n+\n+  private static ImmutableList<LinkageErrorMatcher> parse(InputSource inputSource)\n+      throws SAXException, IOException, VerifierConfigurationException {\n+\n+    XMLReader reader = createXmlReader();\n+\n+    ExclusionFileHandler handler = new ExclusionFileHandler();\n+    reader.setContentHandler(handler);\n+\n+    reader.parse(inputSource);\n+\n+    return handler.getMatchers();\n+  }\n+\n+  private static XMLReader createXmlReader()\n+      throws SAXException, IOException, VerifierConfigurationException {\n+    // Validate and parse XML files in one pass using Jing validator as a filter.\n+    // http://iso-relax.sourceforge.net/JARV/JARV.html#use_42\n+    VerifierFactory factory = VerifierFactory.newInstance(\"http://relaxng.org/ns/structure/1.0\");\n+    InputStream linkageCheckerSchema =\n+        ExclusionFiles.class\n+            .getClassLoader()\n+            .getResourceAsStream(\"linkage-checker-exclusion-relax-ng.xml\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNTU3OQ==", "bodyText": "Can you cut the long argument down to one or two words? Three at most.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405705579", "createdAt": "2020-04-08T17:50:29Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerArguments.java", "diffHunk": "@@ -170,6 +170,14 @@ private static Options configureOptions() {\n             .build();\n     options.addOption(exclusionFile);\n \n+    Option writeAsExclusionFile =\n+        Option.builder(\"o\")\n+            .longOpt(\"output-linkage-errors-as-exclusion-file\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNjMzNA==", "bodyText": "This should be renamed similarly. Maybe we can have inputExclusionFile and outputExclusionFile? or just outputExclusions?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405706334", "createdAt": "2020-04-08T17:51:45Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerArguments.java", "diffHunk": "@@ -251,4 +259,15 @@ Path getExclusionFile() {\n     }\n     return null;\n   }\n+\n+  /**\n+   * Returns the path to write linkage errors as exclusion file. If the argument is not specified,\n+   * {@code null}.\n+   */\n+  Path getWriteAsExclusionFile() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNjg3Mw==", "bodyText": "This surprises me. I thought you could do both in one run.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405706873", "createdAt": "2020-04-08T17:52:45Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerMain.java", "diffHunk": "@@ -94,9 +98,14 @@ public static void main(String[] arguments) throws IOException, RepositoryExcept\n                   Multimaps.filterValues(\n                       symbolProblems, classFile -> graph.isReachable(classFile.getBinaryName())));\n         }\n-    \n-        System.out.println(SymbolProblem.formatSymbolProblems(symbolProblems));\n-    \n+\n+        Path writeAsExclusionFile = linkageCheckerArguments.getWriteAsExclusionFile();\n+        if (writeAsExclusionFile == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "347637015bd81a5d2d7f366b5327f4abccab0c75", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/347637015bd81a5d2d7f366b5327f4abccab0c75", "committedDate": "2020-04-08T18:04:18Z", "message": "rng"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b7033dc8239e1dec9cbae5b0a5e77304d0e5509", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4b7033dc8239e1dec9cbae5b0a5e77304d0e5509", "committedDate": "2020-04-08T18:10:37Z", "message": "output-exclusion-file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a639fcbc64facc33463d280b38b1efc251db22", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/f9a639fcbc64facc33463d280b38b1efc251db22", "committedDate": "2020-04-08T18:12:12Z", "message": "description"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1ca6c09264f10ee2d87d812e50b244f452a6f9f", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/d1ca6c09264f10ee2d87d812e50b244f452a6f9f", "committedDate": "2020-04-10T02:21:21Z", "message": "Merge branch 'master' into i1276"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMjA5MTA0", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#pullrequestreview-390209104", "createdAt": "2020-04-08T18:04:41Z", "commit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxODowNDo0MVrOGC60TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxODoxMToxNFrOGC7C6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMzk5Nw==", "bodyText": "Thanks. Updated.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405713997", "createdAt": "2020-04-08T18:04:41Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFiles.java", "diffHunk": "@@ -0,0 +1,256 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import javax.xml.namespace.QName;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/**\n+ * Utility for Linkage Checker exclusion files.\n+ *\n+ * <p>The exclusion file for Linkage Checker is an XML file. Its top-level element is\n+ * LinkageCheckerFilter. The XML file contains the following structure:\n+ *\n+ * <ul>\n+ *   <li>A LinkageCheckerFilter element has zero or more LinkageError elements.\n+ *   <li>A LinkageError element has at least one of Target element and Source element.\n+ *   <li>A Target element has a Package, Class, Method, or Field element. A Source element has an\n+ *       Artifact, Package, or Class element.\n+ *   <li>Method and Field elements have \u201cclassName\u201d attribute.\n+ * </ul>\n+ *\n+ * <p>Each type of the element works as a corresponding matcher, such as LinkageErrorMatcher for a\n+ * LinkageError element and SourceMatcher for Source element. Given a linkage error, they work as\n+ * below:\n+ *\n+ * <ul>\n+ *   <li>A LinkageErrorMatcher matches when all of its child elements match the linkage error.\n+ *   <li>A SourceMatcher matches a linkage error when the source class of the error matches its\n+ *       child element.\n+ *   <li>A TargetMatcher matches a linkage error when the target symbol (class, method, or field) of\n+ *       the error matches its child element.\n+ *   <li>A PackageMatcher matches the classes that have Java package specified by its name field.\n+ *       Prefix to specify child packages.\n+ *   <li>A ClassMatcher matches the class specified by its name attribute. ArtifactMatcher,\n+ *       PackageMatcher, and ClassMatcher also match methods and fields on their matching classes.\n+ *   <li>A MethodMatcher matches method symbol specified by className and name attribute.\n+ *   <li>A FieldMatcher matches field symbol specified by className and name attribute.\n+ * </ul>\n+ */\n+class ExclusionFiles {\n+  private static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  private static final QName LINKAGE_CHECKER_FILTER_TAG = QName.valueOf(\"LinkageCheckerFilter\");\n+  private static final QName CLASS_TAG = QName.valueOf(\"Class\");\n+  private static final QName LINKAGE_ERROR_TAG = QName.valueOf(\"LinkageError\");\n+  private static final QName TARGET_TAG = QName.valueOf(\"Target\");\n+  private static final QName SOURCE_TAG = QName.valueOf(\"Source\");\n+  private static final QName METHOD_TAG = QName.valueOf(\"Method\");\n+  private static final QName FIELD_TAG = QName.valueOf(\"Field\");\n+\n+  static ImmutableList<LinkageErrorMatcher> parse(Path exclusionFile)\n+      throws SAXException, IOException, VerifierConfigurationException {\n+\n+    InputSource inputSource = new InputSource(Files.newInputStream(exclusionFile));\n+    inputSource.setSystemId(exclusionFile.toUri().toString());\n+\n+    return parse(inputSource);\n+  }\n+\n+  static ImmutableList<LinkageErrorMatcher> parse(URL exclusionFile)\n+      throws SAXException, IOException, VerifierConfigurationException {\n+\n+    InputSource inputSource = new InputSource(exclusionFile.openStream());\n+    inputSource.setSystemId(exclusionFile.toString());\n+\n+    return parse(inputSource);\n+  }\n+\n+  private static ImmutableList<LinkageErrorMatcher> parse(InputSource inputSource)\n+      throws SAXException, IOException, VerifierConfigurationException {\n+\n+    XMLReader reader = createXmlReader();\n+\n+    ExclusionFileHandler handler = new ExclusionFileHandler();\n+    reader.setContentHandler(handler);\n+\n+    reader.parse(inputSource);\n+\n+    return handler.getMatchers();\n+  }\n+\n+  private static XMLReader createXmlReader()\n+      throws SAXException, IOException, VerifierConfigurationException {\n+    // Validate and parse XML files in one pass using Jing validator as a filter.\n+    // http://iso-relax.sourceforge.net/JARV/JARV.html#use_42\n+    VerifierFactory factory = VerifierFactory.newInstance(\"http://relaxng.org/ns/structure/1.0\");\n+    InputStream linkageCheckerSchema =\n+        ExclusionFiles.class\n+            .getClassLoader()\n+            .getResourceAsStream(\"linkage-checker-exclusion-relax-ng.xml\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwMzI4OQ=="}, "originalCommit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxNTU2NQ==", "bodyText": "Updated this to always output the linkage errors to stdout.\nI had thought the output is not wanted when the writeAsExclusionFile is specified.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405715565", "createdAt": "2020-04-08T18:07:40Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerMain.java", "diffHunk": "@@ -94,9 +98,14 @@ public static void main(String[] arguments) throws IOException, RepositoryExcept\n                   Multimaps.filterValues(\n                       symbolProblems, classFile -> graph.isReachable(classFile.getBinaryName())));\n         }\n-    \n-        System.out.println(SymbolProblem.formatSymbolProblems(symbolProblems));\n-    \n+\n+        Path writeAsExclusionFile = linkageCheckerArguments.getWriteAsExclusionFile();\n+        if (writeAsExclusionFile == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNjg3Mw=="}, "originalCommit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxNjMzNg==", "bodyText": "outputExclusionFile sounds nice. Thank you.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405716336", "createdAt": "2020-04-08T18:08:55Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerArguments.java", "diffHunk": "@@ -251,4 +259,15 @@ Path getExclusionFile() {\n     }\n     return null;\n   }\n+\n+  /**\n+   * Returns the path to write linkage errors as exclusion file. If the argument is not specified,\n+   * {@code null}.\n+   */\n+  Path getWriteAsExclusionFile() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNjMzNA=="}, "originalCommit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxNzczOA==", "bodyText": "Updated this to output-exclusion-file", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r405717738", "createdAt": "2020-04-08T18:11:14Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerArguments.java", "diffHunk": "@@ -170,6 +170,14 @@ private static Options configureOptions() {\n             .build();\n     options.addOption(exclusionFile);\n \n+    Option writeAsExclusionFile =\n+        Option.builder(\"o\")\n+            .longOpt(\"output-linkage-errors-as-exclusion-file\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNTU3OQ=="}, "originalCommit": {"oid": "3186264edc952b082771e71b41d93762f08e33de"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26046a3c426c29a87b9c4d32c1d7a0e496a2d6d4", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/26046a3c426c29a87b9c4d32c1d7a0e496a2d6d4", "committedDate": "2020-04-10T14:58:23Z", "message": "Merge remote-tracking branch 'origin/master' into i1276"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ac042a07b0e4b822682abc58bf33cee096b135f", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/9ac042a07b0e4b822682abc58bf33cee096b135f", "committedDate": "2020-04-10T15:02:00Z", "message": "Fixed test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e6e20295dacdd87b39db39941c812a48c28901a", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/9e6e20295dacdd87b39db39941c812a48c28901a", "committedDate": "2020-04-13T19:00:26Z", "message": "Merge remote-tracking branch 'origin/master' into i1276"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d246c88ddcf3f833efb59b05ba569cc9ce5e2523", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/d246c88ddcf3f833efb59b05ba569cc9ce5e2523", "committedDate": "2020-04-15T14:42:09Z", "message": "Merge branch 'master' into i1276"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzMyMTE2", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#pullrequestreview-394732116", "createdAt": "2020-04-16T15:09:52Z", "commit": {"oid": "d246c88ddcf3f833efb59b05ba569cc9ce5e2523"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTowOTo1MlrOGGqGDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTowOTo1MlrOGGqGDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTYzNDMxOQ==", "bodyText": "This is the sort of use of multimap that confuses me. Is the classFile the source or the target? It's unclear how it's encoded or what it means. This should be a Collection and the symbol problem should know the source and the target. What we're writing into the file is a list of linkage errors. Why aren't we passing a list of linkage errors into this method?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1333#discussion_r409634319", "createdAt": "2020-04-16T15:09:52Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ExclusionFiles.java", "diffHunk": "@@ -0,0 +1,254 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Multimap;\n+import com.thaiopensource.xml.sax.DraconianErrorHandler;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.URL;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import javax.xml.namespace.QName;\n+import javax.xml.stream.XMLEventFactory;\n+import javax.xml.stream.XMLEventWriter;\n+import javax.xml.stream.XMLOutputFactory;\n+import javax.xml.stream.XMLStreamException;\n+import javax.xml.stream.events.Attribute;\n+import javax.xml.stream.events.StartElement;\n+import javax.xml.transform.OutputKeys;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerException;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.iso_relax.verifier.Schema;\n+import org.iso_relax.verifier.Verifier;\n+import org.iso_relax.verifier.VerifierConfigurationException;\n+import org.iso_relax.verifier.VerifierFactory;\n+import org.iso_relax.verifier.VerifierFilter;\n+import org.xml.sax.InputSource;\n+import org.xml.sax.SAXException;\n+import org.xml.sax.XMLReader;\n+import org.xml.sax.helpers.XMLReaderFactory;\n+\n+/**\n+ * Utility for Linkage Checker exclusion files.\n+ *\n+ * <p>The exclusion file for Linkage Checker is an XML file. Its top-level element is\n+ * LinkageCheckerFilter. The XML file contains the following structure:\n+ *\n+ * <ul>\n+ *   <li>A LinkageCheckerFilter element has zero or more LinkageError elements.\n+ *   <li>A LinkageError element has at least one of Target element and Source element.\n+ *   <li>A Target element has a Package, Class, Method, or Field element. A Source element has an\n+ *       Artifact, Package, or Class element.\n+ *   <li>Method and Field elements have \u201cclassName\u201d attribute.\n+ * </ul>\n+ *\n+ * <p>Each type of the element works as a corresponding matcher, such as LinkageErrorMatcher for a\n+ * LinkageError element and SourceMatcher for Source element. Given a linkage error, they work as\n+ * below:\n+ *\n+ * <ul>\n+ *   <li>A LinkageErrorMatcher matches when all of its child elements match the linkage error.\n+ *   <li>A SourceMatcher matches a linkage error when the source class of the error matches its\n+ *       child element.\n+ *   <li>A TargetMatcher matches a linkage error when the target symbol (class, method, or field) of\n+ *       the error matches its child element.\n+ *   <li>A PackageMatcher matches the classes that have Java package specified by its name field.\n+ *       Prefix to specify child packages.\n+ *   <li>A ClassMatcher matches the class specified by its name attribute. ArtifactMatcher,\n+ *       PackageMatcher, and ClassMatcher also match methods and fields on their matching classes.\n+ *   <li>A MethodMatcher matches method symbol specified by className and name attribute.\n+ *   <li>A FieldMatcher matches field symbol specified by className and name attribute.\n+ * </ul>\n+ */\n+class ExclusionFiles {\n+  private static final XMLEventFactory eventFactory = XMLEventFactory.newInstance();\n+\n+  private static final QName LINKAGE_CHECKER_FILTER_TAG = QName.valueOf(\"LinkageCheckerFilter\");\n+  private static final QName CLASS_TAG = QName.valueOf(\"Class\");\n+  private static final QName LINKAGE_ERROR_TAG = QName.valueOf(\"LinkageError\");\n+  private static final QName TARGET_TAG = QName.valueOf(\"Target\");\n+  private static final QName SOURCE_TAG = QName.valueOf(\"Source\");\n+  private static final QName METHOD_TAG = QName.valueOf(\"Method\");\n+  private static final QName FIELD_TAG = QName.valueOf(\"Field\");\n+\n+  static ImmutableList<LinkageErrorMatcher> parse(Path exclusionFile)\n+      throws SAXException, IOException, VerifierConfigurationException {\n+\n+    InputSource inputSource = new InputSource(Files.newInputStream(exclusionFile));\n+    inputSource.setSystemId(exclusionFile.toUri().toString());\n+\n+    return parse(inputSource);\n+  }\n+\n+  static ImmutableList<LinkageErrorMatcher> parse(URL exclusionFile)\n+      throws SAXException, IOException, VerifierConfigurationException {\n+\n+    InputSource inputSource = new InputSource(exclusionFile.openStream());\n+    inputSource.setSystemId(exclusionFile.toString());\n+\n+    return parse(inputSource);\n+  }\n+\n+  private static ImmutableList<LinkageErrorMatcher> parse(InputSource inputSource)\n+      throws SAXException, IOException, VerifierConfigurationException {\n+\n+    XMLReader reader = createXmlReader();\n+\n+    ExclusionFileHandler handler = new ExclusionFileHandler();\n+    reader.setContentHandler(handler);\n+\n+    reader.parse(inputSource);\n+\n+    return handler.getMatchers();\n+  }\n+\n+  private static XMLReader createXmlReader()\n+      throws SAXException, IOException, VerifierConfigurationException {\n+    // Validate and parse XML files in one pass using Jing validator as a filter.\n+    // http://iso-relax.sourceforge.net/JARV/JARV.html#use_42\n+    VerifierFactory factory = VerifierFactory.newInstance(\"http://relaxng.org/ns/structure/1.0\");\n+    InputStream linkageCheckerSchema =\n+        ExclusionFiles.class.getClassLoader().getResourceAsStream(\"linkage-checker-exclusion.rng\");\n+    Schema schema = factory.compileSchema(linkageCheckerSchema);\n+    Verifier verifier = schema.newVerifier();\n+\n+    // DraconianErrorHandler throws SAXException upon invalid structure\n+    verifier.setErrorHandler(new DraconianErrorHandler());\n+    VerifierFilter filter = verifier.getVerifierFilter();\n+    filter.setParent(XMLReaderFactory.createXMLReader());\n+    return filter;\n+  }\n+\n+  /** Writes {@code linkageErrors} as exclusion rules into {@code outputFile}. */\n+  static void write(Path outputFile, Multimap<SymbolProblem, ClassFile> linkageErrors)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d246c88ddcf3f833efb59b05ba569cc9ce5e2523"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44a4f51fdd43a949f70b766c4d198f79c405a876", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/44a4f51fdd43a949f70b766c4d198f79c405a876", "committedDate": "2020-04-16T16:19:12Z", "message": "Merge branch 'master' into i1276"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 340, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}