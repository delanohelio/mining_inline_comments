{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxOTY4Mzg0", "number": 1676, "title": "Suppress InaccessibleClassProblem if the class reference is unused in the code attribute", "bodyText": "Fixes #1608.", "createdAt": "2020-09-23T18:36:39Z", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676", "merged": true, "mergeCommit": {"oid": "703b67cc25c291a32f94b9ae565ff99d99dba2c0"}, "closed": true, "closedAt": "2020-09-24T19:00:17Z", "author": {"login": "suztomo"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLwm2mgH2gAyNDkxOTY4Mzg0OjJmY2VkZjJiYmJmYmI5YWI1ZjQ4YTdlOTE2NTE3MmQ4ZWU5M2FlZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMFayvgH2gAyNDkxOTY4Mzg0OjY0ZjM0NTVhNzc4ZDRmZGMwOWE5YTFjZGI3OWE1ZTUyZDkxOWE3ZTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2fcedf2bbbfbb9ab5f48a7e9165172d8ee93aeef", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/2fcedf2bbbfbb9ab5f48a7e9165172d8ee93aeef", "committedDate": "2020-09-23T18:08:17Z", "message": "Test that fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4090ba28c4d42120873427d05b2accc1399b4fda", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4090ba28c4d42120873427d05b2accc1399b4fda", "committedDate": "2020-09-23T18:13:52Z", "message": "Test that fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b91fc5037d475e251dd559a605a2826f2b8a218", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/0b91fc5037d475e251dd559a605a2826f2b8a218", "committedDate": "2020-09-23T18:35:30Z", "message": "Fixes #1608"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "070ad5cca3521aa86cfc9c9ee25437a81b049f23", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/070ad5cca3521aa86cfc9c9ee25437a81b049f23", "committedDate": "2020-09-23T18:37:35Z", "message": "format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a592876514312e1b3cb6e970a67e11a0d73e9d7", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/4a592876514312e1b3cb6e970a67e11a0d73e9d7", "committedDate": "2020-09-23T18:38:41Z", "message": "Description in test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTY0MTQ1", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#pullrequestreview-494964145", "createdAt": "2020-09-23T19:02:56Z", "commit": {"oid": "4a592876514312e1b3cb6e970a67e11a0d73e9d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTY0MzU0", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#pullrequestreview-494964354", "createdAt": "2020-09-23T19:03:13Z", "commit": {"oid": "4a592876514312e1b3cb6e970a67e11a0d73e9d7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71523f86d8cc73a8f5bfc16610b53475f5da4b16", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/71523f86d8cc73a8f5bfc16610b53475f5da4b16", "committedDate": "2020-09-24T01:32:04Z", "message": "Updating tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac8666162ed8e4a74988bcd12dbc24893160a260", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/ac8666162ed8e4a74988bcd12dbc24893160a260", "committedDate": "2020-09-24T02:37:15Z", "message": "Description in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bd196d68536c1f6824236508bd458664d3a8615", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/5bd196d68536c1f6824236508bd458664d3a8615", "committedDate": "2020-09-24T03:11:52Z", "message": "Merge branch 'master' into unused_in_bytecode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTc1MDQ0", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#pullrequestreview-495175044", "createdAt": "2020-09-24T02:20:05Z", "commit": {"oid": "71523f86d8cc73a8f5bfc16610b53475f5da4b16"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMjoyMDowNVrOHXHXzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzoyMToxMlrOHXaWsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMDA3Ng==", "bodyText": "They cover the ones listed in http://go/jdd-class-reference-validation", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#discussion_r494000076", "createdAt": "2020-09-24T02:20:05Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassDumper.java", "diffHunk": "@@ -656,7 +656,8 @@ boolean isUnusedClassSymbolReference(String sourceClassName, ClassSymbol classSy\n             Instruction instruction = instructionHandle.getInstruction();\n             if (instruction instanceof CPInstruction) {\n               // Checking JVM instructions that take a symbolic reference to a class in\n-              // JVM Instruction Set\n+              // JVM Instruction Set: anewarray, checkcast, instanceof, ldc, ldc2_w, multianewarray,\n+              // and new.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71523f86d8cc73a8f5bfc16610b53475f5da4b16"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxMzQ5Nw==", "bodyText": "It was using a dummy pair. The dummySource jar does not contain LinkageCheckerTest class.\nWith this PR, the test cases require real class files that have constant pool section containing the target class.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#discussion_r494013497", "createdAt": "2020-09-24T03:15:25Z", "author": {"login": "suztomo"}, "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerTest.java", "diffHunk": "@@ -548,53 +551,56 @@ public void testFindClassReferences_innerClass() throws IOException {\n     Truth.assertThat(problems).isEmpty();\n   }\n \n-\n   @Test\n-  public void testFindClassReferences_privateClass() throws IOException, URISyntaxException {\n-    // The superclass of AbstractApiService$InnerService (Guava's ApiService) is not in the paths\n-    ClassPathEntry dummySource = firestoreJar;\n-    List<ClassPathEntry> paths =\n-        ImmutableList.of(classPathEntryOfResource(\"testdata/api-common-1.7.0.jar\"));\n-    LinkageChecker linkageChecker = LinkageChecker.create(paths);\n+  public void testFindClassReferences_inaccessibleClass() throws IOException, URISyntaxException {\n+    // io.grpc.grpclb.GrpclbLoadBalancer in grpc-grpclb 0.12.0 had a reference to\n+    // io.grpc.internal.SingleTransportChannel. The SingleTransportChannel became non-public in\n+    // grpc-core 0.15.0.\n+    ClassPathBuilder classPathBuilder = new ClassPathBuilder();\n+    ClassPathResult classPathResult =\n+        classPathBuilder.resolve(\n+            ImmutableList.of(\n+                new DefaultArtifact(\"io.grpc:grpc-core:0.15.0\"),\n+                new DefaultArtifact(\"io.grpc:grpc-grpclb:0.12.0\")),\n+            false);\n \n-    SymbolReferences.Builder builder = new SymbolReferences.Builder();\n-    builder.addClassReference(\n-        new ClassFile(dummySource, LinkageCheckerTest.class.getName()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bd196d68536c1f6824236508bd458664d3a8615"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMxMTA5MQ==", "bodyText": "@netdpb FYI, BCEL has an abstract class \"CPInstruction\" that represents an instruction that takes a constant pool index, and we already had this function to determine whether a constant pool index is unused by JVM instructions. (Therefore this function does not list \"safe\" operations)", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#discussion_r494311091", "createdAt": "2020-09-24T13:21:12Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassDumper.java", "diffHunk": "@@ -656,7 +656,8 @@ boolean isUnusedClassSymbolReference(String sourceClassName, ClassSymbol classSy\n             Instruction instruction = instructionHandle.getInstruction();\n             if (instruction instanceof CPInstruction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bd196d68536c1f6824236508bd458664d3a8615"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjQ2ODc4", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#pullrequestreview-495646878", "createdAt": "2020-09-24T14:41:01Z", "commit": {"oid": "5bd196d68536c1f6824236508bd458664d3a8615"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1e070c7b2de0bb521e6f040251a4875a039950f", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/e1e070c7b2de0bb521e6f040251a4875a039950f", "committedDate": "2020-09-24T15:08:08Z", "message": "ldc_w"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9f333d38c337c180af2cc4530b332c1a9c7a3e4", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/d9f333d38c337c180af2cc4530b332c1a9c7a3e4", "committedDate": "2020-09-24T15:08:37Z", "message": "Merge branch 'unused_in_bytecode' of https://github.com/GoogleCloudPlatform/cloud-opensource-java into unused_in_bytecode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1Njc3NzQ3", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#pullrequestreview-495677747", "createdAt": "2020-09-24T15:11:08Z", "commit": {"oid": "5bd196d68536c1f6824236508bd458664d3a8615"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNToxMTowOFrOHXfslw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNToxNDozMFrOHXf2Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM5ODYxNQ==", "bodyText": "What about:\nif (!isClassAccessibleFrom(targetClass, sourceClassName)\n    && !classDumper.isUnusedClassSymbolReference(sourceClassName, symbol)) {\n  return Optional.of(new InaccessibleClassProblem(sourceClassFile, targetClassFile, symbol));\n}\nreturn Optional.empty();", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#discussion_r494398615", "createdAt": "2020-09-24T15:11:08Z", "author": {"login": "netdpb"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/LinkageChecker.java", "diffHunk": "@@ -512,7 +512,13 @@ private boolean isMemberAccessibleFrom(\n       }\n \n       if (!isClassAccessibleFrom(targetClass, sourceClassName)) {\n-        return Optional.of(new InaccessibleClassProblem(sourceClassFile, targetClassFile, symbol));\n+        if (classDumper.isUnusedClassSymbolReference(sourceClassName, symbol)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bd196d68536c1f6824236508bd458664d3a8615"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwMTA0Ng==", "bodyText": "You only use this once. Inline?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#discussion_r494401046", "createdAt": "2020-09-24T15:14:30Z", "author": {"login": "netdpb"}, "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/LinkageCheckerTest.java", "diffHunk": "@@ -548,53 +551,56 @@ public void testFindClassReferences_innerClass() throws IOException {\n     Truth.assertThat(problems).isEmpty();\n   }\n \n-\n   @Test\n-  public void testFindClassReferences_privateClass() throws IOException, URISyntaxException {\n-    // The superclass of AbstractApiService$InnerService (Guava's ApiService) is not in the paths\n-    ClassPathEntry dummySource = firestoreJar;\n-    List<ClassPathEntry> paths =\n-        ImmutableList.of(classPathEntryOfResource(\"testdata/api-common-1.7.0.jar\"));\n-    LinkageChecker linkageChecker = LinkageChecker.create(paths);\n+  public void testFindClassReferences_inaccessibleClass() throws IOException, URISyntaxException {\n+    // io.grpc.grpclb.GrpclbLoadBalancer in grpc-grpclb 0.12.0 had a reference to\n+    // io.grpc.internal.SingleTransportChannel. The SingleTransportChannel became non-public in\n+    // grpc-core 0.15.0.\n+    ClassPathBuilder classPathBuilder = new ClassPathBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bd196d68536c1f6824236508bd458664d3a8615"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0ad716833e7c416504fbc033269ae7556732ea9", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/f0ad716833e7c416504fbc033269ae7556732ea9", "committedDate": "2020-09-24T15:28:17Z", "message": "Applied review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c54fef08d8e675f5da905e909d488564b60c8df7", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/c54fef08d8e675f5da905e909d488564b60c8df7", "committedDate": "2020-09-24T15:28:38Z", "message": "format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28acb807152f7ed589f098cee6cb951f268171d8", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/28acb807152f7ed589f098cee6cb951f268171d8", "committedDate": "2020-09-24T15:58:14Z", "message": "isClassSymbolReferenceUsed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzM0Nzc3", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#pullrequestreview-495734777", "createdAt": "2020-09-24T16:11:55Z", "commit": {"oid": "28acb807152f7ed589f098cee6cb951f268171d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjoxMTo1NVrOHXiXxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjoxMTo1NVrOHXiXxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ0MjQzNw==", "bodyText": "Oh. Do we need both? I think positive method names are usually better than negative ones. Where else is isUnusedClassSymbolReference used, and can it be switched?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#discussion_r494442437", "createdAt": "2020-09-24T16:11:55Z", "author": {"login": "netdpb"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassDumper.java", "diffHunk": "@@ -561,6 +561,10 @@ private static String outerClassName(JavaClass sourceJavaClass) {\n     return null;\n   }\n \n+  boolean isClassSymbolReferenceUsed(String sourceClassName, ClassSymbol classSymbol) {\n+    return !isUnusedClassSymbolReference(sourceClassName, classSymbol);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28acb807152f7ed589f098cee6cb951f268171d8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "139780c9a2596021153665ea4ac0bcc5d707a826", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/139780c9a2596021153665ea4ac0bcc5d707a826", "committedDate": "2020-09-24T17:27:35Z", "message": "Positive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "905cdcfdbeead4d720b1d772e0e16d2607e7ae0c", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/905cdcfdbeead4d720b1d772e0e16d2607e7ae0c", "committedDate": "2020-09-24T17:28:56Z", "message": "Updated test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8a9d1a943430cd18cfa6b21cb68415ae3e4b660", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/b8a9d1a943430cd18cfa6b21cb68415ae3e4b660", "committedDate": "2020-09-24T18:03:23Z", "message": "Merge remote-tracking branch 'origin/master' into unused_in_bytecode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1ODM4Njcw", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#pullrequestreview-495838670", "createdAt": "2020-09-24T18:19:04Z", "commit": {"oid": "905cdcfdbeead4d720b1d772e0e16d2607e7ae0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxODoxOTowNFrOHXnB-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxODoxOTowNFrOHXnB-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUxODc3OQ==", "bodyText": "checks the following", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1676#discussion_r494518779", "createdAt": "2020-09-24T18:19:04Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassDumper.java", "diffHunk": "@@ -561,12 +561,8 @@ private static String outerClassName(JavaClass sourceJavaClass) {\n     return null;\n   }\n \n-  boolean isClassSymbolReferenceUsed(String sourceClassName, ClassSymbol classSymbol) {\n-    return !isUnusedClassSymbolReference(sourceClassName, classSymbol);\n-  }\n-\n   /**\n-   * Returns true if the class symbol reference is unused in the source class file. It checks\n+   * Returns true if the class symbol reference is used in the source class file. It checks", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "905cdcfdbeead4d720b1d772e0e16d2607e7ae0c"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f3455a778d4fdc09a9a1cdb79a5e52d919a7e8", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/64f3455a778d4fdc09a9a1cdb79a5e52d919a7e8", "committedDate": "2020-09-24T18:23:07Z", "message": "Applied review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 149, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}