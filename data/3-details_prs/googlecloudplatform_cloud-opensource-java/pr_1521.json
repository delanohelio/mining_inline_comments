{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MzE0Mzcw", "number": 1521, "title": "Enable building classpath without optional dependencies", "bodyText": "@suztomo I'm working on measuring exactly how much, if at all, this helps. But I think this might reduce our memory usage somewhat by reusing strings and avoiding some intermediate list and stream objects.\nI hope this helps with #1256", "createdAt": "2020-07-08T15:20:10Z", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521", "merged": true, "mergeCommit": {"oid": "47572dbfc4b114837338283119b213ff2b3322b7"}, "closed": true, "closedAt": "2020-07-11T11:35:14Z", "author": {"login": "elharo"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy8BZ4AH2gAyNDQ2MzE0MzcwOmU3M2NhYzBkMjNhNjgyODY1ZDNhZDg4YTU3MGU2Nzg2MDk5YWY3ZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcznOqcAH2gAyNDQ2MzE0MzcwOjQ4NzIxMTU0MTU0ZDllMzRlNmNiNDU5MWE1NWY3NGMyODZiYjE4NzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e73cac0d23a682865d3ad88a570e6786099af7e1", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/e73cac0d23a682865d3ad88a570e6786099af7e1", "committedDate": "2020-07-08T15:18:08Z", "message": "some optimizations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28fb6bc6ca4fd51efb6e699a7ba9bc6ea9e55237", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/28fb6bc6ca4fd51efb6e699a7ba9bc6ea9e55237", "committedDate": "2020-07-08T15:22:43Z", "message": "reproduce OutOfMemoryError"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbecbdfcfaf6d811816f4e409954615e67608c39", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/fbecbdfcfaf6d811816f4e409954615e67608c39", "committedDate": "2020-07-08T17:13:23Z", "message": "use smaller artifact"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b58e184dac1671280745f5929074211ab28c2b5d", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/b58e184dac1671280745f5929074211ab28c2b5d", "committedDate": "2020-07-08T17:15:02Z", "message": "catalog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e41c924faac59a6f4d18dc6f581524d62f7798b", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/2e41c924faac59a6f4d18dc6f581524d62f7798b", "committedDate": "2020-07-08T17:15:23Z", "message": "copyright"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aa3643c9ecbed849496885ee5f993c9c7a9c4c7", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/2aa3643c9ecbed849496885ee5f993c9c7a9c4c7", "committedDate": "2020-07-08T17:17:12Z", "message": "Merge branch 'memorytest' into opt2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0OTkwNzYy", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#pullrequestreview-444990762", "createdAt": "2020-07-08T17:39:58Z", "commit": {"oid": "e73cac0d23a682865d3ad88a570e6786099af7e1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzozOTo1OVrOGuynaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzozOTo1OVrOGuynaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcxNjk2OQ==", "bodyText": "Good to know intern().", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r451716969", "createdAt": "2020-07-08T17:39:59Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/dependencies/Artifacts.java", "diffHunk": "@@ -31,11 +31,12 @@ private Artifacts() {\n    * packaging are not included.\n    */\n   public static String toCoordinates(Artifact artifact) {\n-    return artifact.getGroupId() + \":\" + artifact.getArtifactId() + \":\" + artifact.getVersion();\n+    return (artifact.getGroupId() + \":\" + artifact.getArtifactId() + \":\" + artifact.getVersion())\n+        .intern();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73cac0d23a682865d3ad88a570e6786099af7e1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc7238f1146e456c863c2a36e59f54dd03312317", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/dc7238f1146e456c863c2a36e59f54dd03312317", "committedDate": "2020-07-09T13:59:43Z", "message": "try not interning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a96608da0c669e4abac413d2db270b2d7509940", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/3a96608da0c669e4abac413d2db270b2d7509940", "committedDate": "2020-07-09T15:08:11Z", "message": "enable building classpaths without optional dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdcd3cd00b131acc50e18296e7441a027f9dca41", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/cdcd3cd00b131acc50e18296e7441a027f9dca41", "committedDate": "2020-07-09T15:10:41Z", "message": "revert unhelpful optimization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzEzODYy", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#pullrequestreview-445713862", "createdAt": "2020-07-09T15:11:52Z", "commit": {"oid": "cdcd3cd00b131acc50e18296e7441a027f9dca41"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODExMzc1", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#pullrequestreview-445811375", "createdAt": "2020-07-09T17:09:38Z", "commit": {"oid": "cdcd3cd00b131acc50e18296e7441a027f9dca41"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNzowOTozOFrOGvaSGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNzoxNDowN1rOGvacVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2Njg3Mw==", "bodyText": "remove this comment", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452366873", "createdAt": "2020-07-09T17:09:38Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassPathBuilder.java", "diffHunk": "@@ -54,15 +54,22 @@ public ClassPathBuilder(DependencyGraphBuilder dependencyGraphBuilder) {\n    * closest\" strategy follows Maven's dependency mediation.\n    *\n    * @param artifacts the first artifacts that appear in the classpath, in order\n+   * @param full if true all optional dependencies and their transitive dependencies are\n+   *     included. If false, optional dependencies are not included.\n    */\n-  public ClassPathResult resolve(List<Artifact> artifacts) {\n-\n+  public ClassPathResult resolve(List<Artifact> artifacts, boolean full) {\n     LinkedListMultimap<ClassPathEntry, DependencyPath> multimap = LinkedListMultimap.create();\n     if (artifacts.isEmpty()) {\n       return new ClassPathResult(multimap, ImmutableList.of());\n     }\n     // dependencyGraph holds multiple versions for one artifact key (groupId:artifactId)\n-    DependencyGraph result = dependencyGraphBuilder.buildFullDependencyGraph(artifacts);\n+    //DependencyGraph result = dependencyGraphBuilder.buildFullDependencyGraph(artifacts);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdcd3cd00b131acc50e18296e7441a027f9dca41"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2OTA3OA==", "bodyText": "Do you still need this test?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452369078", "createdAt": "2020-07-09T17:13:22Z", "author": {"login": "suztomo"}, "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/MemoryUsageTest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.fail;\n+\n+import com.google.common.collect.ImmutableList;\n+import org.eclipse.aether.artifact.Artifact;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class MemoryUsageTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdcd3cd00b131acc50e18296e7441a027f9dca41"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM2OTQ5Mw==", "bodyText": "The check complains about this function.\n[ERROR] /Volumes/BuildData/tmpfs/src/github/cloud-opensource-java/dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/MemoryUsageTest.java:[57,14] error: [JUnit4TestNotRun] This looks like a test method but is not run; please add @Test and @Ignore, or, if this is a helper method, reduce its visibility.\n    (see https://errorprone.info/bugpattern/JUnit4TestNotRun)\n  Did you mean '@Test public void testBeamZetaSqlOutOfMemoryError() {' or '@Test @Ignore public void testBeamZetaSqlOutOfMemoryError() {' or 'private void testBeamZetaSqlOutOfMemoryError() {'?", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#discussion_r452369493", "createdAt": "2020-07-09T17:14:07Z", "author": {"login": "suztomo"}, "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/MemoryUsageTest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Google LLC.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.tools.opensource.classpath;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.fail;\n+\n+import com.google.common.collect.ImmutableList;\n+import org.eclipse.aether.artifact.Artifact;\n+import org.eclipse.aether.artifact.DefaultArtifact;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class MemoryUsageTest {\n+  private ClassPathBuilder classPathBuilder = new ClassPathBuilder();\n+  \n+  @Before\n+  public void setUp() {\n+    System.gc();\n+  }\n+  \n+  @Test\n+  public void testBeamCatalogOutOfMemoryError() {\n+    long before = Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();\n+    String coords = \"org.apache.beam:beam-sdks-java-io-hcatalog:2.19.0\";\n+    \n+    Artifact catalog = new DefaultArtifact(coords);\n+    try {\n+      ClassPathResult result = classPathBuilder.resolve(ImmutableList.of(catalog), false);\n+      long after = Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();\n+      double mb = (after - before) / (1024.0 * 1024.0);\n+      System.err.println(\"Memory used: \" + mb + \"MB\");      \n+      \n+      assertNotNull(result);\n+    } catch (OutOfMemoryError failure) {\n+      failure.printStackTrace();\n+      fail(\"Ran out of memory\");\n+    } finally {\n+      System.gc();      \n+    }\n+  }\n+  \n+  public void testBeamZetaSqlOutOfMemoryError() {    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdcd3cd00b131acc50e18296e7441a027f9dca41"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb24d2bb2a9f6a395aab88669238ad91d356676b", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/bb24d2bb2a9f6a395aab88669238ad91d356676b", "committedDate": "2020-07-09T17:25:40Z", "message": "add @Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf27e44c065b3a3a4f18fc0e79ede83c4d271bbc", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/bf27e44c065b3a3a4f18fc0e79ede83c4d271bbc", "committedDate": "2020-07-09T17:48:41Z", "message": "remove commented code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69d43998f638005939aa45561d37d2aa9091caf5", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/69d43998f638005939aa45561d37d2aa9091caf5", "committedDate": "2020-07-09T20:49:55Z", "message": "one test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1OTU5MzI0", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1521#pullrequestreview-445959324", "createdAt": "2020-07-09T20:50:49Z", "commit": {"oid": "cdcd3cd00b131acc50e18296e7441a027f9dca41"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48721154154d9e34e6cb4591a55f74c286bb1871", "author": {"user": {"login": "elharo", "name": "Elliotte Rusty Harold"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/48721154154d9e34e6cb4591a55f74c286bb1871", "committedDate": "2020-07-10T17:38:32Z", "message": "unstick cla"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 243, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}