{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMTE4MjEy", "number": 1090, "title": "Skip corrupt class file in JAR rather than stopping", "bodyText": "Fixes #1048 .\nInitially I thought outputting warning message per file but it turned out there are many of them (220) in the artifact. Now the implementation outputs one warning per JAR file:\nJan 07, 2020 1:33:51 PM com.google.cloud.tools.opensource.classpath.ClassDumper listClasses\nWARNING: Corrupt jar file /usr/local/google/home/suztomo/.m2/repository/com/amazonaws/amazon-kinesis-client/1.13.0/amazon-kinesis-client-1.13.0.jar; could not load .unison.com.e007f77498fd27177e2ea931a06dcf50.unison.tmp.amazonaws.services.kinesis.leases.impl.LeaseTaker and other 219 files", "createdAt": "2020-01-07T18:35:41Z", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090", "merged": true, "mergeCommit": {"oid": "d5c1f9d161d3d6b5edcf71433833de65f5e9317a"}, "closed": true, "closedAt": "2020-01-08T21:37:46Z", "author": {"login": "suztomo"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4FA6ygH2gAyMzYwMTE4MjEyOmUzZWRkYjAxZjVmMjVmYzM2YWI0ZGE1NjAyYTQ4OGNjMzlhNWUzNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4cKXSgFqTM0MDE1MzY2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e3eddb01f5f25fc36ab4da5602a488cc39a5e354", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/e3eddb01f5f25fc36ab4da5602a488cc39a5e354", "committedDate": "2020-01-07T18:25:13Z", "message": "Fixes #1048"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1f22e37b168faa520d5e847781d3ffa7205b885", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/a1f22e37b168faa520d5e847781d3ffa7205b885", "committedDate": "2020-01-07T18:34:25Z", "message": "One error per JAR file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDM2ODk4", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#pullrequestreview-339436898", "createdAt": "2020-01-07T18:56:06Z", "commit": {"oid": "a1f22e37b168faa520d5e847781d3ffa7205b885"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODo1NjowNlrOFbCmGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODo1NjowNlrOFbCmGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg5ODM5Mw==", "bodyText": "so we'll still die on these sorts of corrupt jar files? Is that what we want? Perhaps whoever calls this method should handle the IOExceptions that arise here.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#discussion_r363898393", "createdAt": "2020-01-07T18:56:06Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassDumper.java", "diffHunk": "@@ -395,7 +400,16 @@ Path findClassLocation(String className) {\n         javaClasses.add(javaClass);\n       } catch (ClassNotFoundException ex) {\n         // We couldn't find the class in the jar file where we found it.\n-        throw new IOException(\"Corrupt jar file \" + jar + \"; could not load \" + classFileName, ex);\n+        Throwable cause = ex.getCause();\n+        if (cause != null && cause instanceof IOException) {\n+          // Skip unexpected files (such as a lock file) included in JAR file\n+          // https://github.com/GoogleCloudPlatform/cloud-opensource-java/issues/1048 was caused\n+          // by an IOException\n+          corruptedClassFileNames.add(classFileName);\n+        } else {\n+          throw new IOException(\n+              \"Corrupt jar file \" + jar + \"; could not load \" + classFileName, ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1f22e37b168faa520d5e847781d3ffa7205b885"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ada8f63154133e8bee16eefbf551ef7808ed6b5", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/7ada8f63154133e8bee16eefbf551ef7808ed6b5", "committedDate": "2020-01-07T20:05:07Z", "message": "findSymbolReferences catches IOException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDc0MzIy", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#pullrequestreview-339474322", "createdAt": "2020-01-07T20:02:24Z", "commit": {"oid": "a1f22e37b168faa520d5e847781d3ffa7205b885"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDowMjoyNFrOFbES1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDowMjoyNFrOFbES1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkyNjIzMQ==", "bodyText": "That's a nice idea. Now findSymbolReferences catches the exception.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#discussion_r363926231", "createdAt": "2020-01-07T20:02:24Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassDumper.java", "diffHunk": "@@ -395,7 +400,16 @@ Path findClassLocation(String className) {\n         javaClasses.add(javaClass);\n       } catch (ClassNotFoundException ex) {\n         // We couldn't find the class in the jar file where we found it.\n-        throw new IOException(\"Corrupt jar file \" + jar + \"; could not load \" + classFileName, ex);\n+        Throwable cause = ex.getCause();\n+        if (cause != null && cause instanceof IOException) {\n+          // Skip unexpected files (such as a lock file) included in JAR file\n+          // https://github.com/GoogleCloudPlatform/cloud-opensource-java/issues/1048 was caused\n+          // by an IOException\n+          corruptedClassFileNames.add(classFileName);\n+        } else {\n+          throw new IOException(\n+              \"Corrupt jar file \" + jar + \"; could not load \" + classFileName, ex);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg5ODM5Mw=="}, "originalCommit": {"oid": "a1f22e37b168faa520d5e847781d3ffa7205b885"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDc3NDg0", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#pullrequestreview-339477484", "createdAt": "2020-01-07T20:08:00Z", "commit": {"oid": "7ada8f63154133e8bee16eefbf551ef7808ed6b5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDowODowMFrOFbEcQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDowODowMFrOFbEcQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkyODY0MA==", "bodyText": "This was exceeding 100 char limit.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#discussion_r363928640", "createdAt": "2020-01-07T20:08:00Z", "author": {"login": "suztomo"}, "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/ClassDumperTest.java", "diffHunk": "@@ -313,7 +314,8 @@ public void testIsUnusedClassSymbolReference_classSymbolReferenceNotFound()\n             ImmutableList.of(absolutePathOfResource(\"testdata/conscrypt-openjdk-uber-1.4.2.jar\")));\n \n     try {\n-      classDumper.isUnusedClassSymbolReference(\"org.conscrypt.Conscrypt\", new ClassSymbol(\"dummy.NoSuchClass\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ada8f63154133e8bee16eefbf551ef7808ed6b5"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffa1e105c8177b20d2dab34d6040a145b8283f78", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/ffa1e105c8177b20d2dab34d6040a145b8283f78", "committedDate": "2020-01-07T20:19:57Z", "message": "listClasses should load valid classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c1b1365835c23ba5c8c22318d20a131089b1e31", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/0c1b1365835c23ba5c8c22318d20a131089b1e31", "committedDate": "2020-01-07T20:21:30Z", "message": "format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDg0ODY2", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#pullrequestreview-339484866", "createdAt": "2020-01-07T20:22:49Z", "commit": {"oid": "ffa1e105c8177b20d2dab34d6040a145b8283f78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDoyMjo0OVrOFbEx6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDoyMjo0OVrOFbEx6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkzNDE4NQ==", "bodyText": "This asserts that ClassDumper loads valid class files from the JAR file even if some of the content are invalid files.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#discussion_r363934185", "createdAt": "2020-01-07T20:22:49Z", "author": {"login": "suztomo"}, "path": "dependencies/src/test/java/com/google/cloud/tools/opensource/classpath/ClassDumperTest.java", "diffHunk": "@@ -364,4 +366,26 @@ public void testFindSymbolReferences_overLappingClass() throws IOException, Repo\n             new ClassFile(\n                 sisuGuicePath, \"com.google.inject.internal.InjectorImpl$BindingsMultimap\"));\n   }\n+\n+  @Test\n+  public void testListClasses_unexpectedNonClassFile() throws RepositoryException, IOException {\n+    // com.amazonaws:amazon-kinesis-client:1.13.0 contains an unexpected lock file\n+    // /unison/com/e007f77498fd27177e2ea931a06dcf50/unison/tmp/amazonaws/services/kinesis/leases/impl/LeaseTaker.class\n+    // https://github.com/awslabs/amazon-kinesis-client/issues/654\n+    Artifact kinesisClient = new DefaultArtifact(\"com.amazonaws:amazon-kinesis-client:1.13.0\");\n+    List<Path> paths = ClassPathBuilder.artifactsToClasspath(ImmutableList.of(kinesisClient));\n+    ClassDumper classDumper = ClassDumper.create(paths);\n+    Path kinesisJar = paths.get(0);\n+\n+    // This should not raise IOException\n+    SymbolReferenceMaps symbolReferences = classDumper.findSymbolReferences();\n+    assertNotNull(symbolReferences);\n+\n+    Truth.assertWithMessage(\"Invalid files should not stop loading valid class files\")\n+        .that(symbolReferences.getClassToClassSymbols().keySet())\n+        .comparingElementsUsing(\n+            Correspondence.transforming(\n+                (ClassFile classFile) -> classFile.getJar(), \"is in the JAR file\"))\n+        .contains(kinesisJar);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffa1e105c8177b20d2dab34d6040a145b8283f78"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDg0NTY3", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#pullrequestreview-339484567", "createdAt": "2020-01-07T20:22:12Z", "commit": {"oid": "ffa1e105c8177b20d2dab34d6040a145b8283f78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDoyMjoxMlrOFbExDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDoyMjoxMlrOFbExDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkzMzk2Nw==", "bodyText": "could we bubble the ClassFormatException instead? This isn't really an IO error.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#discussion_r363933967", "createdAt": "2020-01-07T20:22:12Z", "author": {"login": "elharo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassDumper.java", "diffHunk": "@@ -395,7 +400,7 @@ Path findClassLocation(String className) {\n         javaClasses.add(javaClass);\n       } catch (ClassNotFoundException ex) {\n         // We couldn't find the class in the jar file where we found it.\n-        throw new IOException(\"Corrupt jar file \" + jar + \"; could not load \" + classFileName, ex);\n+        corruptedClassFileNames.add(classFileName);\n       } catch (ClassFormatException ex) {\n         // We couldn't load the class from the jar file where we found it.\n         throw new IOException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffa1e105c8177b20d2dab34d6040a145b8283f78"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaca555f2a543e1afaeec9f6abcfb4dcc238a06e", "author": {"user": {"login": "suztomo", "name": "Tomo Suzuki"}}, "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/commit/eaca555f2a543e1afaeec9f6abcfb4dcc238a06e", "committedDate": "2020-01-07T20:27:15Z", "message": "Bubble ClassFormatException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDg3MDA5", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#pullrequestreview-339487009", "createdAt": "2020-01-07T20:27:04Z", "commit": {"oid": "a1f22e37b168faa520d5e847781d3ffa7205b885"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDoyNzowNFrOFbE4Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QyMDoyNzowNFrOFbE4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkzNTc5NQ==", "bodyText": "Yes, removed the catch clause.", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#discussion_r363935795", "createdAt": "2020-01-07T20:27:04Z", "author": {"login": "suztomo"}, "path": "dependencies/src/main/java/com/google/cloud/tools/opensource/classpath/ClassDumper.java", "diffHunk": "@@ -395,7 +400,7 @@ Path findClassLocation(String className) {\n         javaClasses.add(javaClass);\n       } catch (ClassNotFoundException ex) {\n         // We couldn't find the class in the jar file where we found it.\n-        throw new IOException(\"Corrupt jar file \" + jar + \"; could not load \" + classFileName, ex);\n+        corruptedClassFileNames.add(classFileName);\n       } catch (ClassFormatException ex) {\n         // We couldn't load the class from the jar file where we found it.\n         throw new IOException(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkzMzk2Nw=="}, "originalCommit": {"oid": "ffa1e105c8177b20d2dab34d6040a145b8283f78"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMTUzNjYw", "url": "https://github.com/GoogleCloudPlatform/cloud-opensource-java/pull/1090#pullrequestreview-340153660", "createdAt": "2020-01-08T21:23:21Z", "commit": {"oid": "eaca555f2a543e1afaeec9f6abcfb4dcc238a06e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1251, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}