{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2OTE1NDM3", "number": 165, "title": "applying limit when creating the partition filter", "bodyText": "fixed #164", "createdAt": "2020-01-24T16:26:19Z", "url": "https://github.com/ExpediaGroup/circus-train/pull/165", "merged": true, "mergeCommit": {"oid": "db8f3bb4009cabbf02d4c3fe1ee5f9854f5a314f"}, "closed": true, "closedAt": "2020-01-28T12:05:09Z", "author": {"login": "patduin"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9hfIlgH2gAyMzY2OTE1NDM3OjFmNTcwYmYxOTRlYzllYjEzZDIwMDRhNmJhMGY4Y2MwNTQwMjk4M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-wG9sgH2gAyMzY2OTE1NDM3OjE3NDNlZDM4YzYzZjMzOGE5YmQyY2IxZDYzMzQwNTU3Y2VlNzYwN2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1f570bf194ec9eb13d2004a6ba0f8cc05402983d", "author": {"user": null}, "url": "https://github.com/ExpediaGroup/circus-train/commit/1f570bf194ec9eb13d2004a6ba0f8cc05402983d", "committedDate": "2020-01-24T16:25:11Z", "message": "applying limit when creating the partition filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9b3e22b490606e9f4c7209c9792f9e15086807b", "author": {"user": null}, "url": "https://github.com/ExpediaGroup/circus-train/commit/d9b3e22b490606e9f4c7209c9792f9e15086807b", "committedDate": "2020-01-24T16:51:58Z", "message": "reversing order so we pick new partitions first by default (given partitions are date strings)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NzI4NjA3", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#pullrequestreview-348728607", "createdAt": "2020-01-27T15:02:09Z", "commit": {"oid": "d9b3e22b490606e9f4c7209c9792f9e15086807b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNTowMjowOVrOFiFyBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNTowNzo0M1rOFiF_CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI5MDYzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Fixed issue were limit is ignore when generating a partition filter. See [#164](https://github.com/HotelsDotCom/circus-train/issues/164).\n          \n          \n            \n            \n          \n          \n            \n            Fixed issue where limit is ignore when generating a partition filter. See [#164](https://github.com/HotelsDotCom/circus-train/issues/164).", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371290630", "createdAt": "2020-01-27T15:02:09Z", "author": {"login": "max-jacobs"}, "path": "CHANGELOG.md", "diffHunk": "@@ -1,6 +1,8 @@\n ## [15.1.0] - TBD\n ### Changed\n * AVRO Schema Copier now re-uses the normal 'data' copier instead of its own. See [#162](https://github.com/HotelsDotCom/circus-train/issues/162). \n+### Fixed\n+Fixed issue were limit is ignore when generating a partition filter. See [#164](https://github.com/HotelsDotCom/circus-train/issues/164).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9b3e22b490606e9f4c7209c9792f9e15086807b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI5Mzk2MQ==", "bodyText": "How comes this isn't initialised to UNLIMITED here? This is only to figure out the limit on line 183 in HiveDifferences right?", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371293961", "createdAt": "2020-01-27T15:07:43Z", "author": {"login": "max-jacobs"}, "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/DiffGeneratedPartitionPredicate.java", "diffHunk": "@@ -45,6 +46,7 @@\n   private final Function<Path, String> checksumFunction;\n   private String partitionPredicate;\n   private boolean generated = false;\n+  private Short partitionLimit = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9b3e22b490606e9f4c7209c9792f9e15086807b"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a5e3bfaefe28ddcd500fa8a3451f6489005b2e7", "author": {"user": null}, "url": "https://github.com/ExpediaGroup/circus-train/commit/3a5e3bfaefe28ddcd500fa8a3451f6489005b2e7", "committedDate": "2020-01-27T15:33:56Z", "message": "reworded"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4Nzc3MDcx", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#pullrequestreview-348777071", "createdAt": "2020-01-27T16:01:02Z", "commit": {"oid": "3a5e3bfaefe28ddcd500fa8a3451f6489005b2e7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjowMTowMlrOFiIB-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjowNDo1MVrOFiILSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyNzQ4MA==", "bodyText": "Typo: \"were\" -> \"where\"", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371327480", "createdAt": "2020-01-27T16:01:02Z", "author": {"login": "nvitucci"}, "path": "CHANGELOG.md", "diffHunk": "@@ -1,6 +1,8 @@\n ## [15.1.0] - TBD\n ### Changed\n * AVRO Schema Copier now re-uses the normal 'data' copier instead of its own. See [#162](https://github.com/HotelsDotCom/circus-train/issues/162). \n+### Fixed\n+Fixed issue were partition-limit is not correctly applied when generating a partition filter. See [#164](https://github.com/HotelsDotCom/circus-train/issues/164).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a5e3bfaefe28ddcd500fa8a3451f6489005b2e7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMyOTg2NA==", "bodyText": "What if the partitionLimit is 0?", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371329864", "createdAt": "2020-01-27T16:04:51Z", "author": {"login": "nvitucci"}, "path": "circus-train-comparator/src/main/java/com/hotels/bdp/circustrain/comparator/hive/HiveDifferences.java", "diffHunk": "@@ -162,14 +171,16 @@ private HiveDifferences(\n       Iterator<Partition> sourcePartitionIterator,\n       Optional<Table> replicaTable,\n       Optional<? extends PartitionFetcher> replicaPartitionFetcher,\n-      Function<Path, String> checksumFunction) {\n+      Function<Path, String> checksumFunction,\n+      int partitionLimit) {\n     this.diffListener = diffListener;\n     this.comparatorRegistry = comparatorRegistry;\n     this.sourceTable = sourceTable;\n     this.sourcePartitionIterator = sourcePartitionIterator;\n     this.replicaTable = replicaTable;\n     this.replicaPartitionFetcher = replicaPartitionFetcher;\n     this.checksumFunction = checksumFunction;\n+    this.partitionLimit = partitionLimit < 0 ? UNLIMITED : partitionLimit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a5e3bfaefe28ddcd500fa8a3451f6489005b2e7"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692", "author": {"user": null}, "url": "https://github.com/ExpediaGroup/circus-train/commit/47b5f4d446a56aef39c4c76f0fd51b12dbca1692", "committedDate": "2020-01-27T19:22:11Z", "message": "typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MjY2NDM3", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#pullrequestreview-349266437", "createdAt": "2020-01-28T10:25:15Z", "commit": {"oid": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDoyNToxNVrOFif6Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDoyNToxNVrOFif6Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcxODY3NQ==", "bodyText": "Think you also need a line between Changed and Fixed?", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371718675", "createdAt": "2020-01-28T10:25:15Z", "author": {"login": "max-jacobs"}, "path": "CHANGELOG.md", "diffHunk": "@@ -1,6 +1,8 @@\n ## [15.1.0] - TBD\n ### Changed\n * AVRO Schema Copier now re-uses the normal 'data' copier instead of its own. See [#162](https://github.com/HotelsDotCom/circus-train/issues/162). \n+### Fixed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MjY5MTU3", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#pullrequestreview-349269157", "createdAt": "2020-01-28T10:29:19Z", "commit": {"oid": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fdb171d404a385d109c145a303afc4ce0248978", "author": {"user": null}, "url": "https://github.com/ExpediaGroup/circus-train/commit/7fdb171d404a385d109c145a303afc4ce0248978", "committedDate": "2020-01-28T10:45:45Z", "message": "newline"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MjgwNTk4", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#pullrequestreview-349280598", "createdAt": "2020-01-28T10:47:32Z", "commit": {"oid": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDo0NzozMlrOFiglVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDo0ODoyNlrOFigm8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcyOTc0OQ==", "bodyText": "Isn't this also a change in behaviour that we should mention in the CHANGELOG? HiveDiff will now process the partitions with newest first while in the past it was oldest first?", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371729749", "createdAt": "2020-01-28T10:47:32Z", "author": {"login": "massdosage"}, "path": "circus-train-core/src/main/java/com/hotels/bdp/circustrain/core/DiffGeneratedPartitionPredicate.java", "diffHunk": "@@ -55,19 +57,23 @@ public DiffGeneratedPartitionPredicate(\n     this.replica = replica;\n     this.tableReplication = tableReplication;\n     this.checksumFunction = checksumFunction;\n+    if (tableReplication.getSourceTable().getPartitionLimit() != null) {\n+      partitionLimit = tableReplication.getSourceTable().getPartitionLimit();\n+    }\n   }\n \n   private String generate() {\n     try (CloseableMetaStoreClient sourceMetastore = source.getMetaStoreClientSupplier().get()) {\n       try (CloseableMetaStoreClient replicaMetastore = replica.getMetaStoreClientSupplier().get()) {\n         Table sourceTable = source.getTableAndStatistics(tableReplication).getTable();\n         PartitionIterator partitionIterator = new PartitionIterator(sourceMetastore, sourceTable,\n-            tableReplication.getPartitionIteratorBatchSize());\n+            tableReplication.getPartitionIteratorBatchSize(), Ordering.REVERSE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczMDE2MA==", "bodyText": "I can't make up my mind whether this would be considered a breaking change. Technically I think it is, but I guess most of our end users wouldn't notice?", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371730160", "createdAt": "2020-01-28T10:48:26Z", "author": {"login": "massdosage"}, "path": "circus-train-core/src/test/java/com/hotels/bdp/circustrain/core/DiffGeneratedPartitionPredicateTest.java", "diffHunk": "@@ -106,17 +105,23 @@ public void setUp() throws Exception {\n   public void autogeneratePredicate() throws Exception {\n     when(replica.getTableAndStatistics(tableReplication)).thenReturn(replicaTableAndStats);\n     when(replicaTableAndStats.getTable()).thenReturn(table2);\n+    when(sourceTable.getPartitionLimit()).thenReturn((short) 10);\n+\n+    predicate = new DiffGeneratedPartitionPredicate(source, replica, tableReplication, checksumFunction);\n \n     assertThat(predicate.getPartitionPredicate(),\n-        is(\"(p1='value1' AND p2='value2') OR (p1='value11' AND p2='value22')\"));\n+        is(\"(p1='value11' AND p2='value22') OR (p1='value1' AND p2='value2')\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47b5f4d446a56aef39c4c76f0fd51b12dbca1692"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26f05f1302ad10928d6a7dd2fdb0d0846f255839", "author": {"user": null}, "url": "https://github.com/ExpediaGroup/circus-train/commit/26f05f1302ad10928d6a7dd2fdb0d0846f255839", "committedDate": "2020-01-28T11:09:39Z", "message": "removed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eb28377c0c4dfd4271255337ad58fa15e43c131", "author": {"user": null}, "url": "https://github.com/ExpediaGroup/circus-train/commit/4eb28377c0c4dfd4271255337ad58fa15e43c131", "committedDate": "2020-01-28T11:18:59Z", "message": "Added note about the HiveDiff order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzIwNzgw", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#pullrequestreview-349320780", "createdAt": "2020-01-28T12:00:16Z", "commit": {"oid": "4eb28377c0c4dfd4271255337ad58fa15e43c131"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMjowMDoxN1rOFiie9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMjowMDoxN1rOFiie9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc2MDg4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * Changed the order of the generated partition filter (HiveDiff) it is now reverse natural order (which means new partitions first when partitions are date/time strings). When in doubt use the circus-train-tool `check-filters.sh` to so what would be generated.\n          \n          \n            \n            * Changed the order of the generated partition filter used by \"HiveDiff\"  - it is now reverse natural order (which means new partitions first when partitions are date/time strings). When in doubt use the circus-train-tool `check-filters.sh` to see what would be generated.", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#discussion_r371760884", "createdAt": "2020-01-28T12:00:17Z", "author": {"login": "massdosage"}, "path": "CHANGELOG.md", "diffHunk": "@@ -1,6 +1,7 @@\n ## [15.1.0] - TBD\n ### Changed\n * AVRO Schema Copier now re-uses the normal 'data' copier instead of its own. See [#162](https://github.com/HotelsDotCom/circus-train/issues/162). \n+* Changed the order of the generated partition filter (HiveDiff) it is now reverse natural order (which means new partitions first when partitions are date/time strings). When in doubt use the circus-train-tool `check-filters.sh` to so what would be generated.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4eb28377c0c4dfd4271255337ad58fa15e43c131"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzIxMTM1", "url": "https://github.com/ExpediaGroup/circus-train/pull/165#pullrequestreview-349321135", "createdAt": "2020-01-28T12:00:52Z", "commit": {"oid": "4eb28377c0c4dfd4271255337ad58fa15e43c131"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1743ed38c63f338a9bd2cb1d63340557cee7607d", "author": {"user": {"login": "patduin", "name": "Patrick Duin"}}, "url": "https://github.com/ExpediaGroup/circus-train/commit/1743ed38c63f338a9bd2cb1d63340557cee7607d", "committedDate": "2020-01-28T12:01:17Z", "message": "Update CHANGELOG.md\n\nCo-Authored-By: Adrian Woodhead <awoodhead@expediagroup.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3777, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}