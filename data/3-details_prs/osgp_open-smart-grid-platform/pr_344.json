{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMjM4MTQ3", "number": 344, "title": "FLEX-5395 Add configuration of IP addresses that may be duplicated", "bodyText": "Upon device registration, the IP address of the registered device is\nremoved in the database for other devices where it is configured (with\nthe exception of the loopback address - localhost / 127.0.0.1).\nThese changes allow to either configure that such clean up should never\nbe performed (allowing multiple devices to share any network address),\nor to configure a comma separated list of IP addresses or IP address\nranges that may be shared (for instance\n\"192.168.0.1,192.168.1.12-192.168.2.103\" to allow sharing of 192.168.0.1\nor any IP address from 192.168.1.12 to 192.168.2.103 inclusive).", "createdAt": "2020-06-08T15:53:41Z", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/344", "merged": true, "mergeCommit": {"oid": "290d934914a2c5fbc77cf4380be048b207a2be6a"}, "closed": true, "closedAt": "2020-06-09T14:19:25Z", "author": {"login": "bvdzwet"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpShyBAH2gAyNDMxMjM4MTQ3OjU2YjdjNzJmMDk4MzJlZWFhYmQ2NDFlZDg3ZDU4ZjhkM2E1NjRkY2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcplebZAFqTQyNzE3NzEwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "56b7c72f09832eeaabd641ed87d58f8d3a564dcc", "author": {"user": {"login": "bvdzwet", "name": "Bart van der Zwet"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/56b7c72f09832eeaabd641ed87d58f8d3a564dcc", "committedDate": "2020-06-08T15:52:10Z", "message": "FLEX-5395 ~ Adds configuration of IP addresses that may be duplicated\n\nUpon device registration, the IP address of the registered device is\nremoved in the database for other devices where it is configured (with\nthe exception of the loopback address - localhost / 127.0.0.1).\n\nThese changes allow to either configure that such clean up should never\nbe performed (allowing multiple devices to share any network address),\nor to configure a comma separated list of IP addresses or IP address\nranges that may be shared (for instance\n\"192.168.0.1,192.168.1.12-192.168.2.103\" to allow sharing of 192.168.0.1\nor any IP address from 192.168.1.12 to 192.168.2.103 inclusive)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODI2OTAy", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/344#pullrequestreview-426826902", "createdAt": "2020-06-09T06:35:55Z", "commit": {"oid": "56b7c72f09832eeaabd641ed87d58f8d3a564dcc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNjozNTo1NVrOGg6qZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNjo1MjozMFrOGg7FKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE2ODc0Mg==", "bodyText": "A bit strange to put this in setUp, while it is overridden in a lot of tests", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/344#discussion_r437168742", "createdAt": "2020-06-09T06:35:55Z", "author": {"login": "robindenadel"}, "path": "osgp/platform/osgp-core/src/test/java/org/opensmartgridplatform/core/application/services/DeviceNetworkAddressCleanupServiceTest.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.core.application.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.net.InetAddress;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.opensmartgridplatform.domain.core.entities.Device;\n+import org.opensmartgridplatform.domain.core.repositories.DeviceRepository;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class DeviceNetworkAddressCleanupServiceTest {\n+\n+    private DeviceRepository deviceRepository;\n+    private DeviceNetworkAddressCleanupService deviceNetworkAddressCleanupService;\n+\n+    @BeforeEach\n+    public void setUp() {\n+        this.deviceRepository = Mockito.mock(DeviceRepository.class);\n+        final boolean allowMultipleDevicesPerNetworkAddress = false;\n+        final List<String> ipRangesAllowingMultipleDevicesPerAddress = Collections.emptyList();\n+        this.deviceNetworkAddressCleanupService = new DeviceNetworkAddressCleanupService(this.deviceRepository,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56b7c72f09832eeaabd641ed87d58f8d3a564dcc"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3NTU5Mw==", "bodyText": "You could consider making constants of these variables, since they are used in almost every test", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/344#discussion_r437175593", "createdAt": "2020-06-09T06:52:30Z", "author": {"login": "robindenadel"}, "path": "osgp/platform/osgp-core/src/test/java/org/opensmartgridplatform/core/application/services/DeviceNetworkAddressCleanupServiceTest.java", "diffHunk": "@@ -0,0 +1,168 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.core.application.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.net.InetAddress;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mockito;\n+import org.mockito.MockitoAnnotations;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.opensmartgridplatform.domain.core.entities.Device;\n+import org.opensmartgridplatform.domain.core.repositories.DeviceRepository;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class DeviceNetworkAddressCleanupServiceTest {\n+\n+    private DeviceRepository deviceRepository;\n+    private DeviceNetworkAddressCleanupService deviceNetworkAddressCleanupService;\n+\n+    @BeforeEach\n+    public void setUp() {\n+        this.deviceRepository = Mockito.mock(DeviceRepository.class);\n+        final boolean allowMultipleDevicesPerNetworkAddress = false;\n+        final List<String> ipRangesAllowingMultipleDevicesPerAddress = Collections.emptyList();\n+        this.deviceNetworkAddressCleanupService = new DeviceNetworkAddressCleanupService(this.deviceRepository,\n+                allowMultipleDevicesPerNetworkAddress, ipRangesAllowingMultipleDevicesPerAddress);\n+        MockitoAnnotations.initMocks(this);\n+    }\n+\n+    @Test\n+    public void duplicateAddressesAreAllowedForLoopbackAddresses() throws Exception {\n+        assertThat(this.deviceNetworkAddressCleanupService.allowDuplicateEntries(InetAddress.getLoopbackAddress()))\n+                .isTrue();\n+    }\n+\n+    @Test\n+    public void noDevicesAreUpdatedWhenTheNetworkAddressIsNotUsed() throws Exception {\n+        final String host = \"192.168.0.13\";\n+        final InetAddress inetAddress = InetAddress.getByName(host);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56b7c72f09832eeaabd641ed87d58f8d3a564dcc"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf45d446f5a24d1182cd56bec840315bc77308c7", "author": {"user": {"login": "bvdzwet", "name": "Bart van der Zwet"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/bf45d446f5a24d1182cd56bec840315bc77308c7", "committedDate": "2020-06-09T13:36:00Z", "message": "FLEX-5395 ~ Only allows 127.0.0.1 as duplicate network address\n\nBy default only allow 127.0.0.1 to be used as network address with\nmultiple registered devices simultaneously. Allowing all loopback\naddresses (127.*.*.*) to have duplicates caused some Cucumber test\ndepending on network address cleanup for other loopback addresses to\nfail.\nIt is still possible by changing configuration to allow IP addresses to\nbe shared between devices for all addresses or for specific ranges.\n\nAddresses some review comments about the setup in the test code, where\nsetup with before-each was overridden in most test cases, and some\nspecific values were used in most of the tests.\n\nSimplified code for InetAddress in DeviceRegistrationMessageService.\nInetAddress.getByName(\"127.0.0.1\") works just fine, while\nInetAddress.getLoopbackAddress() could return other values than\n127.0.0.1 according to its documentation (even though the current\nimplementation does return 127.0.0.1)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTc3MTAw", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/344#pullrequestreview-427177100", "createdAt": "2020-06-09T13:56:42Z", "commit": {"oid": "bf45d446f5a24d1182cd56bec840315bc77308c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3754, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}