{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMzA4OTcx", "number": 475, "title": "FLEX-5534 ~ Improves archiving performance", "bodyText": "", "createdAt": "2020-10-26T21:08:07Z", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475", "merged": true, "mergeCommit": {"oid": "960edf5624e0e097ea28fc19afb1b2eab32e25d7"}, "closed": true, "closedAt": "2020-10-30T17:48:44Z", "author": {"login": "rlemmers"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWa8k6AH2gAyNTEwMzA4OTcxOmViMDY5NWVlNmY1MWM3MGFkZWRhYTk1OGJkYzRmNWYxNjU1Mzk0MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXqfPpAFqTUyMDkwMjMyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb0695ee6f51c70adedaa958bdc4f5f165539419", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/eb0695ee6f51c70adedaa958bdc4f5f165539419", "committedDate": "2020-10-26T21:07:16Z", "message": "FLEX-5534 ~ Optimize Event table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18d2576413f733d410e1ba7128ea307fddd149c5", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/18d2576413f733d410e1ba7128ea307fddd149c5", "committedDate": "2020-10-27T14:56:36Z", "message": "Merge branch 'development' of github.com:OSGP/open-smart-grid-platform into feature/FLEX-5534-improve-archiving-performance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "985af7a5f8399a7d83d7f5cbb7474befafc55b6c", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/985af7a5f8399a7d83d7f5cbb7474befafc55b6c", "committedDate": "2020-10-27T16:12:08Z", "message": "FLEX-5534 ~ Fixes search functionality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/cd31855dc7663caedbaf173994f01d30814be80e", "committedDate": "2020-10-28T20:52:41Z", "message": "FLEX-5334 ~ Completes changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNTcxNTY2", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#pullrequestreview-520571566", "createdAt": "2020-10-30T11:14:32Z", "commit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMToxNDozMlrOHrKkeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMzoyMjozOFrOHrOvQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAyMzk5Mg==", "bodyText": "Also remove the Autowired DeviceRepository field, as it seems it is no longer used...", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515023992", "createdAt": "2020-10-30T11:14:32Z", "author": {"login": "smvdheijden"}, "path": "integration-tests/cucumber-tests-platform/src/test/java/org/opensmartgridplatform/cucumber/platform/glue/steps/database/core/EventSteps.java", "diffHunk": "@@ -48,10 +47,10 @@\n \n     @Given(\"^an event$\")\n     public void anEvent(final Map<String, String> data) {\n-        final Device device = this.deviceRepository\n-                .findByDeviceIdentification(getString(data, PlatformKeys.KEY_DEVICE_IDENTIFICATION));\n+        final String deviceIdentification = getString(data, PlatformKeys.KEY_DEVICE_IDENTIFICATION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA2NjMyOA==", "bodyText": "Consider making this an autowired configurable property.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515066328", "createdAt": "2020-10-30T12:34:58Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/TransactionalDeviceLogItemService.java", "diffHunk": "@@ -30,14 +31,16 @@\n @Transactional(transactionManager = \"domainLoggingTransactionManager\")\n public class TransactionalDeviceLogItemService {\n \n+    private static final int PAGE_SIZE = 500;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA2NjM4OQ==", "bodyText": "Consider making this an autowired configurable property.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515066389", "createdAt": "2020-10-30T12:35:04Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/TransactionalEventService.java", "diffHunk": "@@ -30,13 +31,15 @@\n @Transactional(transactionManager = \"transactionManager\")\n public class TransactionalEventService {\n \n+    private static final int PAGE_SIZE = 500;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA3NjA1MQ==", "bodyText": "Move the line above the comment, to keep the comment closer to the if statement.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515076051", "createdAt": "2020-10-30T12:54:33Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationMessageService.java", "diffHunk": "@@ -218,47 +219,45 @@ private void createRelayStatus(final Device device, final Event switchingEvent,\n         }\n     }\n \n-    private void handleSwitchingEvent(final Device device, final Date dateTime, final EventType eventType,\n+    private void handleSwitchingEvent(final String deviceIdentification, final Date dateTime, final EventType eventType,\n             final int index) throws UnknownEntityException {\n \n         // If the index == 0 handle all LIGHT relays, otherwise just handle the\n         // index.\n+        final Ssld ssld = this.eventNotificationHelperService.findSsld(deviceIdentification);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA3Njg0Ng==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515076846", "createdAt": "2020-10-30T12:55:58Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationMessageService.java", "diffHunk": "@@ -329,8 +328,8 @@ private void printRelayIndexes(final Set<Integer> indexesLightRelays, final Set<\n     private void printRelayStatuses(final Map<Integer, RelayStatus> lastRelayStatusPerIndex,\n             final String deviceIdentification) {\n         LOGGER.info(\"print relay statuses for device: {}\", deviceIdentification);\n-        for (final Integer key : lastRelayStatusPerIndex.keySet()) {\n-            LOGGER.info(\"key: {}, value: {}\", key, lastRelayStatusPerIndex.get(key));\n+        for (final Entry<Integer, RelayStatus> entry : lastRelayStatusPerIndex.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA3OTk3MQ==", "bodyText": "Shouldn't a NOT NULL constraint be added once the column is filled with data?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515079971", "createdAt": "2020-10-30T13:01:45Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-core/src/main/resources/db/migration/V20201027172100000__Replaces_Event_deviceId_by_deviceIdentification.sql", "diffHunk": "@@ -0,0 +1,21 @@\n+DO\n+$$\n+BEGIN\n+\n+  IF NOT EXISTS(SELECT 1 FROM information_schema.columns\n+                WHERE table_schema = current_schema AND table_name = 'event' AND column_name = 'device_identification')\n+  THEN\n+    ALTER TABLE event ADD COLUMN device_identification CHARACTER VARYING(40),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4MDI4OQ==", "bodyText": "Isn't @Column(nullable = false) needed here?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515080289", "createdAt": "2020-10-30T13:02:21Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-domain-core/src/main/java/org/opensmartgridplatform/domain/core/entities/Event.java", "diffHunk": "@@ -27,9 +25,7 @@\n      */\n     private static final long serialVersionUID = 5987663923796632312L;\n \n-    @ManyToOne()\n-    @JoinColumn(name = \"device\")\n-    private Device device;\n+    private String deviceIdentification;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4MjMyMg==", "bodyText": "Is this check really needed?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515082322", "createdAt": "2020-10-30T13:06:16Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationMessageService.java", "diffHunk": "@@ -58,18 +59,17 @@\n     public void handleEvent(final String deviceIdentification, final Date dateTime, final EventType eventType,\n             final String description, final Integer index) throws UnknownEntityException {\n \n-        // Lookup device\n-        final Device device = this.eventNotificationHelperService.findDevice(deviceIdentification);\n-        // If the event belongs to an existing device, then save it,\n-        // otherwise don't.\n-        this.eventNotificationHelperService.saveEvent(new Event(device,\n+        // Check if the event belongs to an existing device\n+        this.eventNotificationHelperService.findDevice(deviceIdentification);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4Mzk3NA==", "bodyText": "Not in scope for this story, but it would be nice if the findByDeviceIdentification call is modified to return an Optional<Ssld>...", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515083974", "createdAt": "2020-10-30T13:09:16Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationHelperService.java", "diffHunk": "@@ -63,6 +63,14 @@ public Ssld findSsld(final Long id) throws UnknownEntityException {\n         return ssld.get();\n     }\n \n+    public Ssld findSsld(final String deviceIdentification) throws UnknownEntityException {\n+        final Ssld ssld = this.ssldRepository.findByDeviceIdentification(deviceIdentification);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4NTI1NA==", "bodyText": "Not in scope for this story, but this could easily be refactored to a isSwitchingEvent method, making the comment unnecessary...", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515085254", "createdAt": "2020-10-30T13:11:32Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-core/src/main/java/org/opensmartgridplatform/core/application/services/EventNotificationMessageService.java", "diffHunk": "@@ -58,18 +59,17 @@\n     public void handleEvent(final String deviceIdentification, final Date dateTime, final EventType eventType,\n             final String description, final Integer index) throws UnknownEntityException {\n \n-        // Lookup device\n-        final Device device = this.eventNotificationHelperService.findDevice(deviceIdentification);\n-        // If the event belongs to an existing device, then save it,\n-        // otherwise don't.\n-        this.eventNotificationHelperService.saveEvent(new Event(device,\n+        // Check if the event belongs to an existing device\n+        this.eventNotificationHelperService.findDevice(deviceIdentification);\n+\n+        this.eventNotificationHelperService.saveEvent(new Event(deviceIdentification,\n                 dateTime != null ? dateTime : DateTime.now().toDate(), eventType, description, index));\n \n         // Check if it was a switching event.\n         if (eventType.equals(EventType.LIGHT_EVENTS_LIGHT_ON) || eventType.equals(EventType.LIGHT_EVENTS_LIGHT_OFF)\n                 || eventType.equals(EventType.TARIFF_EVENTS_TARIFF_ON)\n                 || eventType.equals(EventType.TARIFF_EVENTS_TARIFF_OFF)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA4NTU5Mg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515085592", "createdAt": "2020-10-30T13:12:12Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-adapter-ws-publiclighting/src/main/java/org/opensmartgridplatform/adapter/ws/publiclighting/infra/jms/messageprocessor/DomainResponseMessageProcessor.java", "diffHunk": "@@ -76,7 +76,7 @@ public void init() {\n \n     @Override\n     public void processMessage(final ObjectMessage message) {\n-        LOGGER.debug(\"Processing smart metering response message\");\n+        LOGGER.debug(\"Processing public lighting response message\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA5MjI4OA==", "bodyText": "\ud83e\udd14\n\ud83d\udc4d", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#discussion_r515092288", "createdAt": "2020-10-30T13:22:38Z", "author": {"login": "smvdheijden"}, "path": "osgp/platform/osgp-adapter-domain-publiclighting/src/main/java/org/opensmartgridplatform/adapter/domain/publiclighting/application/services/AdHocManagementService.java", "diffHunk": "@@ -390,18 +390,15 @@ private LightMeasurementDevice updateLmdLastCommunicationTime(final LightMeasure\n     }\n \n     private boolean isDuplicateEvent(final Event event, final LightMeasurementDevice lmd) {\n-        final List<Event> events = this.eventRepository.findTop2ByDeviceOrderByDateTimeDesc(lmd);\n-        for (final Event e : events) {\n-            if (event.getDateTime().equals(e.getDateTime())) {\n-                // Exact match found, skip this event of the result set.\n-                continue;\n-            } else if (event.getEventType().equals(e.getEventType())) {\n-                // If second event has same type, duplicate event has been\n-                // detected.\n-                return true;\n-            }\n-        }\n-        return false;\n+        final List<Event> events = this.eventRepository\n+                .findTop2ByDeviceIdentificationOrderByDateTimeDesc(lmd.getDeviceIdentification());\n+\n+        // Returns true if one of the events differs in date/time and has the\n+        // same event type\n+        return events.stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd31855dc7663caedbaf173994f01d30814be80e"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f92b161fb9506275eb5af61e58b4445406bf9e6", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/1f92b161fb9506275eb5af61e58b4445406bf9e6", "committedDate": "2020-10-30T14:20:02Z", "message": "FLEX-5334 ~ Processes review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTAyMzIx", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/475#pullrequestreview-520902321", "createdAt": "2020-10-30T17:47:38Z", "commit": {"oid": "1f92b161fb9506275eb5af61e58b4445406bf9e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3701, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}