{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NzQ2MTA3", "number": 526, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODoyOTowNFrOE_gRFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODozOTo0MlrOE_gg_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDI0NDA0OnYy", "diffSide": "RIGHT", "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/java/org/opensmartgridplatform/webdevicesimulator/service/OslpChannelHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODoyOTowNFrOH9PfIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMDowMTozMVrOH9TOJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk3ODkxNQ==", "bodyText": "I see what you are doing here, but on the other hand, this would  be an oppurtunity to get rid of the hard coded 7 second delay for the FIRMWARE_EVENTS_ACTIVATING event. I agree with you, that it's out of scope for this story, but maybe getting the 7 from a property file is not much work. I leave it up to you what to do with it. For me it's fine to leave it as is right now.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/526#discussion_r533978915", "createdAt": "2020-12-02T08:29:04Z", "author": {"login": "joostknapen"}, "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/java/org/opensmartgridplatform/webdevicesimulator/service/OslpChannelHandler.java", "diffHunk": "@@ -871,13 +919,25 @@ private void handleUpdateFirmwareRequest(final Device device, final UpdateFirmwa\n         LOGGER.debug(\"handle UpdateFirmwareRequest for device: {}, with serialized size of {}\",\n                 device.getDeviceIdentification(), request.getSerializedSize());\n \n-        this.sendDelayedDeviceRegistration(device);\n-\n-        // Send a firmware activation event after the device registration has\n-        // (likely) been finished\n-        final Oslp.Event event = Oslp.Event.FIRMWARE_EVENTS_ACTIVATING;\n-        final String description = \"A new firmware is activated\";\n-        this.sendEventWithCustomDelay(device, event, description, 7000);\n+        this.simulateReboot(device).thenAccept(deviceMessageStatus -> {\n+            if (DeviceMessageStatus.NOT_FOUND == deviceMessageStatus) {\n+                LOGGER.error(\"Device {} not found handling update firmware request\", device.getDeviceIdentification());\n+                return;\n+            }\n+            final Oslp.Event event;\n+            final String description;\n+            if (DeviceMessageStatus.OK == deviceMessageStatus) {\n+                event = Oslp.Event.FIRMWARE_EVENTS_ACTIVATING;\n+                description = \"A new firmware is activated\";\n+            } else {\n+                LOGGER.warn(\"Device {} has issues registering after reboot handling update firmware request\",\n+                        device.getDeviceIdentification());\n+                event = Oslp.Event.FIRMWARE_EVENTS_DOWNLOAD_FAILED;\n+                description = \"Failure rebooting and registrating device during firmware activation\";\n+            }\n+            this.sendEventWithCustomDelay(device, event, description,\n+                    Math.max(1, 7 - this.deviceManagementService.getRebootDelay()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c5fffda6d0a3486207ab3564d16ed6e827ebbb3"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0MDEwMQ==", "bodyText": "In case the 7 sec should be configurable, it should be another user story.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/526#discussion_r534040101", "createdAt": "2020-12-02T10:01:31Z", "author": {"login": "joostknapen"}, "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/java/org/opensmartgridplatform/webdevicesimulator/service/OslpChannelHandler.java", "diffHunk": "@@ -871,13 +919,25 @@ private void handleUpdateFirmwareRequest(final Device device, final UpdateFirmwa\n         LOGGER.debug(\"handle UpdateFirmwareRequest for device: {}, with serialized size of {}\",\n                 device.getDeviceIdentification(), request.getSerializedSize());\n \n-        this.sendDelayedDeviceRegistration(device);\n-\n-        // Send a firmware activation event after the device registration has\n-        // (likely) been finished\n-        final Oslp.Event event = Oslp.Event.FIRMWARE_EVENTS_ACTIVATING;\n-        final String description = \"A new firmware is activated\";\n-        this.sendEventWithCustomDelay(device, event, description, 7000);\n+        this.simulateReboot(device).thenAccept(deviceMessageStatus -> {\n+            if (DeviceMessageStatus.NOT_FOUND == deviceMessageStatus) {\n+                LOGGER.error(\"Device {} not found handling update firmware request\", device.getDeviceIdentification());\n+                return;\n+            }\n+            final Oslp.Event event;\n+            final String description;\n+            if (DeviceMessageStatus.OK == deviceMessageStatus) {\n+                event = Oslp.Event.FIRMWARE_EVENTS_ACTIVATING;\n+                description = \"A new firmware is activated\";\n+            } else {\n+                LOGGER.warn(\"Device {} has issues registering after reboot handling update firmware request\",\n+                        device.getDeviceIdentification());\n+                event = Oslp.Event.FIRMWARE_EVENTS_DOWNLOAD_FAILED;\n+                description = \"Failure rebooting and registrating device during firmware activation\";\n+            }\n+            this.sendEventWithCustomDelay(device, event, description,\n+                    Math.max(1, 7 - this.deviceManagementService.getRebootDelay()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk3ODkxNQ=="}, "originalCommit": {"oid": "7c5fffda6d0a3486207ab3564d16ed6e827ebbb3"}, "originalPosition": 198}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDI4NDc4OnYy", "diffSide": "RIGHT", "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/webapp/WEB-INF/views/devices/list.jsp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwODozOTo0MlrOH9P3Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMDowMDozMVrOH9TLgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk4NTA5OQ==", "bodyText": "It's generally better to put styles in a css class.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/526#discussion_r533985099", "createdAt": "2020-12-02T08:39:42Z", "author": {"login": "joostknapen"}, "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/webapp/WEB-INF/views/devices/list.jsp", "diffHunk": "@@ -73,16 +73,18 @@ body {\n                             <spring:message code=\"device.list.page.title\" />\n                         </h1>\n                         <a href=\"/web-device-simulator/devices/create\" class=\"btn btn-primary\"><spring:message code=\"device.create.link.label\" /></a>\n-                            <spring:message code=\"device.edit.page.device.registration\" />\n-                            <input id=\"devRegistration\" name=\"devRegistration\" type=\"checkbox\"/>\n-                            <spring:message code=\"device.edit.page.device.reboot\" />\n-                            <input id=\"devReboot\" name=\"devReboot\" type=\"checkbox\"/>\n-                            <spring:message code=\"device.edit.page.device.tariff.switching\" />\n-                            <input id=\"tariffSwitching\" name=\"tariffSwitching\" type=\"checkbox\"/>\n-                            <spring:message code=\"device.edit.page.device.light.switching\" />\n-                            <input id=\"lightSwitching\" name=\"lightSwitching\" type=\"checkbox\"/>\n-                            <spring:message code=\"device.edit.page.device.event.notification\" />\n-                            <input id=\"eventListener\" name=\"eventListener\" type=\"checkbox\"/>\n+                        <label for=\"devRegistration\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.registration\" /></label>\n+                        <input id=\"devRegistration\" name=\"devRegistration\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"devReboot\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.reboot\" /></label>\n+                        <input id=\"devReboot\" name=\"devReboot\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"tariffSwitching\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.tariff.switching\" /></label>\n+                        <input id=\"tariffSwitching\" name=\"tariffSwitching\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"lightSwitching\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.light.switching\" /></label>\n+                        <input id=\"lightSwitching\" name=\"lightSwitching\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"eventListener\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.event.notification\" /></label>\n+                        <input id=\"eventListener\" name=\"eventListener\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"rebootDelay\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.reboot.delay\" /></label>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c5fffda6d0a3486207ab3564d16ed6e827ebbb3"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzOTQyNw==", "bodyText": "Leave as is, since the current css is even worse.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/526#discussion_r534039427", "createdAt": "2020-12-02T10:00:31Z", "author": {"login": "joostknapen"}, "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/webapp/WEB-INF/views/devices/list.jsp", "diffHunk": "@@ -73,16 +73,18 @@ body {\n                             <spring:message code=\"device.list.page.title\" />\n                         </h1>\n                         <a href=\"/web-device-simulator/devices/create\" class=\"btn btn-primary\"><spring:message code=\"device.create.link.label\" /></a>\n-                            <spring:message code=\"device.edit.page.device.registration\" />\n-                            <input id=\"devRegistration\" name=\"devRegistration\" type=\"checkbox\"/>\n-                            <spring:message code=\"device.edit.page.device.reboot\" />\n-                            <input id=\"devReboot\" name=\"devReboot\" type=\"checkbox\"/>\n-                            <spring:message code=\"device.edit.page.device.tariff.switching\" />\n-                            <input id=\"tariffSwitching\" name=\"tariffSwitching\" type=\"checkbox\"/>\n-                            <spring:message code=\"device.edit.page.device.light.switching\" />\n-                            <input id=\"lightSwitching\" name=\"lightSwitching\" type=\"checkbox\"/>\n-                            <spring:message code=\"device.edit.page.device.event.notification\" />\n-                            <input id=\"eventListener\" name=\"eventListener\" type=\"checkbox\"/>\n+                        <label for=\"devRegistration\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.registration\" /></label>\n+                        <input id=\"devRegistration\" name=\"devRegistration\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"devReboot\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.reboot\" /></label>\n+                        <input id=\"devReboot\" name=\"devReboot\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"tariffSwitching\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.tariff.switching\" /></label>\n+                        <input id=\"tariffSwitching\" name=\"tariffSwitching\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"lightSwitching\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.light.switching\" /></label>\n+                        <input id=\"lightSwitching\" name=\"lightSwitching\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"eventListener\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.event.notification\" /></label>\n+                        <input id=\"eventListener\" name=\"eventListener\" type=\"checkbox\" style=\"display: inline;\" />\n+                        <label for=\"rebootDelay\" style=\"display: inline; margin-left: .5em;\"><spring:message code=\"device.edit.page.device.reboot.delay\" /></label>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk4NTA5OQ=="}, "originalCommit": {"oid": "7c5fffda6d0a3486207ab3564d16ed6e827ebbb3"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3485, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}