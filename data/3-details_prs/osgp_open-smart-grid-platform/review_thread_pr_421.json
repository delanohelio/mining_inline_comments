{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4Njg5ODc3", "number": 421, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMzowMzoyN1rOEpBTZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwODoyMTo0N1rOEpuvbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNDQ4NDIzOnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMzowMzoyN1rOHacfDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMzowMzoyN1rOHacfDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ5MTcyNQ==", "bodyText": "I think replacing the entry will fix the problem reported concerning a previously installed version. For example when switching back to an older firmware version.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r497491725", "createdAt": "2020-09-30T13:03:27Z", "author": {"login": "kevinsmeets"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -371,38 +368,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,\n+            final List<FirmwareVersion> firmwareVersions) {\n+\n+        if (firmwareVersions.isEmpty()) {\n+            return firmwareVersions;\n+        }\n+        // copy input parameter\n+        final List<FirmwareVersion> firmwareVersionsToCheck = new ArrayList<>();\n+        firmwareVersionsToCheck.addAll(firmwareVersions);\n+\n+        // gets list of all historically installed modules\n+        final Device device = this.deviceRepository.findByDeviceIdentification(deviceId);\n+        final List<DeviceFirmwareFile> deviceFirmwareFiles = this.deviceFirmwareFileRepository\n+                .findByDeviceOrderByInstallationDateAsc(device);\n+\n+        // Transform this list so it contains only the latest entry for each\n+        // moduleType\n+        Map<String, FirmwareVersionWithInstallationDate> currentlyInstalledFirmwareVersionsPerType = new HashMap<String, FirmwareVersionWithInstallationDate>();\n+\n+        for (DeviceFirmwareFile firmwareFile : deviceFirmwareFiles) {\n+\n+            Map<FirmwareModule, String> fwms = firmwareFile.getFirmwareFile().getModuleVersions();\n+            Date installationDate = firmwareFile.getInstallationDate();\n+\n+            for (Map.Entry<FirmwareModule, String> entry : fwms.entrySet()) {\n+                String version = entry.getValue();\n+                FirmwareModule fwm = entry.getKey();\n+                // check if this installation of this same kind of module is\n+                // of a later date\n+                if (currentlyInstalledFirmwareVersionsPerType.containsKey(fwm.getDescription())\n+                        && currentlyInstalledFirmwareVersionsPerType.get(fwm.getDescription())\n+                                .getInstallationDate()\n+                                .before(installationDate)) {\n+                    currentlyInstalledFirmwareVersionsPerType.replace(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ed27d3f841c14a88521a19068382c3af984e096"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTc5MzMzOnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzozNTo0OFrOHbjwUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzozNTo0OFrOHbjwUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1OTQxMQ==", "bodyText": "Change HashMap<String, FirmwareVersionWithInstallationDate>() to HashMap<>()", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498659411", "createdAt": "2020-10-02T07:35:48Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -367,38 +364,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,\n+            final List<FirmwareVersion> firmwareVersions) {\n+\n+        if (firmwareVersions.isEmpty()) {\n+            return firmwareVersions;\n+        }\n+        // copy input parameter\n+        final List<FirmwareVersion> firmwareVersionsToCheck = new ArrayList<>();\n+        firmwareVersionsToCheck.addAll(firmwareVersions);\n+\n+        // gets list of all historically installed modules\n+        final Device device = this.deviceRepository.findByDeviceIdentification(deviceId);\n+        final List<DeviceFirmwareFile> deviceFirmwareFiles = this.deviceFirmwareFileRepository\n+                .findByDeviceOrderByInstallationDateAsc(device);\n+\n+        // Transform this list so it contains only the latest entry for each\n+        // moduleType\n+        Map<String, FirmwareVersionWithInstallationDate> currentlyInstalledFirmwareVersionsPerType = new HashMap<String, FirmwareVersionWithInstallationDate>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTgzMTU0OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzo0OToyMVrOHbkIFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzo0OToyMVrOHbkIFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NTQ5NA==", "bodyText": "Remove this setter. It is not used.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498665494", "createdAt": "2020-10-02T07:49:21Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -367,38 +364,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,\n+            final List<FirmwareVersion> firmwareVersions) {\n+\n+        if (firmwareVersions.isEmpty()) {\n+            return firmwareVersions;\n+        }\n+        // copy input parameter\n+        final List<FirmwareVersion> firmwareVersionsToCheck = new ArrayList<>();\n+        firmwareVersionsToCheck.addAll(firmwareVersions);\n+\n+        // gets list of all historically installed modules\n+        final Device device = this.deviceRepository.findByDeviceIdentification(deviceId);\n+        final List<DeviceFirmwareFile> deviceFirmwareFiles = this.deviceFirmwareFileRepository\n+                .findByDeviceOrderByInstallationDateAsc(device);\n+\n+        // Transform this list so it contains only the latest entry for each\n+        // moduleType\n+        Map<String, FirmwareVersionWithInstallationDate> currentlyInstalledFirmwareVersionsPerType = new HashMap<String, FirmwareVersionWithInstallationDate>();\n+\n+        for (DeviceFirmwareFile firmwareFile : deviceFirmwareFiles) {\n+\n+            Map<FirmwareModule, String> fwms = firmwareFile.getFirmwareFile().getModuleVersions();\n+            Date installationDate = firmwareFile.getInstallationDate();\n+\n+            for (Map.Entry<FirmwareModule, String> entry : fwms.entrySet()) {\n+                String version = entry.getValue();\n+                FirmwareModule fwm = entry.getKey();\n+                // check if this installation of this same kind of module is\n+                // of a later date\n+                if (currentlyInstalledFirmwareVersionsPerType.containsKey(fwm.getDescription())\n+                        && currentlyInstalledFirmwareVersionsPerType.get(fwm.getDescription())\n+                                .getInstallationDate()\n+                                .before(installationDate)) {\n+                    currentlyInstalledFirmwareVersionsPerType.replace(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                } else {\n+                    // no other module of this type found yet so just add it\n+                    currentlyInstalledFirmwareVersionsPerType.put(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                }\n+            }\n+        }\n+\n+        final List<FirmwareVersion> latestfirmwareVersionsOfEachModuleTypeInHistory = currentlyInstalledFirmwareVersionsPerType\n+                .values()\n+                .stream()\n+                .map(e -> new FirmwareVersion(e.getFirmwareVersion().getFirmwareModuleType(),\n+                        e.getFirmwareVersion().getVersion()))\n+                .collect(Collectors.toList());\n+\n+        // remove the latest history (module)versions from the firmwareVersions\n+        // parameter\n+        firmwareVersionsToCheck.removeAll(latestfirmwareVersionsOfEachModuleTypeInHistory);\n+\n+        return firmwareVersionsToCheck;\n+    }\n+\n+    // Helper class to keep track of InstallationDate and FirmwareVersion\n+    class FirmwareVersionWithInstallationDate {\n+        private Date installationDate;\n+        private FirmwareVersion firmwareVersion;\n+\n+        public Date getInstallationDate() {\n+            return this.installationDate;\n+        }\n+\n+        public void setInstallationDate(Date installationDate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTgzMTgzOnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzo0OToyOVrOHbkISQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzo0OToyOVrOHbkISQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NTU0NQ==", "bodyText": "Remove this setter. It is not used.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498665545", "createdAt": "2020-10-02T07:49:29Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -367,38 +364,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,\n+            final List<FirmwareVersion> firmwareVersions) {\n+\n+        if (firmwareVersions.isEmpty()) {\n+            return firmwareVersions;\n+        }\n+        // copy input parameter\n+        final List<FirmwareVersion> firmwareVersionsToCheck = new ArrayList<>();\n+        firmwareVersionsToCheck.addAll(firmwareVersions);\n+\n+        // gets list of all historically installed modules\n+        final Device device = this.deviceRepository.findByDeviceIdentification(deviceId);\n+        final List<DeviceFirmwareFile> deviceFirmwareFiles = this.deviceFirmwareFileRepository\n+                .findByDeviceOrderByInstallationDateAsc(device);\n+\n+        // Transform this list so it contains only the latest entry for each\n+        // moduleType\n+        Map<String, FirmwareVersionWithInstallationDate> currentlyInstalledFirmwareVersionsPerType = new HashMap<String, FirmwareVersionWithInstallationDate>();\n+\n+        for (DeviceFirmwareFile firmwareFile : deviceFirmwareFiles) {\n+\n+            Map<FirmwareModule, String> fwms = firmwareFile.getFirmwareFile().getModuleVersions();\n+            Date installationDate = firmwareFile.getInstallationDate();\n+\n+            for (Map.Entry<FirmwareModule, String> entry : fwms.entrySet()) {\n+                String version = entry.getValue();\n+                FirmwareModule fwm = entry.getKey();\n+                // check if this installation of this same kind of module is\n+                // of a later date\n+                if (currentlyInstalledFirmwareVersionsPerType.containsKey(fwm.getDescription())\n+                        && currentlyInstalledFirmwareVersionsPerType.get(fwm.getDescription())\n+                                .getInstallationDate()\n+                                .before(installationDate)) {\n+                    currentlyInstalledFirmwareVersionsPerType.replace(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                } else {\n+                    // no other module of this type found yet so just add it\n+                    currentlyInstalledFirmwareVersionsPerType.put(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                }\n+            }\n+        }\n+\n+        final List<FirmwareVersion> latestfirmwareVersionsOfEachModuleTypeInHistory = currentlyInstalledFirmwareVersionsPerType\n+                .values()\n+                .stream()\n+                .map(e -> new FirmwareVersion(e.getFirmwareVersion().getFirmwareModuleType(),\n+                        e.getFirmwareVersion().getVersion()))\n+                .collect(Collectors.toList());\n+\n+        // remove the latest history (module)versions from the firmwareVersions\n+        // parameter\n+        firmwareVersionsToCheck.removeAll(latestfirmwareVersionsOfEachModuleTypeInHistory);\n+\n+        return firmwareVersionsToCheck;\n+    }\n+\n+    // Helper class to keep track of InstallationDate and FirmwareVersion\n+    class FirmwareVersionWithInstallationDate {\n+        private Date installationDate;\n+        private FirmwareVersion firmwareVersion;\n+\n+        public Date getInstallationDate() {\n+            return this.installationDate;\n+        }\n+\n+        public void setInstallationDate(Date installationDate) {\n+            this.installationDate = installationDate;\n+        }\n+\n+        public FirmwareVersion getFirmwareVersion() {\n+            return this.firmwareVersion;\n+        }\n+\n+        public void setFirmwareVersion(FirmwareVersion firmwareVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 118}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTgzNTM2OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzo1MDo0M1rOHbkKnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzo1MDo0M1rOHbkKnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NjE0MQ==", "bodyText": "This class does not have to be package private. Make it's scope private static", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498666141", "createdAt": "2020-10-02T07:50:43Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -367,38 +364,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,\n+            final List<FirmwareVersion> firmwareVersions) {\n+\n+        if (firmwareVersions.isEmpty()) {\n+            return firmwareVersions;\n+        }\n+        // copy input parameter\n+        final List<FirmwareVersion> firmwareVersionsToCheck = new ArrayList<>();\n+        firmwareVersionsToCheck.addAll(firmwareVersions);\n+\n+        // gets list of all historically installed modules\n+        final Device device = this.deviceRepository.findByDeviceIdentification(deviceId);\n+        final List<DeviceFirmwareFile> deviceFirmwareFiles = this.deviceFirmwareFileRepository\n+                .findByDeviceOrderByInstallationDateAsc(device);\n+\n+        // Transform this list so it contains only the latest entry for each\n+        // moduleType\n+        Map<String, FirmwareVersionWithInstallationDate> currentlyInstalledFirmwareVersionsPerType = new HashMap<String, FirmwareVersionWithInstallationDate>();\n+\n+        for (DeviceFirmwareFile firmwareFile : deviceFirmwareFiles) {\n+\n+            Map<FirmwareModule, String> fwms = firmwareFile.getFirmwareFile().getModuleVersions();\n+            Date installationDate = firmwareFile.getInstallationDate();\n+\n+            for (Map.Entry<FirmwareModule, String> entry : fwms.entrySet()) {\n+                String version = entry.getValue();\n+                FirmwareModule fwm = entry.getKey();\n+                // check if this installation of this same kind of module is\n+                // of a later date\n+                if (currentlyInstalledFirmwareVersionsPerType.containsKey(fwm.getDescription())\n+                        && currentlyInstalledFirmwareVersionsPerType.get(fwm.getDescription())\n+                                .getInstallationDate()\n+                                .before(installationDate)) {\n+                    currentlyInstalledFirmwareVersionsPerType.replace(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                } else {\n+                    // no other module of this type found yet so just add it\n+                    currentlyInstalledFirmwareVersionsPerType.put(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                }\n+            }\n+        }\n+\n+        final List<FirmwareVersion> latestfirmwareVersionsOfEachModuleTypeInHistory = currentlyInstalledFirmwareVersionsPerType\n+                .values()\n+                .stream()\n+                .map(e -> new FirmwareVersion(e.getFirmwareVersion().getFirmwareModuleType(),\n+                        e.getFirmwareVersion().getVersion()))\n+                .collect(Collectors.toList());\n+\n+        // remove the latest history (module)versions from the firmwareVersions\n+        // parameter\n+        firmwareVersionsToCheck.removeAll(latestfirmwareVersionsOfEachModuleTypeInHistory);\n+\n+        return firmwareVersionsToCheck;\n+    }\n+\n+    // Helper class to keep track of InstallationDate and FirmwareVersion\n+    class FirmwareVersionWithInstallationDate {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTg1NDU0OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzo1Njo1MVrOHbkWHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMToxODozM1rOHbp_SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2OTA4Nw==", "bodyText": "Sonar: \"Preconditions\" and logging arguments should not require evaluation\nCode smell Major java:S2629", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498669087", "createdAt": "2020-10-02T07:56:51Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -367,38 +364,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,\n+            final List<FirmwareVersion> firmwareVersions) {\n+\n+        if (firmwareVersions.isEmpty()) {\n+            return firmwareVersions;\n+        }\n+        // copy input parameter\n+        final List<FirmwareVersion> firmwareVersionsToCheck = new ArrayList<>();\n+        firmwareVersionsToCheck.addAll(firmwareVersions);\n+\n+        // gets list of all historically installed modules\n+        final Device device = this.deviceRepository.findByDeviceIdentification(deviceId);\n+        final List<DeviceFirmwareFile> deviceFirmwareFiles = this.deviceFirmwareFileRepository\n+                .findByDeviceOrderByInstallationDateAsc(device);\n+\n+        // Transform this list so it contains only the latest entry for each\n+        // moduleType\n+        Map<String, FirmwareVersionWithInstallationDate> currentlyInstalledFirmwareVersionsPerType = new HashMap<String, FirmwareVersionWithInstallationDate>();\n+\n+        for (DeviceFirmwareFile firmwareFile : deviceFirmwareFiles) {\n+\n+            Map<FirmwareModule, String> fwms = firmwareFile.getFirmwareFile().getModuleVersions();\n+            Date installationDate = firmwareFile.getInstallationDate();\n+\n+            for (Map.Entry<FirmwareModule, String> entry : fwms.entrySet()) {\n+                String version = entry.getValue();\n+                FirmwareModule fwm = entry.getKey();\n+                // check if this installation of this same kind of module is\n+                // of a later date\n+                if (currentlyInstalledFirmwareVersionsPerType.containsKey(fwm.getDescription())\n+                        && currentlyInstalledFirmwareVersionsPerType.get(fwm.getDescription())\n+                                .getInstallationDate()\n+                                .before(installationDate)) {\n+                    currentlyInstalledFirmwareVersionsPerType.replace(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                } else {\n+                    // no other module of this type found yet so just add it\n+                    currentlyInstalledFirmwareVersionsPerType.put(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                }\n+            }\n+        }\n+\n+        final List<FirmwareVersion> latestfirmwareVersionsOfEachModuleTypeInHistory = currentlyInstalledFirmwareVersionsPerType\n+                .values()\n+                .stream()\n+                .map(e -> new FirmwareVersion(e.getFirmwareVersion().getFirmwareModuleType(),\n+                        e.getFirmwareVersion().getVersion()))\n+                .collect(Collectors.toList());\n+\n+        // remove the latest history (module)versions from the firmwareVersions\n+        // parameter\n+        firmwareVersionsToCheck.removeAll(latestfirmwareVersionsOfEachModuleTypeInHistory);\n+\n+        return firmwareVersionsToCheck;\n+    }\n+\n+    // Helper class to keep track of InstallationDate and FirmwareVersion\n+    class FirmwareVersionWithInstallationDate {\n+        private Date installationDate;\n+        private FirmwareVersion firmwareVersion;\n+\n+        public Date getInstallationDate() {\n+            return this.installationDate;\n+        }\n+\n+        public void setInstallationDate(Date installationDate) {\n+            this.installationDate = installationDate;\n+        }\n+\n+        public FirmwareVersion getFirmwareVersion() {\n+            return this.firmwareVersion;\n+        }\n+\n+        public void setFirmwareVersion(FirmwareVersion firmwareVersion) {\n+            this.firmwareVersion = firmwareVersion;\n+        }\n+\n+        public FirmwareVersionWithInstallationDate(Date installationDate, FirmwareVersion firmwareVersion) {\n+            this.installationDate = installationDate;\n+            this.firmwareVersion = firmwareVersion;\n+        }\n+    }\n+\n+    public void tryToAddDeviceFirmwareFile(final String deviceIdentification,\n+            final List<FirmwareVersion> firmwareVersionsNotCurrent) {\n+\n+        if (firmwareVersionsNotCurrent.isEmpty()) {\n+            LOGGER.info(\"No firmware to look for, concerning device {}, so nothing to add.\", deviceIdentification);\n+            return;\n+        }\n \n-        final FirmwareModule module = createFirmwareModule(firmwareVersion);\n         final Device device = this.deviceRepository.findByDeviceIdentification(deviceIdentification);\n-        final List<FirmwareFile> firmwareFiles = this.getAvailableFirmwareFilesForDeviceModel(device.getDeviceModel());\n \n         // check each file for the module and the version as returned by the\n-        // device\n-        boolean recordAdded = false;\n-\n-        for (final FirmwareFile file : firmwareFiles) {\n-            final Map<FirmwareModule, String> moduleVersions = file.getModuleVersions();\n-            if (moduleVersions.containsKey(module) && moduleVersions.get(module).equals(firmwareVersion.getVersion())) {\n+        // device, in theory there could be files that have partially\n+        // overlapping modules,\n+        // therefore we check if all modules are in the file\n \n+        for (final FirmwareFile file : this.getAvailableFirmwareFilesForDeviceModel(device.getDeviceModel())) {\n+            if (firmwareFileContainsAllOfTheseModules(file, firmwareVersionsNotCurrent)) {\n                 // file found, insert a record into the history\n                 final DeviceFirmwareFile deviceFirmwareFile = new DeviceFirmwareFile(device, file, new Date(),\n                         INSTALLER);\n                 this.deviceFirmwareFileRepository.save(deviceFirmwareFile);\n-                LOGGER.info(\"Firmware version {} added to device {}\", firmwareVersion.getVersion(),\n-                        deviceIdentification);\n \n-                // we only want to add one record in history\n-                recordAdded = true;\n-                break;\n+                LOGGER.info(\n+                        \"Added new record to deviceFirmwareFile for device: {} \"\n+                                + \"with following modules (ModulesType/Versions):{} \" + \", using file: {}\",\n+                        deviceIdentification, firmwareVersionsNotCurrent.toString(), file.getFilename());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2MTU0NQ==", "bodyText": "String concatenation in log statement is not needed, can be changed to 1 string.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498761545", "createdAt": "2020-10-02T11:18:33Z", "author": {"login": "kevinsmeets"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -367,38 +364,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,\n+            final List<FirmwareVersion> firmwareVersions) {\n+\n+        if (firmwareVersions.isEmpty()) {\n+            return firmwareVersions;\n+        }\n+        // copy input parameter\n+        final List<FirmwareVersion> firmwareVersionsToCheck = new ArrayList<>();\n+        firmwareVersionsToCheck.addAll(firmwareVersions);\n+\n+        // gets list of all historically installed modules\n+        final Device device = this.deviceRepository.findByDeviceIdentification(deviceId);\n+        final List<DeviceFirmwareFile> deviceFirmwareFiles = this.deviceFirmwareFileRepository\n+                .findByDeviceOrderByInstallationDateAsc(device);\n+\n+        // Transform this list so it contains only the latest entry for each\n+        // moduleType\n+        Map<String, FirmwareVersionWithInstallationDate> currentlyInstalledFirmwareVersionsPerType = new HashMap<String, FirmwareVersionWithInstallationDate>();\n+\n+        for (DeviceFirmwareFile firmwareFile : deviceFirmwareFiles) {\n+\n+            Map<FirmwareModule, String> fwms = firmwareFile.getFirmwareFile().getModuleVersions();\n+            Date installationDate = firmwareFile.getInstallationDate();\n+\n+            for (Map.Entry<FirmwareModule, String> entry : fwms.entrySet()) {\n+                String version = entry.getValue();\n+                FirmwareModule fwm = entry.getKey();\n+                // check if this installation of this same kind of module is\n+                // of a later date\n+                if (currentlyInstalledFirmwareVersionsPerType.containsKey(fwm.getDescription())\n+                        && currentlyInstalledFirmwareVersionsPerType.get(fwm.getDescription())\n+                                .getInstallationDate()\n+                                .before(installationDate)) {\n+                    currentlyInstalledFirmwareVersionsPerType.replace(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                } else {\n+                    // no other module of this type found yet so just add it\n+                    currentlyInstalledFirmwareVersionsPerType.put(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                }\n+            }\n+        }\n+\n+        final List<FirmwareVersion> latestfirmwareVersionsOfEachModuleTypeInHistory = currentlyInstalledFirmwareVersionsPerType\n+                .values()\n+                .stream()\n+                .map(e -> new FirmwareVersion(e.getFirmwareVersion().getFirmwareModuleType(),\n+                        e.getFirmwareVersion().getVersion()))\n+                .collect(Collectors.toList());\n+\n+        // remove the latest history (module)versions from the firmwareVersions\n+        // parameter\n+        firmwareVersionsToCheck.removeAll(latestfirmwareVersionsOfEachModuleTypeInHistory);\n+\n+        return firmwareVersionsToCheck;\n+    }\n+\n+    // Helper class to keep track of InstallationDate and FirmwareVersion\n+    class FirmwareVersionWithInstallationDate {\n+        private Date installationDate;\n+        private FirmwareVersion firmwareVersion;\n+\n+        public Date getInstallationDate() {\n+            return this.installationDate;\n+        }\n+\n+        public void setInstallationDate(Date installationDate) {\n+            this.installationDate = installationDate;\n+        }\n+\n+        public FirmwareVersion getFirmwareVersion() {\n+            return this.firmwareVersion;\n+        }\n+\n+        public void setFirmwareVersion(FirmwareVersion firmwareVersion) {\n+            this.firmwareVersion = firmwareVersion;\n+        }\n+\n+        public FirmwareVersionWithInstallationDate(Date installationDate, FirmwareVersion firmwareVersion) {\n+            this.installationDate = installationDate;\n+            this.firmwareVersion = firmwareVersion;\n+        }\n+    }\n+\n+    public void tryToAddDeviceFirmwareFile(final String deviceIdentification,\n+            final List<FirmwareVersion> firmwareVersionsNotCurrent) {\n+\n+        if (firmwareVersionsNotCurrent.isEmpty()) {\n+            LOGGER.info(\"No firmware to look for, concerning device {}, so nothing to add.\", deviceIdentification);\n+            return;\n+        }\n \n-        final FirmwareModule module = createFirmwareModule(firmwareVersion);\n         final Device device = this.deviceRepository.findByDeviceIdentification(deviceIdentification);\n-        final List<FirmwareFile> firmwareFiles = this.getAvailableFirmwareFilesForDeviceModel(device.getDeviceModel());\n \n         // check each file for the module and the version as returned by the\n-        // device\n-        boolean recordAdded = false;\n-\n-        for (final FirmwareFile file : firmwareFiles) {\n-            final Map<FirmwareModule, String> moduleVersions = file.getModuleVersions();\n-            if (moduleVersions.containsKey(module) && moduleVersions.get(module).equals(firmwareVersion.getVersion())) {\n+        // device, in theory there could be files that have partially\n+        // overlapping modules,\n+        // therefore we check if all modules are in the file\n \n+        for (final FirmwareFile file : this.getAvailableFirmwareFilesForDeviceModel(device.getDeviceModel())) {\n+            if (firmwareFileContainsAllOfTheseModules(file, firmwareVersionsNotCurrent)) {\n                 // file found, insert a record into the history\n                 final DeviceFirmwareFile deviceFirmwareFile = new DeviceFirmwareFile(device, file, new Date(),\n                         INSTALLER);\n                 this.deviceFirmwareFileRepository.save(deviceFirmwareFile);\n-                LOGGER.info(\"Firmware version {} added to device {}\", firmwareVersion.getVersion(),\n-                        deviceIdentification);\n \n-                // we only want to add one record in history\n-                recordAdded = true;\n-                break;\n+                LOGGER.info(\n+                        \"Added new record to deviceFirmwareFile for device: {} \"\n+                                + \"with following modules (ModulesType/Versions):{} \" + \", using file: {}\",\n+                        deviceIdentification, firmwareVersionsNotCurrent.toString(), file.getFilename());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2OTA4Nw=="}, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 166}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTg1NTQ0OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzo1NzowN1rOHbkWoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMToxODozOFrOHbp_bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2OTIxNg==", "bodyText": "Sonar: \"Preconditions\" and logging arguments should not require evaluation\nCode smell Major java:S2629", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498669216", "createdAt": "2020-10-02T07:57:07Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -367,38 +364,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,\n+            final List<FirmwareVersion> firmwareVersions) {\n+\n+        if (firmwareVersions.isEmpty()) {\n+            return firmwareVersions;\n+        }\n+        // copy input parameter\n+        final List<FirmwareVersion> firmwareVersionsToCheck = new ArrayList<>();\n+        firmwareVersionsToCheck.addAll(firmwareVersions);\n+\n+        // gets list of all historically installed modules\n+        final Device device = this.deviceRepository.findByDeviceIdentification(deviceId);\n+        final List<DeviceFirmwareFile> deviceFirmwareFiles = this.deviceFirmwareFileRepository\n+                .findByDeviceOrderByInstallationDateAsc(device);\n+\n+        // Transform this list so it contains only the latest entry for each\n+        // moduleType\n+        Map<String, FirmwareVersionWithInstallationDate> currentlyInstalledFirmwareVersionsPerType = new HashMap<String, FirmwareVersionWithInstallationDate>();\n+\n+        for (DeviceFirmwareFile firmwareFile : deviceFirmwareFiles) {\n+\n+            Map<FirmwareModule, String> fwms = firmwareFile.getFirmwareFile().getModuleVersions();\n+            Date installationDate = firmwareFile.getInstallationDate();\n+\n+            for (Map.Entry<FirmwareModule, String> entry : fwms.entrySet()) {\n+                String version = entry.getValue();\n+                FirmwareModule fwm = entry.getKey();\n+                // check if this installation of this same kind of module is\n+                // of a later date\n+                if (currentlyInstalledFirmwareVersionsPerType.containsKey(fwm.getDescription())\n+                        && currentlyInstalledFirmwareVersionsPerType.get(fwm.getDescription())\n+                                .getInstallationDate()\n+                                .before(installationDate)) {\n+                    currentlyInstalledFirmwareVersionsPerType.replace(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                } else {\n+                    // no other module of this type found yet so just add it\n+                    currentlyInstalledFirmwareVersionsPerType.put(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                }\n+            }\n+        }\n+\n+        final List<FirmwareVersion> latestfirmwareVersionsOfEachModuleTypeInHistory = currentlyInstalledFirmwareVersionsPerType\n+                .values()\n+                .stream()\n+                .map(e -> new FirmwareVersion(e.getFirmwareVersion().getFirmwareModuleType(),\n+                        e.getFirmwareVersion().getVersion()))\n+                .collect(Collectors.toList());\n+\n+        // remove the latest history (module)versions from the firmwareVersions\n+        // parameter\n+        firmwareVersionsToCheck.removeAll(latestfirmwareVersionsOfEachModuleTypeInHistory);\n+\n+        return firmwareVersionsToCheck;\n+    }\n+\n+    // Helper class to keep track of InstallationDate and FirmwareVersion\n+    class FirmwareVersionWithInstallationDate {\n+        private Date installationDate;\n+        private FirmwareVersion firmwareVersion;\n+\n+        public Date getInstallationDate() {\n+            return this.installationDate;\n+        }\n+\n+        public void setInstallationDate(Date installationDate) {\n+            this.installationDate = installationDate;\n+        }\n+\n+        public FirmwareVersion getFirmwareVersion() {\n+            return this.firmwareVersion;\n+        }\n+\n+        public void setFirmwareVersion(FirmwareVersion firmwareVersion) {\n+            this.firmwareVersion = firmwareVersion;\n+        }\n+\n+        public FirmwareVersionWithInstallationDate(Date installationDate, FirmwareVersion firmwareVersion) {\n+            this.installationDate = installationDate;\n+            this.firmwareVersion = firmwareVersion;\n+        }\n+    }\n+\n+    public void tryToAddDeviceFirmwareFile(final String deviceIdentification,\n+            final List<FirmwareVersion> firmwareVersionsNotCurrent) {\n+\n+        if (firmwareVersionsNotCurrent.isEmpty()) {\n+            LOGGER.info(\"No firmware to look for, concerning device {}, so nothing to add.\", deviceIdentification);\n+            return;\n+        }\n \n-        final FirmwareModule module = createFirmwareModule(firmwareVersion);\n         final Device device = this.deviceRepository.findByDeviceIdentification(deviceIdentification);\n-        final List<FirmwareFile> firmwareFiles = this.getAvailableFirmwareFilesForDeviceModel(device.getDeviceModel());\n \n         // check each file for the module and the version as returned by the\n-        // device\n-        boolean recordAdded = false;\n-\n-        for (final FirmwareFile file : firmwareFiles) {\n-            final Map<FirmwareModule, String> moduleVersions = file.getModuleVersions();\n-            if (moduleVersions.containsKey(module) && moduleVersions.get(module).equals(firmwareVersion.getVersion())) {\n+        // device, in theory there could be files that have partially\n+        // overlapping modules,\n+        // therefore we check if all modules are in the file\n \n+        for (final FirmwareFile file : this.getAvailableFirmwareFilesForDeviceModel(device.getDeviceModel())) {\n+            if (firmwareFileContainsAllOfTheseModules(file, firmwareVersionsNotCurrent)) {\n                 // file found, insert a record into the history\n                 final DeviceFirmwareFile deviceFirmwareFile = new DeviceFirmwareFile(device, file, new Date(),\n                         INSTALLER);\n                 this.deviceFirmwareFileRepository.save(deviceFirmwareFile);\n-                LOGGER.info(\"Firmware version {} added to device {}\", firmwareVersion.getVersion(),\n-                        deviceIdentification);\n \n-                // we only want to add one record in history\n-                recordAdded = true;\n-                break;\n+                LOGGER.info(\n+                        \"Added new record to deviceFirmwareFile for device: {} \"\n+                                + \"with following modules (ModulesType/Versions):{} \" + \", using file: {}\",\n+                        deviceIdentification, firmwareVersionsNotCurrent.toString(), file.getFilename());\n+                return;\n             }\n         }\n \n-        if (!recordAdded) {\n-            LOGGER.warn(\"No firmware file record found for: {} for device: {}\", firmwareVersion, deviceIdentification);\n-        }\n+        LOGGER.warn(\n+                \"Could not find any firmware file for device: {} \"\n+                        + \"that contains (all of) the following modules (ModulesType/Versions):{}\",\n+                deviceIdentification, firmwareVersionsNotCurrent.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 177}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2MTU4Mw==", "bodyText": "String concatenation in log statement is not needed, can be changed to 1 string.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498761583", "createdAt": "2020-10-02T11:18:38Z", "author": {"login": "kevinsmeets"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -367,38 +364,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,\n+            final List<FirmwareVersion> firmwareVersions) {\n+\n+        if (firmwareVersions.isEmpty()) {\n+            return firmwareVersions;\n+        }\n+        // copy input parameter\n+        final List<FirmwareVersion> firmwareVersionsToCheck = new ArrayList<>();\n+        firmwareVersionsToCheck.addAll(firmwareVersions);\n+\n+        // gets list of all historically installed modules\n+        final Device device = this.deviceRepository.findByDeviceIdentification(deviceId);\n+        final List<DeviceFirmwareFile> deviceFirmwareFiles = this.deviceFirmwareFileRepository\n+                .findByDeviceOrderByInstallationDateAsc(device);\n+\n+        // Transform this list so it contains only the latest entry for each\n+        // moduleType\n+        Map<String, FirmwareVersionWithInstallationDate> currentlyInstalledFirmwareVersionsPerType = new HashMap<String, FirmwareVersionWithInstallationDate>();\n+\n+        for (DeviceFirmwareFile firmwareFile : deviceFirmwareFiles) {\n+\n+            Map<FirmwareModule, String> fwms = firmwareFile.getFirmwareFile().getModuleVersions();\n+            Date installationDate = firmwareFile.getInstallationDate();\n+\n+            for (Map.Entry<FirmwareModule, String> entry : fwms.entrySet()) {\n+                String version = entry.getValue();\n+                FirmwareModule fwm = entry.getKey();\n+                // check if this installation of this same kind of module is\n+                // of a later date\n+                if (currentlyInstalledFirmwareVersionsPerType.containsKey(fwm.getDescription())\n+                        && currentlyInstalledFirmwareVersionsPerType.get(fwm.getDescription())\n+                                .getInstallationDate()\n+                                .before(installationDate)) {\n+                    currentlyInstalledFirmwareVersionsPerType.replace(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                } else {\n+                    // no other module of this type found yet so just add it\n+                    currentlyInstalledFirmwareVersionsPerType.put(fwm.getDescription(),\n+                            new FirmwareVersionWithInstallationDate(installationDate, new FirmwareVersion(\n+                                    FirmwareModuleType.forDescription(fwm.getDescription()), version)));\n+                }\n+            }\n+        }\n+\n+        final List<FirmwareVersion> latestfirmwareVersionsOfEachModuleTypeInHistory = currentlyInstalledFirmwareVersionsPerType\n+                .values()\n+                .stream()\n+                .map(e -> new FirmwareVersion(e.getFirmwareVersion().getFirmwareModuleType(),\n+                        e.getFirmwareVersion().getVersion()))\n+                .collect(Collectors.toList());\n+\n+        // remove the latest history (module)versions from the firmwareVersions\n+        // parameter\n+        firmwareVersionsToCheck.removeAll(latestfirmwareVersionsOfEachModuleTypeInHistory);\n+\n+        return firmwareVersionsToCheck;\n+    }\n+\n+    // Helper class to keep track of InstallationDate and FirmwareVersion\n+    class FirmwareVersionWithInstallationDate {\n+        private Date installationDate;\n+        private FirmwareVersion firmwareVersion;\n+\n+        public Date getInstallationDate() {\n+            return this.installationDate;\n+        }\n+\n+        public void setInstallationDate(Date installationDate) {\n+            this.installationDate = installationDate;\n+        }\n+\n+        public FirmwareVersion getFirmwareVersion() {\n+            return this.firmwareVersion;\n+        }\n+\n+        public void setFirmwareVersion(FirmwareVersion firmwareVersion) {\n+            this.firmwareVersion = firmwareVersion;\n+        }\n+\n+        public FirmwareVersionWithInstallationDate(Date installationDate, FirmwareVersion firmwareVersion) {\n+            this.installationDate = installationDate;\n+            this.firmwareVersion = firmwareVersion;\n+        }\n+    }\n+\n+    public void tryToAddDeviceFirmwareFile(final String deviceIdentification,\n+            final List<FirmwareVersion> firmwareVersionsNotCurrent) {\n+\n+        if (firmwareVersionsNotCurrent.isEmpty()) {\n+            LOGGER.info(\"No firmware to look for, concerning device {}, so nothing to add.\", deviceIdentification);\n+            return;\n+        }\n \n-        final FirmwareModule module = createFirmwareModule(firmwareVersion);\n         final Device device = this.deviceRepository.findByDeviceIdentification(deviceIdentification);\n-        final List<FirmwareFile> firmwareFiles = this.getAvailableFirmwareFilesForDeviceModel(device.getDeviceModel());\n \n         // check each file for the module and the version as returned by the\n-        // device\n-        boolean recordAdded = false;\n-\n-        for (final FirmwareFile file : firmwareFiles) {\n-            final Map<FirmwareModule, String> moduleVersions = file.getModuleVersions();\n-            if (moduleVersions.containsKey(module) && moduleVersions.get(module).equals(firmwareVersion.getVersion())) {\n+        // device, in theory there could be files that have partially\n+        // overlapping modules,\n+        // therefore we check if all modules are in the file\n \n+        for (final FirmwareFile file : this.getAvailableFirmwareFilesForDeviceModel(device.getDeviceModel())) {\n+            if (firmwareFileContainsAllOfTheseModules(file, firmwareVersionsNotCurrent)) {\n                 // file found, insert a record into the history\n                 final DeviceFirmwareFile deviceFirmwareFile = new DeviceFirmwareFile(device, file, new Date(),\n                         INSTALLER);\n                 this.deviceFirmwareFileRepository.save(deviceFirmwareFile);\n-                LOGGER.info(\"Firmware version {} added to device {}\", firmwareVersion.getVersion(),\n-                        deviceIdentification);\n \n-                // we only want to add one record in history\n-                recordAdded = true;\n-                break;\n+                LOGGER.info(\n+                        \"Added new record to deviceFirmwareFile for device: {} \"\n+                                + \"with following modules (ModulesType/Versions):{} \" + \", using file: {}\",\n+                        deviceIdentification, firmwareVersionsNotCurrent.toString(), file.getFilename());\n+                return;\n             }\n         }\n \n-        if (!recordAdded) {\n-            LOGGER.warn(\"No firmware file record found for: {} for device: {}\", firmwareVersion, deviceIdentification);\n-        }\n+        LOGGER.warn(\n+                \"Could not find any firmware file for device: {} \"\n+                        + \"that contains (all of) the following modules (ModulesType/Versions):{}\",\n+                deviceIdentification, firmwareVersionsNotCurrent.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2OTIxNg=="}, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 177}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTg3NDI3OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwODowMzozMlrOHbkiXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMToyMDo0M1rOHbqCdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjIyMg==", "bodyText": "FunctionalException is not thrown. Just remove", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498672222", "createdAt": "2020-10-02T08:03:32Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2MjM1OA==", "bodyText": "Those repository functions which are mocked in this method, are not going to throw. Can be removed.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498762358", "createdAt": "2020-10-02T11:20:43Z", "author": {"login": "kevinsmeets"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjIyMg=="}, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTg3NDU4OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwODowMzozOFrOHbkijQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMToyMzo0MlrOHbqGsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjI2OQ==", "bodyText": "FunctionalException is not thrown. Just remove", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498672269", "createdAt": "2020-10-02T08:03:38Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {\n+        // VERSION 1 and VERSION 2 have already been installed previously (in\n+        // that same order)\n         final Manufacturer manufacturer = new Manufacturer(\"code\", \"name\", false);\n         final DeviceModel deviceModel = new DeviceModel(manufacturer, \"modelCode\", \"description\", false);\n         final Device device = this.createDevice(deviceModel);\n         when(this.deviceRepository.findByDeviceIdentification(anyString())).thenReturn(device);\n         final DeviceFirmwareFile deviceFirmwareFile1 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_1), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_1), DateUtils.addDays(new Date(), -2), \"me\");\n         final DeviceFirmwareFile deviceFirmwareFile2 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_2), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_2), DateUtils.addDays(new Date(), -1), \"me\");\n         final List<DeviceFirmwareFile> deviceFirmwareFiles = Arrays.asList(deviceFirmwareFile1, deviceFirmwareFile2);\n         when(this.deviceFirmwareFileRepository.findByDeviceOrderByInstallationDateAsc(any(Device.class)))\n                 .thenReturn(deviceFirmwareFiles);\n+\n         when(this.deviceFirmwareFileRepository.save(any(DeviceFirmwareFile.class))).thenReturn(deviceFirmwareFile1);\n         when(this.manufacturerRepository.findByCode(anyString())).thenReturn(manufacturer);\n         when(this.deviceModelRepository.findByManufacturerAndModelCode(any(Manufacturer.class), anyString()))\n                 .thenReturn(deviceModel);\n     }\n \n     @Test\n-    void testCheckFirmwareHistoryForExistingVersion() throws FunctionalException {\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInHistoryButNotLast() throws FunctionalException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2MzQ0MA==", "bodyText": "I don't think firmwareManagementService.handleGetFirmwareVersionResponse() can throw. Can be removed.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498763440", "createdAt": "2020-10-02T11:23:42Z", "author": {"login": "kevinsmeets"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {\n+        // VERSION 1 and VERSION 2 have already been installed previously (in\n+        // that same order)\n         final Manufacturer manufacturer = new Manufacturer(\"code\", \"name\", false);\n         final DeviceModel deviceModel = new DeviceModel(manufacturer, \"modelCode\", \"description\", false);\n         final Device device = this.createDevice(deviceModel);\n         when(this.deviceRepository.findByDeviceIdentification(anyString())).thenReturn(device);\n         final DeviceFirmwareFile deviceFirmwareFile1 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_1), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_1), DateUtils.addDays(new Date(), -2), \"me\");\n         final DeviceFirmwareFile deviceFirmwareFile2 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_2), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_2), DateUtils.addDays(new Date(), -1), \"me\");\n         final List<DeviceFirmwareFile> deviceFirmwareFiles = Arrays.asList(deviceFirmwareFile1, deviceFirmwareFile2);\n         when(this.deviceFirmwareFileRepository.findByDeviceOrderByInstallationDateAsc(any(Device.class)))\n                 .thenReturn(deviceFirmwareFiles);\n+\n         when(this.deviceFirmwareFileRepository.save(any(DeviceFirmwareFile.class))).thenReturn(deviceFirmwareFile1);\n         when(this.manufacturerRepository.findByCode(anyString())).thenReturn(manufacturer);\n         when(this.deviceModelRepository.findByManufacturerAndModelCode(any(Manufacturer.class), anyString()))\n                 .thenReturn(deviceModel);\n     }\n \n     @Test\n-    void testCheckFirmwareHistoryForExistingVersion() throws FunctionalException {\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInHistoryButNotLast() throws FunctionalException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjI2OQ=="}, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 116}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTg3NDc3OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwODowMzo0MlrOHbkiqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMToyNDoxNlrOHbqHkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjI5Nw==", "bodyText": "FunctionalException is not thrown. Just remove", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498672297", "createdAt": "2020-10-02T08:03:42Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {\n+        // VERSION 1 and VERSION 2 have already been installed previously (in\n+        // that same order)\n         final Manufacturer manufacturer = new Manufacturer(\"code\", \"name\", false);\n         final DeviceModel deviceModel = new DeviceModel(manufacturer, \"modelCode\", \"description\", false);\n         final Device device = this.createDevice(deviceModel);\n         when(this.deviceRepository.findByDeviceIdentification(anyString())).thenReturn(device);\n         final DeviceFirmwareFile deviceFirmwareFile1 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_1), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_1), DateUtils.addDays(new Date(), -2), \"me\");\n         final DeviceFirmwareFile deviceFirmwareFile2 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_2), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_2), DateUtils.addDays(new Date(), -1), \"me\");\n         final List<DeviceFirmwareFile> deviceFirmwareFiles = Arrays.asList(deviceFirmwareFile1, deviceFirmwareFile2);\n         when(this.deviceFirmwareFileRepository.findByDeviceOrderByInstallationDateAsc(any(Device.class)))\n                 .thenReturn(deviceFirmwareFiles);\n+\n         when(this.deviceFirmwareFileRepository.save(any(DeviceFirmwareFile.class))).thenReturn(deviceFirmwareFile1);\n         when(this.manufacturerRepository.findByCode(anyString())).thenReturn(manufacturer);\n         when(this.deviceModelRepository.findByManufacturerAndModelCode(any(Manufacturer.class), anyString()))\n                 .thenReturn(deviceModel);\n     }\n \n     @Test\n-    void testCheckFirmwareHistoryForExistingVersion() throws FunctionalException {\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInHistoryButNotLast() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 1 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_1);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_1);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n \n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistory() throws FunctionalException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2MzY2NQ==", "bodyText": "I don't think firmwareManagementService.handleGetFirmwareVersionResponse() can throw. Can be removed.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498763665", "createdAt": "2020-10-02T11:24:16Z", "author": {"login": "kevinsmeets"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {\n+        // VERSION 1 and VERSION 2 have already been installed previously (in\n+        // that same order)\n         final Manufacturer manufacturer = new Manufacturer(\"code\", \"name\", false);\n         final DeviceModel deviceModel = new DeviceModel(manufacturer, \"modelCode\", \"description\", false);\n         final Device device = this.createDevice(deviceModel);\n         when(this.deviceRepository.findByDeviceIdentification(anyString())).thenReturn(device);\n         final DeviceFirmwareFile deviceFirmwareFile1 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_1), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_1), DateUtils.addDays(new Date(), -2), \"me\");\n         final DeviceFirmwareFile deviceFirmwareFile2 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_2), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_2), DateUtils.addDays(new Date(), -1), \"me\");\n         final List<DeviceFirmwareFile> deviceFirmwareFiles = Arrays.asList(deviceFirmwareFile1, deviceFirmwareFile2);\n         when(this.deviceFirmwareFileRepository.findByDeviceOrderByInstallationDateAsc(any(Device.class)))\n                 .thenReturn(deviceFirmwareFiles);\n+\n         when(this.deviceFirmwareFileRepository.save(any(DeviceFirmwareFile.class))).thenReturn(deviceFirmwareFile1);\n         when(this.manufacturerRepository.findByCode(anyString())).thenReturn(manufacturer);\n         when(this.deviceModelRepository.findByManufacturerAndModelCode(any(Manufacturer.class), anyString()))\n                 .thenReturn(deviceModel);\n     }\n \n     @Test\n-    void testCheckFirmwareHistoryForExistingVersion() throws FunctionalException {\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInHistoryButNotLast() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 1 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_1);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_1);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n \n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistory() throws FunctionalException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjI5Nw=="}, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 153}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTg3NjM0OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwODowNDoxNFrOHbkjpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMToyNDozN1rOHbqIEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjU1MA==", "bodyText": "FunctionalException is not thrown. Just remove", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498672550", "createdAt": "2020-10-02T08:04:14Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {\n+        // VERSION 1 and VERSION 2 have already been installed previously (in\n+        // that same order)\n         final Manufacturer manufacturer = new Manufacturer(\"code\", \"name\", false);\n         final DeviceModel deviceModel = new DeviceModel(manufacturer, \"modelCode\", \"description\", false);\n         final Device device = this.createDevice(deviceModel);\n         when(this.deviceRepository.findByDeviceIdentification(anyString())).thenReturn(device);\n         final DeviceFirmwareFile deviceFirmwareFile1 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_1), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_1), DateUtils.addDays(new Date(), -2), \"me\");\n         final DeviceFirmwareFile deviceFirmwareFile2 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_2), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_2), DateUtils.addDays(new Date(), -1), \"me\");\n         final List<DeviceFirmwareFile> deviceFirmwareFiles = Arrays.asList(deviceFirmwareFile1, deviceFirmwareFile2);\n         when(this.deviceFirmwareFileRepository.findByDeviceOrderByInstallationDateAsc(any(Device.class)))\n                 .thenReturn(deviceFirmwareFiles);\n+\n         when(this.deviceFirmwareFileRepository.save(any(DeviceFirmwareFile.class))).thenReturn(deviceFirmwareFile1);\n         when(this.manufacturerRepository.findByCode(anyString())).thenReturn(manufacturer);\n         when(this.deviceModelRepository.findByManufacturerAndModelCode(any(Manufacturer.class), anyString()))\n                 .thenReturn(deviceModel);\n     }\n \n     @Test\n-    void testCheckFirmwareHistoryForExistingVersion() throws FunctionalException {\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInHistoryButNotLast() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 1 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_1);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_1);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n \n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistory() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 3 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_3);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_3);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n+\n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistoryButNoCorrespondingFirmwareFile()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MzAwNA==", "bodyText": "FunctionalException is not thrown in any of the methods in this test class, so remove it everywhere", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498673004", "createdAt": "2020-10-02T08:05:11Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {\n+        // VERSION 1 and VERSION 2 have already been installed previously (in\n+        // that same order)\n         final Manufacturer manufacturer = new Manufacturer(\"code\", \"name\", false);\n         final DeviceModel deviceModel = new DeviceModel(manufacturer, \"modelCode\", \"description\", false);\n         final Device device = this.createDevice(deviceModel);\n         when(this.deviceRepository.findByDeviceIdentification(anyString())).thenReturn(device);\n         final DeviceFirmwareFile deviceFirmwareFile1 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_1), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_1), DateUtils.addDays(new Date(), -2), \"me\");\n         final DeviceFirmwareFile deviceFirmwareFile2 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_2), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_2), DateUtils.addDays(new Date(), -1), \"me\");\n         final List<DeviceFirmwareFile> deviceFirmwareFiles = Arrays.asList(deviceFirmwareFile1, deviceFirmwareFile2);\n         when(this.deviceFirmwareFileRepository.findByDeviceOrderByInstallationDateAsc(any(Device.class)))\n                 .thenReturn(deviceFirmwareFiles);\n+\n         when(this.deviceFirmwareFileRepository.save(any(DeviceFirmwareFile.class))).thenReturn(deviceFirmwareFile1);\n         when(this.manufacturerRepository.findByCode(anyString())).thenReturn(manufacturer);\n         when(this.deviceModelRepository.findByManufacturerAndModelCode(any(Manufacturer.class), anyString()))\n                 .thenReturn(deviceModel);\n     }\n \n     @Test\n-    void testCheckFirmwareHistoryForExistingVersion() throws FunctionalException {\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInHistoryButNotLast() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 1 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_1);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_1);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n \n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistory() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 3 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_3);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_3);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n+\n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistoryButNoCorrespondingFirmwareFile()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjU1MA=="}, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2Mzc5NQ==", "bodyText": "I don't think firmwareManagementService.handleGetFirmwareVersionResponse() can throw. Can be removed.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498763795", "createdAt": "2020-10-02T11:24:37Z", "author": {"login": "kevinsmeets"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {\n+        // VERSION 1 and VERSION 2 have already been installed previously (in\n+        // that same order)\n         final Manufacturer manufacturer = new Manufacturer(\"code\", \"name\", false);\n         final DeviceModel deviceModel = new DeviceModel(manufacturer, \"modelCode\", \"description\", false);\n         final Device device = this.createDevice(deviceModel);\n         when(this.deviceRepository.findByDeviceIdentification(anyString())).thenReturn(device);\n         final DeviceFirmwareFile deviceFirmwareFile1 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_1), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_1), DateUtils.addDays(new Date(), -2), \"me\");\n         final DeviceFirmwareFile deviceFirmwareFile2 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_2), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_2), DateUtils.addDays(new Date(), -1), \"me\");\n         final List<DeviceFirmwareFile> deviceFirmwareFiles = Arrays.asList(deviceFirmwareFile1, deviceFirmwareFile2);\n         when(this.deviceFirmwareFileRepository.findByDeviceOrderByInstallationDateAsc(any(Device.class)))\n                 .thenReturn(deviceFirmwareFiles);\n+\n         when(this.deviceFirmwareFileRepository.save(any(DeviceFirmwareFile.class))).thenReturn(deviceFirmwareFile1);\n         when(this.manufacturerRepository.findByCode(anyString())).thenReturn(manufacturer);\n         when(this.deviceModelRepository.findByManufacturerAndModelCode(any(Manufacturer.class), anyString()))\n                 .thenReturn(deviceModel);\n     }\n \n     @Test\n-    void testCheckFirmwareHistoryForExistingVersion() throws FunctionalException {\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInHistoryButNotLast() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 1 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_1);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_1);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n \n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistory() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 3 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_3);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_3);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n+\n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistoryButNoCorrespondingFirmwareFile()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjU1MA=="}, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 190}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTg3NjU1OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwODowNDoxOFrOHbkjxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMToyNToxN1rOHbqJHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjU4Mw==", "bodyText": "FunctionalException is not thrown. Just remove", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498672583", "createdAt": "2020-10-02T08:04:18Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {\n+        // VERSION 1 and VERSION 2 have already been installed previously (in\n+        // that same order)\n         final Manufacturer manufacturer = new Manufacturer(\"code\", \"name\", false);\n         final DeviceModel deviceModel = new DeviceModel(manufacturer, \"modelCode\", \"description\", false);\n         final Device device = this.createDevice(deviceModel);\n         when(this.deviceRepository.findByDeviceIdentification(anyString())).thenReturn(device);\n         final DeviceFirmwareFile deviceFirmwareFile1 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_1), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_1), DateUtils.addDays(new Date(), -2), \"me\");\n         final DeviceFirmwareFile deviceFirmwareFile2 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_2), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_2), DateUtils.addDays(new Date(), -1), \"me\");\n         final List<DeviceFirmwareFile> deviceFirmwareFiles = Arrays.asList(deviceFirmwareFile1, deviceFirmwareFile2);\n         when(this.deviceFirmwareFileRepository.findByDeviceOrderByInstallationDateAsc(any(Device.class)))\n                 .thenReturn(deviceFirmwareFiles);\n+\n         when(this.deviceFirmwareFileRepository.save(any(DeviceFirmwareFile.class))).thenReturn(deviceFirmwareFile1);\n         when(this.manufacturerRepository.findByCode(anyString())).thenReturn(manufacturer);\n         when(this.deviceModelRepository.findByManufacturerAndModelCode(any(Manufacturer.class), anyString()))\n                 .thenReturn(deviceModel);\n     }\n \n     @Test\n-    void testCheckFirmwareHistoryForExistingVersion() throws FunctionalException {\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInHistoryButNotLast() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 1 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_1);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_1);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n \n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistory() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 3 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_3);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_3);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n+\n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistoryButNoCorrespondingFirmwareFile()\n+            throws FunctionalException {\n+        // Arrange\n+        // Mock that FUNCTIONAL VERSION 3 and SECURTY VERSION 1 is now\n+        // installed,\n+        // no firmware file will hold this combination, so it will fail to save\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersion firmwareVersion3 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion3);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_3);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_3);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n+\n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, never()).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInAndLast() throws FunctionalException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 230}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc2NDA2MA==", "bodyText": "I don't think firmwareManagementService.handleGetFirmwareVersionResponse() can throw. Can be removed.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498764060", "createdAt": "2020-10-02T11:25:17Z", "author": {"login": "kevinsmeets"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -117,34 +114,187 @@ private FirmwareFile createFirmwareFile(final String version) {\n \n     @BeforeEach\n     void setUp() throws FunctionalException {\n+        // VERSION 1 and VERSION 2 have already been installed previously (in\n+        // that same order)\n         final Manufacturer manufacturer = new Manufacturer(\"code\", \"name\", false);\n         final DeviceModel deviceModel = new DeviceModel(manufacturer, \"modelCode\", \"description\", false);\n         final Device device = this.createDevice(deviceModel);\n         when(this.deviceRepository.findByDeviceIdentification(anyString())).thenReturn(device);\n         final DeviceFirmwareFile deviceFirmwareFile1 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_1), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_1), DateUtils.addDays(new Date(), -2), \"me\");\n         final DeviceFirmwareFile deviceFirmwareFile2 = new DeviceFirmwareFile(device,\n-                this.createFirmwareFile(VERSION_2), new Date(), \"me\");\n+                this.createFirmwareFile(VERSION_2), DateUtils.addDays(new Date(), -1), \"me\");\n         final List<DeviceFirmwareFile> deviceFirmwareFiles = Arrays.asList(deviceFirmwareFile1, deviceFirmwareFile2);\n         when(this.deviceFirmwareFileRepository.findByDeviceOrderByInstallationDateAsc(any(Device.class)))\n                 .thenReturn(deviceFirmwareFiles);\n+\n         when(this.deviceFirmwareFileRepository.save(any(DeviceFirmwareFile.class))).thenReturn(deviceFirmwareFile1);\n         when(this.manufacturerRepository.findByCode(anyString())).thenReturn(manufacturer);\n         when(this.deviceModelRepository.findByManufacturerAndModelCode(any(Manufacturer.class), anyString()))\n                 .thenReturn(deviceModel);\n     }\n \n     @Test\n-    void testCheckFirmwareHistoryForExistingVersion() throws FunctionalException {\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInHistoryButNotLast() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 1 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_1);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_1);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_1);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n \n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistory() throws FunctionalException {\n+        // Arrange\n+        // Mock that VERSION 3 is now installed\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersion firmwareVersion2 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion2);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_3);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_3);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n+\n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, times(1)).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionNotInHistoryButNoCorrespondingFirmwareFile()\n+            throws FunctionalException {\n+        // Arrange\n+        // Mock that FUNCTIONAL VERSION 3 and SECURTY VERSION 1 is now\n+        // installed,\n+        // no firmware file will hold this combination, so it will fail to save\n+        final FirmwareVersionDto firmwareVersionDto1 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.SECURITY, VERSION_3);\n+        final FirmwareVersionDto firmwareVersionDto2 = new FirmwareVersionDto(\n+                org.opensmartgridplatform.dto.valueobjects.FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersionDto> versionsOnDeviceDtos = Arrays.asList(firmwareVersionDto1, firmwareVersionDto2);\n+        final FirmwareVersion firmwareVersion1 = new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1);\n+        final FirmwareVersion firmwareVersion3 = new FirmwareVersion(FirmwareModuleType.FUNCTIONAL, VERSION_3);\n+        final List<FirmwareVersion> versionsOnDevice = Arrays.asList(firmwareVersion1, firmwareVersion3);\n+        final FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"filename\")\n+                .withDescription(\"description\")\n+                .withPushToNewDevices(false)\n+                .build();\n+        final FirmwareModule firmwareModule1 = new FirmwareModule(\n+                FirmwareModuleType.SECURITY.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule1, VERSION_3);\n+        final FirmwareModule firmwareModule2 = new FirmwareModule(\n+                FirmwareModuleType.FUNCTIONAL.getDescription().toLowerCase());\n+        firmwareFile.addFirmwareModule(firmwareModule2, VERSION_3);\n+        when(this.domainCoreMapper.mapAsList(versionsOnDeviceDtos, FirmwareVersion.class)).thenReturn(versionsOnDevice);\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(\"DVC\"))\n+                .thenReturn(Collections.emptyList());\n+        when(this.firmwareFileRepository.findByDeviceModel(any(DeviceModel.class)))\n+                .thenReturn(Arrays.asList(firmwareFile));\n+        final CorrelationIds ids = new CorrelationIds(\"ORG\", \"DVC\", \"CORR\");\n+\n+        // Act\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDeviceDtos, ids, \"FW\", 0,\n+                ResponseMessageResultType.OK, null);\n+\n+        // Validate\n+        verify(this.deviceFirmwareFileRepository, never()).save(any(DeviceFirmwareFile.class));\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseVersionAlreadyInAndLast() throws FunctionalException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY3MjU4Mw=="}, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 230}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTkyODc2OnYy", "diffSide": "RIGHT", "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwODoyMTo0N1rOHblEXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwODoyMTo0N1rOHblEXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4MDkyNQ==", "bodyText": "make private. It is only called from another private method within this class", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/421#discussion_r498680925", "createdAt": "2020-10-02T08:21:47Z", "author": {"login": "joostknapen"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -367,38 +364,159 @@ private void checkFirmwareHistory(final String deviceId,\n         return firmwareVersionsToCheck;\n     }\n \n-    public void tryToAddFirmwareVersionToHistory(final String deviceIdentification,\n-            final FirmwareVersion firmwareVersion) {\n+    /**\n+     * @param deviceId\n+     *            the id of the device we are checking\n+     * @param firmwareVersions\n+     *            the list of firmware modules versions (so type and version) to\n+     *            check if they are currently installed on the device, using the\n+     *            history of the devices firmware history\n+     * @return a list of firmware module versions not present in the the devices\n+     *         firmware history\n+     * @throws FunctionalException\n+     */\n+    public List<FirmwareVersion> checkFirmwareHistoryForModuleVersionsNotCurrentlyInstalled(final String deviceId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95e13cdd9ed85a9403347ebfd29625ae80f2b0ff"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3671, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}