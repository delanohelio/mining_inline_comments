{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NjEyNzQw", "number": 438, "title": "Code quality/increase coverage of firmware management service", "bodyText": "", "createdAt": "2020-09-29T07:16:01Z", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438", "merged": true, "mergeCommit": {"oid": "ac11a18e84428518c7c7071dbe8ce8c5d113fda6"}, "closed": true, "closedAt": "2020-11-27T07:06:04Z", "author": {"login": "andrevanduin"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLVMRogH2gAyNDk0NjEyNzQwOjNiYjJiZTczNWViYjE5NmQxMzhhMDE1ODg5MTc1ZmJlNWZhYmIyNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgiFzDgFqTUzOTc0NjE5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3bb2be735ebb196d138a015889175fbe5fabb24a", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/3bb2be735ebb196d138a015889175fbe5fabb24a", "committedDate": "2020-09-22T10:11:49Z", "message": "Increased coverage for FirmwareManagementService + fixed typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca1e7e9368b53787363d874c19b48fcee328654a", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/ca1e7e9368b53787363d874c19b48fcee328654a", "committedDate": "2020-09-22T10:45:29Z", "message": "Added tests to increase coverage further"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9975f417d2cc43c849d3e7f0a1ce9cdf46210ae5", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/9975f417d2cc43c849d3e7f0a1ce9cdf46210ae5", "committedDate": "2020-09-24T09:46:47Z", "message": "Fixed more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb5bb957c4e034c87d5929493c75e1d718116658", "author": {"user": {"login": "MithraicMagic", "name": "Nick Walraven"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/fb5bb957c4e034c87d5929493c75e1d718116658", "committedDate": "2020-09-24T11:43:31Z", "message": "Merge pull request #2 from OSGP/development\n\nUpdating Fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d55ead2227e47d9004348e5b701ddbf98635972d", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/d55ead2227e47d9004348e5b701ddbf98635972d", "committedDate": "2020-09-24T11:44:30Z", "message": "Merge remote-tracking branch 'origin/development' into code_quality/Increase_coverage_of_FirmwareManagementService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8441c3fcc77090b7a145dc511eba5167ac64381f", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/8441c3fcc77090b7a145dc511eba5167ac64381f", "committedDate": "2020-09-24T13:07:06Z", "message": "Added and cleaned up more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c289d754ddf18482ce27b82d9f0a6d5250dc3a47", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/c289d754ddf18482ce27b82d9f0a6d5250dc3a47", "committedDate": "2020-09-24T14:15:03Z", "message": "fixed whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4af2de58bf144b12bf04ea21cd7fac072b2a9a77", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/4af2de58bf144b12bf04ea21cd7fac072b2a9a77", "committedDate": "2020-09-24T14:16:19Z", "message": "Fixed some more whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f35360526b776bbf06709500767d8fa703f0ddeb", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/f35360526b776bbf06709500767d8fa703f0ddeb", "committedDate": "2020-09-24T14:17:09Z", "message": "Some more whitespace fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df5e6b1095a72488bc000e929a5e0bc618734dbc", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/df5e6b1095a72488bc000e929a5e0bc618734dbc", "committedDate": "2020-09-24T14:19:40Z", "message": "I dislike tabs and spaces :("}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcedf3a858ae5e9804cfc0c55ad219c1dada7de5", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/bcedf3a858ae5e9804cfc0c55ad219c1dada7de5", "committedDate": "2020-10-06T08:18:59Z", "message": "Merge branch 'development' into code_quality/Increase_coverage_of_FirmwareManagementService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzA0ODk0", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#pullrequestreview-502704894", "createdAt": "2020-10-06T08:33:29Z", "commit": {"oid": "bcedf3a858ae5e9804cfc0c55ad219c1dada7de5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2dd7e92a804876e778c991c8fd3c0f6baa66338", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/b2dd7e92a804876e778c991c8fd3c0f6baa66338", "committedDate": "2020-10-06T08:33:33Z", "message": "Fixed duplicate definitions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MTQ4OTUy", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#pullrequestreview-507148952", "createdAt": "2020-10-13T07:38:15Z", "commit": {"oid": "b2dd7e92a804876e778c991c8fd3c0f6baa66338"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNzozODoxNVrOHgZVFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNzo1MTo1MFrOHgZ12Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzczMTQ3Nw==", "bodyText": "very good!", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#discussion_r503731477", "createdAt": "2020-10-13T07:38:15Z", "author": {"login": "robindenadel"}, "path": "osgp/platform/osgp-adapter-domain-core/src/main/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementService.java", "diffHunk": "@@ -145,7 +145,7 @@ private void createSsldPendingFirmwareUpdateRecord(final CorrelationIds ids, fin\n             LOGGER.info(\"Saved pending fimware update record for SSLD: {}, {}\", ids.getDeviceIdentification(),\n                     ssldPendingFirmwareUpdate);\n         } catch (final Exception e) {\n-            LOGGER.error(\"Caugth exception when creating pending firmware update record for SSLD: {}\",\n+            LOGGER.error(\"Caught exception when creating pending firmware update record for SSLD: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2dd7e92a804876e778c991c8fd3c0f6baa66338"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzczMjM4OA==", "bodyText": "indentation not ok, check your IDE settings", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#discussion_r503732388", "createdAt": "2020-10-13T07:39:45Z", "author": {"login": "robindenadel"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -552,4 +582,222 @@ void checkSsldPendingFirmwareUpdateReturnsTrueAndDeletesPendingUpdateWithMatchin\n \n         verify(this.ssldPendingFirmwareUpdateRepository).delete(matchingPendingFirmwareUpdate);\n     }\n+    \n+    \n+    /*\n+     * Returns basic CorrelationIds for simple tests\n+     */\n+    private CorrelationIds getCorrelationIds() {\n+    \tfinal String organisationIdentification = \"test-org\";\n+        final String deviceIdentification = \"device-identification\";\n+        final String correlationUid = \"correlation-uid\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2dd7e92a804876e778c991c8fd3c0f6baa66338"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzczMzMxMQ==", "bodyText": "Since we are going to check for these values in the assert part of the tests, refactor them into constants.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#discussion_r503733311", "createdAt": "2020-10-13T07:41:09Z", "author": {"login": "robindenadel"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -552,4 +582,222 @@ void checkSsldPendingFirmwareUpdateReturnsTrueAndDeletesPendingUpdateWithMatchin\n \n         verify(this.ssldPendingFirmwareUpdateRepository).delete(matchingPendingFirmwareUpdate);\n     }\n+    \n+    \n+    /*\n+     * Returns basic CorrelationIds for simple tests\n+     */\n+    private CorrelationIds getCorrelationIds() {\n+    \tfinal String organisationIdentification = \"test-org\";\n+        final String deviceIdentification = \"device-identification\";\n+        final String correlationUid = \"correlation-uid\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2dd7e92a804876e778c991c8fd3c0f6baa66338"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzczNjgwNA==", "bodyText": "remove public", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#discussion_r503736804", "createdAt": "2020-10-13T07:46:59Z", "author": {"login": "robindenadel"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -552,4 +582,222 @@ void checkSsldPendingFirmwareUpdateReturnsTrueAndDeletesPendingUpdateWithMatchin\n \n         verify(this.ssldPendingFirmwareUpdateRepository).delete(matchingPendingFirmwareUpdate);\n     }\n+    \n+    \n+    /*\n+     * Returns basic CorrelationIds for simple tests\n+     */\n+    private CorrelationIds getCorrelationIds() {\n+    \tfinal String organisationIdentification = \"test-org\";\n+        final String deviceIdentification = \"device-identification\";\n+        final String correlationUid = \"correlation-uid\";\n+    \treturn new CorrelationIds(organisationIdentification, deviceIdentification, correlationUid);\n+    }\n+    \n+    /*\n+     * Returns device of provided class with already mocked IP address \n+     */\n+    private <T> Device getMockDevice(final Class<T> deviceClass) {\n+    \tfinal Device device = (Device) Mockito.mock(deviceClass);\n+    \twhen(device.getIpAddress()).thenReturn(\"0.0.0.0\"); \n+    \treturn device;\n+    }\n+\n+    @Test\n+    void testUpdateFirmwareForNonSsld() throws FunctionalException {\n+        final CorrelationIds ids = this.getCorrelationIds();\n+        final Device device = this.getMockDevice(Device.class);\n+\n+        when(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/firmware-test\");\n+        when(this.deviceDomainService.searchActiveDevice(ids.getDeviceIdentification(), ComponentType.DOMAIN_CORE))\n+            .thenReturn(device);\n+\n+        this.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+\n+        verify(this.osgpCoreRequestMessageSender).sendWithScheduledTime(this.requestMessageCaptor.capture(),\n+                this.messageTypeCaptor.capture(), this.messagePriorityCaptor.capture(), this.ipAddressCaptor.capture(),\n+                this.scheduledTimeCaptor.capture());\n+\n+        final RequestMessage requestMessage = this.requestMessageCaptor.getValue();\n+        final RequestMessage expectedRequestMessage = new RequestMessage(\"correlation-uid\", \"test-org\",\n+            \"device-identification\", null);\n+\n+        assertThat(requestMessage).usingRecursiveComparison().ignoringFields(\"request\").isEqualTo(expectedRequestMessage);\n+    }\n+    \n+    @Test\n+    void testUpdateFirmwareForSsld() throws FunctionalException {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal Device device = this.getMockDevice(Ssld.class);\n+    \tfinal FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"firmware-test\").build();\n+    \tfirmwareFile.addFirmwareModule(new FirmwareModule(\"functional\"), VERSION_1);\n+    \t\n+    \twhen(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/firmware-test\");\n+    \twhen(this.deviceDomainService.searchActiveDevice(ids.getDeviceIdentification(), ComponentType.DOMAIN_CORE))\n+    \t\t.thenReturn(device);\n+    \twhen(this.firmwareFileRepository.findByFilename(\"firmware-test\")).thenReturn(Arrays.asList(firmwareFile));\n+    \t\n+    \tthis.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+\n+    \tverify(this.ssldPendingFirmwareUpdateRepository).save(this.ssldPendingFirmwareUpdateArgumentCaptor.capture());\n+\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate =\n+                this.ssldPendingFirmwareUpdateArgumentCaptor.getValue();\n+        final SsldPendingFirmwareUpdate expectedSsldPendingFirmwareUpdate = new SsldPendingFirmwareUpdate(\n+            \"device-identification\", FirmwareModuleType.FUNCTIONAL, VERSION_1, \"test-org\", \"correlation-uid\"\n+        );\n+\n+        assertThat(ssldPendingFirmwareUpdate).isEqualTo(expectedSsldPendingFirmwareUpdate);\n+    }\n+    \n+    @Test\n+    void testUpdateFirmwareWithNoFirmwareFiles() throws FunctionalException {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal Device device = this.getMockDevice(Ssld.class);\n+    \t\n+    \twhen(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/firmware-test\");\n+    \twhen(this.deviceDomainService.searchActiveDevice(any(), eq(ComponentType.DOMAIN_CORE)))\n+    \t\t.thenReturn(device);\n+    \twhen(this.firmwareFileRepository.findByFilename(\"firmware-test\")).thenReturn(Collections.emptyList());\n+    \t\n+    \tthis.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+\n+        verifyNoInteractions(this.ssldPendingFirmwareUpdateRepository);\n+    }\n+    \n+    @Test\n+    void testUpdateFirmwareWithNoFirmwareModuleVersions() throws FunctionalException {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal Device device = this.getMockDevice(Ssld.class);\n+    \tfinal FirmwareFile firmwareFile = Mockito.mock(FirmwareFile.class);\n+    \tfirmwareFile.addFirmwareModule(new FirmwareModule(\"functional\"), VERSION_1);\n+    \t\n+    \twhen(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/firmware-test\");\n+    \twhen(this.deviceDomainService.searchActiveDevice(any(), eq(ComponentType.DOMAIN_CORE)))\n+    \t\t.thenReturn(device);\n+    \twhen(this.firmwareFileRepository.findByFilename(\"firmware-test\")).thenReturn(Arrays.asList(firmwareFile));\n+    \twhen(firmwareFile.getModuleVersions()).thenReturn(new HashMap<>());\n+    \t\n+    \tthis.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+    \t\n+    \tverifyNoInteractions(this.ssldPendingFirmwareUpdateRepository);\n+    }\n+    \n+    @Test\n+    void testUpdateFirmwareWithIncorrectFirmwareUrl() throws FunctionalException {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal Device device = this.getMockDevice(Ssld.class);\n+    \tfinal FirmwareFile firmwareFile = Mockito.mock(FirmwareFile.class);\n+    \tfirmwareFile.addFirmwareModule(new FirmwareModule(\"functional\"), VERSION_1);\n+    \t\n+    \twhen(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/\");\n+    \twhen(this.deviceDomainService.searchActiveDevice(any(), eq(ComponentType.DOMAIN_CORE)))\n+\t\t\t.thenReturn(device);\n+    \t\n+    \tthis.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+    \t\n+    \tverifyNoInteractions(this.ssldPendingFirmwareUpdateRepository);\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionWithMatchingFirmwareVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2dd7e92a804876e778c991c8fd3c0f6baa66338"}, "originalPosition": 210}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzczOTg2NQ==", "bodyText": "Check for the exception type using either .isInstanceOf in this construction or use assertThatExceptionOfType(<Exception.class>).isThrownBy(() -> {", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#discussion_r503739865", "createdAt": "2020-10-13T07:51:50Z", "author": {"login": "robindenadel"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -552,4 +582,222 @@ void checkSsldPendingFirmwareUpdateReturnsTrueAndDeletesPendingUpdateWithMatchin\n \n         verify(this.ssldPendingFirmwareUpdateRepository).delete(matchingPendingFirmwareUpdate);\n     }\n+    \n+    \n+    /*\n+     * Returns basic CorrelationIds for simple tests\n+     */\n+    private CorrelationIds getCorrelationIds() {\n+    \tfinal String organisationIdentification = \"test-org\";\n+        final String deviceIdentification = \"device-identification\";\n+        final String correlationUid = \"correlation-uid\";\n+    \treturn new CorrelationIds(organisationIdentification, deviceIdentification, correlationUid);\n+    }\n+    \n+    /*\n+     * Returns device of provided class with already mocked IP address \n+     */\n+    private <T> Device getMockDevice(final Class<T> deviceClass) {\n+    \tfinal Device device = (Device) Mockito.mock(deviceClass);\n+    \twhen(device.getIpAddress()).thenReturn(\"0.0.0.0\"); \n+    \treturn device;\n+    }\n+\n+    @Test\n+    void testUpdateFirmwareForNonSsld() throws FunctionalException {\n+        final CorrelationIds ids = this.getCorrelationIds();\n+        final Device device = this.getMockDevice(Device.class);\n+\n+        when(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/firmware-test\");\n+        when(this.deviceDomainService.searchActiveDevice(ids.getDeviceIdentification(), ComponentType.DOMAIN_CORE))\n+            .thenReturn(device);\n+\n+        this.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+\n+        verify(this.osgpCoreRequestMessageSender).sendWithScheduledTime(this.requestMessageCaptor.capture(),\n+                this.messageTypeCaptor.capture(), this.messagePriorityCaptor.capture(), this.ipAddressCaptor.capture(),\n+                this.scheduledTimeCaptor.capture());\n+\n+        final RequestMessage requestMessage = this.requestMessageCaptor.getValue();\n+        final RequestMessage expectedRequestMessage = new RequestMessage(\"correlation-uid\", \"test-org\",\n+            \"device-identification\", null);\n+\n+        assertThat(requestMessage).usingRecursiveComparison().ignoringFields(\"request\").isEqualTo(expectedRequestMessage);\n+    }\n+    \n+    @Test\n+    void testUpdateFirmwareForSsld() throws FunctionalException {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal Device device = this.getMockDevice(Ssld.class);\n+    \tfinal FirmwareFile firmwareFile = new FirmwareFile.Builder().withFilename(\"firmware-test\").build();\n+    \tfirmwareFile.addFirmwareModule(new FirmwareModule(\"functional\"), VERSION_1);\n+    \t\n+    \twhen(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/firmware-test\");\n+    \twhen(this.deviceDomainService.searchActiveDevice(ids.getDeviceIdentification(), ComponentType.DOMAIN_CORE))\n+    \t\t.thenReturn(device);\n+    \twhen(this.firmwareFileRepository.findByFilename(\"firmware-test\")).thenReturn(Arrays.asList(firmwareFile));\n+    \t\n+    \tthis.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+\n+    \tverify(this.ssldPendingFirmwareUpdateRepository).save(this.ssldPendingFirmwareUpdateArgumentCaptor.capture());\n+\n+        final SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate =\n+                this.ssldPendingFirmwareUpdateArgumentCaptor.getValue();\n+        final SsldPendingFirmwareUpdate expectedSsldPendingFirmwareUpdate = new SsldPendingFirmwareUpdate(\n+            \"device-identification\", FirmwareModuleType.FUNCTIONAL, VERSION_1, \"test-org\", \"correlation-uid\"\n+        );\n+\n+        assertThat(ssldPendingFirmwareUpdate).isEqualTo(expectedSsldPendingFirmwareUpdate);\n+    }\n+    \n+    @Test\n+    void testUpdateFirmwareWithNoFirmwareFiles() throws FunctionalException {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal Device device = this.getMockDevice(Ssld.class);\n+    \t\n+    \twhen(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/firmware-test\");\n+    \twhen(this.deviceDomainService.searchActiveDevice(any(), eq(ComponentType.DOMAIN_CORE)))\n+    \t\t.thenReturn(device);\n+    \twhen(this.firmwareFileRepository.findByFilename(\"firmware-test\")).thenReturn(Collections.emptyList());\n+    \t\n+    \tthis.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+\n+        verifyNoInteractions(this.ssldPendingFirmwareUpdateRepository);\n+    }\n+    \n+    @Test\n+    void testUpdateFirmwareWithNoFirmwareModuleVersions() throws FunctionalException {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal Device device = this.getMockDevice(Ssld.class);\n+    \tfinal FirmwareFile firmwareFile = Mockito.mock(FirmwareFile.class);\n+    \tfirmwareFile.addFirmwareModule(new FirmwareModule(\"functional\"), VERSION_1);\n+    \t\n+    \twhen(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/firmware-test\");\n+    \twhen(this.deviceDomainService.searchActiveDevice(any(), eq(ComponentType.DOMAIN_CORE)))\n+    \t\t.thenReturn(device);\n+    \twhen(this.firmwareFileRepository.findByFilename(\"firmware-test\")).thenReturn(Arrays.asList(firmwareFile));\n+    \twhen(firmwareFile.getModuleVersions()).thenReturn(new HashMap<>());\n+    \t\n+    \tthis.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+    \t\n+    \tverifyNoInteractions(this.ssldPendingFirmwareUpdateRepository);\n+    }\n+    \n+    @Test\n+    void testUpdateFirmwareWithIncorrectFirmwareUrl() throws FunctionalException {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal Device device = this.getMockDevice(Ssld.class);\n+    \tfinal FirmwareFile firmwareFile = Mockito.mock(FirmwareFile.class);\n+    \tfirmwareFile.addFirmwareModule(new FirmwareModule(\"functional\"), VERSION_1);\n+    \t\n+    \twhen(this.firmwareUpdateMessageDataContainer.getFirmwareUrl()).thenReturn(\"/\");\n+    \twhen(this.deviceDomainService.searchActiveDevice(any(), eq(ComponentType.DOMAIN_CORE)))\n+\t\t\t.thenReturn(device);\n+    \t\n+    \tthis.firmwareManagementService.updateFirmware(ids, this.firmwareUpdateMessageDataContainer, 0L, \"\", 0);\n+    \t\n+    \tverifyNoInteractions(this.ssldPendingFirmwareUpdateRepository);\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionWithMatchingFirmwareVersion() {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal List<FirmwareVersionDto> firmwareVersionDtos = Arrays.asList();\n+    \t\n+    \tfinal SsldPendingFirmwareUpdate ssldPendingFirmwareUpdate = Mockito.mock(SsldPendingFirmwareUpdate.class);\n+    \tfinal List<SsldPendingFirmwareUpdate> ssldPendingFirmwareUpdates = Arrays.asList(ssldPendingFirmwareUpdate);\n+    \t\n+    \twhen(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(any(String.class)))\n+       \t\t.thenReturn(ssldPendingFirmwareUpdates);\n+    \twhen(ssldPendingFirmwareUpdate.getCorrelationUid()).thenReturn(ids.getCorrelationUid());\n+    \twhen(ssldPendingFirmwareUpdate.getFirmwareModuleType()).thenReturn(FirmwareModuleType.SECURITY);\n+    \twhen(ssldPendingFirmwareUpdate.getFirmwareVersion()).thenReturn(VERSION_1);\n+    \twhen(this.domainCoreMapper.mapAsList(firmwareVersionDtos, FirmwareVersion.class)).thenReturn(\n+\t\t   \tArrays.asList(new FirmwareVersion(FirmwareModuleType.SECURITY, VERSION_1))\n+\t\t);\n+\n+    \tthis.firmwareManagementService.handleGetFirmwareVersionResponse(firmwareVersionDtos, ids, \"messageType\", 1, \n+    \t\t\tResponseMessageResultType.OK, null);\n+\n+    \tverifyNoInteractions(this.webServiceResponseMessageSender);\n+    \tverify(this.ssldPendingFirmwareUpdateRepository).delete(any());\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionResponseNotOk() {\n+    \tfinal CorrelationIds ids = this.getCorrelationIds();\n+    \tfinal List<FirmwareVersionDto> versionsOnDevice = new ArrayList<>();\n+    \t\n+    \tthis.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDevice, ids, \"messageType\", 1,\n+    \t\t\tResponseMessageResultType.NOT_OK, null);\n+\n+    \tverify(this.webServiceResponseMessageSender).send(this.responseMessageCaptor.capture());\n+\n+    \tfinal ResponseMessage responseMessage = this.responseMessageCaptor.getValue();\n+\n+    \tassertThat(responseMessage.getResult()).isEqualTo(ResponseMessageResultType.NOT_OK);\n+    \tassertThat(responseMessage.getOsgpException().getMessage())\n+                .isEqualTo(\"Exception occurred while getting device firmware version\");\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionErrorNotNull() {\n+        final CorrelationIds ids = this.getCorrelationIds();\n+        final List<FirmwareVersionDto> versionsOnDevice = new ArrayList<>();\n+\n+        this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDevice, ids, \"messageType\", 1,\n+            ResponseMessageResultType.OK, this.defaultException);\n+\n+        verify(this.webServiceResponseMessageSender).send(this.responseMessageCaptor.capture());\n+        verify(this.ssldPendingFirmwareUpdateRepository, never()).delete(any());\n+\n+        final ResponseMessage responseMessage = this.responseMessageCaptor.getValue();\n+        final ResponseMessage expectedResponseMessage = ResponseMessage.newResponseMessageBuilder()\n+            .withIds(ids)\n+            .withResult(ResponseMessageResultType.NOT_OK)\n+            .withOsgpException(new TechnicalException(\"Exception occurred while getting device firmware version\"))\n+            .withMessagePriority(1)\n+            .build();\n+\n+        assertThat(responseMessage).usingRecursiveComparison().ignoringFields(\"dataObject\").isEqualTo(expectedResponseMessage);\n+    }\n+\n+    @Test\n+    public void testHandleGetFirmwareVersionWithPendingUpdateIsNull() {\n+        final CorrelationIds ids = this.getCorrelationIds();\n+        final List<FirmwareVersionDto> versionsOnDevice = new ArrayList<>();\n+\n+        when(this.ssldPendingFirmwareUpdateRepository.findByDeviceIdentification(any())).thenReturn(null);\n+\n+        assertThatThrownBy(() -> {\n+            this.firmwareManagementService.handleGetFirmwareVersionResponse(versionsOnDevice, ids, \"messageType\", 1,\n+                    ResponseMessageResultType.OK, null);\n+        }).hasMessage(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2dd7e92a804876e778c991c8fd3c0f6baa66338"}, "originalPosition": 282}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ef02154cf24f58b72131a3a2c4c5489603df6b0", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/3ef02154cf24f58b72131a3a2c4c5489603df6b0", "committedDate": "2020-10-13T14:05:00Z", "message": "Fixed identation, added constants and removed public"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MDQxODE1", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#pullrequestreview-526041815", "createdAt": "2020-11-09T08:59:09Z", "commit": {"oid": "3ef02154cf24f58b72131a3a2c4c5489603df6b0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo1OTowOVrOHvkrAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo1OTowOVrOHvkrAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0NTk1Mw==", "bodyText": "constants should be static\nConstants should be all uppercase with words separated by underscores, see https://www.oracle.com/java/technologies/javase/codeconventions-namingconventions.html", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#discussion_r519645953", "createdAt": "2020-11-09T08:59:09Z", "author": {"login": "robindenadel"}, "path": "osgp/platform/osgp-adapter-domain-core/src/test/java/org/opensmartgridplatform/adapter/domain/core/application/services/FirmwareManagementServiceTest.java", "diffHunk": "@@ -72,6 +82,32 @@\n     private static final String VERSION_1 = \"R01\";\n     private static final String VERSION_2 = \"R02\";\n     private static final String VERSION_3 = \"R03\";\n+\n+    private final String organisationIdentification = \"test-org\";\n+    private final String deviceIdentification = \"device-identification\";\n+    private final String correlationUid = \"correlation-uid\";\n+    private final CorrelationIds correlationIds = new CorrelationIds(this.organisationIdentification,\n+            this.deviceIdentification, this.correlationUid);\n+\n+    private final OsgpException defaultException = new OsgpException(ComponentType.DOMAIN_CORE, \"test\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ef02154cf24f58b72131a3a2c4c5489603df6b0"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87aa724a72552331335dca57c6887e040541a8a3", "author": {"user": {"login": "andrevanduin", "name": "Cesar Pulles"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/87aa724a72552331335dca57c6887e040541a8a3", "committedDate": "2020-11-17T13:59:19Z", "message": "Implementing reviewed changes and tried to fix indentation errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NzQ2MTk3", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/438#pullrequestreview-539746197", "createdAt": "2020-11-27T07:05:55Z", "commit": {"oid": "87aa724a72552331335dca57c6887e040541a8a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3647, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}