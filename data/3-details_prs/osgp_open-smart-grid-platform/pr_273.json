{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwODQ2MDg1", "number": 273, "title": "Feature/flex 5299 protocol adapter iec60870 general interrogation", "bodyText": "", "createdAt": "2020-04-08T13:24:09Z", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273", "merged": true, "mergeCommit": {"oid": "7ab897c0c0d70e9aab1b31215d4d43c181db9ef3"}, "closed": true, "closedAt": "2020-04-17T13:57:50Z", "author": {"login": "smvdheijden"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcStzVVgH2gAyNDAwODQ2MDg1OjhjOTBhMzM1OWI5ZDViMzQ5NDA2ZDcwZmQ5Mjg1N2JiOTQxNDBlODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYhH0GAFqTM5NTQ0MjcyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c90a3359b9d5b349406d70fd92857bb94140e83", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/8c90a3359b9d5b349406d70fd92857bb94140e83", "committedDate": "2020-03-30T12:38:31Z", "message": "Updates pom files for JDK11 compliancy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a57f5e56f5ba564ea3275cd8b69a513ad07613e0", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/a57f5e56f5ba564ea3275cd8b69a513ad07613e0", "committedDate": "2020-03-30T12:54:31Z", "message": "Updates some poms to fix sonar rule about order of pom elements\n\n\"pom elements should be in the recommended order (squid:S3423)\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09a27a249541a6c197332d7c5576d1d6fcacdfdf", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/09a27a249541a6c197332d7c5576d1d6fcacdfdf", "committedDate": "2020-04-03T12:17:14Z", "message": "FLEX-5299 ~ Adds initial implementation for general interrogation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d020d030eae29f8feb4faee9adee5564b087861", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/5d020d030eae29f8feb4faee9adee5564b087861", "committedDate": "2020-04-03T12:18:16Z", "message": "FLEX-5299 ~ Adds DTOs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9047962c1b6f463d22785bf51e7b3b88ecd90041", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/9047962c1b6f463d22785bf51e7b3b88ecd90041", "committedDate": "2020-04-07T14:03:22Z", "message": "FLEX-5299 ~ Refactors protocol adapter\n\nUse a single set of ASDU handlers for all device types,\nhandle measurement reports by device specific service classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd20e1347830f6510562e8e4c01cd029b7dff2e0", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/fd20e1347830f6510562e8e4c01cd029b7dff2e0", "committedDate": "2020-04-08T13:19:04Z", "message": "FLEX-5299 ~ Implements get light sensor status in iec60870 protocol adapter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a2c2eebb3b745718bce3e233037ffdbaaeeac2", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/b4a2c2eebb3b745718bce3e233037ffdbaaeeac2", "committedDate": "2020-04-08T13:20:33Z", "message": "Merge branch 'development' into feature/FLEX-5299-protocol-adapter-iec60870-general-interrogation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a7acd7db81de20ea9049018b70110bdcd062039", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/3a7acd7db81de20ea9049018b70110bdcd062039", "committedDate": "2020-04-08T13:58:58Z", "message": "FLEX-5299 ~ Fixes two sonar issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec6d2658503c47a8ed7abf5000fd7a81f813951d", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/ec6d2658503c47a8ed7abf5000fd7a81f813951d", "committedDate": "2020-04-08T14:20:04Z", "message": "Merge branch 'development' into feature/FLEX-5299-protocol-adapter-iec60870-general-interrogation\n\nosgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/config/TestConfiguration.java\nosgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientAsduHandlerImpl.java\nosgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionEventListener.java\nosgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionEventListenerTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/fe0b7ca82a87fe498e297f0643379226e04bdc57", "committedDate": "2020-04-08T14:47:40Z", "message": "FLEX-5299 ~ Adds db migration script for new Iec60870Device fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTk5MTc1", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#pullrequestreview-390199175", "createdAt": "2020-04-08T17:50:54Z", "commit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 62, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzo1MDo1NFrOGC6UVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjoyMDo1MlrOGFWoKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwNTgxMw==", "bodyText": "Any reason this is not private, like the other fields?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r405705813", "createdAt": "2020-04-08T17:50:54Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/TestContextConfiguration.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests;\n+\n+import static org.mockito.Mockito.reset;\n+\n+import org.openmuc.j60870.Connection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.DeviceResponseMessageSender;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.LogItemRequestMessageSender;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config.InboundRequestsTestConfiguration;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config.LogItemTestConfiguration;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config.OutboundResponsesTestConfiguration;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config.TestConfiguration;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.test.context.ContextConfiguration;\n+\n+import io.cucumber.java.Before;\n+\n+@ContextConfiguration(classes = { TestConfiguration.class, InboundRequestsTestConfiguration.class,\n+        OutboundResponsesTestConfiguration.class, LogItemTestConfiguration.class })\n+public class TestContextConfiguration {\n+\n+    @Autowired\n+    LogItemRequestMessageSender logItemRequestMessageSenderMock;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMDU3OQ==", "bodyText": "I know it would not look very nice, but wouldn't it be more logical if this was named getGetHealthStatusRequestMessageProcessor? (Same for the GetLightSensorStatusRequestMessageProcessor bean below.)\nIf it was a conscious decision not to use getGet, you can leave it as is I guess.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r405710579", "createdAt": "2020-04-08T17:58:56Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/config/InboundRequestsTestConfiguration.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.config;\n+\n+import static org.mockito.Mockito.mock;\n+\n+import javax.jms.ConnectionFactory;\n+\n+import org.apache.activemq.jms.pool.PooledConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.DeviceRequestMessageListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors.ConnectRequestMessageProcessor;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors.GetHealthStatusRequestMessageProcessor;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors.GetLightSensorStatusRequestMessageProcessor;\n+import org.opensmartgridplatform.shared.infra.jms.BaseMessageProcessorMap;\n+import org.opensmartgridplatform.shared.infra.jms.MessageProcessorMap;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+\n+@Configuration\n+public class InboundRequestsTestConfiguration {\n+\n+    @Bean(name = \"protocolIec60870InboundOsgpCoreRequestsConnectionFactory\")\n+    public ConnectionFactory iec60870RequestsConnectionFactory() {\n+        return mock(PooledConnectionFactory.class);\n+    }\n+\n+    @Bean(name = \"protocolIec60870InboundOsgpCoreRequestsMessageListener\")\n+    public DeviceRequestMessageListener iec60870RequestsMessageListener() {\n+        return new DeviceRequestMessageListener();\n+    }\n+\n+    @Bean(name = \"protocolIec60870InboundOsgpCoreRequestsMessageProcessorMap\")\n+    public MessageProcessorMap iec60870RequestMessageProcessorMap() {\n+        return new BaseMessageProcessorMap(\"protocolIec60870InboundOsgpCoreRequestsMessageProcessorMap\");\n+    }\n+\n+    @Bean\n+    public ConnectRequestMessageProcessor connectRequestMessageProcessor() {\n+        return new ConnectRequestMessageProcessor();\n+    }\n+\n+    @Bean\n+    public GetHealthStatusRequestMessageProcessor getHealthStatusRequestMessageProcessor() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxOTExNw==", "bodyText": "This works fine, but given this class already uses Cucumber expressions, I'd favor those over regex configuration unless there is a clear advantage to using the regex.\nYou could consider dropping the ^, $ and replacing the part after device with {string} like in the whenIReceiveAduOfType step.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r405719117", "createdAt": "2020-04-08T18:13:35Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/AsduSteps.java", "diffHunk": "@@ -30,4 +43,16 @@ public void whenIReceiveAsduOfType(final String asduType) {\n         final ASdu asdu = AsduFactory.ofType(ASduType.valueOf(asduType));\n         this.connectionSteps.getConnectionEventListener().newASdu(asdu);\n     }\n+\n+    @Then(\"^I should send a general interrogation command to device \\\"([^\\\"]*)\\\"$\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcyODQyNQ==", "bodyText": "I am not to fond of the duplication of the step description and debug logging it by default in every step.\nIt looks like just extra maintenance, adding it, and keeping it in sync when the step is refactored (or going out of sync and appearing sloppy).\nIf we deem it valuable to debug log every step in this kind of manner, it might be more opportune to look into Cucumber reporting, which allows creation of reporting plugins where you can intercept events (which include step related events, see for instance io.cucumber.plugin.EventListener, io.cucumber.plugin.event,TestStepStarted and the data it gives access to).", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r405728425", "createdAt": "2020-04-08T18:29:15Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/AsduSteps.java", "diffHunk": "@@ -30,4 +43,16 @@ public void whenIReceiveAsduOfType(final String asduType) {\n         final ASdu asdu = AsduFactory.ofType(ASduType.valueOf(asduType));\n         this.connectionSteps.getConnectionEventListener().newASdu(asdu);\n     }\n+\n+    @Then(\"^I should send a general interrogation command to device \\\"([^\\\"]*)\\\"$\")\n+    public void thenIShouldSendAGeneralInterrogationCommandToDevice(final String deviceIdentification)\n+            throws Exception {\n+        LOGGER.debug(\"Then I should send a general interrogation command to device {}\", deviceIdentification);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIxNjI0Ng==", "bodyText": "This certainly works, and if it is the only place a DeviceType is created from a step argument it is OK.\nI was wondering if it would not be nicer to use a Cucumber custom parameter type in such cases (documented somewhere under Cucumber expressions, and under Configuration with the type registry in the documentation for Cucumber).\nNo need to change the code, but I wanted to make sure you know the alternative mentioned here is available.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406216246", "createdAt": "2020-04-09T13:47:01Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/ConnectionSteps.java", "diffHunk": "@@ -82,26 +84,43 @@ public void givenIec60870DeviceIsNotConnected() throws ConnectionFailureExceptio\n                 .thenReturn(deviceConnection);\n     }\n \n-    @Given(\"an existing connection with an IEC60870 device\")\n-    public void givenIec60870DeviceIsConnected() throws ClientConnectionAlreadyInCacheException {\n-        LOGGER.debug(\"Given IEC60870 device is connected\");\n-\n+    @Given(\"an existing connection with IEC60870 device {string} of type {string}\")\n+    public void givenIec60870DeviceIsConnected(final String deviceIdentification, final String typeOfDevice)\n+            throws Exception {\n+        LOGGER.debug(\"Given an existing connection with IEC60870 device {} of type {}\", deviceIdentification,\n+                typeOfDevice);\n+        final DeviceType deviceType = DeviceType.valueOf(typeOfDevice);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIyMjc1Mg==", "bodyText": "I was confused a bit between device and identification in the code that follows with connectionDevice and getGatewayDeviceIndentification().\nIt seems clearer to use something like connectionDeviceIdentification (or maybe even better, gatewayDeviceIdentification) to indicate this is not a device, but just the identification.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406222752", "createdAt": "2020-04-09T13:56:17Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/ConnectionSteps.java", "diffHunk": "@@ -82,26 +84,43 @@ public void givenIec60870DeviceIsNotConnected() throws ConnectionFailureExceptio\n                 .thenReturn(deviceConnection);\n     }\n \n-    @Given(\"an existing connection with an IEC60870 device\")\n-    public void givenIec60870DeviceIsConnected() throws ClientConnectionAlreadyInCacheException {\n-        LOGGER.debug(\"Given IEC60870 device is connected\");\n-\n+    @Given(\"an existing connection with IEC60870 device {string} of type {string}\")\n+    public void givenIec60870DeviceIsConnected(final String deviceIdentification, final String typeOfDevice)\n+            throws Exception {\n+        LOGGER.debug(\"Given an existing connection with IEC60870 device {} of type {}\", deviceIdentification,\n+                typeOfDevice);\n+        final DeviceType deviceType = DeviceType.valueOf(typeOfDevice);\n         // Make sure the connection event listener works as expected\n-        final ResponseMetadata responseMetadata = new ResponseMetadata.Builder()\n-                .withDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION)\n-                .withOrganisationIdentification(DEFAULT_ORGANISATION_IDENTIFICATION)\n-                .withDomainInfo(new DomainInfo(DEFAULT_DOMAIN, DEFAULT_DOMAIN_VERSION))\n-                .withMessageType(DEFAULT_MESSAGE_TYPE)\n-                .build();\n+        this.connectionParameters = this.initConnectionParameters(deviceIdentification);\n+        final ResponseMetadata responseMetadata = this.initResponseMetadata(deviceIdentification, deviceType);\n         this.connectionEventListener = new ClientConnectionEventListener(\n                 this.connectionParameters.getDeviceIdentification(), this.connectionCacheSpy,\n                 this.clientAsduHandlerRegistry, responseMetadata);\n \n         // Make sure a connection could be retrieved from the cache\n         // Only needed for scenarios sending requests to a device\n-        final Connection connection = mock(Connection.class);\n-        this.connectionCacheSpy.addConnection(DEFAULT_DEVICE_IDENTIFICATION,\n-                new DeviceConnection(connection, this.connectionParameters));\n+        // final Connection connection = mock(Connection.class);\n+        this.connectionCacheSpy.addConnection(deviceIdentification,\n+                new DeviceConnection(this.connection, this.connectionParameters));\n+    }\n+\n+    @When(\"I connect to IEC60870 device {string}\")\n+    public void whenIConnectToIEC60870Device(final String deviceIdentification) throws Exception {\n+        LOGGER.debug(\"When I connect to IEC60870 device {}\", deviceIdentification);\n+        final Iec60870Device device = this.iec60870DeviceSteps.getDevice(deviceIdentification)\n+                .orElseThrow(() -> new Exception(\"Device not found\"));\n+        final DeviceType deviceType = device.getDeviceType();\n+        String connectionDevice = deviceIdentification;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzMTc3Ng==", "bodyText": "The common address, IP address and the port appear not to be important information for understanding the test, as they are tucked away here. Besides that, they are the default values in the ConnectionParameters Builder.\nDefaults in the Builder are fine, but I think they should not be repeated elsewhere unless there is a good reason to do so.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406231776", "createdAt": "2020-04-09T14:09:10Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/ConnectionSteps.java", "diffHunk": "@@ -117,4 +136,30 @@ public void thenIShouldCacheConnection() throws ClientConnectionAlreadyInCacheEx\n     public ConnectionEventListener getConnectionEventListener() {\n         return this.connectionEventListener;\n     }\n+\n+    private ConnectionParameters initConnectionParameters(final String deviceIdentification) {\n+        return new ConnectionParameters.Builder().commonAddress(0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNDc4OQ==", "bodyText": "Initially I thought why 2019? But then I saw this is moved here from ContextConfigurationSteps.\nIt looks like it has landed in a better place here.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406234789", "createdAt": "2020-04-09T14:13:28Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/TestContextConfiguration.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTM0Mg==", "bodyText": "Is it necessary to use a DataTable argument and call asMaps?\nWith a simple List it is not, and I would expect things to work if the parameter was something like List<Map<String, String>> deviceRows instead.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406241342", "createdAt": "2020-04-09T14:22:51Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/Iec60870DeviceSteps.java", "diffHunk": "@@ -25,6 +33,37 @@\n     @Given(\"an IEC60870 device\")\n     public void givenIec60870Device() {\n         final Iec60870Device device = Iec60870DeviceFactory.createDefaultWith(DEFAULT_DEVICE_IDENTIFICATION);\n-        when(this.repositoryMock.findByDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION)).thenReturn(device);\n+        when(this.repositoryMock.findByDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION))\n+                .thenReturn(Optional.of(device));\n+    }\n+\n+    @Given(\"IEC60870 devices\")\n+    public void givenIec60870Devices(final DataTable dataTable) {\n+\n+        final List<Map<String, String>> rows = dataTable.asMaps();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0NDIwNQ==", "bodyText": "I wouldn't use i here instead of invocation. The latter is clearer, and the single character is mostly used for integer index values.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406244205", "createdAt": "2020-04-09T14:26:45Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/Iec60870DeviceSteps.java", "diffHunk": "@@ -25,6 +33,37 @@\n     @Given(\"an IEC60870 device\")\n     public void givenIec60870Device() {\n         final Iec60870Device device = Iec60870DeviceFactory.createDefaultWith(DEFAULT_DEVICE_IDENTIFICATION);\n-        when(this.repositoryMock.findByDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION)).thenReturn(device);\n+        when(this.repositoryMock.findByDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION))\n+                .thenReturn(Optional.of(device));\n+    }\n+\n+    @Given(\"IEC60870 devices\")\n+    public void givenIec60870Devices(final DataTable dataTable) {\n+\n+        final List<Map<String, String>> rows = dataTable.asMaps();\n+\n+        final List<Iec60870Device> devices = new ArrayList<>();\n+\n+        for (final Map<String, String> colums : rows) {\n+            final Iec60870Device device = Iec60870DeviceFactory.fromSettings(colums);\n+            when(this.repositoryMock.findByDeviceIdentification(device.getDeviceIdentification()))\n+                    .thenReturn(Optional.of(device));\n+            devices.add(device);\n+        }\n+\n+        when(this.repositoryMock.findByGatewayDeviceIdentification(anyString()))\n+                .thenAnswer(i -> this.getDevicesForGateway(i.getArgument(0), devices));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1MTQxMw==", "bodyText": "Missing license header.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406251413", "createdAt": "2020-04-09T14:36:40Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NTA0NA==", "bodyText": "I think I am not so happy with this name. Mocking is a technique in the implementation of the tests and should not be essential to a step class, in that it is included in its name.\nI am guessing based on what I see in this class, and suspect something like ControlledStationSteps or Iec60870ServerSteps better fits what these steps have to offer.\nJust let me know if this is indeed the case, or if I am missing something.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406255044", "createdAt": "2020-04-09T14:41:43Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2Mzk5MA==", "bodyText": "I have some questions here. Mostly for my own understanding. Only cause for change (now or later) if it makes sense.\nIs the ProcessImage here a class that represents all/some of the information stored on a device.\nIf so, then maybe not now, but very soon it will possibly be convenient to have it accessible broader than here.\nSomething else I was thinking about (if my earlier assumptions are correct) is if it would make sense to split this method up, where givenAProcessImageOnTheControlledStation sets up the data for a controlled station and other methods determine what happens when some or all of this information is requested (something like a when step whenAGeneralInterrogationCommandIsReceived).", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406263990", "createdAt": "2020-04-09T14:53:38Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {\n+    @Autowired\n+    private ConnectionSteps connectionSteps;\n+\n+    @Autowired\n+    private Connection connection;\n+\n+    @Given(\"a process image on the controlled station\")\n+    public void givenAProcessImageOnTheControlledStation(final DataTable datatable) throws Throwable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2NzQwNQ==", "bodyText": "Now this helper method is tied to mockito by the invocation parameter. It could be easier to allow forms of reuse if the mockito stuff was kept together inside the step method. It feels cleaner if the commonAddress and qualifer were arguments of a method like this one instead of the invocation.\nThe method now only makes sense and can only be properly understood when looked at in combination with the method it is called from.\nJust see how you feel about this, to judge whether to leave it as is, or refactor it.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406267405", "createdAt": "2020-04-09T14:58:08Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {\n+    @Autowired\n+    private ConnectionSteps connectionSteps;\n+\n+    @Autowired\n+    private Connection connection;\n+\n+    @Given(\"a process image on the controlled station\")\n+    public void givenAProcessImageOnTheControlledStation(final DataTable datatable) throws Throwable {\n+\n+        final ProcessImage processImage = ProcessImage.fromDataTable(datatable);\n+\n+        doAnswer(invocation -> this.sendInterrogationResponse(invocation, processImage)).when(this.connection)\n+                .interrogation(any(Integer.class), eq(CauseOfTransmission.ACTIVATION),\n+                        any(IeQualifierOfInterrogation.class));\n+    }\n+\n+    private Object sendInterrogationResponse(final InvocationOnMock invocation, final ProcessImage processImage) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3NzI5Nw==", "bodyText": "Same as earlier, I wonder if it would not be cleaner to put some more distance between the Cucumber DataTable and the ProcessImage. If I was correct earlier the step parameter could be changed from DataTable to a list of maps, breaking this dependency, and avoiding the code to explicitly go from data table to list of maps.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406277297", "createdAt": "2020-04-09T15:12:28Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {\n+    @Autowired\n+    private ConnectionSteps connectionSteps;\n+\n+    @Autowired\n+    private Connection connection;\n+\n+    @Given(\"a process image on the controlled station\")\n+    public void givenAProcessImageOnTheControlledStation(final DataTable datatable) throws Throwable {\n+\n+        final ProcessImage processImage = ProcessImage.fromDataTable(datatable);\n+\n+        doAnswer(invocation -> this.sendInterrogationResponse(invocation, processImage)).when(this.connection)\n+                .interrogation(any(Integer.class), eq(CauseOfTransmission.ACTIVATION),\n+                        any(IeQualifierOfInterrogation.class));\n+    }\n+\n+    private Object sendInterrogationResponse(final InvocationOnMock invocation, final ProcessImage processImage) {\n+        final int commonAddress = invocation.getArgument(0);\n+        final IeQualifierOfInterrogation qualifier = invocation.getArgument(2);\n+\n+        final ConnectionEventListener listener = this.connectionSteps.getConnectionEventListener();\n+        listener.newASdu(this.interrogationActivationConfirmationAsdu(commonAddress, qualifier));\n+        for (final ASdu asdu : processImage.toInterrogationAsdus(commonAddress, qualifier)) {\n+            listener.newASdu(asdu);\n+        }\n+        listener.newASdu(this.interrogationActivationTerminationAsdu(commonAddress, qualifier));\n+        return null;\n+    }\n+\n+    private ASdu interrogationActivationConfirmationAsdu(final int commonAddress,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return this.interrogationAsdu(commonAddress, CauseOfTransmission.ACTIVATION_CON, qualifier);\n+    }\n+\n+    private ASdu interrogationActivationTerminationAsdu(final int commonAddress,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return this.interrogationAsdu(commonAddress, CauseOfTransmission.ACTIVATION_TERMINATION, qualifier);\n+    }\n+\n+    private ASdu interrogationAsdu(final int commonAddress, final CauseOfTransmission cot,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return new ASdu(ASduType.C_IC_NA_1, false, cot, false, false, 0, commonAddress,\n+                new InformationObject(0, qualifier));\n+    }\n+\n+    private static class ProcessImage {\n+        private final List<InformationObject> image;\n+\n+        private ProcessImage(final List<InformationObject> image) {\n+            this.image = image;\n+        }\n+\n+        public static ProcessImage fromDataTable(final DataTable datatable) {\n+\n+            final List<Map<String, String>> rows = datatable.asMaps();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3ODc2Mg==", "bodyText": "This should either be un-commented and used, or removed.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406278762", "createdAt": "2020-04-09T15:14:33Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/MockedDeviceSteps.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.integrationtests.steps;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.mockito.invocation.InvocationOnMock;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.datatable.DataTable;\n+import io.cucumber.java.en.Given;\n+\n+public class MockedDeviceSteps {\n+    @Autowired\n+    private ConnectionSteps connectionSteps;\n+\n+    @Autowired\n+    private Connection connection;\n+\n+    @Given(\"a process image on the controlled station\")\n+    public void givenAProcessImageOnTheControlledStation(final DataTable datatable) throws Throwable {\n+\n+        final ProcessImage processImage = ProcessImage.fromDataTable(datatable);\n+\n+        doAnswer(invocation -> this.sendInterrogationResponse(invocation, processImage)).when(this.connection)\n+                .interrogation(any(Integer.class), eq(CauseOfTransmission.ACTIVATION),\n+                        any(IeQualifierOfInterrogation.class));\n+    }\n+\n+    private Object sendInterrogationResponse(final InvocationOnMock invocation, final ProcessImage processImage) {\n+        final int commonAddress = invocation.getArgument(0);\n+        final IeQualifierOfInterrogation qualifier = invocation.getArgument(2);\n+\n+        final ConnectionEventListener listener = this.connectionSteps.getConnectionEventListener();\n+        listener.newASdu(this.interrogationActivationConfirmationAsdu(commonAddress, qualifier));\n+        for (final ASdu asdu : processImage.toInterrogationAsdus(commonAddress, qualifier)) {\n+            listener.newASdu(asdu);\n+        }\n+        listener.newASdu(this.interrogationActivationTerminationAsdu(commonAddress, qualifier));\n+        return null;\n+    }\n+\n+    private ASdu interrogationActivationConfirmationAsdu(final int commonAddress,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return this.interrogationAsdu(commonAddress, CauseOfTransmission.ACTIVATION_CON, qualifier);\n+    }\n+\n+    private ASdu interrogationActivationTerminationAsdu(final int commonAddress,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return this.interrogationAsdu(commonAddress, CauseOfTransmission.ACTIVATION_TERMINATION, qualifier);\n+    }\n+\n+    private ASdu interrogationAsdu(final int commonAddress, final CauseOfTransmission cot,\n+            final IeQualifierOfInterrogation qualifier) {\n+        return new ASdu(ASduType.C_IC_NA_1, false, cot, false, false, 0, commonAddress,\n+                new InformationObject(0, qualifier));\n+    }\n+\n+    private static class ProcessImage {\n+        private final List<InformationObject> image;\n+\n+        private ProcessImage(final List<InformationObject> image) {\n+            this.image = image;\n+        }\n+\n+        public static ProcessImage fromDataTable(final DataTable datatable) {\n+\n+            final List<Map<String, String>> rows = datatable.asMaps();\n+\n+            final List<InformationObject> informationObjects = rows.stream()\n+                    .map(ProcessImage::informationObject)\n+                    .collect(Collectors.toList());\n+            return new ProcessImage(informationObjects);\n+        }\n+\n+        public List<ASdu> toInterrogationAsdus(final int commonAddress, final IeQualifierOfInterrogation qualifier) {\n+            final CauseOfTransmission cot = CauseOfTransmission.causeFor(qualifier.getValue());\n+            final List<ASdu> asdus = new ArrayList<>();\n+            asdus.add(new ASdu(ASduType.M_SP_NA_1, true, cot, false, false, 0, commonAddress,\n+                    this.image.toArray(new InformationObject[0])));\n+            return asdus;\n+        }\n+\n+        public static InformationObject informationObject(final Map<String, String> map) {\n+            final int informationObjectAddress = Integer.parseInt(map.getOrDefault(\"information_object_address\", \"0\"));\n+            // final String informationObjectType =\n+            // map.get(\"information_object_type\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4NTc1Nw==", "bodyText": "Not regarding the changes from this pull request, but the name request steps had me confused until I looked more into the code. Request is so general it could have just as well been a request to a device. Perhaps the longer name OsgpCoreRequestSteps is a clearer alternative. (Something similar could be said for the ResponseSteps I suppose.)", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406285757", "createdAt": "2020-04-09T15:24:55Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/RequestSteps.java", "diffHunk": "@@ -14,13 +14,18 @@\n import javax.jms.ObjectMessage;\n \n import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.DeviceRequestMessageListener;\n+import org.opensmartgridplatform.dto.da.ConnectRequestDto;\n import org.opensmartgridplatform.dto.da.GetHealthStatusRequestDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n import org.opensmartgridplatform.shared.infra.jms.ObjectMessageBuilder;\n import org.springframework.beans.factory.annotation.Autowired;\n \n import io.cucumber.java.en.When;\n \n public class RequestSteps {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxMDM5OQ==", "bodyText": "Indent with spaces.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406310399", "createdAt": "2020-04-09T16:01:19Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/resources/features/GeneralInterrogation.feature", "diffHunk": "@@ -0,0 +1,31 @@\n+Feature: General Interrogation\n+  As controlling station\n+  I want to send general interrogation requests to controlled stations\n+  So that I am able to return the actual statuses of the controlled stations\n+\n+\tBackground:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMxODUwNA==", "bodyText": "Just for my understanding, is the scenario that a connect request occurs for the gateway, and that the gateway will send responses for all devices behind it, which are transferred to OSGP core by the protocol adapter?\nThis is somewhat different from the scenario I would expect based on other value streams (for instance a request is made for gas readings which are read from a gas meter behind a smart meter gateway device).\nTranslated to this case, I would expect the interrogation to be for LMD_1 for instance, where the command is passed through GATEWAY_1 with some identication of the targeted light measurement device that the gateway understands.\nThis would be followed by a response for just the targeted light measurement device.\nJust let me know if my interpretation is wrong, and how this will work instead.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406318504", "createdAt": "2020-04-09T16:14:41Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/resources/features/GeneralInterrogation.feature", "diffHunk": "@@ -0,0 +1,31 @@\n+Feature: General Interrogation\n+  As controlling station\n+  I want to send general interrogation requests to controlled stations\n+  So that I am able to return the actual statuses of the controlled stations\n+\n+\tBackground:\n+    Given IEC60870 devices\n+      | device_identification | device_type               | gateway_device_identification | device_address |\n+      | GATEWAY_1             | LIGHT_MEASUREMENT_GATEWAY |                               |                |\n+      | LMD_1                 | LIGHT_MEASUREMENT_DEVICE  | GATEWAY_1                     |              1 |\n+      | LMD_2                 | LIGHT_MEASUREMENT_DEVICE  | GATEWAY_1                     |              2 |\n+    And a process image on the controlled station\n+      | information_object_address | information_object_type | information_element_value |\n+      |                          1 | SIQ                     | OFF                       |\n+      |                          2 | SIQ                     | ON                        |\n+\n+  Scenario: send general interrogation command after connecting to a controlled station\n+    When I receive a connect request for IEC60870 device \"GATEWAY_1\" from osgp core", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY0OTU2MQ==", "bodyText": "Should this log statement say \"for light measurement gateway\"?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406649561", "createdAt": "2020-04-10T07:57:57Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/DistributionAutomationDeviceResponseService.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.services;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.MeasurementReportingService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class DistributionAutomationDeviceResponseService extends AbstractDeviceResponseService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DistributionAutomationDeviceResponseService.class);\n+\n+    private static final DeviceType DEVICE_TYPE = DeviceType.DA_DEVICE;\n+\n+    @Autowired\n+    private MeasurementReportingService measurementReportingService;\n+\n+    public DistributionAutomationDeviceResponseService() {\n+        super(DEVICE_TYPE);\n+    }\n+\n+    @Override\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata) {\n+        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1NTk3Ng==", "bodyText": "To me it is not immediately obvious why the response meta data is being replaced with a new correlation UID.\nIs there some reason that the one in the current response meta data should not be used? (Maybe because it is not related to earlier actions/events like a request that could be traced?)", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406655976", "createdAt": "2020-04-10T08:16:44Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/LightMeasurementDeviceResponseService.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.services;\n+\n+import java.util.Optional;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions.AsduHandlerException;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.ResponseMetadataFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.LightMeasurementService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementGroupDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+import org.opensmartgridplatform.dto.valueobjects.LightSensorStatusDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class LightMeasurementDeviceResponseService extends AbstractDeviceResponseService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LightMeasurementDeviceResponseService.class);\n+\n+    private static final DeviceType DEVICE_TYPE = DeviceType.LIGHT_MEASUREMENT_DEVICE;\n+\n+    @Autowired\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Autowired\n+    private ResponseMetadataFactory responseMetadataFactory;\n+\n+    @Autowired\n+    private LightMeasurementService lightMeasurementService;\n+\n+    public LightMeasurementDeviceResponseService() {\n+        super(DEVICE_TYPE);\n+    }\n+\n+    @Override\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata)\n+            throws AsduHandlerException {\n+        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,\n+                responseMetadata.getDeviceIdentification());\n+\n+        final ResponseMetadata newResponseMetadata = this.responseMetadataFactory", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY1NjY5Nw==", "bodyText": "It looks out of place that the methods here throw an AsduHandlerException.\nNot finding a device does not appear to be related to handling of ASDUs.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406656697", "createdAt": "2020-04-10T08:19:03Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/LightMeasurementDeviceResponseService.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.services;\n+\n+import java.util.Optional;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions.AsduHandlerException;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.ResponseMetadataFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.LightMeasurementService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementGroupDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+import org.opensmartgridplatform.dto.valueobjects.LightSensorStatusDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class LightMeasurementDeviceResponseService extends AbstractDeviceResponseService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LightMeasurementDeviceResponseService.class);\n+\n+    private static final DeviceType DEVICE_TYPE = DeviceType.LIGHT_MEASUREMENT_DEVICE;\n+\n+    @Autowired\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Autowired\n+    private ResponseMetadataFactory responseMetadataFactory;\n+\n+    @Autowired\n+    private LightMeasurementService lightMeasurementService;\n+\n+    public LightMeasurementDeviceResponseService() {\n+        super(DEVICE_TYPE);\n+    }\n+\n+    @Override\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata)\n+            throws AsduHandlerException {\n+        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,\n+                responseMetadata.getDeviceIdentification());\n+\n+        final ResponseMetadata newResponseMetadata = this.responseMetadataFactory\n+                .createWithNewCorrelationUid(responseMetadata);\n+\n+        final Iec60870Device device = this.iec60870DeviceRepository\n+                .findByDeviceIdentification(responseMetadata.getDeviceIdentification())\n+                .orElseThrow(AsduHandlerException.withMessage(\"Device not found.\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY3NDE2OA==", "bodyText": "This code assumes at least a single element is present for measurements in the measurement group and measurement elements in the measurement.\nIs it safe to assume that these will always be present, or should a clearer exception than an IndexOutOfBoundsException be thrown?\nIs there any reason not to check if there is more than one element in these collections, and throw an exception or log a warning if this would be the case?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406674168", "createdAt": "2020-04-10T09:08:09Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/LightMeasurementGatewayDeviceResponseService.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.services;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.ResponseMetadataFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.LightMeasurementService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementGroupDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+import org.opensmartgridplatform.dto.valueobjects.LightSensorStatusDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+@Service\n+public class LightMeasurementGatewayDeviceResponseService extends AbstractDeviceResponseService {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(LightMeasurementGatewayDeviceResponseService.class);\n+\n+    private static final DeviceType DEVICE_TYPE = DeviceType.LIGHT_MEASUREMENT_GATEWAY;\n+\n+    @Autowired\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Autowired\n+    private ResponseMetadataFactory responseMetadataFactory;\n+\n+    @Autowired\n+    private LightMeasurementService lightMeasurementService;\n+\n+    public LightMeasurementGatewayDeviceResponseService() {\n+        super(DEVICE_TYPE);\n+    }\n+\n+    @Override\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata) {\n+        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,\n+                responseMetadata.getDeviceIdentification());\n+\n+        final ResponseMetadata newResponseMetadata = this.responseMetadataFactory\n+                .createWithNewCorrelationUid(responseMetadata);\n+\n+        final List<Iec60870Device> lightMeasurementDevices = this.iec60870DeviceRepository\n+                .findByGatewayDeviceIdentification(responseMetadata.getDeviceIdentification());\n+\n+        this.sendLightSensorStatusResponses(measurementReportDto, lightMeasurementDevices, newResponseMetadata);\n+    }\n+\n+    private void sendLightSensorStatusResponses(final MeasurementReportDto measurementReportDto,\n+            final List<Iec60870Device> lightMeasurementDevices, final ResponseMetadata responseMetadata) {\n+\n+        for (final MeasurementGroupDto mg : measurementReportDto.getMeasurementGroups()) {\n+            final Optional<Iec60870Device> device = lightMeasurementDevices.stream()\n+                    .filter(d -> d.getInformationObjectAddress().toString().equals(mg.getIdentification()))\n+                    .findFirst();\n+            device.ifPresent(d -> this.sendLightSensorStatusResponse(mg, d, responseMetadata));\n+        }\n+    }\n+\n+    private void sendLightSensorStatusResponse(final MeasurementGroupDto measurementGroupDto,\n+            final Iec60870Device device, final ResponseMetadata responseMetadata) {\n+        final ResponseMetadata rm = new ResponseMetadata.Builder()\n+                .withCorrelationUid(responseMetadata.getCorrelationUid())\n+                .withDeviceIdentification(device.getDeviceIdentification())\n+                .withDomainInfo(device.getDeviceType().domainType().domainInfo())\n+                .withMessageType(MessageType.GET_LIGHT_SENSOR_STATUS.name())\n+                .withOrganisationIdentification(responseMetadata.getOrganisationIdentification())\n+                .build();\n+\n+        final boolean on = ((BitmaskMeasurementElementDto) measurementGroupDto.getMeasurements()\n+                .get(0)\n+                .getMeasurementElements()\n+                .get(0)).getValue() == 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4MjE3OQ==", "bodyText": "Is there a good reason the gateway device modelling is placed in the protocol adapter device?\nLooking at the smart metering domain the protocol adapter does not have this relation.\nThe relation between a device and its gateway device is in OSGP core, where for smart meters the details for identifying the device on the gateway are in the smart_meter table.\nI don't have a firm grasp of what the gateway device in the IEC60870 domain means, but unless there is a good reason it is different, I think it may better be more aligned across the domains.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406682179", "createdAt": "2020-04-10T09:30:48Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/entities/Iec60870Device.java", "diffHunk": "@@ -27,18 +31,33 @@\n     @Column(unique = true, nullable = false, length = 40)\n     private String deviceIdentification;\n \n+    @Column(nullable = false)\n+    @Enumerated(EnumType.STRING)\n+    private DeviceType deviceType;\n+\n+    @Column\n+    private String gatewayDeviceIdentification;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY4NDkxNA==", "bodyText": "This check is a bit different from device.hasGatewayDevice(), it looks cleaner to use the method from the device than to replicate the logic.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406684914", "createdAt": "2020-04-10T09:38:46Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/integration-test/java/org/opensmartgridplatform/adapter/protocol/iec60870/integrationtests/steps/ConnectionSteps.java", "diffHunk": "@@ -82,26 +84,43 @@ public void givenIec60870DeviceIsNotConnected() throws ConnectionFailureExceptio\n                 .thenReturn(deviceConnection);\n     }\n \n-    @Given(\"an existing connection with an IEC60870 device\")\n-    public void givenIec60870DeviceIsConnected() throws ClientConnectionAlreadyInCacheException {\n-        LOGGER.debug(\"Given IEC60870 device is connected\");\n-\n+    @Given(\"an existing connection with IEC60870 device {string} of type {string}\")\n+    public void givenIec60870DeviceIsConnected(final String deviceIdentification, final String typeOfDevice)\n+            throws Exception {\n+        LOGGER.debug(\"Given an existing connection with IEC60870 device {} of type {}\", deviceIdentification,\n+                typeOfDevice);\n+        final DeviceType deviceType = DeviceType.valueOf(typeOfDevice);\n         // Make sure the connection event listener works as expected\n-        final ResponseMetadata responseMetadata = new ResponseMetadata.Builder()\n-                .withDeviceIdentification(DEFAULT_DEVICE_IDENTIFICATION)\n-                .withOrganisationIdentification(DEFAULT_ORGANISATION_IDENTIFICATION)\n-                .withDomainInfo(new DomainInfo(DEFAULT_DOMAIN, DEFAULT_DOMAIN_VERSION))\n-                .withMessageType(DEFAULT_MESSAGE_TYPE)\n-                .build();\n+        this.connectionParameters = this.initConnectionParameters(deviceIdentification);\n+        final ResponseMetadata responseMetadata = this.initResponseMetadata(deviceIdentification, deviceType);\n         this.connectionEventListener = new ClientConnectionEventListener(\n                 this.connectionParameters.getDeviceIdentification(), this.connectionCacheSpy,\n                 this.clientAsduHandlerRegistry, responseMetadata);\n \n         // Make sure a connection could be retrieved from the cache\n         // Only needed for scenarios sending requests to a device\n-        final Connection connection = mock(Connection.class);\n-        this.connectionCacheSpy.addConnection(DEFAULT_DEVICE_IDENTIFICATION,\n-                new DeviceConnection(connection, this.connectionParameters));\n+        // final Connection connection = mock(Connection.class);\n+        this.connectionCacheSpy.addConnection(deviceIdentification,\n+                new DeviceConnection(this.connection, this.connectionParameters));\n+    }\n+\n+    @When(\"I connect to IEC60870 device {string}\")\n+    public void whenIConnectToIEC60870Device(final String deviceIdentification) throws Exception {\n+        LOGGER.debug(\"When I connect to IEC60870 device {}\", deviceIdentification);\n+        final Iec60870Device device = this.iec60870DeviceSteps.getDevice(deviceIdentification)\n+                .orElseThrow(() -> new Exception(\"Device not found\"));\n+        final DeviceType deviceType = device.getDeviceType();\n+        String connectionDevice = deviceIdentification;\n+        if (device.getGatewayDeviceIdentification() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMTQ2Nw==", "bodyText": "Any reason this is a checked exception?\nThe advice of Effective Java for instance, is only to use checked exceptions if a caller can avoid the exception by proper use of the API, or if there is something useful the caller can do when the exception is caught.\nI am not sure if these conditions apply here, but I wouldn't think so by what I have seen until now.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406711467", "createdAt": "2020-04-10T11:06:34Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/exceptions/AsduHandlerException.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions;\n+\n+import java.util.function.Supplier;\n+\n+public class AsduHandlerException extends Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMzUzMQ==", "bodyText": "It feels a little inconsistent that closing all connections is called closeAll... while closing a single connection is called disconnect.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406713531", "createdAt": "2020-04-10T11:14:21Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionService.java", "diffHunk": "@@ -21,6 +22,24 @@\n      */\n     ClientConnection getConnection(RequestMetadata requestMetadata) throws ConnectionFailureException;\n \n+    /**\n+     * Closes the {@link Connection}, sends a disconnect request and closes the\n+     * socket.\n+     *\n+     * @param deviceIdentification\n+     *            Device for which to close the connection.\n+     */\n+    void disconnect(String deviceIdentification);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcxMzk4Ng==", "bodyText": "This documentation reads like implementation notes. For a service I think it may be cleaner to leave these out, or to add them under a section for implementation details that are expected from implementors.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406713986", "createdAt": "2020-04-10T11:16:11Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionService.java", "diffHunk": "@@ -21,6 +22,24 @@\n      */\n     ClientConnection getConnection(RequestMetadata requestMetadata) throws ConnectionFailureException;\n \n+    /**\n+     * Closes the {@link Connection}, sends a disconnect request and closes the\n+     * socket.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyMjI3MA==", "bodyText": "No need to be explicit about interface methods being abstract.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406722270", "createdAt": "2020-04-10T11:44:55Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/DeviceResponseService.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions.AsduHandlerException;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+\n+@FunctionalInterface\n+public interface DeviceResponseService {\n+\n+    abstract void process(MeasurementReportDto measurementReportDto, ResponseMetadata responseMetadata)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyMzI3NQ==", "bodyText": "I'd expect an AsduHandlerException with ASDU handlers, not at the level of abstraction that this service appears to be at.\nIt may be my lack of understanding, unlucky naming, or just out of place.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406723275", "createdAt": "2020-04-10T11:48:40Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/DeviceResponseService.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.exceptions.AsduHandlerException;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+\n+@FunctionalInterface\n+public interface DeviceResponseService {\n+\n+    abstract void process(MeasurementReportDto measurementReportDto, ResponseMetadata responseMetadata)\n+            throws AsduHandlerException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyNDA3MA==", "bodyText": "The name ending in map suggests map semantics (while the map here looks like it is an implementation detail). Maybe a name not tied to the collection API, but more to the general business purpose would be a bit clearer.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406724070", "createdAt": "2020-04-10T11:51:25Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/DeviceResponseServiceMap.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import java.util.EnumMap;\n+import java.util.Map;\n+\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+public class DeviceResponseServiceMap {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjczNTU2OQ==", "bodyText": "Regarding the withNewCorrelationUid, I commented before about why this is done.\nBy now I have become aware of the ClientConnectionEventListener that has ResponseMetadata for a device, created when the connection was set up.\nI would suspect that it might be better to create the new correlation UID at the source of something you could follow.\nIn this case, from newASdu, when the asduHandler is called with the response metadata. It may be better to call it from there with a new correlation UID and don't mess with it later-on when the metadata passes other code.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406735569", "createdAt": "2020-04-10T12:27:42Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/asduhandlers/MeasurementAsduHandler.java", "diffHunk": "@@ -50,13 +51,14 @@ public MeasurementAsduHandler(final ASduType asduType) {\n     }\n \n     @Override\n-    public void handleAsdu(final ASdu asdu, final ResponseMetadata responseMetadata) {\n+    public void handleAsdu(final ASdu asdu, final ResponseMetadata responseMetadata) throws AsduHandlerException {\n         LOGGER.info(\"Received measurement of type {}.\", asdu.getTypeIdentification());\n         final ResponseMetadata newResponseMetadata = this.responseMetadataFactory\n                 .createWithNewCorrelationUid(responseMetadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzODg0Ng==", "bodyText": "This is fine, but you could consider setting these from constants in ConnectionParameters.\nThe advantage of that could be that the defaults are documented in a way and are easily available to other code if desired.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406838846", "createdAt": "2020-04-10T16:38:55Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/ConnectionParameters.java", "diffHunk": "@@ -61,10 +61,10 @@ public String toString() {\n     }\n \n     public static class Builder {\n-        private String ipAddress = null;\n+        private String ipAddress = \"localhost\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjgzOTg2Mw==", "bodyText": "This is certainly shorter than DISTRIBUTION_AUTOMATION_DEVICE.\nGiven that we usually do not use abbreviations, why do so here, or is DA such a highly established abbreviation that it is more obvious to use than the longer variation? (Would it no longer fit in the database columns where it could end up?)", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406839863", "createdAt": "2020-04-10T16:41:20Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DeviceType.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+public enum DeviceType {\n+    DA_DEVICE(DomainType.DISTRIBUTION_AUTOMATION),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0NDE3Mw==", "bodyText": "It feels odd that the protocol adapter would have to know about stuff like device type and domain.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406844173", "createdAt": "2020-04-10T16:51:20Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainType.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+public enum DomainType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg0OTM1Nw==", "bodyText": "Is there some logical place where we could manage values like these as constants?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406849357", "createdAt": "2020-04-10T17:03:22Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/infra/messaging/processors/ConnectRequestMessageProcessor.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors;\n+\n+import java.io.IOException;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.AbstractMessageProcessor;\n+import org.opensmartgridplatform.shared.exceptionhandling.ComponentType;\n+import org.opensmartgridplatform.shared.exceptionhandling.ProtocolAdapterException;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Class for processing get health status requests.\n+ */\n+@Component\n+public class ConnectRequestMessageProcessor extends AbstractMessageProcessor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConnectRequestMessageProcessor.class);\n+\n+    public ConnectRequestMessageProcessor() {\n+        super(MessageType.CONNECT);\n+    }\n+\n+    @Override\n+    public void process(final ClientConnection deviceConnection, final RequestMetadata requestMetadata)\n+            throws ProtocolAdapterException {\n+\n+        final String deviceIdentification = requestMetadata.getDeviceIdentification();\n+        final String organisationIdentification = requestMetadata.getOrganisationIdentification();\n+\n+        LOGGER.info(\"Connect request for IEC60870 device {} for organisation {}\", deviceIdentification,\n+                organisationIdentification);\n+        LOGGER.info(\"Starting general interrogation for IEC60870 device {}\", deviceIdentification);\n+\n+        try {\n+            // Perform general interrogation\n+            final int ieQualifierOfInterrogationValue = 20;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1MDg4MA==", "bodyText": "It would probably be a little more robust if the CauseOfTransmission would be in a local variable, like the commonAddress and the ieQualifierOfInterrogationValue. By repeating it there is always the risk these get out of sync by code modifications, making the message misleading. Same for the IeQualifierOfInterrogation.\nThen again, this creation of an object that will presumably be generated elsewhere looks dodgy. If the library changes how would you know you are logging the correct information? (Or is there some test for this?)", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406850880", "createdAt": "2020-04-10T17:07:10Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/infra/messaging/processors/ConnectRequestMessageProcessor.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors;\n+\n+import java.io.IOException;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.AbstractMessageProcessor;\n+import org.opensmartgridplatform.shared.exceptionhandling.ComponentType;\n+import org.opensmartgridplatform.shared.exceptionhandling.ProtocolAdapterException;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Class for processing get health status requests.\n+ */\n+@Component\n+public class ConnectRequestMessageProcessor extends AbstractMessageProcessor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConnectRequestMessageProcessor.class);\n+\n+    public ConnectRequestMessageProcessor() {\n+        super(MessageType.CONNECT);\n+    }\n+\n+    @Override\n+    public void process(final ClientConnection deviceConnection, final RequestMetadata requestMetadata)\n+            throws ProtocolAdapterException {\n+\n+        final String deviceIdentification = requestMetadata.getDeviceIdentification();\n+        final String organisationIdentification = requestMetadata.getOrganisationIdentification();\n+\n+        LOGGER.info(\"Connect request for IEC60870 device {} for organisation {}\", deviceIdentification,\n+                organisationIdentification);\n+        LOGGER.info(\"Starting general interrogation for IEC60870 device {}\", deviceIdentification);\n+\n+        try {\n+            // Perform general interrogation\n+            final int ieQualifierOfInterrogationValue = 20;\n+            final int originatorAddress = 0;\n+            final int commonAddress = deviceConnection.getConnectionParameters().getCommonAddress();\n+\n+            deviceConnection.getConnection()\n+                    .interrogation(commonAddress, CauseOfTransmission.ACTIVATION,\n+                            new IeQualifierOfInterrogation(ieQualifierOfInterrogationValue));\n+\n+            // interrogation command creates this asdu internally, however we\n+            // need it here as well for logging...\n+            final ASdu asdu = new ASdu(ASduType.C_IC_NA_1, false, CauseOfTransmission.ACTIVATION, false, false,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1Mzk5Mw==", "bodyText": "This is not about requesting the health status that failed, but the connect/interrogation.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406853993", "createdAt": "2020-04-10T17:14:39Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/infra/messaging/processors/ConnectRequestMessageProcessor.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors;\n+\n+import java.io.IOException;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.AbstractMessageProcessor;\n+import org.opensmartgridplatform.shared.exceptionhandling.ComponentType;\n+import org.opensmartgridplatform.shared.exceptionhandling.ProtocolAdapterException;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Class for processing get health status requests.\n+ */\n+@Component\n+public class ConnectRequestMessageProcessor extends AbstractMessageProcessor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConnectRequestMessageProcessor.class);\n+\n+    public ConnectRequestMessageProcessor() {\n+        super(MessageType.CONNECT);\n+    }\n+\n+    @Override\n+    public void process(final ClientConnection deviceConnection, final RequestMetadata requestMetadata)\n+            throws ProtocolAdapterException {\n+\n+        final String deviceIdentification = requestMetadata.getDeviceIdentification();\n+        final String organisationIdentification = requestMetadata.getOrganisationIdentification();\n+\n+        LOGGER.info(\"Connect request for IEC60870 device {} for organisation {}\", deviceIdentification,\n+                organisationIdentification);\n+        LOGGER.info(\"Starting general interrogation for IEC60870 device {}\", deviceIdentification);\n+\n+        try {\n+            // Perform general interrogation\n+            final int ieQualifierOfInterrogationValue = 20;\n+            final int originatorAddress = 0;\n+            final int commonAddress = deviceConnection.getConnectionParameters().getCommonAddress();\n+\n+            deviceConnection.getConnection()\n+                    .interrogation(commonAddress, CauseOfTransmission.ACTIVATION,\n+                            new IeQualifierOfInterrogation(ieQualifierOfInterrogationValue));\n+\n+            // interrogation command creates this asdu internally, however we\n+            // need it here as well for logging...\n+            final ASdu asdu = new ASdu(ASduType.C_IC_NA_1, false, CauseOfTransmission.ACTIVATION, false, false,\n+                    originatorAddress, commonAddress,\n+                    new InformationObject(0, new IeQualifierOfInterrogation(ieQualifierOfInterrogationValue)));\n+\n+            final LogItem logItem = new LogItem(deviceIdentification, organisationIdentification, false,\n+                    asdu.toString());\n+\n+            this.getLoggingService().log(logItem);\n+\n+        } catch (final IOException | RuntimeException e) {\n+            LOGGER.warn(\"Requesting the health status for device {} failed\", deviceIdentification, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1NzA2NA==", "bodyText": "Do all processors execute a general interrogation, with CoT ACTIVATION?\nMaybe this is how it works, but it looks surprising if you don't know the protocol and see all the different processors (connect, health status, light sensor status) do the same thing.\nIf it indeed needs to be the same everywhere, shouldn't this be refactored to avoid the duplication?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406857064", "createdAt": "2020-04-10T17:22:05Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/infra/messaging/processors/GetLightSensorStatusRequestMessageProcessor.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.processors;\n+\n+import java.io.IOException;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeQualifierOfInterrogation;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnection;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.infra.messaging.AbstractMessageProcessor;\n+import org.opensmartgridplatform.shared.exceptionhandling.ComponentType;\n+import org.opensmartgridplatform.shared.exceptionhandling.ProtocolAdapterException;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Class for processing get light sensor status requests.\n+ */\n+@Component\n+public class GetLightSensorStatusRequestMessageProcessor extends AbstractMessageProcessor {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GetLightSensorStatusRequestMessageProcessor.class);\n+\n+    public GetLightSensorStatusRequestMessageProcessor() {\n+        super(MessageType.GET_LIGHT_SENSOR_STATUS);\n+    }\n+\n+    @Override\n+    public void process(final ClientConnection deviceConnection, final RequestMetadata requestMetadata)\n+            throws ProtocolAdapterException {\n+\n+        final String deviceIdentification = requestMetadata.getDeviceIdentification();\n+        final String organisationIdentification = requestMetadata.getOrganisationIdentification();\n+\n+        LOGGER.info(\"Get light sensor status request for IEC60870 device {} for organisation {}\", deviceIdentification,\n+                organisationIdentification);\n+\n+        try {\n+            // Perform general interrogation\n+            final int ieQualifierOfInterrogationValue = 20;\n+            final int originatorAddress = 0;\n+            final int commonAddress = deviceConnection.getConnectionParameters().getCommonAddress();\n+\n+            deviceConnection.getConnection()\n+                    .interrogation(commonAddress, CauseOfTransmission.ACTIVATION,\n+                            new IeQualifierOfInterrogation(ieQualifierOfInterrogationValue));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg1ODc4MA==", "bodyText": "Should there be constraints so that either both the gateway_device_identification and information_object_address are set or neither?\nIf an information_object_address should be unique for iec60870_device per gateway device, is this enforced? (Would it be possible through constraints, or logic in the services/repositories?)", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r406858780", "createdAt": "2020-04-10T17:26:20Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/resources/db/migration/V20200408162500000__Additional_device_fields.sql", "diffHunk": "@@ -0,0 +1,17 @@\n+DO $$\n+BEGIN\n+\n+  IF NOT EXISTS(SELECT 1 FROM information_schema.columns WHERE table_schema = current_schema AND table_name = 'iec60870_device' AND column_name = 'device_type')\n+  THEN\n+  \tALTER TABLE iec60870_device ADD COLUMN device_type VARCHAR(255) NOT NULL DEFAULT 'DA_DEVICE';\n+  \tALTER TABLE iec60870_device ADD COLUMN gateway_device_identification VARCHAR(40);\n+  \tALTER TABLE iec60870_device ADD COLUMN information_object_address INTEGER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyNTc4MA==", "bodyText": "Not from the changes in this pull request, but this looks like a painfully over-complicated way to do the same as could be accomplished with System.currentTimeMillis().", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407925780", "createdAt": "2020-04-14T07:34:56Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/mapping/Iec60870InformationObjectConverterTest.java", "diffHunk": "@@ -31,17 +33,24 @@\n \n     private static final long TIMESTAMP_NOW = ZonedDateTime.now(ZoneOffset.UTC).toInstant().toEpochMilli();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkyOTkwMg==", "bodyText": "2020?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407929902", "createdAt": "2020-04-14T07:42:15Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/mapping/informationelements/IeSinglePointWithQualityConverterTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzMzEzNg==", "bodyText": "I am fine with the bit-shifting if it is your preference, but wanted to check you have considered using binary literals instead? I personally find for small values like single bytes they are quite expressive (e.g. 0b00010000 instead of 1 << 4).", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407933136", "createdAt": "2020-04-14T07:48:10Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/mapping/informationelements/IeSinglePointWithQualityConverterTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.mapping.informationelements;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+\n+public class IeSinglePointWithQualityConverterTest {\n+\n+    private static final int IE_OFF = 0;\n+    private static final int IE_ON = 1 << 0;\n+    private static final int IE_QUALITY_BLOCKED = 1 << 4;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzNjE4Mw==", "bodyText": "This will work, since the distinct values do not have overlapping bit values. It feels semantically more appropriate however in case of combining bit patterns, to use | (bitwise inclusive or) instead of + (addition).", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407936183", "createdAt": "2020-04-14T07:53:35Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/mapping/informationelements/IeSinglePointWithQualityConverterTest.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.application.mapping.informationelements;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+\n+public class IeSinglePointWithQualityConverterTest {\n+\n+    private static final int IE_OFF = 0;\n+    private static final int IE_ON = 1 << 0;\n+    private static final int IE_QUALITY_BLOCKED = 1 << 4;\n+    private static final int IE_QUALITY_SUBSTITUTED = 1 << 5;\n+    private static final int IE_QUALITY_NOT_TOPICAL = 1 << 6;\n+    private static final int IE_QUALITY_INVALID = 1 << 7;\n+    private static final int IE_ALL = IE_ON + IE_QUALITY_BLOCKED + IE_QUALITY_SUBSTITUTED + IE_QUALITY_NOT_TOPICAL\n+            + IE_QUALITY_INVALID;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0ODY3MA==", "bodyText": "Starting test method names with test looks like a reminder of an old JUnit convention to identify test methods (for which we have the Test annotation now).", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407948670", "createdAt": "2020-04-14T08:14:17Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionServiceImplTest.java", "diffHunk": "@@ -0,0 +1,230 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.ClientConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.Iec60870DeviceFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.RequestMetadataFactory;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class ClientConnectionServiceImplTest {\n+\n+    @InjectMocks\n+    private ClientConnectionServiceImpl clientConnectionService;\n+\n+    @Spy\n+    private ClientConnectionCacheImpl connectionCache;\n+\n+    @Mock\n+    private Client iec60870Client;\n+\n+    @Mock\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Mock\n+    private ClientAsduHandlerRegistry clientAsduHandlerRegistry;\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionWhenInCache() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk1MDQ2Mg==", "bodyText": "Are these javadocs the result of some form of automatic test generation?\nFor me it feels like some extra lines I should just try to ignore. I believe functionality being tested is better reveilled through well-picked test method names.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r407950462", "createdAt": "2020-04-14T08:17:17Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionServiceImplTest.java", "diffHunk": "@@ -0,0 +1,230 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.ClientConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.Iec60870DeviceFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.RequestMetadataFactory;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class ClientConnectionServiceImplTest {\n+\n+    @InjectMocks\n+    private ClientConnectionServiceImpl clientConnectionService;\n+\n+    @Spy\n+    private ClientConnectionCacheImpl connectionCache;\n+\n+    @Mock\n+    private Client iec60870Client;\n+\n+    @Mock\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Mock\n+    private ClientAsduHandlerRegistry clientAsduHandlerRegistry;\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2MDM5Ng==", "bodyText": "CreatedConnection or NewConnection instead of CreateConnection? (Also in the other method with CreateConnection in its name?)", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408060396", "createdAt": "2020-04-14T11:21:17Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionServiceImplTest.java", "diffHunk": "@@ -0,0 +1,230 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.ClientConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.Iec60870DeviceFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.RequestMetadataFactory;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class ClientConnectionServiceImplTest {\n+\n+    @InjectMocks\n+    private ClientConnectionServiceImpl clientConnectionService;\n+\n+    @Spy\n+    private ClientConnectionCacheImpl connectionCache;\n+\n+    @Mock\n+    private Client iec60870Client;\n+\n+    @Mock\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Mock\n+    private ClientAsduHandlerRegistry clientAsduHandlerRegistry;\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionWhenInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"DA_DVC_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createDistributionAutomationDevice(deviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(deviceIdentification);\n+        this.connectionCache.addConnection(deviceIdentification, expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionToGatewayDeviceWhenInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"LM_DVC_1\";\n+        final String gatewayDeviceIdentification = \"LM_GATEWAY_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createLightMeasurementDevice(deviceIdentification,\n+                gatewayDeviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(gatewayDeviceIdentification);\n+        this.connectionCache.addConnection(gatewayDeviceIdentification, expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnCreateConnectionWhenNotInCache() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIwOTQ5OA==", "bodyText": "I found the name with DisconnectString a bit confusing. With a general type like String, the name would be clearer if it was something like DisconnectByDeviceIdentification or so.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408209498", "createdAt": "2020-04-14T15:03:47Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/ClientConnectionServiceImplTest.java", "diffHunk": "@@ -0,0 +1,230 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Optional;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ConnectionEventListener;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.entities.Iec60870Device;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.repositories.Iec60870DeviceRepository;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.ClientConnectionFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.Iec60870DeviceFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.factories.RequestMetadataFactory;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class ClientConnectionServiceImplTest {\n+\n+    @InjectMocks\n+    private ClientConnectionServiceImpl clientConnectionService;\n+\n+    @Spy\n+    private ClientConnectionCacheImpl connectionCache;\n+\n+    @Mock\n+    private Client iec60870Client;\n+\n+    @Mock\n+    private Iec60870DeviceRepository iec60870DeviceRepository;\n+\n+    @Mock\n+    private ClientAsduHandlerRegistry clientAsduHandlerRegistry;\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionWhenInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"DA_DVC_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createDistributionAutomationDevice(deviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(deviceIdentification);\n+        this.connectionCache.addConnection(deviceIdentification, expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnExistingConnectionToGatewayDeviceWhenInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"LM_DVC_1\";\n+        final String gatewayDeviceIdentification = \"LM_GATEWAY_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createLightMeasurementDevice(deviceIdentification,\n+                gatewayDeviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(gatewayDeviceIdentification);\n+        this.connectionCache.addConnection(gatewayDeviceIdentification, expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnCreateConnectionWhenNotInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"DA_DVC_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createDistributionAutomationDevice(deviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(deviceIdentification);\n+        when(this.iec60870Client.connect(eq(expectedConnection.getConnectionParameters()),\n+                any(ConnectionEventListener.class))).thenReturn(expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#getConnection(org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.RequestMetadata)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testGetConnectionShouldReturnCreateConnectionToGatewayDeviceWhenNotInCache() throws Exception {\n+        // Arrange\n+        final String deviceIdentification = \"LM_DVC_1\";\n+        final String gatewayDeviceIdentification = \"LM_GATEWAY_1\";\n+        final Iec60870Device device = Iec60870DeviceFactory.createLightMeasurementDevice(deviceIdentification,\n+                gatewayDeviceIdentification);\n+        final Iec60870Device gateway = Iec60870DeviceFactory\n+                .createLightMeasurementGatewayDevice(gatewayDeviceIdentification);\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(deviceIdentification))\n+                .thenReturn(Optional.of(device));\n+        when(this.iec60870DeviceRepository.findByDeviceIdentification(gatewayDeviceIdentification))\n+                .thenReturn(Optional.of(gateway));\n+\n+        final RequestMetadata requestMetadata = RequestMetadataFactory.forDevice(deviceIdentification);\n+        final ClientConnection expectedConnection = ClientConnectionFactory.forDevice(gatewayDeviceIdentification);\n+        when(this.iec60870Client.connect(eq(expectedConnection.getConnectionParameters()),\n+                any(ConnectionEventListener.class))).thenReturn(expectedConnection);\n+\n+        // Act\n+        final ClientConnection actualConnection = this.clientConnectionService.getConnection(requestMetadata);\n+\n+        // Assert\n+        assertThat(actualConnection).isEqualTo(expectedConnection);\n+    }\n+\n+    /**\n+     * Test method for\n+     * {@link org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.ClientConnectionServiceImpl#disconnect(java.lang.String)}.\n+     *\n+     * @throws Exception\n+     */\n+    @Test\n+    void testDisconnectString() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyMTQ2Mg==", "bodyText": "These should either be final or not follow the naming convention for constants (I'd guess the first).", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408221462", "createdAt": "2020-04-14T15:19:06Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/asduhandlers/SinglePointWithQualityAsduHandlerTest.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.asduhandlers;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Arrays;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationObject;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.application.services.Iec60870AsduConverterService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.application.services.LightMeasurementGatewayDeviceResponseService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.LogItemFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.factories.ResponseMetadataFactory;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.DeviceResponseServiceMap;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.LoggingService;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.DeviceType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.LogItem;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.testutils.builders.AsduBuilder;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementElementDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementGroupDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportDto;\n+import org.opensmartgridplatform.dto.da.measurements.MeasurementReportHeaderDto;\n+import org.opensmartgridplatform.dto.da.measurements.elements.BitmaskMeasurementElementDto;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class SinglePointWithQualityAsduHandlerTest {\n+\n+    private static final String GATEWAY_DEVICE_IDENTIFICATION = \"TEST-GATEWAY-1\";\n+    private static final DeviceType GATEWAY_DEVICE_TYPE = DeviceType.LIGHT_MEASUREMENT_GATEWAY;\n+    private static final int LMD_1_IOA = 1;\n+    private static final boolean LMD_1_ON = true;\n+    private static final int LMD_2_IOA = 2;\n+    private static final boolean LMD_2_ON = false;\n+    private static String MEASUREMENT_TYPE = ASduType.M_SP_NA_1.name();\n+    private static String MEASUREMENT_REASON = CauseOfTransmission.INTERROGATED_BY_STATION.name();\n+    private static int MEASUREMENT_ORIGINATOR_ADDRESS = 0;\n+    private static int MEASUREMENT_COMMON_ADDRESS = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyODQ5NA==", "bodyText": "Any reason this has default visibility instead of public like most test classes?\nThe same could be questioned regarding the test methods, and other elements that are left with default visibility instead of being public or private.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408228494", "createdAt": "2020-04-14T15:28:07Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMDc4MQ==", "bodyText": "My initial thoughts were: what does this test? The actual DomainInfo is created just like the expected from the constants.\nMaybe rename the test to something with DomainInfoIsIdentifiedByDomainAndVersion.\nHmm, it appears the equality tests are already elsewhere in this class, making me doubt what this test has to offer?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408230781", "createdAt": "2020-04-14T15:31:04Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNTEyMQ==", "bodyText": "Not necessarily wrong, but a bit over the top I'd say.\nIt looks like this tests that getters return what has been set in the constructor.\nIt's be clearer if the constructor was inside the test if you really want to do this, so you can see inside the test method that the expected value is what was used to create the value object.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408235121", "createdAt": "2020-04-14T15:37:04Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzODQ3Mg==", "bodyText": "For equality test, I see no advantage over assertThat(this).isEqualTo(that). If anything goes wrong chances are the error message is clearer when leaning on the assertions library.\nOther than that, testing equality on identical instances looks a bit over the top.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408238472", "createdAt": "2020-04-14T15:41:42Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForSameObjects() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzOTkxMw==", "bodyText": "This makes that I have to scroll and look back at the constants to understand this test.\nIt would stand out more clear if both domain info objects were created in the test I think.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408239913", "createdAt": "2020-04-14T15:43:37Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForSameObjects() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isTrue();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForObjectsWithSameValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0Mjc2OA==", "bodyText": "For clearer messages if anything should ever go wrong, I'd just use an assertThat(this).isEqualTo(that) style assertion instead of the isTrue.\nA test name with something like DomainInfoIsIdentifiedByItsValues would look nicer in my opinion, as it is more about what is important than about there being an equals method that returns true.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408242768", "createdAt": "2020-04-14T15:47:25Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForSameObjects() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isTrue();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForObjectsWithSameValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, DOMAIN_VERSION);\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0NzAzNQ==", "bodyText": "I wouldn't test the general result of the toString contents.\nIf this is a specifically formatted result that is actually expected to contain certain text, it probably would be better to include another method for that.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408247035", "createdAt": "2020-04-14T15:53:08Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainInfoTest.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainInfoTest {\n+    static final String DOMAIN_DISTRIBUTION_AUTOMATION = \"DISTRIBUTION_AUTOMATION\";\n+    static final String DOMAIN_PUBLIC_LIGHTING = \"PUBLIC_LIGHTING\";\n+    static final String DOMAIN_VERSION = \"1.0\";\n+    static final DomainInfo DOMAIN_INFO_DISTRIBUTION_AUTOMATION = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION,\n+            DOMAIN_VERSION);\n+    static final DomainInfo DOMAIN_INFO_PUBLIC_LIGHTING = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+\n+    @Test\n+    void testDomainInfo() {\n+        // Arrange\n+        final DomainInfo expected = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final DomainInfo actual = new DomainInfo(\"DISTRIBUTION_AUTOMATION\", \"1.0\");\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomain() {\n+        // Arrange\n+        final String expected = DOMAIN_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomain();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testGetDomainVersion() {\n+        // Arrange\n+        final String expected = DOMAIN_VERSION;\n+        // Act\n+        final String actual = DOMAIN_INFO_DISTRIBUTION_AUTOMATION.getDomainVersion();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForSameObjects() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isTrue();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsTrueForObjectsWithSameValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = DOMAIN_INFO_DISTRIBUTION_AUTOMATION;\n+        final DomainInfo otherDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, DOMAIN_VERSION);\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isTrue();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsFalseForObjectsWithDifferentDomainValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, DOMAIN_VERSION);\n+        final DomainInfo otherDomainInfo = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isFalse();\n+    }\n+\n+    @Test\n+    void testEqualsReturnsFalseForObjectsWithDifferentDomainVersionValues() {\n+        // Arrange\n+        final DomainInfo thisDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, \"1.0\");\n+        final DomainInfo otherDomainInfo = new DomainInfo(DOMAIN_DISTRIBUTION_AUTOMATION, \"2.0\");\n+        // Act\n+        final boolean actual = thisDomainInfo.equals(otherDomainInfo);\n+        // Assert\n+        assertThat(actual).isFalse();\n+    }\n+\n+    @Test\n+    void testHashCode() {\n+        // Arrange\n+        final DomainInfo domainInfo = new DomainInfo(DOMAIN_PUBLIC_LIGHTING, DOMAIN_VERSION);\n+        final int expected = DOMAIN_INFO_PUBLIC_LIGHTING.hashCode();\n+        // Act\n+        final int actual = domainInfo.hashCode();\n+        // Assert\n+        assertThat(actual).isEqualTo(expected);\n+    }\n+\n+    @Test\n+    void testToString() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MzIyMA==", "bodyText": "I find it very hard to understand what this class is testing and why?\nPerhaps there is some good reason to do this, but then I feel it is perhaps not clearly expressed in the test method names.\nSame as with DomainInfoTest regarding the absence of public/private modifiers.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408253220", "createdAt": "2020-04-14T16:01:27Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/valueobjects/DomainTypeTest.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class DomainTypeTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1NDQzNg==", "bodyText": "Why use an abbreviation? I think we generally just take the hit on character count and write things out.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408254436", "createdAt": "2020-04-14T16:03:08Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/builders/AsduBuilder.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+\n+package org.opensmartgridplatform.adapter.protocol.iec60870.testutils.builders;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.ie.InformationObject;\n+\n+public class AsduBuilder {\n+\n+    private final ASduType asduType;\n+    private CauseOfTransmission cot = CauseOfTransmission.SPONTANEOUS;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1ODQ3MQ==", "bodyText": "No license header?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408258471", "createdAt": "2020-04-14T16:08:47Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/matchers/AsduMatcher.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.testutils.matchers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1OTM5OQ==", "bodyText": "2020?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408259399", "createdAt": "2020-04-14T16:10:07Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/matchers/GetLightSensorStatusResponseMessageMatcher.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2NjM1Mg==", "bodyText": "I am a bit confused why some choices are made.\nFor instance, why is there an extra field for the LightSensorStatusDto, and why are some values in the matches method hard coded, while others compare the values from argument with those from this.responseMessage.\nCouldn't all values be compared based on looking at values of argument and this.responseMessage?\nMaybe this class could even be a more generic ProtocolResponseMessageMatcher then?\nAm I missing something?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408266352", "createdAt": "2020-04-14T16:20:10Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/matchers/GetLightSensorStatusResponseMessageMatcher.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.testutils.matchers;\n+\n+import org.mockito.ArgumentMatcher;\n+import org.opensmartgridplatform.dto.valueobjects.LightSensorStatusDto;\n+import org.opensmartgridplatform.shared.infra.jms.MessageType;\n+import org.opensmartgridplatform.shared.infra.jms.ProtocolResponseMessage;\n+import org.opensmartgridplatform.shared.infra.jms.ResponseMessageResultType;\n+\n+public class GetLightSensorStatusResponseMessageMatcher implements ArgumentMatcher<ProtocolResponseMessage> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2Njc5Mw==", "bodyText": "No license header?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r408266793", "createdAt": "2020-04-14T16:20:52Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/test/java/org/opensmartgridplatform/adapter/protocol/iec60870/testutils/matchers/asdu/InterrogationActivationAsduMatcher.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package org.opensmartgridplatform.adapter.protocol.iec60870.testutils.matchers.asdu;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0b7ca82a87fe498e297f0643379226e04bdc57"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38c1094ef037391b349937b1ae58dc4f503750f1", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/38c1094ef037391b349937b1ae58dc4f503750f1", "committedDate": "2020-04-17T09:34:09Z", "message": "FLEX-5299 ~ Processes review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4227ff6d166e0c2bf5df18ae178ff8ff20975e48", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/4227ff6d166e0c2bf5df18ae178ff8ff20975e48", "committedDate": "2020-04-17T09:36:53Z", "message": "Merge branch 'development' into feature/FLEX-5299-protocol-adapter-iec60870-general-interrogation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzU5Mjky", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#pullrequestreview-395359292", "createdAt": "2020-04-17T10:59:54Z", "commit": {"oid": "4227ff6d166e0c2bf5df18ae178ff8ff20975e48"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDo1OTo1NFrOGHJk-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoyMzozNVrOGHLz3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1MDEzOQ==", "bodyText": "License header?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410150139", "createdAt": "2020-04-17T10:59:54Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-iec60870/src/main/java/org/opensmartgridplatform/iec60870/QualifierOfInterrogation.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.opensmartgridplatform.iec60870;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4227ff6d166e0c2bf5df18ae178ff8ff20975e48"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE2MDEyNw==", "bodyText": "I am not to fond of optionals in the code like this. There will often be difficulty in clean and precise naming. The name device, for instance, is a slight mismatch, cause it does not leave room to use device for the actual device in the optional (and optionalDevice would not make me much happier either).\nI think the combination of isPresent() + get() is a very unfortunate use of optionals and the get method should rarely to never be used. Even the optional orElse(null) followed by null check would (in my opinion) be cleaner, but preferences may differ.\nFor now leave it as is I guess, mostly because I would like to have seen the following block changed from if optional isPresent in an ifPresentOrElse construct. My preferred option however is an addition to the Optional API in Java 9, and therefore not yet ready to be applied in our code base.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410160127", "createdAt": "2020-04-17T11:23:30Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/application/services/LightMeasurementDeviceResponseService.java", "diffHunk": "@@ -48,19 +45,18 @@ public LightMeasurementDeviceResponseService() {\n     }\n \n     @Override\n-    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata)\n-            throws AsduHandlerException {\n-        LOGGER.info(\"Received measurement report {} for light measurement gateway {}.\", measurementReportDto,\n+    public void process(final MeasurementReportDto measurementReportDto, final ResponseMetadata responseMetadata) {\n+        LOGGER.info(\"Received measurement report {} for light measurement device {}.\", measurementReportDto,\n                 responseMetadata.getDeviceIdentification());\n \n-        final ResponseMetadata newResponseMetadata = this.responseMetadataFactory\n-                .createWithNewCorrelationUid(responseMetadata);\n-\n-        final Iec60870Device device = this.iec60870DeviceRepository\n-                .findByDeviceIdentification(responseMetadata.getDeviceIdentification())\n-                .orElseThrow(AsduHandlerException.withMessage(\"Device not found.\"));\n+        final Optional<Iec60870Device> device = this.iec60870DeviceRepository\n+                .findByDeviceIdentification(responseMetadata.getDeviceIdentification());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4227ff6d166e0c2bf5df18ae178ff8ff20975e48"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4NjcxNw==", "bodyText": "Doesn't this give issues when you have more than 1 gateway device (both gateway_device_identification and information_object_address being null). This was why I wondered if the constraint could be here or would have to be enforced with repository code.\nUpdate: the unique constraint works fine. Multiple rows with NULL values are accepted. This is not an issue.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410186717", "createdAt": "2020-04-17T12:23:35Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/resources/db/migration/V20200408162500000__Additional_device_fields.sql", "diffHunk": "@@ -9,6 +9,15 @@ BEGIN\n \n   \tALTER TABLE iec60870_device ALTER COLUMN common_address SET DEFAULT 0;\n \n+    ALTER TABLE iec60870_device\n+      ADD CONSTRAINT iec60870_device_gateway_key\n+        UNIQUE (gateway_device_identification, information_object_address);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4227ff6d166e0c2bf5df18ae178ff8ff20975e48"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a63c8a737af9c44cea3b25a6e6a2b2407fbb2513", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/a63c8a737af9c44cea3b25a6e6a2b2407fbb2513", "committedDate": "2020-04-17T13:10:36Z", "message": "Adds missing license header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f4d67480483e10f7a9ebd924e0e36cce424ec2", "author": {"user": {"login": "smvdheijden", "name": "Sander van der Heijden"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/d7f4d67480483e10f7a9ebd924e0e36cce424ec2", "committedDate": "2020-04-17T13:14:57Z", "message": "Fixes license header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NDQyNzI3", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#pullrequestreview-395442727", "createdAt": "2020-04-17T13:15:40Z", "commit": {"oid": "a63c8a737af9c44cea3b25a6e6a2b2407fbb2513"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMzoxNTo0MFrOGHNe-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMzoxNTo0MFrOGHNe-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIxNDEzOA==", "bodyText": "2019?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/273#discussion_r410214138", "createdAt": "2020-04-17T13:15:40Z", "author": {"login": "bvdzwet"}, "path": "osgp/protocol-adapter-iec60870/osgp-iec60870/src/main/java/org/opensmartgridplatform/iec60870/QualifierOfInterrogation.java", "diffHunk": "@@ -1,3 +1,10 @@\n+/**\n+ * Copyright 2019 Smart Society Services B.V.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a63c8a737af9c44cea3b25a6e6a2b2407fbb2513"}, "originalPosition": 2}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3853, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}