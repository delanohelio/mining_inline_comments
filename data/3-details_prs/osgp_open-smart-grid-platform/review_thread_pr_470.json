{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2Nzk1ODc1", "number": 470, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzozODo1NlrOEvyFXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjo1Mjo1NFrOEylYkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTM5MTAyOnYy", "diffSide": "RIGHT", "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/messaging/DeviceRequestMessageProcessor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzozODo1NlrOHk9D_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzozODo1NlrOHk9D_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUxMTIzMA==", "bodyText": "Method has 7 parameters, which is greater than 6 authorized.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r508511230", "createdAt": "2020-10-20T13:38:56Z", "author": {"login": "jenkins-ip-10-4-24-184"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/messaging/DeviceRequestMessageProcessor.java", "diffHunk": "@@ -152,19 +154,32 @@ protected void handleError(final IOException e, final String correlationUid,\n         this.responseMessageSender.send(protocolResponseMessage);\n     }\n \n+    protected void handleFunctionalException(final FunctionalException e, final MessageMetadata messageMetadata) {\n+        LOGGER.error(\"Functional error while processing message, using MessageMetadata to create error response\", e);\n+\n+        final ProtocolResponseMessage protocolResponseMessage = createProtocolResponseMessage(messageMetadata, e);\n+        this.responseMessageSender.send(protocolResponseMessage);\n+    }\n+\n     protected void handleError(final RuntimeException e, final MessageMetadata messageMetadata) {\n         LOGGER.error(\"Error while processing message, using MessageMetadata to create error response\", e);\n \n         // Set the exception to a class known by all OSGP components\n         final TechnicalException ex = new TechnicalException(ComponentType.PROTOCOL_OSLP, UNEXPECTED_EXCEPTION);\n+        final ProtocolResponseMessage protocolResponseMessage = createProtocolResponseMessage(messageMetadata, ex);\n+        this.responseMessageSender.send(protocolResponseMessage);\n+    }\n \n+    private ProtocolResponseMessage createProtocolResponseMessage(\n+            final MessageMetadata messageMetadata, final OsgpException ex) {\n         final DeviceMessageMetadata deviceMessageMetadata = new DeviceMessageMetadata(messageMetadata);\n-        final ProtocolResponseMessage protocolResponseMessage = ProtocolResponseMessage.newBuilder()\n-                .domain(messageMetadata.getDomain()).domainVersion(messageMetadata.getDomainVersion())\n-                .deviceMessageMetadata(deviceMessageMetadata).result(ResponseMessageResultType.NOT_OK).osgpException(ex)\n-                .retryCount(messageMetadata.getRetryCount()).build();\n-\n-        this.responseMessageSender.send(protocolResponseMessage);\n+        return ProtocolResponseMessage.newBuilder()\n+                    .domain(messageMetadata.getDomain())\n+                    .domainVersion(messageMetadata.getDomainVersion())\n+                    .deviceMessageMetadata(deviceMessageMetadata)\n+                    .result(ResponseMessageResultType.NOT_OK)\n+                    .osgpException(ex)\n+                    .retryCount(messageMetadata.getRetryCount()).build();\n     }\n \n     public void handleUnableToConnectDeviceResponse(final DeviceResponse deviceResponse, final Throwable t,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0159b150177363b0efea0546d7fafbda23bd99a7"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTU0NDg1OnYy", "diffSide": "RIGHT", "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/java/org/opensmartgridplatform/cucumber/platform/publiclighting/glue/steps/database/adapterprotocoloslp/OslpDeviceSteps.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTowMTo1OVrOHoiOWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTowMTo1OVrOHoiOWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2NTgxNg==", "bodyText": "There's already a function like this in some of the closed source test-code. If this wait function is required here, delete the other one.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512265816", "createdAt": "2020-10-26T21:01:59Z", "author": {"login": "kevinsmeets"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/java/org/opensmartgridplatform/cucumber/platform/publiclighting/glue/steps/database/adapterprotocoloslp/OslpDeviceSteps.java", "diffHunk": "@@ -93,4 +126,12 @@ public void theSsldOslpDeviceContains(final Map<String, String> expectedEntity)\n \n         this.ssldDeviceSteps.theSsldDeviceContains(expectedEntity);\n     }\n+\n+    @Then(\"^I wait (\\\\d+) seconds$\")\n+    public void IWaitXSeconds(final Integer seconds) {\n+        try {\n+            Thread.sleep(seconds * 1000);\n+        } catch (final InterruptedException e) {\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTU2NTQyOnYy", "diffSide": "RIGHT", "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/resources/features/publiclighting/osgp-adapter-ws-publiclighting/ScheduleManagement/SetLightSchedule.feature", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTowNzo0N1rOHoiamQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODozMDoxNVrOHowX9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2ODk1Mw==", "bodyText": "Why are there multiple OK responses here? Is this required? Could it be that for each page a response is sent? There should be only 1 response, no matter how many pages/schedule entries are sent to a device.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512268953", "createdAt": "2020-10-26T21:07:47Z", "author": {"login": "kevinsmeets"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/resources/features/publiclighting/osgp-adapter-ws-publiclighting/ScheduleManagement/SetLightSchedule.feature", "diffHunk": "@@ -257,13 +308,22 @@ Feature: PublicLightingScheduleManagement Set Light Schedule\n       | FaultString  | UNREGISTERED_DEVICE                        |\n       | InnerMessage | Device TEST1024000000001 is not registered |\n \n-  # Note: HasScheduled is set to 'false' because the response type is 'NOT_OK', but should be 'OK'\n+\n   @OslpMockServer\n   Scenario Outline: Set light schedule with 50 schedules # Success\n     Given an ssld oslp device\n       | DeviceIdentification | TEST1024000000001 |\n       | Protocol             | <Protocol>        |\n     And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5NzY1Mg==", "bodyText": "Could it be that for each page a response is sent? --> Yes indeed.\nThere should be only 1 response, no matter how many pages/schedule entries are sent to a device. --> No, every page needs it's own response.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512497652", "createdAt": "2020-10-27T08:30:15Z", "author": {"login": "joostknapen"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/resources/features/publiclighting/osgp-adapter-ws-publiclighting/ScheduleManagement/SetLightSchedule.feature", "diffHunk": "@@ -257,13 +308,22 @@ Feature: PublicLightingScheduleManagement Set Light Schedule\n       | FaultString  | UNREGISTERED_DEVICE                        |\n       | InnerMessage | Device TEST1024000000001 is not registered |\n \n-  # Note: HasScheduled is set to 'false' because the response type is 'NOT_OK', but should be 'OK'\n+\n   @OslpMockServer\n   Scenario Outline: Set light schedule with 50 schedules # Success\n     Given an ssld oslp device\n       | DeviceIdentification | TEST1024000000001 |\n       | Protocol             | <Protocol>        |\n     And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2ODk1Mw=="}, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 120}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTU3NjQyOnYy", "diffSide": "RIGHT", "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/application/services/oslp/PendingSetScheduleRequestService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMToxMDo1MlrOHoihPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMToxMDo1MlrOHoihPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MDY1NA==", "bodyText": "I think we should be using 'Alliander N.V.' as the company name in headers.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512270654", "createdAt": "2020-10-26T21:10:52Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/application/services/oslp/PendingSetScheduleRequestService.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTU5Mzg4OnYy", "diffSide": "RIGHT", "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/resources/features/publiclighting/osgp-adapter-ws-publiclighting/ScheduleManagement/SetLightSchedule.feature", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMToxNjowMFrOHoir0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODozNjoxNFrOHowl3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MzM2MA==", "bodyText": "Is there no condition that can be asserted, instead of waiting an arbitrary amount of time?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512273360", "createdAt": "2020-10-26T21:16:00Z", "author": {"login": "kevinsmeets"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/resources/features/publiclighting/osgp-adapter-ws-publiclighting/ScheduleManagement/SetLightSchedule.feature", "diffHunk": "@@ -276,6 +336,7 @@ Feature: PublicLightingScheduleManagement Set Light Schedule\n       | TriggerWindow        | <TriggerWindow>   |\n     Then the set light schedule async response contains\n       | DeviceIdentification | TEST1024000000001 |\n+    And I wait 7 seconds", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUwMTIxMg==", "bodyText": "This test is actually a out of scope of FLEX-5527. It concluded, based upon the occurence of a SOAP fault, that the schedule was split into several pages. Since that is stupid and faulty, I changed that, into a checking on the reception of a success message as a last step. I don't directly see a way (without investing quite some time) to get around the delay. During that time, the pages are sent to the device.\nIf you really wan't to get rid of the delay in tests, I would just @Skip this test, since it did not do any good before.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512501212", "createdAt": "2020-10-27T08:36:14Z", "author": {"login": "joostknapen"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/resources/features/publiclighting/osgp-adapter-ws-publiclighting/ScheduleManagement/SetLightSchedule.feature", "diffHunk": "@@ -276,6 +336,7 @@ Feature: PublicLightingScheduleManagement Set Light Schedule\n       | TriggerWindow        | <TriggerWindow>   |\n     Then the set light schedule async response contains\n       | DeviceIdentification | TEST1024000000001 |\n+    And I wait 7 seconds", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MzM2MA=="}, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTU5NTcyOnYy", "diffSide": "RIGHT", "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/domain/entities/PendingSetScheduleRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMToxNjozN1rOHois8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMToxNjozN1rOHois8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MzY1MQ==", "bodyText": "Header is missing.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512273651", "createdAt": "2020-10-26T21:16:37Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/domain/entities/PendingSetScheduleRequest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package org.opensmartgridplatform.adapter.protocol.oslp.elster.domain.entities;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTYwNTgwOnYy", "diffSide": "RIGHT", "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/domain/repositories/PendingSetScheduleRequestRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMToxOTo0NFrOHoizIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMToxOTo0NFrOHoizIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3NTIzMg==", "bodyText": "I think we should be using 'Alliander N.V.' as the company name in headers, and the year is wrong.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512275232", "createdAt": "2020-10-26T21:19:44Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/domain/repositories/PendingSetScheduleRequestRepository.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/**\n+ * Copyright 2015 Smart Society Services B.V.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTY2MTc2OnYy", "diffSide": "RIGHT", "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/messaging/processors/PublicLightingSetScheduleRequestMessageProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTozNjo1MFrOHojVLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTozNjo1MFrOHojVLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4Mzk0OQ==", "bodyText": "Most, if not all, of the code-base, is using Java's DateTime class (which used to be Yoda's DateTime class) to create and manipulate times. Don't use the Calender class, instead use something like:\nfinal Date date = DateTime.now().minusMonths(this.deviceMessageRetentionPeriodInMonths).toDate();", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512283949", "createdAt": "2020-10-26T21:36:50Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/messaging/processors/PublicLightingSetScheduleRequestMessageProcessor.java", "diffHunk": "@@ -180,24 +218,68 @@ private void handleGetConfigurationBeforeSetScheduleResponse(final SetScheduleDe\n         this.deviceService.setSchedule(newDeviceRequest);\n     }\n \n+    private ScheduleMessageTypeDto determineNextRequest(final SetScheduleDeviceRequest deviceRequest, final GetConfigurationDeviceResponse deviceResponse) {\n+        final int requestedSunriseOffset = deviceRequest.getScheduleMessageDataContainer().getSchedule().getAstronomicalSunriseOffset();\n+        final int requestedSunsetOffset = deviceRequest.getScheduleMessageDataContainer().getSchedule().getAstronomicalSunsetOffset();\n+        final ConfigurationDto configurationInDevice = deviceResponse.getConfiguration();\n+\n+        LOGGER.info(\"Requested astroGateSunRiseOffset {},  astroGateSunRiseOffset in device {}, Requested astroGateSunSetOffset {},  astroGateSunSetOffset in device {}, \",\n+                requestedSunriseOffset,configurationInDevice.getAstroGateSunRiseOffset(),\n+                requestedSunsetOffset, configurationInDevice.getAstroGateSunSetOffset());\n+\n+        if (requestedSunriseOffset != configurationInDevice.getAstroGateSunRiseOffset() ||\n+                requestedSunsetOffset != configurationInDevice.getAstroGateSunSetOffset()) {\n+            return ScheduleMessageTypeDto.SET_ASTRONOMICAL_OFFSETS;\n+        }\n+\n+        return ScheduleMessageTypeDto.SET_SCHEDULE;\n+    }\n+\n     private void handleSetScheduleAstronomicalOffsetsResponse(final SetScheduleDeviceRequest deviceRequest) {\n+        // Configuration / Astronomical offsets are set , so now continue with rebooting the device\n \n-        // Astronomical offsets are set, so now continue with the actual\n-        // schedule\n         LOGGER.info(LOG_MESSAGE_CALL_DEVICE_SERVICE, deviceRequest.getMessageType(),\n-                ScheduleMessageTypeDto.SET_SCHEDULE, deviceRequest.getDomain(), deviceRequest.getDomainVersion());\n+                ScheduleMessageTypeDto.SET_ASTRONOMICAL_OFFSETS, deviceRequest.getDomain(),\n+                deviceRequest.getDomainVersion());\n \n         final ScheduleMessageDataContainerDto dataContainer = new ScheduleMessageDataContainerDto.Builder(\n                 deviceRequest.getScheduleMessageDataContainer().getSchedule())\n-                        .withScheduleMessageType(ScheduleMessageTypeDto.SET_SCHEDULE)\n-                        .build();\n+                .withScheduleMessageType(ScheduleMessageTypeDto.SET_REBOOT)\n+                .build();\n \n         final SetScheduleDeviceRequest newDeviceRequest = new SetScheduleDeviceRequest(\n                 createDeviceRequestBuilder(deviceRequest), dataContainer, RelayTypeDto.LIGHT);\n \n         this.deviceService.setSchedule(newDeviceRequest);\n     }\n \n+    private void handleSetScheduleSetRebootResponse(final SetScheduleDeviceRequest deviceRequest) {\n+\n+        // The device will reboot now.\n+        // At this point we will need to save the current state to the pending_set_schedule_request table\n+\n+        LOGGER.info(LOG_MESSAGE_CALL_DEVICE_SERVICE, deviceRequest.getMessageType(),\n+                ScheduleMessageTypeDto.SET_SCHEDULE, deviceRequest.getDomain(), deviceRequest.getDomainVersion());\n+\n+        final ScheduleMessageDataContainerDto dataContainer = new ScheduleMessageDataContainerDto.Builder(\n+                deviceRequest.getScheduleMessageDataContainer().getSchedule())\n+                        .withScheduleMessageType(ScheduleMessageTypeDto.SET_SCHEDULE)\n+                        .build();\n+\n+        final Calendar calendar = Calendar.getInstance();\n+        calendar.setTime(new Date());\n+        calendar.add(Calendar.MINUTE, this.pendingSetScheduleRequestExpiresInMinutes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 198}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwOTczNTQzOnYy", "diffSide": "RIGHT", "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/networking/OslpChannelHandlerServer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTo1OTo1M1rOHoj_4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODo1NzowMVrOHoxZtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NDg4MQ==", "bodyText": "There is a lot to remark about adding and calling this function here.\n\nThis class OslpChannelHandlerServer is not transactional. The function handleSetSchedule() deletes a record (this.pendingSetScheduleRequestService.remove(pendingSetScheduleRequest);), if certain conditions are met. This is not OK. Move the function handleSetSchedule() to a transactional service class.\nThis class OslpChannelHandlerServer handles incoming messages. Is it desirable that this class is now also sending a request to a device (this.deviceService.setSchedule(newDeviceRequest);)? I know it is (implicitly) decoupled because the request has to be signed, which means the request is sent to the signing-server component, which is an operation that utilizes queues, therefore there is no direct coupling. Still, it seems to me that a TCP-server is using a TCP-client, which would be a bad design, if not for the signing-thing...\nIs it desirable that each incoming confirm registration message now needs a lookup for the device, and a lookup for the (only in a few cases present) pending set schedule request record(s)? To me, this seems to add a lot of fetch operations to the database load, since every Elster OSLP devices registers once every 24 hours. Saving the device UID as part of the pending set schedule request record(s) could at least mitigate the fetching of the oslp device record.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512294881", "createdAt": "2020-10-26T21:59:53Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/networking/OslpChannelHandlerServer.java", "diffHunk": "@@ -257,15 +276,18 @@ private int convertGpsCoordinateFromFloatToInt(final Float input) {\n         return (int) (input * 1000000);\n     }\n \n-    private Oslp.Message handleConfirmRegisterDeviceRequest(final byte[] deviceId, final byte[] sequenceNumber,\n+    private Oslp.Message handleConfirmRegisterDeviceRequest(final byte[] deviceUid, final byte[] sequenceNumber,\n             final Oslp.ConfirmRegisterDeviceRequest confirmRegisterDeviceRequest) throws ProtocolAdapterException {\n \n         try {\n-            this.deviceRegistrationService.confirmRegisterDevice(deviceId,\n+            this.deviceRegistrationService.confirmRegisterDevice(deviceUid,\n                     SequenceNumberUtils.convertByteArrayToInteger(sequenceNumber),\n                     confirmRegisterDeviceRequest.getRandomDevice(), confirmRegisterDeviceRequest.getRandomPlatform());\n+\n+            this.handleSetSchedule(deviceUid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjUxNDQ4Nw==", "bodyText": "Hmm, the pendingSetScheduleRequestService is transactional. If some other process deleted the pendingSetScheduleRequest this would indeed result in a fail. But I don't exactly know if table locks or record locks or whatever type of locking will be used I don't think it is a good idea to put all code within the handleSetSchedule in a transaction since this.deviceService.setSchedule(newDeviceRequest) will also be inside in the transaction. I think that operation will take most of the time, and I would prefer to at least have that operation succeed before the pendingsetschedulerequest record is removed. I'll change the service to catch PersistenceException.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512514487", "createdAt": "2020-10-27T08:57:01Z", "author": {"login": "joostknapen"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/networking/OslpChannelHandlerServer.java", "diffHunk": "@@ -257,15 +276,18 @@ private int convertGpsCoordinateFromFloatToInt(final Float input) {\n         return (int) (input * 1000000);\n     }\n \n-    private Oslp.Message handleConfirmRegisterDeviceRequest(final byte[] deviceId, final byte[] sequenceNumber,\n+    private Oslp.Message handleConfirmRegisterDeviceRequest(final byte[] deviceUid, final byte[] sequenceNumber,\n             final Oslp.ConfirmRegisterDeviceRequest confirmRegisterDeviceRequest) throws ProtocolAdapterException {\n \n         try {\n-            this.deviceRegistrationService.confirmRegisterDevice(deviceId,\n+            this.deviceRegistrationService.confirmRegisterDevice(deviceUid,\n                     SequenceNumberUtils.convertByteArrayToInteger(sequenceNumber),\n                     confirmRegisterDeviceRequest.getRandomDevice(), confirmRegisterDeviceRequest.getRandomPlatform());\n+\n+            this.handleSetSchedule(deviceUid);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NDg4MQ=="}, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxNDc2NzUyOnYy", "diffSide": "RIGHT", "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/java/org/opensmartgridplatform/webdevicesimulator/service/RegisterDevice.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjo1Mjo1NFrOHpT48g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjo1Mjo1NFrOHpT48g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3OTUzOA==", "bodyText": "Do not forget to remove this deprecated code someday.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r513079538", "createdAt": "2020-10-27T22:52:54Z", "author": {"login": "jenkins-ip-10-4-24-184"}, "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/java/org/opensmartgridplatform/webdevicesimulator/service/RegisterDevice.java", "diffHunk": "@@ -363,6 +352,8 @@ public DeviceMessageStatus sendEventNotificationCommand(final Long id, final Int\n         }\n     }\n \n+    @Deprecated\n+    // No longer used, as device creation scripts create device UID\n     private byte[] createRandomDeviceUid() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d65722442798aeca924dce8f7b47e38b1edf49"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3557, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}