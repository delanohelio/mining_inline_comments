{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2Nzk1ODc1", "number": 470, "title": "FLEX-5527: Added reboot functionality including error handling", "bodyText": "", "createdAt": "2020-10-20T13:24:07Z", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470", "merged": true, "mergeCommit": {"oid": "27e6564684ab878e07b34fdd41d192845fc6a7be"}, "closed": true, "closedAt": "2020-10-29T08:35:45Z", "author": {"login": "joostknapen"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUYtnaAH2gAyNTA2Nzk1ODc1OjFlNjRkNzA3NTIzYjQzYjBiYTY4YmJmOTAyM2YyYzkwZWQ5MjZhYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXFiYFAH2gAyNTA2Nzk1ODc1OmMyMGRhMWJmMDY1M2EwYjQxYjA3ZmYwMTFjZTgyYTYxOGZmZTQ1MWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1e64d707523b43b0ba68bbf9023f2c90ed926ac6", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/1e64d707523b43b0ba68bbf9023f2c90ed926ac6", "committedDate": "2020-10-20T13:23:16Z", "message": "FLEX-5527: Added reboot functionality including error handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0159b150177363b0efea0546d7fafbda23bd99a7", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/0159b150177363b0efea0546d7fafbda23bd99a7", "committedDate": "2020-10-20T13:26:10Z", "message": "FLEX-5527: Run all acceptence tests for public lightning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNzIxNjEz", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#pullrequestreview-512721613", "createdAt": "2020-10-20T13:38:56Z", "commit": {"oid": "0159b150177363b0efea0546d7fafbda23bd99a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzozODo1NlrOHk9D_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzozODo1NlrOHk9D_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUxMTIzMA==", "bodyText": "Method has 7 parameters, which is greater than 6 authorized.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r508511230", "createdAt": "2020-10-20T13:38:56Z", "author": {"login": "jenkins-ip-10-4-24-184"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/messaging/DeviceRequestMessageProcessor.java", "diffHunk": "@@ -152,19 +154,32 @@ protected void handleError(final IOException e, final String correlationUid,\n         this.responseMessageSender.send(protocolResponseMessage);\n     }\n \n+    protected void handleFunctionalException(final FunctionalException e, final MessageMetadata messageMetadata) {\n+        LOGGER.error(\"Functional error while processing message, using MessageMetadata to create error response\", e);\n+\n+        final ProtocolResponseMessage protocolResponseMessage = createProtocolResponseMessage(messageMetadata, e);\n+        this.responseMessageSender.send(protocolResponseMessage);\n+    }\n+\n     protected void handleError(final RuntimeException e, final MessageMetadata messageMetadata) {\n         LOGGER.error(\"Error while processing message, using MessageMetadata to create error response\", e);\n \n         // Set the exception to a class known by all OSGP components\n         final TechnicalException ex = new TechnicalException(ComponentType.PROTOCOL_OSLP, UNEXPECTED_EXCEPTION);\n+        final ProtocolResponseMessage protocolResponseMessage = createProtocolResponseMessage(messageMetadata, ex);\n+        this.responseMessageSender.send(protocolResponseMessage);\n+    }\n \n+    private ProtocolResponseMessage createProtocolResponseMessage(\n+            final MessageMetadata messageMetadata, final OsgpException ex) {\n         final DeviceMessageMetadata deviceMessageMetadata = new DeviceMessageMetadata(messageMetadata);\n-        final ProtocolResponseMessage protocolResponseMessage = ProtocolResponseMessage.newBuilder()\n-                .domain(messageMetadata.getDomain()).domainVersion(messageMetadata.getDomainVersion())\n-                .deviceMessageMetadata(deviceMessageMetadata).result(ResponseMessageResultType.NOT_OK).osgpException(ex)\n-                .retryCount(messageMetadata.getRetryCount()).build();\n-\n-        this.responseMessageSender.send(protocolResponseMessage);\n+        return ProtocolResponseMessage.newBuilder()\n+                    .domain(messageMetadata.getDomain())\n+                    .domainVersion(messageMetadata.getDomainVersion())\n+                    .deviceMessageMetadata(deviceMessageMetadata)\n+                    .result(ResponseMessageResultType.NOT_OK)\n+                    .osgpException(ex)\n+                    .retryCount(messageMetadata.getRetryCount()).build();\n     }\n \n     public void handleUnableToConnectDeviceResponse(final DeviceResponse deviceResponse, final Throwable t,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0159b150177363b0efea0546d7fafbda23bd99a7"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4d736cff69c925ddacc3a98e0ef5347b55e59b3", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/f4d736cff69c925ddacc3a98e0ef5347b55e59b3", "committedDate": "2020-10-20T14:43:44Z", "message": "FLEX-5527: Added soap fault check in cucumber feature test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9f086877f035fda570e5a189a973e9a214be695", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/e9f086877f035fda570e5a189a973e9a214be695", "committedDate": "2020-10-21T07:15:26Z", "message": "FLEX-5527: renamed Flyway script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27f3a0fc4bd1cade9509f12ad260c6638a19b1f7", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/27f3a0fc4bd1cade9509f12ad260c6638a19b1f7", "committedDate": "2020-10-21T08:13:16Z", "message": "Merge branch 'development' of github.com:OSGP/open-smart-grid-platform into FLEX-5527_Reboot_function_after_config_change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d68ba65b5c0cc0a6643e555ee15e23fe4c859299", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/d68ba65b5c0cc0a6643e555ee15e23fe4c859299", "committedDate": "2020-10-21T08:13:38Z", "message": "Merge branch 'FLEX-5527_Reboot_function_after_config_change' of github.com:OSGP/open-smart-grid-platform into FLEX-5527_Reboot_function_after_config_change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cf40d176e4050a8d1cf824b2f83598f1b1ee39d", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/0cf40d176e4050a8d1cf824b2f83598f1b1ee39d", "committedDate": "2020-10-21T08:36:15Z", "message": "FLEX-5527: All set schedules are blocked when a set schedule with astronomical offsets is in progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b2631db25c9f707bf0e34ef44fa3bfab372373", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/78b2631db25c9f707bf0e34ef44fa3bfab372373", "committedDate": "2020-10-21T08:36:20Z", "message": "Merge branch 'FLEX-5527_Reboot_function_after_config_change' of https://github.com/OSGP/open-smart-grid-platform into FLEX-5527_Reboot_function_after_config_change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43ec2316a260b8c3c77fed36cf1125301a5256ad", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/43ec2316a260b8c3c77fed36cf1125301a5256ad", "committedDate": "2020-10-21T10:25:07Z", "message": "FLEX-5527: Fixed tests that check on error state when not able to set a schedule with astronomical offsets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b68b23d4db1e19ffc82822e263b401975c24e0a", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/4b68b23d4db1e19ffc82822e263b401975c24e0a", "committedDate": "2020-10-21T10:29:03Z", "message": "FLEX-5527: renamed property expiration_time to expires_in_minutes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6576cc60a287485c055baf550f5ff4995cecf17b", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/6576cc60a287485c055baf550f5ff4995cecf17b", "committedDate": "2020-10-21T13:32:45Z", "message": "FLEX-5527: Ignore CorrelationUid is unknown in buffered set schedule responses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db4014be8a86a8045228f285fde7de737d6eeb32", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/db4014be8a86a8045228f285fde7de737d6eeb32", "committedDate": "2020-10-21T14:10:05Z", "message": "FLEX-5527: Changed test for paging schedules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "234ba23218c214bb7f0e1a6882f2fae019da0e65", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/234ba23218c214bb7f0e1a6882f2fae019da0e65", "committedDate": "2020-10-22T07:26:03Z", "message": "FLEX-5527: removed false comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e42443e0106e2cef548c15daf0635305a10d3b78", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/e42443e0106e2cef548c15daf0635305a10d3b78", "committedDate": "2020-10-22T07:27:27Z", "message": "Merge branch 'development' into FLEX-5527_Reboot_function_after_config_change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ce1cdf9c66d8e25504e20ff1dd0fd3311b04315", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/0ce1cdf9c66d8e25504e20ff1dd0fd3311b04315", "committedDate": "2020-10-22T14:56:40Z", "message": "FLEX-5527: Fixed bug where a get/set configuration always occured during a set schedule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba64677cb9f21cf926a252a69cd64849bf854d3a", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/ba64677cb9f21cf926a252a69cd64849bf854d3a", "committedDate": "2020-10-23T09:12:03Z", "message": "Merge branch 'development' into FLEX-5527_Reboot_function_after_config_change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/be86fa9753de720c8ea6d3e6c4a58902ec3402f0", "committedDate": "2020-10-26T11:20:14Z", "message": "FLEX-5527: SetConfiguration and SetReboot only happen if the astro offsets in the devices configuration differ from the astro offsets in the requested schedule"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTcyNjUx", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#pullrequestreview-517172651", "createdAt": "2020-10-26T21:01:59Z", "commit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTowMTo1OVrOHoiOWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMTo1OTo1M1rOHoj_4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2NTgxNg==", "bodyText": "There's already a function like this in some of the closed source test-code. If this wait function is required here, delete the other one.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512265816", "createdAt": "2020-10-26T21:01:59Z", "author": {"login": "kevinsmeets"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/java/org/opensmartgridplatform/cucumber/platform/publiclighting/glue/steps/database/adapterprotocoloslp/OslpDeviceSteps.java", "diffHunk": "@@ -93,4 +126,12 @@ public void theSsldOslpDeviceContains(final Map<String, String> expectedEntity)\n \n         this.ssldDeviceSteps.theSsldDeviceContains(expectedEntity);\n     }\n+\n+    @Then(\"^I wait (\\\\d+) seconds$\")\n+    public void IWaitXSeconds(final Integer seconds) {\n+        try {\n+            Thread.sleep(seconds * 1000);\n+        } catch (final InterruptedException e) {\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI2ODk1Mw==", "bodyText": "Why are there multiple OK responses here? Is this required? Could it be that for each page a response is sent? There should be only 1 response, no matter how many pages/schedule entries are sent to a device.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512268953", "createdAt": "2020-10-26T21:07:47Z", "author": {"login": "kevinsmeets"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/resources/features/publiclighting/osgp-adapter-ws-publiclighting/ScheduleManagement/SetLightSchedule.feature", "diffHunk": "@@ -257,13 +308,22 @@ Feature: PublicLightingScheduleManagement Set Light Schedule\n       | FaultString  | UNREGISTERED_DEVICE                        |\n       | InnerMessage | Device TEST1024000000001 is not registered |\n \n-  # Note: HasScheduled is set to 'false' because the response type is 'NOT_OK', but should be 'OK'\n+\n   @OslpMockServer\n   Scenario Outline: Set light schedule with 50 schedules # Success\n     Given an ssld oslp device\n       | DeviceIdentification | TEST1024000000001 |\n       | Protocol             | <Protocol>        |\n     And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"\n+    And the device returns a set light schedule response \"OK\" over \"<Protocol>\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MDY1NA==", "bodyText": "I think we should be using 'Alliander N.V.' as the company name in headers.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512270654", "createdAt": "2020-10-26T21:10:52Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/application/services/oslp/PendingSetScheduleRequestService.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MzM2MA==", "bodyText": "Is there no condition that can be asserted, instead of waiting an arbitrary amount of time?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512273360", "createdAt": "2020-10-26T21:16:00Z", "author": {"login": "kevinsmeets"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/resources/features/publiclighting/osgp-adapter-ws-publiclighting/ScheduleManagement/SetLightSchedule.feature", "diffHunk": "@@ -276,6 +336,7 @@ Feature: PublicLightingScheduleManagement Set Light Schedule\n       | TriggerWindow        | <TriggerWindow>   |\n     Then the set light schedule async response contains\n       | DeviceIdentification | TEST1024000000001 |\n+    And I wait 7 seconds", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3MzY1MQ==", "bodyText": "Header is missing.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512273651", "createdAt": "2020-10-26T21:16:37Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/domain/entities/PendingSetScheduleRequest.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package org.opensmartgridplatform.adapter.protocol.oslp.elster.domain.entities;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI3NTIzMg==", "bodyText": "I think we should be using 'Alliander N.V.' as the company name in headers, and the year is wrong.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512275232", "createdAt": "2020-10-26T21:19:44Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/domain/repositories/PendingSetScheduleRequestRepository.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/**\n+ * Copyright 2015 Smart Society Services B.V.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI4Mzk0OQ==", "bodyText": "Most, if not all, of the code-base, is using Java's DateTime class (which used to be Yoda's DateTime class) to create and manipulate times. Don't use the Calender class, instead use something like:\nfinal Date date = DateTime.now().minusMonths(this.deviceMessageRetentionPeriodInMonths).toDate();", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512283949", "createdAt": "2020-10-26T21:36:50Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/messaging/processors/PublicLightingSetScheduleRequestMessageProcessor.java", "diffHunk": "@@ -180,24 +218,68 @@ private void handleGetConfigurationBeforeSetScheduleResponse(final SetScheduleDe\n         this.deviceService.setSchedule(newDeviceRequest);\n     }\n \n+    private ScheduleMessageTypeDto determineNextRequest(final SetScheduleDeviceRequest deviceRequest, final GetConfigurationDeviceResponse deviceResponse) {\n+        final int requestedSunriseOffset = deviceRequest.getScheduleMessageDataContainer().getSchedule().getAstronomicalSunriseOffset();\n+        final int requestedSunsetOffset = deviceRequest.getScheduleMessageDataContainer().getSchedule().getAstronomicalSunsetOffset();\n+        final ConfigurationDto configurationInDevice = deviceResponse.getConfiguration();\n+\n+        LOGGER.info(\"Requested astroGateSunRiseOffset {},  astroGateSunRiseOffset in device {}, Requested astroGateSunSetOffset {},  astroGateSunSetOffset in device {}, \",\n+                requestedSunriseOffset,configurationInDevice.getAstroGateSunRiseOffset(),\n+                requestedSunsetOffset, configurationInDevice.getAstroGateSunSetOffset());\n+\n+        if (requestedSunriseOffset != configurationInDevice.getAstroGateSunRiseOffset() ||\n+                requestedSunsetOffset != configurationInDevice.getAstroGateSunSetOffset()) {\n+            return ScheduleMessageTypeDto.SET_ASTRONOMICAL_OFFSETS;\n+        }\n+\n+        return ScheduleMessageTypeDto.SET_SCHEDULE;\n+    }\n+\n     private void handleSetScheduleAstronomicalOffsetsResponse(final SetScheduleDeviceRequest deviceRequest) {\n+        // Configuration / Astronomical offsets are set , so now continue with rebooting the device\n \n-        // Astronomical offsets are set, so now continue with the actual\n-        // schedule\n         LOGGER.info(LOG_MESSAGE_CALL_DEVICE_SERVICE, deviceRequest.getMessageType(),\n-                ScheduleMessageTypeDto.SET_SCHEDULE, deviceRequest.getDomain(), deviceRequest.getDomainVersion());\n+                ScheduleMessageTypeDto.SET_ASTRONOMICAL_OFFSETS, deviceRequest.getDomain(),\n+                deviceRequest.getDomainVersion());\n \n         final ScheduleMessageDataContainerDto dataContainer = new ScheduleMessageDataContainerDto.Builder(\n                 deviceRequest.getScheduleMessageDataContainer().getSchedule())\n-                        .withScheduleMessageType(ScheduleMessageTypeDto.SET_SCHEDULE)\n-                        .build();\n+                .withScheduleMessageType(ScheduleMessageTypeDto.SET_REBOOT)\n+                .build();\n \n         final SetScheduleDeviceRequest newDeviceRequest = new SetScheduleDeviceRequest(\n                 createDeviceRequestBuilder(deviceRequest), dataContainer, RelayTypeDto.LIGHT);\n \n         this.deviceService.setSchedule(newDeviceRequest);\n     }\n \n+    private void handleSetScheduleSetRebootResponse(final SetScheduleDeviceRequest deviceRequest) {\n+\n+        // The device will reboot now.\n+        // At this point we will need to save the current state to the pending_set_schedule_request table\n+\n+        LOGGER.info(LOG_MESSAGE_CALL_DEVICE_SERVICE, deviceRequest.getMessageType(),\n+                ScheduleMessageTypeDto.SET_SCHEDULE, deviceRequest.getDomain(), deviceRequest.getDomainVersion());\n+\n+        final ScheduleMessageDataContainerDto dataContainer = new ScheduleMessageDataContainerDto.Builder(\n+                deviceRequest.getScheduleMessageDataContainer().getSchedule())\n+                        .withScheduleMessageType(ScheduleMessageTypeDto.SET_SCHEDULE)\n+                        .build();\n+\n+        final Calendar calendar = Calendar.getInstance();\n+        calendar.setTime(new Date());\n+        calendar.add(Calendar.MINUTE, this.pendingSetScheduleRequestExpiresInMinutes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI5NDg4MQ==", "bodyText": "There is a lot to remark about adding and calling this function here.\n\nThis class OslpChannelHandlerServer is not transactional. The function handleSetSchedule() deletes a record (this.pendingSetScheduleRequestService.remove(pendingSetScheduleRequest);), if certain conditions are met. This is not OK. Move the function handleSetSchedule() to a transactional service class.\nThis class OslpChannelHandlerServer handles incoming messages. Is it desirable that this class is now also sending a request to a device (this.deviceService.setSchedule(newDeviceRequest);)? I know it is (implicitly) decoupled because the request has to be signed, which means the request is sent to the signing-server component, which is an operation that utilizes queues, therefore there is no direct coupling. Still, it seems to me that a TCP-server is using a TCP-client, which would be a bad design, if not for the signing-thing...\nIs it desirable that each incoming confirm registration message now needs a lookup for the device, and a lookup for the (only in a few cases present) pending set schedule request record(s)? To me, this seems to add a lot of fetch operations to the database load, since every Elster OSLP devices registers once every 24 hours. Saving the device UID as part of the pending set schedule request record(s) could at least mitigate the fetching of the oslp device record.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r512294881", "createdAt": "2020-10-26T21:59:53Z", "author": {"login": "kevinsmeets"}, "path": "osgp/protocol-adapter-oslp/osgp-adapter-protocol-oslp-elster/src/main/java/org/opensmartgridplatform/adapter/protocol/oslp/elster/infra/networking/OslpChannelHandlerServer.java", "diffHunk": "@@ -257,15 +276,18 @@ private int convertGpsCoordinateFromFloatToInt(final Float input) {\n         return (int) (input * 1000000);\n     }\n \n-    private Oslp.Message handleConfirmRegisterDeviceRequest(final byte[] deviceId, final byte[] sequenceNumber,\n+    private Oslp.Message handleConfirmRegisterDeviceRequest(final byte[] deviceUid, final byte[] sequenceNumber,\n             final Oslp.ConfirmRegisterDeviceRequest confirmRegisterDeviceRequest) throws ProtocolAdapterException {\n \n         try {\n-            this.deviceRegistrationService.confirmRegisterDevice(deviceId,\n+            this.deviceRegistrationService.confirmRegisterDevice(deviceUid,\n                     SequenceNumberUtils.convertByteArrayToInteger(sequenceNumber),\n                     confirmRegisterDeviceRequest.getRandomDevice(), confirmRegisterDeviceRequest.getRandomPlatform());\n+\n+            this.handleSetSchedule(deviceUid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be86fa9753de720c8ea6d3e6c4a58902ec3402f0"}, "originalPosition": 125}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b7b4d9f44741c8e273f792623e72e4e9c339cb3", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/6b7b4d9f44741c8e273f792623e72e4e9c339cb3", "committedDate": "2020-10-27T09:45:41Z", "message": "FLEX-5527: Changed copyright headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8779e9bb7077cf7b49f5aad45457174ca9ac0381", "author": {"user": {"login": "kevinsmeets", "name": "Kevin Smeets"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/8779e9bb7077cf7b49f5aad45457174ca9ac0381", "committedDate": "2020-10-27T22:31:08Z", "message": "FLEX-5527 ~ Processes review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27d65722442798aeca924dce8f7b47e38b1edf49", "author": {"user": {"login": "kevinsmeets", "name": "Kevin Smeets"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/27d65722442798aeca924dce8f7b47e38b1edf49", "committedDate": "2020-10-27T22:40:38Z", "message": "Merge branch 'FLEX-5527_Reboot_function_after_config_change' of github.com:OSGP/open-smart-grid-platform into FLEX-5527_Reboot_function_after_config_change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjA5NDUx", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#pullrequestreview-518209451", "createdAt": "2020-10-27T22:52:54Z", "commit": {"oid": "27d65722442798aeca924dce8f7b47e38b1edf49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjo1Mjo1NFrOHpT48g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMjo1Mjo1NFrOHpT48g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3OTUzOA==", "bodyText": "Do not forget to remove this deprecated code someday.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/470#discussion_r513079538", "createdAt": "2020-10-27T22:52:54Z", "author": {"login": "jenkins-ip-10-4-24-184"}, "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/java/org/opensmartgridplatform/webdevicesimulator/service/RegisterDevice.java", "diffHunk": "@@ -363,6 +352,8 @@ public DeviceMessageStatus sendEventNotificationCommand(final Long id, final Int\n         }\n     }\n \n+    @Deprecated\n+    // No longer used, as device creation scripts create device UID\n     private byte[] createRandomDeviceUid() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d65722442798aeca924dce8f7b47e38b1edf49"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85954c17dac014afacda4b39b69a56d1bc77f278", "author": {"user": {"login": "kevinsmeets", "name": "Kevin Smeets"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/85954c17dac014afacda4b39b69a56d1bc77f278", "committedDate": "2020-10-27T23:06:25Z", "message": "Merge remote-tracking branch 'origin/development' into FLEX-5527_Reboot_function_after_config_change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b58067a10ce9c4b4b5759a0334a2a974e60d58b8", "author": {"user": {"login": "kevinsmeets", "name": "Kevin Smeets"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/b58067a10ce9c4b4b5759a0334a2a974e60d58b8", "committedDate": "2020-10-28T10:23:27Z", "message": "FLEX-5527 ~ Updates deprecated comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "978c75c05e5ad9f5e70cc13ce3989382706003f4", "author": {"user": {"login": "kevinsmeets", "name": "Kevin Smeets"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/978c75c05e5ad9f5e70cc13ce3989382706003f4", "committedDate": "2020-10-28T22:36:59Z", "message": "FLEX-5527 ~ Moves wait step to common test library."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3db7ccb902aecda8efc4a0b8accadb7e96073afc", "author": {"user": {"login": "kevinsmeets", "name": "Kevin Smeets"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/3db7ccb902aecda8efc4a0b8accadb7e96073afc", "committedDate": "2020-10-28T22:40:33Z", "message": "FLEX-5527 ~ Moves 'handle schedule' call in OSLP channel handler server to a more robust location.\n\nTests have shown that the introduces call to set schedule is too soon. This causes problems with the device simulator, optimistic locking exceptions caused by the fact the register device and confirm register device steps are not completed yet. This change in the execution order seem to deliver a more robust solution."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c20da1bf0653a0b41b07ff011ce82a618ffe451a", "author": {"user": {"login": "kevinsmeets", "name": "Kevin Smeets"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/c20da1bf0653a0b41b07ff011ce82a618ffe451a", "committedDate": "2020-10-28T22:44:34Z", "message": "FLEX-5527 ~ Makes sure exceptions, like connection refused or connection time-out, which result in an IOException, are propagated.\n\nTesting revealed a major bug, which causes exceptions to be 'ignored'. Those exceptions were not handeled and converted to a response sent by protocol adapter to the platform components. Calling the response handler when an exception occurs and introducing a try-catch when bytes are written to the channel solves these problems."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3697, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}