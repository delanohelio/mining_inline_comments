{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MzM3OTU0", "number": 497, "title": "FLEX-5358: Send for every relay switch a notification", "bodyText": "", "createdAt": "2020-11-10T09:11:55Z", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/497", "merged": true, "mergeCommit": {"oid": "93de4d70325e927249152e4604ff44595e5767a9"}, "closed": true, "closedAt": "2020-11-17T09:48:09Z", "author": {"login": "joostknapen"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbFqQKAH2gAyNTE4MzM3OTU0OmVmNTQxMzEyNGVkMTkzMDRlNDMzN2VhNzhhMTMzOTUxNDA5YzEwODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddEPINgH2gAyNTE4MzM3OTU0OjIzZWJhYmNhMjU5NGU5YTk0ZjBkMGQ2YTFiMDE4NDkwZDQzNzJlYzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef5413124ed19304e4337ea78a133951409c1086", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/ef5413124ed19304e4337ea78a133951409c1086", "committedDate": "2020-11-10T09:08:52Z", "message": "FLEX-5358: Send for every relay switch a notification"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MDQ3MDYw", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/497#pullrequestreview-527047060", "createdAt": "2020-11-10T10:11:12Z", "commit": {"oid": "ef5413124ed19304e4337ea78a133951409c1086"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMDoxMToxMlrOHwVSyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMDoxMToxMlrOHwVSyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ0MjU2OA==", "bodyText": "Default timestamp =\"now\", but cannot be parsed by OSGP. What is the correct timestamp format? (new Date() doesn't work) The former cucumber scenario also didn't add the timestamp to the notification.", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/497#discussion_r520442568", "createdAt": "2020-11-10T10:11:12Z", "author": {"login": "joostknapen"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/java/org/opensmartgridplatform/cucumber/platform/publiclighting/mocks/oslpdevice/MockOslpChannelHandler.java", "diffHunk": "@@ -262,6 +220,51 @@ public void channelRead0(final ChannelHandlerContext ctx, final OslpEnvelope mes\n         }\n     }\n \n+\n+    private void sendNotifications(final InetSocketAddress inetAddress, final OslpEnvelope message,\n+            final String deviceUid, final DeviceState deviceState) throws DeviceSimulatorException, IOException {\n+\n+        final MessageType messageType = this.getMessageType(message.getPayloadMessage());\n+\n+        if (MessageType.SET_LIGHT == messageType) {\n+            final List<Oslp.LightValue> lightValueList = message.getPayloadMessage()\n+                    .getSetLightRequest()\n+                    .getValuesList();\n+            for (final Oslp.LightValue lightValue : lightValueList) {\n+                final Oslp.Event event = lightValue.getOn() ? Oslp.Event.LIGHT_EVENTS_LIGHT_ON\n+                        : Oslp.Event.LIGHT_EVENTS_LIGHT_OFF;\n+                final OslpEnvelope notification = buildNotification(message, deviceUid, deviceState, event,\n+                        lightValue.getIndex());\n+                this.send(inetAddress, notification, deviceUid);\n+            }\n+        }\n+    }\n+\n+\n+    private OslpEnvelope buildNotification(final OslpEnvelope message, final String deviceUid,\n+            final DeviceState deviceState, final Oslp.Event event, final ByteString index) {\n+        this.devicesContext.getDeviceState(deviceUid).incrementSequenceNumber();\n+\n+        final Oslp.EventNotification.Builder eventNotificationBuilder = Oslp.EventNotification.newBuilder()\n+                .setEvent(event)\n+                .setDescription(event.name())\n+                //.setTimestamp(PlatformDefaults.TIMESTAMP)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef5413124ed19304e4337ea78a133951409c1086"}, "originalPosition": 173}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc15dc16f6815e6cc9bd0e088cf06baf46e91ab4", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/cc15dc16f6815e6cc9bd0e088cf06baf46e91ab4", "committedDate": "2020-11-10T19:53:51Z", "message": "Merge branch 'development' of github.com:OSGP/open-smart-grid-platform into FLEX-5358_Improve_OSLP_mock_server_-_send_event_on_relay_status_change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d452d2c29230fcfe419065b1a06b3ff29d8ae09", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/4d452d2c29230fcfe419065b1a06b3ff29d8ae09", "committedDate": "2020-11-10T19:55:33Z", "message": "FLEX-5358 ~ Adds timestamp to event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MjQ5NDY3", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/497#pullrequestreview-527249467", "createdAt": "2020-11-10T14:21:04Z", "commit": {"oid": "ef5413124ed19304e4337ea78a133951409c1086"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDoyMTowNFrOHweyOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDoyMTowNFrOHweyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5ODA3Mw==", "bodyText": "Why not call the SequenceNumberUtils class directly here and for convertByteArrayToInteger a few lines later?", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/497#discussion_r520598073", "createdAt": "2020-11-10T14:21:04Z", "author": {"login": "rlemmers"}, "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/java/org/opensmartgridplatform/cucumber/platform/publiclighting/mocks/oslpdevice/MockOslpChannelHandler.java", "diffHunk": "@@ -142,6 +78,23 @@ public MockOslpChannelHandler(final String oslpSignature, final String oslpSigna\n         this.receivedResponses = receivedResponses;\n     }\n \n+    private static byte[] convertIntegerToByteArray(final Integer value) {\n+        // See: platform.service.SequenceNumberUtils", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef5413124ed19304e4337ea78a133951409c1086"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a13575dd332b69511441907ba5c2356b6f62658", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/9a13575dd332b69511441907ba5c2356b6f62658", "committedDate": "2020-11-11T13:02:56Z", "message": "Merge branch 'development' of github.com:OSGP/open-smart-grid-platform into FLEX-5358_Improve_OSLP_mock_server_-_send_event_on_relay_status_change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b23b0520704acd90cc3924b0251b46186b122d1", "author": {"user": {"login": "rlemmers", "name": "Ruud Lemmers"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/4b23b0520704acd90cc3924b0251b46186b122d1", "committedDate": "2020-11-15T22:30:07Z", "message": "FLEX-5358 ~ Handles events"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23ebabca2594e9a94f0d0d6a1b018490d4372ec2", "author": {"user": {"login": "joostknapen", "name": "Joost Knapen"}}, "url": "https://github.com/OSGP/open-smart-grid-platform/commit/23ebabca2594e9a94f0d0d6a1b018490d4372ec2", "committedDate": "2020-11-16T12:37:11Z", "message": "FLEX-5358: removed printStackTrace from catch"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3732, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}