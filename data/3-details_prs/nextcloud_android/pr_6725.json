{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MDEyMDM2", "number": 6725, "title": "Improve performance of DocumentsProvider#isChildDocument()", "bodyText": "The old solution iterates through all parents of the child until it finds the given parent or the storage root. This has been show to be very expensive in empirical tests.\nTherefore, this commit introduces a more efficient solution that simply compares the file paths of child and given parent. It also ensures that parent and child belong to the same account.\nReviewers need to take extra care that this change does not introduce security issues by claiming a document is a child of a parent when it is really not. Maybe also check if the correct path is compared as there seem to be many: local/remote/encrypted/decrypted\nTesting\nI'd be happy to provide instrumentation tests against the DocumentsProvider implementation. However, it seems that there's no framework for that in place, yet. So this would need to be discussed before.\nThe code change is rather small and it should be evident, that if the accounts match, the following is true:\n\n/a/b/c is a child of /a/b and /a\n/a/b/c is not a child /a/x", "createdAt": "2020-08-17T18:55:52Z", "url": "https://github.com/nextcloud/android/pull/6725", "merged": true, "mergeCommit": {"oid": "8a5d58a64e986f3b5d128d25aaa1237721a99939"}, "closed": true, "closedAt": "2020-08-27T13:29:16Z", "author": {"login": "grote"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_3IP9AFqTQ2ODc1NDEzOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDAbmIgFqTQ3NjcyMDU1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NzU0MTM5", "url": "https://github.com/nextcloud/android/pull/6725#pullrequestreview-468754139", "createdAt": "2020-08-17T18:57:06Z", "commit": {"oid": "a34325068803a4ea5dacb2b2572bb9ffb11d3141"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1NzowNlrOHB3CfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODo1NzowNlrOHB3CfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTcxMjM4MA==", "bodyText": "This is an unrelated change I am hoping to sneak in here. Seeing this \"error\" in the logs is quite distracting when debugging things.\nIf you'd want to keep this as an error level log message, we should add a check if that file already exists.", "url": "https://github.com/nextcloud/android/pull/6725#discussion_r471712380", "createdAt": "2020-08-17T18:57:06Z", "author": {"login": "grote"}, "path": "src/main/java/com/owncloud/android/operations/DownloadFileOperation.java", "diffHunk": "@@ -172,7 +172,8 @@ protected RemoteOperationResult run(OwnCloudClient client) {\n             etag = downloadOperation.getEtag();\n             newFile = new File(getSavePath());\n             if (!newFile.getParentFile().mkdirs()) {\n-                Log_OC.e(TAG, \"Unable to create parent folder \" + newFile.getParentFile().getAbsolutePath());\n+                // File#mkdirs() also returns false when the directory already existed, so this not a hard error\n+                Log_OC.d(TAG, \"Unable to create parent folder \" + newFile.getParentFile().getAbsolutePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a34325068803a4ea5dacb2b2572bb9ffb11d3141"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a34325068803a4ea5dacb2b2572bb9ffb11d3141", "author": {"user": {"login": "grote", "name": "Torsten Grote"}}, "url": "https://github.com/nextcloud/android/commit/a34325068803a4ea5dacb2b2572bb9ffb11d3141", "committedDate": "2020-08-17T18:47:53Z", "message": "Improve performance of DocumentsProvider#isChildDocument()\n\nThe old solution iterates through all parents of the child until it\nfinds the given parent or the storage root.\nThis has been show to be very expensive in empirical tests.\n\nTherefore, this commit introduces a more efficient solution that simply\ncompares the file paths of child and given parent.\nIt also ensures that parent and child belong to the same account.\n\nReviewers need to take extra care that this change does not introduce\nsecurity issues by claiming a document is a child of a parent when it is\nreally not."}, "afterCommit": {"oid": "2066d7b115db4cb4f24edee67e451259235024de", "author": {"user": {"login": "grote", "name": "Torsten Grote"}}, "url": "https://github.com/nextcloud/android/commit/2066d7b115db4cb4f24edee67e451259235024de", "committedDate": "2020-08-17T18:58:41Z", "message": "Improve performance of DocumentsProvider#isChildDocument()\n\nThe old solution iterates through all parents of the child until it\nfinds the given parent or the storage root.\nThis has been show to be very expensive in empirical tests.\n\nTherefore, this commit introduces a more efficient solution that simply\ncompares the file paths of child and given parent.\nIt also ensures that parent and child belong to the same account.\n\nReviewers need to take extra care that this change does not introduce\nsecurity issues by claiming a document is a child of a parent when it is\nreally not.\n\nSigned-off-by: Torsten Grote <t@grobox.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2066d7b115db4cb4f24edee67e451259235024de", "author": {"user": {"login": "grote", "name": "Torsten Grote"}}, "url": "https://github.com/nextcloud/android/commit/2066d7b115db4cb4f24edee67e451259235024de", "committedDate": "2020-08-17T18:58:41Z", "message": "Improve performance of DocumentsProvider#isChildDocument()\n\nThe old solution iterates through all parents of the child until it\nfinds the given parent or the storage root.\nThis has been show to be very expensive in empirical tests.\n\nTherefore, this commit introduces a more efficient solution that simply\ncompares the file paths of child and given parent.\nIt also ensures that parent and child belong to the same account.\n\nReviewers need to take extra care that this change does not introduce\nsecurity issues by claiming a document is a child of a parent when it is\nreally not.\n\nSigned-off-by: Torsten Grote <t@grobox.de>"}, "afterCommit": {"oid": "b8d90f2d8091c0e24595be69d5539e9687f69f8e", "author": {"user": {"login": "grote", "name": "Torsten Grote"}}, "url": "https://github.com/nextcloud/android/commit/b8d90f2d8091c0e24595be69d5539e9687f69f8e", "committedDate": "2020-08-19T15:11:42Z", "message": "DocumentsProvider: Take into account that files can be null\n\nThis can happen when files are deleted via the DocumentsProvider before\nother asynchronous operations had a chance to complete."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8d90f2d8091c0e24595be69d5539e9687f69f8e", "author": {"user": {"login": "grote", "name": "Torsten Grote"}}, "url": "https://github.com/nextcloud/android/commit/b8d90f2d8091c0e24595be69d5539e9687f69f8e", "committedDate": "2020-08-19T15:11:42Z", "message": "DocumentsProvider: Take into account that files can be null\n\nThis can happen when files are deleted via the DocumentsProvider before\nother asynchronous operations had a chance to complete."}, "afterCommit": {"oid": "2c4ffb0774af4cf5a7fa8801d07df71211990e20", "author": {"user": {"login": "grote", "name": "Torsten Grote"}}, "url": "https://github.com/nextcloud/android/commit/2c4ffb0774af4cf5a7fa8801d07df71211990e20", "committedDate": "2020-08-19T15:13:10Z", "message": "DocumentsProvider: Take into account that files can be null\n\nThis can happen when files are deleted via the DocumentsProvider before\nother asynchronous operations had a chance to complete.\n\nSigned-off-by: Torsten Grote <t@grobox.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8870334d2e89df4a898909f1a9faa362dbc0781", "author": {"user": {"login": "grote", "name": "Torsten Grote"}}, "url": "https://github.com/nextcloud/android/commit/e8870334d2e89df4a898909f1a9faa362dbc0781", "committedDate": "2020-08-25T12:32:48Z", "message": "Improve performance of DocumentsProvider#isChildDocument()\n\nThe old solution iterates through all parents of the child until it\nfinds the given parent or the storage root.\nThis has been show to be very expensive in empirical tests.\n\nTherefore, this commit introduces a more efficient solution that simply\ncompares the file paths of child and given parent.\nIt also ensures that parent and child belong to the same account.\n\nReviewers need to take extra care that this change does not introduce\nsecurity issues by claiming a document is a child of a parent when it is\nreally not.\n\nSigned-off-by: Torsten Grote <t@grobox.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c4ffb0774af4cf5a7fa8801d07df71211990e20", "author": {"user": {"login": "grote", "name": "Torsten Grote"}}, "url": "https://github.com/nextcloud/android/commit/2c4ffb0774af4cf5a7fa8801d07df71211990e20", "committedDate": "2020-08-19T15:13:10Z", "message": "DocumentsProvider: Take into account that files can be null\n\nThis can happen when files are deleted via the DocumentsProvider before\nother asynchronous operations had a chance to complete.\n\nSigned-off-by: Torsten Grote <t@grobox.de>"}, "afterCommit": {"oid": "e8870334d2e89df4a898909f1a9faa362dbc0781", "author": {"user": {"login": "grote", "name": "Torsten Grote"}}, "url": "https://github.com/nextcloud/android/commit/e8870334d2e89df4a898909f1a9faa362dbc0781", "committedDate": "2020-08-25T12:32:48Z", "message": "Improve performance of DocumentsProvider#isChildDocument()\n\nThe old solution iterates through all parents of the child until it\nfinds the given parent or the storage root.\nThis has been show to be very expensive in empirical tests.\n\nTherefore, this commit introduces a more efficient solution that simply\ncompares the file paths of child and given parent.\nIt also ensures that parent and child belong to the same account.\n\nReviewers need to take extra care that this change does not introduce\nsecurity issues by claiming a document is a child of a parent when it is\nreally not.\n\nSigned-off-by: Torsten Grote <t@grobox.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NzIwNTU2", "url": "https://github.com/nextcloud/android/pull/6725#pullrequestreview-476720556", "createdAt": "2020-08-27T13:29:09Z", "commit": {"oid": "e8870334d2e89df4a898909f1a9faa362dbc0781"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4507, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}