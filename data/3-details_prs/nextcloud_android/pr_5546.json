{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNjQ3ODMx", "number": 5546, "title": "Migrations manager", "bodyText": "Migrations now\nCurrently there is no centrilized migration logic. We have 1 ad-hoc user model migration launched\nin MainApp.java:264 that performs some account changes, but:\n\nit does not block user interactions until the migration is completed\nit ignores errors\n\nAlthough we didn't have much problems with this simple solution, it is no longer scaling given the upcoming needs in WorkManager (#5482) migration and upcoming refactoring work.\nMigrations manager\nChanges\nThis PR provides a migration manager extracted from PR #5482 with few modifications done to satisfy androidTests environment. Changes are for the better anyway, so those changes will stay.\n\nMigrationManager runs and keeps track of past migrations and failures\nMigrations is a dumping ground for all sort of migration code for today and the future (#5482) and supplies migraiton procedures for manager to run\nLocal tests are still using Robolectric, but androidTest are supplied as well so we can compare and make an informed decision about; see section below about problems discovered during implementation.\nAdded mockito-android for androidTests dependencies\n\nCapabilities\n\nwe can now run migrations only once\nwe know when the migration failed and this fact can be used to force application re-installation\nUI can be blocked until all migrations are applied (using the infrastructure provided in #5064, this can be as easy as adding a mixin to base activity)\nmigration status flag is observable\n\nIssues with test environment\nThings are not straightforward, unfortunately and I discovered some problems with androidTest environment.\n\nContrary to local tests running in vanilla JVM, Mockito bytecode generator has some limitations on Android:\nspy() didn't work at all for me; this could be related to  mockito/mockito-kotlin#374\nCannot mock invoke() (so can't use mocked functions)\nCannot mock classes in Kotlin by default, only interfaces; Kotlin classes are final to discourage\ninheritance abuse and must be opened for mocking.\nFor some rason, I cannot run all tests in IDE, only clicking them 1-by-1; instrumentation terminates unexpectedly; This could be just my IDE issue so I'd like to ask other devs for confirmation.\nCannot run androidTests in QA/Dev build due to incompatible user ID (somehting related to screenshots); capability to run tests in non-GPlay variant is important for contributors who use their phone and don't want to overwrite their gplay daily driver app with development build.\nCannot use backticks to name test functions as test titles and linter enforces camelCaseNames which are imo less readable as test titles (this is easily solvable by Detekt config).\n\nTODO\n\n Decide what to do when migration fails - we still don't have a valid strategy for now, so the code only supplies a status flag and carries on - this is the current behaviour\n Decide if we still wan to use androidTest for it; in the context of mocking troubles, it's not so black-white anymore\n Linter cleanup for sure\n Replace MainApp.java:264 call with a call to migration manager\n Address migrations that can be re-run after failure (\"optional\")\n build.gradle cleanup\n Verify if user id migration can be applied only once or needs to be re-applied after new account creation\n\n@AndyScherzinger @tobiasKaminsky review pls\nSigned-off-by: Chris Narkiewicz hello@ezaquarii.com", "createdAt": "2020-02-28T23:39:26Z", "url": "https://github.com/nextcloud/android/pull/5546", "merged": true, "mergeCommit": {"oid": "581c12a86790cbcf1aa0692d5747a62cd4f13ff6"}, "closed": true, "closedAt": "2020-03-06T11:25:24Z", "author": {"login": "ezaquarii"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJMUFeABqjMwODUxMDI5OTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK8z6iABqjMxMDQ2MjkyMDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3ed1f4b98ad1290d1539d303452d82afa39e304", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/c3ed1f4b98ad1290d1539d303452d82afa39e304", "committedDate": "2020-02-28T23:36:25Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "bf3f398dd565e91d066cd2593fae331604fa1447", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/bf3f398dd565e91d066cd2593fae331604fa1447", "committedDate": "2020-02-29T22:31:16Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf3f398dd565e91d066cd2593fae331604fa1447", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/bf3f398dd565e91d066cd2593fae331604fa1447", "committedDate": "2020-02-29T22:31:16Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "9e00fd0dcbc82924d3e972718d4da99989cccff2", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/9e00fd0dcbc82924d3e972718d4da99989cccff2", "committedDate": "2020-02-29T22:53:31Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e00fd0dcbc82924d3e972718d4da99989cccff2", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/9e00fd0dcbc82924d3e972718d4da99989cccff2", "committedDate": "2020-02-29T22:53:31Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "e34999b49e79054ee1214fa0a8a9e8d65a7b2092", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/e34999b49e79054ee1214fa0a8a9e8d65a7b2092", "committedDate": "2020-03-01T06:43:46Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e34999b49e79054ee1214fa0a8a9e8d65a7b2092", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/e34999b49e79054ee1214fa0a8a9e8d65a7b2092", "committedDate": "2020-03-01T06:43:46Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "c930137860869e2b0fc6279f96e986ee10d364c2", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/c930137860869e2b0fc6279f96e986ee10d364c2", "committedDate": "2020-03-01T08:35:04Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c930137860869e2b0fc6279f96e986ee10d364c2", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/c930137860869e2b0fc6279f96e986ee10d364c2", "committedDate": "2020-03-01T08:35:04Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "553a52ec20b431a4de028e37e26d5995bbe6cce9", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/553a52ec20b431a4de028e37e26d5995bbe6cce9", "committedDate": "2020-03-01T21:47:21Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "553a52ec20b431a4de028e37e26d5995bbe6cce9", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/553a52ec20b431a4de028e37e26d5995bbe6cce9", "committedDate": "2020-03-01T21:47:21Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "e51b8e70690c4fd052da88d37a925de97d718f99", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/e51b8e70690c4fd052da88d37a925de97d718f99", "committedDate": "2020-03-03T06:11:33Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "947d5fe2e97e7a2b4baeb325b2d50cf86d9a2f75", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/947d5fe2e97e7a2b4baeb325b2d50cf86d9a2f75", "committedDate": "2020-03-03T23:13:58Z", "message": "Enabled migration manager in MainApp\n\nMigration manager added to DI.\n\nMigration manager called in place of legacy migration code."}, "afterCommit": {"oid": "e80c2a0e2cddee877b4c6b4c07143fcaa328353a", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/e80c2a0e2cddee877b4c6b4c07143fcaa328353a", "committedDate": "2020-03-03T23:17:48Z", "message": "Enabled migration manager in MainApp\n\nMigration manager added to DI.\n\nMigration manager called in place of legacy migration code.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e956d5580337734e86a72ed3d233a91cb7fce0a", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/6e956d5580337734e86a72ed3d233a91cb7fce0a", "committedDate": "2020-03-04T06:07:47Z", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "62407e5c5c60f1b4bfec363c362527c4fc13bd2d", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/62407e5c5c60f1b4bfec363c362527c4fc13bd2d", "committedDate": "2020-03-04T06:14:29Z", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62407e5c5c60f1b4bfec363c362527c4fc13bd2d", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/62407e5c5c60f1b4bfec363c362527c4fc13bd2d", "committedDate": "2020-03-04T06:14:29Z", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "22c9c7a1b6317ecac730147c17d4aaa1537b23a8", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/22c9c7a1b6317ecac730147c17d4aaa1537b23a8", "committedDate": "2020-03-04T06:16:40Z", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTI2NTY4", "url": "https://github.com/nextcloud/android/pull/5546#pullrequestreview-369526568", "createdAt": "2020-03-05T12:26:36Z", "commit": {"oid": "22c9c7a1b6317ecac730147c17d4aaa1537b23a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMjoyNjozNlrOFyRmag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMjoyNjozNlrOFyRmag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI2MTQ4Mg==", "bodyText": "typo: account", "url": "https://github.com/nextcloud/android/pull/5546#discussion_r388261482", "createdAt": "2020-03-05T12:26:36Z", "author": {"login": "tobiasKaminsky"}, "path": "src/main/java/com/nextcloud/client/migrations/Migrations.kt", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Nextcloud Android client application\n+ *\n+ * @author Chris Narkiewicz\n+ * Copyright (C) 2020 Chris Narkiewicz <hello@ezaquarii.com>\n+ *\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with this program. If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.nextcloud.client.migrations\n+\n+import com.nextcloud.client.account.UserAccountManager\n+import javax.inject.Inject\n+import kotlin.IllegalStateException\n+\n+/**\n+ * This class collects all migration steps and provides API to supply those\n+ * steps to [MigrationsManager] for execution.\n+ *\n+ * Note to maintainers: put all migration routines here and export collection of\n+ * opaque [Runnable]s via steps property.\n+ */\n+class Migrations @Inject constructor(\n+    private val userAccountManager: UserAccountManager\n+) {\n+\n+    /**\n+     * @param id Step id; id must be unique\n+     * @param description Human readable migration step description\n+     * @param function Migration runnable object\n+     * @param mandatory If true, failing migration will cause an exception; if false, it will be skipped and repeated\n+     *                  again on next startup\n+     */\n+    data class Step(val id: Int, val description: String, val function: Runnable, val mandatory: Boolean = true)\n+\n+    /**\n+     * List of migration steps. Those steps will be loaded and run by [MigrationsManager]\n+     */\n+    val steps: List<Step> = listOf(\n+        Step(0, \"migrate user id\", Runnable { migrateUserId() }, false)\n+    ).sortedBy { it.id }\n+\n+    fun migrateUserId() {\n+        val allAccuntsHaveUserId = userAccountManager.migrateUserId()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22c9c7a1b6317ecac730147c17d4aaa1537b23a8"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTI3OTcz", "url": "https://github.com/nextcloud/android/pull/5546#pullrequestreview-369527973", "createdAt": "2020-03-05T12:28:59Z", "commit": {"oid": "22c9c7a1b6317ecac730147c17d4aaa1537b23a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22c9c7a1b6317ecac730147c17d4aaa1537b23a8", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/22c9c7a1b6317ecac730147c17d4aaa1537b23a8", "committedDate": "2020-03-04T06:16:40Z", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "7d4f446586a8cd639e2947a0cbc133ef651b867e", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/7d4f446586a8cd639e2947a0cbc133ef651b867e", "committedDate": "2020-03-05T21:03:40Z", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b87bf1f10e631786dfee9203813835595f615292", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/b87bf1f10e631786dfee9203813835595f615292", "committedDate": "2020-03-06T09:35:56Z", "message": "Migrations manager\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ab8d98d8510a0168bc4139e47f7758fc56988d2", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/1ab8d98d8510a0168bc4139e47f7758fc56988d2", "committedDate": "2020-03-06T09:35:57Z", "message": "Support for optional migrations\n\nOptional migrations care not causing migration failure\nand can be applied again on next application run.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "439dd4ff780fe9501be1a066ea1f99d7884aae2a", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/439dd4ff780fe9501be1a066ea1f99d7884aae2a", "committedDate": "2020-03-06T09:35:57Z", "message": "Removed MigrationManager Robolectric tests\n\nRobolectric tests are removed as we don't want to emulate\nplatform.\n\nRenamed instrumentation tests to match expected naming.\n\nUpdated detekt rule to allow human readable test function\nnames in kt files. This naming convention was adopted in\ntest code to enable human-readable test reports, but\nDEX does not support spaces in names. Underscore _ is\na good replacement providnig similar level of readability.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ef27576e1742ff5fdabc99bfd52baddf53b818b", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/9ef27576e1742ff5fdabc99bfd52baddf53b818b", "committedDate": "2020-03-06T09:35:57Z", "message": "Enabled migration manager in MainApp\n\nMigration manager added to DI.\n\nMigration manager called in place of legacy migration code.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ba288e5e68a1918baffda2cec45fe6a4b310333", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/1ba288e5e68a1918baffda2cec45fe6a4b310333", "committedDate": "2020-03-06T09:35:57Z", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5872a973a799e088501f4e19d08c231488d9ad19", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/5872a973a799e088501f4e19d08c231488d9ad19", "committedDate": "2020-03-06T09:36:10Z", "message": "Bump after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d4f446586a8cd639e2947a0cbc133ef651b867e", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/7d4f446586a8cd639e2947a0cbc133ef651b867e", "committedDate": "2020-03-05T21:03:40Z", "message": "Properly signal error when user id migration fails\n\nPrevious implementation was returning success status\nwhen *any* account was migrated, despite possible\nfailures.\n\nReturn error when any account fails to be migrated.\n\nThe migration remines idempotent and can be re-run\nagain, until if finally succeeds.\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "5872a973a799e088501f4e19d08c231488d9ad19", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/5872a973a799e088501f4e19d08c231488d9ad19", "committedDate": "2020-03-06T09:36:10Z", "message": "Bump after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4727, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}