{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NTk0ODEx", "number": 6035, "title": "Add etag column to capabilities table", "bodyText": "Requires nextcloud/android-library#434\n Reset androidLibraryVersion to master-SNAPSHOT\n\nTesting\nWriting tests is very important. Please try to write some tests for your PR.\nIf you need help, please do not hesitate to ask in this PR for help.\nunit tests\ninstrumented tests\nUI tests\n\n Tests written, or not not needed", "createdAt": "2020-05-09T16:02:39Z", "url": "https://github.com/nextcloud/android/pull/6035", "merged": true, "mergeCommit": {"oid": "d1f17df63cf30d17afb7686b9c184c35ec2d2119"}, "closed": true, "closedAt": "2020-06-05T05:28:07Z", "author": {"login": "kesselb"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfotg3gBqjMzMTk1MTU4OTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoGnSqAFqTQyNDkwMDI0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b2585282f6e2d17f62bbce1276ddb95fe3b3399", "author": {"user": {"login": "kesselb", "name": "Daniel"}}, "url": "https://github.com/nextcloud/android/commit/6b2585282f6e2d17f62bbce1276ddb95fe3b3399", "committedDate": "2020-05-09T16:01:49Z", "message": "Add etag column to capabilities table"}, "afterCommit": {"oid": "4dd87cc07081bc317790065a46ad57cd99beb888", "author": {"user": {"login": "kesselb", "name": "Daniel"}}, "url": "https://github.com/nextcloud/android/commit/4dd87cc07081bc317790065a46ad57cd99beb888", "committedDate": "2020-05-09T16:03:27Z", "message": "Add etag column to capabilities table\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5902600d7b6690b47ddd27183784c5d901fc4b6", "author": {"user": {"login": "kesselb", "name": "Daniel"}}, "url": "https://github.com/nextcloud/android/commit/e5902600d7b6690b47ddd27183784c5d901fc4b6", "committedDate": "2020-05-09T16:13:21Z", "message": "Merge remote-tracking branch 'origin/enh/capabilities-etag' into enh/capabilities-etag"}, "afterCommit": {"oid": "552a058fc6a05bd4086f6a494ed8d330529b5b46", "author": {"user": {"login": "kesselb", "name": "Daniel"}}, "url": "https://github.com/nextcloud/android/commit/552a058fc6a05bd4086f6a494ed8d330529b5b46", "committedDate": "2020-05-09T16:13:01Z", "message": "Update androidLibraryVersion for testing\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Njg2MjQw", "url": "https://github.com/nextcloud/android/pull/6035#pullrequestreview-408686240", "createdAt": "2020-05-09T21:40:06Z", "commit": {"oid": "552a058fc6a05bd4086f6a494ed8d330529b5b46"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQyMTo0MDowNlrOGS-XxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQyMTo0MTo1MlrOGS-YdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU0OTQ0NQ==", "bodyText": "there should be 1 statement per line\nsave the storage manager into a final so we don't need to call the getter over and over again; bonus: value returned by the getter can become null between invocations, defying safety null check.\nsame for account", "url": "https://github.com/nextcloud/android/pull/6035#discussion_r422549445", "createdAt": "2020-05-09T21:40:06Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/owncloud/android/operations/GetCapabilitiesOperation.java", "diffHunk": "@@ -32,8 +32,13 @@\n \n     @Override\n     protected RemoteOperationResult run(OwnCloudClient client) {\n-        GetCapabilitiesRemoteOperation getCapabilities = new GetCapabilitiesRemoteOperation();\n-        RemoteOperationResult result = getCapabilities.execute(client);\n+        OCCapability currentCapability = null;\n+\n+        if (getStorageManager() != null && getStorageManager().getAccount() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "552a058fc6a05bd4086f6a494ed8d330529b5b46"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU0OTYyMA==", "bodyText": "Ok, so what happens if the upgrade fails? It looks like we completely ignore that fac and just happily continue like all is fine. This is pretty much undefined behavior.", "url": "https://github.com/nextcloud/android/pull/6035#discussion_r422549620", "createdAt": "2020-05-09T21:41:52Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/owncloud/android/providers/FileContentProvider.java", "diffHunk": "@@ -2193,6 +2194,24 @@ public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n             if (!upgraded) {\n                 Log_OC.i(SQL, String.format(Locale.ENGLISH, UPGRADE_VERSION_MSG, oldVersion, newVersion));\n             }\n+\n+            if (oldVersion < 56 && newVersion >= 56) {\n+                Log_OC.i(SQL, \"Entering in the #56 add etag for capabilities\");\n+                db.beginTransaction();\n+                try {\n+                    db.execSQL(ALTER_TABLE + ProviderTableMeta.CAPABILITIES_TABLE_NAME +\n+                                   ADD_COLUMN + ProviderTableMeta.CAPABILITIES_ETAG + \" TEXT \");\n+\n+                    upgraded = true;\n+                    db.setTransactionSuccessful();\n+                } finally {\n+                    db.endTransaction();\n+                }\n+            }\n+\n+            if (!upgraded) {\n+                Log_OC.i(SQL, String.format(Locale.ENGLISH, UPGRADE_VERSION_MSG, oldVersion, newVersion));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "552a058fc6a05bd4086f6a494ed8d330529b5b46"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f3d39af85bc1c6775cda90a6741b1f5c87ceaaf", "author": {"user": {"login": "kesselb", "name": "Daniel"}}, "url": "https://github.com/nextcloud/android/commit/9f3d39af85bc1c6775cda90a6741b1f5c87ceaaf", "committedDate": "2020-05-10T20:30:37Z", "message": "Add local variable for storageManager\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>"}, "afterCommit": {"oid": "f6876d4698a24afd5bce9ab0070d5d37034a7acf", "author": {"user": {"login": "kesselb", "name": "Daniel"}}, "url": "https://github.com/nextcloud/android/commit/f6876d4698a24afd5bce9ab0070d5d37034a7acf", "committedDate": "2020-05-18T12:03:27Z", "message": "Add local variable for storageManager\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNTc4MTMx", "url": "https://github.com/nextcloud/android/pull/6035#pullrequestreview-413578131", "createdAt": "2020-05-18T13:10:40Z", "commit": {"oid": "f6876d4698a24afd5bce9ab0070d5d37034a7acf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca8a89b9303a6f9c158c01c883b6ea4ffe36011b", "author": {"user": {"login": "kesselb", "name": "Daniel"}}, "url": "https://github.com/nextcloud/android/commit/ca8a89b9303a6f9c158c01c883b6ea4ffe36011b", "committedDate": "2020-06-04T13:14:55Z", "message": "Add etag column to capabilities table\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a86038ebabec98286b5fa5572ba639ab6459c8b2", "author": {"user": {"login": "kesselb", "name": "Daniel"}}, "url": "https://github.com/nextcloud/android/commit/a86038ebabec98286b5fa5572ba639ab6459c8b2", "committedDate": "2020-06-04T13:14:57Z", "message": "Add local variable for storageManager\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14", "committedDate": "2020-06-04T13:16:57Z", "message": "Fix after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6876d4698a24afd5bce9ab0070d5d37034a7acf", "author": {"user": {"login": "kesselb", "name": "Daniel"}}, "url": "https://github.com/nextcloud/android/commit/f6876d4698a24afd5bce9ab0070d5d37034a7acf", "committedDate": "2020-05-18T12:03:27Z", "message": "Add local variable for storageManager\n\nSigned-off-by: Daniel Kesselberg <mail@danielkesselberg.de>"}, "afterCommit": {"oid": "2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14", "committedDate": "2020-06-04T13:16:57Z", "message": "Fix after rebase\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDMwMjQ0", "url": "https://github.com/nextcloud/android/pull/6035#pullrequestreview-424430244", "createdAt": "2020-06-04T13:17:35Z", "commit": {"oid": "2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NTI4NzQ5", "url": "https://github.com/nextcloud/android/pull/6035#pullrequestreview-424528749", "createdAt": "2020-06-04T14:48:33Z", "commit": {"oid": "2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTAwMjQ2", "url": "https://github.com/nextcloud/android/pull/6035#pullrequestreview-424900246", "createdAt": "2020-06-04T23:25:24Z", "commit": {"oid": "2a3fd4287e3f5ea364ad9d1b84f4e3e5eb8eea14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4613, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}