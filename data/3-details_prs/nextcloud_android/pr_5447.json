{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMzc1NTc0", "number": 5447, "title": "Migrate jobs to new user model", "bodyText": "Jobs are migrated to new user model.\nSome of the APIs that jobs use are not yet user-ready - we use toPlatformAccount. As ususal, the plan is to scoop those cases when we refactor those dependencies.\nThere should be no changes in logic - this is pretty mechanical change.", "createdAt": "2020-02-10T22:00:44Z", "url": "https://github.com/nextcloud/android/pull/5447", "merged": true, "mergeCommit": {"oid": "4616b0d40b01303627098712e1632c1b00b7eb1a"}, "closed": true, "closedAt": "2020-02-17T09:40:05Z", "author": {"login": "ezaquarii"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDEilXgBqjMwMjQ1NDU2OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcENp3AAFqTM1ODg3MjgxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9301750ca30af05556a98032098ca36c87fa3e89", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/9301750ca30af05556a98032098ca36c87fa3e89", "committedDate": "2020-02-10T21:59:57Z", "message": "Migrated jobs to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "0e0be9207baae0a24d3e168eec46055149d0351a", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/0e0be9207baae0a24d3e168eec46055149d0351a", "committedDate": "2020-02-10T22:05:02Z", "message": "Migrated jobs to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0afc2645c437dfd63b706945127971536c0e9e5d", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/0afc2645c437dfd63b706945127971536c0e9e5d", "committedDate": "2020-02-14T06:22:20Z", "message": "Migrated jobs to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e0be9207baae0a24d3e168eec46055149d0351a", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/0e0be9207baae0a24d3e168eec46055149d0351a", "committedDate": "2020-02-10T22:05:02Z", "message": "Migrated jobs to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}, "afterCommit": {"oid": "0afc2645c437dfd63b706945127971536c0e9e5d", "author": {"user": {"login": "ezaquarii", "name": "Chris Narkiewicz"}}, "url": "https://github.com/nextcloud/android/commit/0afc2645c437dfd63b706945127971536c0e9e5d", "committedDate": "2020-02-14T06:22:20Z", "message": "Migrated jobs to new user model\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODI2Njky", "url": "https://github.com/nextcloud/android/pull/5447#pullrequestreview-358826692", "createdAt": "2020-02-14T09:56:54Z", "commit": {"oid": "0afc2645c437dfd63b706945127971536c0e9e5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwOTo1Njo1NFrOFpxJ9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwOTo1Njo1NFrOFpxJ9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0MTMwMQ==", "bodyText": "I know that this was used before, so I am totally fine to re-use this.\nBut as our approach as to get rid of 3rd party libs, we should think about removing EventBus and evernote Job scheduling, but rely on WorkManager and\n[https://developer.android.com/topic/libraries/architecture/workmanager/how-to/states-and-observation#observing](observing your work)\nBut let us do this in a following PR, please :-)", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379341301", "createdAt": "2020-02-14T09:56:54Z", "author": {"login": "tobiasKaminsky"}, "path": "src/main/java/com/owncloud/android/jobs/AccountRemovalJob.java", "diffHunk": "@@ -75,100 +76,121 @@\n /**\n  * Removes account and all local files\n  */\n-public class AccountRemovalJob extends Job implements AccountManagerCallback<Boolean> {\n+public class AccountRemovalJob extends Job {\n     public static final String TAG = \"AccountRemovalJob\";\n     public static final String ACCOUNT = \"account\";\n     public static final String REMOTE_WIPE = \"remote_wipe\";\n \n     private final UploadsStorageManager uploadsStorageManager;\n     private final UserAccountManager userAccountManager;\n     private final Clock clock;\n+    private final EventBus eventBus;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0afc2645c437dfd63b706945127971536c0e9e5d"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/7b4e1b82e3b48756f75f135451825fe25e43838d", "committedDate": "2020-02-14T10:08:38Z", "message": "change cancelContactBackupJobForAccount to user new User class\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODM0Mjk1", "url": "https://github.com/nextcloud/android/pull/5447#pullrequestreview-358834295", "createdAt": "2020-02-14T10:09:06Z", "commit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODM1OTE3", "url": "https://github.com/nextcloud/android/pull/5447#pullrequestreview-358835917", "createdAt": "2020-02-14T10:11:48Z", "commit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDoxMTo0OFrOFpxnLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDoxMTo0OFrOFpxnLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0ODc4Mg==", "bodyText": "Issue found: Avoid instantiating new objects inside loops", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379348782", "createdAt": "2020-02-14T10:11:48Z", "author": {"login": "nextcloud-android-bot"}, "path": "src/main/java/com/owncloud/android/jobs/OfflineSyncJob.java", "diffHunk": "@@ -89,10 +90,10 @@ protected Result onRunJob(@NonNull Params params) {\n                 }\n             }\n \n-            Account[] accounts = userAccountManager.getAccounts();\n+            List<User> users = userAccountManager.getAllUsers();\n \n-            for (Account account : accounts) {\n-                FileDataStorageManager storageManager = new FileDataStorageManager(account,\n+            for (User user : users) {\n+                FileDataStorageManager storageManager = new FileDataStorageManager(user.toPlatformAccount(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODM1OTMy", "url": "https://github.com/nextcloud/android/pull/5447#pullrequestreview-358835932", "createdAt": "2020-02-14T10:11:49Z", "commit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDoxMTo0OVrOFpxnOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDoxMTo0OVrOFpxnOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0ODc5Mg==", "bodyText": "Issue found: Avoid instantiating new objects inside loops", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379348792", "createdAt": "2020-02-14T10:11:49Z", "author": {"login": "nextcloud-android-bot"}, "path": "src/main/java/com/owncloud/android/jobs/OfflineSyncJob.java", "diffHunk": "@@ -101,7 +102,7 @@ protected Result onRunJob(@NonNull Params params) {\n                     break;\n                 }\n \n-                recursive(new File(ocRoot.getStoragePath()), storageManager, account);\n+                recursive(new File(ocRoot.getStoragePath()), storageManager, user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODM1OTQ1", "url": "https://github.com/nextcloud/android/pull/5447#pullrequestreview-358835945", "createdAt": "2020-02-14T10:11:50Z", "commit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDoxMTo1MFrOFpxnQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDoxMTo1MFrOFpxnQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0ODgwMg==", "bodyText": "Issue found: Deeply nested if..then statements are hard to read", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379348802", "createdAt": "2020-02-14T10:11:50Z", "author": {"login": "nextcloud-android-bot"}, "path": "src/main/java/com/owncloud/android/jobs/MediaFoldersDetectionJob.java", "diffHunk": "@@ -138,32 +138,41 @@ protected Result onRunJob(@NonNull Params params) {\n                 videoMediaFolderPaths.removeAll(mediaFoldersModel.getVideoMediaFolders());\n \n                 if (!imageMediaFolderPaths.isEmpty() || !videoMediaFolderPaths.isEmpty()) {\n-                    Account[] accounts = userAccountManager.getAccounts();\n-                    List<Account> accountList = new ArrayList<>();\n-                    for (Account account : accounts) {\n-                        if (!arbitraryDataProvider.getBooleanValue(account, ManageAccountsActivity.PENDING_FOR_REMOVAL)) {\n-                            accountList.add(account);\n+                    List<User> allUsers = userAccountManager.getAllUsers();\n+                    List<User> activeUsers = new ArrayList<>();\n+                    for (User account : allUsers) {\n+                        if (!arbitraryDataProvider.getBooleanValue(account.toPlatformAccount(),\n+                                                                   ManageAccountsActivity.PENDING_FOR_REMOVAL)) {\n+                            activeUsers.add(account);\n                         }\n                     }\n \n-                    for (Account account : accountList) {\n+                    for (User user : activeUsers) {\n                         for (String imageMediaFolder : imageMediaFolderPaths) {\n-                            if (syncedFolderProvider.findByLocalPathAndAccount(imageMediaFolder, account) == null) {\n-                                sendNotification(String.format(context.getString(R.string.new_media_folder_detected),\n-                                    context.getString(R.string.new_media_folder_photos)),\n-                                    imageMediaFolder.substring(imageMediaFolder.lastIndexOf('/') + 1\n-                                    ),\n-                                    account, imageMediaFolder, 1);\n+                            final SyncedFolder folder = syncedFolderProvider.findByLocalPathAndAccount(imageMediaFolder,\n+                                                                                                       user.toPlatformAccount());\n+                            if (folder == null) {\n+                                String contentTitle = String.format(context.getString(R.string.new_media_folder_detected),\n+                                                                    context.getString(R.string.new_media_folder_photos));\n+                                sendNotification(contentTitle,\n+                                                imageMediaFolder.substring(imageMediaFolder.lastIndexOf('/') + 1),\n+                                                user,\n+                                                imageMediaFolder,\n+                                                 1);\n                             }\n                         }\n \n                         for (String videoMediaFolder : videoMediaFolderPaths) {\n-                            if (syncedFolderProvider.findByLocalPathAndAccount(videoMediaFolder, account) == null) {\n-                                sendNotification(String.format(context.getString(R.string.new_media_folder_detected),\n-                                    context.getString(R.string.new_media_folder_videos)),\n-                                    videoMediaFolder.substring(videoMediaFolder.lastIndexOf('/') + 1\n-                                    ),\n-                                    account, videoMediaFolder, 2);\n+                            final SyncedFolder folder = syncedFolderProvider.findByLocalPathAndAccount(videoMediaFolder,\n+                                                                                                       user.toPlatformAccount());\n+                            if (folder == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODM1OTYx", "url": "https://github.com/nextcloud/android/pull/5447#pullrequestreview-358835961", "createdAt": "2020-02-14T10:11:51Z", "commit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDoxMTo1MVrOFpxnUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDoxMTo1MVrOFpxnUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0ODgxOQ==", "bodyText": "Issue found: Deeply nested if..then statements are hard to read", "url": "https://github.com/nextcloud/android/pull/5447#discussion_r379348819", "createdAt": "2020-02-14T10:11:51Z", "author": {"login": "nextcloud-android-bot"}, "path": "src/main/java/com/owncloud/android/jobs/MediaFoldersDetectionJob.java", "diffHunk": "@@ -138,32 +138,41 @@ protected Result onRunJob(@NonNull Params params) {\n                 videoMediaFolderPaths.removeAll(mediaFoldersModel.getVideoMediaFolders());\n \n                 if (!imageMediaFolderPaths.isEmpty() || !videoMediaFolderPaths.isEmpty()) {\n-                    Account[] accounts = userAccountManager.getAccounts();\n-                    List<Account> accountList = new ArrayList<>();\n-                    for (Account account : accounts) {\n-                        if (!arbitraryDataProvider.getBooleanValue(account, ManageAccountsActivity.PENDING_FOR_REMOVAL)) {\n-                            accountList.add(account);\n+                    List<User> allUsers = userAccountManager.getAllUsers();\n+                    List<User> activeUsers = new ArrayList<>();\n+                    for (User account : allUsers) {\n+                        if (!arbitraryDataProvider.getBooleanValue(account.toPlatformAccount(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4ODcyODE5", "url": "https://github.com/nextcloud/android/pull/5447#pullrequestreview-358872819", "createdAt": "2020-02-14T11:16:16Z", "commit": {"oid": "7b4e1b82e3b48756f75f135451825fe25e43838d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4792, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}