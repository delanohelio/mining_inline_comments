{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMzI2Njg4", "number": 7340, "title": "Directly start foreground service", "bodyText": "Fix #2010\nFix #6905\nThis is not done at all, but it prevents from crashing on my test device.\n@ezaquarii for some reason the startForeground in PlayerService is not called, when starting a video.\nThus it get killed by Android after a specific time.\nSigned-off-by: tobiasKaminsky tobias@kaminsky.me\nTesting\nWriting tests is very important. Please try to write some tests for your PR.\nIf you need help, please do not hesitate to ask in this PR for help.\nunit tests\ninstrumented tests\nUI tests\n\n Tests written, or not not needed", "createdAt": "2020-11-17T11:08:50Z", "url": "https://github.com/nextcloud/android/pull/7340", "merged": true, "mergeCommit": {"oid": "9a80066f9f4266ae6b8b7d57aebda67e2167dff1"}, "closed": true, "closedAt": "2020-11-20T20:27:40Z", "author": {"login": "tobiasKaminsky"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddiJmlAFqTUzMjg5NzQxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeTPQAgBqjQwMTk3NzM1ODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODk3NDE0", "url": "https://github.com/nextcloud/android/pull/7340#pullrequestreview-532897414", "createdAt": "2020-11-17T23:28:17Z", "commit": {"oid": "41dcb04a13591a3efd35a4dc8fbb1ef51c1a593c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzoyODoxN1rOH1Pr9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzoyODoxN1rOH1Pr9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5MzU5MQ==", "bodyText": "This is nasty. But if we need this workaround, I'd put it in onCreate().", "url": "https://github.com/nextcloud/android/pull/7340#discussion_r525593591", "createdAt": "2020-11-17T23:28:17Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/nextcloud/client/media/PlayerService.kt", "diffHunk": "@@ -101,6 +101,13 @@ class PlayerService : Service() {\n         stop.action = ACTION_STOP\n         val pendingStop = PendingIntent.getService(this, 0, stop, 0)\n         notificationBuilder.addAction(0, \"STOP\", pendingStop)\n+\n+        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41dcb04a13591a3efd35a4dc8fbb1ef51c1a593c"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41dcb04a13591a3efd35a4dc8fbb1ef51c1a593c", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/41dcb04a13591a3efd35a4dc8fbb1ef51c1a593c", "committedDate": "2020-11-17T11:06:49Z", "message": "wip\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}, "afterCommit": {"oid": "8f17962bd8bcd9c5390b897798f3cf3ecdaa7f56", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/8f17962bd8bcd9c5390b897798f3cf3ecdaa7f56", "committedDate": "2020-11-18T07:48:44Z", "message": "Fix falsely starting player service when previewing video\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0Nzc2MjE1", "url": "https://github.com/nextcloud/android/pull/7340#pullrequestreview-534776215", "createdAt": "2020-11-19T19:24:10Z", "commit": {"oid": "8f17962bd8bcd9c5390b897798f3cf3ecdaa7f56"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOToyNDoxMFrOH2uGYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOToyNDoxMFrOH2uGYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0MDQ0OA==", "bodyText": "This looks like a solution for this case.\nHowever, because stopAudio() results in Intent being sent to a service and thus it starts the service, the call is simply not safe to use in other places. I think we should internally call Service.stopSelf() if there is nothing to play as well.", "url": "https://github.com/nextcloud/android/pull/7340#discussion_r527140448", "createdAt": "2020-11-19T19:24:10Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/owncloud/android/ui/preview/PreviewMediaFragment.java", "diffHunk": "@@ -324,7 +324,9 @@ public void onStart() {\n                 mMultiListContainer.setVisibility(View.GONE);\n                 mPreviewContainer.setVisibility(View.VISIBLE);\n             } else if (MimeTypeUtil.isVideo(file)) {\n-                stopAudio();\n+                if (mMediaPlayerServiceConnection.isConnected() && mMediaPlayerServiceConnection.isPlaying()) {\n+                    stopAudio();\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f17962bd8bcd9c5390b897798f3cf3ecdaa7f56"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be223883c230e0f946944da1660204aaf27201e1", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/be223883c230e0f946944da1660204aaf27201e1", "committedDate": "2020-11-20T08:39:38Z", "message": "Fix falsely starting player service when previewing video\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "343561a013c3fdbe84fc71f2ab3db786e54dfbbf", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/343561a013c3fdbe84fc71f2ab3db786e54dfbbf", "committedDate": "2020-11-20T08:39:38Z", "message": "Add toggle function\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1af8e419d0e222e3fd1a106a5e09bf2d9efee9cc", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/1af8e419d0e222e3fd1a106a5e09bf2d9efee9cc", "committedDate": "2020-11-20T08:39:11Z", "message": "Add toggle function\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}, "afterCommit": {"oid": "343561a013c3fdbe84fc71f2ab3db786e54dfbbf", "author": {"user": {"login": "tobiasKaminsky", "name": "Tobias Kaminsky"}}, "url": "https://github.com/nextcloud/android/commit/343561a013c3fdbe84fc71f2ab3db786e54dfbbf", "committedDate": "2020-11-20T08:39:38Z", "message": "Add toggle function\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4403, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}