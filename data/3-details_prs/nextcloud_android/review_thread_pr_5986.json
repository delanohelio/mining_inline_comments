{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExODk0NjAz", "number": 5986, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMzozNTo0NFrOD4Pimw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMTo1ODo0N1rOD5mDVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzAxNDY3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/nextcloud/client/network/Connectivity.kt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMzozNTo0NFrOGO94rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMzozNTo0NFrOGO94rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0NzE4MA==", "bodyText": "I guess we'll make use of it when we finally do async server availability API. For now, I'll put it here as a reminder/proposal for the API.", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r418347180", "createdAt": "2020-04-30T23:35:44Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/nextcloud/client/network/Connectivity.kt", "diffHunk": "@@ -0,0 +1,13 @@\n+package com.nextcloud.client.network\n+\n+data class Connectivity(\n+    val isConnected: Boolean = false,\n+    val isMetered: Boolean = false,\n+    val isWifi: Boolean = false,\n+    val isServerAvailable: Boolean? = null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcbff7019b8537f7bff9e4f96fbce283fb817dff"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzAyMjg2OnYy", "diffSide": "LEFT", "path": "src/main/java/com/owncloud/android/files/services/FileUploader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMzo0MDoxMVrOGO99xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNToyNjowN1rOGQFg8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0ODQ4Ng==", "bodyText": "I don't get what was the purpose of this line?", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r418348486", "createdAt": "2020-04-30T23:40:11Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/owncloud/android/files/services/FileUploader.java", "diffHunk": "@@ -1027,7 +1026,6 @@ public static void retryFailedUploads(\n                         uploadsStorageManager.updateUpload(failedUpload);\n                     }\n                 } else {\n-                    charging = charging || Device.getBatteryStatus(context).getBatteryPercent() == 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcbff7019b8537f7bff9e4f96fbce283fb817dff"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUyMDc1Mg==", "bodyText": "This checks if battery is 100%.\nI assume that on some strange devices charging state is not shown correct and therefore 100% is assumed as \"ongoing charging\".", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419520752", "createdAt": "2020-05-04T15:26:07Z", "author": {"login": "tobiasKaminsky"}, "path": "src/main/java/com/owncloud/android/files/services/FileUploader.java", "diffHunk": "@@ -1027,7 +1026,6 @@ public static void retryFailedUploads(\n                         uploadsStorageManager.updateUpload(failedUpload);\n                     }\n                 } else {\n-                    charging = charging || Device.getBatteryStatus(context).getBatteryPercent() == 1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0ODQ4Ng=="}, "originalCommit": {"oid": "fcbff7019b8537f7bff9e4f96fbce283fb817dff"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzI2ODg0OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/nextcloud/client/jobs/BackgroundJobFactoryTest.kt", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjowODoyMFrOGPAN1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNToyODowMFrOGQFmIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NTM2NA==", "bodyText": "This is unrelated, but it was broken. I guess that it slipped through because we have permanently failing IT tests and probably didn't eyeball the failing test list carefully enough.", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r418385364", "createdAt": "2020-05-01T02:08:20Z", "author": {"login": "ezaquarii"}, "path": "src/test/java/com/nextcloud/client/jobs/BackgroundJobFactoryTest.kt", "diffHunk": "@@ -86,6 +88,12 @@ class BackgroundJobFactoryTest {\n     @Mock\n     private lateinit var connectivityService: ConnectivityService\n \n+    @Mock\n+    private lateinit var notificationManager: NotificationManager", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ec762678f492fbe0878306e85d6353a3501db84"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUyMjA4Mw==", "bodyText": "hm.\nSince our new approach to retry failing tests, we did not had any problems with this.\nAnd thus it should have shown this failing test\u2026\n(however, screenshots are sometimes failing, but this is in a later step)", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419522083", "createdAt": "2020-05-04T15:28:00Z", "author": {"login": "tobiasKaminsky"}, "path": "src/test/java/com/nextcloud/client/jobs/BackgroundJobFactoryTest.kt", "diffHunk": "@@ -86,6 +88,12 @@ class BackgroundJobFactoryTest {\n     @Mock\n     private lateinit var connectivityService: ConnectivityService\n \n+    @Mock\n+    private lateinit var notificationManager: NotificationManager", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NTM2NA=="}, "originalCommit": {"oid": "1ec762678f492fbe0878306e85d6353a3501db84"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzI3NDM0OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/nextcloud/client/network/ConnectivityService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjoxMjowMVrOGPAQ_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoyNTo1M1rOGQQ2Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NjE3NQ==", "bodyText": "I renamed the isInernetWalled() API.\nWe could have perfect internet connectivity but the server could be in maintenance mode, which this API checks as well. So he name referring to a \"walled garden\" probably went past it's shelf live at some point, so I renamed it.", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r418386175", "createdAt": "2020-05-01T02:12:01Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/nextcloud/client/network/ConnectivityService.java", "diffHunk": "@@ -20,10 +20,25 @@\n \n package com.nextcloud.client.network;\n \n-import com.evernote.android.job.JobRequest;\n-\n+/**\n+ * This service provides information about current network connectivity\n+ * and server reachableity.\n+ */\n public interface ConnectivityService {\n-    boolean isInternetWalled();\n-    boolean isOnlineWithWifi();\n-    JobRequest.NetworkType getActiveNetworkType();\n+\n+    /**\n+     * Check if server is accessible by issuing HTTP status check request.\n+     * Since this call involves network traffic, it should not be called\n+     * on a main thread.\n+     *\n+     * @return True if server is reachable and operational, false otherwise\n+     */\n+    boolean isServerAvailable();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ec762678f492fbe0878306e85d6353a3501db84"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNjQzNA==", "bodyText": "Nope, changing semantics from \"it is\" to \"it is not\" wasn't a terrific idea after all...", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419706434", "createdAt": "2020-05-04T20:25:53Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/nextcloud/client/network/ConnectivityService.java", "diffHunk": "@@ -20,10 +20,25 @@\n \n package com.nextcloud.client.network;\n \n-import com.evernote.android.job.JobRequest;\n-\n+/**\n+ * This service provides information about current network connectivity\n+ * and server reachableity.\n+ */\n public interface ConnectivityService {\n-    boolean isInternetWalled();\n-    boolean isOnlineWithWifi();\n-    JobRequest.NetworkType getActiveNetworkType();\n+\n+    /**\n+     * Check if server is accessible by issuing HTTP status check request.\n+     * Since this call involves network traffic, it should not be called\n+     * on a main thread.\n+     *\n+     * @return True if server is reachable and operational, false otherwise\n+     */\n+    boolean isServerAvailable();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NjE3NQ=="}, "originalCommit": {"oid": "1ec762678f492fbe0878306e85d6353a3501db84"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzI3NjQ3OnYy", "diffSide": "LEFT", "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjoxMzo0NVrOGPASPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjoxMzo0NVrOGPASPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NjQ5NA==", "bodyText": "This was confusing status... Having those flags in that varying form made simple \"connected\" statate quite unintuitive to figure out. Connectivity gives one a simpler answer.", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r418386494", "createdAt": "2020-05-01T02:13:45Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "diffHunk": "@@ -116,65 +116,37 @@ public boolean isInternetWalled() {\n                 }\n             }\n         } else {\n-            return getActiveNetworkType() == JobRequest.NetworkType.ANY;\n+            return !getConnectivity().isConnected();\n         }\n \n         return true;\n     }\n \n     @Override\n-    public boolean isOnlineWithWifi() {\n+    public Connectivity getConnectivity() {\n+        NetworkInfo ni;\n         try {\n-            NetworkInfo activeNetwork = connectivityManager.getActiveNetworkInfo();\n-\n-            if (activeNetwork.isConnectedOrConnecting()) {\n-                switch (activeNetwork.getType()) {\n-                    case ConnectivityManager.TYPE_VPN:\n-                        // check if any other network is wifi\n-                        for (NetworkInfo networkInfo : connectivityManager.getAllNetworkInfo()) {\n-                            if (networkInfo.isConnectedOrConnecting() &&\n-                                networkInfo.getType() == ConnectivityManager.TYPE_WIFI) {\n-                                return true;\n-                            }\n-                        }\n-                        return false;\n-\n-                    case ConnectivityManager.TYPE_WIFI:\n-                        return true;\n-\n-                    default:\n-                        return false;\n-                }\n-            } else {\n-                return false;\n-            }\n-        } catch (NullPointerException exception) {\n-            return false;\n-        }\n-    }\n-\n-    @Override\n-    public JobRequest.NetworkType getActiveNetworkType() {\n-        NetworkInfo networkInfo;\n-        try {\n-            networkInfo = connectivityManager.getActiveNetworkInfo();\n+            ni = platformConnectivityManager.getActiveNetworkInfo();\n         } catch (Throwable t) {\n-            return JobRequest.NetworkType.ANY;\n-        }\n-\n-        if (networkInfo == null || !networkInfo.isConnectedOrConnecting()) {\n-            return JobRequest.NetworkType.ANY;\n+            ni = null; // no network available or no information (permission denied?)\n         }\n \n-        boolean metered = ConnectivityManagerCompat.isActiveNetworkMetered(connectivityManager);\n-        if (!metered) {\n-            return JobRequest.NetworkType.UNMETERED;\n+        if (ni != null) {\n+            boolean isConnected = ni.isConnectedOrConnecting();\n+            boolean isMetered = ConnectivityManagerCompat.isActiveNetworkMetered(platformConnectivityManager);\n+            boolean isWifi = ni.getType() == ConnectivityManager.TYPE_WIFI || isAnyOtherNetworkWifi();\n+            return new Connectivity(isConnected, isMetered, isWifi, null);\n+        } else {\n+            return Connectivity.DISCONNECTED;\n         }\n+    }\n \n-        if (networkInfo.isRoaming()) {\n-            return JobRequest.NetworkType.CONNECTED;\n-        } else {\n-            return JobRequest.NetworkType.NOT_ROAMING;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ec762678f492fbe0878306e85d6353a3501db84"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzI3ODgxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/nextcloud/client/device/PowerManagementServiceImpl.kt", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjoxNTowNlrOGPATdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwMjoxNTowNlrOGPATdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NjgwNQ==", "bodyText": "I was considering adding another API but realized that those queries go over IPC to another process. Having a one-stop-shop for complete status is slightly more performant.", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r418386805", "createdAt": "2020-05-01T02:15:06Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/nextcloud/client/device/PowerManagementServiceImpl.kt", "diffHunk": "@@ -71,16 +71,24 @@ internal class PowerManagementServiceImpl(\n     override val isPowerSavingExclusionAvailable: Boolean\n         get() = deviceInfo.vendor in OVERLY_AGGRESSIVE_POWER_SAVING_VENDORS\n \n-    override val isBatteryCharging: Boolean\n+    override val battery: BatteryStatus", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ec762678f492fbe0878306e85d6353a3501db84"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMTM2MjY1OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNToyNDoxN1rOGQFb0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoyNjozM1rOGQQ3oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxOTQ0MA==", "bodyText": "Can we keep networkInfo?", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419519440", "createdAt": "2020-05-04T15:24:17Z", "author": {"login": "tobiasKaminsky"}, "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "diffHunk": "@@ -116,65 +116,37 @@ public boolean isInternetWalled() {\n                 }\n             }\n         } else {\n-            return getActiveNetworkType() == JobRequest.NetworkType.ANY;\n+            return !getConnectivity().isConnected();\n         }\n \n         return true;\n     }\n \n     @Override\n-    public boolean isOnlineWithWifi() {\n+    public Connectivity getConnectivity() {\n+        NetworkInfo ni;\n         try {\n-            NetworkInfo activeNetwork = connectivityManager.getActiveNetworkInfo();\n-\n-            if (activeNetwork.isConnectedOrConnecting()) {\n-                switch (activeNetwork.getType()) {\n-                    case ConnectivityManager.TYPE_VPN:\n-                        // check if any other network is wifi\n-                        for (NetworkInfo networkInfo : connectivityManager.getAllNetworkInfo()) {\n-                            if (networkInfo.isConnectedOrConnecting() &&\n-                                networkInfo.getType() == ConnectivityManager.TYPE_WIFI) {\n-                                return true;\n-                            }\n-                        }\n-                        return false;\n-\n-                    case ConnectivityManager.TYPE_WIFI:\n-                        return true;\n-\n-                    default:\n-                        return false;\n-                }\n-            } else {\n-                return false;\n-            }\n-        } catch (NullPointerException exception) {\n-            return false;\n-        }\n-    }\n-\n-    @Override\n-    public JobRequest.NetworkType getActiveNetworkType() {\n-        NetworkInfo networkInfo;\n-        try {\n-            networkInfo = connectivityManager.getActiveNetworkInfo();\n+            ni = platformConnectivityManager.getActiveNetworkInfo();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f5caa45b9e84ed822808e1457052271803af484"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNjc4NQ==", "bodyText": "done", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419706785", "createdAt": "2020-05-04T20:26:33Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "diffHunk": "@@ -116,65 +116,37 @@ public boolean isInternetWalled() {\n                 }\n             }\n         } else {\n-            return getActiveNetworkType() == JobRequest.NetworkType.ANY;\n+            return !getConnectivity().isConnected();\n         }\n \n         return true;\n     }\n \n     @Override\n-    public boolean isOnlineWithWifi() {\n+    public Connectivity getConnectivity() {\n+        NetworkInfo ni;\n         try {\n-            NetworkInfo activeNetwork = connectivityManager.getActiveNetworkInfo();\n-\n-            if (activeNetwork.isConnectedOrConnecting()) {\n-                switch (activeNetwork.getType()) {\n-                    case ConnectivityManager.TYPE_VPN:\n-                        // check if any other network is wifi\n-                        for (NetworkInfo networkInfo : connectivityManager.getAllNetworkInfo()) {\n-                            if (networkInfo.isConnectedOrConnecting() &&\n-                                networkInfo.getType() == ConnectivityManager.TYPE_WIFI) {\n-                                return true;\n-                            }\n-                        }\n-                        return false;\n-\n-                    case ConnectivityManager.TYPE_WIFI:\n-                        return true;\n-\n-                    default:\n-                        return false;\n-                }\n-            } else {\n-                return false;\n-            }\n-        } catch (NullPointerException exception) {\n-            return false;\n-        }\n-    }\n-\n-    @Override\n-    public JobRequest.NetworkType getActiveNetworkType() {\n-        NetworkInfo networkInfo;\n-        try {\n-            networkInfo = connectivityManager.getActiveNetworkInfo();\n+            ni = platformConnectivityManager.getActiveNetworkInfo();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxOTQ0MA=="}, "originalCommit": {"oid": "3f5caa45b9e84ed822808e1457052271803af484"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMTM2NDM5OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNToyNDozN1rOGQFc3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDoyNjozOFrOGQQ3wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxOTcwOQ==", "bodyText": "Same here.", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419519709", "createdAt": "2020-05-04T15:24:37Z", "author": {"login": "tobiasKaminsky"}, "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "diffHunk": "@@ -116,65 +116,37 @@ public boolean isInternetWalled() {\n                 }\n             }\n         } else {\n-            return getActiveNetworkType() == JobRequest.NetworkType.ANY;\n+            return !getConnectivity().isConnected();\n         }\n \n         return true;\n     }\n \n     @Override\n-    public boolean isOnlineWithWifi() {\n+    public Connectivity getConnectivity() {\n+        NetworkInfo ni;\n         try {\n-            NetworkInfo activeNetwork = connectivityManager.getActiveNetworkInfo();\n-\n-            if (activeNetwork.isConnectedOrConnecting()) {\n-                switch (activeNetwork.getType()) {\n-                    case ConnectivityManager.TYPE_VPN:\n-                        // check if any other network is wifi\n-                        for (NetworkInfo networkInfo : connectivityManager.getAllNetworkInfo()) {\n-                            if (networkInfo.isConnectedOrConnecting() &&\n-                                networkInfo.getType() == ConnectivityManager.TYPE_WIFI) {\n-                                return true;\n-                            }\n-                        }\n-                        return false;\n-\n-                    case ConnectivityManager.TYPE_WIFI:\n-                        return true;\n-\n-                    default:\n-                        return false;\n-                }\n-            } else {\n-                return false;\n-            }\n-        } catch (NullPointerException exception) {\n-            return false;\n-        }\n-    }\n-\n-    @Override\n-    public JobRequest.NetworkType getActiveNetworkType() {\n-        NetworkInfo networkInfo;\n-        try {\n-            networkInfo = connectivityManager.getActiveNetworkInfo();\n+            ni = platformConnectivityManager.getActiveNetworkInfo();\n         } catch (Throwable t) {\n-            return JobRequest.NetworkType.ANY;\n-        }\n-\n-        if (networkInfo == null || !networkInfo.isConnectedOrConnecting()) {\n-            return JobRequest.NetworkType.ANY;\n+            ni = null; // no network available or no information (permission denied?)\n         }\n \n-        boolean metered = ConnectivityManagerCompat.isActiveNetworkMetered(connectivityManager);\n-        if (!metered) {\n-            return JobRequest.NetworkType.UNMETERED;\n+        if (ni != null) {\n+            boolean isConnected = ni.isConnectedOrConnecting();\n+            boolean isMetered = ConnectivityManagerCompat.isActiveNetworkMetered(platformConnectivityManager);\n+            boolean isWifi = ni.getType() == ConnectivityManager.TYPE_WIFI || isAnyOtherNetworkWifi();\n+            return new Connectivity(isConnected, isMetered, isWifi, null);\n+        } else {\n+            return Connectivity.DISCONNECTED;\n         }\n+    }\n \n-        if (networkInfo.isRoaming()) {\n-            return JobRequest.NetworkType.CONNECTED;\n-        } else {\n-            return JobRequest.NetworkType.NOT_ROAMING;\n+    private boolean isAnyOtherNetworkWifi() {\n+        for (NetworkInfo ni : platformConnectivityManager.getAllNetworkInfo()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f5caa45b9e84ed822808e1457052271803af484"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNjgxOA==", "bodyText": "done", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419706818", "createdAt": "2020-05-04T20:26:38Z", "author": {"login": "ezaquarii"}, "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "diffHunk": "@@ -116,65 +116,37 @@ public boolean isInternetWalled() {\n                 }\n             }\n         } else {\n-            return getActiveNetworkType() == JobRequest.NetworkType.ANY;\n+            return !getConnectivity().isConnected();\n         }\n \n         return true;\n     }\n \n     @Override\n-    public boolean isOnlineWithWifi() {\n+    public Connectivity getConnectivity() {\n+        NetworkInfo ni;\n         try {\n-            NetworkInfo activeNetwork = connectivityManager.getActiveNetworkInfo();\n-\n-            if (activeNetwork.isConnectedOrConnecting()) {\n-                switch (activeNetwork.getType()) {\n-                    case ConnectivityManager.TYPE_VPN:\n-                        // check if any other network is wifi\n-                        for (NetworkInfo networkInfo : connectivityManager.getAllNetworkInfo()) {\n-                            if (networkInfo.isConnectedOrConnecting() &&\n-                                networkInfo.getType() == ConnectivityManager.TYPE_WIFI) {\n-                                return true;\n-                            }\n-                        }\n-                        return false;\n-\n-                    case ConnectivityManager.TYPE_WIFI:\n-                        return true;\n-\n-                    default:\n-                        return false;\n-                }\n-            } else {\n-                return false;\n-            }\n-        } catch (NullPointerException exception) {\n-            return false;\n-        }\n-    }\n-\n-    @Override\n-    public JobRequest.NetworkType getActiveNetworkType() {\n-        NetworkInfo networkInfo;\n-        try {\n-            networkInfo = connectivityManager.getActiveNetworkInfo();\n+            ni = platformConnectivityManager.getActiveNetworkInfo();\n         } catch (Throwable t) {\n-            return JobRequest.NetworkType.ANY;\n-        }\n-\n-        if (networkInfo == null || !networkInfo.isConnectedOrConnecting()) {\n-            return JobRequest.NetworkType.ANY;\n+            ni = null; // no network available or no information (permission denied?)\n         }\n \n-        boolean metered = ConnectivityManagerCompat.isActiveNetworkMetered(connectivityManager);\n-        if (!metered) {\n-            return JobRequest.NetworkType.UNMETERED;\n+        if (ni != null) {\n+            boolean isConnected = ni.isConnectedOrConnecting();\n+            boolean isMetered = ConnectivityManagerCompat.isActiveNetworkMetered(platformConnectivityManager);\n+            boolean isWifi = ni.getType() == ConnectivityManager.TYPE_WIFI || isAnyOtherNetworkWifi();\n+            return new Connectivity(isConnected, isMetered, isWifi, null);\n+        } else {\n+            return Connectivity.DISCONNECTED;\n         }\n+    }\n \n-        if (networkInfo.isRoaming()) {\n-            return JobRequest.NetworkType.CONNECTED;\n-        } else {\n-            return JobRequest.NetworkType.NOT_ROAMING;\n+    private boolean isAnyOtherNetworkWifi() {\n+        for (NetworkInfo ni : platformConnectivityManager.getAllNetworkInfo()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxOTcwOQ=="}, "originalCommit": {"oid": "3f5caa45b9e84ed822808e1457052271803af484"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNzE4ODY4OnYy", "diffSide": "RIGHT", "path": "build.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMTo1ODo0N1rOGQ9HdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMTo1ODo0N1rOGQ9HdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQzMTczMg==", "bodyText": "Sadly, lint is crashing due to internal bug:\nhttps://www.kaminsky.me/nc-dev/android-lint/13796.html#LintError\n../../../src/main/java/com/nextcloud/client/jobs/BackgroundJobManagerImpl.kt: Unexpected failure during lint analysis of BackgroundJobManagerImpl.kt (this is a bug in lint or one of the libraries it depends on)\n\nMessage: null cannot be cast to non-null type kotlin.Long\n\nThe crash seems to involve the detector androidx.work.lint.InvalidPeriodicWorkRequestIntervalDetector.\nYou can try disabling it with something like this:\n    android {\n        lintOptions {\n            disable \"InvalidPeriodicWorkRequestInterval\"\n        }\n    }\n\nStack: TypeCastException:InvalidPeriodicWorkRequestIntervalDetector.visitConstructor(InvalidPeriodicWorkRequestIntervalDetector.kt:70)\n\u2190UElementVisitor$DelegatingPsiVisitor.visitNewExpression(UElementVisitor.kt:1099)\n\u2190UElementVisitor$DelegatingPsiVisitor.visitCallExpression(UElementVisitor.kt:1063)\n\u2190KotlinUFunctionCallExpression.accept(KotlinUFunctionCallExpression.kt:198)\n\u2190UQualifiedReferenceExpression$DefaultImpls.accept(UQualifiedReferenceExpression.kt:48)\n\u2190KotlinUQualifiedReferenceExpression.accept(KotlinUQualifiedReferenceExpression.kt:27)\n\u2190UQualifiedReferenceExpression$DefaultImpls.accept(UQualifiedReferenceExpression.kt:47)\n\u2190KotlinUQualifiedReferenceExpression.accept(KotlinUQualifiedReferenceExpression.kt:27)\n\nYou can set environment variable LINT_PRINT_STACKTRACE=true to dump a full stacktrace to stdout.", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r420431732", "createdAt": "2020-05-05T21:58:47Z", "author": {"login": "ezaquarii"}, "path": "build.gradle", "diffHunk": "@@ -119,7 +119,8 @@ android {\n             'IconMissingDensityFolder',\n             'IconDensities',\n             'GoogleAppIndexingWarning',\n-            'MissingDefaultResource'\n+            'MissingDefaultResource',\n+            'InvalidPeriodicWorkRequestInterval' // crashes due to a bug in lint itself", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8073a0d0038b643c740de331692e4a7f725c7770"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2996, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}