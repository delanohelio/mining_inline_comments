{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NjM3NzMx", "number": 552, "title": "[Feature] Add ability to delete features", "bodyText": "Fixes #108\n\nThis PR aims at making the Delete Feature item in menu functionable.\n\n\n Verify changes manually by double checking with remote database.\n Add tests\n\n\nSteps to verify:\n\nOpen app\nClick + to add a new feature\nSelect Delete Feature from the options menu\n\n\n@gino-m  PTAL?", "createdAt": "2020-07-23T11:13:19Z", "url": "https://github.com/google/ground-android/pull/552", "merged": true, "mergeCommit": {"oid": "12d59e5c6b49985da2179c15c59cb2ad8796597a"}, "closed": true, "closedAt": "2020-07-27T22:23:50Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3uGj7gBqjM1Nzk2MjU0Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5Jf4YAFqTQ1NjE3Njc0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4d6671edd5962b5dbe2128c483ede9b5d98fedc", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d4d6671edd5962b5dbe2128c483ede9b5d98fedc", "committedDate": "2020-07-23T11:52:11Z", "message": "Add unit test"}, "afterCommit": {"oid": "aff6e8889f747367584fa1ada277b1dd1055c4f3", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/aff6e8889f747367584fa1ada277b1dd1055c4f3", "committedDate": "2020-07-23T11:53:51Z", "message": "Add unit test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aff6e8889f747367584fa1ada277b1dd1055c4f3", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/aff6e8889f747367584fa1ada277b1dd1055c4f3", "committedDate": "2020-07-23T11:53:51Z", "message": "Add unit test"}, "afterCommit": {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/1e58c77259e194e162f55dcfba6f2a4df8444899", "committedDate": "2020-07-23T12:02:35Z", "message": "Add unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MDkxMzQy", "url": "https://github.com/google/ground-android/pull/552#pullrequestreview-454091342", "createdAt": "2020-07-23T12:44:40Z", "commit": {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjo0NDo0MFrOG2IyKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNTo0NDoxOFrOG2QkOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMDIwMQ==", "bodyText": "Naming nit: we may want to call this \"markFeatureForDeletion\" to distinguish it from our future state where we don't actually delete things, but rather mark them as \"deleted\". In that case there would be three states in the local DB, \"not deleted\", \"marked for deletion on remote\", and \"deleted\".", "url": "https://github.com/google/ground-android/pull/552#discussion_r459420201", "createdAt": "2020-07-23T12:44:40Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -387,17 +388,42 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureDeleted(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureDeleted(\n+      FeatureEntity featureEntity, FeatureMutation mutation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMTAwNg==", "bodyText": "Can this steam be simplified by starting it with the call to featureDao.update?", "url": "https://github.com/google/ground-android/pull/552#discussion_r459421006", "createdAt": "2020-07-23T12:45:58Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -387,17 +388,42 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureDeleted(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureDeleted(\n+      FeatureEntity featureEntity, FeatureMutation mutation) {\n+    return Single.just(featureEntity)\n+        .doOnSubscribe(__ -> Timber.d(\"Marking feature as deleted : %s\", mutation))\n+        .map(entity -> entity.toBuilder().setState(EntityState.DELETED).build())\n+        .flatMap(entity -> featureDao.update(entity))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyMjA2Ng==", "bodyText": "Can you refer to the static constant here for state 1 instead? You should be able to concat it to the string with +.", "url": "https://github.com/google/ground-android/pull/552#discussion_r459422066", "createdAt": "2020-07-23T12:47:48Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/dao/FeatureDao.java", "diffHunk": "@@ -26,7 +26,7 @@\n /** Provides low-level read/write operations of {@link FeatureEntity} to/from the local db. */\n @Dao\n public interface FeatureDao extends BaseDao<FeatureEntity> {\n-  @Query(\"SELECT * FROM feature WHERE project_id = :projectId\")\n+  @Query(\"SELECT * FROM feature WHERE project_id = :projectId AND state = 1\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzODI2NQ==", "bodyText": "Please add GitHub issue no to TODO, e.g. TODO(#123).", "url": "https://github.com/google/ground-android/pull/552#discussion_r459538265", "createdAt": "2020-07-23T15:30:38Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/FeatureDocumentReference.java", "diffHunk": "@@ -35,7 +35,9 @@ public void addMutationToBatch(FeatureMutation mutation, User user, WriteBatch b\n         merge(FeatureMutationConverter.toMap(mutation, user), batch);\n         break;\n       case DELETE:\n-        // TODO: Implement me!\n+        // TODO: Also delete all remote observations linked to this feature.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0MjAyNA==", "bodyText": "The naming of this method is a bit misleading; it actually filters out delete mutations and applies them to the local db. To make this clearer, I think we could do something like the following:\n  private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n    return remoteDataStore\n        .applyMutations(mutations, user)\n        .andThen(localDataStore.finalizeMutations(mutations));\n  }\n\nThen from LocalDataStore.finalizePendingMutations  we could finalizeDeletions and removePending, both in LocalDataStore. Wdyt?", "url": "https://github.com/google/ground-android/pull/552#discussion_r459542024", "createdAt": "2020-07-23T15:35:58Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -112,17 +113,26 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n-        .andThen(deleteObservationIfRemovedRemotely(mutations))\n+        .andThen(deleteObservationOrFeature(mutations))\n         .andThen(localDataStore.removePendingMutations(mutations));\n   }\n \n   // TODO: If the remote sync fails, reset the state to DEFAULT.\n-  private Completable deleteObservationIfRemovedRemotely(ImmutableList<Mutation> mutations) {\n+  private Completable deleteObservationOrFeature(ImmutableList<Mutation> mutations) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0NzM4Mg==", "bodyText": "With autoDisposable() used here, I believe it will scope the subscription to the entire lifecycle of the HomeScreenFragment. These will accumulate as long as the home screen remains open.\nTo fix this, you can create a PublishProcessor deleteFeatureRequests in the VM which you could populate with feature id on each deletion request. That stream would then be flatMapped to the actual feature deletion observable, the resulting stream exposed as a stream of SingleEvent that is subscribed to in one of the create methods of this class. Wdyt?", "url": "https://github.com/google/ground-android/pull/552#discussion_r459547382", "createdAt": "2020-07-23T15:43:50Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenFragment.java", "diffHunk": "@@ -232,10 +236,25 @@ private void closeDrawer() {\n   }\n \n   @Override\n-  public void onCreateOptionsMenu(Menu menu, MenuInflater inflater) {\n+  public void onCreateOptionsMenu(@NonNull Menu menu, MenuInflater inflater) {\n     inflater.inflate(R.menu.feature_sheet_menu, menu);\n   }\n \n+  @Override\n+  public boolean onOptionsItemSelected(@NonNull MenuItem item) {\n+    switch (item.getItemId()) {\n+      case R.id.move_feature_menu_item:\n+        // TODO\n+        return false;\n+      case R.id.delete_feature_menu_item:\n+        // TODO: Re-position map to default location after successful deletion.\n+        viewModel.deleteActiveFeature().as(autoDisposable(this)).subscribe(this::hideBottomSheet);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU0NzcwNg==", "bodyText": "Why do we remove the current user here?", "url": "https://github.com/google/ground-android/pull/552#discussion_r459547706", "createdAt": "2020-07-23T15:44:18Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "diffHunk": "@@ -80,7 +78,7 @@\n             .switchMapSingle(\n                 newFeature ->\n                     featureRepository\n-                        .saveFeature(newFeature, authManager.getCurrentUser())\n+                        .saveFeature(newFeature)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e58c77259e194e162f55dcfba6f2a4df8444899"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c49e69b9aa24d77c240d1f49e40b510545ba3af", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/6c49e69b9aa24d77c240d1f49e40b510545ba3af", "committedDate": "2020-07-23T15:47:35Z", "message": "Fix theme for toolbar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff5a5b0f3c1749b02288ad8bfdd3aa361819f8e1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/ff5a5b0f3c1749b02288ad8bfdd3aa361819f8e1", "committedDate": "2020-07-23T15:47:35Z", "message": "Add toBuilder() for converting entity to builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04fc89217e9060c32551b32842c72df2ac75a661", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/04fc89217e9060c32551b32842c72df2ac75a661", "committedDate": "2020-07-23T15:47:35Z", "message": "Add methods to repository for UI to interact with\n\n - Add deleteFeature() to FeatureRepository to enqueuing mutation\n - Move AuthenticationManager to FeatureRepository\n - Add method to HomeScreenViewModel to delete active feature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87648003f4fbe26f58c36c24650b5d74e69b7d79", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/87648003f4fbe26f58c36c24650b5d74e69b7d79", "committedDate": "2020-07-23T15:47:36Z", "message": "Handle delete mutation when applying to local database"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14eef0e9bbc7a91a5101c5afaa05ba9650bb7477", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/14eef0e9bbc7a91a5101c5afaa05ba9650bb7477", "committedDate": "2020-07-23T15:47:36Z", "message": "Handle delete mutation in LocalMutationSyncWorker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e49697b27de4c2ba3db48ed60337ec28bf271c2", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/4e49697b27de4c2ba3db48ed60337ec28bf271c2", "committedDate": "2020-07-23T15:47:36Z", "message": "Handle delete type in FeatureDocumentReference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e858ba67b77b65631d1ae96da5bcd16b116557f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/9e858ba67b77b65631d1ae96da5bcd16b116557f", "committedDate": "2020-07-23T15:47:36Z", "message": "Hook UI to repository\n\n - On successful delete, hide the bottom sheet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0af26e504c5bfddb15cfde1ec88a5da6b0bad5e", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e0af26e504c5bfddb15cfde1ec88a5da6b0bad5e", "committedDate": "2020-07-23T15:47:36Z", "message": "Load only active features from local db"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ebf48c25c1013bdc9bc48b3ea0763786840f7fb", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/5ebf48c25c1013bdc9bc48b3ea0763786840f7fb", "committedDate": "2020-07-23T15:47:36Z", "message": "Unrelated changes to Project.xml by IDE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22e2122857a100077d9d7d7005b63d4064fd6e9e", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/22e2122857a100077d9d7d7005b63d4064fd6e9e", "committedDate": "2020-07-23T15:47:36Z", "message": "Add todo and update method names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11e4b6beaeacf71d408b132244754a3f3530ae8f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/11e4b6beaeacf71d408b132244754a3f3530ae8f", "committedDate": "2020-07-23T15:47:36Z", "message": "Add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c210b452ac3acb7c96b734ea279495d77af68427", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/c210b452ac3acb7c96b734ea279495d77af68427", "committedDate": "2020-07-23T15:51:30Z", "message": "Rename method to mark*ForDeletion\n\nFrom Gino: This is to distinguish it from our future state where we don't actually delete things, but rather mark them as \"deleted\". In that case there would be three states in the local DB, \"not deleted\", \"marked for deletion on remote\", and \"deleted\"."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a65f16d32b3e4d782a2321da425eb0b3e9da8ea", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/9a65f16d32b3e4d782a2321da425eb0b3e9da8ea", "committedDate": "2020-07-23T16:03:03Z", "message": "Simplify method by starting call with *Dao.update()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d0403954e77804fdb2cb712aaeed3cbf2cf0886", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/1d0403954e77804fdb2cb712aaeed3cbf2cf0886", "committedDate": "2020-07-23T16:12:45Z", "message": "Avoid using magic numbers for entity state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6022ed38affc9ab252f815e7dd43cb0bcacdaf84", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/6022ed38affc9ab252f815e7dd43cb0bcacdaf84", "committedDate": "2020-07-23T16:14:10Z", "message": "Add existing issue number next to TODO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05b7f5b622f80528f88bf12ec1f02c1f14678302", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/05b7f5b622f80528f88bf12ec1f02c1f14678302", "committedDate": "2020-07-23T16:34:08Z", "message": "Refactor finalizing pending mutations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3468058b247fd9773ad44f28952e64f90c94ae5", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f3468058b247fd9773ad44f28952e64f90c94ae5", "committedDate": "2020-07-23T15:43:02Z", "message": "Merge branch 'master' into delete-feature"}, "afterCommit": {"oid": "05b7f5b622f80528f88bf12ec1f02c1f14678302", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/05b7f5b622f80528f88bf12ec1f02c1f14678302", "committedDate": "2020-07-23T16:34:08Z", "message": "Refactor finalizing pending mutations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba945002a8895c2c45b14076219effe556ecbe09", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/ba945002a8895c2c45b14076219effe556ecbe09", "committedDate": "2020-07-23T17:07:52Z", "message": "Fix line length"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTU0Nzg1", "url": "https://github.com/google/ground-android/pull/552#pullrequestreview-454554785", "createdAt": "2020-07-23T23:13:07Z", "commit": {"oid": "ba945002a8895c2c45b14076219effe556ecbe09"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMzoxMzowN1rOG2ennw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMzoxNTo1OVrOG2erCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3Nzk1MQ==", "bodyText": "@Transaction doesn't apply to Firebase, which uses it's own API (db.runTransaction) to batch writings. Please remove here and throughout.", "url": "https://github.com/google/ground-android/pull/552#discussion_r459777951", "createdAt": "2020-07-23T23:13:07Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -333,9 +335,29 @@ public Completable updateMutations(ImmutableList<Mutation> mutations) {\n         .collect(toImmutableList());\n   }\n \n-  @Transaction\n   @Override\n-  public Completable removePendingMutations(ImmutableList<Mutation> mutations) {\n+  public Completable finalizePendingMutations(ImmutableList<Mutation> mutations) {\n+    return finalizeDeletions(mutations).andThen(removePending(mutations));\n+  }\n+\n+  @Transaction", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba945002a8895c2c45b14076219effe556ecbe09"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODA3MQ==", "bodyText": "Perhaps Timber.t would be more appropriate here (or remove altogether).", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778071", "createdAt": "2020-07-23T23:13:35Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -401,17 +423,40 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureForDeletion(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureForDeletion(FeatureEntity entity, FeatureMutation mutation) {\n+    return featureDao\n+        .update(entity.toBuilder().setState(EntityState.DELETED).build())\n+        .doOnSubscribe(__ -> Timber.d(\"Marking feature as deleted : %s\", mutation))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba945002a8895c2c45b14076219effe556ecbe09"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODIwMg==", "bodyText": "This can return Completable instead.", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778202", "createdAt": "2020-07-23T23:14:02Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -401,17 +423,40 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureForDeletion(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureForDeletion(FeatureEntity entity, FeatureMutation mutation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba945002a8895c2c45b14076219effe556ecbe09"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODIzMg==", "bodyText": "Same here.", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778232", "createdAt": "2020-07-23T23:14:09Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -401,17 +423,40 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureForDeletion(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureForDeletion(FeatureEntity entity, FeatureMutation mutation) {\n+    return featureDao\n+        .update(entity.toBuilder().setState(EntityState.DELETED).build())\n+        .doOnSubscribe(__ -> Timber.d(\"Marking feature as deleted : %s\", mutation))\n+        .ignoreElement()\n+        .subscribeOn(schedulers.io());\n+  }\n+\n   private Completable insertOrUpdateFeature(FeatureMutation mutation, User user) {\n     return featureDao\n         .insertOrUpdate(FeatureEntity.fromMutation(mutation, AuditInfo.now(user)))\n         .subscribeOn(schedulers.io());\n   }\n \n+  @Override\n+  public Completable deleteFeature(String featureId) {\n+    return featureDao\n+        .findById(featureId)\n+        .toSingle()\n+        .doOnSubscribe(__ -> Timber.d(\"Deleting local feature : %s\", featureId))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba945002a8895c2c45b14076219effe556ecbe09"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODQ0MQ==", "bodyText": "No need to change the subscribeOn thread inside private methods; it only needs to be done in the main entry point of each operation, the setting propagates to the rest of the stream.", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778441", "createdAt": "2020-07-23T23:14:50Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -401,17 +423,40 @@ private Completable apply(FeatureMutation mutation) throws LocalDataStoreExcepti\n       case CREATE:\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> insertOrUpdateFeature(mutation, user));\n+      case DELETE:\n+        return featureDao\n+            .findById(mutation.getFeatureId())\n+            .flatMapCompletable(entity -> markFeatureForDeletion(entity, mutation))\n+            .subscribeOn(schedulers.io());\n       default:\n         throw LocalDataStoreException.unknownMutationType(mutation.getType());\n     }\n   }\n \n+  private CompletableSource markFeatureForDeletion(FeatureEntity entity, FeatureMutation mutation) {\n+    return featureDao\n+        .update(entity.toBuilder().setState(EntityState.DELETED).build())\n+        .doOnSubscribe(__ -> Timber.d(\"Marking feature as deleted : %s\", mutation))\n+        .ignoreElement()\n+        .subscribeOn(schedulers.io());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba945002a8895c2c45b14076219effe556ecbe09"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3ODgyNA==", "bodyText": "Using our convention in the Wiki, should should be called findOnceAndStream (or findByProjectIdAndEntityStateOnceAndStream, but that seems excessive).", "url": "https://github.com/google/ground-android/pull/552#discussion_r459778824", "createdAt": "2020-07-23T23:15:59Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/dao/FeatureDao.java", "diffHunk": "@@ -19,15 +19,16 @@\n import androidx.room.Dao;\n import androidx.room.Query;\n import com.google.android.gnd.persistence.local.room.entity.FeatureEntity;\n+import com.google.android.gnd.persistence.local.room.models.EntityState;\n import io.reactivex.Flowable;\n import io.reactivex.Maybe;\n import java.util.List;\n \n /** Provides low-level read/write operations of {@link FeatureEntity} to/from the local db. */\n @Dao\n public interface FeatureDao extends BaseDao<FeatureEntity> {\n-  @Query(\"SELECT * FROM feature WHERE project_id = :projectId\")\n-  Flowable<List<FeatureEntity>> findByProjectIdStream(String projectId);\n+  @Query(\"SELECT * FROM feature WHERE project_id = :projectId AND state = :state\")\n+  Flowable<List<FeatureEntity>> findByProjectIdStream(String projectId, EntityState state);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba945002a8895c2c45b14076219effe556ecbe09"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2661073119bcada83b6f3c21971f47a02ef99c9", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f2661073119bcada83b6f3c21971f47a02ef99c9", "committedDate": "2020-07-24T14:45:10Z", "message": "Avoid using autoDisposable() and replace with LiveData"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3f1b66d218fa41f161fe6956becd31fa999ed79", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e3f1b66d218fa41f161fe6956becd31fa999ed79", "committedDate": "2020-07-24T14:46:49Z", "message": "Remove annotation Transaction\n\nSince this doesn't apply to firebase, it's better not to include it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fbcff7a38e0ed4e117a22f024b49e63c2057d29", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/8fbcff7a38e0ed4e117a22f024b49e63c2057d29", "committedDate": "2020-07-24T14:49:56Z", "message": "Replace CompletableSource with Completable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9858e8e9ea1294b2619b219440c752bbac190761", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/9858e8e9ea1294b2619b219440c752bbac190761", "committedDate": "2020-07-24T14:53:45Z", "message": "Remove unnecessary thread switching inside private methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6591275c886c98ade2e3c5064b8594b1bc38356", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f6591275c886c98ade2e3c5064b8594b1bc38356", "committedDate": "2020-07-24T14:57:25Z", "message": "Improve method name to follow naming conventions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTc2NzQx", "url": "https://github.com/google/ground-android/pull/552#pullrequestreview-456176741", "createdAt": "2020-07-27T22:23:44Z", "commit": {"oid": "f6591275c886c98ade2e3c5064b8594b1bc38356"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1598, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}