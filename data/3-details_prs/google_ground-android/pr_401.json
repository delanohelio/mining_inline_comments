{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNjgyNzEx", "number": 401, "title": "[Cleanup] Replace manual subscription handling with ViewModel", "bodyText": "Resolves a TODO added in #386\n\nFactor out Photo Field UI elements into photo_field.xml\nReuse above layout and PhotoFieldViewModel to render ObservationDetailsFragment\n\nTested manually:\n\nObservationDetailsFragment page (both with and without image)\nEditObservationFragment page (both with and without image)", "createdAt": "2020-03-18T21:49:44Z", "url": "https://github.com/google/ground-android/pull/401", "merged": true, "mergeCommit": {"oid": "b9a20bd6308b489f8639015656fe91f34e52fc6c"}, "closed": true, "closedAt": "2020-03-18T22:14:23Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO9uZ3gH2gAyMzkwNjgyNzExOjZkMGJmZDdiZmI2OWVmMTM5MWExZGQ5YWE0ZTAxMzk4NzI3ZTUzN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO-xa7gFqTM3NzI3MDI4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6d0bfd7bfb69ef1391a1dd9aa4e01398727e537a", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/6d0bfd7bfb69ef1391a1dd9aa4e01398727e537a", "committedDate": "2020-03-18T20:55:55Z", "message": "Add annotations based on base class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d33223a91e98ec8144686844e3b0cf82ed1306a", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/8d33223a91e98ec8144686844e3b0cf82ed1306a", "committedDate": "2020-03-18T20:56:29Z", "message": "Replace switch with if block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fec50f6961b64b18a99dd6f697d7434b899af35", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/5fec50f6961b64b18a99dd6f697d7434b899af35", "committedDate": "2020-03-18T21:43:16Z", "message": "Move photo field elements into separate layout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0845afb06aa512b8cb95128a225b8d9711419c5c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/0845afb06aa512b8cb95128a225b8d9711419c5c", "committedDate": "2020-03-18T21:44:28Z", "message": "Replace RxCall with photo_view.xml and PhotoFieldViewModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34832873d7c1742af5c05643331f877961bb454f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/34832873d7c1742af5c05643331f877961bb454f", "committedDate": "2020-03-18T21:45:47Z", "message": "Remove useless parenthesis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45431707d3bbcff8a1937fc3af3782ddbbc71c74", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/45431707d3bbcff8a1937fc3af3782ddbbc71c74", "committedDate": "2020-03-18T21:52:47Z", "message": "Rename photo_view -> photo_field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb59b20c479b576e4f2b1fbeb6cdf3b42588d67f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fb59b20c479b576e4f2b1fbeb6cdf3b42588d67f", "committedDate": "2020-03-18T21:57:50Z", "message": "Remove unused dagger dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c171e586b8108519afeb7a41fdc6c5d95f0ebe1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/8c171e586b8108519afeb7a41fdc6c5d95f0ebe1", "committedDate": "2020-03-18T21:59:11Z", "message": "Rename to viewModel for simplicity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MjY4MzEx", "url": "https://github.com/google/ground-android/pull/401#pullrequestreview-377268311", "createdAt": "2020-03-18T22:05:14Z", "commit": {"oid": "8c171e586b8108519afeb7a41fdc6c5d95f0ebe1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjowNToxNFrOF4Yg1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjowNToxNFrOF4Yg1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2NjE5Ng==", "bodyText": "It appears this method is called both from init() and here. Is this intentional? If so, why?", "url": "https://github.com/google/ground-android/pull/401#discussion_r394666196", "createdAt": "2020-03-18T22:05:14Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/observationdetails/ObservationDetailsFragment.java", "diffHunk": "@@ -156,35 +149,25 @@ private void addField(Field field, Observation observation) {\n     observation\n         .getResponses()\n         .getResponse(field.getId())\n-        .map(r -> r.getDetailsText(field))\n         .ifPresent(\n-            value -> {\n-              if (field.getType().equals(Type.PHOTO)) {\n-                binding.fieldValue.setVisibility(View.GONE);\n-                binding.imagePreview.setVisibility(View.VISIBLE);\n-\n-                // TODO: Subscriptions should only be made inside lifecycle methods so they can be\n-                // properly disposed of in their equivalent end lifecycle methods. To do this\n-                // safely, we can create a PublishSubject in the view model that gets exposed to\n-                // the fragment as a LiveData.\n-                storageManager\n-                    .getDownloadUrl(value)\n-                    .subscribeOn(schedulers.io())\n-                    .observeOn(schedulers.ui())\n-                    .as(autoDisposable(this))\n-                    .subscribe(\n-                        uri ->\n-                            Picasso.get()\n-                                .load(uri)\n-                                .placeholder(R.drawable.ic_photo_grey_600_24dp)\n-                                .into(binding.imagePreview));\n-\n+            response -> {\n+              if (field.getType() == Type.PHOTO) {\n+                addPhotoField((ViewGroup) binding.getRoot(), field, response);\n               } else {\n-                binding.fieldValue.setText(value);\n+                binding.fieldValue.setText(response.getDetailsText(field));\n               }\n             });\n   }\n \n+  private void addPhotoField(ViewGroup container, Field field, Response response) {\n+    PhotoFieldBinding photoFieldBinding = PhotoFieldBinding.inflate(getLayoutInflater());\n+    PhotoFieldViewModel photoFieldViewModel = viewModelFactory.create(PhotoFieldViewModel.class);\n+    photoFieldBinding.setLifecycleOwner(this);\n+    photoFieldBinding.setViewModel(photoFieldViewModel);\n+    photoFieldViewModel.updateField(response, field);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c171e586b8108519afeb7a41fdc6c5d95f0ebe1"}, "originalPosition": 115}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MjcwMjgz", "url": "https://github.com/google/ground-android/pull/401#pullrequestreview-377270283", "createdAt": "2020-03-18T22:09:07Z", "commit": {"oid": "8c171e586b8108519afeb7a41fdc6c5d95f0ebe1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1745, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}