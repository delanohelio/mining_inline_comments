{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MjY5NjUx", "number": 563, "title": "[Photos] Refactor uploading photos to remote storage ", "bodyText": "Closes #455\nThings done:\n\nAdd FieldType to ResponseDelta\nMove code for enqueuing photos to LocalMutationSyncWorker which gets called only after mutations have been successfully synced", "createdAt": "2020-08-13T09:37:28Z", "url": "https://github.com/google/ground-android/pull/563", "merged": true, "mergeCommit": {"oid": "14ac5252487d2b0eb557647f5852d319206185a0"}, "closed": true, "closedAt": "2020-08-14T16:41:05Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-bz28AH2gAyNDY3MjY5NjUxOjcwYmM3YjVlMjQyZWViODliMjY3N2Y5ODViNmVlMDM2OThjOGMwODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-3YjXgFqTQ2NzcxODQ0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "70bc7b5e242eeb89b2677f985b6ee03698c8c089", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/70bc7b5e242eeb89b2677f985b6ee03698c8c089", "committedDate": "2020-08-13T08:33:28Z", "message": "Save original response and field type in ResponseDelta object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b99db9adeb039d1d531d311462331b0953721c80", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/b99db9adeb039d1d531d311462331b0953721c80", "committedDate": "2020-08-13T08:34:38Z", "message": "Add data to fieldType and originalResponse while creating mutation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbe62da7de9cfcc5d3d70b53c608f49d6913698f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/dbe62da7de9cfcc5d3d70b53c608f49d6913698f", "committedDate": "2020-08-13T08:35:22Z", "message": "Configure ResponseDeltasTypeConverter to save the new info to db"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa0e8f009c52121d5a588f3b3e36406843177340", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fa0e8f009c52121d5a588f3b3e36406843177340", "committedDate": "2020-08-13T08:37:18Z", "message": "Replace log with timber"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8d0ccb57719b325a240b96fbc622d0f840b053f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f8d0ccb57719b325a240b96fbc622d0f840b053f", "committedDate": "2020-08-13T09:14:28Z", "message": "Add method to delete remote files in RemoteStorageManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe471c86ac733078db7027224d2b3c046e693b34", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fe471c86ac733078db7027224d2b3c046e693b34", "committedDate": "2020-08-13T09:15:54Z", "message": "Remove code for uploading photo from FirestoreDataStore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8a80959daafde6d143bafd28db1f79510d2cac9", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d8a80959daafde6d143bafd28db1f79510d2cac9", "committedDate": "2020-08-13T09:16:35Z", "message": "Add delete method to StorageManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e5e498fb4cddb3f5a2bd227905d5d08c4b2908c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/4e5e498fb4cddb3f5a2bd227905d5d08c4b2908c", "committedDate": "2020-08-13T09:23:18Z", "message": "Process photo mutations in LocalMutationSyncWorker\n\n - Do this after successful sync of mutations to remote db\n - Find all deltas for photo type mutations\n - Remove old response and enqueue new ones for uploading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c10ca4267c9e7e8f7c03270e654a033bdbc3a93", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/7c10ca4267c9e7e8f7c03270e654a033bdbc3a93", "committedDate": "2020-08-13T10:15:03Z", "message": "Fix unit tests\n\n - add dummy values to required fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0356487c14ca377b1e094a7e577aba9453bbc002", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/0356487c14ca377b1e094a7e577aba9453bbc002", "committedDate": "2020-08-13T10:26:08Z", "message": "Fix missing required fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDI5NDA0", "url": "https://github.com/google/ground-android/pull/563#pullrequestreview-467029404", "createdAt": "2020-08-13T18:32:53Z", "commit": {"oid": "0356487c14ca377b1e094a7e577aba9453bbc002"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODozMjo1M1rOHAYe6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODozMjo1M1rOHAYe6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE2MzE3OQ==", "bodyText": "Consider Completable.fromRunnable(() -> ) instead.", "url": "https://github.com/google/ground-android/pull/563#discussion_r470163179", "createdAt": "2020-08-13T18:32:53Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +127,54 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields. Delete old\n+   * photo from remote storage and enqueue new photo for upload.\n+   */\n+  private Completable processPhotoFieldMutations(ImmutableList<Mutation> mutations) {\n+    return Observable.fromIterable(mutations)\n+        .filter(mutation -> mutation instanceof ObservationMutation)\n+        .cast(ObservationMutation.class)\n+        .flatMapCompletable(\n+            mutation ->\n+                Observable.fromIterable(mutation.getResponseDeltas())\n+                    .filter(delta -> delta.getFieldType() == Type.PHOTO)\n+                    .flatMapCompletable(\n+                        delta ->\n+                            enqueuePhotoUpload(delta.getNewResponse())\n+                                .andThen(deleteRemotePhoto(delta.getOriginalResponse()))));\n+  }\n+\n+  /** Enqueue photo for uploading to remote storage. */\n+  private Completable enqueuePhotoUpload(Optional<Response> response) {\n+    return Completable.create(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0356487c14ca377b1e094a7e577aba9453bbc002"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdd23da09bf16496b8ab278653dfa90952308b55", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/cdd23da09bf16496b8ab278653dfa90952308b55", "committedDate": "2020-08-14T07:31:43Z", "message": "Do not remove remote files from client\n\nIt will be handled by the server\nhttps://github.com/google/ground-android/pull/563#issuecomment-673512226"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b99b557891d56865ff69f707db724cd82682fe1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/1b99b557891d56865ff69f707db724cd82682fe1", "committedDate": "2020-08-14T07:37:25Z", "message": "Remove original response from ResponseDelta"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f400433e24e0d6006fb4ed9a74012aa4fd47b089", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f400433e24e0d6006fb4ed9a74012aa4fd47b089", "committedDate": "2020-08-14T07:47:17Z", "message": "Replace `create()` with `fromRunnable()`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04cb4bb31ded12f67f5d5f7d6e157f09aadc84c0", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/04cb4bb31ded12f67f5d5f7d6e157f09aadc84c0", "committedDate": "2020-08-14T07:53:46Z", "message": "Remove remaining usage of originalResponse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bff16b4585c46b432ca14b45cfc6601efe9df84a", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/bff16b4585c46b432ca14b45cfc6601efe9df84a", "committedDate": "2020-08-14T09:20:58Z", "message": "Cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NjMzNjgy", "url": "https://github.com/google/ground-android/pull/563#pullrequestreview-467633682", "createdAt": "2020-08-14T14:43:04Z", "commit": {"oid": "bff16b4585c46b432ca14b45cfc6601efe9df84a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDo0MzowNFrOHA3Oxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDo1MDoxNlrOHA3mQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2Njk1MQ==", "bodyText": "Can we use short camel-cased keys without spaces here to make them more idiomatic JSON? e.g. \"fieldType\" and \"newResponse\"?", "url": "https://github.com/google/ground-android/pull/563#discussion_r470666951", "createdAt": "2020-08-14T14:43:04Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/converter/ResponseDeltasTypeConverter.java", "diffHunk": "@@ -32,18 +35,25 @@\n  */\n public class ResponseDeltasTypeConverter {\n \n+  private static final String KEY_FIELD_TYPE = \"field type\";\n+  private static final String KEY_NEW_RESPONSE = \"new response\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff16b4585c46b432ca14b45cfc6601efe9df84a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2OTM0Ng==", "bodyText": "Nit: Filter -> Filters", "url": "https://github.com/google/ground-android/pull/563#discussion_r470669346", "createdAt": "2020-08-14T14:45:05Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +117,32 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields and uploads\n+   * to remote storage.\n+   */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff16b4585c46b432ca14b45cfc6601efe9df84a"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3MDg5NQ==", "bodyText": "isPresent() returns a boolean; wouldn't the next line cause remotePath to be \"true\" or \"false\"?", "url": "https://github.com/google/ground-android/pull/563#discussion_r470670895", "createdAt": "2020-08-14T14:46:46Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +117,32 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields and uploads\n+   * to remote storage.\n+   */\n+  private Completable processPhotoFieldMutations(ImmutableList<Mutation> mutations) {\n+    return Observable.fromIterable(mutations)\n+        .filter(mutation -> mutation instanceof ObservationMutation)\n+        .cast(ObservationMutation.class)\n+        .flatMapCompletable(\n+            mutation ->\n+                Observable.fromIterable(mutation.getResponseDeltas())\n+                    .filter(delta -> delta.getFieldType() == Type.PHOTO)\n+                    .map(ResponseDelta::getNewResponse)\n+                    .map(Optional::isPresent)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff16b4585c46b432ca14b45cfc6601efe9df84a"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3MjgyOQ==", "bodyText": "I think this can be simplified, but not sure of the exact syntax.", "url": "https://github.com/google/ground-android/pull/563#discussion_r470672829", "createdAt": "2020-08-14T14:50:03Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +117,32 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields and uploads\n+   * to remote storage.\n+   */\n+  private Completable processPhotoFieldMutations(ImmutableList<Mutation> mutations) {\n+    return Observable.fromIterable(mutations)\n+        .filter(mutation -> mutation instanceof ObservationMutation)\n+        .cast(ObservationMutation.class)\n+        .flatMapCompletable(\n+            mutation ->\n+                Observable.fromIterable(mutation.getResponseDeltas())\n+                    .filter(delta -> delta.getFieldType() == Type.PHOTO)\n+                    .map(ResponseDelta::getNewResponse)\n+                    .map(Optional::isPresent)\n+                    .map(Object::toString)\n+                    .flatMapCompletable(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff16b4585c46b432ca14b45cfc6601efe9df84a"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3Mjk2Mg==", "bodyText": "Does flatMapIterable() help here?", "url": "https://github.com/google/ground-android/pull/563#discussion_r470672962", "createdAt": "2020-08-14T14:50:16Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -110,10 +117,32 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n+        .andThen(processPhotoFieldMutations(mutations))\n         // TODO: If the remote sync fails, reset the state to DEFAULT.\n         .andThen(localDataStore.finalizePendingMutations(mutations));\n   }\n \n+  /**\n+   * Filter all mutations containing observation mutations with changes to photo fields and uploads\n+   * to remote storage.\n+   */\n+  private Completable processPhotoFieldMutations(ImmutableList<Mutation> mutations) {\n+    return Observable.fromIterable(mutations)\n+        .filter(mutation -> mutation instanceof ObservationMutation)\n+        .cast(ObservationMutation.class)\n+        .flatMapCompletable(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff16b4585c46b432ca14b45cfc6601efe9df84a"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a478804e6c7aaba41a095d8cc19b26ab0d918d7f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a478804e6c7aaba41a095d8cc19b26ab0d918d7f", "committedDate": "2020-08-14T15:10:14Z", "message": "Simplify RxChain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1688cdc6af466bccc997582dcbbcdd9cab1ca51b", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/1688cdc6af466bccc997582dcbbcdd9cab1ca51b", "committedDate": "2020-08-14T15:10:44Z", "message": "Use camel-cased keys for consistency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzE4NDQ0", "url": "https://github.com/google/ground-android/pull/563#pullrequestreview-467718444", "createdAt": "2020-08-14T16:40:59Z", "commit": {"oid": "1688cdc6af466bccc997582dcbbcdd9cab1ca51b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1602, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}