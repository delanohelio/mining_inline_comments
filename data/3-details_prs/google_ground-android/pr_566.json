{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NzY1Nzk5", "number": 566, "title": "Geocoding Fixes", "bodyText": "The main motivation for this PR is to make our offline areas functionality truly offline, by persisting area names offline--before, we had run the geocoder (which requires a connection) on rendering area details. Instead, we now run it before storing an area, so that the name is saved.\nI've also refactored the code accordingly, eliminating a duplicate map key bug in the areas list.", "createdAt": "2020-08-18T21:53:14Z", "url": "https://github.com/google/ground-android/pull/566", "merged": true, "mergeCommit": {"oid": "5ec9131a6666eac26243c0dfeabaaa0678baf660"}, "closed": true, "closedAt": "2020-08-19T23:01:05Z", "author": {"login": "scolsen"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdANqPEAH2gAyNDY5NzY1Nzk5OmFkMGFiNDY4OTZmY2ZmZTAyZDIwMDU4ZDc0YmZmMmM4NTUxYjRiZDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAi-R5AFqTQ3MDk5NjEyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ad0ab46896fcffe02d20058d74bff2c8551b4bd6", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/ad0ab46896fcffe02d20058d74bff2c8551b4bd6", "committedDate": "2020-08-18T21:12:08Z", "message": "Add a name field to Offline Areas\n\nSince we need to render human readable names for offline areas, well, offline, we'll extend the model to persist a name. For now, the name will be automatically derived using geocoding, but we may allow users to specify custom area names in the future."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ac9ad416e2fedf6b391ee8fa5f7414aadf25bc2", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/6ac9ad416e2fedf6b391ee8fa5f7414aadf25bc2", "committedDate": "2020-08-18T21:34:49Z", "message": "Refactor handling of area name geocoding to persist names offline\n\nThis change does a couple of significant things:\n\n- Moves geocoding out of the view model and into the offline area repository in order to persist a reverse geocoded name offline\n- Changes the signature of the geocoder's area name function to work on bounds--necessary because of the prior point, since now we need to reverse geocode and entity while constructing an area.\n- Updates the offline area view model and list adapter to work directly on immutable lists of areas, resolving a duplicate key issue.\n\nIn general the implementation is simpler and now we persist names offline."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01364f6946e4fd4aafe24bf44be903617ead4eea", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/01364f6946e4fd4aafe24bf44be903617ead4eea", "committedDate": "2020-08-18T21:49:59Z", "message": "Update the geocoder to save country+locality names\n\nUntil we have a firmer decision around what address components we should use to name areas, we'll use a simple combination of country + locality, falling back to country only if the locality is not found."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNTUyNDk1", "url": "https://github.com/google/ground-android/pull/566#pullrequestreview-470552495", "createdAt": "2020-08-19T15:05:42Z", "commit": {"oid": "01364f6946e4fd4aafe24bf44be903617ead4eea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNTowNTo0MlrOHDLyGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNTowNTo0MlrOHDLyGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEwMDgyNw==", "bodyText": "Since geocodingManager.getOfflineAreaName(bounds) is an async operation, should it be modeled as a Single<>? If not, the UI might block while waiting for addAreaAndEnqueue() to finish. It might look something like:\nreturn geocodingManager.getOfflineAreaName(bounds)\n    .map(areaName => OfflineArea.newBuilder()....setName(areaName).build())   \n    .flatMapCompletable(this::enqueueTileDownloads);", "url": "https://github.com/google/ground-android/pull/566#discussion_r473100827", "createdAt": "2020-08-19T15:05:42Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -140,11 +144,11 @@ private Completable enqueueTileDownloads(OfflineArea area) {\n \n   public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n     OfflineArea offlineArea =\n-        // TODO: Geocode\n         OfflineArea.newBuilder()\n             .setBounds(bounds)\n             .setId(uuidGenerator.generateUuid())\n             .setState(State.PENDING)\n+            .setName(geocodingManager.getOfflineAreaName(bounds))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01364f6946e4fd4aafe24bf44be903617ead4eea"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03f1fdb54f3affe13168b0e3fa8a6c231b0deff0", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/03f1fdb54f3affe13168b0e3fa8a6c231b0deff0", "committedDate": "2020-08-19T16:27:00Z", "message": "Remove unused import in OfflineAreaListAdapter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "582b8039617f77ab406366da735801c199ffa80f", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/582b8039617f77ab406366da735801c199ffa80f", "committedDate": "2020-08-19T16:29:20Z", "message": "Model reverse geocoding area names as Singles\n\nThe Geocoder's getFromLocation call blocks, so we should run it on the IO thread instead of the UI thread to avoid blocking the UI. In line with the rest of the code base, we use RX java to wrpa the computation and run it on the IO scheduler."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bdfe113bb7b2a53c76f305d1d3c03bea61b1d2e", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/0bdfe113bb7b2a53c76f305d1d3c03bea61b1d2e", "committedDate": "2020-08-19T20:00:41Z", "message": "Update local data store tests according to Offline Area model changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwODUxNzM3", "url": "https://github.com/google/ground-android/pull/566#pullrequestreview-470851737", "createdAt": "2020-08-19T20:12:17Z", "commit": {"oid": "0bdfe113bb7b2a53c76f305d1d3c03bea61b1d2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e71f478931229922b14d24efb43badc9e45984dc", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e71f478931229922b14d24efb43badc9e45984dc", "committedDate": "2020-08-19T20:48:03Z", "message": "Merge branch 'master' into geocoding-fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwOTk2MTIx", "url": "https://github.com/google/ground-android/pull/566#pullrequestreview-470996121", "createdAt": "2020-08-19T22:02:02Z", "commit": {"oid": "e71f478931229922b14d24efb43badc9e45984dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1607, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}