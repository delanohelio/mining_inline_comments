{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MzAwNzQ2", "number": 560, "title": "Fetch Basemap sources from projects", "bodyText": "This PR changes our approach to getting json sources for offline areas--we now pull them from the active project instead of a file preloaded on the user's device.\nNote that everything should work, however--we don't yet have a project that has a valid basemap source to test with (afaict).", "createdAt": "2020-08-11T19:11:19Z", "url": "https://github.com/google/ground-android/pull/560", "merged": true, "mergeCommit": {"oid": "2791dcd782f7e3f3fb5f32ca5013b1716213e64a"}, "closed": true, "closedAt": "2020-08-18T18:25:15Z", "author": {"login": "scolsen"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3xsJSgH2gAyNDY2MzAwNzQ2Ojk4OTRiZDQ3ZDFhMzQ3YmUwMzE4NGE3NThjYjdjYWNjMjExMDRiNWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdALRGSAFqTQ2OTcxNTQ3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9894bd47d1a347be03184a758cb7cacc21104b5d", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/9894bd47d1a347be03184a758cb7cacc21104b5d", "committedDate": "2020-07-23T16:05:29Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59ac651dc9b078f50b53e0112b6b016ab587fa04", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/59ac651dc9b078f50b53e0112b6b016ab587fa04", "committedDate": "2020-08-11T18:46:11Z", "message": "Get tile json from project basemap sources\n\nProjects now contain a list of basemap sources, geojson files that specify tilesets for downloadable offline areas. This commit updates the OfflineAreaRepository to use the json sources specified in the active project instead of a json source on device."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42b16d58919b0fa5623f7cce3400db2ce6cdd592", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/42b16d58919b0fa5623f7cce3400db2ce6cdd592", "committedDate": "2020-08-11T19:07:20Z", "message": "Update getIntersectingDownloadedTiles... to get json from the active project"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2947032a4432f095a8e6b62a0dc36c2e8f20533", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/c2947032a4432f095a8e6b62a0dc36c2e8f20533", "committedDate": "2020-08-11T19:07:51Z", "message": "Remove config for on-device json source location\n\nNow that we pull json sources from projects, it's no longer needed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3be3daf6b2268a8d5f032d49ce185c727f9d2712", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/3be3daf6b2268a8d5f032d49ce185c727f9d2712", "committedDate": "2020-08-11T19:09:02Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into project-basemap-source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10480bfa9fe1751d1e03d0ca47d19e934bec01fd", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/10480bfa9fe1751d1e03d0ca47d19e934bec01fd", "committedDate": "2020-08-14T14:15:33Z", "message": "Merge branch 'master' into project-basemap-source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "716d61cd736675a3dcd919da206e7a406906c534", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/716d61cd736675a3dcd919da206e7a406906c534", "committedDate": "2020-08-14T21:40:41Z", "message": "Make id the primary key for Option entities"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1b294801cc2d1d54a84b100af9012dbdfea6cb3", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/c1b294801cc2d1d54a84b100af9012dbdfea6cb3", "committedDate": "2020-08-14T21:41:21Z", "message": "Update GeoJsonTile URL_KEY"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a60c9df0dec7d032c8469de2a5a79079a5cbd90f", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/a60c9df0dec7d032c8469de2a5a79079a5cbd90f", "committedDate": "2020-08-14T21:42:02Z", "message": "Run OfflineAreaRepository streams on the io thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/f0660a3fa22728ed035b4f2b7fde516062eace9b", "committedDate": "2020-08-14T21:43:07Z", "message": "Merge branch 'project-basemap-source' of https://github.com/scolsen/ground-android into project-basemap-source"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3OTYzMTgy", "url": "https://github.com/google/ground-android/pull/560#pullrequestreview-467963182", "createdAt": "2020-08-15T10:29:08Z", "commit": {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxMDoyOTowOVrOHBJVAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxMDo1MToyOFrOHBJbYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2MzQ1Nw==", "bodyText": "Please revert this one and remove the unused file gnd_geojson.json", "url": "https://github.com/google/ground-android/pull/560#discussion_r470963457", "createdAt": "2020-08-15T10:29:09Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/google-services.json", "diffHunk": "@@ -1,51 +0,0 @@\n-{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2Mzg4MA==", "bodyText": "Could you also please remove the NOPMD from all these 3 places and 1 more in the same file?\nIt was added because of 4 occurrences of string literal \"field_id\". Now there are only 3\nhttps://pmd.github.io/latest/pmd_rules_java_errorprone.html#avoidduplicateliterals\nAlso, we should think about whether to disable this check as it is a bit annoying and less useful.", "url": "https://github.com/google/ground-android/pull/560#discussion_r470963880", "createdAt": "2020-08-15T10:34:43Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/entity/OptionEntity.java", "diffHunk": "@@ -35,7 +35,7 @@\n             childColumns = \"field_id\", // NOPMD\n             onDelete = ForeignKey.CASCADE),\n     indices = {@Index(\"field_id\")}, // NOPMD\n-    primaryKeys = {\"code\", \"field_id\"}) // NOPMD\n+    primaryKeys = {\"id\"}) // NOPMD", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDQzMA==", "bodyText": "This block can be refactored into a new method and then reused in the rest of the code.", "url": "https://github.com/google/ground-android/pull/560#discussion_r470964430", "createdAt": "2020-08-15T10:42:29Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -85,18 +109,33 @@ private Completable enqueueTileDownloads(OfflineArea area) {\n         .andThen(tileDownloadWorkManager.enqueueTileDownloadWorker());\n   }\n \n+  /**\n+   * Determine the set of tiles that need to be downloaded for a given area, then enqueue tile\n+   * downloads.\n+   */\n+  private Completable enqueueTileDownloads(OfflineArea area) {\n+    return projectRepository\n+        .getActiveProjectOnceAndStream()\n+        .compose(Loadable::values)\n+        .map(Project::getOfflineBaseMapSources)\n+        .map(this::downloadOfflineBaseMapSource)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDYyOQ==", "bodyText": "How about passing only the first OfflineBaseMapSource to this method?\nSince the method is named downloadOfflineBaseMapSource, the error \"No basemap sources specified for this project.\" doesn't seem very intuitive. So that check should be done before the call reaches this function.\nWdyt?", "url": "https://github.com/google/ground-android/pull/560#discussion_r470964629", "createdAt": "2020-08-15T10:45:08Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -38,42 +41,63 @@\n import io.reactivex.Single;\n import java.io.File;\n import java.io.IOException;\n+import java.net.URL;\n import javax.inject.Inject;\n+import org.apache.commons.io.FileUtils;\n import timber.log.Timber;\n \n public class OfflineAreaRepository {\n   private final TileDownloadWorkManager tileDownloadWorkManager;\n   private final LocalDataStore localDataStore;\n+  private final ProjectRepository projectRepository;\n   private final GeoJsonParser geoJsonParser;\n   private final FileUtil fileUtil;\n+  private final Schedulers schedulers;\n \n   private final OfflineUuidGenerator uuidGenerator;\n \n   @Inject\n   public OfflineAreaRepository(\n       TileDownloadWorkManager tileDownloadWorkManager,\n       LocalDataStore localDataStore,\n+      ProjectRepository projectRepository,\n       GeoJsonParser geoJsonParser,\n       OfflineUuidGenerator uuidGenerator,\n-      FileUtil fileUtil) {\n+      FileUtil fileUtil,\n+      Schedulers schedulers) {\n     this.tileDownloadWorkManager = tileDownloadWorkManager;\n     this.localDataStore = localDataStore;\n     this.geoJsonParser = geoJsonParser;\n     this.uuidGenerator = uuidGenerator;\n+    this.projectRepository = projectRepository;\n     this.fileUtil = fileUtil;\n+    this.schedulers = schedulers;\n   }\n \n-  private Completable enqueueTileDownloads(OfflineArea area) {\n-    File jsonSource;\n-\n-    try {\n-      jsonSource = fileUtil.getFileFromRawResource(R.raw.gnd_geojson, Config.GEO_JSON);\n-    } catch (IOException e) {\n-      return Completable.error(e);\n+  /**\n+   * Download the offline basemap source for the active project.\n+   *\n+   * <p>Only the first basemap source is used. Sources are always re-downloaded and overwritten on\n+   * subsequent calls.\n+   */\n+  private File downloadOfflineBaseMapSource(\n+      ImmutableList<OfflineBaseMapSource> offlineBaseMapSources)\n+      throws IOException, NoBaseMapSourceException {\n+    if (offlineBaseMapSources.isEmpty()) {\n+      throw new NoBaseMapSourceException(\"No basemap sources specified for this project.\");\n     }\n \n-    ImmutableList<Tile> tiles = geoJsonParser.intersectingTiles(area.getBounds(), jsonSource);\n+    OfflineBaseMapSource source = offlineBaseMapSources.get(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDcyMg==", "bodyText": "Please refactor as mentioned above.", "url": "https://github.com/google/ground-android/pull/560#discussion_r470964722", "createdAt": "2020-08-15T10:46:18Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -109,19 +148,17 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n \n   public Flowable<ImmutableSet<Tile>> getIntersectingDownloadedTilesOnceAndStream(\n       OfflineArea offlineArea) {\n-    File jsonSource;\n-\n-    try {\n-      jsonSource = fileUtil.getFileFromRawResource(R.raw.gnd_geojson, Config.GEO_JSON);\n-    } catch (IOException e) {\n-      return Flowable.error(e);\n-    }\n-\n-    ImmutableList<Tile> tiles =\n-        geoJsonParser.intersectingTiles(offlineArea.getBounds(), jsonSource);\n-\n-    return getDownloadedTilesOnceAndStream()\n-        .map(ts -> stream(tiles).filter(tiles::contains).collect(toImmutableSet()));\n+    return projectRepository\n+        .getActiveProjectOnceAndStream()\n+        .compose(Loadable::values)\n+        .map(Project::getOfflineBaseMapSources)\n+        .map(this::downloadOfflineBaseMapSource)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NDg0MA==", "bodyText": "Is the error non-fatal? If not, then please consider adding Timber.e() so that it eventually ends up in error/crash reporting.", "url": "https://github.com/google/ground-android/pull/560#discussion_r470964840", "createdAt": "2020-08-15T10:48:14Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -109,19 +148,17 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n \n   public Flowable<ImmutableSet<Tile>> getIntersectingDownloadedTilesOnceAndStream(\n       OfflineArea offlineArea) {\n-    File jsonSource;\n-\n-    try {\n-      jsonSource = fileUtil.getFileFromRawResource(R.raw.gnd_geojson, Config.GEO_JSON);\n-    } catch (IOException e) {\n-      return Flowable.error(e);\n-    }\n-\n-    ImmutableList<Tile> tiles =\n-        geoJsonParser.intersectingTiles(offlineArea.getBounds(), jsonSource);\n-\n-    return getDownloadedTilesOnceAndStream()\n-        .map(ts -> stream(tiles).filter(tiles::contains).collect(toImmutableSet()));\n+    return projectRepository\n+        .getActiveProjectOnceAndStream()\n+        .compose(Loadable::values)\n+        .map(Project::getOfflineBaseMapSources)\n+        .map(this::downloadOfflineBaseMapSource)\n+        .map(json -> geoJsonParser.intersectingTiles(offlineArea.getBounds(), json))\n+        .flatMap(\n+            tiles ->\n+                getDownloadedTilesOnceAndStream()\n+                    .map(ts -> stream(ts).filter(tiles::contains).collect(toImmutableSet())))\n+        .onErrorReturn(throwable -> ImmutableSet.of());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2NTA4OA==", "bodyText": "makeFile -> createFile?\nIn the comment, you've mentioned that it creates a new empty file. But it is not always going to be true if the file for the provided filename already exists. Please consider adding a check to validate that no file exists for the given name or update comment.", "url": "https://github.com/google/ground-android/pull/560#discussion_r470965088", "createdAt": "2020-08-15T10:51:28Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/util/FileUtil.java", "diffHunk": "@@ -70,6 +70,13 @@ public File getFile(String filename) throws FileNotFoundException {\n     return file;\n   }\n \n+  /**\n+   * Creates a new empty file in the app's file directory /data/data/com.google.android.gnd/files\n+   */\n+  public File makeFile(String filename) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0660a3fa22728ed035b4f2b7fde516062eace9b"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80f43c4a1cd028b8ffe3c5c4e33fa9051fce66a2", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/80f43c4a1cd028b8ffe3c5c4e33fa9051fce66a2", "committedDate": "2020-08-17T19:12:16Z", "message": "Revert removal of google-services.json"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b11ee0f7699ce2e369f905e695ab879dd0d22ff", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/5b11ee0f7699ce2e369f905e695ab879dd0d22ff", "committedDate": "2020-08-17T19:14:56Z", "message": "Remove NO_PMD annotations from OptionEntity\n\nThe ignored PMD violation stemmed from repetitions of the field_id literal. There are few enough repetitions now to prevent the violation from occurring, so we no longer need the annotations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e17a280a2b16e0ddf61887141892c7f1ccf4fbf8", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/e17a280a2b16e0ddf61887141892c7f1ccf4fbf8", "committedDate": "2020-08-17T19:19:18Z", "message": "Rename makeFile -> getOrCreateFile\n\nThis name more accurately describes what this method does--it is equivalent to getFile, sans an existence check. I've updated the corresponding comment as well."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80e58f88e24788d3fe112481bea4b36f0e814b33", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/80e58f88e24788d3fe112481bea4b36f0e814b33", "committedDate": "2020-08-17T19:25:30Z", "message": "Refactor offline area repository methods\n\nThe basemap source stream wasn't completing, resulting in failed event\npropagations to the UI--that's fixed now.\n\nAdditionally, I've refactored some methods to make the code dryer.\n\nBig thanks to Shobhit for the feedback!"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a911334a2a0532f66cbe368e7f0b04bc8196c7a6", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/a911334a2a0532f66cbe368e7f0b04bc8196c7a6", "committedDate": "2020-08-18T17:40:57Z", "message": "Merge branch 'master' into project-basemap-source"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzE1NDc2", "url": "https://github.com/google/ground-android/pull/560#pullrequestreview-469715476", "createdAt": "2020-08-18T18:24:52Z", "commit": {"oid": "a911334a2a0532f66cbe368e7f0b04bc8196c7a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1600, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}