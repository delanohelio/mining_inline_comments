{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1ODQ3NDgy", "number": 371, "title": "[Remote sync] Refactor remote persistence layer", "bodyText": "Splits conversion logic out from remote entity classes\n Makes remote entity classes immutable\n Renames and moves all entities and converters into com.google.android.gnd.persistence.remote.firestore\n Additional error checking for Features and Observations\n Other minor cleanup around remote persistence\n\nWe should also handle null fields in the Project document correctly, but saving this for a follow-up PR since this one is already a getting to be a scary beast!", "createdAt": "2020-02-16T16:54:26Z", "url": "https://github.com/google/ground-android/pull/371", "merged": true, "mergeCommit": {"oid": "bd4a650c5dbf485368c54b13b9e829840549236b"}, "closed": true, "closedAt": "2020-02-20T22:49:22Z", "author": {"login": "gino-m"}, "timelineItems": {"totalCount": 45, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDKCgzgH2gAyMzc1ODQ3NDgyOmVkZDE5ODJhZTZmOWU1YTRkNzhiNTg1OWZkMDdmYWJiNGExOWU3YmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGSTVLAFqTM2MjI1ODM5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "edd1982ae6f9e5a4d78b5859fd07fabb4a19e7bc", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/edd1982ae6f9e5a4d78b5859fd07fabb4a19e7bc", "committedDate": "2020-02-11T04:29:39Z", "message": "Increase max perm size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15ffc620272cdd614efb0ade24f7c40f80f029ad", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/15ffc620272cdd614efb0ade24f7c40f80f029ad", "committedDate": "2020-02-11T04:34:57Z", "message": "Refactor remote persistency layer for Features"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aa7f3abb3a11ea067280a7c8cdac9899e8c4d7c", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/1aa7f3abb3a11ea067280a7c8cdac9899e8c4d7c", "committedDate": "2020-02-11T04:36:46Z", "message": "Merge branch 'disable-data-class-pmd' into harden-firestore-objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "982ac036c98eca03bf9cb275d83525b7db924c1f", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/982ac036c98eca03bf9cb275d83525b7db924c1f", "committedDate": "2020-02-12T02:11:26Z", "message": "Merge branch 'master' into harden-firestore-objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2555c9a6775f6b82d1cb907c170320abe8f0e379", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/2555c9a6775f6b82d1cb907c170320abe8f0e379", "committedDate": "2020-02-12T02:11:43Z", "message": "Add missing newline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa059f3062dfe0c8a1b155fc669e4886b5352bb3", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/aa059f3062dfe0c8a1b155fc669e4886b5352bb3", "committedDate": "2020-02-12T02:11:52Z", "message": "Merge branch 'harden-firestore-objects' of https://github.com/gino-m/ground-android into harden-firestore-objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f08e84e49015057de4cdef8281bb00d92a8035", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/76f08e84e49015057de4cdef8281bb00d92a8035", "committedDate": "2020-02-12T02:13:24Z", "message": "Replace \"place\" with \"feature\"."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be5f2f223ea7ca1eabcc1304b71cfd38626cf67c", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/be5f2f223ea7ca1eabcc1304b71cfd38626cf67c", "committedDate": "2020-02-12T03:38:32Z", "message": "Implement missing value checks for Features in Firestore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b56acc31af0ce988d851e6cb142ddbdc2ad4f803", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/b56acc31af0ce988d851e6cb142ddbdc2ad4f803", "committedDate": "2020-02-12T15:47:41Z", "message": "More descriptive arg names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78ffa72333f57be3d2dba31e570a565a60d28721", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/78ffa72333f57be3d2dba31e570a565a60d28721", "committedDate": "2020-02-12T15:48:55Z", "message": "Shorter converter name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "937971f5cffad1ef8279f64acebb994cbb682682", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/937971f5cffad1ef8279f64acebb994cbb682682", "committedDate": "2020-02-12T16:12:48Z", "message": "Handle Feature deserialization errors downstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9df1b8725a920f31146378f04ce0041a3ec1015c", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/9df1b8725a920f31146378f04ce0041a3ec1015c", "committedDate": "2020-02-15T15:44:36Z", "message": "Merge branch 'master' into harden-firestore-objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eee5979ca2a982f3e57e9ac12e69fe70087b1733", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/eee5979ca2a982f3e57e9ac12e69fe70087b1733", "committedDate": "2020-02-15T16:30:03Z", "message": "Update JavaDoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8de127afef1323754c5d8c8f3f589920efa98a0", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/a8de127afef1323754c5d8c8f3f589920efa98a0", "committedDate": "2020-02-16T16:51:44Z", "message": "Refactor Firestore observation persistence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d349a6a627757e6406426d34eefffed17eb1a42", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/6d349a6a627757e6406426d34eefffed17eb1a42", "committedDate": "2020-02-17T20:20:22Z", "message": "Update method visibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a498cf7ae7a0c99b32b0518c4a0511054f214ea", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/7a498cf7ae7a0c99b32b0518c4a0511054f214ea", "committedDate": "2020-02-17T20:28:27Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into firestore-cleanup2\n\n# Conflicts:\n#\tgradle.properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b2b988370de9e4deca59821ade391146f795f80", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/6b2b988370de9e4deca59821ade391146f795f80", "committedDate": "2020-02-17T20:28:43Z", "message": "Update visibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be956f328d78b6ba579304075f8da13203f821d6", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/be956f328d78b6ba579304075f8da13203f821d6", "committedDate": "2020-02-17T22:06:03Z", "message": "Handle remote observation conversion errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aa8b64f7b4b0486fe452d52dcb00f78d213ee3d", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/1aa8b64f7b4b0486fe452d52dcb00f78d213ee3d", "committedDate": "2020-02-17T22:10:12Z", "message": "Add log text"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "319fb80fc01e27bbdc7fd8855acda306eeb0750a", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/319fb80fc01e27bbdc7fd8855acda306eeb0750a", "committedDate": "2020-02-17T22:10:57Z", "message": "Handle remote observation mutation errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c466a2419952ed05c30a2302b356c9af7e6294dc", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/c466a2419952ed05c30a2302b356c9af7e6294dc", "committedDate": "2020-02-17T22:45:48Z", "message": "Refactor remote project deserialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34f23d172f762377879f49489c20fb160cca8f54", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/34f23d172f762377879f49489c20fb160cca8f54", "committedDate": "2020-02-17T23:00:48Z", "message": "Improve handling of missing remote entities"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "977baf4f5abfc27cc198874ae3b75e63151f2369", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/977baf4f5abfc27cc198874ae3b75e63151f2369", "committedDate": "2020-02-17T23:04:40Z", "message": "Rename and move AuditInfo remote entity class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3319e600b8cfddbca92a1473903c01079a789ab2", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/3319e600b8cfddbca92a1473903c01079a789ab2", "committedDate": "2020-02-17T23:12:29Z", "message": "Refactor remote persistence of AuditInfo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc32093e25eeb2c836227480cbe1d85e9f18ccd", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/4fc32093e25eeb2c836227480cbe1d85e9f18ccd", "committedDate": "2020-02-17T23:13:12Z", "message": "Rename and move user remote nested object class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53ec85d2bdcb2929388bab730c1c7c23a1e2a4b1", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/53ec85d2bdcb2929388bab730c1c7c23a1e2a4b1", "committedDate": "2020-02-17T23:18:55Z", "message": "Refactor remote persistence of nested user objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45451337f601d54af0b47a17bada6fe436cfa91b", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/45451337f601d54af0b47a17bada6fe436cfa91b", "committedDate": "2020-02-17T23:55:46Z", "message": "Refactor remaining layer and form remote entity classes and converters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8605661dde690a7e9d8f49fc719b5eff04a68e9", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/d8605661dde690a7e9d8f49fc719b5eff04a68e9", "committedDate": "2020-02-18T00:00:43Z", "message": "Move up common remote datastore classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a748b24b014aa43961735eee5c55a5deb0df577", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/7a748b24b014aa43961735eee5c55a5deb0df577", "committedDate": "2020-02-18T00:10:06Z", "message": "Restore checkCode invocation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb", "committedDate": "2020-02-18T00:26:15Z", "message": "Reduce visibility of members"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzEzODQ4", "url": "https://github.com/google/ground-android/pull/371#pullrequestreview-360713848", "createdAt": "2020-02-18T22:15:28Z", "commit": {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMjoxNToyOFrOFrUdAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMjo0NToxNFrOFrVNug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2ODE5Mg==", "bodyText": "Should we use exceptions for this case?\nI'm of the opinion that exceptions are more useful for states that are actually unrecoverable/catastrophic--places where crashing w/ a message + trace is a valid course of action, whereas when we do stuff like ignore or log a potential value we don't care about and otherwise continue running some kind of value wrapper type is more appropriate\u2014it doesn't make much of a difference at the end of the day, so I would bother if you have a different stance on this.", "url": "https://github.com/google/ground-android/pull/371#discussion_r380968192", "createdAt": "2020-02-18T22:15:28Z", "author": {"login": "scolsen"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreDataStore.java", "diffHunk": "@@ -91,30 +97,37 @@ public Completable applyMutations(ImmutableCollection<Mutation> mutations, User\n   private Task<?> applyMutationsInternal(ImmutableCollection<Mutation> mutations, User user) {\n     WriteBatch batch = db.batch();\n     for (Mutation mutation : mutations) {\n-      addMutationToBatch(mutation, user, batch);\n+      try {\n+        addMutationToBatch(mutation, user, batch);\n+      } catch (DataStoreException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDA1MQ==", "bodyText": "Is it really a POJO? Doesn't it depend on Firebase?", "url": "https://github.com/google/ground-android/pull/371#discussion_r380970051", "createdAt": "2020-02-18T22:19:39Z", "author": {"login": "scolsen"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/AuditInfoConverter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import com.google.android.gnd.model.AuditInfo;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.User;\n+import com.google.firebase.Timestamp;\n+import java.util.Date;\n+import java8.util.Optional;\n+\n+/** Converts between Firestore nested objects and {@link AuditInfo} instances. */\n+class AuditInfoConverter {\n+\n+  /**\n+   * Converts a POJO representing user and timestamp data in Firebase into an equivalent model", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDkzNg==", "bodyText": "If we know the user, shouldn't we ascribe the audit to the user even if the time is somehow unknown?", "url": "https://github.com/google/ground-android/pull/371#discussion_r380970936", "createdAt": "2020-02-18T22:21:44Z", "author": {"login": "scolsen"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/AuditInfoConverter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import com.google.android.gnd.model.AuditInfo;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.User;\n+import com.google.firebase.Timestamp;\n+import java.util.Date;\n+import java8.util.Optional;\n+\n+/** Converts between Firestore nested objects and {@link AuditInfo} instances. */\n+class AuditInfoConverter {\n+\n+  /**\n+   * Converts a POJO representing user and timestamp data in Firebase into an equivalent model\n+   * object. This should never be empty in Firebase, but this method returns a default value when\n+   * the input is null to support legacy or corrupt dbs.\n+   */\n+  @NonNull\n+  static AuditInfo toAuditInfo(@Nullable AuditInfoNestedObject doc) {\n+    if (doc == null || doc.getClientTimeMillis() == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3NDI1NA==", "bodyText": "We could also return defaults from the AuditInfoNestedObject getters themselves -- since we're accounting for a peculiarity of firebase and not our model.\nPlus that ensures the work performed by the converter is actual conversion from store values to model values (timestamp->date) and we don't give it the double duty of defining defaults for store values.", "url": "https://github.com/google/ground-android/pull/371#discussion_r380974254", "createdAt": "2020-02-18T22:29:50Z", "author": {"login": "scolsen"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/AuditInfoConverter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import com.google.android.gnd.model.AuditInfo;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.User;\n+import com.google.firebase.Timestamp;\n+import java.util.Date;\n+import java8.util.Optional;\n+\n+/** Converts between Firestore nested objects and {@link AuditInfo} instances. */\n+class AuditInfoConverter {\n+\n+  /**\n+   * Converts a POJO representing user and timestamp data in Firebase into an equivalent model\n+   * object. This should never be empty in Firebase, but this method returns a default value when\n+   * the input is null to support legacy or corrupt dbs.\n+   */\n+  @NonNull\n+  static AuditInfo toAuditInfo(@Nullable AuditInfoNestedObject doc) {\n+    if (doc == null || doc.getClientTimeMillis() == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDkzNg=="}, "originalCommit": {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3NDM5OQ==", "bodyText": "I don't have a particularly strong opinion on this though, so up to you.", "url": "https://github.com/google/ground-android/pull/371#discussion_r380974399", "createdAt": "2020-02-18T22:30:13Z", "author": {"login": "scolsen"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/AuditInfoConverter.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import com.google.android.gnd.model.AuditInfo;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.User;\n+import com.google.firebase.Timestamp;\n+import java.util.Date;\n+import java8.util.Optional;\n+\n+/** Converts between Firestore nested objects and {@link AuditInfo} instances. */\n+class AuditInfoConverter {\n+\n+  /**\n+   * Converts a POJO representing user and timestamp data in Firebase into an equivalent model\n+   * object. This should never be empty in Firebase, but this method returns a default value when\n+   * the input is null to support legacy or corrupt dbs.\n+   */\n+  @NonNull\n+  static AuditInfo toAuditInfo(@Nullable AuditInfoNestedObject doc) {\n+    if (doc == null || doc.getClientTimeMillis() == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3MDkzNg=="}, "originalCommit": {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk3ODA5NA==", "bodyText": "Is there a reason we don't store formIds on forms themselves?", "url": "https://github.com/google/ground-android/pull/371#discussion_r380978094", "createdAt": "2020-02-18T22:39:10Z", "author": {"login": "scolsen"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/FormConverter.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n+\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java8.util.stream.StreamSupport.stream;\n+\n+import com.google.android.gnd.model.form.Form;\n+\n+/** Converts between Firestore nested objects and {@link Form} instances. */\n+class FormConverter {\n+\n+  static Form toForm(String formId, FormNestedObject obj) {\n+    return Form.newBuilder()\n+        .setId(formId)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk4MDY2Ng==", "bodyText": "Instead of doing a conversion here, could we just add a single layer of indirection to the DocSnapshots? -- so that their first interior/nested field is the representation of a Project, instead of having them represent the project itself? --or would that be rather fussy/pointless?", "url": "https://github.com/google/ground-android/pull/371#discussion_r380980666", "createdAt": "2020-02-18T22:45:14Z", "author": {"login": "scolsen"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/schema/ProjectConverter.java", "diffHunk": "@@ -14,36 +14,28 @@\n  * limitations under the License.\n  */\n \n-package com.google.android.gnd.persistence.remote.firestore;\n+package com.google.android.gnd.persistence.remote.firestore.schema;\n \n import static com.google.android.gnd.util.Localization.getLocalizedMessage;\n \n-import androidx.annotation.Nullable;\n import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.persistence.remote.DataStoreException;\n import com.google.firebase.firestore.DocumentSnapshot;\n-import com.google.firebase.firestore.IgnoreExtraProperties;\n-import java.util.Map;\n import java8.util.Maps;\n \n-@IgnoreExtraProperties\n-public class ProjectDoc {\n-  @Nullable public Map<String, String> title;\n+/** Converts between Firestore documents and {@link Project} instances. */\n+class ProjectConverter {\n \n-  @Nullable public Map<String, String> description;\n-\n-  // TODO: Add AuditInfoDoc for created and lastModified.\n-\n-  @Nullable public Map<String, LayerDoc> featureTypes;\n-\n-  public static Project toObject(DocumentSnapshot doc) {\n-    ProjectDoc pd = doc.toObject(ProjectDoc.class);\n+  static Project toProject(DocumentSnapshot doc) throws DataStoreException {\n+    ProjectDocument pd = doc.toObject(ProjectDocument.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4c6fff20bf30073a52ee2f3a564ac162a8cc0bb"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43045e6a7e3951db53f00be4fc902718c89a2052", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/43045e6a7e3951db53f00be4fc902718c89a2052", "committedDate": "2020-02-18T23:05:59Z", "message": "Merge branch 'master' into firestore-cleanup2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab1b06fb643e4de3e4d029cedbc93f575535674d", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/ab1b06fb643e4de3e4d029cedbc93f575535674d", "committedDate": "2020-02-18T23:20:08Z", "message": "Fail on missing creation timestamp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "895bbd468329a4aa64fcb8c89d5bc483e8e34556", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/895bbd468329a4aa64fcb8c89d5bc483e8e34556", "committedDate": "2020-02-18T23:20:44Z", "message": "Merge remote-tracking branch 'origin/firestore-cleanup2' into firestore-cleanup2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f16c32f4670c2d8313c87958891da0063c71c21", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/9f16c32f4670c2d8313c87958891da0063c71c21", "committedDate": "2020-02-18T23:25:27Z", "message": "Remove redundant JavaDoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzk2NTM1", "url": "https://github.com/google/ground-android/pull/371#pullrequestreview-360796535", "createdAt": "2020-02-19T01:55:41Z", "commit": {"oid": "9f16c32f4670c2d8313c87958891da0063c71c21"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3df4f1986c96035cbdbcd1c002f08cedeaaf6163", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/3df4f1986c96035cbdbcd1c002f08cedeaaf6163", "committedDate": "2020-02-19T14:52:47Z", "message": "Merge branch 'master' into firestore-cleanup2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60f8f92f0f5a1e33394bedc7f54eac49c227cde7", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/60f8f92f0f5a1e33394bedc7f54eac49c227cde7", "committedDate": "2020-02-19T22:17:41Z", "message": "Merge branch 'master' into firestore-cleanup2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42a9c8a8dd6b536d19d69be66f46e83fd630a5e2", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/42a9c8a8dd6b536d19d69be66f46e83fd630a5e2", "committedDate": "2020-02-19T22:31:41Z", "message": "Remove qualifier from TAG constant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16fbc894218216d91428cc7e30361e8b1e58090e", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/16fbc894218216d91428cc7e30361e8b1e58090e", "committedDate": "2020-02-19T22:45:02Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into firestore-cleanup2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "991d6c76e3403e769890ce4768c31dc70b03ede0", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/991d6c76e3403e769890ce4768c31dc70b03ede0", "committedDate": "2020-02-19T23:15:08Z", "message": "Make stack trace more readable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6c22ab44e6176741570d3074824a104b4ad2611", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/e6c22ab44e6176741570d3074824a104b4ad2611", "committedDate": "2020-02-19T23:20:31Z", "message": "Add nullness check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bf722f58ef3fca00f1459b0cfba85b722119a6e", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/6bf722f58ef3fca00f1459b0cfba85b722119a6e", "committedDate": "2020-02-19T23:34:53Z", "message": "Public constructors and accessors for Firestore toObject()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "519025f61dadcebfb74685a7d780988680959280", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/519025f61dadcebfb74685a7d780988680959280", "committedDate": "2020-02-19T23:35:04Z", "message": "Merge remote-tracking branch 'origin/firestore-cleanup2' into firestore-cleanup2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjU4Mzk0", "url": "https://github.com/google/ground-android/pull/371#pullrequestreview-362258394", "createdAt": "2020-02-20T21:49:02Z", "commit": {"oid": "519025f61dadcebfb74685a7d780988680959280"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1717, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}