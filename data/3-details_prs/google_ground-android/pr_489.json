{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MTMxNzk2", "number": 489, "title": "Fixed Tile Providers", "bodyText": "Revert problematic MapBox changes\n Ensure all available tiles are rendered on the map.", "createdAt": "2020-05-27T21:50:35Z", "url": "https://github.com/google/ground-android/pull/489", "merged": true, "mergeCommit": {"oid": "3a33e827c30130bfd4d762c156e65d04d8ccdc2c"}, "closed": true, "closedAt": "2020-06-04T15:47:16Z", "author": {"login": "scolsen"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcldzoFgH2gAyNDI0MTMxNzk2OjExY2M2ZTBiMzE4ZjFmNzVhMTI4ZjRkYjBmMjY0YmY3ZjJmYzkwNTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoJYbkgFqTQyNDk1OTUyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "11cc6e0b318f1f75a128f4db0f264bf7f2fc9052", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/11cc6e0b318f1f75a128f4db0f264bf7f2fc9052", "committedDate": "2020-05-27T18:44:55Z", "message": "Restore 47fdd45 in MapBoxOfflineTileProvider\n\nI made some less than wise changes in the commits following this one,\nwhich caused tile rendering to behave incorrectly (we'd render a tile\nonly at a specific zoom level).\n\nGoing forward, we'll use a different approach and instead spawn tile\nproviders for each mbtiles file we need."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0e724a2fb4effb9ce9b882a7612a723d0f39d65", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/e0e724a2fb4effb9ce9b882a7612a723d0f39d65", "committedDate": "2020-05-27T21:47:50Z", "message": "Catch database corruption errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81ad3789deba3edb2849809f0900c613d9633ae9", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/81ad3789deba3edb2849809f0900c613d9633ae9", "committedDate": "2020-05-27T21:48:15Z", "message": "Update map adapter to render mbtiles correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ed6666e89453a63d671d798ee87b57fed3f5c06", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/6ed6666e89453a63d671d798ee87b57fed3f5c06", "committedDate": "2020-06-03T20:47:44Z", "message": "Ensure MapBoxOfflineTileProviders are closed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/7de2a9acc752fec35b98a1d30dc56acfba86bf32", "committedDate": "2020-06-03T20:48:14Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into tile-provider-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzOTcwMTc0", "url": "https://github.com/google/ground-android/pull/489#pullrequestreview-423970174", "createdAt": "2020-06-03T22:04:49Z", "commit": {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMjowNDo0OVrOGevMnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QyMjowOToxNVrOGevTRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4Mzc0MQ==", "bodyText": "Naming nit: onTileProvider<event/action>", "url": "https://github.com/google/ground-android/pull/489#discussion_r434883741", "createdAt": "2020-06-03T22:04:49Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerFragment.java", "diffHunk": "@@ -103,6 +103,11 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n         .flatMap(MapAdapter::getCameraMoves)\n         .as(disposeOnDestroy(this))\n         .subscribe(mapContainerViewModel::onCameraMove);\n+    mapAdapter\n+        .toObservable()\n+        .flatMap(MapAdapter::getTileProviders)\n+        .as(disposeOnDestroy(this))\n+        .subscribe(mapContainerViewModel::onTileProvider);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4MzkxNA==", "bodyText": "Naming: render -> addTileOverlays", "url": "https://github.com/google/ground-android/pull/489#discussion_r434883914", "createdAt": "2020-06-03T22:05:13Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerFragment.java", "diffHunk": "@@ -149,7 +154,7 @@ private void onMapReady(MapAdapter map) {\n     addFeatureBtn.setOnClickListener(\n         __ -> homeScreenViewModel.onAddFeatureBtnClick(map.getCameraTarget()));\n     enableLocationLockBtn();\n-    map.renderTileOverlay();\n+    mapContainerViewModel.getMbtiles().observe(this, map::renderTileOverlays);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDI0Mw==", "bodyText": "mbtilesFilePaths maybe? (since this doesn't actually contain the data)", "url": "https://github.com/google/ground-android/pull/489#discussion_r434884243", "createdAt": "2020-06-03T22:06:07Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerViewModel.java", "diffHunk": "@@ -90,6 +98,11 @@\n                 .map(Loadable::value)\n                 .switchMap(this::getFeaturesStream)\n                 .map(MapContainerViewModel::toMapPins));\n+    this.mbtiles =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDcxMA==", "bodyText": "Same here: add instead of render", "url": "https://github.com/google/ground-android/pull/489#discussion_r434884710", "createdAt": "2020-06-03T22:07:17Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/map/gms/GoogleMapsMapAdapter.java", "diffHunk": "@@ -247,10 +257,21 @@ public LatLngBounds getViewport() {\n   }\n \n   @Override\n-  public void renderTileOverlay() {\n-    try (MapBoxOfflineTileProvider tileProvider =\n-        new MapBoxOfflineTileProvider(context.getFilesDir())) {\n-      map.addTileOverlay(new TileOverlayOptions().tileProvider(tileProvider));\n-    }\n+  public void renderTileOverlays(ImmutableSet<String> mbtilesFiles) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NDc5MA==", "bodyText": "Can this inner lambda be extract to its own method for readability?", "url": "https://github.com/google/ground-android/pull/489#discussion_r434884790", "createdAt": "2020-06-03T22:07:32Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/map/gms/GoogleMapsMapAdapter.java", "diffHunk": "@@ -247,10 +257,21 @@ public LatLngBounds getViewport() {\n   }\n \n   @Override\n-  public void renderTileOverlay() {\n-    try (MapBoxOfflineTileProvider tileProvider =\n-        new MapBoxOfflineTileProvider(context.getFilesDir())) {\n-      map.addTileOverlay(new TileOverlayOptions().tileProvider(tileProvider));\n-    }\n+  public void renderTileOverlays(ImmutableSet<String> mbtilesFiles) {\n+    stream(mbtilesFiles)\n+        .forEach(\n+            path -> {\n+              File mbtiles = new File(context.getFilesDir(), path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NTA3MA==", "bodyText": "Could you short circuit exit here instead and Timber.info the fact the the file was not found?", "url": "https://github.com/google/ground-android/pull/489#discussion_r434885070", "createdAt": "2020-06-03T22:08:13Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/map/gms/GoogleMapsMapAdapter.java", "diffHunk": "@@ -247,10 +257,21 @@ public LatLngBounds getViewport() {\n   }\n \n   @Override\n-  public void renderTileOverlay() {\n-    try (MapBoxOfflineTileProvider tileProvider =\n-        new MapBoxOfflineTileProvider(context.getFilesDir())) {\n-      map.addTileOverlay(new TileOverlayOptions().tileProvider(tileProvider));\n-    }\n+  public void renderTileOverlays(ImmutableSet<String> mbtilesFiles) {\n+    stream(mbtilesFiles)\n+        .forEach(\n+            path -> {\n+              File mbtiles = new File(context.getFilesDir(), path);\n+              if (mbtiles.exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg4NTQ0Nw==", "bodyText": "Could you kindly add a TODO and Code health task to create our own wrapper interface/impl for these?", "url": "https://github.com/google/ground-android/pull/489#discussion_r434885447", "createdAt": "2020-06-03T22:09:15Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerViewModel.java", "diffHunk": "@@ -59,12 +64,15 @@\n   private final Subject<Boolean> locationLockChangeRequests;\n   private final Subject<CameraUpdate> cameraUpdateSubject;\n   private final MutableLiveData<Event<Nil>> showMapTypeSelectorRequests = new MutableLiveData<>();\n+  private final LiveData<ImmutableSet<String>> mbtiles;\n+  private final List<MapBoxOfflineTileProvider> tileProviders = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7de2a9acc752fec35b98a1d30dc56acfba86bf32"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57cb7dd9d31e68d8c97168a3778b7bcb62c173f7", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/57cb7dd9d31e68d8c97168a3778b7bcb62c173f7", "committedDate": "2020-06-04T13:55:15Z", "message": "Refactor renderTileOverlays in MapAdapter\n\n- rename renderTileOverlays -> addTileOverlays\n- convert anonymous lambda into a named helper function\n- short-circuit when tile files aren't found"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a41a2650397ca3f118ba6677bb57e2affb43af", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/f9a41a2650397ca3f118ba6677bb57e2affb43af", "committedDate": "2020-06-04T14:13:39Z", "message": "Refactor MBTiles handling in MapContainer\n\n- Rename onTileProvider -> queueTileProvider\n- Rename mbtiles -> mbtilesFilePaths\n- Add a TODO to create a generic interface/wrapper for MBtiles providers."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NTg4NTQy", "url": "https://github.com/google/ground-android/pull/489#pullrequestreview-424588542", "createdAt": "2020-06-04T15:46:52Z", "commit": {"oid": "f9a41a2650397ca3f118ba6677bb57e2affb43af"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNTo0Njo1MlrOGfMcEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNTo0Njo1MlrOGfMcEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM2MjgzNA==", "bodyText": "Not sure queue is the right name here, since it implies an actual queue is being used, and not a stream. In this case \"add\" would be correct, since it's really a deferred add operation, but this can be changed later if we like.", "url": "https://github.com/google/ground-android/pull/489#discussion_r435362834", "createdAt": "2020-06-04T15:46:52Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/mapcontainer/MapContainerFragment.java", "diffHunk": "@@ -107,7 +107,7 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n         .toObservable()\n         .flatMap(MapAdapter::getTileProviders)\n         .as(disposeOnDestroy(this))\n-        .subscribe(mapContainerViewModel::onTileProvider);\n+        .subscribe(mapContainerViewModel::queueTileProvider);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9a41a2650397ca3f118ba6677bb57e2affb43af"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTU5NTIy", "url": "https://github.com/google/ground-android/pull/489#pullrequestreview-424959522", "createdAt": "2020-06-05T02:38:52Z", "commit": {"oid": "f9a41a2650397ca3f118ba6677bb57e2affb43af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1562, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}