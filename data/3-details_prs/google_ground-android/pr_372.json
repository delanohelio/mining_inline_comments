{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2NDA2MzYw", "number": 372, "title": "[Map] Use custom Ground marker for point features", "bodyText": "User-defined fill color required building the bitmap in memory out of constituent vector parts, since it's not possible to edit a single vector path in Android without extra libraries or workarounds.\nFixes #117, fixes #171. #364, #373 still pending.\n\n\n@hintzemichael w00t! \ud83c\udf89", "createdAt": "2020-02-18T04:04:43Z", "url": "https://github.com/google/ground-android/pull/372", "merged": true, "mergeCommit": {"oid": "45afb2de53776776bfad85f2a9f4720c74b7f0b9"}, "closed": true, "closedAt": "2020-02-24T17:15:58Z", "author": {"login": "gino-m"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFZ0ifgH2gAyMzc2NDA2MzYwOmM2MWUwM2RlM2U2MjNjMjQ5NGYzOTNmOWZlMzM2Y2U0NWQ5OWFiMWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHgynaAFqTM2MzU1OTQ4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c61e03de3e623c2494f393f9fe336ce45d99ab1c", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/c61e03de3e623c2494f393f9fe336ce45d99ab1c", "committedDate": "2020-02-18T04:00:43Z", "message": "Build marker bitmap out of vector components"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e653d1a548e41dba4076ddf09f9881ce3f7dce4f", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/e653d1a548e41dba4076ddf09f9881ce3f7dce4f", "committedDate": "2020-02-18T04:08:28Z", "message": "Replace commented out code with TODO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b9ad1af89ae5e3e68e916c2606abb198c926f69", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/5b9ad1af89ae5e3e68e916c2606abb198c926f69", "committedDate": "2020-02-18T17:58:20Z", "message": "Merge branch 'master' into new-map-marker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4d1540b6c6d003af80c7c911223fd20724ce328", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/f4d1540b6c6d003af80c7c911223fd20724ce328", "committedDate": "2020-02-18T18:56:52Z", "message": "Fix path of includes in base checkstyle config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5584ccdc8b7949ac5a6f83eaf4701f034f167c5f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/5584ccdc8b7949ac5a6f83eaf4701f034f167c5f", "committedDate": "2020-02-19T10:37:48Z", "message": "Fix header and rearrange ic_marker_fill"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5d2778d59aa786c78242ba9d46a2cea80b62ee3", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d5d2778d59aa786c78242ba9d46a2cea80b62ee3", "committedDate": "2020-02-19T10:38:40Z", "message": "Fix header and rearrange ic_marker_outline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc51f47580dd65fd1995b4d86ee47805fab0d0af", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/bc51f47580dd65fd1995b4d86ee47805fab0d0af", "committedDate": "2020-02-19T10:39:13Z", "message": "Fix header and rearrange ic_marker_overlay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "954d88cbf6be49130cb85b9ccbbcb88f9aa42747", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/954d88cbf6be49130cb85b9ccbbcb88f9aa42747", "committedDate": "2020-02-19T10:39:51Z", "message": "Fix checkstyle header template path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5cb855ad0b9809ac83b181892f7f613bb23a162", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f5cb855ad0b9809ac83b181892f7f613bb23a162", "committedDate": "2020-02-19T10:40:01Z", "message": "Fix checkstyle header template path"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMDM3Mzkz", "url": "https://github.com/google/ground-android/pull/372#pullrequestreview-361037393", "createdAt": "2020-02-19T11:30:24Z", "commit": {"oid": "f5cb855ad0b9809ac83b181892f7f613bb23a162"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMTozMDoyNFrOFrkvCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMTozMDoyNFrOFrkvCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTIzNDk1Mw==", "bodyText": "In addition, let's log an error as well to keep track of such events.", "url": "https://github.com/google/ground-android/pull/372#discussion_r381234953", "createdAt": "2020-02-19T11:30:24Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/MapIcon.java", "diffHunk": "@@ -17,80 +17,54 @@\n package com.google.android.gnd.ui;\n \n import android.content.Context;\n-import android.content.res.Resources;\n import android.graphics.Bitmap;\n+import android.graphics.Canvas;\n import android.graphics.Color;\n-import android.graphics.drawable.BitmapDrawable;\n-import android.util.Log;\n-import androidx.annotation.DrawableRes;\n-import androidx.annotation.NonNull;\n+import android.graphics.PorterDuff;\n+import android.graphics.drawable.Drawable;\n import androidx.annotation.Nullable;\n-import androidx.core.content.ContextCompat;\n+import androidx.appcompat.content.res.AppCompatResources;\n import com.google.android.gms.maps.model.BitmapDescriptor;\n import com.google.android.gms.maps.model.BitmapDescriptorFactory;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.ui.util.ViewUtil;\n \n // TODO: Move to common, rename Marker.\n public class MapIcon {\n-  private static final String TAG = MapIcon.class.getSimpleName();\n   private final Context context;\n-  private BitmapDrawable drawable;\n-  private int color;\n+  private final int color;\n \n-  public MapIcon(Context context, @Nullable String iconId, @Nullable String color) {\n+  public MapIcon(Context context, @Nullable String colorHexCode) {\n     this.context = context;\n-    this.color = getIconColor(context, color);\n-    int resourceId = getResourceId(context, iconId);\n-    this.drawable = (BitmapDrawable) ContextCompat.getDrawable(context, resourceId);\n+    this.color = getIconColor(context, colorHexCode);\n   }\n \n-  private static int getIconColor(Context context, String color) {\n-    try {\n-      return Color.parseColor(color);\n-    } catch (Exception e) {\n-      return context.getResources().getColor(R.color.colorMapAccent);\n-    }\n+  public BitmapDescriptor getBitmap() {\n+    Drawable outline = AppCompatResources.getDrawable(context, R.drawable.ic_marker_outline);\n+    Drawable fill = AppCompatResources.getDrawable(context, R.drawable.ic_marker_fill);\n+    Drawable overlay = AppCompatResources.getDrawable(context, R.drawable.ic_marker_overlay);\n+    // TODO: Define scale in resources.\n+    // TODO: Adjust size based on zoom level and selection state.\n+    float scale = 1.8f;\n+    int width = (int) (outline.getIntrinsicWidth() * scale);\n+    int height = (int) (outline.getIntrinsicHeight() * scale);\n+    Bitmap bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);\n+    Canvas canvas = new Canvas(bitmap);\n+    outline.setBounds(0, 0, width, height);\n+    outline.draw(canvas);\n+    fill.setColorFilter(color, PorterDuff.Mode.SRC_ATOP);\n+    fill.setBounds(0, 0, width, height);\n+    fill.draw(canvas);\n+    overlay.setBounds(0, 0, width, height);\n+    overlay.draw(canvas);\n+    // TODO: Cache rendered bitmaps.\n+    return BitmapDescriptorFactory.fromBitmap(bitmap);\n   }\n \n-  @NonNull\n-  public static @DrawableRes int getResourceId(Context context, @Nullable String iconId) {\n-    if (iconId == null) {\n-      return R.drawable.ic_default_map_marker;\n-    }\n+  private static int getIconColor(Context context, String colorHexCode) {\n     try {\n-      String resourceName = \"ic_marker_\" + iconId.replace(\"-\", \"_\");\n-      int resourceId =\n-          context.getResources().getIdentifier(resourceName, \"drawable\", context.getPackageName());\n-      if (resourceId > 0) {\n-        return resourceId;\n-      }\n-    } catch (Resources.NotFoundException e) {\n-      Log.w(TAG, e);\n+      return Color.parseColor(colorHexCode);\n+    } catch (IllegalArgumentException e) {\n+      return context.getResources().getColor(R.color.colorMapAccent);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5cb855ad0b9809ac83b181892f7f613bb23a162"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50049aaea418d44ff6c3fb78d584947b4acb2174", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/50049aaea418d44ff6c3fb78d584947b4acb2174", "committedDate": "2020-02-19T14:46:02Z", "message": "Turn MapIcon into MapMarkerFactory and inject"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "954eadba425adcfac0948ea17f5e95fd06c213e9", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/954eadba425adcfac0948ea17f5e95fd06c213e9", "committedDate": "2020-02-19T14:46:45Z", "message": "Merge branch 'master' into new-map-marker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c64382627b337ebf0547065b61287803e377ae55", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/c64382627b337ebf0547065b61287803e377ae55", "committedDate": "2020-02-19T14:54:02Z", "message": "Enable legacy support vector drawables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be7c7c5e853217baa86726fc31272dd32ce52e93", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/be7c7c5e853217baa86726fc31272dd32ce52e93", "committedDate": "2020-02-24T07:39:02Z", "message": "Merge branch 'master' into new-map-marker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjA3Mjgy", "url": "https://github.com/google/ground-android/pull/372#pullrequestreview-363207282", "createdAt": "2020-02-24T07:50:21Z", "commit": {"oid": "be7c7c5e853217baa86726fc31272dd32ce52e93"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503ba81f1231e2dde2eef9cc25cb94aad9f5f22e", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/503ba81f1231e2dde2eef9cc25cb94aad9f5f22e", "committedDate": "2020-02-24T16:27:02Z", "message": "Use srcCompat for vector images"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNTU5NDg4", "url": "https://github.com/google/ground-android/pull/372#pullrequestreview-363559488", "createdAt": "2020-02-24T17:15:48Z", "commit": {"oid": "503ba81f1231e2dde2eef9cc25cb94aad9f5f22e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1719, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}