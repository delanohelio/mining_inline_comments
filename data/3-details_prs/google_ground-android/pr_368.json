{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NzQ1Mjgx", "number": 368, "title": "[Photos support] Load saved photo in ObservationDetailsFragment", "bodyText": "Towards #310\nAlso fixes a bug for saving photo field to local/remote db", "createdAt": "2020-02-15T18:38:31Z", "url": "https://github.com/google/ground-android/pull/368", "merged": true, "mergeCommit": {"oid": "25b1cac63065b3038017ab22c71b0c68845ad053"}, "closed": true, "closedAt": "2020-02-24T19:41:41Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcEjSShAH2gAyMzc1NzQ1MjgxOmQ4N2Q0MjlkNjBhOGI4N2VlYjA0OGMzMWU0ZmIzNDRhODE4NmZkOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHi4DcgFqTM2MzY1MDI3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d87d429d60a8b87eeb048c31e4fb344a8186fd91", "committedDate": "2020-02-15T12:28:26Z", "message": "Do not clear response map when retuning from external photo intent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "456260abe3f46bfc5b2f173755d62c3c0e767ae2", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/456260abe3f46bfc5b2f173755d62c3c0e767ae2", "committedDate": "2020-02-15T12:33:57Z", "message": "Move FieldViewHolder to its own class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73ee9c76686454a1b5c2e9910eec52ea6b155e39", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/73ee9c76686454a1b5c2e9910eec52ea6b155e39", "committedDate": "2020-02-15T13:18:50Z", "message": "Load response via data binding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93da5a57b608b252469afe41242ef5d459a6c5ac", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/93da5a57b608b252469afe41242ef5d459a6c5ac", "committedDate": "2020-02-15T13:23:57Z", "message": "Cleanup obsolete code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "252b61901930dd1e60c903e06082bfe2b975c2fe", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/252b61901930dd1e60c903e06082bfe2b975c2fe", "committedDate": "2020-02-15T18:35:04Z", "message": "Add placeholder when loading photo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "934348d6e790230d6c1ee9b95e17da5c6fc0c879", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/934348d6e790230d6c1ee9b95e17da5c6fc0c879", "committedDate": "2020-02-15T18:37:12Z", "message": "Load photo field in ObservationDetailsFragment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0351e62a91c60b40b1cb3de22c3e8139de428e0d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/0351e62a91c60b40b1cb3de22c3e8139de428e0d", "committedDate": "2020-02-15T19:20:20Z", "message": " Code cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2975bf046db7f29cf84f43aac9dd8e36ea4bfa3a", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/2975bf046db7f29cf84f43aac9dd8e36ea4bfa3a", "committedDate": "2020-02-15T19:19:43Z", "message": "Remove dummy data"}, "afterCommit": {"oid": "0351e62a91c60b40b1cb3de22c3e8139de428e0d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/0351e62a91c60b40b1cb3de22c3e8139de428e0d", "committedDate": "2020-02-15T19:20:20Z", "message": " Code cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTMxMDY2", "url": "https://github.com/google/ground-android/pull/368#pullrequestreview-359931066", "createdAt": "2020-02-17T19:23:08Z", "commit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOToyMzowOFrOFquAnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOTozMTo0OVrOFquKRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMzODMzNQ==", "bodyText": "Wording here is unclear: True if the photo field has been updated?", "url": "https://github.com/google/ground-android/pull/368#discussion_r380338335", "createdAt": "2020-02-17T19:23:08Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -138,6 +138,9 @@\n   /** True if the observation is being added, false if editing an existing one. */\n   private boolean isNew;\n \n+  /** True if the photo field is immediately updated. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0MDAzMA==", "bodyText": "May be out of scope of this PR, but it would seem that saving the bitmap should be an asynchronous operation, whereas here it's modeled as a synchronous one.\nAlso, the Rx chain seems to be relying on side effects to do critical work, which is general not harder to debug and maintain. It might be clearer if this method would accept Bitmap instead of an Observable<Bitmap>, save and upload asynchronously, and return a Completable or Single<String> when done. Wdyt?", "url": "https://github.com/google/ground-android/pull/368#discussion_r380340030", "createdAt": "2020-02-17T19:29:11Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -267,6 +270,7 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n             })\n         .doOnNext(\n             url -> {\n+              isPhotoFieldUpdated = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0MDgwNw==", "bodyText": "Wouldn't this be equivalent to opening another app while editing the form? If so, how is this working today for non-photo fields, and why are photos different?", "url": "https://github.com/google/ground-android/pull/368#discussion_r380340807", "createdAt": "2020-02-17T19:31:49Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -316,7 +320,15 @@ public void onSaveClick() {\n \n   private void onObservationLoaded(Observation observation) {\n     this.originalObservation = observation;\n-    refreshResponseMap(observation);\n+\n+    // Photo field is updated by launching an external intent. This causes the form to reload.\n+    // When that happens, we don't want to lose the unsaved changes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzcyNjAy", "url": "https://github.com/google/ground-android/pull/368#pullrequestreview-360372602", "createdAt": "2020-02-18T14:18:18Z", "commit": {"oid": "0351e62a91c60b40b1cb3de22c3e8139de428e0d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoxODoxOFrOFrEBBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoxODoxOFrOFrEBBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY5ODg4Ng==", "bodyText": "See comment below re isPhotoFieldUpdated.\nCould you kindly collapse the chained map and doOnNext into a single function and use a more appropriate Rx method for chaining? Might look something like this:\n  private Completable handlePhotoCaptureResult(String fieldId) {\n    return cameraManager\n        .capturePhotoResult()\n        .flatMapCompletable(bitmap -> saveBitmapAndUpdateResponse(bitmap, fieldId));\n  }\n\n  private Completable saveBitmapAndUpdateResponse(\n      Bitmap bitmap, String fieldId) {\n    String file = fileUtil.saveBitmap(bitmap, fieldId + \".jpg\");\n    String destinationPath = getRemoteImagePath(file.getName());\n    String url = firestoreStorageManager.uploadMediaFromFile(file, destinationPath);\n    isPhotoFieldUpdated = true;\n    onTextChanged(form.getValue().getField(fieldId).get(), url);\n    return Complete.complete()\n  }\nI assume we'd want capturePhotoResult() to run on the UI thread, and saveBitmapAndUpdateResponse() to run in the IO thread.  I vaguely remember downstream flatMap logic runs on the same thread as the upstream subscribers (defined with subscribeOn), while switchMap does not, but I can't find a reference for it.", "url": "https://github.com/google/ground-android/pull/368#discussion_r380698886", "createdAt": "2020-02-18T14:18:18Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -267,6 +270,7 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n             })\n         .doOnNext(\n             url -> {\n+              isPhotoFieldUpdated = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0MDAzMA=="}, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aca9eb85f3c22ac7d06124e26da644d6f40cbeb8", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/aca9eb85f3c22ac7d06124e26da644d6f40cbeb8", "committedDate": "2020-02-18T15:11:53Z", "message": "Merge branch 'master' into photo-bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5de8e2241f79a1a9a3f2f537afb57232834a3b38", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/5de8e2241f79a1a9a3f2f537afb57232834a3b38", "committedDate": "2020-02-19T11:49:27Z", "message": "Fix comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eadc51fc9b28833cbfa4c6a20fef0a3c1084a7a", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/4eadc51fc9b28833cbfa4c6a20fef0a3c1084a7a", "committedDate": "2020-02-19T12:09:28Z", "message": "Refactor image intent handling logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a73930c046af043f164bdc20fcd46391fc444cbf", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a73930c046af043f164bdc20fcd46391fc444cbf", "committedDate": "2020-02-20T16:12:49Z", "message": "Merge branch 'master' into photo-bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46f3888fc340f6e67825d8b49a207677c2d167e7", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/46f3888fc340f6e67825d8b49a207677c2d167e7", "committedDate": "2020-02-20T22:50:53Z", "message": "Merge branch 'master' into photo-bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5028e0edecc0dba94a5b4fc66eef39bda249b8d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a5028e0edecc0dba94a5b4fc66eef39bda249b8d", "committedDate": "2020-02-24T19:06:29Z", "message": "Merge branch 'master' into photo-bugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjMwMjQx", "url": "https://github.com/google/ground-android/pull/368#pullrequestreview-363630241", "createdAt": "2020-02-24T19:09:30Z", "commit": {"oid": "a5028e0edecc0dba94a5b4fc66eef39bda249b8d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96427bd96490f2d34492b365ca081c9a97bfd4ac", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/96427bd96490f2d34492b365ca081c9a97bfd4ac", "committedDate": "2020-02-24T19:24:31Z", "message": "src -> srcCompat for vector drawable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjUwMjc4", "url": "https://github.com/google/ground-android/pull/368#pullrequestreview-363650278", "createdAt": "2020-02-24T19:41:33Z", "commit": {"oid": "96427bd96490f2d34492b365ca081c9a97bfd4ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1712, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}