{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNjI3ODMw", "number": 311, "title": "[Support Photos] Integrate Firebase Storage for uploading photos", "bodyText": "Towards #310\n\n\n Helper class to upload media files\n\n\n Test upload media", "createdAt": "2020-01-14T13:13:21Z", "url": "https://github.com/google/ground-android/pull/311", "merged": true, "mergeCommit": {"oid": "1a669ddae993266c514d2a41924d3cc144a3b993"}, "closed": true, "closedAt": "2020-01-17T07:38:41Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb60aRpAH2gAyMzYyNjI3ODMwOmU2MWVmYTY0MDJkY2UwZmU1ZTE4ZGY0MTU4Y2RjM2Y2ZmNhMzI5MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7JwgHgFqTM0NDQwNDE2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e61efa6402dce0fe5e18df4158cdc3f6fca32934", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e61efa6402dce0fe5e18df4158cdc3f6fca32934", "committedDate": "2020-01-16T06:46:18Z", "message": "Add firebase storage gradle dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2631bd4b672d49f211fd64a158fdcafe86a3f460", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/2631bd4b672d49f211fd64a158fdcafe86a3f460", "committedDate": "2020-01-16T06:46:18Z", "message": "Add MediaUploadManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b86c0b4e63a6fda24a87e653964c13652fe0bec", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/9b86c0b4e63a6fda24a87e653964c13652fe0bec", "committedDate": "2020-01-16T06:46:18Z", "message": "Add overloaded methods for uploading via File"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26f058b832cbb0307ca114f13b6243c88ea79b90", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/26f058b832cbb0307ca114f13b6243c88ea79b90", "committedDate": "2020-01-16T06:46:18Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cab8e1181b5ca4e708a2f0598fd9533707a79ed", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/3cab8e1181b5ca4e708a2f0598fd9533707a79ed", "committedDate": "2020-01-16T06:46:18Z", "message": "Fetch download link for storing to db after upload"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf4eca2988026ff6d4753e193e356d4b2587f897", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/cf4eca2988026ff6d4753e193e356d4b2587f897", "committedDate": "2020-01-14T13:09:20Z", "message": "Add notes"}, "afterCommit": {"oid": "b4a98a7628def2db3ef4135a17fa5211630b7b02", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/b4a98a7628def2db3ef4135a17fa5211630b7b02", "committedDate": "2020-01-16T06:48:26Z", "message": "Revert UI changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d31a44184820055fb3fe9c0110475838135dfa40", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d31a44184820055fb3fe9c0110475838135dfa40", "committedDate": "2020-01-16T06:53:17Z", "message": "Add notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12c602f6be67efc65b012e8a486ef2373d50f10e", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/12c602f6be67efc65b012e8a486ef2373d50f10e", "committedDate": "2020-01-16T06:59:58Z", "message": "Fix variable name and add comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ad69b62e674d7946e86ab88f6c231e698bd34c0", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/1ad69b62e674d7946e86ab88f6c231e698bd34c0", "committedDate": "2020-01-16T06:50:06Z", "message": "Revert test code"}, "afterCommit": {"oid": "12c602f6be67efc65b012e8a486ef2373d50f10e", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/12c602f6be67efc65b012e8a486ef2373d50f10e", "committedDate": "2020-01-16T06:59:58Z", "message": "Fix variable name and add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDY4ODky", "url": "https://github.com/google/ground-android/pull/311#pullrequestreview-344068892", "createdAt": "2020-01-16T16:58:20Z", "commit": {"oid": "12c602f6be67efc65b012e8a486ef2373d50f10e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNjo1ODoyMVrOFegsSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNzowMDowMlrOFegwAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzNzIyNQ==", "bodyText": "FYI for when you get to this, you can use our util RxTask to convert the task to a Single.", "url": "https://github.com/google/ground-android/pull/311#discussion_r367537225", "createdAt": "2020-01-16T16:58:21Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/system/MediaUploadManager.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.graphics.Bitmap;\n+import android.net.Uri;\n+import android.util.Log;\n+import com.google.firebase.storage.FirebaseStorage;\n+import com.google.firebase.storage.StorageReference;\n+import com.google.firebase.storage.UploadTask;\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.Objects;\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+\n+// TODO: Add column to Observation table for storing uploaded media urls\n+// TODO: Synced to remote db as well\n+@Singleton\n+public class MediaUploadManager {\n+\n+  private static final String TAG = MediaUploadManager.class.getName();\n+  private static final String MEDIA_ROOT_DIR = \"uploaded_media\";\n+  private final SimpleDateFormat dateFormat =\n+      new SimpleDateFormat(\"yyyyMMddHHmmss\", Locale.getDefault());\n+\n+  @Inject\n+  MediaUploadManager() {}\n+\n+  /** Returns a reference to the default Storage bucket. */\n+  private FirebaseStorage getStorage() {\n+    return FirebaseStorage.getInstance();\n+  }\n+\n+  /** Returns a reference to the root media dir. */\n+  private StorageReference getRootMediaDir() {\n+    return getStorage().getReference().child(MEDIA_ROOT_DIR);\n+  }\n+\n+  /**\n+   * Returns a reference to a object under the root media dir.\n+   *\n+   * @param fileName Name of the uploaded media\n+   */\n+  private StorageReference createReference(String fileName) {\n+    return getRootMediaDir().child(fileName + '-' + getFilenameSuffix());\n+  }\n+\n+  /** Converts current timestamp to a string to be used a suffix for uploading media. */\n+  private String getFilenameSuffix() {\n+    return dateFormat.format(new Date());\n+  }\n+\n+  /**\n+   * Upload file to Firebase Storage.\n+   */\n+  public void uploadMediaFromFile(File file, String fileName) {\n+    StorageReference reference = createReference(fileName);\n+    UploadTask task = reference.putFile(Uri.fromFile(file));\n+\n+    uploadMediaToFirebaseStorage(task, fileName);\n+    fetchDownloadUrl(reference, task);\n+  }\n+\n+  /** Upload bitmap to Firebase Storage. */\n+  public void uploadMediaFromBitmap(Bitmap bitmap, String fileName) {\n+    ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+    bitmap.compress(Bitmap.CompressFormat.JPEG, 100, baos);\n+    byte[] data = baos.toByteArray();\n+\n+    StorageReference reference = createReference(fileName);\n+    UploadTask task = reference.putBytes(data);\n+\n+    uploadMediaToFirebaseStorage(task, fileName);\n+    fetchDownloadUrl(reference, task);\n+  }\n+\n+  private void uploadMediaToFirebaseStorage(UploadTask uploadTask, String fileName) {\n+    // TODO: Create UploadState enum and use RxJava to broadcast upload state globally.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c602f6be67efc65b012e8a486ef2373d50f10e"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzODE3Nw==", "bodyText": "Since this class interacts with the remote data store, and not Android SDK specifically, perhaps it belongs in ..persistence.remote? Also, I'd name it something Firestore specific. Later we'll need to extract a generic interface so that we have an internal API to switch providers if necessary.", "url": "https://github.com/google/ground-android/pull/311#discussion_r367538177", "createdAt": "2020-01-16T17:00:02Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/system/MediaUploadManager.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12c602f6be67efc65b012e8a486ef2373d50f10e"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ca8ec8933ad300690eeca9a76254fdf9eba811f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/4ca8ec8933ad300690eeca9a76254fdf9eba811f", "committedDate": "2020-01-16T17:08:55Z", "message": "Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "253cbfe581dca0b38750269065e5d6b99085ef9d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/253cbfe581dca0b38750269065e5d6b99085ef9d", "committedDate": "2020-01-16T17:11:20Z", "message": "Move to persistence.remote package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b8f18b4c33a4c01629bdea3e27b9680b8674bed", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/6b8f18b4c33a4c01629bdea3e27b9680b8674bed", "committedDate": "2020-01-17T05:42:50Z", "message": "Merge branch 'master' into integrate-photos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a402b007277fd502474e1b28d4c5bc88b97bbe0c", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/a402b007277fd502474e1b28d4c5bc88b97bbe0c", "committedDate": "2020-01-17T07:13:57Z", "message": "Merge branch 'master' into integrate-photos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55d9756933a2f3bfff21bec2512efe6f4dc03121", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/55d9756933a2f3bfff21bec2512efe6f4dc03121", "committedDate": "2020-01-17T07:23:18Z", "message": "Merge branch 'master' into integrate-photos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NDA0MTYy", "url": "https://github.com/google/ground-android/pull/311#pullrequestreview-344404162", "createdAt": "2020-01-17T07:38:35Z", "commit": {"oid": "6b8f18b4c33a4c01629bdea3e27b9680b8674bed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1673, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}