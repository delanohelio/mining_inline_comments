{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MjA0MzM2", "number": 414, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToxODowMFrODrsc3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToyMTozN1rODrskAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTQzNjQ0OnYy", "diffSide": "RIGHT", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/RemoteStorageManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToxODowMFrOF8MAPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToxODowMFrOF8MAPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1NTU0OQ==", "bodyText": "Why wrapping with Event? It's used as a \"Wrapper for events passed through streams that should be handled at most once.\". It's primarily used to prevent UIs from showing the same message more than ones. In this case, it seems you'd want to just stream the UploadProgress with Backpressure.LATEST.", "url": "https://github.com/google/ground-android/pull/414#discussion_r398655549", "createdAt": "2020-03-26T15:18:00Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/RemoteStorageManager.java", "diffHunk": "@@ -31,5 +32,5 @@\n   Task<Uri> getDownloadUrl(String remoteDestinationPath);\n \n   /** Uploads file to a remote path. */\n-  Completable uploadMediaFromFile(File file, String remoteDestinationPath);\n+  Flowable<Event<UploadProgress>> uploadMediaFromFile(File file, String remoteDestinationPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTQ0NTUzOnYy", "diffSide": "RIGHT", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreStorageManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToxOTo0OFrOF8MF6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToxOTo0OFrOF8MF6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1NzAwMA==", "bodyText": "Instead of calling new directly, consider adding \"static constructor\" methods like UploadProgress.paused() and UploadProgress.inProgress(byteCount, bytesTransferred).", "url": "https://github.com/google/ground-android/pull/414#discussion_r398657000", "createdAt": "2020-03-26T15:19:48Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreStorageManager.java", "diffHunk": "@@ -65,27 +68,35 @@ private StorageReference createReference(String path) {\n     return createReference(remoteDestinationPath).getDownloadUrl();\n   }\n \n-  /** Upload file to Firebase Storage. */\n   @Override\n-  public Completable uploadMediaFromFile(File file, String remoteDestinationPath) {\n-    return Completable.create(\n+  public Flowable<Event<UploadProgress>> uploadMediaFromFile(\n+      File file, String remoteDestinationPath) {\n+    return Flowable.create(\n         emitter ->\n             createReference(remoteDestinationPath)\n                 .putFile(Uri.fromFile(file))\n                 .addOnCompleteListener(uploadTask -> emitter.onComplete())\n-                .addOnFailureListener(emitter::onError)\n+                .addOnPausedListener(\n+                    taskSnapshot -> {\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.PAUSED)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTQ0ODI4OnYy", "diffSide": "RIGHT", "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreStorageManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToyMDoyMlrOF8MHqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToyMDoyMlrOF8MHqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1NzQ0OQ==", "bodyText": "Only use buffer if it's important that downstream subscribers catch every single value. In this case, only the latest value is relevant, so we'd use LATEST.", "url": "https://github.com/google/ground-android/pull/414#discussion_r398657449", "createdAt": "2020-03-26T15:20:22Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreStorageManager.java", "diffHunk": "@@ -65,27 +68,35 @@ private StorageReference createReference(String path) {\n     return createReference(remoteDestinationPath).getDownloadUrl();\n   }\n \n-  /** Upload file to Firebase Storage. */\n   @Override\n-  public Completable uploadMediaFromFile(File file, String remoteDestinationPath) {\n-    return Completable.create(\n+  public Flowable<Event<UploadProgress>> uploadMediaFromFile(\n+      File file, String remoteDestinationPath) {\n+    return Flowable.create(\n         emitter ->\n             createReference(remoteDestinationPath)\n                 .putFile(Uri.fromFile(file))\n                 .addOnCompleteListener(uploadTask -> emitter.onComplete())\n-                .addOnFailureListener(emitter::onError)\n+                .addOnPausedListener(\n+                    taskSnapshot -> {\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.PAUSED)));\n+                    })\n+                .addOnFailureListener(\n+                    throwable -> {\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.FAILED)));\n+                      emitter.onError(throwable);\n+                    })\n                 .addOnSuccessListener(\n                     taskSnapshot -> {\n-                      // TODO: taskSnapshot contains metadata that can be displayed after uploading\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.COMPLETED)));\n                     })\n                 .addOnProgressListener(\n-                    taskSnapshot -> {\n-                      // TODO: Display upload status in app or notification\n-                      double completed =\n-                          100.0\n-                              * taskSnapshot.getBytesTransferred()\n-                              / taskSnapshot.getTotalByteCount();\n-                      Timber.d(\"Uploading in progress: %s %f\", remoteDestinationPath, completed);\n-                    }));\n+                    taskSnapshot ->\n+                        emitter.onNext(\n+                            Event.create(\n+                                new UploadProgress(\n+                                    UploadState.IN_PROGRESS,\n+                                    (int) taskSnapshot.getTotalByteCount(),\n+                                    (int) taskSnapshot.getBytesTransferred())))),\n+        BackpressureStrategy.BUFFER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTQ1NDcyOnYy", "diffSide": "RIGHT", "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorker.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToyMTozN1rOF8MLpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQyMDoyNToxN1rOF9U1-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA==", "bodyText": "Are we showing a notification for each photo being uploaded? Ideally we'd have a single status bar for sync progress.", "url": "https://github.com/google/ground-android/pull/414#discussion_r398658470", "createdAt": "2020-03-26T15:21:37Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorker.java", "diffHunk": "@@ -66,7 +72,8 @@ public Result doWork() {\n       try {\n         remoteStorageManager\n             .uploadMediaFromFile(new File(localSourcePath), remoteDestinationPath)\n-            .blockingAwait();\n+            .blockingForEach(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY4MzEwMg==", "bodyText": "For now, yes. I plan to add notifications to all workers, then move on to refactor PhotoSyncWorker (merge with DataSyncWorker and store mutations in db)", "url": "https://github.com/google/ground-android/pull/414#discussion_r398683102", "createdAt": "2020-03-26T15:52:12Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorker.java", "diffHunk": "@@ -66,7 +72,8 @@ public Result doWork() {\n       try {\n         remoteStorageManager\n             .uploadMediaFromFile(new File(localSourcePath), remoteDestinationPath)\n-            .blockingAwait();\n+            .blockingForEach(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA=="}, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM3NTc4Ng==", "bodyText": "I may be wrong, but isn't this fundamentally different than showing a single always-on service UI notification? Won't we be doing a lot of work that will then need to be deleted?", "url": "https://github.com/google/ground-android/pull/414#discussion_r399375786", "createdAt": "2020-03-27T16:08:16Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorker.java", "diffHunk": "@@ -66,7 +72,8 @@ public Result doWork() {\n       try {\n         remoteStorageManager\n             .uploadMediaFromFile(new File(localSourcePath), remoteDestinationPath)\n-            .blockingAwait();\n+            .blockingForEach(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA=="}, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ0MzU0OA==", "bodyText": "Nope, it's just a matter of changing boolean values to keep it sticky and then reuse the same notification for displaying updates. My idea was to have many eyes look at the code without making too many changes at once. But if you think it's better to do all at once, I can give it a try.", "url": "https://github.com/google/ground-android/pull/414#discussion_r399443548", "createdAt": "2020-03-27T17:55:29Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorker.java", "diffHunk": "@@ -66,7 +72,8 @@ public Result doWork() {\n       try {\n         remoteStorageManager\n             .uploadMediaFromFile(new File(localSourcePath), remoteDestinationPath)\n-            .blockingAwait();\n+            .blockingForEach(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA=="}, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg0ODk1Mw==", "bodyText": "If it's an incremental change then SGTM!", "url": "https://github.com/google/ground-android/pull/414#discussion_r399848953", "createdAt": "2020-03-29T20:25:17Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorker.java", "diffHunk": "@@ -66,7 +72,8 @@ public Result doWork() {\n       try {\n         remoteStorageManager\n             .uploadMediaFromFile(new File(localSourcePath), remoteDestinationPath)\n-            .blockingAwait();\n+            .blockingForEach(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA=="}, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2661, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}