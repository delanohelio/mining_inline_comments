{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MjM5MTI1", "number": 326, "title": "[Code health] Tidy up fluent Firestore base classes", "bodyText": "Fixes #321, work towards #323.", "createdAt": "2020-01-17T17:12:27Z", "url": "https://github.com/google/ground-android/pull/326", "merged": true, "mergeCommit": {"oid": "430f25bea1387c5304ffa4c6b0a29e461a733d68"}, "closed": true, "closedAt": "2020-01-28T06:36:40Z", "author": {"login": "gino-m"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7R_fqAH2gAyMzY0MjM5MTI1OmI1NGQ2MTg3Yzg1MjdiMDQ3MGMxOWYzODYxOGMxMjc3ZWQyOGFiMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-rdmcgFqTM0OTE1MzQwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b54d6187c8527b0470c19f38618c1277ed28ab26", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/b54d6187c8527b0470c19f38618c1277ed28ab26", "committedDate": "2020-01-17T17:14:12Z", "message": "Move fluent Firestore classes into their own package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19bfbc8faa367ecb39e250ba7395d21b474ea816", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/19bfbc8faa367ecb39e250ba7395d21b474ea816", "committedDate": "2020-01-17T17:14:15Z", "message": "Move fluent Firestore classes to lop level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0336e2f7e7d20e1688a14de5c2e59815e1f99e1", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/e0336e2f7e7d20e1688a14de5c2e59815e1f99e1", "committedDate": "2020-01-17T17:14:18Z", "message": "Refactore requireActiveNetwork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb4b8625d72969cc63b3ab793df31aa35ef8985e", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/cb4b8625d72969cc63b3ab793df31aa35ef8985e", "committedDate": "2020-01-17T17:14:20Z", "message": "All fluent base classes are abstract; remove prefix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a58fba89e00bcf6e8f75c82de89471d1a42b61dc", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/a58fba89e00bcf6e8f75c82de89471d1a42b61dc", "committedDate": "2020-01-17T17:11:42Z", "message": "All fluent base classes are abstract; remove prefix"}, "afterCommit": {"oid": "cb4b8625d72969cc63b3ab793df31aa35ef8985e", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/cb4b8625d72969cc63b3ab793df31aa35ef8985e", "committedDate": "2020-01-17T17:14:20Z", "message": "All fluent base classes are abstract; remove prefix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTI3MDM0", "url": "https://github.com/google/ground-android/pull/326#pullrequestreview-344927034", "createdAt": "2020-01-18T05:43:53Z", "commit": {"oid": "cb4b8625d72969cc63b3ab793df31aa35ef8985e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNTo0Mzo1NFrOFfJpjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwNTo0ODo1MlrOFfJqXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODI3MA==", "bodyText": "Why are we providing the context here as a parameter when there's already a method isNetworkAvailable() for the same purpose?", "url": "https://github.com/google/ground-android/pull/326#discussion_r368208270", "createdAt": "2020-01-18T05:43:54Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/system/NetworkManager.java", "diffHunk": "@@ -41,6 +44,14 @@ public static boolean isNetworkAvailable(Context context) {\n     return networkInfo != null && networkInfo.isConnected();\n   }\n \n+  /**\n+   * Returns a Completable that completes immediately on subscribe if network is available, or fails\n+   * in error if not.\n+   */\n+  public static Completable requireActiveNetwork(Context context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb4b8625d72969cc63b3ab793df31aa35ef8985e"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODMwOA==", "bodyText": "2020", "url": "https://github.com/google/ground-android/pull/326#discussion_r368208308", "createdAt": "2020-01-18T05:44:55Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/fluent/FluentFirestore.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2018 Google LLC", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb4b8625d72969cc63b3ab793df31aa35ef8985e"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODQxNg==", "bodyText": "Can we instead call this method reference()?", "url": "https://github.com/google/ground-android/pull/326#discussion_r368208416", "createdAt": "2020-01-18T05:47:17Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/fluent/FluentDocumentReference.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.fluent;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.google.firebase.firestore.DocumentReference;\n+import com.google.firebase.firestore.SetOptions;\n+import com.google.firebase.firestore.WriteBatch;\n+\n+public class FluentDocumentReference {\n+  protected final DocumentReference ref;\n+\n+  protected FluentDocumentReference(DocumentReference ref) {\n+    this.ref = ref;\n+  }\n+\n+  /**\n+   * Adds a request to the specified batch to merge the provided key-value pairs into the remote\n+   * database. If the document does not yet exist, one is created on commit.\n+   */\n+  public void merge(ImmutableMap<String, Object> values, WriteBatch batch) {\n+    batch.set(ref, values, SetOptions.merge());\n+  }\n+\n+  public DocumentReference ref() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb4b8625d72969cc63b3ab793df31aa35ef8985e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIwODQ3Ng==", "bodyText": "Can we call this method reference() instead?", "url": "https://github.com/google/ground-android/pull/326#discussion_r368208476", "createdAt": "2020-01-18T05:48:52Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/fluent/FluentCollectionReference.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.remote.firestore.fluent;\n+\n+import com.google.android.gnd.system.NetworkManager;\n+import com.google.firebase.firestore.CollectionReference;\n+import com.google.firebase.firestore.DocumentSnapshot;\n+import com.google.firebase.firestore.Query;\n+import durdinapps.rxfirebase2.RxFirestore;\n+import io.reactivex.Completable;\n+import io.reactivex.Single;\n+import java.util.List;\n+import java8.util.function.Function;\n+\n+public abstract class FluentCollectionReference {\n+  protected final CollectionReference ref;\n+\n+  protected FluentCollectionReference(CollectionReference ref) {\n+    this.ref = ref;\n+  }\n+\n+  /**\n+   * Returns a Completable that completes immediately on subscribe if network is available, or fails\n+   * in error if not.\n+   */\n+  private Completable requireActiveNetwork() {\n+    return NetworkManager.requireActiveNetwork(ref.getFirestore().getApp().getApplicationContext());\n+  }\n+\n+  /**\n+   * Runs the specified query, returning a Single containing a List of values created by applying\n+   * the mappingFunction to all results. Fails immediately with an error if an active network is not\n+   * available.\n+   */\n+  protected <T> Single<List<T>> runQuery(\n+      Query query, Function<DocumentSnapshot, T> mappingFunction) {\n+    return requireActiveNetwork()\n+        .andThen(FluentFirestore.toSingleList(RxFirestore.getCollection(query), mappingFunction));\n+  }\n+\n+  public CollectionReference ref() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb4b8625d72969cc63b3ab793df31aa35ef8985e"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b7ccf6715a809a99460e0788570bd2ed3455982", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/6b7ccf6715a809a99460e0788570bd2ed3455982", "committedDate": "2020-01-27T17:55:27Z", "message": "Merge branch 'master' into fluent-fs-refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c038626db8a64127e77cb9292ee6bbe39a60cb3", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/4c038626db8a64127e77cb9292ee6bbe39a60cb3", "committedDate": "2020-01-27T22:10:24Z", "message": "Merge branch 'master' into fluent-fs-refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "458347df751d3cd6db3b5508ba664f77cb99ecd6", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/458347df751d3cd6db3b5508ba664f77cb99ecd6", "committedDate": "2020-01-28T00:56:08Z", "message": "Rename collection ref accessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1648efa15a061ba980df04f8f11bbad4c14faace", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/1648efa15a061ba980df04f8f11bbad4c14faace", "committedDate": "2020-01-28T00:57:22Z", "message": "Rename document ref accessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d72d592504ccb20bdfd2508868b050159a42656", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/9d72d592504ccb20bdfd2508868b050159a42656", "committedDate": "2020-01-28T00:58:07Z", "message": "Rename ref field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26e56e8c25026a224eaeff73b4d17b1426b6f688", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/26e56e8c25026a224eaeff73b4d17b1426b6f688", "committedDate": "2020-01-28T00:58:32Z", "message": "Rename ref field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39bf958b41e12993d6597965eb1de33ea341ad6a", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/39bf958b41e12993d6597965eb1de33ea341ad6a", "committedDate": "2020-01-28T01:01:40Z", "message": "Access ref via accessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "648f74f5a44dc81475fbe4055a3feb14450376b1", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/648f74f5a44dc81475fbe4055a3feb14450376b1", "committedDate": "2020-01-28T01:02:56Z", "message": "Fix copyright year"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e03605a1cb2b8b2844efe17a5cdb3fafd7a3ec1", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/8e03605a1cb2b8b2844efe17a5cdb3fafd7a3ec1", "committedDate": "2020-01-28T01:05:07Z", "message": "Make isNetworkAvailable private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f52c195f295ee8dbec9ee877d4faf6d03a24725", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/8f52c195f295ee8dbec9ee877d4faf6d03a24725", "committedDate": "2020-01-28T01:10:23Z", "message": "Access Firestore instance via accessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a24c910e7131652c505f643d1758bac3746677c8", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/a24c910e7131652c505f643d1758bac3746677c8", "committedDate": "2020-01-28T01:12:44Z", "message": "Rename 'fluent' package to 'base'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTUzNDAw", "url": "https://github.com/google/ground-android/pull/326#pullrequestreview-349153400", "createdAt": "2020-01-28T06:36:29Z", "commit": {"oid": "a24c910e7131652c505f643d1758bac3746677c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1677, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}