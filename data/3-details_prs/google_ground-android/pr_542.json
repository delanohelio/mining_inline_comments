{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MDA1MzEz", "number": 542, "title": "List Human Readable Area Names in Offline Area List", "bodyText": "This PR uses reverse Geocoding to give downloaded offline areas human readable names.\nArea names are determined by walking up (from bottom up) the addressing hierarchy defined by the Extensible Address Language--according to the docs, this is the schema that Android's Address implementation roughly follows.\nExplicitly, we try to get a name for the area using the following address components in the following order--if the prior component is null, we move on to the next item in the list:\n\nFeature name (e.g. Golden Gate Bridge)\nLocality name\nSubadministration name\nAdministration name\nCountry name\n\n\nCloses #536.", "createdAt": "2020-07-14T17:08:30Z", "url": "https://github.com/google/ground-android/pull/542", "merged": true, "mergeCommit": {"oid": "a448e05e7b5609969799b2942e0b38b6b4fb743c"}, "closed": true, "closedAt": "2020-07-29T18:28:38Z", "author": {"login": "scolsen"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc03ooPAH2gAyNDQ5MDA1MzEzOmRhYmFkNjA2MTc2OTZkODM3ZmI2Njk2ZjI0NDkzNmUxYWZjNDYzZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5vVQJgFqTQ1Nzc4MTY5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dabad60617696d837fb6696f244936e1afc463df", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/dabad60617696d837fb6696f244936e1afc463df", "committedDate": "2020-07-14T15:19:18Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd0d4a7dcc59a52922b7b766e8e375e7548972cc", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/cd0d4a7dcc59a52922b7b766e8e375e7548972cc", "committedDate": "2020-07-14T16:49:55Z", "message": "Remove unused method in OfflineAreasViewModel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45e91bb8751a90ea5d2198abb130045c36996946", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/45e91bb8751a90ea5d2198abb130045c36996946", "committedDate": "2020-07-14T16:54:28Z", "message": "Display locality/country names in area list\n\nPreviously, the area list listed the auto-generated ids for each area on the user's device--which isn't very helpful. Instead, we now use reverse Geocoding to get a human readable descriptor for an area based on the lat/lng of its center.\n\nWe use a bottom-up approach, as not all addresses have precise locale detail. If the area centers on a known Feature, we render the feature name, otherwise we fallback to the locality, otherwise, the subadministrative area, otherwise the administrative area, and finally, if all the other granularities are unknown, the country name. If we can't find any locality/address for the area, we list it as \"unknown area\". This hierarchy follows that of Extensible Address Language spec, in reverse order (a Country subsumes and admin area, an admin area a subadmin area, and so forth)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97e50a7be5ebad9663806485736b38b5296303e1", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/97e50a7be5ebad9663806485736b38b5296303e1", "committedDate": "2020-07-14T16:59:19Z", "message": "Throw a custom Exception when Area Addresses aren't found\n\nRather than throw a raw exception, using a custom class makes the type of exception explicit (and makes PMD happy)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b6c4f309345107101af3eff4b30aac27e44ebba", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/7b6c4f309345107101af3eff4b30aac27e44ebba", "committedDate": "2020-07-14T17:12:20Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into geocoding"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MzU4Nzg0", "url": "https://github.com/google/ground-android/pull/542#pullrequestreview-448358784", "createdAt": "2020-07-14T18:27:06Z", "commit": {"oid": "7b6c4f309345107101af3eff4b30aac27e44ebba"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxODoyNzowNlrOGxgBBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxODoyODo1NVrOGxgFGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1Nzk1OQ==", "bodyText": "Can you please move this string creation to catch block? Otherwise, it seems wasteful to do this init each time.", "url": "https://github.com/google/ground-android/pull/542#discussion_r454557959", "createdAt": "2020-07-14T18:27:06Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -75,9 +90,42 @@ public void onClick(View v) {\n   }\n \n   @Override\n-  public void onBindViewHolder(ViewHolder viewHolder, int position) {\n-    viewHolder.binding.offlineAreaName.setText(offlineAreas.get(position).getId());\n-    viewHolder.position = position;\n+  public void onBindViewHolder(@NonNull ViewHolder viewHolder, int position) {\n+    String areaName =\n+        viewHolder.binding.getRoot().getContext().getString(R.string.offline_areas_unknown_area);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b6c4f309345107101af3eff4b30aac27e44ebba"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1OTAwMQ==", "bodyText": "Can we please specify exactly which exception we are looking for? Is this catching errors other than AddressNotFoundException too?", "url": "https://github.com/google/ground-android/pull/542#discussion_r454559001", "createdAt": "2020-07-14T18:28:55Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -75,9 +90,42 @@ public void onClick(View v) {\n   }\n \n   @Override\n-  public void onBindViewHolder(ViewHolder viewHolder, int position) {\n-    viewHolder.binding.offlineAreaName.setText(offlineAreas.get(position).getId());\n-    viewHolder.position = position;\n+  public void onBindViewHolder(@NonNull ViewHolder viewHolder, int position) {\n+    String areaName =\n+        viewHolder.binding.getRoot().getContext().getString(R.string.offline_areas_unknown_area);\n+\n+    OfflineArea area = offlineAreas.get(position);\n+    String id = area.getId();\n+    LatLng center = area.getBounds().getCenter();\n+\n+    try {\n+      List<Address> addresses =\n+          viewHolder.geocoder.getFromLocation(center.latitude, center.longitude, 1);\n+\n+      if (addresses.isEmpty()) {\n+        throw new AddressNotFoundException(\"No address found for area.\");\n+      }\n+\n+      Address address = addresses.get(0);\n+\n+      areaName =\n+          Optional.ofNullable(address.getFeatureName())\n+              .or(() -> Optional.ofNullable(address.getLocality()))\n+              .or(() -> Optional.ofNullable(address.getSubAdminArea()))\n+              .or(() -> Optional.ofNullable(address.getAdminArea()))\n+              .or(() -> Optional.ofNullable(address.getCountryName()))\n+              .orElse(areaName);\n+    } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b6c4f309345107101af3eff4b30aac27e44ebba"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDM0NjY0", "url": "https://github.com/google/ground-android/pull/542#pullrequestreview-448434664", "createdAt": "2020-07-14T20:19:29Z", "commit": {"oid": "7b6c4f309345107101af3eff4b30aac27e44ebba"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDoxOToyOVrOGxjxDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMDoyNzo1N1rOGxkDww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYxOTQwNg==", "bodyText": "Following our current architecture, remote and system services are all hidden either behind a Repository or a Manager, respectively. Also,\nListAdapter is a purely UI component, so it would be best to abstract services like this one so they can be mocked or replaced without needing to mock the lower level API.\nHow about creating a GeocodingService that exposes only the functionality needed to implement this feature?", "url": "https://github.com/google/ground-android/pull/542#discussion_r454619406", "createdAt": "2020-07-14T20:19:29Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -37,6 +50,7 @@\n     public int position;\n     private ImmutableList<OfflineArea> areas;\n     private final Navigator navigator;\n+    private final Geocoder geocoder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b6c4f309345107101af3eff4b30aac27e44ebba"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDYyNDE5NQ==", "bodyText": "In particular, this is business logic that would be best defined in a more tightly scoped class imo.", "url": "https://github.com/google/ground-android/pull/542#discussion_r454624195", "createdAt": "2020-07-14T20:27:57Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -75,9 +90,42 @@ public void onClick(View v) {\n   }\n \n   @Override\n-  public void onBindViewHolder(ViewHolder viewHolder, int position) {\n-    viewHolder.binding.offlineAreaName.setText(offlineAreas.get(position).getId());\n-    viewHolder.position = position;\n+  public void onBindViewHolder(@NonNull ViewHolder viewHolder, int position) {\n+    String areaName =\n+        viewHolder.binding.getRoot().getContext().getString(R.string.offline_areas_unknown_area);\n+\n+    OfflineArea area = offlineAreas.get(position);\n+    String id = area.getId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b6c4f309345107101af3eff4b30aac27e44ebba"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12c8afbf7c7862b2f17e4875bac9cfb953009a11", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/12c8afbf7c7862b2f17e4875bac9cfb953009a11", "committedDate": "2020-07-23T15:54:27Z", "message": "Merge branch 'master' into geocoding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81c0b3f03cfad12f8a23a0d002c5e59738df7ef8", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/81c0b3f03cfad12f8a23a0d002c5e59738df7ef8", "committedDate": "2020-07-23T15:58:03Z", "message": "Move geocoding functionality into its own class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "725046904d4b4ab0f5ff01d61738269c62855489", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/725046904d4b4ab0f5ff01d61738269c62855489", "committedDate": "2020-07-23T15:58:54Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into geocoding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cef1feaf66f7d8e5b5bf6d26c045f1ca88196398", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/cef1feaf66f7d8e5b5bf6d26c045f1ca88196398", "committedDate": "2020-07-23T15:59:23Z", "message": "Merge branch 'geocoding' of https://github.com/scolsen/ground-android into geocoding"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTUzMDA4", "url": "https://github.com/google/ground-android/pull/542#pullrequestreview-454553008", "createdAt": "2020-07-23T23:07:53Z", "commit": {"oid": "cef1feaf66f7d8e5b5bf6d26c045f1ca88196398"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMzowNzo1M1rOG2ehNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMzowODo1N1rOG2eiWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NjMxMA==", "bodyText": "This seems like logic that would normally be called from the ViewModel. Also, it would be preferable to inject the GeocodingManager (in the VM) to make it easier to swap out in tests. Would this be possible?", "url": "https://github.com/google/ground-android/pull/542#discussion_r459776310", "createdAt": "2020-07-23T23:07:53Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreaListAdapter.java", "diffHunk": "@@ -60,7 +47,7 @@ public AddressNotFoundException(String message) {\n       this.binding = binding;\n       this.areas = areas;\n       this.navigator = navigator;\n-      this.geocoder = new Geocoder(binding.getRoot().getContext());\n+      this.geocoder = new GeocodingManager(binding.getRoot().getContext());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cef1feaf66f7d8e5b5bf6d26c045f1ca88196398"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NjYwMA==", "bodyText": "s/abstracts over/abstracts/", "url": "https://github.com/google/ground-android/pull/542#discussion_r459776600", "createdAt": "2020-07-23T23:08:57Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/system/GeocodingManager.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.system;\n+\n+import android.content.Context;\n+import android.location.Address;\n+import android.location.Geocoder;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gnd.R;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import java.io.IOException;\n+import java.util.List;\n+import java8.util.Optional;\n+import timber.log.Timber;\n+\n+/**\n+ * GeocodingManger abstracts over native geocoding facilities, and provides convenience methods for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cef1feaf66f7d8e5b5bf6d26c045f1ca88196398"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce69f7c87b4e09e157c384fc21d675a4fe150ae4", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/ce69f7c87b4e09e157c384fc21d675a4fe150ae4", "committedDate": "2020-07-28T14:28:28Z", "message": "Merge branch 'master' into geocoding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "656adc801372efba3a3c01c39ff66efc660feec8", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/656adc801372efba3a3c01c39ff66efc660feec8", "committedDate": "2020-07-28T19:21:19Z", "message": "Comment editorial"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77aaed7c5c8cbd1918f4b2a6ed881765a9494438", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/77aaed7c5c8cbd1918f4b2a6ed881765a9494438", "committedDate": "2020-07-28T20:58:14Z", "message": "Move geocoding calls into the area selector viewmodel\n\nCalling the GeoCodingManager here, rather than in the list adapter, is better aligned with our architecture. We now pass an immutablemap of human readable names + areas to the list adapter from the view model."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3379d8971a8436cd8bb2700c936dc192f2612a6d", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/3379d8971a8436cd8bb2700c936dc192f2612a6d", "committedDate": "2020-07-28T20:58:48Z", "message": "Merge branch 'geocoding' of https://github.com/scolsen/ground-android into geocoding"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDI2ODg5", "url": "https://github.com/google/ground-android/pull/542#pullrequestreview-457026889", "createdAt": "2020-07-28T21:29:21Z", "commit": {"oid": "3379d8971a8436cd8bb2700c936dc192f2612a6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMToyOToyMVrOG4flYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMToyOToyMVrOG4flYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg5MDkxNQ==", "bodyText": "Instead of creating an instance here, how about converting GeocodingManager into an injectable dependency?", "url": "https://github.com/google/ground-android/pull/542#discussion_r461890915", "createdAt": "2020-07-28T21:29:21Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/OfflineAreasViewModel.java", "diffHunk": "@@ -16,39 +16,57 @@\n \n package com.google.android.gnd.ui.offlinearea;\n \n+import static java8.util.stream.StreamSupport.stream;\n+\n+import android.content.Context;\n import androidx.lifecycle.LiveData;\n import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gnd.model.basemap.OfflineArea;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n+import com.google.android.gnd.system.GeocodingManager;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n import com.google.android.gnd.ui.common.Navigator;\n-import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableMap;\n+import dagger.hilt.android.qualifiers.ApplicationContext;\n+import java8.util.stream.Collectors;\n import javax.inject.Inject;\n \n /**\n  * View model for the offline area manager fragment. Handles the current list of downloaded areas.\n  */\n public class OfflineAreasViewModel extends AbstractViewModel {\n \n-  private LiveData<ImmutableList<OfflineArea>> offlineAreas;\n+  private LiveData<ImmutableMap<String, OfflineArea>> offlineAreas;\n   private final Navigator navigator;\n+  private final GeocodingManager geocoder;\n \n   @Inject\n-  OfflineAreasViewModel(Navigator navigator, OfflineAreaRepository offlineAreaRepository) {\n+  OfflineAreasViewModel(\n+      Navigator navigator,\n+      OfflineAreaRepository offlineAreaRepository,\n+      @ApplicationContext Context context) {\n     this.navigator = navigator;\n+    this.geocoder = new GeocodingManager(context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3379d8971a8436cd8bb2700c936dc192f2612a6d"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56b49e5c83e6587ba053ac894754f6d0d036c607", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/56b49e5c83e6587ba053ac894754f6d0d036c607", "committedDate": "2020-07-29T14:06:47Z", "message": "Make GeocodingManager injectable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6db2bc823f1422144abca19ce84d6aee7cb93984", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/6db2bc823f1422144abca19ce84d6aee7cb93984", "committedDate": "2020-07-29T14:07:19Z", "message": "Style compliance fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjExMjAz", "url": "https://github.com/google/ground-android/pull/542#pullrequestreview-457611203", "createdAt": "2020-07-29T15:00:19Z", "commit": {"oid": "6db2bc823f1422144abca19ce84d6aee7cb93984"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NzgxNjk2", "url": "https://github.com/google/ground-android/pull/542#pullrequestreview-457781696", "createdAt": "2020-07-29T18:28:31Z", "commit": {"oid": "6db2bc823f1422144abca19ce84d6aee7cb93984"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1593, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}