{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MjA0MzM2", "number": 414, "title": "[Notifications] Show notifications when uploading photos", "bodyText": "Towards #110\nFor testing: Use FROGS project or create one having a photo field", "createdAt": "2020-03-26T14:27:10Z", "url": "https://github.com/google/ground-android/pull/414", "merged": true, "mergeCommit": {"oid": "e6e8f740b18f8eff24724b8aa43e060edad5eff6"}, "closed": true, "closedAt": "2020-03-29T20:35:30Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRZJB2gH2gAyMzk0MjA0MzM2OmZjYjVlOTgwNDlmMmFiYmU4YWY4NTQ5MWVkNDc1NzFlZjA0ZWY0NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSf5LnAFqTM4MzQ1MTY4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fcb5e98049f2abbe8af85491ed47571ef04ef476", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fcb5e98049f2abbe8af85491ed47571ef04ef476", "committedDate": "2020-03-26T10:00:17Z", "message": "Add NotificationManager class\n\n - Test implementation by creating dummy progress notifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c93146b950732ddc461d767efbbd433b7e41f909", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/c93146b950732ddc461d767efbbd433b7e41f909", "committedDate": "2020-03-26T13:38:26Z", "message": "Add notifications for photo sync operation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cdf1b5d4b74dce9b9c90ecd2aeda26f923d1eac", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/6cdf1b5d4b74dce9b9c90ecd2aeda26f923d1eac", "committedDate": "2020-03-26T13:53:10Z", "message": "Store upload progress in data model and pass them forward"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec4661286f53929d332a96648fe36b67c8f5a14d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/ec4661286f53929d332a96648fe36b67c8f5a14d", "committedDate": "2020-03-26T14:13:34Z", "message": "Create model class for storing upload progress info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c729e740ac18a7b6a1a6743175d34320f0df7247", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/c729e740ac18a7b6a1a6743175d34320f0df7247", "committedDate": "2020-03-26T14:15:35Z", "message": "Return flowable from RemoteStorageManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b96ac20b53a710f2351aae7d188ab9b1fd95699", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/0b96ac20b53a710f2351aae7d188ab9b1fd95699", "committedDate": "2020-03-26T14:15:55Z", "message": "Send notifications from worker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c051dca6ee20f9cb70d3f79e65ae89082244722d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/c051dca6ee20f9cb70d3f79e65ae89082244722d", "committedDate": "2020-03-26T14:17:08Z", "message": "Add licenses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/2db0b8a15ec0810679c023dbd656c9783221633f", "committedDate": "2020-03-26T14:22:56Z", "message": "Rename variable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMTE0NzM1", "url": "https://github.com/google/ground-android/pull/414#pullrequestreview-382114735", "createdAt": "2020-03-26T15:18:00Z", "commit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToxODowMFrOF8MAPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToyMTozN1rOF8MLpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1NTU0OQ==", "bodyText": "Why wrapping with Event? It's used as a \"Wrapper for events passed through streams that should be handled at most once.\". It's primarily used to prevent UIs from showing the same message more than ones. In this case, it seems you'd want to just stream the UploadProgress with Backpressure.LATEST.", "url": "https://github.com/google/ground-android/pull/414#discussion_r398655549", "createdAt": "2020-03-26T15:18:00Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/RemoteStorageManager.java", "diffHunk": "@@ -31,5 +32,5 @@\n   Task<Uri> getDownloadUrl(String remoteDestinationPath);\n \n   /** Uploads file to a remote path. */\n-  Completable uploadMediaFromFile(File file, String remoteDestinationPath);\n+  Flowable<Event<UploadProgress>> uploadMediaFromFile(File file, String remoteDestinationPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1NzAwMA==", "bodyText": "Instead of calling new directly, consider adding \"static constructor\" methods like UploadProgress.paused() and UploadProgress.inProgress(byteCount, bytesTransferred).", "url": "https://github.com/google/ground-android/pull/414#discussion_r398657000", "createdAt": "2020-03-26T15:19:48Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreStorageManager.java", "diffHunk": "@@ -65,27 +68,35 @@ private StorageReference createReference(String path) {\n     return createReference(remoteDestinationPath).getDownloadUrl();\n   }\n \n-  /** Upload file to Firebase Storage. */\n   @Override\n-  public Completable uploadMediaFromFile(File file, String remoteDestinationPath) {\n-    return Completable.create(\n+  public Flowable<Event<UploadProgress>> uploadMediaFromFile(\n+      File file, String remoteDestinationPath) {\n+    return Flowable.create(\n         emitter ->\n             createReference(remoteDestinationPath)\n                 .putFile(Uri.fromFile(file))\n                 .addOnCompleteListener(uploadTask -> emitter.onComplete())\n-                .addOnFailureListener(emitter::onError)\n+                .addOnPausedListener(\n+                    taskSnapshot -> {\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.PAUSED)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1NzQ0OQ==", "bodyText": "Only use buffer if it's important that downstream subscribers catch every single value. In this case, only the latest value is relevant, so we'd use LATEST.", "url": "https://github.com/google/ground-android/pull/414#discussion_r398657449", "createdAt": "2020-03-26T15:20:22Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/remote/firestore/FirestoreStorageManager.java", "diffHunk": "@@ -65,27 +68,35 @@ private StorageReference createReference(String path) {\n     return createReference(remoteDestinationPath).getDownloadUrl();\n   }\n \n-  /** Upload file to Firebase Storage. */\n   @Override\n-  public Completable uploadMediaFromFile(File file, String remoteDestinationPath) {\n-    return Completable.create(\n+  public Flowable<Event<UploadProgress>> uploadMediaFromFile(\n+      File file, String remoteDestinationPath) {\n+    return Flowable.create(\n         emitter ->\n             createReference(remoteDestinationPath)\n                 .putFile(Uri.fromFile(file))\n                 .addOnCompleteListener(uploadTask -> emitter.onComplete())\n-                .addOnFailureListener(emitter::onError)\n+                .addOnPausedListener(\n+                    taskSnapshot -> {\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.PAUSED)));\n+                    })\n+                .addOnFailureListener(\n+                    throwable -> {\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.FAILED)));\n+                      emitter.onError(throwable);\n+                    })\n                 .addOnSuccessListener(\n                     taskSnapshot -> {\n-                      // TODO: taskSnapshot contains metadata that can be displayed after uploading\n+                      emitter.onNext(Event.create(new UploadProgress(UploadState.COMPLETED)));\n                     })\n                 .addOnProgressListener(\n-                    taskSnapshot -> {\n-                      // TODO: Display upload status in app or notification\n-                      double completed =\n-                          100.0\n-                              * taskSnapshot.getBytesTransferred()\n-                              / taskSnapshot.getTotalByteCount();\n-                      Timber.d(\"Uploading in progress: %s %f\", remoteDestinationPath, completed);\n-                    }));\n+                    taskSnapshot ->\n+                        emitter.onNext(\n+                            Event.create(\n+                                new UploadProgress(\n+                                    UploadState.IN_PROGRESS,\n+                                    (int) taskSnapshot.getTotalByteCount(),\n+                                    (int) taskSnapshot.getBytesTransferred())))),\n+        BackpressureStrategy.BUFFER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1ODQ3MA==", "bodyText": "Are we showing a notification for each photo being uploaded? Ideally we'd have a single status bar for sync progress.", "url": "https://github.com/google/ground-android/pull/414#discussion_r398658470", "createdAt": "2020-03-26T15:21:37Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/PhotoSyncWorker.java", "diffHunk": "@@ -66,7 +72,8 @@ public Result doWork() {\n       try {\n         remoteStorageManager\n             .uploadMediaFromFile(new File(localSourcePath), remoteDestinationPath)\n-            .blockingAwait();\n+            .blockingForEach(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2db0b8a15ec0810679c023dbd656c9783221633f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac6cb651492d3c39f61e61990c770b8041b0d2bd", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/ac6cb651492d3c39f61e61990c770b8041b0d2bd", "committedDate": "2020-03-26T15:40:39Z", "message": "Merge branch 'master' into notifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ac228d24b8cbf03f7850ed266b28f0e12c7d6ab", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/5ac228d24b8cbf03f7850ed266b28f0e12c7d6ab", "committedDate": "2020-03-26T15:49:32Z", "message": "Add static methods and cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1900b85edb1f55740852a794619a31ef3ff9877", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f1900b85edb1f55740852a794619a31ef3ff9877", "committedDate": "2020-03-26T15:50:04Z", "message": "Use LATEST back-pressure strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c04b21f24fc4fb3382fad1971a51308e4597bc6", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/0c04b21f24fc4fb3382fad1971a51308e4597bc6", "committedDate": "2020-03-26T15:54:20Z", "message": "Unwrap progress events"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5affdb54e39f8687c50897ba451c4243ca180cd", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a5affdb54e39f8687c50897ba451c4243ca180cd", "committedDate": "2020-03-26T16:03:00Z", "message": "Improve variable names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13296b8174731634c66924d821cec16f4e69decd", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/13296b8174731634c66924d821cec16f4e69decd", "committedDate": "2020-03-26T16:03:29Z", "message": "typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2bdf3ccb9526db0b5ad89178f78d6aacd366e73", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/c2bdf3ccb9526db0b5ad89178f78d6aacd366e73", "committedDate": "2020-03-28T09:25:43Z", "message": "Merge branch 'master' into notifications"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNDUxNjg0", "url": "https://github.com/google/ground-android/pull/414#pullrequestreview-383451684", "createdAt": "2020-03-29T20:26:14Z", "commit": {"oid": "c2bdf3ccb9526db0b5ad89178f78d6aacd366e73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1763, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}