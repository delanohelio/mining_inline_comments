{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5MTMxODUy", "number": 425, "title": "[Code health] Add unit tests for LocalDataStore", "bodyText": "Unit tests for LocalDataStore. Code coverage: 96%", "createdAt": "2020-04-05T15:27:31Z", "url": "https://github.com/google/ground-android/pull/425", "merged": true, "mergeCommit": {"oid": "27612045a8029e2260308ad07dc307c0d8058d01"}, "closed": true, "closedAt": "2020-04-21T21:24:42Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 101, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZ6g2lAFqTM5NzY4NzAzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ6g2lAFqTM5NzY4NzAzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3Njg3MDM3", "url": "https://github.com/google/ground-android/pull/425#pullrequestreview-397687037", "createdAt": "2020-04-21T21:24:34Z", "commit": {"oid": "a8538d608ce52d1e8f7039614156025609d8f941"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c1ad6268da44894b6dc7eeb63b40072a05812b1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/0c1ad6268da44894b6dc7eeb63b40072a05812b1", "committedDate": "2020-04-05T14:36:06Z", "message": "Add dagger test dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73b504214fe3c76d91e771f197d80998ae15d4d4", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/73b504214fe3c76d91e771f197d80998ae15d4d4", "committedDate": "2020-04-05T14:39:01Z", "message": "Setup dagger injection for local database"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb3404a81c5efa680243972851f0d8b784580c4c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fb3404a81c5efa680243972851f0d8b784580c4c", "committedDate": "2020-04-05T15:25:27Z", "message": "Add tests for UserDao"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7e5a711cece66af39420de4ac7c3db16561afa2", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/b7e5a711cece66af39420de4ac7c3db16561afa2", "committedDate": "2020-04-05T15:53:42Z", "message": "Reuse test user object and add test for empty db"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "901471556fdd572069b57f8447d2c4926e6b91f1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/901471556fdd572069b57f8447d2c4926e6b91f1", "committedDate": "2020-04-05T16:30:10Z", "message": "Aggregate dependencies for LocalDataStore under LocalDataStoreModule\n\n - This would allow us to reuse just this module for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f283375e986b3ad84695c0c06761347e3656be26", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f283375e986b3ad84695c0c06761347e3656be26", "committedDate": "2020-04-05T16:31:04Z", "message": "Load LocalDataStoreModule in TestComponent and inject UserDao directly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODY4MzI3", "url": "https://github.com/google/ground-android/pull/425#pullrequestreview-387868327", "createdAt": "2020-04-05T22:28:04Z", "commit": {"oid": "f283375e986b3ad84695c0c06761347e3656be26"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQyMjoyODowNFrOGBD5qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQyMjoyODowNFrOGBD5qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzc2NTY3NA==", "bodyText": "Should we include the name of the entry point in this method as well for consistency? Perhaps we can create a convention like testEntryPoint_condition_result, e.g. testInsertUser_alreadyPresent_raisesError?  If condition and result are missing it can be assumed we're testing the default code path?", "url": "https://github.com/google/ground-android/pull/425#discussion_r403765674", "createdAt": "2020-04-05T22:28:04Z", "author": {"login": "gino-m"}, "path": "gnd/src/androidTest/java/com/google/android/gnd/persistence/local/room/dao/UserDaoTest.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local.room.dao;\n+\n+import androidx.test.runner.AndroidJUnit4;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.persistence.local.room.entity.UserEntity;\n+import javax.inject.Inject;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class UserDaoTest {\n+\n+  @Inject UserDao userDao;\n+\n+  private User testUser =\n+      User.builder().setId(\"foo id\").setDisplayName(\"foo name\").setEmail(\"foo@gmail.com\").build();\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testEmptyDb() {\n+    userDao.findById(testUser.getId()).test().assertNoValues();\n+  }\n+\n+  @Test\n+  public void testInsertUser() {\n+    userDao.insert(UserEntity.fromUser(testUser)).test().assertNoErrors();\n+    userDao\n+        .findById(testUser.getId())\n+        .test()\n+        .assertNoErrors()\n+        .assertValue(UserEntity.fromUser(testUser));\n+  }\n+\n+  @Test\n+  public void insertingAlreadyPresentUser_shouldRaiseError() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f283375e986b3ad84695c0c06761347e3656be26"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3154fe79b90a1b7db6f2feaa06577e354eebd24", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f3154fe79b90a1b7db6f2feaa06577e354eebd24", "committedDate": "2020-04-06T06:34:04Z", "message": "Name tests using convention testEntryPoint_condition_result"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce948d14b228fdf54c29dc39c0287c84627e69f4", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/ce948d14b228fdf54c29dc39c0287c84627e69f4", "committedDate": "2020-04-06T06:37:05Z", "message": "Remove redundant assertions already tested in other tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96a63da5289cc7b6890c333cef4e001eb95f2a8c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/96a63da5289cc7b6890c333cef4e001eb95f2a8c", "committedDate": "2020-04-07T12:42:29Z", "message": "Merge branch 'master' into testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aab1adc418084d50682298c7ae37ae2259af2c86", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/aab1adc418084d50682298c7ae37ae2259af2c86", "committedDate": "2020-04-08T19:15:17Z", "message": "Merge branch 'master' into testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e732b7557ea24476a62ce2d8d2dcbfe70a76f0c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/8e732b7557ea24476a62ce2d8d2dcbfe70a76f0c", "committedDate": "2020-04-08T19:31:31Z", "message": "Merge branch 'master' into testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8181b2d95961fc182395a9b1ad8fcf7938cf137f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/8181b2d95961fc182395a9b1ad8fcf7938cf137f", "committedDate": "2020-04-10T07:29:25Z", "message": "Merge branch 'master' into testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d397882c58395cabcf805725a27e3afe2486eb8b", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d397882c58395cabcf805725a27e3afe2486eb8b", "committedDate": "2020-04-10T08:41:54Z", "message": "Add dependencies for robolectric and configure gradle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "898cb348b99b22c332e19d94dcb7e98b510dcfb1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/898cb348b99b22c332e19d94dcb7e98b510dcfb1", "committedDate": "2020-04-10T08:42:28Z", "message": "Remove InstrumentationTest UserDaoTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "675d62f5d7aed3ed0cae4f354e812ab02ae715fb", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/675d62f5d7aed3ed0cae4f354e812ab02ae715fb", "committedDate": "2020-04-10T08:42:49Z", "message": "Rename dagger config for instrumentation tests -> Android*"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5ace3d429ac82b9e44bab338f880092d14f59a8", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/b5ace3d429ac82b9e44bab338f880092d14f59a8", "committedDate": "2020-04-10T08:43:17Z", "message": "Configure dagger injection for robolectric tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eab5e222d693d823147c69b6af6b75e3c80cff1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/2eab5e222d693d823147c69b6af6b75e3c80cff1", "committedDate": "2020-04-10T08:43:38Z", "message": "Add robolectric test for UserDao"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2465de00c0717efbf649feedd546676b9a24e714", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/2465de00c0717efbf649feedd546676b9a24e714", "committedDate": "2020-04-10T14:22:21Z", "message": "Convert Schedulers into interface and create implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cde54ecfc009da2f889bf54cc2ba75bd2ee3893f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/cde54ecfc009da2f889bf54cc2ba75bd2ee3893f", "committedDate": "2020-04-10T14:23:16Z", "message": "Create TestScheduler for tests\n\n - each method uses trampoline() which basically runs everything on the same thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca5899f31f796f8cacaefafd81bb352bde7d9e2f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/ca5899f31f796f8cacaefafd81bb352bde7d9e2f", "committedDate": "2020-04-10T14:23:38Z", "message": "Add tests for tiles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48d46f857a5dbf9de2b8b449912a2a8e1150ead5", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/48d46f857a5dbf9de2b8b449912a2a8e1150ead5", "committedDate": "2020-04-10T14:37:17Z", "message": "Add tests for offline area"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "049c60cc6f240ab4d0f54f3598934942b890cc65", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/049c60cc6f240ab4d0f54f3598934942b890cc65", "committedDate": "2020-04-10T14:47:43Z", "message": "loadUser -> getUser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "721610b19563514429cdcd86bb327657730486d6", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/721610b19563514429cdcd86bb327657730486d6", "committedDate": "2020-04-10T14:48:06Z", "message": "Add test for user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2133e51b805466c8a426518d696767c33e11b555", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/2133e51b805466c8a426518d696767c33e11b555", "committedDate": "2020-04-10T14:51:03Z", "message": "DB gets recreated for each test.\n\nSo, we don't need to close it after each test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "929d915ea96b2add233d59b509aada58487deac0", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/929d915ea96b2add233d59b509aada58487deac0", "committedDate": "2020-04-11T06:56:38Z", "message": "Return ImmutableList<Project> instead of List<Project>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06865b89b388394c22a10f13f6e1a82c9be93c16", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/06865b89b388394c22a10f13f6e1a82c9be93c16", "committedDate": "2020-04-11T06:56:55Z", "message": "Add test for getProjects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90b71b388ca442abcf11db6a33aae2efb9367add", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/90b71b388ca442abcf11db6a33aae2efb9367add", "committedDate": "2020-04-11T07:00:49Z", "message": "Test getProjectById and deleteProject"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3192d7a3918abc349d6e67b2d57204497f841ab0", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/3192d7a3918abc349d6e67b2d57204497f841ab0", "committedDate": "2020-04-11T13:40:42Z", "message": "test inserting project with dummy data (text field)\n\n this test fails when trying to save layer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "462ab11b7ea77ee311b79e08f3554e9c203e058b", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/462ab11b7ea77ee311b79e08f3554e9c203e058b", "committedDate": "2020-04-11T14:09:26Z", "message": "Replace assertNoError with assetComplete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1962814aca54ef069117f9617afff78d65f8470", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f1962814aca54ef069117f9617afff78d65f8470", "committedDate": "2020-04-11T14:12:18Z", "message": "Exclude the insertProjectTest until we have a solution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "437d284911a491f19bac494842bb0980dcb54ba9", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/437d284911a491f19bac494842bb0980dcb54ba9", "committedDate": "2020-04-11T14:13:19Z", "message": "Remove UserDaoTest, already tested in LocalDataStoreTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "266117c7dd25c16b832b5687f21489e6e2e2a769", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/266117c7dd25c16b832b5687f21489e6e2e2a769", "committedDate": "2020-04-11T14:16:36Z", "message": "Improve comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a312dd69d624e7244f93fea68ebfbf9e19d6661a", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a312dd69d624e7244f93fea68ebfbf9e19d6661a", "committedDate": "2020-04-11T14:17:45Z", "message": "Merge branch 'master' into testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "015c2518ccdd7ab2855007f8e5b10e4e3e34573f", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/015c2518ccdd7ab2855007f8e5b10e4e3e34573f", "committedDate": "2020-04-12T08:41:54Z", "message": "Fix failing layer insertion test\n\n - A new instance of local db was getting created for each Dao (see LocalDataStoreModule). This causes constraint exception as the project and layer inserted into different databases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "affe11b1eeb671ae565467e647c69f7ab56b5e13", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/affe11b1eeb671ae565467e647c69f7ab56b5e13", "committedDate": "2020-04-12T08:49:34Z", "message": "Change type of field to multiple choice to exercise options insertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c17ec288e501d2ce175995387c9d3c3bbfe9247", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/7c17ec288e501d2ce175995387c9d3c3bbfe9247", "committedDate": "2020-04-12T09:17:08Z", "message": "Add test for adding feature mutation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c3afa5d88f42ebf7b653e9332fb45c55c507f9e", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/2c3afa5d88f42ebf7b653e9332fb45c55c507f9e", "committedDate": "2020-04-12T09:29:38Z", "message": "Assert saved mutation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18fd73eea5a122ef8eb66ee965ff0dd7c4c2af12", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/18fd73eea5a122ef8eb66ee965ff0dd7c4c2af12", "committedDate": "2020-04-12T17:43:45Z", "message": "Test remove pending mutations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66dbfce3839411285fd0b4b5fa898daf537b4e0d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/66dbfce3839411285fd0b4b5fa898daf537b4e0d", "committedDate": "2020-04-12T17:48:50Z", "message": "Create method for generating test user object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5c5d91401f367171f17a84582125e04b2f05164", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a5c5d91401f367171f17a84582125e04b2f05164", "committedDate": "2020-04-12T19:47:57Z", "message": "Test getFeature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a7dda8acea6f17da1ac23c037a1ef3c9d6b3cbf", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/4a7dda8acea6f17da1ac23c037a1ef3c9d6b3cbf", "committedDate": "2020-04-12T20:03:25Z", "message": "Test mergeFeature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00e71a3abd1bb2061484d9179a3aa05260faef14", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/00e71a3abd1bb2061484d9179a3aa05260faef14", "committedDate": "2020-04-12T20:26:09Z", "message": "Test applyAndEnqueue observationFeature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f80979684b0dd7a609b35a1a124f477719690a85", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f80979684b0dd7a609b35a1a124f477719690a85", "committedDate": "2020-04-12T20:35:22Z", "message": "Test applyAndEnqueue observationFeature for existing observation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88ac6932b3ca39865bf5c2e8ce79db2a2bd5a83d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/88ac6932b3ca39865bf5c2e8ce79db2a2bd5a83d", "committedDate": "2020-04-12T21:01:24Z", "message": "Test getObservation and combine similar tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd0d65466707b090d3dd49910286b2db5a6cbd81", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fd0d65466707b090d3dd49910286b2db5a6cbd81", "committedDate": "2020-04-12T21:10:09Z", "message": "Also exercise getObservations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b161822bf19d71a29dc1716f8f8ea9ce46fa2002", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/b161822bf19d71a29dc1716f8f8ea9ce46fa2002", "committedDate": "2020-04-13T08:24:13Z", "message": "Add test for getTilesOnceAndStream\n\n - We also had to add a rule to run all tasks instantly in addition to having the TestScheduler. Maybe TestScheduler can be removed now."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c06cd16ae4c6e3e8dc52f4950c09a2f12b178ce", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/2c06cd16ae4c6e3e8dc52f4950c09a2f12b178ce", "committedDate": "2020-04-13T08:45:18Z", "message": "Fix pmd warnings and disable one spotbugs rule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcbf0b5dbe0c7a2d3c300fd2d220357e30c5a4a1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/dcbf0b5dbe0c7a2d3c300fd2d220357e30c5a4a1", "committedDate": "2020-04-13T15:44:34Z", "message": "Add test for getFeaturesOnceAndStream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/14749960635afa4a4e6dd97065a3999ef2f1dd9c", "committedDate": "2020-04-13T15:57:23Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e552b174758c6a83d48d1f5f87fcb7f6e326750b", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e552b174758c6a83d48d1f5f87fcb7f6e326750b", "committedDate": "2020-04-13T17:20:03Z", "message": "Add tests for updateMutations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8b96af9891cc444262b6913c95b9d383b04f1b7", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/c8b96af9891cc444262b6913c95b9d383b04f1b7", "committedDate": "2020-04-13T17:26:12Z", "message": "Add id to created mutations for simplicity\n\n - this is so that we don't always need to get the row from db before updating the entity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjc3MDQ1", "url": "https://github.com/google/ground-android/pull/425#pullrequestreview-392277045", "createdAt": "2020-04-13T16:57:23Z", "commit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjo1NzoyM1rOGEtIGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoyNToxOFrOGEuDgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4Njg0MA==", "bodyText": "Can we use @VisibileForTesting annotation instead of disabling this check altogether?", "url": "https://github.com/google/ground-android/pull/425#discussion_r407586840", "createdAt": "2020-04-13T16:57:23Z", "author": {"login": "gino-m"}, "path": "config/spotbugs/spotbugs-filter.xml", "diffHunk": "@@ -80,4 +81,7 @@\n   <Match>\n     <Bug pattern=\"UWF_FIELD_NOT_INITIALIZED_IN_CONSTRUCTOR\" />\n   </Match>\n+  <Match>\n+    <Bug pattern=\"URF_UNREAD_PUBLIC_OR_PROTECTED_FIELD\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MTI2NQ==", "bodyText": "\ud83d\udc4f \ud83d\udc4f\nThanks also for the name fixes, the DAO injection, and all the rest!", "url": "https://github.com/google/ground-android/pull/425#discussion_r407591265", "createdAt": "2020-04-13T17:05:37Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/LocalDataStore.java", "diffHunk": "@@ -49,13 +48,13 @@\n public interface LocalDataStore {\n \n   /** Load projects stored in local database. */\n-  Single<List<Project>> getProjects();\n+  Single<ImmutableList<Project>> getProjects();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5NjI0NA==", "bodyText": "\"all saved\" -> \"all queued, failed, and completed\"", "url": "https://github.com/google/ground-android/pull/425#discussion_r407596244", "createdAt": "2020-04-13T17:14:48Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/LocalDataStore.java", "diffHunk": "@@ -145,4 +144,7 @@\n    * the area into the local data store.\n    */\n   Completable insertOrUpdateOfflineArea(OfflineArea area);\n+\n+  /** Returns all saved offline areas from the local data store. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODQxNA==", "bodyText": "Good catch.", "url": "https://github.com/google/ground-android/pull/425#discussion_r407598414", "createdAt": "2020-04-13T17:18:52Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/dao/OfflineAreaDao.java", "diffHunk": "@@ -19,15 +19,15 @@\n import androidx.room.Dao;\n import androidx.room.Query;\n import com.google.android.gnd.persistence.local.room.entity.OfflineAreaEntity;\n-import io.reactivex.Flowable;\n import io.reactivex.Maybe;\n+import io.reactivex.Single;\n import java.util.List;\n \n /** Provides read/write operations for writing {@link OfflineAreaEntity} to the local db. */\n @Dao\n public interface OfflineAreaDao extends BaseDao<OfflineAreaEntity> {\n   @Query(\"SELECT * FROM offline_area\")\n-  Flowable<List<OfflineAreaEntity>> findAll();\n+  Single<List<OfflineAreaEntity>> findAll();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODc3Mg==", "bodyText": "Why return a Flowable here? Do we want to subscribe to future tile changes?", "url": "https://github.com/google/ground-android/pull/425#discussion_r407598772", "createdAt": "2020-04-13T17:19:29Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/dao/TileDao.java", "diffHunk": "@@ -27,7 +28,7 @@\n public interface TileDao extends BaseDao<TileEntity> {\n \n   @Query(\"SELECT * FROM tile\")\n-  Single<List<TileEntity>> findAll();\n+  Flowable<List<TileEntity>> findAll();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMDM4Mg==", "bodyText": "Neat.. could you please add a class description that explains what this does in practice?", "url": "https://github.com/google/ground-android/pull/425#discussion_r407600382", "createdAt": "2020-04-13T17:22:18Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/TestScheduler.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd;\n+\n+import com.google.android.gnd.rx.Schedulers;\n+import io.reactivex.Scheduler;\n+import javax.inject.Inject;\n+\n+public class TestScheduler implements Schedulers {\n+\n+  @Inject\n+  TestScheduler() {}\n+\n+  @Override\n+  public Scheduler io() {\n+    return io.reactivex.schedulers.Schedulers.trampoline();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwMjA1MA==", "bodyText": "Please make helpers static, include word \"Test\" so it's clear these don't just create a new empty instance (e.g. createTestUser()).", "url": "https://github.com/google/ground-android/pull/425#discussion_r407602050", "createdAt": "2020-04-13T17:25:18Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,565 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Builder;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  private User createUser() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e552b174758c6a83d48d1f5f87fcb7f6e326750b"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2dddee373177af62f8af3dcf6dd7d2be6f13eb5", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e2dddee373177af62f8af3dcf6dd7d2be6f13eb5", "committedDate": "2020-04-13T17:51:33Z", "message": "Add test for mergeObservation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48e2a92da77a9c78d69447f600d7b5fb2b02df40", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/48e2a92da77a9c78d69447f600d7b5fb2b02df40", "committedDate": "2020-04-13T18:07:00Z", "message": "Use simple test id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89dd29f3d5c67921b69e7159696bf4bfdc3d28d8", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/89dd29f3d5c67921b69e7159696bf4bfdc3d28d8", "committedDate": "2020-04-13T18:46:25Z", "message": "Update comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80804884422c3443753a13bef00ff03500d162f9", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/80804884422c3443753a13bef00ff03500d162f9", "committedDate": "2020-04-13T18:50:59Z", "message": "Add doc comments for TestScheduler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f19366bc11942167e22c82666e751169de42eb8", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/7f19366bc11942167e22c82666e751169de42eb8", "committedDate": "2020-04-13T18:53:03Z", "message": "Declare methods as static and append Test to their name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d067567ac55be392063ab19c3d46df237e0e657", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/4d067567ac55be392063ab19c3d46df237e0e657", "committedDate": "2020-04-14T16:29:59Z", "message": "Merge branch 'master' into testing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDY5MzI2", "url": "https://github.com/google/ground-android/pull/425#pullrequestreview-393069326", "createdAt": "2020-04-14T15:56:23Z", "commit": {"oid": "7f19366bc11942167e22c82666e751169de42eb8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1NjoyM1rOGFVkdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNzozOTo1OVrOGFZvoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0OTQ2Mw==", "bodyText": "The semantics of Single and Flowable are different in Room generated classes; Single returns a result and completes, whereas Flowable continues emitting values on each change. We convert to Flowable in upstream code because we're merging with a hot observable that doesn't complete as soon as a value is emitted. Here we expect the stream to terminate after the first item is emitted, so Single is appropriate here.", "url": "https://github.com/google/ground-android/pull/425#discussion_r408249463", "createdAt": "2020-04-14T15:56:23Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/dao/TileDao.java", "diffHunk": "@@ -27,7 +28,7 @@\n public interface TileDao extends BaseDao<TileEntity> {\n \n   @Query(\"SELECT * FROM tile\")\n-  Single<List<TileEntity>> findAll();\n+  Flowable<List<TileEntity>> findAll();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODc3Mg=="}, "originalCommit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2MjIxMg==", "bodyText": "In the InMemoryCacheTest we kept constant fake objects as static members, FAKE_... Should we do the same here for clarity and consistency?", "url": "https://github.com/google/ground-android/pull/425#discussion_r408262212", "createdAt": "2020-04-14T16:14:06Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,611 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Builder;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static User createTestUser() {\n+    return User.builder()\n+        .setId(\"test_user_id\")\n+        .setEmail(\"test@gmail.com\")\n+        .setDisplayName(\"test user\")\n+        .build();\n+  }\n+\n+  private static Project createTestProject() {\n+    Builder multipleChoiceBuilder =\n+        MultipleChoice.newBuilder().setCardinality(Cardinality.SELECT_ONE);\n+    multipleChoiceBuilder\n+        .optionsBuilder()\n+        .add(Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build())\n+        .add(Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build());\n+\n+    Field field =\n+        Field.newBuilder()\n+            .setId(\"field id\")\n+            .setLabel(\"field label\")\n+            .setRequired(false)\n+            .setType(Type.MULTIPLE_CHOICE)\n+            .setMultipleChoice(multipleChoiceBuilder.build())\n+            .build();\n+\n+    Element element = Element.ofField(field);\n+\n+    Form form =\n+        Form.newBuilder()\n+            .setId(\"form id\")\n+            .setElements(ImmutableList.<Element>builder().add(element).build())\n+            .build();\n+\n+    Layer layer =\n+        Layer.newBuilder()\n+            .setId(\"layer id\")\n+            .setItemLabel(\"item label\")\n+            .setListHeading(\"heading title\")\n+            .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+            .setForm(form)\n+            .build();\n+\n+    Project.Builder builder =\n+        Project.newBuilder()\n+            .setId(\"project id\")\n+            .setTitle(\"project 1\")\n+            .setDescription(\"foo description\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f19366bc11942167e22c82666e751169de42eb8"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2NDgyNg==", "bodyText": "Can we use ImmutableList.of() here instead?\nI didn't realize RxJava had test helpers and assertions built in.", "url": "https://github.com/google/ground-android/pull/425#discussion_r408264826", "createdAt": "2020-04-14T16:17:51Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,611 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Builder;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static User createTestUser() {\n+    return User.builder()\n+        .setId(\"test_user_id\")\n+        .setEmail(\"test@gmail.com\")\n+        .setDisplayName(\"test user\")\n+        .build();\n+  }\n+\n+  private static Project createTestProject() {\n+    Builder multipleChoiceBuilder =\n+        MultipleChoice.newBuilder().setCardinality(Cardinality.SELECT_ONE);\n+    multipleChoiceBuilder\n+        .optionsBuilder()\n+        .add(Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build())\n+        .add(Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build());\n+\n+    Field field =\n+        Field.newBuilder()\n+            .setId(\"field id\")\n+            .setLabel(\"field label\")\n+            .setRequired(false)\n+            .setType(Type.MULTIPLE_CHOICE)\n+            .setMultipleChoice(multipleChoiceBuilder.build())\n+            .build();\n+\n+    Element element = Element.ofField(field);\n+\n+    Form form =\n+        Form.newBuilder()\n+            .setId(\"form id\")\n+            .setElements(ImmutableList.<Element>builder().add(element).build())\n+            .build();\n+\n+    Layer layer =\n+        Layer.newBuilder()\n+            .setId(\"layer id\")\n+            .setItemLabel(\"item label\")\n+            .setListHeading(\"heading title\")\n+            .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+            .setForm(form)\n+            .build();\n+\n+    Project.Builder builder =\n+        Project.newBuilder()\n+            .setId(\"project id\")\n+            .setTitle(\"project 1\")\n+            .setDescription(\"foo description\");\n+    builder.putLayer(layer.getId(), layer);\n+    return builder.build();\n+  }\n+\n+  private static FeatureMutation createTestFeatureMutation(\n+      String userId, String projectId, String layerId) {\n+    return FeatureMutation.builder()\n+        .setId(1L)\n+        .setType(Mutation.Type.CREATE)\n+        .setUserId(userId)\n+        .setProjectId(projectId)\n+        .setFeatureId(\"feature id\")\n+        .setLayerId(layerId)\n+        .setNewLocation(\n+            Optional.ofNullable(Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build()))\n+        .setClientTimestamp(new Date())\n+        .build();\n+  }\n+\n+  private static ObservationMutation createTestObservationMutation(\n+      String projectId, String featureId, String layerId, String formId, String userId) {\n+    return ObservationMutation.builder()\n+        .setType(Mutation.Type.CREATE)\n+        .setProjectId(projectId)\n+        .setFeatureId(featureId)\n+        .setLayerId(layerId)\n+        .setObservationId(\"observation id\")\n+        .setFormId(formId)\n+        .setResponseDeltas(\n+            ImmutableList.<ResponseDelta>builder()\n+                .add(\n+                    ResponseDelta.builder()\n+                        .setFieldId(\"field id\")\n+                        .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                        .build())\n+                .build())\n+        .setClientTimestamp(new Date())\n+        .setUserId(userId)\n+        .build();\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    Project project1 =\n+        Project.newBuilder()\n+            .setId(\"id 1\")\n+            .setTitle(\"project 1\")\n+            .setDescription(\"foo description\")\n+            .build();\n+    Project project2 =\n+        Project.newBuilder()\n+            .setId(\"id 2\")\n+            .setTitle(\"project 2\")\n+            .setDescription(\"foo description 2\")\n+            .build();\n+    localDataStore.insertOrUpdateProject(project1).test().assertComplete();\n+    localDataStore.insertOrUpdateProject(project2).test().assertComplete();\n+    localDataStore\n+        .getProjects()\n+        .test()\n+        .assertValue(ImmutableList.<Project>builder().add(project1, project2).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f19366bc11942167e22c82666e751169de42eb8"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2OTAwMQ==", "bodyText": "Can we use Google Truth and compare the entire object here and throughout?\nassertThat(savedMutations).containsExactly(expectedValue)\nAlso, consider creating expected mutation as a constant to simplify these tests.\nRx assertValue is still fine for simple cases, or we can always use Truth, no opinion there.", "url": "https://github.com/google/ground-android/pull/425#discussion_r408269001", "createdAt": "2020-04-14T16:23:56Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,611 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Builder;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static User createTestUser() {\n+    return User.builder()\n+        .setId(\"test_user_id\")\n+        .setEmail(\"test@gmail.com\")\n+        .setDisplayName(\"test user\")\n+        .build();\n+  }\n+\n+  private static Project createTestProject() {\n+    Builder multipleChoiceBuilder =\n+        MultipleChoice.newBuilder().setCardinality(Cardinality.SELECT_ONE);\n+    multipleChoiceBuilder\n+        .optionsBuilder()\n+        .add(Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build())\n+        .add(Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build());\n+\n+    Field field =\n+        Field.newBuilder()\n+            .setId(\"field id\")\n+            .setLabel(\"field label\")\n+            .setRequired(false)\n+            .setType(Type.MULTIPLE_CHOICE)\n+            .setMultipleChoice(multipleChoiceBuilder.build())\n+            .build();\n+\n+    Element element = Element.ofField(field);\n+\n+    Form form =\n+        Form.newBuilder()\n+            .setId(\"form id\")\n+            .setElements(ImmutableList.<Element>builder().add(element).build())\n+            .build();\n+\n+    Layer layer =\n+        Layer.newBuilder()\n+            .setId(\"layer id\")\n+            .setItemLabel(\"item label\")\n+            .setListHeading(\"heading title\")\n+            .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+            .setForm(form)\n+            .build();\n+\n+    Project.Builder builder =\n+        Project.newBuilder()\n+            .setId(\"project id\")\n+            .setTitle(\"project 1\")\n+            .setDescription(\"foo description\");\n+    builder.putLayer(layer.getId(), layer);\n+    return builder.build();\n+  }\n+\n+  private static FeatureMutation createTestFeatureMutation(\n+      String userId, String projectId, String layerId) {\n+    return FeatureMutation.builder()\n+        .setId(1L)\n+        .setType(Mutation.Type.CREATE)\n+        .setUserId(userId)\n+        .setProjectId(projectId)\n+        .setFeatureId(\"feature id\")\n+        .setLayerId(layerId)\n+        .setNewLocation(\n+            Optional.ofNullable(Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build()))\n+        .setClientTimestamp(new Date())\n+        .build();\n+  }\n+\n+  private static ObservationMutation createTestObservationMutation(\n+      String projectId, String featureId, String layerId, String formId, String userId) {\n+    return ObservationMutation.builder()\n+        .setType(Mutation.Type.CREATE)\n+        .setProjectId(projectId)\n+        .setFeatureId(featureId)\n+        .setLayerId(layerId)\n+        .setObservationId(\"observation id\")\n+        .setFormId(formId)\n+        .setResponseDeltas(\n+            ImmutableList.<ResponseDelta>builder()\n+                .add(\n+                    ResponseDelta.builder()\n+                        .setFieldId(\"field id\")\n+                        .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                        .build())\n+                .build())\n+        .setClientTimestamp(new Date())\n+        .setUserId(userId)\n+        .build();\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    Project project1 =\n+        Project.newBuilder()\n+            .setId(\"id 1\")\n+            .setTitle(\"project 1\")\n+            .setDescription(\"foo description\")\n+            .build();\n+    Project project2 =\n+        Project.newBuilder()\n+            .setId(\"id 2\")\n+            .setTitle(\"project 2\")\n+            .setDescription(\"foo description 2\")\n+            .build();\n+    localDataStore.insertOrUpdateProject(project1).test().assertComplete();\n+    localDataStore.insertOrUpdateProject(project2).test().assertComplete();\n+    localDataStore\n+        .getProjects()\n+        .test()\n+        .assertValue(ImmutableList.<Project>builder().add(project1, project2).build());\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    localDataStore.getProjectById(project.getId()).test().assertValue(project);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    localDataStore.deleteProject(project).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+    localDataStore.getUser(user.getId()).test().assertValue(user);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+\n+    Layer layer = project.getLayers().get(0);\n+    FeatureMutation mutation =\n+        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n+    localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n+\n+    ImmutableList<Mutation> savedMutations =\n+        localDataStore.getPendingMutations(mutation.getFeatureId()).blockingGet();\n+    Assert.assertEquals(1, savedMutations.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f19366bc11942167e22c82666e751169de42eb8"}, "originalPosition": 227}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3MDg4MA==", "bodyText": "I'm not sure we want to assert our precondition setup - don't we already have coverage for these code paths in other tests?", "url": "https://github.com/google/ground-android/pull/425#discussion_r408270880", "createdAt": "2020-04-14T16:26:41Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,611 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Builder;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static User createTestUser() {\n+    return User.builder()\n+        .setId(\"test_user_id\")\n+        .setEmail(\"test@gmail.com\")\n+        .setDisplayName(\"test user\")\n+        .build();\n+  }\n+\n+  private static Project createTestProject() {\n+    Builder multipleChoiceBuilder =\n+        MultipleChoice.newBuilder().setCardinality(Cardinality.SELECT_ONE);\n+    multipleChoiceBuilder\n+        .optionsBuilder()\n+        .add(Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build())\n+        .add(Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build());\n+\n+    Field field =\n+        Field.newBuilder()\n+            .setId(\"field id\")\n+            .setLabel(\"field label\")\n+            .setRequired(false)\n+            .setType(Type.MULTIPLE_CHOICE)\n+            .setMultipleChoice(multipleChoiceBuilder.build())\n+            .build();\n+\n+    Element element = Element.ofField(field);\n+\n+    Form form =\n+        Form.newBuilder()\n+            .setId(\"form id\")\n+            .setElements(ImmutableList.<Element>builder().add(element).build())\n+            .build();\n+\n+    Layer layer =\n+        Layer.newBuilder()\n+            .setId(\"layer id\")\n+            .setItemLabel(\"item label\")\n+            .setListHeading(\"heading title\")\n+            .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+            .setForm(form)\n+            .build();\n+\n+    Project.Builder builder =\n+        Project.newBuilder()\n+            .setId(\"project id\")\n+            .setTitle(\"project 1\")\n+            .setDescription(\"foo description\");\n+    builder.putLayer(layer.getId(), layer);\n+    return builder.build();\n+  }\n+\n+  private static FeatureMutation createTestFeatureMutation(\n+      String userId, String projectId, String layerId) {\n+    return FeatureMutation.builder()\n+        .setId(1L)\n+        .setType(Mutation.Type.CREATE)\n+        .setUserId(userId)\n+        .setProjectId(projectId)\n+        .setFeatureId(\"feature id\")\n+        .setLayerId(layerId)\n+        .setNewLocation(\n+            Optional.ofNullable(Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build()))\n+        .setClientTimestamp(new Date())\n+        .build();\n+  }\n+\n+  private static ObservationMutation createTestObservationMutation(\n+      String projectId, String featureId, String layerId, String formId, String userId) {\n+    return ObservationMutation.builder()\n+        .setType(Mutation.Type.CREATE)\n+        .setProjectId(projectId)\n+        .setFeatureId(featureId)\n+        .setLayerId(layerId)\n+        .setObservationId(\"observation id\")\n+        .setFormId(formId)\n+        .setResponseDeltas(\n+            ImmutableList.<ResponseDelta>builder()\n+                .add(\n+                    ResponseDelta.builder()\n+                        .setFieldId(\"field id\")\n+                        .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                        .build())\n+                .build())\n+        .setClientTimestamp(new Date())\n+        .setUserId(userId)\n+        .build();\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    Project project1 =\n+        Project.newBuilder()\n+            .setId(\"id 1\")\n+            .setTitle(\"project 1\")\n+            .setDescription(\"foo description\")\n+            .build();\n+    Project project2 =\n+        Project.newBuilder()\n+            .setId(\"id 2\")\n+            .setTitle(\"project 2\")\n+            .setDescription(\"foo description 2\")\n+            .build();\n+    localDataStore.insertOrUpdateProject(project1).test().assertComplete();\n+    localDataStore.insertOrUpdateProject(project2).test().assertComplete();\n+    localDataStore\n+        .getProjects()\n+        .test()\n+        .assertValue(ImmutableList.<Project>builder().add(project1, project2).build());\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    localDataStore.getProjectById(project.getId()).test().assertValue(project);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    localDataStore.deleteProject(project).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+    localDataStore.getUser(user.getId()).test().assertValue(user);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+\n+    Layer layer = project.getLayers().get(0);\n+    FeatureMutation mutation =\n+        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n+    localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n+\n+    ImmutableList<Mutation> savedMutations =\n+        localDataStore.getPendingMutations(mutation.getFeatureId()).blockingGet();\n+    Assert.assertEquals(1, savedMutations.size());\n+\n+    // assert that mutation is saved to local database\n+    FeatureMutation savedMutation = (FeatureMutation) savedMutations.get(0);\n+    Assert.assertEquals(mutation.getNewLocation(), savedMutation.getNewLocation());\n+    Assert.assertEquals(mutation.getType(), savedMutation.getType());\n+    Assert.assertEquals(mutation.getUserId(), savedMutation.getUserId());\n+    Assert.assertEquals(mutation.getProjectId(), savedMutation.getProjectId());\n+    Assert.assertEquals(mutation.getFeatureId(), savedMutation.getFeatureId());\n+    Assert.assertEquals(mutation.getLayerId(), savedMutation.getLayerId());\n+    Assert.assertEquals(mutation.getClientTimestamp(), savedMutation.getClientTimestamp());\n+    Assert.assertEquals(0, savedMutation.getRetryCount());\n+    Assert.assertNull(savedMutation.getLastError());\n+\n+    // assert feature is saved to local database\n+    Feature feature = localDataStore.getFeature(project, mutation.getFeatureId()).blockingGet();\n+    Assert.assertEquals(mutation.getFeatureId(), feature.getId());\n+    Assert.assertEquals(project, feature.getProject());\n+    Assert.assertEquals(layer.getItemLabel(), feature.getTitle());\n+    Assert.assertEquals(layer, feature.getLayer());\n+    Assert.assertNull(feature.getCustomId());\n+    Assert.assertNull(feature.getCaption());\n+    Assert.assertEquals(mutation.getNewLocation().get(), feature.getPoint());\n+    Assert.assertEquals(user, feature.getCreated().getUser());\n+    Assert.assertEquals(user, feature.getLastModified().getUser());\n+  }\n+\n+  @Test\n+  public void testGetFeaturesOnceAndStream() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f19366bc11942167e22c82666e751169de42eb8"}, "originalPosition": 257}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMxNzg1Nw==", "bodyText": "This test (and ones like it) look they're testing more than one behavior, which is why they're longer . Can we split these into clear preconditions, execute, and postconditions? See previous comments for ways to simplify.", "url": "https://github.com/google/ground-android/pull/425#discussion_r408317857", "createdAt": "2020-04-14T17:39:59Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,611 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Builder;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static User createTestUser() {\n+    return User.builder()\n+        .setId(\"test_user_id\")\n+        .setEmail(\"test@gmail.com\")\n+        .setDisplayName(\"test user\")\n+        .build();\n+  }\n+\n+  private static Project createTestProject() {\n+    Builder multipleChoiceBuilder =\n+        MultipleChoice.newBuilder().setCardinality(Cardinality.SELECT_ONE);\n+    multipleChoiceBuilder\n+        .optionsBuilder()\n+        .add(Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build())\n+        .add(Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build());\n+\n+    Field field =\n+        Field.newBuilder()\n+            .setId(\"field id\")\n+            .setLabel(\"field label\")\n+            .setRequired(false)\n+            .setType(Type.MULTIPLE_CHOICE)\n+            .setMultipleChoice(multipleChoiceBuilder.build())\n+            .build();\n+\n+    Element element = Element.ofField(field);\n+\n+    Form form =\n+        Form.newBuilder()\n+            .setId(\"form id\")\n+            .setElements(ImmutableList.<Element>builder().add(element).build())\n+            .build();\n+\n+    Layer layer =\n+        Layer.newBuilder()\n+            .setId(\"layer id\")\n+            .setItemLabel(\"item label\")\n+            .setListHeading(\"heading title\")\n+            .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+            .setForm(form)\n+            .build();\n+\n+    Project.Builder builder =\n+        Project.newBuilder()\n+            .setId(\"project id\")\n+            .setTitle(\"project 1\")\n+            .setDescription(\"foo description\");\n+    builder.putLayer(layer.getId(), layer);\n+    return builder.build();\n+  }\n+\n+  private static FeatureMutation createTestFeatureMutation(\n+      String userId, String projectId, String layerId) {\n+    return FeatureMutation.builder()\n+        .setId(1L)\n+        .setType(Mutation.Type.CREATE)\n+        .setUserId(userId)\n+        .setProjectId(projectId)\n+        .setFeatureId(\"feature id\")\n+        .setLayerId(layerId)\n+        .setNewLocation(\n+            Optional.ofNullable(Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build()))\n+        .setClientTimestamp(new Date())\n+        .build();\n+  }\n+\n+  private static ObservationMutation createTestObservationMutation(\n+      String projectId, String featureId, String layerId, String formId, String userId) {\n+    return ObservationMutation.builder()\n+        .setType(Mutation.Type.CREATE)\n+        .setProjectId(projectId)\n+        .setFeatureId(featureId)\n+        .setLayerId(layerId)\n+        .setObservationId(\"observation id\")\n+        .setFormId(formId)\n+        .setResponseDeltas(\n+            ImmutableList.<ResponseDelta>builder()\n+                .add(\n+                    ResponseDelta.builder()\n+                        .setFieldId(\"field id\")\n+                        .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                        .build())\n+                .build())\n+        .setClientTimestamp(new Date())\n+        .setUserId(userId)\n+        .build();\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    Project project1 =\n+        Project.newBuilder()\n+            .setId(\"id 1\")\n+            .setTitle(\"project 1\")\n+            .setDescription(\"foo description\")\n+            .build();\n+    Project project2 =\n+        Project.newBuilder()\n+            .setId(\"id 2\")\n+            .setTitle(\"project 2\")\n+            .setDescription(\"foo description 2\")\n+            .build();\n+    localDataStore.insertOrUpdateProject(project1).test().assertComplete();\n+    localDataStore.insertOrUpdateProject(project2).test().assertComplete();\n+    localDataStore\n+        .getProjects()\n+        .test()\n+        .assertValue(ImmutableList.<Project>builder().add(project1, project2).build());\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    localDataStore.getProjectById(project.getId()).test().assertValue(project);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    localDataStore.deleteProject(project).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+    localDataStore.getUser(user.getId()).test().assertValue(user);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+\n+    Layer layer = project.getLayers().get(0);\n+    FeatureMutation mutation =\n+        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n+    localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n+\n+    ImmutableList<Mutation> savedMutations =\n+        localDataStore.getPendingMutations(mutation.getFeatureId()).blockingGet();\n+    Assert.assertEquals(1, savedMutations.size());\n+\n+    // assert that mutation is saved to local database\n+    FeatureMutation savedMutation = (FeatureMutation) savedMutations.get(0);\n+    Assert.assertEquals(mutation.getNewLocation(), savedMutation.getNewLocation());\n+    Assert.assertEquals(mutation.getType(), savedMutation.getType());\n+    Assert.assertEquals(mutation.getUserId(), savedMutation.getUserId());\n+    Assert.assertEquals(mutation.getProjectId(), savedMutation.getProjectId());\n+    Assert.assertEquals(mutation.getFeatureId(), savedMutation.getFeatureId());\n+    Assert.assertEquals(mutation.getLayerId(), savedMutation.getLayerId());\n+    Assert.assertEquals(mutation.getClientTimestamp(), savedMutation.getClientTimestamp());\n+    Assert.assertEquals(0, savedMutation.getRetryCount());\n+    Assert.assertNull(savedMutation.getLastError());\n+\n+    // assert feature is saved to local database\n+    Feature feature = localDataStore.getFeature(project, mutation.getFeatureId()).blockingGet();\n+    Assert.assertEquals(mutation.getFeatureId(), feature.getId());\n+    Assert.assertEquals(project, feature.getProject());\n+    Assert.assertEquals(layer.getItemLabel(), feature.getTitle());\n+    Assert.assertEquals(layer, feature.getLayer());\n+    Assert.assertNull(feature.getCustomId());\n+    Assert.assertNull(feature.getCaption());\n+    Assert.assertEquals(mutation.getNewLocation().get(), feature.getPoint());\n+    Assert.assertEquals(user, feature.getCreated().getUser());\n+    Assert.assertEquals(user, feature.getLastModified().getUser());\n+  }\n+\n+  @Test\n+  public void testGetFeaturesOnceAndStream() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+\n+    TestSubscriber<ImmutableSet<Feature>> subscriber =\n+        localDataStore.getFeaturesOnceAndStream(project).test();\n+\n+    subscriber.assertValueCount(1);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+\n+    Layer layer = project.getLayers().get(0);\n+    FeatureMutation mutation =\n+        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n+    localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n+\n+    Feature feature = localDataStore.getFeature(project, mutation.getFeatureId()).blockingGet();\n+\n+    subscriber.assertValueCount(2);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+    subscriber.assertValueAt(1, ImmutableSet.<Feature>builder().add(feature).build());\n+  }\n+\n+  @Test\n+  public void testUpdateMutations() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+\n+    Layer layer = project.getLayers().get(0);\n+    FeatureMutation mutation =\n+        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n+    localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n+\n+    Point newPoint = Point.newBuilder().setLatitude(51.0).setLongitude(44.0).build();\n+    Mutation updatedMutation =\n+        mutation.toBuilder().setNewLocation(Optional.ofNullable(newPoint)).build();\n+\n+    localDataStore\n+        .updateMutations(ImmutableList.<Mutation>builder().add(updatedMutation).build())\n+        .test()\n+        .assertComplete();\n+\n+    ImmutableList<Mutation> savedMutations =\n+        localDataStore.getPendingMutations(updatedMutation.getFeatureId()).blockingGet();\n+    Assert.assertEquals(1, savedMutations.size());\n+\n+    FeatureMutation savedMutation = (FeatureMutation) savedMutations.get(0);\n+    Assert.assertEquals(newPoint, savedMutation.getNewLocation().get());\n+  }\n+\n+  @Test\n+  public void testRemovePendingMutation() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+\n+    Layer layer = project.getLayers().get(0);\n+    FeatureMutation mutation =\n+        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n+    localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n+\n+    localDataStore\n+        .removePendingMutations(ImmutableList.<Mutation>builder().add(mutation).build())\n+        .test()\n+        .assertComplete();\n+\n+    localDataStore\n+        .getPendingMutations(mutation.getFeatureId())\n+        .test()\n+        .assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testMergeFeature() {\n+    User user = createTestUser();\n+    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+\n+    Project project = createTestProject();\n+    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+\n+    Layer layer = project.getLayers().get(0);\n+    FeatureMutation mutation =\n+        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n+    localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n+\n+    Feature feature = localDataStore.getFeature(project, mutation.getFeatureId()).blockingGet();\n+    Point point = Point.newBuilder().setLongitude(11.0).setLatitude(33.0).build();\n+    feature = feature.toBuilder().setPoint(point).build();\n+    localDataStore.mergeFeature(feature).test().assertComplete();\n+\n+    Feature newFeature = localDataStore.getFeature(project, mutation.getFeatureId()).blockingGet();\n+    Assert.assertEquals(mutation.getFeatureId(), newFeature.getId());\n+    Assert.assertEquals(project, newFeature.getProject());\n+    Assert.assertEquals(layer.getItemLabel(), newFeature.getTitle());\n+    Assert.assertEquals(layer, newFeature.getLayer());\n+    Assert.assertNull(newFeature.getCustomId());\n+    Assert.assertNull(newFeature.getCaption());\n+    Assert.assertEquals(point, newFeature.getPoint());\n+    Assert.assertEquals(user, newFeature.getCreated().getUser());\n+    Assert.assertEquals(user, newFeature.getLastModified().getUser());\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_observationMutation() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d067567ac55be392063ab19c3d46df237e0e657"}, "originalPosition": 365}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b132a471dbef9903e1fc088b9003bf053afc510", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/8b132a471dbef9903e1fc088b9003bf053afc510", "committedDate": "2020-04-15T12:54:07Z", "message": "Merge branch 'master' into testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73864a4a37674ebe848a112d66e295e240362d94", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/73864a4a37674ebe848a112d66e295e240362d94", "committedDate": "2020-04-15T13:09:39Z", "message": "Compare entire FeatureMutation instead of checking individually\n\n - This wasn't done earlier because Id was auto-generating. But in the one of the last commits, we added the id as well to the test object."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "196df6e3e8166b8a30ddccb2859046da8af14419", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/196df6e3e8166b8a30ddccb2859046da8af14419", "committedDate": "2020-04-15T13:14:46Z", "message": "Use Immutable.of() wherever possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7693bc51f300e6881c3360e5396a6abb94ccb3c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f7693bc51f300e6881c3360e5396a6abb94ccb3c", "committedDate": "2020-04-15T13:50:52Z", "message": "Convert test objects into static variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "275264dc6e9c99ac2bcc852e567eaa3819853def", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/275264dc6e9c99ac2bcc852e567eaa3819853def", "committedDate": "2020-04-15T14:01:55Z", "message": "Replace test().assertComplete() with subscribe()\n\n - this is prevent duplicate assertions already done in previous tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9157493982a085ea2c26d064480b5df733ad7fe", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d9157493982a085ea2c26d064480b5df733ad7fe", "committedDate": "2020-04-15T14:14:06Z", "message": "Move assertions for ObservationMutation into a separate method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa02907b788d98144fe5a82646ddea63cf980083", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fa02907b788d98144fe5a82646ddea63cf980083", "committedDate": "2020-04-15T14:17:10Z", "message": "Use ImmutableSet.of() wherever possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80c66e473d42d62852c4b52ac756329965b4a8a1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/80c66e473d42d62852c4b52ac756329965b4a8a1", "committedDate": "2020-04-15T14:28:32Z", "message": "Simplify observationMutation assertion and add comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36833ab571c4a9338575e6d24bf44ddc31a7521d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/36833ab571c4a9338575e6d24bf44ddc31a7521d", "committedDate": "2020-04-15T14:32:00Z", "message": "Store fake location in a separate variable for easy assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40f73f415664e3dd69a277a24ea8fdc3f2da0953", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/40f73f415664e3dd69a277a24ea8fdc3f2da0953", "committedDate": "2020-04-15T14:47:16Z", "message": "Move assertion for observation to a separate method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93cc92acdfb4d7a8fc632b2d405a96315de08130", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/93cc92acdfb4d7a8fc632b2d405a96315de08130", "committedDate": "2020-04-15T14:48:31Z", "message": "Reuse assertObservation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f75789943d137ed571042cc2cbe8358b955dbbe8", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f75789943d137ed571042cc2cbe8358b955dbbe8", "committedDate": "2020-04-15T17:40:05Z", "message": "Reuse FAKE_USER for testGetProjects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "324ef32e9520df89388fa8aa15a3d3aba2516f77", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/324ef32e9520df89388fa8aa15a3d3aba2516f77", "committedDate": "2020-04-15T17:48:28Z", "message": "Create static fakes for the rest of the tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d68f4e4e1251fb315c1b1b40d4552baa99a8a79e", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d68f4e4e1251fb315c1b1b40d4552baa99a8a79e", "committedDate": "2020-04-16T14:57:12Z", "message": "Merge branch 'master' into testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4f09decacd17490ef305dab30085dd432f14ed3", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e4f09decacd17490ef305dab30085dd432f14ed3", "committedDate": "2020-04-16T19:32:50Z", "message": "Exclude pmd checks for tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df3ccd288599968bf3b28bd181076bdacc157c11", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/df3ccd288599968bf3b28bd181076bdacc157c11", "committedDate": "2020-04-16T19:36:41Z", "message": "Rename FAKE -> Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7", "committedDate": "2020-04-16T19:38:18Z", "message": "Rename findAll to getTilesOnceAndStream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MDA1MzYy", "url": "https://github.com/google/ground-android/pull/425#pullrequestreview-395005362", "createdAt": "2020-04-16T21:16:34Z", "commit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMToxNjozNFrOGG3dxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMTozMTo0NlrOGG36BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1MzM4Mg==", "bodyText": "let's stick with the \"findAll\" prefix for consistency with other DAOs, so \"findAllOnceAndStream?", "url": "https://github.com/google/ground-android/pull/425#discussion_r409853382", "createdAt": "2020-04-16T21:16:34Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -268,7 +268,7 @@ public Completable applyAndEnqueue(FeatureMutation mutation) {\n   @Override\n   public Flowable<ImmutableSet<Tile>> getTilesOnceAndStream() {\n     return tileDao\n-        .findAll()\n+        .getTilesOnceAndStream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1Mzc0NA==", "bodyText": "Nit: Please use natural word order for readability: TEST_PENDING_TILE here and below.", "url": "https://github.com/google/ground-android/pull/425#discussion_r409853744", "createdAt": "2020-04-16T21:17:26Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -67,97 +66,138 @@\n @Config(application = TestApplication.class)\n public class LocalDataStoreTest {\n \n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_TILE_PENDING =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1NDUwNg==", "bodyText": "One asserts that something Xs, so here it would be assertObservationMutationEquals.\nBut this also does something extra, so should be reflected in the name, e.g.:\nassertEqualsIgnoreId.\nWe can omit \"ObservationMutation\" from the name for brevity since it will be clear from the arguments what's being compared.", "url": "https://github.com/google/ground-android/pull/425#discussion_r409854506", "createdAt": "2020-04-16T21:18:58Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -67,97 +66,138 @@\n @Config(application = TestApplication.class)\n public class LocalDataStoreTest {\n \n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_TILE_PENDING =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_TILE_DOWNLOADED =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_TILE_FAILED =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n   // This rule makes sure that Room executes all the database operations instantly.\n   @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n \n   @Inject LocalDataStore localDataStore;\n \n-  private static User createTestUser() {\n-    return User.builder()\n-        .setId(\"test_user_id\")\n-        .setEmail(\"test@gmail.com\")\n-        .setDisplayName(\"test user\")\n-        .build();\n-  }\n-\n-  private static Project createTestProject() {\n-    Builder multipleChoiceBuilder =\n-        MultipleChoice.newBuilder().setCardinality(Cardinality.SELECT_ONE);\n-    multipleChoiceBuilder\n-        .optionsBuilder()\n-        .add(Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build())\n-        .add(Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build());\n-\n-    Field field =\n-        Field.newBuilder()\n-            .setId(\"field id\")\n-            .setLabel(\"field label\")\n-            .setRequired(false)\n-            .setType(Type.MULTIPLE_CHOICE)\n-            .setMultipleChoice(multipleChoiceBuilder.build())\n-            .build();\n-\n-    Element element = Element.ofField(field);\n-\n-    Form form =\n-        Form.newBuilder()\n-            .setId(\"form id\")\n-            .setElements(ImmutableList.<Element>builder().add(element).build())\n-            .build();\n-\n-    Layer layer =\n-        Layer.newBuilder()\n-            .setId(\"layer id\")\n-            .setItemLabel(\"item label\")\n-            .setListHeading(\"heading title\")\n-            .setDefaultStyle(Style.builder().setColor(\"000\").build())\n-            .setForm(form)\n-            .build();\n-\n-    Project.Builder builder =\n-        Project.newBuilder()\n-            .setId(\"project id\")\n-            .setTitle(\"project 1\")\n-            .setDescription(\"foo description\");\n-    builder.putLayer(layer.getId(), layer);\n-    return builder.build();\n-  }\n-\n-  private static FeatureMutation createTestFeatureMutation(\n-      String userId, String projectId, String layerId) {\n-    return FeatureMutation.builder()\n-        .setId(1L)\n-        .setType(Mutation.Type.CREATE)\n-        .setUserId(userId)\n-        .setProjectId(projectId)\n-        .setFeatureId(\"feature id\")\n-        .setLayerId(layerId)\n-        .setNewLocation(\n-            Optional.ofNullable(Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build()))\n-        .setClientTimestamp(new Date())\n-        .build();\n+  private static void assertObservationMutation(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 189}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1NTU0MQ==", "bodyText": "Let's use Google Truth consistently here and throughout to set a stable precedent and to get more useful error messages. i.e. assertThat(actual).isEqualTo(expected).", "url": "https://github.com/google/ground-android/pull/425#discussion_r409855541", "createdAt": "2020-04-16T21:21:09Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -67,97 +66,138 @@\n @Config(application = TestApplication.class)\n public class LocalDataStoreTest {\n \n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_TILE_PENDING =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_TILE_DOWNLOADED =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_TILE_FAILED =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n   // This rule makes sure that Room executes all the database operations instantly.\n   @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n \n   @Inject LocalDataStore localDataStore;\n \n-  private static User createTestUser() {\n-    return User.builder()\n-        .setId(\"test_user_id\")\n-        .setEmail(\"test@gmail.com\")\n-        .setDisplayName(\"test user\")\n-        .build();\n-  }\n-\n-  private static Project createTestProject() {\n-    Builder multipleChoiceBuilder =\n-        MultipleChoice.newBuilder().setCardinality(Cardinality.SELECT_ONE);\n-    multipleChoiceBuilder\n-        .optionsBuilder()\n-        .add(Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build())\n-        .add(Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build());\n-\n-    Field field =\n-        Field.newBuilder()\n-            .setId(\"field id\")\n-            .setLabel(\"field label\")\n-            .setRequired(false)\n-            .setType(Type.MULTIPLE_CHOICE)\n-            .setMultipleChoice(multipleChoiceBuilder.build())\n-            .build();\n-\n-    Element element = Element.ofField(field);\n-\n-    Form form =\n-        Form.newBuilder()\n-            .setId(\"form id\")\n-            .setElements(ImmutableList.<Element>builder().add(element).build())\n-            .build();\n-\n-    Layer layer =\n-        Layer.newBuilder()\n-            .setId(\"layer id\")\n-            .setItemLabel(\"item label\")\n-            .setListHeading(\"heading title\")\n-            .setDefaultStyle(Style.builder().setColor(\"000\").build())\n-            .setForm(form)\n-            .build();\n-\n-    Project.Builder builder =\n-        Project.newBuilder()\n-            .setId(\"project id\")\n-            .setTitle(\"project 1\")\n-            .setDescription(\"foo description\");\n-    builder.putLayer(layer.getId(), layer);\n-    return builder.build();\n-  }\n-\n-  private static FeatureMutation createTestFeatureMutation(\n-      String userId, String projectId, String layerId) {\n-    return FeatureMutation.builder()\n-        .setId(1L)\n-        .setType(Mutation.Type.CREATE)\n-        .setUserId(userId)\n-        .setProjectId(projectId)\n-        .setFeatureId(\"feature id\")\n-        .setLayerId(layerId)\n-        .setNewLocation(\n-            Optional.ofNullable(Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build()))\n-        .setClientTimestamp(new Date())\n-        .build();\n+  private static void assertObservationMutation(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    Assert.assertEquals(expected, actual);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 195}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1NjQ2NA==", "bodyText": "Same here: https://truth.dev/\nPlease be sure to use static imports to make assertions more fluent.", "url": "https://github.com/google/ground-android/pull/425#discussion_r409856464", "createdAt": "2020-04-16T21:23:02Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -67,97 +66,138 @@\n @Config(application = TestApplication.class)\n public class LocalDataStoreTest {\n \n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_TILE_PENDING =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_TILE_DOWNLOADED =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_TILE_FAILED =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n   // This rule makes sure that Room executes all the database operations instantly.\n   @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n \n   @Inject LocalDataStore localDataStore;\n \n-  private static User createTestUser() {\n-    return User.builder()\n-        .setId(\"test_user_id\")\n-        .setEmail(\"test@gmail.com\")\n-        .setDisplayName(\"test user\")\n-        .build();\n-  }\n-\n-  private static Project createTestProject() {\n-    Builder multipleChoiceBuilder =\n-        MultipleChoice.newBuilder().setCardinality(Cardinality.SELECT_ONE);\n-    multipleChoiceBuilder\n-        .optionsBuilder()\n-        .add(Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build())\n-        .add(Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build());\n-\n-    Field field =\n-        Field.newBuilder()\n-            .setId(\"field id\")\n-            .setLabel(\"field label\")\n-            .setRequired(false)\n-            .setType(Type.MULTIPLE_CHOICE)\n-            .setMultipleChoice(multipleChoiceBuilder.build())\n-            .build();\n-\n-    Element element = Element.ofField(field);\n-\n-    Form form =\n-        Form.newBuilder()\n-            .setId(\"form id\")\n-            .setElements(ImmutableList.<Element>builder().add(element).build())\n-            .build();\n-\n-    Layer layer =\n-        Layer.newBuilder()\n-            .setId(\"layer id\")\n-            .setItemLabel(\"item label\")\n-            .setListHeading(\"heading title\")\n-            .setDefaultStyle(Style.builder().setColor(\"000\").build())\n-            .setForm(form)\n-            .build();\n-\n-    Project.Builder builder =\n-        Project.newBuilder()\n-            .setId(\"project id\")\n-            .setTitle(\"project 1\")\n-            .setDescription(\"foo description\");\n-    builder.putLayer(layer.getId(), layer);\n-    return builder.build();\n-  }\n-\n-  private static FeatureMutation createTestFeatureMutation(\n-      String userId, String projectId, String layerId) {\n-    return FeatureMutation.builder()\n-        .setId(1L)\n-        .setType(Mutation.Type.CREATE)\n-        .setUserId(userId)\n-        .setProjectId(projectId)\n-        .setFeatureId(\"feature id\")\n-        .setLayerId(layerId)\n-        .setNewLocation(\n-            Optional.ofNullable(Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build()))\n-        .setClientTimestamp(new Date())\n-        .build();\n+  private static void assertObservationMutation(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    Assert.assertEquals(expected, actual);\n   }\n \n-  private static ObservationMutation createTestObservationMutation(\n-      String projectId, String featureId, String layerId, String formId, String userId) {\n-    return ObservationMutation.builder()\n-        .setType(Mutation.Type.CREATE)\n-        .setProjectId(projectId)\n-        .setFeatureId(featureId)\n-        .setLayerId(layerId)\n-        .setObservationId(\"observation id\")\n-        .setFormId(formId)\n-        .setResponseDeltas(\n-            ImmutableList.<ResponseDelta>builder()\n-                .add(\n-                    ResponseDelta.builder()\n-                        .setFieldId(\"field id\")\n-                        .setNewResponse(TextResponse.fromString(\"response for field id\"))\n-                        .build())\n-                .build())\n-        .setClientTimestamp(new Date())\n-        .setUserId(userId)\n-        .build();\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    Assert.assertEquals(mutation.getObservationId(), observation.getId());\n+    Assert.assertEquals(mutation.getFeatureId(), observation.getFeature().getId());\n+    Assert.assertEquals(TEST_USER, observation.getCreated().getUser());\n+    Assert.assertEquals(TEST_FORM, observation.getForm());\n+    Assert.assertEquals(TEST_PROJECT, observation.getProject());\n+    Assert.assertEquals(TEST_USER, observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 225}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1NjgxNA==", "bodyText": "Please use constants directly, here and throughout; extra indirection makes tests [marginally] harder to ready.", "url": "https://github.com/google/ground-android/pull/425#discussion_r409856814", "createdAt": "2020-04-16T21:23:41Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -167,137 +207,97 @@ public void setUp() {\n \n   @Test\n   public void testGetProjects() {\n-    Project project1 =\n-        Project.newBuilder()\n-            .setId(\"id 1\")\n-            .setTitle(\"project 1\")\n-            .setDescription(\"foo description\")\n-            .build();\n-    Project project2 =\n-        Project.newBuilder()\n-            .setId(\"id 2\")\n-            .setTitle(\"project 2\")\n-            .setDescription(\"foo description 2\")\n-            .build();\n-    localDataStore.insertOrUpdateProject(project1).test().assertComplete();\n-    localDataStore.insertOrUpdateProject(project2).test().assertComplete();\n-    localDataStore\n-        .getProjects()\n-        .test()\n-        .assertValue(ImmutableList.<Project>builder().add(project1, project2).build());\n+    Project project = TEST_PROJECT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 253}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1NzE3Nw==", "bodyText": "Please use blocking* instead of subscribe here and throughout.", "url": "https://github.com/google/ground-android/pull/425#discussion_r409857177", "createdAt": "2020-04-16T21:24:23Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -167,137 +207,97 @@ public void setUp() {\n \n   @Test\n   public void testGetProjects() {\n-    Project project1 =\n-        Project.newBuilder()\n-            .setId(\"id 1\")\n-            .setTitle(\"project 1\")\n-            .setDescription(\"foo description\")\n-            .build();\n-    Project project2 =\n-        Project.newBuilder()\n-            .setId(\"id 2\")\n-            .setTitle(\"project 2\")\n-            .setDescription(\"foo description 2\")\n-            .build();\n-    localDataStore.insertOrUpdateProject(project1).test().assertComplete();\n-    localDataStore.insertOrUpdateProject(project2).test().assertComplete();\n-    localDataStore\n-        .getProjects()\n-        .test()\n-        .assertValue(ImmutableList.<Project>builder().add(project1, project2).build());\n+    Project project = TEST_PROJECT;\n+    localDataStore.insertOrUpdateProject(project).subscribe();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(project));\n   }\n \n   @Test\n   public void testGetProjectById() {\n-    Project project = createTestProject();\n-    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    Project project = TEST_PROJECT;\n+    localDataStore.insertOrUpdateProject(project).subscribe();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 263}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1ODk1Nw==", "bodyText": "Can this entire block be replaced with:\n   localDataStore.getFeature(TEST_PROJECT, mutation.getFeatureId()).test().assertValue(TEST_FEATURE);\n\n?", "url": "https://github.com/google/ground-android/pull/425#discussion_r409858957", "createdAt": "2020-04-16T21:28:13Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -167,137 +207,97 @@ public void setUp() {\n \n   @Test\n   public void testGetProjects() {\n-    Project project1 =\n-        Project.newBuilder()\n-            .setId(\"id 1\")\n-            .setTitle(\"project 1\")\n-            .setDescription(\"foo description\")\n-            .build();\n-    Project project2 =\n-        Project.newBuilder()\n-            .setId(\"id 2\")\n-            .setTitle(\"project 2\")\n-            .setDescription(\"foo description 2\")\n-            .build();\n-    localDataStore.insertOrUpdateProject(project1).test().assertComplete();\n-    localDataStore.insertOrUpdateProject(project2).test().assertComplete();\n-    localDataStore\n-        .getProjects()\n-        .test()\n-        .assertValue(ImmutableList.<Project>builder().add(project1, project2).build());\n+    Project project = TEST_PROJECT;\n+    localDataStore.insertOrUpdateProject(project).subscribe();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(project));\n   }\n \n   @Test\n   public void testGetProjectById() {\n-    Project project = createTestProject();\n-    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    Project project = TEST_PROJECT;\n+    localDataStore.insertOrUpdateProject(project).subscribe();\n     localDataStore.getProjectById(project.getId()).test().assertValue(project);\n   }\n \n   @Test\n   public void testDeleteProject() {\n-    Project project = createTestProject();\n-    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    Project project = TEST_PROJECT;\n+    localDataStore.insertOrUpdateProject(project).subscribe();\n     localDataStore.deleteProject(project).test().assertComplete();\n     localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n   }\n \n   @Test\n   public void testGetUser() {\n-    User user = createTestUser();\n-    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n+    User user = TEST_USER;\n+    localDataStore.insertOrUpdateUser(user).subscribe();\n     localDataStore.getUser(user.getId()).test().assertValue(user);\n   }\n \n   @Test\n   public void testApplyAndEnqueue_featureMutation() {\n-    User user = createTestUser();\n-    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n-\n-    Project project = createTestProject();\n-    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n+    localDataStore.insertOrUpdateUser(TEST_USER).subscribe();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).subscribe();\n \n-    Layer layer = project.getLayers().get(0);\n-    FeatureMutation mutation =\n-        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;\n     localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n \n-    ImmutableList<Mutation> savedMutations =\n-        localDataStore.getPendingMutations(mutation.getFeatureId()).blockingGet();\n-    Assert.assertEquals(1, savedMutations.size());\n-\n     // assert that mutation is saved to local database\n-    FeatureMutation savedMutation = (FeatureMutation) savedMutations.get(0);\n-    Assert.assertEquals(mutation.getNewLocation(), savedMutation.getNewLocation());\n-    Assert.assertEquals(mutation.getType(), savedMutation.getType());\n-    Assert.assertEquals(mutation.getUserId(), savedMutation.getUserId());\n-    Assert.assertEquals(mutation.getProjectId(), savedMutation.getProjectId());\n-    Assert.assertEquals(mutation.getFeatureId(), savedMutation.getFeatureId());\n-    Assert.assertEquals(mutation.getLayerId(), savedMutation.getLayerId());\n-    Assert.assertEquals(mutation.getClientTimestamp(), savedMutation.getClientTimestamp());\n-    Assert.assertEquals(0, savedMutation.getRetryCount());\n-    Assert.assertNull(savedMutation.getLastError());\n+    localDataStore\n+        .getPendingMutations(mutation.getFeatureId())\n+        .test()\n+        .assertValue(ImmutableList.of(mutation));\n \n     // assert feature is saved to local database\n-    Feature feature = localDataStore.getFeature(project, mutation.getFeatureId()).blockingGet();\n+    Feature feature =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 324}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDA1Mg==", "bodyText": "You probably will also want to assertThat(mutation).isInstanceOf(ObservationMutation.class)", "url": "https://github.com/google/ground-android/pull/425#discussion_r409860052", "createdAt": "2020-04-16T21:30:31Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -352,136 +341,75 @@ public void testMergeFeature() {\n     Feature newFeature = localDataStore.getFeature(project, mutation.getFeatureId()).blockingGet();\n     Assert.assertEquals(mutation.getFeatureId(), newFeature.getId());\n     Assert.assertEquals(project, newFeature.getProject());\n-    Assert.assertEquals(layer.getItemLabel(), newFeature.getTitle());\n-    Assert.assertEquals(layer, newFeature.getLayer());\n+    Assert.assertEquals(TEST_LAYER.getItemLabel(), newFeature.getTitle());\n+    Assert.assertEquals(TEST_LAYER, newFeature.getLayer());\n     Assert.assertNull(newFeature.getCustomId());\n     Assert.assertNull(newFeature.getCaption());\n     Assert.assertEquals(point, newFeature.getPoint());\n-    Assert.assertEquals(user, newFeature.getCreated().getUser());\n-    Assert.assertEquals(user, newFeature.getLastModified().getUser());\n+    Assert.assertEquals(TEST_USER, newFeature.getCreated().getUser());\n+    Assert.assertEquals(TEST_USER, newFeature.getLastModified().getUser());\n   }\n \n   @Test\n   public void testApplyAndEnqueue_observationMutation() {\n-    User user = createTestUser();\n-    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n-\n-    Project project = createTestProject();\n-    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n-\n-    Layer layer = project.getLayers().get(0);\n-    FeatureMutation featureMutation =\n-        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n-    localDataStore.applyAndEnqueue(featureMutation).test().assertComplete();\n-\n-    ObservationMutation mutation =\n-        createTestObservationMutation(\n-            project.getId(),\n-            featureMutation.getFeatureId(),\n-            layer.getId(),\n-            layer.getForm().get().getId(),\n-            user.getId());\n+    localDataStore.insertOrUpdateUser(TEST_USER).subscribe();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).subscribe();\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).subscribe();\n+\n+    ObservationMutation mutation = TEST_OBSERVATION_MUTATION;\n     localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n \n     ImmutableList<Mutation> savedMutations =\n         localDataStore.getPendingMutations(mutation.getFeatureId()).blockingGet();\n     Assert.assertEquals(2, savedMutations.size());\n-\n     // ignoring the first item, which is a FeatureMutation. Already tested separately.\n-    ObservationMutation savedMutation = (ObservationMutation) savedMutations.get(1);\n-    Assert.assertEquals(mutation.getResponseDeltas(), savedMutation.getResponseDeltas());\n-    Assert.assertEquals(mutation.getType(), savedMutation.getType());\n-    Assert.assertEquals(mutation.getUserId(), savedMutation.getUserId());\n-    Assert.assertEquals(mutation.getProjectId(), savedMutation.getProjectId());\n-    Assert.assertEquals(mutation.getFeatureId(), savedMutation.getFeatureId());\n-    Assert.assertEquals(layer.getId(), savedMutation.getLayerId());\n-    Assert.assertEquals(mutation.getClientTimestamp(), savedMutation.getClientTimestamp());\n-    Assert.assertEquals(0, savedMutation.getRetryCount());\n-    Assert.assertNull(savedMutation.getLastError());\n+    assertObservationMutation(mutation, (ObservationMutation) savedMutations.get(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 512}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2MDYxMw==", "bodyText": "Please replace secondary assertions (i.e. those that don't test the behavior in question) with blocking*(). If those code paths don't already have their own tests, please be sure to add them.", "url": "https://github.com/google/ground-android/pull/425#discussion_r409860613", "createdAt": "2020-04-16T21:31:46Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -352,136 +341,75 @@ public void testMergeFeature() {\n     Feature newFeature = localDataStore.getFeature(project, mutation.getFeatureId()).blockingGet();\n     Assert.assertEquals(mutation.getFeatureId(), newFeature.getId());\n     Assert.assertEquals(project, newFeature.getProject());\n-    Assert.assertEquals(layer.getItemLabel(), newFeature.getTitle());\n-    Assert.assertEquals(layer, newFeature.getLayer());\n+    Assert.assertEquals(TEST_LAYER.getItemLabel(), newFeature.getTitle());\n+    Assert.assertEquals(TEST_LAYER, newFeature.getLayer());\n     Assert.assertNull(newFeature.getCustomId());\n     Assert.assertNull(newFeature.getCaption());\n     Assert.assertEquals(point, newFeature.getPoint());\n-    Assert.assertEquals(user, newFeature.getCreated().getUser());\n-    Assert.assertEquals(user, newFeature.getLastModified().getUser());\n+    Assert.assertEquals(TEST_USER, newFeature.getCreated().getUser());\n+    Assert.assertEquals(TEST_USER, newFeature.getLastModified().getUser());\n   }\n \n   @Test\n   public void testApplyAndEnqueue_observationMutation() {\n-    User user = createTestUser();\n-    localDataStore.insertOrUpdateUser(user).test().assertComplete();\n-\n-    Project project = createTestProject();\n-    localDataStore.insertOrUpdateProject(project).test().assertComplete();\n-\n-    Layer layer = project.getLayers().get(0);\n-    FeatureMutation featureMutation =\n-        createTestFeatureMutation(user.getId(), project.getId(), layer.getId());\n-    localDataStore.applyAndEnqueue(featureMutation).test().assertComplete();\n-\n-    ObservationMutation mutation =\n-        createTestObservationMutation(\n-            project.getId(),\n-            featureMutation.getFeatureId(),\n-            layer.getId(),\n-            layer.getForm().get().getId(),\n-            user.getId());\n+    localDataStore.insertOrUpdateUser(TEST_USER).subscribe();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).subscribe();\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).subscribe();\n+\n+    ObservationMutation mutation = TEST_OBSERVATION_MUTATION;\n     localDataStore.applyAndEnqueue(mutation).test().assertComplete();\n \n     ImmutableList<Mutation> savedMutations =\n         localDataStore.getPendingMutations(mutation.getFeatureId()).blockingGet();\n     Assert.assertEquals(2, savedMutations.size());\n-\n     // ignoring the first item, which is a FeatureMutation. Already tested separately.\n-    ObservationMutation savedMutation = (ObservationMutation) savedMutations.get(1);\n-    Assert.assertEquals(mutation.getResponseDeltas(), savedMutation.getResponseDeltas());\n-    Assert.assertEquals(mutation.getType(), savedMutation.getType());\n-    Assert.assertEquals(mutation.getUserId(), savedMutation.getUserId());\n-    Assert.assertEquals(mutation.getProjectId(), savedMutation.getProjectId());\n-    Assert.assertEquals(mutation.getFeatureId(), savedMutation.getFeatureId());\n-    Assert.assertEquals(layer.getId(), savedMutation.getLayerId());\n-    Assert.assertEquals(mutation.getClientTimestamp(), savedMutation.getClientTimestamp());\n-    Assert.assertEquals(0, savedMutation.getRetryCount());\n-    Assert.assertNull(savedMutation.getLastError());\n+    assertObservationMutation(mutation, (ObservationMutation) savedMutations.get(1));\n \n     // check if the observation was saved properly to local database\n-    Feature feature = localDataStore.getFeature(project, mutation.getFeatureId()).blockingGet();\n+    Feature feature =\n+        localDataStore.getFeature(TEST_PROJECT, mutation.getFeatureId()).blockingGet();\n     Observation observation =\n         localDataStore.getObservation(feature, mutation.getObservationId()).blockingGet();\n-    Assert.assertEquals(mutation.getObservationId(), observation.getId());\n-    Assert.assertEquals(user, observation.getCreated().getUser());\n-    Assert.assertEquals(feature, observation.getFeature());\n-    Assert.assertEquals(layer.getForm().get(), observation.getForm());\n-    Assert.assertEquals(project, observation.getProject());\n-    Assert.assertEquals(user, observation.getLastModified().getUser());\n-    MatcherAssert.assertThat(\n-        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n-        samePropertyValuesAs(observation.getResponses()));\n+    assertObservation(mutation, observation);\n \n     // now update the inserted observation with new responses\n     ImmutableList<ResponseDelta> deltas =\n-        ImmutableList.<ResponseDelta>builder()\n-            .add(\n-                ResponseDelta.builder()\n-                    .setFieldId(\"really new field\")\n-                    .setNewResponse(TextResponse.fromString(\"value for the really new field\"))\n-                    .build())\n-            .build();\n+        ImmutableList.of(\n+            ResponseDelta.builder()\n+                .setFieldId(\"really new field\")\n+                .setNewResponse(TextResponse.fromString(\"value for the really new field\"))\n+                .build());\n     mutation = mutation.toBuilder().setResponseDeltas(deltas).setType(Mutation.Type.UPDATE).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbcfe556d9d7c343cf2ac9f95d7d01dee76089a7"}, "originalPosition": 545}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c495f77b7802df078b3d1bd6bfb78ce766826365", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/c495f77b7802df078b3d1bd6bfb78ce766826365", "committedDate": "2020-04-17T06:29:06Z", "message": "Fix method name findAllOnceAndStream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0bd194dc5b55f1ef6498f1c338154f3ae769e85", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a0bd194dc5b55f1ef6498f1c338154f3ae769e85", "committedDate": "2020-04-17T06:32:00Z", "message": "Fix natural naming order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfcfecdf0164ce25b6d87cb4d78c57144b104afe", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/dfcfecdf0164ce25b6d87cb4d78c57144b104afe", "committedDate": "2020-04-17T06:38:35Z", "message": "Improve helper assert method name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e02384441ddb428103dbb68657590c049f01ad4", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/1e02384441ddb428103dbb68657590c049f01ad4", "committedDate": "2020-04-17T06:52:23Z", "message": "Replace junit.Assert with Google Truth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e50af6cc8315c7970d1bd2a49e6c9a0f617060b8", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e50af6cc8315c7970d1bd2a49e6c9a0f617060b8", "committedDate": "2020-04-17T07:00:49Z", "message": "Factor out common assertions for asserting feature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "879d7ee73982f120b1e3dd7811350092693f09f6", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/879d7ee73982f120b1e3dd7811350092693f09f6", "committedDate": "2020-04-17T07:03:43Z", "message": "Use hasSize to assert size of collections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b2bbf38215527803511a9bc849e0bd0d71aaae3", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/3b2bbf38215527803511a9bc849e0bd0d71aaae3", "committedDate": "2020-04-17T07:21:05Z", "message": "Use static strings wherever possible to improve test readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d7cafb993fccb364473c1302cac776d06773648", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/6d7cafb993fccb364473c1302cac776d06773648", "committedDate": "2020-04-17T07:26:25Z", "message": "Replace subscribe by blockingAwait"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b34f16498c2f775fceb4fa2730b59cc2d24db7f6", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/b34f16498c2f775fceb4fa2730b59cc2d24db7f6", "committedDate": "2020-04-17T07:29:39Z", "message": "Add tests for the remaining paths"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8e208e7d5821a4aad43553e0aa9a3d4ca39c93c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e8e208e7d5821a4aad43553e0aa9a3d4ca39c93c", "committedDate": "2020-04-17T08:19:12Z", "message": "Add test for asserting instance type of mutation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/761beb1cb735a763ac3b42a577be73b8274f2cd6", "committedDate": "2020-04-17T08:22:11Z", "message": "Add missing semicolon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MDc0MzYx", "url": "https://github.com/google/ground-android/pull/425#pullrequestreview-396074361", "createdAt": "2020-04-19T23:19:34Z", "commit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQyMzoxOTozNVrOGH-UvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQyMzozNDozM1rOGH-f1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNDMzMg==", "bodyText": "Did you try setting value = \"UUF_UNUSED_PUBLIC_OR_PROTECTED_FIELD\" in the annotation?", "url": "https://github.com/google/ground-android/pull/425#discussion_r411014332", "createdAt": "2020-04-19T23:19:35Z", "author": {"login": "gino-m"}, "path": "config/spotbugs/spotbugs-filter.xml", "diffHunk": "@@ -80,4 +81,7 @@\n   <Match>\n     <Bug pattern=\"UWF_FIELD_NOT_INITIALIZED_IN_CONSTRUCTOR\" />\n   </Match>\n+  <Match>\n+    <Bug pattern=\"URF_UNREAD_PUBLIC_OR_PROTECTED_FIELD\" />", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4Njg0MA=="}, "originalCommit": {"oid": "14749960635afa4a4e6dd97065a3999ef2f1dd9c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNDcyNQ==", "bodyText": "Naming nit: assert that observation is what? assertEquivalent?", "url": "https://github.com/google/ground-android/pull/425#discussion_r411014725", "createdAt": "2020-04-19T23:21:17Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 191}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNDc5MQ==", "bodyText": "Seems a bit surprising that this method would compare to constant values - should we be looking instead at the user, form, project in the mutation instead?", "url": "https://github.com/google/ground-android/pull/425#discussion_r411014791", "createdAt": "2020-04-19T23:21:47Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 194}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNDkyNg==", "bodyText": "Same here - the name seems to be missing what is actually being asserted (i.e. or it seems to imply it's just checking that the supplied value is a feature)", "url": "https://github.com/google/ground-android/pull/425#discussion_r411014926", "createdAt": "2020-04-19T23:22:34Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNDk3Nw==", "bodyText": "Same comment here re constants.", "url": "https://github.com/google/ground-android/pull/425#discussion_r411014977", "createdAt": "2020-04-19T23:22:50Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {\n+    assertThat(featureId).isEqualTo(feature.getId());\n+    assertThat(TEST_PROJECT).isEqualTo(feature.getProject());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 205}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNTI4NQ==", "bodyText": "In testDeleteProject we checked that the project was actually deleted. Should we do the same here for user insertion? The method could then be called testInsertAndGetUser and the next method deleted.", "url": "https://github.com/google/ground-android/pull/425#discussion_r411015285", "createdAt": "2020-04-19T23:24:11Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {\n+    assertThat(featureId).isEqualTo(feature.getId());\n+    assertThat(TEST_PROJECT).isEqualTo(feature.getProject());\n+    assertThat(TEST_LAYER.getItemLabel()).isEqualTo(feature.getTitle());\n+    assertThat(TEST_LAYER).isEqualTo(feature.getLayer());\n+    assertThat(feature.getCustomId()).isNull();\n+    assertThat(feature.getCaption()).isNull();\n+    assertThat(point).isEqualTo(feature.getPoint());\n+    assertThat(TEST_USER).isEqualTo(feature.getCreated().getUser());\n+    assertThat(TEST_USER).isEqualTo(feature.getLastModified().getUser());\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testInsertProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(TEST_PROJECT));\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjectById(\"project id\").test().assertValue(TEST_PROJECT);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.deleteProject(TEST_PROJECT).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testInsertUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).test().assertComplete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 246}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNjA4MQ==", "bodyText": "Since we check this at the end of the method, do we also need to check it here?", "url": "https://github.com/google/ground-android/pull/425#discussion_r411016081", "createdAt": "2020-04-19T23:28:42Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {\n+    assertThat(featureId).isEqualTo(feature.getId());\n+    assertThat(TEST_PROJECT).isEqualTo(feature.getProject());\n+    assertThat(TEST_LAYER.getItemLabel()).isEqualTo(feature.getTitle());\n+    assertThat(TEST_LAYER).isEqualTo(feature.getLayer());\n+    assertThat(feature.getCustomId()).isNull();\n+    assertThat(feature.getCaption()).isNull();\n+    assertThat(point).isEqualTo(feature.getPoint());\n+    assertThat(TEST_USER).isEqualTo(feature.getCreated().getUser());\n+    assertThat(TEST_USER).isEqualTo(feature.getLastModified().getUser());\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testInsertProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(TEST_PROJECT));\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjectById(\"project id\").test().assertValue(TEST_PROJECT);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.deleteProject(TEST_PROJECT).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testInsertUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.getUser(\"user id\").test().assertValue(TEST_USER);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).test().assertComplete();\n+\n+    // assert that mutation is saved to local database\n+    localDataStore\n+        .getPendingMutations(\"feature id\")\n+        .test()\n+        .assertValue(ImmutableList.of(TEST_FEATURE_MUTATION));\n+\n+    // assert feature is saved to local database\n+    Feature feature = localDataStore.getFeature(TEST_PROJECT, \"feature id\").blockingGet();\n+    assertFeature(\"feature id\", TEST_POINT, feature);\n+  }\n+\n+  @Test\n+  public void testGetFeaturesOnceAndStream() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    TestSubscriber<ImmutableSet<Feature>> subscriber =\n+        localDataStore.getFeaturesOnceAndStream(TEST_PROJECT).test();\n+\n+    subscriber.assertValueCount(1);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 282}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNjEzOA==", "bodyText": "Please inline this variable since it always contains a constant.", "url": "https://github.com/google/ground-android/pull/425#discussion_r411016138", "createdAt": "2020-04-19T23:28:56Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {\n+    assertThat(featureId).isEqualTo(feature.getId());\n+    assertThat(TEST_PROJECT).isEqualTo(feature.getProject());\n+    assertThat(TEST_LAYER.getItemLabel()).isEqualTo(feature.getTitle());\n+    assertThat(TEST_LAYER).isEqualTo(feature.getLayer());\n+    assertThat(feature.getCustomId()).isNull();\n+    assertThat(feature.getCaption()).isNull();\n+    assertThat(point).isEqualTo(feature.getPoint());\n+    assertThat(TEST_USER).isEqualTo(feature.getCreated().getUser());\n+    assertThat(TEST_USER).isEqualTo(feature.getLastModified().getUser());\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testInsertProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(TEST_PROJECT));\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjectById(\"project id\").test().assertValue(TEST_PROJECT);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.deleteProject(TEST_PROJECT).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testInsertUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.getUser(\"user id\").test().assertValue(TEST_USER);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).test().assertComplete();\n+\n+    // assert that mutation is saved to local database\n+    localDataStore\n+        .getPendingMutations(\"feature id\")\n+        .test()\n+        .assertValue(ImmutableList.of(TEST_FEATURE_MUTATION));\n+\n+    // assert feature is saved to local database\n+    Feature feature = localDataStore.getFeature(TEST_PROJECT, \"feature id\").blockingGet();\n+    assertFeature(\"feature id\", TEST_POINT, feature);\n+  }\n+\n+  @Test\n+  public void testGetFeaturesOnceAndStream() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    TestSubscriber<ImmutableSet<Feature>> subscriber =\n+        localDataStore.getFeaturesOnceAndStream(TEST_PROJECT).test();\n+\n+    subscriber.assertValueCount(1);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 284}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNjE4OQ==", "bodyText": "We could also use subscriber.assertValues() here instead of two assertValueAt calls.", "url": "https://github.com/google/ground-android/pull/425#discussion_r411016189", "createdAt": "2020-04-19T23:29:19Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {\n+    assertThat(featureId).isEqualTo(feature.getId());\n+    assertThat(TEST_PROJECT).isEqualTo(feature.getProject());\n+    assertThat(TEST_LAYER.getItemLabel()).isEqualTo(feature.getTitle());\n+    assertThat(TEST_LAYER).isEqualTo(feature.getLayer());\n+    assertThat(feature.getCustomId()).isNull();\n+    assertThat(feature.getCaption()).isNull();\n+    assertThat(point).isEqualTo(feature.getPoint());\n+    assertThat(TEST_USER).isEqualTo(feature.getCreated().getUser());\n+    assertThat(TEST_USER).isEqualTo(feature.getLastModified().getUser());\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testInsertProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(TEST_PROJECT));\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjectById(\"project id\").test().assertValue(TEST_PROJECT);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.deleteProject(TEST_PROJECT).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testInsertUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.getUser(\"user id\").test().assertValue(TEST_USER);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).test().assertComplete();\n+\n+    // assert that mutation is saved to local database\n+    localDataStore\n+        .getPendingMutations(\"feature id\")\n+        .test()\n+        .assertValue(ImmutableList.of(TEST_FEATURE_MUTATION));\n+\n+    // assert feature is saved to local database\n+    Feature feature = localDataStore.getFeature(TEST_PROJECT, \"feature id\").blockingGet();\n+    assertFeature(\"feature id\", TEST_POINT, feature);\n+  }\n+\n+  @Test\n+  public void testGetFeaturesOnceAndStream() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    TestSubscriber<ImmutableSet<Feature>> subscriber =\n+        localDataStore.getFeaturesOnceAndStream(TEST_PROJECT).test();\n+\n+    subscriber.assertValueCount(1);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;\n+    localDataStore.applyAndEnqueue(mutation).blockingAwait();\n+\n+    Feature feature =\n+        localDataStore.getFeature(TEST_PROJECT, mutation.getFeatureId()).blockingGet();\n+\n+    subscriber.assertValueCount(2);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 291}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNjIwOA==", "bodyText": "Please inline.", "url": "https://github.com/google/ground-android/pull/425#discussion_r411016208", "createdAt": "2020-04-19T23:29:26Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {\n+    assertThat(featureId).isEqualTo(feature.getId());\n+    assertThat(TEST_PROJECT).isEqualTo(feature.getProject());\n+    assertThat(TEST_LAYER.getItemLabel()).isEqualTo(feature.getTitle());\n+    assertThat(TEST_LAYER).isEqualTo(feature.getLayer());\n+    assertThat(feature.getCustomId()).isNull();\n+    assertThat(feature.getCaption()).isNull();\n+    assertThat(point).isEqualTo(feature.getPoint());\n+    assertThat(TEST_USER).isEqualTo(feature.getCreated().getUser());\n+    assertThat(TEST_USER).isEqualTo(feature.getLastModified().getUser());\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testInsertProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(TEST_PROJECT));\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjectById(\"project id\").test().assertValue(TEST_PROJECT);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.deleteProject(TEST_PROJECT).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testInsertUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.getUser(\"user id\").test().assertValue(TEST_USER);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).test().assertComplete();\n+\n+    // assert that mutation is saved to local database\n+    localDataStore\n+        .getPendingMutations(\"feature id\")\n+        .test()\n+        .assertValue(ImmutableList.of(TEST_FEATURE_MUTATION));\n+\n+    // assert feature is saved to local database\n+    Feature feature = localDataStore.getFeature(TEST_PROJECT, \"feature id\").blockingGet();\n+    assertFeature(\"feature id\", TEST_POINT, feature);\n+  }\n+\n+  @Test\n+  public void testGetFeaturesOnceAndStream() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    TestSubscriber<ImmutableSet<Feature>> subscriber =\n+        localDataStore.getFeaturesOnceAndStream(TEST_PROJECT).test();\n+\n+    subscriber.assertValueCount(1);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;\n+    localDataStore.applyAndEnqueue(mutation).blockingAwait();\n+\n+    Feature feature =\n+        localDataStore.getFeature(TEST_PROJECT, mutation.getFeatureId()).blockingGet();\n+\n+    subscriber.assertValueCount(2);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+    subscriber.assertValueAt(1, ImmutableSet.of(feature));\n+  }\n+\n+  @Test\n+  public void testUpdateMutations() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 300}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNjM2Mg==", "bodyText": "Shall we create a constant, TEST_POINT_2, for example, for use here and throughout instead? Otherwise it may seem like these values might have special meaning.\nAlso, consider creating a constructor method createTestFeatureMutation(point) that you can use for both cases.", "url": "https://github.com/google/ground-android/pull/425#discussion_r411016362", "createdAt": "2020-04-19T23:30:09Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {\n+    assertThat(featureId).isEqualTo(feature.getId());\n+    assertThat(TEST_PROJECT).isEqualTo(feature.getProject());\n+    assertThat(TEST_LAYER.getItemLabel()).isEqualTo(feature.getTitle());\n+    assertThat(TEST_LAYER).isEqualTo(feature.getLayer());\n+    assertThat(feature.getCustomId()).isNull();\n+    assertThat(feature.getCaption()).isNull();\n+    assertThat(point).isEqualTo(feature.getPoint());\n+    assertThat(TEST_USER).isEqualTo(feature.getCreated().getUser());\n+    assertThat(TEST_USER).isEqualTo(feature.getLastModified().getUser());\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testInsertProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(TEST_PROJECT));\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjectById(\"project id\").test().assertValue(TEST_PROJECT);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.deleteProject(TEST_PROJECT).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testInsertUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.getUser(\"user id\").test().assertValue(TEST_USER);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).test().assertComplete();\n+\n+    // assert that mutation is saved to local database\n+    localDataStore\n+        .getPendingMutations(\"feature id\")\n+        .test()\n+        .assertValue(ImmutableList.of(TEST_FEATURE_MUTATION));\n+\n+    // assert feature is saved to local database\n+    Feature feature = localDataStore.getFeature(TEST_PROJECT, \"feature id\").blockingGet();\n+    assertFeature(\"feature id\", TEST_POINT, feature);\n+  }\n+\n+  @Test\n+  public void testGetFeaturesOnceAndStream() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    TestSubscriber<ImmutableSet<Feature>> subscriber =\n+        localDataStore.getFeaturesOnceAndStream(TEST_PROJECT).test();\n+\n+    subscriber.assertValueCount(1);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;\n+    localDataStore.applyAndEnqueue(mutation).blockingAwait();\n+\n+    Feature feature =\n+        localDataStore.getFeature(TEST_PROJECT, mutation.getFeatureId()).blockingGet();\n+\n+    subscriber.assertValueCount(2);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+    subscriber.assertValueAt(1, ImmutableSet.of(feature));\n+  }\n+\n+  @Test\n+  public void testUpdateMutations() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;\n+    localDataStore.applyAndEnqueue(mutation).blockingAwait();\n+\n+    Point newPoint = Point.newBuilder().setLatitude(51.0).setLongitude(44.0).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 303}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNjk1Ng==", "bodyText": "Please use assertThat(savedMutations).containsExactly instead of hasSize, get, isEqualTo.", "url": "https://github.com/google/ground-android/pull/425#discussion_r411016956", "createdAt": "2020-04-19T23:33:33Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {\n+    assertThat(featureId).isEqualTo(feature.getId());\n+    assertThat(TEST_PROJECT).isEqualTo(feature.getProject());\n+    assertThat(TEST_LAYER.getItemLabel()).isEqualTo(feature.getTitle());\n+    assertThat(TEST_LAYER).isEqualTo(feature.getLayer());\n+    assertThat(feature.getCustomId()).isNull();\n+    assertThat(feature.getCaption()).isNull();\n+    assertThat(point).isEqualTo(feature.getPoint());\n+    assertThat(TEST_USER).isEqualTo(feature.getCreated().getUser());\n+    assertThat(TEST_USER).isEqualTo(feature.getLastModified().getUser());\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testInsertProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(TEST_PROJECT));\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjectById(\"project id\").test().assertValue(TEST_PROJECT);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.deleteProject(TEST_PROJECT).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testInsertUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.getUser(\"user id\").test().assertValue(TEST_USER);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).test().assertComplete();\n+\n+    // assert that mutation is saved to local database\n+    localDataStore\n+        .getPendingMutations(\"feature id\")\n+        .test()\n+        .assertValue(ImmutableList.of(TEST_FEATURE_MUTATION));\n+\n+    // assert feature is saved to local database\n+    Feature feature = localDataStore.getFeature(TEST_PROJECT, \"feature id\").blockingGet();\n+    assertFeature(\"feature id\", TEST_POINT, feature);\n+  }\n+\n+  @Test\n+  public void testGetFeaturesOnceAndStream() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    TestSubscriber<ImmutableSet<Feature>> subscriber =\n+        localDataStore.getFeaturesOnceAndStream(TEST_PROJECT).test();\n+\n+    subscriber.assertValueCount(1);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;\n+    localDataStore.applyAndEnqueue(mutation).blockingAwait();\n+\n+    Feature feature =\n+        localDataStore.getFeature(TEST_PROJECT, mutation.getFeatureId()).blockingGet();\n+\n+    subscriber.assertValueCount(2);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+    subscriber.assertValueAt(1, ImmutableSet.of(feature));\n+  }\n+\n+  @Test\n+  public void testUpdateMutations() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;\n+    localDataStore.applyAndEnqueue(mutation).blockingAwait();\n+\n+    Point newPoint = Point.newBuilder().setLatitude(51.0).setLongitude(44.0).build();\n+    Mutation updatedMutation =\n+        mutation.toBuilder().setNewLocation(Optional.ofNullable(newPoint)).build();\n+\n+    localDataStore.updateMutations(ImmutableList.of(updatedMutation)).test().assertComplete();\n+\n+    ImmutableList<Mutation> savedMutations =\n+        localDataStore.getPendingMutations(updatedMutation.getFeatureId()).blockingGet();\n+    assertThat(savedMutations).hasSize(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 311}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTAxNzE3NA==", "bodyText": "Same here re containsExactly. I think it will also check the type for you.", "url": "https://github.com/google/ground-android/pull/425#discussion_r411017174", "createdAt": "2020-04-19T23:34:33Z", "author": {"login": "gino-m"}, "path": "gnd/src/test/java/com/google/android/gnd/persistence/local/LocalDataStoreTest.java", "diffHunk": "@@ -0,0 +1,480 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.android.gnd.persistence.local;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.hamcrest.Matchers.samePropertyValuesAs;\n+\n+import androidx.arch.core.executor.testing.InstantTaskExecutorRule;\n+import com.google.android.gms.maps.model.LatLng;\n+import com.google.android.gms.maps.model.LatLngBounds;\n+import com.google.android.gnd.TestApplication;\n+import com.google.android.gnd.inject.DaggerTestComponent;\n+import com.google.android.gnd.model.Mutation;\n+import com.google.android.gnd.model.Project;\n+import com.google.android.gnd.model.User;\n+import com.google.android.gnd.model.basemap.OfflineArea;\n+import com.google.android.gnd.model.basemap.tile.Tile;\n+import com.google.android.gnd.model.basemap.tile.Tile.State;\n+import com.google.android.gnd.model.feature.Feature;\n+import com.google.android.gnd.model.feature.FeatureMutation;\n+import com.google.android.gnd.model.feature.Point;\n+import com.google.android.gnd.model.form.Element;\n+import com.google.android.gnd.model.form.Field;\n+import com.google.android.gnd.model.form.Field.Type;\n+import com.google.android.gnd.model.form.Form;\n+import com.google.android.gnd.model.form.MultipleChoice;\n+import com.google.android.gnd.model.form.MultipleChoice.Cardinality;\n+import com.google.android.gnd.model.form.Option;\n+import com.google.android.gnd.model.layer.Layer;\n+import com.google.android.gnd.model.layer.Style;\n+import com.google.android.gnd.model.observation.Observation;\n+import com.google.android.gnd.model.observation.ObservationMutation;\n+import com.google.android.gnd.model.observation.ResponseDelta;\n+import com.google.android.gnd.model.observation.ResponseMap;\n+import com.google.android.gnd.model.observation.TextResponse;\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.ImmutableSet;\n+import io.reactivex.subscribers.TestSubscriber;\n+import java.util.AbstractCollection;\n+import java.util.Date;\n+import java8.util.Optional;\n+import javax.inject.Inject;\n+import org.hamcrest.MatcherAssert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(application = TestApplication.class)\n+public class LocalDataStoreTest {\n+\n+  private static final User TEST_USER =\n+      User.builder().setId(\"user id\").setEmail(\"user@gmail.com\").setDisplayName(\"user 1\").build();\n+\n+  private static final MultipleChoice TEST_MULTIPLE_CHOICE =\n+      MultipleChoice.newBuilder()\n+          .setCardinality(Cardinality.SELECT_ONE)\n+          .setOptions(\n+              ImmutableList.of(\n+                  Option.newBuilder().setCode(\"a\").setLabel(\"Name\").build(),\n+                  Option.newBuilder().setCode(\"b\").setLabel(\"Age\").build()))\n+          .build();\n+\n+  private static final Field TEST_FIELD =\n+      Field.newBuilder()\n+          .setId(\"field id\")\n+          .setLabel(\"field label\")\n+          .setRequired(false)\n+          .setType(Type.MULTIPLE_CHOICE)\n+          .setMultipleChoice(TEST_MULTIPLE_CHOICE)\n+          .build();\n+\n+  private static final Form TEST_FORM =\n+      Form.newBuilder()\n+          .setId(\"form id\")\n+          .setElements(ImmutableList.of(Element.ofField(TEST_FIELD)))\n+          .build();\n+\n+  private static final Layer TEST_LAYER =\n+      Layer.newBuilder()\n+          .setId(\"layer id\")\n+          .setItemLabel(\"item label\")\n+          .setListHeading(\"heading title\")\n+          .setDefaultStyle(Style.builder().setColor(\"000\").build())\n+          .setForm(TEST_FORM)\n+          .build();\n+\n+  private static final Project TEST_PROJECT =\n+      Project.newBuilder()\n+          .setId(\"project id\")\n+          .setTitle(\"project 1\")\n+          .setDescription(\"foo description\")\n+          .putLayer(\"layer id\", TEST_LAYER)\n+          .build();\n+\n+  private static final Point TEST_POINT =\n+      Point.newBuilder().setLatitude(110.0).setLongitude(-23.1).build();\n+\n+  private static final FeatureMutation TEST_FEATURE_MUTATION =\n+      FeatureMutation.builder()\n+          .setId(1L)\n+          .setFeatureId(\"feature id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setUserId(\"user id\")\n+          .setProjectId(\"project id\")\n+          .setLayerId(\"layer id\")\n+          .setNewLocation(Optional.ofNullable(TEST_POINT))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final ObservationMutation TEST_OBSERVATION_MUTATION =\n+      ObservationMutation.builder()\n+          .setObservationId(\"observation id\")\n+          .setType(Mutation.Type.CREATE)\n+          .setProjectId(\"project id\")\n+          .setFeatureId(\"feature id\")\n+          .setLayerId(\"layer id\")\n+          .setFormId(\"form id\")\n+          .setUserId(\"user id\")\n+          .setResponseDeltas(\n+              ImmutableList.of(\n+                  ResponseDelta.builder()\n+                      .setFieldId(\"field id\")\n+                      .setNewResponse(TextResponse.fromString(\"response for field id\"))\n+                      .build()))\n+          .setClientTimestamp(new Date())\n+          .build();\n+\n+  private static final Tile TEST_PENDING_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_1\")\n+          .setState(State.PENDING)\n+          .setPath(\"some_path 1\")\n+          .setUrl(\"some_url 1\")\n+          .build();\n+\n+  private static final Tile TEST_DOWNLOADED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_2\")\n+          .setState(State.DOWNLOADED)\n+          .setPath(\"some_path 2\")\n+          .setUrl(\"some_url 2\")\n+          .build();\n+\n+  private static final Tile TEST_FAILED_TILE =\n+      Tile.newBuilder()\n+          .setId(\"id_3\")\n+          .setState(State.FAILED)\n+          .setPath(\"some_path 3\")\n+          .setUrl(\"some_url 3\")\n+          .build();\n+\n+  private static final OfflineArea TEST_OFFLINE_AREA =\n+      OfflineArea.newBuilder()\n+          .setId(\"id_1\")\n+          .setBounds(LatLngBounds.builder().include(new LatLng(0.0, 0.0)).build())\n+          .setState(OfflineArea.State.PENDING)\n+          .build();\n+\n+  // This rule makes sure that Room executes all the database operations instantly.\n+  @Rule public InstantTaskExecutorRule instantTaskExecutorRule = new InstantTaskExecutorRule();\n+\n+  @Inject LocalDataStore localDataStore;\n+\n+  private static void assertEqualsIgnoreId(\n+      ObservationMutation expected, ObservationMutation actual) {\n+    // TODO: Id is auto-assigned to ObservationMutation.\n+    //  If we try to give it while inserting, then it causes problems. Improve this behavior.\n+    //  So, copy the id from actual to expected and then compare the objects.\n+    expected = expected.toBuilder().setId(actual.getId()).build();\n+    assertThat(expected).isEqualTo(actual);\n+  }\n+\n+  private static void assertObservation(ObservationMutation mutation, Observation observation) {\n+    assertThat(mutation.getObservationId()).isEqualTo(observation.getId());\n+    assertThat(mutation.getFeatureId()).isEqualTo(observation.getFeature().getId());\n+    assertThat(TEST_USER).isEqualTo(observation.getCreated().getUser());\n+    assertThat(TEST_FORM).isEqualTo(observation.getForm());\n+    assertThat(TEST_PROJECT).isEqualTo(observation.getProject());\n+    assertThat(TEST_USER).isEqualTo(observation.getLastModified().getUser());\n+    MatcherAssert.assertThat(\n+        ResponseMap.builder().applyDeltas(mutation.getResponseDeltas()).build(),\n+        samePropertyValuesAs(observation.getResponses()));\n+  }\n+\n+  private static void assertFeature(String featureId, Point point, Feature feature) {\n+    assertThat(featureId).isEqualTo(feature.getId());\n+    assertThat(TEST_PROJECT).isEqualTo(feature.getProject());\n+    assertThat(TEST_LAYER.getItemLabel()).isEqualTo(feature.getTitle());\n+    assertThat(TEST_LAYER).isEqualTo(feature.getLayer());\n+    assertThat(feature.getCustomId()).isNull();\n+    assertThat(feature.getCaption()).isNull();\n+    assertThat(point).isEqualTo(feature.getPoint());\n+    assertThat(TEST_USER).isEqualTo(feature.getCreated().getUser());\n+    assertThat(TEST_USER).isEqualTo(feature.getLastModified().getUser());\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    DaggerTestComponent.create().inject(this);\n+  }\n+\n+  @Test\n+  public void testInsertProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetProjects() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjects().test().assertValue(ImmutableList.of(TEST_PROJECT));\n+  }\n+\n+  @Test\n+  public void testGetProjectById() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.getProjectById(\"project id\").test().assertValue(TEST_PROJECT);\n+  }\n+\n+  @Test\n+  public void testDeleteProject() {\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.deleteProject(TEST_PROJECT).test().assertComplete();\n+    localDataStore.getProjects().test().assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testInsertUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).test().assertComplete();\n+  }\n+\n+  @Test\n+  public void testGetUser() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.getUser(\"user id\").test().assertValue(TEST_USER);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_featureMutation() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).test().assertComplete();\n+\n+    // assert that mutation is saved to local database\n+    localDataStore\n+        .getPendingMutations(\"feature id\")\n+        .test()\n+        .assertValue(ImmutableList.of(TEST_FEATURE_MUTATION));\n+\n+    // assert feature is saved to local database\n+    Feature feature = localDataStore.getFeature(TEST_PROJECT, \"feature id\").blockingGet();\n+    assertFeature(\"feature id\", TEST_POINT, feature);\n+  }\n+\n+  @Test\n+  public void testGetFeaturesOnceAndStream() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    TestSubscriber<ImmutableSet<Feature>> subscriber =\n+        localDataStore.getFeaturesOnceAndStream(TEST_PROJECT).test();\n+\n+    subscriber.assertValueCount(1);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;\n+    localDataStore.applyAndEnqueue(mutation).blockingAwait();\n+\n+    Feature feature =\n+        localDataStore.getFeature(TEST_PROJECT, mutation.getFeatureId()).blockingGet();\n+\n+    subscriber.assertValueCount(2);\n+    subscriber.assertValueAt(0, AbstractCollection::isEmpty);\n+    subscriber.assertValueAt(1, ImmutableSet.of(feature));\n+  }\n+\n+  @Test\n+  public void testUpdateMutations() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+\n+    FeatureMutation mutation = TEST_FEATURE_MUTATION;\n+    localDataStore.applyAndEnqueue(mutation).blockingAwait();\n+\n+    Point newPoint = Point.newBuilder().setLatitude(51.0).setLongitude(44.0).build();\n+    Mutation updatedMutation =\n+        mutation.toBuilder().setNewLocation(Optional.ofNullable(newPoint)).build();\n+\n+    localDataStore.updateMutations(ImmutableList.of(updatedMutation)).test().assertComplete();\n+\n+    ImmutableList<Mutation> savedMutations =\n+        localDataStore.getPendingMutations(updatedMutation.getFeatureId()).blockingGet();\n+    assertThat(savedMutations).hasSize(1);\n+\n+    FeatureMutation savedMutation = (FeatureMutation) savedMutations.get(0);\n+    assertThat(newPoint).isEqualTo(savedMutation.getNewLocation().get());\n+  }\n+\n+  @Test\n+  public void testRemovePendingMutation() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).blockingAwait();\n+\n+    localDataStore\n+        .removePendingMutations(ImmutableList.of(TEST_FEATURE_MUTATION))\n+        .test()\n+        .assertComplete();\n+\n+    localDataStore\n+        .getPendingMutations(\"feature id\")\n+        .test()\n+        .assertValue(AbstractCollection::isEmpty);\n+  }\n+\n+  @Test\n+  public void testMergeFeature() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).blockingAwait();\n+\n+    Feature feature = localDataStore.getFeature(TEST_PROJECT, \"feature id\").blockingGet();\n+    Point point = Point.newBuilder().setLongitude(11.0).setLatitude(33.0).build();\n+    feature = feature.toBuilder().setPoint(point).build();\n+    localDataStore.mergeFeature(feature).test().assertComplete();\n+\n+    Feature newFeature = localDataStore.getFeature(TEST_PROJECT, \"feature id\").blockingGet();\n+    assertFeature(\"feature id\", point, newFeature);\n+  }\n+\n+  @Test\n+  public void testApplyAndEnqueue_observationMutation() {\n+    localDataStore.insertOrUpdateUser(TEST_USER).blockingAwait();\n+    localDataStore.insertOrUpdateProject(TEST_PROJECT).blockingAwait();\n+    localDataStore.applyAndEnqueue(TEST_FEATURE_MUTATION).blockingAwait();\n+\n+    localDataStore.applyAndEnqueue(TEST_OBSERVATION_MUTATION).test().assertComplete();\n+\n+    ImmutableList<Mutation> savedMutations =\n+        localDataStore.getPendingMutations(\"feature id\").blockingGet();\n+    assertThat(savedMutations).hasSize(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761beb1cb735a763ac3b42a577be73b8274f2cd6"}, "originalPosition": 359}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76dd61abf1b3b456fe227211a4a872fe25738aa1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/76dd61abf1b3b456fe227211a4a872fe25738aa1", "committedDate": "2020-04-21T15:49:53Z", "message": "Merge branch 'master' into testing\n\n# Conflicts:\n#\tgnd/build.gradle\n#\tgnd/src/main/java/com/google/android/gnd/persistence/local/LocalDataStore.java\n#\tgnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f1cd41fa37f61ec46c7231b22991b2652368c51", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/1f1cd41fa37f61ec46c7231b22991b2652368c51", "committedDate": "2020-04-21T15:54:31Z", "message": "Fix merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f74d29f2686816ee5e428802146783fcf1fa39c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/4f74d29f2686816ee5e428802146783fcf1fa39c", "committedDate": "2020-04-21T16:41:10Z", "message": "Assign ids to observation mutation test data\n\n - This allows us to compare the objects directly instead of having to compare one-by-one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2761a5ab9bd4132639eecc151f2a577001f9acde", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/2761a5ab9bd4132639eecc151f2a577001f9acde", "committedDate": "2020-04-21T17:13:08Z", "message": "Create test point 2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0778b6a25cc50b3169e445bb9c3703558d9d3c06", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/0778b6a25cc50b3169e445bb9c3703558d9d3c06", "committedDate": "2020-04-21T17:25:04Z", "message": "Create test feature mutation using helper method\n\n - this is to interchange POINT at ease"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "922711c0f11d1643173b42eb7ae3ef07f0a4d00d", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/922711c0f11d1643173b42eb7ae3ef07f0a4d00d", "committedDate": "2020-04-21T17:41:08Z", "message": "Assert streaming events all at once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "743120839642fb7ee34c7d26baf65362a51d433a", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/743120839642fb7ee34c7d26baf65362a51d433a", "committedDate": "2020-04-21T17:43:00Z", "message": "inline variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62fbb0344a6bce840de65a8c27e04df262f5c53c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/62fbb0344a6bce840de65a8c27e04df262f5c53c", "committedDate": "2020-04-21T17:46:38Z", "message": "Combine together insert and get tests for project and user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a13efb166f1b37a7c5a514131a8b64b701ada5d1", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a13efb166f1b37a7c5a514131a8b64b701ada5d1", "committedDate": "2020-04-21T18:02:15Z", "message": "Remove assertFeature method\n\n - we were mostly comparing static values. so moved those assertions directly instead of verifying the entire object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8538d608ce52d1e8f7039614156025609d8f941", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a8538d608ce52d1e8f7039614156025609d8f941", "committedDate": "2020-04-21T19:05:55Z", "message": "Merge branch 'master' into testing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1773, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}