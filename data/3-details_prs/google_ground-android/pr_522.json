{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MjcwOTI4", "number": 522, "title": "[Manage observations] Add ability to remove observations", "bodyText": "Fixes #107", "createdAt": "2020-07-04T11:03:49Z", "url": "https://github.com/google/ground-android/pull/522", "merged": true, "mergeCommit": {"oid": "13d5812343ee68153b3f15af7cb0f12134ba2154"}, "closed": true, "closedAt": "2020-07-13T16:22:27Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyVxCkAFqTQ0MzMyMzQ0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0j7XiAFqTQ0NzQwNDYwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzIzNDQ0", "url": "https://github.com/google/ground-android/pull/522#pullrequestreview-443323444", "createdAt": "2020-07-06T18:43:52Z", "commit": {"oid": "ac5ae765a701b329f363d7b94b19539809325ed3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40eea3341ac36111fee65342b5a92cfe99c44efd", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/40eea3341ac36111fee65342b5a92cfe99c44efd", "committedDate": "2020-07-09T16:24:48Z", "message": "Change ActivityScoped to Singleton"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f9966ea07e6914c7ed96ab359d302fb53b89f01", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/8f9966ea07e6914c7ed96ab359d302fb53b89f01", "committedDate": "2020-07-09T16:24:48Z", "message": "Implement DELETE mutation handling in firestore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c778b878bbc5358744e1d72dfdd94b8886d2d7", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/b9c778b878bbc5358744e1d72dfdd94b8886d2d7", "committedDate": "2020-07-09T16:25:51Z", "message": "Add deleteObservation() method in ObservationRepository\n\n - Creates mutation in the local database\n - Enqueues worker\n - Replace Log -> Timber"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7db2c4a00ffc42ab89d61217a0b04b4ed32164b5", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/7db2c4a00ffc42ab89d61217a0b04b4ed32164b5", "committedDate": "2020-07-09T16:25:53Z", "message": "Add deleteObservation() in RoomLocalDataStore.\n\nAlso, exposes apply() and enqueue() methods publicly. This is so that we update the local database after deleting the observation from remote firestore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25581766f0a5889dc7f079638f44ea2bcfad5e1a", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/25581766f0a5889dc7f079638f44ea2bcfad5e1a", "committedDate": "2020-07-09T16:26:21Z", "message": "Delete observation from local db after remote sync succeeds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fca75b3883c02ecc3b95da69c18e8a96f0508623", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fca75b3883c02ecc3b95da69c18e8a96f0508623", "committedDate": "2020-07-09T16:26:31Z", "message": "Integrate delete observation implementation to the UI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e894269c2942912be01e3c5f1dd156eebd24af0c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e894269c2942912be01e3c5f1dd156eebd24af0c", "committedDate": "2020-07-09T16:26:33Z", "message": "Remove debug messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d081655e2450b8032ca0ad660db97f3b893b89ca", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d081655e2450b8032ca0ad660db97f3b893b89ca", "committedDate": "2020-07-09T16:26:33Z", "message": "Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "714fea2fc7a2d8f206a49528824afee9b097ac18", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/714fea2fc7a2d8f206a49528824afee9b097ac18", "committedDate": "2020-07-09T16:26:33Z", "message": "Add test for deleteObservation()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f68baa303b35e6d4026398a350bfc14741873d2", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/4f68baa303b35e6d4026398a350bfc14741873d2", "committedDate": "2020-07-09T16:26:33Z", "message": "Remove extra constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6df2a6cc24dee1cb01eb5ab4445a4a9b776a7160", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/6df2a6cc24dee1cb01eb5ab4445a4a9b776a7160", "committedDate": "2020-07-09T16:26:38Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81b70dff782710896bca710bc7dddc062d673208", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/81b70dff782710896bca710bc7dddc062d673208", "committedDate": "2020-07-09T16:26:40Z", "message": "Rename variable to observation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac5ae765a701b329f363d7b94b19539809325ed3", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/ac5ae765a701b329f363d7b94b19539809325ed3", "committedDate": "2020-07-06T15:47:54Z", "message": "Merge branch 'master' into delete-collection-firestore"}, "afterCommit": {"oid": "81b70dff782710896bca710bc7dddc062d673208", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/81b70dff782710896bca710bc7dddc062d673208", "committedDate": "2020-07-09T16:26:40Z", "message": "Rename variable to observation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86dcfbd0a06750382a15f66c33c580e49ae36535", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/86dcfbd0a06750382a15f66c33c580e49ae36535", "committedDate": "2020-07-09T17:11:07Z", "message": "Mark observation as deleted and delete only after sync finishes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODIxODY4", "url": "https://github.com/google/ground-android/pull/522#pullrequestreview-445821868", "createdAt": "2020-07-09T17:24:20Z", "commit": {"oid": "86dcfbd0a06750382a15f66c33c580e49ae36535"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5535db55bc8a564232efa57d3729263bff3a32b", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/c5535db55bc8a564232efa57d3729263bff3a32b", "committedDate": "2020-07-09T17:30:04Z", "message": "Update tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODU3NzQ4", "url": "https://github.com/google/ground-android/pull/522#pullrequestreview-445857748", "createdAt": "2020-07-09T18:15:48Z", "commit": {"oid": "c5535db55bc8a564232efa57d3729263bff3a32b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODoxNTo0OFrOGvcgkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxODoxNjoyOFrOGvch9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwMzM0Nw==", "bodyText": "Isn't this just another case of apply(ObservationMutation)? Adding a separate method would break this model, and it would mean there are many configurations of ObservationMutation that would be invalid and would need to be checked. Can we instead call the impl of this method via apply()?", "url": "https://github.com/google/ground-android/pull/522#discussion_r452403347", "createdAt": "2020-07-09T18:15:48Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/LocalDataStore.java", "diffHunk": "@@ -80,13 +81,25 @@\n    */\n   Completable applyAndEnqueue(ObservationMutation mutation);\n \n+  /** Applies the specified {@link ObservationMutation} to the local data store.. */\n+  Completable apply(ObservationMutation mutation) throws LocalDataStoreException;\n+\n+  /** Appends the specified {@link ObservationMutation} to the local queue for remote sync. */\n+  Completable enqueue(ObservationMutation mutation);\n+\n+  /** Deletes local observation entry. */\n+  Completable deleteObservation(ObservationMutation mutation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5535db55bc8a564232efa57d3729263bff3a32b"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwMzcwMw==", "bodyText": "Can we implement this in the DAO instead?", "url": "https://github.com/google/ground-android/pull/522#discussion_r452403703", "createdAt": "2020-07-09T18:16:28Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -260,6 +261,8 @@ public Completable applyAndEnqueue(FeatureMutation mutation) {\n         .map(\n             list ->\n                 stream(list)\n+                    .filter(\n+                        observationEntity -> observationEntity.getState() != EntityState.DELETED)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5535db55bc8a564232efa57d3729263bff3a32b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f6dbff01b22a6021eb4b6f1a9eaec5696b10e15", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/7f6dbff01b22a6021eb4b6f1a9eaec5696b10e15", "committedDate": "2020-07-10T04:12:43Z", "message": "Merge implementation for mark delete / delete in apply"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32bcc02ee81377ece2e13b2a22576849b607a972", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/32bcc02ee81377ece2e13b2a22576849b607a972", "committedDate": "2020-07-10T04:16:30Z", "message": "Remove duplicate filter\n\nObservationDao already contains where clause: state = 1 (DEFAULT)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5532f0504c67b4c7168d71b3db35868291165c0", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/c5532f0504c67b4c7168d71b3db35868291165c0", "committedDate": "2020-07-10T04:29:04Z", "message": "Improve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abac476b9055826472416faa4d4152407c25de81", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/abac476b9055826472416faa4d4152407c25de81", "committedDate": "2020-07-10T04:49:13Z", "message": "Update unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7e79c28cafef0f46d4c085afc3df08da8cf56c9", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f7e79c28cafef0f46d4c085afc3df08da8cf56c9", "committedDate": "2020-07-10T05:10:02Z", "message": "Also assert local entity's state in unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8260190bd6f291a516712202322b4685d3959c54", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/8260190bd6f291a516712202322b4685d3959c54", "committedDate": "2020-07-10T05:24:04Z", "message": "Fix indentation level"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NDc1NjIw", "url": "https://github.com/google/ground-android/pull/522#pullrequestreview-446475620", "createdAt": "2020-07-10T15:02:58Z", "commit": {"oid": "8260190bd6f291a516712202322b4685d3959c54"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNTowMjo1OVrOGv61yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNTowMjo1OVrOGv61yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkwMDI5Ng==", "bodyText": "This logic is not idempotent, which can lead to issues wrt order and timing of mutations; if you call it once, it will do something different than if you call it twice.\nIt's not clear to me when/how the second mutation to delete the entity would occur. Wouldn't it occur at a lower level, once the remote observation is actually removed (i.e. not via the mutation interface)?", "url": "https://github.com/google/ground-android/pull/522#discussion_r452900296", "createdAt": "2020-07-10T15:02:59Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -424,8 +427,25 @@ public Completable apply(ObservationMutation mutation) throws LocalDataStoreExce\n         return getUser(mutation.getUserId())\n             .flatMapCompletable(user -> updateObservation(mutation, user));\n       case DELETE:\n-        return getUser(mutation.getUserId())\n-            .flatMapCompletable(user -> markObservationDeleted(mutation));\n+        return observationDao\n+            .findById(mutation.getObservationId())\n+            .flatMapCompletable(\n+                entity -> {\n+                  // Mark the ObservationEntity as DELETED if the current state is DEFAULT.\n+                  // Otherwise, delete the observation entity from local db.\n+                  //\n+                  // TODO: If the remote sync fails, reset the state to DEFAULT.\n+                  //\n+                  // Note: Observations marked as DELETED are not shown in UI.\n+                  //       See {@link ObservationDao}\n+                  if (entity.getState() == EntityState.DEFAULT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8260190bd6f291a516712202322b4685d3959c54"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3077b295cf5497f571d36e0bc3c15ede06fe396c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/3077b295cf5497f571d36e0bc3c15ede06fe396c", "committedDate": "2020-07-10T16:57:18Z", "message": "Separate mark and delete methods for readability"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NjY5NTk3", "url": "https://github.com/google/ground-android/pull/522#pullrequestreview-446669597", "createdAt": "2020-07-10T20:02:16Z", "commit": {"oid": "3077b295cf5497f571d36e0bc3c15ede06fe396c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDowMjoxNlrOGwEImQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQyMDowMjoxNlrOGwEImQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1MjU2OQ==", "bodyText": "Why don't we just delete the observation as soon as the remote observation is deleted inside applyMutations? Sorry if I'm missing something!", "url": "https://github.com/google/ground-android/pull/522#discussion_r453052569", "createdAt": "2020-07-10T20:02:16Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/sync/LocalMutationSyncWorker.java", "diffHunk": "@@ -112,17 +112,17 @@ private Completable processMutations(ImmutableList<Mutation> mutations, String u\n   private Completable processMutations(ImmutableList<Mutation> mutations, User user) {\n     return remoteDataStore\n         .applyMutations(mutations, user)\n-        .andThen(removeLocalObservationsIfMutationTypeIsDelete(mutations))\n+        .andThen(deleteObservationIfRemovedRemotely(mutations))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3077b295cf5497f571d36e0bc3c15ede06fe396c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDA0NjA5", "url": "https://github.com/google/ground-android/pull/522#pullrequestreview-447404609", "createdAt": "2020-07-13T16:21:40Z", "commit": {"oid": "3077b295cf5497f571d36e0bc3c15ede06fe396c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1590, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}