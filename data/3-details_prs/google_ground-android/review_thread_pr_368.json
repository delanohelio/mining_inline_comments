{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NzQ1Mjgx", "number": 368, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOToyMzowOFrODgfK2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOTozMTo0OVrODgfRFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MzkxNzA3OnYy", "diffSide": "RIGHT", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOToyMzowOFrOFquAnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOToyMzowOFrOFquAnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDMzODMzNQ==", "bodyText": "Wording here is unclear: True if the photo field has been updated?", "url": "https://github.com/google/ground-android/pull/368#discussion_r380338335", "createdAt": "2020-02-17T19:23:08Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -138,6 +138,9 @@\n   /** True if the observation is being added, false if editing an existing one. */\n   private boolean isNew;\n \n+  /** True if the photo field is immediately updated. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MzkyODAwOnYy", "diffSide": "RIGHT", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOToyOToxMVrOFquHPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoxODoxOFrOFrEBBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0MDAzMA==", "bodyText": "May be out of scope of this PR, but it would seem that saving the bitmap should be an asynchronous operation, whereas here it's modeled as a synchronous one.\nAlso, the Rx chain seems to be relying on side effects to do critical work, which is general not harder to debug and maintain. It might be clearer if this method would accept Bitmap instead of an Observable<Bitmap>, save and upload asynchronously, and return a Completable or Single<String> when done. Wdyt?", "url": "https://github.com/google/ground-android/pull/368#discussion_r380340030", "createdAt": "2020-02-17T19:29:11Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -267,6 +270,7 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n             })\n         .doOnNext(\n             url -> {\n+              isPhotoFieldUpdated = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ3NDA1Ng==", "bodyText": "We're handling the result of the activity before the state of the response is reset. To fix this, we should call the external intent from the activity and handle for results in onObservationLoaded after refreshResponseMap call.", "url": "https://github.com/google/ground-android/pull/368#discussion_r380474056", "createdAt": "2020-02-18T06:27:00Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -267,6 +270,7 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n             })\n         .doOnNext(\n             url -> {\n+              isPhotoFieldUpdated = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0MDAzMA=="}, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY5ODg4Ng==", "bodyText": "See comment below re isPhotoFieldUpdated.\nCould you kindly collapse the chained map and doOnNext into a single function and use a more appropriate Rx method for chaining? Might look something like this:\n  private Completable handlePhotoCaptureResult(String fieldId) {\n    return cameraManager\n        .capturePhotoResult()\n        .flatMapCompletable(bitmap -> saveBitmapAndUpdateResponse(bitmap, fieldId));\n  }\n\n  private Completable saveBitmapAndUpdateResponse(\n      Bitmap bitmap, String fieldId) {\n    String file = fileUtil.saveBitmap(bitmap, fieldId + \".jpg\");\n    String destinationPath = getRemoteImagePath(file.getName());\n    String url = firestoreStorageManager.uploadMediaFromFile(file, destinationPath);\n    isPhotoFieldUpdated = true;\n    onTextChanged(form.getValue().getField(fieldId).get(), url);\n    return Complete.complete()\n  }\nI assume we'd want capturePhotoResult() to run on the UI thread, and saveBitmapAndUpdateResponse() to run in the IO thread.  I vaguely remember downstream flatMap logic runs on the same thread as the upstream subscribers (defined with subscribeOn), while switchMap does not, but I can't find a reference for it.", "url": "https://github.com/google/ground-android/pull/368#discussion_r380698886", "createdAt": "2020-02-18T14:18:18Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -267,6 +270,7 @@ private Completable handlePhotoCaptureResult(String fieldId) {\n             })\n         .doOnNext(\n             url -> {\n+              isPhotoFieldUpdated = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0MDAzMA=="}, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MzkzMzAxOnYy", "diffSide": "RIGHT", "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxOTozMTo0OVrOFquKRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoxNToyNFrOFrD55Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0MDgwNw==", "bodyText": "Wouldn't this be equivalent to opening another app while editing the form? If so, how is this working today for non-photo fields, and why are photos different?", "url": "https://github.com/google/ground-android/pull/368#discussion_r380340807", "createdAt": "2020-02-17T19:31:49Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -316,7 +320,15 @@ public void onSaveClick() {\n \n   private void onObservationLoaded(Observation observation) {\n     this.originalObservation = observation;\n-    refreshResponseMap(observation);\n+\n+    // Photo field is updated by launching an external intent. This causes the form to reload.\n+    // When that happens, we don't want to lose the unsaved changes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ3NDMxMg==", "bodyText": "The reason is we handle the result of the photos before the response map is refreshed. As mentioned in the previous comment, this is a side-effect of an earlier pending refactor.", "url": "https://github.com/google/ground-android/pull/368#discussion_r380474312", "createdAt": "2020-02-18T06:28:02Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -316,7 +320,15 @@ public void onSaveClick() {\n \n   private void onObservationLoaded(Observation observation) {\n     this.originalObservation = observation;\n-    refreshResponseMap(observation);\n+\n+    // Photo field is updated by launching an external intent. This causes the form to reload.\n+    // When that happens, we don't want to lose the unsaved changes.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0MDgwNw=="}, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDY5NzA2MQ==", "bodyText": "If the initialize is getting called whenever we reopen the Fragment, I'm not sure how this is actually working today.  There are many reasons the fragment could get reinitialized; it's hard to name isPhotoFieldUpdated appropriately because it's not really well defined - iiuc it's asking \"am I being reinitialized because the user left to a photo intent and came back?\" In reality I don't think we can know that for sure, and as result there are likely many edge cases where this will fail.\nI may be a bit out of my depth on Android fragment/VM lifecycles, but I'll approve for now to unblock current work. @dturner, would you mind taking a look at the EditObservation* logic when you get a chance to see how we might improve?", "url": "https://github.com/google/ground-android/pull/368#discussion_r380697061", "createdAt": "2020-02-18T14:15:24Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/EditObservationViewModel.java", "diffHunk": "@@ -316,7 +320,15 @@ public void onSaveClick() {\n \n   private void onObservationLoaded(Observation observation) {\n     this.originalObservation = observation;\n-    refreshResponseMap(observation);\n+\n+    // Photo field is updated by launching an external intent. This causes the form to reload.\n+    // When that happens, we don't want to lose the unsaved changes.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDM0MDgwNw=="}, "originalCommit": {"oid": "d87d429d60a8b87eeb048c31e4fb344a8186fd91"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2611, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}