{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NTc2NTM2", "number": 666, "title": "[Feature] Fixes new point can't be added", "bodyText": "Fixes #661\nThings done:\n\nReplace Subject with interface\nRemove extra Rx call to invoke dialog\nRemove duplicate null check for project\nReuse parameter \"point\" instead of injecting\nLimit AddFeatureDialogFragment to only return layer and remove uuid generator and auth manager\nCreate new feature object in HomeScreenViewModel\n\n\n\n\n\n\n\n@gino-m  PTAL?", "createdAt": "2020-12-23T05:23:17Z", "url": "https://github.com/google/ground-android/pull/666", "merged": true, "mergeCommit": {"oid": "93d852a3361b5a34be6c7de7fc68355add2e468f"}, "closed": true, "closedAt": "2020-12-26T18:42:54Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdo4IiggH2gAyNTQ0NTc2NTM2OjM0NzdhZmQ3ZjM2ZWU0ODFmZGNlODBhMjRiOTY2NzAwODJlZmFhODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqAfmNAFqTU1ODg4NDEzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3477afd7f36ee481fdce80a24b96670082efaa84", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/3477afd7f36ee481fdce80a24b96670082efaa84", "committedDate": "2020-12-23T05:18:13Z", "message": "Fix new point can't be added bug\n\n - Replace Subject with interface\n - Remove extra Rx call to invoke dialog\n - Remove duplicate null check for project\n - Reuse parameter \"point\" instead of injecting\n - Restrict AddFeatureDialogFragment to only return layer and create feature object in VM"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3OTAyNjc0", "url": "https://github.com/google/ground-android/pull/666#pullrequestreview-557902674", "createdAt": "2020-12-23T14:31:04Z", "commit": {"oid": "3477afd7f36ee481fdce80a24b96670082efaa84"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNDozMTowNFrOIKmaow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNToyMToxNVrOIKn2dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk4NjA4Mw==", "bodyText": "@NonNull is the default now, so these annotations can be removed.", "url": "https://github.com/google/ground-android/pull/666#discussion_r547986083", "createdAt": "2020-12-23T14:31:04Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java", "diffHunk": "@@ -21,107 +21,74 @@\n \n import android.app.Dialog;\n import android.os.Bundle;\n+import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.model.AuditInfo;\n import com.google.android.gnd.model.Project;\n-import com.google.android.gnd.model.feature.Feature;\n-import com.google.android.gnd.model.feature.Point;\n import com.google.android.gnd.model.layer.Layer;\n-import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n-import com.google.android.gnd.rx.Loadable;\n-import com.google.android.gnd.system.auth.AuthenticationManager;\n import com.google.android.gnd.ui.common.AbstractDialogFragment;\n-import com.google.android.gnd.ui.home.mapcontainer.MapContainerViewModel;\n-import com.google.android.gnd.ui.map.CameraPosition;\n import com.google.common.collect.ImmutableList;\n import dagger.hilt.android.AndroidEntryPoint;\n-import io.reactivex.Maybe;\n-import io.reactivex.subjects.MaybeSubject;\n import java8.util.Objects;\n import javax.inject.Inject;\n+import timber.log.Timber;\n \n @AndroidEntryPoint\n public class AddFeatureDialogFragment extends AbstractDialogFragment {\n+\n   private static final String TAG = AddFeatureDialogFragment.class.getSimpleName();\n-  private final OfflineUuidGenerator uuidGenerator;\n-  private final AuthenticationManager authManager;\n \n-  private final MaybeSubject<Feature> addFeatureRequestSubject = MaybeSubject.create();\n-  private HomeScreenViewModel homeScreenViewModel;\n-  private MapContainerViewModel mapContainerViewModel;\n+  @Nullable private Project project;\n+  @Nullable private LayerSelectedListener listener;\n \n   @Inject\n-  public AddFeatureDialogFragment(\n-      OfflineUuidGenerator uuidGenerator, AuthenticationManager authManager) {\n-    this.uuidGenerator = uuidGenerator;\n-    this.authManager = authManager;\n-  }\n-\n-  @Override\n-  public void onCreate(@Nullable Bundle savedInstanceState) {\n-    super.onCreate(savedInstanceState);\n-    // TODO: Move into new AddFeatureDialogViewModel?\n-    this.homeScreenViewModel = getViewModel(HomeScreenViewModel.class);\n-    this.mapContainerViewModel = getViewModel(MapContainerViewModel.class);\n-  }\n+  public AddFeatureDialogFragment() {}\n \n-  public Maybe<Feature> show(FragmentManager fragmentManager) {\n+  public void show(\n+      @NonNull Project project,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3477afd7f36ee481fdce80a24b96670082efaa84"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk4NjM2Nw==", "bodyText": "Same here.", "url": "https://github.com/google/ground-android/pull/666#discussion_r547986367", "createdAt": "2020-12-23T14:31:39Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java", "diffHunk": "@@ -21,107 +21,74 @@\n \n import android.app.Dialog;\n import android.os.Bundle;\n+import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.model.AuditInfo;\n import com.google.android.gnd.model.Project;\n-import com.google.android.gnd.model.feature.Feature;\n-import com.google.android.gnd.model.feature.Point;\n import com.google.android.gnd.model.layer.Layer;\n-import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n-import com.google.android.gnd.rx.Loadable;\n-import com.google.android.gnd.system.auth.AuthenticationManager;\n import com.google.android.gnd.ui.common.AbstractDialogFragment;\n-import com.google.android.gnd.ui.home.mapcontainer.MapContainerViewModel;\n-import com.google.android.gnd.ui.map.CameraPosition;\n import com.google.common.collect.ImmutableList;\n import dagger.hilt.android.AndroidEntryPoint;\n-import io.reactivex.Maybe;\n-import io.reactivex.subjects.MaybeSubject;\n import java8.util.Objects;\n import javax.inject.Inject;\n+import timber.log.Timber;\n \n @AndroidEntryPoint\n public class AddFeatureDialogFragment extends AbstractDialogFragment {\n+\n   private static final String TAG = AddFeatureDialogFragment.class.getSimpleName();\n-  private final OfflineUuidGenerator uuidGenerator;\n-  private final AuthenticationManager authManager;\n \n-  private final MaybeSubject<Feature> addFeatureRequestSubject = MaybeSubject.create();\n-  private HomeScreenViewModel homeScreenViewModel;\n-  private MapContainerViewModel mapContainerViewModel;\n+  @Nullable private Project project;\n+  @Nullable private LayerSelectedListener listener;\n \n   @Inject\n-  public AddFeatureDialogFragment(\n-      OfflineUuidGenerator uuidGenerator, AuthenticationManager authManager) {\n-    this.uuidGenerator = uuidGenerator;\n-    this.authManager = authManager;\n-  }\n-\n-  @Override\n-  public void onCreate(@Nullable Bundle savedInstanceState) {\n-    super.onCreate(savedInstanceState);\n-    // TODO: Move into new AddFeatureDialogViewModel?\n-    this.homeScreenViewModel = getViewModel(HomeScreenViewModel.class);\n-    this.mapContainerViewModel = getViewModel(MapContainerViewModel.class);\n-  }\n+  public AddFeatureDialogFragment() {}\n \n-  public Maybe<Feature> show(FragmentManager fragmentManager) {\n+  public void show(\n+      @NonNull Project project,\n+      @NonNull FragmentManager fragmentManager,\n+      @NonNull LayerSelectedListener listener) {\n+    this.project = project;\n+    this.listener = listener;\n     show(fragmentManager, TAG);\n-    return addFeatureRequestSubject;\n   }\n \n+  @NonNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3477afd7f36ee481fdce80a24b96670082efaa84"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Nzk5MDEwMQ==", "bodyText": "Instantiating a new features, assigning UUID and AuditInfo sounds like a job for the FeatureRepository. Can we move this there? (newFeature?)", "url": "https://github.com/google/ground-android/pull/666#discussion_r547990101", "createdAt": "2020-12-23T14:40:09Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/HomeScreenViewModel.java", "diffHunk": "@@ -148,6 +159,20 @@ public void addFeature(Feature feature) {\n     addFeatureClicks.onNext(feature);\n   }\n \n+  public void addFeature(Project project, Layer layer, Point point) {\n+    AuditInfo auditInfo = AuditInfo.now(authManager.getCurrentUser());\n+    Feature feature =\n+        Feature.newBuilder()\n+            .setId(uuidGenerator.generateUuid())\n+            .setProject(project)\n+            .setLayer(layer)\n+            .setPoint(point)\n+            .setCreated(auditInfo)\n+            .setLastModified(auditInfo)\n+            .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3477afd7f36ee481fdce80a24b96670082efaa84"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODAwOTI0Ng==", "bodyText": "The listener reference should be removed to prevent memory leaks when the dialog is closed to prevent memory leaks. @dturner Please cmiiw.", "url": "https://github.com/google/ground-android/pull/666#discussion_r548009246", "createdAt": "2020-12-23T15:20:33Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java", "diffHunk": "@@ -21,107 +21,74 @@\n \n import android.app.Dialog;\n import android.os.Bundle;\n+import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.model.AuditInfo;\n import com.google.android.gnd.model.Project;\n-import com.google.android.gnd.model.feature.Feature;\n-import com.google.android.gnd.model.feature.Point;\n import com.google.android.gnd.model.layer.Layer;\n-import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n-import com.google.android.gnd.rx.Loadable;\n-import com.google.android.gnd.system.auth.AuthenticationManager;\n import com.google.android.gnd.ui.common.AbstractDialogFragment;\n-import com.google.android.gnd.ui.home.mapcontainer.MapContainerViewModel;\n-import com.google.android.gnd.ui.map.CameraPosition;\n import com.google.common.collect.ImmutableList;\n import dagger.hilt.android.AndroidEntryPoint;\n-import io.reactivex.Maybe;\n-import io.reactivex.subjects.MaybeSubject;\n import java8.util.Objects;\n import javax.inject.Inject;\n+import timber.log.Timber;\n \n @AndroidEntryPoint\n public class AddFeatureDialogFragment extends AbstractDialogFragment {\n+\n   private static final String TAG = AddFeatureDialogFragment.class.getSimpleName();\n-  private final OfflineUuidGenerator uuidGenerator;\n-  private final AuthenticationManager authManager;\n \n-  private final MaybeSubject<Feature> addFeatureRequestSubject = MaybeSubject.create();\n-  private HomeScreenViewModel homeScreenViewModel;\n-  private MapContainerViewModel mapContainerViewModel;\n+  @Nullable private Project project;\n+  @Nullable private LayerSelectedListener listener;\n \n   @Inject\n-  public AddFeatureDialogFragment(\n-      OfflineUuidGenerator uuidGenerator, AuthenticationManager authManager) {\n-    this.uuidGenerator = uuidGenerator;\n-    this.authManager = authManager;\n-  }\n-\n-  @Override\n-  public void onCreate(@Nullable Bundle savedInstanceState) {\n-    super.onCreate(savedInstanceState);\n-    // TODO: Move into new AddFeatureDialogViewModel?\n-    this.homeScreenViewModel = getViewModel(HomeScreenViewModel.class);\n-    this.mapContainerViewModel = getViewModel(MapContainerViewModel.class);\n-  }\n+  public AddFeatureDialogFragment() {}\n \n-  public Maybe<Feature> show(FragmentManager fragmentManager) {\n+  public void show(\n+      @NonNull Project project,\n+      @NonNull FragmentManager fragmentManager,\n+      @NonNull LayerSelectedListener listener) {\n+    this.project = project;\n+    this.listener = listener;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3477afd7f36ee481fdce80a24b96670082efaa84"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODAwOTU5MQ==", "bodyText": "Instead of defining a custom functional interface, you should be able to use Consumer<Layer>.", "url": "https://github.com/google/ground-android/pull/666#discussion_r548009591", "createdAt": "2020-12-23T15:21:15Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/home/AddFeatureDialogFragment.java", "diffHunk": "@@ -21,107 +21,74 @@\n \n import android.app.Dialog;\n import android.os.Bundle;\n+import androidx.annotation.NonNull;\n import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n import androidx.fragment.app.FragmentManager;\n import com.google.android.gnd.R;\n-import com.google.android.gnd.model.AuditInfo;\n import com.google.android.gnd.model.Project;\n-import com.google.android.gnd.model.feature.Feature;\n-import com.google.android.gnd.model.feature.Point;\n import com.google.android.gnd.model.layer.Layer;\n-import com.google.android.gnd.persistence.uuid.OfflineUuidGenerator;\n-import com.google.android.gnd.rx.Loadable;\n-import com.google.android.gnd.system.auth.AuthenticationManager;\n import com.google.android.gnd.ui.common.AbstractDialogFragment;\n-import com.google.android.gnd.ui.home.mapcontainer.MapContainerViewModel;\n-import com.google.android.gnd.ui.map.CameraPosition;\n import com.google.common.collect.ImmutableList;\n import dagger.hilt.android.AndroidEntryPoint;\n-import io.reactivex.Maybe;\n-import io.reactivex.subjects.MaybeSubject;\n import java8.util.Objects;\n import javax.inject.Inject;\n+import timber.log.Timber;\n \n @AndroidEntryPoint\n public class AddFeatureDialogFragment extends AbstractDialogFragment {\n+\n   private static final String TAG = AddFeatureDialogFragment.class.getSimpleName();\n-  private final OfflineUuidGenerator uuidGenerator;\n-  private final AuthenticationManager authManager;\n \n-  private final MaybeSubject<Feature> addFeatureRequestSubject = MaybeSubject.create();\n-  private HomeScreenViewModel homeScreenViewModel;\n-  private MapContainerViewModel mapContainerViewModel;\n+  @Nullable private Project project;\n+  @Nullable private LayerSelectedListener listener;\n \n   @Inject\n-  public AddFeatureDialogFragment(\n-      OfflineUuidGenerator uuidGenerator, AuthenticationManager authManager) {\n-    this.uuidGenerator = uuidGenerator;\n-    this.authManager = authManager;\n-  }\n-\n-  @Override\n-  public void onCreate(@Nullable Bundle savedInstanceState) {\n-    super.onCreate(savedInstanceState);\n-    // TODO: Move into new AddFeatureDialogViewModel?\n-    this.homeScreenViewModel = getViewModel(HomeScreenViewModel.class);\n-    this.mapContainerViewModel = getViewModel(MapContainerViewModel.class);\n-  }\n+  public AddFeatureDialogFragment() {}\n \n-  public Maybe<Feature> show(FragmentManager fragmentManager) {\n+  public void show(\n+      @NonNull Project project,\n+      @NonNull FragmentManager fragmentManager,\n+      @NonNull LayerSelectedListener listener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3477afd7f36ee481fdce80a24b96670082efaa84"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fadb8d3774e710e59d7ad39a8eadd3b2920c7179", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/fadb8d3774e710e59d7ad39a8eadd3b2920c7179", "committedDate": "2020-12-23T19:02:20Z", "message": "Merge branch 'master' into issue#661"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a8d2030ca732fd3155b244bc3c331accff707ee", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/7a8d2030ca732fd3155b244bc3c331accff707ee", "committedDate": "2020-12-24T04:34:00Z", "message": "Remove @NonNull as it is the default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bf90c07e6408445a4ec4f15b12633ab0b6c7f29", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/5bf90c07e6408445a4ec4f15b12633ab0b6c7f29", "committedDate": "2020-12-24T04:48:16Z", "message": "Move instantiating features to FeatureRepository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeb8967e5643372d6c1f9c7c129bb5d77ea783cc", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/eeb8967e5643372d6c1f9c7c129bb5d77ea783cc", "committedDate": "2020-12-24T05:04:10Z", "message": "Use Consumer<Layer> and remove references on destroy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9378982ce94559723548cd5844974ce70f2cc2a", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/b9378982ce94559723548cd5844974ce70f2cc2a", "committedDate": "2020-12-24T17:42:16Z", "message": "Pass layers instead of project and check nullability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f885df34c51a7957d8d00349c8c2238c592e6003", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/f885df34c51a7957d8d00349c8c2238c592e6003", "committedDate": "2020-12-24T18:22:12Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e53f63e3583df8755eb6033dcb26001c35b19956", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/e53f63e3583df8755eb6033dcb26001c35b19956", "committedDate": "2020-12-26T17:34:19Z", "message": "Merge branch 'master' into issue#661"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODg0MTM2", "url": "https://github.com/google/ground-android/pull/666#pullrequestreview-558884136", "createdAt": "2020-12-26T17:36:34Z", "commit": {"oid": "e53f63e3583df8755eb6033dcb26001c35b19956"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1532, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}