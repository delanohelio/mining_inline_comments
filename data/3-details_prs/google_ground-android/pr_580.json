{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMTkxNzgy", "number": 580, "title": "[Offline base maps] Add support for deleting areas", "bodyText": "EDITED: We use reference counting to remove tile sources from the device when offline areas are deleted.\nIt also updates the offline area viewer to trigger deletions upon clicking the remove button.\nI verified this behavior using the device file explorer and stetho--everything seems to be removed correctly.\nAlso fixes #573", "createdAt": "2020-09-22T20:58:45Z", "url": "https://github.com/google/ground-android/pull/580", "merged": true, "mergeCommit": {"oid": "e9f09c83c5284211d3a9b2306931d24fb04b23ff"}, "closed": true, "closedAt": "2020-11-09T10:37:23Z", "author": {"login": "scolsen"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLeZldAH2gAyNDkxMTkxNzgyOjQxY2FhZWZkMzFkMWMwNjUyMzUzNWEyNGVkYTYzMDgyMzYwNWM1NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdayFoMAH2gAyNDkxMTkxNzgyOjRmYjVhZDg1Njg2OTU5MTc5OTg1ZjY5MjFiM2Y1MjcyMGUxMWU3NzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41caaefd31d1c06523535a24eda630823605c564", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/41caaefd31d1c06523535a24eda630823605c564", "committedDate": "2020-09-22T20:55:30Z", "message": "Update local data store to manage tile/area cross references\n\nTo simplify our handling of offline area deletions, we now keep an association object in the database to track associations between tile sources and offline areas. When deleting an offline area, we can only delete tiles that are unique to the area in question. This cross-table approach simplifies accounting for this, since we can simply fetch tiles along with the areas that depend on them directly from the data store.\n\nThis change also includes the area deletion functionality we need in the data store and offline area repository. I've also updated our File utility to handle deleting files relative to the app's file directory."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "251278150c43c72e8578891725666128992a5bd3", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/251278150c43c72e8578891725666128992a5bd3", "committedDate": "2020-09-23T21:39:04Z", "message": "Fix code style errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTQzMzk5", "url": "https://github.com/google/ground-android/pull/580#pullrequestreview-495143399", "createdAt": "2020-09-24T00:29:18Z", "commit": {"oid": "251278150c43c72e8578891725666128992a5bd3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDoyOToxOFrOHXFp9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMDozMzoxN1rOHXFuKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MTk1OA==", "bodyText": "=>2020", "url": "https://github.com/google/ground-android/pull/580#discussion_r493971958", "createdAt": "2020-09-24T00:29:18Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/dao/OfflineAreaTileSourceCrossRefDao.java", "diffHunk": "@@ -1,9 +1,25 @@\n+/*\n+ * Copyright 2019 Google LLC", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "251278150c43c72e8578891725666128992a5bd3"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MjE3Mg==", "bodyText": "Nit: Extra '/ ' here", "url": "https://github.com/google/ground-android/pull/580#discussion_r493972172", "createdAt": "2020-09-24T00:29:58Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -187,7 +188,7 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n                     .collect(toImmutableSet()));\n   }\n \n-  //** Delete an offline area and the unique tile sources associated with it. */\n+  // ** Delete an offline area and the unique tile sources associated with it. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "251278150c43c72e8578891725666128992a5bd3"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3Mjc1Nw==", "bodyText": "Imo logging should be done in the subscriber (where possible) to avoid duplicate logging messages - lmk what you think!", "url": "https://github.com/google/ground-android/pull/580#discussion_r493972757", "createdAt": "2020-09-24T00:32:17Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -583,4 +604,50 @@ public Completable insertOrUpdateOfflineArea(OfflineArea area) {\n         .toSingle()\n         .subscribeOn(schedulers.io());\n   }\n+\n+  private Completable deleteTiles(OfflineAreaEntity offlineAreaEntity) {\n+    return tileSourceDao\n+        .getTileSourcesWithOfflineAreas()\n+        .toSingle()\n+        .map(\n+            sources ->\n+                stream(sources)\n+                    .filter(\n+                        source ->\n+                            // We only remove tiles when the given area is the only one that depends\n+                            // on them.\n+                            source.offlineAreaEntities.contains(offlineAreaEntity)\n+                                && source.offlineAreaEntities.size() == 1)\n+                    .map(source -> source.tileSourceEntity)\n+                    .collect(toImmutableList()))\n+        .flatMapObservable(Observable::fromIterable)\n+        .flatMapCompletable(\n+            tile ->\n+                // TODO: Ideally, we'll want to decouple the file deletion from the local data store\n+                Completable.fromAction(() -> fileUtil.deleteFile(tile.getPath()))\n+                    .andThen(\n+                        tileSourceDao\n+                            .delete(tile)\n+                            .andThen(\n+                                offlineAreaTileSourceCrossRefDao.delete(\n+                                    OfflineAreaTileSourceCrossRef.builder()\n+                                        .setOfflineAreaId(offlineAreaEntity.getId())\n+                                        .setTileSourcePath(tile.getPath())\n+                                        .build()))))\n+        .doOnComplete(() -> Timber.d(\"Removed tiles\"))\n+        .doOnError(throwable -> Timber.e(throwable, \"Failed to delete tiles\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "251278150c43c72e8578891725666128992a5bd3"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MjkwOA==", "bodyText": "Is there any way to split this stream up to make it more readable and self documenting?", "url": "https://github.com/google/ground-android/pull/580#discussion_r493972908", "createdAt": "2020-09-24T00:32:48Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -583,4 +604,50 @@ public Completable insertOrUpdateOfflineArea(OfflineArea area) {\n         .toSingle()\n         .subscribeOn(schedulers.io());\n   }\n+\n+  private Completable deleteTiles(OfflineAreaEntity offlineAreaEntity) {\n+    return tileSourceDao", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "251278150c43c72e8578891725666128992a5bd3"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk3MzAzMg==", "bodyText": "Iirc there are some iterable Rx operations, like flatMapIterable. Do any of those help here?", "url": "https://github.com/google/ground-android/pull/580#discussion_r493973032", "createdAt": "2020-09-24T00:33:17Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -583,4 +604,50 @@ public Completable insertOrUpdateOfflineArea(OfflineArea area) {\n         .toSingle()\n         .subscribeOn(schedulers.io());\n   }\n+\n+  private Completable deleteTiles(OfflineAreaEntity offlineAreaEntity) {\n+    return tileSourceDao\n+        .getTileSourcesWithOfflineAreas()\n+        .toSingle()\n+        .map(\n+            sources ->\n+                stream(sources)\n+                    .filter(\n+                        source ->\n+                            // We only remove tiles when the given area is the only one that depends\n+                            // on them.\n+                            source.offlineAreaEntities.contains(offlineAreaEntity)\n+                                && source.offlineAreaEntities.size() == 1)\n+                    .map(source -> source.tileSourceEntity)\n+                    .collect(toImmutableList()))\n+        .flatMapObservable(Observable::fromIterable)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "251278150c43c72e8578891725666128992a5bd3"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0bfb2f866acd7c85604c74af57a782fecdfdd7", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/bd0bfb2f866acd7c85604c74af57a782fecdfdd7", "committedDate": "2020-10-12T21:19:16Z", "message": "Manage tile/area references using reference counting\n\nRather than manage cross-reference entities, we now use simple reference counting to determine how many offline areas a tile source is associated with. As part of this change:\n\n- A tile source's URL, *not its UID* is now used as the primary key for tile sources, this is necessary to update reference counts, since we generate new UIDs every time we fetch tiles from a basemap source.\n- We now delete tiles only when the reference count of areas is < 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ed2eed17a929c87375dcee97278719634ae06dd", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/9ed2eed17a929c87375dcee97278719634ae06dd", "committedDate": "2020-10-12T21:37:11Z", "message": "Remove unused tile/area cross reference tables classes/methods\n\nThe previous commit obviates the need for these classes and methods since we now use reference counting to manage associations between tile sources and offline areas."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "243de8f86db75485b9587f533bc9d6a90b792c98", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/243de8f86db75485b9587f533bc9d6a90b792c98", "committedDate": "2020-10-12T21:37:32Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into delete-areas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a764651ada43760db9edd3f9e80019270b38513f", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/a764651ada43760db9edd3f9e80019270b38513f", "committedDate": "2020-10-13T14:49:48Z", "message": "Update tile source tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/fa3c572bdfb7a7971feb6252d65d917232697bdb", "committedDate": "2020-10-15T15:12:00Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into delete-areas"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTA5NjAx", "url": "https://github.com/google/ground-android/pull/580#pullrequestreview-509509601", "createdAt": "2020-10-15T15:32:26Z", "commit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTozMjoyNlrOHiNyaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNTo0MTo0MVrOHiOM3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzOTUzMQ==", "bodyText": "Nit: Extra leading /", "url": "https://github.com/google/ground-android/pull/580#discussion_r505639531", "createdAt": "2020-10-15T15:32:26Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/model/basemap/tile/TileSource.java", "diffHunk": "@@ -22,6 +22,11 @@\n @AutoValue\n public abstract class TileSource {\n \n+  //** Increment the area reference count of a tile source by one. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzOTc3Mg==", "bodyText": "Style nit: Please use full name \"incrementAreaCount()\"", "url": "https://github.com/google/ground-android/pull/580#discussion_r505639772", "createdAt": "2020-10-15T15:32:46Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/model/basemap/tile/TileSource.java", "diffHunk": "@@ -22,6 +22,11 @@\n @AutoValue\n public abstract class TileSource {\n \n+  //** Increment the area reference count of a tile source by one. */\n+  public static TileSource incAreaCount(TileSource tileSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0MTkyOA==", "bodyText": "It's generally safer to use artificial ids (id) as PK, and to declare other unique columns as unique if necessary. If there's no specific reason for making this PK, can we move it back to id?", "url": "https://github.com/google/ground-android/pull/580#discussion_r505641928", "createdAt": "2020-10-15T15:35:44Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/entity/TileSourceEntity.java", "diffHunk": "@@ -41,6 +40,7 @@\n \n   @CopyAnnotations\n   @NonNull\n+  @PrimaryKey", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0MjM2Ng==", "bodyText": "If area count can never be null please use int instead.", "url": "https://github.com/google/ground-android/pull/580#discussion_r505642366", "createdAt": "2020-10-15T15:36:21Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/entity/TileSourceEntity.java", "diffHunk": "@@ -117,6 +131,8 @@ public static Builder builder() {\n \n     public abstract Builder setState(TileEntityState newState);\n \n+    public abstract Builder setAreaCount(Integer areaCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0MzkwNQ==", "bodyText": "My intuition is that there's a simpler way of doing this using RxJava fromIterable and recombining the result (combine()?) but would take some tinkering to figure it out. If you don't want to explore that now please add a TODO to simplifying this block.", "url": "https://github.com/google/ground-android/pull/580#discussion_r505643905", "createdAt": "2020-10-15T15:38:29Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -96,12 +97,21 @@ private File downloadOfflineBaseMapSource(OfflineBaseMapSource offlineBaseMapSou\n \n   /** Enqueue a single area and its tile sources for download. */\n   private Completable enqueueDownload(OfflineArea area, ImmutableList<TileSource> tileSources) {\n+\n     return localDataStore\n         .insertOrUpdateOfflineArea(area.toBuilder().setState(State.IN_PROGRESS).build())\n         .andThen(\n             Completable.merge(\n                 stream(tileSources.asList())\n-                    .map(localDataStore::insertOrUpdateTileSource)\n+                    .map(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0NDE5MQ==", "bodyText": "Any way we can reduce nesting here? Maybe just refactor part of this into its own method?", "url": "https://github.com/google/ground-android/pull/580#discussion_r505644191", "createdAt": "2020-10-15T15:38:52Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -170,13 +180,28 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n         .flatMapPublisher(\n             tiles ->\n                 getDownloadedTileSourcesOnceAndStream()\n-                    .map(ts -> stream(ts).filter(tiles::contains).collect(toImmutableSet())))\n+                    .map(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0NDc2Mg==", "bodyText": "A better explanation might be \"Delete an offline area, including any tile sources that don't overlap with other existing offline areas.\"", "url": "https://github.com/google/ground-android/pull/580#discussion_r505644762", "createdAt": "2020-10-15T15:39:39Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -186,4 +211,27 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n                     .filter(tileSource -> tileSource.getState() == TileSource.State.DOWNLOADED)\n                     .collect(toImmutableSet()));\n   }\n+\n+  /** Delete an offline area and the unique tile sources associated with it. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0NjMwMg==", "bodyText": "Same here.. Any way to make this more readable?", "url": "https://github.com/google/ground-android/pull/580#discussion_r505646302", "createdAt": "2020-10-15T15:41:41Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineAreaRepository.java", "diffHunk": "@@ -186,4 +211,27 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n                     .filter(tileSource -> tileSource.getState() == TileSource.State.DOWNLOADED)\n                     .collect(toImmutableSet()));\n   }\n+\n+  /** Delete an offline area and the unique tile sources associated with it. */\n+  public Completable deleteArea(String offlineAreaId) {\n+    return localDataStore\n+        .getOfflineAreaById(offlineAreaId)\n+        .flatMapMaybe(this::getIntersectingDownloadedTileSourcesOnce)\n+        .flatMapCompletable(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6db79f59caf5c1e0e476dfc9231f351eed814554", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/6db79f59caf5c1e0e476dfc9231f351eed814554", "committedDate": "2020-10-15T15:42:34Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into delete-areas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e542aaec0a6c830d38886fde0ebfb2815282dabb", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/e542aaec0a6c830d38886fde0ebfb2815282dabb", "committedDate": "2020-10-15T16:29:26Z", "message": "Rename incAreaCount -> incrementAreaCount"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "048dd804729d4b574c985380030b349b90b0dd8f", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/048dd804729d4b574c985380030b349b90b0dd8f", "committedDate": "2020-10-15T16:36:34Z", "message": "Use int instead of Integer for tile area counts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b86a87ab45ecb164530b0e3e8f7cda2a5087e1c7", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/b86a87ab45ecb164530b0e3e8f7cda2a5087e1c7", "committedDate": "2020-10-15T18:02:57Z", "message": "Readability fixes for the OfflineBaseMapRespository"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODA2NDc5", "url": "https://github.com/google/ground-android/pull/580#pullrequestreview-509806479", "createdAt": "2020-10-15T21:02:30Z", "commit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTowMjozMFrOHiafWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMTowMjozMFrOHiafWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg0NzY0MQ==", "bodyText": "I think what you want here is the following in the DAO:\n@query(\"UPDATE tile_source SET reference_count=:newCount WHERE id = :id\")\nvoid updateReferenceCount(String id, int newCount);\nYou probably could also do the increment directly in SQL, but that might be overkill here.\nNote that we've been following the convention that the table or entity is named after what each row describes, in this case \"tile_source\" instead of \"tile_sources'.", "url": "https://github.com/google/ground-android/pull/580#discussion_r505847641", "createdAt": "2020-10-15T21:02:30Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/entity/TileSourceEntity.java", "diffHunk": "@@ -41,6 +40,7 @@\n \n   @CopyAnnotations\n   @NonNull\n+  @PrimaryKey", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY0MTkyOA=="}, "originalCommit": {"oid": "fa3c572bdfb7a7971feb6252d65d917232697bdb"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9027ebe61a15c931e27ed575f17531f4554c6005", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/9027ebe61a15c931e27ed575f17531f4554c6005", "committedDate": "2020-10-15T21:04:45Z", "message": "Merge branch 'master' into delete-areas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "572bdbca876c655c9e32f605814c76dbad0022b7", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/572bdbca876c655c9e32f605814c76dbad0022b7", "committedDate": "2020-10-29T09:50:55Z", "message": "Merge branch 'master' into delete-areas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bf8d74f07e78443bbb824d17c2ff1fc1fcda780", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/7bf8d74f07e78443bbb824d17c2ff1fc1fcda780", "committedDate": "2020-11-02T20:16:07Z", "message": "Use a custom query to update tile area counts\n\nFor integrity reasons, we shouldn't use URL as the primary key for tile sources and should use a UID instead. However, this means we can't rely on Room's automatic update/delete methods which perform selections against primary keys. This commit restores the tile source UID as the primary key and adds custom queries for updating area counts and deleting tile sources based on the URL of the tile source."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b72c84631d3edb88752bbf97966e4f2c4ec33be", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/0b72c84631d3edb88752bbf97966e4f2c4ec33be", "committedDate": "2020-11-02T20:17:13Z", "message": "Merge branch 'delete-areas' of https://github.com/scolsen/ground-android into delete-areas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2200f87a48690a76eb3368d360c25c61fcec2ee", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/e2200f87a48690a76eb3368d360c25c61fcec2ee", "committedDate": "2020-11-02T20:18:56Z", "message": "Merge branch 'master' into delete-areas"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMzQ4ODY2", "url": "https://github.com/google/ground-android/pull/580#pullrequestreview-522348866", "createdAt": "2020-11-03T10:12:15Z", "commit": {"oid": "e2200f87a48690a76eb3368d360c25c61fcec2ee"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4450fe2bb4255506b31ded5ab22ddd5e813084e", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/a4450fe2bb4255506b31ded5ab22ddd5e813084e", "committedDate": "2020-11-03T10:12:36Z", "message": "Merge branch 'master' into delete-areas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/469c2a9f5e7de8347198f010bb9bca2610d4f125", "committedDate": "2020-11-03T15:13:15Z", "message": "Fix errors introduced by bad merge.\n\ne2200f87 introduced a regression by doubly defining a function in the GeoJsonParser. I used the github UI to perform the merge...lesson learned. -.-"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMTIzMDQz", "url": "https://github.com/google/ground-android/pull/580#pullrequestreview-523123043", "createdAt": "2020-11-04T08:13:26Z", "commit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwODoxMzoyN1rOHtNDdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwODozNjoxNlrOHtNzcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MTg0Nw==", "bodyText": "Since this operates on a tile source, can you make this non-static and modify this instead?", "url": "https://github.com/google/ground-android/pull/580#discussion_r517161847", "createdAt": "2020-11-04T08:13:27Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/model/basemap/tile/TileSource.java", "diffHunk": "@@ -22,6 +22,11 @@\n @AutoValue\n public abstract class TileSource {\n \n+  /** Increment the area reference count of a tile source by one. */\n+  public static TileSource incrementAreaCount(TileSource tileSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MjAwOA==", "bodyText": "then here you could just call TileSource::incrementAreaCount", "url": "https://github.com/google/ground-android/pull/580#discussion_r517162008", "createdAt": "2020-11-04T08:13:48Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/geojson/GeoJsonParser.java", "diffHunk": "@@ -48,6 +48,32 @@\n     this.uuidGenerator = uuidGenerator;\n   }\n \n+  /**\n+   * Returns the immutable list of tiles specified in {@param geojson} that intersect {@param\n+   * bounds}.\n+   */\n+  public ImmutableList<TileSource> intersectingTiles(LatLngBounds bounds, File file) {\n+    try {\n+      String fileContents = FileUtils.readFileToString(file, Charset.forName(JSON_SOURCE_CHARSET));\n+      // TODO: Separate parsing and intersection checks, make asyc (single, completable).\n+      JSONObject geoJson = new JSONObject(fileContents);\n+      // TODO: Make features constant.\n+      JSONArray features = geoJson.getJSONArray(FEATURES_KEY);\n+\n+      return stream(toArrayList(features))\n+          .map(GeoJsonTile::new)\n+          .filter(tile -> tile.boundsIntersect(bounds))\n+          .map(this::jsonToTileSource)\n+          .map(tileSource -> tileSource.toBuilder().setAreaCount(1).build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MjQ3OA==", "bodyText": "Nit: Calling it \"reference count\" might make the purpose of this field more obvious.", "url": "https://github.com/google/ground-android/pull/580#discussion_r517162478", "createdAt": "2020-11-04T08:14:43Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/model/basemap/tile/TileSource.java", "diffHunk": "@@ -37,6 +42,8 @@\n \n   public abstract State getState();\n \n+  public abstract int getAreaCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MzIwMA==", "bodyText": "\" Delete an offline area and any tiles that are no longer needed.\" might be clearer here.", "url": "https://github.com/google/ground-android/pull/580#discussion_r517163200", "createdAt": "2020-11-04T08:16:07Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/LocalDataStore.java", "diffHunk": "@@ -164,6 +164,18 @@\n   /** Returns all queued, failed, and completed offline areas from the local data store. */\n   Flowable<ImmutableList<OfflineBaseMap>> getOfflineAreasOnceAndStream();\n \n+  /** Delete an offline area and its *unique* tiles. */\n+  Completable deleteOfflineArea(String offlineAreaId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MzYxMg==", "bodyText": "I'd expect this to accept the URL and new count; this makes what's happening more obvious and reduces the surface area of the internal API.\nAlso, returning a Completable here may be more correct.", "url": "https://github.com/google/ground-android/pull/580#discussion_r517163612", "createdAt": "2020-11-04T08:16:54Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/LocalDataStore.java", "diffHunk": "@@ -164,6 +164,18 @@\n   /** Returns all queued, failed, and completed offline areas from the local data store. */\n   Flowable<ImmutableList<OfflineBaseMap>> getOfflineAreasOnceAndStream();\n \n+  /** Delete an offline area and its *unique* tiles. */\n+  Completable deleteOfflineArea(String offlineAreaId);\n+\n   /** Returns the offline area with the specified id. */\n   Single<OfflineBaseMap> getOfflineAreaById(String id);\n+\n+  /**\n+   * Update the area count of an existing tile source in the local data store with the area count of\n+   * {@param tilesource}.\n+   */\n+  Single<TileSource> updateTileSourceAreaCountByUrl(TileSource tilesource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2NDkyMg==", "bodyText": "Why do we need to find the area in order to delete it? We should be able to just deleted by id, no?", "url": "https://github.com/google/ground-android/pull/580#discussion_r517164922", "createdAt": "2020-11-04T08:19:29Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -585,4 +586,32 @@ public Completable insertOrUpdateOfflineArea(OfflineBaseMap area) {\n         .toSingle()\n         .subscribeOn(schedulers.io());\n   }\n+\n+  @Override\n+  public Completable deleteOfflineArea(String id) {\n+    return offlineBaseMapDao\n+        .findById(id)\n+        .toSingle()\n+        .doOnSubscribe(__ -> Timber.d(\"Deleting offline area: %s\", id))\n+        .flatMapCompletable(offlineBaseMapDao::delete)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2NTA5Mg==", "bodyText": "Can we return a Completable here instead?", "url": "https://github.com/google/ground-android/pull/580#discussion_r517165092", "createdAt": "2020-11-04T08:19:49Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/persistence/local/room/RoomLocalDataStore.java", "diffHunk": "@@ -585,4 +586,32 @@ public Completable insertOrUpdateOfflineArea(OfflineBaseMap area) {\n         .toSingle()\n         .subscribeOn(schedulers.io());\n   }\n+\n+  @Override\n+  public Completable deleteOfflineArea(String id) {\n+    return offlineBaseMapDao\n+        .findById(id)\n+        .toSingle()\n+        .doOnSubscribe(__ -> Timber.d(\"Deleting offline area: %s\", id))\n+        .flatMapCompletable(offlineBaseMapDao::delete)\n+        .subscribeOn(schedulers.io());\n+  }\n+\n+  @Override\n+  public Single<TileSource> updateTileSourceAreaCountByUrl(TileSource tileSource) {\n+    return tileSourceDao\n+        .updateAreaCount(tileSource.getAreaCount(), tileSource.getUrl())\n+        .map(__ -> tileSource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2NjMzMg==", "bodyText": "Naming nit: ->deleteFileIfExists", "url": "https://github.com/google/ground-android/pull/580#discussion_r517166332", "createdAt": "2020-11-04T08:22:13Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/util/FileUtil.java", "diffHunk": "@@ -84,4 +84,14 @@ public File getFileFromRawResource(@RawRes int resourceId, String filename) thro\n     }\n     return file;\n   }\n+\n+  /** Attempts to delete a file relative to the app's file directory when it exists. */\n+  public void deleteFile(String filename) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE3MjM1Nw==", "bodyText": "Please move this logic into subscribe() instead of side effect.", "url": "https://github.com/google/ground-android/pull/580#discussion_r517172357", "createdAt": "2020-11-04T08:32:58Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinebasemap/viewer/OfflineBaseMapViewerFragment.java", "diffHunk": "@@ -109,6 +112,11 @@ public void onRemoveClick() {\n       return;\n     }\n \n-    viewModel.onRemoveClick();\n+    Timber.d(\"Removing offline area %s\", viewModel.getOfflineArea());\n+    viewModel\n+        .onRemoveClick()\n+        .doOnComplete(() -> navigator.navigateUp())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE3MjgxNg==", "bodyText": "Can we avoid casting to Flowable here to simplify a bit?", "url": "https://github.com/google/ground-android/pull/580#discussion_r517172816", "createdAt": "2020-11-04T08:33:54Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineBaseMapRepository.java", "diffHunk": "@@ -186,4 +212,23 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n                     .filter(tileSource -> tileSource.getState() == TileSource.State.DOWNLOADED)\n                     .collect(toImmutableSet()));\n   }\n+\n+  /**\n+   * Delete an offline base map and any tile sources associated with it that do not overlap with\n+   * other offline base maps .\n+   */\n+  public Completable deleteArea(String offlineAreaId) {\n+    return localDataStore\n+        .getOfflineAreaById(offlineAreaId)\n+        .flatMapMaybe(this::getIntersectingDownloadedTileSourcesOnce)\n+        .flatMapPublisher(Flowable::fromIterable)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE3MzcyMQ==", "bodyText": "It might be nice to have a tileSource.decrementTileCount() called here instead (better encapsulated and for consistency with increment..", "url": "https://github.com/google/ground-android/pull/580#discussion_r517173721", "createdAt": "2020-11-04T08:35:30Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineBaseMapRepository.java", "diffHunk": "@@ -186,4 +212,23 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n                     .filter(tileSource -> tileSource.getState() == TileSource.State.DOWNLOADED)\n                     .collect(toImmutableSet()));\n   }\n+\n+  /**\n+   * Delete an offline base map and any tile sources associated with it that do not overlap with\n+   * other offline base maps .\n+   */\n+  public Completable deleteArea(String offlineAreaId) {\n+    return localDataStore\n+        .getOfflineAreaById(offlineAreaId)\n+        .flatMapMaybe(this::getIntersectingDownloadedTileSourcesOnce)\n+        .flatMapPublisher(Flowable::fromIterable)\n+        .map(\n+            tileSource ->\n+                tileSource.toBuilder().setAreaCount(tileSource.getAreaCount() - 1).build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE3NDAyMg==", "bodyText": "Also, if the previous stream is a Completable, here we could just use andThen.", "url": "https://github.com/google/ground-android/pull/580#discussion_r517174022", "createdAt": "2020-11-04T08:36:04Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineBaseMapRepository.java", "diffHunk": "@@ -186,4 +212,23 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n                     .filter(tileSource -> tileSource.getState() == TileSource.State.DOWNLOADED)\n                     .collect(toImmutableSet()));\n   }\n+\n+  /**\n+   * Delete an offline base map and any tile sources associated with it that do not overlap with\n+   * other offline base maps .\n+   */\n+  public Completable deleteArea(String offlineAreaId) {\n+    return localDataStore\n+        .getOfflineAreaById(offlineAreaId)\n+        .flatMapMaybe(this::getIntersectingDownloadedTileSourcesOnce)\n+        .flatMapPublisher(Flowable::fromIterable)\n+        .map(\n+            tileSource ->\n+                tileSource.toBuilder().setAreaCount(tileSource.getAreaCount() - 1).build())\n+        .flatMapCompletable(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE3NDEyOQ==", "bodyText": "Same here.", "url": "https://github.com/google/ground-android/pull/580#discussion_r517174129", "createdAt": "2020-11-04T08:36:16Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/repository/OfflineBaseMapRepository.java", "diffHunk": "@@ -186,4 +212,23 @@ public Completable addAreaAndEnqueue(LatLngBounds bounds) {\n                     .filter(tileSource -> tileSource.getState() == TileSource.State.DOWNLOADED)\n                     .collect(toImmutableSet()));\n   }\n+\n+  /**\n+   * Delete an offline base map and any tile sources associated with it that do not overlap with\n+   * other offline base maps .\n+   */\n+  public Completable deleteArea(String offlineAreaId) {\n+    return localDataStore\n+        .getOfflineAreaById(offlineAreaId)\n+        .flatMapMaybe(this::getIntersectingDownloadedTileSourcesOnce)\n+        .flatMapPublisher(Flowable::fromIterable)\n+        .map(\n+            tileSource ->\n+                tileSource.toBuilder().setAreaCount(tileSource.getAreaCount() - 1).build())\n+        .flatMapCompletable(\n+            tile ->\n+                Completable.fromSingle(localDataStore.updateTileSourceAreaCountByUrl(tile))\n+                    .andThen(localDataStore.deleteTileByUrl(tile)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469c2a9f5e7de8347198f010bb9bca2610d4f125"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaf0c83e9eed7502190539964bc3d1d27b748f60", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/aaf0c83e9eed7502190539964bc3d1d27b748f60", "committedDate": "2020-11-04T22:01:10Z", "message": "Stylistic improvements to TileSource\n\n- Rename areaCount -> basemapReferenceCount\n- Add a decrement method for reference counts\n- Remove static from increment method\n- Update the signature of updateTileSourceBasemapReferenceCountByUrl signature."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "302135cac4d3cc4ebc1618cfdd22a551a910eb1e", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/302135cac4d3cc4ebc1618cfdd22a551a910eb1e", "committedDate": "2020-11-04T22:07:34Z", "message": "Move navigation logic in basemap viewer fragment into subscribe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "364195fac7361f20c62e687efaf522f4f13a1a0a", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/364195fac7361f20c62e687efaf522f4f13a1a0a", "committedDate": "2020-11-09T03:41:53Z", "message": "OfflineBaseMapRepository: Cast maybe to observable\n\nWe don't need backpressure here, thus, we have no need for a flowable."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MTA4OTgw", "url": "https://github.com/google/ground-android/pull/580#pullrequestreview-526108980", "createdAt": "2020-11-09T10:20:32Z", "commit": {"oid": "364195fac7361f20c62e687efaf522f4f13a1a0a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fb5ad85686959179985f6921b3f52720e11e774", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/4fb5ad85686959179985f6921b3f52720e11e774", "committedDate": "2020-11-09T10:20:40Z", "message": "Merge branch 'master' into delete-areas"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1624, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}