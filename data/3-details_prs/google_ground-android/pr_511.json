{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMzEwNDQx", "number": 511, "title": "[Offline base map] Notify user when \"download\" clicked", "bodyText": "This PR adds a basic toast + navigation change to signal to users that they've initiated an offline area download. After tapping the button, the user is immediately returned to the offline area list, where the newly downloaded area is listed. An informative toast also appears. On errors we still return to the list, but display a different toast message.\n\nCloses #537.", "createdAt": "2020-06-30T21:38:35Z", "url": "https://github.com/google/ground-android/pull/511", "merged": true, "mergeCommit": {"oid": "4d3cc6b317c5991003fea35bde6f85ec0e827832"}, "closed": true, "closedAt": "2020-07-14T17:05:08Z", "author": {"login": "scolsen"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqTA3zgH2gAyNDQyMzEwNDQxOmEwNGYwN2E0YTJiMWZmNDJlZTk2M2M2MmRjMjgwMWUxNTZiYWYyNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc06ZpVgFqTQ0ODM2MjY5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a04f07a4a2b1ff42ee963c62dc2801e156baf260", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/a04f07a4a2b1ff42ee963c62dc2801e156baf260", "committedDate": "2020-06-11T19:00:03Z", "message": "Fix GeoJson coordinate parsing\n\nThe GeoJson spec states that positions must be described by a longitude followed by a latitude; we previously assumed the reverse order, leading to errors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66d3f3b48eb81c7c1671850ae9c4b608ea9d1699", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/66d3f3b48eb81c7c1671850ae9c4b608ea9d1699", "committedDate": "2020-06-30T20:43:55Z", "message": "Merge branch 'master' of https://github.com/google/ground-android"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7018931c22a32c055ad8a8c5d569a713b75e2d54", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/7018931c22a32c055ad8a8c5d569a713b75e2d54", "committedDate": "2020-06-30T21:12:27Z", "message": "Display an emphemeral popup on area download; navigate back\n\nPreviously, we gave users no indication that a download had initiated after selecting the Download button. Now, we display a popup to let the user know the download started and navigate them back to the offline area list (where they'll see the new entry for the area)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d85af3f4d33995a4cec0cec5ad8c87afbdb06e62", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/d85af3f4d33995a4cec0cec5ad8c87afbdb06e62", "committedDate": "2020-06-30T21:34:30Z", "message": "Differentiate between successfully initiated downloads and failures\n\nWe now display a different toast in case an offline area download initialization fails."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390", "committedDate": "2020-07-01T14:43:18Z", "message": "Merge branch 'master' into download-popup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTM2OTk3", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-440936997", "createdAt": "2020-07-01T14:43:55Z", "commit": {"oid": "d85af3f4d33995a4cec0cec5ad8c87afbdb06e62"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNDo0NjowMVrOGrpGeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNDo1MDowMVrOGrpREQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxNTM1Mw==", "bodyText": "I believe in this case the toast will re-appear every time to view is restored (e.g. after configuration change). To ensure they're single use, you can wrap DownloadTrigger in our custom class  Event<>.", "url": "https://github.com/google/ground-android/pull/511#discussion_r448415353", "createdAt": "2020-07-01T14:46:01Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,51 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n+  private final LiveData<DownloadTrigger> downloads;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxNTc1MQ==", "bodyText": "downloads -> downloadEvents?", "url": "https://github.com/google/ground-android/pull/511#discussion_r448415751", "createdAt": "2020-07-01T14:46:39Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,51 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n+  private final LiveData<DownloadTrigger> downloads;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxNjA5Mw==", "bodyText": "DownloadEvent?", "url": "https://github.com/google/ground-android/pull/511#discussion_r448416093", "createdAt": "2020-07-01T14:47:07Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,51 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n+  private final LiveData<DownloadTrigger> downloads;\n+\n+  public LiveData<DownloadTrigger> getDownloadTriggers() {\n+    return this.downloads;\n+  }\n+\n+  enum DownloadTrigger {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxNjgxMQ==", "bodyText": "Please add a TODO to handle this asynchronously instead of blocking the UI.", "url": "https://github.com/google/ground-android/pull/511#discussion_r448416811", "createdAt": "2020-07-01T14:48:05Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,51 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n+  private final LiveData<DownloadTrigger> downloads;\n+\n+  public LiveData<DownloadTrigger> getDownloadTriggers() {\n+    return this.downloads;\n+  }\n+\n+  enum DownloadTrigger {\n+    Started,\n+    Failure\n+  }\n+\n   private final OfflineAreaRepository offlineAreaRepository;\n+  private final PublishSubject<DownloadTrigger> downloadsPublishSubject = PublishSubject.create();\n \n   @Inject\n   OfflineAreaSelectorViewModel(OfflineAreaRepository offlineAreaRepository) {\n     this.offlineAreaRepository = offlineAreaRepository;\n+    this.downloads =\n+        LiveDataReactiveStreams.fromPublisher(\n+            downloadsPublishSubject.toFlowable(BackpressureStrategy.LATEST));\n   }\n \n   // TODO: Use an abstraction over LatLngBounds\n   public void onDownloadClick(LatLngBounds viewport) {\n     Timber.d(\"viewport:%s\", viewport);\n-    offlineAreaRepository.addAreaAndEnqueue(viewport)\n-      .doOnError(err -> Timber.e(\"Failed to add area and queue downloads: %s\", err.getMessage()))\n-      .onErrorComplete()\n-      .blockingAwait();\n+    offlineAreaRepository\n+        .addAreaAndEnqueue(viewport)\n+        .doOnError(\n+            err -> {\n+              Timber.e(\"Failed to add area and queue downloads: %s\", err.getMessage());\n+              downloadsPublishSubject.onNext(DownloadTrigger.Failure);\n+            })\n+        .doOnComplete(() -> downloadsPublishSubject.onNext(DownloadTrigger.Started))\n+        .blockingAwait();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxNzQ5OQ==", "bodyText": "Since you're blocking, you can just move this operation outside of the stream immediately following the blockingAwait().", "url": "https://github.com/google/ground-android/pull/511#discussion_r448417499", "createdAt": "2020-07-01T14:49:07Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,51 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n+  private final LiveData<DownloadTrigger> downloads;\n+\n+  public LiveData<DownloadTrigger> getDownloadTriggers() {\n+    return this.downloads;\n+  }\n+\n+  enum DownloadTrigger {\n+    Started,\n+    Failure\n+  }\n+\n   private final OfflineAreaRepository offlineAreaRepository;\n+  private final PublishSubject<DownloadTrigger> downloadsPublishSubject = PublishSubject.create();\n \n   @Inject\n   OfflineAreaSelectorViewModel(OfflineAreaRepository offlineAreaRepository) {\n     this.offlineAreaRepository = offlineAreaRepository;\n+    this.downloads =\n+        LiveDataReactiveStreams.fromPublisher(\n+            downloadsPublishSubject.toFlowable(BackpressureStrategy.LATEST));\n   }\n \n   // TODO: Use an abstraction over LatLngBounds\n   public void onDownloadClick(LatLngBounds viewport) {\n     Timber.d(\"viewport:%s\", viewport);\n-    offlineAreaRepository.addAreaAndEnqueue(viewport)\n-      .doOnError(err -> Timber.e(\"Failed to add area and queue downloads: %s\", err.getMessage()))\n-      .onErrorComplete()\n-      .blockingAwait();\n+    offlineAreaRepository\n+        .addAreaAndEnqueue(viewport)\n+        .doOnError(\n+            err -> {\n+              Timber.e(\"Failed to add area and queue downloads: %s\", err.getMessage());\n+              downloadsPublishSubject.onNext(DownloadTrigger.Failure);\n+            })\n+        .doOnComplete(() -> downloadsPublishSubject.onNext(DownloadTrigger.Started))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxODA2NQ==", "bodyText": "This will report the error but it won't catch it; I believe blockingAwait() will throw an exception for unhandled errors, so may want to use try{} catch around this call instead so you'd catch both cases.", "url": "https://github.com/google/ground-android/pull/511#discussion_r448418065", "createdAt": "2020-07-01T14:50:01Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,51 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n+  private final LiveData<DownloadTrigger> downloads;\n+\n+  public LiveData<DownloadTrigger> getDownloadTriggers() {\n+    return this.downloads;\n+  }\n+\n+  enum DownloadTrigger {\n+    Started,\n+    Failure\n+  }\n+\n   private final OfflineAreaRepository offlineAreaRepository;\n+  private final PublishSubject<DownloadTrigger> downloadsPublishSubject = PublishSubject.create();\n \n   @Inject\n   OfflineAreaSelectorViewModel(OfflineAreaRepository offlineAreaRepository) {\n     this.offlineAreaRepository = offlineAreaRepository;\n+    this.downloads =\n+        LiveDataReactiveStreams.fromPublisher(\n+            downloadsPublishSubject.toFlowable(BackpressureStrategy.LATEST));\n   }\n \n   // TODO: Use an abstraction over LatLngBounds\n   public void onDownloadClick(LatLngBounds viewport) {\n     Timber.d(\"viewport:%s\", viewport);\n-    offlineAreaRepository.addAreaAndEnqueue(viewport)\n-      .doOnError(err -> Timber.e(\"Failed to add area and queue downloads: %s\", err.getMessage()))\n-      .onErrorComplete()\n-      .blockingAwait();\n+    offlineAreaRepository\n+        .addAreaAndEnqueue(viewport)\n+        .doOnError(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTQzNTc5", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-440943579", "createdAt": "2020-07-01T14:50:56Z", "commit": {"oid": "4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNDo1MDo1NlrOGrpT8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNDo1MDo1NlrOGrpT8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxODgwMQ==", "bodyText": "Enum values are constants so they're general ALL_CAPS in Java.", "url": "https://github.com/google/ground-android/pull/511#discussion_r448418801", "createdAt": "2020-07-01T14:50:56Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,51 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n+  private final LiveData<DownloadTrigger> downloads;\n+\n+  public LiveData<DownloadTrigger> getDownloadTriggers() {\n+    return this.downloads;\n+  }\n+\n+  enum DownloadTrigger {\n+    Started,\n+    Failure", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d9b4a6f17a630134fe5e6ede2ba4d0ff3b18390"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02a874348104d771f91e9d0137e04d1b1fc7c608", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/02a874348104d771f91e9d0137e04d1b1fc7c608", "committedDate": "2020-07-01T16:10:01Z", "message": "Capitalize downloadTrigger enum values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ccc0c59502b59d2a36e07c772c62bc82e0a7c18", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/6ccc0c59502b59d2a36e07c772c62bc82e0a7c18", "committedDate": "2020-07-01T16:21:21Z", "message": "Wrap download events in Event\n\nThe Event class prevents us from unwittingly re-presenting UIs on view restoration.\n\nI've also renamed downloadTrigger to downloadEvent."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3972bdb4ab994ffc42af7a15de97b303756e6f2a", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/3972bdb4ab994ffc42af7a15de97b303756e6f2a", "committedDate": "2020-07-01T17:30:40Z", "message": "Make download click handling non-blocking\n\nInstead of using blockingAwait, we use a click subject and subscribe to its emissions to fire off downloads and react appropriately in the fragment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd", "committedDate": "2020-07-01T17:32:51Z", "message": "Merge branch 'download-popup' of https://github.com/scolsen/ground-android into download-popup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTUzMTI1", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-441153125", "createdAt": "2020-07-01T19:49:53Z", "commit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo0OTo1M1rOGrzQiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo0OTo1M1rOGrzQiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MTc2OA==", "bodyText": "Add \"break;\" here and below.", "url": "https://github.com/google/ground-android/pull/511#discussion_r448581768", "createdAt": "2020-07-01T19:49:53Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorFragment.java", "diffHunk": "@@ -56,6 +61,24 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n     // TODO: use the viewmodel\n     Single<MapAdapter> mapAdapter = mapProvider.getMapAdapter();\n     mapAdapter.as(autoDisposable(this)).subscribe(this::onMapReady);\n+    viewModel\n+        .getDownloadEvents()\n+        .observe(\n+            this,\n+            e -> {\n+              e.ifUnhandled(this::onDownloadEvent);\n+            });\n+  }\n+\n+  private void onDownloadEvent(DownloadEvent downloadEvent) {\n+    switch (downloadEvent) {\n+      case FAILURE:\n+        EphemeralPopups.showError(getContext(), R.string.offline_area_download_failed);\n+        navigator.navigateUp();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTUzMjgz", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-441153283", "createdAt": "2020-07-01T19:50:09Z", "commit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo1MDowOVrOGrzRMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo1MDowOVrOGrzRMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MTkzOA==", "bodyText": "Pls move enum declaration to start of class.", "url": "https://github.com/google/ground-android/pull/511#discussion_r448581938", "createdAt": "2020-07-01T19:50:09Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,62 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n+import com.google.android.gnd.rx.Event;\n+import com.google.android.gnd.rx.Schedulers;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.Observable;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n-  private final OfflineAreaRepository offlineAreaRepository;\n+  private final LiveData<Event<DownloadEvent>> downloadEvents;\n+\n+  public LiveData<Event<DownloadEvent>> getDownloadEvents() {\n+    return this.downloadEvents;\n+  }\n+\n+  enum DownloadEvent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTU0Mzgw", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-441154380", "createdAt": "2020-07-01T19:52:05Z", "commit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo1MjowNlrOGrzUuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo1MjowNlrOGrzUuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4Mjg0MA==", "bodyText": "I think maybe here you'd just want to use flatMapCompletable without the additional andThen?", "url": "https://github.com/google/ground-android/pull/511#discussion_r448582840", "createdAt": "2020-07-01T19:52:06Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,62 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n+import com.google.android.gnd.rx.Event;\n+import com.google.android.gnd.rx.Schedulers;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.Observable;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n-  private final OfflineAreaRepository offlineAreaRepository;\n+  private final LiveData<Event<DownloadEvent>> downloadEvents;\n+\n+  public LiveData<Event<DownloadEvent>> getDownloadEvents() {\n+    return this.downloadEvents;\n+  }\n+\n+  enum DownloadEvent {\n+    STARTED,\n+    FAILURE\n+  }\n+\n+  private final PublishSubject<DownloadEvent> downloadsPublishSubject = PublishSubject.create();\n+  private final PublishSubject<LatLngBounds> downloadClickSubject = PublishSubject.create();\n \n   @Inject\n-  OfflineAreaSelectorViewModel(OfflineAreaRepository offlineAreaRepository) {\n-    this.offlineAreaRepository = offlineAreaRepository;\n+  OfflineAreaSelectorViewModel(OfflineAreaRepository offlineAreaRepository, Schedulers schedulers) {\n+\n+    disposeOnClear(\n+        downloadClickSubject\n+            .flatMap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTU1NjUx", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-441155651", "createdAt": "2020-07-01T19:54:21Z", "commit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo1NDoyMlrOGrzYkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOTo1NDoyMlrOGrzYkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU4MzgyNw==", "bodyText": "Following up on the more idiomatic use about, you should then be able to do:\n  .toSingleDefault(DownloadEvent.STARTED)\n  .onErrorReturn(DownloadEvent.FAILURE)\n  .subscribe(downloadsPublishSubject::onNext);", "url": "https://github.com/google/ground-android/pull/511#discussion_r448583827", "createdAt": "2020-07-01T19:54:22Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorViewModel.java", "diffHunk": "@@ -16,27 +16,62 @@\n \n package com.google.android.gnd.ui.offlinearea.selector;\n \n+import androidx.lifecycle.LiveData;\n+import androidx.lifecycle.LiveDataReactiveStreams;\n import com.google.android.gms.maps.model.LatLngBounds;\n import com.google.android.gnd.repository.OfflineAreaRepository;\n+import com.google.android.gnd.rx.Event;\n+import com.google.android.gnd.rx.Schedulers;\n import com.google.android.gnd.ui.common.AbstractViewModel;\n+import io.reactivex.BackpressureStrategy;\n+import io.reactivex.Observable;\n+import io.reactivex.subjects.PublishSubject;\n import javax.inject.Inject;\n import timber.log.Timber;\n \n public class OfflineAreaSelectorViewModel extends AbstractViewModel {\n \n-  private final OfflineAreaRepository offlineAreaRepository;\n+  private final LiveData<Event<DownloadEvent>> downloadEvents;\n+\n+  public LiveData<Event<DownloadEvent>> getDownloadEvents() {\n+    return this.downloadEvents;\n+  }\n+\n+  enum DownloadEvent {\n+    STARTED,\n+    FAILURE\n+  }\n+\n+  private final PublishSubject<DownloadEvent> downloadsPublishSubject = PublishSubject.create();\n+  private final PublishSubject<LatLngBounds> downloadClickSubject = PublishSubject.create();\n \n   @Inject\n-  OfflineAreaSelectorViewModel(OfflineAreaRepository offlineAreaRepository) {\n-    this.offlineAreaRepository = offlineAreaRepository;\n+  OfflineAreaSelectorViewModel(OfflineAreaRepository offlineAreaRepository, Schedulers schedulers) {\n+\n+    disposeOnClear(\n+        downloadClickSubject\n+            .flatMap(\n+                // We need to handle this in the inner lambda instead of using a combinator such as\n+                // flatMapCompletable because the PublishSubject will never actually complete.\n+                // andThen enables us to fill the resulting stream w/ items to propagate completion.\n+                viewport ->\n+                    offlineAreaRepository\n+                        .addAreaAndEnqueue(viewport)\n+                        .andThen(Observable.just(new Object())))\n+            .observeOn(schedulers.ui())\n+            .doOnError(e -> Timber.e(\"Failed to add area and queue downloads: %s\", e.getMessage()))\n+            .subscribe(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTU2NDg0", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-441156484", "createdAt": "2020-07-01T19:55:47Z", "commit": {"oid": "6de3e69e1f740f3e07e5ba4a5a7d6c7a7ab982fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f52e781703b4006d252994fc358fd7c7135f3528", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/f52e781703b4006d252994fc358fd7c7135f3528", "committedDate": "2020-07-01T20:21:00Z", "message": "Merge branch 'master' into download-popup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eb55d43ede72a2c41e3773575eb0a562977bec2", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/3eb55d43ede72a2c41e3773575eb0a562977bec2", "committedDate": "2020-07-01T22:16:35Z", "message": "Convert download messages to idiomatic RxJava"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "056d556ce8b6f329846a6fabad832cffde6adf49", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/056d556ce8b6f329846a6fabad832cffde6adf49", "committedDate": "2020-07-01T22:19:08Z", "message": "Rename remaining DownloadEvent instances"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b842c381ab0664f14be1de77445878f32c87ae4", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/5b842c381ab0664f14be1de77445878f32c87ae4", "committedDate": "2020-07-01T22:29:36Z", "message": "Use more generic type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30692ef061146e9e3a349cd085ee1de5e57e3355", "author": {"user": {"login": "gino-m", "name": "Gino Miceli"}}, "url": "https://github.com/google/ground-android/commit/30692ef061146e9e3a349cd085ee1de5e57e3355", "committedDate": "2020-07-01T22:29:54Z", "message": "Reverse order of declarations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjM3NTU1", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-441237555", "createdAt": "2020-07-01T22:33:11Z", "commit": {"oid": "f52e781703b4006d252994fc358fd7c7135f3528"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae89b51cdcf15a2167690aa47aeaef0d2f8c23b4", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/ae89b51cdcf15a2167690aa47aeaef0d2f8c23b4", "committedDate": "2020-07-02T02:07:12Z", "message": "Merge pull request #1 from gino-m/pr-511\n\nSuggestions to convert download messages to idiomatic RxJava"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzM1Mjk5", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-441335299", "createdAt": "2020-07-02T04:03:58Z", "commit": {"oid": "ae89b51cdcf15a2167690aa47aeaef0d2f8c23b4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b31f966a12124df85b47e8cf49f98d67af9c78e8", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/b31f966a12124df85b47e8cf49f98d67af9c78e8", "committedDate": "2020-07-14T14:27:18Z", "message": "Fix switch statement checkstyle errors\n\nWe need a default case! And we should break :)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94e1eea3f5b586c372748864adb586fd45cd3a8d", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/94e1eea3f5b586c372748864adb586fd45cd3a8d", "committedDate": "2020-07-14T14:28:25Z", "message": "Merge branch 'master' of https://github.com/google/ground-android into download-popup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea47af48d5c65a872313e368a5d61690478d87be", "author": {"user": {"login": "scolsen", "name": "Scott Olsen"}}, "url": "https://github.com/google/ground-android/commit/ea47af48d5c65a872313e368a5d61690478d87be", "committedDate": "2020-07-14T15:01:37Z", "message": "Remove unused import and constructor param"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4Mjk4NTMz", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-448298533", "createdAt": "2020-07-14T17:05:01Z", "commit": {"oid": "ea47af48d5c65a872313e368a5d61690478d87be"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MzYyNjk1", "url": "https://github.com/google/ground-android/pull/511#pullrequestreview-448362695", "createdAt": "2020-07-14T18:32:39Z", "commit": {"oid": "ea47af48d5c65a872313e368a5d61690478d87be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxODozMjozOVrOGxgOBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxODozMjozOVrOGxgOBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2MTI4NA==", "bodyText": "Why default? Doesn't this make above line case FAILURE redundant?", "url": "https://github.com/google/ground-android/pull/511#discussion_r454561284", "createdAt": "2020-07-14T18:32:39Z", "author": {"login": "shobhitagarwal1612"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/offlinearea/selector/OfflineAreaSelectorFragment.java", "diffHunk": "@@ -55,6 +60,21 @@ public void onCreate(@Nullable Bundle savedInstanceState) {\n     // TODO: use the viewmodel\n     Single<MapAdapter> mapAdapter = mapProvider.getMapAdapter();\n     mapAdapter.as(autoDisposable(this)).subscribe(this::onMapReady);\n+    viewModel.getDownloadMessages().observe(this, e -> e.ifUnhandled(this::onDownloadMessage));\n+  }\n+\n+  private void onDownloadMessage(DownloadMessage message) {\n+    switch (message) {\n+      case STARTED:\n+        EphemeralPopups.showSuccess(getContext(), R.string.offline_area_download_started);\n+        navigator.navigateUp();\n+        break;\n+      case FAILURE:\n+      default:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea47af48d5c65a872313e368a5d61690478d87be"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1580, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}