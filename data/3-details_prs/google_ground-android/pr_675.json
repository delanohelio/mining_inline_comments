{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1OTUxNDM5", "number": 675, "title": "Refactor handler for MultipleChoiceFields", "bodyText": "Things done:\n\nAdded a base class for Single/Multi dialog factory\nRefactored existing dialog factory classes to use this new base class.\nMerged inner DialogState class to improve readability\n\n\n\n\n\n@gino-m  PTAL?", "createdAt": "2020-12-28T06:34:54Z", "url": "https://github.com/google/ground-android/pull/675", "merged": true, "mergeCommit": {"oid": "0568af0dd43acd4b63fbc8072bc390d323a36903"}, "closed": true, "closedAt": "2020-12-29T18:12:35Z", "author": {"login": "shobhitagarwal1612"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqIg6vgH2gAyNTQ1OTUxNDM5OjE4ZmM1NGU0YWNkZGFmMTk3NTA2YmQ4MWVhOTg1OWFkOWUwZjE1OTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq-zjsgFqTU1OTY0NjA0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "18fc54e4acddaf197506bd81ea9859ad9e0f1594", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/18fc54e4acddaf197506bd81ea9859ad9e0f1594", "committedDate": "2020-12-27T02:57:15Z", "message": "Add abstract builder for select dialogs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d537f15e632625a64dbfaebe584b443dac6bc000", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d537f15e632625a64dbfaebe584b443dac6bc000", "committedDate": "2020-12-28T05:59:00Z", "message": "Add helper method to VM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f8afc8e00c6fb731386e136f4ca31d77790d0c4", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/0f8afc8e00c6fb731386e136f4ca31d77790d0c4", "committedDate": "2020-12-28T06:22:32Z", "message": "Add base methods for generating alert dialog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc6f7a811385c55f1975b3d6580f63c52a7b0d51", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/bc6f7a811385c55f1975b3d6580f63c52a7b0d51", "committedDate": "2020-12-28T06:23:36Z", "message": "Refactor Single/MultiSelectDialogFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef1f7147a0ba1db5d188a33005c34a191e8310ae", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/ef1f7147a0ba1db5d188a33005c34a191e8310ae", "committedDate": "2020-12-28T06:26:00Z", "message": "Update usages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed3869a76a7f3d8f843bf5ec4b7b6fac9ad27d4c", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/ed3869a76a7f3d8f843bf5ec4b7b6fac9ad27d4c", "committedDate": "2020-12-28T06:29:08Z", "message": "Fix method name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6347d5de0c7d84c0732a98fa1b5b3c4d8cfc623", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/e6347d5de0c7d84c0732a98fa1b5b3c4d8cfc623", "committedDate": "2020-12-28T20:07:19Z", "message": "Merge branch 'master' into refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NTc4NDIw", "url": "https://github.com/google/ground-android/pull/675#pullrequestreview-559578420", "createdAt": "2020-12-29T15:20:20Z", "commit": {"oid": "d537f15e632625a64dbfaebe584b443dac6bc000"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNToyMDoyMFrOIMRpYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNToyNTowNlrOIMRwag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0Mjk0Nw==", "bodyText": "I think you could do:\n Optional.ofNullable(getResponse().getValue())\n                .flatMap(MultipleChoiceResponse.class::cast);", "url": "https://github.com/google/ground-android/pull/675#discussion_r549742947", "createdAt": "2020-12-29T15:20:20Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultipleChoiceFieldViewModel.java", "diffHunk": "@@ -37,4 +39,10 @@ public void onShowDialog() {\n   MutableLiveData<Nil> getShowDialogClicks() {\n     return showDialogClicks;\n   }\n+\n+  Optional<MultipleChoiceResponse> getCurrentResponse() {\n+    return getResponse().getValue() == null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d537f15e632625a64dbfaebe584b443dac6bc000"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0NDI4MA==", "bodyText": "Can we make this empty by default instead of null?", "url": "https://github.com/google/ground-android/pull/675#discussion_r549744280", "createdAt": "2020-12-29T15:23:55Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultiSelectDialogFactory.java", "diffHunk": "@@ -16,84 +16,75 @@\n \n package com.google.android.gnd.ui.editobservation;\n \n-import static com.google.common.base.Preconditions.checkNotNull;\n-import static java8.util.stream.StreamSupport.stream;\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n \n import android.content.Context;\n+import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n-import com.google.android.gnd.R;\n-import com.google.android.gnd.model.form.Field;\n import com.google.android.gnd.model.form.MultipleChoice;\n import com.google.android.gnd.model.form.Option;\n import com.google.android.gnd.model.observation.MultipleChoiceResponse;\n import com.google.android.gnd.model.observation.Response;\n+import com.google.auto.value.AutoValue;\n import com.google.common.collect.ImmutableList;\n-import java.util.List;\n import java8.util.Optional;\n import java8.util.function.Consumer;\n import java8.util.stream.IntStreams;\n \n-// TODO: Replace with modal bottom sheet.\n-class MultiSelectDialogFactory {\n+@AutoValue\n+abstract class MultiSelectDialogFactory extends SelectDialogFactory {\n \n-  private Context context;\n+  @Nullable private boolean[] checkedItems;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc6f7a811385c55f1975b3d6580f63c52a7b0d51"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0NDUxOA==", "bodyText": "Do we need this wrapper function here? It doesn't seem to provide much abstraction or logic of its own.", "url": "https://github.com/google/ground-android/pull/675#discussion_r549744518", "createdAt": "2020-12-29T15:24:36Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultiSelectDialogFactory.java", "diffHunk": "@@ -16,84 +16,75 @@\n \n package com.google.android.gnd.ui.editobservation;\n \n-import static com.google.common.base.Preconditions.checkNotNull;\n-import static java8.util.stream.StreamSupport.stream;\n+import static com.google.android.gnd.util.ImmutableListCollector.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n \n import android.content.Context;\n+import androidx.annotation.Nullable;\n import androidx.appcompat.app.AlertDialog;\n-import com.google.android.gnd.R;\n-import com.google.android.gnd.model.form.Field;\n import com.google.android.gnd.model.form.MultipleChoice;\n import com.google.android.gnd.model.form.Option;\n import com.google.android.gnd.model.observation.MultipleChoiceResponse;\n import com.google.android.gnd.model.observation.Response;\n+import com.google.auto.value.AutoValue;\n import com.google.common.collect.ImmutableList;\n-import java.util.List;\n import java8.util.Optional;\n import java8.util.function.Consumer;\n import java8.util.stream.IntStreams;\n \n-// TODO: Replace with modal bottom sheet.\n-class MultiSelectDialogFactory {\n+@AutoValue\n+abstract class MultiSelectDialogFactory extends SelectDialogFactory {\n \n-  private Context context;\n+  @Nullable private boolean[] checkedItems;\n \n-  MultiSelectDialogFactory(Context context) {\n-    this.context = context;\n+  private static Builder builder() {\n+    return new AutoValue_MultiSelectDialogFactory.Builder();\n   }\n \n-  AlertDialog create(\n-      Field field,\n-      Optional<Response> initialResponse,\n-      Consumer<Optional<Response>> responseChangeCallback) {\n-    MultipleChoice multipleChoice = field.getMultipleChoice();\n-    checkNotNull(\n-        multipleChoice,\n-        \"When creating a MultiSelectDialogFactory the field must have a non-null MultipleChoice\");\n-\n-    AlertDialog.Builder dialogBuilder = new AlertDialog.Builder(context);\n-    List<Option> options = multipleChoice.getOptions();\n-    final DialogState state = new DialogState(multipleChoice, initialResponse);\n-    dialogBuilder.setMultiChoiceItems(\n-        getLabels(multipleChoice), state.checkedItems, (dialog, which, isChecked) -> {});\n-    dialogBuilder.setCancelable(false);\n-    dialogBuilder.setTitle(field.getLabel());\n-    dialogBuilder.setPositiveButton(\n-        R.string.apply_multiple_choice_changes,\n-        (dialog, which) -> responseChangeCallback.accept(state.getSelectedValues(options)));\n-    dialogBuilder.setNegativeButton(R.string.cancel, (dialog, which) -> {});\n-    return dialogBuilder.create();\n+  public static void showSelectDialog(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc6f7a811385c55f1975b3d6580f63c52a7b0d51"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0NDc0Ng==", "bodyText": "Same here.", "url": "https://github.com/google/ground-android/pull/675#discussion_r549744746", "createdAt": "2020-12-29T15:25:06Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/SingleSelectDialogFactory.java", "diffHunk": "@@ -16,91 +16,79 @@\n \n package com.google.android.gnd.ui.editobservation;\n \n-import static com.google.common.base.Preconditions.checkNotNull;\n-import static java8.util.stream.StreamSupport.stream;\n-\n import android.content.Context;\n import android.content.DialogInterface;\n import androidx.appcompat.app.AlertDialog;\n-import com.google.android.gnd.R;\n-import com.google.android.gnd.model.form.Field;\n import com.google.android.gnd.model.form.MultipleChoice;\n import com.google.android.gnd.model.form.Option;\n import com.google.android.gnd.model.observation.MultipleChoiceResponse;\n import com.google.android.gnd.model.observation.Response;\n+import com.google.auto.value.AutoValue;\n import com.google.common.collect.ImmutableList;\n-import java.util.List;\n import java8.util.Optional;\n import java8.util.function.Consumer;\n \n-// TODO: Replace with modal bottom sheet.\n-class SingleSelectDialogFactory {\n+@AutoValue\n+abstract class SingleSelectDialogFactory extends SelectDialogFactory {\n \n-  private Context context;\n+  private int checkedItem;\n \n-  SingleSelectDialogFactory(Context context) {\n-    this.context = context;\n+  private static Builder builder() {\n+    return new AutoValue_SingleSelectDialogFactory.Builder();\n   }\n \n-  AlertDialog create(\n-      Field field,\n-      Optional<Response> initialValue,\n-      Consumer<Optional<Response>> valueChangeCallback) {\n-    MultipleChoice multipleChoice = field.getMultipleChoice();\n-    checkNotNull(\n-        multipleChoice,\n-        \"When creating a SingleSelectDialogFactory the field must have a non-null MultipleChoice\"\n-    );\n-\n-    AlertDialog.Builder dialogBuilder = new AlertDialog.Builder(context);\n-    List<Option> options = multipleChoice.getOptions();\n-    DialogState state = new DialogState(multipleChoice, initialValue);\n-    dialogBuilder.setSingleChoiceItems(\n-        getLabels(multipleChoice), state.checkedItem, state::onSelect);\n-    dialogBuilder.setCancelable(false);\n-    dialogBuilder.setTitle(field.getLabel());\n-    dialogBuilder.setPositiveButton(\n-        R.string.apply_multiple_choice_changes,\n-        (dialog, which) -> valueChangeCallback.accept(state.getSelectedValue(options)));\n-    dialogBuilder.setNegativeButton(R.string.cancel, (dialog, which) -> {});\n-    return dialogBuilder.create();\n+  public static void showSelectDialog(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc6f7a811385c55f1975b3d6580f63c52a7b0d51"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6eca88da25be3c363fc4b2fae85d91a591b0391", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/a6eca88da25be3c363fc4b2fae85d91a591b0391", "committedDate": "2020-12-29T17:10:44Z", "message": "Set default checked value for single select"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjI3Njkw", "url": "https://github.com/google/ground-android/pull/675#pullrequestreview-559627690", "createdAt": "2020-12-29T17:19:32Z", "commit": {"oid": "d537f15e632625a64dbfaebe584b443dac6bc000"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzoxOTozMlrOIMUKyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQxNzoxOTozMlrOIMUKyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc4NDI2NQ==", "bodyText": "If getValue() returns an Optional, it shouldn't also be nullable. Would it be difficult to update it so that getValue() is @NonNull?", "url": "https://github.com/google/ground-android/pull/675#discussion_r549784265", "createdAt": "2020-12-29T17:19:32Z", "author": {"login": "gino-m"}, "path": "gnd/src/main/java/com/google/android/gnd/ui/editobservation/MultipleChoiceFieldViewModel.java", "diffHunk": "@@ -37,4 +39,10 @@ public void onShowDialog() {\n   MutableLiveData<Nil> getShowDialogClicks() {\n     return showDialogClicks;\n   }\n+\n+  Optional<MultipleChoiceResponse> getCurrentResponse() {\n+    return getResponse().getValue() == null", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTc0Mjk0Nw=="}, "originalCommit": {"oid": "d537f15e632625a64dbfaebe584b443dac6bc000"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0ef2009cca65aaf17edf36d151d41147174b204", "author": {"user": {"login": "shobhitagarwal1612", "name": "Shobhit Agarwal"}}, "url": "https://github.com/google/ground-android/commit/d0ef2009cca65aaf17edf36d151d41147174b204", "committedDate": "2020-12-29T17:27:28Z", "message": "Create dialog in fragment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NjQ2MDQ3", "url": "https://github.com/google/ground-android/pull/675#pullrequestreview-559646047", "createdAt": "2020-12-29T18:12:29Z", "commit": {"oid": "d0ef2009cca65aaf17edf36d151d41147174b204"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1536, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}