{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzMzIyMzI3", "number": 2106, "title": "Optimizations for Paper (cargo network optimizations)", "bodyText": "Description\n\nThis Pull Request introduces a bunch of optimizations for Servers using Paper.\nPaper uses Asynchronous Chunk Generation/Loading which can improve performance for long-distance teleports.\nBlockState Snapshots\nNormally, Spigot creates a new BlockState instance as a hard copy, for InventoryHolders the Inventory is only copied softly, as a reference. Since Inventories are already Thread-safe and only the reference is passed, cargo networks have no reason to create a BlockState snapshot.\nThis behaviour cannot be avoided when using Spigot, with Paper it can.\nSo this will improve performance drastically (Sometimes up to 6 times smoother from what i tested) and optimize Cargo networks to work best when using Paper.\nChanges\n\n\nAdded PaperLib as a shaded dependency\nAdded the \"Works best with Paper\" suggestion on startup\nOptimized teleporter and elevators to use async-chunk-loading when possible\nHuge optimizations for Cargo networks and multiblocks to not take BlockState snapshots when accessing inventories\n\nChecklist\n\n\n\n I have fully tested the proposed changes and promise that they will not break everything into chaos.\n I have also tested the proposed changes in combination with various popular addons and can confirm my changes do not break them.\n I followed the existing code standards and didn't mess up the formatting.\n I did my best to add documentation to any public classes or methods I added.\n I added sufficient Unit Tests to cover my code.", "createdAt": "2020-07-20T10:53:21Z", "url": "https://github.com/Slimefun/Slimefun4/pull/2106", "merged": true, "mergeCommit": {"oid": "a1952edde3f96c313e288042d10bcbac01a547e0"}, "closed": true, "closedAt": "2020-07-21T08:17:47Z", "author": {"login": "TheBusyBiscuit"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2l9HVAH2gAyNDUzMzIyMzI3OmFlNzgwYTY5YmJlMDc2Y2VjYTA5ZGZjMGFiYmI3YzdhM2NhM2NlM2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3Bfu8gH2gAyNDUzMzIyMzI3OjZlZWJiNzkzMTQ0YTA4YjBmOWRmYmQ5NjkxMmI0ZDM0MWI1ZjE2ZTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae780a69bbe076ceca09dfc0abbb7c7a3ca3ce3b", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/ae780a69bbe076ceca09dfc0abbb7c7a3ca3ce3b", "committedDate": "2020-07-19T23:51:14Z", "message": "Added PaperLib"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "045cdf1090b03c8752e34ff4dca323ff0c8e1f76", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/045cdf1090b03c8752e34ff4dca323ff0c8e1f76", "committedDate": "2020-07-20T00:22:24Z", "message": "Added performance improvements for Block States"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1d6021216f9aadb5a64fee020eed404b9a80232", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/c1d6021216f9aadb5a64fee020eed404b9a80232", "committedDate": "2020-07-20T00:31:58Z", "message": "Optimized teleportations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64b59e3a023bbfb18bbb6680dce3272056737159", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/64b59e3a023bbfb18bbb6680dce3272056737159", "committedDate": "2020-07-20T01:05:49Z", "message": "Spigot is now called \"Spigot\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4c0c9f905e779d03b446fbddd01f5c40320fb0d", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/f4c0c9f905e779d03b446fbddd01f5c40320fb0d", "committedDate": "2020-07-20T08:49:59Z", "message": "Minor changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd10f2ea4cdc97fa83e2e076e50452b90bd452b7", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/fd10f2ea4cdc97fa83e2e076e50452b90bd452b7", "committedDate": "2020-07-20T10:48:25Z", "message": "Merge branch 'master' of https://github.com/TheBusyBiscuit/Slimefun4 into paper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "397f1940292feaf8aea2164a46fc7df9bf975bc6", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/397f1940292feaf8aea2164a46fc7df9bf975bc6", "committedDate": "2020-07-20T11:08:13Z", "message": "Fixed two synchronization issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTk3NjI2", "url": "https://github.com/Slimefun/Slimefun4/pull/2106#pullrequestreview-451597626", "createdAt": "2020-07-20T13:20:30Z", "commit": {"oid": "397f1940292feaf8aea2164a46fc7df9bf975bc6"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoyMDozMFrOG0L_Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoyMjozMVrOG0MGXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3NTUxOA==", "bodyText": "English?", "url": "https://github.com/Slimefun/Slimefun4/pull/2106#discussion_r457375518", "createdAt": "2020-07-20T13:20:30Z", "author": {"login": "WalshyDev"}, "path": "src/main/java/io/github/thebusybiscuit/slimefun4/core/commands/subcommands/VersionsCommand.java", "diffHunk": "@@ -33,7 +34,10 @@ public boolean isHidden() {\n     @Override\n     public void onExecute(CommandSender sender, String[] args) {\n         if (sender.hasPermission(\"slimefun.command.versions\") || sender instanceof ConsoleCommandSender) {\n-            sender.sendMessage(ChatColors.color(\"&a\" + Bukkit.getName() + \" &2\" + ReflectionUtils.getVersion()));\n+            // After all these years... Spigot still displays as \"CraftBukkit\"\n+            // so we will just this issue for them :)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "397f1940292feaf8aea2164a46fc7df9bf975bc6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3NzM3Mg==", "bodyText": "These strings are nullable", "url": "https://github.com/Slimefun/Slimefun4/pull/2106#discussion_r457377372", "createdAt": "2020-07-20T13:22:31Z", "author": {"login": "WalshyDev"}, "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/items/gps/ElevatorPlate.java", "diffHunk": "@@ -134,8 +135,12 @@ public void open(Player p, Block b) {\n                         yaw = -180 + (yaw - 180);\n                     }\n \n-                    player.teleport(new Location(player.getWorld(), block.getX() + 0.5, block.getY() + 0.4, block.getZ() + 0.5, yaw, player.getEyeLocation().getPitch()));\n-                    player.sendTitle(ChatColor.WHITE + ChatColors.color(floor), \" \", 20, 60, 20);\n+                    Location destination = new Location(player.getWorld(), block.getX() + 0.5, block.getY() + 0.4, block.getZ() + 0.5, yaw, player.getEyeLocation().getPitch());\n+                    PaperLib.teleportAsync(player, destination).thenAccept(teleported -> {\n+                        if (teleported.booleanValue()) {\n+                            Slimefun.runSync(() -> player.sendTitle(ChatColor.WHITE + ChatColors.color(floor), \" \", 20, 60, 20));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "397f1940292feaf8aea2164a46fc7df9bf975bc6"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29b26ed32790448b5a22292d5f5c463bd23d788d", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/29b26ed32790448b5a22292d5f5c463bd23d788d", "committedDate": "2020-07-20T14:30:20Z", "message": "Made requested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d64f37999543ed84df0106bfcf14e36b3041d4a", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/2d64f37999543ed84df0106bfcf14e36b3041d4a", "committedDate": "2020-07-20T17:33:03Z", "message": "Update CHANGELOG.md"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODI1MjQy", "url": "https://github.com/Slimefun/Slimefun4/pull/2106#pullrequestreview-451825242", "createdAt": "2020-07-20T17:45:04Z", "commit": {"oid": "2d64f37999543ed84df0106bfcf14e36b3041d4a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzo0NTowNFrOG0YvVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzo1NDowOVrOG0ZDzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4NDQ2OA==", "bodyText": "Probably best to use Arrays.asList\nI can't see a reason why this should be done. Would be slower and means there's a mutable list (even if for a short time)", "url": "https://github.com/Slimefun/Slimefun4/pull/2106#discussion_r457584468", "createdAt": "2020-07-20T17:45:04Z", "author": {"login": "WalshyDev"}, "path": "src/main/java/io/github/thebusybiscuit/slimefun4/api/gps/TeleportationManager.java", "diffHunk": "@@ -58,10 +61,21 @@ public void openTeleporterGUI(Player p, UUID uuid, Block b, int complexity) {\n                 }\n \n                 int slot = teleporterInventory[index];\n-\n                 Location l = waypoint.getLocation();\n-                menu.addItem(slot,\n-                        new CustomItem(waypoint.getIcon(), waypoint.getName().replace(\"player:death \", \"\"), \"\", \"&8\\u21E8 &7\" + SlimefunPlugin.getLocalization().getResourceString(p, \"tooltips.world\") + \": &f\" + l.getWorld().getName(), \"&8\\u21E8 &7X: &f\" + l.getX(), \"&8\\u21E8 &7Y: &f\" + l.getY(), \"&8\\u21E8 &7Z: &f\" + l.getZ(), \"&8\\u21E8 &7\" + SlimefunPlugin.getLocalization().getMessage(p, \"machines.TELEPORTER.gui.time\") + \": &f\" + DoubleHandler.fixDouble(0.5 * getTeleportationTime(complexity, source, l)) + \"s\", \"\", \"&8\\u21E8 &c\" + SlimefunPlugin.getLocalization().getMessage(p, \"machines.TELEPORTER.gui.tooltip\")));\n+                double time = DoubleHandler.fixDouble(0.5 * getTeleportationTime(complexity, source, l));\n+\n+                List<String> nameAndLore = new ArrayList<>();\n+                nameAndLore.add(waypoint.getName().replace(\"player:death \", \"\"));\n+                nameAndLore.add(\"\");\n+                nameAndLore.add(\"&8\\u21E8 &7\" + SlimefunPlugin.getLocalization().getResourceString(p, \"tooltips.world\") + \": &f\" + l.getWorld().getName());\n+                nameAndLore.add(\"&8\\u21E8 &7X: &f\" + l.getX());\n+                nameAndLore.add(\"&8\\u21E8 &7Y: &f\" + l.getY());\n+                nameAndLore.add(\"&8\\u21E8 &7Z: &f\" + l.getZ());\n+                nameAndLore.add(\"&8\\u21E8 &7\" + SlimefunPlugin.getLocalization().getMessage(p, \"machines.TELEPORTER.gui.time\") + \": &f\" + time + \"s\");\n+                nameAndLore.add(\"\");\n+                nameAndLore.add(\"&8\\u21E8 &c\" + SlimefunPlugin.getLocalization().getMessage(p, \"machines.TELEPORTER.gui.tooltip\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d64f37999543ed84df0106bfcf14e36b3041d4a"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4OTcwOA==", "bodyText": "Check if this can be async first.", "url": "https://github.com/Slimefun/Slimefun4/pull/2106#discussion_r457589708", "createdAt": "2020-07-20T17:54:09Z", "author": {"login": "WalshyDev"}, "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/items/gps/ElevatorPlate.java", "diffHunk": "@@ -134,8 +135,12 @@ public void open(Player p, Block b) {\n                         yaw = -180 + (yaw - 180);\n                     }\n \n-                    player.teleport(new Location(player.getWorld(), block.getX() + 0.5, block.getY() + 0.4, block.getZ() + 0.5, yaw, player.getEyeLocation().getPitch()));\n-                    player.sendTitle(ChatColor.WHITE + ChatColors.color(floor), \" \", 20, 60, 20);\n+                    Location destination = new Location(player.getWorld(), block.getX() + 0.5, block.getY() + 0.4, block.getZ() + 0.5, yaw, player.getEyeLocation().getPitch());\n+                    PaperLib.teleportAsync(player, destination).thenAccept(teleported -> {\n+                        if (teleported.booleanValue()) {\n+                            Slimefun.runSync(() -> player.sendTitle(ChatColor.WHITE + ChatColors.color(floor), null, 20, 60, 20));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d64f37999543ed84df0106bfcf14e36b3041d4a"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eebb793144a08b0f9dfbd96912b4d341b5f16e0", "author": {"user": {"login": "TheBusyBiscuit", "name": "TheBusyBiscuit"}}, "url": "https://github.com/Slimefun/Slimefun4/commit/6eebb793144a08b0f9dfbd96912b4d341b5f16e0", "committedDate": "2020-07-21T07:56:29Z", "message": "Fixed"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2511, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}