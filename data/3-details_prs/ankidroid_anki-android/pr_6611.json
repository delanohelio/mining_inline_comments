{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MzAzMjgz", "number": 6611, "title": "Card browser show even on close", "bodyText": "There is currently the following problem in ankidroid:\n\nSearch for a big number of card\nquickly change app on android. The window should not be displayed anymore\nwait some time\ncome back to AnkiDroid\n\nIt should show the list of card, or being processing. Instead it shows\nthere are 0 card found.\nThis is because, when the app change, onStop is called, and this\ncancel the search. Instead, the cancellation should occur in\nonDestroy, whene there the search is not used anymore.\nI also allow to cancel another background task if it is not useful anymore.\nTesting it on my phone\nFixes #7017", "createdAt": "2020-07-04T16:25:29Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6611", "merged": true, "mergeCommit": {"oid": "32a4e06304dcafc47d7048586c482bbbd209a84d"}, "closed": true, "closedAt": "2020-09-06T23:40:42Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxq5lggFqTQ0MjYyMDAxNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGViWBABqjM3MzQ1NDk5Mzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjIwMDE3", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#pullrequestreview-442620017", "createdAt": "2020-07-04T16:47:17Z", "commit": {"oid": "34c69af67636aa087648777b67780393376223ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxNjo0NzoxN1rOGs83iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxNjo0NzoxN1rOGs83iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Nzc4Nw==", "bodyText": "this comment seems related, and a little like a warning. what does shared access to mCards mean now if we continue using it in between onStop and onDestroy ? I am not sure it means anything and the change otherwise seems like it should be okay though", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r449787787", "createdAt": "2020-07-04T16:47:17Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -676,8 +676,6 @@ private void openNoteEditorForCurrentlySelectedNote() {\n     protected void onStop() {\n         Timber.d(\"onStop()\");\n         // cancel rendering the question and answer, which has shared access to mCards", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34c69af67636aa087648777b67780393376223ec"}, "originalPosition": 3}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aae28d7cd72e186881281fb8078e76e39f1bbfc8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/aae28d7cd72e186881281fb8078e76e39f1bbfc8", "committedDate": "2020-07-04T16:19:10Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "d16059f5fd2b385d7de356e63a31da65ec0a93c7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d16059f5fd2b385d7de356e63a31da65ec0a93c7", "committedDate": "2020-07-04T17:08:23Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjIxNzI4", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#pullrequestreview-442621728", "createdAt": "2020-07-04T17:21:48Z", "commit": {"oid": "d16059f5fd2b385d7de356e63a31da65ec0a93c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d16059f5fd2b385d7de356e63a31da65ec0a93c7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d16059f5fd2b385d7de356e63a31da65ec0a93c7", "committedDate": "2020-07-04T17:08:23Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "8262d9f0cd566847740ad0edefc8a9434fef7a9d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8262d9f0cd566847740ad0edefc8a9434fef7a9d", "committedDate": "2020-07-04T19:55:31Z", "message": "tmp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "633e45049e4003a275ccaca3aa9558f2bff4209c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/633e45049e4003a275ccaca3aa9558f2bff4209c", "committedDate": "2020-07-04T20:02:14Z", "message": "NF: remove getInstance\n\nIt is never used, and is probably a bad idea"}, "afterCommit": {"oid": "9df643e202ff553ab829a7059306a8ea1c7b057c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9df643e202ff553ab829a7059306a8ea1c7b057c", "committedDate": "2020-07-04T20:15:29Z", "message": "NF: remove getInstance\n\nIt is never used, and is probably a bad idea"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9df643e202ff553ab829a7059306a8ea1c7b057c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9df643e202ff553ab829a7059306a8ea1c7b057c", "committedDate": "2020-07-04T20:15:29Z", "message": "NF: remove getInstance\n\nIt is never used, and is probably a bad idea"}, "afterCommit": {"oid": "7463d47c897c8a3bbdc97169c60dc99f020063f3", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7463d47c897c8a3bbdc97169c60dc99f020063f3", "committedDate": "2020-07-04T20:15:27Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7463d47c897c8a3bbdc97169c60dc99f020063f3", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7463d47c897c8a3bbdc97169c60dc99f020063f3", "committedDate": "2020-07-04T20:15:27Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "1481e381551b090e4e839c9c145230b9fc8b0b85", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1481e381551b090e4e839c9c145230b9fc8b0b85", "committedDate": "2020-07-05T15:22:47Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1481e381551b090e4e839c9c145230b9fc8b0b85", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1481e381551b090e4e839c9c145230b9fc8b0b85", "committedDate": "2020-07-05T15:22:47Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "07c9e7d53439b6a8b7e7475fe3cb96497246513d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/07c9e7d53439b6a8b7e7475fe3cb96497246513d", "committedDate": "2020-07-05T19:46:23Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07c9e7d53439b6a8b7e7475fe3cb96497246513d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/07c9e7d53439b6a8b7e7475fe3cb96497246513d", "committedDate": "2020-07-05T19:46:23Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "edd972a8b6a3cab55f2de344f78bac3b8aeffa84", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/edd972a8b6a3cab55f2de344f78bac3b8aeffa84", "committedDate": "2020-07-05T23:44:15Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edd972a8b6a3cab55f2de344f78bac3b8aeffa84", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/edd972a8b6a3cab55f2de344f78bac3b8aeffa84", "committedDate": "2020-07-05T23:44:15Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}, "afterCommit": {"oid": "59822264e6481a2fae8e620de6f94aa230f6c052", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/59822264e6481a2fae8e620de6f94aa230f6c052", "committedDate": "2020-07-21T20:50:01Z", "message": "NF: Model type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9030db370cc3410524d2b9d8906222c2b52e687d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9030db370cc3410524d2b9d8906222c2b52e687d", "committedDate": "2020-07-22T05:35:27Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "37007bde2b3de9a70fce7394bd6bd08b73ae4752", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/37007bde2b3de9a70fce7394bd6bd08b73ae4752", "committedDate": "2020-07-24T10:52:39Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fefff829dd8498e1ab0f2febc9f30d6b1e6e60a7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fefff829dd8498e1ab0f2febc9f30d6b1e6e60a7", "committedDate": "2020-08-01T17:06:26Z", "message": "Merge branch 'getCardQuicker' into card_browser_show_even_on_close"}, "afterCommit": {"oid": "02af1aed4d04162feedaeeac1a90b33ceca34423", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/02af1aed4d04162feedaeeac1a90b33ceca34423", "committedDate": "2020-08-02T09:11:13Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02af1aed4d04162feedaeeac1a90b33ceca34423", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/02af1aed4d04162feedaeeac1a90b33ceca34423", "committedDate": "2020-08-02T09:11:13Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "df8df4d15dc964cc499d2143be7523d4fcce26b5", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/df8df4d15dc964cc499d2143be7523d4fcce26b5", "committedDate": "2020-08-15T23:19:01Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df8df4d15dc964cc499d2143be7523d4fcce26b5", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/df8df4d15dc964cc499d2143be7523d4fcce26b5", "committedDate": "2020-08-15T23:19:01Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "9c128fd927cbf024e3d531acc01aa1f22081c5df", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9c128fd927cbf024e3d531acc01aa1f22081c5df", "committedDate": "2020-08-30T21:57:38Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a993e993d29f7c0658c1cd787a7475ba95e7f454", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a993e993d29f7c0658c1cd787a7475ba95e7f454", "committedDate": "2020-09-06T20:58:42Z", "message": "Cards are displayed in card browser after return from background\n\nThere is currently the following problem in ankidroid:\n* Search for a big number of card\n* quickly change app on android. The window should not be displayed anymore\n* wait some time\n* come back to AnkiDroid\n\nIt should show the list of card, or being processing. Instead it shows\nthere are 0 card found.\n\nThis is because, when the app change, onStop is called, and this\ncancel the search. Instead, the cancellation should occur in\nonDestroy, whene there the search is not used anymore."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c128fd927cbf024e3d531acc01aa1f22081c5df", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9c128fd927cbf024e3d531acc01aa1f22081c5df", "committedDate": "2020-08-30T21:57:38Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "fd226fd80d65236453b1bd4467194b3ea9dfa6da", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fd226fd80d65236453b1bd4467194b3ea9dfa6da", "committedDate": "2020-09-06T21:00:04Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTc0MTA4", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#pullrequestreview-483174108", "createdAt": "2020-09-06T21:32:02Z", "commit": {"oid": "fd226fd80d65236453b1bd4467194b3ea9dfa6da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMTozMjowMlrOHNsGyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMTozMjowMlrOHNsGyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExNjE3MA==", "bodyText": "this did not ever return null before, should annotate the method as @Nullable now to see what falls out from that (if anything)\nThere is still the general idea from previous comments that I do not believe has been tested:\nfrom @david-allison-1:\n\nI believe that this PR introduces an unlikely path where this could happen (note editor card template editor -> delete card template).\nIf we're going to introduce this potential bug, we should ensure that the card browser will handle a deleted card correctly.\n\nfrom me:\n\nMaybe to be defensive, CardBrowser should just never trust state after delegating out to NoteEditor and should always invalidate itself/cancel tasks/research. For instance right now if you went CardBrowser -> NoteEditor -> CardTemplateEditor -> CardBrowserAppearance you are clearly interested in changing the way things look in the card browser right? But I don't think it will actually refresh when you return.", "url": "https://github.com/ankidroid/Anki-Android/pull/6611#discussion_r484116170", "createdAt": "2020-09-06T21:32:02Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1879,6 +1879,10 @@ public TaskData doInBackgroundCheckCardSelection(TaskData param) {\n         boolean hasUnsuspended = false;\n         boolean hasUnmarked = false;\n         for (CardBrowser.CardCache c: checkedCards) {\n+            if (isCancelled()) {\n+                Timber.v(\"doInBackgroundCheckCardSelection: cancelled.\");\n+                return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd226fd80d65236453b1bd4467194b3ea9dfa6da"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9baa80463e9dc704c207c82683db1b6b9ba63217", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9baa80463e9dc704c207c82683db1b6b9ba63217", "committedDate": "2020-09-06T21:46:10Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd226fd80d65236453b1bd4467194b3ea9dfa6da", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fd226fd80d65236453b1bd4467194b3ea9dfa6da", "committedDate": "2020-09-06T21:00:04Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}, "afterCommit": {"oid": "9baa80463e9dc704c207c82683db1b6b9ba63217", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9baa80463e9dc704c207c82683db1b6b9ba63217", "committedDate": "2020-09-06T21:46:10Z", "message": "NF: alow to cancel Task_type_Check_Card_selection\n\nIt's kind of inneficient right now if we select all suspended\ncards. That's not a real trouble, but still useful to avoid leaving\nuseles computation in background"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3069, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}