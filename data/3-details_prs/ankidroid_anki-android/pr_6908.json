{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MTQ5MjU0", "number": 6908, "title": "Reviewer: undo gets faster (performance)", "bodyText": "Pull Request template\nPurpose / Description\nUndo is slow. One of the reason is that it gets the card from the database. This is actually useless, we usually could as easily save the card than the ID. This lead to saving 20 card object instead of 20 long, this is not a huge cost in term of memory.\nSending the card directly to the reviewer ensure that it can be displayed almost immediately. It removes one of the last slow operation I had on my phone. (There remains bury/suspend... but I've no idea how to improve this more at this time)\nHow Has This Been Tested?\nOn my phone, doing undo and ensuring that it appears almost without delay.\nLearning (optional, can help others)\nWhen you spent dozen of hours working on background tasks and then some on the Undoable, and then on the list of undo, you can still miss this obvious optimization... and I don't know why it took me so much time to see it !\nI may be wrong, but I suspect that if I didn't introduce this Undoable class, I would not have understood what is going on as well, and I may be would not have seen this optimization. But maybe I'm just trying to justify doing so much refactoring\nTodo: in study option fragment: open reviewer and call undo from the reviewer, so that it actually gets the card undone instead of calling sched.getCard()\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-08-18T01:37:00Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6908", "merged": true, "mergeCommit": {"oid": "45a6dd28ec6ca53431c830118c6a40f03126fa4c"}, "closed": true, "closedAt": "2020-09-02T21:43:37Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEB1P-AFqTQ3ODIyMTYzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFBpP8gBqjM3MjE1NDcyNTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjIxNjMz", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#pullrequestreview-478221633", "createdAt": "2020-08-30T17:41:00Z", "commit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjIxOTAw", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#pullrequestreview-478221900", "createdAt": "2020-08-30T17:45:34Z", "commit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNzo0NTozNFrOHJkeQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNzo0ODoxNlrOHJkfWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc5NjgwMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public Card undo(Collection col) {\n          \n          \n            \n                    public @Nullable Card undo(Collection col) {", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#discussion_r479796800", "createdAt": "2020-08-30T17:45:34Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -641,29 +641,29 @@ public UndoSuspendCard(Card suspendedCard) {\n         }\n \n \n-        public long undo(Collection col) {\n+        public Card undo(Collection col) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc5Njg4Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private final Card card;\n          \n          \n            \n                    private final @Nullable Card card;", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#discussion_r479796887", "createdAt": "2020-08-30T17:46:24Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -641,29 +641,29 @@ public UndoSuspendCard(Card suspendedCard) {\n         }\n \n \n-        public long undo(Collection col) {\n+        public Card undo(Collection col) {\n             Timber.i(\"UNDO: Suspend Card %d\", suspendedCard.getId());\n             suspendedCard.flush(false);\n-            return suspendedCard.getId();\n+            return suspendedCard;\n         }\n     }\n \n \n     private static class UndoDeleteNote extends Undoable {\n         private final Note note;\n         private final ArrayList<Card> allCs;\n-        private final long cid;\n+        private final Card card;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc5NjkwMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public UndoDeleteNote(Note note, ArrayList<Card> allCs, Card card) {\n          \n          \n            \n                    public UndoDeleteNote(Note note, ArrayList<Card> allCs, @Nullable Card card) {", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#discussion_r479796903", "createdAt": "2020-08-30T17:46:36Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -641,29 +641,29 @@ public UndoSuspendCard(Card suspendedCard) {\n         }\n \n \n-        public long undo(Collection col) {\n+        public Card undo(Collection col) {\n             Timber.i(\"UNDO: Suspend Card %d\", suspendedCard.getId());\n             suspendedCard.flush(false);\n-            return suspendedCard.getId();\n+            return suspendedCard;\n         }\n     }\n \n \n     private static class UndoDeleteNote extends Undoable {\n         private final Note note;\n         private final ArrayList<Card> allCs;\n-        private final long cid;\n+        private final Card card;\n \n \n-        public UndoDeleteNote(Note note, ArrayList<Card> allCs, long cid) {\n+        public UndoDeleteNote(Note note, ArrayList<Card> allCs, Card card) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc5Njk0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public Card undo(Collection col) {\n          \n          \n            \n                    public @Nullable Card undo(Collection col) {", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#discussion_r479796949", "createdAt": "2020-08-30T17:47:01Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -768,7 +767,7 @@ public UndoSuspendCardMulti(Card[] cards, boolean[] originalSuspended) {\n         }\n \n \n-        public long undo(Collection col) {\n+        public Card undo(Collection col) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc5Njk5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public Card undo(Collection col) {\n          \n          \n            \n                    public @Nullable Card undo(Collection col) {", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#discussion_r479796993", "createdAt": "2020-08-30T17:47:20Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -812,7 +811,7 @@ public UndoDeleteNoteMulti(Note[] notesArr, List<Card> allCards) {\n         }\n \n \n-        public long undo(Collection col) {\n+        public Card undo(Collection col) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc5NzAyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public Card undo(Collection col) {\n          \n          \n            \n                    public @Nullable Card undo(Collection col) {", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#discussion_r479797026", "createdAt": "2020-08-30T17:47:32Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -843,7 +842,7 @@ public UndoChangeDeckMulti(Card[] cards, long[] originalDids) {\n         }\n \n \n-        public long undo(Collection col) {\n+        public Card undo(Collection col) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc5NzA0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    public Card undo(Collection col) {\n          \n          \n            \n                    public @Nullable Card undo(Collection col) {", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#discussion_r479797040", "createdAt": "2020-08-30T17:47:42Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -871,11 +870,11 @@ public UndoMarkNoteMulti(List<Note> originalMarked, List<Note> originalUnmarked)\n         }\n \n \n-        public long undo(Collection col) {\n+        public Card undo(Collection col) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc5NzA4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Card undo() {\n          \n          \n            \n                public @Nullable Card undo() {", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#discussion_r479797080", "createdAt": "2020-08-30T17:48:16Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1309,7 +1309,7 @@ public boolean undoAvailable() {\n         return mUndo.size() > 0;\n     }\n \n-    public long undo() {\n+    public Card undo() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eae434e3865087bd832a26a60a1e12adabbd4941", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/eae434e3865087bd832a26a60a1e12adabbd4941", "committedDate": "2020-08-18T01:31:06Z", "message": "NF: undo return card"}, "afterCommit": {"oid": "8bb2611537d910ccccc1a12e237876680dd424e4", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8bb2611537d910ccccc1a12e237876680dd424e4", "committedDate": "2020-08-30T18:22:03Z", "message": "NF: undo return card"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8bb2611537d910ccccc1a12e237876680dd424e4", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8bb2611537d910ccccc1a12e237876680dd424e4", "committedDate": "2020-08-30T18:22:03Z", "message": "NF: undo return card"}, "afterCommit": {"oid": "3970aac0aad5ffe887e43c337e58580d0c6f56e9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3970aac0aad5ffe887e43c337e58580d0c6f56e9", "committedDate": "2020-08-30T19:09:52Z", "message": "NF: undo return card"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3970aac0aad5ffe887e43c337e58580d0c6f56e9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3970aac0aad5ffe887e43c337e58580d0c6f56e9", "committedDate": "2020-08-30T19:09:52Z", "message": "NF: undo return card"}, "afterCommit": {"oid": "33af5ed743d8cb3390c03dd1113133458fdab511", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/33af5ed743d8cb3390c03dd1113133458fdab511", "committedDate": "2020-08-30T20:03:30Z", "message": "NF: undo return card"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33af5ed743d8cb3390c03dd1113133458fdab511", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/33af5ed743d8cb3390c03dd1113133458fdab511", "committedDate": "2020-08-30T20:03:30Z", "message": "NF: undo return card"}, "afterCommit": {"oid": "59f3ed735e1ede5ffddd6b90fbb2f5fabf9924aa", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/59f3ed735e1ede5ffddd6b90fbb2f5fabf9924aa", "committedDate": "2020-08-30T20:08:25Z", "message": "NF: undo return card"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjMxNTA1", "url": "https://github.com/ankidroid/Anki-Android/pull/6908#pullrequestreview-478231505", "createdAt": "2020-08-30T20:21:47Z", "commit": {"oid": "59f3ed735e1ede5ffddd6b90fbb2f5fabf9924aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59f3ed735e1ede5ffddd6b90fbb2f5fabf9924aa", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/59f3ed735e1ede5ffddd6b90fbb2f5fabf9924aa", "committedDate": "2020-08-30T20:08:25Z", "message": "NF: undo return card"}, "afterCommit": {"oid": "963bbf4b34471d1adf453e4607fc0c454fa48170", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/963bbf4b34471d1adf453e4607fc0c454fa48170", "committedDate": "2020-08-30T23:44:46Z", "message": "NF: undo return card"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baa601fda1b438ab0580c5e372f40c72dab18c18", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/baa601fda1b438ab0580c5e372f40c72dab18c18", "committedDate": "2020-09-02T19:57:33Z", "message": "NF: Undo moved to background task in Study Option Fragment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79ec35db04fc872007f451099f41f23f47d1e84d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/79ec35db04fc872007f451099f41f23f47d1e84d", "committedDate": "2020-09-02T19:57:33Z", "message": "NF: remove NO_REVIEW"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aca7f7116b991b09b3fd10c65fdcd4aff3fec72", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9aca7f7116b991b09b3fd10c65fdcd4aff3fec72", "committedDate": "2020-09-02T20:01:39Z", "message": "NF: undo return card"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "963bbf4b34471d1adf453e4607fc0c454fa48170", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/963bbf4b34471d1adf453e4607fc0c454fa48170", "committedDate": "2020-08-30T23:44:46Z", "message": "NF: undo return card"}, "afterCommit": {"oid": "9aca7f7116b991b09b3fd10c65fdcd4aff3fec72", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9aca7f7116b991b09b3fd10c65fdcd4aff3fec72", "committedDate": "2020-09-02T20:01:39Z", "message": "NF: undo return card"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2941, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}