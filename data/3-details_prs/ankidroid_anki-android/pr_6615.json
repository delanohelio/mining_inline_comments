{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MzI0Mzk3", "number": 6615, "title": "S tasks", "bodyText": "cancelTask(type) was really strange. I was expecting it to cancel all tasks of a given type. Instead it only cancel current one, and only if it is running.\nThere are few call to this method in the code, and in each case, it seems that the intent of the author is to cancel of tasks of the type, so I believe that it is only going to be an improvement in term of time the user should wait.\nThis PR is required for my recent PR, because allowing to cancel tasks in background was useless since the cancellation event is rarely given to the actual task\nI am going to test it on my phone", "createdAt": "2020-07-04T20:20:07Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6615", "merged": true, "mergeCommit": {"oid": "c18a421db5329cf3f2b86e62a819e5a116265f60"}, "closed": true, "closedAt": "2020-07-05T13:46:50Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxuLCyAFqTQ0MjYzMDM2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxzP5zABqjM1MTI5NzIyODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjMwMzYy", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442630362", "createdAt": "2020-07-04T20:36:04Z", "commit": {"oid": "05640b8a65f65af5a043caff4abb9a4997fe3471"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMDozNjowNFrOGs912Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMDozNjowNFrOGs912Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMzczNw==", "bodyText": "if we're potentially dealing with threading and you're worried (below in the patch) about copy before read because of synchronization, why not actually synchronize like so?\nhttps://stackoverflow.com/a/11360516/9910298", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449803737", "createdAt": "2020-07-04T20:36:04Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -119,6 +119,10 @@\n      * A reference to the application context to use to fetch the current Collection object.\n      */\n     private Context mContext;\n+    /**\n+     * Tasks which are running or waiting to run.\n+     * */\n+    private static List<CollectionTask> sTasks = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05640b8a65f65af5a043caff4abb9a4997fe3471"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjMwNDI4", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442630428", "createdAt": "2020-07-04T20:37:21Z", "commit": {"oid": "05640b8a65f65af5a043caff4abb9a4997fe3471"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMDozNzoyMlrOGs92Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMDozNzoyMlrOGs92Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMzgxNQ==", "bodyText": "Should probably change the name to cancelAllTasksOfType then it's obvious and forces the quick (but needed) inspection of callers to make sure they cope with (or maybe already expect) this behavior\nSeems like a reasonable assumption though, I'm positive on the idea", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449803815", "createdAt": "2020-07-04T20:37:22Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -206,10 +210,15 @@ public static void cancelTask() {\n     }\n \n \n+    /** Cancel all tasks of type taskType*/\n     public static void cancelTask(TASK_TYPE taskType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05640b8a65f65af5a043caff4abb9a4997fe3471"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjMxMTI3", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442631127", "createdAt": "2020-07-04T20:53:41Z", "commit": {"oid": "b16785350df3b0c14a657475156a8fe82869ea24"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjMyMzc4", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442632378", "createdAt": "2020-07-04T21:28:25Z", "commit": {"oid": "b16785350df3b0c14a657475156a8fe82869ea24"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjMzMTM2", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442633136", "createdAt": "2020-07-04T21:51:04Z", "commit": {"oid": "b16785350df3b0c14a657475156a8fe82869ea24"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b16785350df3b0c14a657475156a8fe82869ea24", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b16785350df3b0c14a657475156a8fe82869ea24", "committedDate": "2020-07-04T20:42:49Z", "message": "NF: rename cancelTask to cancelAllTasks"}, "afterCommit": {"oid": "1bd43b4cd71c303013e9e03543213345c53e4cb8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1bd43b4cd71c303013e9e03543213345c53e4cb8", "committedDate": "2020-07-04T22:28:58Z", "message": "NF: rename cancelTask to cancelAllTasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM0NDcz", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442634473", "createdAt": "2020-07-04T22:33:19Z", "commit": {"oid": "1bd43b4cd71c303013e9e03543213345c53e4cb8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMjozMzoxOVrOGs-Qqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMjozMzoxOVrOGs-Qqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMDYwMg==", "bodyText": "After all the synchronized discussion, it orphaned this comment - the comment no longer applies :-)", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449810602", "createdAt": "2020-07-04T22:33:19Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -206,10 +210,16 @@ public static void cancelTask() {\n     }\n \n \n-    public static void cancelTask(TASK_TYPE taskType) {\n-        // cancel the current task only if it's of type taskType\n-        if (sLatestInstance != null && sLatestInstance.mType == taskType) {\n-            cancelTask();\n+    /** Cancel all tasks of type taskType*/\n+    public static void cancelAllTasks(TASK_TYPE taskType) {\n+        // Copying list to array, because cancelled task may be\n+        // removed from list.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1bd43b4cd71c303013e9e03543213345c53e4cb8"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bd43b4cd71c303013e9e03543213345c53e4cb8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1bd43b4cd71c303013e9e03543213345c53e4cb8", "committedDate": "2020-07-04T22:28:58Z", "message": "NF: rename cancelTask to cancelAllTasks"}, "afterCommit": {"oid": "f5e0d1887c600fd0338bdf47ddd1becfa60c09cf", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f5e0d1887c600fd0338bdf47ddd1becfa60c09cf", "committedDate": "2020-07-04T22:38:19Z", "message": "NF: rename cancelTask to cancelAllTasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM0Njc0", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442634674", "createdAt": "2020-07-04T22:39:31Z", "commit": {"oid": "1bd43b4cd71c303013e9e03543213345c53e4cb8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMjo0MDo1N1rOGs-SfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMjo0Mjo1M1rOGs-S8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMTA2OQ==", "bodyText": "The closer I look at it the more little things I see, sorry. But, cancelTask(TASK_TYPE) used to delegate to cancelTask, which just silently eats all Exceptions. Now you are cancelling the task directly so it's missing all this safety code:\n        try {\n            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n                sLatestInstance.cancel(true);\n                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n            }\n        } catch (Exception e) {\n            return;\n        }\n\nthe finished check\nthe logging that it's being cancelled\nthe exception catch", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449811069", "createdAt": "2020-07-04T22:40:57Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -206,10 +210,14 @@ public static void cancelTask() {\n     }\n \n \n-    public static void cancelTask(TASK_TYPE taskType) {\n-        // cancel the current task only if it's of type taskType\n-        if (sLatestInstance != null && sLatestInstance.mType == taskType) {\n-            cancelTask();\n+    /** Cancel all tasks of type taskType*/\n+    public static void cancelAllTasks(TASK_TYPE taskType) {\n+        synchronized (sTasks) {\n+            for (CollectionTask task: sTasks) {\n+                if (task.mType == taskType) {\n+                    task.cancel(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e0d1887c600fd0338bdf47ddd1becfa60c09cf"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMTE4NA==", "bodyText": "This one is actually not cancelAllTasks as the implementation did not change, it is just cancelCurrentTask() semantically, unless you want to delegate to the new \"cancelAllTasks\" idea by doing this:\nif (sLatestInstance != null) {\n  cancelAllTasks(sLatestInstance.mType);\n}", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449811184", "createdAt": "2020-07-04T22:42:53Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -193,7 +197,7 @@ public static boolean waitToFinish(Integer timeout) {\n     }\n \n \n-    public static void cancelTask() {\n+    public static void cancelAllTasks() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e0d1887c600fd0338bdf47ddd1becfa60c09cf"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5e0d1887c600fd0338bdf47ddd1becfa60c09cf", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f5e0d1887c600fd0338bdf47ddd1becfa60c09cf", "committedDate": "2020-07-04T22:38:19Z", "message": "NF: rename cancelTask to cancelAllTasks"}, "afterCommit": {"oid": "8911b61727fa6ccfe378d27995ccfa6341b1fa27", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8911b61727fa6ccfe378d27995ccfa6341b1fa27", "committedDate": "2020-07-04T23:05:48Z", "message": "NF: rename cancelTask to cancelAllTasks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8911b61727fa6ccfe378d27995ccfa6341b1fa27", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8911b61727fa6ccfe378d27995ccfa6341b1fa27", "committedDate": "2020-07-04T23:05:48Z", "message": "NF: rename cancelTask to cancelAllTasks"}, "afterCommit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e", "committedDate": "2020-07-04T23:08:53Z", "message": "NF: rename cancelTask to cancelAllTasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM1OTI3", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442635927", "createdAt": "2020-07-04T23:24:44Z", "commit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM2Mjcy", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442636272", "createdAt": "2020-07-04T23:39:01Z", "commit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMzozOTowMVrOGs-egg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMzo1MTo0N1rOGs-hOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNDE0Ng==", "bodyText": "This exception at the very least needs logging, what does it mean?", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449814146", "createdAt": "2020-07-04T23:39:01Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -192,24 +196,38 @@ public static boolean waitToFinish(Integer timeout) {\n         }\n     }\n \n-\n-    public static void cancelTask() {\n-        //cancel the current task\n+    /** Cancel the current task */\n+    public void safeCancel() {\n         try {\n-            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n-                sLatestInstance.cancel(true);\n-                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n+            if (getStatus() != AsyncTask.Status.FINISHED) {\n+                cancel(true);\n+                Timber.i(\"Cancelled task %s\", mType);\n             }\n         } catch (Exception e) {\n+            sTasks.remove(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNDM5Nw==", "bodyText": "Can you move this to a finally. .remove(object) returns a boolean, so can handle double removal.", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449814397", "createdAt": "2020-07-04T23:43:34Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -192,24 +196,38 @@ public static boolean waitToFinish(Integer timeout) {\n         }\n     }\n \n-\n-    public static void cancelTask() {\n-        //cancel the current task\n+    /** Cancel the current task */\n+    public void safeCancel() {\n         try {\n-            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n-                sLatestInstance.cancel(true);\n-                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n+            if (getStatus() != AsyncTask.Status.FINISHED) {\n+                cancel(true);\n+                Timber.i(\"Cancelled task %s\", mType);\n             }\n         } catch (Exception e) {\n+            sTasks.remove(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNDY1MQ==", "bodyText": "Could you rename either this, or the non-static cancelTask.", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449814651", "createdAt": "2020-07-04T23:48:16Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -192,24 +196,38 @@ public static boolean waitToFinish(Integer timeout) {\n         }\n     }\n \n-\n-    public static void cancelTask() {\n-        //cancel the current task\n+    /** Cancel the current task */\n+    public void safeCancel() {\n         try {\n-            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n-                sLatestInstance.cancel(true);\n-                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n+            if (getStatus() != AsyncTask.Status.FINISHED) {\n+                cancel(true);\n+                Timber.i(\"Cancelled task %s\", mType);\n             }\n         } catch (Exception e) {\n+            sTasks.remove(this);\n             return;\n         }\n+\n+    }\n+\n+\n+    /** cancel the current task safely. */\n+    public static void cancelTask() {\n+        CollectionTask latestInstance = sLatestInstance;\n+        if (latestInstance != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNDY1NA==", "bodyText": "This is O(n^2) [triangular numbers] worst case - removal will shift all elements down by 1 starting at index 0.\nI don't think it matters, but it'd be best to add a comment stating that there's room for improvement here.", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449814654", "createdAt": "2020-07-04T23:48:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -192,24 +196,38 @@ public static boolean waitToFinish(Integer timeout) {\n         }\n     }\n \n-\n-    public static void cancelTask() {\n-        //cancel the current task\n+    /** Cancel the current task */\n+    public void safeCancel() {\n         try {\n-            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n-                sLatestInstance.cancel(true);\n-                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n+            if (getStatus() != AsyncTask.Status.FINISHED) {\n+                cancel(true);\n+                Timber.i(\"Cancelled task %s\", mType);\n             }\n         } catch (Exception e) {\n+            sTasks.remove(this);\n             return;\n         }\n+\n+    }\n+\n+\n+    /** cancel the current task safely. */\n+    public static void cancelTask() {\n+        CollectionTask latestInstance = sLatestInstance;\n+        if (latestInstance != null) {\n+            latestInstance.safeCancel();\n+        };\n     }\n \n \n-    public static void cancelTask(TASK_TYPE taskType) {\n-        // cancel the current task only if it's of type taskType\n-        if (sLatestInstance != null && sLatestInstance.mType == taskType) {\n-            cancelTask();\n+    /** Cancel all tasks of type taskType*/\n+    public static void cancelAllTasks(TASK_TYPE taskType) {\n+        synchronized (sTasks) {\n+            for (CollectionTask task: sTasks) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNDc2OQ==", "bodyText": "For readability, extract this switch to a method, rather than assigning ret here.", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449814769", "createdAt": "2020-07-04T23:50:29Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -255,126 +275,165 @@ protected TaskData doInBackground(TaskData... params) {\n         // Skip the task if the collection cannot be opened\n         if (mType != TASK_TYPE.REPAIR_DECK && CollectionHelper.getInstance().getColSafe(mContext) == null) {\n             Timber.e(\"CollectionTask CollectionTask %s as Collection could not be opened\", mType);\n+            sTasks.remove(this);\n             return null;\n         }\n         // Actually execute the task now that we are at the front of the queue.\n+        TaskData ret = null;\n         switch (mType) {\n             case LOAD_DECK_COUNTS:\n-                return doInBackgroundLoadDeckCounts();\n+                ret = doInBackgroundLoadDeckCounts();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNDg0Mw==", "bodyText": "Is there any way that this can be converted to a finally block?", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449814843", "createdAt": "2020-07-04T23:51:47Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -240,6 +259,7 @@ protected TaskData doInBackground(TaskData... params) {\n                 Thread.currentThread().interrupt();\n                 // We have been interrupted, return immediately.\n                 Timber.d(e, \"interrupted while waiting for previous task: %s\", mPreviousTask.mType);\n+                sTasks.remove(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e"}, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ccef733b9d7b0ea0b1f8c2cc8133bf6cc061fa7e", "committedDate": "2020-07-04T23:08:53Z", "message": "NF: rename cancelTask to cancelAllTasks"}, "afterCommit": {"oid": "b63e05f425789990845f14b6013d9d66c83fa5b2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b63e05f425789990845f14b6013d9d66c83fa5b2", "committedDate": "2020-07-05T00:21:27Z", "message": "NF: remove useless try/catch"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b63e05f425789990845f14b6013d9d66c83fa5b2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b63e05f425789990845f14b6013d9d66c83fa5b2", "committedDate": "2020-07-05T00:21:27Z", "message": "NF: remove useless try/catch"}, "afterCommit": {"oid": "e636dbfbf35e544c239164e2ba911940f34204d5", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e636dbfbf35e544c239164e2ba911940f34204d5", "committedDate": "2020-07-05T00:26:10Z", "message": "NF: remove useless try/catch"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e636dbfbf35e544c239164e2ba911940f34204d5", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e636dbfbf35e544c239164e2ba911940f34204d5", "committedDate": "2020-07-05T00:26:10Z", "message": "NF: remove useless try/catch"}, "afterCommit": {"oid": "423422388c7d80de74f1088196d646a8550a687c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/423422388c7d80de74f1088196d646a8550a687c", "committedDate": "2020-07-05T00:26:40Z", "message": "NF: rename cancelTask to cancelAllTasks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "423422388c7d80de74f1088196d646a8550a687c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/423422388c7d80de74f1088196d646a8550a687c", "committedDate": "2020-07-05T00:26:40Z", "message": "NF: rename cancelTask to cancelAllTasks"}, "afterCommit": {"oid": "073834e3bfaaa9181ee714f01fb49f3484eb27e4", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/073834e3bfaaa9181ee714f01fb49f3484eb27e4", "committedDate": "2020-07-05T00:28:57Z", "message": "NF: rename cancelTask to cancelAllTasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM3OTAw", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442637900", "createdAt": "2020-07-05T00:36:00Z", "commit": {"oid": "3a1fd54f5cbd4ce7dd0bab15edf175b70d933b7b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMDozNjowMFrOGs-q8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMDo0Njo0MVrOGs-tHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNzMyOQ==", "bodyText": "Let's go back to the original list. This is unnecessarily complex", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449817329", "createdAt": "2020-07-05T00:36:00Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -192,24 +198,36 @@ public static boolean waitToFinish(Integer timeout) {\n         }\n     }\n \n-\n-    public static void cancelTask() {\n-        //cancel the current task\n-        try {\n-            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n-                sLatestInstance.cancel(true);\n-                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n-            }\n-        } catch (Exception e) {\n-            return;\n+    /** Cancel the current task */\n+    public void safeCancel() {\n+        if (getStatus() != AsyncTask.Status.FINISHED) {\n+            cancel(true);\n+            Timber.i(\"Cancelled task %s\", mType);\n         }\n+        sTasks.remove(this);\n     }\n \n \n-    public static void cancelTask(TASK_TYPE taskType) {\n-        // cancel the current task only if it's of type taskType\n-        if (sLatestInstance != null && sLatestInstance.mType == taskType) {\n-            cancelTask();\n+    /** cancel the current task safely. */\n+    public static void cancelCurrentlyExecutingTask() {\n+        CollectionTask latestInstance = sLatestInstance;\n+        if (latestInstance != null) {\n+            latestInstance.safeCancel();\n+        };\n+    }\n+\n+\n+    /** Cancel all tasks of type taskType*/\n+    public static void cancelAllTasks(TASK_TYPE taskType) {\n+        synchronized (sTasks) {\n+            Iterator<CollectionTask> taskIterator = sTasks.iterator();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a1fd54f5cbd4ce7dd0bab15edf175b70d933b7b"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNzQyOQ==", "bodyText": "Could we switch this to try...finally, also allows us to return without a ret", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449817429", "createdAt": "2020-07-05T00:38:25Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -223,12 +241,19 @@ public CollectionTask(TASK_TYPE type, Listener listener, CollectionTask previous\n         mType = type;\n         mListener = listener;\n         mPreviousTask = previousTask;\n+        sTasks.add(this);\n     }\n \n \n     // This method and those that are called here are executed in a new thread\n     @Override\n     protected TaskData doInBackground(TaskData... params) {\n+        TaskData ret = actualDoInBackground(params);\n+        sTasks.remove(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a1fd54f5cbd4ce7dd0bab15edf175b70d933b7b"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNzg3Mw==", "bodyText": "This will duplicate many log lines if the same task appears more than once. Maybe move to the caller, and return a boolean and count the number of instances.", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449817873", "createdAt": "2020-07-05T00:46:26Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -192,24 +198,36 @@ public static boolean waitToFinish(Integer timeout) {\n         }\n     }\n \n-\n-    public static void cancelTask() {\n-        //cancel the current task\n-        try {\n-            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n-                sLatestInstance.cancel(true);\n-                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n-            }\n-        } catch (Exception e) {\n-            return;\n+    /** Cancel the current task */\n+    public void safeCancel() {\n+        if (getStatus() != AsyncTask.Status.FINISHED) {\n+            cancel(true);\n+            Timber.i(\"Cancelled task %s\", mType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a1fd54f5cbd4ce7dd0bab15edf175b70d933b7b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxNzg4NA==", "bodyText": "can we also switch back to try...catch...finally", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449817884", "createdAt": "2020-07-05T00:46:41Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -192,24 +198,36 @@ public static boolean waitToFinish(Integer timeout) {\n         }\n     }\n \n-\n-    public static void cancelTask() {\n-        //cancel the current task\n-        try {\n-            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n-                sLatestInstance.cancel(true);\n-                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n-            }\n-        } catch (Exception e) {\n-            return;\n+    /** Cancel the current task */\n+    public void safeCancel() {\n+        if (getStatus() != AsyncTask.Status.FINISHED) {\n+            cancel(true);\n+            Timber.i(\"Cancelled task %s\", mType);\n         }\n+        sTasks.remove(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a1fd54f5cbd4ce7dd0bab15edf175b70d933b7b"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a1fd54f5cbd4ce7dd0bab15edf175b70d933b7b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3a1fd54f5cbd4ce7dd0bab15edf175b70d933b7b", "committedDate": "2020-07-05T00:31:18Z", "message": "NF: cancelTask to cancelCurrentlyExecutingTask\n\nAs requested by David"}, "afterCommit": {"oid": "d577f3f787d1d5481962dabed7db832ec020b37d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d577f3f787d1d5481962dabed7db832ec020b37d", "committedDate": "2020-07-05T01:15:33Z", "message": "NF: cancelTask to cancelCurrentlyExecutingTask\n\nAs requested by David"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d577f3f787d1d5481962dabed7db832ec020b37d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d577f3f787d1d5481962dabed7db832ec020b37d", "committedDate": "2020-07-05T01:15:33Z", "message": "NF: cancelTask to cancelCurrentlyExecutingTask\n\nAs requested by David"}, "afterCommit": {"oid": "22595c5ff499cab6103ce1eadd812e84468d43e6", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/22595c5ff499cab6103ce1eadd812e84468d43e6", "committedDate": "2020-07-05T01:16:37Z", "message": "NF: cancelTask to cancelCurrentlyExecutingTask\n\nAs requested by David"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM5OTUw", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442639950", "createdAt": "2020-07-05T01:55:31Z", "commit": {"oid": "22595c5ff499cab6103ce1eadd812e84468d43e6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMTo1NTozMVrOGs-7ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMTo1ODowNlrOGs-78Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyMTU0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Timber.d(\"Catched exception \" + e);\n          \n          \n            \n                        Timber.w(e, \"Exception cancelling task\");", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449821540", "createdAt": "2020-07-05T01:55:31Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -192,24 +198,47 @@ public static boolean waitToFinish(Integer timeout) {\n         }\n     }\n \n-\n-    public static void cancelTask() {\n-        //cancel the current task\n+    /** Cancel the current task.\n+     * @return whether cancelling did occur.*/\n+    public boolean safeCancel() {\n         try {\n-            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n-                sLatestInstance.cancel(true);\n-                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n+            if (getStatus() != AsyncTask.Status.FINISHED) {\n+                return cancel(true);\n             }\n         } catch (Exception e) {\n-            return;\n+            Timber.d(\"Catched exception \" + e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22595c5ff499cab6103ce1eadd812e84468d43e6"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyMTU5NA==", "bodyText": "nit, implementer's choice: Maybe invert this if", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449821594", "createdAt": "2020-07-05T01:56:24Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -192,24 +198,47 @@ public static boolean waitToFinish(Integer timeout) {\n         }\n     }\n \n-\n-    public static void cancelTask() {\n-        //cancel the current task\n+    /** Cancel the current task.\n+     * @return whether cancelling did occur.*/\n+    public boolean safeCancel() {\n         try {\n-            if ((sLatestInstance != null) && (sLatestInstance.getStatus() != AsyncTask.Status.FINISHED)) {\n-                sLatestInstance.cancel(true);\n-                Timber.i(\"Cancelled task %s\", sLatestInstance.mType);\n+            if (getStatus() != AsyncTask.Status.FINISHED) {\n+                return cancel(true);\n             }\n         } catch (Exception e) {\n-            return;\n+            Timber.d(\"Catched exception \" + e);\n+        } finally {\n+            sTasks.remove(this);\n         }\n+        return false;\n     }\n \n \n-    public static void cancelTask(TASK_TYPE taskType) {\n-        // cancel the current task only if it's of type taskType\n-        if (sLatestInstance != null && sLatestInstance.mType == taskType) {\n-            cancelTask();\n+    /** Cancel the current task only if it's of type taskType */\n+    public static void cancelCurrentlyExecutingTask() {\n+        CollectionTask latestInstance = sLatestInstance;\n+        if (latestInstance != null) {\n+            if (latestInstance.safeCancel()) {\n+                Timber.i(\"Cancelled task %s\", latestInstance.mType);\n+            }\n+        };\n+    }\n+\n+\n+    /** Cancel all tasks of type taskType*/\n+    public static void cancelAllTasks(TASK_TYPE taskType) {\n+        int count = 0;\n+        synchronized (sTasks) {\n+            for (CollectionTask task: sTasks) {\n+                if (task.mType == taskType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22595c5ff499cab6103ce1eadd812e84468d43e6"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgyMTY4MQ==", "bodyText": "Probably best to extract the method - we're so far down that we've lost context of why we do this.", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#discussion_r449821681", "createdAt": "2020-07-05T01:58:06Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -223,158 +252,163 @@ public CollectionTask(TASK_TYPE type, Listener listener, CollectionTask previous\n         mType = type;\n         mListener = listener;\n         mPreviousTask = previousTask;\n+        sTasks.add(this);\n     }\n \n \n     // This method and those that are called here are executed in a new thread\n     @Override\n     protected TaskData doInBackground(TaskData... params) {\n-        super.doInBackground(params);\n-        // Wait for previous thread (if any) to finish before continuing\n-        if (mPreviousTask != null && mPreviousTask.getStatus() != AsyncTask.Status.FINISHED) {\n-            Timber.d(\"Waiting for %s to finish before starting %s\", mPreviousTask.mType, mType);\n-            try {\n-                mPreviousTask.get();\n-                Timber.d(\"Finished waiting for %s to finish. Status= %s\", mPreviousTask.mType, mPreviousTask.getStatus());\n-            } catch (InterruptedException e) {\n-                Thread.currentThread().interrupt();\n-                // We have been interrupted, return immediately.\n-                Timber.d(e, \"interrupted while waiting for previous task: %s\", mPreviousTask.mType);\n-                return null;\n-            } catch (ExecutionException e) {\n-                // Ignore failures in the previous task.\n-                Timber.e(e, \"previously running task failed with exception: %s\", mPreviousTask.mType);\n-            } catch (CancellationException e) {\n-                // Ignore cancellation of previous task\n-                Timber.d(e, \"previously running task was cancelled: %s\", mPreviousTask.mType);\n+        try {\n+            super.doInBackground(params);\n+            // Wait for previous thread (if any) to finish before continuing\n+            if (mPreviousTask != null && mPreviousTask.getStatus() != AsyncTask.Status.FINISHED) {\n+                Timber.d(\"Waiting for %s to finish before starting %s\", mPreviousTask.mType, mType);\n+                try {\n+                    mPreviousTask.get();\n+                    Timber.d(\"Finished waiting for %s to finish. Status= %s\", mPreviousTask.mType, mPreviousTask.getStatus());\n+                } catch (InterruptedException e) {\n+                    Thread.currentThread().interrupt();\n+                    // We have been interrupted, return immediately.\n+                    Timber.d(e, \"interrupted while waiting for previous task: %s\", mPreviousTask.mType);\n+                    return null;\n+                } catch (ExecutionException e) {\n+                    // Ignore failures in the previous task.\n+                    Timber.e(e, \"previously running task failed with exception: %s\", mPreviousTask.mType);\n+                } catch (CancellationException e) {\n+                    // Ignore cancellation of previous task\n+                    Timber.d(e, \"previously running task was cancelled: %s\", mPreviousTask.mType);\n+                }\n             }\n-        }\n-        sLatestInstance = this;\n-        mContext = AnkiDroidApp.getInstance().getApplicationContext();\n+            sLatestInstance = this;\n+            mContext = AnkiDroidApp.getInstance().getApplicationContext();\n \n-        // Skip the task if the collection cannot be opened\n-        if (mType != TASK_TYPE.REPAIR_DECK && CollectionHelper.getInstance().getColSafe(mContext) == null) {\n-            Timber.e(\"CollectionTask CollectionTask %s as Collection could not be opened\", mType);\n-            return null;\n-        }\n-        // Actually execute the task now that we are at the front of the queue.\n-        switch (mType) {\n-            case LOAD_DECK_COUNTS:\n-                return doInBackgroundLoadDeckCounts();\n+            // Skip the task if the collection cannot be opened\n+            if (mType != TASK_TYPE.REPAIR_DECK && CollectionHelper.getInstance().getColSafe(mContext) == null) {\n+                Timber.e(\"CollectionTask CollectionTask %s as Collection could not be opened\", mType);\n+                return null;\n+            }\n+            // Actually execute the task now that we are at the front of the queue.\n+            switch (mType) {\n+                case LOAD_DECK_COUNTS:\n+                    return doInBackgroundLoadDeckCounts();\n \n-            case SAVE_COLLECTION:\n-                doInBackgroundSaveCollection();\n-                break;\n+                case SAVE_COLLECTION:\n+                    doInBackgroundSaveCollection();\n+                    break;\n \n-            case ANSWER_CARD:\n-                return doInBackgroundAnswerCard(params);\n+                case ANSWER_CARD:\n+                    return doInBackgroundAnswerCard(params);\n \n-            case ADD_NOTE:\n-                return doInBackgroundAddNote(params);\n+                case ADD_NOTE:\n+                    return doInBackgroundAddNote(params);\n \n-            case UPDATE_NOTE:\n-                return doInBackgroundUpdateNote(params);\n+                case UPDATE_NOTE:\n+                    return doInBackgroundUpdateNote(params);\n \n-            case UPDATE_NOTES_MULTI:\n-                return doInBackgroundUpdateNotes(params);\n+                case UPDATE_NOTES_MULTI:\n+                    return doInBackgroundUpdateNotes(params);\n \n-            case UNDO:\n-                return doInBackgroundUndo();\n+                case UNDO:\n+                    return doInBackgroundUndo();\n \n-            case SEARCH_CARDS:\n-                return doInBackgroundSearchCards(params);\n+                case SEARCH_CARDS:\n+                    return doInBackgroundSearchCards(params);\n \n-            case DISMISS:\n-                return doInBackgroundDismissNote(params);\n+                case DISMISS:\n+                    return doInBackgroundDismissNote(params);\n \n-            case DISMISS_MULTI:\n-                return doInBackgroundDismissNotes(params);\n+                case DISMISS_MULTI:\n+                    return doInBackgroundDismissNotes(params);\n \n-            case CHECK_DATABASE:\n-                return doInBackgroundCheckDatabase();\n+                case CHECK_DATABASE:\n+                    return doInBackgroundCheckDatabase();\n \n-            case REPAIR_DECK:\n-                return doInBackgroundRepairDeck();\n+                case REPAIR_DECK:\n+                    return doInBackgroundRepairDeck();\n \n-            case UPDATE_VALUES_FROM_DECK:\n-                return doInBackgroundUpdateValuesFromDeck(params);\n+                case UPDATE_VALUES_FROM_DECK:\n+                    return doInBackgroundUpdateValuesFromDeck(params);\n \n-            case DELETE_DECK:\n-                return doInBackgroundDeleteDeck(params);\n+                case DELETE_DECK:\n+                    return doInBackgroundDeleteDeck(params);\n \n-            case REBUILD_CRAM:\n-                return doInBackgroundRebuildCram();\n+                case REBUILD_CRAM:\n+                    return doInBackgroundRebuildCram();\n \n-            case EMPTY_CRAM:\n-                return doInBackgroundEmptyCram();\n+                case EMPTY_CRAM:\n+                    return doInBackgroundEmptyCram();\n \n-            case IMPORT:\n-                return doInBackgroundImportAdd(params);\n+                case IMPORT:\n+                    return doInBackgroundImportAdd(params);\n \n-            case IMPORT_REPLACE:\n-                return doInBackgroundImportReplace(params);\n+                case IMPORT_REPLACE:\n+                    return doInBackgroundImportReplace(params);\n \n-            case EXPORT_APKG:\n-                return doInBackgroundExportApkg(params);\n+                case EXPORT_APKG:\n+                    return doInBackgroundExportApkg(params);\n \n-            case REORDER:\n-                return doInBackgroundReorder(params);\n+                case REORDER:\n+                    return doInBackgroundReorder(params);\n \n-            case CONF_CHANGE:\n-                return doInBackgroundConfChange(params);\n+                case CONF_CHANGE:\n+                    return doInBackgroundConfChange(params);\n \n-            case CONF_RESET:\n-                return doInBackgroundConfReset(params);\n+                case CONF_RESET:\n+                    return doInBackgroundConfReset(params);\n \n-            case CONF_REMOVE:\n-                return doInBackgroundConfRemove(params);\n+                case CONF_REMOVE:\n+                    return doInBackgroundConfRemove(params);\n \n-            case CONF_SET_SUBDECKS:\n-                return doInBackgroundConfSetSubdecks(params);\n+                case CONF_SET_SUBDECKS:\n+                    return doInBackgroundConfSetSubdecks(params);\n \n-            case RENDER_BROWSER_QA:\n-                return doInBackgroundRenderBrowserQA(params);\n+                case RENDER_BROWSER_QA:\n+                    return doInBackgroundRenderBrowserQA(params);\n \n-            case CHECK_MEDIA:\n-                return doInBackgroundCheckMedia();\n+                case CHECK_MEDIA:\n+                    return doInBackgroundCheckMedia();\n \n-            case ADD_TEMPLATE:\n-                return doInBackgroundAddTemplate(params);\n+                case ADD_TEMPLATE:\n+                    return doInBackgroundAddTemplate(params);\n \n-            case REMOVE_TEMPLATE:\n-                return doInBackgroundRemoveTemplate(params);\n+                case REMOVE_TEMPLATE:\n+                    return doInBackgroundRemoveTemplate(params);\n \n-            case COUNT_MODELS:\n-                return doInBackgroundCountModels();\n+                case COUNT_MODELS:\n+                    return doInBackgroundCountModels();\n \n-            case DELETE_MODEL:\n-                return  doInBackGroundDeleteModel(params);\n+                case DELETE_MODEL:\n+                    return doInBackGroundDeleteModel(params);\n \n-            case DELETE_FIELD:\n-                return doInBackGroundDeleteField(params);\n+                case DELETE_FIELD:\n+                    return doInBackGroundDeleteField(params);\n \n-            case REPOSITION_FIELD:\n-                return doInBackGroundRepositionField(params);\n+                case REPOSITION_FIELD:\n+                    return doInBackGroundRepositionField(params);\n \n-            case ADD_FIELD:\n-                return doInBackGroundAddField(params);\n+                case ADD_FIELD:\n+                    return doInBackGroundAddField(params);\n \n-            case CHANGE_SORT_FIELD:\n-                return doInBackgroundChangeSortField(params);\n+                case CHANGE_SORT_FIELD:\n+                    return doInBackgroundChangeSortField(params);\n \n-            case SAVE_MODEL:\n-                return doInBackgroundSaveModel(params);\n+                case SAVE_MODEL:\n+                    return doInBackgroundSaveModel(params);\n \n-            case FIND_EMPTY_CARDS:\n-                return doInBackGroundFindEmptyCards(params);\n+                case FIND_EMPTY_CARDS:\n+                    return doInBackGroundFindEmptyCards(params);\n \n-            case CHECK_CARD_SELECTION:\n-                return doInBackgroundCheckCardSelection(params);\n+                case CHECK_CARD_SELECTION:\n+                    return doInBackgroundCheckCardSelection(params);\n \n-            default:\n-                Timber.e(\"unknown task type: %s\", mType);\n+                default:\n+                    Timber.e(\"unknown task type: %s\", mType);\n+            }\n+            return null;\n+        } finally {\n+            sTasks.remove(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22595c5ff499cab6103ce1eadd812e84468d43e6"}, "originalPosition": 343}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "440c93200c278f82aceece62d1f979d93f43da2d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/440c93200c278f82aceece62d1f979d93f43da2d", "committedDate": "2020-07-05T02:05:18Z", "message": "NF: split doInBackground split in two"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df97f32c87d8cf4aeb761e99e149a5de833a597c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/df97f32c87d8cf4aeb761e99e149a5de833a597c", "committedDate": "2020-07-05T02:07:35Z", "message": "NF: sTasks\n\nA list of tasks that are expected to run, now or later"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e394db03081110fc4a2f24842a0f94c5f2dce905", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e394db03081110fc4a2f24842a0f94c5f2dce905", "committedDate": "2020-07-05T02:07:36Z", "message": "NF: Move comments to javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e75c92f762345f5f433332ee41e4b6e8cb000ad", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0e75c92f762345f5f433332ee41e4b6e8cb000ad", "committedDate": "2020-07-05T02:07:36Z", "message": "NF: assign to local variable to avoid concurrent chnage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a86b9d07a6b76aea6b0828e76b6d4f9ceb81068", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2a86b9d07a6b76aea6b0828e76b6d4f9ceb81068", "committedDate": "2020-07-05T02:07:36Z", "message": "NF: safeCancel, allow to cancel task"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22595c5ff499cab6103ce1eadd812e84468d43e6", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/22595c5ff499cab6103ce1eadd812e84468d43e6", "committedDate": "2020-07-05T01:16:37Z", "message": "NF: cancelTask to cancelCurrentlyExecutingTask\n\nAs requested by David"}, "afterCommit": {"oid": "1e889606b066ecacd092d461d0cf47d734b780e2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1e889606b066ecacd092d461d0cf47d734b780e2", "committedDate": "2020-07-05T02:07:36Z", "message": "NF: cancelTask to cancelCurrentlyExecutingTask\n\nAs requested by David"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjQwNTQ5", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442640549", "createdAt": "2020-07-05T02:19:15Z", "commit": {"oid": "1e889606b066ecacd092d461d0cf47d734b780e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjQwNzg5", "url": "https://github.com/ankidroid/Anki-Android/pull/6615#pullrequestreview-442640789", "createdAt": "2020-07-05T02:29:08Z", "commit": {"oid": "1e889606b066ecacd092d461d0cf47d734b780e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c2f392fc9d59492e5955b09ac912c24a61022b6", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0c2f392fc9d59492e5955b09ac912c24a61022b6", "committedDate": "2020-07-05T02:30:47Z", "message": "cancelTask(type) cancel all tasks of given type\n\nThere is only a few call to this method, and I can never see a good\nreason to cancel a task only if it is running. In all case, if the\ntask type is cancelled, it is because it is not useful anymore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa0e28c48a181c9d7de0c2dbabda10a447c38905", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fa0e28c48a181c9d7de0c2dbabda10a447c38905", "committedDate": "2020-07-05T02:30:48Z", "message": "NF: cancelTask to cancelCurrentlyExecutingTask\n\nAs requested by David"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e889606b066ecacd092d461d0cf47d734b780e2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1e889606b066ecacd092d461d0cf47d734b780e2", "committedDate": "2020-07-05T02:07:36Z", "message": "NF: cancelTask to cancelCurrentlyExecutingTask\n\nAs requested by David"}, "afterCommit": {"oid": "fa0e28c48a181c9d7de0c2dbabda10a447c38905", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fa0e28c48a181c9d7de0c2dbabda10a447c38905", "committedDate": "2020-07-05T02:30:48Z", "message": "NF: cancelTask to cancelCurrentlyExecutingTask\n\nAs requested by David"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3072, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}