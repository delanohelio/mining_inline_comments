{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1OTY3NTM2", "number": 7005, "title": "NF: Mock Task manager", "bodyText": "Currently, the biggest problem to generate test are that some code is executed in background. Either I wait until the end of the background task, which is not easy to do, or I the test in OnPostExecute. In this case, I need to actually check whether onPostExecute is executed which lead back to first problem.\nWorse, as show #6978 there is difference in background task between machines.\nThe trouble, according to me, is that those are not difference I actually want to consider in tests. In the example linked above, it just means on some machine the counts will takes more time to be updated than on some other machines. That's not actually a problem as long as counts gets updated.\nThe trouble is that if I want to do test without task actually in background, currently, I need to run copy the background code in the test. This makes code complex, and potentially it does not even follow evolution of the task.\nI thought that the solution should be:\n\nUses a task manager. It contains what was static in CollectionTask\nMock the task manager, with a method executing all tasks immediately. This way, this part of the test becomes deterministic.\nUse the mock in the tests.\n\nA single error remains, checkDatabaseWithLockedCollectionReturnsLocked. I'd love your help @david-allison-1 debugging this one. I don't know what this is supposed to test, so no way of knowing how to correct.\nI tried to simply do  getCol().getTaskManager().launchCollection(CHECK_DATABASE) but this method never ends, so that's not the correct answer", "createdAt": "2020-08-30T21:45:31Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7005", "merged": true, "mergeCommit": {"oid": "c8a04e45c5dc729c738664b63a885ee62174d63d"}, "closed": true, "closedAt": "2021-04-03T01:15:43Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEFWxkABqjM3MDc2NTEwNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeJSaBKgBqjQ1NDcxODQ4NTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3fe21a8f22735f505d2c73dcfef62e8f72658db5", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3fe21a8f22735f505d2c73dcfef62e8f72658db5", "committedDate": "2020-08-30T21:34:30Z", "message": "NF: remove wait for task"}, "afterCommit": {"oid": "c2ee96822852dc89f297265ef62268e4cdb1dbbb", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c2ee96822852dc89f297265ef62268e4cdb1dbbb", "committedDate": "2020-08-30T21:47:02Z", "message": "NF: remove wait for task"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjM4NjM5", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#pullrequestreview-478238639", "createdAt": "2020-08-30T22:06:02Z", "commit": {"oid": "c2ee96822852dc89f297265ef62268e4cdb1dbbb"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2ee96822852dc89f297265ef62268e4cdb1dbbb", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c2ee96822852dc89f297265ef62268e4cdb1dbbb", "committedDate": "2020-08-30T21:47:02Z", "message": "NF: remove wait for task"}, "afterCommit": {"oid": "2121f1bfc86b070f68582bd7052856b05f5da8a8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2121f1bfc86b070f68582bd7052856b05f5da8a8", "committedDate": "2020-08-30T22:40:35Z", "message": "NF: remove wait for task"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2121f1bfc86b070f68582bd7052856b05f5da8a8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2121f1bfc86b070f68582bd7052856b05f5da8a8", "committedDate": "2020-08-30T22:40:35Z", "message": "NF: remove wait for task"}, "afterCommit": {"oid": "e8d5921aa562af577b749c2d08491a56859598b8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e8d5921aa562af577b749c2d08491a56859598b8", "committedDate": "2020-08-30T22:54:07Z", "message": "NF: remove wait for task"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjQzODcw", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#pullrequestreview-478243870", "createdAt": "2020-08-30T23:22:49Z", "commit": {"oid": "ab66529d7fdc0b43ee695ef61fd4e25c9597f46c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQyMzoyMjo0OVrOHJmblw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQyMzoyMjo0OVrOHJmblw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgyODg4Nw==", "bodyText": "There's semantic meaning in the previous name (admittedly the timeout variable can go)\nI feel the new code is harder to reason about", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r479828887", "createdAt": "2020-08-30T23:22:49Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sched/AbstractSchedTest.java", "diffHunk": "@@ -96,7 +96,7 @@ public void testUndoResetsCardCountsToCorrectValue() throws InterruptedException\n \n         sched.answerCard(cardBeforeUndo, EASE_3);\n \n-        waitForTask(UNDO, 5000);\n+        getCol().getTaskManager().launchCollectionTask(UNDO);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab66529d7fdc0b43ee695ef61fd4e25c9597f46c"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab66529d7fdc0b43ee695ef61fd4e25c9597f46c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ab66529d7fdc0b43ee695ef61fd4e25c9597f46c", "committedDate": "2020-08-30T22:56:10Z", "message": "NF: background task for AbstractCollectionTaskTest"}, "afterCommit": {"oid": "fe25d963b35999947b7bc3925023b7f2bda9d28d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fe25d963b35999947b7bc3925023b7f2bda9d28d", "committedDate": "2020-08-31T02:15:14Z", "message": "NF: remove advanceRobolectricLooper except for assume"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe25d963b35999947b7bc3925023b7f2bda9d28d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fe25d963b35999947b7bc3925023b7f2bda9d28d", "committedDate": "2020-08-31T02:15:14Z", "message": "NF: remove advanceRobolectricLooper except for assume"}, "afterCommit": {"oid": "0a412903643a2060bd3e504ed1990cd0093527c0", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0a412903643a2060bd3e504ed1990cd0093527c0", "committedDate": "2020-08-31T02:23:51Z", "message": "NF: remove advanceRobolectricLooper except for assume"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a412903643a2060bd3e504ed1990cd0093527c0", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0a412903643a2060bd3e504ed1990cd0093527c0", "committedDate": "2020-08-31T02:23:51Z", "message": "NF: remove advanceRobolectricLooper except for assume"}, "afterCommit": {"oid": "66358132e0f30c674dddb937b318bca31e5af136", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/66358132e0f30c674dddb937b318bca31e5af136", "committedDate": "2020-09-07T17:33:38Z", "message": "NF: remove advanceRobolectricLooper except for assume"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66358132e0f30c674dddb937b318bca31e5af136", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/66358132e0f30c674dddb937b318bca31e5af136", "committedDate": "2020-09-07T17:33:38Z", "message": "NF: remove advanceRobolectricLooper except for assume"}, "afterCommit": {"oid": "7918cc27b66c06b683974d9bf1540adea5e5c086", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7918cc27b66c06b683974d9bf1540adea5e5c086", "committedDate": "2020-09-07T17:37:27Z", "message": "NF: remove advanceRobolectricLooper except for assume"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7918cc27b66c06b683974d9bf1540adea5e5c086", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7918cc27b66c06b683974d9bf1540adea5e5c086", "committedDate": "2020-09-07T17:37:27Z", "message": "NF: remove advanceRobolectricLooper except for assume"}, "afterCommit": {"oid": "61bf4686d5bb2eaf4e66174f443a682c5cfb3221", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/61bf4686d5bb2eaf4e66174f443a682c5cfb3221", "committedDate": "2021-01-14T10:33:41Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61bf4686d5bb2eaf4e66174f443a682c5cfb3221", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/61bf4686d5bb2eaf4e66174f443a682c5cfb3221", "committedDate": "2021-01-14T10:33:41Z", "message": "NF: Allow tests to execute everything in foreground"}, "afterCommit": {"oid": "0ca54af1ae66e3de93fef9a303db3b5d9c3d2ca3", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0ca54af1ae66e3de93fef9a303db3b5d9c3d2ca3", "committedDate": "2021-01-28T20:47:56Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjIzNjc4OTM3", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#pullrequestreview-623678937", "createdAt": "2021-03-29T21:49:43Z", "commit": {"oid": "0ca54af1ae66e3de93fef9a303db3b5d9c3d2ca3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0yOVQyMTo0OTo0M1rOI_rEEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0yOVQyMTo0OTo0M1rOI_rEEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzYzNjc1NA==", "bodyText": "Let's keep the TaskManager methods static, and call .getManager() inside the TaskManager methods, this will reduce the PR down to what matters", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r603636754", "createdAt": "2021-03-29T21:49:43Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -795,9 +795,9 @@ public void testQueryNextCard() {\n         for(int i = 0; i < 10; i++) {//minimizing fails, when sched.reset() randomly chooses between multiple cards\n             col.reset();\n             nextCard = sched.getCard();\n-            TaskManager.waitToFinish();\n+            TaskManager.getManager().waitToFinish();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ca54af1ae66e3de93fef9a303db3b5d9c3d2ca3"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ca54af1ae66e3de93fef9a303db3b5d9c3d2ca3", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0ca54af1ae66e3de93fef9a303db3b5d9c3d2ca3", "committedDate": "2021-01-28T20:47:56Z", "message": "NF: Allow tests to execute everything in foreground"}, "afterCommit": {"oid": "088b2195108d017da2de43ddaaedb9e0b15b47b3", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/088b2195108d017da2de43ddaaedb9e0b15b47b3", "committedDate": "2021-03-30T03:37:15Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "088b2195108d017da2de43ddaaedb9e0b15b47b3", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/088b2195108d017da2de43ddaaedb9e0b15b47b3", "committedDate": "2021-03-30T03:37:15Z", "message": "NF: Allow tests to execute everything in foreground"}, "afterCommit": {"oid": "4e08332054997be2cd57adcd8bfcb24167e8400a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4e08332054997be2cd57adcd8bfcb24167e8400a", "committedDate": "2021-03-30T04:04:14Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e08332054997be2cd57adcd8bfcb24167e8400a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4e08332054997be2cd57adcd8bfcb24167e8400a", "committedDate": "2021-03-30T04:04:14Z", "message": "NF: Allow tests to execute everything in foreground"}, "afterCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "committedDate": "2021-03-30T04:10:42Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjI0MjI1OTI4", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#pullrequestreview-624225928", "createdAt": "2021-03-30T13:00:00Z", "commit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0zMFQxMzowMDowMVrOJAFt7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0zMFQxMzoxMzowMVrOJAGUjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3MzQ1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class SingleTaskManager extends TaskManager{\n          \n          \n            \n            public class SingleTaskManager extends TaskManager {", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604073453", "createdAt": "2021-03-30T13:00:01Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/SingleTaskManager.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.ichi2.async;\n+\n+import android.os.AsyncTask;\n+\n+import com.ichi2.utils.ThreadUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import timber.log.Timber;\n+\n+public class SingleTaskManager extends TaskManager{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTI3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void noBackground() {\n          \n          \n            \n                public void runTasksInForeground() {", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604075274", "createdAt": "2021-03-30T13:02:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -167,10 +172,31 @@ public void tearDown() {\n             //called on each AnkiDroidApp.onCreate(), and spams the build\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n+\n+            TaskManager.setTaskManager(new SingleTaskManager());\n         }\n     }\n \n \n+    /**\n+     * Ensure that each task in backgrounds are executed immediately instead of being queued.\n+     * This may help debugging test without requiring to guess where `advanceRobolectricLooper` are needed.\n+     */\n+    public void noBackground() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTQ0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void background() {\n          \n          \n            \n                public void runTasksInBackground() {", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604075440", "createdAt": "2021-03-30T13:02:33Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -167,10 +172,31 @@ public void tearDown() {\n             //called on each AnkiDroidApp.onCreate(), and spams the build\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n+\n+            TaskManager.setTaskManager(new SingleTaskManager());\n         }\n     }\n \n \n+    /**\n+     * Ensure that each task in backgrounds are executed immediately instead of being queued.\n+     * This may help debugging test without requiring to guess where `advanceRobolectricLooper` are needed.\n+     */\n+    public void noBackground() {\n+        TaskManager.setTaskManager(new ForegroundTaskManager(this));\n+        mBackground = false;\n+    }\n+\n+\n+    /**\n+     * Set back the standard background process\n+     */\n+    public void background() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTk1Ng==", "bodyText": "Shouldn't this be a call to background, or else the local variable won't be set", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604075956", "createdAt": "2021-03-30T13:03:16Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -167,10 +172,31 @@ public void tearDown() {\n             //called on each AnkiDroidApp.onCreate(), and spams the build\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n+\n+            TaskManager.setTaskManager(new SingleTaskManager());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3Njc1NQ==", "bodyText": "Is it possible to add a warning to exceptions thrown here (as Robolectric does) to warn that a new failure may have something to do with running in the foreground", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604076755", "createdAt": "2021-03-30T13:04:17Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/async/ForegroundTaskManager.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package com.ichi2.async;\n+\n+import com.ichi2.libanki.CollectionGetter;\n+import com.ichi2.libanki.Collection;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+public class ForegroundTaskManager extends TaskManager {\n+    private final CollectionGetter mColGetter;\n+\n+\n+    public ForegroundTaskManager(CollectionGetter colGetter) {\n+        mColGetter = colGetter;\n+    }\n+\n+    @Override\n+    protected boolean removeTaskConcrete(CollectionTask task) {\n+        return true;\n+    }\n+\n+\n+    @Override\n+    public <ProgressBackground, ResultBackground> CollectionTask<ProgressBackground, ProgressBackground, ResultBackground, ResultBackground> launchCollectionTaskConcrete(CollectionTask.Task<ProgressBackground, ResultBackground> task) {\n+        return launchCollectionTaskConcrete(task, null);\n+    }\n+\n+\n+    @Override\n+    protected void setLatestInstanceConcrete(CollectionTask task) {\n+    }\n+\n+\n+    @Override\n+    public <ProgressListener, ProgressBackground extends ProgressListener, ResultListener, ResultBackground extends ResultListener> CollectionTask<ProgressListener, ProgressBackground, ResultListener, ResultBackground> launchCollectionTaskConcrete(\n+            @NonNull CollectionTask.Task<ProgressBackground, ResultBackground> task,\n+            @Nullable TaskListener<ProgressListener, ResultListener> listener) {\n+        if (listener != null) {\n+            listener.onPreExecute();\n+        }\n+        ResultBackground res = task.task(mColGetter.getCol(), new MockTaskManager<>(listener));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA4MzM0MQ==", "bodyText": "\u26a0\ufe0f This is calling the static launchCollectionTask", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604083341", "createdAt": "2021-03-30T13:13:01Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/TaskManager.java", "diffHunk": "@@ -50,11 +48,18 @@ protected static void setLatestInstance(CollectionTask task) {\n      * @param task the task to execute\n      * @return the newly created task\n      */\n+    protected static void setLatestInstance(CollectionTask task) {\n+        sTaskManager.setLatestInstanceConcrete(task);\n+    }\n+\n     public static <ProgressBackground, ResultBackground> CollectionTask<ProgressBackground, ProgressBackground, ResultBackground, ResultBackground> launchCollectionTask(CollectionTask.Task<ProgressBackground, ResultBackground> task) {\n-        return launchCollectionTask(task, null);\n+        return sTaskManager.launchCollectionTask(task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "originalPosition": 69}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/84281089ef7a64bbf7fe7d4626c5647e064bbcb2", "committedDate": "2021-03-30T04:10:42Z", "message": "NF: Allow tests to execute everything in foreground"}, "afterCommit": {"oid": "00bfa26def6733a4157bec5326d45dc5a4d49813", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/00bfa26def6733a4157bec5326d45dc5a4d49813", "committedDate": "2021-03-30T22:45:02Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00bfa26def6733a4157bec5326d45dc5a4d49813", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/00bfa26def6733a4157bec5326d45dc5a4d49813", "committedDate": "2021-03-30T22:45:02Z", "message": "NF: Allow tests to execute everything in foreground"}, "afterCommit": {"oid": "b78b85cd58f6b8e698ab597b46737c673ee07e9d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b78b85cd58f6b8e698ab597b46737c673ee07e9d", "committedDate": "2021-03-30T23:06:31Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjI0NzkwNjMx", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#pullrequestreview-624790631", "createdAt": "2021-03-30T23:53:41Z", "commit": {"oid": "b78b85cd58f6b8e698ab597b46737c673ee07e9d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0zMFQyMzo1Mzo0MVrOJAgA_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0zMFQyMzo1Mzo0MVrOJAgA_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUwNDMxNg==", "bodyText": "This should likely still be an abstraction on CollectionTask", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604504316", "createdAt": "2021-03-30T23:53:41Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -906,7 +904,7 @@ protected void onActivityResult(int requestCode, int resultCode, Intent intent)\n                 }\n             } else if (resultCode == Reviewer.RESULT_ABORT_AND_SYNC) {\n                 Timber.i(\"Obtained Abort and Sync result\");\n-                CollectionTask.waitForAllToFinish(4);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b78b85cd58f6b8e698ab597b46737c673ee07e9d"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b78b85cd58f6b8e698ab597b46737c673ee07e9d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b78b85cd58f6b8e698ab597b46737c673ee07e9d", "committedDate": "2021-03-30T23:06:31Z", "message": "NF: Allow tests to execute everything in foreground"}, "afterCommit": {"oid": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "committedDate": "2021-03-31T01:07:51Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjI0ODE0MzYy", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#pullrequestreview-624814362", "createdAt": "2021-03-31T01:02:30Z", "commit": {"oid": "b78b85cd58f6b8e698ab597b46737c673ee07e9d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0zMVQwMTowMjozMFrOJAhUPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0zMVQwMTowNzozMFrOJAhaGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUyNTYyOA==", "bodyText": "Why ?\nMy understanding is that CollectionTask deal with the individual tasks and the TaskManager with the queue of tasks. This is relevant to the queue.", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604525628", "createdAt": "2021-03-31T01:02:30Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -906,7 +904,7 @@ protected void onActivityResult(int requestCode, int resultCode, Intent intent)\n                 }\n             } else if (resultCode == Reviewer.RESULT_ABORT_AND_SYNC) {\n                 Timber.i(\"Obtained Abort and Sync result\");\n-                CollectionTask.waitForAllToFinish(4);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUwNDMxNg=="}, "originalCommit": {"oid": "b78b85cd58f6b8e698ab597b46737c673ee07e9d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUyNjA0Nw==", "bodyText": "Nice catch", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604526047", "createdAt": "2021-03-31T01:03:57Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -167,10 +172,31 @@ public void tearDown() {\n             //called on each AnkiDroidApp.onCreate(), and spams the build\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n+\n+            TaskManager.setTaskManager(new SingleTaskManager());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTk1Ng=="}, "originalCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUyNzEzMA==", "bodyText": "Done. Not sure about the exact message", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r604527130", "createdAt": "2021-03-31T01:07:30Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/test/java/com/ichi2/async/ForegroundTaskManager.java", "diffHunk": "@@ -0,0 +1,104 @@\n+package com.ichi2.async;\n+\n+import com.ichi2.libanki.CollectionGetter;\n+import com.ichi2.libanki.Collection;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+public class ForegroundTaskManager extends TaskManager {\n+    private final CollectionGetter mColGetter;\n+\n+\n+    public ForegroundTaskManager(CollectionGetter colGetter) {\n+        mColGetter = colGetter;\n+    }\n+\n+    @Override\n+    protected boolean removeTaskConcrete(CollectionTask task) {\n+        return true;\n+    }\n+\n+\n+    @Override\n+    public <ProgressBackground, ResultBackground> CollectionTask<ProgressBackground, ProgressBackground, ResultBackground, ResultBackground> launchCollectionTaskConcrete(CollectionTask.Task<ProgressBackground, ResultBackground> task) {\n+        return launchCollectionTaskConcrete(task, null);\n+    }\n+\n+\n+    @Override\n+    protected void setLatestInstanceConcrete(CollectionTask task) {\n+    }\n+\n+\n+    @Override\n+    public <ProgressListener, ProgressBackground extends ProgressListener, ResultListener, ResultBackground extends ResultListener> CollectionTask<ProgressListener, ProgressBackground, ResultListener, ResultBackground> launchCollectionTaskConcrete(\n+            @NonNull CollectionTask.Task<ProgressBackground, ResultBackground> task,\n+            @Nullable TaskListener<ProgressListener, ResultListener> listener) {\n+        if (listener != null) {\n+            listener.onPreExecute();\n+        }\n+        ResultBackground res = task.task(mColGetter.getCol(), new MockTaskManager<>(listener));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3Njc1NQ=="}, "originalCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjI2NDgxMjY4", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#pullrequestreview-626481268", "createdAt": "2021-04-01T17:10:54Z", "commit": {"oid": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wMVQxNzoxMDo1NFrOJBwImw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wMVQxNzoxMDo1NFrOJBwImw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTgxNjk4Nw==", "bodyText": "You're correct", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r605816987", "createdAt": "2021-04-01T17:10:54Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -906,7 +904,7 @@ protected void onActivityResult(int requestCode, int resultCode, Intent intent)\n                 }\n             } else if (resultCode == Reviewer.RESULT_ABORT_AND_SYNC) {\n                 Timber.i(\"Obtained Abort and Sync result\");\n-                CollectionTask.waitForAllToFinish(4);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUwNDMxNg=="}, "originalCommit": {"oid": "b78b85cd58f6b8e698ab597b46737c673ee07e9d"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjI3MjIzMDQ4", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#pullrequestreview-627223048", "createdAt": "2021-04-02T19:27:13Z", "commit": {"oid": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjI3MjM0MTIy", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#pullrequestreview-627234122", "createdAt": "2021-04-02T19:54:04Z", "commit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wMlQxOTo1NDowNFrOJCTX3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wMlQxOTo1NjowM1rOJCTazQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM5NDMzNA==", "bodyText": "David's suggestion here is good, the API should have mirror naming if it has mirror effect I think", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r606394334", "createdAt": "2021-04-02T19:54:04Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -167,10 +172,31 @@ public void tearDown() {\n             //called on each AnkiDroidApp.onCreate(), and spams the build\n             //there is no onDestroy(), so call it here.\n             Timber.uprootAll();\n+\n+            TaskManager.setTaskManager(new SingleTaskManager());\n         }\n     }\n \n \n+    /**\n+     * Ensure that each task in backgrounds are executed immediately instead of being queued.\n+     * This may help debugging test without requiring to guess where `advanceRobolectricLooper` are needed.\n+     */\n+    public void noBackground() {\n+        TaskManager.setTaskManager(new ForegroundTaskManager(this));\n+        mBackground = false;\n+    }\n+\n+\n+    /**\n+     * Set back the standard background process\n+     */\n+    public void background() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDA3NTQ0MA=="}, "originalCommit": {"oid": "84281089ef7a64bbf7fe7d4626c5647e064bbcb2"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM5NTA4NQ==", "bodyText": "I think I would actually go farther with this!\nI would start with mBackground = false and in the RobolectricTest.setUp I would set the foreground task manager, with cleanup resetting it to foreground\nI think unit tests wanting actual asynchronous testing are the rare case in other words, and the burden should be on them to call runTasksInForeground vs on regular code to call runTasksInBackground (note I picked David's name there", "url": "https://github.com/ankidroid/Anki-Android/pull/7005#discussion_r606395085", "createdAt": "2021-04-02T19:56:03Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/test/java/com/ichi2/anki/RobolectricTest.java", "diffHunk": "@@ -77,7 +80,9 @@\n import static org.hamcrest.Matchers.is;\n import static org.robolectric.Shadows.shadowOf;\n \n-public class RobolectricTest {\n+public class RobolectricTest implements CollectionGetter {\n+\n+    private static boolean mBackground = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "450f5296cb3e146de6086230a8e3b8f7dc2f4dd1", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/450f5296cb3e146de6086230a8e3b8f7dc2f4dd1", "committedDate": "2021-04-02T20:22:55Z", "message": "NF: moving waitForAllToFinish to TaskManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83d180483cd034abc4a20126f23a9cbdbeec796f", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/83d180483cd034abc4a20126f23a9cbdbeec796f", "committedDate": "2021-04-02T20:22:55Z", "message": "NF: move addTask entirely in TaskManager\n\nThe manager is supposde to know when a task is added, and deal with it itself"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5fc11da354a03b37f4c7f1453af84453c5214e9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a5fc11da354a03b37f4c7f1453af84453c5214e9", "committedDate": "2021-04-02T20:22:55Z", "message": "NF: SingleTaskManager\n\nSpliting TaskManager into an abstract and a concrete part allow to change no call while still allowing to switch implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c16c79e22ac3f193fca8b65058595c579d73fc69", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c16c79e22ac3f193fca8b65058595c579d73fc69", "committedDate": "2021-04-02T20:22:55Z", "message": "NF: introduce CollectionGetter interface"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/81dc984585ce8b28b6d8ac1d825afb595bf8dfff", "committedDate": "2021-03-31T01:07:51Z", "message": "NF: Allow tests to execute everything in foreground"}, "afterCommit": {"oid": "c44cb962a07d4f44851ead14efb423c9fc30d2c0", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c44cb962a07d4f44851ead14efb423c9fc30d2c0", "committedDate": "2021-04-02T20:23:49Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "003ac75fcb7a80581cf0fd028e3c9db9f6d556ad", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/003ac75fcb7a80581cf0fd028e3c9db9f6d556ad", "committedDate": "2021-04-02T22:00:20Z", "message": "NF: Allow tests to execute everything in foreground"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c44cb962a07d4f44851ead14efb423c9fc30d2c0", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c44cb962a07d4f44851ead14efb423c9fc30d2c0", "committedDate": "2021-04-02T20:23:49Z", "message": "NF: Allow tests to execute everything in foreground"}, "afterCommit": {"oid": "003ac75fcb7a80581cf0fd028e3c9db9f6d556ad", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/003ac75fcb7a80581cf0fd028e3c9db9f6d556ad", "committedDate": "2021-04-02T22:00:20Z", "message": "NF: Allow tests to execute everything in foreground"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3001, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}