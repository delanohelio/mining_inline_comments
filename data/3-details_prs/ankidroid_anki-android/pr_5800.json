{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MjkyNTAz", "number": 5800, "title": "Avoid crashing on import even if collection not found", "bodyText": "Pull Request template\nPurpose / Description\nIt is possible to crash on import if the collection isn't found\nFixes\nhttps://couchdb.ankidroid.org/acralyzer/_design/acralyzer/index.html#/report-details/77140843-8f1a-404b-a2ec-2d752b9dde1c\njava.lang.NullPointerException\nat java.util.Objects.requireNonNull(Objects.java:203)\nat java.util.Arrays$ArrayList.<init>(Arrays.java:3741)\nat java.util.Arrays.asList(Arrays.java:3728)\nat com.ichi2.libanki.Utils.getImportableDecks(Utils.java:917)\nat com.ichi2.anki.dialogs.ImportDialog.onCreateDialog(ImportDialog.java:88)\nat com.ichi2.anki.dialogs.ImportDialog.onCreateDialog(ImportDialog.java:20)\nat android.support.v4.app.DialogFragment.getLayoutInflater(DialogFragment.java:312)\nat android.support.v4.app.FragmentManagerImpl.moveToState(FragmentManager.java:1298)\nat android.support.v4.app.FragmentManagerImpl.moveFragmentsToInvisible(FragmentManager.java:2323)\nat android.support.v4.app.FragmentManagerImpl.executeOpsTogether(FragmentManager.java:2136)\nat android.support.v4.app.FragmentManagerImpl.optimizeAndExecuteOps(FragmentManager.java:2092)\nat android.support.v4.app.FragmentManagerImpl.execPendingActions(FragmentManager.java:1998)\nat android.support.v4.app.FragmentManagerImpl.executePendingTransactions(FragmentManager.java:762)\nat com.ichi2.anki.AnkiActivity.showDialogFragment(AnkiActivity.java:349)\nat com.ichi2.anki.DeckPicker.showImportDialog(DeckPicker.java:1114)\nat com.ichi2.anki.DeckPicker.showImportDialog(DeckPicker.java:1107)\nat com.ichi2.anki.dialogs.ImportDialog$1.onPositive(ImportDialog.java:76)\nat com.afollestad.materialdialogs.MaterialDialog.onClick(MaterialDialog.java:340)\n\nApproach\nI think this is a little far-fetched but we get crash reports and it's a simple fix to avoid the crash here, so I just re-arranged variable access / initialization such that we will always at least return an empty list vs crashing\nHow Has This Been Tested?\nI revoked permissions on an API28 emulator then attempted to import a file while denying storage permission during import, and we get a fail error message and app quit vs a crash\nRegular imports still work fine as well\nLearning (optional, can help others)\nDescribe the research stage\nLinks to blog posts, patterns, libraries or addons used to solve this problem\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-03-08T17:35:52Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5800", "merged": true, "mergeCommit": {"oid": "501aee48c8cf5a8a964269d6d42aa06365c1fa4b"}, "closed": true, "closedAt": "2020-03-09T12:38:50Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLszqVAH2gAyMzg1MjkyNTAzOjJjYWY1NDM4OGJmNDNkMTkxNTgzOTI1NDNjNjIyMzY3MmFjMWQ3Y2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLyU6ugFqTM3MDg2OTA4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2caf54388bf43d19158392543c6223672ac1d7ca", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2caf54388bf43d19158392543c6223672ac1d7ca", "committedDate": "2020-03-08T17:31:30Z", "message": "Avoid crashing on import even if collection not found"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwODY5MDg3", "url": "https://github.com/ankidroid/Anki-Android/pull/5800#pullrequestreview-370869087", "createdAt": "2020-03-08T23:57:12Z", "commit": {"oid": "2caf54388bf43d19158392543c6223672ac1d7ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMzo1NzoxMlrOFzYViQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMzo1NzoxMlrOFzYViQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQyMDQyNQ==", "bodyText": "Are you getting the whole list as a sublist here? Why is that necessary? \ud83e\udd14", "url": "https://github.com/ankidroid/Anki-Android/pull/5800#discussion_r389420425", "createdAt": "2020-03-08T23:57:12Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -847,14 +847,11 @@ public static double utcOffset() {\n     public static List<File> getImportableDecks(Context context) {\n         String deckPath = CollectionHelper.getCurrentAnkiDroidDirectory(context);\n         File dir = new File(deckPath);\n-        int deckCount = 0;\n-        File[] deckList = null;\n+        List<File> decks = new ArrayList<>();\n         if (dir.exists() && dir.isDirectory()) {\n-            deckList = dir.listFiles(pathname -> pathname.isFile() && ImportUtils.isValidPackageName(pathname.getName()));\n-            deckCount = deckList.length;\n+            File[] deckList = dir.listFiles(pathname -> pathname.isFile() && ImportUtils.isValidPackageName(pathname.getName()));\n+            decks.addAll(Arrays.asList(deckList).subList(0, deckList.length));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2caf54388bf43d19158392543c6223672ac1d7ca"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3696, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}