{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMjEzNjI4", "number": 5947, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyOTo1NVrODvib2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzoxNDo0OVrODv_Leg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTczODQ4OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyOTo1NVrOGCBKzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyOTo1NVrOGCBKzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2OTQ4NQ==", "bodyText": "I don't think this loop is doing what you think it's doing... You would need to actually restart the task to get a different result. I think most likely it's fine to just throw the exception without retrying anyway. Execution exception only happens when the runnable throws, and I think interrupted exception only occurs if we cancel the future task? And we never do that.", "url": "https://github.com/ankidroid/Anki-Android/pull/5947#discussion_r404769485", "createdAt": "2020-04-07T12:29:55Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2024,15 +2024,73 @@ public Media getMedia() {\n         return mMedia;\n     }\n \n+    private class ModelsLoader {\n+    /**\n+        Ensure that models get loaded. This operation only need to be\n+        done once; this is the point of using a future.\n+\n+        Loading only need to be done when anki starts and after full\n+        sync. This is the point of using a future, ensuring it's done\n+        once and only once.\n+\n+        However, loading may blocks database for a long time when\n+        there are a lot of note types or when there are big note\n+        types, so it should only be performed when database is not\n+        used by more important tasks. This is why it is not done in\n+        the main thread, but in a separate thread. Furthermore, the\n+        models are not required to show the deck picker screen, so it\n+        can wait until the screen has loaded.\n+\n+        Most of the time is spent querying the database, and blocking\n+        access to it. Because of that we want to load the models only\n+        when there are no important data base access\n+        needed. E.g. after the list of deck is displayed to the user.\n+\n+     */\n+        Collection mCol;\n+        private FutureTask<Models> ft;\n+\n+        public ModelsLoader (Collection col) {\n+            mCol = col;\n+        }\n+\n+        public void load() {\n+            if (ft != null) {\n+                return;\n+            }\n+            ft = new FutureTask<Models> (() -> new Models(mCol).load(loadColumn(\"models\")));\n+            new Thread(ft).start();\n+        }\n+\n+        public Models get() {\n+            load();\n+            int tries = 0;\n+            while (true) {\n+                try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9567ddc792f429d66bbddf927d4f3cfe1828b7f"}, "originalPosition": 220}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzc5OTI0OnYy", "diffSide": "LEFT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDo0NToyOFrOGCVbQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDo0NToyOFrOGCVbQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMTM3Ng==", "bodyText": "Can you please comment this out rather than deleting it, and add the following comment:\n// We deviate from upstream by lazy loading the models to improve app start time", "url": "https://github.com/ankidroid/Anki-Android/pull/5947#discussion_r405101376", "createdAt": "2020-04-07T20:45:28Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -266,7 +267,6 @@ public void load() {\n                 cursor.close();\n             }\n         }\n-        mModels.load(loadColumn(\"models\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbaa92c4c94b6f41ae2f2f9fcbfdedec803919a5"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzg3ODQxOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMTowNzo0NVrOGCWLSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMTowNzo0NVrOGCWLSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTExMzY3Mw==", "bodyText": "// Waits for the FutureTask to complete and returns the result", "url": "https://github.com/ankidroid/Anki-Android/pull/5947#discussion_r405113673", "createdAt": "2020-04-07T21:07:45Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2024,15 +2024,66 @@ public Media getMedia() {\n         return mMedia;\n     }\n \n+    private class ModelsLoader {\n+    /**\n+        Ensure that models get loaded. This operation only need to be\n+        done once; this is the point of using a future.\n+\n+        Loading only need to be done when anki starts and after full\n+        sync. This is the point of using a future, ensuring it's done\n+        once and only once.\n+\n+        However, loading may blocks database for a long time when\n+        there are a lot of note types or when there are big note\n+        types, so it should only be performed when database is not\n+        used by more important tasks. This is why it is not done in\n+        the main thread, but in a separate thread. Furthermore, the\n+        models are not required to show the deck picker screen, so it\n+        can wait until the screen has loaded.\n+\n+        Most of the time is spent querying the database, and blocking\n+        access to it. Because of that we want to load the models only\n+        when there are no important data base access\n+        needed. E.g. after the list of deck is displayed to the user.\n+\n+     */\n+        private Collection mCol;\n+        private FutureTask<Models> mFutureTask;\n+\n+        public ModelsLoader (Collection col) {\n+            mCol = col;\n+        }\n+\n+        public void load() {\n+            if (mFutureTask != null) {\n+                return;\n+            }\n+            mFutureTask = new FutureTask<Models> (() -> new Models(mCol).load(loadColumn(\"models\")));\n+            new Thread(mFutureTask).start();\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbaa92c4c94b6f41ae2f2f9fcbfdedec803919a5"}, "originalPosition": 215}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzg5MDYzOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMToxMToyN1rOGCWS5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMToxMToyN1rOGCWS5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTExNTYyMQ==", "bodyText": "// Starts a FutureTask on a new thread (if one doesn't already exist) to load the models asynchronously", "url": "https://github.com/ankidroid/Anki-Android/pull/5947#discussion_r405115621", "createdAt": "2020-04-07T21:11:27Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2024,15 +2024,66 @@ public Media getMedia() {\n         return mMedia;\n     }\n \n+    private class ModelsLoader {\n+    /**\n+        Ensure that models get loaded. This operation only need to be\n+        done once; this is the point of using a future.\n+\n+        Loading only need to be done when anki starts and after full\n+        sync. This is the point of using a future, ensuring it's done\n+        once and only once.\n+\n+        However, loading may blocks database for a long time when\n+        there are a lot of note types or when there are big note\n+        types, so it should only be performed when database is not\n+        used by more important tasks. This is why it is not done in\n+        the main thread, but in a separate thread. Furthermore, the\n+        models are not required to show the deck picker screen, so it\n+        can wait until the screen has loaded.\n+\n+        Most of the time is spent querying the database, and blocking\n+        access to it. Because of that we want to load the models only\n+        when there are no important data base access\n+        needed. E.g. after the list of deck is displayed to the user.\n+\n+     */\n+        private Collection mCol;\n+        private FutureTask<Models> mFutureTask;\n+\n+        public ModelsLoader (Collection col) {\n+            mCol = col;\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbaa92c4c94b6f41ae2f2f9fcbfdedec803919a5"}, "originalPosition": 207}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNjM5MDI4OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzowMTowMlrOGCuGJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzowMTowMlrOGCuGJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUwNTU3Mg==", "bodyText": "Add a comment here:\n// Start loading the models asynchronously\n// This can still indirectly block other operations if they require database access", "url": "https://github.com/ankidroid/Anki-Android/pull/5947#discussion_r405505572", "createdAt": "2020-04-08T13:01:02Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2024,15 +2024,66 @@ public Media getMedia() {\n         return mMedia;\n     }\n \n+    private class ModelsLoader {\n+    /**\n+        Ensure that models get loaded. This operation only need to be\n+        done once; this is the point of using a future.\n+\n+        Loading only need to be done when anki starts and after full\n+        sync. This is the point of using a future, ensuring it's done\n+        once and only once.\n+\n+        However, loading may blocks database for a long time when\n+        there are a lot of note types or when there are big note\n+        types, so it should only be performed when database is not\n+        used by more important tasks. This is why it is not done in\n+        the main thread, but in a separate thread. Furthermore, the\n+        models are not required to show the deck picker screen, so it\n+        can wait until the screen has loaded.\n+\n+        Most of the time is spent querying the database, and blocking\n+        access to it. Because of that we want to load the models only\n+        when there are no important data base access\n+        needed. E.g. after the list of deck is displayed to the user.\n+\n+     */\n+        private Collection mCol;\n+        private FutureTask<Models> mFutureTask;\n+\n+        public ModelsLoader (Collection col) {\n+            mCol = col;\n+        }\n+\n+        public void load() {\n+            if (mFutureTask != null) {\n+                return;\n+            }\n+            mFutureTask = new FutureTask<Models> (() -> new Models(mCol).load(loadColumn(\"models\")));\n+            new Thread(mFutureTask).start();\n+        }\n+\n+        public Models get() {\n+            load();\n+            try {\n+                return mFutureTask.get();\n+            } catch (ExecutionException | InterruptedException e) {\n+                throw new RuntimeException(e);\n+            }\n+        }\n+    }\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbaa92c4c94b6f41ae2f2f9fcbfdedec803919a5"}, "originalPosition": 225}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNjQxNzMyOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzowNzozOFrOGCuXVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzowNzozOFrOGCuXVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUwOTk3NQ==", "bodyText": "This function could potentially be called simultaneously from multiple threads which would lead to a race condition, so better make it synchronized", "url": "https://github.com/ankidroid/Anki-Android/pull/5947#discussion_r405509975", "createdAt": "2020-04-08T13:07:38Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2024,15 +2024,66 @@ public Media getMedia() {\n         return mMedia;\n     }\n \n+    private class ModelsLoader {\n+    /**\n+        Ensure that models get loaded. This operation only need to be\n+        done once; this is the point of using a future.\n+\n+        Loading only need to be done when anki starts and after full\n+        sync. This is the point of using a future, ensuring it's done\n+        once and only once.\n+\n+        However, loading may blocks database for a long time when\n+        there are a lot of note types or when there are big note\n+        types, so it should only be performed when database is not\n+        used by more important tasks. This is why it is not done in\n+        the main thread, but in a separate thread. Furthermore, the\n+        models are not required to show the deck picker screen, so it\n+        can wait until the screen has loaded.\n+\n+        Most of the time is spent querying the database, and blocking\n+        access to it. Because of that we want to load the models only\n+        when there are no important data base access\n+        needed. E.g. after the list of deck is displayed to the user.\n+\n+     */\n+        private Collection mCol;\n+        private FutureTask<Models> mFutureTask;\n+\n+        public ModelsLoader (Collection col) {\n+            mCol = col;\n+        }\n+\n+        public void load() {\n+            if (mFutureTask != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbaa92c4c94b6f41ae2f2f9fcbfdedec803919a5"}, "originalPosition": 209}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNjQ0Nzk0OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzoxNDo0OVrOGCuqXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzoxNDo0OVrOGCuqXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUxNDg0NA==", "bodyText": "Personally I feel this comment is too long and difficult to understand. You don't need to tell the whole life story of this pull request, just briefly put what does the class do, why does it do it, and how is it used. It's up to you though.", "url": "https://github.com/ankidroid/Anki-Android/pull/5947#discussion_r405514844", "createdAt": "2020-04-08T13:14:49Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2024,15 +2024,66 @@ public Media getMedia() {\n         return mMedia;\n     }\n \n+    private class ModelsLoader {\n+    /**\n+        Ensure that models get loaded. This operation only need to be", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbaa92c4c94b6f41ae2f2f9fcbfdedec803919a5"}, "originalPosition": 180}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 520, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}