{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNDUyNzk3", "number": 5736, "title": "Okhttp interrupted crash", "bodyText": "Pull Request template\nPurpose / Description\nhttps://couchdb.ankidroid.org/acralyzer/_design/acralyzer/index.html#/report-details/950f7ab5-1e97-44a2-b58a-e56f15d08e72\nOkHTTP uses slightly different errors to percolate timeouts and connection interruptions vs the apache-http library, so we are now misinterpreting relatively harmless errors has something we should crash on\nApproach\nI added the two okio (okhttp underlying library) messages to our connection error logic\nhttps://github.com/square/okio/blob/1bed1bc104c19a673ad86fbe7e8eed859131a5ee/okio/src/main/java/okio/Timeout.java#L220-L226\nHow Has This Been Tested?\nInstalled and used on API28 and API29 emulators to do a conflict full sync, a no-op sync, then to sync the results of a small review between them, it all still worked. I also checked interrupting data while a full sync was happening and it threw an error message instead of crashing\nAfter the one commit with what should be the crash fix there is a second separate one which delints the file a bit. Look at the commits separately for easy review\nLearning (optional, can help others)\ngoogled for the error present in the stack trace after stepping through the control flow in our connection code to see how the error was circulating\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-02-03T18:14:22Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5736", "merged": true, "mergeCommit": {"oid": "8b909f6d2e9505efcad2532fb55e9699527be9ff"}, "closed": true, "closedAt": "2020-02-03T20:08:16Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAwkfbgH2gAyMzcwNDUyNzk3OjkxMjc2ZDgzMjUzODk0ZGJhZjE1MjE0ODQ2MWFjODEwN2JlYWRmZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAyqPAAFqTM1MjUyODAxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "91276d83253894dbaf152148461ac8107beadff4", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/91276d83253894dbaf152148461ac8107beadff4", "committedDate": "2020-02-03T17:41:23Z", "message": "Adapt timeout detection to handle okhttp transition\n\nWithout this change, timeouts that were handled with apache-http are bubbling\nup and causing app crashes when it is really just a connection error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e4aedec402a9e41ebba3fcabee13dc2008e9392", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4e4aedec402a9e41ebba3fcabee13dc2008e9392", "committedDate": "2020-02-03T17:42:23Z", "message": "de-lint and spelling fixes in Connection object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "495da526a5619dd108e6218afafa8e09057b6192", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/495da526a5619dd108e6218afafa8e09057b6192", "committedDate": "2020-02-03T18:23:04Z", "message": "Add okhttp connection failure to list of timeouts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNTI4MDE5", "url": "https://github.com/ankidroid/Anki-Android/pull/5736#pullrequestreview-352528019", "createdAt": "2020-02-03T20:07:27Z", "commit": {"oid": "495da526a5619dd108e6218afafa8e09057b6192"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMDowNzoyN1rOFk-T-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMDowNzoyN1rOFk-T-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMxMzk3OA==", "bodyText": "Probably with the new library we no longer need to rely on string comparisons of the message to figure out whether a network error occurred... This was just a nasty hack we threw together to work around that old Apache library. I'll merge for now as a quick fix, but you should definitely consider using they type information instead of string comparisons if possible.", "url": "https://github.com/ankidroid/Anki-Android/pull/5736#discussion_r374313978", "createdAt": "2020-02-03T20:07:27Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/Connection.java", "diffHunk": "@@ -249,13 +251,16 @@ private Payload doInBackgroundLogin(Payload data) {\n     }\n \n \n-    private boolean timeoutOccured(Exception e) {\n+    private boolean timeoutOccurred(Exception e) {\n         String msg = e.getMessage();\n         return msg.contains(\"UnknownHostException\") ||\n                 msg.contains(\"HttpHostConnectException\") ||\n                 msg.contains(\"SSLException while building HttpClient\") ||\n                 msg.contains(\"SocketTimeoutException\") ||\n                 msg.contains(\"ClientProtocolException\") ||\n+                msg.contains(\"deadline reached\") ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "495da526a5619dd108e6218afafa8e09057b6192"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3670, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}