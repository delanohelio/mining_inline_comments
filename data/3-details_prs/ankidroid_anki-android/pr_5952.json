{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwODI4NDM0", "number": 5952, "title": "CardViewer: Correctly Decode typed text in <input>", "bodyText": "Purpose / Description\nPreviously, only some data was URL Encoded when sent from JS to Java. When an invalid sequence (a single %) was entered, then the app would crash due to the decode failure.\nFixes\nFixes #5944\nApproach\nWe both fix this encoding in the JS, and if invalid data comes in for any reason, we show an error.\nHow Has This Been Tested?\nUnit Tested with data. No longer crashes my Android.\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-04-08T12:49:33Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5952", "merged": true, "mergeCommit": {"oid": "cf434f10ed8556679f8256ee11729d61d27d789d"}, "closed": true, "closedAt": "2020-04-08T19:10:25Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVmWEDgH2gAyNDAwODI4NDM0OjQ0ZjNmOGI2YjZhNjNlYThlMTljNTk1N2ZmYTY4Mjk2MTc1ZmEzNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVsy74gFqTM5MDI1NTM3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "44f3f8b6b6a63ea8e19c5957ffa68296175fa368", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/44f3f8b6b6a63ea8e19c5957ffa68296175fa368", "committedDate": "2020-04-08T11:38:59Z", "message": "NF: Extract CardViewerWebClient\n\nThis helps with testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc8c7c80f2e7234e4a944acc8ae0d6a916ade518", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/cc8c7c80f2e7234e4a944acc8ae0d6a916ade518", "committedDate": "2020-04-08T11:41:44Z", "message": "NF: CardViewerWebClient Add Logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62225f4da802971884308ea4c101461737076701", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/62225f4da802971884308ea4c101461737076701", "committedDate": "2020-04-08T12:44:08Z", "message": "URLEncode data before sending to Java\n\nFixes #5944\n\nPreviously, only some data was encoded. When an invalid sequence (single\n%) was entered, then the app would crash due to the decode failure.\n\nWe both fix this encoding in the JS, and if invalid data comes in for\nany reason, we show an error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5OTQzMTY4", "url": "https://github.com/ankidroid/Anki-Android/pull/5952#pullrequestreview-389943168", "createdAt": "2020-04-08T12:52:07Z", "commit": {"oid": "62225f4da802971884308ea4c101461737076701"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMjo1MjowN1rOGCtv-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMjo1MjowN1rOGCtv-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ5OTg5OA==", "bodyText": "Issue found: The method 'filterUrl(String)' has an NPath complexity of 22176", "url": "https://github.com/ankidroid/Anki-Android/pull/5952#discussion_r405499898", "createdAt": "2020-04-08T12:52:07Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -3168,4 +2910,300 @@ public static int getSignalFromUrl(String url) {\n             return SIGNAL_UNHANDLED; //unknown, or not a signal.\n         }\n     }\n+\n+    protected class CardViewerWebClient extends WebViewClient {\n+        @Override\n+        @TargetApi(Build.VERSION_CODES.N)\n+        public boolean shouldOverrideUrlLoading(WebView view, WebResourceRequest request) {\n+            String url = request.getUrl().toString();\n+            Timber.i(\"Obtained URL from card: '%s'\", url);\n+            return filterUrl(url);\n+        }\n+\n+\n+        @Override\n+        @TargetApi(Build.VERSION_CODES.N)\n+        public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceRequest request) {\n+            WebResourceResponse webResourceResponse = null;\n+            if (!AdaptionUtil.hasWebBrowser(getBaseContext())) {\n+                String scheme = request.getUrl().getScheme().trim();\n+                if (scheme.equalsIgnoreCase(\"http\") || scheme.equalsIgnoreCase(\"https\")) {\n+                    String response = getResources().getString(R.string.no_outgoing_link_in_cardbrowser);\n+                    webResourceResponse = new WebResourceResponse(\"text/html\", \"utf-8\", new ByteArrayInputStream(response.getBytes()));\n+                }\n+            }\n+            return webResourceResponse;\n+        }\n+\n+\n+        @Override\n+        @SuppressWarnings(\"deprecation\") // tracked as #5017 in github\n+        public boolean shouldOverrideUrlLoading(WebView view, String url) {\n+            return filterUrl(url);\n+        }\n+\n+\n+        // Filter any links using the custom \"playsound\" protocol defined in Sound.java.\n+        // We play sounds through these links when a user taps the sound icon.\n+        private boolean filterUrl(String url) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62225f4da802971884308ea4c101461737076701"}, "originalPosition": 306}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5OTQzMTgy", "url": "https://github.com/ankidroid/Anki-Android/pull/5952#pullrequestreview-389943182", "createdAt": "2020-04-08T12:52:08Z", "commit": {"oid": "62225f4da802971884308ea4c101461737076701"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMjo1MjowOFrOGCtwBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMjo1MjowOFrOGCtwBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQ5OTkwOQ==", "bodyText": "Issue found: JUnit tests should include assert() or fail()", "url": "https://github.com/ankidroid/Anki-Android/pull/5952#discussion_r405499909", "createdAt": "2020-04-08T12:52:08Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/test/java/com/ichi2/anki/AbstractFlashcardViewerTest.java", "diffHunk": "@@ -272,4 +285,40 @@ public void invalidEaseIsParsedFromSignal() {\n         String url = \"signal:answer_ease0\";\n         assertEquals(SIGNAL_NOOP, getSignalFromUrl(url));\n     }\n+\n+    @Test\n+    public void invalidEncodingDoesNotCrash() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62225f4da802971884308ea4c101461737076701"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5OTcxODk0", "url": "https://github.com/ankidroid/Anki-Android/pull/5952#pullrequestreview-389971894", "createdAt": "2020-04-08T13:26:53Z", "commit": {"oid": "44f3f8b6b6a63ea8e19c5957ffa68296175fa368"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzoyNjo1M1rOGCvLmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxMzoyNjo1M1rOGCvLmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTUyMzM1NA==", "bodyText": "Yeah, maybe having a 250+ line sub-class inline isn't the best idea... ;-)", "url": "https://github.com/ankidroid/Anki-Android/pull/5952#discussion_r405523354", "createdAt": "2020-04-08T13:26:53Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1494,265 +1494,7 @@ private WebView createWebView() {\n         webView.setScrollbarFadingEnabled(true);\n         Timber.d(\"Focusable = %s, Focusable in touch mode = %s\", webView.isFocusable(), webView.isFocusableInTouchMode());\n \n-        webView.setWebViewClient(new WebViewClient() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f3f8b6b6a63ea8e19c5957ffa68296175fa368"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMjU1Mzc1", "url": "https://github.com/ankidroid/Anki-Android/pull/5952#pullrequestreview-390255375", "createdAt": "2020-04-08T19:09:57Z", "commit": {"oid": "62225f4da802971884308ea4c101461737076701"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3607, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}