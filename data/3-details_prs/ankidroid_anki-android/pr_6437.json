{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMzIxMDMw", "number": 6437, "title": "sync: fix media sync with trailing slash on media sync url", "bodyText": "Prevent duplicated slashes in the media sync url\nPull Request template\nPurpose / Description\nIf my Media sync url under Settings -> Advanced -> Custom sync server  ends with a slash, I get a 404 on synchronization because of a duplicate slash (/) in the url.\nThis PR adds a check, that prevents the duplicate slash.\nFixes\nFixes #6436\nApproach\nI add a check to RemoteMediaServer::syncURL that prevents the second slash from being added to the url if it already ends with an slash.\nHow Has This Been Tested?\nI installed ankicommunity/anki-sync-server locally.\nThen I added my custom sync server under Settings -> Advanced -> Custom sync server.\nMy Media sync url  ends with a slash (\\).\nWhen I tap the sync button in the main activity everything synchronizes without an error.\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-06-11T20:39:58Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6437", "merged": true, "mergeCommit": {"oid": "9a509c5d623eb7882cf116eaaf6034db0c901ab3"}, "closed": true, "closedAt": "2020-06-18T19:49:50Z", "author": {"login": "kalehmann"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqW3_PAFqTQyOTM2MDYwOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr58nCgFqTQzMTgwMzQ2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzYwNjA5", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#pullrequestreview-429360609", "createdAt": "2020-06-11T23:29:58Z", "commit": {"oid": "b345982929e4d2f372ec53da11d8d3443c0c988f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b345982929e4d2f372ec53da11d8d3443c0c988f", "author": {"user": {"login": "kalehmann", "name": "Karsten Lehmann"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b345982929e4d2f372ec53da11d8d3443c0c988f", "committedDate": "2020-06-11T20:38:57Z", "message": "sync: fix media sync with trailing slash on url\n\nPrevent duplicated slashes in the media sync url"}, "afterCommit": {"oid": "dc1861d12593105dbc12777bc1083c7e452cd5b1", "author": {"user": {"login": "kalehmann", "name": "Karsten Lehmann"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/dc1861d12593105dbc12777bc1083c7e452cd5b1", "committedDate": "2020-06-14T15:30:14Z", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjMzMTgw", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#pullrequestreview-430233180", "createdAt": "2020-06-14T16:25:36Z", "commit": {"oid": "dc1861d12593105dbc12777bc1083c7e452cd5b1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNjoyNTozN1rOGjeEjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNjoyOToxNVrOGjeFug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjAzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    AlertDialog.Builder builder = new AlertDialog.Builder(this);\n          \n          \n            \n                                    builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n          \n          \n            \n                                    builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n          \n          \n            \n                                    new AlertDialog.Builder(this)\n          \n          \n            \n                                        .setTitle(R.string.custom_sync_server_base_url_invalid);\n          \n          \n            \n                                        .setPositiveButton(R.string.dialog_ok, null)\n          \n          \n            \n                                        .show();", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846031", "createdAt": "2020-06-14T16:25:37Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc1861d12593105dbc12777bc1083c7e452cd5b1"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjEwMw==", "bodyText": "same as above - it's a fluent API, use the fluency, and since we don't care about the builder after we use it, it does not need a local variable even I don't believe", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846103", "createdAt": "2020-06-14T16:26:23Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_single_slash);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc1861d12593105dbc12777bc1083c7e452cd5b1"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjExNg==", "bodyText": "same as above - it's a fluent API, use the fluency, and since we don't care about the builder after we use it, it does not need a local variable even I don't believe", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846116", "createdAt": "2020-06-14T16:26:38Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_single_slash);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    return true;\n+                });\n+                mSyncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_media_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc1861d12593105dbc12777bc1083c7e452cd5b1"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjEyOA==", "bodyText": "same as above - it's a fluent API, use the fluency, and since we don't care about the builder after we use it, it does not need a local variable even I don't believe", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846128", "createdAt": "2020-06-14T16:26:46Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_single_slash);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    return true;\n+                });\n+                mSyncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_media_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_media_url_single_slash);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc1861d12593105dbc12777bc1083c7e452cd5b1"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NjMzMA==", "bodyText": "If the URIUtil already says it is valid, why are we checking something else? It is valid or not, isn't it?\nShould the URIUtil be extended to do the complete check, or is the second check unnecessary? (this comment applies to the other instance as well", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#discussion_r439846330", "createdAt": "2020-06-14T16:29:15Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -380,6 +384,51 @@ private void initSubscreen(String action, PreferenceContext listener) {\n             case \"com.ichi2.anki.prefs.custom_sync_server\":\n                 getSupportActionBar().setTitle(R.string.custom_sync_server_title);\n                 listener.addPreferencesFromResource(R.xml.preferences_custom_sync_server);\n+                screen = listener.getPreferenceScreen();\n+                Preference syncUrlPreference = screen.findPreference(\"syncBaseUrl\");\n+                Preference mSyncUrlPreference = screen.findPreference(\"syncMediaUrl\");\n+                syncUrlPreference.setOnPreferenceChangeListener((Preference preference, Object newValue) -> {\n+                    String newUrl = newValue.toString();\n+                    if (!URLUtil.isValidUrl(newUrl)) {\n+                        AlertDialog.Builder builder = new AlertDialog.Builder(this);\n+                        builder.setTitle(R.string.custom_sync_server_base_url_invalid);\n+                        builder.setPositiveButton(R.string.dialog_ok, null);builder.show();\n+\n+                        return false;\n+                    }\n+\n+                    URI uri = URI.create(newUrl);\n+                    if (!Pattern.matches(\".*[^/]*/$\", uri.getPath())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc1861d12593105dbc12777bc1083c7e452cd5b1"}, "originalPosition": 50}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc1861d12593105dbc12777bc1083c7e452cd5b1", "author": {"user": {"login": "kalehmann", "name": "Karsten Lehmann"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/dc1861d12593105dbc12777bc1083c7e452cd5b1", "committedDate": "2020-06-14T15:30:14Z", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url"}, "afterCommit": {"oid": "de980370963f7d7a5d47168d562e486eb0951737", "author": {"user": {"login": "kalehmann", "name": "Karsten Lehmann"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/de980370963f7d7a5d47168d562e486eb0951737", "committedDate": "2020-06-14T18:56:04Z", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de980370963f7d7a5d47168d562e486eb0951737", "author": {"user": {"login": "kalehmann", "name": "Karsten Lehmann"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/de980370963f7d7a5d47168d562e486eb0951737", "committedDate": "2020-06-14T18:56:04Z", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url"}, "afterCommit": {"oid": "0173a162bcf0de570edeccf60b11f417d2c1b994", "author": {"user": {"login": "kalehmann", "name": "Karsten Lehmann"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0173a162bcf0de570edeccf60b11f417d2c1b994", "committedDate": "2020-06-14T19:01:15Z", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "709732d5630c6184ed0871aa85131f194405fd42", "author": {"user": {"login": "kalehmann", "name": "Karsten Lehmann"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/709732d5630c6184ed0871aa85131f194405fd42", "committedDate": "2020-06-14T19:07:28Z", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0173a162bcf0de570edeccf60b11f417d2c1b994", "author": {"user": {"login": "kalehmann", "name": "Karsten Lehmann"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0173a162bcf0de570edeccf60b11f417d2c1b994", "committedDate": "2020-06-14T19:01:15Z", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url"}, "afterCommit": {"oid": "709732d5630c6184ed0871aa85131f194405fd42", "author": {"user": {"login": "kalehmann", "name": "Karsten Lehmann"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/709732d5630c6184ed0871aa85131f194405fd42", "committedDate": "2020-06-14T19:07:28Z", "message": "preferences: Enforce slash at the end of url\n\nEnforces one and only one single slash at the end of the sync url\nand the media sync url"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODAzNDYz", "url": "https://github.com/ankidroid/Anki-Android/pull/6437#pullrequestreview-431803463", "createdAt": "2020-06-16T18:55:37Z", "commit": {"oid": "709732d5630c6184ed0871aa85131f194405fd42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3183, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}