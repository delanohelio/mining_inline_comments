{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3ODEyNjY3", "number": 6663, "title": "Protect against stale field info in CardTemplatePreviewer", "bodyText": "Pull Request template\nPurpose / Description\nApparently it is possible for the model and the preview bundle to\nbe out of sync, unsure how it came about but now we won't populate off\nthe end of the field array and we will carefully clean up after\nCardTemplatePreviewer where before no cleanup was done\nFixes\nFixes #6644\nApproach\nI harden the array access that caused the crash so that is not possible at all, so we shouldn't crash\nWhy did we get there though? I'm not 100% sure and don't have the time to run it to ground completely unfortunately\nWhat I did add was cleanup though - perhaps the fields and model were out of sync because no cleanup was done? So now I do a start-for-result to open the card template previewer and I close it carefully while cleaning up the TemporaryModel file which had been orphaned before\nHow Has This Been Tested?\nAPI29 testing - I could not replicate the crash unfortunately but I could replicate crashing when I started trying to clean up after ourselves! Required a bit of internal state hardening which is an improvement I think\nI know that with array length checks during array traversal we won't crash in the same way at least and since it's just a preview hopefully we don't crash at all\nLearning (optional, can help others)\nI learned that to get control of the little back arrows at top left you have to override onNavigation, that was unexpected, I was thinking onOptionItem etc\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-07-11T20:21:01Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6663", "merged": true, "mergeCommit": {"oid": "184effd4d1c47fb3308b26bd308bcce36ccdb7e4"}, "closed": true, "closedAt": "2020-07-14T15:33:56Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0FB56gFqTQ0Njg0NDYzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc03uE3gFqTQ0ODIxNTAzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODQ0NjMz", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#pullrequestreview-446844633", "createdAt": "2020-07-12T04:15:58Z", "commit": {"oid": "76490b580ab015f445fd5b61d5185fed4b1b2d32"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoxNTo1OFrOGwRFsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDoyOVrOGwRGtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NDgxOQ==", "bodyText": "This doesn't finish() on certain cases.\nBrackets would make the logic more explicit", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453264819", "createdAt": "2020-07-12T04:15:58Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -136,6 +160,10 @@ public void onSaveInstanceState(Bundle outState) {\n     @Override\n     protected void onCollectionLoaded(Collection col) {\n         super.onCollectionLoaded(col);\n+        if (isFinishing() || (mCurrentCard == null) && (mCardList == null)) {\n+            Timber.d(\"onCollectionLoaded - incorrect state to load, closing\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76490b580ab015f445fd5b61d5185fed4b1b2d32"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA3OQ==", "bodyText": "This constant isn't used other than here. This seems to launch the activity twice.", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453265079", "createdAt": "2020-07-12T04:20:29Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -936,6 +937,7 @@ public boolean onOptionsItemSelected(MenuItem item) {\n                 Bundle noteEditorBundle = new Bundle();\n                 onSaveInstanceState(noteEditorBundle);\n                 previewer.putExtra(\"noteEditorBundle\", noteEditorBundle);\n+                startActivityForResultWithoutAnimation(previewer, REQUEST_PREVIEW);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76490b580ab015f445fd5b61d5185fed4b1b2d32"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e29357fae38d8112038728aef3d149c7fb5f3d9e", "committedDate": "2020-07-13T22:06:39Z", "message": "Protect against mis-matched field info in CardTemplatePreviewer\n\nIt is possible for the model and the preview bundle to\nbe out of sync, as NoteEditor preserves \"extra\" fields from old card types\nin case the user switches back, meaning we could be attempting to preview with\nmore field info than we have fields to show\n\nnow we won't populate fields off the end of the note's field array\n\nadditionally we will carefully clean up after\nCardTemplatePreviewer where before no cleanup was done"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76490b580ab015f445fd5b61d5185fed4b1b2d32", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/76490b580ab015f445fd5b61d5185fed4b1b2d32", "committedDate": "2020-07-11T20:15:18Z", "message": "Protect against stale field info in CardTemplatePreviewer\n\nApparently it is possible for the model and the preview bundle to\nbe out of sync, unsure how it came about but now we won't populate off\nthe end of the field array and we will carefully clean up after\nCardTemplatePreviewer where before no cleanup was done"}, "afterCommit": {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e29357fae38d8112038728aef3d149c7fb5f3d9e", "committedDate": "2020-07-13T22:06:39Z", "message": "Protect against mis-matched field info in CardTemplatePreviewer\n\nIt is possible for the model and the preview bundle to\nbe out of sync, as NoteEditor preserves \"extra\" fields from old card types\nin case the user switches back, meaning we could be attempting to preview with\nmore field info than we have fields to show\n\nnow we won't populate fields off the end of the note's field array\n\nadditionally we will carefully clean up after\nCardTemplatePreviewer where before no cleanup was done"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MTMxMzg2", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#pullrequestreview-448131386", "createdAt": "2020-07-14T13:57:22Z", "commit": {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzo1NzoyMlrOGxU5fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzo1NzoyMlrOGxU5fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM3NTgwNQ==", "bodyText": "Needs confirmation this still works with the CardTemplatePreviewer - I'd have expected this to be required for state restoration if it's too big for a bundle.", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r454375805", "createdAt": "2020-07-14T13:57:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -89,11 +91,33 @@ protected void onResume() {\n         super.onResume();\n         if (mCurrentCard == null || mOrdinal < 0) {\n             Timber.e(\"CardTemplatePreviewer started with empty card list or invalid index\");\n-            finishWithoutAnimation();\n+            closeCardTemplatePreviewer();\n         }\n     }\n \n \n+    private void closeCardTemplatePreviewer() {\n+        Timber.d(\"CardTemplatePreviewer:: closeCardTemplatePreviewer()\");\n+        setResult(RESULT_OK);\n+        TemporaryModel.clearTempModelFiles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MjE1MDMz", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#pullrequestreview-448215033", "createdAt": "2020-07-14T15:25:15Z", "commit": {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3111, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}