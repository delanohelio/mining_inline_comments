{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMjA1ODgx", "number": 6959, "title": "Bug: Undo and card in learning.", "bodyText": "There are multiple things here.\nI split undo in two, so that I get access to the actual background part without creating a background task nad having to deal with UI part. This is useful to entirely tests undo, since there are some parts of undo not done in col.undo.\nThen, I add a test that bugs and should not bug. Thanks to David for explaining how to create it. Because of it, a card undone which becomes a learning card is not added to the learning queue. The problem is that mCardNotToFetch was not set to null even when it is not relevant anymore.\nThis was relevant for prefetching a card. Except that I forgot to tell the preLoadCard method to reset counts and queues if required, which made the method useless after a reset. (Actually, in the first version, preLoadCard was calling getCard so this would have been totally useless. But I did change for a version dealing with a queue of card and forgot to update this part...)\nFor safety, I also ensured that getCard set the two variables to null. This should be NF for reviewer. Maybe not NF for the content provider.\nI should note it's not related to 2.12.1 bugs since those were introduce in alphas.", "createdAt": "2020-08-24T01:03:26Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6959", "merged": true, "mergeCommit": {"oid": "f9647db16539b87398ea655626c239cf0148575f"}, "closed": true, "closedAt": "2020-08-30T23:24:08Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdB3_s3gBqjM2ODMzMjEwNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDqQ9sgBqjM3MDY1MzUxMjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92b53eb4c9d051176ab5e1e7b0344449da922333", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/92b53eb4c9d051176ab5e1e7b0344449da922333", "committedDate": "2020-08-24T00:40:04Z", "message": "resetLrn"}, "afterCommit": {"oid": "ecd110d879d5c2c7e9861a8593b66dbd2d78b72b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ecd110d879d5c2c7e9861a8593b66dbd2d78b72b", "committedDate": "2020-08-24T01:00:52Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMDkxODc2", "url": "https://github.com/ankidroid/Anki-Android/pull/6959#pullrequestreview-473091876", "createdAt": "2020-08-24T03:01:18Z", "commit": {"oid": "ecd110d879d5c2c7e9861a8593b66dbd2d78b72b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjg3MjMw", "url": "https://github.com/ankidroid/Anki-Android/pull/6959#pullrequestreview-473287230", "createdAt": "2020-08-24T09:25:34Z", "commit": {"oid": "ecd110d879d5c2c7e9861a8593b66dbd2d78b72b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToyNTozNFrOHFbx9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwOToyNTozNFrOHFbx9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ2MDA4Nw==", "bodyText": "Could you modify the ported tests to run twice, once using this undo, one one using the regular col.undo()", "url": "https://github.com/ankidroid/Anki-Android/pull/6959#discussion_r475460087", "createdAt": "2020-08-24T09:25:34Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1125,6 +1126,33 @@ private TaskData doInBackgroundDismissNotes(TaskData param) {\n         return copies;\n     }\n \n+    @VisibleForTesting\n+    public static Card nonTaskUndo(Collection col) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecd110d879d5c2c7e9861a8593b66dbd2d78b72b"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ecd110d879d5c2c7e9861a8593b66dbd2d78b72b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ecd110d879d5c2c7e9861a8593b66dbd2d78b72b", "committedDate": "2020-08-24T01:00:52Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}, "afterCommit": {"oid": "4c1688c6a32daf25ee626c540c018fc40efded35", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4c1688c6a32daf25ee626c540c018fc40efded35", "committedDate": "2020-08-24T17:55:27Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c1688c6a32daf25ee626c540c018fc40efded35", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4c1688c6a32daf25ee626c540c018fc40efded35", "committedDate": "2020-08-24T17:55:27Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}, "afterCommit": {"oid": "faf02503807cd7ce28fd81e58b8eb9b8c7029848", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/faf02503807cd7ce28fd81e58b8eb9b8c7029848", "committedDate": "2020-08-24T18:08:47Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "faf02503807cd7ce28fd81e58b8eb9b8c7029848", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/faf02503807cd7ce28fd81e58b8eb9b8c7029848", "committedDate": "2020-08-24T18:08:47Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}, "afterCommit": {"oid": "36df2bbf01c1c39dc4529a1f246ad45ca72f4393", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/36df2bbf01c1c39dc4529a1f246ad45ca72f4393", "committedDate": "2020-08-24T18:11:53Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36df2bbf01c1c39dc4529a1f246ad45ca72f4393", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/36df2bbf01c1c39dc4529a1f246ad45ca72f4393", "committedDate": "2020-08-24T18:11:53Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}, "afterCommit": {"oid": "f601ae3859dc7c776fa356fd0ccab4c60340a003", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f601ae3859dc7c776fa356fd0ccab4c60340a003", "committedDate": "2020-08-24T18:24:44Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e4d1bd745e5ad2093662a8143e9533bea70ba58", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9e4d1bd745e5ad2093662a8143e9533bea70ba58", "committedDate": "2020-08-28T22:57:26Z", "message": "NF: split undo for testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f172b1b0fef56ad51d1ee7172a49c34bf2001358", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f172b1b0fef56ad51d1ee7172a49c34bf2001358", "committedDate": "2020-08-29T01:24:13Z", "message": "NF: uses undo in test instead of background task"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f601ae3859dc7c776fa356fd0ccab4c60340a003", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f601ae3859dc7c776fa356fd0ccab4c60340a003", "committedDate": "2020-08-24T18:24:44Z", "message": "Remove mCardNotToFetch/mCardToDecrement when card answered\n\nIf the queue is reset while a card is in reviewer, this card should be taken into account. But if the card is answered,\nno need to keep track of it anymore. This should be NF as long as pre fetching occurs between undo and `getCard`"}, "afterCommit": {"oid": "9de9ebf44f898774f403843f6290954f495de343", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9de9ebf44f898774f403843f6290954f495de343", "committedDate": "2020-08-29T01:24:13Z", "message": "NF: uses queue correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52c1f5ca03cbd175af253eccac2eb0d0960fc114", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/52c1f5ca03cbd175af253eccac2eb0d0960fc114", "committedDate": "2020-08-29T14:03:22Z", "message": "NF: tests use col reset instead of sched reset\n\nReset of sched should never been called directly. The scheduler decides whethen it is needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c81684efd079a2c1226226a959fd7c3036540682", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c81684efd079a2c1226226a959fd7c3036540682", "committedDate": "2020-08-29T14:05:53Z", "message": "NF: regression test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbbe58958eaa90c6deb7103fc53323fff89ec89f", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/dbbe58958eaa90c6deb7103fc53323fff89ec89f", "committedDate": "2020-08-29T14:05:53Z", "message": "Going back to a simple mCurrentCard\n\nNow that the resetCount and resetQueue are separated that's quite simpler. And according to the test, it's also the good\nway.\n\nThe idea is that: either there is a card in reviewer or there is not. Nothing else to take into account.\n\nIf there is no card in reviewer, do as usual, as upstream.\n\nIf there is a card in reviewer, do not count it, discard it when prefetching the queues. That is, simulate the part\nbetween getCard and answerCard.\n\nBut, instead of discarding it, just ensure that the resetCounts does not count it at all. This way, if\nresetNew/Lrn/RevCount occurs because of queue filling, it'll still have good value, which is the part I missed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9ee54b159fe1117262f0e9650761befa83eefdb", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a9ee54b159fe1117262f0e9650761befa83eefdb", "committedDate": "2020-08-29T14:05:53Z", "message": "NF: getGoodNewButton"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88ec93ff1f5288d7847f1b65f5d8c622e8e4a5a2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/88ec93ff1f5288d7847f1b65f5d8c622e8e4a5a2", "committedDate": "2020-08-29T14:05:53Z", "message": "NF: uses queue correctly"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9de9ebf44f898774f403843f6290954f495de343", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9de9ebf44f898774f403843f6290954f495de343", "committedDate": "2020-08-29T01:24:13Z", "message": "NF: uses queue correctly"}, "afterCommit": {"oid": "88ec93ff1f5288d7847f1b65f5d8c622e8e4a5a2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/88ec93ff1f5288d7847f1b65f5d8c622e8e4a5a2", "committedDate": "2020-08-29T14:05:53Z", "message": "NF: uses queue correctly"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2980, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}