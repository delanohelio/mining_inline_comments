{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwODg2Mjkz", "number": 5834, "title": "Persist Whiteboard Visible State", "bodyText": "This review was borderline \"I should split this into commits\". If you'd prefer this, please let me know.\nI'd also love to hear \"You should abstract out the whiteboard logic from Reviewer and test it\", but I doubt it's considered to be a good use of time.\n\nPurpose / Description\nPreviously, the whiteboard visible state depended on the enabled state\nThis caused problems when switching from Night Mode, as it would forget the Visible setting.\nFixes\nFixes #5065\nApproach\nWe now persist the visible state to the internal database, this still depends on the enabled flag.\nHow Has This Been Tested?\nPreviously it did not work on my device.\nNow when switching to night mode, the visible status is saved.\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-03-19T09:17:56Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5834", "merged": true, "mergeCommit": {"oid": "ab9b9354a4990b872ad4d5dcc391fb3aec9baaf4"}, "closed": true, "closedAt": "2020-03-22T19:01:03Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPMhVYgFqTM3Nzc1MDE3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQMHbtgFqTM3OTAyMTA2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NzUwMTc5", "url": "https://github.com/ankidroid/Anki-Android/pull/5834#pullrequestreview-377750179", "createdAt": "2020-03-19T14:05:00Z", "commit": {"oid": "408cd9bc413aee931698109b98f0b2098dbaa91b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDowNTowMFrOF4v6fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNDowODoyM1rOF4wEOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA0OTU5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(columnCount <= 0) {\n          \n          \n            \n                    if (columnCount <= 0) {", "url": "https://github.com/ankidroid/Anki-Android/pull/5834#discussion_r395049596", "createdAt": "2020-03-19T14:05:00Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/MetaDB.java", "diffHunk": "@@ -81,38 +81,49 @@ private static SQLiteDatabase upgradeDB(SQLiteDatabase mMetaDb, int databaseVers\n         // Create tables if not exist\n         mMetaDb.execSQL(\"CREATE TABLE IF NOT EXISTS languages (\" + \" _id INTEGER PRIMARY KEY AUTOINCREMENT, \"\n                 + \"did INTEGER NOT NULL, ord INTEGER, \" + \"qa INTEGER, \" + \"language TEXT)\");\n-        mMetaDb.execSQL(\"CREATE TABLE IF NOT EXISTS whiteboardState (\" + \"_id INTEGER PRIMARY KEY AUTOINCREMENT, \"\n-                + \"did INTEGER NOT NULL, \" + \"state INTEGER)\");\n         mMetaDb.execSQL(\"CREATE TABLE IF NOT EXISTS customDictionary (\" + \"_id INTEGER PRIMARY KEY AUTOINCREMENT, \"\n                 + \"did INTEGER NOT NULL, \" + \"dictionary INTEGER)\");\n         mMetaDb.execSQL(\"CREATE TABLE IF NOT EXISTS smallWidgetStatus (\" + \"id INTEGER PRIMARY KEY AUTOINCREMENT, \"\n                 + \"due INTEGER NOT NULL, eta INTEGER NOT NULL)\");\n-        // Use pragma to get info about widgetStatus.\n-        Cursor c = null;\n-        try {\n-             c = mMetaDb.rawQuery(\"PRAGMA table_info(widgetStatus)\", null);\n-            int columnNumber = c.getCount();\n-            if (columnNumber > 0) {\n-                if (columnNumber < 7) {\n-                    mMetaDb.execSQL(\"ALTER TABLE widgetStatus \" + \"ADD COLUMN eta INTEGER NOT NULL DEFAULT '0'\");\n-                    mMetaDb.execSQL(\"ALTER TABLE widgetStatus \" + \"ADD COLUMN time INTEGER NOT NULL DEFAULT '0'\");\n-                }\n-            } else {\n-                mMetaDb.execSQL(\"CREATE TABLE IF NOT EXISTS widgetStatus (\" + \"deckId INTEGER NOT NULL PRIMARY KEY, \"\n-                        + \"deckName TEXT NOT NULL, \" + \"newCards INTEGER NOT NULL, \" + \"lrnCards INTEGER NOT NULL, \"\n-                        + \"dueCards INTEGER NOT NULL, \" + \"progress INTEGER NOT NULL, \" + \"eta INTEGER NOT NULL)\");\n-            }\n-            mMetaDb.setVersion(databaseVersion);\n-            Timber.i(\"MetaDB:: Upgrading Internal Database finished. New version: %d\", databaseVersion);\n-            return mMetaDb;\n-        } finally {\n-            if (c != null) {\n-                c.close();\n-            }\n+        updateWidgetStatus(mMetaDb);\n+        updateWhiteboardState(mMetaDb);\n+        mMetaDb.setVersion(databaseVersion);\n+        Timber.i(\"MetaDB:: Upgrading Internal Database finished. New version: %d\", databaseVersion);\n+        return mMetaDb;\n+    }\n+\n+\n+    private static void updateWhiteboardState(SQLiteDatabase mMetaDb) {\n+        int columnCount  = DatabaseUtil.getTableColumnCount(mMetaDb, \"whiteboardState\");\n+\n+        if(columnCount <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "408cd9bc413aee931698109b98f0b2098dbaa91b"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA1MjA4OQ==", "bodyText": "I believe this onCollectionLoaded callback is async yes? (I should know offhand but always have to re-trace this stuff and I'm reviewing quickly at the moment) I believe it is - if this is on the main/UI thread it could be a pain for folks, we try not to touch storage ever on the main/UI thread, thus all the AsyncTask infrastructure", "url": "https://github.com/ankidroid/Anki-Android/pull/5834#discussion_r395052089", "createdAt": "2020-03-19T14:08:23Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -169,8 +169,10 @@ protected void onCollectionLoaded(Collection col) {\n \n         mPrefWhiteboard = MetaDB.getWhiteboardState(this, getParentDid());\n         if (mPrefWhiteboard) {\n+            //DEFECT: Slight inefficiency here, as we set the database using these methods", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "408cd9bc413aee931698109b98f0b2098dbaa91b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37c8c62b520265c5d28c93c02d432af1e36ce326", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/37c8c62b520265c5d28c93c02d432af1e36ce326", "committedDate": "2020-03-22T12:50:46Z", "message": "Extract: getTableColumnCount"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12f6cedbc9aad1550b2f47fb848dfa41ea12b2a0", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/12f6cedbc9aad1550b2f47fb848dfa41ea12b2a0", "committedDate": "2020-03-22T12:51:47Z", "message": "Extract: getScalarBoolean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7386636ce00a8ab4d7fb4cff652a0b4da980209", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d7386636ce00a8ab4d7fb4cff652a0b4da980209", "committedDate": "2020-03-22T12:53:15Z", "message": "Extract: updateWidgetStatus"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4442e4293f4818e0b3366aeabe2e1d73d400af4b", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4442e4293f4818e0b3366aeabe2e1d73d400af4b", "committedDate": "2020-03-22T12:58:06Z", "message": "#5065 - Persist Whiteboard Visible State\n\nPreviously, the whiteboard visible state depended on the enabled state\n\nThis caused problems when switching from Night Mode.\n\nNow, the preferences are separate, with visible depending on the status\nof enabled."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "be9aca813e256f945d8936ab5580784d9a1f2b34", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/be9aca813e256f945d8936ab5580784d9a1f2b34", "committedDate": "2020-03-19T14:23:22Z", "message": "NF: Fix spacing\n\nCo-Authored-By: Mike Hardy <github@mikehardy.net>"}, "afterCommit": {"oid": "4442e4293f4818e0b3366aeabe2e1d73d400af4b", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4442e4293f4818e0b3366aeabe2e1d73d400af4b", "committedDate": "2020-03-22T12:58:06Z", "message": "#5065 - Persist Whiteboard Visible State\n\nPreviously, the whiteboard visible state depended on the enabled state\n\nThis caused problems when switching from Night Mode.\n\nNow, the preferences are separate, with visible depending on the status\nof enabled."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MDIxMDYw", "url": "https://github.com/ankidroid/Anki-Android/pull/5834#pullrequestreview-379021060", "createdAt": "2020-03-22T16:15:51Z", "commit": {"oid": "4442e4293f4818e0b3366aeabe2e1d73d400af4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3525, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}