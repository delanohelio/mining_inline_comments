{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NzY0MjAw", "number": 5941, "title": "Remove Ability to \"Change Deck\" to Dynamic Deck", "bodyText": "Request\nCould you ask me to rebase this if this isn't going to be squashed. The final commit is a regression fix introduced in the first commit, it's a bit of effort to fix due to an incorrect unit test based of the assumption in the middle, which isn't worth fixing it if we'll squash-merge this.\nPurpose / Description\nYou can't move cards to a filtered deck via \"Change Deck\" in Anki Desktop, we do the same in AnkiDroid\nFixes\nPartially: #5932. Needs a PR for a check database to close this off.\nApproach\nRemoves filtered decks from the \"change deck\" screen, and blocks any internal attempts to change them\nHow Has This Been Tested?\nUnit tests, I can still move decks on my phone, but the filtered decks no longer exist.\nTested on my Android, missed a regression and fixed a test to handle it, now works as normal.\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-04-06T16:33:07Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5941", "merged": true, "mergeCommit": {"oid": "dc318301ead5f793b171af1e135d95361232ac6a"}, "closed": true, "closedAt": "2020-04-06T20:24:14Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUwy2QgH2gAyMzk5NzY0MjAwOjdjNWRiMTVjMWY1ZDk0MDgxNTIyNmFkYWZkZmRjNzlkNzk0ZjU0YTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVEnzJgFqTM4ODU4NzQzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c5db15c1f5d940815226adafdfdc79d794f54a9", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7c5db15c1f5d940815226adafdfdc79d794f54a9", "committedDate": "2020-04-05T21:15:33Z", "message": "NF: Extract getValidDecksForChangeDeck()\n\nWe want to target this function for change and it's the best abstraction\nto take without large code changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e8b9ab6142d5670061780215b9a4b73ab2ef14e", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7e8b9ab6142d5670061780215b9a4b73ab2ef14e", "committedDate": "2020-04-06T08:54:20Z", "message": "Disable selecting dynamic decks in \"Change Deck\"\n\nJust contains the UI logic fix, Anki Desktop doesn't support the\noperation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6f7965224e8bd57dd4f1bb641c4ca00179f7616", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b6f7965224e8bd57dd4f1bb641c4ca00179f7616", "committedDate": "2020-04-06T09:51:15Z", "message": "Add check to block transfer to dynamic deck\n\nAnki Desktop does not allow this. We already block it in the UI, but add\nan additional check in-case there's a race condition in the UI logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82c2b50d9d9ba49b9d6270730d61aeffc666ab65", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/82c2b50d9d9ba49b9d6270730d61aeffc666ab65", "committedDate": "2020-04-06T10:53:58Z", "message": "NF: Add attributes to Decks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ec091290fed3c6948ccc63b2eee2b721546814", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d7ec091290fed3c6948ccc63b2eee2b721546814", "committedDate": "2020-04-06T11:19:35Z", "message": "Add failure to transfer deck task\n\nThis ensures that the task can't be provided with an invalid deckId\n\nWe fix two bugs:\n\n* A Dynamic Deck is supplied\n* A Deck which doesn't exist is supplied (moving the cards to the\ndefault)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acbe97b86e07c8137b793e8270dec760d585f72b", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/acbe97b86e07c8137b793e8270dec760d585f72b", "committedDate": "2020-04-06T16:27:12Z", "message": "Fix regression in CardBrowser selection\n\nWe now use getValidDecksForChangeDeck to display the items, so we need\nthis to correctly map from the index back to the selected deck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "680b7128d43c5df2953ad62e91de2a86fba8d2c4", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/680b7128d43c5df2953ad62e91de2a86fba8d2c4", "committedDate": "2020-04-06T16:36:50Z", "message": "NF: Codacy Scoping Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDI2ODA2", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#pullrequestreview-388426806", "createdAt": "2020-04-06T16:38:42Z", "commit": {"oid": "680b7128d43c5df2953ad62e91de2a86fba8d2c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjozODo0M1rOGBgZwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjozODo0M1rOGBgZwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzMjY0Mg==", "bodyText": "getDecks().get() returns did:1 if unsuccessful.", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#discussion_r404232642", "createdAt": "2020-04-06T16:38:43Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/DeckTask.java", "diffHunk": "@@ -737,6 +737,28 @@ private TaskData doInBackgroundDismissNotes(TaskData... params) {\n \n                     case CHANGE_DECK_MULTI: {\n                         long newDid = (long) data[2];\n+\n+                        Timber.i(\"Changing %d cards to deck: '%d'\", cards.length, newDid);\n+                        JSONObject deckData = col.getDecks().get(newDid);\n+\n+                        if (Decks.isDynamic(deckData)) {\n+                            //#5932 - can't change to a dynamic deck. Use \"Rebuild\"\n+                            Timber.w(\"Attempted to move to dynamic deck. Cancelling task.\");\n+                            return new TaskData(false);\n+                        }\n+\n+                        //Confirm that the deck exists (and is not the default)\n+                        try {\n+                            long actualId = deckData.getLong(\"id\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "680b7128d43c5df2953ad62e91de2a86fba8d2c4"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDI3Mzgx", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#pullrequestreview-388427381", "createdAt": "2020-04-06T16:39:23Z", "commit": {"oid": "680b7128d43c5df2953ad62e91de2a86fba8d2c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjozOToyNFrOGBgbuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjozOToyNFrOGBgbuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzMzE0NQ==", "bodyText": "I know streams whenever we reach a new API level, is there anything now?", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#discussion_r404233145", "createdAt": "2020-04-06T16:39:24Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/anki/CardBrowserTest.java", "diffHunk": "@@ -159,6 +273,15 @@ private void selectMenuItem(CardBrowser browser, int action_select_all) {\n         shadowActivity.clickMenuItem(action_select_all);\n     }\n \n+    //There has to be a better way :(\n+    private long[] toLongArray(List<Long> list){\n+        long[] ret = new long[list.size()];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "680b7128d43c5df2953ad62e91de2a86fba8d2c4"}, "originalPosition": 149}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTMzMjg4", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#pullrequestreview-388533288", "createdAt": "2020-04-06T19:00:24Z", "commit": {"oid": "7e8b9ab6142d5670061780215b9a4b73ab2ef14e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTowMDoyNFrOGBltBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTowMDoyNFrOGBltBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxOTQ5Mw==", "bodyText": "I'm just reviewing as I go through the commits in series so this may be addressed later but writing it while I think it: this is the exact assumption that bit us somewhere else but you worked on it directly so you might remember better. There were two different tests for a deck and whether it was dynamic right? And the previous problem was that they were used in different spots and (incorrectly I think) they returned different answers sometimes. Centralizing this and making sure everyone is using the same test and everything still works should be a side quest I think", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#discussion_r404319493", "createdAt": "2020-04-06T19:00:24Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -1053,4 +1053,8 @@ public boolean hasDeckOptions(long deckId) throws NoSuchDeckException {\n     public void removeDeckOptions(long deckId) throws NoSuchDeckException {\n         getDeckOrFail(deckId).remove(\"conf\");\n     }\n+\n+    public static boolean isDynamic(JSONObject deck) {\n+        return deck.getInt(\"dyn\") != 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e8b9ab6142d5670061780215b9a4b73ab2ef14e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTg3NDMy", "url": "https://github.com/ankidroid/Anki-Android/pull/5941#pullrequestreview-388587432", "createdAt": "2020-04-06T20:21:35Z", "commit": {"oid": "680b7128d43c5df2953ad62e91de2a86fba8d2c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3593, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}