{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1NjM4NDM0", "number": 6140, "title": "Allow import of files with long Unicode Names", "bodyText": "Purpose / Description\nWe URLEncode filenames, and CJK characters are 9x the size when this happens. This allows them to easily blow up when imported with \"File path too long\"\nFixes\nFixes #6137\nApproach\nTruncate the filename before import. We do this at the end, not at the middle.\nHow Has This Been Tested?\nUnit tests, I can now import \u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d\u597d.apkg\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-05-09T22:22:32Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6140", "merged": true, "mergeCommit": {"oid": "84530f9d2e949957e1d908664a5ccd093a04bf4a"}, "closed": true, "closedAt": "2020-05-10T21:14:03Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfrl7mgH2gAyNDE1NjM4NDM0OjQ5M2Y3YTFkY2Q3ZmNiNTM3ZmVhMjNhZDc0YTc3ZWEwMzcxN2I4ZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcf-NtCgBqjMzMjA1MDc0NzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "493f7a1dcd7fcb537fea23ad74a77ea03717b8f5", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/493f7a1dcd7fcb537fea23ad74a77ea03717b8f5", "committedDate": "2020-05-09T19:25:05Z", "message": "NF: Make ImportUtils testable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Njk5NTcx", "url": "https://github.com/ankidroid/Anki-Android/pull/6140#pullrequestreview-408699571", "createdAt": "2020-05-10T02:42:50Z", "commit": {"oid": "eb94bcd8fd576375dc28c675af2aa3ab8993ccf1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjo0Mjo1MFrOGS_61w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQwMjo0Mzo0M1rOGS_7Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NDgwNw==", "bodyText": "nit: Timber.d(\"\") ?", "url": "https://github.com/ankidroid/Anki-Android/pull/6140#discussion_r422574807", "createdAt": "2020-05-10T02:42:50Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java", "diffHunk": "@@ -150,6 +158,36 @@ private String handleContentProviderFile(Context context, Intent intent, Uri dat\n             return errorMessage;\n         }\n \n+\n+        private String ensureValidLength(String fileName) {\n+            //#6137 - filenames can be too long when URLEncoded\n+            try {\n+                String encoded = URLEncoder.encode(fileName, \"UTF-8\");\n+\n+                if (encoded.length() <= fileNameShorteningThreshold) {\n+                    Timber.d(\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb94bcd8fd576375dc28c675af2aa3ab8993ccf1"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjU3NDg2Mw==", "bodyText": "I think 90 should be fileNameShorteningThreshold - 10 otherwise the numbers are very magic, the 10 for extension adjustment is still a little magic but at least it would be an adjustment off the constant", "url": "https://github.com/ankidroid/Anki-Android/pull/6140#discussion_r422574863", "createdAt": "2020-05-10T02:43:43Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java", "diffHunk": "@@ -150,6 +158,36 @@ private String handleContentProviderFile(Context context, Intent intent, Uri dat\n             return errorMessage;\n         }\n \n+\n+        private String ensureValidLength(String fileName) {\n+            //#6137 - filenames can be too long when URLEncoded\n+            try {\n+                String encoded = URLEncoder.encode(fileName, \"UTF-8\");\n+\n+                if (encoded.length() <= fileNameShorteningThreshold) {\n+                    Timber.d(\"\");\n+                    return fileName;\n+                } else {\n+                    Timber.d(\"Filename was longer than %d, shortening\", fileNameShorteningThreshold);\n+                    //take 90 instead of 100 so we don't get the extension\n+                    String shortenedFileName = encoded.substring(0, 90) + \"...\" + getExtension(fileName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb94bcd8fd576375dc28c675af2aa3ab8993ccf1"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb94bcd8fd576375dc28c675af2aa3ab8993ccf1", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/eb94bcd8fd576375dc28c675af2aa3ab8993ccf1", "committedDate": "2020-05-09T21:59:29Z", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\""}, "afterCommit": {"oid": "79e1613516f4918b1324cef7fd5bb5309044a414", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/79e1613516f4918b1324cef7fd5bb5309044a414", "committedDate": "2020-05-10T02:53:51Z", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Njk5OTkx", "url": "https://github.com/ankidroid/Anki-Android/pull/6140#pullrequestreview-408699991", "createdAt": "2020-05-10T02:55:52Z", "commit": {"oid": "79e1613516f4918b1324cef7fd5bb5309044a414"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79e1613516f4918b1324cef7fd5bb5309044a414", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/79e1613516f4918b1324cef7fd5bb5309044a414", "committedDate": "2020-05-10T02:53:51Z", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\""}, "afterCommit": {"oid": "35857a917f5ea84726d3a8789b9416ed34a12ddd", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/35857a917f5ea84726d3a8789b9416ed34a12ddd", "committedDate": "2020-05-10T11:01:01Z", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\""}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35857a917f5ea84726d3a8789b9416ed34a12ddd", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/35857a917f5ea84726d3a8789b9416ed34a12ddd", "committedDate": "2020-05-10T11:01:01Z", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\""}, "afterCommit": {"oid": "b56d7a0e122097149d53087a3028f02e26f276b1", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b56d7a0e122097149d53087a3028f02e26f276b1", "committedDate": "2020-05-10T13:33:11Z", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39d7d5497d7b792fa0ef3fbadd74515970f20b72", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/39d7d5497d7b792fa0ef3fbadd74515970f20b72", "committedDate": "2020-05-10T17:05:35Z", "message": "NF: ImportUtils - Add Regression Test\n\nAlso requires that DialogHandler is reset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cbbba9155d6fe5cd6dd0a4cb4c1b3791bba2899", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0cbbba9155d6fe5cd6dd0a4cb4c1b3791bba2899", "committedDate": "2020-05-10T17:05:38Z", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\""}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b56d7a0e122097149d53087a3028f02e26f276b1", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b56d7a0e122097149d53087a3028f02e26f276b1", "committedDate": "2020-05-10T13:33:11Z", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\""}, "afterCommit": {"oid": "0cbbba9155d6fe5cd6dd0a4cb4c1b3791bba2899", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0cbbba9155d6fe5cd6dd0a4cb4c1b3791bba2899", "committedDate": "2020-05-10T17:05:38Z", "message": "File import: Shorten Filenames to 100 characters\n\nWe URLEncode filenames, and CJK characters are 9x the size when this\nhappens.\n\nNow, we truncate any filenames which would be too long after this.\n\nThis ensures that we avoid \"FileSystemException: File name too long\""}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3504, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}