{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMzU4MjY3", "number": 6004, "title": "Use AnkiWeb Dynamic Sync Url", "bodyText": "ankitects/anki@ae46bfa#diff-be58d55ab11f38bc77a9e44496f1d2a8\n\nReview Goals\n\nIf the hostNum is corrupt, the user can't sync, and we don't currently provide a means to wipe it. How should we handle this?\nA malicious sync server likely can silently rewrite the sync url as we're performing String.format on user-provided data going into the URL.\n\nPurpose / Description\nThis is only for AnkiWeb, we still do not support this for custom sync servers.\nThis is for a few reasons:\n\nDebate over whether to keep a separate media sync URL, or do Anki did in the linked commit.\nChanging servers - when to reset the hostNum? Much more likely to get into a situation where we have an invalid hostNum and no way to fix it.\n\nFixes\nFixes #4921\nApproach\nCareful refactorings and unit tests. Once we remove the uses of SYNC_BASE to 1, we add in a format string and convert.\nHow Has This Been Tested?\nHeavily unit tested.\nSync still works on my device.\nLearning (optional, can help others)\nSee discussions in linked issue.\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-04-14T18:58:09Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6004", "merged": true, "mergeCommit": {"oid": "8ada79b2698092c6f53bcba66e835e696b8d8e05"}, "closed": true, "closedAt": "2020-04-16T02:14:33Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXoRR4gFqTM5MzIxMTg0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX93gxgFqTM5NDA5OTU0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjExODQw", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#pullrequestreview-393211840", "createdAt": "2020-04-14T19:01:24Z", "commit": {"oid": "f661460a79085e6b1b2b8ade3dc3f67627ff36ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTowMToyNFrOGFcu3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTowMToyNFrOGFcu3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM2NjgxNQ==", "bodyText": "Worth discussing whether we should skip the cache and hit preferences on each get()", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r408366815", "createdAt": "2020-04-14T19:01:24Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/web/PreferenceBackedHostNum.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.ichi2.anki.web;\n+\n+import android.content.SharedPreferences;\n+\n+import com.ichi2.libanki.Consts;\n+import com.ichi2.libanki.sync.HostNum;\n+\n+import timber.log.Timber;\n+\n+public class PreferenceBackedHostNum extends HostNum {\n+\n+    private final SharedPreferences mPreferences;\n+    private String mHostNum;\n+\n+    public PreferenceBackedHostNum(String hostNum, SharedPreferences preferences) {\n+        super();\n+        this.mHostNum = hostNum;\n+        this.mPreferences = preferences;\n+    }\n+\n+\n+    public static PreferenceBackedHostNum fromPreferences(SharedPreferences preferences) {\n+        String hostNum = preferences.getString(\"hostNum\", null);\n+        if (hostNum == null) {\n+            return new PreferenceBackedHostNum(Consts.DEFAULT_HOST_NUM, preferences);\n+        }\n+        return new PreferenceBackedHostNum(hostNum, preferences);\n+    }\n+\n+    @Override\n+    public String getHostNum() {\n+        return mHostNum;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f661460a79085e6b1b2b8ade3dc3f67627ff36ab"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMzIxNjQz", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#pullrequestreview-393321643", "createdAt": "2020-04-14T21:51:04Z", "commit": {"oid": "1e308055c9500de5a13f599c7a4b3378f92afc5c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMTo1MTowNFrOGFiRlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMjo0MjoxNFrOGFjiBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ1NzYyMg==", "bodyText": "In the context of this commit at least (I'm reviewing commit by commit) having an abstract class here just to wrap a String, when it's used as a String everywhere else, doesn't seem to add value. Perhaps I will be enlightened in the rest of the commits though...", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r408457622", "createdAt": "2020-04-14T21:51:04Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sync/HostNum.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package com.ichi2.libanki.sync;\n+\n+/** Not part of libAnki directly, but abstracts out Preferences to a libAnki context */\n+public abstract class HostNum {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e308055c9500de5a13f599c7a4b3378f92afc5c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NjY2Mw==", "bodyText": "Ah, now I'm enlightened. Here's an idea though - instead of an abstract and two concretes, why not one concrete, then the Test one just extends the concrete and overrides what you need? I did that a lot in my CardTemplateEditor odyssey and it worked fine while keeping the \"main code line\" (non test code) easier to understand with a flat (entity count == 1) hierarchy for simple objects", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r408476663", "createdAt": "2020-04-14T22:38:02Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/web/PreferenceBackedHostNum.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.ichi2.anki.web;\n+\n+import android.content.SharedPreferences;\n+\n+import com.ichi2.libanki.Consts;\n+import com.ichi2.libanki.sync.HostNum;\n+\n+import timber.log.Timber;\n+\n+public class PreferenceBackedHostNum extends HostNum {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f661460a79085e6b1b2b8ade3dc3f67627ff36ab"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NzE2NQ==", "bodyText": "SharedPreferences is a cache if I understand correctly?", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r408477165", "createdAt": "2020-04-14T22:39:18Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/web/PreferenceBackedHostNum.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package com.ichi2.anki.web;\n+\n+import android.content.SharedPreferences;\n+\n+import com.ichi2.libanki.Consts;\n+import com.ichi2.libanki.sync.HostNum;\n+\n+import timber.log.Timber;\n+\n+public class PreferenceBackedHostNum extends HostNum {\n+\n+    private final SharedPreferences mPreferences;\n+    private String mHostNum;\n+\n+    public PreferenceBackedHostNum(String hostNum, SharedPreferences preferences) {\n+        super();\n+        this.mHostNum = hostNum;\n+        this.mPreferences = preferences;\n+    }\n+\n+\n+    public static PreferenceBackedHostNum fromPreferences(SharedPreferences preferences) {\n+        String hostNum = preferences.getString(\"hostNum\", null);\n+        if (hostNum == null) {\n+            return new PreferenceBackedHostNum(Consts.DEFAULT_HOST_NUM, preferences);\n+        }\n+        return new PreferenceBackedHostNum(hostNum, preferences);\n+    }\n+\n+    @Override\n+    public String getHostNum() {\n+        return mHostNum;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM2NjgxNQ=="}, "originalCommit": {"oid": "f661460a79085e6b1b2b8ade3dc3f67627ff36ab"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3ODIxMg==", "bodyText": "if it's mildly unexpected but fine to continue without, should be Timber.w I think. Unimportant in the grand scheme, but just want to either have a good debate on or harmonize on log levels. I consider 'e' to be things where you need to bomb out of an activity entirely, almost completely unrecoverable but not quite a crash.", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r408478212", "createdAt": "2020-04-14T22:42:14Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sync/Syncer.java", "diffHunk": "@@ -249,6 +250,18 @@ public Syncer(Collection col, HttpSyncer server) {\n         return new Object[] { \"success\" };\n     }\n \n+\n+    private void trySetHostNum(JSONObject rMeta) {\n+        //We perform this as old version of the sync server may not provide the hostNum\n+        //And it's fine to continue without one.\n+        try {\n+            mHostNum.setHostNum(rMeta.getString(\"hostNum\"));\n+        } catch (Exception e) {\n+            Timber.e(e, \"Failed to set hostNum\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f661460a79085e6b1b2b8ade3dc3f67627ff36ab"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f661460a79085e6b1b2b8ade3dc3f67627ff36ab", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f661460a79085e6b1b2b8ade3dc3f67627ff36ab", "committedDate": "2020-04-14T18:57:05Z", "message": "Read HostNum from AnkiWeb into Preferences and use\n\nFixes #4921\n\nBrings the HostNum class into the inheritance hierarchy to allow it to\nbe modified while the sync process is ongoing.\n\nAlso provides the reference to Syncer to allow it to persist the data\nwhen loaded from /meta/."}, "afterCommit": {"oid": "b09cdce9791c0b589be58d19777d5e7295c48578", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b09cdce9791c0b589be58d19777d5e7295c48578", "committedDate": "2020-04-14T23:32:31Z", "message": "Read HostNum from AnkiWeb into Preferences and use\n\nFixes #4921\n\nBrings the HostNum class into the inheritance hierarchy to allow it to\nbe modified while the sync process is ongoing.\n\nAlso provides the reference to Syncer to allow it to persist the data\nwhen loaded from /meta/."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f46d2570a042382e1839971e54284ebda76b47b5", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f46d2570a042382e1839971e54284ebda76b47b5", "committedDate": "2020-04-15T15:15:30Z", "message": "Add hostNum from preferences if set\n\nUnused, but handle the threading of the variable into the sync code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24d40f80828a2397d56a3b8fbcfa48a6d4e13661", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/24d40f80828a2397d56a3b8fbcfa48a6d4e13661", "committedDate": "2020-04-15T15:15:34Z", "message": "Add unit tests for current code\n\nAnd ignored tests for hostNum changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ee5dc370b0067c59aacbc526ca0d4cb7e17c970", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3ee5dc370b0067c59aacbc526ca0d4cb7e17c970", "committedDate": "2020-04-15T15:15:34Z", "message": "NF: Extract getUrlPrefix()\n\nAnki removed SYNC_MEDIA_BASE, we work towards this"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7edd570a5f69f679f1930c90b75f4afc28906676", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7edd570a5f69f679f1930c90b75f4afc28906676", "committedDate": "2020-04-15T15:15:34Z", "message": "NF: Extract isUsingCustomSyncServer()\n\nRefactoring for code clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d373194a9e21ee5c837911428314c6b8feba8bc7", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d373194a9e21ee5c837911428314c6b8feba8bc7", "committedDate": "2020-04-15T15:15:34Z", "message": "Add more tests before changes\n\nRegarding the value if one preference is found and the other fails."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ace2aca25d58d77f8be4f2d9f656e4e4ce800af3", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ace2aca25d58d77f8be4f2d9f656e4e4ce800af3", "committedDate": "2020-04-15T15:15:35Z", "message": "NF: Extract getDefaultAnkiWebUrl()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "419119928976172901609064a825b030118a7637", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/419119928976172901609064a825b030118a7637", "committedDate": "2020-04-15T15:15:35Z", "message": "Remove SYNC_MEDIA_BASE and fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad6b66c9a81b7bd61500cdd0a0198cfdbbda877b", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ad6b66c9a81b7bd61500cdd0a0198cfdbbda877b", "committedDate": "2020-04-15T15:15:35Z", "message": "NF: Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3978ff2c6226e5f9fce5993935f402c7f321701", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c3978ff2c6226e5f9fce5993935f402c7f321701", "committedDate": "2020-04-15T15:15:35Z", "message": "Removed identical FullSyncer method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc2060f519a95715d1e1dbb3927ffdd387bd8751", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/dc2060f519a95715d1e1dbb3927ffdd387bd8751", "committedDate": "2020-04-15T15:15:36Z", "message": "Use HostNum for Load Balancing\n\nWe don't set the variable yet, but we move to a point where we can set\nit and it will be handled correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2548489b47e2c06cd9baf29ff225f4e976fcf126", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2548489b47e2c06cd9baf29ff225f4e976fcf126", "committedDate": "2020-04-15T15:16:27Z", "message": "Read HostNum from AnkiWeb into Preferences and use\n\nFixes #4921\n\nBrings the HostNum class into the inheritance hierarchy to allow it to\nbe modified while the sync process is ongoing.\n\nAlso provides the reference to Syncer to allow it to persist the data\nwhen loaded from /meta/."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35d5a4d3d3f1a94f1e28c69690b7730e1bdc6a1b", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/35d5a4d3d3f1a94f1e28c69690b7730e1bdc6a1b", "committedDate": "2020-04-15T15:16:30Z", "message": "Remove LEGACY_SYNC_BASE\n\nConfirmed with Damien that methods were unused:\n\n> Those two endpoints look like they could be removed.\n> Upgrade was an old endpoint that upgraded Anki 1.x collections,\n> and users need to sign up for an account in a webview these days.\n\nhttps://github.com/ankidroid/Anki-Android/issues/4921\n#issuecomment-613729490"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e264daf84be7133b515275255628fb961c302a3e", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e264daf84be7133b515275255628fb961c302a3e", "committedDate": "2020-04-15T15:16:31Z", "message": "NF: Extract prefs to CustomSyncServer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5103b7512af367b8a1b2e07c54bda69fbab7aae1", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5103b7512af367b8a1b2e07c54bda69fbab7aae1", "committedDate": "2020-04-15T15:16:31Z", "message": "Remove HostNum on logoff or sync server change\n\nThe hostnum is only valid for the account, on these changes, the\npreference is no longer valid and should be unset."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5f1539fe2903f9997c7171c659d86b98fed4626", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a5f1539fe2903f9997c7171c659d86b98fed4626", "committedDate": "2020-04-15T16:26:17Z", "message": "Convert HostNum to Integer\n\nReview Discussion - AnkiWeb guarantees that the HostNum is an integer\nand allowing a string means we can get URL injection."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc9f9dbaf2c7831565f16c099b5c97b7df7fcf5e", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/dc9f9dbaf2c7831565f16c099b5c97b7df7fcf5e", "committedDate": "2020-04-15T15:05:32Z", "message": "Remove HostNum on logoff or sync server change\n\nThe hostnum is only valid for the account, on these changes, the\npreference is no longer valid and should be unset."}, "afterCommit": {"oid": "d2b3cdd27c4ebf36c3dca198df5f29c95a7ef7fd", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d2b3cdd27c4ebf36c3dca198df5f29c95a7ef7fd", "committedDate": "2020-04-15T16:28:37Z", "message": "NF: HostNum - Reduce coupling to Preferences\n\nVia factory class\n\nEnsures that we keep code modifications to the hostNum consistent."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9ef22b685de2acb6ddd82b831447e80801f5629", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a9ef22b685de2acb6ddd82b831447e80801f5629", "committedDate": "2020-04-15T16:42:12Z", "message": "NF: HostNum - Reduce coupling to Preferences\n\nVia factory class\n\nEnsures that we keep code modifications to the hostNum consistent."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2b3cdd27c4ebf36c3dca198df5f29c95a7ef7fd", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d2b3cdd27c4ebf36c3dca198df5f29c95a7ef7fd", "committedDate": "2020-04-15T16:28:37Z", "message": "NF: HostNum - Reduce coupling to Preferences\n\nVia factory class\n\nEnsures that we keep code modifications to the hostNum consistent."}, "afterCommit": {"oid": "a9ef22b685de2acb6ddd82b831447e80801f5629", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a9ef22b685de2acb6ddd82b831447e80801f5629", "committedDate": "2020-04-15T16:42:12Z", "message": "NF: HostNum - Reduce coupling to Preferences\n\nVia factory class\n\nEnsures that we keep code modifications to the hostNum consistent."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDMyMzM1", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#pullrequestreview-394032335", "createdAt": "2020-04-15T18:33:34Z", "commit": {"oid": "a9ef22b685de2acb6ddd82b831447e80801f5629"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxODozMzozNFrOGGGdIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxODo0OToyOFrOGGHCFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1MDQwMQ==", "bodyText": "For all your new classes you're missing the copyright header, can you copy/splat one in, change it to your preferred ankidroid email, then copy/splat that in to the rest of the new files?", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r409050401", "createdAt": "2020-04-15T18:33:34Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/web/CustomSyncServer.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package com.ichi2.anki.web;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9ef22b685de2acb6ddd82b831447e80801f5629"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1MzU0OA==", "bodyText": "Can you add all the rules here? It is always an integer, it should be reset wiped under xyz conditions? It's not documented anywhere else and this seems like the place to set out the full set of biz reqs", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r409053548", "createdAt": "2020-04-15T18:38:40Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sync/HostNum.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.ichi2.libanki.sync;\n+\n+import com.ichi2.libanki.Consts;\n+\n+/**\n+ * The server provides hostNum in the /sync/meta call. All requests after that (including future meta requests)\n+ * should use that hostNum to construct the sync URL, until a future /sync/meta call advises otherwise.\n+ *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9ef22b685de2acb6ddd82b831447e80801f5629"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1NzIyOQ==", "bodyText": "Just out of curiosity since you just up on SharedPreferences, why commit here vs apply? I scanned back and saw you used apply (correctly, I believe) in PreferenceBackedHostNum, and I think apply would be fine here as well. For the same reasons commit is typically unnecessary and may slow things down, I think it may be unnecessary and just slow testing down here, but perhaps I'm about to learn something about SharedPreferences, or I read it wrong", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r409057229", "createdAt": "2020-04-15T18:44:55Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sync/HttpSyncerTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.ichi2.libanki.sync;\n+\n+import android.content.SharedPreferences;\n+\n+import com.ichi2.anki.AnkiDroidApp;\n+\n+import org.junit.Ignore;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import androidx.annotation.NonNull;\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class HttpSyncerTest {\n+    private static String sCustomServerWithNoFormatting = \"https://sync.example.com/\";\n+    private static String sCustomServerWithFormatting   = \"https://sync%s.example.com/\";\n+    private static final String sDefaultUrlNoHostNum    = \"https://sync.ankiweb.net/sync/\";\n+    private static final String sDefaultUrlWithHostNum  = \"https://sync1.ankiweb.net/sync/\";\n+\n+\n+    @Test\n+    public void getDefaultMediaUrlWithNoHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(null);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(sDefaultUrlNoHostNum));\n+    }\n+\n+\n+    @Test\n+    public void getDefaultMediaUrlWithHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(1);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(sDefaultUrlWithHostNum));\n+    }\n+\n+\n+    @Test\n+    @Ignore(\"Not yet supported\")\n+    public void getCustomMediaUrlWithNoHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(null);\n+        setCustomServer(sCustomServerWithFormatting);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(\"https://sync.example.com/sync/\"));\n+    }\n+\n+\n+    @Test\n+    @Ignore(\"Not yet supported\")\n+    public void getCustomMediaUrlWithHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(1);\n+        setCustomServer(sCustomServerWithFormatting);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(\"https://sync1.example.com/sync/\"));\n+    }\n+\n+    @Test\n+    public void getUnformattedCustomMediaUrlWithHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(null);\n+        setCustomServer(sCustomServerWithNoFormatting);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(\"https://sync.example.com/sync/\"));\n+    }\n+\n+    @Test\n+    public void getUnformattedCustomMediaUrlWithNoHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(1);\n+        setCustomServer(sCustomServerWithNoFormatting);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(\"https://sync.example.com/sync/\"));\n+    }\n+\n+    @Test\n+    public void invalidSettingReturnsCorrectResultWithNoHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(null);\n+        setCustomServerWithNoUrl();\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(sDefaultUrlNoHostNum));\n+    }\n+\n+    @Test\n+    public void invalidSettingReturnsCorrectResultWithHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(1);\n+        setCustomServerWithNoUrl();\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(sDefaultUrlWithHostNum));\n+    }\n+\n+    private void setCustomServerWithNoUrl() {\n+        SharedPreferences userPreferences = AnkiDroidApp.getSharedPrefs(AnkiDroidApp.getInstance());\n+        userPreferences.edit().putBoolean(\"useCustomSyncServer\", true).commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9ef22b685de2acb6ddd82b831447e80801f5629"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1NzM3Ng==", "bodyText": "same commit vs apply question here, one answer answers both", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r409057376", "createdAt": "2020-04-15T18:45:09Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/test/java/com/ichi2/libanki/sync/HttpSyncerTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.ichi2.libanki.sync;\n+\n+import android.content.SharedPreferences;\n+\n+import com.ichi2.anki.AnkiDroidApp;\n+\n+import org.junit.Ignore;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import androidx.annotation.NonNull;\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class HttpSyncerTest {\n+    private static String sCustomServerWithNoFormatting = \"https://sync.example.com/\";\n+    private static String sCustomServerWithFormatting   = \"https://sync%s.example.com/\";\n+    private static final String sDefaultUrlNoHostNum    = \"https://sync.ankiweb.net/sync/\";\n+    private static final String sDefaultUrlWithHostNum  = \"https://sync1.ankiweb.net/sync/\";\n+\n+\n+    @Test\n+    public void getDefaultMediaUrlWithNoHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(null);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(sDefaultUrlNoHostNum));\n+    }\n+\n+\n+    @Test\n+    public void getDefaultMediaUrlWithHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(1);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(sDefaultUrlWithHostNum));\n+    }\n+\n+\n+    @Test\n+    @Ignore(\"Not yet supported\")\n+    public void getCustomMediaUrlWithNoHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(null);\n+        setCustomServer(sCustomServerWithFormatting);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(\"https://sync.example.com/sync/\"));\n+    }\n+\n+\n+    @Test\n+    @Ignore(\"Not yet supported\")\n+    public void getCustomMediaUrlWithHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(1);\n+        setCustomServer(sCustomServerWithFormatting);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(\"https://sync1.example.com/sync/\"));\n+    }\n+\n+    @Test\n+    public void getUnformattedCustomMediaUrlWithHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(null);\n+        setCustomServer(sCustomServerWithNoFormatting);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(\"https://sync.example.com/sync/\"));\n+    }\n+\n+    @Test\n+    public void getUnformattedCustomMediaUrlWithNoHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(1);\n+        setCustomServer(sCustomServerWithNoFormatting);\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(\"https://sync.example.com/sync/\"));\n+    }\n+\n+    @Test\n+    public void invalidSettingReturnsCorrectResultWithNoHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(null);\n+        setCustomServerWithNoUrl();\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(sDefaultUrlNoHostNum));\n+    }\n+\n+    @Test\n+    public void invalidSettingReturnsCorrectResultWithHostNum() {\n+        HttpSyncer underTest = getServerWithHostNum(1);\n+        setCustomServerWithNoUrl();\n+\n+        String syncUrl = underTest.syncURL();\n+\n+        assertThat(syncUrl, is(sDefaultUrlWithHostNum));\n+    }\n+\n+    private void setCustomServerWithNoUrl() {\n+        SharedPreferences userPreferences = AnkiDroidApp.getSharedPrefs(AnkiDroidApp.getInstance());\n+        userPreferences.edit().putBoolean(\"useCustomSyncServer\", true).commit();\n+    }\n+\n+    private void setCustomServer(String s) {\n+\n+        SharedPreferences userPreferences = AnkiDroidApp.getSharedPrefs(AnkiDroidApp.getInstance());\n+        SharedPreferences.Editor e = userPreferences.edit();\n+        e.putBoolean(\"useCustomSyncServer\", true);\n+        e.putString(\"syncBaseUrl\", s);\n+        e.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9ef22b685de2acb6ddd82b831447e80801f5629"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1OTg2MQ==", "bodyText": "You did this another way in a different check, and it is because of the nullability/non-nullability of preferences. Could you eat the null check consistently in CustomSyncServer then everyone can just do a simple call to CustomSyncServer.isEnabled(prefs)? (whether prefs is null or not). Less code in the end, fewer mental gotos", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r409059861", "createdAt": "2020-04-15T18:49:28Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sync/HttpSyncer.java", "diffHunk": "@@ -454,12 +450,36 @@ public static ByteArrayInputStream getInputStream(String string) {\n     public String syncURL() {\n         // Allow user to specify custom sync server\n         SharedPreferences userPreferences = AnkiDroidApp.getSharedPrefs(AnkiDroidApp.getInstance());\n-        if (userPreferences != null && userPreferences.getBoolean(\"useCustomSyncServer\", false)) {\n-            Uri syncBase = Uri.parse(userPreferences.getString(\"syncBaseUrl\", Consts.SYNC_BASE));\n-            return syncBase.buildUpon().appendPath(\"sync\").toString() + \"/\";\n+        if (isUsingCustomSyncServer(userPreferences)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9ef22b685de2acb6ddd82b831447e80801f5629"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a014eda7ae855eb46c6dfd209ff994c97dde3277", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a014eda7ae855eb46c6dfd209ff994c97dde3277", "committedDate": "2020-04-15T19:42:25Z", "message": "NF: Preferences - commit -> apply"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b9eb3b2bc2610f128564cf1cfcd75670f97f015", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2b9eb3b2bc2610f128564cf1cfcd75670f97f015", "committedDate": "2020-04-15T19:53:29Z", "message": "NF: HostNum: Added requirements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a9aeac237bc4f53451408f6fd428dfb7d6c114a", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1a9aeac237bc4f53451408f6fd428dfb7d6c114a", "committedDate": "2020-04-15T19:56:35Z", "message": "NF: Copyright"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDkxNzgx", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#pullrequestreview-394091781", "createdAt": "2020-04-15T19:59:34Z", "commit": {"oid": "1a9aeac237bc4f53451408f6fd428dfb7d6c114a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo1OTozNFrOGGJaPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo1OTozNFrOGGJaPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5ODgxNA==", "bodyText": "Issue found: The utility class name 'HostNumFactory' doesn't match '[A-Z][a-zA-Z0-9]+(Utils?|Helper)'", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r409098814", "createdAt": "2020-04-15T19:59:34Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/web/HostNumFactory.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki.web;\n+\n+import android.content.Context;\n+\n+import com.ichi2.anki.AnkiDroidApp;\n+import com.ichi2.libanki.sync.HostNum;\n+\n+public class HostNumFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a9aeac237bc4f53451408f6fd428dfb7d6c114a"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDkxNzkw", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#pullrequestreview-394091790", "createdAt": "2020-04-15T19:59:35Z", "commit": {"oid": "1a9aeac237bc4f53451408f6fd428dfb7d6c114a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo1OTozNVrOGGJaRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTo1OTozNVrOGGJaRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA5ODgyMQ==", "bodyText": "Issue found: The utility class name 'CustomSyncServer' doesn't match '[A-Z][a-zA-Z0-9]+(Utils?|Helper)'", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#discussion_r409098821", "createdAt": "2020-04-15T19:59:35Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/web/CustomSyncServer.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki.web;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import timber.log.Timber;\n+\n+public class CustomSyncServer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a9aeac237bc4f53451408f6fd428dfb7d6c114a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDk5NTQw", "url": "https://github.com/ankidroid/Anki-Android/pull/6004#pullrequestreview-394099540", "createdAt": "2020-04-15T20:11:11Z", "commit": {"oid": "1a9aeac237bc4f53451408f6fd428dfb7d6c114a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3395, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}