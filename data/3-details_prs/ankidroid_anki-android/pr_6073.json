{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NjA2NDU4", "number": 6073, "title": "Regex", "bodyText": "Pull Request template\nPurpose / Description\nMaking question/answer creation faster and kind of following anki.\nFixes\nWhen you have 200 field in a note type, creating the question is slow. (Yeah, I've got note type with 200 fields)\nFurthermore, anki evolved in template generation recently, and we are not even close to anki anymore.\nApproach\nInstead of doing a lot of replace and iteration, we do a single iteration for {{# and {{^, and then a single iteration for cloze; using what java's documentation recommand to do multiple search/replace simultaneously.\nI should note that upstream code, in rust, parse the template to generate a tree, and then use the tree to compute answer/question. This is extremely useful to quickly determine exactly which cards should be generated/deleted for each note. If I recall correctly DAE told he intended to eventually remove req and really check whether a field is present or not in the question.\nHow Has This Been Tested?\nAnkiDroid test already tests cloze. And I added it in my \"merge\" branch, which I run on my phone", "createdAt": "2020-04-22T23:57:36Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6073", "merged": true, "mergeCommit": {"oid": "39f180e8f8a3fa08da0813fa7fb1f83088828958"}, "closed": true, "closedAt": "2020-04-26T16:23:03Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaRvNiABqjMyNjI5MTgxMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbdMW9gFqTQwMDUyMjIwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c68ba8a05df059e11604417420607a1d61e14245", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c68ba8a05df059e11604417420607a1d61e14245", "committedDate": "2020-04-22T23:36:55Z", "message": "render section use string buffer"}, "afterCommit": {"oid": "1ce89ce620e6ee8e31fa87db4d2ad694cc080718", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1ce89ce620e6ee8e31fa87db4d2ad694cc080718", "committedDate": "2020-04-23T00:27:21Z", "message": "render section use string buffer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MjM1NTQ4", "url": "https://github.com/ankidroid/Anki-Android/pull/6073#pullrequestreview-399235548", "createdAt": "2020-04-23T15:48:24Z", "commit": {"oid": "469886b949e99ff94b241713a1c8ce6afb8624c2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo0ODoyNFrOGKvNmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo1MzowNFrOGKvcpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxMjQ3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String section = otag + \"[\\\\#|^]([^\\\\}]*)\" + ctag +\"(.+?)\"+otag+\"/\\\\1\" + ctag;\n          \n          \n            \n                    String section = otag + \"[\\\\#|^]([^\\\\}]*)\" + ctag + \"(.+?)\" + otag + \"/\\\\1\" + ctag;", "url": "https://github.com/ankidroid/Anki-Android/pull/6073#discussion_r413912474", "createdAt": "2020-04-23T15:48:24Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -107,11 +107,10 @@ private void compile_regexps() {\n         String otag = Pattern.quote(sOtag);\n         String ctag = Pattern.quote(sCtag);\n \n-        String section = String.format(Locale.US,\n-                \"%s[\\\\#|^]([^\\\\}]*)%s(.+?)%s/\\\\1%s\", otag, ctag, otag, ctag);\n+        String section = otag + \"[\\\\#|^]([^\\\\}]*)\" + ctag +\"(.+?)\"+otag+\"/\\\\1\" + ctag;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469886b949e99ff94b241713a1c8ce6afb8624c2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxMjc3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String tag = otag+\"(#|=|&|!|>|\\\\{)?(.+?)\\\\1?\"+ctag+\"+\";\n          \n          \n            \n                    String tag = otag + \"(#|=|&|!|>|\\\\{)?(.+?)\\\\1?\" + ctag + \"+\";", "url": "https://github.com/ankidroid/Anki-Android/pull/6073#discussion_r413912772", "createdAt": "2020-04-23T15:48:46Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -107,11 +107,10 @@ private void compile_regexps() {\n         String otag = Pattern.quote(sOtag);\n         String ctag = Pattern.quote(sCtag);\n \n-        String section = String.format(Locale.US,\n-                \"%s[\\\\#|^]([^\\\\}]*)%s(.+?)%s/\\\\1%s\", otag, ctag, otag, ctag);\n+        String section = otag + \"[\\\\#|^]([^\\\\}]*)\" + ctag +\"(.+?)\"+otag+\"/\\\\1\" + ctag;\n         sSection_re = Pattern.compile(section, Pattern.MULTILINE | Pattern.DOTALL);\n \n-        String tag = String.format(Locale.US, \"%s(#|=|&|!|>|\\\\{)?(.+?)\\\\1?%s+\", otag, ctag);\n+        String tag = otag+\"(#|=|&|!|>|\\\\{)?(.+?)\\\\1?\"+ctag+\"+\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469886b949e99ff94b241713a1c8ce6afb8624c2"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxNDcwNA==", "bodyText": "Those might be faster with a StringBuilder (which is like StringBuffer for constructing Strings but is even faster because it is unsynchronized - meaning it is perfect for single-threaded use like this)", "url": "https://github.com/ankidroid/Anki-Android/pull/6073#discussion_r413914704", "createdAt": "2020-04-23T15:51:10Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -107,11 +107,10 @@ private void compile_regexps() {\n         String otag = Pattern.quote(sOtag);\n         String ctag = Pattern.quote(sCtag);\n \n-        String section = String.format(Locale.US,\n-                \"%s[\\\\#|^]([^\\\\}]*)%s(.+?)%s/\\\\1%s\", otag, ctag, otag, ctag);\n+        String section = otag + \"[\\\\#|^]([^\\\\}]*)\" + ctag +\"(.+?)\"+otag+\"/\\\\1\" + ctag;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxMjQ3NA=="}, "originalCommit": {"oid": "469886b949e99ff94b241713a1c8ce6afb8624c2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxNjMyNQ==", "bodyText": "StringBuilder might be even faster, only safe for single thread use but I believe it fits here https://developer.android.com/reference/java/lang/StringBuilder", "url": "https://github.com/ankidroid/Anki-Android/pull/6073#discussion_r413916325", "createdAt": "2020-04-23T15:53:04Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -118,31 +118,32 @@ private void compile_regexps() {\n      * Expands sections.\n      */\n     private String render_sections(String template, Map<String, String> context) {\n-        while (true) {\n-            Matcher match = sSection_re.matcher(template);\n-            if (!match.find()) {\n-                break;\n-            }\n-\n+        StringBuffer sb = new StringBuffer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce89ce620e6ee8e31fa87db4d2ad694cc080718"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9307c34c9b667288d440b0f7f8934d8fdc9063c7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9307c34c9b667288d440b0f7f8934d8fdc9063c7", "committedDate": "2020-04-26T15:28:26Z", "message": "render_tags in a single pass\n\nThis follow\nhttps://docs.oracle.com/javase/7/docs/api/java/util/regex/Matcher.html#appendReplacement(java.lang.StringBuffer,%20java.lang.String)\npattern to do a quicker search and replace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c148303fbc467f1766a8cfda05a8bc96516e0cb9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c148303fbc467f1766a8cfda05a8bc96516e0cb9", "committedDate": "2020-04-26T15:29:09Z", "message": "remove pattern formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b3d8b54eec5bcc4c3d761367555452228b72f53", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2b3d8b54eec5bcc4c3d761367555452228b72f53", "committedDate": "2020-04-26T15:29:09Z", "message": "Remove special case of cloze in pattern\n\nThis case is already considered by the fact that, in cloze NN, cNN is\na field with value 1. This is actually what upstream does."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d8a0d2bd5ba9c54b1b223122024328be123e8d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a3d8a0d2bd5ba9c54b1b223122024328be123e8d", "committedDate": "2020-04-26T15:29:15Z", "message": "render section use string buffer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ce89ce620e6ee8e31fa87db4d2ad694cc080718", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1ce89ce620e6ee8e31fa87db4d2ad694cc080718", "committedDate": "2020-04-23T00:27:21Z", "message": "render section use string buffer"}, "afterCommit": {"oid": "a3d8a0d2bd5ba9c54b1b223122024328be123e8d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a3d8a0d2bd5ba9c54b1b223122024328be123e8d", "committedDate": "2020-04-26T15:29:15Z", "message": "render section use string buffer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNTIyMjA1", "url": "https://github.com/ankidroid/Anki-Android/pull/6073#pullrequestreview-400522205", "createdAt": "2020-04-26T16:22:47Z", "commit": {"oid": "a3d8a0d2bd5ba9c54b1b223122024328be123e8d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3460, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}