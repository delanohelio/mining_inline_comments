{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMTIzMDA5", "number": 6570, "title": "Schedv2 testing", "bodyText": "This parameterizes the ContentProviderTest across the two scheduler versions, in an attempt to get us a bit more coverage across v2 scheduler which I don't think was being exercised much\n@david-allison-1 you'll notice I added an \"isEmulator\" check and removed your @Ignore on the content provider test - this implies the assertion: if you are running the instrumented tests on an emulator you accept corruption may occur. I believe that's a valid assertion. Feel free to disagree! We can change it back\nI also use the isEmulator check to only toggle the scheduler change on the collection if it is an emulator: same assertion applies.\n@Arthur-Milchior two tests fail on SchedV2 - can you essentially take over this branch and investigate? I only made the PR as a convenient way to show how to parameterize across the scheduler versions and expose potential problems, but I don't have the scheduler expertise to be useful in fixing things... you can either push directly to the branch or just copy it, I am not sensitive to the method of getting it done", "createdAt": "2020-06-28T22:17:21Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6570", "merged": true, "mergeCommit": {"oid": "58dc68a72b4d2e25a2e64191245e65325b65dd9a"}, "closed": true, "closedAt": "2020-06-29T21:48:02Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvzbFiAH2gAyNDQxMTIzMDA5OjJlYTc4ZWQ5ODM2NzM2Yjk1OTA2MDllMzE0OGQxOGE1N2U3YTg4Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwFu-ggFqTQzOTQxNTM3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2ea78ed9836736b9590609e3148d18a57e7a8838", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2ea78ed9836736b9590609e3148d18a57e7a8838", "committedDate": "2020-06-28T21:35:16Z", "message": "NF: de-lint ContentProviderTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4ODE5MjM4", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#pullrequestreview-438819238", "createdAt": "2020-06-28T22:38:39Z", "commit": {"oid": "342f8623bc70f5a5efe030afa2e4a3d17eb0fcf8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMjozODozOVrOGqA1dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMjo0MjoxNFrOGqA29g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzA2Mw==", "bodyText": "needs braces", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r446707063", "createdAt": "2020-06-28T22:38:39Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -118,24 +129,28 @@ public void setUp() throws Exception {\n         Log.i(AnkiDroidApp.TAG, \"setUp()\");\n         mCreatedNotes = new ArrayList<>();\n         final Collection col = getCol();\n+\n+        // We have parameterized the \"schedVersion\" variable, if we are on an emulator\n+        // (so it is safe) we will try to run with multiple scheduler versions\n+        if (InstrumentedTest.isEmulator()) col.changeSchedulerVer(schedVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "342f8623bc70f5a5efe030afa2e4a3d17eb0fcf8"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzI0NA==", "bodyText": "likewise", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r446707244", "createdAt": "2020-06-28T22:40:21Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -392,11 +413,10 @@ public void testQueryNotesProjection() {\n         }\n     }\n \n-    private String[] removeFromProjection(String[] inputProjection, int idx) {\n+    private String[] removeFromProjection(@SuppressWarnings(\"SameParameterValue\") String[] inputProjection, int idx) {\n         String[] outputProjection = new String[inputProjection.length - 1];\n-        for (int i = 0; i < idx; i++) {\n-            outputProjection[i] = inputProjection[i];\n-        }\n+        if (idx >= 0) System.arraycopy(inputProjection, 0, outputProjection, 0, idx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "342f8623bc70f5a5efe030afa2e4a3d17eb0fcf8"}, "originalPosition": 177}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzQ0Ng==", "bodyText": "Can we use Assume (http://junit.sourceforge.net/javadoc/org/junit/Assume.html) here? Assuming (hehe) it doesn't fail the build.\nIME it's best to explicitly show that a test was ignored, rather than passing with a noop", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r446707446", "createdAt": "2020-06-28T22:42:14Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -994,8 +1021,11 @@ public void testUpdateTags() {\n \n     /** Test that a null did will not crash the provider (#6378) */\n      @Test\n-     @Ignore(\"#6025 - This causes mild data corruption - should not be run on actual collection\")\n      public void testProviderProvidesDefaultForEmptyModelDeck() {\n+         if (!isEmulator()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "342f8623bc70f5a5efe030afa2e4a3d17eb0fcf8"}, "originalPosition": 323}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "342f8623bc70f5a5efe030afa2e4a3d17eb0fcf8", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/342f8623bc70f5a5efe030afa2e4a3d17eb0fcf8", "committedDate": "2020-06-28T22:12:39Z", "message": "Parameterize the ContentProviderTest across both schedulers\n\nNow we exercise SchedV2 a bit as well which should help\nNote that it is having problems right now but hopefully\nfollowing commits will fix them"}, "afterCommit": {"oid": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d2e0399cf1fe9b06fcd28d522c379e18d7097624", "committedDate": "2020-06-29T17:52:32Z", "message": "Parameterize the ContentProviderTest across both schedulers\n\nNow we exercise SchedV2 a bit as well which should help\nNote that it is having problems right now but hopefully\nfollowing commits will fix them"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzkwOTUz", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#pullrequestreview-439390953", "createdAt": "2020-06-29T18:19:48Z", "commit": {"oid": "d2e0399cf1fe9b06fcd28d522c379e18d7097624"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoxOTo0OFrOGqctqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxODoyMjo1MVrOGqc0hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2MzgxNg==", "bodyText": "Can we use Utils.arrayList2array here (and in a few other places)?\nNote: actually accepts List<T>", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447163816", "createdAt": "2020-06-29T18:19:48Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -176,11 +194,11 @@ public void tearDown() throws Exception {\n         // Delete all notes\n         List<Long> remnantNotes = col.findNotes(\"tag:\" + TEST_TAG);\n         if (remnantNotes.size() > 0) {\n-            long[] nids = new long[remnantNotes.size()];\n+            long[] noteIds = new long[remnantNotes.size()];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e0399cf1fe9b06fcd28d522c379e18d7097624"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDI4NA==", "bodyText": "Is this in the right place?", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447164284", "createdAt": "2020-06-29T18:20:39Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -392,11 +416,12 @@ public void testQueryNotesProjection() {\n         }\n     }\n \n-    private String[] removeFromProjection(String[] inputProjection, int idx) {\n+    private String[] removeFromProjection(@SuppressWarnings(\"SameParameterValue\") String[] inputProjection, int idx) {\n         String[] outputProjection = new String[inputProjection.length - 1];\n-        for (int i = 0; i < idx; i++) {\n-            outputProjection[i] = inputProjection[i];\n+        if (idx >= 0) {\n+            System.arraycopy(inputProjection, 0, outputProjection, 0, idx);\n         }\n+        //noinspection ManualArrayCopy", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e0399cf1fe9b06fcd28d522c379e18d7097624"}, "originalPosition": 185}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NDc1MA==", "bodyText": "maybe rename to earlyGraduatingEase", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447164750", "createdAt": "2020-06-29T18:21:28Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -829,7 +862,7 @@ public void testAnswerCard(){\n         ContentValues values = new ContentValues();\n         long noteId = card.note().getId();\n         int cardOrd = card.getOrd();\n-        int ease = AbstractFlashcardViewer.EASE_3; //<- insert real ease here\n+        int ease = (schedVersion == 1) ? AbstractFlashcardViewer.EASE_3 : AbstractFlashcardViewer.EASE_4;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e0399cf1fe9b06fcd28d522c379e18d7097624"}, "originalPosition": 314}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NTE5NA==", "bodyText": "Shouldn't this be assumeTrue(isEmulator());\nOr\nassumeThat(\"This causes mild data corruption - should not be run on a collection you care about\", isEmulator())", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447165194", "createdAt": "2020-06-29T18:22:13Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -986,16 +1019,14 @@ public void testUpdateTags() {\n         assertEquals(\"two tags\", 2, newTagList.size());\n         assertEquals(\"check first tag\", TEST_TAG, newTagList.get(0));\n         assertEquals(\"check second tag\", tag2, newTagList.get(1));\n-\n-\n     }\n \n \n-\n     /** Test that a null did will not crash the provider (#6378) */\n      @Test\n-     @Ignore(\"#6025 - This causes mild data corruption - should not be run on actual collection\")\n      public void testProviderProvidesDefaultForEmptyModelDeck() {\n+         // This causes mild data corruption - should not be run on a collection you care about\n+         assumeTrue(!isEmulator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e0399cf1fe9b06fcd28d522c379e18d7097624"}, "originalPosition": 358}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE2NTU3NA==", "bodyText": "This is marked as changed, but it looks the same - might just be whitespace?", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#discussion_r447165574", "createdAt": "2020-06-29T18:22:51Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/androidTest/java/com/ichi2/anki/tests/ContentProviderTest.java", "diffHunk": "@@ -1006,10 +1037,8 @@ public void testProviderProvidesDefaultForEmptyModelDeck() {\n          assertNotNull(allModels);\n      }\n \n-\n- private Collection reopenCol() {\n-        CollectionHelper.getInstance().closeCollection(false, \"ContentProviderTest: reopenCol\");\n-        return getCol();\n-    }\n-\n+     private Collection reopenCol() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e0399cf1fe9b06fcd28d522c379e18d7097624"}, "originalPosition": 372}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42ba7bbb324ceec55937ff63e6943ad12c2c2337", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/42ba7bbb324ceec55937ff63e6943ad12c2c2337", "committedDate": "2020-06-29T18:43:21Z", "message": "Parameterize the ContentProviderTest across both schedulers\n\nNow we exercise SchedV2 a bit as well which should help\nNote that it is having problems right now but hopefully\nfollowing commits will fix them"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2e0399cf1fe9b06fcd28d522c379e18d7097624", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d2e0399cf1fe9b06fcd28d522c379e18d7097624", "committedDate": "2020-06-29T17:52:32Z", "message": "Parameterize the ContentProviderTest across both schedulers\n\nNow we exercise SchedV2 a bit as well which should help\nNote that it is having problems right now but hopefully\nfollowing commits will fix them"}, "afterCommit": {"oid": "42ba7bbb324ceec55937ff63e6943ad12c2c2337", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/42ba7bbb324ceec55937ff63e6943ad12c2c2337", "committedDate": "2020-06-29T18:43:21Z", "message": "Parameterize the ContentProviderTest across both schedulers\n\nNow we exercise SchedV2 a bit as well which should help\nNote that it is having problems right now but hopefully\nfollowing commits will fix them"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDA5NTAy", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#pullrequestreview-439409502", "createdAt": "2020-06-29T18:46:39Z", "commit": {"oid": "42ba7bbb324ceec55937ff63e6943ad12c2c2337"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDE1Mzc3", "url": "https://github.com/ankidroid/Anki-Android/pull/6570#pullrequestreview-439415377", "createdAt": "2020-06-29T18:55:17Z", "commit": {"oid": "42ba7bbb324ceec55937ff63e6943ad12c2c2337"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3023, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}