{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMTgwNDYx", "number": 7271, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMzozNzoyMlrOFCGvww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQwNTowODoyNVrOFRQPTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NzUyMDAzOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMzozNzoyMlrOIBFePw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwNTozNjo0NFrOIBH5Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAwOTE1MQ==", "bodyText": "This code isn't used, what is the intention when a user is previewing?", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r538009151", "createdAt": "2020-12-08T03:37:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -892,7 +893,8 @@ public void _remNotes(java.util.Collection<Long> ids) {\n \t    ArrayList<JSONObject> cms;\n \t    switch (type) {\n             case ADD:\n-    \t        cms = findTemplates(note);\n+                // Don't show empty card, so it's clear during preview that no cards are generated\n+    \t        cms = findTemplates(note, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97a9f7199cf5eb8f98e9b09505388b70f88b4d84"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA0ODg0Ng==", "bodyText": "I just answered in #7842 . In particular I explained what the method does (since there is no comment).\u00a0I am confident that this change is consistent with the function goal. However, since I can't imagine we'll need this function, as we currently have a working previewer, I suggest to delete the method instead of finding the correct change to do", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r538048846", "createdAt": "2020-12-08T05:36:44Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -892,7 +893,8 @@ public void _remNotes(java.util.Collection<Long> ids) {\n \t    ArrayList<JSONObject> cms;\n \t    switch (type) {\n             case ADD:\n-    \t        cms = findTemplates(note);\n+                // Don't show empty card, so it's clear during preview that no cards are generated\n+    \t        cms = findTemplates(note, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAwOTE1MQ=="}, "originalCommit": {"oid": "97a9f7199cf5eb8f98e9b09505388b70f88b4d84"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NzUyODgxOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMzo0MDo1MlrOIBFivA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwNTozNjo1M1rOIBH5jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMDMwMA==", "bodyText": "We've moved from _availClozeOrds(.., true) to _availClozeOrds(.., variable), is this correct? Can this ever be false in Anki Desktop?", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r538010300", "createdAt": "2020-12-08T03:40:52Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -1111,16 +1110,21 @@ public static boolean emptyStandardCard(String type, JSONArray req, String[] tri\n     /**\n      * @param m A model\n      * @param sfld Fields of a note\n+     * @param allowEmpty whether to always return an ord, even if all cards are actually empty\n      * @return The index of the cards that are generated. For cloze cards, if no card is generated, then {0} */\n-    public static ArrayList<Integer> availOrds(Model m, String[] sfld) {\n+    public static ArrayList<Integer> availOrds(Model m, String[] sfld, boolean allowEmpty) {\n         if (m.getInt(\"type\") == Consts.MODEL_CLOZE) {\n-            return _availClozeOrds(m, sfld);\n+            return _availClozeOrds(m, sfld, allowEmpty);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97a9f7199cf5eb8f98e9b09505388b70f88b4d84"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODA0ODkxMA==", "bodyText": "I believe it is correct. As the PR state, my goal is to change a single thing: a note will always generate a card. In particular this will ensure that using \"Empty card\" and \"Check Database\" does not risk to delete cards by accident.\nHowever, there remains plenty of differences that I did not port between 2.1.27 and 2.1.28. For example, anki now allows to add notes even when they does not generate a card. It shows a warning but register the note correctly. It is not clear to me why it does that, but it does. I have read that this feature was asked for a usecase I can't remember. My goal was not to port this change to AnkiDroid. First because if we do so, it should be in a separate PR I believe. Secondly because this would be a disaster until the UI is changed. Indeed, AnkiDroid does not have a way to access recently created card the way than anki does with the \"History\" button. Accepting note without cards is okay in Anki, because you can easily go back and edit it. It would not be okay in ankidroid without a way to edit the card recently added.\nThis mean that currently, we want \"allow empty\" to be false when we create a note (so that we don't allow to create notes that generate no card), but we want it to be true when using \"Empty cards\" in order to ensure we don't delete notes by accident. This is note something that exists upstream because they changed the way they deal with creation of card and my goal was not to change it.", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r538048910", "createdAt": "2020-12-08T05:36:53Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -1111,16 +1110,21 @@ public static boolean emptyStandardCard(String type, JSONArray req, String[] tri\n     /**\n      * @param m A model\n      * @param sfld Fields of a note\n+     * @param allowEmpty whether to always return an ord, even if all cards are actually empty\n      * @return The index of the cards that are generated. For cloze cards, if no card is generated, then {0} */\n-    public static ArrayList<Integer> availOrds(Model m, String[] sfld) {\n+    public static ArrayList<Integer> availOrds(Model m, String[] sfld, boolean allowEmpty) {\n         if (m.getInt(\"type\") == Consts.MODEL_CLOZE) {\n-            return _availClozeOrds(m, sfld);\n+            return _availClozeOrds(m, sfld, allowEmpty);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODAxMDMwMA=="}, "originalCommit": {"oid": "97a9f7199cf5eb8f98e9b09505388b70f88b4d84"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUzNjM2MTc0OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/NoteImporter.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQwNTowODoyNVrOIXlsBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOFQxNDoyMDoxNFrOIb5z-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTYwNTYzNw==", "bodyText": "This should always be false now", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r561605637", "createdAt": "2021-01-21T05:08:25Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/NoteImporter.java", "diffHunk": "@@ -376,7 +376,7 @@ private boolean processFields(ForeignNote note, @Nullable String[] fields) {\n             }\n         }\n         note.fieldsStr = joinFields(fields);\n-        ArrayList<Integer> ords = Models.availOrds(mModel, fields);\n+        ArrayList<Integer> ords = Models.availOrds(mModel, fields, true);\n         if (ords.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f07fff417da5a90a0ef897d7ff019cce88b95e69"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTY5MTMyOA==", "bodyText": "On the opposite. If for some reason the note generate no card, we still want to allow it to be imported and saved in the collection, so allowEmpty should be true.", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r561691328", "createdAt": "2021-01-21T08:40:16Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/NoteImporter.java", "diffHunk": "@@ -376,7 +376,7 @@ private boolean processFields(ForeignNote note, @Nullable String[] fields) {\n             }\n         }\n         note.fieldsStr = joinFields(fields);\n-        ArrayList<Integer> ords = Models.availOrds(mModel, fields);\n+        ArrayList<Integer> ords = Models.availOrds(mModel, fields, true);\n         if (ords.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTYwNTYzNw=="}, "originalCommit": {"oid": "f07fff417da5a90a0ef897d7ff019cce88b95e69"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjIzMTY4NA==", "bodyText": "ords.isEmpty() surely should always return false now, unless I'm misunderstanding the code.\nCloze should always generate a card, now a normal note should also generate ord 0?", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r562231684", "createdAt": "2021-01-21T22:12:37Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/NoteImporter.java", "diffHunk": "@@ -376,7 +376,7 @@ private boolean processFields(ForeignNote note, @Nullable String[] fields) {\n             }\n         }\n         note.fieldsStr = joinFields(fields);\n-        ArrayList<Integer> ords = Models.availOrds(mModel, fields);\n+        ArrayList<Integer> ords = Models.availOrds(mModel, fields, true);\n         if (ords.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTYwNTYzNw=="}, "originalCommit": {"oid": "f07fff417da5a90a0ef897d7ff019cce88b95e69"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjEyOTY1OA==", "bodyText": "@Arthur-Milchior / @david-allison-1 is this point resolved? It seems like this is close, I'd still really like to land it :-)", "url": "https://github.com/ankidroid/Anki-Android/pull/7271#discussion_r566129658", "createdAt": "2021-01-28T14:20:14Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/NoteImporter.java", "diffHunk": "@@ -376,7 +376,7 @@ private boolean processFields(ForeignNote note, @Nullable String[] fields) {\n             }\n         }\n         note.fieldsStr = joinFields(fields);\n-        ArrayList<Integer> ords = Models.availOrds(mModel, fields);\n+        ArrayList<Integer> ords = Models.availOrds(mModel, fields, true);\n         if (ords.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTYwNTYzNw=="}, "originalCommit": {"oid": "f07fff417da5a90a0ef897d7ff019cce88b95e69"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 782, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}