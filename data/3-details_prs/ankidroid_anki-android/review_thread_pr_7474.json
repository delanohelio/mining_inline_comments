{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5NDUzNTM0", "number": 7474, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjoxNzo1NVrOExkswQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjoyMToyMlrOExkt5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNDE2OTYxOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjoxNzo1NVrOHnyxmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNzoyMToxMVrOHnzIaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQxMQ==", "bodyText": "is this correct? the SQL is asking for an id and you're feeding it a Long array, seems like it should just be the nid here?\nAny time I see SQL changing my first thought is: is this exercised by a test anywhere? I'd check the results of coverage output to see if this is indeed exercised to make sure the result is semantically the same. If it doesn't already have coverage I am nervous changing it without adding coverage first", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511488411", "createdAt": "2020-10-24T16:17:55Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -921,7 +918,7 @@ private void _changeCards(long[] nids, Model oldModel, Model newModel, Map<Integ\n         int nflds = newModel.getJSONArray(\"tmpls\").length();\n         try {\n             cur = mCol.getDb().getDatabase().query(\n-                    \"select id, ord from cards where nid in \" + Utils.ids2str(nids), null);\n+                    \"select id, ord from cards where nid = ?\", new Long[]{nid});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2eaeaaefea2103ffc542b64e24823f76a6f451e3"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MjkzOA==", "bodyText": "Previous answer deleted.\nIt works. I guess it is more clear now that I use an array of Object that this is just an array of argument values for the query.\nSince there is a single nid to consider, testing equality is simpler and more efficient than testing whether the value is in the list", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511492938", "createdAt": "2020-10-24T17:06:40Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -921,7 +918,7 @@ private void _changeCards(long[] nids, Model oldModel, Model newModel, Map<Integ\n         int nflds = newModel.getJSONArray(\"tmpls\").length();\n         try {\n             cur = mCol.getDb().getDatabase().query(\n-                    \"select id, ord from cards where nid in \" + Utils.ids2str(nids), null);\n+                    \"select id, ord from cards where nid = ?\", new Long[]{nid});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQxMQ=="}, "originalCommit": {"oid": "2eaeaaefea2103ffc542b64e24823f76a6f451e3"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5NDI0OQ==", "bodyText": "This was the cause of a CI failure before, the SQL prepare statement did have a problem, not sure if it will really compile correctly as a SQL statement but CI will tell us", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511494249", "createdAt": "2020-10-24T17:21:11Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -921,7 +918,7 @@ private void _changeCards(long[] nids, Model oldModel, Model newModel, Map<Integ\n         int nflds = newModel.getJSONArray(\"tmpls\").length();\n         try {\n             cur = mCol.getDb().getDatabase().query(\n-                    \"select id, ord from cards where nid in \" + Utils.ids2str(nids), null);\n+                    \"select id, ord from cards where nid = ?\", new Long[]{nid});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQxMQ=="}, "originalCommit": {"oid": "2eaeaaefea2103ffc542b64e24823f76a6f451e3"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNDE2OTgzOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjoxODowOFrOHnyxsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjo1MjoyOFrOHny-IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQzMw==", "bodyText": "I suppose this should be \"_changeNote\" now?", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511488433", "createdAt": "2020-10-24T16:18:08Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -871,48 +871,45 @@ private void _syncTemplates(Model m) {\n      */\n     public void change(Model m, long nid, Model newModel, Map<Integer, Integer> fmap, Map<Integer, Integer> cmap) throws ConfirmModSchemaException {\n         mCol.modSchema();\n-        long[] nids = new long[] {nid};\n         assert (newModel.getLong(\"id\") == m.getLong(\"id\")) || (fmap != null && cmap != null);\n         if (fmap != null) {\n-            _changeNotes(nids, newModel, fmap);\n+            _changeNotes(nid, newModel, fmap);\n         }\n         if (cmap != null) {\n-            _changeCards(nids, m, newModel, cmap);\n+            _changeCards(nid, m, newModel, cmap);\n         }\n+        long[] nids = new long[] {nid};\n         mCol.genCards(nids);\n     }\n \n-    private void _changeNotes(long[] nids, Model newModel, Map<Integer, Integer> map) {\n+    private void _changeNotes(long nid, Model newModel, Map<Integer, Integer> map) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2eaeaaefea2103ffc542b64e24823f76a6f451e3"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MTYxNw==", "bodyText": "Done", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511491617", "createdAt": "2020-10-24T16:52:28Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -871,48 +871,45 @@ private void _syncTemplates(Model m) {\n      */\n     public void change(Model m, long nid, Model newModel, Map<Integer, Integer> fmap, Map<Integer, Integer> cmap) throws ConfirmModSchemaException {\n         mCol.modSchema();\n-        long[] nids = new long[] {nid};\n         assert (newModel.getLong(\"id\") == m.getLong(\"id\")) || (fmap != null && cmap != null);\n         if (fmap != null) {\n-            _changeNotes(nids, newModel, fmap);\n+            _changeNotes(nid, newModel, fmap);\n         }\n         if (cmap != null) {\n-            _changeCards(nids, m, newModel, cmap);\n+            _changeCards(nid, m, newModel, cmap);\n         }\n+        long[] nids = new long[] {nid};\n         mCol.genCards(nids);\n     }\n \n-    private void _changeNotes(long[] nids, Model newModel, Map<Integer, Integer> map) {\n+    private void _changeNotes(long nid, Model newModel, Map<Integer, Integer> map) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODQzMw=="}, "originalCommit": {"oid": "2eaeaaefea2103ffc542b64e24823f76a6f451e3"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNDE3MTU3OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjoyMDowM1rOHnyyeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNzowNDoxOVrOHnzCVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODYzMw==", "bodyText": "Does this work? Shouldn't it just be nid?", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511488633", "createdAt": "2020-10-24T16:20:03Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -920,7 +917,7 @@ private void _changeCards(long[] nids, Model oldModel, Model newModel, Map<Integ\n         int nflds = newModel.getJSONArray(\"tmpls\").length();\n         try {\n             cur = mCol.getDb().getDatabase().query(\n-                    \"select id, ord from cards where nid in \" + Utils.ids2str(nids), null);\n+                    \"select id, ord from cards where nid = ?\", new Long[]{nid});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9bb304480d6a62633421892c5b7d16b12e96529"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MjY5Mg==", "bodyText": "I answered to Mike above", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511492692", "createdAt": "2020-10-24T17:04:19Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -920,7 +917,7 @@ private void _changeCards(long[] nids, Model oldModel, Model newModel, Map<Integ\n         int nflds = newModel.getJSONArray(\"tmpls\").length();\n         try {\n             cur = mCol.getDb().getDatabase().query(\n-                    \"select id, ord from cards where nid in \" + Utils.ids2str(nids), null);\n+                    \"select id, ord from cards where nid = ?\", new Long[]{nid});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODYzMw=="}, "originalCommit": {"oid": "b9bb304480d6a62633421892c5b7d16b12e96529"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNDE3MjU0OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjoyMToyMlrOHnyy6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjo1NTo1NVrOHny_Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODc0NA==", "bodyText": "Not any more", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511488744", "createdAt": "2020-10-24T16:21:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -720,26 +720,39 @@ public void _remNotes(java.util.Collection<Long> ids) {\n     /**\n      * Generate cards for non-empty templates, return ids to remove.\n      */\n-\tpublic ArrayList<Long> genCards(List<Long> nids) {\n-\t    return genCards(Utils.collection2Array(nids));\n+\tpublic ArrayList<Long> genCards(java.util.Collection<Long> nids) {\n+        String snids = Utils.ids2str(nids);\n+\t    return genCards(snids);\n \t}\n \n     public <T extends ProgressSender<TaskData> & CancelListener> ArrayList<Long> genCards(List<Long> nids, @Nullable T task) {\n-       return genCards(Utils.collection2Array(nids), task);\n+        String snids = Utils.ids2str(nids);\n+        return genCards(snids, task);\n     }\n \n-    public ArrayList<Long> genCards(long[] nids) {\n-       return genCards(nids, null);\n+    public ArrayList<Long> genCards(long nid) {\n+       return genCards(nid, null);\n     }\n \n     /**\n-     * @param nids All ids of nodes of a note type\n+     * @param nid All ids of nodes of a note type", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9bb304480d6a62633421892c5b7d16b12e96529"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ5MTkzOA==", "bodyText": "Thanks. You're right", "url": "https://github.com/ankidroid/Anki-Android/pull/7474#discussion_r511491938", "createdAt": "2020-10-24T16:55:55Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -720,26 +720,39 @@ public void _remNotes(java.util.Collection<Long> ids) {\n     /**\n      * Generate cards for non-empty templates, return ids to remove.\n      */\n-\tpublic ArrayList<Long> genCards(List<Long> nids) {\n-\t    return genCards(Utils.collection2Array(nids));\n+\tpublic ArrayList<Long> genCards(java.util.Collection<Long> nids) {\n+        String snids = Utils.ids2str(nids);\n+\t    return genCards(snids);\n \t}\n \n     public <T extends ProgressSender<TaskData> & CancelListener> ArrayList<Long> genCards(List<Long> nids, @Nullable T task) {\n-       return genCards(Utils.collection2Array(nids), task);\n+        String snids = Utils.ids2str(nids);\n+        return genCards(snids, task);\n     }\n \n-    public ArrayList<Long> genCards(long[] nids) {\n-       return genCards(nids, null);\n+    public ArrayList<Long> genCards(long nid) {\n+       return genCards(nid, null);\n     }\n \n     /**\n-     * @param nids All ids of nodes of a note type\n+     * @param nid All ids of nodes of a note type", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODc0NA=="}, "originalCommit": {"oid": "b9bb304480d6a62633421892c5b7d16b12e96529"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 758, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}