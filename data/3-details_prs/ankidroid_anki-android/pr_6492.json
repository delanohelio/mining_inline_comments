{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MjEwNjY4", "number": 6492, "title": "Augment analytics so we can answer hardware questions", "bodyText": "Pull Request template\nPurpose / Description\n\nwhat hardware are we running on?\nwhat operating system version?\nwhat screen size?\n\nThis came about when I realized the analytics currently did not answer\nthe question, how many users are using Amazon devices?\nWhile I was in there I added the other hardware bits I thought could\nfocus development effort allocation\nApproach\nAdd a method to the initializer for the default analytics request to set device data\nSetting User-Agent correctly let's google auto-segment devices to a large degree, I used custom dimensions as well to make sure\nHow Has This Been Tested?\nAPI29 emulator, used advanced preferences to turn on debug analytics and watched the analytics console as well as adb logcat to check the request parameters and see their effect on reporting\nLearning (optional, can help others)\nThe User-Agent style is working code from another project I maintain, so I have confidence in it:\nhttps://github.com/react-native-community/react-native-device-info/blob/b2d77dbbfc89143747b43f42ae04937d7b2e82ff/android/src/main/java/com/learnium/RNDeviceInfo/RNDeviceModule.java#L725-L735\nAnd the reason to set it, as well as send custom dimensions is because that's just how it's done since there's no API for it:\nhttps://stackoverflow.com/questions/35202625/how-do-i-provide-google-analytics-my-operating-system\nhttps://developers.google.com/analytics/devguides/collection/protocol/v1/parameters\nChecklist\nSome unnecessary whitespace changed, specifically auto-format aligned javadoc parameter descriptions, leaving it\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-06-18T03:50:56Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6492", "merged": true, "mergeCommit": {"oid": "254944f96552873d993ba7565fc5e741ad908622"}, "closed": true, "closedAt": "2020-06-18T14:14:08Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsWXB8gH2gAyNDM2MjEwNjY4OmUwMDJkNWJhN2YzYjk2MzdlN2ZmM2QxNmNjODYzZjhlNWQ2MzZjMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsfA5NgFqTQzMzMxOTQ2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "committedDate": "2020-06-18T04:01:49Z", "message": "Augment analytics so we can answer hardware questions\n\n- what hardware are we running on?\n- what operating system version?\n- what screen size?\n\nThis came about when I realized the analytics currently did not answer\nthe question, how many users are using Amazon devices?\n\nWhile I was in there I added the other hardware bits I thought could\nfocus development effort allocation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0438b62f3616d2b21158e574837c85466958cc17", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0438b62f3616d2b21158e574837c85466958cc17", "committedDate": "2020-06-18T03:41:55Z", "message": "Augment analytics so we can answer hardware questions\n\n- what hardware are we running on?\n- what operating system version?\n- what screen size?\n\nThis came about when I realized the analytics currently did not answer\nthe question, how many users are using Amazon devices?\n\nWhile I was in there I added the other hardware bits I thought could\nfocus development effort allocation"}, "afterCommit": {"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b", "committedDate": "2020-06-18T04:01:49Z", "message": "Augment analytics so we can answer hardware questions\n\n- what hardware are we running on?\n- what operating system version?\n- what screen size?\n\nThis came about when I realized the analytics currently did not answer\nthe question, how many users are using Amazon devices?\n\nWhile I was in there I added the other hardware bits I thought could\nfocus development effort allocation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDg3MzEw", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#pullrequestreview-433087310", "createdAt": "2020-06-18T09:07:26Z", "commit": {"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwOTowNzoyNlrOGlmghA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwOToxNzo0OFrOGlm5kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MTQxMg==", "bodyText": "These seem erroneous", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442081412", "createdAt": "2020-06-18T09:07:26Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java", "diffHunk": "@@ -221,9 +228,9 @@ public static void sendAnalyticsEvent(@NonNull String category, @NonNull String\n      * Send a detailed arbitrary analytics event, with noun/verb pairs and extra data if needed\n      *\n      * @param category the category of event, make your own but use a constant so reporting is good\n-     * @param action the action the user performed\n-     * @param value A value for the event, Integer.MIN_VALUE signifies caller shouldn't send the value\n-     * @param label A label for the event, may be null\n+     * @param action   the action the user performed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MzQ5Mg==", "bodyText": "Might want to look into how ACRA gets compatScreenHeightDp, possibly from Configuration", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442083492", "createdAt": "2020-06-18T09:10:44Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java", "diffHunk": "@@ -278,4 +285,46 @@ public static void sendAnalyticsException(@NonNull String description, boolean f\n         }\n         sAnalytics.exception().exceptionDescription(description).exceptionFatal(fatal).sendAsync();\n     }\n+\n+\n+    /**\n+     * An Android-specific device config generator. Without this it's \"Desktop\" and unknown for all hardware.\n+     * It is interesting to us what devices people use though (for instance: is Amazon Kindle support worth it?\n+     * Is anyone still using e-ink devices? How many people are on tablets? ChromeOS?)\n+     */\n+    private static class AndroidDefaultRequest extends DefaultRequest {\n+        private DefaultRequest setAndroidRequestParameters(Context context) {\n+\n+            // Are we running on really large screens or small screens or ?\n+            try {\n+                WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);\n+                Display display = wm.getDefaultDisplay();\n+                Point size = new Point();\n+                display.getSize(size);\n+                this.screenResolution(size.x + \"x\" + size.y);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NTM3NA==", "bodyText": "Got this confused with BuildConfig.DEBUG\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        this.customDimension(1, Build.VERSION.RELEASE); // systemVersion\n          \n          \n            \n                        this.customDimension(1, Build.VERSION.RELEASE); // readable version: \"2.12alpha9\"", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442085374", "createdAt": "2020-06-18T09:13:50Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java", "diffHunk": "@@ -278,4 +285,46 @@ public static void sendAnalyticsException(@NonNull String description, boolean f\n         }\n         sAnalytics.exception().exceptionDescription(description).exceptionFatal(fatal).sendAsync();\n     }\n+\n+\n+    /**\n+     * An Android-specific device config generator. Without this it's \"Desktop\" and unknown for all hardware.\n+     * It is interesting to us what devices people use though (for instance: is Amazon Kindle support worth it?\n+     * Is anyone still using e-ink devices? How many people are on tablets? ChromeOS?)\n+     */\n+    private static class AndroidDefaultRequest extends DefaultRequest {\n+        private DefaultRequest setAndroidRequestParameters(Context context) {\n+\n+            // Are we running on really large screens or small screens or ?\n+            try {\n+                WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);\n+                Display display = wm.getDefaultDisplay();\n+                Point size = new Point();\n+                display.getSize(size);\n+                this.screenResolution(size.x + \"x\" + size.y);\n+            } catch (RuntimeException e) {\n+                // nothing much to do here, it means we couldn't get WindowManager\n+            }\n+\n+            // We can have up to 20 of these - there might be other things we want to know\n+            // but simply seeing what hardware we are running on should be useful\n+            this.customDimension(1, Build.VERSION.RELEASE); // systemVersion", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4NzgyNQ==", "bodyText": "Just flagging; I don't think this will trigger #5794", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#discussion_r442087825", "createdAt": "2020-06-18T09:17:48Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/analytics/UsageAnalytics.java", "diffHunk": "@@ -278,4 +285,46 @@ public static void sendAnalyticsException(@NonNull String description, boolean f\n         }\n         sAnalytics.exception().exceptionDescription(description).exceptionFatal(fatal).sendAsync();\n     }\n+\n+\n+    /**\n+     * An Android-specific device config generator. Without this it's \"Desktop\" and unknown for all hardware.\n+     * It is interesting to us what devices people use though (for instance: is Amazon Kindle support worth it?\n+     * Is anyone still using e-ink devices? How many people are on tablets? ChromeOS?)\n+     */\n+    private static class AndroidDefaultRequest extends DefaultRequest {\n+        private DefaultRequest setAndroidRequestParameters(Context context) {\n+\n+            // Are we running on really large screens or small screens or ?\n+            try {\n+                WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);\n+                Display display = wm.getDefaultDisplay();\n+                Point size = new Point();\n+                display.getSize(size);\n+                this.screenResolution(size.x + \"x\" + size.y);\n+            } catch (RuntimeException e) {\n+                // nothing much to do here, it means we couldn't get WindowManager\n+            }\n+\n+            // We can have up to 20 of these - there might be other things we want to know\n+            // but simply seeing what hardware we are running on should be useful\n+            this.customDimension(1, Build.VERSION.RELEASE); // systemVersion\n+            this.customDimension(2, Build.BRAND); // brand\n+            this.customDimension(3, Build.MODEL); // model\n+            this.customDimension(4, Build.BOARD); // deviceId\n+\n+            // This is important for google to auto-fingerprint us for default reporting\n+            try {\n+                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR1) {\n+                    this.userAgent(WebSettings.getDefaultUserAgent(context));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b"}, "originalPosition": 115}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5420abcd848a2835133998fd0cb71333e095b9df", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5420abcd848a2835133998fd0cb71333e095b9df", "committedDate": "2020-06-18T14:00:02Z", "message": "NF: extended commentary on android-specific analytics values"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMzE5NDYx", "url": "https://github.com/ankidroid/Anki-Android/pull/6492#pullrequestreview-433319461", "createdAt": "2020-06-18T14:06:48Z", "commit": {"oid": "e002d5ba7f3b9637e7ff3d16cc863f8e5d636c1b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3228, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}