{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NTI3MDk1", "number": 6048, "title": "beforeUpload: save only if some change occured", "bodyText": "Saving any in the collection takes a lot of time, especially because we need to deal with big strings. Saving values in the database is useless when no change occured.\nSo, in this case, I just uses a boolean to see whether any change did occur, and save only if there is some change.", "createdAt": "2020-04-18T16:49:30Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6048", "merged": true, "mergeCommit": {"oid": "82c8c55e0378460d1c0d508d4ad9e42fee001a1d"}, "closed": true, "closedAt": "2020-06-04T22:49:22Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoCOIhAFqTQyNDcxMjQyOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoDx7PAFqTQyNDc4OTIxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzEyNDI4", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#pullrequestreview-424712428", "createdAt": "2020-06-04T18:18:18Z", "commit": {"oid": "0bf84ca4f58bf34eb8edbada0c4fe676e6929243"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0bf84ca4f58bf34eb8edbada0c4fe676e6929243", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0bf84ca4f58bf34eb8edbada0c4fe676e6929243", "committedDate": "2020-04-18T16:49:09Z", "message": "beforeUpload: save only if some change occured\n\nSaving any in the collectio takes a lot of time, especially because we\nneed to deal with big strings. Saving values in the database is\nuseless when no change occured.\n\nSo, in this case, I just uses a boolean to see whether any change did\noccur, and save only if there is some change."}, "afterCommit": {"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b9cffb6595f77972d749eb0a2443f81454813ec8", "committedDate": "2020-06-04T18:58:10Z", "message": "Array of JSONObject: save only if modified in beforeUpload"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzU1OTIz", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#pullrequestreview-424755923", "createdAt": "2020-06-04T19:17:34Z", "commit": {"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxOToxNzozNFrOGfUbww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxOToyMTowN1rOGfUiyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzgyNw==", "bodyText": "For reference: You could use a single | here which will evaluate both sides, but I'm happy with the comment. Feel free to mark as resolved with no action.", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435493827", "createdAt": "2020-06-04T19:17:34Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -979,13 +979,14 @@ private void gather(HashMap<Long, HashMap> node, List<Long> arr) {\n \n \n     public void beforeUpload() {\n-        for (JSONObject d : all()) {\n-            d.put(\"usn\", 0);\n+        boolean changed_decks = Utils.shouldSave(all());\n+        boolean changed_conf = Utils.shouldSave(allConf());\n+        if (changed_decks || changed_conf) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzkzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // shouldSave should always be called on both list, for\n          \n          \n            \n                        // shouldSave should always be called on both lists, for", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435493935", "createdAt": "2020-06-04T19:17:46Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -979,13 +979,14 @@ private void gather(HashMap<Long, HashMap> node, List<Long> arr) {\n \n \n     public void beforeUpload() {\n-        for (JSONObject d : all()) {\n-            d.put(\"usn\", 0);\n+        boolean changed_decks = Utils.shouldSave(all());\n+        boolean changed_conf = Utils.shouldSave(allConf());\n+        if (changed_decks || changed_conf) {\n+            // shouldSave should always be called on both list, for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDk4Mw==", "bodyText": "nit: I think you can iterate mTags here, rather than the keySet.\nYou might want to extract this to a shouldSave in Utils with a different parameter type for readability", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435494983", "createdAt": "2020-06-04T19:19:52Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Tags.java", "diffHunk": "@@ -372,10 +372,16 @@ public boolean inList(String tag, Iterable<String> tags) {\n      */\n \n     public void beforeUpload() {\n+        boolean changed = false;\n         for (String k : mTags.keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTYyNg==", "bodyText": "if the connection break at this exact moment, the collection will be inconsistent.\n\nIs this handled in the code right now, or do we need an issue to fix this?", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435495626", "createdAt": "2020-06-04T19:21:07Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -1017,4 +1017,29 @@ public static float randomFloatInRange(float min, float max) {\n         Random rand = new Random();\n         return rand.nextFloat() * (max - min) + min;\n     }\n+\n+    /**\n+       Set usn to 0 in every object.\n+\n+       Usn zero means that the object is already online. Non-zero usn\n+       means that the object is different than online or is not online.\n+\n+       This method is called during sync, before uploading, so during\n+       an instant, the value will be zero while the object is not\n+       actually online; if the connection break at this exact moment,\n+       the collection will be inconsistent.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzYwMTIz", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#pullrequestreview-424760123", "createdAt": "2020-06-04T19:23:49Z", "commit": {"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxOToyMzo1MFrOGfUoYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxOToyMzo1MFrOGfUoYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NzA1OA==", "bodyText": "Nit: needs a name change. should implies it doesn't make changed.\nMaybe markAsRequiringSync", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435497058", "createdAt": "2020-06-04T19:23:50Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -1017,4 +1017,29 @@ public static float randomFloatInRange(float min, float max) {\n         Random rand = new Random();\n         return rand.nextFloat() * (max - min) + min;\n     }\n+\n+    /**\n+       Set usn to 0 in every object.\n+\n+       Usn zero means that the object is already online. Non-zero usn\n+       means that the object is different than online or is not online.\n+\n+       This method is called during sync, before uploading, so during\n+       an instant, the value will be zero while the object is not\n+       actually online; if the connection break at this exact moment,\n+       the collection will be inconsistent.\n+\n+       @return whether there was a non-zero usn; in this case the list\n+       should be saved before the upload.\n+     */\n+    public static boolean shouldSave(ArrayList<JSONObject> ar) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54888591abadd36e100f0f6f9f8bcde28d03db4f", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/54888591abadd36e100f0f6f9f8bcde28d03db4f", "committedDate": "2020-06-04T19:43:42Z", "message": "Tags: save only if modified in beforeUpload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "committedDate": "2020-06-04T19:58:42Z", "message": "Array of JSONObject: save only if modified in beforeUpload"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b9cffb6595f77972d749eb0a2443f81454813ec8", "committedDate": "2020-06-04T18:58:10Z", "message": "Array of JSONObject: save only if modified in beforeUpload"}, "afterCommit": {"oid": "4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "committedDate": "2020-06-04T19:58:42Z", "message": "Array of JSONObject: save only if modified in beforeUpload"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0Nzg1ODQ4", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#pullrequestreview-424785848", "createdAt": "2020-06-04T20:02:16Z", "commit": {"oid": "4276b2cdd045c68dc1cb4e59a532efe6fbf997e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0Nzg5MjE1", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#pullrequestreview-424789215", "createdAt": "2020-06-04T20:07:18Z", "commit": {"oid": "4276b2cdd045c68dc1cb4e59a532efe6fbf997e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3438, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}