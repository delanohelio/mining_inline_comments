{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3Nzg3NTIz", "number": 6662, "title": "Handle Exception from FileProvider in crop", "bodyText": "Pull Request template\nPurpose / Description\nFileProvider can throw unchecked exceptions\nNot a fan of system APIs throwing RuntimeExceptions, they catch me out like this too frequently\nFixes\nFixes #6628\nApproach\nPokemon error handling, fall back to non-FileProvider URI, consumers of the method already have hardening against the image still being non-existent in case fallback / non-FileProvider style results in invalid URI\nHow Has This Been Tested?\nDifficult to test unfortunately but when I feed bad data as image references into the image field editor I can't make it crash. I couldn't make it crash before though unfortunately and there is no good test infrastructure here yet\nLearning (optional, can help others)\nAlways always always check underlying APIs to see if they can throw RuntimeExceptions\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-07-11T16:21:07Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6662", "merged": true, "mergeCommit": {"oid": "2515251c92bcd0caea94c86e978b2d76b4fbf7e1"}, "closed": true, "closedAt": "2020-07-14T19:00:37Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcz6tMwgH2gAyNDQ3Nzg3NTIzOjJhNTIxMDczMTg3M2NhMzdjYzIwY2VhM2YwMWIzN2ZjZDFjMWVhZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc03s4sgFqTQ0ODIxMzgwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a5210731873ca37cc20cea3f01b37fcd1c1eae0", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2a5210731873ca37cc20cea3f01b37fcd1c1eae0", "committedDate": "2020-07-11T16:20:05Z", "message": "Handle Exception from FileProvider in crop\n\nNot a fan of system APIs throwing RuntimeExceptions, they catch\nme out like this too frequently"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODQ0Mjk5", "url": "https://github.com/ankidroid/Anki-Android/pull/6662#pullrequestreview-446844299", "createdAt": "2020-07-12T04:06:49Z", "commit": {"oid": "2a5210731873ca37cc20cea3f01b37fcd1c1eae0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDowNjo0OVrOGwRDUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDowNjo0OVrOGwRDUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NDIwOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Timber.w(\"getUriForFile failed on %s - attempting fallback\", file);\n          \n          \n            \n                        Timber.w(e, \"getUriForFile failed on %s - attempting fallback\", file);", "url": "https://github.com/ankidroid/Anki-Android/pull/6662#discussion_r453264208", "createdAt": "2020-07-12T04:06:49Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/fields/BasicImageFieldController.java", "diffHunk": "@@ -654,13 +654,15 @@ private void handleCropResult() {\n      */\n     private Uri getUriForFile(File file) {\n         Timber.d(\"getUriForFile() %s\", file);\n-        Uri uri;\n-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {\n-            uri = FileProvider.getUriForFile(mActivity, mActivity.getApplicationContext().getPackageName() + \".apkgfileprovider\", file);\n-        } else {\n-            uri = Uri.fromFile(file);\n+        try {\n+            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {\n+                return FileProvider.getUriForFile(mActivity, mActivity.getApplicationContext().getPackageName() + \".apkgfileprovider\", file);\n+            }\n+        } catch (Exception e) {\n+            Timber.w(\"getUriForFile failed on %s - attempting fallback\", file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a5210731873ca37cc20cea3f01b37fcd1c1eae0"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "080f5b9b6229aa8c57f15f39bf711e455b9997e0", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/080f5b9b6229aa8c57f15f39bf711e455b9997e0", "committedDate": "2020-07-12T14:39:55Z", "message": "Add telemetry to getUriForFile failures\n\nwe are not sure exactly how often this is happening or why, this\ntelemetry is diagnostic"}, "afterCommit": {"oid": "47d25e2f007102c077caeb6a1fad95981e5d4af3", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/47d25e2f007102c077caeb6a1fad95981e5d4af3", "committedDate": "2020-07-12T14:42:01Z", "message": "Add telemetry to getUriForFile failures\n\nwe are not sure exactly how often this is happening or why, this\ntelemetry is diagnostic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47d25e2f007102c077caeb6a1fad95981e5d4af3", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/47d25e2f007102c077caeb6a1fad95981e5d4af3", "committedDate": "2020-07-12T14:42:01Z", "message": "Add telemetry to getUriForFile failures\n\nwe are not sure exactly how often this is happening or why, this\ntelemetry is diagnostic"}, "afterCommit": {"oid": "330038b3fd72ad1c8e632a989dbf95005ae86690", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/330038b3fd72ad1c8e632a989dbf95005ae86690", "committedDate": "2020-07-13T21:47:52Z", "message": "Add telemetry to getUriForFile failures\n\nWe are not sure exactly how often this is happening or why, this\ntelemetry is diagnostic and only engages if user is set to auto-send\nreports so the UX isn't bad"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MDcwOTM4", "url": "https://github.com/ankidroid/Anki-Android/pull/6662#pullrequestreview-448070938", "createdAt": "2020-07-14T12:45:33Z", "commit": {"oid": "330038b3fd72ad1c8e632a989dbf95005ae86690"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo0NTozM1rOGxSDQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo0NTozM1rOGxSDQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyOTE1Mg==", "bodyText": "nit: onlyAlwaysOn doesn't seem necessary. There's no reason to pass false.\nMaybe send[Silent/Unintrusive]ExceptionReport?", "url": "https://github.com/ankidroid/Anki-Android/pull/6662#discussion_r454329152", "createdAt": "2020-07-14T12:45:33Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AnkiDroidApp.java", "diffHunk": "@@ -342,6 +342,15 @@ public static void sendExceptionReport(Throwable e, String origin, String additi\n     }\n \n \n+    public static void sendExceptionReportConditionally(Throwable e, String origin, String additionalInfo, boolean onlyAlwaysOn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "330038b3fd72ad1c8e632a989dbf95005ae86690"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5b6597b8c0ca8ec015e5477be89e53d2239a7cf", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a5b6597b8c0ca8ec015e5477be89e53d2239a7cf", "committedDate": "2020-07-14T15:20:55Z", "message": "Add telemetry to getUriForFile failures\n\nWe are not sure exactly how often this is happening or why, this\ntelemetry is diagnostic and only engages if user is set to auto-send\nreports so the UX isn't bad"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "330038b3fd72ad1c8e632a989dbf95005ae86690", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/330038b3fd72ad1c8e632a989dbf95005ae86690", "committedDate": "2020-07-13T21:47:52Z", "message": "Add telemetry to getUriForFile failures\n\nWe are not sure exactly how often this is happening or why, this\ntelemetry is diagnostic and only engages if user is set to auto-send\nreports so the UX isn't bad"}, "afterCommit": {"oid": "a5b6597b8c0ca8ec015e5477be89e53d2239a7cf", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a5b6597b8c0ca8ec015e5477be89e53d2239a7cf", "committedDate": "2020-07-14T15:20:55Z", "message": "Add telemetry to getUriForFile failures\n\nWe are not sure exactly how often this is happening or why, this\ntelemetry is diagnostic and only engages if user is set to auto-send\nreports so the UX isn't bad"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MjEzODA4", "url": "https://github.com/ankidroid/Anki-Android/pull/6662#pullrequestreview-448213808", "createdAt": "2020-07-14T15:23:57Z", "commit": {"oid": "a5b6597b8c0ca8ec015e5477be89e53d2239a7cf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3108, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}