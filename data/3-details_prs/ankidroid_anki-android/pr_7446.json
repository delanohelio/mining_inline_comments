{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4ODAyNTA2", "number": 7446, "title": "Cache result of a part of _availClozeOrds", "bodyText": "Following advice of #7296 (comment) I cache the result of a function called multiple time with the same value", "createdAt": "2020-10-23T08:22:45Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7446", "merged": true, "mergeCommit": {"oid": "abe50702999122412cf6f65018aac7c67a105cd6"}, "closed": true, "closedAt": "2020-10-24T18:15:24Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVXE6xAFqTUxNTY5NjkzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVupbsAFqTUxNjI5Mzc4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1Njk2OTM0", "url": "https://github.com/ankidroid/Anki-Android/pull/7446#pullrequestreview-515696934", "createdAt": "2020-10-23T14:02:49Z", "commit": {"oid": "c22a7183f2f778ef9064faa9947cbb6c00a1b4da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDowMjo0OVrOHnPPPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDowMjo0OVrOHnPPPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkwNjE3NQ==", "bodyText": "cache coherency question: is it possible to change the question in some way via note editor or similar after it has been entered in this cache, such that the field still exists, and did have a cloze but no longer has a cloze, yet comes back in the return array here still because it was not knocked out of the cache after edit?", "url": "https://github.com/ankidroid/Anki-Android/pull/7446#discussion_r510906175", "createdAt": "2020-10-23T14:02:49Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Models.java", "diffHunk": "@@ -1105,18 +1105,28 @@ private void _updateRequired(Model m) {\n         return _availClozeOrds(m, sflds, true);\n     }\n \n+    /**\n+     * Cache of getNamesOfFieldsContainingCloze\n+     * Computing hash of string is costly. However, hash is cashed in the string object, so this virtually ensure that\n+     * given a card type, we don't nede to recompute the hash.\n+     */\n+    private static HashMap<String, List<String>> namesOfFieldsContainingClozeCache = new HashMap<>();\n+\n     /** The name of all fields that are used as cloze in the question.\n      * It is not guaranteed that the field found are actually the name of any field of the note type.*/\n     @VisibleForTesting\n     protected static List<String> getNamesOfFieldsContainingCloze(String question) {\n-        List<String> matches = new ArrayList<>();\n-        for (Pattern pattern : new Pattern[]{fClozePattern1, fClozePattern2}) {\n-             Matcher mm = pattern.matcher(question);\n-             while (mm.find()) {\n-                 matches.add(mm.group(1));\n-             }\n+        if (! namesOfFieldsContainingClozeCache.containsKey(question)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c22a7183f2f778ef9064faa9947cbb6c00a1b4da"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46e55588b73c236b2acd0ef475f5747200573efa", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/46e55588b73c236b2acd0ef475f5747200573efa", "committedDate": "2020-10-24T17:21:21Z", "message": "NF: extracting a variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "374deaf7237c25fe84863f5758a859af19f8f4a7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/374deaf7237c25fe84863f5758a859af19f8f4a7", "committedDate": "2020-10-24T17:21:21Z", "message": "NF: factorize duplicated code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ab105384a476e0b6d3616cbe3a1fd504a36f7c8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0ab105384a476e0b6d3616cbe3a1fd504a36f7c8", "committedDate": "2020-10-24T17:28:47Z", "message": "NF: extract getNamesOfFieldContainingCloze"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "603f2020fe3794ceaf285cfc09007b284242ca53", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/603f2020fe3794ceaf285cfc09007b284242ca53", "committedDate": "2020-10-24T17:28:48Z", "message": "NF: cache getNamesOfFieldsContainingCloze"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c22a7183f2f778ef9064faa9947cbb6c00a1b4da", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c22a7183f2f778ef9064faa9947cbb6c00a1b4da", "committedDate": "2020-10-23T08:10:33Z", "message": "NF: cache getNamesOfFieldsContainingCloze"}, "afterCommit": {"oid": "603f2020fe3794ceaf285cfc09007b284242ca53", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/603f2020fe3794ceaf285cfc09007b284242ca53", "committedDate": "2020-10-24T17:28:48Z", "message": "NF: cache getNamesOfFieldsContainingCloze"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MjkzNzgx", "url": "https://github.com/ankidroid/Anki-Android/pull/7446#pullrequestreview-516293781", "createdAt": "2020-10-24T17:30:32Z", "commit": {"oid": "603f2020fe3794ceaf285cfc09007b284242ca53"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3861, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}