{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4ODEyMjIx", "number": 6191, "title": "#6184 Fix - Handle massive images in DeckPicker Background", "bodyText": "Pull Request template\nPurpose / Description\nHandle massive images in DeckPicker Background\nFixes\nFixes #6184\nApproach\nReducing copied image size in AnkiDroid directory\nHow Has This Been Tested?\nTested on moto x4\n\nAnkdroid -> Setting -> Appearnce -> Background\nSelect an image with large size.\nFor ex:\n\nhttps://visibleearth.nasa.gov/images/73751/july-blue-marble-next-generation-w-topography-and-bathymetry\n\n\nImage get reduced in AnkiDroid folder.\n\n284 MB\nsize reduced to \n321 KB\n\n\nLearning (optional, can help others)\nhttps://android.jlelse.eu/loading-large-bitmaps-efficiently-in-android-66826cd4ad53\nhttps://stackoverflow.com/questions/18573774/how-to-reduce-an-image-file-size-before-uploading-to-a-server\nChecklist\nPlease, go through these checks before submitting the PR.\n\n[ x ] You have not changed whitespace unnecessarily (it makes diffs hard to read)\n[ x ] You have a descriptive commit message with a short title (first line, max 50 chars).\n[ x ] Your code follows the style of the project (e.g. never omit braces in if statements)\n[ x ] You have commented your code, particularly in hard-to-understand areas\n[ x ] You have performed a self-review of your own code", "createdAt": "2020-05-15T21:03:50Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6191", "merged": true, "mergeCommit": {"oid": "d8b60ad95911278c6d6fc9ad607c365e98f4badb"}, "closed": true, "closedAt": "2020-05-24T22:49:10Z", "author": {"login": "infinyte7"}, "timelineItems": {"totalCount": 46, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNhzaJgH2gAyNDE4ODEyMjIxOjNhNGEzMDFkYTNkY2E0ZjZhNDRlZGVmMjE5Mzk4OGJlZDE1MzE2YWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABckjeWZgFqTQxNzM5ODI0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3a4a301da3dca4f6a44edef2193988bed15316ad", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3a4a301da3dca4f6a44edef2193988bed15316ad", "committedDate": "2020-03-14T09:50:07Z", "message": "Add files via upload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e57c4ceca25bb1fec92ca743eaa98700966108f", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3e57c4ceca25bb1fec92ca743eaa98700966108f", "committedDate": "2020-03-15T09:39:50Z", "message": "Update card.js"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7e91bc09a085ffc129535442af8456f97f6dc80", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e7e91bc09a085ffc129535442af8456f97f6dc80", "committedDate": "2020-03-15T09:41:29Z", "message": "Update AbstractFlashcardViewer.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "366610142dc2b93fd4a54958878b9205a9d59f52", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/366610142dc2b93fd4a54958878b9205a9d59f52", "committedDate": "2020-03-15T15:52:38Z", "message": "Update AbstractFlashcardViewer.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7c5ec74a43504d5357e66dfec9b329a64c88c04f", "committedDate": "2020-03-15T15:55:06Z", "message": "Update card.js"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8041a93bb3249736811d14659250d93a9c76ca4", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f8041a93bb3249736811d14659250d93a9c76ca4", "committedDate": "2020-03-15T18:25:09Z", "message": "Update AbstractFlashcardViewer.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0f9331b5e8d518d7cbad7ac48cb0443c9384559", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f0f9331b5e8d518d7cbad7ac48cb0443c9384559", "committedDate": "2020-03-15T18:36:30Z", "message": "Update AbstractFlashcardViewer.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f4df32f4fe9551691ebe4117059d301c55fd9b4", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2f4df32f4fe9551691ebe4117059d301c55fd9b4", "committedDate": "2020-03-15T18:36:57Z", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bd146c9a8a58c5b01b73bae5400734b4e940f5b", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7bd146c9a8a58c5b01b73bae5400734b4e940f5b", "committedDate": "2020-03-17T12:05:33Z", "message": "Merge pull request #1 from ankidroid/master\n\nUpdate Ankidroid forked repo - DONE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38ccf485e82e8413146a979176eed3819481439d", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/38ccf485e82e8413146a979176eed3819481439d", "committedDate": "2020-04-01T06:36:27Z", "message": "Added localhost domain-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b6bcf3dc2e58fa384cc9a55c701c7f942e115ca", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2b6bcf3dc2e58fa384cc9a55c701c7f942e115ca", "committedDate": "2020-05-07T11:39:18Z", "message": "Merge pull request #2 from ankidroid/master\n\nUpdating Fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "465b0a20c6a12b8cae48c4825dcad000aba38688", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/465b0a20c6a12b8cae48c4825dcad000aba38688", "committedDate": "2020-05-07T18:41:31Z", "message": "Anki"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30863ff6ccd14c27375a786629d48a0175b991b6", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/30863ff6ccd14c27375a786629d48a0175b991b6", "committedDate": "2020-05-07T18:41:47Z", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7df6d450273f46b457b846f3a7daf7a19f61b52c", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7df6d450273f46b457b846f3a7daf7a19f61b52c", "committedDate": "2020-05-07T18:45:03Z", "message": "Merge pull request #3 from ankidroid/master\n\nRevert \"don't put \"undo\" to color enabled\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3045d9c618e2f3dc0cfe4f322b9b64d6de3498c", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e3045d9c618e2f3dc0cfe4f322b9b64d6de3498c", "committedDate": "2020-05-07T18:57:46Z", "message": "Update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "955285abd863193bf0c70ab1436ba7d9ec70c770", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/955285abd863193bf0c70ab1436ba7d9ec70c770", "committedDate": "2020-05-07T19:00:37Z", "message": "Update Preferences.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9ef4310bd195d21efbc9be8dd419cc4122a682a", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a9ef4310bd195d21efbc9be8dd419cc4122a682a", "committedDate": "2020-05-07T19:01:55Z", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91574092619fc3adc061e147930a4d565638d8ec", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/91574092619fc3adc061e147930a4d565638d8ec", "committedDate": "2020-05-07T19:03:35Z", "message": "Update preferences_appearance.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46d7fc5616561e625e72ee3164edfd27a7c19669", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/46d7fc5616561e625e72ee3164edfd27a7c19669", "committedDate": "2020-05-07T19:36:11Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae832792d6acce358da70329161103ba215cc98f", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ae832792d6acce358da70329161103ba215cc98f", "committedDate": "2020-05-08T05:52:44Z", "message": "update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25aac571d064bb849f01cfd59e895c2d8b13ce2c", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/25aac571d064bb849f01cfd59e895c2d8b13ce2c", "committedDate": "2020-05-08T06:02:46Z", "message": "Update DeckPicker.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "333008cf0e4b7eaa73c02d013f12e24e096e835e", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/333008cf0e4b7eaa73c02d013f12e24e096e835e", "committedDate": "2020-05-08T12:35:00Z", "message": "Background Image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5871b34b2f930a78e7146bdd4915eb5d2231e037", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5871b34b2f930a78e7146bdd4915eb5d2231e037", "committedDate": "2020-05-08T12:38:11Z", "message": "Update DeckPicker.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47a1c6f60e968142e6365f8438da3b7855d0234c", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/47a1c6f60e968142e6365f8438da3b7855d0234c", "committedDate": "2020-05-08T12:44:09Z", "message": "Update Preferences.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "829d14f4ae422a1a45a04980735caf75147a153a", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/829d14f4ae422a1a45a04980735caf75147a153a", "committedDate": "2020-05-08T12:48:30Z", "message": "Update DeckPicker.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e7d40de9633ad992bdc271f68857515ec934d2b", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5e7d40de9633ad992bdc271f68857515ec934d2b", "committedDate": "2020-05-08T13:00:59Z", "message": "Update 03-dialogs.xml\n\nPrefrences.java\n03-dialogs.xml\nUpdated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5a04d4e6144e98ebbae8fa816752aa0f0231ac4", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f5a04d4e6144e98ebbae8fa816752aa0f0231ac4", "committedDate": "2020-05-08T13:07:57Z", "message": "Update Preferences.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60a4ff0790aff50a34b21fb2ea498854e55574c3", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/60a4ff0790aff50a34b21fb2ea498854e55574c3", "committedDate": "2020-05-08T13:58:32Z", "message": "Update Preferences.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1d46028367f813c99febe0d3c13b4e87dad030b", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f1d46028367f813c99febe0d3c13b4e87dad030b", "committedDate": "2020-05-09T14:54:08Z", "message": "Update DeckPicker.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e60944353d6b9fc10ea86360db4ca4c9dbc6b7f7", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e60944353d6b9fc10ea86360db4ca4c9dbc6b7f7", "committedDate": "2020-05-09T22:05:49Z", "message": "deckpicker background image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dc19a5c833b782c107e408aa239b13ab71d995a", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3dc19a5c833b782c107e408aa239b13ab71d995a", "committedDate": "2020-05-09T22:52:51Z", "message": "update Deckpicker.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2ceb64bcc0ab6a6dbc4c2002976e7320845a2ae", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e2ceb64bcc0ab6a6dbc4c2002976e7320845a2ae", "committedDate": "2020-05-09T23:11:58Z", "message": "update 03-dialogs.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cabb8a314b16f550369db9e7cd203911655334ef", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/cabb8a314b16f550369db9e7cd203911655334ef", "committedDate": "2020-05-15T20:06:58Z", "message": "Update Preferences.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32c28a1a8112c2706eee554efdfcefbe2e0aa283", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/32c28a1a8112c2706eee554efdfcefbe2e0aa283", "committedDate": "2020-05-15T20:31:05Z", "message": "Update Fork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0841b85d6ea0e3b5506c9e3f50f7c23d480a347", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b0841b85d6ea0e3b5506c9e3f50f7c23d480a347", "committedDate": "2020-05-15T20:35:12Z", "message": "Merge pull request #6 from ankidroid/master\n\nFork Update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d93e935edcad218651be9576fad70b30f11652e", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1d93e935edcad218651be9576fad70b30f11652e", "committedDate": "2020-05-15T20:37:41Z", "message": "Update Preferences.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/81bc40bf310ca4da971f25b2b017f0d7b8564bf8", "committedDate": "2020-05-15T20:38:08Z", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTc3MjE4", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#pullrequestreview-412977218", "createdAt": "2020-05-15T21:25:07Z", "commit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyNTowN1rOGWUSRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyNTowN1rOGWUSRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NDIxNQ==", "bodyText": "Can you generalize this function and put it in BitmapUtils, like this one? https://github.com/ankidroid/Anki-Android/blob/master/AnkiDroid/src/main/java/com/ichi2/utils/BitmapUtil.java#L40\nEspecially important to pay attention to the error handling there, anything opened should be closed in a finally, for instance - also, is this potentially crunching the image too much? I actually have the blue marble as my desktop background and if I had selected that but then it got JPEG-blocked out with an overzealous crunch that I couldn't configure, I'd be less happy with it personally", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426054215", "createdAt": "2020-05-15T21:25:07Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTcwOTIx", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#pullrequestreview-412970921", "createdAt": "2020-05-15T21:11:51Z", "commit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToxMTo1MVrOGWT-sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToxNTozMVrOGWUEHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0OTIwMg==", "bodyText": "use try with resources", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426049202", "createdAt": "2020-05-15T21:11:51Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0OTM5MQ==", "bodyText": "Could we get a comment explaining the variable (what units?) Surely not pixels", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426049391", "createdAt": "2020-05-15T21:12:23Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);\n+            BitmapFactory.decodeStream(inputStream, null, bitmap);\n+            inputStream.close();\n+\n+            final int REQUIRED_SIZE=75;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0OTUxNg==", "bodyText": "This is a complex procedure, could you explain what it does, and why it does it in a comment (some at the call site, some inside the method)?", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426049516", "createdAt": "2020-05-15T21:12:43Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MDE3NQ==", "bodyText": "A toast is showed twice, once here, and once when null is returned", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426050175", "createdAt": "2020-05-15T21:14:31Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);\n+            BitmapFactory.decodeStream(inputStream, null, bitmap);\n+            inputStream.close();\n+\n+            final int REQUIRED_SIZE=75;\n+\n+            int scale = 1;\n+            while(bitmap.outWidth / scale / 2 >= REQUIRED_SIZE &&\n+                    bitmap.outHeight / scale / 2 >= REQUIRED_SIZE) {\n+                scale *= 2;\n+            }\n+\n+            BitmapFactory.Options bitmap2 = new BitmapFactory.Options();\n+            bitmap2.inSampleSize = scale;\n+            inputStream = new FileInputStream(file);\n+\n+            Bitmap selectedBitmap = BitmapFactory.decodeStream(inputStream, null, bitmap2);\n+            inputStream.close();\n+\n+            file.createNewFile();\n+\n+            FileOutputStream outputStream = new FileOutputStream(file);\n+\n+            selectedBitmap.compress(Bitmap.CompressFormat.JPEG, 100 , outputStream);\n+\n+            return file;\n+        } catch (Exception e) {\n+            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MDQxMQ==", "bodyText": "try with resources here as well", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426050411", "createdAt": "2020-05-15T21:15:07Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);\n+            BitmapFactory.decodeStream(inputStream, null, bitmap);\n+            inputStream.close();\n+\n+            final int REQUIRED_SIZE=75;\n+\n+            int scale = 1;\n+            while(bitmap.outWidth / scale / 2 >= REQUIRED_SIZE &&\n+                    bitmap.outHeight / scale / 2 >= REQUIRED_SIZE) {\n+                scale *= 2;\n+            }\n+\n+            BitmapFactory.Options bitmap2 = new BitmapFactory.Options();\n+            bitmap2.inSampleSize = scale;\n+            inputStream = new FileInputStream(file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1MDU4OQ==", "bodyText": "Also catch OutOfMemoryError here", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426050589", "createdAt": "2020-05-15T21:15:31Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -428,21 +430,68 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     try (FileChannel sourceChannel = new FileInputStream(sourceFile).getChannel();\n                          FileChannel destChannel = new FileOutputStream(destFile).getChannel()) {\n                         destChannel.transferFrom(sourceChannel, 0, sourceChannel.size());\n-                        UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+\n+                        File newImage = compressedImage(destFile);\n+\n+                        if (newImage != null) {\n+                            UIUtils.showThemedToast(this, getString(R.string.background_image_applied), false);\n+                        } else {\n+                            UIUtils.showThemedToast(this, getString(R.string.error_selecting_image), false);\n+                        }\n                     }\n                 } finally {\n                     if (cursor != null) {\n                         cursor.close();\n                     }\n                 }\n             } else {\n+                backgroundImage.setChecked(false);\n                 UIUtils.showThemedToast(this, getString(R.string.no_image_selected), false);\n             }\n         } catch (OutOfMemoryError | Exception e) {\n             UIUtils.showThemedToast(this, getString(R.string.error_selecting_image, e.getLocalizedMessage()), false);\n         }\n     }\n \n+    private File compressedImage(File file) {\n+        try {\n+            BitmapFactory.Options bitmap = new BitmapFactory.Options();\n+            bitmap.inJustDecodeBounds = true;\n+            bitmap.inSampleSize = 6;\n+\n+            FileInputStream inputStream = new FileInputStream(file);\n+            BitmapFactory.decodeStream(inputStream, null, bitmap);\n+            inputStream.close();\n+\n+            final int REQUIRED_SIZE=75;\n+\n+            int scale = 1;\n+            while(bitmap.outWidth / scale / 2 >= REQUIRED_SIZE &&\n+                    bitmap.outHeight / scale / 2 >= REQUIRED_SIZE) {\n+                scale *= 2;\n+            }\n+\n+            BitmapFactory.Options bitmap2 = new BitmapFactory.Options();\n+            bitmap2.inSampleSize = scale;\n+            inputStream = new FileInputStream(file);\n+\n+            Bitmap selectedBitmap = BitmapFactory.decodeStream(inputStream, null, bitmap2);\n+            inputStream.close();\n+\n+            file.createNewFile();\n+\n+            FileOutputStream outputStream = new FileOutputStream(file);\n+\n+            selectedBitmap.compress(Bitmap.CompressFormat.JPEG, 100 , outputStream);\n+\n+            return file;\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81bc40bf310ca4da971f25b2b017f0d7b8564bf8"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05bec673418481cd410d69c862de0b18222e8525", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/05bec673418481cd410d69c862de0b18222e8525", "committedDate": "2020-05-15T23:13:32Z", "message": "Update Preferences.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a92f1b79babe2513417d1e02372d883ca2e1c2f2", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a92f1b79babe2513417d1e02372d883ca2e1c2f2", "committedDate": "2020-05-16T04:08:11Z", "message": "Update 03-dialogs.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec5c80b5b361260a3516de3cf82b61b3bea166f", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9ec5c80b5b361260a3516de3cf82b61b3bea166f", "committedDate": "2020-05-16T04:13:37Z", "message": "Update 03-dialogs.xml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMDk3Mjkz", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#pullrequestreview-413097293", "createdAt": "2020-05-16T18:14:33Z", "commit": {"oid": "9ec5c80b5b361260a3516de3cf82b61b3bea166f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQxODoxNDozNFrOGWbz4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNlQxODoxNTo1MVrOGWb0cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE3NzUwNQ==", "bodyText": "Supply a format string so the variable can change without updating translations", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426177505", "createdAt": "2020-05-16T18:14:34Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -184,7 +184,8 @@\n     <string name=\"error_selecting_image\">Error selecting image. Please see manual. %s</string>\n     <string name=\"error_deleting_image\">Error deleting image</string>\n     <string name=\"failed_to_apply_background_image\">Failed to apply background image %s</string>\n-\n+    <string name=\"image_max_size_10_mb\">Maximum image size 10 MB allowed</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec5c80b5b361260a3516de3cf82b61b3bea166f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE3NzY0OA==", "bodyText": "consider moving this to a private static final String variable", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#discussion_r426177648", "createdAt": "2020-05-16T18:15:51Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Preferences.java", "diffHunk": "@@ -421,21 +421,30 @@ protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n                     String imgPathString = cursor.getString(columnIndex);\n                     File sourceFile = new File(imgPathString);\n \n+                    // file size in MB\n+                    long fileLength = sourceFile.length() / (1024 * 1024);\n+\n                     String currentAnkiDroidDirectory = CollectionHelper.getCurrentAnkiDroidDirectory(this);\n                     String imageName = \"DeckPickerBackground.png\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ec5c80b5b361260a3516de3cf82b61b3bea166f"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9d0b1d608e184048ac7baae6423accf2cbec87f", "author": {"user": {"login": "infinyte7", "name": "Mani"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e9d0b1d608e184048ac7baae6423accf2cbec87f", "committedDate": "2020-05-17T03:05:56Z", "message": "update preferences.java, 03-dialog.xml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3Mzk4MDY1", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#pullrequestreview-417398065", "createdAt": "2020-05-24T22:44:05Z", "commit": {"oid": "e9d0b1d608e184048ac7baae6423accf2cbec87f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3Mzk4MjQ5", "url": "https://github.com/ankidroid/Anki-Android/pull/6191#pullrequestreview-417398249", "createdAt": "2020-05-24T22:47:11Z", "commit": {"oid": "e9d0b1d608e184048ac7baae6423accf2cbec87f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3267, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}