{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMDkyNTA5", "number": 5830, "title": "Fix \"AnkiDroid directory is inaccessible\" Bug", "bodyText": "Purpose / Description\nThis bug has been pervasive for some time, and I logically believe that this change fixes it, although I haven't verified this empirically.\nA user accessing \"Advanced Settings\" would obtain an error: directory_inaccessible\nThis was caused by entering the settings, which set a hardcoded default value sdcard/AnkiDroid without validation which did not match getDefaultAnkiDroidDirectory()\nThis immediately kicks the user out the app and leaves them in a crash loop. They don't know what the actual value is meant to be (as they never saw the UI, so they can't easily fix it)\nFixes\nFixes #5097\nFixes #5510\nPartially Addresses #5346 (option can still be set if somehow preferences is the first entered screen, but I think that's logically impossible)\nApproach\nWe fix this by setting the preference when we try to access deckPath and the value is unset.\nHow Has This Been Tested?\nNot Tested \ud83d\uded1\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-03-17T21:42:23Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5830", "merged": true, "mergeCommit": {"oid": "6fda6387b2f86a0653a9be24b31601fd9a6d43bc"}, "closed": true, "closedAt": "2020-03-18T14:13:57Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOp6I7ABqjMxMzkxOTI5MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO_NgyAFqTM3NzI4NjQzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "466cf3b6ef88f4c815a86516c7b19070aad850aa", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/466cf3b6ef88f4c815a86516c7b19070aad850aa", "committedDate": "2020-03-17T21:39:14Z", "message": "Fix \"AnkiDroid directory is inaccessible\" Bug\n\nFixes #5097, #5510\nPartially Addresses #5346 (option can still be set if somehow\npreferences is the first entered screen, but I think that's\nlogically impossible)\n\nThis bug has been pervasive for some time, and I logically believe that\nthis change fixes it, although I haven't verified this empirically.\n\nA user accessing \"Advanced Settings\" would obtain an error:\ndirectory_inaccessible\n\nThis was caused by entering the settings, which set a hardcoded default\nvalue `sdcard/AnkiDroid` without validation which did not match\n`getDefaultAnkiDroidDirectory()`\n\nThis immediately kicks the user out the app and leaves them in a\ncrash loop. They don't know what the actual value is meant to be\n(as they never saw the UI, so they can't easily fix it)\n\nWe fix this by setting the preference when we try to access `deckPath`"}, "afterCommit": {"oid": "569515ae6a3e66aac0e5331371a2d332807ab395", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/569515ae6a3e66aac0e5331371a2d332807ab395", "committedDate": "2020-03-17T21:50:27Z", "message": "Fix \"AnkiDroid directory is inaccessible\" Bug\n\nFixes #5097, #5510\nPartially Addresses #5346 (option can still be set if somehow\npreferences is the first entered screen, but I think that's\nlogically impossible)\n\nThis bug has been pervasive for some time, and I logically believe that\nthis change fixes it, although I haven't verified this empirically.\n\nA user accessing \"Advanced Settings\" would obtain an error:\ndirectory_inaccessible\n\nThis was caused by entering the settings, which set a hardcoded default\nvalue `sdcard/AnkiDroid` without validation which did not match\n`getDefaultAnkiDroidDirectory()`\n\nThis immediately kicks the user out the app and leaves them in a\ncrash loop. They don't know what the actual value is meant to be\n(as they never saw the UI, so they can't easily fix it)\n\nWe fix this by setting the preference when we try to access `deckPath`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NDQzMzkx", "url": "https://github.com/ankidroid/Anki-Android/pull/5830#pullrequestreview-376443391", "createdAt": "2020-03-17T22:16:40Z", "commit": {"oid": "569515ae6a3e66aac0e5331371a2d332807ab395"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMjoxNjo0MFrOF3v-pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMjoxNjo0MFrOF3v-pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMjA4Nw==", "bodyText": "replace \"\" with anyString()", "url": "https://github.com/ankidroid/Anki-Android/pull/5830#discussion_r394002087", "createdAt": "2020-03-17T22:16:40Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/preferences/PreferenceExtensionsTest.java", "diffHunk": "@@ -0,0 +1,86 @@\n+package com.ichi2.preferences;\n+\n+import android.content.SharedPreferences;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.Mockito;\n+import org.powermock.modules.junit4.PowerMockRunner;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+//Unknown issue: @CheckResult should provide warnings on this class when return value is unused, but doesn't.\n+//TODO: The preference mock is messy\n+@RunWith(PowerMockRunner.class)\n+public class PreferenceExtensionsTest {\n+\n+    private static PreferenceExtensions.Supplier<String> UNUSED_SUPPLIER = () -> { throw new UnexpectedException();};\n+    private static PreferenceExtensions.Supplier<String> EXCEPTION_SUPPLIER = () -> { throw new ExpectedException();};\n+\n+    private static final String VALID_KEY = \"VALID\";\n+    private static final String VALID_RESULT = \"WAS VALID KEY\";\n+    private static final String MISSING_KEY = \"INVALID\";\n+    private static final String LAMBDA_RETURN = \"LAMBDA\";\n+\n+    @Mock\n+    private SharedPreferences mMockReferences;\n+\n+    @Mock\n+    private SharedPreferences.Editor mockEditor;\n+\n+    private String getOrSetString(String key, PreferenceExtensions.Supplier<String> supplier) {\n+        return PreferenceExtensions.getOrSetString(mMockReferences, key, supplier);\n+    }\n+\n+    @Before\n+    public void setUp() {\n+        Mockito.when(mMockReferences.contains(VALID_KEY)).thenReturn(true);\n+        Mockito.when(mMockReferences.getString(VALID_KEY, \"\")).thenReturn(VALID_RESULT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569515ae6a3e66aac0e5331371a2d332807ab395"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "569515ae6a3e66aac0e5331371a2d332807ab395", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/569515ae6a3e66aac0e5331371a2d332807ab395", "committedDate": "2020-03-17T21:50:27Z", "message": "Fix \"AnkiDroid directory is inaccessible\" Bug\n\nFixes #5097, #5510\nPartially Addresses #5346 (option can still be set if somehow\npreferences is the first entered screen, but I think that's\nlogically impossible)\n\nThis bug has been pervasive for some time, and I logically believe that\nthis change fixes it, although I haven't verified this empirically.\n\nA user accessing \"Advanced Settings\" would obtain an error:\ndirectory_inaccessible\n\nThis was caused by entering the settings, which set a hardcoded default\nvalue `sdcard/AnkiDroid` without validation which did not match\n`getDefaultAnkiDroidDirectory()`\n\nThis immediately kicks the user out the app and leaves them in a\ncrash loop. They don't know what the actual value is meant to be\n(as they never saw the UI, so they can't easily fix it)\n\nWe fix this by setting the preference when we try to access `deckPath`"}, "afterCommit": {"oid": "db10052a4c1f7230b3e29eee77df14ed7176ccfa", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/db10052a4c1f7230b3e29eee77df14ed7176ccfa", "committedDate": "2020-03-17T22:52:56Z", "message": "Fix \"AnkiDroid directory is inaccessible\" Bug\n\nFixes #5097, #5510\nPartially Addresses #5346 (option can still be set if somehow\npreferences is the first entered screen, but I think that's\nlogically impossible)\n\nThis bug has been pervasive for some time, and I logically believe that\nthis change fixes it, although I haven't verified this empirically.\n\nA user accessing \"Advanced Settings\" would obtain an error:\ndirectory_inaccessible\n\nThis was caused by entering the settings, which set a hardcoded default\nvalue `sdcard/AnkiDroid` without validation which did not match\n`getDefaultAnkiDroidDirectory()`\n\nThis immediately kicks the user out the app and leaves them in a\ncrash loop. They don't know what the actual value is meant to be\n(as they never saw the UI, so they can't easily fix it)\n\nWe fix this by setting the preference when we try to access `deckPath`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00fb61896e5f4321673a5a9d43f86ca3bff72604", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/00fb61896e5f4321673a5a9d43f86ca3bff72604", "committedDate": "2020-03-17T22:55:42Z", "message": "Fix \"AnkiDroid directory is inaccessible\" Bug\n\nFixes #5097, #5510\nPartially Addresses #5346 (option can still be set if somehow\npreferences is the first entered screen, but I think that's\nlogically impossible)\n\nThis bug has been pervasive for some time, and I logically believe that\nthis change fixes it, although I haven't verified this empirically.\n\nA user accessing \"Advanced Settings\" would obtain an error:\ndirectory_inaccessible\n\nThis was caused by entering the settings, which set a hardcoded default\nvalue `sdcard/AnkiDroid` without validation which did not match\n`getDefaultAnkiDroidDirectory()`\n\nThis immediately kicks the user out the app and leaves them in a\ncrash loop. They don't know what the actual value is meant to be\n(as they never saw the UI, so they can't easily fix it)\n\nWe fix this by setting the preference when we try to access `deckPath`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db10052a4c1f7230b3e29eee77df14ed7176ccfa", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/db10052a4c1f7230b3e29eee77df14ed7176ccfa", "committedDate": "2020-03-17T22:52:56Z", "message": "Fix \"AnkiDroid directory is inaccessible\" Bug\n\nFixes #5097, #5510\nPartially Addresses #5346 (option can still be set if somehow\npreferences is the first entered screen, but I think that's\nlogically impossible)\n\nThis bug has been pervasive for some time, and I logically believe that\nthis change fixes it, although I haven't verified this empirically.\n\nA user accessing \"Advanced Settings\" would obtain an error:\ndirectory_inaccessible\n\nThis was caused by entering the settings, which set a hardcoded default\nvalue `sdcard/AnkiDroid` without validation which did not match\n`getDefaultAnkiDroidDirectory()`\n\nThis immediately kicks the user out the app and leaves them in a\ncrash loop. They don't know what the actual value is meant to be\n(as they never saw the UI, so they can't easily fix it)\n\nWe fix this by setting the preference when we try to access `deckPath`"}, "afterCommit": {"oid": "00fb61896e5f4321673a5a9d43f86ca3bff72604", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/00fb61896e5f4321673a5a9d43f86ca3bff72604", "committedDate": "2020-03-17T22:55:42Z", "message": "Fix \"AnkiDroid directory is inaccessible\" Bug\n\nFixes #5097, #5510\nPartially Addresses #5346 (option can still be set if somehow\npreferences is the first entered screen, but I think that's\nlogically impossible)\n\nThis bug has been pervasive for some time, and I logically believe that\nthis change fixes it, although I haven't verified this empirically.\n\nA user accessing \"Advanced Settings\" would obtain an error:\ndirectory_inaccessible\n\nThis was caused by entering the settings, which set a hardcoded default\nvalue `sdcard/AnkiDroid` without validation which did not match\n`getDefaultAnkiDroidDirectory()`\n\nThis immediately kicks the user out the app and leaves them in a\ncrash loop. They don't know what the actual value is meant to be\n(as they never saw the UI, so they can't easily fix it)\n\nWe fix this by setting the preference when we try to access `deckPath`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NjI4MTMw", "url": "https://github.com/ankidroid/Anki-Android/pull/5830#pullrequestreview-376628130", "createdAt": "2020-03-18T07:51:36Z", "commit": {"oid": "00fb61896e5f4321673a5a9d43f86ca3bff72604"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNzo1MTozNlrOF35gXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNzo1MTozNlrOF35gXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE1ODE3Mg==", "bodyText": "Since the auto-review removed the discussion (and didn't flag it a second time).\nI don't like the Extensions[Helper/Util] suffix as Extensions is a subset of both. Happy to go with [Shared]Preference[Utils/Extensions]. Don't know the esosystem well enough to have a preference.", "url": "https://github.com/ankidroid/Anki-Android/pull/5830#discussion_r394158172", "createdAt": "2020-03-18T07:51:36Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/preferences/PreferenceExtensions.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.ichi2.preferences;\n+\n+import android.content.SharedPreferences;\n+\n+import androidx.annotation.CheckResult;\n+import androidx.annotation.NonNull;\n+\n+/** Extension methods over the SharedPreferences class */\n+public class PreferenceExtensions {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00fb61896e5f4321673a5a9d43f86ca3bff72604"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2OTAyNDYx", "url": "https://github.com/ankidroid/Anki-Android/pull/5830#pullrequestreview-376902461", "createdAt": "2020-03-18T14:13:44Z", "commit": {"oid": "00fb61896e5f4321673a5a9d43f86ca3bff72604"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3Mjg2NDMw", "url": "https://github.com/ankidroid/Anki-Android/pull/5830#pullrequestreview-377286430", "createdAt": "2020-03-18T22:39:47Z", "commit": {"oid": "00fb61896e5f4321673a5a9d43f86ca3bff72604"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjozOTo0N1rOF4ZW5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjozOTo0N1rOF4ZW5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY4MDAzOA==", "bodyText": "\ud83d\udc1e @FunctionalInterface is apparently only available in API 24. I don't quite understand this, so I'm not sure if it's a bug, but flagging for testing.\nhttps://developer.android.com/studio/write/java8-support", "url": "https://github.com/ankidroid/Anki-Android/pull/5830#discussion_r394680038", "createdAt": "2020-03-18T22:39:47Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/preferences/PreferenceExtensions.java", "diffHunk": "@@ -0,0 +1,32 @@\n+package com.ichi2.preferences;\n+\n+import android.content.SharedPreferences;\n+\n+import androidx.annotation.CheckResult;\n+import androidx.annotation.NonNull;\n+\n+/** Extension methods over the SharedPreferences class */\n+public class PreferenceExtensions {\n+\n+    /**\n+     * Returns the string value specified by the key, or sets key to the result of the lambda and returns it.<br/>\n+     * This is not designed to be used when bulk editing preferences.<br/>\n+     * Defect #5828 - This is potentially not thread safe and could cause another preference commit to fail.\n+     */\n+    @CheckResult //Not truly an error as this has a side effect, but you should use a \"set\" API for perf.\n+    public static String getOrSetString(@NonNull SharedPreferences target, @NonNull String key, @NonNull Supplier<String> supplier) {\n+        if (target.contains(key)) {\n+            //the default Is never returned. The value might be able be optimised, but the Android API should be better.\n+            return target.getString(key, \"\");\n+        }\n+        String supplied = supplier.get();\n+        target.edit().putString(key, supplied).apply();\n+        return supplied;\n+    }\n+\n+    /** TODO: Move this to Supplier in API 24 */\n+    @FunctionalInterface", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00fb61896e5f4321673a5a9d43f86ca3bff72604"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3520, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}