{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MDg2NzEw", "number": 6457, "reviewThreads": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwODo1NjoxNlrOEFTg3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToyNjoxMFrOEFV8Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4MDQ3OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwODo1NjoxNlrOGjbs-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNToyOTozN1rOGjdw_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzIyNw==", "bodyText": "This implies that there is an issue in one of the format strings. Definitely don't suppress here.\nEDIT: I tried a PR to turn this into a lint fail, but it didn't fail here.\nLooks like an issue with values_ti where someone translated our comment literally:\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/res/values-ti/01-core.xml\n    \n    \n        Lines 138 to 140\n      in\n      9595b84\n    \n    \n    \n    \n\n        \n          \n               <string name=\"time_quantity_seconds\">\u130d\u12dc_\u1265\u12dd\u1212_\u12ab\u120d\u12a2\u1273\u1275 \n        \n\n        \n          \n           \u1265\u12dd\u1212 \u130d\u12dc \u1218\u12d0\u1250\u1292 \u1293\u12ed \u130d\u12dc \u12a5\u12ee\u121d\u1362\u1265\u12d8\u12ed \u121d\u1265\u12db\u1215\u1295 \u1265\u12d8\u12ed \u1290\u1320\u1265\u1295 \u12a8\u12a3 \u1295\u1325\u1240\u1218\u120e\u121d\u1362 \n        \n\n        \n          \n           s,min,h,d, \u12a5\u12da\u12a6\u121d \u12a8\u121d \u120d\u1219\u12f5(ISO 31-1) \u1218\u12d0\u1240\u1292\u1273\u1275 \u12a8\u121d\u12a1 \u12cd\u1295 \u12ad\u1275\u122d\u130e\u1219 \u12d8\u12ed\u12ad\u12a5\u1209 \u12a2\u12ee\u121d \u1265\u12cd\u1211\u12f1 \u1295 \u124b\u1295\u124b \u1265 \u120b\u1272\u1295 \u1218\u1235\u122d\u1215 \u1243\u120b\u1275\u1362</string> \n        \n    \n  \n\n\nI've fixed the translation", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439807227", "createdAt": "2020-06-14T08:56:16Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -138,6 +141,7 @@ public static long intTime(int scale) {\n      * @return The time quantity string. Something like \"3 s\" or \"1.7\n      * yr\". Only months and year have a number after the decimal.\n      */\n+    @SuppressLint(\"StringFormatInvalid\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MTAyMA==", "bodyText": "Interesting that we weren't able to get signal from lint on that. Could you open a separate issue about that with what you tried? Should do a full codebase grep on the suppresslint I slapped on there to make sure it's removed everywhere. Then perhaps the linter needs configuration like which resources to load or something (I don't know...) but if Android Studio is able to see it, we should be able to do it on the command line, so it should be possible in Travis...", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439841020", "createdAt": "2020-06-14T15:29:37Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -138,6 +141,7 @@ public static long intTime(int scale) {\n      * @return The time quantity string. Something like \"3 s\" or \"1.7\n      * yr\". Only months and year have a number after the decimal.\n      */\n+    @SuppressLint(\"StringFormatInvalid\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzIyNw=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4NDIyOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOTowMzowN1rOGjbvJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToyMjowOFrOGje6nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzc4MA==", "bodyText": "I've wanted to look into this for a while, as it makes stack traces harder to reason about.\nIt's the endTransacttion which throws, so I'd presumed that you should be able to get away with mDst.getDb().getDatabase().inTransaction() without the try..catch. Is this not the case?", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439807780", "createdAt": "2020-06-14T09:03:07Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -147,13 +147,33 @@ private void _import() {\n             publishProgress(100, 100, 50);\n             mDst.getDb().getDatabase().setTransactionSuccessful();\n             mDst.getMedia().getDb().getDatabase().setTransactionSuccessful();\n+        } catch (Exception err) {\n+            Timber.e(err, \"_import() exception\");\n+            throw err;\n         } finally {\n-            mDst.getDb().getDatabase().endTransaction();\n-            mDst.getMedia().getDb().getDatabase().endTransaction();\n+            // These methods throw about invalid transaction even when you try!\n+            if (mDst.getDb().getDatabase().inTransaction()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzNjUzMA==", "bodyText": "Nope. Throws anyway. Thus the note.", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439836530", "createdAt": "2020-06-14T14:39:47Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -147,13 +147,33 @@ private void _import() {\n             publishProgress(100, 100, 50);\n             mDst.getDb().getDatabase().setTransactionSuccessful();\n             mDst.getMedia().getDb().getDatabase().setTransactionSuccessful();\n+        } catch (Exception err) {\n+            Timber.e(err, \"_import() exception\");\n+            throw err;\n         } finally {\n-            mDst.getDb().getDatabase().endTransaction();\n-            mDst.getMedia().getDb().getDatabase().endTransaction();\n+            // These methods throw about invalid transaction even when you try!\n+            if (mDst.getDb().getDatabase().inTransaction()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzc4MA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTg2OQ==", "bodyText": "Comment wasn't clear for me (try was ambiguous), could we extract this to a Utils class of some sort, as it'll be needed everywhere.\nAlternately, could make a runInTrnasaction method now we have lambdas. But that might be gold-plating", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859869", "createdAt": "2020-06-14T19:22:08Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -147,13 +147,33 @@ private void _import() {\n             publishProgress(100, 100, 50);\n             mDst.getDb().getDatabase().setTransactionSuccessful();\n             mDst.getMedia().getDb().getDatabase().setTransactionSuccessful();\n+        } catch (Exception err) {\n+            Timber.e(err, \"_import() exception\");\n+            throw err;\n         } finally {\n-            mDst.getDb().getDatabase().endTransaction();\n-            mDst.getMedia().getDb().getDatabase().endTransaction();\n+            // These methods throw about invalid transaction even when you try!\n+            if (mDst.getDb().getDatabase().inTransaction()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzc4MA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4NTg4OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOTowNjoxNFrOGjbwEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNzoxMjo1MlrOGjeTVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODAxOA==", "bodyText": "The point of executeMany is to perform a for loop in a transaction. We've lost the transaction by moving the logic outside.\nHave you considered turning this into an iterator, so we can keep the current structure, keep a low memory profile and retain the transaction behaviour", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808018", "createdAt": "2020-06-14T09:06:14Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzNjczMQ==", "bodyText": "Nope. Was just ferrying 2 year old code from 5 year old bugs into a PR that works for the stated problem. Transaction semantics weren't investigated. I'll look at it a bit maybe executemany can be made aware of existing transactions", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439836731", "createdAt": "2020-06-14T14:42:09Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODAxOA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0OTgxMg==", "bodyText": "I externalized the txn mgmt in that area", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439849812", "createdAt": "2020-06-14T17:12:52Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODAxOA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4NzI0OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOTowODowOVrOGjbwxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNTozNDo1NFrOGjdzEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODE5OA==", "bodyText": "Nit: These concatenations inside Timber should be showing lint warnings to use format strings", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808198", "createdAt": "2020-06-14T09:08:09Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){\n+                    totalAddSize  += add.size();\n+                    mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", add);\n+                    add.clear();\n+                    Timber.d(\"add notes: \"+totalAddSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MTIxNA==", "bodyText": "I used to get those as well. I also remember Timber lint rules showing some sort of internal linter versioning deprecation, and now they don't work - I wonder if Android Studio upgrade broke that? Timber unfortunately non-responsive at the moment though that maintainer is typically thorough \ud83e\udd14 JakeWharton/timber#391", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439841214", "createdAt": "2020-06-14T15:31:36Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){\n+                    totalAddSize  += add.size();\n+                    mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", add);\n+                    add.clear();\n+                    Timber.d(\"add notes: \"+totalAddSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODE5OA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0MTU1NA==", "bodyText": "Actually, it showed up as lint in the IDE in another area. Some IDE artifact. Anyway, changing them all to formatting now", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439841554", "createdAt": "2020-06-14T15:34:54Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){\n+                    totalAddSize  += add.size();\n+                    mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", add);\n+                    add.clear();\n+                    Timber.d(\"add notes: \"+totalAddSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODE5OA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4ODQxOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMDozMlrOGjbxdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNjoxODoxMFrOGjeB-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODM3NA==", "bodyText": "Could you change size for count here. Size (to me) implies a file size.", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808374", "createdAt": "2020-06-14T09:10:32Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -264,9 +317,15 @@ private void _importNotes() {\n                 cur.close();\n             }\n         }\n+\n+        // summarize partial add/update/dirty results for total values\n+        totalAddSize += add.size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0Mzk0OA==", "bodyText": "No, size is not a method on ArrayList.", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439843948", "createdAt": "2020-06-14T16:02:04Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -264,9 +317,15 @@ private void _importNotes() {\n                 cur.close();\n             }\n         }\n+\n+        // summarize partial add/update/dirty results for total values\n+        totalAddSize += add.size();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODM3NA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NDgxMw==", "bodyText": "I was referring to the variable name, but implementer's choice", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439844813", "createdAt": "2020-06-14T16:11:46Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -264,9 +317,15 @@ private void _importNotes() {\n                 cur.close();\n             }\n         }\n+\n+        // summarize partial add/update/dirty results for total values\n+        totalAddSize += add.size();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODM3NA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NTM3MA==", "bodyText": "Ah! Sure. Still in there haven't pushed the NF whitespace commit", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439845370", "createdAt": "2020-06-14T16:18:10Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -264,9 +317,15 @@ private void _importNotes() {\n                 cur.close();\n             }\n         }\n+\n+        // summarize partial add/update/dirty results for total values\n+        totalAddSize += add.size();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODM3NA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4ODc0OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMDo1N1rOGjbxog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNDo0MzowNFrOGjdgqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQxOA==", "bodyText": "nit: whitespace", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808418", "createdAt": "2020-06-14T09:10:57Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -307,7 +369,6 @@ private boolean _uniquifyNote(Object[] note) {\n \t\treturn false;\n     }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzNjg0Mw==", "bodyText": "I'll do one nf commit for whitespace and formatting but I wanted to leave the original commit intact as respect for the OP", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439836843", "createdAt": "2020-06-14T14:43:04Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -307,7 +369,6 @@ private boolean _uniquifyNote(Object[] note) {\n \t\treturn false;\n     }\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQxOA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 131}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4OTA0OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMToxN1rOGjbxwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMToxN1rOGjbxwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQ0OA==", "bodyText": "nit: whitespace", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808448", "createdAt": "2020-06-14T09:11:17Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -205,6 +231,8 @@ private void _importNotes() {\n             int onePercent = total/100;\n             int i = 0;\n \n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4OTIzOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMTozNlrOGjbx2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMTozNlrOGjbx2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQ3NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(cards.size() > thresExecCards){\n          \n          \n            \n                            if (cards.size() > thresExecCards){", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808474", "createdAt": "2020-06-14T09:11:36Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially\n+                if(cards.size() > thresExecCards){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 153}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4OTQzOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMTo0OVrOGjbx8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMTo0OVrOGjbx8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQ5Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(revlog.size() > thresExecRevlog){\n          \n          \n            \n                            if (revlog.size() > thresExecRevlog){", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808496", "createdAt": "2020-06-14T09:11:49Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially\n+                if(cards.size() > thresExecCards){\n+                    totalCardsSize += cards.size();\n+                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                    cards.clear();\n+                    Timber.d(\"add cards: \"+totalCardsSize);\n+                }\n+                // apply revlog changes partially\n+                if(revlog.size() > thresExecRevlog){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 160}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk4OTY1OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMjowN1rOGjbyDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNjowMzo1NVrOGjd88A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODUyNg==", "bodyText": "This logic seems duplicated, can we combine it?", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808526", "createdAt": "2020-06-14T09:12:07Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NDA4MA==", "bodyText": "No, they increment independently each card can have many revisions, and the revisions might cause OOM before cards would get there, or vice versa.", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439844080", "createdAt": "2020-06-14T16:03:55Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODUyNg=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 152}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk5MDQ0OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMzo0MlrOGjbygw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxMzo0MlrOGjbygw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODY0Mw==", "bodyText": "Optional: could we move these two lines next to each other so it's obvious the spacing is for output purposes.", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808643", "createdAt": "2020-06-14T09:13:42Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                Timber.d(\"Total uncompressed size will be: \" + uncompressedSize);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total available size is:         \" + availableSpace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk5MjI5OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxNjoyMlrOGjbzbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxNjoyMlrOGjbzbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODg3Ng==", "bodyText": "various nitpicks on the placement of the plus\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Timber.d(\"add cards: \"+totalCardsSize);\n          \n          \n            \n                                Timber.d(\"add cards: \"+ totalCardsSize);", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808876", "createdAt": "2020-06-14T09:16:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially\n+                if(cards.size() > thresExecCards){\n+                    totalCardsSize += cards.size();\n+                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                    cards.clear();\n+                    Timber.d(\"add cards: \"+totalCardsSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 157}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTk5MjY2OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxNjo1N1rOGjbzmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxNjo1N1rOGjbzmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODkyMg==", "bodyText": "Definitely better with string formatting on this one", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808922", "createdAt": "2020-06-14T09:16:57Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                Timber.d(\"Total uncompressed size will be: \" + uncompressedSize);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total available size is:         \" + availableSpace);\n+                if (uncompressedSize > availableSpace) {\n+                    Timber.e(\"Not enough space to unzip, need \" + uncompressedSize + \", available \" + availableSpace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDM3MzI4OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToxNjo0NVrOGje5Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNjowMDozMlrOGj4rWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTQ4Nw==", "bodyText": "Are these d or v? could have 30000 notes in a collection", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859487", "createdAt": "2020-06-14T19:16:45Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,39 +279,84 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() >= thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n+                    add.clear();\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (update.size() >= thresExecUpdate){\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (dirty.size() >= thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                   long[] das = Utils.arrayList2array(dirty);\n+                    mDst.updateFieldCache(das);\n+                    mDst.getTags().registerNotes(das);\n+                    dirty.clear();\n+                    Timber.d(\"dirty notes: %d\", totalDirtyCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3NDIzNQ==", "bodyText": "There were well over that number of notes in the OOM zip I was testing and %d had no problem handling it? I'll investigate", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r440274235", "createdAt": "2020-06-15T15:49:21Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,39 +279,84 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() >= thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n+                    add.clear();\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (update.size() >= thresExecUpdate){\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (dirty.size() >= thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                   long[] das = Utils.arrayList2array(dirty);\n+                    mDst.updateFieldCache(das);\n+                    mDst.getTags().registerNotes(das);\n+                    dirty.clear();\n+                    Timber.d(\"dirty notes: %d\", totalDirtyCount);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTQ4Nw=="}, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4MTk0NQ==", "bodyText": "I see no 'v' possibility for String.format which is used by Timber internally and then delegates to java.util.Formatter https://developer.android.com/reference/java/util/Formatter#conversions which seems as though it can handle any number you throw at it, and matches my testing experience - no problem with this Timber line", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r440281945", "createdAt": "2020-06-15T16:00:32Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,39 +279,84 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() >= thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n+                    add.clear();\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (update.size() >= thresExecUpdate){\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (dirty.size() >= thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                   long[] das = Utils.arrayList2array(dirty);\n+                    mDst.updateFieldCache(das);\n+                    mDst.getTags().registerNotes(das);\n+                    dirty.clear();\n+                    Timber.d(\"dirty notes: %d\", totalDirtyCount);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTQ4Nw=="}, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDM3MzQxOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToxNjo1N1rOGje5LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToxNjo1N1rOGje5LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTUwMQ==", "bodyText": "Nittiest of nits\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                               long[] das = Utils.arrayList2array(dirty);\n          \n          \n            \n                                long[] das = Utils.arrayList2array(dirty);", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859501", "createdAt": "2020-06-14T19:16:57Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,39 +279,84 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() >= thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n+                    add.clear();\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (update.size() >= thresExecUpdate){\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (dirty.size() >= thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                   long[] das = Utils.arrayList2array(dirty);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDM3Njk0OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToyMzo1NFrOGje7CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToyMzo1NFrOGje7CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTk3Ng==", "bodyText": "Much nicer, thanks", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859976", "createdAt": "2020-06-14T19:23:54Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total uncompressed size will be: %d\", uncompressedSize);\n+                Timber.d(\"Total available size is:         %d\", availableSpace);\n+                if (uncompressedSize > availableSpace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDM3ODI2OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToyNjoxMFrOGje7vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToyNjoxMFrOGje7vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2MDE1Nw==", "bodyText": "There may be bugs in determineBytesAvailable: #6442 (could also be my issue).\nIf so, do we need a way to override?", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439860157", "createdAt": "2020-06-14T19:26:10Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total uncompressed size will be: %d\", uncompressedSize);\n+                Timber.d(\"Total available size is:         %d\", availableSpace);\n+                if (uncompressedSize > availableSpace) {\n+                    Timber.e(\"Not enough space to unzip, need %d, available %d\", uncompressedSize, availableSpace);\n+                    mLog.add(getRes().getString(R.string.import_log_insufficient_space, uncompressedSize, availableSpace));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 189, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}