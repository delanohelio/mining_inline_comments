{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0ODgwMjcz", "number": 6849, "title": "NF: add a class CardCache", "bodyText": "I realized the Card Cache from #6372 can be useful for other purpose too. So I extracted its core in a distinct PR and put the Cache in Card.java. Currently this is NF because this class is not used. I would still like that you confirm that it's a nice way to save card without loading them until needed, but still loading only once. I expect that it will save loading time from database.\nThere is a cost however, because if the card is loaded in advance and the card content changed, the new question/answer may or may not be already computed. So it should not be used in every circonstances", "createdAt": "2020-08-07T23:31:40Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6849", "merged": true, "mergeCommit": {"oid": "8fd0e4a708c7201a42b1eeabb55897f9455c0d28"}, "closed": true, "closedAt": "2020-08-13T17:36:31Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8tOEbABqjM2MzUwOTM5ODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-jkxrAFqTQ2Njk4OTA0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0565cd588cf562b7e83fd95283eda8b99852754c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0565cd588cf562b7e83fd95283eda8b99852754c", "committedDate": "2020-08-07T23:28:49Z", "message": "NF: add a class CardCache"}, "afterCommit": {"oid": "adf5b2e6db2ecbac77c3f73ee9b89c889b0ec4df", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/adf5b2e6db2ecbac77c3f73ee9b89c889b0ec4df", "committedDate": "2020-08-07T23:42:31Z", "message": "NF: add a class CardCache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adf5b2e6db2ecbac77c3f73ee9b89c889b0ec4df", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/adf5b2e6db2ecbac77c3f73ee9b89c889b0ec4df", "committedDate": "2020-08-07T23:42:31Z", "message": "NF: add a class CardCache"}, "afterCommit": {"oid": "15908fdd598f3c8fa143d62725165d8567666965", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/15908fdd598f3c8fa143d62725165d8567666965", "committedDate": "2020-08-07T23:43:33Z", "message": "NF: add a class CardCache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15908fdd598f3c8fa143d62725165d8567666965", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/15908fdd598f3c8fa143d62725165d8567666965", "committedDate": "2020-08-07T23:43:33Z", "message": "NF: add a class CardCache"}, "afterCommit": {"oid": "282a450ef6273bc5a0a917afbb8dc592c2343b0d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/282a450ef6273bc5a0a917afbb8dc592c2343b0d", "committedDate": "2020-08-08T00:03:09Z", "message": "NF: Sched uses Card cache in queue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "257cd5bba6c97ee6ff6052134fc861f49a5737af", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/257cd5bba6c97ee6ff6052134fc861f49a5737af", "committedDate": "2020-08-08T00:20:48Z", "message": "NF: loadQA in card cache"}, "afterCommit": {"oid": "6de38dcaf09fc87a2e9b67ba26586bf0d4ad14f8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6de38dcaf09fc87a2e9b67ba26586bf0d4ad14f8", "committedDate": "2020-08-08T00:03:08Z", "message": "NF: add a class CardCache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a48dcd87a462bc2b58911c83cecbe4d92bbb41d2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a48dcd87a462bc2b58911c83cecbe4d92bbb41d2", "committedDate": "2020-08-08T01:05:00Z", "message": "NF: loadQA directly from CardCache"}, "afterCommit": {"oid": "483a988320ff58f524af3d64cdf51f8b51487087", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/483a988320ff58f524af3d64cdf51f8b51487087", "committedDate": "2020-08-13T00:31:22Z", "message": "NF: loadQA directly from CardCache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "483a988320ff58f524af3d64cdf51f8b51487087", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/483a988320ff58f524af3d64cdf51f8b51487087", "committedDate": "2020-08-13T00:31:22Z", "message": "NF: loadQA directly from CardCache"}, "afterCommit": {"oid": "843b5f5e902a038158349abb4260de2336372932", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/843b5f5e902a038158349abb4260de2336372932", "committedDate": "2020-08-13T00:34:09Z", "message": "NF: loadQA directly from CardCache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "843b5f5e902a038158349abb4260de2336372932", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/843b5f5e902a038158349abb4260de2336372932", "committedDate": "2020-08-13T00:34:09Z", "message": "NF: loadQA directly from CardCache"}, "afterCommit": {"oid": "e855eac92561032d29ced8838db401141ecc7ea7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e855eac92561032d29ced8838db401141ecc7ea7", "committedDate": "2020-08-13T00:36:07Z", "message": "NF: loadQA directly from CardCache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2Mzg1NTIz", "url": "https://github.com/ankidroid/Anki-Android/pull/6849#pullrequestreview-466385523", "createdAt": "2020-08-13T01:25:20Z", "commit": {"oid": "e855eac92561032d29ced8838db401141ecc7ea7"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwMToyNToyMFrOG_4tVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwMToyNTo0MVrOG_4uNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY0MjU4Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private Card mCard;\n          \n          \n            \n                    @Nullable\n          \n          \n            \n                    private Card mCard;", "url": "https://github.com/ankidroid/Anki-Android/pull/6849#discussion_r469642583", "createdAt": "2020-08-13T01:25:20Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Card.java", "diffHunk": "@@ -715,4 +715,101 @@ public boolean isReview() {\n     public boolean isNew() {\n         return this.getType() == Consts.CARD_TYPE_NEW;\n     }\n+\n+    /** A cache represents an intermediary step between a card id and a card object. Creating a Card has some fixed cost\n+     * in term of database access. Using an id has an unknown cost: none if the card is never accessed, heavy if the\n+     * card is accessed a lot of time. CardCache ensure that the cost is paid at most once, by waiting for first access\n+     * to load the data, and then saving them. Since CPU and RAM is usually less of a bottleneck than database access,\n+     * it may often be worth using this cache.\n+     *\n+     * Beware that the card is loaded only once. Change in the database are not reflected, so use it only if you can\n+     * safely assume that the card has not changed. That is\n+     * long id;\n+     * Card card = col.getCard(id);\n+     * ....\n+     * Card card2 = col.getCard(id);\n+     * is not equivalent to\n+     * long id;\n+     * Card.Cache cache = new Cache(col, id);\n+     * Card card = cache.getCard();\n+     * ....\n+     * Card card2 = cache.getCard();\n+     *\n+     * It is equivalent to:\n+     * long id;\n+     * Card.Cache cache = new Cache(col, id);\n+     * Card card = cache.getCard();\n+     * ....\n+     * cache.releoad();\n+     * Card card2 = cache.getCard();\n+     */\n+    public static class Cache implements Cloneable {\n+        private final Collection mCol;\n+        private final long mId;\n+        private Card mCard;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e855eac92561032d29ced8838db401141ecc7ea7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY0MjgwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private final Collection mCol;\n          \n          \n            \n                    @NonNull\n          \n          \n            \n                    private final Collection mCol;", "url": "https://github.com/ankidroid/Anki-Android/pull/6849#discussion_r469642804", "createdAt": "2020-08-13T01:25:41Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Card.java", "diffHunk": "@@ -715,4 +715,101 @@ public boolean isReview() {\n     public boolean isNew() {\n         return this.getType() == Consts.CARD_TYPE_NEW;\n     }\n+\n+    /** A cache represents an intermediary step between a card id and a card object. Creating a Card has some fixed cost\n+     * in term of database access. Using an id has an unknown cost: none if the card is never accessed, heavy if the\n+     * card is accessed a lot of time. CardCache ensure that the cost is paid at most once, by waiting for first access\n+     * to load the data, and then saving them. Since CPU and RAM is usually less of a bottleneck than database access,\n+     * it may often be worth using this cache.\n+     *\n+     * Beware that the card is loaded only once. Change in the database are not reflected, so use it only if you can\n+     * safely assume that the card has not changed. That is\n+     * long id;\n+     * Card card = col.getCard(id);\n+     * ....\n+     * Card card2 = col.getCard(id);\n+     * is not equivalent to\n+     * long id;\n+     * Card.Cache cache = new Cache(col, id);\n+     * Card card = cache.getCard();\n+     * ....\n+     * Card card2 = cache.getCard();\n+     *\n+     * It is equivalent to:\n+     * long id;\n+     * Card.Cache cache = new Cache(col, id);\n+     * Card card = cache.getCard();\n+     * ....\n+     * cache.releoad();\n+     * Card card2 = cache.getCard();\n+     */\n+    public static class Cache implements Cloneable {\n+        private final Collection mCol;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e855eac92561032d29ced8838db401141ecc7ea7"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2Mzg1ODkz", "url": "https://github.com/ankidroid/Anki-Android/pull/6849#pullrequestreview-466385893", "createdAt": "2020-08-13T01:26:47Z", "commit": {"oid": "e855eac92561032d29ced8838db401141ecc7ea7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwMToyNjo0N1rOG_4xCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwMToyNjo0N1rOG_4xCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY0MzUzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * cache.releoad();\n          \n          \n            \n                 * cache.reload();", "url": "https://github.com/ankidroid/Anki-Android/pull/6849#discussion_r469643530", "createdAt": "2020-08-13T01:26:47Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Card.java", "diffHunk": "@@ -715,4 +715,101 @@ public boolean isReview() {\n     public boolean isNew() {\n         return this.getType() == Consts.CARD_TYPE_NEW;\n     }\n+\n+    /** A cache represents an intermediary step between a card id and a card object. Creating a Card has some fixed cost\n+     * in term of database access. Using an id has an unknown cost: none if the card is never accessed, heavy if the\n+     * card is accessed a lot of time. CardCache ensure that the cost is paid at most once, by waiting for first access\n+     * to load the data, and then saving them. Since CPU and RAM is usually less of a bottleneck than database access,\n+     * it may often be worth using this cache.\n+     *\n+     * Beware that the card is loaded only once. Change in the database are not reflected, so use it only if you can\n+     * safely assume that the card has not changed. That is\n+     * long id;\n+     * Card card = col.getCard(id);\n+     * ....\n+     * Card card2 = col.getCard(id);\n+     * is not equivalent to\n+     * long id;\n+     * Card.Cache cache = new Cache(col, id);\n+     * Card card = cache.getCard();\n+     * ....\n+     * Card card2 = cache.getCard();\n+     *\n+     * It is equivalent to:\n+     * long id;\n+     * Card.Cache cache = new Cache(col, id);\n+     * Card card = cache.getCard();\n+     * ....\n+     * cache.releoad();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e855eac92561032d29ced8838db401141ecc7ea7"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e4f071591af7d35c0de3c2c039b490aa379ab7b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7e4f071591af7d35c0de3c2c039b490aa379ab7b", "committedDate": "2020-08-13T01:32:18Z", "message": "NF: add a class CardCache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e855eac92561032d29ced8838db401141ecc7ea7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e855eac92561032d29ced8838db401141ecc7ea7", "committedDate": "2020-08-13T00:36:07Z", "message": "NF: loadQA directly from CardCache"}, "afterCommit": {"oid": "7e4f071591af7d35c0de3c2c039b490aa379ab7b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7e4f071591af7d35c0de3c2c039b490aa379ab7b", "committedDate": "2020-08-13T01:32:18Z", "message": "NF: add a class CardCache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2OTg5MDQ4", "url": "https://github.com/ankidroid/Anki-Android/pull/6849#pullrequestreview-466989048", "createdAt": "2020-08-13T17:36:14Z", "commit": {"oid": "7e4f071591af7d35c0de3c2c039b490aa379ab7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2895, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}