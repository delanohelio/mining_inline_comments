{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxODcyNDY1", "number": 5848, "title": "#5740 - Add Welcome Dialog Explaining Permissions", "bodyText": "Purpose / Description\nSome users din't feel comfortable about us requiring access to external storage.\nFixes\nFixes #5740\nApproach\nWe add a dialog explaining that we don't perform any malicious activities with this in order to hopefully alleviate concerns.\nHow Has This Been Tested?\n\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-03-21T15:24:08Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5848", "merged": true, "mergeCommit": {"oid": "bf4ce65d58f50df5bfb2c7065ceac45e0fe99ee8"}, "closed": true, "closedAt": "2020-03-21T19:59:50Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcP34kngFqTM3ODkzMTA5NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcP4uvagBqjMxNTE5MzU4MTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4OTMxMDk0", "url": "https://github.com/ankidroid/Anki-Android/pull/5848#pullrequestreview-378931094", "createdAt": "2020-03-21T16:28:19Z", "commit": {"oid": "e86bec7cabfc43a7f190ae9f0173d1a39b4f97f4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNjoyODoxOVrOF5qUcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNjo0MDo1M1rOF5qYWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwNjUxMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"collection_load_welcome_request_permissions_details\">We require storage access to store your AnkiDroid collection, including media and backups. We do not access any of your media or files. Our code is open-source, written by volunteers, and trusted by millions.\\n\\nIf you have any questions, please access our in-app manual or visit our support forums.\\n\\nThank you for trying AnkiDroid!\\n\u2014AnkiDroid Development Team</string>\n          \n          \n            \n                <string name=\"collection_load_welcome_request_permissions_details\">AnkiDroid requires storage permission, which we use exclusively to store your AnkiDroid collection, flashcard media and backups. Our code is open-source, written by volunteers, and trusted by millions.\\n\\nIf you have any questions, please access our in-app manual or visit our support forums.\\n\\nThank you for trying AnkiDroid!\\n\u2014AnkiDroid Development Team</string>", "url": "https://github.com/ankidroid/Anki-Android/pull/5848#discussion_r396006512", "createdAt": "2020-03-21T16:28:19Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -139,4 +139,8 @@\n     <string name=\"empty_cards_none\">No empty cards</string>\n     <string name=\"empty_cards_count\">Cards to delete: %d</string>\n     <string name=\"empty_cards_deleted\">Cards deleted: %d</string>\n+\n+    <!-- Initial collection load -->\n+    <string name=\"collection_load_welcome_request_permissions_title\">Welcome to AnkiDroid!</string>\n+    <string name=\"collection_load_welcome_request_permissions_details\">We require storage access to store your AnkiDroid collection, including media and backups. We do not access any of your media or files. Our code is open-source, written by volunteers, and trusted by millions.\\n\\nIf you have any questions, please access our in-app manual or visit our support forums.\\n\\nThank you for trying AnkiDroid!\\n\u2014AnkiDroid Development Team</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e86bec7cabfc43a7f190ae9f0173d1a39b4f97f4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwNzUxNQ==", "bodyText": "not sure if it's best practice to set our member variable prior to asking the system to go off and do something, but I think it might be?", "url": "https://github.com/ankidroid/Anki-Android/pull/5848#discussion_r396007515", "createdAt": "2020-03-21T16:40:53Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -454,11 +460,28 @@ private boolean firstCollectionOpen() {\n         if (CollectionHelper.hasStorageAccessPermission(this)) {\n             // Show error dialog if collection could not be opened\n             return CollectionHelper.getInstance().getColSafe(this) != null;\n-        } else {\n-            // Request storage permission if we don't have it (e.g. on Android 6.0+)\n+        } else if (mClosedWelcomeMessage) {\n+            // DEFECT #5847: This fails if the activity is killed.\n+            //Even if the dialog is showing, we want to show it again.\n             ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.WRITE_EXTERNAL_STORAGE},\n                     REQUEST_STORAGE_PERMISSION);\n             return false;\n+        } else {\n+            // Request storage permission if we don't have it (e.g. on Android 6.0+)\n+            new MaterialDialog.Builder(this)\n+                    .title(R.string.collection_load_welcome_request_permissions_title)\n+                    .titleGravity(GravityEnum.CENTER)\n+                    .content(R.string.collection_load_welcome_request_permissions_details)\n+                    .positiveText(R.string.dialog_ok)\n+                    .onPositive((innerDialog, innerWhich) -> {\n+                        ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.WRITE_EXTERNAL_STORAGE},\n+                                REQUEST_STORAGE_PERMISSION);\n+                        this.mClosedWelcomeMessage = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e86bec7cabfc43a7f190ae9f0173d1a39b4f97f4"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d073c5cfd7c72c265ad7173519d888e86773882c", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d073c5cfd7c72c265ad7173519d888e86773882c", "committedDate": "2020-03-21T17:40:09Z", "message": "#5740 - Add Dialog Requesting Permissions\n\nSome users din't feel comfortable about us requiring access to\nexternal storage.\n\nWe explain that we don't perform any malicious activities with this\nin order to hopefully alleviate concerns."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9999a0cc3b78b5753bcccfa1a4af9bd77e2e5cfc", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9999a0cc3b78b5753bcccfa1a4af9bd77e2e5cfc", "committedDate": "2020-03-21T17:11:08Z", "message": "Review: Welcome Dialog - member variable location"}, "afterCommit": {"oid": "d073c5cfd7c72c265ad7173519d888e86773882c", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d073c5cfd7c72c265ad7173519d888e86773882c", "committedDate": "2020-03-21T17:40:09Z", "message": "#5740 - Add Dialog Requesting Permissions\n\nSome users din't feel comfortable about us requiring access to\nexternal storage.\n\nWe explain that we don't perform any malicious activities with this\nin order to hopefully alleviate concerns."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3536, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}