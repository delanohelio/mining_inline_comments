{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2OTgwNTQ1", "number": 6063, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMzoyMDoxOFrOEFNgiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxODoyMjoyNVrOEFVuQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczODk5NjU2OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMzoyMDoxOFrOGjTyFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMzoyMDoxOFrOGjTyFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3NzQ2MQ==", "bodyText": "Could you extract mCurrentCard.note(), it's fine from a performance standpoint, but makes me double-take.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439677461", "createdAt": "2020-06-12T23:20:18Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -132,6 +135,30 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            for (String tag : mCurrentCard.note().getTags()) {\n+                mCurrentCard.note().delTag(tag);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98a922c887456ed9c4d31bb06a0b4207129b89f1"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTAwODkzOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMzozMTowNVrOGjT5hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQyMzozMTowNVrOGjT5hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3OTM2NA==", "bodyText": "This feels like it'll cause a ConcurrentModificationException. Could you do a defensive copy to ensure this won't happen.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439679364", "createdAt": "2020-06-12T23:31:05Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -132,6 +135,30 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            for (String tag : mCurrentCard.note().getTags()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98a922c887456ed9c4d31bb06a0b4207129b89f1"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczOTA2MTYzOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QwMDoyMzoyN1rOGjUZKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QyMTowNjozMFrOGjZYVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY4NzQ2NQ==", "bodyText": "Optional: Could extract to a method on note", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439687465", "createdAt": "2020-06-13T00:23:27Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -132,6 +135,30 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            for (String tag : mCurrentCard.note().getTags()) {\n+                mCurrentCard.note().delTag(tag);\n+            }\n+            ArrayList<String> tags = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tags != null) {\n+                for (String tag : tags) {\n+                    if (!mCurrentCard.note().hasTag(tag)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98a922c887456ed9c4d31bb06a0b4207129b89f1"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2OTE3Mg==", "bodyText": "Note is libanki, I won't alter it for optional", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439769172", "createdAt": "2020-06-13T21:06:30Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -132,6 +135,30 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            for (String tag : mCurrentCard.note().getTags()) {\n+                mCurrentCard.note().delTag(tag);\n+            }\n+            ArrayList<String> tags = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tags != null) {\n+                for (String tag : tags) {\n+                    if (!mCurrentCard.note().hasTag(tag)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY4NzQ2NQ=="}, "originalCommit": {"oid": "98a922c887456ed9c4d31bb06a0b4207129b89f1"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDIyMzUxOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNToxNTozMFrOGjdr8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNjoxNTo0OFrOGjeBJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzOTcyOQ==", "bodyText": "the old name seems better (but it's not good).", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439839729", "createdAt": "2020-06-14T15:15:30Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1351,7 +1373,7 @@ private void initFieldEditText(FieldEditText editText, final int index, String[]\n             public void afterTextChanged(Editable arg0) {\n                 mFieldEdited = true;\n                 if (index == 0) {\n-                    duplicateCheck();\n+                    setDuplicateFieldStyles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e584096a87dd6c15fd4ab5e3c4525d49cbcc199"}, "originalPosition": 312}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg0NTE1Ng==", "bodyText": "The old name had no indication it had side effects. Not it's a side-effecty verb. Changed on purpose, leaving", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439845156", "createdAt": "2020-06-14T16:15:48Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1351,7 +1373,7 @@ private void initFieldEditText(FieldEditText editText, final int index, String[]\n             public void afterTextChanged(Editable arg0) {\n                 mFieldEdited = true;\n                 if (index == 0) {\n-                    duplicateCheck();\n+                    setDuplicateFieldStyles();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzOTcyOQ=="}, "originalCommit": {"oid": "2e584096a87dd6c15fd4ab5e3c4525d49cbcc199"}, "originalPosition": 312}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDMyNzQ0OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxNzo1Nzo0MVrOGjehrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxODowNTowN1rOGjej8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1MzQ4Ng==", "bodyText": "Is there any particular reason to indicate which kinds of list is used everywhere ? Are we using any feature that is not available to standard list ?\nI'd assume that it would be better to leave types as generic as possible, in order to have the freedom to change implementation as easily as possible if we ever want it.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439853486", "createdAt": "2020-06-14T17:57:41Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -176,7 +176,7 @@\n \n     private Note mEditorNote;\n     public static Card mCurrentEditedCard;\n-    private List<String> mSelectedTags;\n+    private ArrayList<String> mSelectedTags;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17ead7a528a4bb022073a9a6db959b795d51f1e0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDA2NQ==", "bodyText": "Yes. Per the comment on the commit. The Bundle API can put/get ArrayList types but not generic List.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439854065", "createdAt": "2020-06-14T18:05:07Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -176,7 +176,7 @@\n \n     private Note mEditorNote;\n     public static Card mCurrentEditedCard;\n-    private List<String> mSelectedTags;\n+    private ArrayList<String> mSelectedTags;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1MzQ4Ng=="}, "originalCommit": {"oid": "17ead7a528a4bb022073a9a6db959b795d51f1e0"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDMzMzE2OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxODowNjo0M1rOGjekfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxODo0NjoyOFrOGjeweQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDIwNA==", "bodyText": "Any reason to transform it into an array before iterating ?\nI would expect it to be easier to iterate on the list directly. In particular it would avoid to create an array just to discard it after", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439854204", "createdAt": "2020-06-14T18:06:43Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDI5NA==", "bodyText": "I may assume that you fear the list gets modified during execution, leading to an error, maybe a comment would make it more clear", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439854294", "createdAt": "2020-06-14T18:07:53Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDIwNA=="}, "originalCommit": {"oid": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTgwNQ==", "bodyText": "That is precisely it, David asked for a local copy to avoid ConcurrentModificationException. I'll add a comment.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439855805", "createdAt": "2020-06-14T18:27:30Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDIwNA=="}, "originalCommit": {"oid": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NzI3Mw==", "bodyText": "comment clarified", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439857273", "createdAt": "2020-06-14T18:46:28Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDIwNA=="}, "originalCommit": {"oid": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDMzODExOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxODoxNTowOFrOGjenFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQyMDoyMToxMFrOGjfLhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDg3MQ==", "bodyText": "Usually, you add a tag without checking whether it is already in the list of tag, so this is quite strange to read.\nI don't expect it to be a problem in any way, since there is not enough tag for the inefficiency to matter. I still would feel like that it would be clearer to put in Note.java a method setTags(List<String>); and leave this background task to Note.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439854871", "createdAt": "2020-06-14T18:15:08Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {\n+                    if (!currentNote.hasTag(tag)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTg5MA==", "bodyText": "I am not altering Note.java (which is in libanki, and I don't want to touch it) on purpose. The tag reset is done here because I want to make certain the tags sent to the webview (which I think are visible and thus may alter render) are exactly the tags that might be edited-but-not-saved in the NoteEditor", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439855890", "createdAt": "2020-06-14T18:29:12Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {\n+                    if (!currentNote.hasTag(tag)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDg3MQ=="}, "originalCommit": {"oid": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1ODU5MA==", "bodyText": "It did occur multiple time that a small code was added to a libanki method, at the end of the file, indicating this is a method for us.\nRemoving all tags one by one is usulessly slow, even if the number of tags made it not a real problem.\nAt least, I believe it would make sens to put this in a function in util, or someplace like that, so that it is clear that the whole part of the code does a single thing: replace the list of tags, and if it's ever needed again, it can be reused easily", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439858590", "createdAt": "2020-06-14T19:04:23Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {\n+                    if (!currentNote.hasTag(tag)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDg3MQ=="}, "originalCommit": {"oid": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2NDE5Nw==", "bodyText": "I'm not doing that in this PR.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439864197", "createdAt": "2020-06-14T20:21:10Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -135,6 +138,32 @@ protected void onCollectionLoaded(Collection col) {\n         if (mCurrentCard == null) {\n             mCurrentCard = new PreviewerCard(col, mCardList[mOrdinal]);\n         }\n+\n+        if (mNoteEditorBundle != null) {\n+            mCurrentCard.setDid(mNoteEditorBundle.getLong(\"did\"));\n+\n+            // Clear out old tags, add current tags as that can affect render\n+            Note currentNote = mCurrentCard.note();\n+            String[] currentTags = currentNote.getTags().toArray(new String[0]);\n+            for (String tag : currentTags) {\n+                currentNote.delTag(tag);\n+            }\n+            ArrayList<String> tagsList = mNoteEditorBundle.getStringArrayList(\"tags\");\n+            if (tagsList != null) {\n+                for (String tag : tagsList.toArray(new String[0])) {\n+                    if (!currentNote.hasTag(tag)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NDg3MQ=="}, "originalCommit": {"oid": "2c813b2a4854a5c2e1a6937f22a2eda8989949c9"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDM0MjQzOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxODoyMjoyNVrOGjepQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQyMjo0NjozMlrOGjf2jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw==", "bodyText": "I had trouble thinking how it could be true. mCurrentEditedCard was a card already existing, and card usually don't disappear unless you check for empty card. You are not supposed to be able to do it while you're reviewing.\nI then realized that it can be true if you change a note type. If I'm right, I believe a comment here would be nice to explain it. If I'm wrong, it shows explanation may help here.\nAs a side note, I don't really get the point. Even if the card did disappear, editing the note still makes sens. Either there are other cards and we may want to edit them. Or they are no other card, and in this case the fields won't be recoverable, and it's even more important to give a strong warning to user that they'll lose data.\nActually, I had to create an add-on for anki to warn when note would be deleted because it would generate no more card. It occured multiple time to me and was always an accident, a template I did badly edit. In all cases, I would have wanted anki to warn me instead of just deleting the note", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439855427", "createdAt": "2020-06-14T18:22:25Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1136,9 +1136,13 @@ else if (fieldEditText.getText() != null) {\n                     mReloadRequired = true;\n                     mEditorNote.reloadModel();\n                     if (!mEditorNote.cards().contains(mCurrentEditedCard)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36604cf8081589aa134322416af4ff9125da99b3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NjA4Mg==", "bodyText": "I don't believe this functionality changed. Are you making a comment on my PR or is this a separate issue that should be logged as a separate defect?", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439856082", "createdAt": "2020-06-14T18:31:03Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1136,9 +1136,13 @@ else if (fieldEditText.getText() != null) {\n                     mReloadRequired = true;\n                     mEditorNote.reloadModel();\n                     if (!mEditorNote.cards().contains(mCurrentEditedCard)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}, "originalCommit": {"oid": "36604cf8081589aa134322416af4ff9125da99b3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NzQzNA==", "bodyText": "Also worth noting that in #5151 there was much work done to make sure that deleting a card would orphan a note. We don't allow that. I don't think it has anything to do with this PR. 9777bee", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439857434", "createdAt": "2020-06-14T18:48:47Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1136,9 +1136,13 @@ else if (fieldEditText.getText() != null) {\n                     mReloadRequired = true;\n                     mEditorNote.reloadModel();\n                     if (!mEditorNote.cards().contains(mCurrentEditedCard)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}, "originalCommit": {"oid": "36604cf8081589aa134322416af4ff9125da99b3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3NDY3NA==", "bodyText": "Sorry, didn't see the message, I didn't thought about expending resolved conversation.\nIndeed, this remark was related to the case you have not just introduced. I is not clear to me how it used to be possible. When you can enter this if branch.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439874674", "createdAt": "2020-06-14T22:40:15Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1136,9 +1136,13 @@ else if (fieldEditText.getText() != null) {\n                     mReloadRequired = true;\n                     mEditorNote.reloadModel();\n                     if (!mEditorNote.cards().contains(mCurrentEditedCard)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}, "originalCommit": {"oid": "36604cf8081589aa134322416af4ff9125da99b3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3NDk2MQ==", "bodyText": "If I am in NoteEditor on for example 'Card 3', and I go to CardTemplateEditor and delete the Card 3 template, then save it and it returns to the NoteEditor, NoteEditor hits this case. And in general now it will just boot you out.\nHowever, if you are in NoteEditor in \"add note\" mode (so there is no current card) and you go to CardTemplatePreviewer, you will come back here and also be in this case. But in that specific situation it's okay, there was no card to begin with so we don't need to leave.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439874961", "createdAt": "2020-06-14T22:43:40Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1136,9 +1136,13 @@ else if (fieldEditText.getText() != null) {\n                     mReloadRequired = true;\n                     mEditorNote.reloadModel();\n                     if (!mEditorNote.cards().contains(mCurrentEditedCard)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}, "originalCommit": {"oid": "36604cf8081589aa134322416af4ff9125da99b3"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg3NTIxNA==", "bodyText": "Thank you for the explanation.", "url": "https://github.com/ankidroid/Anki-Android/pull/6063#discussion_r439875214", "createdAt": "2020-06-14T22:46:32Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -1136,9 +1136,13 @@ else if (fieldEditText.getText() != null) {\n                     mReloadRequired = true;\n                     mEditorNote.reloadModel();\n                     if (!mEditorNote.cards().contains(mCurrentEditedCard)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1NTQyNw=="}, "originalCommit": {"oid": "36604cf8081589aa134322416af4ff9125da99b3"}, "originalPosition": 3}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 375, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}