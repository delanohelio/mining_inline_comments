{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5NDQxNjU1", "number": 7472, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNToxNDowOFrOExkYmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNToxNjowNVrOExkZ1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNDExODAwOnYy", "diffSide": "LEFT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNToxNDowOFrOHnyZbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjowOTozMlrOHnyumQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4MjIyMw==", "bodyText": "here we are iterating through the set of available templates as our source for determining to include or not, which implicitly constrains the search to only existing templates, even if avail somehow contains a template ordinal that does not exist", "url": "https://github.com/ankidroid/Anki-Android/pull/7472#discussion_r511482223", "createdAt": "2020-10-24T15:14:08Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -700,10 +700,8 @@ public void _remNotes(java.util.Collection<Long> ids) {\n         JSONArray tmpls;\n         if (model.getInt(\"type\") == Consts.MODEL_STD) {\n             tmpls = model.getJSONArray(\"tmpls\");\n-            for (JSONObject t : tmpls.jsonObjectIterable()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0139c0ee1015beac03a8685f02e2ccbe3deac78d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4NzY0MQ==", "bodyText": "For standard model, avail returns a subset of existing template. If at some point avail return something else, it means either we introduced a bug (and I actually would love to see the program crash, because it ensures we get a clear error sign), or card generation rules changed so drastically that this whole method is probably going to be deleted", "url": "https://github.com/ankidroid/Anki-Android/pull/7472#discussion_r511487641", "createdAt": "2020-10-24T16:09:32Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -700,10 +700,8 @@ public void _remNotes(java.util.Collection<Long> ids) {\n         JSONArray tmpls;\n         if (model.getInt(\"type\") == Consts.MODEL_STD) {\n             tmpls = model.getJSONArray(\"tmpls\");\n-            for (JSONObject t : tmpls.jsonObjectIterable()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4MjIyMw=="}, "originalCommit": {"oid": "0139c0ee1015beac03a8685f02e2ccbe3deac78d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNDEyMTE3OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNToxNjowNVrOHnybLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQxNjoxNDoyNFrOHnywTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4MjY2OA==", "bodyText": "...in the proposed version we are now getting a template via ordinal directly from the avail array without checking first to make sure that the ordinal actually exists in the set of templates on the model\nI don't think this is a big risk but is not NF, it is possible now to request an array of ordinals from the model that don't exist, and different behavior will happen.\nIf there was a check first to make sure that the ordinal existed / the return value of tmpls.getJSONObject(ord) was valid before attempting to add it to to the return collection, then this would truly be NF I think", "url": "https://github.com/ankidroid/Anki-Android/pull/7472#discussion_r511482668", "createdAt": "2020-10-24T15:16:05Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -700,10 +700,8 @@ public void _remNotes(java.util.Collection<Long> ids) {\n         JSONArray tmpls;\n         if (model.getInt(\"type\") == Consts.MODEL_STD) {\n             tmpls = model.getJSONArray(\"tmpls\");\n-            for (JSONObject t : tmpls.jsonObjectIterable()) {\n-                if (avail.contains(t.getInt(\"ord\"))) {\n-                    ok.add(t);\n-                }\n+            for (Integer ord : avail) {\n+                ok.add(tmpls.getJSONObject(ord));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0139c0ee1015beac03a8685f02e2ccbe3deac78d"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4ODA3OQ==", "bodyText": "I added comments in a first commit to explain what are the restrictions that avail currently satisfies, and that can't be broken without strongly breaking the card generation rules.", "url": "https://github.com/ankidroid/Anki-Android/pull/7472#discussion_r511488079", "createdAt": "2020-10-24T16:14:24Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -700,10 +700,8 @@ public void _remNotes(java.util.Collection<Long> ids) {\n         JSONArray tmpls;\n         if (model.getInt(\"type\") == Consts.MODEL_STD) {\n             tmpls = model.getJSONArray(\"tmpls\");\n-            for (JSONObject t : tmpls.jsonObjectIterable()) {\n-                if (avail.contains(t.getInt(\"ord\"))) {\n-                    ok.add(t);\n-                }\n+            for (Integer ord : avail) {\n+                ok.add(tmpls.getJSONObject(ord));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTQ4MjY2OA=="}, "originalCommit": {"oid": "0139c0ee1015beac03a8685f02e2ccbe3deac78d"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 755, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}