{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MTc0Mjk5", "number": 6206, "title": "Introduce night mode compatibility with desktop Anki", "bodyText": "Purpose / Description\nNight mode in Anki for Desktop introduces a new CSS class for styling cards incompatible with AnkiDroid. This in turn neccessitates very hacky and verbose CSS for consistent styling of night mode (sometimes impossible), instead of styling for night mode in Anki or for night mode in AnkiDroid.\nFixes\nhttps://docs.ankiweb.net/#/templates/styling?id=night-mode\nApproach\nThis change introduces such compatibility (BC/FC) and only potentially breaks things if users have already tried to hack around the incompatibility for both night modes; nonetheless, in virtually all cases, the resulting CSS should be a lot simpler.\nChecklist\n\n I have not changed whitespace unnecessarily.\n I have a descriptive commit message with a short title (first line, max 50 chars).\n My code follows the style of the project (e.g. never omit braces in if statements).\n I have commented my code, particularly in hard-to-understand areas (doesn't apply).\n I have performed a self-review of your own code.", "createdAt": "2020-05-17T21:10:11Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6206", "merged": true, "mergeCommit": {"oid": "185dbbba65b62423f01395b8090ceb4cb9c97529"}, "closed": true, "closedAt": "2020-05-24T17:19:38Z", "author": {"login": "Kubo2"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciRyEfgH2gAyNDE5MTc0Mjk5OjJlMzUwYjUxM2UwMjI4ZmY1ZGJkOTg5MGE0NDhlMDBkZmMyNWRkNWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABckdNHsAFqTQxNzM2ODUzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2e350b513e0228ff5dbd9890a448e00dfc25dd5b", "author": {"user": {"login": "Kubo2", "name": "Kubis Fowler"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2e350b513e0228ff5dbd9890a448e00dfc25dd5b", "committedDate": "2020-05-17T21:02:35Z", "message": "Introduce night mode compatibility with desktop\n\nNight mode in Anki for Desktop introduces a new CSS class for styling cards incompatible with AnkiDroid. This in turn neccessitates very hacky and verbose CSS for consistent styling of night mode (sometimes impossible), instead of styling for night mode in Anki or for night mode in AnkiDroid.\r\n\r\nThis change introduces such compatibility (BC/FC) and only potentially breaks things if users have already tried to hack around the incompatibility for both night modes; nonetheless, in virtually all cases, the resulting CSS should be a lot simpler."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMjAxNDAy", "url": "https://github.com/ankidroid/Anki-Android/pull/6206#pullrequestreview-413201402", "createdAt": "2020-05-17T21:43:53Z", "commit": {"oid": "2e350b513e0228ff5dbd9890a448e00dfc25dd5b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f7b95fc3a2d7d19895420bc7106f99d72879d83", "author": {"user": {"login": "Kubo2", "name": "Kubis Fowler"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7f7b95fc3a2d7d19895420bc7106f99d72879d83", "committedDate": "2020-05-24T14:00:17Z", "message": "CardAppearence check for custom night mode stylesheet"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MzYyNDQ5", "url": "https://github.com/ankidroid/Anki-Android/pull/6206#pullrequestreview-417362449", "createdAt": "2020-05-24T14:13:02Z", "commit": {"oid": "7f7b95fc3a2d7d19895420bc7106f99d72879d83"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNDoxMzowMlrOGZvNLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNDoxMzowMlrOGZvNLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0MTAwNg==", "bodyText": "Possible improvement: rename to hasUserDefinedNightMode", "url": "https://github.com/ankidroid/Anki-Android/pull/6206#discussion_r429641006", "createdAt": "2020-05-24T14:13:02Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/cardviewer/CardAppearance.java", "diffHunk": "@@ -45,6 +46,15 @@ public boolean isNightMode() {\n         return mNightMode;\n     }\n \n+\n+    /**\n+     * customNightMode finds out if the user has included class .night_mode in card's stylesheet\n+     */\n+    public boolean customNightMode(Card card) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f7b95fc3a2d7d19895420bc7106f99d72879d83"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff53cd79a643d647086d674b17d537484b905f77", "author": {"user": {"login": "Kubo2", "name": "Kubis Fowler"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ff53cd79a643d647086d674b17d537484b905f77", "committedDate": "2020-05-24T14:31:55Z", "message": "Rename CardAppearance.customNightMode() -> hasUserDefinedNightMode()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MzY0MjQ0", "url": "https://github.com/ankidroid/Anki-Android/pull/6206#pullrequestreview-417364244", "createdAt": "2020-05-24T14:34:52Z", "commit": {"oid": "ff53cd79a643d647086d674b17d537484b905f77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNDozNDo1MlrOGZvU3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQxNDozNDo1MlrOGZvU3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0Mjk3NQ==", "bodyText": "Issue found: These nested if statements could be combined", "url": "https://github.com/ankidroid/Anki-Android/pull/6206#discussion_r429642975", "createdAt": "2020-05-24T14:34:52Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -2062,9 +2062,7 @@ private void updateCard(final String newContent) {\n         }\n \n         if (isInNightMode()) {\n-            // If card styling doesn't contain any mention of the night_mode class then do color inversion as fallback\n-            // TODO: find more robust solution that won't match unrelated classes like \"night_mode_old\"\n-            if (!mCurrentCard.css().contains(\".night_mode\")) {\n+            if (!mCardAppearance.hasUserDefinedNightMode(mCurrentCard)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff53cd79a643d647086d674b17d537484b905f77"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MzY4NTM5", "url": "https://github.com/ankidroid/Anki-Android/pull/6206#pullrequestreview-417368539", "createdAt": "2020-05-24T15:28:56Z", "commit": {"oid": "ff53cd79a643d647086d674b17d537484b905f77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3277, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}