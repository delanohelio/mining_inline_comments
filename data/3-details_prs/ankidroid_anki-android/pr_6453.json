{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzOTk5MDAw", "number": 6453, "title": "Strip spaces in deck name", "bodyText": "Starting with 2.1.28, anki strip deck's name. I imitate it. I don't\nuse the same code as they do it in rust and we don't have rust yet.\nHowever, since this create compatibility problems between anki and\nankidroid during some sync ( see\nhttps://forums.ankiweb.net/t/decks-with-trailing-spaces/89/4?u=arthurmilchior\n) I believe it should be considered without waiting for\nrust. Especially since it's a small change in term of code.\nThe spaces are stripped in two places: when checking for deck\nintegrity, and when changing deck name (i.e. through id which\ncreates deck, and through rename). No need currently to use it in\nbyName, since it is only called with names already stripped and with\nthe constant \"Custom study session\".\nThis was tested by:\n\ncreating a deck name \" A B :: C D:: E\" and seeing that it created deck \"A B\", \"A B::C D\" and \"A B::C D::E\"\nOpening a collection with deck \"Foo \" and seeing it got renamed in \"Foo\"\nopening a collection with decks \"Foo\" and \"Foo \" and checking that \"Foo \" got renamed to \"Foorandomstring\"\n\n\nEdit by @david-allison-1\nFixes #6452", "createdAt": "2020-06-13T12:15:04Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6453", "merged": true, "mergeCommit": {"oid": "a2478511a615a86bf33fcf1523dd381f9ff0a3b7"}, "closed": true, "closedAt": "2020-06-19T17:48:10Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcq2o4tAH2gAyNDMzOTk5MDAwOjgzMTU4NDlhZWU0NjY5OTk2ZTI1YTVlOTViMzQ1YTg4MzRjODdjMWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsFq5mAFqTQzMjE3NjYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8315849aee4669996e25a5e95b345a8834c87c1d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8315849aee4669996e25a5e95b345a8834c87c1d", "committedDate": "2020-06-13T12:30:26Z", "message": "Strip spaces in deck name\n\nStarting with 2.1.28, anki strip deck's name. I imitate it. I don't\nuse the same code as they do it in rust and we don't have rust yet.\n\nHowever, since this create compatibility problems between anki and\nankidroid during some sync ( see\nhttps://forums.ankiweb.net/t/decks-with-trailing-spaces/89/4?u=arthurmilchior\n) I believe it should be considered without waiting for\nrust. Especially since it's a small change in term of code.\n\nThe spaces are stripped in two places: when checking for deck\nintegrity, and when changing deck name (i.e. through `id` which\ncreates deck, and through `rename`). No need currently to use it in\nbyName, since it is only called with names already stripped and with\nthe constant \"Custom study session\"."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1f78182f41c6e13a7d7beca7ddb5d6520f416c5", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d1f78182f41c6e13a7d7beca7ddb5d6520f416c5", "committedDate": "2020-06-13T12:12:40Z", "message": "Strip spaces in deck name\n\nStarting with 2.1.28, anki strip deck's name. I imitate it. I don't\nuse the same code as they do it in rust and we don't have rust yet.\n\nHowever, since this create compatibility problems between anki and\nankidroid during some sync ( see\nhttps://forums.ankiweb.net/t/decks-with-trailing-spaces/89/4?u=arthurmilchior\n) I believe it should be considered without waiting for\nrust. Especially since it's a small change in term of code.\n\nThe spaces are stripped in two places: when checking for deck\nintegrity, and when changing deck name (i.e. through `id` which\ncreates deck, and through `rename`). No need currently to use it in\nbyName, since it is only called with names already stripped and with\nthe constant \"Custom study session\"."}, "afterCommit": {"oid": "8315849aee4669996e25a5e95b345a8834c87c1d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8315849aee4669996e25a5e95b345a8834c87c1d", "committedDate": "2020-06-13T12:30:26Z", "message": "Strip spaces in deck name\n\nStarting with 2.1.28, anki strip deck's name. I imitate it. I don't\nuse the same code as they do it in rust and we don't have rust yet.\n\nHowever, since this create compatibility problems between anki and\nankidroid during some sync ( see\nhttps://forums.ankiweb.net/t/decks-with-trailing-spaces/89/4?u=arthurmilchior\n) I believe it should be considered without waiting for\nrust. Especially since it's a small change in term of code.\n\nThe spaces are stripped in two places: when checking for deck\nintegrity, and when changing deck name (i.e. through `id` which\ncreates deck, and through `rename`). No need currently to use it in\nbyName, since it is only called with names already stripped and with\nthe constant \"Custom study session\"."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMTYxMjYw", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#pullrequestreview-430161260", "createdAt": "2020-06-13T19:36:27Z", "commit": {"oid": "8315849aee4669996e25a5e95b345a8834c87c1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxOTozNjoyN1rOGjZCuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxOTozNjoyN1rOGjZCuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2MzY0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** With .28, anki started strips whitespace of deck name.\n          \n          \n            \n                /** With 2.1.28, anki started strips whitespace of deck name.", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r439763641", "createdAt": "2020-06-13T19:36:27Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");\n+    private static String strip(String deckName) {\n+        return spaceAroundSeparator.matcher(deckName.trim()).replaceAll( \"::\");\n+    }\n+\n+    /** With .28, anki started strips whitespace of deck name.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8315849aee4669996e25a5e95b345a8834c87c1d"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "456b8a9036adde0def848bad303ef06e5a40c5df", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/456b8a9036adde0def848bad303ef06e5a40c5df", "committedDate": "2020-06-13T20:23:25Z", "message": "Update AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\nCo-authored-by: Mike Hardy <github@mikehardy.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODA1Mzcw", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#pullrequestreview-430805370", "createdAt": "2020-06-15T16:28:10Z", "commit": {"oid": "456b8a9036adde0def848bad303ef06e5a40c5df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTc2NjI0", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#pullrequestreview-432176624", "createdAt": "2020-06-17T08:31:48Z", "commit": {"oid": "456b8a9036adde0def848bad303ef06e5a40c5df"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODozMTo0OFrOGk7ZFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODozMzoyOVrOGk7dEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NDk5Nw==", "bodyText": "sSpaceAroundSeparator", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441374997", "createdAt": "2020-06-17T08:31:48Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456b8a9036adde0def848bad303ef06e5a40c5df"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NTM1Mw==", "bodyText": "Is this the same pattern as the one that Anki uses? Will have have problems such as the triple-colon that you previously solved?", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441375353", "createdAt": "2020-06-17T08:32:24Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NDk5Nw=="}, "originalCommit": {"oid": "456b8a9036adde0def848bad303ef06e5a40c5df"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjAxOQ==", "bodyText": "Have you tested this on decks with duplicate names and different spacing?\nHave you tested this on decks which would normalise to the same name: \"Foo\" and \" FOO \"\nCan the user currently call their deck \"\", or \" \", would this generate an invalid name? What happens in Anki Desktop?", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441376019", "createdAt": "2020-06-17T08:33:29Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");\n+    private static String strip(String deckName) {\n+        return spaceAroundSeparator.matcher(deckName.trim()).replaceAll( \"::\");\n+    }\n+\n+    /** With 2.1.28, anki started strips whitespace of deck name.\n+     * This method is here for compatibility while we wait for rust.\n+     * It should be executed before other methods, because both \"FOO \" and \"FOO\" will be renamed to the same name,\n+     * and so this will need to be renamed by _checkDeckTree.*/\n+    private void _removeSpaces () {\n+        for (JSONObject deck: all()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "456b8a9036adde0def848bad303ef06e5a40c5df"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3201, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}