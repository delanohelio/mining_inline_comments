{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNzI5Mzkz", "number": 7290, "title": "Empty card progress", "bodyText": "On my collection, \"empty cards\" takes two minutes. No progress indicates where we are. I correct it by adding a number. This is not perfect, because the numerator counts cards that should exists and the denominator counts cards that already exists. So if there are missing cards in the collection, the numerator will become greater than 1.\u00a0On the other hand, if cards should be deleted, we will never reach the denominator. This is still a good indication on how the process is evolving.\nFurthermore, this task is now cancellable.", "createdAt": "2020-09-27T14:30:01Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7290", "merged": true, "mergeCommit": {"oid": "c77f5ca840f81a2e4a67b744ad8a53f18810d38c"}, "closed": true, "closedAt": "2020-10-14T21:14:45Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdM_5i4ABqjM4MTE3MTQwMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdShkFOgBqjM4Nzc5ODMwMDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4203e17a56b1930b665c0234ee805b8dc7c6d607", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4203e17a56b1930b665c0234ee805b8dc7c6d607", "committedDate": "2020-09-27T14:26:04Z", "message": "Empty card is cancellable"}, "afterCommit": {"oid": "289ea3805d630cdd4b8e477506a679dad36df021", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/289ea3805d630cdd4b8e477506a679dad36df021", "committedDate": "2020-09-27T14:31:06Z", "message": "Empty card is cancellable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDg1OTU1", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-497085955", "createdAt": "2020-09-27T14:37:15Z", "commit": {"oid": "0eb342fd3dbff9ac6f1657d27a924c3609619a2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDozNzoxNlrOHYnxiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDozNzoxNlrOHYnxiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTUyOA==", "bodyText": "If this is an update frequency issue, then we could perhaps still overwhelm the display if the math was correct and each percent was roughly real time. Perhaps better to have this \"update frequency reducer\" be based on time vs percents, and update once a second? (or similar)", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495579528", "createdAt": "2020-09-27T14:37:16Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2738,6 +2742,18 @@ public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n                     deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n         }\n \n+        @Override\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            int lastCardSeenPercent = (int) ((cardSeen * 100) / numberCards);\n+            cardSeen += progress.getInt();\n+            int cardSeenPercent = (int) ((cardSeen * 100) / numberCards);\n+            if (lastCardSeenPercent != cardSeenPercent) {\n+                // Ensure we update at most 100 times. Updating in real time freeze the screen", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0eb342fd3dbff9ac6f1657d27a924c3609619a2a"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDg2MDY3", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-497086067", "createdAt": "2020-09-27T14:38:45Z", "commit": {"oid": "0eb342fd3dbff9ac6f1657d27a924c3609619a2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDozODo0NVrOHYnyEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDozODo0NVrOHYnyEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3OTY2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    deckPicker.getResources().getString(R.string.emtpy_cards_finding) + cardSeen + \" / \" + numberCards);\n          \n          \n            \n                                    deckPicker.getResources().getString(R.string.empty_cards_finding) + cardSeen + \" / \" + numberCards);\n          \n      \n    \n    \n  \n\nBut more problematically this does not work with RTL languages, the numbers should be interpolated into the string with a string format I think?\nAnd a minor note, but if the math is \"fuzzy\" (you mention that things might go up or down) then I think you could put a ~ sign or something before the numbers to indicate \"not exact but close\"", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495579664", "createdAt": "2020-09-27T14:38:45Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2738,6 +2742,18 @@ public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n                     deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n         }\n \n+        @Override\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            int lastCardSeenPercent = (int) ((cardSeen * 100) / numberCards);\n+            cardSeen += progress.getInt();\n+            int cardSeenPercent = (int) ((cardSeen * 100) / numberCards);\n+            if (lastCardSeenPercent != cardSeenPercent) {\n+                // Ensure we update at most 100 times. Updating in real time freeze the screen\n+                deckPicker.mProgressDialog.setContent(\n+                        deckPicker.getResources().getString(R.string.emtpy_cards_finding) + cardSeen + \" / \" + numberCards);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0eb342fd3dbff9ac6f1657d27a924c3609619a2a"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDg2MTUy", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-497086152", "createdAt": "2020-09-27T14:39:58Z", "commit": {"oid": "289ea3805d630cdd4b8e477506a679dad36df021"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "289ea3805d630cdd4b8e477506a679dad36df021", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/289ea3805d630cdd4b8e477506a679dad36df021", "committedDate": "2020-09-27T14:31:06Z", "message": "Empty card is cancellable"}, "afterCommit": {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41", "committedDate": "2020-09-27T14:50:21Z", "message": "Empty card is cancellable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDg3Mjk3", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-497087297", "createdAt": "2020-09-27T14:56:46Z", "commit": {"oid": "289ea3805d630cdd4b8e477506a679dad36df021"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDo1NzowMFrOHYn4tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNTowMjo0OFrOHYn6hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTM2NQ==", "bodyText": "spacing changes", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581365", "createdAt": "2020-09-27T14:57:00Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1179,13 +1207,13 @@ public void updateFieldCache(long[] nids) {\n         return data;\n     }\n \n-\tpublic String _flagNameFromCardFlags(int flags){\n-\t\tint flag = flags & 0b111;\n-\t\tif (flag == 0) {\n-\t\t\treturn \"\";\n-\t\t}\n-\t\treturn \"flag\"+flag;\n-\t}\n+   public String _flagNameFromCardFlags(int flags){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTM2OQ==", "bodyText": "spacing changes", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581369", "createdAt": "2020-09-27T14:57:03Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2033,8 +2061,8 @@ public synchronized Models getModels() {\n     /** Check if this collection is valid. */\n     @SuppressWarnings(\"BooleanMethodIsAlwaysInverted\")\n     public boolean validCollection() {\n-    \t//TODO: more validation code\n-    \treturn getModels().validateModel();\n+       //TODO: more validation code", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41"}, "originalPosition": 179}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTQ1NQ==", "bodyText": "Use an interface here - adding a dependency from libAnki -> CollectionTask isn't a good idea", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581455", "createdAt": "2020-09-27T14:58:13Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -716,19 +716,40 @@ public void _remNotes(java.util.Collection<Long> ids) {\n     /**\n      * Generate cards for non-empty templates, return ids to remove.\n      */\n-\tpublic ArrayList<Long> genCards(List<Long> nids) {\n-\t    return genCards(Utils.collection2Array(nids));\n-\t}\n+   public ArrayList<Long> genCards(List<Long> nids) {\n+       return genCards(Utils.collection2Array(nids));\n+   }\n+\n+    public ArrayList<Long> genCards(List<Long> nids, CollectionTask task) {\n+       return genCards(Utils.collection2Array(nids), task);\n+    }\n+\n     public ArrayList<Long> genCards(long[] nids) {\n+       return genCards(nids, null);\n+    }\n+\n+    /**\n+     * @param nids All ids of nodes of a note type\n+     * @param task Task to check for cancellation and update number of card processed\n+     * @return Cards that should be removed because they should not be generated\n+     */\n+    public ArrayList<Long> genCards(long[] nids, CollectionTask task) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTU3OA==", "bodyText": "If we stick with this, don't string concat", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581578", "createdAt": "2020-09-27T14:59:51Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2725,50 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        emptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int numberCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            numberCards = deckPicker.getCol().cardCount();\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask emptyCardTask = deckPicker.emptyCardTask;\n+                if (emptyCardTask != null) {\n+                    emptyCardTask.safeCancel();\n+                }};\n             deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), true,\n+                    onCancel);\n         }\n \n         @Override\n-        public void actualOnPostExecute(@NonNull DeckPicker deckPicker, TaskData result) {\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            cardSeen += progress.getInt();\n+            // Ensure we update at most 100 times. Updating in real time freeze the screen\n+            deckPicker.mProgressDialog.setContent(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTYxOQ==", "bodyText": "Might want to move this code (safeCancel) into a utils class.", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581619", "createdAt": "2020-09-27T15:00:18Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2725,50 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        emptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int numberCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            numberCards = deckPicker.getCol().cardCount();\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask emptyCardTask = deckPicker.emptyCardTask;\n+                if (emptyCardTask != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTcwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private final int numberCards;\n          \n          \n            \n                    private final int mNumberOfCards;", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581705", "createdAt": "2020-09-27T15:01:14Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2725,50 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        emptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int numberCards;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTgzMA==", "bodyText": "We never reset this to null after execution - do we want to?", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495581830", "createdAt": "2020-09-27T15:02:48Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -214,6 +215,8 @@\n \n     private String mExportFileName;\n \n+    private CollectionTask emptyCardTask = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "855f4527d68e4e4839373502352168ba1e2d4a1b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/855f4527d68e4e4839373502352168ba1e2d4a1b", "committedDate": "2020-09-27T15:04:38Z", "message": "Don't cancel on touch\n\nOtherwise any touch on the screen cancel by acciddent"}, "afterCommit": {"oid": "15703b1c8ed90a4a154136d1ebfc4f0df8c738bc", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/15703b1c8ed90a4a154136d1ebfc4f0df8c738bc", "committedDate": "2020-09-27T15:13:50Z", "message": "Don't cancel on touch\n\nOtherwise any touch on the screen cancel by acciddent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15703b1c8ed90a4a154136d1ebfc4f0df8c738bc", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/15703b1c8ed90a4a154136d1ebfc4f0df8c738bc", "committedDate": "2020-09-27T15:13:50Z", "message": "Don't cancel on touch\n\nOtherwise any touch on the screen cancel by acciddent"}, "afterCommit": {"oid": "cf19df7f21c58abb221bd5e685e4552e1b0c7296", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/cf19df7f21c58abb221bd5e685e4552e1b0c7296", "committedDate": "2020-09-27T15:15:13Z", "message": "Don't cancel on touch\n\nOtherwise any touch on the screen cancel by acciddent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf19df7f21c58abb221bd5e685e4552e1b0c7296", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/cf19df7f21c58abb221bd5e685e4552e1b0c7296", "committedDate": "2020-09-27T15:15:13Z", "message": "Don't cancel on touch\n\nOtherwise any touch on the screen cancel by acciddent"}, "afterCommit": {"oid": "45f380ff942ca8c7e153fbc675f6c8e671375f69", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/45f380ff942ca8c7e153fbc675f6c8e671375f69", "committedDate": "2020-09-27T15:56:49Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45f380ff942ca8c7e153fbc675f6c8e671375f69", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/45f380ff942ca8c7e153fbc675f6c8e671375f69", "committedDate": "2020-09-27T15:56:49Z", "message": "Ask for confirmation to cancel"}, "afterCommit": {"oid": "854dba507e3534e87d2f67b6334697e727b2838c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/854dba507e3534e87d2f67b6334697e727b2838c", "committedDate": "2020-09-27T16:03:06Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDkxNjkx", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-497091691", "createdAt": "2020-09-27T16:04:16Z", "commit": {"oid": "45f380ff942ca8c7e153fbc675f6c8e671375f69"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNjowNDo0M1rOHYoQ_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNjowNDo0M1rOHYoQ_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4NzU4Mw==", "bodyText": "I am also usually trying to do the minimum UI too, I will admit, this one in particular I was thinking percent only with no other info, like so:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                              deckPicker.getResources().getString(R.string.empty_cards_finding_percent, percent) + cardSeen + \" / \" + mNumberOfCards);\n          \n          \n            \n                                                              deckPicker.getResources().getString(R.string.empty_cards_finding_percent, percent));\n          \n      \n    \n    \n  \n\nThat's how we avoid all the RTL language business - we can't do string concatenation in general because you never know where the language puts numbers naturally when doing translations. This way we have a percent and that's it", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495587583", "createdAt": "2020-09-27T16:04:43Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2725,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(DeckPicker deckPicker, CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))\n+                    .positiveText(deckPicker.getResources().getString(R.string.yes))\n+                    .negativeText(deckPicker.getResources().getString(R.string.no))\n+                    .onNegative((x, y) -> actualOnPreExecute(deckPicker))\n+                    .onPositive((x, y) -> task.safeCancel()).show()\n+                    ;\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask mEmptyCardTask = deckPicker.mEmptyCardTask;\n+                if (mEmptyCardTask != null) {\n+                    confirmCancel(deckPicker, mEmptyCardTask);\n+                }};\n             deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), true,\n+                    onCancel);\n+            deckPicker.mProgressDialog.setCanceledOnTouchOutside(false);\n         }\n \n         @Override\n-        public void actualOnPostExecute(@NonNull DeckPicker deckPicker, TaskData result) {\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            cardSeen += progress.getInt();\n+            int percent = Math.min(((int) (cardSeen * 100) / mNumberOfCards), 100);\n+            deckPicker.mProgressDialog.setContent(\n+                                                  deckPicker.getResources().getString(R.string.empty_cards_finding_percent, percent) + cardSeen + \" / \" + mNumberOfCards);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "854dba507e3534e87d2f67b6334697e727b2838c"}, "originalPosition": 66}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "854dba507e3534e87d2f67b6334697e727b2838c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/854dba507e3534e87d2f67b6334697e727b2838c", "committedDate": "2020-09-27T16:03:06Z", "message": "Ask for confirmation to cancel"}, "afterCommit": {"oid": "3dcac06f84fe9a64c66f2cfe465482478a438d43", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3dcac06f84fe9a64c66f2cfe465482478a438d43", "committedDate": "2020-09-27T16:05:46Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3dcac06f84fe9a64c66f2cfe465482478a438d43", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3dcac06f84fe9a64c66f2cfe465482478a438d43", "committedDate": "2020-09-27T16:05:46Z", "message": "Ask for confirmation to cancel"}, "afterCommit": {"oid": "61ee8dce64c19e5446c7c1fdd4018dd297f32f57", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/61ee8dce64c19e5446c7c1fdd4018dd297f32f57", "committedDate": "2020-09-27T16:54:25Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61ee8dce64c19e5446c7c1fdd4018dd297f32f57", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/61ee8dce64c19e5446c7c1fdd4018dd297f32f57", "committedDate": "2020-09-27T16:54:25Z", "message": "Ask for confirmation to cancel"}, "afterCommit": {"oid": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2", "committedDate": "2020-09-27T17:15:17Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2", "committedDate": "2020-09-27T17:15:17Z", "message": "Ask for confirmation to cancel"}, "afterCommit": {"oid": "a123aba592623f6c89b951bf5b8f745a13698006", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a123aba592623f6c89b951bf5b8f745a13698006", "committedDate": "2020-09-29T06:10:56Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDk3Mzgw", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-497097380", "createdAt": "2020-09-27T17:32:53Z", "commit": {"oid": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNzozMjo1M1rOHYoxuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNzo0MjowN1rOHYo0_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NTk2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"confirm_cancel\">Do you want to cancel ?</string>\n          \n          \n            \n                <string name=\"confirm_cancel\">Do you want to cancel?</string>", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495595963", "createdAt": "2020-09-27T17:32:53Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -145,10 +145,12 @@\n \n     <!-- Empty cards -->\n     <string name=\"emtpy_cards_finding\">Finding empty cards\u2026</string>\n+    <string name=\"confirm_cancel\">Do you want to cancel ?</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NjMwMw==", "bodyText": "As far as I know, this is an accessor for cancelable", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495596303", "createdAt": "2020-09-27T17:36:42Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2726,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(DeckPicker deckPicker, CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))\n+                    .positiveText(deckPicker.getResources().getString(R.string.yes))\n+                    .negativeText(deckPicker.getResources().getString(R.string.no))\n+                    .onNegative((x, y) -> actualOnPreExecute(deckPicker))\n+                    .onPositive((x, y) -> task.safeCancel()).show()\n+                    ;\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n-            deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask mEmptyCardTask = deckPicker.mEmptyCardTask;\n+                if (mEmptyCardTask != null) {\n+                    confirmCancel(deckPicker, mEmptyCardTask);\n+                }};\n+            deckPicker.mProgressDialog = new MaterialDialog.Builder(deckPicker)\n+                    .progress(false, mNumberOfCards)\n+                    .title(R.string.emtpy_cards_finding)\n+                    .cancelable(true)\n+                    .show();\n+            deckPicker.mProgressDialog.setOnCancelListener(onCancel);\n+            deckPicker.mProgressDialog.setCanceledOnTouchOutside(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NjM2MA==", "bodyText": "An explicit click on cancel no longer necessitates a dialog", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495596360", "createdAt": "2020-09-27T17:37:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2722,24 +2726,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(DeckPicker deckPicker, CollectionTask task) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5Njc5Nw==", "bodyText": "An interface with a named method for sending progress which doesn't couple us directly to either CollectionTask or TaskData (this is useful as we can send multiple categories of progress notifications for this operation and the ideal would be to be able to differentiate them).\nIt's ideal to avoid circular dependencies when feasible.\nEspecially so in the case of CollectionTask, where know it requires both a hard reference to the Android framework, and when the underlying mechanism (AsyncTask) has been deprecated in the latest version of Android.", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r495596797", "createdAt": "2020-09-27T17:42:07Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -716,19 +716,40 @@ public void _remNotes(java.util.Collection<Long> ids) {\n     /**\n      * Generate cards for non-empty templates, return ids to remove.\n      */\n-\tpublic ArrayList<Long> genCards(List<Long> nids) {\n-\t    return genCards(Utils.collection2Array(nids));\n-\t}\n+   public ArrayList<Long> genCards(List<Long> nids) {\n+       return genCards(Utils.collection2Array(nids));\n+   }\n+\n+    public ArrayList<Long> genCards(List<Long> nids, CollectionTask task) {\n+       return genCards(Utils.collection2Array(nids), task);\n+    }\n+\n     public ArrayList<Long> genCards(long[] nids) {\n+       return genCards(nids, null);\n+    }\n+\n+    /**\n+     * @param nids All ids of nodes of a note type\n+     * @param task Task to check for cancellation and update number of card processed\n+     * @return Cards that should be removed because they should not be generated\n+     */\n+    public ArrayList<Long> genCards(long[] nids, CollectionTask task) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MTQ1NQ=="}, "originalCommit": {"oid": "6b5fb7b1d87fdfc95a6c692fcf3a13ffd57cfd41"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NzY1NDg5", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-498765489", "createdAt": "2020-09-29T18:28:03Z", "commit": {"oid": "a123aba592623f6c89b951bf5b8f745a13698006"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxODoyODowM1rOHZ7eRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxODoyOTowMlrOHZ7gUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MDg1NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private long cardSeen = 0;\n          \n          \n            \n                    private long mCardsSeen = 0;", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496950855", "createdAt": "2020-09-29T18:28:03Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2742,24 +2746,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a123aba592623f6c89b951bf5b8f745a13698006"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njk1MTM3Ng==", "bodyText": "Does this need a\nif (deckPicker.mProgressDialog != null && deckPicker.mProgressDialog.isShowing()) {\n deckPicker.mProgressDialog.dismiss();\n      }", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r496951376", "createdAt": "2020-09-29T18:29:02Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2742,24 +2746,66 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+        private long cardSeen = 0;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(@NonNull DeckPicker deckPicker, @NonNull CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))\n+                    .positiveText(deckPicker.getResources().getString(R.string.yes))\n+                    .negativeText(deckPicker.getResources().getString(R.string.no))\n+                    .onNegative((x, y) -> actualOnPreExecute(deckPicker))\n+                    .onPositive((x, y) -> task.safeCancel()).show()\n+                    ;\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n-            deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask mEmptyCardTask = deckPicker.mEmptyCardTask;\n+                if (mEmptyCardTask != null) {\n+                    confirmCancel(deckPicker, mEmptyCardTask);\n+                }};\n+            deckPicker.mProgressDialog = new MaterialDialog.Builder(deckPicker)\n+                    .progress(false, mNumberOfCards)\n+                    .title(R.string.emtpy_cards_finding)\n+                    .cancelable(true)\n+                    .show();\n+            deckPicker.mProgressDialog.setOnCancelListener(onCancel);\n+            deckPicker.mProgressDialog.setCanceledOnTouchOutside(false);\n         }\n \n         @Override\n-        public void actualOnPostExecute(@NonNull DeckPicker deckPicker, TaskData result) {\n+        public void actualOnProgressUpdate(@NonNull DeckPicker deckPicker, @NonNull TaskData progress) {\n+            deckPicker.mProgressDialog.incrementProgress(progress.getInt());\n+        }\n+\n+        @Override\n+        public void actualOnCancelled(@NonNull DeckPicker deckPicker) {\n+            deckPicker.mEmptyCardTask = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a123aba592623f6c89b951bf5b8f745a13698006"}, "originalPosition": 80}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a123aba592623f6c89b951bf5b8f745a13698006", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a123aba592623f6c89b951bf5b8f745a13698006", "committedDate": "2020-09-29T06:10:56Z", "message": "Ask for confirmation to cancel"}, "afterCommit": {"oid": "3600eb6c369e0ee1732fe76b841ecff33f357029", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3600eb6c369e0ee1732fe76b841ecff33f357029", "committedDate": "2020-10-04T13:17:54Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNDQ5NzA2", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-503449706", "createdAt": "2020-10-07T00:34:58Z", "commit": {"oid": "3600eb6c369e0ee1732fe76b841ecff33f357029"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMDozNDo1OFrOHdejsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMDozNDo1OFrOHdejsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTQxMA==", "bodyText": "Nullable", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500671410", "createdAt": "2020-10-07T00:34:58Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -215,6 +217,8 @@\n \n     private String mExportFileName;\n \n+    private CollectionTask mEmptyCardTask = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3600eb6c369e0ee1732fe76b841ecff33f357029"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNDQ5ODcy", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-503449872", "createdAt": "2020-10-07T00:35:32Z", "commit": {"oid": "3600eb6c369e0ee1732fe76b841ecff33f357029"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMDozNTozM1rOHdekVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMDo0MTo0M1rOHdeqhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTU3Mg==", "bodyText": "You should be able to pass the IDs into this method directly", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500671572", "createdAt": "2020-10-07T00:35:33Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2757,24 +2761,65 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(@NonNull DeckPicker deckPicker, @NonNull CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3600eb6c369e0ee1732fe76b841ecff33f357029"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTczMQ==", "bodyText": "(nit: add a blank line after  }}; for readability)", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500671731", "createdAt": "2020-10-07T00:36:14Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2757,24 +2761,65 @@ public void onExtendStudyLimits() {\n     }\n \n     public void handleEmptyCards() {\n-        CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n+        mEmptyCardTask = CollectionTask.launchCollectionTask(FIND_EMPTY_CARDS, handlerEmptyCardListener());\n     }\n     private HandleEmptyCardListener handlerEmptyCardListener() {\n         return new HandleEmptyCardListener(this);\n     }\n     private static class HandleEmptyCardListener extends TaskListenerWithContext<DeckPicker> {\n+        private final int mNumberOfCards;\n+\n         public HandleEmptyCardListener(DeckPicker deckPicker) {\n             super(deckPicker);\n+            mNumberOfCards = deckPicker.getCol().cardCount();\n+        }\n+\n+        private void confirmCancel(@NonNull DeckPicker deckPicker, @NonNull CollectionTask task) {\n+            new MaterialDialog.Builder(deckPicker)\n+                    .content(deckPicker.getResources().getString(R.string.confirm_cancel))\n+                    .positiveText(deckPicker.getResources().getString(R.string.yes))\n+                    .negativeText(deckPicker.getResources().getString(R.string.no))\n+                    .onNegative((x, y) -> actualOnPreExecute(deckPicker))\n+                    .onPositive((x, y) -> task.safeCancel()).show()\n+                    ;\n         }\n \n         @Override\n         public void actualOnPreExecute(@NonNull DeckPicker deckPicker) {\n-            deckPicker.mProgressDialog = StyledProgressDialog.show(deckPicker, \"\",\n-                    deckPicker.getResources().getString(R.string.emtpy_cards_finding), false);\n+            DialogInterface.OnCancelListener onCancel = (dialogInterface) -> {\n+                CollectionTask mEmptyCardTask = deckPicker.mEmptyCardTask;\n+                if (mEmptyCardTask != null) {\n+                    confirmCancel(deckPicker, mEmptyCardTask);\n+                }};\n+            deckPicker.mProgressDialog = new MaterialDialog.Builder(deckPicker)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3600eb6c369e0ee1732fe76b841ecff33f357029"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MjEyNw==", "bodyText": "Please abstract out CollectionTask into a progress/cancellable listener as mentioned in the previous reviews. We shouldn't have a circular dependency from CollectionTask to Collection", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500672127", "createdAt": "2020-10-07T00:37:50Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -720,16 +720,37 @@ public void _remNotes(java.util.Collection<Long> ids) {\n \tpublic ArrayList<Long> genCards(List<Long> nids) {\n \t    return genCards(Utils.collection2Array(nids));\n \t}\n+\n+    public ArrayList<Long> genCards(List<Long> nids, @Nullable CollectionTask task) {\n+       return genCards(Utils.collection2Array(nids), task);\n+    }\n+\n     public ArrayList<Long> genCards(long[] nids) {\n+       return genCards(nids, null);\n+    }\n+\n+    /**\n+     * @param nids All ids of nodes of a note type\n+     * @param task Task to check for cancellation and update number of card processed\n+     * @return Cards that should be removed because they should not be generated\n+     */\n+    public ArrayList<Long> genCards(long[] nids, @Nullable CollectionTask task) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3600eb6c369e0ee1732fe76b841ecff33f357029"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MzEwMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"confirm_cancel\">Do you want to cancel ?</string>\n          \n          \n            \n                <string name=\"confirm_cancel\">Do you want to cancel?</string>", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500673100", "createdAt": "2020-10-07T00:41:32Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -145,10 +145,12 @@\n \n     <!-- Empty cards -->\n     <string name=\"emtpy_cards_finding\">Finding empty cards\u2026</string>\n+    <string name=\"confirm_cancel\">Do you want to cancel ?</string>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NTk2Mw=="}, "originalCommit": {"oid": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MzE1OQ==", "bodyText": "@mikehardy - yes/no is advised against in material guidelines, but I can't think of any better wording.\n\nDon\u2019t use action text that fails to indicate what the selection will do. \u201cCancel\u201d and \u201cDelete\u201d better indicate what will occur in this dialog.\n\nhttps://material.io/components/dialogs#alert-dialog\nCancel/Resume maybe?", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500673159", "createdAt": "2020-10-07T00:41:43Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -145,10 +145,12 @@\n \n     <!-- Empty cards -->\n     <string name=\"emtpy_cards_finding\">Finding empty cards\u2026</string>\n+    <string name=\"confirm_cancel\">Do you want to cancel ?</string>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5NTk2Mw=="}, "originalCommit": {"oid": "926ccc3f2010d5e9f186cf6b4bfc3a9460aa52b2"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3600eb6c369e0ee1732fe76b841ecff33f357029", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3600eb6c369e0ee1732fe76b841ecff33f357029", "committedDate": "2020-10-04T13:17:54Z", "message": "Ask for confirmation to cancel"}, "afterCommit": {"oid": "3a4ef38cde61b09a01585eb86ff1b3477c61a2a0", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3a4ef38cde61b09a01585eb86ff1b3477c61a2a0", "committedDate": "2020-10-07T10:07:28Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODMxNTUw", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-503831550", "createdAt": "2020-10-07T12:37:54Z", "commit": {"oid": "3a4ef38cde61b09a01585eb86ff1b3477c61a2a0"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMjozNzo1NFrOHdxNIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMjozODoxNFrOHdxN7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NjkzMA==", "bodyText": "@FunctionalInterface", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500976930", "createdAt": "2020-10-07T12:37:54Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/ProgressSender.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package com.ichi2.async;\n+\n+public interface ProgressSender<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a4ef38cde61b09a01585eb86ff1b3477c61a2a0"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NzEzNA==", "bodyText": "@FunctionalInterface", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r500977134", "createdAt": "2020-10-07T12:38:14Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CancelListener.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package com.ichi2.async;\n+\n+public interface CancelListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a4ef38cde61b09a01585eb86ff1b3477c61a2a0"}, "originalPosition": 3}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a4ef38cde61b09a01585eb86ff1b3477c61a2a0", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3a4ef38cde61b09a01585eb86ff1b3477c61a2a0", "committedDate": "2020-10-07T10:07:28Z", "message": "Ask for confirmation to cancel"}, "afterCommit": {"oid": "a0dea0f70216ea5ad971dd8c4038020ff98be6e7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a0dea0f70216ea5ad971dd8c4038020ff98be6e7", "committedDate": "2020-10-07T14:31:37Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NDg5OTA5", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#pullrequestreview-508489909", "createdAt": "2020-10-14T15:48:55Z", "commit": {"oid": "e1916fc304bb293db3c8322d3a4d07f3ad043da7"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNTo0ODo1NVrOHhZuFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNTo1MDowNFrOHhZxgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc4NjQ1Mg==", "bodyText": "Needs a copyright header", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r504786452", "createdAt": "2020-10-14T15:48:55Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CancelListener.java", "diffHunk": "@@ -0,0 +1,6 @@\n+package com.ichi2.async;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1916fc304bb293db3c8322d3a4d07f3ad043da7"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc4NzMzMQ==", "bodyText": "copyright header here too", "url": "https://github.com/ankidroid/Anki-Android/pull/7290#discussion_r504787331", "createdAt": "2020-10-14T15:50:04Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/ProgressSender.java", "diffHunk": "@@ -0,0 +1,6 @@\n+package com.ichi2.async;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0d12096ae414f42613438d2d35b38755db278a7"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5e4451826a8299a6199f1a36da82309ada672f1", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b5e4451826a8299a6199f1a36da82309ada672f1", "committedDate": "2020-10-14T18:32:49Z", "message": "NF: comment genCards"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "307ec031670d91603a2f1770b8598c796f678c5d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/307ec031670d91603a2f1770b8598c796f678c5d", "committedDate": "2020-10-14T18:33:46Z", "message": "NF: CancelListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f5130398bd793cb2818296523bea83179fe2530", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5f5130398bd793cb2818296523bea83179fe2530", "committedDate": "2020-10-14T18:34:00Z", "message": "NF: ProgressSender"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d7c585917ef24ee2cdba056cddf57b70928449", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d8d7c585917ef24ee2cdba056cddf57b70928449", "committedDate": "2020-10-14T18:34:01Z", "message": "Empty card update on number of card checked"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d4d4fc167435b43963514cf4fe738c07bda8bf5", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4d4d4fc167435b43963514cf4fe738c07bda8bf5", "committedDate": "2020-10-14T18:34:01Z", "message": "Empty card is cancellable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cabe7821886a89acb68ab259943cec5b3ed6c52", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2cabe7821886a89acb68ab259943cec5b3ed6c52", "committedDate": "2020-10-14T18:34:01Z", "message": "Don't cancel on touch\n\nOtherwise any touch on the screen cancel by acciddent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05705f16e404cd098e77566a9cf0868cc1868668", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/05705f16e404cd098e77566a9cf0868cc1868668", "committedDate": "2020-10-14T18:34:01Z", "message": "Ask for confirmation to cancel"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0dea0f70216ea5ad971dd8c4038020ff98be6e7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a0dea0f70216ea5ad971dd8c4038020ff98be6e7", "committedDate": "2020-10-07T14:31:37Z", "message": "Ask for confirmation to cancel"}, "afterCommit": {"oid": "05705f16e404cd098e77566a9cf0868cc1868668", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/05705f16e404cd098e77566a9cf0868cc1868668", "committedDate": "2020-10-14T18:34:01Z", "message": "Ask for confirmation to cancel"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3916, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}