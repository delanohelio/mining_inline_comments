{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMzUyNjE3", "number": 5855, "title": "Add File Space Warning before Check Database", "bodyText": "Purpose / Description\nWe are having problems with users performing check database with insufficient file space. This causes a crash.\nFixes\nPartially #5852\nApproach\nWe discourage the user from performing check database without enough file space.\nHow Has This Been Tested?\nNothing normally. This when I reverse the condition,\n\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code\n\nReview Goals\n\nText - preamble feels too long without explaining the issue.\nUI flows\n\nSeeing this when immediately opening the app seems too strong and may scare users. Maybe we want a pre-dialog stating on this case stating that the update fixes some issues and it's advised to run it, rather than forcing a check.\n\n\n\nNotes\nThis appears on database error (also used by the manual check database button), and on startup.", "createdAt": "2020-03-23T12:22:20Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5855", "merged": true, "mergeCommit": {"oid": "11d6a6f2470137824ad973019d2b08f335628b20"}, "closed": true, "closedAt": "2020-03-24T18:46:13Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQS25-AH2gAyMzkyMzUyNjE3OjU1YWYxNTM5ZTc4ODc1YjA3YWZjZjQzYzJmMDVhY2E3MTc1MDQwOWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ2nU9AFqTM4MDU1NDcxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "55af1539e78875b07afcf43c2f05aca71750409e", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/55af1539e78875b07afcf43c2f05aca71750409e", "committedDate": "2020-03-23T00:07:08Z", "message": "Extract: performIntegrityCheck\n\nWe want to add in a dialog box under certain circumstances, this is the\nfirst step, as it allows us to conditionally call the 'meat' of the\nmethod without changing the public signature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0abdf288e00a924ba5f106742ed0556ef21efafe", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0abdf288e00a924ba5f106742ed0556ef21efafe", "committedDate": "2020-03-23T02:03:31Z", "message": "Extract method: getFreeDiscSpace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/34e9f70abea29826f0d5f5e13fb60f2a75e8e15e", "committedDate": "2020-03-23T12:14:44Z", "message": "Check Database: File Space warning\n\nWe are having problems with users performing check database with\ninsufficient file space. This causes a crash.\n\nTo remedy this, we discourage the user from performing check database\nwithout enough file space."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDI5MjQ5", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#pullrequestreview-379429249", "createdAt": "2020-03-23T13:31:21Z", "commit": {"oid": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMzozMToyMVrOF6FeNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMzo0MjoxOVrOF6F7Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1MTM4Mg==", "bodyText": "These strings are basically all the same. Some have a hard value in them and some are interpolated. This one has a misspelling ('colection') but in general the less strings the better - nothing should be repeated. I think we can have one general string (that is always interpolated, then 150MB (or whatever) can be sent in for those cases otherwise it gets the dynamic value. Then just one extra string you can concatenate that says how much free space there is now.", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396451382", "createdAt": "2020-03-23T13:31:21Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -151,4 +151,13 @@\n     <string name=\"collection_load_welcome_request_permissions_title\">Welcome to AnkiDroid!</string>\n     <string name=\"collection_load_welcome_request_permissions_details\">AnkiDroid requires storage permission, which we use exclusively to store your AnkiDroid collection, flashcard media and backups. Our code is open-source, written by volunteers, and trusted by millions.\\n\\nIf you have any questions, please access our in-app manual or visit our support forums.\\n\\nThank you for trying AnkiDroid!\\n\u2014AnkiDroid Development Team</string>\n     <string name=\"mutimedia_editor_assertion_failed\">Unknown error occurred displaying Advanced Editor</string>\n+\n+    <!-- Database Integrity Check -->\n+    <string name=\"integrity_check_continue_anyway\">Continue Anyway</string>\n+    <string name=\"integrity_check_insufficient_space\">Check Database uses a large amount of temporary storage.\\n\\nIt is strongly recommended that you have at least %s free space on your device before continuing.\\n\\nYou currently have %s free.</string>\n+\n+    <string name=\"integrity_check_error_colection_load_failed\">Check Database uses a large amount of temporary storage.\\n\\nIt is strongly recommended that you have at least 150MB free space on your device before continuing.</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1NTE4OA==", "bodyText": "this comment is too cryptic for me \ud83e\udd23", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396455188", "createdAt": "2020-03-23T13:37:00Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -225,4 +239,82 @@ private static String getParentDirectory(String path) {\n         return new File(path).getParentFile().getAbsolutePath();\n     }\n \n+    /** Union: (required space * free space) | Error */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1NzY0NQ==", "bodyText": "I have to admit I don't like the wtf's. Timber says \"log an assert message\", but what does that mean? Are these all going to change behavior unexpectedly and stop effectively mapping to error / start actually being a hard crash assert when the new Android Studio 4 de-sugaring comes in? I'd rather stick with Timber.d through Timber.e", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396457645", "createdAt": "2020-03-23T13:40:37Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -225,4 +239,82 @@ private static String getParentDirectory(String path) {\n         return new File(path).getParentFile().getAbsolutePath();\n     }\n \n+    /** Union: (required space * free space) | Error */\n+    public static class CollectionIntegrityCheckStatus {\n+\n+        @Nullable\n+        private final String mErrorMessage;\n+\n+        //OR:\n+        @Nullable\n+        private final Long mRequiredSpace;\n+        @Nullable\n+        private final Long mFreeSpace;\n+\n+        private CollectionIntegrityCheckStatus(long requiredSpace, long freeSpace) {\n+            this.mFreeSpace = freeSpace;\n+            this.mRequiredSpace = requiredSpace;\n+            this.mErrorMessage = null;\n+        }\n+\n+        private CollectionIntegrityCheckStatus(@NonNull String errorMessage) {\n+            this.mRequiredSpace = null;\n+            this.mFreeSpace = null;\n+            this.mErrorMessage = errorMessage;\n+        }\n+\n+        private static CollectionIntegrityCheckStatus fromError(String errorMessage) {\n+            return new CollectionIntegrityCheckStatus(errorMessage);\n+        }\n+\n+        public static CollectionIntegrityCheckStatus createInstance(Context context) {\n+\n+            Long maybeCurrentCollectionSizeInBytes = getCollectionSize(context);\n+            if (maybeCurrentCollectionSizeInBytes == null) {\n+                return fromError(context.getResources().getString(R.string.integrity_check_error_colection_load_failed));\n+            }\n+\n+            // This means that when VACUUMing a database, as much as twice the size of the original database file is\n+            // required in free disk space. - https://www.sqlite.org/lang_vacuum.html\n+            long requiredSpaceInBytes = maybeCurrentCollectionSizeInBytes * 2;\n+\n+            // We currently use the same directory as the collection for VACUUM/ANALYZE due to the SQLite APIs\n+            File collectionFile = new File(getCollectionPath(context));\n+            long freeSpace = FileUtil.getFreeDiskSpace(collectionFile, -1);\n+\n+            if (freeSpace == -1) {\n+                String readableFileSize  = Formatter.formatFileSize(context, requiredSpaceInBytes);\n+                return fromError(context.getResources().getString(R.string.integrity_check_error_remaining_filesystem_size_failed, readableFileSize));\n+            }\n+\n+            return new CollectionIntegrityCheckStatus(requiredSpaceInBytes, freeSpace);\n+        }\n+\n+        public boolean shouldWarnOnIntegrityCheck() {\n+            return this.mErrorMessage != null || fileSystemDoesNotHaveSpaceForBackup();\n+        }\n+\n+        private boolean fileSystemDoesNotHaveSpaceForBackup() {\n+            //only to be called when mErrorMessage == null\n+            if (mFreeSpace == null || mRequiredSpace == null) {\n+                Timber.wtf(\"fileSystemDoesNotHaveSpaceForBackup called in invalid state.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1ODc5MQ==", "bodyText": "The name is CollectionIntegrityCheckStatus but the logic is all \"do I have space for fix integrity\", should it be CollectionIntegrityStorageCheck\" or something else similar that bakes the idea it's all storage-related into it, instead of sounding like it's more general?", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396458791", "createdAt": "2020-03-23T13:42:19Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -225,4 +239,82 @@ private static String getParentDirectory(String path) {\n         return new File(path).getParentFile().getAbsolutePath();\n     }\n \n+    /** Union: (required space * free space) | Error */\n+    public static class CollectionIntegrityCheckStatus {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34e9f70abea29826f0d5f5e13fb60f2a75e8e15e"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e95dd48b9906ac3c5584cc7b92ec77076721b724", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e95dd48b9906ac3c5584cc7b92ec77076721b724", "committedDate": "2020-03-23T13:47:08Z", "message": "NF: Rename CollectionIntegrityStorageCheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "315f30c07997140bed7799c762b35afc39bc4fc4", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/315f30c07997140bed7799c762b35afc39bc4fc4", "committedDate": "2020-03-23T13:49:19Z", "message": "NF: Improve comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f7e463dcb20ab318acd5ba6bc01502b2fb3316", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d3f7e463dcb20ab318acd5ba6bc01502b2fb3316", "committedDate": "2020-03-23T13:49:51Z", "message": "Timber.wtf -> Timber.e"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5334b203db7402b09d62cb5e9998a1d6afa8c155", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5334b203db7402b09d62cb5e9998a1d6afa8c155", "committedDate": "2020-03-23T14:16:10Z", "message": "Reduced string constants in Integrity Check\n\nFactored out default into code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89a7f6450c506f9c445516c05ee0c89b0d459f11", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/89a7f6450c506f9c445516c05ee0c89b0d459f11", "committedDate": "2020-03-23T15:59:01Z", "message": "Dialog for Confirm Database check on upgrade\n\nWe added in a dialog to warn about file size if someone performs a check\ndatabase without space. This can come up unexpectedly when a user\nperforms check database, so we want to let a user know what is\nhappening first."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NjEwMzg0", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#pullrequestreview-379610384", "createdAt": "2020-03-23T16:39:09Z", "commit": {"oid": "89a7f6450c506f9c445516c05ee0c89b0d459f11"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNjozOTowOVrOF6OD3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNjo0MDowOFrOF6OGlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU5MjA5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"integrity_check_startup_content\">AnkiDroid has been upgraded. It is advised that you check and optimise your database to ensure an optimal user experience.</string>\n          \n          \n            \n                <string name=\"integrity_check_startup_content\">AnkiDroid has been upgraded. This upgrade includes fixes for possible database problems, and we advise you to run check database now.</string>\n          \n      \n    \n    \n  \n\nMy only hesitation here is that I can imagine a time when the check is not optional. Right now I think the checks are all \"grooming\" type things so they are optional, so I kind of like the idea of letting the user skip it, but in the future we may need another option that is more direct and not-cancellable\nOn balance, I approve of this with the wording tweak (where I studiously avoided en-US or en-GB :) )", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396592093", "createdAt": "2020-03-23T16:39:09Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -151,4 +151,12 @@\n     <string name=\"collection_load_welcome_request_permissions_title\">Welcome to AnkiDroid!</string>\n     <string name=\"collection_load_welcome_request_permissions_details\">AnkiDroid requires storage permission, which we use exclusively to store your AnkiDroid collection, flashcard media and backups. Our code is open-source, written by volunteers, and trusted by millions.\\n\\nIf you have any questions, please access our in-app manual or visit our support forums.\\n\\nThank you for trying AnkiDroid!\\n\u2014AnkiDroid Development Team</string>\n     <string name=\"mutimedia_editor_assertion_failed\">Unknown error occurred displaying Advanced Editor</string>\n+\n+    <!-- Database Integrity Check -->\n+    <string name=\"integrity_check_startup_title\">AnkiDroid Upgraded</string>\n+    <string name=\"integrity_check_startup_content\">AnkiDroid has been upgraded. It is advised that you check and optimise your database to ensure an optimal user experience.</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a7f6450c506f9c445516c05ee0c89b0d459f11"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU5Mjc4OQ==", "bodyText": "I still don't like that the string is almost completely duplicated, it increases translator load for no value I can discern", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#discussion_r396592789", "createdAt": "2020-03-23T16:40:08Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -151,4 +151,12 @@\n     <string name=\"collection_load_welcome_request_permissions_title\">Welcome to AnkiDroid!</string>\n     <string name=\"collection_load_welcome_request_permissions_details\">AnkiDroid requires storage permission, which we use exclusively to store your AnkiDroid collection, flashcard media and backups. Our code is open-source, written by volunteers, and trusted by millions.\\n\\nIf you have any questions, please access our in-app manual or visit our support forums.\\n\\nThank you for trying AnkiDroid!\\n\u2014AnkiDroid Development Team</string>\n     <string name=\"mutimedia_editor_assertion_failed\">Unknown error occurred displaying Advanced Editor</string>\n+\n+    <!-- Database Integrity Check -->\n+    <string name=\"integrity_check_startup_title\">AnkiDroid Upgraded</string>\n+    <string name=\"integrity_check_startup_content\">AnkiDroid has been upgraded. It is advised that you check and optimise your database to ensure an optimal user experience.</string>\n+    <string name=\"integrity_check_positive\">Check Database</string>\n+    <string name=\"integrity_check_continue_anyway\">Continue Anyway</string>\n+    <string name=\"integrity_check_insufficient_space\">Check Database uses a large amount of temporary storage.\\n\\nIt is strongly recommended that you have at least %s free space on your device before continuing.\\n\\nYou currently have %s free.</string>>\n+    <string name=\"integrity_check_maybe_insufficient_space\">Check Database uses a large amount of temporary storage.\\n\\nIt is strongly recommended that you have at least %s free space on your device before continuing.</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a7f6450c506f9c445516c05ee0c89b0d459f11"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e1015f871c77b1907a520246a93235a4cc800c8", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0e1015f871c77b1907a520246a93235a4cc800c8", "committedDate": "2020-03-23T17:06:49Z", "message": "Update content for check database\n\nCo-Authored-By: Mike Hardy <github@mikehardy.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acc715e8f255977bf56d4419279fceff51b33b9e", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/acc715e8f255977bf56d4419279fceff51b33b9e", "committedDate": "2020-03-23T17:22:06Z", "message": "Refactor: Change translation to use concat"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzU4NDMy", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#pullrequestreview-379758432", "createdAt": "2020-03-23T19:33:44Z", "commit": {"oid": "acc715e8f255977bf56d4419279fceff51b33b9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdda9d086b38c73f398ca33c36a3a48695cbbb11", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fdda9d086b38c73f398ca33c36a3a48695cbbb11", "committedDate": "2020-03-23T19:51:24Z", "message": "NF: Added additional logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNTU0NzE4", "url": "https://github.com/ankidroid/Anki-Android/pull/5855#pullrequestreview-380554718", "createdAt": "2020-03-24T17:46:43Z", "commit": {"oid": "fdda9d086b38c73f398ca33c36a3a48695cbbb11"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3545, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}