{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NDkzOTk1", "number": 6638, "title": "Check deck tree update name map", "bodyText": "Pull Request template\nPurpose / Description\nI was thinking \"in case of problem, we just have to construct the name map again once they are corrected\".\nI didn't fully grasp that name map was actually used in the deck manager and that _checkDeckTree uses the deck manager, E.g. to ensure parents are created. So I need to ensure that the name map stays consistent during the whole computation.\nFixes\nShould fix #6636\nApproach\nWhen a deck is renamed (e.g. because blank, because duplicate) the information is directly given to the name map, so that the remaining of the code can find this name.\nFurthermore, we uses a map instead of a set, this way, when we find a duplicate, we also find the original deck and ensure both are in the name map (the original may have been erased when adding the duplicate)\nHow Has This Been Tested?\nRunning on my phone. However, as it's a problem that should rarely occurs, I can't test it in real life.\nLearning (optional, can help others)\nCode which deals with accident (duplicate name, empty names)... is harder to think through than normal code, since usual assumptions are broken. Those assumption may be repaired, but the method which repair them still need to deal with the broken collection\n@mikehardy I didn't pay attention when you added isValidDeckName, but the name is not really correct.\nNowaday, valid deck name should not contains \"::::\", and no part of the name should starts or end with spaces.  However, I don't know whether you want to send error message for spaces as we can easily trim them. That should occur in a different PR I assume\nDeck names which are not normalized UTF-8 are not valid either, and I don't know if it's possible for a user to actually enter that except if they are really trying to do it\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-07-06T01:34:04Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6638", "merged": true, "mergeCommit": {"oid": "92cf529989f9219f90355ad5b27f0c4d667bee94"}, "closed": true, "closedAt": "2020-07-06T15:12:54Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyHKDsgFqTQ0MjczMTY1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyJZ3zAFqTQ0Mjc2NTM5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNzMxNjU0", "url": "https://github.com/ankidroid/Anki-Android/pull/6638#pullrequestreview-442731654", "createdAt": "2020-07-06T01:39:31Z", "commit": {"oid": "cf53a8be62fe51de85492dacbb539bc5ca1b938d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwMTozOTozMVrOGtGj9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwMTozOTozMVrOGtGj9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk0NjYxNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                deckName = deckName + \"+\";\n          \n          \n            \n                                deckName += \"+\";", "url": "https://github.com/ankidroid/Anki-Android/pull/6638#discussion_r449946615", "createdAt": "2020-07-06T01:39:31Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -885,44 +885,48 @@ private void _checkDeckTree() {\n         boolean correction = false;\n \n         for (JSONObject deck: decks) {\n+            String deckName = deck.getString(\"name\");\n             // ensure no sections are blank\n-            if (\"\".equals(deck.getString(\"name\"))) {\n+            if (\"\".equals(deckName)) {\n                 Timber.i(\"Fix deck with empty name\");\n+                deckName = \"blank\";\n                 deck.put(\"name\", \"blank\");\n                 save(deck);\n                 correction = true;\n             }\n \n-            if (deck.getString(\"name\").indexOf(\"::::\") != -1) {\n+            if (deckName.indexOf(\"::::\") != -1) {\n                 Timber.i(\"fix deck with missing sections %s\", deck.getString(\"name\"));\n                 do {\n-                    deck.put(\"name\", deck.getString(\"name\").replace(\"::::\", \"::blank::\"));\n+                    deckName = deck.getString(\"name\").replace(\"::::\", \"::blank::\");\n                     // We may need to iterate, in order to replace \"::::::\" and adding to \"blank\" in it.\n-                } while (deck.getString(\"name\").indexOf(\"::::\") != -1);\n+                } while (deckName.indexOf(\"::::\") != -1);\n+                deck.put(\"name\", deckName);\n                 save(deck);\n                 correction = true;\n             }\n \n             // two decks with the same name?\n-            if (names.containsKey(normalizeName(deck.getString(\"name\")))) {\n-                Timber.i(\"fix duplicate deck name %s\", deck.getString(\"name\"));\n+            if (names.containsKey(normalizeName(deckName))) {\n+                Timber.i(\"fix duplicate deck name %s\", deckName);\n                 do {\n-                    deck.put(\"name\", deck.getString(\"name\") + \"+\");\n-                } while (names.containsKey(normalizeName(deck.getString(\"name\"))));\n+                    deckName = deckName + \"+\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf53a8be62fe51de85492dacbb539bc5ca1b938d"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "757e5431941aa3f574f9b86112e3896ad54e3d30", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/757e5431941aa3f574f9b86112e3896ad54e3d30", "committedDate": "2020-07-06T02:03:28Z", "message": "Test failing on 6636"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "562efb4dbfe185630577c4163f857ca3c057ce63", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/562efb4dbfe185630577c4163f857ca3c057ce63", "committedDate": "2020-07-06T02:03:33Z", "message": "NF: _checkDeckTree saves map to parent\n\nThis will ensure that if there is a duplicate, we find the previous version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bb21c1ec1bbd58cea5b262d26d0e67a037cd9d8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5bb21c1ec1bbd58cea5b262d26d0e67a037cd9d8", "committedDate": "2020-07-06T02:03:33Z", "message": "NF: name map: remove redundant name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b08b089eb4fb6ff5d41acf54c59371c6e29958e0", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b08b089eb4fb6ff5d41acf54c59371c6e29958e0", "committedDate": "2020-07-06T02:03:33Z", "message": "NF: _checkDeckTree string deckName to simplify text"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a08280d72f0d09650c1a94a841fa79d718bb378a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a08280d72f0d09650c1a94a841fa79d718bb378a", "committedDate": "2020-07-06T02:03:33Z", "message": "_checkDeckTree keeps nameMap updated with its value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc1dfcca1a91437871959ee933c19529b4181a0", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/adc1dfcca1a91437871959ee933c19529b4181a0", "committedDate": "2020-07-06T02:03:33Z", "message": "NF: remove correction in _checkDeckTree"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd0e8ab6957f0625223065ce76b310ccc519ef51", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/dd0e8ab6957f0625223065ce76b310ccc519ef51", "committedDate": "2020-07-06T02:03:33Z", "message": "NF: remove resetNameMap\n\nIt became useless since it is now created only at construction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10aa9d548bef726e331556cf521bb3e42879b878", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/10aa9d548bef726e331556cf521bb3e42879b878", "committedDate": "2020-07-06T02:03:33Z", "message": "Update AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\nCo-authored-by: david-allison-1 <62114487+david-allison-1@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80b1def2ab968d5c35a96b3ae47980c1ad2058ad", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/80b1def2ab968d5c35a96b3ae47980c1ad2058ad", "committedDate": "2020-07-06T01:56:25Z", "message": "Test failing on 6636"}, "afterCommit": {"oid": "10aa9d548bef726e331556cf521bb3e42879b878", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/10aa9d548bef726e331556cf521bb3e42879b878", "committedDate": "2020-07-06T02:03:33Z", "message": "Update AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\nCo-authored-by: david-allison-1 <62114487+david-allison-1@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNzY1Mzk1", "url": "https://github.com/ankidroid/Anki-Android/pull/6638#pullrequestreview-442765395", "createdAt": "2020-07-06T04:19:42Z", "commit": {"oid": "10aa9d548bef726e331556cf521bb3e42879b878"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3092, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}