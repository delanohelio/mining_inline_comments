{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5OTUxNzM3", "number": 7181, "title": "Add \"Search Decks\" to Deck Picker", "bodyText": "Purpose / Description\nSome users wanted this\nFixes\nFixes #7116\nApproach\n\nSearchView and Filter\nIf a deck matches the search string, then all children are visible\nIf a deck matches the search string, then all parents are visible\n\nHow Has This Been Tested?\nOn my Android 9 with the AnKing deck. Worked as expected.\n\n\"Create Deck\" result is only visible if searched\nDecks which are not visible can be reviewed if the parent is selected.\nNesting works as expected\nTested on my Android Emulator\nKeyboard shortcuts no longer get in the way\n\n\n\n\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-09-20T20:10:24Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7181", "merged": true, "mergeCommit": {"oid": "f2831f8dd7e6df149aaf6c8630a28e93611c75bf"}, "closed": true, "closedAt": "2020-09-21T21:25:50Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKhUBigH2gAyNDg5OTUxNzM3OmFkOWI4NzY5M2E5ZDQ3MDVkNzdlNzBiOTVjNzFkNWYwYjY5Y2JkZmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLFReggBqjM3ODkzMzc2MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ad9b87693a9d4705d77e70b95c71d5f0b69cbdff", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ad9b87693a9d4705d77e70b95c71d5f0b69cbdff", "committedDate": "2020-09-19T21:45:13Z", "message": "NF: Deck Picker: Extract getNodeByDid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb439f6ed238ee2c1e323cdaabd1415c90427d29", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/bb439f6ed238ee2c1e323cdaabd1415c90427d29", "committedDate": "2020-09-20T19:50:15Z", "message": "NF: Add FilterResultsUtils\n\nQuick harmless refactoring to reduce code\n\nTo be used again in 7116"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "620883f91daf677fbbe997f3b1dafb1667587726", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/620883f91daf677fbbe997f3b1dafb1667587726", "committedDate": "2020-09-20T20:10:03Z", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116"}, "afterCommit": {"oid": "86c26f1d4014284c757ade154f3f930c3f5e102a", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/86c26f1d4014284c757ade154f3f930c3f5e102a", "committedDate": "2020-09-20T20:14:05Z", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86c26f1d4014284c757ade154f3f930c3f5e102a", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/86c26f1d4014284c757ade154f3f930c3f5e102a", "committedDate": "2020-09-20T20:14:05Z", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116"}, "afterCommit": {"oid": "c1316eba3f37d62abf936c2722c52c68f25a63f4", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c1316eba3f37d62abf936c2722c52c68f25a63f4", "committedDate": "2020-09-20T20:40:53Z", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMjUxMzYy", "url": "https://github.com/ankidroid/Anki-Android/pull/7181#pullrequestreview-492251362", "createdAt": "2020-09-21T02:18:09Z", "commit": {"oid": "c1316eba3f37d62abf936c2722c52c68f25a63f4"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwMjoxODowOVrOHU_IZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwMjoyMDowMVrOHU_JpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc2NzkxMQ==", "bodyText": "Extract this above", "url": "https://github.com/ankidroid/Anki-Android/pull/7181#discussion_r491767911", "createdAt": "2020-09-21T02:18:09Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2384,11 +2411,15 @@ public void __renderPage() {\n             if (getSupportActionBar() != null) {\n                 getSupportActionBar().setSubtitle(null);\n             }\n+            if (mToolbarSearchView != null) {\n+                mDeckListAdapter.getFilter().filter(mToolbarSearchView.getQuery());\n+            }\n             // We're done here\n             return;\n         }\n \n-        mDeckListAdapter.buildDeckList(mDueTree, getCol());\n+        CharSequence filter = mToolbarSearchView != null ? mToolbarSearchView.getQuery() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1316eba3f37d62abf936c2722c52c68f25a63f4"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc2ODA3OQ==", "bodyText": "Only necessary to add a private constructor - needs no code", "url": "https://github.com/ankidroid/Anki-Android/pull/7181#discussion_r491768079", "createdAt": "2020-09-21T02:19:16Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/widgets/DeckAdapter.java", "diffHunk": "@@ -346,7 +361,87 @@ public Integer getDue() {\n         }\n     }\n \n-    public List<AbstractDeckTreeNode> getDeckList() {\n-        return mDeckList;\n+    private List<AbstractDeckTreeNode> getDeckList() {\n+        return mCurrentDeckList;\n+    }\n+\n+\n+    @Override\n+    public Filter getFilter() {\n+        return new DeckFilter();\n+    }\n+\n+\n+    private class DeckFilter extends Filter {\n+        private ArrayList<AbstractDeckTreeNode> mFilteredDecks;\n+        private DeckFilter() {\n+            super();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1316eba3f37d62abf936c2722c52c68f25a63f4"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc2ODIyOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // If a deck contains the string, then all ts children are valid\n          \n          \n            \n                        // If a deck contains the string, then all its children are valid", "url": "https://github.com/ankidroid/Anki-Android/pull/7181#discussion_r491768228", "createdAt": "2020-09-21T02:20:01Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/widgets/DeckAdapter.java", "diffHunk": "@@ -346,7 +361,87 @@ public Integer getDue() {\n         }\n     }\n \n-    public List<AbstractDeckTreeNode> getDeckList() {\n-        return mDeckList;\n+    private List<AbstractDeckTreeNode> getDeckList() {\n+        return mCurrentDeckList;\n+    }\n+\n+\n+    @Override\n+    public Filter getFilter() {\n+        return new DeckFilter();\n+    }\n+\n+\n+    private class DeckFilter extends Filter {\n+        private ArrayList<AbstractDeckTreeNode> mFilteredDecks;\n+        private DeckFilter() {\n+            super();\n+            mFilteredDecks = new ArrayList<>();\n+        }\n+\n+        private List<AbstractDeckTreeNode> getAllDecks() {\n+            return mDeckList;\n+        }\n+\n+        @Override\n+        protected FilterResults performFiltering(CharSequence constraint) {\n+            mFilteredDecks.clear();\n+\n+            List<AbstractDeckTreeNode> allDecks = getAllDecks();\n+            if (TextUtils.isEmpty(constraint)) {\n+                mFilteredDecks.addAll(allDecks);\n+            } else {\n+                final String filterPattern = constraint.toString().toLowerCase().trim();\n+                List<AbstractDeckTreeNode> filteredDecks = filterDecks(filterPattern, allDecks);\n+                mFilteredDecks.addAll(filteredDecks);\n+            }\n+\n+            return FilterResultsUtils.fromCollection(mFilteredDecks);\n+        }\n+\n+        @Override\n+        protected void publishResults(CharSequence constraint, FilterResults results) {\n+            mCurrentDeckList.clear();\n+            mCurrentDeckList.addAll(mFilteredDecks);\n+            notifyDataSetChanged();\n+        }\n+\n+\n+        private List<AbstractDeckTreeNode> filterDecks(String filterPattern, List<AbstractDeckTreeNode> allDecks) {\n+            ArrayList<AbstractDeckTreeNode> ret = new ArrayList<>();\n+            for (AbstractDeckTreeNode tag : allDecks) {\n+                AbstractDeckTreeNode node = filterDeckInternal(filterPattern, tag);\n+                if (node != null) {\n+                    ret.add(node);\n+                }\n+            }\n+            return ret;\n+        }\n+\n+        @Nullable\n+        private <T extends AbstractDeckTreeNode<T>> T filterDeckInternal(String filterPattern, T root) {\n+\n+            // If a deck contains the string, then all ts children are valid", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1316eba3f37d62abf936c2722c52c68f25a63f4"}, "originalPosition": 168}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNzE3NjQ2", "url": "https://github.com/ankidroid/Anki-Android/pull/7181#pullrequestreview-492717646", "createdAt": "2020-09-21T15:10:55Z", "commit": {"oid": "c1316eba3f37d62abf936c2722c52c68f25a63f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d19efd0bcb3e1a6b6a209bc8c8b7aa69a8c13cf", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2d19efd0bcb3e1a6b6a209bc8c8b7aa69a8c13cf", "committedDate": "2020-09-21T15:38:48Z", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1316eba3f37d62abf936c2722c52c68f25a63f4", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c1316eba3f37d62abf936c2722c52c68f25a63f4", "committedDate": "2020-09-20T20:40:53Z", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116"}, "afterCommit": {"oid": "2d19efd0bcb3e1a6b6a209bc8c8b7aa69a8c13cf", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2d19efd0bcb3e1a6b6a209bc8c8b7aa69a8c13cf", "committedDate": "2020-09-21T15:38:48Z", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4018, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}