{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MzQzODU0", "number": 7126, "title": "HACK - Use Clipboard to allow MIUI Cloze", "bodyText": "NOTE: Defaults to true\nPurpose / Description\nMIUI users can't use Cloze due to the OS being a pain.\nWe've had a lot of 5* ratings and support queries about this, let's send some love back to these users.\nApproach\nWe add the selected value to the clipboard surrounded by cloze marks\nThis allows MIUI users with GBoard to paste it in immediately (and other keyboards to use Paste)\nHACK before #7124 obsoletes this\nHow Has This Been Tested?\nAndroid 9: I returned false for hasContextMenu and it worked\nAPI 16 emulator\n\nPreference is not visible normally\nOnly work with Cloze\nPreference is enabled by default and handles this case\nPreference can be disabled\nWorks\n\nLearning\nhttps://stackoverflow.com/questions/47610456/how-to-detect-miui-rom-programmatically-in-android\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-09-17T01:18:34Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7126", "merged": true, "mergeCommit": {"oid": "43151b618758c80b2bd4b7134f498a56f5b27170"}, "closed": true, "closedAt": "2020-09-17T04:16:06Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJnXTJAH2gAyNDg4MzQzODU0Ojc0MjI1Zjg5NGRiMmY4ZTRiZjQwNzA2Y2ZhM2NiNjAzNzdhNzIxM2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJn5dqgFqTQ5MDIwNzE0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "74225f894db2f8e4bf40706cfa3cb60377a7213b", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/74225f894db2f8e4bf40706cfa3cb60377a7213b", "committedDate": "2020-09-17T02:14:18Z", "message": "HACK - Use Clipboard to allow MIUI Cloze\n\nWe add the selected value to the clipboard surrounded by cloze marks\n\nThis allows MIUI users with GBoard to paste it in immediately (and other keyboards to use Paste)\n\nHACK before 7124 obsoletes this"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "602662f8d4567ca1559e2d35e636c06e8b3952bd", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/602662f8d4567ca1559e2d35e636c06e8b3952bd", "committedDate": "2020-09-17T01:17:01Z", "message": "HACK - Use Clipboard to allow MIUI Cloze\n\nWe add the selected value to the clipboard surrounded by cloze marks\n\nThis allows MIUI users with GBoard to paste it in immediately (and other keyboards to use Paste)\n\nHACK before 7124 obsoletes this"}, "afterCommit": {"oid": "74225f894db2f8e4bf40706cfa3cb60377a7213b", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/74225f894db2f8e4bf40706cfa3cb60377a7213b", "committedDate": "2020-09-17T02:14:18Z", "message": "HACK - Use Clipboard to allow MIUI Cloze\n\nWe add the selected value to the clipboard surrounded by cloze marks\n\nThis allows MIUI users with GBoard to paste it in immediately (and other keyboards to use Paste)\n\nHACK before 7124 obsoletes this"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMjA2ODM3", "url": "https://github.com/ankidroid/Anki-Android/pull/7126#pullrequestreview-490206837", "createdAt": "2020-09-17T02:50:40Z", "commit": {"oid": "74225f894db2f8e4bf40706cfa3cb60377a7213b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwMjo1MDo0MFrOHTNiTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwMjo1MDo0MFrOHTNiTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTkwNjc2NQ==", "bodyText": "\ud83e\udd23", "url": "https://github.com/ankidroid/Anki-Android/pull/7126#discussion_r489906765", "createdAt": "2020-09-17T02:50:40Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/utils/AdaptionUtil.java", "diffHunk": "@@ -121,4 +123,34 @@ public static boolean isRestrictedLearningDevice() {\n         }\n         return sIsRestrictedLearningDevice;\n     }\n+\n+    public static boolean canUseContextMenu() {\n+        return !isRunningMiui();\n+    }\n+\n+    private static boolean isRunningMiui() {\n+        if (sIsRunningMiUI == null) {\n+            sIsRunningMiUI = queryIsMiui();\n+        }\n+        return sIsRunningMiUI;\n+    }\n+\n+    // https://stackoverflow.com/questions/47610456/how-to-detect-miui-rom-programmatically-in-android\n+    private static boolean isIntentResolved(Context ctx, Intent intent) {\n+        return (intent != null && ctx.getPackageManager().resolveActivity(intent, PackageManager.MATCH_DEFAULT_ONLY) != null);\n+    }\n+\n+    private static boolean queryIsMiui() {\n+        Context ctx = AnkiDroidApp.getInstance();\n+        return isIntentResolved(ctx, new Intent(\"miui.intent.action.OP_AUTO_START\").addCategory(Intent.CATEGORY_DEFAULT))\n+                || isIntentResolved(ctx, new Intent().setComponent(new ComponentName(\"com.miui.securitycenter\", \"com.miui.permcenter.autostart.AutoStartManagementActivity\")))\n+                || isIntentResolved(ctx, new Intent(\"miui.intent.action.POWER_HIDE_MODE_APP_LIST\").addCategory(Intent.CATEGORY_DEFAULT))\n+                || isIntentResolved(ctx, new Intent().setComponent(new ComponentName(\"com.miui.securitycenter\", \"com.miui.powercenter.PowerSettings\")));\n+    }\n+\n+\n+    @SuppressWarnings( {\"unused\", \"RedundantSuppression\"})\n+    public static boolean shouldCurrentUserBuyDifferentPhone() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74225f894db2f8e4bf40706cfa3cb60377a7213b"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMjA3MTQz", "url": "https://github.com/ankidroid/Anki-Android/pull/7126#pullrequestreview-490207143", "createdAt": "2020-09-17T02:51:37Z", "commit": {"oid": "74225f894db2f8e4bf40706cfa3cb60377a7213b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3996, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}