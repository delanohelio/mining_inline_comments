{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1ODQyNTc0", "number": 7065, "title": "Fix scrollbar's position not remembered in CardBrowser #6857", "bodyText": "Fixes\nFixes #6857\nApproach\nProblem Analysis\nThe scrollbar's position is reset because, when user edits and saves a note in NoteEditor, NoteEditor sends a \"noteChanged\" event back to CardBrowser. In method onActivityResult() of CardBrowser, this event causes a reload, which resets the scrollbar position.\nIn my opinion, the solution which programmatically scrolls to the old position (using methods like ListView.setSelection(oldPosition)) might be suboptimal, because after scrolling like this, we still have to handle the logic to show / hide progressbar. This is a nontrivial task because method onScroll() of ListView gets called multiple times, asynchronously and unpredictably.\nIn search for a simpler solution, I think that a reload for the \"noteChanged\" event (sent from NoteEditor to CardBrowser) might not be necessary.\n(with other events like adding note(s) or previewing card(s), a reload is still necessary, because:\nwhen adding note(s), the number of notes is changed\nwhen previewing card(s), multiple of notes can be editted before the user comes back to CardBrowser, in this case, it does not make sense to remember the scrollbar's old position)\nThe Solution\nIn this PR, I remove the \"noteChanged\" event (sent from NoteEditor to CardBrowser) from the list of events that cause a reload (in onActivityResult() of CardBrowser).\nAfter doing this, now when I tap on a row in CardBrowser (to navigate from CardBrowser to NoteEditor), make changes to the selected note in NoteEditor, save the changes, and come back to CardBrowser, 2 things are achieved:\n* the scrollbar still remains at its previous position.\n* the note gets updated with new modification.\n(the note gets updated in CardBrowser even without a reload because in onActivityResult() of CardBrowser, the \"noteChanged\" event still triggers the UPDATE_NOTE collectionTask, which will eventually call notifyDatasetChanged() on mCardsAdapter)\nHow Has This Been Tested?\nI have tested this solution in Emulator (API 27 and API 28).\nFirst I verified that the solution works as expected.\nAfter that I ran the following automatic tests and they all passed:\n* unit tests in com/ichi2/anki\n* instrumentation tests\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-09-12T09:30:34Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7065", "merged": true, "mergeCommit": {"oid": "456daa33af9c099a52d05ecba69b47ed9a4d1944"}, "closed": true, "closedAt": "2020-10-14T21:20:05Z", "author": {"login": "tda1009"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH2oUWgH2gAyNDg1ODQyNTc0OjM5NTU4ZjYxNmQ1MTY0Njk2YjBjYWY0NWRiM2QyNWUzNmQ5ZTZkNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSfzZUAFqTUwODUyNzU2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "39558f616d5164696b0caf45db3d25e36d9e6d62", "author": {"user": {"login": "tda1009", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/39558f616d5164696b0caf45db3d25e36d9e6d62", "committedDate": "2020-09-11T14:53:37Z", "message": "Fix scrollbar's position not remembered in CardBrowser\n\nThe scrollbar's position is reset because, when user edits and saves a note in NoteEditor, NoteEditor sends a \"noteChanged\" event back to CardBrowser. In method onActivityResult() of CardBrowser, this event causes a reload, which resets the scrollbar position.\n\nIn this PR, I remove the \"noteChanged\" event from the list of events that cause a reload (in onActivityResult() of CardBrowser)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08d829db883a5e769dc3fa1207a565a608094e32", "author": {"user": {"login": "tda1009", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/08d829db883a5e769dc3fa1207a565a608094e32", "committedDate": "2020-09-15T11:28:25Z", "message": "Scroll to previously selected card"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6412267ebda550b1b7218aa8e0e48e405fa5eaf9", "author": {"user": {"login": "tda1009", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6412267ebda550b1b7218aa8e0e48e405fa5eaf9", "committedDate": "2020-09-15T11:42:15Z", "message": "Handle progress bar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c49e92370dcb0e527e93a8615681ae2c9e93dff", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9c49e92370dcb0e527e93a8615681ae2c9e93dff", "committedDate": "2020-09-30T16:02:16Z", "message": "Merge branch 'master' into fix_cardbrowser_scrollbar_position_problem"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTgyODkw", "url": "https://github.com/ankidroid/Anki-Android/pull/7065#pullrequestreview-499582890", "createdAt": "2020-09-30T15:57:29Z", "commit": {"oid": "08d829db883a5e769dc3fa1207a565a608094e32"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNTo1NzozMFrOHakgLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNTo1OTo0OFrOHaknYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyMzA4NA==", "bodyText": "@tda1009 I apologize for the delay in looking at these - I want to be clear I like the purpose of this change and I'm sorry I've let it sit\nOne thing I'll note is that now if you add member variables, it's important to handle them across Activity restarts in the Android lifecycle. Specifically openNoteEditorForCard will open another Activity, and you haven't calculated the member variable values yet, nor are they put into the Bundle in onSaveInstanceState (or brought back from the bundle in onCreate)\nIf we add member state it should be calculated before launching another Activity and that onSaveInstanceState/onCreate change is required, or things will break if the user rotates their screen for instance", "url": "https://github.com/ankidroid/Anki-Android/pull/7065#discussion_r497623084", "createdAt": "2020-09-30T15:57:30Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -633,6 +637,8 @@ public void onItemClick(AdapterView<?> parent, View view, int position, long id)\n                     // load up the card selected on the list\n                     long clickedCardId = getCards().get(position).getId();\n                     openNoteEditorForCard(clickedCardId);\n+                    mOldCardId = clickedCardId;\n+                    mOldCardTopOffset = calculateTopOffset(position);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08d829db883a5e769dc3fa1207a565a608094e32"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYyNDkyOQ==", "bodyText": "same comment here for required handling in onSaveInstanceState/onCreate of instance variables", "url": "https://github.com/ankidroid/Anki-Android/pull/7065#discussion_r497624929", "createdAt": "2020-09-30T15:59:48Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -224,6 +224,7 @@\n     private long mOldCardId = 0;\n     private int mOldCardTopOffset = 0;\n     private boolean mShouldRestoreScroll = false;\n+    private boolean mPostAutoScroll = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6412267ebda550b1b7218aa8e0e48e405fa5eaf9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c36fdc89ada2f7e24019dd81263d00dbd1aaed19", "author": {"user": {"login": "tda1009", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c36fdc89ada2f7e24019dd81263d00dbd1aaed19", "committedDate": "2020-10-03T10:57:54Z", "message": "Improve handling of scrolling state variables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NDczODE4", "url": "https://github.com/ankidroid/Anki-Android/pull/7065#pullrequestreview-508473818", "createdAt": "2020-10-14T15:31:54Z", "commit": {"oid": "c36fdc89ada2f7e24019dd81263d00dbd1aaed19"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NTI3NTYx", "url": "https://github.com/ankidroid/Anki-Android/pull/7065#pullrequestreview-508527561", "createdAt": "2020-10-14T16:31:04Z", "commit": {"oid": "c36fdc89ada2f7e24019dd81263d00dbd1aaed19"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4079, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}