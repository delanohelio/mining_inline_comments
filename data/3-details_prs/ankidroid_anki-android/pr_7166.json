{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5ODI4ODky", "number": 7166, "title": "Discard current card in deck picker", "bodyText": "This correct partially #7162 (comment) (in the sens that it corrects the comment made by David below the main error)\nYou also have a regression test with it.\nI didn't realize there was asynchronicity I uncorrectly considered. When the reviewer is destroyed, the currentCard should be discarded. However, I didn't realize that the deck picker would start computing before the Reviewer is destroyed. For safety, I tells the Deck\u00a0Picker to state that the current card does not exists anymore.\nThis would break if at any point we decide to allow the deck picker and the reviewer to be opened simultaneously. But to be honest, a lot of things would break in the scheduler, so that's not an actual concern.\nThe discarding is done in CollectionTask. This way, if some API ask for number of cards to be reviewed and call deckDueTree, this won't change the current card and won't disturb the state of the scheduler.", "createdAt": "2020-09-19T22:14:38Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7166", "merged": true, "mergeCommit": {"oid": "ff8c7bc6607fe2426269dc895802df675d564ce1"}, "closed": true, "closedAt": "2020-09-20T15:57:37Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKhrO5AH2gAyNDg5ODI4ODkyOjYzMmM0NWZmNDc3ZDViZjkyOGQ3YWQ3Mjc1MzRjYjhmY2M4ZGNjMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKw8BigFqTQ5MjIwMzkwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "632c45ff477d5bf928d7ad727534cb8fcc8dcc35", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/632c45ff477d5bf928d7ad727534cb8fcc8dcc35", "committedDate": "2020-09-19T22:10:34Z", "message": "NF: regressino test for limit of new card after review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMTYxMDI1", "url": "https://github.com/ankidroid/Anki-Android/pull/7166#pullrequestreview-492161025", "createdAt": "2020-09-19T23:13:33Z", "commit": {"oid": "ea25088dd9ceae46a11ec40079ff415001ec9273"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQyMzoxMzozNFrOHU0oIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQyMzoxMzozNFrOHU0oIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTU5NTgwOA==", "bodyText": "I feel it'd be better to move this decision inside the method, dependent on a parameter, rather than depending on knowledge of the classes internals.", "url": "https://github.com/ankidroid/Anki-Android/pull/7166#discussion_r491595808", "createdAt": "2020-09-19T23:13:34Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -619,12 +619,18 @@ private TaskData doInBackgroundLoadDeck() {\n     }\n \n \n+    // This method should be called only if the reviewer is closed\n+    // Because it tells the scheduler there is no more current cards\n     private TaskData doInBackgroundLoadDeckCounts() {\n         Timber.d(\"doInBackgroundLoadDeckCounts\");\n         Collection col = getCol();\n+        AbstractSched sched = col.getSched();\n+        // Normally, the current card is already discarded. Here out of precaution because of\n+        // asynchronicity.\n+        sched.discardCurrentCard();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea25088dd9ceae46a11ec40079ff415001ec9273"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40313787131ddf2e167a855c52b66ff51ec4fc1e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/40313787131ddf2e167a855c52b66ff51ec4fc1e", "committedDate": "2020-09-20T04:03:40Z", "message": "NF: Last card from reviewer not taken into account in deck picker"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea25088dd9ceae46a11ec40079ff415001ec9273", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ea25088dd9ceae46a11ec40079ff415001ec9273", "committedDate": "2020-09-19T22:11:00Z", "message": "NF: Last card from reviewer not taken into account in deck picker"}, "afterCommit": {"oid": "40313787131ddf2e167a855c52b66ff51ec4fc1e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/40313787131ddf2e167a855c52b66ff51ec4fc1e", "committedDate": "2020-09-20T04:03:40Z", "message": "NF: Last card from reviewer not taken into account in deck picker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMTg1NzE0", "url": "https://github.com/ankidroid/Anki-Android/pull/7166#pullrequestreview-492185714", "createdAt": "2020-09-20T10:17:45Z", "commit": {"oid": "40313787131ddf2e167a855c52b66ff51ec4fc1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMjAzOTAx", "url": "https://github.com/ankidroid/Anki-Android/pull/7166#pullrequestreview-492203901", "createdAt": "2020-09-20T15:57:29Z", "commit": {"oid": "40313787131ddf2e167a855c52b66ff51ec4fc1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4008, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}