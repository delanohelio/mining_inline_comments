{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3ODEyNjY3", "number": 6663, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoxNTo1OFrOENjqlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzo1NzoyMlrOEORScw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNjUxMjg3OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoxNTo1OFrOGwRFsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoxNTo1OFrOGwRFsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NDgxOQ==", "bodyText": "This doesn't finish() on certain cases.\nBrackets would make the logic more explicit", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453264819", "createdAt": "2020-07-12T04:15:58Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -136,6 +160,10 @@ public void onSaveInstanceState(Bundle outState) {\n     @Override\n     protected void onCollectionLoaded(Collection col) {\n         super.onCollectionLoaded(col);\n+        if (isFinishing() || (mCurrentCard == null) && (mCardList == null)) {\n+            Timber.d(\"onCollectionLoaded - incorrect state to load, closing\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76490b580ab015f445fd5b61d5185fed4b1b2d32"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyNjUxNTEwOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQwNDoyMDoyOVrOGwRGtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMjowODo1NlrOGw8AYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA3OQ==", "bodyText": "This constant isn't used other than here. This seems to launch the activity twice.", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453265079", "createdAt": "2020-07-12T04:20:29Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -936,6 +937,7 @@ public boolean onOptionsItemSelected(MenuItem item) {\n                 Bundle noteEditorBundle = new Bundle();\n                 onSaveInstanceState(noteEditorBundle);\n                 previewer.putExtra(\"noteEditorBundle\", noteEditorBundle);\n+                startActivityForResultWithoutAnimation(previewer, REQUEST_PREVIEW);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76490b580ab015f445fd5b61d5185fed4b1b2d32"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMyNTY5OA==", "bodyText": "the double-launch is a big deal although (usefully?) it pointed out several areas in CardTemplatePreviewer that needed hardening which I actually liked. I couldn't figure out the double-launch on quick inspection but I'll dig in more. The constant is only used once because I don't actually care in onActivityResult, as deleting temporary model is always safe so it doesn't really need a special case. Otherwise it would be used there", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453325698", "createdAt": "2020-07-12T14:48:14Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -936,6 +937,7 @@ public boolean onOptionsItemSelected(MenuItem item) {\n                 Bundle noteEditorBundle = new Bundle();\n                 onSaveInstanceState(noteEditorBundle);\n                 previewer.putExtra(\"noteEditorBundle\", noteEditorBundle);\n+                startActivityForResultWithoutAnimation(previewer, REQUEST_PREVIEW);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA3OQ=="}, "originalCommit": {"oid": "76490b580ab015f445fd5b61d5185fed4b1b2d32"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzk2Nzk3MA==", "bodyText": "OMG the double launch was literally right there. Sleep deprivation is a real thing.\nCleaned up the double-launch, was able to reproduce it and prove this fix worked, re-pushed", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r453967970", "createdAt": "2020-07-13T22:08:56Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/NoteEditor.java", "diffHunk": "@@ -936,6 +937,7 @@ public boolean onOptionsItemSelected(MenuItem item) {\n                 Bundle noteEditorBundle = new Bundle();\n                 onSaveInstanceState(noteEditorBundle);\n                 previewer.putExtra(\"noteEditorBundle\", noteEditorBundle);\n+                startActivityForResultWithoutAnimation(previewer, REQUEST_PREVIEW);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzI2NTA3OQ=="}, "originalCommit": {"oid": "76490b580ab015f445fd5b61d5185fed4b1b2d32"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzk4NzcxOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzo1NzoyMlrOGxU5fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNTozMzoxMFrOGxZQIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM3NTgwNQ==", "bodyText": "Needs confirmation this still works with the CardTemplatePreviewer - I'd have expected this to be required for state restoration if it's too big for a bundle.", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r454375805", "createdAt": "2020-07-14T13:57:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -89,11 +91,33 @@ protected void onResume() {\n         super.onResume();\n         if (mCurrentCard == null || mOrdinal < 0) {\n             Timber.e(\"CardTemplatePreviewer started with empty card list or invalid index\");\n-            finishWithoutAnimation();\n+            closeCardTemplatePreviewer();\n         }\n     }\n \n \n+    private void closeCardTemplatePreviewer() {\n+        Timber.d(\"CardTemplatePreviewer:: closeCardTemplatePreviewer()\");\n+        setResult(RESULT_OK);\n+        TemporaryModel.clearTempModelFiles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5NDM2MQ==", "bodyText": "The NoteEditor does not do anything about it's own state being stored in a bundle, the addition of the TemporaryModel was 100% for communication with CardTemplatePreviewer, so when it returns it is always valid to clear TemporaryModel. If NoteEditor sees some preening in the future it may take advantage of TemporaryModel internally but right now it does not, and since on Preview there is no mutation possible, clearing on both sides (CardTemplatePreviewer.close / NoteEditor.onActivityResult) should be safe\nThis close pathway is not exercised on Activity restarts - where TemporaryModel is needed for restoration - so, also safe?", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r454394361", "createdAt": "2020-07-14T14:23:29Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -89,11 +91,33 @@ protected void onResume() {\n         super.onResume();\n         if (mCurrentCard == null || mOrdinal < 0) {\n             Timber.e(\"CardTemplatePreviewer started with empty card list or invalid index\");\n-            finishWithoutAnimation();\n+            closeCardTemplatePreviewer();\n         }\n     }\n \n \n+    private void closeCardTemplatePreviewer() {\n+        Timber.d(\"CardTemplatePreviewer:: closeCardTemplatePreviewer()\");\n+        setResult(RESULT_OK);\n+        TemporaryModel.clearTempModelFiles();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM3NTgwNQ=="}, "originalCommit": {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ0NzEzOQ==", "bodyText": "Confirmed working with discard activities / across activity restarts. I think this is good to go", "url": "https://github.com/ankidroid/Anki-Android/pull/6663#discussion_r454447139", "createdAt": "2020-07-14T15:33:10Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardTemplatePreviewer.java", "diffHunk": "@@ -89,11 +91,33 @@ protected void onResume() {\n         super.onResume();\n         if (mCurrentCard == null || mOrdinal < 0) {\n             Timber.e(\"CardTemplatePreviewer started with empty card list or invalid index\");\n-            finishWithoutAnimation();\n+            closeCardTemplatePreviewer();\n         }\n     }\n \n \n+    private void closeCardTemplatePreviewer() {\n+        Timber.d(\"CardTemplatePreviewer:: closeCardTemplatePreviewer()\");\n+        setResult(RESULT_OK);\n+        TemporaryModel.clearTempModelFiles();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM3NTgwNQ=="}, "originalCommit": {"oid": "e29357fae38d8112038728aef3d149c7fb5f3d9e"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 120, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}