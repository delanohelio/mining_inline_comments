{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0Mjk5NTI3", "number": 6610, "title": "Optimize model count (performance)", "bodyText": "Model count task was uselessly inefficient. And was still running even when the activity gets killed. this PR corrects that.\nRunning on my phone", "createdAt": "2020-07-04T15:49:14Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6610", "merged": true, "mergeCommit": {"oid": "44192bbf70781755d5b2bc3a4cf1124a73763e7c"}, "closed": true, "closedAt": "2020-07-06T04:25:38Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxrO21gBqjM1MTI3MDczMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyFeVKgBqjM1MTM3NzgzOTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f56c1327fe85b4d0fb0ec439428accc24f8a0fd2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f56c1327fe85b4d0fb0ec439428accc24f8a0fd2", "committedDate": "2020-07-04T15:48:03Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}, "afterCommit": {"oid": "48fdfe435b015fb0dd8bfb5721149e82b0ebf78d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/48fdfe435b015fb0dd8bfb5721149e82b0ebf78d", "committedDate": "2020-07-04T17:10:14Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjI2MTQy", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#pullrequestreview-442626142", "createdAt": "2020-07-04T18:59:19Z", "commit": {"oid": "48fdfe435b015fb0dd8bfb5721149e82b0ebf78d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjI4MDM0", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#pullrequestreview-442628034", "createdAt": "2020-07-04T19:43:51Z", "commit": {"oid": "48fdfe435b015fb0dd8bfb5721149e82b0ebf78d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxOTo0Mzo1MVrOGs9n6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQxOTo0Mzo1MVrOGs9n6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgwMDE2OQ==", "bodyText": "When would this be called on restore?", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449800169", "createdAt": "2020-07-04T19:43:51Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/ModelBrowser.java", "diffHunk": "@@ -207,6 +207,7 @@ public boolean onOptionsItemSelected(MenuItem item) {\n \n     @Override\n     public void onStop() {\n+        CollectionTask.cancelTask(COUNT_MODELS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48fdfe435b015fb0dd8bfb5721149e82b0ebf78d"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "48fdfe435b015fb0dd8bfb5721149e82b0ebf78d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/48fdfe435b015fb0dd8bfb5721149e82b0ebf78d", "committedDate": "2020-07-04T17:10:14Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}, "afterCommit": {"oid": "fabb154f2563c54c6743d039429c8d5d7c00cc0b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fabb154f2563c54c6743d039429c8d5d7c00cc0b", "committedDate": "2020-07-04T19:52:35Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM2MTg0", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#pullrequestreview-442636184", "createdAt": "2020-07-04T23:35:42Z", "commit": {"oid": "fabb154f2563c54c6743d039429c8d5d7c00cc0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMzozNTo0MlrOGs-d4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNFQyMzozNTo0MlrOGs-d4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxMzk4Ng==", "bodyText": "Have you tested this?\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/java/com/ichi2/anki/ModelBrowser.java\n    \n    \n        Lines 108 to 113\n      in\n      e4543a4\n    \n    \n    \n    \n\n        \n          \n           @Override \n        \n\n        \n          \n           public void onPostExecute(TaskData result) { \n        \n\n        \n          \n            \n        \n\n        \n          \n               if (!result.getBoolean()) { \n        \n\n        \n          \n                   throw new RuntimeException(); \n        \n\n        \n          \n               }", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449813986", "createdAt": "2020-07-04T23:35:42Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1505,8 +1505,11 @@ public int compare(JSONObject a, JSONObject b) {\n \n         try{\n             for (JSONObject n : models) {\n-                long modID = n.getLong(\"id\");\n-                cardCount.add(col.getModels().nids(col.getModels().get(modID)).size());\n+                if (isCancelled()) {\n+                    Timber.e(\"doInBackgroundLoadModels :: Cancelled\");\n+                    return new TaskData(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fabb154f2563c54c6743d039429c8d5d7c00cc0b"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fabb154f2563c54c6743d039429c8d5d7c00cc0b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fabb154f2563c54c6743d039429c8d5d7c00cc0b", "committedDate": "2020-07-04T19:52:35Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}, "afterCommit": {"oid": "6a3f4c4e9d6a56a6bdc560729131865c567bc04e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6a3f4c4e9d6a56a6bdc560729131865c567bc04e", "committedDate": "2020-07-05T15:21:51Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjg4MDg0", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#pullrequestreview-442688084", "createdAt": "2020-07-05T15:55:03Z", "commit": {"oid": "6a3f4c4e9d6a56a6bdc560729131865c567bc04e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNTo1NTowNFrOGtDO5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNTo1NTowNFrOGtDO5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5MjA2OQ==", "bodyText": "@Arthur-Milchior I think this just needs a comment here and it can merge\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                return new TaskData(false);\n          \n          \n            \n                                // onPostExecute should not be called if canceled, return should not matter. Using false.\n          \n          \n            \n                                return new TaskData(false);", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449892069", "createdAt": "2020-07-05T15:55:04Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1546,8 +1546,11 @@ public int compare(JSONObject a, JSONObject b) {\n \n         try{\n             for (JSONObject n : models) {\n-                long modID = n.getLong(\"id\");\n-                cardCount.add(col.getModels().nids(col.getModels().get(modID)).size());\n+                if (isCancelled()) {\n+                    Timber.e(\"doInBackgroundLoadModels :: Cancelled\");\n+                    return new TaskData(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a3f4c4e9d6a56a6bdc560729131865c567bc04e"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a3f4c4e9d6a56a6bdc560729131865c567bc04e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6a3f4c4e9d6a56a6bdc560729131865c567bc04e", "committedDate": "2020-07-05T15:21:51Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}, "afterCommit": {"oid": "9010e5b5c2eb70c7d938108076e14d3ab569f860", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9010e5b5c2eb70c7d938108076e14d3ab569f860", "committedDate": "2020-07-05T15:57:14Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjkwMjE0", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#pullrequestreview-442690214", "createdAt": "2020-07-05T16:29:31Z", "commit": {"oid": "9010e5b5c2eb70c7d938108076e14d3ab569f860"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjkwNTc1", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#pullrequestreview-442690575", "createdAt": "2020-07-05T16:35:18Z", "commit": {"oid": "9010e5b5c2eb70c7d938108076e14d3ab569f860"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNjozNToxOVrOGtDc8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNjozNToxOVrOGtDc8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg5NTY2Ng==", "bodyText": "onPostExecute also crashes on null, could we handle this case if we're going to imply it's fine.", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#discussion_r449895666", "createdAt": "2020-07-05T16:35:19Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1546,8 +1546,12 @@ public int compare(JSONObject a, JSONObject b) {\n \n         try{\n             for (JSONObject n : models) {\n-                long modID = n.getLong(\"id\");\n-                cardCount.add(col.getModels().nids(col.getModels().get(modID)).size());\n+                if (isCancelled()) {\n+                    Timber.e(\"doInBackgroundLoadModels :: Cancelled\");\n+                    // onPostExecute not executed if cancelled. Return value not used.\n+                    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9010e5b5c2eb70c7d938108076e14d3ab569f860"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9010e5b5c2eb70c7d938108076e14d3ab569f860", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9010e5b5c2eb70c7d938108076e14d3ab569f860", "committedDate": "2020-07-05T15:57:14Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}, "afterCommit": {"oid": "a380613fb92a4857cfd793b843a59140d1419a34", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a380613fb92a4857cfd793b843a59140d1419a34", "committedDate": "2020-07-05T17:14:32Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjkzNTg5", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#pullrequestreview-442693589", "createdAt": "2020-07-05T17:24:08Z", "commit": {"oid": "a380613fb92a4857cfd793b843a59140d1419a34"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjk0MzE3", "url": "https://github.com/ankidroid/Anki-Android/pull/6610#pullrequestreview-442694317", "createdAt": "2020-07-05T17:35:54Z", "commit": {"oid": "a380613fb92a4857cfd793b843a59140d1419a34"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a380613fb92a4857cfd793b843a59140d1419a34", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a380613fb92a4857cfd793b843a59140d1419a34", "committedDate": "2020-07-05T17:14:32Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}, "afterCommit": {"oid": "af086f186b7549ae45ba72c743b838701ccacbd1", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/af086f186b7549ae45ba72c743b838701ccacbd1", "committedDate": "2020-07-05T19:48:09Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef3fa794effc954886762f6029342cb4be7e5466", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ef3fa794effc954886762f6029342cb4be7e5466", "committedDate": "2020-07-05T23:44:49Z", "message": "NF: avoid going from id to count model to id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e912163508b19aa0d542fc38bba95536e3d3c875", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e912163508b19aa0d542fc38bba95536e3d3c875", "committedDate": "2020-07-05T23:44:49Z", "message": "NF: uses sql's count instead of list size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ce359195c7ae2e200487cc1a95b918fe1922823", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7ce359195c7ae2e200487cc1a95b918fe1922823", "committedDate": "2020-07-05T23:44:49Z", "message": "NF: doInBackgroundLoadModels cancellable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "729e173142aadbb20d2c05637e316b961182cb80", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/729e173142aadbb20d2c05637e316b961182cb80", "committedDate": "2020-07-05T23:44:49Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af086f186b7549ae45ba72c743b838701ccacbd1", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/af086f186b7549ae45ba72c743b838701ccacbd1", "committedDate": "2020-07-05T19:48:09Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}, "afterCommit": {"oid": "729e173142aadbb20d2c05637e316b961182cb80", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/729e173142aadbb20d2c05637e316b961182cb80", "committedDate": "2020-07-05T23:44:49Z", "message": "NF: kill Task_Type_Count_Models when ModelBrowser close"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3066, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}