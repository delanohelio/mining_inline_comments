{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MjA4OTI0", "number": 6462, "title": "Forward-port Stats ViewPager usage to ViewPager2", "bodyText": "Pull Request template\nPurpose / Description\nViewPager is dead, long live ViewPager2\nFixes\nObsolescence\nApproach\nSame general strategy as the CardTemplateEditor forward-port, but this one needed a little extra hook-up in order to get the fragments to re-display when you twiddled other things\nSo I maintain a fragment list and ask them to update as needed before notifying data set changed (which will cause them to re-display if I am understanding things correctly)\nHow Has This Been Tested?\nAPI29 emulator", "createdAt": "2020-06-14T22:04:58Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6462", "merged": true, "mergeCommit": {"oid": "4481bad0903a6eea8cad503a12767c893a179aef"}, "closed": true, "closedAt": "2021-03-09T19:50:40Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsVQ7ngFqTQzMjg5ODY0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeA7gNTABqjQ0MTg1ODkzMzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyODk4NjQw", "url": "https://github.com/ankidroid/Anki-Android/pull/6462#pullrequestreview-432898640", "createdAt": "2020-06-18T02:30:34Z", "commit": {"oid": "41dd22cba80c487150c4e6d78279e1e6ddf90dd4"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMjozMDozNFrOGldfJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMjo0Mjo1NlrOGldreg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzMzYwNg==", "bodyText": "Is there a better way to do this? A static, mutable reference to Android internals seems like it will get nasty.", "url": "https://github.com/ankidroid/Anki-Android/pull/6462#discussion_r441933606", "createdAt": "2020-06-18T02:30:34Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Statistics.java", "diffHunk": "@@ -256,85 +261,55 @@ public AnkiStatsTaskHandler getTaskHandler(){\n     }\n \n \n-    public ViewPager getViewPager(){\n+    public ViewPager2 getViewPager(){\n         return mViewPager;\n     }\n \n-\n-    public SectionsPagerAdapter getSectionsPagerAdapter() {\n-        return mSectionsPagerAdapter;\n+    public TabLayout getSlidingTabLayout() {\n+        return mSlidingTabLayout;\n     }\n \n     private long getDeckId() { return mDeckId; }\n \n-\n     /**\n-     * A {@link FragmentPagerAdapter} that returns a fragment corresponding to\n-     * one of the sections/tabs/pages.\n+     * A {@link androidx.viewpager2.adapter.FragmentStateAdapter} that returns a fragment corresponding to\n+     * one of the tabs.\n      */\n-    public class SectionsPagerAdapter extends FragmentPagerAdapter {\n+    public static class StatsPagerAdapter extends FragmentStateAdapter {\n \n-        public SectionsPagerAdapter(FragmentManager fm) {\n-            super(fm, BEHAVIOR_RESUME_ONLY_CURRENT_FRAGMENT);\n+        private StatsPagerAdapter(@NonNull FragmentActivity fragmentActivity) {\n+            super(fragmentActivity);\n         }\n \n-        //this is called when mSectionsPagerAdapter.notifyDataSetChanged() is called, so checkAndUpdate() here\n-        //works best for updating all tabs\n+        @NonNull\n         @Override\n-        public int getItemPosition(Object object) {\n-            if (object instanceof StatisticFragment) {\n-                ((StatisticFragment) object).checkAndUpdate();\n-            }\n-            //don't return POSITION_NONE, avoid fragment recreation.\n-            return super.getItemPosition(object);\n-        }\n-\n-        @Override\n-        public Fragment getItem(int position) {\n-            Fragment item = StatisticFragment.newInstance(position);\n-            ((StatisticFragment) item).checkAndUpdate();\n+        public Fragment createFragment(int position) {\n+            StatisticFragment item = StatisticFragment.newInstance(position);\n+            item.checkAndUpdate();\n             return item;\n         }\n \n         @Override\n-        public int getCount() {\n+        public int getItemCount() {\n             return 9;\n         }\n-\n-        @Override\n-        public CharSequence getPageTitle(int position) {\n-            Locale l = Locale.getDefault();\n-\n-            switch (position) {\n-                case TODAYS_STATS_TAB_POSITION:\n-                    return getString(R.string.stats_overview).toUpperCase(l);\n-                case FORECAST_TAB_POSITION:\n-                    return getString(R.string.stats_forecast).toUpperCase(l);\n-                case REVIEW_COUNT_TAB_POSITION:\n-                    return getString(R.string.stats_review_count).toUpperCase(l);\n-                case REVIEW_TIME_TAB_POSITION:\n-                    return getString(R.string.stats_review_time).toUpperCase(l);\n-                case INTERVALS_TAB_POSITION:\n-                    return getString(R.string.stats_review_intervals).toUpperCase(l);\n-                case HOURLY_BREAKDOWN_TAB_POSITION:\n-                    return getString(R.string.stats_breakdown).toUpperCase(l);\n-                case WEEKLY_BREAKDOWN_TAB_POSITION:\n-                    return getString(R.string.stats_weekly_breakdown).toUpperCase(l);\n-                case ANSWER_BUTTONS_TAB_POSITION:\n-                    return getString(R.string.stats_answer_buttons).toUpperCase(l);\n-                case CARDS_TYPES_TAB_POSITION:\n-                    return getString(R.string.stats_cards_types).toUpperCase(l);\n-            }\n-            return null;\n-        }\n     }\n \n     public static abstract class StatisticFragment extends Fragment {\n \n         //track current settings for each individual fragment\n         protected long mDeckId;\n-        protected ViewPager mActivityPager;\n-        protected SectionsPagerAdapter mActivitySectionPagerAdapter;\n+        protected AsyncTask mStatisticsTask;\n+        private ViewPager2 mActivityPager;\n+        private TabLayout mSlidingTabLayout;\n+        private TabLayoutMediator mTabLayoutMediator;\n+        private static ArrayList<StatisticFragment> sFragments = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41dd22cba80c487150c4e6d78279e1e6ddf90dd4"}, "originalPosition": 227}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNDAzNg==", "bodyText": "Just to note: requireActivity() now exists if you can guarantee that the call will occur when the activity is valid.", "url": "https://github.com/ankidroid/Anki-Android/pull/6462#discussion_r441934036", "createdAt": "2020-06-18T02:32:12Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Statistics.java", "diffHunk": "@@ -465,37 +490,42 @@ public View onCreateView(LayoutInflater inflater, ViewGroup container,\n         }\n \n         private void createChart() {\n+            Statistics statisticsActivity = (Statistics) getActivity();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41dd22cba80c487150c4e6d78279e1e6ddf90dd4"}, "originalPosition": 353}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNTY4MQ==", "bodyText": "This previously did not properly cancel the task (or the task did not handle cancellation). #6192\nStats for a big collection, exit, then change collection path -> crash.\nConfirming that nothing has changed yet (and if you know the cause, would save me a bit of time debugging).", "url": "https://github.com/ankidroid/Anki-Android/pull/6462#discussion_r441935681", "createdAt": "2020-06-18T02:38:50Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Statistics.java", "diffHunk": "@@ -363,26 +339,78 @@ public static StatisticFragment newInstance(int sectionNumber) {\n                     args = new Bundle();\n                     args.putInt(ARG_SECTION_NUMBER, sectionNumber);\n                     fragment.setArguments(args);\n-                    return (ChartFragment) fragment;\n+                    sFragments.add(fragment);\n+                    return fragment;\n                 case TODAYS_STATS_TAB_POSITION:\n                     fragment = new OverviewStatisticsFragment();\n                     args = new Bundle();\n                     args.putInt(ARG_SECTION_NUMBER, sectionNumber);\n                     fragment.setArguments(args);\n-                    return (OverviewStatisticsFragment) fragment;\n+                    sFragments.add(fragment);\n+                    return fragment;\n                 default:\n-                    return null;\n+                    throw new IllegalArgumentException(\"Unknown section number: \" + sectionNumber);\n             }\n         }\n \n         @Override\n         public void onResume() {\n-            super.onResume();\n             checkAndUpdate();\n+            super.onResume();\n+        }\n \n+        @Override\n+        public void onDestroy() {\n+            sFragments.remove(this);\n+            if (mStatisticsTask != null && !mStatisticsTask.isCancelled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41dd22cba80c487150c4e6d78279e1e6ddf90dd4"}, "originalPosition": 279}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNjI5Mg==", "bodyText": "Optional: significant duplicated logic here", "url": "https://github.com/ankidroid/Anki-Android/pull/6462#discussion_r441936292", "createdAt": "2020-06-18T02:41:06Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Statistics.java", "diffHunk": "@@ -363,26 +339,78 @@ public static StatisticFragment newInstance(int sectionNumber) {\n                     args = new Bundle();\n                     args.putInt(ARG_SECTION_NUMBER, sectionNumber);\n                     fragment.setArguments(args);\n-                    return (ChartFragment) fragment;\n+                    sFragments.add(fragment);\n+                    return fragment;\n                 case TODAYS_STATS_TAB_POSITION:\n                     fragment = new OverviewStatisticsFragment();\n                     args = new Bundle();\n                     args.putInt(ARG_SECTION_NUMBER, sectionNumber);\n                     fragment.setArguments(args);\n-                    return (OverviewStatisticsFragment) fragment;\n+                    sFragments.add(fragment);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41dd22cba80c487150c4e6d78279e1e6ddf90dd4"}, "originalPosition": 261}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNjU0Ng==", "bodyText": "CheckResult as well", "url": "https://github.com/ankidroid/Anki-Android/pull/6462#discussion_r441936546", "createdAt": "2020-06-18T02:42:08Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Statistics.java", "diffHunk": "@@ -347,8 +322,9 @@ public CharSequence getPageTitle(int position) {\n          * Returns a new instance of this fragment for the given section\n          * number.\n          */\n+        @NonNull", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41dd22cba80c487150c4e6d78279e1e6ddf90dd4"}, "originalPosition": 241}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNjc2Mg==", "bodyText": "Nit: I believe these can be imported (as it was before this change)", "url": "https://github.com/ankidroid/Anki-Android/pull/6462#discussion_r441936762", "createdAt": "2020-06-18T02:42:56Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Statistics.java", "diffHunk": "@@ -256,85 +261,55 @@ public AnkiStatsTaskHandler getTaskHandler(){\n     }\n \n \n-    public ViewPager getViewPager(){\n+    public ViewPager2 getViewPager(){\n         return mViewPager;\n     }\n \n-\n-    public SectionsPagerAdapter getSectionsPagerAdapter() {\n-        return mSectionsPagerAdapter;\n+    public TabLayout getSlidingTabLayout() {\n+        return mSlidingTabLayout;\n     }\n \n     private long getDeckId() { return mDeckId; }\n \n-\n     /**\n-     * A {@link FragmentPagerAdapter} that returns a fragment corresponding to\n-     * one of the sections/tabs/pages.\n+     * A {@link androidx.viewpager2.adapter.FragmentStateAdapter} that returns a fragment corresponding to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41dd22cba80c487150c4e6d78279e1e6ddf90dd4"}, "originalPosition": 149}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "420943fe52d0a30a4ec60ce505884f386b082eb8", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/420943fe52d0a30a4ec60ce505884f386b082eb8", "committedDate": "2021-03-07T22:47:22Z", "message": "Forward port stats from ViewPager to ViewPager2"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41dd22cba80c487150c4e6d78279e1e6ddf90dd4", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/41dd22cba80c487150c4e6d78279e1e6ddf90dd4", "committedDate": "2020-06-14T23:07:31Z", "message": "Statistics partial de-lint and tracking fragment destroy better"}, "afterCommit": {"oid": "420943fe52d0a30a4ec60ce505884f386b082eb8", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/420943fe52d0a30a4ec60ce505884f386b082eb8", "committedDate": "2021-03-07T22:47:22Z", "message": "Forward port stats from ViewPager to ViewPager2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3209, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}