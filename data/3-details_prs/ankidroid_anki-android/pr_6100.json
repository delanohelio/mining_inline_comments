{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNjE2MjEx", "number": 6100, "title": "Don't crash Check Database when Database is locked", "bodyText": "Purpose / Description\nbeginTransaction was throwing SQLiteDatabaseLockedException\nThis meant that endTransaction threw in Check Integrity.\nFixes\nFixes #6067\nApproach\nWe handle this case in Check Database, and add in a new \"Database Error\" screen to handle \"Database Locked\".\nHow Has This Been Tested?\nTested on my phone, and unit tests. No longer crashes.\n\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-05-03T15:05:29Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6100", "merged": true, "mergeCommit": {"oid": "fecf42c8b4cf8b914fb090b80dde6c7293f84099"}, "closed": true, "closedAt": "2020-05-03T17:35:21Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdocSPgH2gAyNDEyNjE2MjExOjU3ZTVlOWNhMjVhMmE1M2Y5NmQ0MmM1OTFmZjZhNWFjMTNhZDZlMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdua7gAFqTQwNDY0MDY1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "57e5e9ca25a2a53f96d42c591ff6a5ac13ad6e39", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/57e5e9ca25a2a53f96d42c591ff6a5ac13ad6e39", "committedDate": "2020-05-03T10:36:59Z", "message": "Add DEBUG: Lock Database"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjM0NzA0", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#pullrequestreview-404634704", "createdAt": "2020-05-03T16:23:26Z", "commit": {"oid": "e1622d5b07c0a6627066e7488a2947047d6909d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNjoyMzoyNlrOGPtbYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNjoyMzoyNlrOGPtbYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNjExMw==", "bodyText": "this stuff is touchy, this is not something to fix here / it is not actionable - just as knowledge sharing I have an advanceRobolectricLooper method I use in #5151 and it's basically setting Looper mode to PAUSED in robolectric, then after you do something that twiddles state but before (and after) you twiddle UI you ask robolectric to advance the execution loop, and then I sleep for a moment (since we do async things). Not ideal but that's how to turn the crank as it were in robolectric if you want to play with UI stuff\nnot actionable here because visibility isn't important but maybe useful info going forward", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419126113", "createdAt": "2020-05-03T16:23:26Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/test/java/com/ichi2/anki/DeckPickerCheckDatabaseListenerTest.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki;\n+\n+import android.content.Intent;\n+\n+import com.ichi2.anki.dialogs.DatabaseErrorDialog;\n+import com.ichi2.async.CollectionTask.TaskData;\n+import com.ichi2.libanki.Collection.CheckDatabaseResult;\n+\n+import org.junit.Ignore;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.Robolectric;\n+import org.robolectric.android.controller.ActivityController;\n+\n+import androidx.annotation.NonNull;\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class DeckPickerCheckDatabaseListenerTest extends RobolectricTest {\n+\n+    private DeckPickerTestImpl impl;\n+\n+    @Override\n+    public void setUp() {\n+        super.setUp();\n+        //.visible() crashes: Layout state should be one of 100 but it is 10", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1622d5b07c0a6627066e7488a2947047d6909d2"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjM1MDcx", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#pullrequestreview-404635071", "createdAt": "2020-05-03T16:27:44Z", "commit": {"oid": "8fe879dcbaa2b9c8c27d2f5f2f6270ec7f4a8fb4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNjoyNzo0NVrOGPtdog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNjoyOToyMlrOGPtefA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNjY5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"database_locked_summary\">The AnkiDroid database is in use by another application. Please close it and reopen the app.</string>\n          \n          \n            \n                <string name=\"database_locked_summary\">The AnkiDroid database is in use by another application. Please close the other application then reopen AnkiDroid.</string>\n          \n      \n    \n    \n  \n\nambiguity-- && pedanticness++", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419126690", "createdAt": "2020-05-03T16:27:45Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -172,4 +172,8 @@\n \n     <!-- Deck Options -->\n     <string name=\"deck_options_corrupt\">Failed to process deck options: %s</string>\n+\n+    <!-- Database Errors-->\n+    <string name=\"database_locked_title\">Database Locked</string>\n+    <string name=\"database_locked_summary\">The AnkiDroid database is in use by another application. Please close it and reopen the app.</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe879dcbaa2b9c8c27d2f5f2f6270ec7f4a8fb4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNjkwOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            //If the database is locked, all we can do is ask the user t exit.\n          \n          \n            \n                            //If the database is locked, all we can do is ask the user to exit.\n          \n      \n    \n    \n  \n\nAs long as I have one textual nit that's important might as well throw in the other one I would have otherwise ignore ;-)\nI think this was the last commit in the stack, I'd like to rebase not squash so if you could merge this in (ignoring the fact that github makes them committable - it's just a nice presentation to see my suggestion - that'd be <kiwi>legend</kiwi>", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419126908", "createdAt": "2020-05-03T16:29:22Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -270,12 +272,25 @@ public MaterialDialog onCreateDialog(Bundle savedInstanceState) {\n                         })\n                         .show();\n             }\n+            case DIALOG_DB_LOCKED: {\n+                //If the database is locked, all we can do is ask the user t exit.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe879dcbaa2b9c8c27d2f5f2f6270ec7f4a8fb4"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjM1NDI0", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#pullrequestreview-404635424", "createdAt": "2020-05-03T16:31:52Z", "commit": {"oid": "8fe879dcbaa2b9c8c27d2f5f2f6270ec7f4a8fb4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e7fb11a75d84dba1ed3e924c7f88711940162f5", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1e7fb11a75d84dba1ed3e924c7f88711940162f5", "committedDate": "2020-05-03T16:50:55Z", "message": "Don't crash on locked database in Check Database\n\nPreviously, we tried to end a transaction which did not exist, which\ncrashed. Now, we go back to the \"failed to load\" error.\n\nFixes #6067"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1981f73dd4ac0ce52a20c4fcdb70b39ffb1680a0", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1981f73dd4ac0ce52a20c4fcdb70b39ffb1680a0", "committedDate": "2020-05-03T16:50:59Z", "message": "NF: Add tests for CheckDatabaseListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b7ae2a4fbaf9dcfeed516fd365030d38c4f5f5f", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9b7ae2a4fbaf9dcfeed516fd365030d38c4f5f5f", "committedDate": "2020-05-03T16:50:59Z", "message": "NF: DeckPicker: Refactor CheckDatabaseListener\n\nAutomated swap & removal of else block for clarity."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e3d42d6c1758fca69b5b4fa255a83431628e095", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3e3d42d6c1758fca69b5b4fa255a83431628e095", "committedDate": "2020-05-03T16:50:59Z", "message": "DeckPicker: Handle DbLocked & change outcomes\n\nIf we got a valid result with no data, treat it as a success"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "222c6ec50c0304d676c80752de5cf69371dff543", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/222c6ec50c0304d676c80752de5cf69371dff543", "committedDate": "2020-05-03T16:52:31Z", "message": "DatabaseErrorDialog: Handle DB Locked\n\nAdd in a dialog which will handle the database being locked."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fe879dcbaa2b9c8c27d2f5f2f6270ec7f4a8fb4", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8fe879dcbaa2b9c8c27d2f5f2f6270ec7f4a8fb4", "committedDate": "2020-05-03T14:56:48Z", "message": "DatabaseErrorDialog: Handle DB Locked\n\nAdd in a dialog which will handle the database being locked."}, "afterCommit": {"oid": "222c6ec50c0304d676c80752de5cf69371dff543", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/222c6ec50c0304d676c80752de5cf69371dff543", "committedDate": "2020-05-03T16:52:31Z", "message": "DatabaseErrorDialog: Handle DB Locked\n\nAdd in a dialog which will handle the database being locked."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjM3NDU5", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#pullrequestreview-404637459", "createdAt": "2020-05-03T16:55:15Z", "commit": {"oid": "222c6ec50c0304d676c80752de5cf69371dff543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNjo1NToxNVrOGPtq1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNjo1NToxNVrOGPtq1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMDA2OA==", "bodyText": "Issue found: Avoid throwing raw exception types.", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419130068", "createdAt": "2020-05-03T16:55:15Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/test/java/com/ichi2/async/AbstractCollectionTaskTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.async;\n+\n+import com.ichi2.anki.RobolectricTest;\n+\n+import org.junit.runner.RunWith;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.arrayWithSize;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.hamcrest.Matchers.notNullValue;\n+\n+@RunWith(AndroidJUnit4.class)\n+public abstract class AbstractCollectionTaskTest extends RobolectricTest {\n+\n+    protected CollectionTask.TaskData execute(int taskType) {\n+        CollectionTask task = CollectionTask.launchCollectionTask(taskType);\n+        try {\n+            return task.execute().get();\n+        } catch (Exception e) {\n+            throw new RuntimeException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222c6ec50c0304d676c80752de5cf69371dff543"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjM3NDY0", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#pullrequestreview-404637464", "createdAt": "2020-05-03T16:55:16Z", "commit": {"oid": "222c6ec50c0304d676c80752de5cf69371dff543"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNjo1NToxNlrOGPtq2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNjo1NToxNlrOGPtq2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMDA3NA==", "bodyText": "Issue found: The utility class name 'DatabaseLock' doesn't match '[A-Z][a-zA-Z0-9]+(Utils?|Helper|Constants)'", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419130074", "createdAt": "2020-05-03T16:55:16Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/debug/DatabaseLock.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki.debug;\n+\n+import android.content.Context;\n+\n+import com.ichi2.anki.CollectionHelper;\n+import com.ichi2.libanki.Collection;\n+\n+import timber.log.Timber;\n+\n+/** Debug only class which will lock the database */\n+public class DatabaseLock {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "222c6ec50c0304d676c80752de5cf69371dff543"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjQwNjU4", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#pullrequestreview-404640658", "createdAt": "2020-05-03T17:34:56Z", "commit": {"oid": "222c6ec50c0304d676c80752de5cf69371dff543"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3476, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}