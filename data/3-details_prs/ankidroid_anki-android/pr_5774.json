{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NjE5MDc4", "number": 5774, "title": "Feature/reviewer add mic tool bar", "bodyText": "Pull Request template\nPurpose / Description\nProposal to add the ability to record/replay voice temporarily during card review.\nFixes\nEdit by @david-allison-1\nFixes #5283\nFixes #2221\nApproach\nThe idea is simply to reuse the AudioView all ready available to record voice at card creation.\nI add an \"Toggle mic tool bar\" into the Reviewer menu.\nIt will add the AudioView between the top_bar and the flashcard.\nIt stay during all the review process\nHow Has This Been Tested?\nI have tested it on my mobile Phone which is a HUAWEI P10 Lite running EMUI 8.0 based on Android 8.0.\nTo test the process is as follow:\n1 - Start review a deck.\n2 - Into the review menu there is a new entry : Toggle mic tool bar, click on it\n3 - It request audio record auhtorisation if not allready allowed.\n4 - If granted, it a the AudioView on top of the card\n5 - Then you can record/play/pause/stop\n6 - An other action on the \"Toggle mic tool bar\" menu entry hide the tool box.\nLearning (optional, can help others)\nNote that the patch use a temporary file for recording the voice.\nI have refactor that part of code to mutualize it with the BasicAudioRecordingFieldController.\nThe audio file is deleted at review activity close.\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-02-25T14:36:11Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5774", "merged": true, "mergeCommit": {"oid": "44ea5d66c7ac3dcec765d7ca645a98e03bb2eee4"}, "closed": true, "closedAt": "2020-06-09T18:52:15Z", "author": {"login": "dgeranton"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJrfejABqjMwODc0MjM5NzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpprjBgFqTQyNzQ0Nzc4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e221b2261472752004d8af05991bd446626690fb", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e221b2261472752004d8af05991bd446626690fb", "committedDate": "2020-02-25T17:08:14Z", "message": "BUG: Must stop recorder when closing viewer"}, "afterCommit": {"oid": "ad8aee0f6dee722e514070aec6a80646493ee498", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ad8aee0f6dee722e514070aec6a80646493ee498", "committedDate": "2020-03-02T10:38:53Z", "message": "BUG: Must stop recorder when closing viewer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad8aee0f6dee722e514070aec6a80646493ee498", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ad8aee0f6dee722e514070aec6a80646493ee498", "committedDate": "2020-03-02T10:38:53Z", "message": "BUG: Must stop recorder when closing viewer"}, "afterCommit": {"oid": "89741a6ca261fb37265a7b022b753592e3f38583", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/89741a6ca261fb37265a7b022b753592e3f38583", "committedDate": "2020-04-06T18:34:40Z", "message": "BUG: Must stop recorder when closing viewer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "563de4d05a25aa40392efd28fdc700e1f7ae52ce", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/563de4d05a25aa40392efd28fdc700e1f7ae52ce", "committedDate": "2020-06-06T09:04:35Z", "message": "Refactor audio temporary file generation for further mutual use."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52df4127d649bce6858af2db132f74705d9398ab", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/52df4127d649bce6858af2db132f74705d9398ab", "committedDate": "2020-06-06T09:11:05Z", "message": "Add mic tool bar into reviewer menu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2580b6b5a4e47057784a6fcc8dbf2d838372e3f8", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2580b6b5a4e47057784a6fcc8dbf2d838372e3f8", "committedDate": "2020-06-06T09:11:08Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15c919213fe0b9ae9db2f93f61eba0ca93298295", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/15c919213fe0b9ae9db2f93f61eba0ca93298295", "committedDate": "2020-06-06T09:14:39Z", "message": "BUG: Must stop recorder when closing viewer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d65affda2d59130044bb0bffe23863b6e13b097f", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d65affda2d59130044bb0bffe23863b6e13b097f", "committedDate": "2020-06-06T09:22:52Z", "message": "Unused import correction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "committedDate": "2020-06-06T10:47:37Z", "message": "Correct merge issue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8942dce1ae2194ec02f0acb697ca5a1b6c5d60ec", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8942dce1ae2194ec02f0acb697ca5a1b6c5d60ec", "committedDate": "2020-04-06T19:09:32Z", "message": "Unused import correction"}, "afterCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0", "committedDate": "2020-06-06T10:47:37Z", "message": "Correct merge issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzM0Njgy", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#pullrequestreview-425734682", "createdAt": "2020-06-06T11:49:45Z", "commit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMTo0OTo0NVrOGgDV4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMTo1Nzo1OFrOGgDYQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjM3MQ==", "bodyText": "Could you revert changes to Project.xml", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262371", "createdAt": "2020-06-06T11:49:45Z", "author": {"login": "david-allison-1"}, "path": ".idea/codeStyles/Project.xml", "diffHunk": "@@ -24,6 +24,9 @@\n         <package name=\"\" withSubpackages=\"true\" static=\"true\" />\n       </value>\n     </option>\n+    <AndroidXmlCodeStyleSettings>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjQyMg==", "bodyText": "Could you revert changes to additional files", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262422", "createdAt": "2020-06-06T11:50:28Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DeckPickerExportCompleteDialog.java", "diffHunk": "@@ -5,10 +5,8 @@\n import android.os.Message;\n \n import com.afollestad.materialdialogs.MaterialDialog;\n-import com.ichi2.anki.CollectionHelper;\n import com.ichi2.anki.DeckPicker;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjU4MQ==", "bodyText": "I understand that this is copy/pasted, but we'll want to confirm that the media directory is better than the cache for these files. I think the cache directory (context.getCacheDir()) would be better", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262581", "createdAt": "2020-06-06T11:52:30Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/AudioView.java", "diffHunk": "@@ -72,6 +76,19 @@ public static AudioView createRecorderInstance(Context context, int resPlay, int\n         return new AudioView(context, resPlay, resPause, resStop, resRecord, resRecordStop, audioPath);\n     }\n \n+    public static String generateTempAudioFile(Context context) {\n+        String tempAudioPath;\n+        try {\n+            Collection col = CollectionHelper.getInstance().getCol(context);\n+            File storingDirectory = new File(col.getMedia().dir());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjY4MA==", "bodyText": "Could you prefix this variable with an m\nCode conventions for ref: https://github.com/ankidroid/Anki-Android/tree/master/docs/code_conventions", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262680", "createdAt": "2020-06-06T11:53:51Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -320,6 +321,10 @@\n \n     private long mUseTimerDynamicMS;\n \n+    /** File of the temporary mic record **/\n+    protected AudioView mMicToolBar;\n+    protected String tempAudioPath;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjcwMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if( mMicToolBar != null ) {\n          \n          \n            \n                    if (mMicToolBar != null) {", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262701", "createdAt": "2020-06-06T11:54:12Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -2577,6 +2582,16 @@ public boolean onJsAlert(WebView view, String url, String message, JsResult resu\n \n \n     protected void closeReviewer(int result, boolean saveDeck) {\n+        // Stop the mic recording if still pending\n+        if( mMicToolBar != null ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjcyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if( tempAudioPath != null ) {\n          \n          \n            \n                    if (tempAudioPath != null) {", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262722", "createdAt": "2020-06-06T11:54:28Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -2577,6 +2582,16 @@ public boolean onJsAlert(WebView view, String url, String message, JsResult resu\n \n \n     protected void closeReviewer(int result, boolean saveDeck) {\n+        // Stop the mic recording if still pending\n+        if( mMicToolBar != null ) {\n+            mMicToolBar.notifyStopRecord();\n+        }\n+        // Remove the temporary audio file\n+        if( tempAudioPath != null ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjgwNw==", "bodyText": "nit: could you add braces around the if in One-True Brace style", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262807", "createdAt": "2020-06-06T11:55:29Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -2577,6 +2582,16 @@ public boolean onJsAlert(WebView view, String url, String message, JsResult resu\n \n \n     protected void closeReviewer(int result, boolean saveDeck) {\n+        // Stop the mic recording if still pending\n+        if( mMicToolBar != null ) {\n+            mMicToolBar.notifyStopRecord();\n+        }\n+        // Remove the temporary audio file\n+        if( tempAudioPath != null ) {\n+            File tempAudioPathToDelete = new File(tempAudioPath);\n+            if (tempAudioPathToDelete.exists()) tempAudioPathToDelete.delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2Mjg2OQ==", "bodyText": "!Permissions.canRecordAudio(this)", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262869", "createdAt": "2020-06-06T11:56:09Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -280,6 +286,18 @@ public boolean onOptionsItemSelected(MenuItem item) {\n                 playSounds(true);\n                 break;\n \n+            case R.id.action_toggle_mic_tool_bar:\n+                Timber.i(\"Reviewer:: Record mic\");\n+                // Check permission to record and request if not granted\n+                if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.RECORD_AUDIO) !=", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2MjkxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if ( mMicToolBar == null ) {\n          \n          \n            \n                    if (mMicToolBar == null) {", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262913", "createdAt": "2020-06-06T11:56:58Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,36 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if ( mMicToolBar == null ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2Mjk1Mw==", "bodyText": "Could you wrap this in a try..catch and display a toast and send an exception report on failure, we don't want to crash the app if the toolbar fails to init.", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262953", "createdAt": "2020-06-06T11:57:40Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,36 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if ( mMicToolBar == null ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI2Mjk3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if( mMicToolBar.getVisibility() != View.VISIBLE) {\n          \n          \n            \n                        if (mMicToolBar.getVisibility() != View.VISIBLE) {", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436262978", "createdAt": "2020-06-06T11:57:58Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,36 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if ( mMicToolBar == null ) {\n+            // Record mic tool bar does not exist yet\n+            tempAudioPath = AudioView.generateTempAudioFile(this);\n+            mMicToolBar = AudioView.createRecorderInstance(this, R.drawable.av_play, R.drawable.av_pause,\n+                    R.drawable.av_stop, R.drawable.av_rec, R.drawable.av_rec_stop, tempAudioPath);\n+            FrameLayout.LayoutParams lp2 = new FrameLayout.LayoutParams(\n+                    ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);\n+            mMicToolBar.setLayoutParams(lp2);\n+            LinearLayout micToolBarLayer = findViewById(R.id.mic_tool_bar_layer);\n+            micToolBarLayer.addView(mMicToolBar);\n+        } else {\n+            // It exists swap visibility status\n+            if( mMicToolBar.getVisibility() != View.VISIBLE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2b5e7bcc45ae7b7b7372ba2affcc0e8674e88e0"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c22edb3c33cbb33b47687541d04425940a319c55", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c22edb3c33cbb33b47687541d04425940a319c55", "committedDate": "2020-06-06T15:56:27Z", "message": "Add new strings ressources in all language"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d73e9262ce285dae1f514e1dd2f55e26b8197929", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d73e9262ce285dae1f514e1dd2f55e26b8197929", "committedDate": "2020-06-06T15:59:10Z", "message": "Revert Project.xml to original"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b9a9598553232398e3b42817c83c5072e94b377", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8b9a9598553232398e3b42817c83c5072e94b377", "committedDate": "2020-06-06T16:05:35Z", "message": "Apply correction according to code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1Nzk5OTEw", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#pullrequestreview-425799910", "createdAt": "2020-06-07T08:49:37Z", "commit": {"oid": "8b9a9598553232398e3b42817c83c5072e94b377"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wN1QwODo0OTozOFrOGgIG7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wN1QwODo1MzozOVrOGgIIDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDQ2MQ==", "bodyText": "Could you revert this change? Our translation scripts will handle it.", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436340461", "createdAt": "2020-06-07T08:49:38Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/res/values-af/02-strings.xml", "diffHunk": "@@ -64,6 +64,7 @@\n     <string name=\"hide_whiteboard\">Hide whiteboard</string>\n     <string name=\"clear_whiteboard\">Clear whiteboard</string>\n     <string name=\"replay_audio\">Replay audio</string>\n+    <string name=\"toggle_mic_tool_bar\">Toggle mic tool bar</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b9a9598553232398e3b42817c83c5072e94b377"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDYwNQ==", "bodyText": "Could you mark this with\n\n@Nullable (place the string above public),\nMark context as @NonNull - place before the word Context", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436340605", "createdAt": "2020-06-07T08:51:31Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/multimediacard/AudioView.java", "diffHunk": "@@ -69,7 +75,27 @@\n \n     public static AudioView createRecorderInstance(Context context, int resPlay, int resPause, int resStop,\n             int resRecord, int resRecordStop, String audioPath) {\n+        try {\n         return new AudioView(context, resPlay, resPause, resStop, resRecord, resRecordStop, audioPath);\n+        } catch(Exception e) {\n+            Timber.e(e);\n+            AnkiDroidApp.sendExceptionReport(e, \"Unable to create recorder tool bar\");\n+            UIUtils.showThemedToast(context,\n+                    context.getText(R.string.multimedia_editor_audio_view_create_failed).toString(), true);\n+            return null;\n+        }\n+    }\n+\n+    public static String generateTempAudioFile(Context context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b9a9598553232398e3b42817c83c5072e94b377"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDY5OQ==", "bodyText": "Consider inverting this if (this can be done by placing your cursor over the if and pressing Alt+Enter", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436340699", "createdAt": "2020-06-07T08:52:45Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,43 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if (mMicToolBar == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b9a9598553232398e3b42817c83c5072e94b377"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM0MDc0OA==", "bodyText": "I believe this can fail if the activity is in the process of being destroyed.", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436340748", "createdAt": "2020-06-07T08:53:39Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -376,6 +394,43 @@ public boolean onOptionsItemSelected(MenuItem item) {\n         return true;\n     }\n \n+\n+    private void toggleMicToolBar() {\n+        if (mMicToolBar == null) {\n+            // Record mic tool bar does not exist yet\n+            mTempAudioPath = AudioView.generateTempAudioFile(this);\n+            if (mTempAudioPath == null) {\n+                return;\n+            }\n+            mMicToolBar = AudioView.createRecorderInstance(this, R.drawable.av_play, R.drawable.av_pause,\n+                        R.drawable.av_stop, R.drawable.av_rec, R.drawable.av_rec_stop, mTempAudioPath);\n+            if (mMicToolBar == null) {\n+                mTempAudioPath = null;\n+                return;\n+            }\n+            FrameLayout.LayoutParams lp2 = new FrameLayout.LayoutParams(\n+                    ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);\n+            mMicToolBar.setLayoutParams(lp2);\n+            LinearLayout micToolBarLayer = findViewById(R.id.mic_tool_bar_layer);\n+            micToolBarLayer.addView(mMicToolBar);\n+        } else {\n+            // It exists swap visibility status\n+            if (mMicToolBar.getVisibility() != View.VISIBLE) {\n+                mMicToolBar.setVisibility(View.VISIBLE);\n+            } else {\n+                mMicToolBar.setVisibility(View.GONE);\n+            }\n+        }\n+    }\n+\n+    public void onRequestPermissionsResult (int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {\n+        if ( (requestCode == REQUEST_AUDIO_PERMISSION) &&\n+                (permissions.length >= 1) && (grantResults[0] == PackageManager.PERMISSION_GRANTED)) {\n+            // Get get audio record permission, so we can create the record tool bar\n+            toggleMicToolBar();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b9a9598553232398e3b42817c83c5072e94b377"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "962b3ba51e0e45ffe2dbab372a2d0bbe114e420b", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/962b3ba51e0e45ffe2dbab372a2d0bbe114e420b", "committedDate": "2020-06-07T12:27:05Z", "message": "Revert \"Add new strings ressources in all language\"\n\nThis reverts commit c22edb3c33cbb33b47687541d04425940a319c55."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6f2ecb47bf25567d8566c2162fcee2460837eb9", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e6f2ecb47bf25567d8566c2162fcee2460837eb9", "committedDate": "2020-06-07T12:42:22Z", "message": "CodeReview: Add annotation around generateTempAudioFile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ad5283ea6d1bf0bf8b4f1b1c33647a35f6c0044", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6ad5283ea6d1bf0bf8b4f1b1c33647a35f6c0044", "committedDate": "2020-06-07T12:46:15Z", "message": "CodeReview: Invert if statement in toggleMicToolBar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebe17f20397a5bfeb0097ab571fde06a97fe3ca5", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ebe17f20397a5bfeb0097ab571fde06a97fe3ca5", "committedDate": "2020-06-07T13:17:39Z", "message": "CodeReview: Add toggle mic tool bar button into to custom button menu."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f72a748963f1386f36f252f07a9b61ae86d029fe", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f72a748963f1386f36f252f07a9b61ae86d029fe", "committedDate": "2020-06-07T13:21:28Z", "message": "CodeReview: Change menu text to \"Check Pronunciation\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c", "committedDate": "2020-06-07T13:50:26Z", "message": "CodeReview: Center the mic tool bar"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1ODI4NTU3", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#pullrequestreview-425828557", "createdAt": "2020-06-07T15:09:19Z", "commit": {"oid": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wN1QxNTowOToxOVrOGgKF3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wN1QxNToyNjoyM1rOGgKMAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3Mjk1Nw==", "bodyText": "I think once these additional files are removed from the commit, we're good to go. This looks awesome!!", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436372957", "createdAt": "2020-06-07T15:09:19Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/ImportDialog.java", "diffHunk": "@@ -8,7 +8,6 @@\n import com.ichi2.anki.CollectionHelper;\n import com.ichi2.anki.R;\n import com.ichi2.anki.UIUtils;\n-import com.ichi2.anki.analytics.AnalyticsDialogFragment;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3MzE5Nw==", "bodyText": "Nitpick - Same", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436373197", "createdAt": "2020-06-07T15:11:47Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/libanki/ClozeTest.java", "diffHunk": "@@ -3,19 +3,15 @@\n import android.content.Context;\n \n import com.ichi2.anki.RobolectricTest;\n-import com.ichi2.libanki.template.Template;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3MzIxNw==", "bodyText": "Nitpick - same", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436373217", "createdAt": "2020-06-07T15:11:59Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/libanki/MathJaxClozeTest.java", "diffHunk": "@@ -5,18 +5,14 @@\n import com.ichi2.anki.RobolectricTest;\n import com.ichi2.libanki.Card;\n import com.ichi2.libanki.Collection;\n-import com.ichi2.libanki.Models;\n import com.ichi2.libanki.Note;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3NDA2Ng==", "bodyText": "nit - same", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436374066", "createdAt": "2020-06-07T15:21:26Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/libanki/MathJaxClozeTest.java", "diffHunk": "@@ -5,18 +5,14 @@\n import com.ichi2.anki.RobolectricTest;\n import com.ichi2.libanki.Card;\n import com.ichi2.libanki.Collection;\n-import com.ichi2.libanki.Models;\n import com.ichi2.libanki.Note;\n import com.ichi2.libanki.template.Template;\n \n import org.junit.Test;\n import org.junit.runner.RunWith;\n \n import java.util.ArrayList;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjM3NDUyOA==", "bodyText": "We need to be consistent with this.\n\nPreferences show \"ifRoom\", here shows \"never\".\n\nI'd be tempted to use \"never\" and change the preferences/layout.xml. Users can increase the priority if they desire.\n@mikehardy - does this seem sensible?", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r436374528", "createdAt": "2020-06-07T15:26:23Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/reviewer/ActionButtonStatus.java", "diffHunk": "@@ -59,6 +59,7 @@ public void setup(SharedPreferences preferences) {\n         setupButton(preferences, R.id.action_suspend, \"customButtonSuspend\", SHOW_AS_ACTION_NEVER);\n         setupButton(preferences, R.id.action_mark_card, \"customButtonMarkCard\", SHOW_AS_ACTION_IF_ROOM);\n         setupButton(preferences, R.id.action_delete, \"customButtonDelete\", SHOW_AS_ACTION_NEVER);\n+        setupButton(preferences, R.id.action_toggle_mic_tool_bar, \"customButtonToggleMicToolBar\", SHOW_AS_ACTION_NEVER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99f716cbf63dc1ba44a8400cc9f6a1055ce2d28c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfb7b8e4436af3f84f7d5bda807a7aaa18936143", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/dfb7b8e4436af3f84f7d5bda807a7aaa18936143", "committedDate": "2020-06-07T17:36:45Z", "message": "CodeReview: Revert remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDYxNzU5", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#pullrequestreview-427061759", "createdAt": "2020-06-09T11:54:32Z", "commit": {"oid": "dfb7b8e4436af3f84f7d5bda807a7aaa18936143"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMTo1NDozM1rOGhFtyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMTo1NjowNlrOGhFxYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0OTgzNQ==", "bodyText": "SHOW_AS_ACTION_NEVER to be consistent\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        android:defaultValue=\"1\"\n          \n          \n            \n                        android:defaultValue=\"0\"", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r437349835", "createdAt": "2020-06-09T11:54:33Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/res/xml/preferences_custom_buttons.xml", "diffHunk": "@@ -81,6 +81,12 @@ MENU_DISABLED = 3\n             android:entryValues=\"@array/custom_button_values\"\n             android:key=\"customButtonMarkCard\"\n             android:title=\"@string/menu_mark_note\" />\n+        <ListPreference\n+            android:defaultValue=\"1\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfb7b8e4436af3f84f7d5bda807a7aaa18936143"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM1MDc1NA==", "bodyText": "Consistency with other preferences\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ankidroid:showAsAction=\"ifRoom\"/>\n          \n          \n            \n                    ankidroid:showAsAction=\"never\"/>", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#discussion_r437350754", "createdAt": "2020-06-09T11:56:06Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/res/menu/reviewer.xml", "diffHunk": "@@ -61,6 +61,11 @@\n         android:title=\"@string/replay_audio\"\n         android:icon=\"@drawable/ic_play_circle_white\"\n         ankidroid:showAsAction=\"ifRoom\"/>\n+    <item\n+        android:id=\"@+id/action_toggle_mic_tool_bar\"\n+        android:title=\"@string/toggle_mic_tool_bar\"\n+        android:icon=\"@drawable/ic_action_mic\"\n+        ankidroid:showAsAction=\"ifRoom\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfb7b8e4436af3f84f7d5bda807a7aaa18936143"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d492cb5bfe99ec4e58f8dcfbb6696e14311cce86", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d492cb5bfe99ec4e58f8dcfbb6696e14311cce86", "committedDate": "2020-06-09T12:19:57Z", "message": "Update AnkiDroid/src/main/res/xml/preferences_custom_buttons.xml\n\nCo-authored-by: david-allison-1 <62114487+david-allison-1@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d59523437be0c711bc01ad8dc2f203afd0767fa", "author": {"user": {"login": "dgeranton", "name": null}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3d59523437be0c711bc01ad8dc2f203afd0767fa", "committedDate": "2020-06-09T12:20:17Z", "message": "Update AnkiDroid/src/main/res/menu/reviewer.xml\n\nCo-authored-by: david-allison-1 <62114487+david-allison-1@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDkwNDkz", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#pullrequestreview-427090493", "createdAt": "2020-06-09T12:29:51Z", "commit": {"oid": "3d59523437be0c711bc01ad8dc2f203afd0767fa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDQ3Nzgy", "url": "https://github.com/ankidroid/Anki-Android/pull/5774#pullrequestreview-427447782", "createdAt": "2020-06-09T18:50:39Z", "commit": {"oid": "3d59523437be0c711bc01ad8dc2f203afd0767fa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3687, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}