{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1Mjc4MDIy", "number": 7061, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNzoxMTo1N1rOEin9QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDo0NzowNVrOEl1VGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NzQxNjk2OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/ui/TvNavigationElement.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNzoxMTo1N1rOHQnC8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNzoxMTo1N1rOHQnC8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3ODk5NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // COULD_BE_BETTER: This crashes inside the framework if right is pressed on the\n          \n          \n            \n                        // COULD_BE_BETTER: This crashes inside the framework if \"left\" is pressed when a submenu is open", "url": "https://github.com/ankidroid/Anki-Android/pull/7061#discussion_r487178994", "createdAt": "2020-09-11T17:11:57Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/ui/TvNavigationElement.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ *  Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+ *\n+ *  This program is free software; you can redistribute it and/or modify it under\n+ *  the terms of the GNU General Public License as published by the Free Software\n+ *  Foundation; either version 3 of the License, or (at your option) any later\n+ *  version.\n+ *\n+ *  This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ *  PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+ *\n+ *  You should have received a copy of the GNU General Public License along with\n+ *  this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.ui;\n+\n+import android.annotation.SuppressLint;\n+import android.content.Context;\n+import android.content.ContextWrapper;\n+import android.graphics.Rect;\n+import android.os.Build;\n+import android.util.AttributeSet;\n+import android.view.View;\n+\n+import com.ichi2.anki.NavigationDrawerActivity;\n+\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import androidx.appcompat.app.ActionBar;\n+import androidx.appcompat.app.AppCompatActivity;\n+import timber.log.Timber;\n+\n+/** Hack to allow the navigation and options menu to appear when on a TV\n+ *  This is a view to handle dispatchUnhandledMove without using onKeyUp/Down\n+ *  (which interferes with other view events) */\n+public class TvNavigationElement extends View {\n+    public TvNavigationElement(Context context) {\n+        super(context);\n+    }\n+\n+\n+    public TvNavigationElement(Context context, @Nullable AttributeSet attrs) {\n+        super(context, attrs);\n+    }\n+\n+\n+    public TvNavigationElement(Context context, @Nullable AttributeSet attrs, int defStyleAttr) {\n+        super(context, attrs, defStyleAttr);\n+    }\n+\n+\n+    @SuppressWarnings( {\"unused\", \"RedundantSuppression\"})\n+    @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)\n+    public TvNavigationElement(Context context, @Nullable AttributeSet attrs, int defStyleAttr, int defStyleRes) {\n+        super(context, attrs, defStyleAttr, defStyleRes);\n+    }\n+\n+\n+    @Override\n+    protected void onFocusChanged(boolean gainFocus, int direction, @Nullable Rect previouslyFocusedRect) {\n+        Timber.d(\"onFocusChanged %d\", direction);\n+        super.onFocusChanged(gainFocus, direction, previouslyFocusedRect);\n+    }\n+\n+\n+    @Override\n+    public boolean dispatchUnhandledMove(View focused, int direction) {\n+        Timber.d(\"dispatchUnhandledMove %d\", direction);\n+\n+        AppCompatActivity activity = getActivity();\n+        if (activity == null) {\n+            return super.dispatchUnhandledMove(focused, direction);\n+        }\n+\n+        if (direction == FOCUS_LEFT && activity instanceof NavigationDrawerActivity) {\n+            // COULD_BE_BETTER: This leaves focus on the top item when navigation occurs.\n+            NavigationDrawerActivity navigationDrawerActivity = (NavigationDrawerActivity) activity;\n+            navigationDrawerActivity.toggleDrawer();\n+            navigationDrawerActivity.focusNavigation();\n+            return true;\n+        }\n+\n+        if (direction == FOCUS_RIGHT) {\n+            Timber.d(\"Opening options menu\");\n+            // COULD_BE_BETTER: This crashes inside the framework if right is pressed on the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49dca20951b2465447b0a22804739dc098cd9dff"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NzQxNzgzOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/ui/TvNavigationElement.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNzoxMjoxNVrOHQnDeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNzoxMjoxNVrOHQnDeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3OTEzMA==", "bodyText": "I couldn't repro a second time", "url": "https://github.com/ankidroid/Anki-Android/pull/7061#discussion_r487179130", "createdAt": "2020-09-11T17:12:15Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/ui/TvNavigationElement.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ *  Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+ *\n+ *  This program is free software; you can redistribute it and/or modify it under\n+ *  the terms of the GNU General Public License as published by the Free Software\n+ *  Foundation; either version 3 of the License, or (at your option) any later\n+ *  version.\n+ *\n+ *  This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ *  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ *  PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+ *\n+ *  You should have received a copy of the GNU General Public License along with\n+ *  this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.ui;\n+\n+import android.annotation.SuppressLint;\n+import android.content.Context;\n+import android.content.ContextWrapper;\n+import android.graphics.Rect;\n+import android.os.Build;\n+import android.util.AttributeSet;\n+import android.view.View;\n+\n+import com.ichi2.anki.NavigationDrawerActivity;\n+\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import androidx.appcompat.app.ActionBar;\n+import androidx.appcompat.app.AppCompatActivity;\n+import timber.log.Timber;\n+\n+/** Hack to allow the navigation and options menu to appear when on a TV\n+ *  This is a view to handle dispatchUnhandledMove without using onKeyUp/Down\n+ *  (which interferes with other view events) */\n+public class TvNavigationElement extends View {\n+    public TvNavigationElement(Context context) {\n+        super(context);\n+    }\n+\n+\n+    public TvNavigationElement(Context context, @Nullable AttributeSet attrs) {\n+        super(context, attrs);\n+    }\n+\n+\n+    public TvNavigationElement(Context context, @Nullable AttributeSet attrs, int defStyleAttr) {\n+        super(context, attrs, defStyleAttr);\n+    }\n+\n+\n+    @SuppressWarnings( {\"unused\", \"RedundantSuppression\"})\n+    @RequiresApi(api = Build.VERSION_CODES.LOLLIPOP)\n+    public TvNavigationElement(Context context, @Nullable AttributeSet attrs, int defStyleAttr, int defStyleRes) {\n+        super(context, attrs, defStyleAttr, defStyleRes);\n+    }\n+\n+\n+    @Override\n+    protected void onFocusChanged(boolean gainFocus, int direction, @Nullable Rect previouslyFocusedRect) {\n+        Timber.d(\"onFocusChanged %d\", direction);\n+        super.onFocusChanged(gainFocus, direction, previouslyFocusedRect);\n+    }\n+\n+\n+    @Override\n+    public boolean dispatchUnhandledMove(View focused, int direction) {\n+        Timber.d(\"dispatchUnhandledMove %d\", direction);\n+\n+        AppCompatActivity activity = getActivity();\n+        if (activity == null) {\n+            return super.dispatchUnhandledMove(focused, direction);\n+        }\n+\n+        if (direction == FOCUS_LEFT && activity instanceof NavigationDrawerActivity) {\n+            // COULD_BE_BETTER: This leaves focus on the top item when navigation occurs.\n+            NavigationDrawerActivity navigationDrawerActivity = (NavigationDrawerActivity) activity;\n+            navigationDrawerActivity.toggleDrawer();\n+            navigationDrawerActivity.focusNavigation();\n+            return true;\n+        }\n+\n+        if (direction == FOCUS_RIGHT) {\n+            Timber.d(\"Opening options menu\");\n+            // COULD_BE_BETTER: This crashes inside the framework if right is pressed on the\n+            openOptionsMenu(activity);\n+            return true;\n+        }\n+        return super.dispatchUnhandledMove(focused, direction);\n+    }\n+\n+\n+    @SuppressLint(\"RestrictedApi\")\n+    private void openOptionsMenu(AppCompatActivity activity) {\n+        // This occasionally glitches graphically on my emulator", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49dca20951b2465447b0a22804739dc098cd9dff"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTA2NTIwOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMDo0NzowNVrOHVh1bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMTo1MDoxOVrOHVjolA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMzNjQ5Mg==", "bodyText": "Actually, now the WebView is out of the picture, this can probably go away", "url": "https://github.com/ankidroid/Anki-Android/pull/7061#discussion_r492336492", "createdAt": "2020-09-21T20:47:05Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -658,14 +683,72 @@ public boolean onCreateOptionsMenu(Menu menu) {\n         bury_icon.getIcon().mutate().setAlpha(alpha);\n         suspend_icon.getIcon().mutate().setAlpha(alpha);\n \n-        MenuItemCompat.setActionProvider(menu.findItem(R.id.action_schedule), new ScheduleProvider(this));\n+        setupSubMenu(menu, R.id.action_schedule, new ScheduleProvider(this));\n         return super.onCreateOptionsMenu(menu);\n     }\n \n \n+    @SuppressLint(\"RestrictedApi\") // setIconTintList\n+    private void displayIconsOnTv(Menu menu) {\n+        try {\n+            if (AndroidUiUtils.isRunningOnTv(this) && menu instanceof MenuBuilder) {\n+                MenuBuilder m = (MenuBuilder) menu;\n+                m.setOptionalIconsVisible(true);\n+            }\n+\n+            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\n+                for (int i = 0; i < menu.size(); i++) {\n+                    MenuItem m = menu.getItem(i);\n+\n+                    if (m == null || isFlagResource(m.getItemId())) {\n+                        continue;\n+                    }\n+\n+                    int color = Themes.getColorFromAttr(this, R.attr.navDrawerItemColor);\n+                    m.setIconTintList(ColorStateList.valueOf(color));\n+\n+                }\n+            }\n+\n+        } catch (Exception e) {\n+            Timber.w(e, \"Failed to display icons\");\n+        } catch (Error e) {\n+            Timber.w(e, \"Failed to display icons\");\n+        }\n+    }\n+\n+\n+    private boolean isFlagResource(int itemId) {\n+        return itemId == R.id.action_flag_four\n+                || itemId == R.id.action_flag_three\n+                || itemId == R.id.action_flag_two\n+                || itemId == R.id.action_flag_one;\n+    }\n     @Override\n     public boolean onKeyDown(int keyCode, KeyEvent event) {\n-        return mProcessor.onKeyDown(keyCode, event) || super.onKeyDown(keyCode, event);\n+        if (mProcessor.onKeyDown(keyCode, event) || super.onKeyDown(keyCode, event)) {\n+            return true;\n+        }\n+\n+        // Process DPAD Up/Down to focus the TV Controls\n+        if (keyCode != KeyEvent.KEYCODE_DPAD_DOWN && keyCode != KeyEvent.KEYCODE_DPAD_UP) {\n+            return false;\n+        }\n+\n+        // HACK: This shouldn't be required, as the navigation should handle this.\n+        if (isDrawerOpen()) {\n+            return false;\n+        }\n+\n+        // HACK: We should be performing this in the base class, or allowing the view to be focused by the keyboard.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18fcc55f7767df6f2b222727b800526cec8ca502"}, "originalPosition": 197}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM2NTk3Mg==", "bodyText": "Nope \ud83d\udc4e", "url": "https://github.com/ankidroid/Anki-Android/pull/7061#discussion_r492365972", "createdAt": "2020-09-21T21:50:19Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -658,14 +683,72 @@ public boolean onCreateOptionsMenu(Menu menu) {\n         bury_icon.getIcon().mutate().setAlpha(alpha);\n         suspend_icon.getIcon().mutate().setAlpha(alpha);\n \n-        MenuItemCompat.setActionProvider(menu.findItem(R.id.action_schedule), new ScheduleProvider(this));\n+        setupSubMenu(menu, R.id.action_schedule, new ScheduleProvider(this));\n         return super.onCreateOptionsMenu(menu);\n     }\n \n \n+    @SuppressLint(\"RestrictedApi\") // setIconTintList\n+    private void displayIconsOnTv(Menu menu) {\n+        try {\n+            if (AndroidUiUtils.isRunningOnTv(this) && menu instanceof MenuBuilder) {\n+                MenuBuilder m = (MenuBuilder) menu;\n+                m.setOptionalIconsVisible(true);\n+            }\n+\n+            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {\n+                for (int i = 0; i < menu.size(); i++) {\n+                    MenuItem m = menu.getItem(i);\n+\n+                    if (m == null || isFlagResource(m.getItemId())) {\n+                        continue;\n+                    }\n+\n+                    int color = Themes.getColorFromAttr(this, R.attr.navDrawerItemColor);\n+                    m.setIconTintList(ColorStateList.valueOf(color));\n+\n+                }\n+            }\n+\n+        } catch (Exception e) {\n+            Timber.w(e, \"Failed to display icons\");\n+        } catch (Error e) {\n+            Timber.w(e, \"Failed to display icons\");\n+        }\n+    }\n+\n+\n+    private boolean isFlagResource(int itemId) {\n+        return itemId == R.id.action_flag_four\n+                || itemId == R.id.action_flag_three\n+                || itemId == R.id.action_flag_two\n+                || itemId == R.id.action_flag_one;\n+    }\n     @Override\n     public boolean onKeyDown(int keyCode, KeyEvent event) {\n-        return mProcessor.onKeyDown(keyCode, event) || super.onKeyDown(keyCode, event);\n+        if (mProcessor.onKeyDown(keyCode, event) || super.onKeyDown(keyCode, event)) {\n+            return true;\n+        }\n+\n+        // Process DPAD Up/Down to focus the TV Controls\n+        if (keyCode != KeyEvent.KEYCODE_DPAD_DOWN && keyCode != KeyEvent.KEYCODE_DPAD_UP) {\n+            return false;\n+        }\n+\n+        // HACK: This shouldn't be required, as the navigation should handle this.\n+        if (isDrawerOpen()) {\n+            return false;\n+        }\n+\n+        // HACK: We should be performing this in the base class, or allowing the view to be focused by the keyboard.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjMzNjQ5Mg=="}, "originalCommit": {"oid": "18fcc55f7767df6f2b222727b800526cec8ca502"}, "originalPosition": 197}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 917, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}