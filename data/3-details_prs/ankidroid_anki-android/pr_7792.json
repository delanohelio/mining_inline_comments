{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5MDM2NzUx", "number": 7792, "title": "Add check that onPageFinished runs on the viewer url", "bodyText": "Purpose / Description\nFixes onPageFinished in JavaScript being run multiple times unneccessarily.\nFixes\nFixes #7790\nApproach\nIt checks that onPageFinished runs agains the viewers main url, without any anchors.\nHow Has This Been Tested?\nI made sure, that onPageFinished within JavaScript is only ever executed once.\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-11-29T02:10:16Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7792", "merged": true, "mergeCommit": {"oid": "43d3d9cbabcf8fefcb9cdea27a4894a0f84de4d5"}, "closed": true, "closedAt": "2020-11-30T14:48:58Z", "author": {"login": "hgiesel"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhG-g_gH2gAyNTI5MDM2NzUxOjE1OGY2OTk1YzM2MjE2NDQxZmNiYjMxZTU3NzlkZDE2NmVmMmUzZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhmff6AFqTU0MDk3NzE4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "158f6995c36216441fcbb31e5779dd166ef2e3dd", "author": {"user": {"login": "hgiesel", "name": "Henrik Giesel"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/158f6995c36216441fcbb31e5779dd166ef2e3dd", "committedDate": "2020-11-29T02:04:27Z", "message": "Add check that onPageFinished runs on the viewer url\n\n* without any anchors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDc5MzAw", "url": "https://github.com/ankidroid/Anki-Android/pull/7792#pullrequestreview-540479300", "createdAt": "2020-11-29T13:22:15Z", "commit": {"oid": "158f6995c36216441fcbb31e5779dd166ef2e3dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxMzoyMjoxNlrOH7jeRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxMzoyMjoxNlrOH7jeRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjIwOTIyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Timber.d(\"onPageFinished triggered: %s\", url);\n          \n          \n            \n            \n          \n          \n            \n                        // onPageFinished will be called multiple times if the WebView redirects by setting window.location.href\n          \n          \n            \n                        if (url.equals(mViewerUrl)) {\n          \n          \n            \n                            drawFlag();\n          \n          \n            \n                            drawMark();\n          \n          \n            \n                            view.loadUrl(\"javascript:onPageFinished();\");\n          \n          \n            \n                        }\n          \n          \n            \n                        Timber.d(\"Java onPageFinished triggered: %s\", url);\n          \n          \n            \n            \n          \n          \n            \n                        // onPageFinished will be called multiple times if the WebView redirects by setting window.location.href\n          \n          \n            \n                        if (url.equals(mViewerUrl)) {\n          \n          \n            \n                            Timber.d(\"New URL, drawing flags, marks, and triggering JS onPageFinished: %s\", url);\n          \n          \n            \n                            drawFlag();\n          \n          \n            \n                            drawMark();\n          \n          \n            \n                            view.loadUrl(\"javascript:onPageFinished();\");\n          \n          \n            \n                        }", "url": "https://github.com/ankidroid/Anki-Android/pull/7792#discussion_r532209222", "createdAt": "2020-11-29T13:22:16Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -3478,10 +3480,14 @@ private String decodeUrl(String url) {\n         // Run any post-load events in javascript that rely on the window being completely loaded.\n         @Override\n         public void onPageFinished(WebView view, String url) {\n-            Timber.d(\"onPageFinished triggered\");\n-            drawFlag();\n-            drawMark();\n-            view.loadUrl(\"javascript:onPageFinished();\");\n+            Timber.d(\"onPageFinished triggered: %s\", url);\n+\n+            // onPageFinished will be called multiple times if the WebView redirects by setting window.location.href\n+            if (url.equals(mViewerUrl)) {\n+                drawFlag();\n+                drawMark();\n+                view.loadUrl(\"javascript:onPageFinished();\");\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "158f6995c36216441fcbb31e5779dd166ef2e3dd"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1a198c0c3df8d0c67e2e16f18abeab651903a45", "author": {"user": {"login": "hgiesel", "name": "Henrik Giesel"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b1a198c0c3df8d0c67e2e16f18abeab651903a45", "committedDate": "2020-11-30T13:11:28Z", "message": "Add additional logging for onPageFinished\n\nCo-authored-by: Mike Hardy <github@mikehardy.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTc3MTgw", "url": "https://github.com/ankidroid/Anki-Android/pull/7792#pullrequestreview-540977180", "createdAt": "2020-11-30T14:47:32Z", "commit": {"oid": "b1a198c0c3df8d0c67e2e16f18abeab651903a45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3773, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}