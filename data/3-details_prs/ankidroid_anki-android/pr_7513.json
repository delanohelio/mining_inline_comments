{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5NjA1MjEx", "number": 7513, "title": "Show partial result in browser before showing all", "bodyText": "Pull Request template\nPurpose / Description\nCurrently, showing search result in the browser takes time. On my collection, showing a big deck with subdecks takes 20 seconds. I thought that it could be possible to first show the first cards, and then show the full result. The number of cards I chose is exactly the number of precomputed cards we were already calculating. This lead to showing a part of the result in 7 seconds, while the whole result still takes 20 seconds to show.\nThe progress bar is still displayed to indicate that the result is not yet fully present.\nSince the card we must show is not yet necessarily in the list, I wait until the full list is  computed to scroll to it.\nApproach\nThe collection task sends a progress update with the partial result.\nWe may also want to regularly send partial result, so that the list grow and the user actually see there is work in progress.\nOne of the program was that the finder deal with list of card id, and the collection task deals with list of card cache. I had to create a class which change the list of cids to the list of card caches, precompute the data of the first card to display, and ensure this caching is actually cached. I do believe that splitting the CollectionTask in smaller classes would have helped here and make code simpler, but I am not going to wait until this is fully discussed and merged/corrected to add this feature.\nHow Has This Been Tested?\nI run it on my phone, and check it works. I check that some partial result appears quite quicker and that there is no more delay for the full result.\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code\n UI changes: include screenshots of all affected screens (in particular showing any new or changed strings)", "createdAt": "2020-10-25T14:52:25Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7513", "merged": true, "mergeCommit": {"oid": "9103930e7c95d765056b784336c28356751379be"}, "closed": true, "closedAt": "2020-11-20T12:54:41Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWXEyggFqTUxNjk2NTEwMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWyLIjgFqTUxODIzNzQ2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTY1MTAx", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#pullrequestreview-516965101", "createdAt": "2020-10-26T16:36:37Z", "commit": {"oid": "f81f4d15af88bf4dd85dac7e629f2c384f38accc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjozNjozN1rOHoYOuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjozNjozN1rOHoYOuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwMjA3Mw==", "bodyText": "typo mPositino -> mPosition but it won't let me make the suggestion", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512102073", "createdAt": "2020-10-26T16:36:37Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1176,6 +1176,59 @@ private TaskData doInBackgroundUndo() {\n     }\n \n \n+    /**\n+     * A class allowing to send partial search result to the browser to display while the search ends\n+     */\n+    public class PartialSearch implements CancelListener, ProgressSender<List<Long>> {\n+        private final List<CardBrowser.CardCache> mCards;\n+        private int mPosition = 0;\n+        private final int mColumn1Index, mColumn2Index;\n+        private final int mNumCardsToRender;\n+\n+        public PartialSearch(List<CardBrowser.CardCache> cards, int columnIndex1, int columnIndex2, int numCardsToRender) {\n+            mCards = cards;\n+            mColumn1Index = columnIndex1;\n+            mColumn2Index = columnIndex2;\n+            mNumCardsToRender = numCardsToRender;\n+        }\n+\n+        @Override\n+        public boolean isCancelled() {\n+            return CollectionTask.this.isCancelled();\n+        }\n+\n+\n+        /**\n+         * @param cids Card ids to display in the browser. It is assumed that its length is at least `mPosition`, and that mCards[i].cid = cids[i].\n+         *             It add the cards in cids after `mPosition` to mCards\n+         */\n+        public void add(@NonNull List<Long> cids) {\n+            for (; mPosition < cids.size(); ++mPosition) {\n+                mCards.add(new CardBrowser.CardCache(cids.get(mPosition), getCol(), mPosition));\n+            }\n+            // At the end of the loop, mPositino is the size of cids, we want it to be the last position in cids", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f81f4d15af88bf4dd85dac7e629f2c384f38accc"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTY3NDM1", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#pullrequestreview-516967435", "createdAt": "2020-10-26T16:39:10Z", "commit": {"oid": "f81f4d15af88bf4dd85dac7e629f2c384f38accc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjozOToxMFrOHoYVkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjozOToxMFrOHoYVkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwMzgyNg==", "bodyText": "formatting here, missing 4-space indent", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512103826", "createdAt": "2020-10-26T16:39:10Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1176,6 +1176,59 @@ private TaskData doInBackgroundUndo() {\n     }\n \n \n+    /**\n+     * A class allowing to send partial search result to the browser to display while the search ends\n+     */\n+    public class PartialSearch implements CancelListener, ProgressSender<List<Long>> {\n+        private final List<CardBrowser.CardCache> mCards;\n+        private int mPosition = 0;\n+        private final int mColumn1Index, mColumn2Index;\n+        private final int mNumCardsToRender;\n+\n+        public PartialSearch(List<CardBrowser.CardCache> cards, int columnIndex1, int columnIndex2, int numCardsToRender) {\n+            mCards = cards;\n+            mColumn1Index = columnIndex1;\n+            mColumn2Index = columnIndex2;\n+            mNumCardsToRender = numCardsToRender;\n+        }\n+\n+        @Override\n+        public boolean isCancelled() {\n+            return CollectionTask.this.isCancelled();\n+        }\n+\n+\n+        /**\n+         * @param cids Card ids to display in the browser. It is assumed that its length is at least `mPosition`, and that mCards[i].cid = cids[i].\n+         *             It add the cards in cids after `mPosition` to mCards\n+         */\n+        public void add(@NonNull List<Long> cids) {\n+            for (; mPosition < cids.size(); ++mPosition) {\n+                mCards.add(new CardBrowser.CardCache(cids.get(mPosition), getCol(), mPosition));\n+            }\n+            // At the end of the loop, mPositino is the size of cids, we want it to be the last position in cids\n+            mPosition--;\n+        }\n+\n+\n+        @Override\n+        public void doProgress(@NonNull List<Long>... values) {\n+            add(values[0]);\n+            for (CardBrowser.CardCache card : mCards) {\n+                if (isCancelled()) {\n+                Timber.d(\"doInBackgroundSearchCards was cancelled so return\u00ab\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f81f4d15af88bf4dd85dac7e629f2c384f38accc"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTcyODc1", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#pullrequestreview-516972875", "createdAt": "2020-10-26T16:44:59Z", "commit": {"oid": "f81f4d15af88bf4dd85dac7e629f2c384f38accc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjo0NTowMFrOHoYlcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjo0NTowMFrOHoYlcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwNzg5MA==", "bodyText": "curious - if it's just one loop, why extract it? it seems more difficult to read this way, as it implies it might be used elsewhere (and thus update internal state) but it is only used in doProgress I think?", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512107890", "createdAt": "2020-10-26T16:45:00Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1176,6 +1176,59 @@ private TaskData doInBackgroundUndo() {\n     }\n \n \n+    /**\n+     * A class allowing to send partial search result to the browser to display while the search ends\n+     */\n+    public class PartialSearch implements CancelListener, ProgressSender<List<Long>> {\n+        private final List<CardBrowser.CardCache> mCards;\n+        private int mPosition = 0;\n+        private final int mColumn1Index, mColumn2Index;\n+        private final int mNumCardsToRender;\n+\n+        public PartialSearch(List<CardBrowser.CardCache> cards, int columnIndex1, int columnIndex2, int numCardsToRender) {\n+            mCards = cards;\n+            mColumn1Index = columnIndex1;\n+            mColumn2Index = columnIndex2;\n+            mNumCardsToRender = numCardsToRender;\n+        }\n+\n+        @Override\n+        public boolean isCancelled() {\n+            return CollectionTask.this.isCancelled();\n+        }\n+\n+\n+        /**\n+         * @param cids Card ids to display in the browser. It is assumed that its length is at least `mPosition`, and that mCards[i].cid = cids[i].\n+         *             It add the cards in cids after `mPosition` to mCards\n+         */\n+        public void add(@NonNull List<Long> cids) {\n+            for (; mPosition < cids.size(); ++mPosition) {\n+                mCards.add(new CardBrowser.CardCache(cids.get(mPosition), getCol(), mPosition));\n+            }\n+            // At the end of the loop, mPositino is the size of cids, we want it to be the last position in cids\n+            mPosition--;\n+        }\n+\n+\n+        @Override\n+        public void doProgress(@NonNull List<Long>... values) {\n+            add(values[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f81f4d15af88bf4dd85dac7e629f2c384f38accc"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTc4MjYz", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#pullrequestreview-516978263", "createdAt": "2020-10-26T16:47:57Z", "commit": {"oid": "f81f4d15af88bf4dd85dac7e629f2c384f38accc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjo0Nzo1N1rOHoYvmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjo0Nzo1N1rOHoYvmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExMDQ5MQ==", "bodyText": "I think you could eliminate the mPosition state here - if I'm reading correctly, mPosition is \"mCards.size() - 1\" at all times? Then this loop can be a standard iterator for (int i = (mCards - 1); i < cids.size(); i++), eliminating both the state and the more complicated for-loop construction?", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r512110491", "createdAt": "2020-10-26T16:47:57Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1176,6 +1176,59 @@ private TaskData doInBackgroundUndo() {\n     }\n \n \n+    /**\n+     * A class allowing to send partial search result to the browser to display while the search ends\n+     */\n+    public class PartialSearch implements CancelListener, ProgressSender<List<Long>> {\n+        private final List<CardBrowser.CardCache> mCards;\n+        private int mPosition = 0;\n+        private final int mColumn1Index, mColumn2Index;\n+        private final int mNumCardsToRender;\n+\n+        public PartialSearch(List<CardBrowser.CardCache> cards, int columnIndex1, int columnIndex2, int numCardsToRender) {\n+            mCards = cards;\n+            mColumn1Index = columnIndex1;\n+            mColumn2Index = columnIndex2;\n+            mNumCardsToRender = numCardsToRender;\n+        }\n+\n+        @Override\n+        public boolean isCancelled() {\n+            return CollectionTask.this.isCancelled();\n+        }\n+\n+\n+        /**\n+         * @param cids Card ids to display in the browser. It is assumed that its length is at least `mPosition`, and that mCards[i].cid = cids[i].\n+         *             It add the cards in cids after `mPosition` to mCards\n+         */\n+        public void add(@NonNull List<Long> cids) {\n+            for (; mPosition < cids.size(); ++mPosition) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f81f4d15af88bf4dd85dac7e629f2c384f38accc"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTc4OTQx", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#pullrequestreview-516978941", "createdAt": "2020-10-26T16:48:41Z", "commit": {"oid": "95ee51675a738c8565cc63b774b6e6cb9e03c97d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95ee51675a738c8565cc63b774b6e6cb9e03c97d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/95ee51675a738c8565cc63b774b6e6cb9e03c97d", "committedDate": "2020-10-25T15:07:09Z", "message": "NF: comment query"}, "afterCommit": {"oid": "607aef7f1398f5d67c8307d5efcdc66bce61a363", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/607aef7f1398f5d67c8307d5efcdc66bce61a363", "committedDate": "2020-10-26T18:14:03Z", "message": "NF: comment query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDg0MjE3", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#pullrequestreview-517084217", "createdAt": "2020-10-26T18:55:35Z", "commit": {"oid": "607aef7f1398f5d67c8307d5efcdc66bce61a363"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "607aef7f1398f5d67c8307d5efcdc66bce61a363", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/607aef7f1398f5d67c8307d5efcdc66bce61a363", "committedDate": "2020-10-26T18:14:03Z", "message": "NF: comment query"}, "afterCommit": {"oid": "eafcf9466ad28fbb15aff87868183443b7e26b7a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/eafcf9466ad28fbb15aff87868183443b7e26b7a", "committedDate": "2020-10-26T20:52:18Z", "message": "NF: comment query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b0c48f73950e1d25cd0d2f4f70239ad6ace3c98", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0b0c48f73950e1d25cd0d2f4f70239ad6ace3c98", "committedDate": "2020-10-28T00:01:09Z", "message": "Show partial result in browser before showing all"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9", "committedDate": "2020-10-28T00:01:09Z", "message": "NF: comment query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eafcf9466ad28fbb15aff87868183443b7e26b7a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/eafcf9466ad28fbb15aff87868183443b7e26b7a", "committedDate": "2020-10-26T20:52:18Z", "message": "NF: comment query"}, "afterCommit": {"oid": "de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9", "committedDate": "2020-10-28T00:01:09Z", "message": "NF: comment query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MjM3NDYx", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#pullrequestreview-518237461", "createdAt": "2020-10-28T00:07:22Z", "commit": {"oid": "de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMDowNzoyMlrOHpVWvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMDowNzoyMlrOHpVWvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMzU1MQ==", "bodyText": "Nit: encapsulate searchResult, and rename the other variable", "url": "https://github.com/ankidroid/Anki-Android/pull/7513#discussion_r513103551", "createdAt": "2020-10-28T00:07:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1188,23 +1238,12 @@ private TaskData doInBackgroundSearchCards(TaskData param) {\n         }\n         int column1Index = (Integer) param.getObjArray()[3];\n         int column2Index = (Integer) param.getObjArray()[4];\n-        List<Long> searchResult_ = col.findCards(query, order, this);\n+        final List<CardBrowser.CardCache> searchResult = new ArrayList<>();\n+        PartialSearch partialSearch = new PartialSearch(searchResult, column1Index, column2Index, numCardsToRender);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de5e4cd325b2cc0bb52b1c9590f0060e5e2906e9"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3782, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}