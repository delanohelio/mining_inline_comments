{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MDg2NzEw", "number": 6457, "title": "Avoid unhandled out-of-space and OOM on large imports", "bodyText": "Pull Request template\nPurpose / Description\nThis is a continuation of #4622 from @camparijet - his original idea - do partial commits to the database while importing - seemed correct but I could not get it to work at the time.\nNow with very large decks being more normal (#6419 #6438 #6435) I was reminded about this and wanted to try it again\nFixes\nFixes #6419 at least in part\nMaybe fixes #4481 #2596\nApproach\n\nScan a zip before even trying it, tell the user if there is not enough space to decompress\nDuring import, commit work and clear scratch space periodically so we don't run out of memory\nDuring import if we run out of space, report that to the user nicely\nPost import, during cleanup, if we run out of space report that to the user nicely\n\nHow Has This Been Tested?\nThis was tested on an emulator, with each scenario repeating these steps\n\nshutdown the emulator\nwipe data\nset the external sdcard size to a specific size\nstart the emulator\nupload the attached OOM collection to /sdcard/Download/\nimport the OOM collection (original https://drive.google.com/open?id=0B5kybuti0pOIQXoxRmtHMWc2c00 and I will try to attach it here\nOOMDeck.apkg.gz\n)\n\nHere are the scenarios to run, by size of sdcard, and what you should see:\n\n350MB sdcard, you should get an error that there isn't enough space to unzip\n500MB of sdcard, you should get an error during import that import failed because disk was full\n1GB of sdcard, message that import succeeded but cleanup failed. Deck works. DB check afterwards works.\n1.5GB of sdcard, everything should work.\n\nWithout this patch, it just fails everywhere.\nLearning (optional, can help others)\nLook really closely at PRs before you discard them? This one was one line away from working last time. (it was missing revlog.clear()\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-06-14T02:57:27Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6457", "merged": true, "mergeCommit": {"oid": "21adf1fcda732af48bd4c2d6702efebf774939bf"}, "closed": true, "closedAt": "2020-06-15T19:06:07Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrBmSWgH2gAyNDM0MDg2NzEwOjNjNDVkZmY4YWRlNjlhYjJjZjlkODY2ZGIzYWNkZGNkYzEzNzk3M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcri4w8ABqjM0NDUxMTkzNzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3c45dff8ade69ab2cf9d866db3acddcdc137973d", "author": {"user": {"login": "camparijet", "name": "TAKEOKA Hideki"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3c45dff8ade69ab2cf9d866db3acddcdc137973d", "committedDate": "2020-06-14T01:16:33Z", "message": "to avoid OOM, process add/update/dirty.. partially"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fa6c4fa205da287b9e4e20c207c72fcf6ec7b61", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6fa6c4fa205da287b9e4e20c207c72fcf6ec7b61", "committedDate": "2020-06-14T01:34:51Z", "message": "Verify space to unzip, reduce import mem use"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cb44ffcc803f9294ede244cb72a72d73a492827", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4cb44ffcc803f9294ede244cb72a72d73a492827", "committedDate": "2020-06-14T02:13:55Z", "message": "Handle disk full errors on import gracefully\n\nIf you run out of disk while importing, the errors percolate up\nin the most unexpected ways. This is the actual tested way they show up,\nhandled in a way that the user sees that they ran out of disk in the dialog\nbox, so they can hopefully self help"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/51ff7c61445aeafe71e07e83654b01837a95359d", "committedDate": "2020-06-14T03:05:15Z", "message": "Gracefully handle post-import cleanup failures\n\nThe user should get a notice that check database will help\nthem, but the import actually worked - the data is fine\n\nThis can happen if you import a very large deck at the limit\nof the space available on your device, because vacuum can take\nso much extra space"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dde55db9b811cae3257cd05739b99b174e4e5eb8", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/dde55db9b811cae3257cd05739b99b174e4e5eb8", "committedDate": "2020-06-14T02:38:36Z", "message": "Gracefully handle post-import cleanup failures\n\nThe user should get a notice that check database will help\nthem, but the import actually worked - the data is fine\n\nThis can happen if you import a very large deck at the limit\nof the space available on your device, because vacuum can take\nso much extra space"}, "afterCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/51ff7c61445aeafe71e07e83654b01837a95359d", "committedDate": "2020-06-14T03:05:15Z", "message": "Gracefully handle post-import cleanup failures\n\nThe user should get a notice that check database will help\nthem, but the import actually worked - the data is fine\n\nThis can happen if you import a very large deck at the limit\nof the space available on your device, because vacuum can take\nso much extra space"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjAwMjg5", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#pullrequestreview-430200289", "createdAt": "2020-06-14T08:56:16Z", "commit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwODo1NjoxNlrOGjbs-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQwOToxNjo1N1rOGjbzmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzIyNw==", "bodyText": "This implies that there is an issue in one of the format strings. Definitely don't suppress here.\nEDIT: I tried a PR to turn this into a lint fail, but it didn't fail here.\nLooks like an issue with values_ti where someone translated our comment literally:\n\n  \n    \n      Anki-Android/AnkiDroid/src/main/res/values-ti/01-core.xml\n    \n    \n        Lines 138 to 140\n      in\n      9595b84\n    \n    \n    \n    \n\n        \n          \n               <string name=\"time_quantity_seconds\">\u130d\u12dc_\u1265\u12dd\u1212_\u12ab\u120d\u12a2\u1273\u1275 \n        \n\n        \n          \n           \u1265\u12dd\u1212 \u130d\u12dc \u1218\u12d0\u1250\u1292 \u1293\u12ed \u130d\u12dc \u12a5\u12ee\u121d\u1362\u1265\u12d8\u12ed \u121d\u1265\u12db\u1215\u1295 \u1265\u12d8\u12ed \u1290\u1320\u1265\u1295 \u12a8\u12a3 \u1295\u1325\u1240\u1218\u120e\u121d\u1362 \n        \n\n        \n          \n           s,min,h,d, \u12a5\u12da\u12a6\u121d \u12a8\u121d \u120d\u1219\u12f5(ISO 31-1) \u1218\u12d0\u1240\u1292\u1273\u1275 \u12a8\u121d\u12a1 \u12cd\u1295 \u12ad\u1275\u122d\u130e\u1219 \u12d8\u12ed\u12ad\u12a5\u1209 \u12a2\u12ee\u121d \u1265\u12cd\u1211\u12f1 \u1295 \u124b\u1295\u124b \u1265 \u120b\u1272\u1295 \u1218\u1235\u122d\u1215 \u1243\u120b\u1275\u1362</string> \n        \n    \n  \n\n\nI've fixed the translation", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439807227", "createdAt": "2020-06-14T08:56:16Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -138,6 +141,7 @@ public static long intTime(int scale) {\n      * @return The time quantity string. Something like \"3 s\" or \"1.7\n      * yr\". Only months and year have a number after the decimal.\n      */\n+    @SuppressLint(\"StringFormatInvalid\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzc4MA==", "bodyText": "I've wanted to look into this for a while, as it makes stack traces harder to reason about.\nIt's the endTransacttion which throws, so I'd presumed that you should be able to get away with mDst.getDb().getDatabase().inTransaction() without the try..catch. Is this not the case?", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439807780", "createdAt": "2020-06-14T09:03:07Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -147,13 +147,33 @@ private void _import() {\n             publishProgress(100, 100, 50);\n             mDst.getDb().getDatabase().setTransactionSuccessful();\n             mDst.getMedia().getDb().getDatabase().setTransactionSuccessful();\n+        } catch (Exception err) {\n+            Timber.e(err, \"_import() exception\");\n+            throw err;\n         } finally {\n-            mDst.getDb().getDatabase().endTransaction();\n-            mDst.getMedia().getDb().getDatabase().endTransaction();\n+            // These methods throw about invalid transaction even when you try!\n+            if (mDst.getDb().getDatabase().inTransaction()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODAxOA==", "bodyText": "The point of executeMany is to perform a for loop in a transaction. We've lost the transaction by moving the logic outside.\nHave you considered turning this into an iterator, so we can keep the current structure, keep a low memory profile and retain the transaction behaviour", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808018", "createdAt": "2020-06-14T09:06:14Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODE5OA==", "bodyText": "Nit: These concatenations inside Timber should be showing lint warnings to use format strings", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808198", "createdAt": "2020-06-14T09:08:09Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,6 +281,31 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() > thresExecAdd){\n+                    totalAddSize  += add.size();\n+                    mDst.getDb().executeMany(\"insert or replace into notes values (?,?,?,?,?,?,?,?,?,?,?)\", add);\n+                    add.clear();\n+                    Timber.d(\"add notes: \"+totalAddSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODM3NA==", "bodyText": "Could you change size for count here. Size (to me) implies a file size.", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808374", "createdAt": "2020-06-14T09:10:32Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -264,9 +317,15 @@ private void _importNotes() {\n                 cur.close();\n             }\n         }\n+\n+        // summarize partial add/update/dirty results for total values\n+        totalAddSize += add.size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQxOA==", "bodyText": "nit: whitespace", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808418", "createdAt": "2020-06-14T09:10:57Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -307,7 +369,6 @@ private boolean _uniquifyNote(Object[] note) {\n \t\treturn false;\n     }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQ0OA==", "bodyText": "nit: whitespace", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808448", "createdAt": "2020-06-14T09:11:17Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -205,6 +231,8 @@ private void _importNotes() {\n             int onePercent = total/100;\n             int i = 0;\n \n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQ3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(cards.size() > thresExecCards){\n          \n          \n            \n                            if (cards.size() > thresExecCards){", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808474", "createdAt": "2020-06-14T09:11:36Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially\n+                if(cards.size() > thresExecCards){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODQ5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(revlog.size() > thresExecRevlog){\n          \n          \n            \n                            if (revlog.size() > thresExecRevlog){", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808496", "createdAt": "2020-06-14T09:11:49Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially\n+                if(cards.size() > thresExecCards){\n+                    totalCardsSize += cards.size();\n+                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                    cards.clear();\n+                    Timber.d(\"add cards: \"+totalCardsSize);\n+                }\n+                // apply revlog changes partially\n+                if(revlog.size() > thresExecRevlog){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODUyNg==", "bodyText": "This logic seems duplicated, can we combine it?", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808526", "createdAt": "2020-06-14T09:12:07Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODY0Mw==", "bodyText": "Optional: could we move these two lines next to each other so it's obvious the spacing is for output purposes.", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808643", "createdAt": "2020-06-14T09:13:42Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                Timber.d(\"Total uncompressed size will be: \" + uncompressedSize);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total available size is:         \" + availableSpace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODg3Ng==", "bodyText": "various nitpicks on the placement of the plus\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Timber.d(\"add cards: \"+totalCardsSize);\n          \n          \n            \n                                Timber.d(\"add cards: \"+ totalCardsSize);", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808876", "createdAt": "2020-06-14T09:16:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -546,6 +611,21 @@ private void _importCards() {\n                 }\n                 cnt += 1;\n                 i++;\n+                // apply card changes partially\n+                if(cards.size() > thresExecCards){\n+                    totalCardsSize += cards.size();\n+                    mDst.getDb().executeMany(\"insert or ignore into cards values (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)\", cards);\n+                    cards.clear();\n+                    Timber.d(\"add cards: \"+totalCardsSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 157}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwODkyMg==", "bodyText": "Definitely better with string formatting on this one", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439808922", "createdAt": "2020-06-14T09:16:57Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                Timber.d(\"Total uncompressed size will be: \" + uncompressedSize);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total available size is:         \" + availableSpace);\n+                if (uncompressedSize > availableSpace) {\n+                    Timber.e(\"Not enough space to unzip, need \" + uncompressedSize + \", available \" + availableSpace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed9db84b64ae40f0e80dafff96b07dfd0b90cfd8", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ed9db84b64ae40f0e80dafff96b07dfd0b90cfd8", "committedDate": "2020-06-14T15:56:44Z", "message": "NF: de-lint format strings, fixes were made in crowdin so will persist\n\nJust committing them here to make sure the strings go green, without\ndoing a full strings sync. All verified on crowdin though, the fixes\nare in upstream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjQ0MjYw", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#pullrequestreview-430244260", "createdAt": "2020-06-14T19:16:45Z", "commit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToxNjo0NVrOGje5Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNFQxOToyNjoxMFrOGje7vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTQ4Nw==", "bodyText": "Are these d or v? could have 30000 notes in a collection", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859487", "createdAt": "2020-06-14T19:16:45Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,39 +279,84 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() >= thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n+                    add.clear();\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (update.size() >= thresExecUpdate){\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (dirty.size() >= thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                   long[] das = Utils.arrayList2array(dirty);\n+                    mDst.updateFieldCache(das);\n+                    mDst.getTags().registerNotes(das);\n+                    dirty.clear();\n+                    Timber.d(\"dirty notes: %d\", totalDirtyCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTUwMQ==", "bodyText": "Nittiest of nits\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                               long[] das = Utils.arrayList2array(dirty);\n          \n          \n            \n                                long[] das = Utils.arrayList2array(dirty);", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859501", "createdAt": "2020-06-14T19:16:57Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -253,39 +279,84 @@ private void _importNotes() {\n                     }\n                 }\n                 i++;\n+\n+                // add to col partially, so as to avoid OOM\n+                if (add.size() >= thresExecAdd) {\n+                    totalAddCount  += add.size();\n+                    addNotes(add);\n+                    add.clear();\n+                    Timber.d(\"add notes: %d\", totalAddCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (update.size() >= thresExecUpdate){\n+                    totalUpdateCount  += update.size();\n+                    updateNotes(update);\n+                    update.clear();\n+                    Timber.d(\"update notes: %d\", totalUpdateCount);\n+                }\n+                // add to col partially, so as to avoid OOM\n+                if (dirty.size() >= thresExecDirty) {\n+                    totalDirtyCount  += dirty.size();\n+                   long[] das = Utils.arrayList2array(dirty);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTg2OQ==", "bodyText": "Comment wasn't clear for me (try was ambiguous), could we extract this to a Utils class of some sort, as it'll be needed everywhere.\nAlternately, could make a runInTrnasaction method now we have lambdas. But that might be gold-plating", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859869", "createdAt": "2020-06-14T19:22:08Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/Anki2Importer.java", "diffHunk": "@@ -147,13 +147,33 @@ private void _import() {\n             publishProgress(100, 100, 50);\n             mDst.getDb().getDatabase().setTransactionSuccessful();\n             mDst.getMedia().getDb().getDatabase().setTransactionSuccessful();\n+        } catch (Exception err) {\n+            Timber.e(err, \"_import() exception\");\n+            throw err;\n         } finally {\n-            mDst.getDb().getDatabase().endTransaction();\n-            mDst.getMedia().getDb().getDatabase().endTransaction();\n+            // These methods throw about invalid transaction even when you try!\n+            if (mDst.getDb().getDatabase().inTransaction()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwNzc4MA=="}, "originalCommit": {"oid": "51ff7c61445aeafe71e07e83654b01837a95359d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg1OTk3Ng==", "bodyText": "Much nicer, thanks", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439859976", "createdAt": "2020-06-14T19:23:54Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total uncompressed size will be: %d\", uncompressedSize);\n+                Timber.d(\"Total available size is:         %d\", availableSpace);\n+                if (uncompressedSize > availableSpace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTg2MDE1Nw==", "bodyText": "There may be bugs in determineBytesAvailable: #6442 (could also be my issue).\nIf so, do we need a way to override?", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#discussion_r439860157", "createdAt": "2020-06-14T19:26:10Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/importer/AnkiPackageImporter.java", "diffHunk": "@@ -64,6 +65,18 @@ public void run() throws ImportExportException {\n                 if (mZip.getEntry(colname) == null) {\n                     colname = CollectionHelper.COLLECTION_FILENAME;\n                 }\n+\n+                // Make sure we have sufficient free space\n+                long uncompressedSize = Utils.calculateUncompressedSize(mZip);\n+                long availableSpace = Utils.determineBytesAvailable(mCol.getPath());\n+                Timber.d(\"Total uncompressed size will be: %d\", uncompressedSize);\n+                Timber.d(\"Total available size is:         %d\", availableSpace);\n+                if (uncompressedSize > availableSpace) {\n+                    Timber.e(\"Not enough space to unzip, need %d, available %d\", uncompressedSize, availableSpace);\n+                    mLog.add(getRes().getString(R.string.import_log_insufficient_space, uncompressedSize, availableSpace));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTkxMjQy", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#pullrequestreview-430591242", "createdAt": "2020-06-15T12:23:25Z", "commit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNzQwMzUy", "url": "https://github.com/ankidroid/Anki-Android/pull/6457#pullrequestreview-430740352", "createdAt": "2020-06-15T15:12:16Z", "commit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be661ef74d4dacaac62591fa461ec86766867d0e", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/be661ef74d4dacaac62591fa461ec86766867d0e", "committedDate": "2020-06-15T16:02:54Z", "message": "NF: whitespace and timber log format in importers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e984f80b7f21dbf704e0412154025e00ad3f154", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0e984f80b7f21dbf704e0412154025e00ad3f154", "committedDate": "2020-06-15T16:02:57Z", "message": "External txn mgmt in importers new partial commits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61223b2d9b9da6058fca5a642cb72230bdf043bb", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/61223b2d9b9da6058fca5a642cb72230bdf043bb", "committedDate": "2020-06-14T17:12:03Z", "message": "External txn mgmt in importers new partial commits"}, "afterCommit": {"oid": "0e984f80b7f21dbf704e0412154025e00ad3f154", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0e984f80b7f21dbf704e0412154025e00ad3f154", "committedDate": "2020-06-15T16:02:57Z", "message": "External txn mgmt in importers new partial commits"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3206, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}