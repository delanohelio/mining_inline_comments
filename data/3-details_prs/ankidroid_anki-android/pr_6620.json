{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MzQyNTMx", "number": 6620, "title": "Synchronize deck name", "bodyText": "Pull Request template\nPurpose / Description\nUses normalize name for nameMap and ensure it is impossible not to do so\nFixes\nHopefully\n\nFixes #6612\nFixes #6613\n\nApproach\nHidding the hash map in a data structure, so that it can be accessed only in the expected ways.\nHow Has This Been Tested?\nRunning on my phone\nI can't test that #6612 and #6613 won't occur again, as I don't know how it did occur, even if I would expect that in this case, there is a deck \"A\" with a child \"a::B\" and the change in case (or any other normalization process) may have created the problem in the first place", "createdAt": "2020-07-05T00:37:28Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6620", "merged": true, "mergeCommit": {"oid": "cc2620de182d5c3c96b6ece76ce04a65d20364d6"}, "closed": true, "closedAt": "2020-07-05T13:52:50Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxx8ydgFqTQ0MjYzODQ2Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcx9AHBAFqTQ0MjY3OTA3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjM4NDY2", "url": "https://github.com/ankidroid/Anki-Android/pull/6620#pullrequestreview-442638466", "createdAt": "2020-07-05T00:56:55Z", "commit": {"oid": "107920014b450b75a27010b52378e39001de350d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMDo1Njo1NlrOGs-vew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQwMDo1Njo1NlrOGs-vew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTgxODQ5MQ==", "bodyText": "Nit: better as a static factory method rather than a constructor.\nTry to avoid work in a constructor if at all possible.", "url": "https://github.com/ankidroid/Anki-Android/pull/6620#discussion_r449818491", "createdAt": "2020-07-05T00:56:56Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -139,9 +139,65 @@\n     private Collection mCol;\n     private HashMap<Long, JSONObject> mDecks;\n     private HashMap<Long, JSONObject> mDconf;\n-    private HashMap<String, JSONObject> mNameMap;\n+    // Never access mNameMap directly. Uses byName\n+    private NameMap mNameMap;\n     private boolean mChanged;\n \n+    private class NameMap {\n+        private final HashMap<String, JSONObject> mNameMap;\n+\n+        public NameMap(java.util.Collection<JSONObject> decks) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "107920014b450b75a27010b52378e39001de350d"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "107920014b450b75a27010b52378e39001de350d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/107920014b450b75a27010b52378e39001de350d", "committedDate": "2020-07-05T00:35:22Z", "message": "NF: NameMap as a separate class\n\nThis should ensure nobody won't make the same error as last commit"}, "afterCommit": {"oid": "052a9ecb34cae7269aa77918ae5050aa2b49c792", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/052a9ecb34cae7269aa77918ae5050aa2b49c792", "committedDate": "2020-07-05T03:20:20Z", "message": "NF: NameMap as a separate class\n\nThis should ensure nobody won't make the same error as last commit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjY0MjM5", "url": "https://github.com/ankidroid/Anki-Android/pull/6620#pullrequestreview-442664239", "createdAt": "2020-07-05T10:13:29Z", "commit": {"oid": "052a9ecb34cae7269aa77918ae5050aa2b49c792"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxMDoxMzoyOVrOGtBQlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxMDoxNDozMVrOGtBQ1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1OTczMw==", "bodyText": "Nit: It'd be useful to either comment that the casing changes here (the deck in TEST_DECKS has the same casing as this string), or pick a deck name where it's immediately obvious that the casing is changed", "url": "https://github.com/ankidroid/Anki-Android/pull/6620#discussion_r449859733", "createdAt": "2020-07-05T10:13:29Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/libanki/DecksTest.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.ichi2.libanki;\n+\n+import com.ichi2.anki.RobolectricTest;\n+import com.ichi2.libanki.sched.AbstractSched;\n+import com.ichi2.utils.Assert;\n+import com.ichi2.utils.JSONObject;\n+\n+import org.apache.http.util.Asserts;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.List;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class DecksTest extends RobolectricTest {\n+    public static final String[] TEST_DECKS = {\n+            \"scxipjiyozczaaczoawo\",\n+            \"cmxieunwoogyxsctnJmv::abcdefgh::ZYXW\",\n+            \"cmxieunwoogyxsctNjmv::INSBGDS\",\n+    };\n+\n+    @Test\n+    public void ensureDeckList() {\n+        Decks decks = getCol().getDecks();\n+        //decks.load(\"{\\\"2\\\":{\\\"name\\\":\\\"A\\\", \\\"id\\\":2}, \\\"3\\\":{\\\"name\\\":\\\"a::B\\\", \\\"id\\\":2}}\", \"{}\");\n+        for (String deckName: TEST_DECKS) {\n+            addDeck(deckName);\n+        }\n+        JSONObject brokenDeck = decks.byName(\"cmxieunwoogyxsctNjmv::INSBGDS\");\n+        Asserts.notNull(brokenDeck,\"We should get deck with given name\");\n+        brokenDeck.put(\"name\", \"cmxieunwoogyxSctNjmv::INSBGDS\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "052a9ecb34cae7269aa77918ae5050aa2b49c792"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTg1OTc5OQ==", "bodyText": "Could you comment that this is used by external consumers", "url": "https://github.com/ankidroid/Anki-Android/pull/6620#discussion_r449859799", "createdAt": "2020-07-05T10:14:31Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/libanki/DecksTest.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package com.ichi2.libanki;\n+\n+import com.ichi2.anki.RobolectricTest;\n+import com.ichi2.libanki.sched.AbstractSched;\n+import com.ichi2.utils.Assert;\n+import com.ichi2.utils.JSONObject;\n+\n+import org.apache.http.util.Asserts;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.util.List;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class DecksTest extends RobolectricTest {\n+    public static final String[] TEST_DECKS = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "052a9ecb34cae7269aa77918ae5050aa2b49c792"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a4fc22d4180fcb52dae7a209e2ca1febeb97e15", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1a4fc22d4180fcb52dae7a209e2ca1febeb97e15", "committedDate": "2020-07-05T12:30:20Z", "message": "Broken test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c028064ef409d5c81c114f97fa431454ace0f411", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c028064ef409d5c81c114f97fa431454ace0f411", "committedDate": "2020-07-05T12:30:20Z", "message": "Probably correct #6613\n\nmNameMap should never be accessed directly. That was a real mistake of\nmine. We first need to normalize name. This is particularly important\nbecause \"a\" may well be the parent of \"A::b\"."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "052a9ecb34cae7269aa77918ae5050aa2b49c792", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/052a9ecb34cae7269aa77918ae5050aa2b49c792", "committedDate": "2020-07-05T03:20:20Z", "message": "NF: NameMap as a separate class\n\nThis should ensure nobody won't make the same error as last commit"}, "afterCommit": {"oid": "157c22154c3d19a7dd59499a7cd2a062700fcadf", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/157c22154c3d19a7dd59499a7cd2a062700fcadf", "committedDate": "2020-07-05T12:49:57Z", "message": "NF: NameMap as a separate class\n\nThis should ensure nobody won't make the same error as last commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "351cf9f3786556c08425eb3a4302055a7914468a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/351cf9f3786556c08425eb3a4302055a7914468a", "committedDate": "2020-07-05T12:58:15Z", "message": "NF: NameMap as a separate class\n\nThis should ensure nobody won't make the same error as last commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "157c22154c3d19a7dd59499a7cd2a062700fcadf", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/157c22154c3d19a7dd59499a7cd2a062700fcadf", "committedDate": "2020-07-05T12:49:57Z", "message": "NF: NameMap as a separate class\n\nThis should ensure nobody won't make the same error as last commit"}, "afterCommit": {"oid": "351cf9f3786556c08425eb3a4302055a7914468a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/351cf9f3786556c08425eb3a4302055a7914468a", "committedDate": "2020-07-05T12:58:15Z", "message": "NF: NameMap as a separate class\n\nThis should ensure nobody won't make the same error as last commit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjc1MjQ2", "url": "https://github.com/ankidroid/Anki-Android/pull/6620#pullrequestreview-442675246", "createdAt": "2020-07-05T13:00:50Z", "commit": {"oid": "351cf9f3786556c08425eb3a4302055a7914468a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjc5MDcy", "url": "https://github.com/ankidroid/Anki-Android/pull/6620#pullrequestreview-442679072", "createdAt": "2020-07-05T13:52:42Z", "commit": {"oid": "351cf9f3786556c08425eb3a4302055a7914468a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3078, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}