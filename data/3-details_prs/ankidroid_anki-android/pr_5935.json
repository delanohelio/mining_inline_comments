{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5MTc4Mjk3", "number": 5935, "title": "Cache nameMap (performance)", "bodyText": "Pull Request template\nPurpose / Description\nImproving ankidroid speed by doing small efficient changes.\nApproach\nHow does this change address the problem?\nHow Has This Been Tested?\nPlease describe the tests that you ran to verify your changes. Provide instructions so we can reproduce. Please also list any relevant details for your test configuration (SDK version(s), emulator or physical, etc)\nLearning (optional, can help others)\nAs discussed in #5928 (and it would make\nthis other PR useless)\nAccessing a deck by is name is done quite often. Being able to do it\nin constant time consists in part of seconds win in a lot of actions,\nallowing ankidroid to be faster.\nIn this particular case, a little difference from upstream anki makes\nsens. Anki need to deals with a lot of add-ons, and add-ons may do\nwhathever they want to add-on. As we don't have this problem, we can\ncache some computation.\nLinks to blog posts, patterns, libraries or addons used to solve this problem\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-04-05T17:27:05Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5935", "merged": true, "mergeCommit": {"oid": "e58bf1d3867f9b391c095775703c1ec05a1bf707"}, "closed": true, "closedAt": "2020-06-28T16:58:14Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUuUgeABqjMyMDI4MTI4NTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvvdDuAFqTQzODc5NjU5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b1236d8ed5a7a8ee0a60518e149d705b823d83b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6b1236d8ed5a7a8ee0a60518e149d705b823d83b", "committedDate": "2020-04-05T18:08:01Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}, "afterCommit": {"oid": "1dc0ce28c64cab646f6caabc53f733d66d319e4b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1dc0ce28c64cab646f6caabc53f733d66d319e4b", "committedDate": "2020-04-05T18:22:23Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1dc0ce28c64cab646f6caabc53f733d66d319e4b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1dc0ce28c64cab646f6caabc53f733d66d319e4b", "committedDate": "2020-04-05T18:22:23Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}, "afterCommit": {"oid": "4674f1d6534d8b106e303c318bdecda72e6fd556", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4674f1d6534d8b106e303c318bdecda72e6fd556", "committedDate": "2020-04-05T19:16:32Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4674f1d6534d8b106e303c318bdecda72e6fd556", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4674f1d6534d8b106e303c318bdecda72e6fd556", "committedDate": "2020-04-05T19:16:32Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}, "afterCommit": {"oid": "90a3117641057e7d5579ec85121552cd9ef2fda8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/90a3117641057e7d5579ec85121552cd9ef2fda8", "committedDate": "2020-04-05T20:53:03Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90a3117641057e7d5579ec85121552cd9ef2fda8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/90a3117641057e7d5579ec85121552cd9ef2fda8", "committedDate": "2020-04-05T20:53:03Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}, "afterCommit": {"oid": "1e1e88176915b7025a977c61abbd867034abfb49", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1e1e88176915b7025a977c61abbd867034abfb49", "committedDate": "2020-04-05T21:03:44Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e1e88176915b7025a977c61abbd867034abfb49", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1e1e88176915b7025a977c61abbd867034abfb49", "committedDate": "2020-04-05T21:03:44Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}, "afterCommit": {"oid": "28205e06c17d6c21e2f4f070a594a5a32c71abcb", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/28205e06c17d6c21e2f4f070a594a5a32c71abcb", "committedDate": "2020-04-07T00:03:00Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28205e06c17d6c21e2f4f070a594a5a32c71abcb", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/28205e06c17d6c21e2f4f070a594a5a32c71abcb", "committedDate": "2020-04-07T00:03:00Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}, "afterCommit": {"oid": "4ff46c028c59e6cdf9b5dded443f40db3ed482d2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4ff46c028c59e6cdf9b5dded443f40db3ed482d2", "committedDate": "2020-04-09T12:38:36Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ff46c028c59e6cdf9b5dded443f40db3ed482d2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4ff46c028c59e6cdf9b5dded443f40db3ed482d2", "committedDate": "2020-04-09T12:38:36Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}, "afterCommit": {"oid": "d15048bcf2e040fbf04fa2a579a8a8556a5b69df", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d15048bcf2e040fbf04fa2a579a8a8556a5b69df", "committedDate": "2020-04-11T18:13:41Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a7d2e55f3a8ee45cdd1525e811eecc73ceaf7d2", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9a7d2e55f3a8ee45cdd1525e811eecc73ceaf7d2", "committedDate": "2020-04-11T18:22:55Z", "message": "remove useless import"}, "afterCommit": {"oid": "c838928297d32dacccc918e8f16acd1962cc02c7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c838928297d32dacccc918e8f16acd1962cc02c7", "committedDate": "2020-04-13T14:22:38Z", "message": "remove useless import"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c838928297d32dacccc918e8f16acd1962cc02c7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c838928297d32dacccc918e8f16acd1962cc02c7", "committedDate": "2020-04-13T14:22:38Z", "message": "remove useless import"}, "afterCommit": {"oid": "940df5aa513638a61667b3b77e7b43a096bba8af", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/940df5aa513638a61667b3b77e7b43a096bba8af", "committedDate": "2020-06-01T14:23:10Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1OTc5Nzkw", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#pullrequestreview-435979790", "createdAt": "2020-06-23T17:01:57Z", "commit": {"oid": "940df5aa513638a61667b3b77e7b43a096bba8af"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzowMTo1N1rOGnycSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzowNToxNFrOGnyj1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3NDA4OA==", "bodyText": "Should follow convention for member variables\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private HashMap<String, JSONObject> nameMap;\n          \n          \n            \n                private HashMap<String, JSONObject> mNameMap;", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#discussion_r444374088", "createdAt": "2020-06-23T17:01:57Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -138,6 +139,7 @@\n     private Collection mCol;\n     private HashMap<Long, JSONObject> mDecks;\n     private HashMap<Long, JSONObject> mDconf;\n+    private HashMap<String, JSONObject> nameMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "940df5aa513638a61667b3b77e7b43a096bba8af"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM3NjAyMg==", "bodyText": "I really don't like asserts unless absolutely necessary as they are basically saying \"crash right here\"\nIs there any way to recover from this error? If not - if the data is too corrupt at this point and there is no way to reason about app state, okay\nBut if there is a return value we could send here I'd rather do that.\nI fear this might be a \"crash here\" case, but every single time I see an Assert I will force this inspection, as putting \"crash right here\" code in the app should never be done with out checking a few times.", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#discussion_r444376022", "createdAt": "2020-06-23T17:05:14Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -430,26 +434,69 @@ public JSONObject get(long did, boolean _default) {\n      * Get deck with NAME, ignoring case.\n      */\n     @CheckResult\n-    public @Nullable JSONObject byName(String name) {\n-        for (JSONObject m : mDecks.values()) {\n-            if (equalName(m.getString(\"name\"),name)) {\n-                return m;\n-            }\n+    public JSONObject byName(String name) {\n+        String normalized = normalizeName(name);\n+        JSONObject deck = nameMap.get(normalized);\n+        if (deck == null) {\n+            return null;\n         }\n-        return null;\n+        String deckName = deck.getString(\"name\");\n+        Assert.that(equalName(name, deckName),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "940df5aa513638a61667b3b77e7b43a096bba8af"}, "originalPosition": 82}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "940df5aa513638a61667b3b77e7b43a096bba8af", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/940df5aa513638a61667b3b77e7b43a096bba8af", "committedDate": "2020-06-01T14:23:10Z", "message": "rename _nameMap to nameMap\n\nThe collision disappeared in last commit"}, "afterCommit": {"oid": "500bf6d03146a9edb7c5cac5e293b67a48982380", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/500bf6d03146a9edb7c5cac5e293b67a48982380", "committedDate": "2020-06-23T17:35:52Z", "message": "add report if byName gets a wrong result"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MDI4Mjky", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#pullrequestreview-436028292", "createdAt": "2020-06-23T18:01:22Z", "commit": {"oid": "500bf6d03146a9edb7c5cac5e293b67a48982380"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "500bf6d03146a9edb7c5cac5e293b67a48982380", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/500bf6d03146a9edb7c5cac5e293b67a48982380", "committedDate": "2020-06-23T17:35:52Z", "message": "add report if byName gets a wrong result"}, "afterCommit": {"oid": "d61b03115592c34125f1e2115b820f464dc51412", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d61b03115592c34125f1e2115b820f464dc51412", "committedDate": "2020-06-23T19:37:38Z", "message": "NF: add report if byName gets a wrong result"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d61b03115592c34125f1e2115b820f464dc51412", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d61b03115592c34125f1e2115b820f464dc51412", "committedDate": "2020-06-23T19:37:38Z", "message": "NF: add report if byName gets a wrong result"}, "afterCommit": {"oid": "50f9995078a56d7d0fa429aaca35b105e1a68029", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/50f9995078a56d7d0fa429aaca35b105e1a68029", "committedDate": "2020-06-23T19:42:00Z", "message": "NF: add report if byName gets a wrong result"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjIxNDc2", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#pullrequestreview-436221476", "createdAt": "2020-06-23T23:13:49Z", "commit": {"oid": "50f9995078a56d7d0fa429aaca35b105e1a68029"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "154a3e102aea9360d35435ac3ad35978ddba1280", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/154a3e102aea9360d35435ac3ad35978ddba1280", "committedDate": "2020-06-23T23:58:46Z", "message": "NF: Cache nameMap\n\nIt'll be used in next commits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e91d756636bd435351e51afa7397af3a55926bc7", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e91d756636bd435351e51afa7397af3a55926bc7", "committedDate": "2020-06-23T23:58:47Z", "message": "NF: byName uses nameMap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f76ef48de27aad51c505ff8138388e75ca3a19f", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5f76ef48de27aad51c505ff8138388e75ca3a19f", "committedDate": "2020-06-23T23:58:47Z", "message": "NF: childMap uses precomputed namemap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c047fb4d09c8ecf748012e62d37b423b39df0d8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7c047fb4d09c8ecf748012e62d37b423b39df0d8", "committedDate": "2020-06-23T23:58:47Z", "message": "NF: Parents no longer takes a name map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a0c1e3a51a2b0db1334a8d0f057c195ea94153f", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0a0c1e3a51a2b0db1334a8d0f057c195ea94153f", "committedDate": "2020-06-23T23:58:47Z", "message": "NF: remove method nameMap()\n\nIt became useless since nameMap is used everywhere"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f54ca6eec346d9771c3d06294520e5e62b37757d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f54ca6eec346d9771c3d06294520e5e62b37757d", "committedDate": "2020-06-23T23:58:47Z", "message": "NF: add report if byName gets a wrong result"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50f9995078a56d7d0fa429aaca35b105e1a68029", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/50f9995078a56d7d0fa429aaca35b105e1a68029", "committedDate": "2020-06-23T19:42:00Z", "message": "NF: add report if byName gets a wrong result"}, "afterCommit": {"oid": "f54ca6eec346d9771c3d06294520e5e62b37757d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f54ca6eec346d9771c3d06294520e5e62b37757d", "committedDate": "2020-06-23T23:58:47Z", "message": "NF: add report if byName gets a wrong result"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4Nzk2NTkw", "url": "https://github.com/ankidroid/Anki-Android/pull/5935#pullrequestreview-438796590", "createdAt": "2020-06-28T16:57:48Z", "commit": {"oid": "f54ca6eec346d9771c3d06294520e5e62b37757d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3591, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}