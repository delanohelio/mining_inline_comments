{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNzUxNjkx", "number": 7291, "title": "[BugFix] Card Browser Preview works after sorting", "bodyText": "Purpose / Description\nDue to the addition of CardCache, the position variable was out-of-sync with reality after performing Collection.reverse()\nFixes\nFixes #7286\nApproach\n\nExtract to a structure where this can no longer happen\nFix the numbers after a reverse()\n\nHow Has This Been Tested?\nUnit & Integration tested\nTested on my phone briefly\nLearning\nWe still need more tests\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-09-27T17:31:07Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7291", "merged": true, "mergeCommit": {"oid": "fe6a93e79014acd6ae7ae04ca34447f4cb3bc0a3"}, "closed": true, "closedAt": "2020-09-28T16:24:53Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNCW0TgH2gAyNDkzNzUxNjkxOmZkN2Y5MGQ1ZDhiZThhYTQ5YzkwODAyN2M0MDUyZmUzZGJiYTgyNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNDvaOgBqjM4MTE5MTMzNTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd7f90d5d8be8aa49c908027c4052fe3dbba8262", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fd7f90d5d8be8aa49c908027c4052fe3dbba8262", "committedDate": "2020-09-27T17:22:59Z", "message": "NF: Extract class CardCollection\n\nThere's an invariant to ensure that positions are updated with the collection\n\nThis is currently broken due to reverse(), but this keeps a refactor out\nof the code to fix the bug\n\nThe class also ensures that this will not occur again\n\nRelated: 7286"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDk3NzEy", "url": "https://github.com/ankidroid/Anki-Android/pull/7291#pullrequestreview-497097712", "createdAt": "2020-09-27T17:38:11Z", "commit": {"oid": "41a0c8d7b1c78f028349d3b46aa190d42188f108"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDk4OTQ2", "url": "https://github.com/ankidroid/Anki-Android/pull/7291#pullrequestreview-497098946", "createdAt": "2020-09-27T17:59:25Z", "commit": {"oid": "2272fa552026eb74e0e00fe36ae1b8b777fc78c4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNzo1OToyNVrOHYo66Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxODowMDo0NVrOHYo7bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5ODMxMw==", "bodyText": "\"sort field\" usually means \"the field from the note type that is used to sort cards and that can be displayed directly in browser\"\nSo I believe that \"the sort value in the card browser\" would be less confusing", "url": "https://github.com/ankidroid/Anki-Android/pull/7291#discussion_r495598313", "createdAt": "2020-09-27T17:59:25Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -227,35 +227,38 @@\n     private BroadcastReceiver mUnmountReceiver = null;\n \n     private final MaterialDialog.ListCallbackSingleChoice mOrderDialogListener =\n-            new MaterialDialog.ListCallbackSingleChoice() {\n-        @Override\n-        public boolean onSelection(MaterialDialog materialDialog, View view, int which,\n-                CharSequence charSequence) {\n-            if (which != mOrder) {\n-                mOrder = which;\n-                mOrderAsc = false;\n-                if (mOrder == 0) {\n-                    getCol().getConf().put(\"sortType\", fSortTypes[1]);\n-                    AnkiDroidApp.getSharedPrefs(getBaseContext()).edit()\n-                            .putBoolean(\"cardBrowserNoSorting\", true)\n-                            .commit();\n-                } else {\n-                    getCol().getConf().put(\"sortType\", fSortTypes[mOrder]);\n-                    AnkiDroidApp.getSharedPrefs(getBaseContext()).edit()\n-                            .putBoolean(\"cardBrowserNoSorting\", false)\n-                            .commit();\n-                }\n-                getCol().getConf().put(\"sortBackwards\", mOrderAsc);\n-                searchCards();\n-            } else if (which != CARD_ORDER_NONE) {\n-                mOrderAsc = !mOrderAsc;\n-                getCol().getConf().put(\"sortBackwards\", mOrderAsc);\n-                mCards.reverse();\n-                updateList();\n+            (materialDialog, view, which, charSequence) -> {\n+                changeCardOrder(which);\n+                return true;\n+            };\n+\n+\n+    protected void changeCardOrder(int which) {\n+        if (which != mOrder) {\n+            // if the sort field was changed, then perform a new search", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2272fa552026eb74e0e00fe36ae1b8b777fc78c4"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5ODQ0Nw==", "bodyText": "If it does not takes too much time, it would have been nice for review to have it in its own commit, since this part is trivial to check", "url": "https://github.com/ankidroid/Anki-Android/pull/7291#discussion_r495598447", "createdAt": "2020-09-27T18:00:45Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1092,18 +1095,7 @@ public boolean onOptionsItemSelected(MenuItem item) {\n                 return true;\n \n             case R.id.action_preview: {\n-                Intent previewer = new Intent(CardBrowser.this, Previewer.class);\n-                if (mInMultiSelectMode && checkedCardCount() > 1) {\n-                    // Multiple cards have been explicitly selected, so preview only those cards\n-                    previewer.putExtra(\"index\", 0);\n-                    previewer.putExtra(\"cardList\", getSelectedCardIds());\n-                } else {\n-                    // Preview all cards, starting from the one that is currently selected\n-                    int startIndex = mCheckedCards.isEmpty() ? 0 : mCheckedCards.iterator().next().getPosition();\n-                    previewer.putExtra(\"index\", startIndex);\n-                    previewer.putExtra(\"cardList\", getAllCardIds());\n-                }\n-                startActivityForResultWithoutAnimation(previewer, PREVIEW_CARDS);\n+                onPreview();\n                 return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2272fa552026eb74e0e00fe36ae1b8b777fc78c4"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce62e52c216d50501d6c041a33f913c76ac85a9b", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ce62e52c216d50501d6c041a33f913c76ac85a9b", "committedDate": "2020-09-27T18:59:16Z", "message": "NF: CardBrowser - Extract methods\n\nPrep for unit tests - requested to split this commit out in a review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f179c5ff6d65d9ab0f9ffe4ac17e70e8031fbe56", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f179c5ff6d65d9ab0f9ffe4ac17e70e8031fbe56", "committedDate": "2020-09-27T18:59:17Z", "message": "Regression Test: Browser - Preview after sorting\n\nCurrently fails due to 7286"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf0caa62107571c86f8891083890cc00f8ba4bf4", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/cf0caa62107571c86f8891083890cc00f8ba4bf4", "committedDate": "2020-09-27T18:59:17Z", "message": "[BugFix] Preview reverse cards correctly\n\nPreviously, we did not reverse the positions in the collection\n\nFixes 7286"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8b5b59a2b0a81b780bddf69a7f8784ffe2af6a1", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b8b5b59a2b0a81b780bddf69a7f8784ffe2af6a1", "committedDate": "2020-09-27T18:59:17Z", "message": "NF: CardBrowser - Improve comments\n\nRenderBrowserQA: CardCache/CardCollection will keep positions consistent\n\nImproved changeCardOrder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41a0c8d7b1c78f028349d3b46aa190d42188f108", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/41a0c8d7b1c78f028349d3b46aa190d42188f108", "committedDate": "2020-09-27T17:24:19Z", "message": "NF: RenderBrowserQA - Remove redundant comment\n\nWe're now using CardCache, which also should keep positions consistent"}, "afterCommit": {"oid": "b8b5b59a2b0a81b780bddf69a7f8784ffe2af6a1", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b8b5b59a2b0a81b780bddf69a7f8784ffe2af6a1", "committedDate": "2020-09-27T18:59:17Z", "message": "NF: CardBrowser - Improve comments\n\nRenderBrowserQA: CardCache/CardCollection will keep positions consistent\n\nImproved changeCardOrder"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3919, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}