{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMTI1OTY4", "number": 6571, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMjo0NzoxM1rOEJfbFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjo1NTowMFrOEJpSxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4Mzg3NDc5OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMjo0NzoxM1rOGqA4wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTowNzowOFrOGqVWeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzkwNQ==", "bodyText": "Can we exit early if this isn't true?", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446707905", "createdAt": "2020-06-28T22:47:13Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +31,78 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n     @Override\n     public void onReceive(Context context, Intent intent) {\n \n-        final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n+        final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);\n \n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n+        if (CollectionHelper.getInstance().getCol(context).getDecks().getConf(dConfId) == null) {\n             final AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n \n             final PendingIntent reminderIntent = PendingIntent.getBroadcast(\n                     context,\n-                    (int) deckId,\n-                    new Intent(context, ReminderService.class).putExtra(EXTRA_DECK_ID, deckId),\n+                    (int) dConfId,\n+                    new Intent(context, ReminderService.class).putExtra(EXTRA_DECK_OPTION_ID, dConfId),\n                     0\n             );\n \n             alarmManager.cancel(reminderIntent);\n         }\n \n-        Sched.DeckDueTreeNode deckDue = getDeckDue(context, deckId, true);\n+        List<Sched.DeckDueTreeNode> decksDue = getDeckOptionDue(context, dConfId, true);\n \n-        if (null == deckDue) {\n+        if (null == decksDue) {\n             return;\n         }\n \n-        final int total = deckDue.getRevCount() + deckDue.getLrnCount() + deckDue.getNewCount();\n+        for (Sched.DeckDueTreeNode deckDue: decksDue) {\n+            long deckId = deckDue.getDid();\n+            final int total = deckDue.getRevCount() + deckDue.getLrnCount() + deckDue.getNewCount();\n \n-        if (total <= 0) {\n-            return;\n-        }\n+            if (total <= 0) {\n+                continue;\n+            }\n \n-        final NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n-\n-        if (notificationManager.areNotificationsEnabled()) {\n-            final Notification notification =\n-                    new NotificationCompat.Builder(context,\n-                            NotificationChannels.getId(NotificationChannels.Channel.DECK_REMINDERS))\n-                    .setCategory(NotificationCompat.CATEGORY_REMINDER)\n-                    .setContentTitle(context.getString(R.string.reminder_title))\n-                    .setContentText(context.getResources().getQuantityString(\n-                            R.plurals.reminder_text,\n-                            total,\n-                            CollectionHelper.getInstance().getCol(context).getDecks().name(deckId),\n-                            total\n-                    ))\n-                    .setSmallIcon(R.drawable.ic_stat_notify)\n-                    .setColor(ContextCompat.getColor(context, R.color.material_light_blue_700))\n-                    .setContentIntent(PendingIntent.getActivity(\n-                            context,\n-                            (int) deckId,\n-                            getReviewDeckIntent(context, deckId),\n-                            PendingIntent.FLAG_UPDATE_CURRENT\n-                    ))\n-                    .setAutoCancel(true)\n-                    .build();\n-            notificationManager.notify((int) deckId, notification);\n+            final NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n+\n+            Timber.v(\"Notify: study deck %s\", deckDue.getFullDeckName());\n+            if (notificationManager.areNotificationsEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxMzkzMA==", "bodyText": "Yes. That was actually true even before this PR", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446713930", "createdAt": "2020-06-28T23:47:24Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +31,78 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n     @Override\n     public void onReceive(Context context, Intent intent) {\n \n-        final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n+        final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);\n \n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n+        if (CollectionHelper.getInstance().getCol(context).getDecks().getConf(dConfId) == null) {\n             final AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n \n             final PendingIntent reminderIntent = PendingIntent.getBroadcast(\n                     context,\n-                    (int) deckId,\n-                    new Intent(context, ReminderService.class).putExtra(EXTRA_DECK_ID, deckId),\n+                    (int) dConfId,\n+                    new Intent(context, ReminderService.class).putExtra(EXTRA_DECK_OPTION_ID, dConfId),\n                     0\n             );\n \n             alarmManager.cancel(reminderIntent);\n         }\n \n-        Sched.DeckDueTreeNode deckDue = getDeckDue(context, deckId, true);\n+        List<Sched.DeckDueTreeNode> decksDue = getDeckOptionDue(context, dConfId, true);\n \n-        if (null == deckDue) {\n+        if (null == decksDue) {\n             return;\n         }\n \n-        final int total = deckDue.getRevCount() + deckDue.getLrnCount() + deckDue.getNewCount();\n+        for (Sched.DeckDueTreeNode deckDue: decksDue) {\n+            long deckId = deckDue.getDid();\n+            final int total = deckDue.getRevCount() + deckDue.getLrnCount() + deckDue.getNewCount();\n \n-        if (total <= 0) {\n-            return;\n-        }\n+            if (total <= 0) {\n+                continue;\n+            }\n \n-        final NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n-\n-        if (notificationManager.areNotificationsEnabled()) {\n-            final Notification notification =\n-                    new NotificationCompat.Builder(context,\n-                            NotificationChannels.getId(NotificationChannels.Channel.DECK_REMINDERS))\n-                    .setCategory(NotificationCompat.CATEGORY_REMINDER)\n-                    .setContentTitle(context.getString(R.string.reminder_title))\n-                    .setContentText(context.getResources().getQuantityString(\n-                            R.plurals.reminder_text,\n-                            total,\n-                            CollectionHelper.getInstance().getCol(context).getDecks().name(deckId),\n-                            total\n-                    ))\n-                    .setSmallIcon(R.drawable.ic_stat_notify)\n-                    .setColor(ContextCompat.getColor(context, R.color.material_light_blue_700))\n-                    .setContentIntent(PendingIntent.getActivity(\n-                            context,\n-                            (int) deckId,\n-                            getReviewDeckIntent(context, deckId),\n-                            PendingIntent.FLAG_UPDATE_CURRENT\n-                    ))\n-                    .setAutoCancel(true)\n-                    .build();\n-            notificationManager.notify((int) deckId, notification);\n+            final NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n+\n+            Timber.v(\"Notify: study deck %s\", deckDue.getFullDeckName());\n+            if (notificationManager.areNotificationsEnabled()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzkwNQ=="}, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0MzE5NA==", "bodyText": "Done in another commit", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r447043194", "createdAt": "2020-06-29T15:07:08Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +31,78 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n     @Override\n     public void onReceive(Context context, Intent intent) {\n \n-        final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n+        final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);\n \n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n+        if (CollectionHelper.getInstance().getCol(context).getDecks().getConf(dConfId) == null) {\n             final AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);\n \n             final PendingIntent reminderIntent = PendingIntent.getBroadcast(\n                     context,\n-                    (int) deckId,\n-                    new Intent(context, ReminderService.class).putExtra(EXTRA_DECK_ID, deckId),\n+                    (int) dConfId,\n+                    new Intent(context, ReminderService.class).putExtra(EXTRA_DECK_OPTION_ID, dConfId),\n                     0\n             );\n \n             alarmManager.cancel(reminderIntent);\n         }\n \n-        Sched.DeckDueTreeNode deckDue = getDeckDue(context, deckId, true);\n+        List<Sched.DeckDueTreeNode> decksDue = getDeckOptionDue(context, dConfId, true);\n \n-        if (null == deckDue) {\n+        if (null == decksDue) {\n             return;\n         }\n \n-        final int total = deckDue.getRevCount() + deckDue.getLrnCount() + deckDue.getNewCount();\n+        for (Sched.DeckDueTreeNode deckDue: decksDue) {\n+            long deckId = deckDue.getDid();\n+            final int total = deckDue.getRevCount() + deckDue.getLrnCount() + deckDue.getNewCount();\n \n-        if (total <= 0) {\n-            return;\n-        }\n+            if (total <= 0) {\n+                continue;\n+            }\n \n-        final NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n-\n-        if (notificationManager.areNotificationsEnabled()) {\n-            final Notification notification =\n-                    new NotificationCompat.Builder(context,\n-                            NotificationChannels.getId(NotificationChannels.Channel.DECK_REMINDERS))\n-                    .setCategory(NotificationCompat.CATEGORY_REMINDER)\n-                    .setContentTitle(context.getString(R.string.reminder_title))\n-                    .setContentText(context.getResources().getQuantityString(\n-                            R.plurals.reminder_text,\n-                            total,\n-                            CollectionHelper.getInstance().getCol(context).getDecks().name(deckId),\n-                            total\n-                    ))\n-                    .setSmallIcon(R.drawable.ic_stat_notify)\n-                    .setColor(ContextCompat.getColor(context, R.color.material_light_blue_700))\n-                    .setContentIntent(PendingIntent.getActivity(\n-                            context,\n-                            (int) deckId,\n-                            getReviewDeckIntent(context, deckId),\n-                            PendingIntent.FLAG_UPDATE_CURRENT\n-                    ))\n-                    .setAutoCancel(true)\n-                    .build();\n-            notificationManager.notify((int) deckId, notification);\n+            final NotificationManagerCompat notificationManager = NotificationManagerCompat.from(context);\n+\n+            Timber.v(\"Notify: study deck %s\", deckDue.getFullDeckName());\n+            if (notificationManager.areNotificationsEnabled()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwNzkwNQ=="}, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4Mzg3NjQyOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMjo0OTo0OVrOGqA5iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMzo0OToxMFrOGqBRIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODEwNQ==", "bodyText": "rare race condition here: col.getDecks().get(node.getDid()) could be deleted, in this case, we check the default deck multiple times.", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446708105", "createdAt": "2020-06-28T22:49:49Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +114,23 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true\n-    private Sched.DeckDueTreeNode getDeckDue(Context context, long deckId, boolean recur) {\n+    private List<Sched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {\n \n+        Collection col = CollectionHelper.getInstance().getCol(context);\n         // Avoid crashes if the deck is deleted while we are working\n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n-            Timber.d(\"Deck %s deleted while ReminderService was working. Ignoring\", deckId);\n+        if (col.getDecks().getConf(dConfId) == null) {\n+            Timber.d(\"Deck option %s deleted while ReminderService was working. Ignoring\", dConfId);\n             return null;\n         }\n \n+        List<Sched.DeckDueTreeNode> decks = new ArrayList<>();\n         try {\n             for (Sched.DeckDueTreeNode node : CollectionHelper.getInstance().getCol(context).getSched().deckDueTree()) {\n-                if (node.getDid() == deckId) {\n-                    return node;\n+                if (col.getDecks().get(node.getDid()).optLong(\"conf\") == dConfId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNDE0Nw==", "bodyText": "Nice catch", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446714147", "createdAt": "2020-06-28T23:49:10Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +114,23 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true\n-    private Sched.DeckDueTreeNode getDeckDue(Context context, long deckId, boolean recur) {\n+    private List<Sched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {\n \n+        Collection col = CollectionHelper.getInstance().getCol(context);\n         // Avoid crashes if the deck is deleted while we are working\n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n-            Timber.d(\"Deck %s deleted while ReminderService was working. Ignoring\", deckId);\n+        if (col.getDecks().getConf(dConfId) == null) {\n+            Timber.d(\"Deck option %s deleted while ReminderService was working. Ignoring\", dConfId);\n             return null;\n         }\n \n+        List<Sched.DeckDueTreeNode> decks = new ArrayList<>();\n         try {\n             for (Sched.DeckDueTreeNode node : CollectionHelper.getInstance().getCol(context).getSched().deckDueTree()) {\n-                if (node.getDid() == deckId) {\n-                    return node;\n+                if (col.getDecks().get(node.getDid()).optLong(\"conf\") == dConfId) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODEwNQ=="}, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 135}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4Mzg3ODY2OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMjo1MjoyM1rOGqA6nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMzo1MTo1MFrOGqBSYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODM4MQ==", "bodyText": "@Nullable. But, should we return an empty list here?", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446708381", "createdAt": "2020-06-28T22:52:23Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +114,23 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true\n-    private Sched.DeckDueTreeNode getDeckDue(Context context, long deckId, boolean recur) {\n+    private List<Sched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNDQ2NQ==", "bodyText": "Before and after this PR it is null only if there is an exception after two tries, with one second between both try. I believe that it's nice that \"null\" and empty list have distinct meaning, i.e. error and no element founds.\nI see no reason to change the return value in case of error here, the current choice in master seems good to me", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446714465", "createdAt": "2020-06-28T23:51:50Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +114,23 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true\n-    private Sched.DeckDueTreeNode getDeckDue(Context context, long deckId, boolean recur) {\n+    private List<Sched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODM4MQ=="}, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4Mzg4MDMwOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQyMjo1NDo0MFrOGqA7cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzoxNTo1MFrOGqahQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODU5NQ==", "bodyText": "Can we return early if we don't have the intended extra.", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446708595", "createdAt": "2020-06-28T22:54:40Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +31,78 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n     @Override\n     public void onReceive(Context context, Intent intent) {\n \n-        final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n+        final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNDg2OA==", "bodyText": "We probably can, as long as we check that there is no ETRXA_dECK_ID either", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446714868", "createdAt": "2020-06-28T23:55:18Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +31,78 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n     @Override\n     public void onReceive(Context context, Intent intent) {\n \n-        final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n+        final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODU5NQ=="}, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcxNTEyMA==", "bodyText": "See Mike's comment below - maybe will happen on an upgrade path", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446715120", "createdAt": "2020-06-28T23:57:48Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +31,78 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n     @Override\n     public void onReceive(Context context, Intent intent) {\n \n-        final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n+        final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODU5NQ=="}, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0ODgyNw==", "bodyText": "Looking at this again, I presume we'd want to cancel the alarm if it's invalid", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446948827", "createdAt": "2020-06-29T12:55:36Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +31,78 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n     @Override\n     public void onReceive(Context context, Intent intent) {\n \n-        final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n+        final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODU5NQ=="}, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0MzAwOQ==", "bodyText": "I believe that is exactly what is happening below. If we can't find the deck option, the intent is created again and then the alarm manager get told that this intent is cancelled", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r447043009", "createdAt": "2020-06-29T15:06:53Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +31,78 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n     @Override\n     public void onReceive(Context context, Intent intent) {\n \n-        final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n+        final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODU5NQ=="}, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEyNzg3NA==", "bodyText": "I'm gold-plating here, but there's a slight concern that we don't cancel intents that we weren't expecting.\nLooks good to go then", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r447127874", "createdAt": "2020-06-29T17:15:50Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +31,78 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n     @Override\n     public void onReceive(Context context, Intent intent) {\n \n-        final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n+        final long dConfId = intent.getLongExtra(EXTRA_DECK_OPTION_ID, 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjcwODU5NQ=="}, "originalCommit": {"oid": "e6915cca49db1e5573bfe5dee6417df1c744ad4d"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NTQ3Mzk3OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjo1MDo0MlrOGqPZjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTowOToxN1rOGqVchQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0NTY3OA==", "bodyText": "Can be inverted to reduce nesting", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446945678", "createdAt": "2020-06-29T12:50:42Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +32,103 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n-    @Override\n-    public void onReceive(Context context, Intent intent) {\n \n+    /** Cancelling all deck reminder. We used to use them, now we have deck option reminders. */\n+    private void cancelDeckReminder(Context context, Intent intent) {\n+        // 0 Is not a valid deck id.\n         final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n-\n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n+        if (deckId != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fffaec6685c55b56100b766dbc0ee9d9921adfd5"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NDE2Mg==", "bodyText": "Done", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r447044162", "createdAt": "2020-06-29T15:08:25Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +32,103 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n-    @Override\n-    public void onReceive(Context context, Intent intent) {\n \n+    /** Cancelling all deck reminder. We used to use them, now we have deck option reminders. */\n+    private void cancelDeckReminder(Context context, Intent intent) {\n+        // 0 Is not a valid deck id.\n         final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n-\n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n+        if (deckId != 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0NTY3OA=="}, "originalCommit": {"oid": "fffaec6685c55b56100b766dbc0ee9d9921adfd5"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NDc0MQ==", "bodyText": "Done", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r447044741", "createdAt": "2020-06-29T15:09:17Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -31,67 +32,103 @@\n import com.ichi2.anki.IntentHandler;\n import com.ichi2.anki.NotificationChannels;\n import com.ichi2.anki.R;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.libanki.sched.AbstractSched;\n import com.ichi2.libanki.sched.Sched;\n+import com.ichi2.utils.JSONObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n \n public class ReminderService extends BroadcastReceiver {\n \n+    public static final String EXTRA_DECK_OPTION_ID = \"EXTRA_DECK_OPTION_ID\";\n     public static final String EXTRA_DECK_ID = \"EXTRA_DECK_ID\";\n \n-    @Override\n-    public void onReceive(Context context, Intent intent) {\n \n+    /** Cancelling all deck reminder. We used to use them, now we have deck option reminders. */\n+    private void cancelDeckReminder(Context context, Intent intent) {\n+        // 0 Is not a valid deck id.\n         final long deckId = intent.getLongExtra(EXTRA_DECK_ID, 0);\n-\n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n+        if (deckId != 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0NTY3OA=="}, "originalCommit": {"oid": "fffaec6685c55b56100b766dbc0ee9d9921adfd5"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NTQ4ODE4OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjo1NDowN1rOGqPiLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToxMDozMFrOGqVf8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0Nzg4NA==", "bodyText": "Could you add a comment to note that this also explicitly excludes dynamic decks", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446947884", "createdAt": "2020-06-29T12:54:07Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +140,25 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true\n-    private Sched.DeckDueTreeNode getDeckDue(Context context, long deckId, boolean recur) {\n+    @Nullable\n+    private List<Sched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {\n \n+        Collection col = CollectionHelper.getInstance().getCol(context);\n         // Avoid crashes if the deck is deleted while we are working\n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n-            Timber.d(\"Deck %s deleted while ReminderService was working. Ignoring\", deckId);\n+        if (col.getDecks().getConf(dConfId) == null) {\n+            Timber.d(\"Deck option %s deleted while ReminderService was working. Ignoring\", dConfId);\n             return null;\n         }\n \n+        List<Sched.DeckDueTreeNode> decks = new ArrayList<>();\n         try {\n             for (Sched.DeckDueTreeNode node : CollectionHelper.getInstance().getCol(context).getSched().deckDueTree()) {\n-                if (node.getDid() == deckId) {\n-                    return node;\n+                JSONObject deck = col.getDecks().get(node.getDid(), false);\n+                if (deck != null && deck.optLong(\"conf\") == dConfId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fffaec6685c55b56100b766dbc0ee9d9921adfd5"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NTYxNw==", "bodyText": "Done", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r447045617", "createdAt": "2020-06-29T15:10:30Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +140,25 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true\n-    private Sched.DeckDueTreeNode getDeckDue(Context context, long deckId, boolean recur) {\n+    @Nullable\n+    private List<Sched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {\n \n+        Collection col = CollectionHelper.getInstance().getCol(context);\n         // Avoid crashes if the deck is deleted while we are working\n-        if (CollectionHelper.getInstance().getCol(context).getDecks().get(deckId, false) == null) {\n-            Timber.d(\"Deck %s deleted while ReminderService was working. Ignoring\", deckId);\n+        if (col.getDecks().getConf(dConfId) == null) {\n+            Timber.d(\"Deck option %s deleted while ReminderService was working. Ignoring\", dConfId);\n             return null;\n         }\n \n+        List<Sched.DeckDueTreeNode> decks = new ArrayList<>();\n         try {\n             for (Sched.DeckDueTreeNode node : CollectionHelper.getInstance().getCol(context).getSched().deckDueTree()) {\n-                if (node.getDid() == deckId) {\n-                    return node;\n+                JSONObject deck = col.getDecks().get(node.getDid(), false);\n+                if (deck != null && deck.optLong(\"conf\") == dConfId) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0Nzg4NA=="}, "originalCommit": {"oid": "fffaec6685c55b56100b766dbc0ee9d9921adfd5"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NTQ5MDI2OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjo1NDozN1rOGqPjXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToxMDo0OVrOGqVgwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0ODE4OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Avoid crashes if the deck is deleted while we are working\n          \n          \n            \n                    // Avoid crashes if the options group is deleted while we are working", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446948189", "createdAt": "2020-06-29T12:54:37Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +140,25 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true\n-    private Sched.DeckDueTreeNode getDeckDue(Context context, long deckId, boolean recur) {\n+    @Nullable\n+    private List<Sched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {\n \n+        Collection col = CollectionHelper.getInstance().getCol(context);\n         // Avoid crashes if the deck is deleted while we are working", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fffaec6685c55b56100b766dbc0ee9d9921adfd5"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NTgyNQ==", "bodyText": "Nice catch. Really sorry, I have trouble remembering to check comments", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r447045825", "createdAt": "2020-06-29T15:10:49Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +140,25 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true\n-    private Sched.DeckDueTreeNode getDeckDue(Context context, long deckId, boolean recur) {\n+    @Nullable\n+    private List<Sched.DeckDueTreeNode> getDeckOptionDue(Context context, long dConfId, boolean recur) {\n \n+        Collection col = CollectionHelper.getInstance().getCol(context);\n         // Avoid crashes if the deck is deleted while we are working", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0ODE4OQ=="}, "originalCommit": {"oid": "fffaec6685c55b56100b766dbc0ee9d9921adfd5"}, "originalPosition": 153}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NTQ5MTkxOnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjo1NTowMFrOGqPkUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToxMToxMFrOGqVhqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0ODQzMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // getDeckDue information, will recur one time to workaround collection close if recur is true\n          \n          \n            \n                // getDeckOptionDue information, will recur one time to workaround collection close if recur is true", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r446948432", "createdAt": "2020-06-29T12:55:00Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +140,25 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fffaec6685c55b56100b766dbc0ee9d9921adfd5"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NjA1OA==", "bodyText": "Done. And one other comment corrected too", "url": "https://github.com/ankidroid/Anki-Android/pull/6571#discussion_r447046058", "createdAt": "2020-06-29T15:11:10Z", "author": {"login": "Arthur-Milchior"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/services/ReminderService.java", "diffHunk": "@@ -103,20 +140,25 @@ public static Intent getReviewDeckIntent(@NonNull Context context, long deckId)\n \n \n     // getDeckDue information, will recur one time to workaround collection close if recur is true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk0ODQzMg=="}, "originalCommit": {"oid": "fffaec6685c55b56100b766dbc0ee9d9921adfd5"}, "originalPosition": 147}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 41, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}