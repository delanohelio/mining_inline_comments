{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMDAxMTkz", "number": 6233, "title": "clean code of the undo button", "bodyText": "I found the code which deal with the \"undo\" button quite ugly. I hope you'll agree with me that this new version is more clear. I removed a lot of code duplication.\nEach commit are supposed to be easy to follow, it should be clear nothing is done, with one exception,  0c37624 is more complex, so the commit message explain why actually, this simplification is valid.\nMy ultimate goal is to deal with #6119 with a solution which allows the undo button to sometime change its color. I've learned my lesson, I first submit code simplification, and only when it has been accepted do I submit the code which does actual bug correction.\n(Normally, the bug will become really easy to correct now that the code is simpler)", "createdAt": "2020-05-20T20:26:15Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6233", "merged": true, "mergeCommit": {"oid": "052b1c1a12e688f336d73647b68e27194ef049d3"}, "closed": true, "closedAt": "2020-05-22T22:22:13Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjQq2bgH2gAyNDIxMDAxMTkzOjc5Yjc2YWIwNDU3ZDI3YTYyYTkzNTQyMTZjMjY1NmYyMzE1MmI3NTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcj3dPegFqTQxNzE0Mzk5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "79b76ab0457d27a62a9354216c2656f23152b751", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/79b76ab0457d27a62a9354216c2656f23152b751", "committedDate": "2020-05-20T22:18:43Z", "message": "NF: comments undo button"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0ceda6d6898d23cf3b26d19147245fcec4a6d7e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d0ceda6d6898d23cf3b26d19147245fcec4a6d7e", "committedDate": "2020-05-20T20:21:00Z", "message": "NF: factorize undoEnabled"}, "afterCommit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/14c9f6af08f3c6fc9b814c5be8636613b5a21496", "committedDate": "2020-05-20T22:22:41Z", "message": "Disable undo if slow block"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NjE1NjM0", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#pullrequestreview-416615634", "createdAt": "2020-05-22T02:50:01Z", "commit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Nzg2MjI1", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#pullrequestreview-416786225", "createdAt": "2020-05-22T09:48:53Z", "commit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwOTo0ODo1M1rOGZRUeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxMDoxNTo0NlrOGZSC5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTM1NA==", "bodyText": "Nit: could we use AOSP naming (m Prefix), and move these variables to the top of the class?\nAside: I don't like Hungarian Notation, but it's best to be consistent.", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429151354", "createdAt": "2020-05-22T09:48:53Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -431,21 +431,29 @@ public boolean onCreateOptionsMenu(Menu menu) {\n             }\n         }\n \n-        if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.undoSize() > 0) {\n-            // Whiteboard undo queue non-empty. Switch the undo icon to a whiteboard specific one.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n-        } else if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.isUndoModeActive()) {\n-            // Whiteboard undo queue empty, but user has added strokes to it for current card. Disable undo button.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(false).getIcon().setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);\n-        } else if (colIsOpen() && getCol().undoAvailable()) {\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_undo_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n+        // Undo button\n+        int undoIcon;\n+        boolean undoEnabled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTY4NA==", "bodyText": "nit/personal preference: isEmpty()", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429151684", "createdAt": "2020-05-22T09:49:36Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Whiteboard.java", "diffHunk": "@@ -402,5 +407,9 @@ public void apply() {\n             }\n             invalidate();\n         }\n+\n+        public boolean empty() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1NjQ2Mw==", "bodyText": "Nit: Do these need to be members, or can these be function scoped?", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429156463", "createdAt": "2020-05-22T09:59:58Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -431,21 +431,29 @@ public boolean onCreateOptionsMenu(Menu menu) {\n             }\n         }\n \n-        if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.undoSize() > 0) {\n-            // Whiteboard undo queue non-empty. Switch the undo icon to a whiteboard specific one.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n-        } else if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.isUndoModeActive()) {\n-            // Whiteboard undo queue empty, but user has added strokes to it for current card. Disable undo button.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(false).getIcon().setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);\n-        } else if (colIsOpen() && getCol().undoAvailable()) {\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_undo_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n+        // Undo button\n+        int undoIcon;\n+        boolean undoEnabled;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MTM1NA=="}, "originalCommit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1ODAwOQ==", "bodyText": "Could you change the title of the PR if there's a functional change mixed in", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429158009", "createdAt": "2020-05-22T10:03:27Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -431,21 +431,29 @@ public boolean onCreateOptionsMenu(Menu menu) {\n             }\n         }\n \n-        if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.undoSize() > 0) {\n-            // Whiteboard undo queue non-empty. Switch the undo icon to a whiteboard specific one.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n-        } else if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.isUndoModeActive()) {\n-            // Whiteboard undo queue empty, but user has added strokes to it for current card. Disable undo button.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(false).getIcon().setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);\n-        } else if (colIsOpen() && getCol().undoAvailable()) {\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_undo_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n+        // Undo button\n+        int undoIcon;\n+        boolean undoEnabled;\n+        if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.isUndoModeActive()) {\n+            // Whiteboard is here and strokes have been added at some point\n+            undoIcon = R.drawable.ic_eraser_variant_white_24dp;\n+            undoEnabled = !mWhiteboard.undoEmpty();\n         } else {\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_undo_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(false).getIcon().setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);\n+            // We can arrive here even if `mShowWhiteboard &&\n+            // mWhiteboard != null` if no stroke had ever been made\n+            undoIcon = R.drawable.ic_undo_white_24dp;\n+            undoEnabled = (colIsOpen() && getCol().undoAvailable());\n+        }\n+        int alpha;\n+        if (getControlBlocked() == ControlBlock.SLOW || !undoEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2Mjk5Mw==", "bodyText": "Nit: @DrawableRes if this needs to exist", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429162993", "createdAt": "2020-05-22T10:15:07Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Reviewer.java", "diffHunk": "@@ -431,21 +431,29 @@ public boolean onCreateOptionsMenu(Menu menu) {\n             }\n         }\n \n-        if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.undoSize() > 0) {\n-            // Whiteboard undo queue non-empty. Switch the undo icon to a whiteboard specific one.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n-        } else if (mShowWhiteboard && mWhiteboard != null && mWhiteboard.isUndoModeActive()) {\n-            // Whiteboard undo queue empty, but user has added strokes to it for current card. Disable undo button.\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_eraser_variant_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(false).getIcon().setAlpha(Themes.ALPHA_ICON_DISABLED_LIGHT);\n-        } else if (colIsOpen() && getCol().undoAvailable()) {\n-            menu.findItem(R.id.action_undo).setIcon(R.drawable.ic_undo_white_24dp);\n-            menu.findItem(R.id.action_undo).setEnabled(true).getIcon().setAlpha(Themes.ALPHA_ICON_ENABLED_LIGHT);\n+        // Undo button\n+        int undoIcon;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE2MzIzOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** @return Whethere there are strokes to undo */\n          \n          \n            \n                /** @return Whether there are strokes to undo */", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#discussion_r429163239", "createdAt": "2020-05-22T10:15:46Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/Whiteboard.java", "diffHunk": "@@ -218,6 +218,11 @@ public int undoSize() {\n         return mUndo.size();\n     }\n \n+    /** @return Whethere there are strokes to undo */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14c9f6af08f3c6fc9b814c5be8636613b5a21496", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/14c9f6af08f3c6fc9b814c5be8636613b5a21496", "committedDate": "2020-05-20T22:22:41Z", "message": "Disable undo if slow block"}, "afterCommit": {"oid": "500a421fd53021424407cb6fc519b47d2792521a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/500a421fd53021424407cb6fc519b47d2792521a", "committedDate": "2020-05-22T18:51:12Z", "message": "NF: factorize undoEnabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c432c854a77f728bdec36e23c06f69fc02cc276a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c432c854a77f728bdec36e23c06f69fc02cc276a", "committedDate": "2020-05-22T19:28:55Z", "message": "NF: factorize undoIcon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4df47eb1e552de1918c80651163b11efe103c10f", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4df47eb1e552de1918c80651163b11efe103c10f", "committedDate": "2020-05-22T19:28:55Z", "message": "NF: Factorize undoEnabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ce9d1bd6d39e24167496c73981e94b9fa614699", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2ce9d1bd6d39e24167496c73981e94b9fa614699", "committedDate": "2020-05-22T19:28:55Z", "message": "NF: Factorize undoIcon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f741531f20a1adc0989ebc078c502802e18b10df", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f741531f20a1adc0989ebc078c502802e18b10df", "committedDate": "2020-05-22T19:28:55Z", "message": "NF: Factorize undoEnabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "961752b37709879baf096e59839cc809791e80a6", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/961752b37709879baf096e59839cc809791e80a6", "committedDate": "2020-05-22T19:28:55Z", "message": "UndoStack.empty()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b805e62975071b7436f1eefc9ac17d771bc93eb", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5b805e62975071b7436f1eefc9ac17d771bc93eb", "committedDate": "2020-05-22T19:28:55Z", "message": "whiteboard: undoEmpty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "180011e78b8ea800f39377a521fbef622cea0c59", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/180011e78b8ea800f39377a521fbef622cea0c59", "committedDate": "2020-05-22T19:28:55Z", "message": "NF: Factorize whiteboard undos\n\nNote that !mWhiteboard.undoEmpty() implies\nmWhiteboard.isUndoModeActive(), so the code actions is not changed\n\nThere are four cases to consider:\n\n* Either there is no white board shown; in which case we go to the\n\"else\" part of the code, as before\n* Either there is a whiteboard, but no stroke has ever been made. In\n  the previous code, both condition fails. In the new code, the first\n  condition fails. In both case, we go to the else part of the code.\n* Either there is some actions to undo; in which case in the previous\n  code, the first condition is satisfied; in the new code the first\n  and the second conditions are satisfied; so in both case we execute:\n  ```\n            undoIcon = R.drawable.ic_eraser_variant_white_24dp;\n            undoEnabled = true;\n```\n* Either strokes have been made, and all have been undone. In this\ncase, in the previous code the first condition fail and the second\nsuceed. In the new code the first condition succeed and the second\nfail. In both case, we execute:\n```\n            undoIcon = R.drawable.ic_eraser_variant_white_24dp;\n            undoEnabled = false;\n```"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9072e73998718d4563bea3859fc52fe43d0befce", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/9072e73998718d4563bea3859fc52fe43d0befce", "committedDate": "2020-05-22T19:28:55Z", "message": "NF: factorize undoIcon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a12a4c8a5138295576be3a2849af1737ff0a2891", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a12a4c8a5138295576be3a2849af1737ff0a2891", "committedDate": "2020-05-22T19:28:55Z", "message": "NF: factorize undoEnabled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "500a421fd53021424407cb6fc519b47d2792521a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/500a421fd53021424407cb6fc519b47d2792521a", "committedDate": "2020-05-22T18:51:12Z", "message": "NF: factorize undoEnabled"}, "afterCommit": {"oid": "a12a4c8a5138295576be3a2849af1737ff0a2891", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a12a4c8a5138295576be3a2849af1737ff0a2891", "committedDate": "2020-05-22T19:28:55Z", "message": "NF: factorize undoEnabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTQzOTk3", "url": "https://github.com/ankidroid/Anki-Android/pull/6233#pullrequestreview-417143997", "createdAt": "2020-05-22T19:30:09Z", "commit": {"oid": "a12a4c8a5138295576be3a2849af1737ff0a2891"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3299, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}