{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNDQ2NTU2", "number": 6804, "title": "Indicator for unsynced local changes", "bodyText": "Purpose / Description\nUsers currently do not know if they have pending changes. We add a badge to fix this.\nAPI 23+ due to DrawableWrapper\nFixes\nFixes #3524\nApproach\n\n\nAdd a badge to the sync icon\n\nIf the user does not have an account (clicking sync takes them to logon).\nIf the changes require a full sync\nIf the changes require a regular sync\n\n\n\nOn each database query, check if the query starts with \"\n\n\nThis badge is not set when changing decks - as it would be more annoying than helpful (even though changing decks is internally a change when syncing).\nHow Has This Been Tested?\nOn my phone - Statistics and Browse do not trigger the icon, reviewing and adding notes do.\n\n\nLearning\n\nNot listing false starts  - see the issue\nAndroid Drawables need a .setBounds() call if they're not\nsetBounds() can be negative and still work\nUI is hard\nhttps://developer.android.com/reference/android/graphics/drawable/DrawableWrapper is API23+\nhttps://stackoverflow.com/questions/13057782/dynamic-drawable-icon-for-actionbar-menu-item-android-actionbarsherlock/13058113#13058113\n\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-08-03T23:32:37Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6804", "merged": true, "mergeCommit": {"oid": "4d4abb8e0736cf5f08ed38ee9278df677e24f057"}, "closed": true, "closedAt": "2020-08-04T03:52:51Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7ZUgFAH2gAyNDYyNDQ2NTU2OjY1NWY2YWY3NTdhMWQxNDZhMTk0M2FmOTkyZDNiOTQwN2Y2ZjRiYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7cDE7gFqTQ2MDQzMTA3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "655f6af757a1d146a1943af992d3b9407f6f4bb7", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/655f6af757a1d146a1943af992d3b9407f6f4bb7", "committedDate": "2020-08-03T21:57:38Z", "message": "Add badging functionality for App Bar MenuItems\n\nThis allows textual/colourful badges for items in the app bar\n\nTo be trialed with a badge for unsynced changes in 3524"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b614f3d608decadf7d1b80e2a77799943f531e4", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0b614f3d608decadf7d1b80e2a77799943f531e4", "committedDate": "2020-08-03T23:24:05Z", "message": "DeckPicker: no pending sync if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it"}, "afterCommit": {"oid": "4cb4bd7fbef9de0007095dbdbbffa15d830f7768", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4cb4bd7fbef9de0007095dbdbbffa15d830f7768", "committedDate": "2020-08-03T23:49:24Z", "message": "DeckPicker: no pending sync if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4cb4bd7fbef9de0007095dbdbbffa15d830f7768", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4cb4bd7fbef9de0007095dbdbbffa15d830f7768", "committedDate": "2020-08-03T23:49:24Z", "message": "DeckPicker: no pending sync if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it"}, "afterCommit": {"oid": "0f08b85a92105fe003cf604be90d20aa160c6588", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0f08b85a92105fe003cf604be90d20aa160c6588", "committedDate": "2020-08-03T23:50:45Z", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDA3MjE0", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#pullrequestreview-460407214", "createdAt": "2020-08-03T23:46:23Z", "commit": {"oid": "ec3bfde588c0531ad4f3978983005914873156f3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMzo0NjoyM1rOG7MNxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMzo0OTo1MlrOG7MRYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTMwMQ==", "bodyText": "doesn't seem \"web\"-y to me, seems more utils-y to me ? Shame all the boilerplate is necessary!", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464719301", "createdAt": "2020-08-03T23:46:23Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/web/DatabaseChangeDecorator.java", "diffHunk": "@@ -0,0 +1,281 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki.web;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec3bfde588c0531ad4f3978983005914873156f3"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxOTQ3MA==", "bodyText": "also maybe Utils-y ?", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464719470", "createdAt": "2020-08-03T23:47:04Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/SyncStatus.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d02246b56b13ce29f52eaf954617875cb6b9025f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyMDIyNw==", "bodyText": "I'd prefer if this sort of stuff was in the Compat infrastructure so we didn't spread the API-dependent conditionals across the codebase. Not sure how to do that well when there are related public methods like here though \ud83e\udd14 might be this is as good as it gets and we already have to do a full code scan for API codes anyway, so maybe just think about it for a timebox of no more than two minutes, and leave as is if it doesn't seem easy to fit into Compat/CompatV16/CompatV23", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464720227", "createdAt": "2020-08-03T23:49:52Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/ui/BadgeDrawableBuilder.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.ui;\n+\n+import android.content.res.Resources;\n+import android.graphics.drawable.Drawable;\n+import android.os.Build;\n+import android.view.MenuItem;\n+\n+import com.ichi2.anki.R;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.core.graphics.drawable.DrawableCompat;\n+import androidx.vectordrawable.graphics.drawable.VectorDrawableCompat;\n+import timber.log.Timber;\n+\n+public class BadgeDrawableBuilder {\n+    private final Resources mResources;\n+    private char mChar;\n+    private Integer mColor;\n+\n+\n+    public BadgeDrawableBuilder(@NonNull Resources resources) {\n+        mResources = resources;\n+    }\n+\n+\n+    public static void removeBadge(MenuItem menuItem) {\n+        if (android.os.Build.VERSION.SDK_INT < Build.VERSION_CODES.M) {\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "655f6af757a1d146a1943af992d3b9407f6f4bb7"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f08b85a92105fe003cf604be90d20aa160c6588", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/0f08b85a92105fe003cf604be90d20aa160c6588", "committedDate": "2020-08-03T23:50:45Z", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it"}, "afterCommit": {"oid": "167ac7859f106f405cb4d1fb8ac0fdfa24513297", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/167ac7859f106f405cb4d1fb8ac0fdfa24513297", "committedDate": "2020-08-04T00:15:50Z", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDE3MzEx", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#pullrequestreview-460417311", "createdAt": "2020-08-04T00:20:14Z", "commit": {"oid": "167ac7859f106f405cb4d1fb8ac0fdfa24513297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDoyMDoxNFrOG7MyVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDoyMDoxNFrOG7MyVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyODY2MA==", "bodyText": "Also flagging - static state is typically something to be avoided, but we'd need DI to solve it.", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464728660", "createdAt": "2020-08-04T00:20:14Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/utils/SyncStatus.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.utils;\n+\n+import android.content.SharedPreferences;\n+\n+import com.ichi2.anki.AnkiDroidApp;\n+import com.ichi2.libanki.Collection;\n+import com.ichi2.utils.FunctionalInterfaces.Supplier;\n+\n+import androidx.annotation.NonNull;\n+\n+public enum SyncStatus {\n+    INCONCLUSIVE,\n+    NO_ACCOUNT,\n+    NO_CHANGES,\n+    HAS_CHANGES,\n+    FULL_SYNC;\n+\n+    private static boolean sPauseCheckingDatabase = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167ac7859f106f405cb4d1fb8ac0fdfa24513297"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDE4MDMy", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#pullrequestreview-460418032", "createdAt": "2020-08-04T00:22:27Z", "commit": {"oid": "167ac7859f106f405cb4d1fb8ac0fdfa24513297"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDoyMjoyN1rOG7M01g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMDoyMjoyN1rOG7M01g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcyOTMwMg==", "bodyText": "@mikehardy Bikeshedding - but I'd actually like to move these new additions out of \"Network.xml\", and use a \"Sync\" string for the DeckPicker, would that be OK with you?\nIt's used in a few places (dialog, notification channel name and the action item) and I feel the action item would be best named \"Sync\"\nEDIT: Done, TBC if it's appropriate. Maybe they should be in \"core\"?", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#discussion_r464729302", "createdAt": "2020-08-04T00:22:27Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/res/values/04-network.xml", "diffHunk": "@@ -62,6 +62,8 @@\n     <string name=\"sync_uploading_message\">Uploading\u2026</string>\n     <string name=\"sync_downloading_message\">Downloading\u2026</string>\n     <string name=\"sync_title\">Synchronization</string>\n+    <string name=\"sync_title_full_sync\">Sync (full)</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167ac7859f106f405cb4d1fb8ac0fdfa24513297"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b72fc1a4c6894550c5214cc381655473a3ef4d4b", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/b72fc1a4c6894550c5214cc381655473a3ef4d4b", "committedDate": "2020-08-04T00:33:49Z", "message": "DeckPicker: Added badge for unsynced changes\n\nNote: This does not yet handle normal syncs - only no account or full syncs\n\nThis also changes the default menu name from \"Synchronization\" to \"Sync\"\n\nFixes 3524"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "319f95f1dbcedca8caaa0b9f516897aef9a0691f", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/319f95f1dbcedca8caaa0b9f516897aef9a0691f", "committedDate": "2020-08-04T00:33:52Z", "message": "Unsynced changes badge - handle regular changes\n\nWe implement this by listening to the database and triggering a flag if any\nmodifications are detected via SQL.\n\nThis is similar to DB.java, but works at a lower level, as we\noften call getDb().getDatabase()\n\n_recoverOrphans has an update which generally does nothing\nAs it's performed when the DeckPicker is loaded, we don't want this\nto set the preference\n\nFixes 3524"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "677831e94aa2cbd83284a305cf9cb88050e78f4f", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/677831e94aa2cbd83284a305cf9cb88050e78f4f", "committedDate": "2020-08-04T00:33:52Z", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "167ac7859f106f405cb4d1fb8ac0fdfa24513297", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/167ac7859f106f405cb4d1fb8ac0fdfa24513297", "committedDate": "2020-08-04T00:15:50Z", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it"}, "afterCommit": {"oid": "677831e94aa2cbd83284a305cf9cb88050e78f4f", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/677831e94aa2cbd83284a305cf9cb88050e78f4f", "committedDate": "2020-08-04T00:33:52Z", "message": "DeckPicker: no pending sync icon if deck changed\n\nThe UI is better if it only shows worthwhile changes\notherwise users will ignore it"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDMxMDc0", "url": "https://github.com/ankidroid/Anki-Android/pull/6804#pullrequestreview-460431074", "createdAt": "2020-08-04T01:08:19Z", "commit": {"oid": "677831e94aa2cbd83284a305cf9cb88050e78f4f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3093, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}