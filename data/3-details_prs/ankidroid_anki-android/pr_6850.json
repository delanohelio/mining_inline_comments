{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0OTI4NjE5", "number": 6850, "title": "Pre compute the next card's question", "bodyText": "This is a new version of #6026\nI believe the code is quite simpler. Instead of having a list of ID, I have a list of CardCache. That is, essentially, it's an ID, with potentially one more data, the card loaded and even the question preloaded. Thanks to this, I can preload the card content without needing to actually change anything about the content of the queue.\nI actually usually preload two cards, because I do not know in advance whether the next card will be a card in learning or not.\nThis also means that if for some unknown reason I got the next card wrong, the worst that will occur is that the next card will need to be loaded before being displayed instead of being preloaded.  I don't expect to get the next card wrong, but at this point I'm not as confident as I used to be. Thanks to David for noticing in the last version of the code that I was preloading the next card as if it were a card that we must review now, ignoring that in the future, a card in learning may become due.\nThe next task would be to figure out how to preload the medias, and maybe even create partially the HTML document to load MathJax in it if required.", "createdAt": "2020-08-08T02:03:39Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6850", "merged": true, "mergeCommit": {"oid": "16e468d2c99e82ef6720a8d8edb2ae3120c89178"}, "closed": true, "closedAt": "2020-08-15T23:05:58Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-U68MABqjM2NDk5MTg5NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_RfSIAFqTQ2ODAyMjE3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "248ab051069e0069f05c171a0be4585fc01eee17", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/248ab051069e0069f05c171a0be4585fc01eee17", "committedDate": "2020-08-08T01:58:04Z", "message": "NF: loadQA in card cache"}, "afterCommit": {"oid": "7f326eb2b0b5a4ad318ff45fa48607b15635ca38", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7f326eb2b0b5a4ad318ff45fa48607b15635ca38", "committedDate": "2020-08-13T00:31:45Z", "message": "NF: loadQA in card cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f326eb2b0b5a4ad318ff45fa48607b15635ca38", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7f326eb2b0b5a4ad318ff45fa48607b15635ca38", "committedDate": "2020-08-13T00:31:45Z", "message": "NF: loadQA in card cache"}, "afterCommit": {"oid": "15f2137c1d3e29362727a0641c952938733ae266", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/15f2137c1d3e29362727a0641c952938733ae266", "committedDate": "2020-08-13T00:36:12Z", "message": "NF: loadQA in card cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15f2137c1d3e29362727a0641c952938733ae266", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/15f2137c1d3e29362727a0641c952938733ae266", "committedDate": "2020-08-13T00:36:12Z", "message": "NF: loadQA in card cache"}, "afterCommit": {"oid": "a0136f169f66c2795b68b93eb2007abc9b09811c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a0136f169f66c2795b68b93eb2007abc9b09811c", "committedDate": "2020-08-13T01:44:10Z", "message": "NF: loadQA in card cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NjE3NTE2", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#pullrequestreview-466617516", "createdAt": "2020-08-13T09:59:27Z", "commit": {"oid": "a0136f169f66c2795b68b93eb2007abc9b09811c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwOTo1OToyN1rOHAEr1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwOTo1OToyN1rOHAEr1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTgzODgwNA==", "bodyText": "On failure, what do we want to do here?", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r469838804", "createdAt": "2020-08-13T09:59:27Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -1875,6 +1880,10 @@ public TaskData doInBackgroundCheckCardSelection(TaskData param) {\n         return new TaskData(new Object[] { hasUnsuspended, hasUnmarked});\n     }\n \n+    public void doInBackgroundPreloadNextCard() {\n+        getCol().getSched().preloadNextCard();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0136f169f66c2795b68b93eb2007abc9b09811c"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0136f169f66c2795b68b93eb2007abc9b09811c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a0136f169f66c2795b68b93eb2007abc9b09811c", "committedDate": "2020-08-13T01:44:10Z", "message": "NF: loadQA in card cache"}, "afterCommit": {"oid": "c2c92013146a70f97afa98a709b01e48d22e964e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c2c92013146a70f97afa98a709b01e48d22e964e", "committedDate": "2020-08-13T17:43:34Z", "message": "NF: loadQA in card cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDM5MTU2", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#pullrequestreview-467039156", "createdAt": "2020-08-13T18:47:35Z", "commit": {"oid": "c2c92013146a70f97afa98a709b01e48d22e964e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODo0NzozNlrOHAZAjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxODo1MzoyMFrOHAZMvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3MTc4OQ==", "bodyText": "Why has this been added? What has been added that needs to be protected against?", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470171789", "createdAt": "2020-08-13T18:47:36Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -719,7 +746,7 @@ protected void _resetRevQueue() {\n \n \n     @Override\n-    protected boolean _fillRev(boolean allowSibling) {\n+    protected synchronized boolean _fillRev(boolean allowSibling) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c92013146a70f97afa98a709b01e48d22e964e"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3MzgxOA==", "bodyText": "I don't get this logic? If cache 1 is empty, why would you not want to reload cache 2?", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470173818", "createdAt": "2020-08-13T18:51:17Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -674,6 +671,60 @@ protected Card _getCard() {\n         return _getLrnCard(true);\n     }\n \n+    /** similar to _getCard but only fill the queues without taking the card.\n+     * Returns lists that may contain the next cards.\n+     */\n+    protected List<? extends Card.Cache>[] _fillNextCard() {\n+        // learning card due?\n+        if (_preloadLrnCard(false)) {\n+            return new List[]{mLrnQueue};\n+        }\n+        // new first, or time for one?\n+        if (_timeForNewCard()) {\n+            if (_fillNew()) {\n+                return new List[]{mLrnQueue, mNewQueue};\n+            }\n+        }\n+        // Day learning first and card due?\n+        boolean dayLearnFirst = mCol.getConf().optBoolean(\"dayLearnFirst\", false);\n+        if (dayLearnFirst) {\n+            if (_fillLrnDay()) {\n+                return new List[]{mLrnQueue, mLrnDayQueue};\n+            }\n+        }\n+        // Card due for review?\n+        if (_fillRev()) {\n+            return new List[]{mLrnQueue, mRevQueue};\n+        }\n+        // day learning card due?\n+        if (!dayLearnFirst) {\n+            if (_fillLrnDay()) {\n+                return new List[]{mLrnQueue, mLrnDayQueue};\n+            }\n+        }\n+        // New cards left?\n+        if (_fillNew()) {\n+            return new List[]{mLrnQueue, mNewQueue};\n+        }\n+        // collapse or finish\n+        if (_preloadLrnCard(true)) {\n+            return new List[]{mLrnQueue};\n+        }\n+        return new List[]{};\n+    }\n+\n+    /** pre load the potential next card. It may loads many card because, depending on the time taken, the next card may\n+     * be a card in review or not. */\n+    public void preloadNextCard() {\n+        for (List<? extends Card.Cache> caches: _fillNextCard()) {\n+            if (caches.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c92013146a70f97afa98a709b01e48d22e964e"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3NDA3NA==", "bodyText": "Why was this changed?", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470174074", "createdAt": "2020-08-13T18:51:45Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -708,7 +759,7 @@ private void _resetNew() {\n     }\n \n     private void _resetNewQueue() {\n-        mNewDids = new LinkedList<>(mCol.getDecks().active());\n+        mNewDids = new LinkedList(mCol.getDecks().active());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c92013146a70f97afa98a709b01e48d22e964e"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE3NDkwOQ==", "bodyText": "Alternate implementation: Bake the caching into the data structure, and then you don't complicate the API calls here", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470174909", "createdAt": "2020-08-13T18:53:20Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -3063,8 +3128,8 @@ public void setCurrentCard(@NonNull Card card) {\n         mCurrentCardParentsDid = currentCardParentsDid;\n         _burySiblings(card);\n         // if current card is next card or in the queue\n-        mRevQueue.remove(card.getId());\n-        mNewQueue.remove(card.getId());\n+        mRevQueue.remove(mCol.getCardCache(card.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c92013146a70f97afa98a709b01e48d22e964e"}, "originalPosition": 272}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f83b66293eca08e6ef986e2893db82ef5f1fffc0", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f83b66293eca08e6ef986e2893db82ef5f1fffc0", "committedDate": "2020-08-13T19:20:33Z", "message": "NF: Sched uses Card cache in queue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2c92013146a70f97afa98a709b01e48d22e964e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c2c92013146a70f97afa98a709b01e48d22e964e", "committedDate": "2020-08-13T17:43:34Z", "message": "NF: loadQA in card cache"}, "afterCommit": {"oid": "81880a97eed1def11bbe5ba5e792af7982b66122", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/81880a97eed1def11bbe5ba5e792af7982b66122", "committedDate": "2020-08-13T19:20:33Z", "message": "NF: loadQA in card cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7edd757af69a9eaebb111e4277e0df0d226e0f7e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7edd757af69a9eaebb111e4277e0df0d226e0f7e", "committedDate": "2020-08-13T20:30:22Z", "message": "NF: loadQA in card cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4826ccdce41846fc0dc8ee8f60134e0c04979c56", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4826ccdce41846fc0dc8ee8f60134e0c04979c56", "committedDate": "2020-08-13T20:27:57Z", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier"}, "afterCommit": {"oid": "fb255d37a1620c87f90f0ca7752466fb6bf40561", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fb255d37a1620c87f90f0ca7752466fb6bf40561", "committedDate": "2020-08-13T20:30:23Z", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTEzNDQ2", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#pullrequestreview-467113446", "createdAt": "2020-08-13T20:39:39Z", "commit": {"oid": "fb255d37a1620c87f90f0ca7752466fb6bf40561"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozOTo0MFrOHAc0_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozOTo0MFrOHAc0_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzNDM2NQ==", "bodyText": "This should also be implemented in the card queue.\nWe need to assume that this does not return false. I'm not sure how", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470234365", "createdAt": "2020-08-13T20:39:40Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -3063,8 +3149,8 @@ public void setCurrentCard(@NonNull Card card) {\n         mCurrentCardParentsDid = currentCardParentsDid;\n         _burySiblings(card);\n         // if current card is next card or in the queue\n-        mRevQueue.remove(card.getId());\n-        mNewQueue.remove(card.getId());\n+        mRevQueue.remove(mCol.getCardCache(card.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb255d37a1620c87f90f0ca7752466fb6bf40561"}, "originalPosition": 232}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb255d37a1620c87f90f0ca7752466fb6bf40561", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fb255d37a1620c87f90f0ca7752466fb6bf40561", "committedDate": "2020-08-13T20:30:23Z", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier"}, "afterCommit": {"oid": "bf8cd0f5666b5c5f2c74731af6f556719c5a60fd", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/bf8cd0f5666b5c5f2c74731af6f556719c5a60fd", "committedDate": "2020-08-13T20:46:29Z", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTIwNTc5", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#pullrequestreview-467120579", "createdAt": "2020-08-13T20:51:14Z", "commit": {"oid": "bf8cd0f5666b5c5f2c74731af6f556719c5a60fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDo1MToxNVrOHAdOpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDo1MToxNVrOHAdOpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDI0MDkzNQ==", "bodyText": "I think this is the final one", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#discussion_r470240935", "createdAt": "2020-08-13T20:51:15Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -2514,7 +2605,7 @@ protected void _burySiblings(Card card) {\n                 }\n                 // even if burying disabled, we still discard to give\n                 // same-day spacing\n-                queue_object.remove(cid);\n+                queue_object.remove(mCol.getCardCache(cid));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf8cd0f5666b5c5f2c74731af6f556719c5a60fd"}, "originalPosition": 227}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef5231f3f9c3b4fcb054c728dae2bb81a8645b69", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ef5231f3f9c3b4fcb054c728dae2bb81a8645b69", "committedDate": "2020-08-13T20:56:25Z", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf8cd0f5666b5c5f2c74731af6f556719c5a60fd", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/bf8cd0f5666b5c5f2c74731af6f556719c5a60fd", "committedDate": "2020-08-13T20:46:29Z", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier"}, "afterCommit": {"oid": "ef5231f3f9c3b4fcb054c728dae2bb81a8645b69", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ef5231f3f9c3b4fcb054c728dae2bb81a8645b69", "committedDate": "2020-08-13T20:56:25Z", "message": "NF: CardQueue\n\nfactorizing some code so that getting head, loading first card, creating card cache and getting Card is easier"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTI0NzM5", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#pullrequestreview-467124739", "createdAt": "2020-08-13T20:58:00Z", "commit": {"oid": "ef5231f3f9c3b4fcb054c728dae2bb81a8645b69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDIyMTcy", "url": "https://github.com/ankidroid/Anki-Android/pull/6850#pullrequestreview-468022172", "createdAt": "2020-08-15T23:05:52Z", "commit": {"oid": "ef5231f3f9c3b4fcb054c728dae2bb81a8645b69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2900, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}