{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1Mjg2ODM0", "number": 5798, "title": "Give users more connection error information, handle cleartext failure", "bodyText": "Pull Request template\nPurpose / Description\nConnection error information is largely eaten by the app so users don't have a good chance to help themselves if they configure things wrong or there is a sync problem\nThis gives users more info they can use to self-help, and categorizes cleartext protocol failures as harmless\nFixes\nhttps://couchdb.ankidroid.org/acralyzer/_design/acralyzer/index.html#/report-details/69ac5da1-bb3f-48cf-ba63-6cef9bc7bf4d\njava.lang.RuntimeException: java.net.UnknownServiceException: CLEARTEXT communication to 220.208.39.208 not permitted by network security policy\nat com.ichi2.libanki.sync.HttpSyncer.req(HttpSyncer.java:62)\nat com.ichi2.libanki.sync.HttpSyncer.req(HttpSyncer.java:4)\nat com.ichi2.libanki.sync.HttpSyncer.req(HttpSyncer.java:2)\nat com.ichi2.libanki.sync.RemoteServer.meta(RemoteServer.java:9)\nat com.ichi2.libanki.sync.Syncer.sync(Syncer.java:4)\nat com.ichi2.async.Connection.doInBackgroundSync(Connection.java:15)\nat com.ichi2.async.Connection.doOneInBackground(Connection.java:2)\nat com.ichi2.async.Connection.doInBackground(Connection.java:4)\nat com.ichi2.async.Connection.doInBackground(Connection.java:1)\n\nApproach\nI classify 'CLEARTEXT' HTTP problems as harmless via the existing classification style\nI pass along the exception to the AsyncTask consumer, so it may be inspected\nOn login and sync failures that are connection failures, I look to see if the async result has an exception, and if it does I add the exception message to what we show the user\nThis will just go for 2.10 it's not frequent enough to pull in to 2.9 and isn't a crash anyway, just user help\nHow Has This Been Tested?\nOn an API28 emulator I tried\n\na regular sync to ankiweb (works)\nI tried logging in to the cleartext custom sync server from the error link above (did not work) - had a useless message before, now contains the cleartext fail information which is actionable\nI tried logging in to AnkiWeb then changing to the custom sync server above (did not work) - had a useless message before, now contains the cleartext fail information which is actionable\n\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-03-08T16:39:10Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5798", "merged": true, "mergeCommit": {"oid": "8f1e03d0332eb0cd07191cae6f1c744aca2b991a"}, "closed": true, "closedAt": "2020-03-09T12:23:25Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLvX_6AFqTM3MDg1NTY2Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcL1DQ7gBqjMxMDkwMjM1ODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwODU1NjY2", "url": "https://github.com/ankidroid/Anki-Android/pull/5798#pullrequestreview-370855666", "createdAt": "2020-03-08T20:28:34Z", "commit": {"oid": "efbf5a87a52fba82ab8218319ee94f7929f84990"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMDoyODozNVrOFzXPJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMDozMDoxNVrOFzXPoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwMjQwNg==", "bodyText": "You seriously want to use a hyphen here? \ud83e\udd14\ud83d\ude05 A colon and new line character may be the way to go...?", "url": "https://github.com/ankidroid/Anki-Android/pull/5798#discussion_r389402406", "createdAt": "2020-03-08T20:28:35Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -1542,6 +1542,9 @@ public void onPostExecute(Payload data) {\n                         showSyncErrorMessage(joinSyncMessages(dialogMessage, syncMessage));\n                     } else if (\"connectionError\".equals(resultType)) {\n                         dialogMessage = res.getString(R.string.sync_connection_error);\n+                        if (result.length >= 1 && result[1] instanceof Exception) {\n+                            dialogMessage += \" - \" + ((Exception)result[1]).getLocalizedMessage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efbf5a87a52fba82ab8218319ee94f7929f84990"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwMjUyOQ==", "bodyText": "I'm not sure how meaningful this is, as it's pretty much guaranteed to truncate in the snack bar. Maybe you want to show a dialog when there's an error and only show the snack bar when there's not.", "url": "https://github.com/ankidroid/Anki-Android/pull/5798#discussion_r389402529", "createdAt": "2020-03-08T20:30:15Z", "author": {"login": "timrae"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/MyAccount.java", "diffHunk": "@@ -200,11 +200,16 @@ public void onPostExecute(Payload data) {\n                     switchToState(STATE_LOGGED_IN);\n                 }\n             } else {\n-                Timber.e(\"Login failed, error code %d\",data.returnType);\n+                Timber.e(\"Login failed, error code %d\", data.returnType);\n                 if (data.returnType == 403) {\n                     UIUtils.showSimpleSnackbar(MyAccount.this, R.string.invalid_username_password, true);\n                 } else {\n-                    UIUtils.showSimpleSnackbar(MyAccount.this, R.string.connection_error_message, true);\n+                    String message = getResources().getString(R.string.connection_error_message);\n+                    Object[] result = (Object [])data.result;\n+                    if (result.length > 1 && result[1] instanceof Exception) {\n+                        message += \": \" + ((Exception)result[1]).getLocalizedMessage();\n+                    }\n+                    UIUtils.showSimpleSnackbar(MyAccount.this, message, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efbf5a87a52fba82ab8218319ee94f7929f84990"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35b680620b784daf27ffeee59a5c0631474a5f55", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/35b680620b784daf27ffeee59a5c0631474a5f55", "committedDate": "2020-03-09T03:07:32Z", "message": "Give users more connection error information, handle cleartext failure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efbf5a87a52fba82ab8218319ee94f7929f84990", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/efbf5a87a52fba82ab8218319ee94f7929f84990", "committedDate": "2020-03-08T16:32:27Z", "message": "Give users more connection error information, handle cleartext failure"}, "afterCommit": {"oid": "35b680620b784daf27ffeee59a5c0631474a5f55", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/35b680620b784daf27ffeee59a5c0631474a5f55", "committedDate": "2020-03-09T03:07:32Z", "message": "Give users more connection error information, handle cleartext failure"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3693, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}