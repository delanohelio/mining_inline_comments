{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1NDkyNTk4", "number": 6648, "title": "Decks: Strip whitespace in children as well as parents", "bodyText": "Pull Request template\nPurpose / Description\nFun fact, did you know in Java, \".trim\" remove only the ' ' character https://docs.oracle.com/javase/7/docs/api/java/lang/String.html#trim() https://github.com/ankidroid/Anki-Android/blob/master/AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java#L851\nwhile in rust, it removes all \"Unicode Derived Core Property White_Space.\"\nhttps://doc.rust-lang.org/std/string/struct.String.html\nhttps://github.com/ankitects/anki/blob/master/rslib/src/decks/mod.rs#L128\nSo I'm moving the \"strip\" function so that it deals with all whitespace.\nNot sure it will solve #6383 but it should be a way forward at least.\nThe main trouble with #6383 being that I have no clue where we did remove some new line symbol, it seems we never strip them. The best explanation I would see would be if the method \".trim\" does not always follow java documentation and sometime trim more than just ' '.\nThis should also improve validation of deck name, even if it's still not perfect #6639\nI should note that this method should also be cached; because checking whethe a deck name is correct needs to do a lot of string processing while we could easily cache the set of deck name we already know to be correct.\nApproach\nUsing \\s instead of ' '\nHow Has This Been Tested?\nOn emulator, I pasted a new line at the end of a deck name and saw it was correctly stripped\nLearning (optional, can help others)\nI wish more and more that I had a deck class. Ensuring that names are not changed with only .put(\"name\", \"new name\") would have clearly improved the safety, because\u00a0i could at least search easily for each place the deck name is considered", "createdAt": "2020-07-07T15:35:01Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6648", "merged": true, "mergeCommit": {"oid": "fd5195602833e6833d137e3eb94aa6b72020adce"}, "closed": true, "closedAt": "2020-07-08T15:00:12Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcynXJ2gH2gAyNDQ1NDkyNTk4OjY3NWUwNGJlZjQyOGU3MDI1MzQzMjYyOGJmMmIyODRlMGFmMzkxNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy7w4QgFqTQ0NDg1NDcxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "675e04bef428e70253432628bf2b284e0af3916b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/675e04bef428e70253432628bf2b284e0af3916b", "committedDate": "2020-07-07T15:13:53Z", "message": "move _removeSpace to _checkDeckTree\n\nThere was no reason to do it otherwhere, and it could cause problem as it did not update name map."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDE0OTIy", "url": "https://github.com/ankidroid/Anki-Android/pull/6648#pullrequestreview-444014922", "createdAt": "2020-07-07T15:38:58Z", "commit": {"oid": "7373ab6581fca0ed161337b30d8229b45633fbc9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7373ab6581fca0ed161337b30d8229b45633fbc9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7373ab6581fca0ed161337b30d8229b45633fbc9", "committedDate": "2020-07-07T15:23:56Z", "message": "Trim all whitespace\n\nCurrently anki's trim deal with all white space from unicode while java only dealt with ' '"}, "afterCommit": {"oid": "3c792fe16bdebd531529c779674cf26d87f4dd86", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3c792fe16bdebd531529c779674cf26d87f4dd86", "committedDate": "2020-07-07T15:57:18Z", "message": "NF: unit test for trim"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDM3MDk5", "url": "https://github.com/ankidroid/Anki-Android/pull/6648#pullrequestreview-444037099", "createdAt": "2020-07-07T16:03:45Z", "commit": {"oid": "3c792fe16bdebd531529c779674cf26d87f4dd86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjowMzo0NlrOGuFcCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjowMzo0NlrOGuFcCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk3Njc3Nw==", "bodyText": "I was referring to a test to ensure that a deck with a trailing newline in the parent won't break the system from a higher level\nSomething along the lines of:\nBuild:\n\nA::B\\n\nA::B\\n::C\nA::B\\n::D\\n\nEnsure that deckDueTree works\n\nAnd ensure that the deck list can be built.", "url": "https://github.com/ankidroid/Anki-Android/pull/6648#discussion_r450976777", "createdAt": "2020-07-07T16:03:46Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/test/java/com/ichi2/libanki/DecksTest.java", "diffHunk": "@@ -56,4 +56,11 @@ public void ensureDeckList() {\n             }\n         }\n     }\n+\n+    @Test\n+    public void trim() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c792fe16bdebd531529c779674cf26d87f4dd86"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c792fe16bdebd531529c779674cf26d87f4dd86", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3c792fe16bdebd531529c779674cf26d87f4dd86", "committedDate": "2020-07-07T15:57:18Z", "message": "NF: unit test for trim"}, "afterCommit": {"oid": "a653f26093bf9b6ecdfb66c88b52d35f49e93035", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a653f26093bf9b6ecdfb66c88b52d35f49e93035", "committedDate": "2020-07-07T16:04:24Z", "message": "NF: unit test for trim"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjczMTgy", "url": "https://github.com/ankidroid/Anki-Android/pull/6648#pullrequestreview-444273182", "createdAt": "2020-07-07T21:46:41Z", "commit": {"oid": "a653f26093bf9b6ecdfb66c88b52d35f49e93035"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMTo0Njo0MVrOGuQxcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMTo0ODozOFrOGuQ0-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE2MjQ4MA==", "bodyText": "Comment to explain that this will handle decks that do not contain ::", "url": "https://github.com/ankidroid/Anki-Android/pull/6648#discussion_r451162480", "createdAt": "2020-07-07T21:46:41Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -846,24 +847,12 @@ private void maybeAddToActive() {\n     }\n \n \n-    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");\n-    private static String strip(String deckName) {\n-        return spaceAroundSeparator.matcher(deckName.trim()).replaceAll( \"::\");\n-    }\n-\n-    /** With 2.1.28, anki started strips whitespace of deck name.\n-     * This method is here for compatibility while we wait for rust.\n-     * It should be executed before other methods, because both \"FOO \" and \"FOO\" will be renamed to the same name,\n-     * and so this will need to be renamed by _checkDeckTree.*/\n-    private void _removeSpaces () {\n-        for (JSONObject deck: all()) {\n-            String currentName = deck.getString(\"name\");\n-            String newName = strip(currentName);\n-            if (!currentName.equals(newName)) {\n-                deck.put(\"name\", newName);\n-                save(deck);\n-            }\n-        }\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\"\\\\s*::\\\\s*\");\n+    @VisibleForTesting\n+    public static String strip(String deckName) {\n+        deckName = spaceAroundSeparator.matcher(deckName).replaceAll(\"::\");\n+        deckName = deckName.trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a653f26093bf9b6ecdfb66c88b52d35f49e93035"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE2MzM4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static String strip(String deckName) {\n          \n          \n            \n                static String strip(String deckName) {", "url": "https://github.com/ankidroid/Anki-Android/pull/6648#discussion_r451163384", "createdAt": "2020-07-07T21:48:38Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -846,24 +847,12 @@ private void maybeAddToActive() {\n     }\n \n \n-    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");\n-    private static String strip(String deckName) {\n-        return spaceAroundSeparator.matcher(deckName.trim()).replaceAll( \"::\");\n-    }\n-\n-    /** With 2.1.28, anki started strips whitespace of deck name.\n-     * This method is here for compatibility while we wait for rust.\n-     * It should be executed before other methods, because both \"FOO \" and \"FOO\" will be renamed to the same name,\n-     * and so this will need to be renamed by _checkDeckTree.*/\n-    private void _removeSpaces () {\n-        for (JSONObject deck: all()) {\n-            String currentName = deck.getString(\"name\");\n-            String newName = strip(currentName);\n-            if (!currentName.equals(newName)) {\n-                deck.put(\"name\", newName);\n-                save(deck);\n-            }\n-        }\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\"\\\\s*::\\\\s*\");\n+    @VisibleForTesting\n+    public static String strip(String deckName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a653f26093bf9b6ecdfb66c88b52d35f49e93035"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "721ac841f61629c584422ca389c9d5ec582ee2fc", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/721ac841f61629c584422ca389c9d5ec582ee2fc", "committedDate": "2020-07-07T22:18:26Z", "message": "Trim all whitespace\n\nCurrently anki's trim deal with all white space from unicode while java only dealt with ' '"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c87dd44d0c4df6d1778a4631e621f39eeb1a09b9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c87dd44d0c4df6d1778a4631e621f39eeb1a09b9", "committedDate": "2020-07-07T22:19:52Z", "message": "NF: unit test for trim"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a653f26093bf9b6ecdfb66c88b52d35f49e93035", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a653f26093bf9b6ecdfb66c88b52d35f49e93035", "committedDate": "2020-07-07T16:04:24Z", "message": "NF: unit test for trim"}, "afterCommit": {"oid": "c87dd44d0c4df6d1778a4631e621f39eeb1a09b9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c87dd44d0c4df6d1778a4631e621f39eeb1a09b9", "committedDate": "2020-07-07T22:19:52Z", "message": "NF: unit test for trim"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODU0NzE5", "url": "https://github.com/ankidroid/Anki-Android/pull/6648#pullrequestreview-444854719", "createdAt": "2020-07-08T15:00:05Z", "commit": {"oid": "c87dd44d0c4df6d1778a4631e621f39eeb1a09b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3101, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}