{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MDc4Njkx", "number": 6506, "title": "Deck import: Pre-validate zip file", "bodyText": "Purpose / Description\nPreviously, we performed the check inside either AnkiPackageImporter/doInBackgroundReplace. This caused exception reports to be thrown when zip files were invalid, which wasn't a great UX\nFixes\nFixes #6489\nApproach\nWe move to ImportUtil to validate the import, which displays an error and does not raise an exception report.\nHow Has This Been Tested?\nOn my phone:\n\nEmpty file - no exception report, \"Failed to unzip apkg: archive is not a ZIP archive\"\nCorrupt file - no exception report, \"Failed to unzip apkg: central directory is empty ...\"\nGood file - imports as normal\n\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-06-19T12:38:47Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6506", "merged": true, "mergeCommit": {"oid": "a95d2b8fe63db9bea8416b53f41fc40756775f61"}, "closed": true, "closedAt": "2020-06-19T19:15:08Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsxpPwgH2gAyNDM3MDc4NjkxOmFlNzk3YmVjNzI2ZWQ2NGUwYTEyYjhkNzhmN2MwNGYxOWExYzIxOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcs2nxgAFqTQzNDI0MzM5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae797bec726ed64e0a12b8d78f7c04f19a1c2191", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ae797bec726ed64e0a12b8d78f7c04f19a1c2191", "committedDate": "2020-06-19T11:49:09Z", "message": "NF: Refactor import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjMxMjEy", "url": "https://github.com/ankidroid/Anki-Android/pull/6506#pullrequestreview-434231212", "createdAt": "2020-06-19T17:14:35Z", "commit": {"oid": "922ec108822cc1d5210961b8dcb89c6137e44ddc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxNDozNVrOGmb9xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxNDozNVrOGmb9xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk1NzI1NA==", "bodyText": "Pretty much a nit but 'e' is for \"application has unknown state and we're basically a contained explosion at this point\", 'w' is for, input was unexpected and it definitely messes with what the user was trying to do, but internal state is fine, we know what's going on, we're good'\nThis is 'w' I think", "url": "https://github.com/ankidroid/Anki-Android/pull/6506#discussion_r442957254", "createdAt": "2020-06-19T17:14:35Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/utils/ImportUtils.java", "diffHunk": "@@ -173,12 +174,32 @@ private String handleContentProviderFile(Context context, Intent intent, Uri dat\n                     AnkiDroidApp.sendExceptionReport(new RuntimeException(\"Error importing apkg file\"), \"IntentHandler.java\", \"apkg import failed\");\n                     return errorMessage;\n                 }\n+\n+                errorMessage = validateZipFile(context, tempOutDir);\n+                if (errorMessage != null) {\n+                    //noinspection ResultOfMethodCallIgnored\n+                    new File(tempOutDir).delete();\n+                    return errorMessage;\n+                }\n+\n                 sendShowImportFileDialogMsg(tempOutDir);\n                 return null;\n             }\n         }\n \n \n+        protected String validateZipFile(Context context, String filePath) {\n+            File file = new File(filePath);\n+            try {\n+                new ZipFile(file);\n+            } catch (Exception e) {\n+                Timber.e(e, \"Failed to validate zip\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "922ec108822cc1d5210961b8dcb89c6137e44ddc"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjMxODg3", "url": "https://github.com/ankidroid/Anki-Android/pull/6506#pullrequestreview-434231887", "createdAt": "2020-06-19T17:15:56Z", "commit": {"oid": "922ec108822cc1d5210961b8dcb89c6137e44ddc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e58e32a0666f7c3a79471b79361337c2d62fbd0", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3e58e32a0666f7c3a79471b79361337c2d62fbd0", "committedDate": "2020-06-19T17:23:56Z", "message": "Import: Fail early if zip is invalid\n\nThis means we clean up any invalid zip files and do not send exception reports\n\nFixes 6489"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "922ec108822cc1d5210961b8dcb89c6137e44ddc", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/922ec108822cc1d5210961b8dcb89c6137e44ddc", "committedDate": "2020-06-19T12:32:15Z", "message": "Import: Fail early if zip is invalid\n\nThis means we clean up any invalid zip files and do not send exception reports\n\nFixes 6489"}, "afterCommit": {"oid": "3e58e32a0666f7c3a79471b79361337c2d62fbd0", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3e58e32a0666f7c3a79471b79361337c2d62fbd0", "committedDate": "2020-06-19T17:23:56Z", "message": "Import: Fail early if zip is invalid\n\nThis means we clean up any invalid zip files and do not send exception reports\n\nFixes 6489"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjQzMzk1", "url": "https://github.com/ankidroid/Anki-Android/pull/6506#pullrequestreview-434243395", "createdAt": "2020-06-19T17:37:04Z", "commit": {"oid": "3e58e32a0666f7c3a79471b79361337c2d62fbd0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3244, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}