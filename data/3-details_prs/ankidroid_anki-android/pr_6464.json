{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MjQzMjIy", "number": 6464, "title": "Shrink published APK by ~3MB w/ABI splits", "bodyText": "Pull Request template\nPurpose / Description\nWe include native code now and that will only continue with Rust\nWe must implement a 64-bit native build by Play store guidelines but we still have devices that use ARM and x86.\nThe only way to include 64-bit binaries and support all the users without bloating the APK as it is currently is to split via ABI\nSo this PR does binary ABI splits so platforms only get the binary code they need from our libraries.\nThat takes it from 10.5MB to 7.5MB or so\nApproach\nI cribbed the style used by react-native, which I have used successfully for a couple years, and adapted the ABI-versionCode-ranges to match our versioning style\nHow Has This Been Tested?\nUnfortunately this is the sort of thing that you test by releasing, so this is already released as 2.12alpha7 and 2.12alpha8 to make sure it was working \ud83d\ude28\nLearning (optional, can help others)\nI put links in the comments in the code for versionCode range since that is vital to understand now and in the future.\nMaximum versionCode is 2.1billion FWIW. We'll be fine.\nhttps://github.com/facebook/react-native/blob/6d6268e903def9e4a8609e5dee6de2d2c4ab8c5e/template/android/app/build.gradle#L167-L180\nChecklist\nPlease, go through these checks before submitting the PR.\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-06-15T01:55:44Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6464", "merged": true, "mergeCommit": {"oid": "34d1808e1d14538878725234e90d8dd831265c29"}, "closed": true, "closedAt": "2020-06-15T01:58:14Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrWhE-AH2gAyNDM0MjQzMjIyOmFmYTY4YjNmOWI3ZjRiMmU1YzQ2YTU3ZTE1Y2YwMjhkNWM3ZjJmMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrcLbZgFqTQzMDQxMTc3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "afa68b3f9b7f4b2e5c46a57e15cf028d5c7f2f23", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/afa68b3f9b7f4b2e5c46a57e15cf028d5c7f2f23", "committedDate": "2020-06-15T01:38:52Z", "message": "Bumped version to 2.12alpha7\n@branch-specific"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "217e0b0f6bfc5dc365b14f055399d676be875f02", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/217e0b0f6bfc5dc365b14f055399d676be875f02", "committedDate": "2020-06-15T01:46:23Z", "message": "Implement ABI splits for release builds\n\nThis reduces built APK to 7.5MB vs 10.4MB\n\nCareful consideration was taken to version range space so we won't exhaust it\n\nManual downloads (github attachments, mostly) are configured as armv7 since no\none uses x86 in real devices anymore - and armv8 devices can run armv7 code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7730d5f501f3721d3fe77b3bad7bc2723426b0", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/cb7730d5f501f3721d3fe77b3bad7bc2723426b0", "committedDate": "2020-06-15T01:50:02Z", "message": "Bumped version to 2.12alpha8\n@branch-specific"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNDExNzcx", "url": "https://github.com/ankidroid/Anki-Android/pull/6464#pullrequestreview-430411771", "createdAt": "2020-06-15T08:08:37Z", "commit": {"oid": "cb7730d5f501f3721d3fe77b3bad7bc2723426b0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwODowODozN1rOGjne-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwODoxMDo1MFrOGjnjxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAwMDI1MQ==", "bodyText": "Is it worth putting the fat apk for public download?", "url": "https://github.com/ankidroid/Anki-Android/pull/6464#discussion_r440000251", "createdAt": "2020-06-15T08:08:37Z", "author": {"login": "david-allison-1"}, "path": "tools/parallel-package-release.sh", "diffHunk": "@@ -34,5 +34,5 @@ for BUILD in $BUILDNAMES; do\n     LCBUILD=`tr '[:upper:]' '[:lower:]' <<< $BUILD`\n     ./tools/parallel-package-name.sh com.ichi2.anki.$LCBUILD AnkiDroid.$BUILD\n     ./gradlew assembleRelease\n-    cp AnkiDroid/build/outputs/apk/release/AnkiDroid-release.apk ../AnkiDroid-$TAG.parallel.$BUILD.apk\n+    cp AnkiDroid/build/outputs/apk/release/AnkiDroid-armeabi-v7a-release.apk ../AnkiDroid-$TAG.parallel.$BUILD.apk", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb7730d5f501f3721d3fe77b3bad7bc2723426b0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAwMTQ3Ng==", "bodyText": "universalApk seems to be set to false, where is it generated?", "url": "https://github.com/ankidroid/Anki-Android/pull/6464#discussion_r440001476", "createdAt": "2020-06-15T08:10:50Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/build.gradle", "diffHunk": "@@ -66,6 +91,49 @@ android {\n         }\n     }\n \n+    /**\n+     * Set this to true to create five separate APKs instead of one:\n+     *   - 2 APKs that only work on ARM/ARM64 devices\n+     *   - 2 APKs that only works on x86/x86_64 devices\n+     *   - a universal APK that works on all devices", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb7730d5f501f3721d3fe77b3bad7bc2723426b0"}, "originalPosition": 45}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3217, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}