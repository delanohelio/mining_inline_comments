{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxODcyNDY1", "number": 5848, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNjoyODoxOVrODqF9Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNjo0MDo1M1rODqGATQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDY0Mzk4OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNjoyODoxOVrOF5qUcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNjoyODoxOVrOF5qUcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwNjUxMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                <string name=\"collection_load_welcome_request_permissions_details\">We require storage access to store your AnkiDroid collection, including media and backups. We do not access any of your media or files. Our code is open-source, written by volunteers, and trusted by millions.\\n\\nIf you have any questions, please access our in-app manual or visit our support forums.\\n\\nThank you for trying AnkiDroid!\\n\u2014AnkiDroid Development Team</string>\n          \n          \n            \n                <string name=\"collection_load_welcome_request_permissions_details\">AnkiDroid requires storage permission, which we use exclusively to store your AnkiDroid collection, flashcard media and backups. Our code is open-source, written by volunteers, and trusted by millions.\\n\\nIf you have any questions, please access our in-app manual or visit our support forums.\\n\\nThank you for trying AnkiDroid!\\n\u2014AnkiDroid Development Team</string>", "url": "https://github.com/ankidroid/Anki-Android/pull/5848#discussion_r396006512", "createdAt": "2020-03-21T16:28:19Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/res/values/03-dialogs.xml", "diffHunk": "@@ -139,4 +139,8 @@\n     <string name=\"empty_cards_none\">No empty cards</string>\n     <string name=\"empty_cards_count\">Cards to delete: %d</string>\n     <string name=\"empty_cards_deleted\">Cards deleted: %d</string>\n+\n+    <!-- Initial collection load -->\n+    <string name=\"collection_load_welcome_request_permissions_title\">Welcome to AnkiDroid!</string>\n+    <string name=\"collection_load_welcome_request_permissions_details\">We require storage access to store your AnkiDroid collection, including media and backups. We do not access any of your media or files. Our code is open-source, written by volunteers, and trusted by millions.\\n\\nIf you have any questions, please access our in-app manual or visit our support forums.\\n\\nThank you for trying AnkiDroid!\\n\u2014AnkiDroid Development Team</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e86bec7cabfc43a7f190ae9f0173d1a39b4f97f4"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDY1MTY1OnYy", "diffSide": "RIGHT", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNjo0MDo1M1rOF5qYWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNjo1Mzo1MVrOF5qciw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwNzUxNQ==", "bodyText": "not sure if it's best practice to set our member variable prior to asking the system to go off and do something, but I think it might be?", "url": "https://github.com/ankidroid/Anki-Android/pull/5848#discussion_r396007515", "createdAt": "2020-03-21T16:40:53Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -454,11 +460,28 @@ private boolean firstCollectionOpen() {\n         if (CollectionHelper.hasStorageAccessPermission(this)) {\n             // Show error dialog if collection could not be opened\n             return CollectionHelper.getInstance().getColSafe(this) != null;\n-        } else {\n-            // Request storage permission if we don't have it (e.g. on Android 6.0+)\n+        } else if (mClosedWelcomeMessage) {\n+            // DEFECT #5847: This fails if the activity is killed.\n+            //Even if the dialog is showing, we want to show it again.\n             ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.WRITE_EXTERNAL_STORAGE},\n                     REQUEST_STORAGE_PERMISSION);\n             return false;\n+        } else {\n+            // Request storage permission if we don't have it (e.g. on Android 6.0+)\n+            new MaterialDialog.Builder(this)\n+                    .title(R.string.collection_load_welcome_request_permissions_title)\n+                    .titleGravity(GravityEnum.CENTER)\n+                    .content(R.string.collection_load_welcome_request_permissions_details)\n+                    .positiveText(R.string.dialog_ok)\n+                    .onPositive((innerDialog, innerWhich) -> {\n+                        ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.WRITE_EXTERNAL_STORAGE},\n+                                REQUEST_STORAGE_PERMISSION);\n+                        this.mClosedWelcomeMessage = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e86bec7cabfc43a7f190ae9f0173d1a39b4f97f4"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwODU4Nw==", "bodyText": "I'm not sure I understand this one. We're tracking whether welcome has been closed (which is done inside the lambda at first opportunity).\nEDIT: It doesn't matter much as it's executed async, but lets do it anyway.", "url": "https://github.com/ankidroid/Anki-Android/pull/5848#discussion_r396008587", "createdAt": "2020-03-21T16:53:51Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -454,11 +460,28 @@ private boolean firstCollectionOpen() {\n         if (CollectionHelper.hasStorageAccessPermission(this)) {\n             // Show error dialog if collection could not be opened\n             return CollectionHelper.getInstance().getColSafe(this) != null;\n-        } else {\n-            // Request storage permission if we don't have it (e.g. on Android 6.0+)\n+        } else if (mClosedWelcomeMessage) {\n+            // DEFECT #5847: This fails if the activity is killed.\n+            //Even if the dialog is showing, we want to show it again.\n             ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.WRITE_EXTERNAL_STORAGE},\n                     REQUEST_STORAGE_PERMISSION);\n             return false;\n+        } else {\n+            // Request storage permission if we don't have it (e.g. on Android 6.0+)\n+            new MaterialDialog.Builder(this)\n+                    .title(R.string.collection_load_welcome_request_permissions_title)\n+                    .titleGravity(GravityEnum.CENTER)\n+                    .content(R.string.collection_load_welcome_request_permissions_details)\n+                    .positiveText(R.string.dialog_ok)\n+                    .onPositive((innerDialog, innerWhich) -> {\n+                        ActivityCompat.requestPermissions(this, new String[] {Manifest.permission.WRITE_EXTERNAL_STORAGE},\n+                                REQUEST_STORAGE_PERMISSION);\n+                        this.mClosedWelcomeMessage = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwNzUxNQ=="}, "originalCommit": {"oid": "e86bec7cabfc43a7f190ae9f0173d1a39b4f97f4"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 453, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}