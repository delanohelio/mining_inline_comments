{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MjA0NTkz", "number": 6180, "title": "Iteratively render tags", "bodyText": "Pull Request template\nPurpose / Description\nTags in tags weren't rendering correctly, this showed up with a reported bug in expansion of tag that should have turned into a type-answer tag\nFixes\nFixes #6176\nApproach\nI applied the same transformation applied to section rendering to make it iterative until it determined no new replacements happened\nHow Has This Been Tested?\nWith a test based on user report, used for the original bisect from @david-allison-1, integrated into TemplateTest\nLearning (optional, can help others)\nPerformance changes without a wide ranging test suite are fraught with regression danger.\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-05-14T19:33:32Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6180", "merged": true, "mergeCommit": {"oid": "7028a63f01be50804692f9995a051fdaa0f52ec0"}, "closed": true, "closedAt": "2020-05-14T21:32:09Z", "author": {"login": "mikehardy"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchSnxdgH2gAyNDE4MjA0NTkzOjNkOTgwNDI2ZmZhMzA4MWZmOTlmODg4MWQ1MjIwYWY0OWQ3M2YwZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchUWZigBqjMzMzg1MDQzNjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3d980426ffa3081ff99f8881d5220af49d73f0e1", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3d980426ffa3081ff99f8881d5220af49d73f0e1", "committedDate": "2020-05-14T19:27:19Z", "message": "LINT: Template de-linting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d944e2182b73625dea2dc79d28c7b5794046b1ee", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d944e2182b73625dea2dc79d28c7b5794046b1ee", "committedDate": "2020-05-14T19:27:36Z", "message": "Template tag expansion must recur if needed\n\nThis is the same recursion patch needed for sections after the\nperformance change there - as tags may be replaced by tags\n\nFixes #6176"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTUxMzAw", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#pullrequestreview-412151300", "createdAt": "2020-05-14T20:16:02Z", "commit": {"oid": "d944e2182b73625dea2dc79d28c7b5794046b1ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoxNjowMlrOGVsndA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQyMDoxNjowMlrOGVsndA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTQwNDI3Ng==", "bodyText": "I think that marking everything you can as final is a good practice.", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#discussion_r425404276", "createdAt": "2020-05-14T20:16:02Z", "author": {"login": "mrozigor"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -161,17 +154,34 @@ private String render_some_sections(@NonNull String template, @NonNull Map<Strin\n         return sb.toString();\n     }\n \n+    /**\n+     * Expands all tags, iteratively until all tags (even tags that are replaced by tags) are resolved.\n+     */\n+    private String render_tags(@NonNull String template, @NonNull Map<String, String> context) {\n+        /* Apply render_some_tags to the tags, until\n+           render_some_tags states that it does not find tags to replace anymore\n+           anymore. Return the last template state */\n+        String previous_template = null;\n+        while (template != null) {\n+            previous_template = template;\n+            template = render_some_tags(template, context);\n+        }\n+        return previous_template;\n+    }\n \n     /**\n-     * Renders all the tags in a template for a context.\n+     * Replaces all the tags in a template in a single pass for the values in the given context map.\n      */\n-    private String render_tags(String template, Map<String, String> context) {\n-        if (template.indexOf(ALT_HANDLEBAR_DIRECTIVE) != -1) {\n+    private String render_some_tags(String template, Map<String, String> context) {\n+        String ALT_HANDLEBAR_DIRECTIVE = \"{{=<% %>=}}\";\n+        if (template.contains(ALT_HANDLEBAR_DIRECTIVE)) {\n             template = template.replace(ALT_HANDLEBAR_DIRECTIVE, \"\").replace(\"<%\", \"{{\").replace(\"%>\", \"}}\");\n         }\n         StringBuffer sb = new StringBuffer();\n         Matcher match = sTag_re.matcher(template);\n+        boolean found = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d944e2182b73625dea2dc79d28c7b5794046b1ee"}, "originalPosition": 117}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTI5MDM5", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#pullrequestreview-412129039", "createdAt": "2020-05-14T19:43:17Z", "commit": {"oid": "d944e2182b73625dea2dc79d28c7b5794046b1ee"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTo0MzoxN1rOGVrj_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOTo0NjozNFrOGVrq5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4NzAwNw==", "bodyText": "Can you make this @Nullable", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#discussion_r425387007", "createdAt": "2020-05-14T19:43:17Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -161,17 +154,34 @@ private String render_some_sections(@NonNull String template, @NonNull Map<Strin\n         return sb.toString();\n     }\n \n+    /**\n+     * Expands all tags, iteratively until all tags (even tags that are replaced by tags) are resolved.\n+     */\n+    private String render_tags(@NonNull String template, @NonNull Map<String, String> context) {\n+        /* Apply render_some_tags to the tags, until\n+           render_some_tags states that it does not find tags to replace anymore\n+           anymore. Return the last template state */\n+        String previous_template = null;\n+        while (template != null) {\n+            previous_template = template;\n+            template = render_some_tags(template, context);\n+        }\n+        return previous_template;\n+    }\n \n     /**\n-     * Renders all the tags in a template for a context.\n+     * Replaces all the tags in a template in a single pass for the values in the given context map.\n      */\n-    private String render_tags(String template, Map<String, String> context) {\n-        if (template.indexOf(ALT_HANDLEBAR_DIRECTIVE) != -1) {\n+    private String render_some_tags(String template, Map<String, String> context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d944e2182b73625dea2dc79d28c7b5794046b1ee"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4ODc3Mw==", "bodyText": "again, @Nullable", "url": "https://github.com/ankidroid/Anki-Android/pull/6180#discussion_r425388773", "createdAt": "2020-05-14T19:46:34Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/template/Template.java", "diffHunk": "@@ -59,38 +57,33 @@\n     private static final String sCtag = Pattern.quote(\"}}\");\n \n     // The regular expression used to find a #section\n-    private static final Pattern sSection_re = Pattern.compile(sOtag + \"[\\\\#|^]([^\\\\}]*)\" + sCtag + \"(.+?)\" + sOtag + \"/\\\\1\" + sCtag, Pattern.MULTILINE | Pattern.DOTALL);\n+    private static final Pattern sSection_re = Pattern.compile(sOtag + \"[#|^]([^}]*)\" + sCtag + \"(.+?)\" + sOtag + \"/\\\\1\" + sCtag, Pattern.MULTILINE | Pattern.DOTALL);\n \n     // The regular expression used to find a tag.\n-    private static final Pattern sTag_re = Pattern.compile(sOtag + \"(#|=|&|!|>|\\\\{)?(.+?)\\\\1?\" + sCtag + \"+\");\n+    private static final Pattern sTag_re = Pattern.compile(sOtag + \"([#=&!>{])?(.+?)\\\\1?\" + sCtag + \"+\");\n \n     // MathJax opening delimiters\n-    private static String sMathJaxOpenings[] = {\"\\\\(\", \"\\\\[\"};\n+    private static String[] sMathJaxOpenings = {\"\\\\(\", \"\\\\[\"};\n \n     // MathJax closing delimiters\n-    private static String sMathJaxClosings[] = {\"\\\\)\", \"\\\\]\"};\n+    private static String[] sMathJaxClosings = {\"\\\\)\", \"\\\\]\"};\n \n     private String mTemplate;\n     private Map<String, String> mContext;\n \n-    private static String ALT_HANDLEBAR_DIRECTIVE = \"{{=<% %>=}}\";\n \n     private static String get_or_attr(Map<String, String> obj, String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d944e2182b73625dea2dc79d28c7b5794046b1ee"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c4bbcbbfd9b406448ac98a000e3f635a8153c79", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5c4bbcbbfd9b406448ac98a000e3f635a8153c79", "committedDate": "2020-05-14T21:27:04Z", "message": "LINT: add Nullable/NonNull annotations throughout Template\n\nThis pointed out that there was some dangerous variable passing in\nto methods that would have thrown NullPointerException in matchers\nor could violate their return contract - both patched up"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "209ac22f01792eaec278da917d8ce7ce1859c53f", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/209ac22f01792eaec278da917d8ce7ce1859c53f", "committedDate": "2020-05-14T21:01:01Z", "message": "LINT: add Nullable/NonNull annotations throughout Template"}, "afterCommit": {"oid": "5c4bbcbbfd9b406448ac98a000e3f635a8153c79", "author": {"user": {"login": "mikehardy", "name": "Mike Hardy"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5c4bbcbbfd9b406448ac98a000e3f635a8153c79", "committedDate": "2020-05-14T21:27:04Z", "message": "LINT: add Nullable/NonNull annotations throughout Template\n\nThis pointed out that there was some dangerous variable passing in\nto methods that would have thrown NullPointerException in matchers\nor could violate their return contract - both patched up"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3264, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}