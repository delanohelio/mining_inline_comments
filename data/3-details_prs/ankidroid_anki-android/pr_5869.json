{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NDM4OTc4", "number": 5869, "title": "CardBrowser: Multiple Selection Fixes", "bodyText": "Purpose / Description\nThe Card Browser could not display \"Select All\" and \"Select None\" at the same time\nThe Card Browser did not display \"Select All\" when no cards were selected\nWhen \"Select None\" was clicked, the browser remained in Multi-Select Mode\nWhen no cards are available, \"Select All\" should not be visible. Edited\nFixes\nFixes #5464\nApproach\nWe add in additional items in the layout:\n\nNew \"Select All\" in the unselected mode\nDifferentiate \"Select All\" and \"Select None\" in mutliselect mode.\n\nWe combine all previous state changes into a function which takes the current state into account, and sets the \"Selection Buttons\" to the correct states.\nHow Has This Been Tested?\nBoth on my device, and via unit test\n\n0 item deck\nNormal Decks\nDeleting cards so they become 0 item decks\nAdding items to 0 item decks\nMoving items out of 1 item decks\n\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-03-26T21:42:27Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5869", "merged": true, "mergeCommit": {"oid": "be0a768906af0b4a47b8078f78a51e01235d31dc"}, "closed": true, "closedAt": "2020-03-31T17:46:43Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRiMrggH2gAyMzk0NDM4OTc4OmE2ZTY5MzdhNjYxYmRhNmEyODViZDFmOTljNTk0Mjc0NmQ4NzU0NzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTGpZAgFqTM4NDk1Njk5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a6e6937a661bda6a285bd1f99c5942746d875471", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a6e6937a661bda6a285bd1f99c5942746d875471", "committedDate": "2020-03-26T20:33:25Z", "message": "NF: Add logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a9566c4c35d7905f9d65c966def7e6e323a7994", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1a9566c4c35d7905f9d65c966def7e6e323a7994", "committedDate": "2020-03-26T20:37:23Z", "message": "Extracted deckDropDownItemChanged to allow tests\n\nRoboelectric previously threw a StackOverflow due to an infinite loop\nin setting the position."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a702a61007980d3ff9cd0317dd36536d9ae9fade", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/a702a61007980d3ff9cd0317dd36536d9ae9fade", "committedDate": "2020-03-26T20:44:15Z", "message": "CardBrowser: Initial Unit Tests\n\nWe want to modify the card selection status, keep some initial tests\nwhich do not need to change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "694a60b49e1eeaa62182867998dffc51b6e6a89a", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/694a60b49e1eeaa62182867998dffc51b6e6a89a", "committedDate": "2020-03-26T20:48:06Z", "message": "Extract: hasSelectedAllCards"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbc08919bd4c64f1c2948ad43cec38ccf6f8aa44", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/dbc08919bd4c64f1c2948ad43cec38ccf6f8aa44", "committedDate": "2020-03-26T21:04:02Z", "message": "Add 'Select None' as well as 'Select All'\n\nThis allows both Select All and Select None to be displayed when some,\nbut not all cards are selected."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90553d435c5090984225d1c43892984929b95e34", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/90553d435c5090984225d1c43892984929b95e34", "committedDate": "2020-03-26T21:05:02Z", "message": "NF: mActionBarMenu is nullable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7470546741628e215c1f75072996a8260a3e06a5", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7470546741628e215c1f75072996a8260a3e06a5", "committedDate": "2020-03-26T21:47:40Z", "message": "Add \"Select All\" to Browser when in Single Select\n\nFixes #5464\n\nConsolidates state update for selection updates to onSelectionChanged()\n\nAdds \"Select All\" to the single-select screen which uses the same\nmechanism and same ID as the multiselect \"Select All\"\n\nThis also removes the state where clicking \"Select None\" moves the user\nto a multiselect with no items selected."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39925d2fdb85c046e7ac2b9535f31d1893cb7497", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/39925d2fdb85c046e7ac2b9535f31d1893cb7497", "committedDate": "2020-03-26T21:38:12Z", "message": "Add \"Select All\" to Browser when in Single Select\n\nFixes #5464\n\nConsolidates state update for selection updates to onSelectionChanged()\n\nAdds \"Select All\" to the single-select screen which uses the same\nmechanism and same ID as the multiselect \"Select All\"\n\nThis also removes the state where clicking \"Select None\" moves the user\nto a multiselect with no items selected."}, "afterCommit": {"oid": "7470546741628e215c1f75072996a8260a3e06a5", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7470546741628e215c1f75072996a8260a3e06a5", "committedDate": "2020-03-26T21:47:40Z", "message": "Add \"Select All\" to Browser when in Single Select\n\nFixes #5464\n\nConsolidates state update for selection updates to onSelectionChanged()\n\nAdds \"Select All\" to the single-select screen which uses the same\nmechanism and same ID as the multiselect \"Select All\"\n\nThis also removes the state where clicking \"Select None\" moves the user\nto a multiselect with no items selected."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDQ2NzQx", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#pullrequestreview-382446741", "createdAt": "2020-03-26T21:51:08Z", "commit": {"oid": "7470546741628e215c1f75072996a8260a3e06a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMTo1MTowOVrOF8bz-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMTo1MTowOVrOF8bz-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkxNDU1NQ==", "bodyText": "performed in onSelectionChanged", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r398914555", "createdAt": "2020-03-26T21:51:09Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -717,7 +721,6 @@ public void onClick(View v) {\n             // multi-select mode\n             getMenuInflater().inflate(R.menu.card_browser_multiselect, menu);\n             showBackIcon();\n-            updateMultiselectMenu();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7470546741628e215c1f75072996a8260a3e06a5"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDQ3MTY1", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#pullrequestreview-382447165", "createdAt": "2020-03-26T21:51:58Z", "commit": {"oid": "7470546741628e215c1f75072996a8260a3e06a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMTo1MTo1OFrOF8b1gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMTo1MTo1OFrOF8b1gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkxNDk0Ng==", "bodyText": "updateCardsInList -> updateList -> onSelectionChanged", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r398914946", "createdAt": "2020-03-26T21:51:58Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1438,7 +1463,6 @@ private void removeNotesView(Card[] cards) {\n         protected void actualPostExecute(DeckTask.TaskData result) {\n             Card[] cards = (Card[]) result.getObjArray();\n             updateCardsInList(Arrays.asList(cards), null);\n-            updateMultiselectMenu();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7470546741628e215c1f75072996a8260a3e06a5"}, "originalPosition": 118}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDQ3NTg4", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#pullrequestreview-382447588", "createdAt": "2020-03-26T21:52:46Z", "commit": {"oid": "7470546741628e215c1f75072996a8260a3e06a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMTo1Mjo0NlrOF8b2vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMTo1Mjo0NlrOF8b2vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkxNTI2Mw==", "bodyText": "This button had two purposes, we split it into onSelectAll and onSelectNone", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r398915263", "createdAt": "2020-03-26T21:52:46Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1798,28 +1821,47 @@ private void onCheck(int position, View cell) {\n             mCheckedCardPositions.remove(position);\n         }\n \n-        updateMultiselectMenu();\n+       onSelectionChanged();\n+    }\n \n-        if (mCheckedCardPositions.isEmpty()) {\n-            // when 0 are selected: end selection mode\n-            endMultiSelectMode();\n-        } else {\n-            mActionBarTitle.setText(Integer.toString(mCheckedCardPositions.size()));\n+    private void onSelectAll() {\n+        for (int i = 0; i < mCards.size(); i++) {\n+            mCheckedCardPositions.add(i);\n         }\n+        onSelectionChanged();\n     }\n \n-    private void onCheckAll() {\n-        boolean all = mCheckedCardPositions.size() < getCards().size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7470546741628e215c1f75072996a8260a3e06a5"}, "originalPosition": 151}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNDU4NzIz", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#pullrequestreview-383458723", "createdAt": "2020-03-29T21:43:45Z", "commit": {"oid": "dbc08919bd4c64f1c2948ad43cec38ccf6f8aa44"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQyMTo0Mzo0NVrOF9VZnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQyMTo0Mzo0NVrOF9VZnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTg1ODA3Nw==", "bodyText": "I've seen in one other place that async tasks are sometimes working on CardBrowser member variables, and a clear causes NPEs and ConcurrentModExceptions - how would you feel about changing this from .clear() to creating a new empty object? Feels like a defensive programming improvement to me", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#discussion_r399858077", "createdAt": "2020-03-29T21:43:45Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1825,20 +1830,25 @@ private void onCheck(int position, View cell) {\n         }\n     }\n \n-    private void onCheckAll() {\n-        boolean all = mCheckedCardPositions.size() < getCards().size();\n-        if (all) {\n-            for (int i = 0; i < mCards.size(); i++) {\n-                mCheckedCardPositions.add(i);\n-            }\n-        } else {\n-            mCheckedCardPositions.clear();\n+    private void onSelectAll() {\n+        for (int i = 0; i < mCards.size(); i++) {\n+            mCheckedCardPositions.add(i);\n         }\n+        onSelectionChanged();\n+    }\n+\n+    private void onSelectNone() {\n+        mCheckedCardPositions.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbc08919bd4c64f1c2948ad43cec38ccf6f8aa44"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22040be74f19eeec20546c0ed4424929c0658052", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/22040be74f19eeec20546c0ed4424929c0658052", "committedDate": "2020-03-30T01:31:18Z", "message": "Made CheckedCardPositions concurrent\n\nAs it's accessed via an AsyncTask."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94c58b4fe3a57b27c40ff872c3625b6058bcac3c", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/94c58b4fe3a57b27c40ff872c3625b6058bcac3c", "committedDate": "2020-03-31T15:19:44Z", "message": "Make getSelectedCardIds thread safe"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTU2OTk5", "url": "https://github.com/ankidroid/Anki-Android/pull/5869#pullrequestreview-384956999", "createdAt": "2020-03-31T17:35:18Z", "commit": {"oid": "94c58b4fe3a57b27c40ff872c3625b6058bcac3c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3560, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}