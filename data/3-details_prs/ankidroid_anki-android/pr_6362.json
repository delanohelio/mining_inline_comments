{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MDY5NDc3", "number": 6362, "title": "Improve Card Browser Performance: Time to view first card", "bodyText": "This is a follow up of today's PR. It's actually based on a merge of them.\nIt does no computation in finder. It computes values for card shown and the few context lines only.\nI was expecting to make smaller PR, but this answer #6358 (comment)\nThis was tested by merging it in my \"merge\" branch, which I run on my phone and just using the browser", "createdAt": "2020-06-04T20:26:17Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6362", "merged": true, "mergeCommit": {"oid": "d98f55f399b7e718f15623a8af1c566b6deb0bf6"}, "closed": true, "closedAt": "2020-06-05T16:18:07Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoEhZUgFqTQyNDgxODYwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoVG26gFqTQyNTQ0MjYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0ODE4NjA3", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#pullrequestreview-424818607", "createdAt": "2020-06-04T20:51:57Z", "commit": {"oid": "3b638b1e5356ea1642c12d14b517aec3b13c5c67"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMDo1MTo1N1rOGfXWPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMDo1NzowOFrOGfXhPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0MTU2NQ==", "bodyText": "You can remove this comment now", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435541565", "createdAt": "2020-06-04T20:51:57Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Finder.java", "diffHunk": "@@ -1003,81 +998,4 @@ public static Integer ordForMid(Collection col, Map<Long, Integer> fields, long\n      * The methods below are not in LibAnki.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b638b1e5356ea1642c12d14b517aec3b13c5c67"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0MjUyMA==", "bodyText": "Nit: Could you move to the top of the class and fix the spacing around the  =", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435542520", "createdAt": "2020-06-04T20:53:41Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1481,7 +1481,9 @@ public void onClick(View v) {\n         }\n     };\n \n-    public static void updateSearchItemQA(Context context, Map<String, String> item, Card c) {\n+    private static Pattern sMarkedPattern= Pattern.compile(\".*[Mm]arked.*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b638b1e5356ea1642c12d14b517aec3b13c5c67"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0Mzc1OQ==", "bodyText": "Further performance: Tags.join should be static", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435543759", "createdAt": "2020-06-04T20:56:01Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1531,6 +1534,13 @@ public static void updateSearchItemQA(Context context, Map<String, String> item,\n         item.put(NOTE, c.model().optString(\"name\"));\n         item.put(QUESTION, formatQA(q, context));\n         item.put(REVIEWS, Integer.toString(c.getReps()));\n+        String tags = note.stringTags();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b638b1e5356ea1642c12d14b517aec3b13c5c67"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NDM4Mg==", "bodyText": "I don't get new Integer().toString() - is this validation as it'll throw otherwise?", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435544382", "createdAt": "2020-06-04T20:57:08Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/CardBrowser.java", "diffHunk": "@@ -1531,6 +1534,13 @@ public static void updateSearchItemQA(Context context, Map<String, String> item,\n         item.put(NOTE, c.model().optString(\"name\"));\n         item.put(QUESTION, formatQA(q, context));\n         item.put(REVIEWS, Integer.toString(c.getReps()));\n+        String tags = note.stringTags();\n+        item.put(TAGS, tags);\n+        item.put(MARKED, (sMarkedPattern.matcher(item.get(TAGS)).matches())?\"marked\": null);\n+        item.put(FLAGS, (new Integer(c.getUserFlag())).toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b638b1e5356ea1642c12d14b517aec3b13c5c67"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0ODI3MDcw", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#pullrequestreview-424827070", "createdAt": "2020-06-04T21:02:32Z", "commit": {"oid": "3b638b1e5356ea1642c12d14b517aec3b13c5c67"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMTowMjozMlrOGfXrtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMTowMjozMlrOGfXrtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU0NzA2MQ==", "bodyText": "Would be nice to Timber.d the count", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#discussion_r435547061", "createdAt": "2020-06-04T21:02:32Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/async/CollectionTask.java", "diffHunk": "@@ -895,11 +895,17 @@ private TaskData doInBackgroundSearchCards(TaskData... params) {\n         String query = (String) params[0].getObjArray()[0];\n         Boolean order = (Boolean) params[0].getObjArray()[1];\n         int numCardsToRender = (int) params[0].getObjArray()[2];\n-        List<Map<String,String>> searchResult = col.findCardsForCardBrowser(query, order);\n+        List<Long> searchResult_ = col.findCards(query, order);\n+        List<Map<String,String>> searchResult = new ArrayList<>(searchResult_.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b638b1e5356ea1642c12d14b517aec3b13c5c67"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b638b1e5356ea1642c12d14b517aec3b13c5c67", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3b638b1e5356ea1642c12d14b517aec3b13c5c67", "committedDate": "2020-06-04T20:17:11Z", "message": "NF: Remove unused _queryForCardBrowser"}, "afterCommit": {"oid": "fb983f23d1bdd251c2d5c8e28e1970ef5cbc0571", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fb983f23d1bdd251c2d5c8e28e1970ef5cbc0571", "committedDate": "2020-06-04T22:02:10Z", "message": "Timber size of result of search"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb983f23d1bdd251c2d5c8e28e1970ef5cbc0571", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/fb983f23d1bdd251c2d5c8e28e1970ef5cbc0571", "committedDate": "2020-06-04T22:02:10Z", "message": "Timber size of result of search"}, "afterCommit": {"oid": "19a0e6bcff769fb2a79b4b0350d28774b7ceb335", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/19a0e6bcff769fb2a79b4b0350d28774b7ceb335", "committedDate": "2020-06-04T23:00:59Z", "message": "Timber size of result of search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "783609ad81e5b933cd8b93bdc4a5d8ed0596029e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/783609ad81e5b933cd8b93bdc4a5d8ed0596029e", "committedDate": "2020-06-05T11:30:27Z", "message": "checking which cards are marked is moved to CardBrowser\n\nCurrently, asking the browser to show the whole collection takes\nmultiple minutes. On a smaller deck, it takes 40 seconds, out of which\n15 are spent executing the regexp and looking for marked cards.\n\nMoving it to updateSearchItemQA ensure it is executed only for card we\nintend to display and save most of this time.\n\nSince \"marked\" is computed later, the color of the browser line is\ncomputed at the same time than the text, instead of being\npre-computed. So it makes the following difference:\n* before this commit, all lines are directly colored\n* after this commit, if you scroll quickly, all lines are white and\n  they become colored at the moment when they get their text.\n\n(To be even more precise, the text is filled or not depending on the\ncolumns. \"sort field\" is always filled while \"question\" is filled only\nafter the line appear on screen.)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4570aeb1e44bd78877deee85d0b82019f355d1fb", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4570aeb1e44bd78877deee85d0b82019f355d1fb", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: compile pattern for marked cards"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f3377f414da2c71ef50b87b1b6c209d0c8b2945", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7f3377f414da2c71ef50b87b1b6c209d0c8b2945", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: Finder._where is private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e276fc2272e917b7fec775761eda846b8f387fb", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3e276fc2272e917b7fec775761eda846b8f387fb", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: unused findCardsForCardBrowser with String"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6306e410f54d38069690d0bf7f784bbe853b3797", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6306e410f54d38069690d0bf7f784bbe853b3797", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: findCardsForCardBrowser removes an useless indirection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c675255c2dd305af7da3b6d8730de04c9684ef91", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c675255c2dd305af7da3b6d8730de04c9684ef91", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: remove useless findCards"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f884e785d57513c684fa992df32dcd234078a385", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/f884e785d57513c684fa992df32dcd234078a385", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: move computation of flag string to card browser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a178ba8419c9ca4da29fecd639f2e00c0ba141c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4a178ba8419c9ca4da29fecd639f2e00c0ba141c", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: add variable note in updateSearchItemQA"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba3088dca4876c86e1feb0f0335ce8b218bbafac", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ba3088dca4876c86e1feb0f0335ce8b218bbafac", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: tags put in cardbrowser and not finder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "654b5f00e2da527c2dea394210524cdce275a9ce", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/654b5f00e2da527c2dea394210524cdce275a9ce", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: move suspended to cardbrowser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6e96b8a762942a18b24787a4ec3e91d6070479b", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/e6e96b8a762942a18b24787a4ec3e91d6070479b", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: add col parameter to updateSearchItemQA"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d02c4af7f391992ac9ec3c7ed2d5e8113ad28f13", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d02c4af7f391992ac9ec3c7ed2d5e8113ad28f13", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: Deck name is put in card browser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db867c9006c24de3f8ad5ea0e6f68e35fe13e66c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/db867c9006c24de3f8ad5ea0e6f68e35fe13e66c", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: SFLD put in cardbrowser and not Finder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bec1daed99ac459f39a7ab311ea6b85565b9fe1", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/3bec1daed99ac459f39a7ab311ea6b85565b9fe1", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: remove place holders for Question/Answer\n\nSeems they are not checked anymore anyplace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00e1bb835fd81d304cb4c709947e480725fe8bca", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/00e1bb835fd81d304cb4c709947e480725fe8bca", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: find cards with boolean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8293ad235b65d93695ed4d8eeb1b4b421d8c2d56", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8293ad235b65d93695ed4d8eeb1b4b421d8c2d56", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: uses findCards and not forCardBrowser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57fc520792964beb32dbd95761f30a48f2e39a4", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/d57fc520792964beb32dbd95761f30a48f2e39a4", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: remove unused findCardsForCardBrowser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "085b1b0fcd928f4417b784d6874a51fcfbf26d25", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/085b1b0fcd928f4417b784d6874a51fcfbf26d25", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: remove unused findCardsForCardBrowser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baa0ac4c03547dec5b71c44cf30a88b79cac434a", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/baa0ac4c03547dec5b71c44cf30a88b79cac434a", "committedDate": "2020-06-05T11:30:27Z", "message": "NF: Remove unused _queryForCardBrowser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19a0e6bcff769fb2a79b4b0350d28774b7ceb335", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/19a0e6bcff769fb2a79b4b0350d28774b7ceb335", "committedDate": "2020-06-04T23:00:59Z", "message": "Timber size of result of search"}, "afterCommit": {"oid": "7fccc05cde4e26216a73054bd61bd5278c507f6d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7fccc05cde4e26216a73054bd61bd5278c507f6d", "committedDate": "2020-06-05T14:34:04Z", "message": "NF: use enum for column"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7fccc05cde4e26216a73054bd61bd5278c507f6d", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7fccc05cde4e26216a73054bd61bd5278c507f6d", "committedDate": "2020-06-05T14:34:04Z", "message": "NF: use enum for column"}, "afterCommit": {"oid": "2114aeedad26a5384d6d6a46289f72e405f8c9e9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2114aeedad26a5384d6d6a46289f72e405f8c9e9", "committedDate": "2020-06-05T14:55:29Z", "message": "NF: Integer.toString instead of new Integer().toString"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1Mzc4NDEy", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#pullrequestreview-425378412", "createdAt": "2020-06-05T14:58:51Z", "commit": {"oid": "2114aeedad26a5384d6d6a46289f72e405f8c9e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c47f1e596152a515866c87d7098d9d269709fea5", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/c47f1e596152a515866c87d7098d9d269709fea5", "committedDate": "2020-06-05T15:13:37Z", "message": "Timber size of result of search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daa3086e96b6ef50a1e526f126920025a2c28c6f", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/daa3086e96b6ef50a1e526f126920025a2c28c6f", "committedDate": "2020-06-05T15:13:37Z", "message": "NF: Integer.toString instead of new Integer().toString"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2114aeedad26a5384d6d6a46289f72e405f8c9e9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2114aeedad26a5384d6d6a46289f72e405f8c9e9", "committedDate": "2020-06-05T14:55:29Z", "message": "NF: Integer.toString instead of new Integer().toString"}, "afterCommit": {"oid": "daa3086e96b6ef50a1e526f126920025a2c28c6f", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/daa3086e96b6ef50a1e526f126920025a2c28c6f", "committedDate": "2020-06-05T15:13:37Z", "message": "NF: Integer.toString instead of new Integer().toString"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NDQyNjI0", "url": "https://github.com/ankidroid/Anki-Android/pull/6362#pullrequestreview-425442624", "createdAt": "2020-06-05T16:18:33Z", "commit": {"oid": "daa3086e96b6ef50a1e526f126920025a2c28c6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3131, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}