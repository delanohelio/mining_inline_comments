{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MTM2OTk1", "number": 5823, "title": "#5708 Fix Dynamic Deck with Options defined", "bodyText": "Purpose / Description\nA dynamic deck with conf (Deck Options) defined will crash the reviewer.\nA dynamic deck should not have deck options, therefore we want to remove them.\nFixes\nFixes #5708. But I'd either like to avoid closing the issue, or raise some other issues.\n\nWe can improve the exception thrown in the reviewer\nWe should try to track down how this happened: #5253\n\nApproach\nThis adds a task to \"Check Database\" to remove Deck Options from any dynamic decks.\nHow Has This Been Tested?\n\nForce Sync + Download corrupt collection\nSelect corrupt custom study deck and flip card (FAIL).\nSelect Check Database\nSelect same custom study deck and flip card (PASS)\n\nChecklist\n\n You have not changed whitespace unnecessarily (it makes diffs hard to read)\n You have a descriptive commit message with a short title (first line, max 50 chars).\n Your code follows the style of the project (e.g. never omit braces in if statements)\n You have commented your code, particularly in hard-to-understand areas\n You have performed a self-review of your own code", "createdAt": "2020-03-16T10:30:56Z", "url": "https://github.com/ankidroid/Anki-Android/pull/5823", "merged": true, "mergeCommit": {"oid": "cdc55efcd087d4d11362e6f869af65908bf2a953"}, "closed": true, "closedAt": "2020-03-18T20:37:25Z", "author": {"login": "david-allison-1"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOLmD4gFqTM3NTA4NjkxMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO8VWpgFqTM3NzE2NTEyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDg2OTEz", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#pullrequestreview-375086913", "createdAt": "2020-03-16T10:31:33Z", "commit": {"oid": "2198209fe3257ebe922f89faf699cf8b27c4767f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMDozMTozM1rOF2tzCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMDozMTozM1rOF2tzCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkxNzc3MA==", "bodyText": "Note: This is just used for logging, so it's fine to not internationalise.", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r392917770", "createdAt": "2020-03-16T10:31:33Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {\n+                    //#5708 - a dynamic deck should not have \"Deck Options\"\n+                    fixIntegrityProgress(progressCallback, currentTask++, totalTasks);\n+                    int fixCount = 0;\n+                    for (long id : mDecks.allDynamicDeckIds()) {\n+                        try {\n+                            if (mDecks.hasDeckOptions(id)) {\n+                                mDecks.removeDeckOptions(id);\n+                                fixCount++;\n+                            }\n+                        } catch (NoSuchDeckException e) {\n+                            Timber.e(\"Unable to find dynamic deck %d\", id);\n+                        }\n+                    }\n+                    if (fixCount > 0) {\n+                        mDecks.save();\n+                        problems.add(String.format(Locale.US, \"%d dynamic deck(s) had deck options.\", fixCount));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2198209fe3257ebe922f89faf699cf8b27c4767f"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDg3Mjcw", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#pullrequestreview-375087270", "createdAt": "2020-03-16T10:32:06Z", "commit": {"oid": "2198209fe3257ebe922f89faf699cf8b27c4767f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMDozMjowNlrOF2t0tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMDozMjowNlrOF2t0tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkxODE5Nw==", "bodyText": "This is fine to log and ignore", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r392918197", "createdAt": "2020-03-16T10:32:06Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {\n+                    //#5708 - a dynamic deck should not have \"Deck Options\"\n+                    fixIntegrityProgress(progressCallback, currentTask++, totalTasks);\n+                    int fixCount = 0;\n+                    for (long id : mDecks.allDynamicDeckIds()) {\n+                        try {\n+                            if (mDecks.hasDeckOptions(id)) {\n+                                mDecks.removeDeckOptions(id);\n+                                fixCount++;\n+                            }\n+                        } catch (NoSuchDeckException e) {\n+                            Timber.e(\"Unable to find dynamic deck %d\", id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2198209fe3257ebe922f89faf699cf8b27c4767f"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTE4NjY0", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#pullrequestreview-375118664", "createdAt": "2020-03-16T11:22:31Z", "commit": {"oid": "2198209fe3257ebe922f89faf699cf8b27c4767f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMToyMjozMVrOF2vnLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMToyMjozMVrOF2vnLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NzUwMg==", "bodyText": "This doesn't touch the database, jut marks it as dirty.", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r392947502", "createdAt": "2020-03-16T11:22:31Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {\n+                    //#5708 - a dynamic deck should not have \"Deck Options\"\n+                    fixIntegrityProgress(progressCallback, currentTask++, totalTasks);\n+                    int fixCount = 0;\n+                    for (long id : mDecks.allDynamicDeckIds()) {\n+                        try {\n+                            if (mDecks.hasDeckOptions(id)) {\n+                                mDecks.removeDeckOptions(id);\n+                                fixCount++;\n+                            }\n+                        } catch (NoSuchDeckException e) {\n+                            Timber.e(\"Unable to find dynamic deck %d\", id);\n+                        }\n+                    }\n+                    if (fixCount > 0) {\n+                        mDecks.save();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2198209fe3257ebe922f89faf699cf8b27c4767f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2633c445be7b99eff4e757ed91851f6e26b03e72", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2633c445be7b99eff4e757ed91851f6e26b03e72", "committedDate": "2020-03-18T15:37:59Z", "message": "#5708 Fix Dynamic Deck with Options defined\n\nA dynamic deck with \"conf\" (Deck Options) defined will crash the\nreviewer.\n\nThis adds a task to \"Check Database\" to remove Deck Options from any\ndynamic decks.\n\nWe also set CHECK_DB_AT_VERSION, so we automatically apply this fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2198209fe3257ebe922f89faf699cf8b27c4767f", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2198209fe3257ebe922f89faf699cf8b27c4767f", "committedDate": "2020-03-16T10:23:57Z", "message": "#5708 Fix Dynamic Deck with Options defined\n\nA dynamic deck with \"conf\" (Deck Options) defined will crash the\nreviewer.\n\nThis adds a task to \"Check Database\" to remove Deck Options from\nany dynamic decks."}, "afterCommit": {"oid": "2633c445be7b99eff4e757ed91851f6e26b03e72", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/2633c445be7b99eff4e757ed91851f6e26b03e72", "committedDate": "2020-03-18T15:37:59Z", "message": "#5708 Fix Dynamic Deck with Options defined\n\nA dynamic deck with \"conf\" (Deck Options) defined will crash the\nreviewer.\n\nThis adds a task to \"Check Database\" to remove Deck Options from any\ndynamic decks.\n\nWe also set CHECK_DB_AT_VERSION, so we automatically apply this fix."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MTEwOTE0", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#pullrequestreview-377110914", "createdAt": "2020-03-18T18:01:31Z", "commit": {"oid": "2633c445be7b99eff4e757ed91851f6e26b03e72"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxODowMTozMlrOF4Q1xQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxODowNjowMlrOF4RATA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MDQ4NQ==", "bodyText": "nit: should remove the counts from the comment as they will skew as they have now\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    int totalTasks = (mModels.all().size() * 4) + 21; // 4 things are in all-models loops, 20 things are one-offs\n          \n          \n            \n                    int totalTasks = (mModels.all().size() * 4) + 21; // a few fixes are in all-models loops, the rest are one-offs", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394540485", "createdAt": "2020-03-18T18:01:32Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1606,7 +1607,7 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n         ArrayList<String> problems = new ArrayList<>();\n         long oldSize = file.length();\n         int currentTask = 1;\n-        int totalTasks = (mModels.all().size() * 4) + 20; // 4 things are in all-models loops, 20 things are one-offs\n+        int totalTasks = (mModels.all().size() * 4) + 21; // 4 things are in all-models loops, 20 things are one-offs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2633c445be7b99eff4e757ed91851f6e26b03e72"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MTEzOA==", "bodyText": "\ud83e\udd26\u200d\u2642\ufe0f just did 50, next is 51 sorry\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final int CHECK_DB_AT_VERSION = 21000150;\n          \n          \n            \n                public static final int CHECK_DB_AT_VERSION = 21000151;", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394541138", "createdAt": "2020-03-18T18:02:38Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/anki/AnkiDroidApp.java", "diffHunk": "@@ -157,7 +157,7 @@\n      * collections being upgraded to (or after) this version must run an integrity check as it will contain fixes that\n      * all collections should have.\n      */\n-    public static final int CHECK_DB_AT_VERSION = 20900148;\n+    public static final int CHECK_DB_AT_VERSION = 21000150;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2633c445be7b99eff4e757ed91851f6e26b03e72"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MjU2OA==", "bodyText": "none of the other ones have their own block scope - they could maybe use a newline between each fix, but they don't have independent scopes", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394542568", "createdAt": "2020-03-18T18:04:59Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2633c445be7b99eff4e757ed91851f6e26b03e72"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU0MzE4MA==", "bodyText": "maybe dynDeckFixCount? - just a more specific name so I don't think of this as global fixes", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#discussion_r394543180", "createdAt": "2020-03-18T18:06:02Z", "author": {"login": "mikehardy"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1714,6 +1715,25 @@ public long fixIntegrity(DeckTask.ProgressCallback progressCallback) {\n                     problems.add(\"Fixed \" + ids.size() + \" card(s) with invalid properties.\");\n                     mDb.execute(\"update cards set odid=0, odue=0 where id in \" + Utils.ids2str(ids));\n                 }\n+                {\n+                    //#5708 - a dynamic deck should not have \"Deck Options\"\n+                    fixIntegrityProgress(progressCallback, currentTask++, totalTasks);\n+                    int fixCount = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2633c445be7b99eff4e757ed91851f6e26b03e72"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff70da6263e65b0e8fb97c1a74965828ef72b5af", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/ff70da6263e65b0e8fb97c1a74965828ef72b5af", "committedDate": "2020-03-18T18:28:26Z", "message": "Review: Fix comment\n\nCo-Authored-By: Mike Hardy <github@mikehardy.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d11418d667ab23ad7be4d1c9a2fd4fca0789bbc", "author": {"user": {"login": "david-allison-1", "name": "David Allison"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/6d11418d667ab23ad7be4d1c9a2fd4fca0789bbc", "committedDate": "2020-03-18T18:31:57Z", "message": "Fix DB Check version due to alpha upgrade\n\nCo-Authored-By: Mike Hardy <github@mikehardy.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MTY1MTI2", "url": "https://github.com/ankidroid/Anki-Android/pull/5823#pullrequestreview-377165126", "createdAt": "2020-03-18T19:18:39Z", "commit": {"oid": "6d11418d667ab23ad7be4d1c9a2fd4fca0789bbc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3514, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}