{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MjkxNzMz", "number": 7615, "title": "NF: uses parametrized query where possible", "bodyText": "They were found using\n= ?\" ?\\+", "createdAt": "2020-11-04T10:36:17Z", "url": "https://github.com/ankidroid/Anki-Android/pull/7615", "merged": true, "mergeCommit": {"oid": "5afdb30df7c421b0de3fb4403fe41e8b382a7fb6"}, "closed": true, "closedAt": "2020-11-06T16:29:04Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZZfoTgFqTUyMzg5MDkwMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ5jtUAFqTUyNTMwODI4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzODkwOTAx", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#pullrequestreview-523890901", "createdAt": "2020-11-05T02:55:31Z", "commit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMjo1NTozMVrOHtxwtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMzowMzoxN1rOHtx4vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc2MzI1Mw==", "bodyText": "Not for this PR, but a further improvement:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try (Cursor cursor = mCol.getDb().getDatabase().query(\"SELECT * FROM cards WHERE id = ?\", new Object[]{mId})) {\n          \n          \n            \n                    try (Cursor cursor = mCol.getDb().query(\"SELECT * FROM cards WHERE id = ?\", mId)) {", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517763253", "createdAt": "2020-11-05T02:55:31Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Card.java", "diffHunk": "@@ -148,7 +148,7 @@ public Card(Collection col, Long id) {\n \n \n     public void load() {\n-        try (Cursor cursor = mCol.getDb().getDatabase().query(\"SELECT * FROM cards WHERE id = \" + mId, null)) {\n+        try (Cursor cursor = mCol.getDb().getDatabase().query(\"SELECT * FROM cards WHERE id = ?\", new Object[]{mId})) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc2Mzk2NA==", "bodyText": "Can you manually confirm that this is correct - we don't use .update() often", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517763964", "createdAt": "2020-11-05T02:58:09Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Card.java", "diffHunk": "@@ -241,7 +241,7 @@ public void flushSched() {\n         values.put(\"odid\", mODid);\n         values.put(\"did\", mDid);\n         // TODO: The update DB call sets mod=true. Verify if this is intended.\n-        mCol.getDb().update(\"cards\", values, \"id = \" + mId, null);\n+        mCol.getDb().update(\"cards\", values, \"id = ?\", new String[] {Long.toString(mId)});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc2NDE5Mw==", "bodyText": "execute accepts Object...", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517764193", "createdAt": "2020-11-05T02:59:04Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1595,14 +1595,14 @@ public CheckDatabaseResult fixIntegrity(CollectionTask.ProgressCallback progress\n         getDecks().flush();\n \n         mDb.execute(\"update cards \" +\n-                        \"set did = \" + nextDeckId + \", \" +\n+                        \"set did = ?, \" +\n                         \"odid = 0,\" +\n-                        \"mod = \" +  getTime().intTime() + \", \" +\n-                        \"usn = \" + usn() + \" \" +\n+                        \"mod = ?, \" +\n+                        \"usn = ? \" +\n                         \"where did in \" +\n                         Utils.ids2str(dynDeckIds) +\n                         \"and odid in \" +\n-                        Utils.ids2str(dynIdsAndZero));\n+                        Utils.ids2str(dynIdsAndZero), new Object[] {nextDeckId, getTime().intTime(), usn()});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc2NDI3Mw==", "bodyText": "ditto", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517764273", "createdAt": "2020-11-05T02:59:15Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1673,8 +1673,7 @@ public CheckDatabaseResult fixIntegrity(CollectionTask.ProgressCallback progress\n         notifyProgress.run();\n         if (ids.size() > 0) {\n             problems.add(\"Reviews had incorrect due date.\");\n-            mDb.execute(\"UPDATE cards SET due = \" + mSched.getToday() + \", ivl = 1, mod = \" +  getTime().intTime() +\n-                    \", usn = \" + usn() + \" WHERE id IN \" + Utils.ids2str(Utils.collection2Array(ids)));\n+            mDb.execute(\"UPDATE cards SET due = ?, ivl = 1, mod = ?, usn = ? WHERE id IN \" + Utils.ids2str(Utils.collection2Array(ids)), new Object[]{mSched.getToday(), getTime().intTime(), usn()});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc2NDMxNA==", "bodyText": "ditto", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517764314", "createdAt": "2020-11-05T02:59:23Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -1693,8 +1692,7 @@ public CheckDatabaseResult fixIntegrity(CollectionTask.ProgressCallback progress\n         Timber.d(\"fixNewCardDuePositionOverflow\");\n         // new cards can't have a due position > 32 bits\n         notifyProgress.run();\n-        mDb.execute(\"UPDATE cards SET due = 1000000, mod = \" + getTime().intTime() + \", usn = \" + usn()\n-                + \" WHERE due > 1000000 AND type = \" + Consts.CARD_TYPE_NEW);\n+        mDb.execute(\"UPDATE cards SET due = 1000000, mod = ?, usn = ? WHERE due > 1000000 AND type = \" + Consts.CARD_TYPE_NEW, new Object[]{getTime().intTime(), usn()});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc2NDM3Mw==", "bodyText": "unnecessary change", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517764373", "createdAt": "2020-11-05T02:59:34Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Finder.java", "diffHunk": "@@ -481,6 +481,7 @@ private String _findCardState(String val) {\n         } else if (\"due\".equals(val)) {\n             return \"(c.queue in (\" + Consts.QUEUE_TYPE_REV + \",\" + Consts.QUEUE_TYPE_DAY_LEARN_RELEARN + \") and c.due <= \" + mCol.getSched().getToday() +\n                     \") or (c.queue = \" + Consts.QUEUE_TYPE_LRN + \" and c.due <= \" + mCol.getSched().getDayCutoff() + \")\";\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc2NTE0NA==", "bodyText": "Add a comment - the code was easier to understand before", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517765144", "createdAt": "2020-11-05T03:02:31Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/SchedV2.java", "diffHunk": "@@ -1868,14 +1868,20 @@ public void emptyDyn(long did) {\n     // Overriden: other queue in V1\n     public void emptyDyn(long did, String lim) {\n         if (lim == null) {\n-            lim = \"did = \" + did;\n-        }\n-        mCol.log(mCol.getDb().queryLongList(\"select id from cards where \" + lim));\n+            mCol.log(mCol.getDb().queryLongList(\"select id from cards where did = ?\", did));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc2NTMwOQ==", "bodyText": "Consider reverting this - it makes the code harder to reason about.", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517765309", "createdAt": "2020-11-05T03:03:17Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/stats/Stats.java", "diffHunk": "@@ -435,8 +435,10 @@ private boolean calculateDue(AxisType type) {\n \n         String lim = \"\";// AND due - \" + mCol.getSched().getToday() + \" >= \" + start; // leave this out in order to show\n         // card too which were due the days before\n+        Object[] bindArgs = new Object[] {};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd54e7a383696fc3e268eab56cfadd18540764c9", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/bd54e7a383696fc3e268eab56cfadd18540764c9", "committedDate": "2020-11-04T10:29:11Z", "message": "NF: uses parametrized query where possible\n\nThey were found using\n```sql\n= ?\" ?\\+\n```"}, "afterCommit": {"oid": "7c1602886892d097bb442a7f7248233df2656d57", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/7c1602886892d097bb442a7f7248233df2656d57", "committedDate": "2020-11-05T04:47:49Z", "message": "NF: uses parametrized query where possible\n\nThey were found using\n```sql\n= ?\" ?\\+\n```"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTMzOTQ1", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#pullrequestreview-523933945", "createdAt": "2020-11-05T05:24:54Z", "commit": {"oid": "7c1602886892d097bb442a7f7248233df2656d57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNToyNDo1NFrOHtz-vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNToyNDo1NFrOHtz-vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzc5OTYxMg==", "bodyText": "IMO, This is adding too much complexity - I'd be tempted to move it back, unless emptyDyn() is on a critical path.", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517799612", "createdAt": "2020-11-05T05:24:54Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/sched/Sched.java", "diffHunk": "@@ -930,16 +930,24 @@ public void rebuildDyn(long did) {\n \n \n     @Override\n-    public void emptyDyn(long did, String lim) {\n-        if (lim == null) {\n-            lim = \"did = \" + did;\n-        }\n+    public void emptyDyn(String lim) {\n+        mCol.log(mCol.getDb().queryLongList(\"select id from cards where \" + lim));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c1602886892d097bb442a7f7248233df2656d57"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTM0NzE2", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#pullrequestreview-523934716", "createdAt": "2020-11-05T05:27:09Z", "commit": {"oid": "cbe51804a298353ba455478cfa549ac711afadd8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNToyNzowOVrOHt0BMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNToyNzowOVrOHt0BMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMDI0MA==", "bodyText": "Better as the original", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517800240", "createdAt": "2020-11-05T05:27:09Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Finder.java", "diffHunk": "@@ -108,7 +108,7 @@ public Finder(Collection col) {\n         boolean rev = res2.second;\n         String sql = _query(preds, order);\n         Timber.v(\"Search query '%s' is compiled as '%s'.\", query, sql);\n-        try (Cursor cur = mCol.getDb().getDatabase().query(sql, args)) {\n+        try (Cursor cur = mCol.getDb().query(sql, (Object[]) args)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbe51804a298353ba455478cfa549ac711afadd8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzOTM0NzYx", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#pullrequestreview-523934761", "createdAt": "2020-11-05T05:27:15Z", "commit": {"oid": "cbe51804a298353ba455478cfa549ac711afadd8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNToyNzoxNVrOHt0BTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwNToyNzozNFrOHt0BoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMDI2OQ==", "bodyText": "ditto", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517800269", "createdAt": "2020-11-05T05:27:15Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Finder.java", "diffHunk": "@@ -141,7 +141,7 @@ public Finder(Collection col) {\n             preds = \"(\" + preds + \")\";\n         }\n         String sql = \"select distinct(n.id) from cards c, notes n where c.nid=n.id and \" + preds;\n-        try (Cursor cur = mCol.getDb().getDatabase().query(sql, args)) {\n+        try (Cursor cur = mCol.getDb().query(sql, (Object[]) args)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbe51804a298353ba455478cfa549ac711afadd8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgwMDM1Mg==", "bodyText": "Is new Object[] needed here?", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#discussion_r517800352", "createdAt": "2020-11-05T05:27:34Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Finder.java", "diffHunk": "@@ -761,10 +761,10 @@ private String _findField(String field, String val) {\n             return null;\n         }\n         LinkedList<Long> nids = new LinkedList<>();\n-        try (Cursor cur = mCol.getDb().getDatabase().query(\n+        try (Cursor cur = mCol.getDb().query(\n                 \"select id, mid, flds from notes where mid in \" +\n                         Utils.ids2str(new LinkedList<>(mods.keySet())) +\n-                        \" and flds like ? escape '\\\\'\", new String[] {\"%\" + sqlVal + \"%\"})) {\n+                        \" and flds like ? escape '\\\\'\", new Object[] {\"%\" + sqlVal + \"%\"})) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbe51804a298353ba455478cfa549ac711afadd8"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbe51804a298353ba455478cfa549ac711afadd8", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/cbe51804a298353ba455478cfa549ac711afadd8", "committedDate": "2020-11-05T05:22:28Z", "message": "NF: query query"}, "afterCommit": {"oid": "4b5db42c7d5e0773bd118aec8af0d1e7662f6382", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4b5db42c7d5e0773bd118aec8af0d1e7662f6382", "committedDate": "2020-11-05T05:47:32Z", "message": "NF: query query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b5db42c7d5e0773bd118aec8af0d1e7662f6382", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/4b5db42c7d5e0773bd118aec8af0d1e7662f6382", "committedDate": "2020-11-05T05:47:32Z", "message": "NF: query query"}, "afterCommit": {"oid": "1b4665f1773ad2e94bc874270836ac1405bc3ffe", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1b4665f1773ad2e94bc874270836ac1405bc3ffe", "committedDate": "2020-11-06T11:49:35Z", "message": "NF: query query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaa576289554a7e0ee1337db25c1e8c15d1716aa", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/aaa576289554a7e0ee1337db25c1e8c15d1716aa", "committedDate": "2020-11-06T11:54:52Z", "message": "NF: uses parametrized query where possible\n\nThey were found using\n```sql\n= ?\" ?\\+\n```"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c07069088ded103325b068e8d44dd6d04e07d5c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5c07069088ded103325b068e8d44dd6d04e07d5c", "committedDate": "2020-11-06T11:54:56Z", "message": "NF: query query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b4665f1773ad2e94bc874270836ac1405bc3ffe", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/1b4665f1773ad2e94bc874270836ac1405bc3ffe", "committedDate": "2020-11-06T11:49:35Z", "message": "NF: query query"}, "afterCommit": {"oid": "5c07069088ded103325b068e8d44dd6d04e07d5c", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/5c07069088ded103325b068e8d44dd6d04e07d5c", "committedDate": "2020-11-06T11:54:56Z", "message": "NF: query query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzA4Mjgy", "url": "https://github.com/ankidroid/Anki-Android/pull/7615#pullrequestreview-525308282", "createdAt": "2020-11-06T16:28:56Z", "commit": {"oid": "5c07069088ded103325b068e8d44dd6d04e07d5c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3819, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}