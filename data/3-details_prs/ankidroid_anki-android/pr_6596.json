{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMzU1ODU2", "number": 6596, "title": "Deck tree check deal with name map", "bodyText": "It seems I totally forgot to ensure that _checkDeckTree change the\nname map. The main problem here being that it changes name using JSON\noperation and not the method rename. Actually, using rename would\nbe almost impossible, because rename would risk to raise an\nexception due to name duplication.\nInstead, I simply ensure that the map is created again when there is\nany error.\nThis should solve #6590 and also other potential error later.\nAs a side note, I am happy that I decided to raise an exception if\nbyName returns a deck with a wrong name. We would note have found it\notherwise, and it seems quite good to see it here\nTested by adding it to my \"merge\" deck and ensuring Ankidroid still works", "createdAt": "2020-06-30T23:34:58Z", "url": "https://github.com/ankidroid/Anki-Android/pull/6596", "merged": true, "mergeCommit": {"oid": "09f2c3ac639987e347e12282540cd06842c66fdf"}, "closed": true, "closedAt": "2020-07-01T04:01:48Z", "author": {"login": "Arthur-Milchior"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwe9P_AFqTQ0MDQ2ODYwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwfWZXABqjM1MDAxNzc5OTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDY4NjAz", "url": "https://github.com/ankidroid/Anki-Android/pull/6596#pullrequestreview-440468603", "createdAt": "2020-07-01T00:18:30Z", "commit": {"oid": "eda119bd5cec8c6da1850d8b39c958929803ee01"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDc1NTI4", "url": "https://github.com/ankidroid/Anki-Android/pull/6596#pullrequestreview-440475528", "createdAt": "2020-07-01T00:42:22Z", "commit": {"oid": "eda119bd5cec8c6da1850d8b39c958929803ee01"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMDo0MjoyMlrOGrTFOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwMDo0MjoyMlrOGrTFOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1NDU4Ng==", "bodyText": "Is Map<String, JSONObject nameMap> valid syntax?\nI'd have assumed Map<String, JSONObject> nameMap", "url": "https://github.com/ankidroid/Anki-Android/pull/6596#discussion_r448054586", "createdAt": "2020-07-01T00:42:22Z", "author": {"login": "david-allison-1"}, "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -468,11 +468,25 @@ public void update(JSONObject g) {\n         save();\n     }\n \n+    /** Recompute the name map. Most operation deal with updating the name map directly,\n+     * however, after a failed safety check, doing the whole computation is easier.*/\n+    private void resetNameMap() {\n+        HashMap<String, JSONObject> nameMap = new HashMap<>(mDecks.size());\n+        for (JSONObject deck: mDecks.values()) {\n+            nameMapAdd(deck.getString(\"name\"), deck, nameMap);\n+        }\n+        mNameMap = nameMap;\n+    }\n+\n     private void nameMapAdd(String name, JSONObject g) {\n-        mNameMap.put(name, g);\n+        nameMapAdd(name, g, mNameMap);\n+    }\n+\n+    private void nameMapAdd(String name, JSONObject g, Map<String, JSONObject nameMap>) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda119bd5cec8c6da1850d8b39c958929803ee01"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c313e8b12a391c0d10f6eecac2a5695a43bea8e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8c313e8b12a391c0d10f6eecac2a5695a43bea8e", "committedDate": "2020-07-01T00:45:50Z", "message": "Deck tree check deal with name map\n\nIt seems I totally forgot to ensure that `_checkDeckTree` change the\nname map. The main problem here being that it changes name using JSON\noperation and not the method `rename`. Actually, using `rename` would\nbe almost impossible, because `rename` would risk to raise an\nexception due to name duplication.\n\nInstead, I simply ensure that the map is created again when there is\nany error.\n\nThis should solve #6590 and also other potential error later.\n\nAs a side note, I am happy that I decided to raise an exception if\nbyName returns a deck with a wrong name. We would note have found it\notherwise, and it seems quite good to see it here"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eda119bd5cec8c6da1850d8b39c958929803ee01", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/eda119bd5cec8c6da1850d8b39c958929803ee01", "committedDate": "2020-06-30T23:30:10Z", "message": "Deck tree check deal with name map\n\nIt seems I totally forgot to ensure that `_checkDeckTree` change the\nname map. The main problem here being that it changes name using JSON\noperation and not the method `rename`. Actually, using `rename` would\nbe almost impossible, because `rename` would risk to raise an\nexception due to name duplication.\n\nInstead, I simply ensure that the map is created again when there is\nany error.\n\nThis should solve #6590 and also other potential error later.\n\nAs a side note, I am happy that I decided to raise an exception if\nbyName returns a deck with a wrong name. We would note have found it\notherwise, and it seems quite good to see it here"}, "afterCommit": {"oid": "8c313e8b12a391c0d10f6eecac2a5695a43bea8e", "author": {"user": {"login": "Arthur-Milchior", "name": "Arthur Milchior"}}, "url": "https://github.com/ankidroid/Anki-Android/commit/8c313e8b12a391c0d10f6eecac2a5695a43bea8e", "committedDate": "2020-07-01T00:45:50Z", "message": "Deck tree check deal with name map\n\nIt seems I totally forgot to ensure that `_checkDeckTree` change the\nname map. The main problem here being that it changes name using JSON\noperation and not the method `rename`. Actually, using `rename` would\nbe almost impossible, because `rename` would risk to raise an\nexception due to name duplication.\n\nInstead, I simply ensure that the map is created again when there is\nany error.\n\nThis should solve #6590 and also other potential error later.\n\nAs a side note, I am happy that I decided to raise an exception if\nbyName returns a deck with a wrong name. We would note have found it\notherwise, and it seems quite good to see it here"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3052, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}