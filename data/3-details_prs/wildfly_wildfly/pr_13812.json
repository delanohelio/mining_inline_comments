{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MzY4MjI4", "number": 13812, "title": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attribut\u2026", "bodyText": "\u2026es against the 1.0.0 and 2.0.0 model versions. Model version 2.0.0 was incorrectly used in WildFly 19, 20 and 21. An added system property was added to allow the transformers to be bypassed.\nhttps://issues.redhat.com/browse/WFLY-14210", "createdAt": "2020-12-11T00:38:13Z", "url": "https://github.com/wildfly/wildfly/pull/13812", "merged": true, "mergeCommit": {"oid": "768456b8840997839305f0187436a59c72d155c8"}, "closed": true, "closedAt": "2020-12-15T19:30:20Z", "author": {"login": "jamezp"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlNSsWgFqTU1MDUwOTI0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmNc8KAFqTU1MTk0NjEwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTA5MjQy", "url": "https://github.com/wildfly/wildfly/pull/13812#pullrequestreview-550509242", "createdAt": "2020-12-11T19:15:37Z", "commit": {"oid": "4be4fe3b8699184af128c4631ec4c80ac511f27c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxOToxNTozN1rOIEHPXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxOTozOToyOFrOIEIoRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE4MzgzNg==", "bodyText": "Since you went down the refactoring path I'm going to punish you. ;)\nj/k -- cleanup is good.\nThis class should no longer implement XMLElementWriter as it is never used as such.", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r541183836", "createdAt": "2020-12-11T19:15:37Z", "author": {"login": "bstansberry"}, "path": "jaxrs/src/main/java/org/jboss/as/jaxrs/JaxrsSubsystemParser_1_0.java", "diffHunk": "@@ -56,6 +58,6 @@ public void readElement(final XMLExtendedStreamReader reader, final List<ModelNo\n        */\n       @Override\n       public void writeContent(final XMLExtendedStreamWriter streamWriter, final SubsystemMarshallingContext context) throws XMLStreamException {\n-          context.startSubsystemElement(JaxrsExtension.NAMESPACE_1_0, true);\n+          context.startSubsystemElement(NAMESPACE, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4be4fe3b8699184af128c4631ec4c80ac511f27c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIwNjU5OQ==", "bodyText": "Something feels off here.\nAIUI we've actually had a \"3.0\" (imagine some air quotes) since WF 19, and it looks like we've had a proper 2.0 since some time in 2017. And now you're officially creating a proper 3.0.\nWe need transformation for hosts using 1.0 no matter what. We need the missing 3.0 -> 2.0 transformation unless the admin disabled it. If the admin disabled 3.0 -> 2.0 with the system property, then we must do 3.0 -> 1.0.\nMaybe rename registerTransformers_2_0_0 to registerTransformersFrom_3_0_0 and then make sure it's invoked no matter what. What differs is the target version provided to chainedBuilder.createBuilder.\nBTW I think names like registerTransformersFrom_3_0_0 are better in general. When I review these classes I usually waste time trying to figure out what these version # in these methods represents -- source or target.", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r541206599", "createdAt": "2020-12-11T19:39:28Z", "author": {"login": "bstansberry"}, "path": "jaxrs/src/main/java/org/jboss/as/jaxrs/JaxrsTransformers.java", "diffHunk": "@@ -45,12 +56,22 @@ public String getSubsystemName() {\n \n     @Override\n     public void registerTransformers(SubsystemTransformerRegistration subsystemRegistration) {\n-        registerTransformers_2_0_0(subsystemRegistration);\n+        if (!isByPassTransformers()) {\n+            ChainedTransformationDescriptionBuilder chainedBuilder =\n+                    TransformationDescriptionBuilder.Factory.createChainedSubystemInstance(subsystemRegistration.getCurrentSubsystemVersion());\n+\n+            //Differences between 3.0.0 and 2.0.0\n+            ResourceTransformationDescriptionBuilder builder200 =\n+                    chainedBuilder.createBuilder(subsystemRegistration.getCurrentSubsystemVersion(), MODEL_VERSION_2_0_0);\n+            registerTransformers_2_0_0(builder200);\n+\n+            //Create chained transformers.\n+            chainedBuilder.buildAndRegister(subsystemRegistration, new ModelVersion[] {MODEL_VERSION_2_0_0, MODEL_VERSION_1_0_0});\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4be4fe3b8699184af128c4631ec4c80ac511f27c"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTY0NTQ4", "url": "https://github.com/wildfly/wildfly/pull/13812#pullrequestreview-550564548", "createdAt": "2020-12-11T20:43:20Z", "commit": {"oid": "4be4fe3b8699184af128c4631ec4c80ac511f27c"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4be4fe3b8699184af128c4631ec4c80ac511f27c", "author": {"user": {"login": "jamezp", "name": "James R. Perkins"}}, "url": "https://github.com/wildfly/wildfly/commit/4be4fe3b8699184af128c4631ec4c80ac511f27c", "committedDate": "2020-12-11T00:36:13Z", "message": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attributes against the 1.0.0 and 2.0.0 model versions. Model version 2.0.0 was incorrectly used in WildFly 19, 20 and 21. An added system property was added to allow the transformers to be bypassed.\n\nhttps://issues.redhat.com/browse/WFLY-14210"}, "afterCommit": {"oid": "6c2904c8ab9bc3c2b95af33d01a29def9c58871f", "author": {"user": {"login": "jamezp", "name": "James R. Perkins"}}, "url": "https://github.com/wildfly/wildfly/commit/6c2904c8ab9bc3c2b95af33d01a29def9c58871f", "committedDate": "2020-12-14T16:34:13Z", "message": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attributes against the 1.0.0 and 2.0.0 model versions. Model version 2.0.0 was incorrectly used in WildFly 19, 20 and 21. An added system property was added to allow the transformers to be bypassed.\n\nhttps://issues.redhat.com/browse/WFLY-14210"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c", "author": {"user": {"login": "jamezp", "name": "James R. Perkins"}}, "url": "https://github.com/wildfly/wildfly/commit/6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c", "committedDate": "2020-12-14T16:36:22Z", "message": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attributes against the 1.0.0 and 2.0.0 model versions. Model version 2.0.0 was incorrectly used in WildFly 19, 20 and 21. An added system property was added to allow the transformers to be bypassed.\n\nhttps://issues.redhat.com/browse/WFLY-14210"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c2904c8ab9bc3c2b95af33d01a29def9c58871f", "author": {"user": {"login": "jamezp", "name": "James R. Perkins"}}, "url": "https://github.com/wildfly/wildfly/commit/6c2904c8ab9bc3c2b95af33d01a29def9c58871f", "committedDate": "2020-12-14T16:34:13Z", "message": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attributes against the 1.0.0 and 2.0.0 model versions. Model version 2.0.0 was incorrectly used in WildFly 19, 20 and 21. An added system property was added to allow the transformers to be bypassed.\n\nhttps://issues.redhat.com/browse/WFLY-14210"}, "afterCommit": {"oid": "6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c", "author": {"user": {"login": "jamezp", "name": "James R. Perkins"}}, "url": "https://github.com/wildfly/wildfly/commit/6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c", "committedDate": "2020-12-14T16:36:22Z", "message": "[WFLY-14210] Bump the jaxrs subsystems model version. Reject attributes against the 1.0.0 and 2.0.0 model versions. Model version 2.0.0 was incorrectly used in WildFly 19, 20 and 21. An added system property was added to allow the transformers to be bypassed.\n\nhttps://issues.redhat.com/browse/WFLY-14210"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNjE2NzE3", "url": "https://github.com/wildfly/wildfly/pull/13812#pullrequestreview-551616717", "createdAt": "2020-12-14T16:58:44Z", "commit": {"oid": "6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNjo1ODo0NFrOIFaYeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNjo1ODo0NFrOIFaYeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU0NjA0MQ==", "bodyText": "@kabir All of the above LGTM but can you confirm?", "url": "https://github.com/wildfly/wildfly/pull/13812#discussion_r542546041", "createdAt": "2020-12-14T16:58:44Z", "author": {"login": "bstansberry"}, "path": "jaxrs/src/main/java/org/jboss/as/jaxrs/JaxrsTransformers.java", "diffHunk": "@@ -45,12 +56,29 @@ public String getSubsystemName() {\n \n     @Override\n     public void registerTransformers(SubsystemTransformerRegistration subsystemRegistration) {\n-        registerTransformers_2_0_0(subsystemRegistration);\n+        final ModelVersion[] modelVersions;\n+        final ModelVersion target;\n+        if (isByPassTransformers()) {\n+            target = MODEL_VERSION_1_0_0;\n+            modelVersions = new ModelVersion[] {MODEL_VERSION_1_0_0};\n+        } else {\n+            target = MODEL_VERSION_2_0_0;\n+            modelVersions = new ModelVersion[] {MODEL_VERSION_2_0_0, MODEL_VERSION_1_0_0};\n+        }\n+        ChainedTransformationDescriptionBuilder chainedBuilder =\n+                TransformationDescriptionBuilder.Factory.createChainedSubystemInstance(subsystemRegistration.getCurrentSubsystemVersion());\n+\n+        // Differences between 3.0.0 and 2.0.0\n+        ResourceTransformationDescriptionBuilder builder300 =\n+                chainedBuilder.createBuilder(subsystemRegistration.getCurrentSubsystemVersion(), target);\n+        registerTransformers_3_0_0(builder300);\n+\n+        // Create chained transformers.\n+        chainedBuilder.buildAndRegister(subsystemRegistration, modelVersions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxOTQ2MTA5", "url": "https://github.com/wildfly/wildfly/pull/13812#pullrequestreview-551946109", "createdAt": "2020-12-14T22:26:44Z", "commit": {"oid": "6875cc33c0afc3c8d62f30c4a80907ee3c4f1a7c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3701, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}