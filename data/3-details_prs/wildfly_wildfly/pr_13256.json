{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNjU3NDcw", "number": 13256, "title": "[WFLY-5097] Session bean spec violation ...", "bodyText": "[WFLY-5097] : https://issues.redhat.com/browse/WFLY-5097", "createdAt": "2020-04-30T15:48:32Z", "url": "https://github.com/wildfly/wildfly/pull/13256", "merged": true, "mergeCommit": {"oid": "7b04ab783625fb5eaf1f051a81390f951196e254"}, "closed": true, "closedAt": "2020-05-29T00:05:28Z", "author": {"login": "panossot"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccyVIpAFqTQwMzgwNzgxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABciv1SbgBqjMzNTA1OTU0NTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzODA3ODEx", "url": "https://github.com/wildfly/wildfly/pull/13256#pullrequestreview-403807811", "createdAt": "2020-04-30T19:17:27Z", "commit": {"oid": "f35deab274f87b9a4d6a034158c3a0c9e70717ab"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOToxNzoyN1rOGO29SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOTozMzowNlrOGO3caA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzMzY3Mw==", "bodyText": "This is more efficiently stored as:\n    Map<Class<? extends Annotation>, Set<String>> ejbTypes = new IdentityHashMap<>();\n    ejbTypes.put(javax.ejb.Stateful.class, new HashSet<>());\n    ejbTypes.put(javax.ejb.Stateless.class, new HashSet<>());\n    ejbTypes.put(javax.ejb.Singleton.class, new HashSet<>());", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r418233673", "createdAt": "2020-04-30T19:17:27Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        HashMap<String,HashSet<String>> ejbClassTypes = new HashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f35deab274f87b9a4d6a034158c3a0c9e70717ab"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0MTYyNQ==", "bodyText": "Using the above data structure, this method is unnecessary.", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r418241625", "createdAt": "2020-04-30T19:33:04Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -274,6 +283,32 @@ private void logBinding(final StringBuilder jndiBindingsLogMessage, final String\n         jndiBindingsLogMessage.append(System.lineSeparator());\n     }\n \n+    private boolean checkBeanTypeSpecViolation(HashMap<String,HashSet<String>> ejbClassTypes, SessionBeanComponentDescription ejbComponentDescription) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f35deab274f87b9a4d6a034158c3a0c9e70717ab"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0MTY0MA==", "bodyText": "Using the above data structure, this spec violation check is simple:\nEJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\nString ejbClassName = ejbComponentDescription.getEJBClassName();\nif (ejbClassTypes.putIfAbsent(ejbClassName, ejbComponentDescription) == null) {\n    this.setupJNDIBindings(ejbComponentDescription, deploymentUnit);\n} else {\n    EjbLogger.DEPLOYMENT_LOGGER.typeSpecViolation(ejbClassName);\n}", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r418241640", "createdAt": "2020-04-30T19:33:06Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        HashMap<String,HashSet<String>> ejbClassTypes = new HashMap();\n+        ejbClassTypes.put(\"isStateful\",new HashSet<>());\n+        ejbClassTypes.put(\"isStateless\",new HashSet<>());\n+        ejbClassTypes.put(\"isSingleton\",new HashSet<>());\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    if(!checkBeanTypeSpecViolation(ejbClassTypes,(SessionBeanComponentDescription)componentDescription))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f35deab274f87b9a4d6a034158c3a0c9e70717ab"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f35deab274f87b9a4d6a034158c3a0c9e70717ab", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/f35deab274f87b9a4d6a034158c3a0c9e70717ab", "committedDate": "2020-04-30T15:44:29Z", "message": "[WFLY-5097] Session bean spec violation ..."}, "afterCommit": {"oid": "0a1738c258c5645197c2dc3037542382a5d51c8c", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/0a1738c258c5645197c2dc3037542382a5d51c8c", "committedDate": "2020-05-04T09:12:48Z", "message": "[WFLY-5097] Session bean spec violation ..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a1738c258c5645197c2dc3037542382a5d51c8c", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/0a1738c258c5645197c2dc3037542382a5d51c8c", "committedDate": "2020-05-04T09:12:48Z", "message": "[WFLY-5097] Session bean spec violation ..."}, "afterCommit": {"oid": "9d317d9ea07ee165eaf693da28e01e4777ec3e9c", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/9d317d9ea07ee165eaf693da28e01e4777ec3e9c", "committedDate": "2020-05-05T08:25:35Z", "message": "[WFLY-5097] Session bean spec violation ..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d317d9ea07ee165eaf693da28e01e4777ec3e9c", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/9d317d9ea07ee165eaf693da28e01e4777ec3e9c", "committedDate": "2020-05-05T08:25:35Z", "message": "[WFLY-5097] Session bean spec violation ..."}, "afterCommit": {"oid": "c29c837cc080df91e20f436d37dc88bae0d88067", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/c29c837cc080df91e20f436d37dc88bae0d88067", "committedDate": "2020-05-05T09:29:56Z", "message": "[WFLY-5097] Session bean spec violation ..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c29c837cc080df91e20f436d37dc88bae0d88067", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/c29c837cc080df91e20f436d37dc88bae0d88067", "committedDate": "2020-05-05T09:29:56Z", "message": "[WFLY-5097] Session bean spec violation ..."}, "afterCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/4749a30b879bf7bacf49deb9a8a802b72cc26377", "committedDate": "2020-05-05T09:55:42Z", "message": "[WFLY-5097] Session bean spec violation ..."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NzEzNTc0", "url": "https://github.com/wildfly/wildfly/pull/13256#pullrequestreview-405713574", "createdAt": "2020-05-05T11:50:56Z", "commit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTo1MDo1NlrOGQl0GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTo1MDo1NlrOGQl0GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0OTk0NA==", "bodyText": "I don't understand the need for these other conditions.  An EJB class name should only ever have 1 ejb component description (regardless of it's type).  Consequently, a simple putIfAbsent should be all that is needed to ensure there are not multiple type declarations.\nTo me, these other checks look redundant.  Am I missing something?", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420049944", "createdAt": "2020-05-05T11:50:56Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        Map<String, EJBComponentDescription> ejbClassTypeDefined = new HashMap<>();\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    EJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\n+                    String ejbClassName = ejbComponentDescription.getEJBClassName();\n+                    if ((ejbClassTypeDefined.putIfAbsent(ejbClassName,ejbComponentDescription) == null || !((ejbClassTypeDefined.get(ejbClassName).isSingleton() && (ejbComponentDescription.isStateful() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateful() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateless() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateful()))))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/4749a30b879bf7bacf49deb9a8a802b72cc26377", "committedDate": "2020-05-05T09:55:42Z", "message": "[WFLY-5097] Session bean spec violation ..."}, "afterCommit": {"oid": "432b22b3cde786b679d1b852fea1d00939c60f36", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/432b22b3cde786b679d1b852fea1d00939c60f36", "committedDate": "2020-05-05T13:28:27Z", "message": "[WFLY-5097] Session bean spec violation ..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "432b22b3cde786b679d1b852fea1d00939c60f36", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/432b22b3cde786b679d1b852fea1d00939c60f36", "committedDate": "2020-05-05T13:28:27Z", "message": "[WFLY-5097] Session bean spec violation ..."}, "afterCommit": {"oid": "a59de3d694b25e88c595b34d5c1a0a960ebbd35c", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/a59de3d694b25e88c595b34d5c1a0a960ebbd35c", "committedDate": "2020-05-06T14:19:30Z", "message": "[WFLY-5097] Session bean spec violation ..."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2ODY1MjM4", "url": "https://github.com/wildfly/wildfly/pull/13256#pullrequestreview-406865238", "createdAt": "2020-05-06T18:10:16Z", "commit": {"oid": "a59de3d694b25e88c595b34d5c1a0a960ebbd35c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxMDoxNlrOGRfUFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxMDoxNlrOGRfUFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5MjAyMA==", "bodyText": "violetion should read violation\nSessionBeans should read Session EJBs", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420992020", "createdAt": "2020-05-06T18:10:16Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/logging/EjbLogger.java", "diffHunk": "@@ -3204,4 +3204,8 @@\n     @LogMessage(level = WARN)\n     @Message(id = 515, value = \"[EJB3.2 spec, section 4.9.2] Singleton session beans are not allowed to implement 'javax.ejb.SessionBean' interface. This interface on bean '%s' is going to be ignored and should be removed.\")\n     void singletonCantImplementSessionBean(String className);\n+\n+    @LogMessage(level = ERROR)\n+    @Message(id = 517, value = \"[EJB3.2 spec, section 4.1] Spec violetion for class %s. SessionBeans should have only one of the following types : Stateful, Stateless, Singleton.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a59de3d694b25e88c595b34d5c1a0a960ebbd35c"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a59de3d694b25e88c595b34d5c1a0a960ebbd35c", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/a59de3d694b25e88c595b34d5c1a0a960ebbd35c", "committedDate": "2020-05-06T14:19:30Z", "message": "[WFLY-5097] Session bean spec violation ..."}, "afterCommit": {"oid": "0ebac8324807869f493e0b4a32b205c485fff4ac", "author": {"user": null}, "url": "https://github.com/wildfly/wildfly/commit/0ebac8324807869f493e0b4a32b205c485fff4ac", "committedDate": "2020-05-06T18:18:50Z", "message": "[WFLY-5097] Session bean spec violation ..."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MDEyNzU3", "url": "https://github.com/wildfly/wildfly/pull/13256#pullrequestreview-407012757", "createdAt": "2020-05-06T21:50:26Z", "commit": {"oid": "0ebac8324807869f493e0b4a32b205c485fff4ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7c891d336f13efcadbb97845f94026f9b4130c0", "author": {"user": {"login": "panossot", "name": "Panagiotis Sotiropoulos"}}, "url": "https://github.com/wildfly/wildfly/commit/a7c891d336f13efcadbb97845f94026f9b4130c0", "committedDate": "2020-05-19T07:11:53Z", "message": "Merge branch 'master' into specviolation"}, "afterCommit": {"oid": "16838a596d4fb6715d0d56a4697a5e39580178b5", "author": {"user": {"login": "panossot", "name": "Panagiotis Sotiropoulos"}}, "url": "https://github.com/wildfly/wildfly/commit/16838a596d4fb6715d0d56a4697a5e39580178b5", "committedDate": "2020-05-19T07:17:24Z", "message": "[WFLY-5097] Session bean spec violation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83b28cca08f906b7a50d947bef11070a3255b7e3", "author": {"user": {"login": "panossot", "name": "Panagiotis Sotiropoulos"}}, "url": "https://github.com/wildfly/wildfly/commit/83b28cca08f906b7a50d947bef11070a3255b7e3", "committedDate": "2020-05-19T07:48:58Z", "message": "[WFLY-5097] : Session bean spec violation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ffbe6d0ed801d25a01113282794c34bbcae0f19", "author": {"user": {"login": "panossot", "name": "Panagiotis Sotiropoulos"}}, "url": "https://github.com/wildfly/wildfly/commit/3ffbe6d0ed801d25a01113282794c34bbcae0f19", "committedDate": "2020-05-19T07:39:11Z", "message": "Update EjbLogger.java"}, "afterCommit": {"oid": "83b28cca08f906b7a50d947bef11070a3255b7e3", "author": {"user": {"login": "panossot", "name": "Panagiotis Sotiropoulos"}}, "url": "https://github.com/wildfly/wildfly/commit/83b28cca08f906b7a50d947bef11070a3255b7e3", "committedDate": "2020-05-19T07:48:58Z", "message": "[WFLY-5097] : Session bean spec violation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3545, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}