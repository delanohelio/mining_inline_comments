{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUyNzIzMjY3", "number": 13415, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjowODowNlrOEQ0Guw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjozMjo1MFrOEQ0g5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDY2MzYzOnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3AsyncResourceDefinition.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjowODowNlrOG1Lj9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMDowMToyN1rOG2ffYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxNzE0Mw==", "bodyText": "This one doesn't seem dynamic as there's only 1 instance of this resource with a fixed name.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r458417143", "createdAt": "2020-07-21T22:08:06Z", "author": {"login": "bstansberry"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3AsyncResourceDefinition.java", "diffHunk": "@@ -28,30 +28,44 @@\n import org.jboss.as.controller.SimpleAttributeDefinition;\n import org.jboss.as.controller.SimpleAttributeDefinitionBuilder;\n import org.jboss.as.controller.SimpleResourceDefinition;\n+import org.jboss.as.controller.capability.RuntimeCapability;\n import org.jboss.as.controller.registry.AttributeAccess;\n import org.jboss.as.controller.registry.ManagementResourceRegistration;\n+import org.jboss.as.threads.ThreadsServices;\n import org.jboss.dmr.ModelType;\n \n+import java.util.concurrent.ExecutorService;\n+\n /**\n  * A {@link org.jboss.as.controller.ResourceDefinition} for the EJB async service\n  * <p/>\n  * @author Stuart Douglas\n  */\n public class EJB3AsyncResourceDefinition extends SimpleResourceDefinition {\n \n+    // this is an unregistered copy of the capability defined and registered in /subsystem=ejb3/thread-pool=*\n+    // needed due to the unorthodox way in which the thread pools are defined in ejb3 subsystem\n+    protected static final String THREAD_POOL_CAPABILITY_NAME = ThreadsServices.createCapability(EJB3SubsystemModel.BASE_EJB_THREAD_POOL_NAME, ExecutorService.class).getName();\n+\n+    public static final String ASYNC_SERVICE_CAPABILITY_NAME = \"org.wildfly.ejb3.async\";\n+    public static final RuntimeCapability<Void> ASYNC_SERVICE_CAPABILITY =\n+            RuntimeCapability.Builder.of(ASYNC_SERVICE_CAPABILITY_NAME, true).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5999392b9dd6c9d34449a6cf0ef869d6b88b522"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5MjIyNA==", "bodyText": "Done.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r459792224", "createdAt": "2020-07-24T00:01:27Z", "author": {"login": "rachmatowicz"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3AsyncResourceDefinition.java", "diffHunk": "@@ -28,30 +28,44 @@\n import org.jboss.as.controller.SimpleAttributeDefinition;\n import org.jboss.as.controller.SimpleAttributeDefinitionBuilder;\n import org.jboss.as.controller.SimpleResourceDefinition;\n+import org.jboss.as.controller.capability.RuntimeCapability;\n import org.jboss.as.controller.registry.AttributeAccess;\n import org.jboss.as.controller.registry.ManagementResourceRegistration;\n+import org.jboss.as.threads.ThreadsServices;\n import org.jboss.dmr.ModelType;\n \n+import java.util.concurrent.ExecutorService;\n+\n /**\n  * A {@link org.jboss.as.controller.ResourceDefinition} for the EJB async service\n  * <p/>\n  * @author Stuart Douglas\n  */\n public class EJB3AsyncResourceDefinition extends SimpleResourceDefinition {\n \n+    // this is an unregistered copy of the capability defined and registered in /subsystem=ejb3/thread-pool=*\n+    // needed due to the unorthodox way in which the thread pools are defined in ejb3 subsystem\n+    protected static final String THREAD_POOL_CAPABILITY_NAME = ThreadsServices.createCapability(EJB3SubsystemModel.BASE_EJB_THREAD_POOL_NAME, ExecutorService.class).getName();\n+\n+    public static final String ASYNC_SERVICE_CAPABILITY_NAME = \"org.wildfly.ejb3.async\";\n+    public static final RuntimeCapability<Void> ASYNC_SERVICE_CAPABILITY =\n+            RuntimeCapability.Builder.of(ASYNC_SERVICE_CAPABILITY_NAME, true).build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxNzE0Mw=="}, "originalCommit": {"oid": "a5999392b9dd6c9d34449a6cf0ef869d6b88b522"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDY3NzMwOnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/TimerServiceAdd.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjoxMjo0N1rOG1LsEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMzo1ODoyNFrOG2fcEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxOTIxOQ==", "bodyText": "It looks like this can remain private.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r458419219", "createdAt": "2020-07-21T22:12:47Z", "author": {"login": "bstansberry"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/TimerServiceAdd.java", "diffHunk": "@@ -74,12 +76,10 @@ protected void execute(DeploymentProcessorTarget processorTarget) {\n             }\n         }, OperationContext.Stage.RUNTIME);\n \n-        context.getServiceTarget().addService(TimerServiceDeploymentProcessor.TIMER_SERVICE_NAME, new TimerValueService())\n-                .install();\n-\n+        context.getCapabilityServiceTarget().addCapability(TimerServiceResourceDefinition.TIMER_SERVICE_CAPABILITY, new TimerValueService()).install();\n     }\n \n-    private static final class TimerValueService implements Service<Timer> {\n+    public static final class TimerValueService implements Service<Timer> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba3290af17494a163dc5f03ac26f82d0cb64ac49"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5MTM3OA==", "bodyText": "Done.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r459791378", "createdAt": "2020-07-23T23:58:24Z", "author": {"login": "rachmatowicz"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/TimerServiceAdd.java", "diffHunk": "@@ -74,12 +76,10 @@ protected void execute(DeploymentProcessorTarget processorTarget) {\n             }\n         }, OperationContext.Stage.RUNTIME);\n \n-        context.getServiceTarget().addService(TimerServiceDeploymentProcessor.TIMER_SERVICE_NAME, new TimerValueService())\n-                .install();\n-\n+        context.getCapabilityServiceTarget().addCapability(TimerServiceResourceDefinition.TIMER_SERVICE_CAPABILITY, new TimerValueService()).install();\n     }\n \n-    private static final class TimerValueService implements Service<Timer> {\n+    public static final class TimerValueService implements Service<Timer> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQxOTIxOQ=="}, "originalCommit": {"oid": "ba3290af17494a163dc5f03ac26f82d0cb64ac49"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDcwNzM4OnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemAdd.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjoyNDoyNVrOG1L-LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMDoxNjoxNlrOG2futA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyMzg1Mg==", "bodyText": "It's unfortunate this attribute allows expressions. This runs in Stage.MODEL and some expressions (typically legacy security vault ones) may not be resolvable until Stage.RUNTIME. Which is the big reason we avoid allow expressions for model reference attributes. But this one has been around forever, so it is what it is.\nTo be really safe L236-238 should be in a try/catch that just logs a WARN if resolvesExpressions throws OperationFailedException. We'd just not record the requirement.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r458423852", "createdAt": "2020-07-21T22:24:25Z", "author": {"login": "bstansberry"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemAdd.java", "diffHunk": "@@ -215,6 +221,35 @@ protected void populateModel(final OperationContext context, ModelNode operation\n         }\n     }\n \n+    /*\n+     * Conditional registration of capabilities for default bean instance pools (which may or may not be defined)\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, ModelNode operation, Resource resource) throws OperationFailedException {\n+        ModelNode model = resource.getModel();\n+\n+        // register the capability we are exporting as well as its capability requirement on the strict-max-pool that supports it\n+        if (model.hasDefined(DEFAULT_SLSB_INSTANCE_POOL)) {\n+            context.registerCapability(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultSLSBPoolName = context.resolveExpressions(model.get(DEFAULT_SLSB_INSTANCE_POOL)).asString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5NjE0OA==", "bodyText": "Done", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r459796148", "createdAt": "2020-07-24T00:16:16Z", "author": {"login": "rachmatowicz"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemAdd.java", "diffHunk": "@@ -215,6 +221,35 @@ protected void populateModel(final OperationContext context, ModelNode operation\n         }\n     }\n \n+    /*\n+     * Conditional registration of capabilities for default bean instance pools (which may or may not be defined)\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, ModelNode operation, Resource resource) throws OperationFailedException {\n+        ModelNode model = resource.getModel();\n+\n+        // register the capability we are exporting as well as its capability requirement on the strict-max-pool that supports it\n+        if (model.hasDefined(DEFAULT_SLSB_INSTANCE_POOL)) {\n+            context.registerCapability(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultSLSBPoolName = context.resolveExpressions(model.get(DEFAULT_SLSB_INSTANCE_POOL)).asString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyMzg1Mg=="}, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDcwNzg3OnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemAdd.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjoyNDozOFrOG1L-fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMDoxNjoyN1rOG2fu4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyMzkzMg==", "bodyText": "Same comment as above.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r458423932", "createdAt": "2020-07-21T22:24:38Z", "author": {"login": "bstansberry"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemAdd.java", "diffHunk": "@@ -215,6 +221,35 @@ protected void populateModel(final OperationContext context, ModelNode operation\n         }\n     }\n \n+    /*\n+     * Conditional registration of capabilities for default bean instance pools (which may or may not be defined)\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, ModelNode operation, Resource resource) throws OperationFailedException {\n+        ModelNode model = resource.getModel();\n+\n+        // register the capability we are exporting as well as its capability requirement on the strict-max-pool that supports it\n+        if (model.hasDefined(DEFAULT_SLSB_INSTANCE_POOL)) {\n+            context.registerCapability(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultSLSBPoolName = context.resolveExpressions(model.get(DEFAULT_SLSB_INSTANCE_POOL)).asString();\n+            String defaultSLSBPoolRequirementName = RuntimeCapability.buildDynamicCapabilityName(STRICT_MAX_POOL_CONFIG_CAPABILITY_NAME, resolvedDefaultSLSBPoolName);\n+            context.registerAdditionalCapabilityRequirement(defaultSLSBPoolRequirementName, DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME, DEFAULT_SLSB_INSTANCE_POOL);\n+        }\n+\n+        if (model.hasDefined(DEFAULT_MDB_INSTANCE_POOL)) {\n+            context.registerCapability(DEFAULT_MDB_POOL_CONFIG_CAPABILITY);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultMDBPoolName = context.resolveExpressions(model.get(DEFAULT_MDB_INSTANCE_POOL)).asString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5NjE5Mw==", "bodyText": "Done", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r459796193", "createdAt": "2020-07-24T00:16:27Z", "author": {"login": "rachmatowicz"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemAdd.java", "diffHunk": "@@ -215,6 +221,35 @@ protected void populateModel(final OperationContext context, ModelNode operation\n         }\n     }\n \n+    /*\n+     * Conditional registration of capabilities for default bean instance pools (which may or may not be defined)\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, ModelNode operation, Resource resource) throws OperationFailedException {\n+        ModelNode model = resource.getModel();\n+\n+        // register the capability we are exporting as well as its capability requirement on the strict-max-pool that supports it\n+        if (model.hasDefined(DEFAULT_SLSB_INSTANCE_POOL)) {\n+            context.registerCapability(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultSLSBPoolName = context.resolveExpressions(model.get(DEFAULT_SLSB_INSTANCE_POOL)).asString();\n+            String defaultSLSBPoolRequirementName = RuntimeCapability.buildDynamicCapabilityName(STRICT_MAX_POOL_CONFIG_CAPABILITY_NAME, resolvedDefaultSLSBPoolName);\n+            context.registerAdditionalCapabilityRequirement(defaultSLSBPoolRequirementName, DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME, DEFAULT_SLSB_INSTANCE_POOL);\n+        }\n+\n+        if (model.hasDefined(DEFAULT_MDB_INSTANCE_POOL)) {\n+            context.registerCapability(DEFAULT_MDB_POOL_CONFIG_CAPABILITY);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultMDBPoolName = context.resolveExpressions(model.get(DEFAULT_MDB_INSTANCE_POOL)).asString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyMzkzMg=="}, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDcxMjc2OnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemDefaultPoolWriteHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjoyNjoyMFrOG1MBSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMDo0Mzo1NlrOG2gHqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyNDY1MQ==", "bodyText": "Probably log a WARN and just deregister the old requirement, don't record the new one.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r458424651", "createdAt": "2020-07-21T22:26:20Z", "author": {"login": "bstansberry"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemDefaultPoolWriteHandler.java", "diffHunk": "@@ -27,40 +27,84 @@\n import org.jboss.as.controller.OperationContext;\n import org.jboss.as.controller.OperationFailedException;\n import org.jboss.as.controller.PathAddress;\n+import org.jboss.as.controller.capability.RuntimeCapability;\n+import org.jboss.as.controller.registry.Resource;\n import org.jboss.as.ejb3.component.pool.PoolConfig;\n-import org.jboss.as.ejb3.component.pool.StrictMaxPoolConfigService;\n import org.jboss.dmr.ModelNode;\n import org.jboss.msc.service.ServiceController;\n import org.jboss.msc.service.ServiceName;\n import org.jboss.msc.service.ServiceRegistry;\n import org.jboss.msc.service.ValueInjectionService;\n \n+import static org.jboss.as.ejb3.subsystem.EJB3SubsystemModel.DEFAULT_MDB_INSTANCE_POOL;\n+import static org.jboss.as.ejb3.subsystem.EJB3SubsystemModel.DEFAULT_SLSB_INSTANCE_POOL;\n+\n /**\n  * User: jpai\n  */\n public class EJB3SubsystemDefaultPoolWriteHandler extends AbstractWriteAttributeHandler<Void> {\n \n-    public static final EJB3SubsystemDefaultPoolWriteHandler MDB_POOL =\n-            new EJB3SubsystemDefaultPoolWriteHandler(StrictMaxPoolConfigService.DEFAULT_MDB_POOL_CONFIG_SERVICE_NAME,\n-                    EJB3SubsystemRootResourceDefinition.DEFAULT_MDB_INSTANCE_POOL);\n+    private static final String STRICT_MAX_POOL_CONFIG_CAPABILITY_NAME = \"org.wildfly.ejb3.pool-config\";\n+    private static final String DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME = \"org.wildfly.ejb3.pool-config.slsb-default\";\n+    private static final String DEFAULT_MDB_POOL_CONFIG_CAPABILITY_NAME = \"org.wildfly.ejb3.pool-config.mdb-default\";\n+    private static final String DEFAULT_ENTITY_POOL_CONFIG_CAPABILITY_NAME = \"org.wildfly.ejb3.pool-config.entity-default\";\n \n     public static final EJB3SubsystemDefaultPoolWriteHandler SLSB_POOL =\n-            new EJB3SubsystemDefaultPoolWriteHandler(StrictMaxPoolConfigService.DEFAULT_SLSB_POOL_CONFIG_SERVICE_NAME,\n-                    EJB3SubsystemRootResourceDefinition.DEFAULT_SLSB_INSTANCE_POOL);\n+            new EJB3SubsystemDefaultPoolWriteHandler(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME, EJB3SubsystemRootResourceDefinition.DEFAULT_SLSB_INSTANCE_POOL);\n+\n+    public static final EJB3SubsystemDefaultPoolWriteHandler MDB_POOL =\n+            new EJB3SubsystemDefaultPoolWriteHandler(DEFAULT_MDB_POOL_CONFIG_CAPABILITY_NAME, EJB3SubsystemRootResourceDefinition.DEFAULT_MDB_INSTANCE_POOL);\n \n     public static final EJB3SubsystemDefaultPoolWriteHandler ENTITY_BEAN_POOL =\n-            new EJB3SubsystemDefaultPoolWriteHandler(StrictMaxPoolConfigService.DEFAULT_ENTITY_POOL_CONFIG_SERVICE_NAME,\n-                    EJB3SubsystemRootResourceDefinition.DEFAULT_ENTITY_BEAN_INSTANCE_POOL);\n+            new EJB3SubsystemDefaultPoolWriteHandler(DEFAULT_ENTITY_POOL_CONFIG_CAPABILITY_NAME, EJB3SubsystemRootResourceDefinition.DEFAULT_ENTITY_BEAN_INSTANCE_POOL);\n \n-    private final ServiceName poolConfigServiceName;\n+    private final String poolConfigCapabilityName;\n     private final AttributeDefinition poolAttribute;\n \n-    public EJB3SubsystemDefaultPoolWriteHandler(ServiceName poolConfigServiceName, AttributeDefinition poolAttribute) {\n+    public EJB3SubsystemDefaultPoolWriteHandler(String defaultPoolConfigCapabilityName, AttributeDefinition poolAttribute) {\n         super(poolAttribute);\n-        this.poolConfigServiceName = poolConfigServiceName;\n+        this.poolConfigCapabilityName = defaultPoolConfigCapabilityName;\n         this.poolAttribute = poolAttribute;\n     }\n \n+    /*\n+     * Update the conditional capabilities for the default bean instance pools if the attribute values have changed\n+     * This write handler is registered with the EJB3SubsystemRootResource\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, AttributeDefinition attributeDefinition, ModelNode newValue, ModelNode oldValue) {\n+        Resource resource = context.readResource(PathAddress.EMPTY_ADDRESS);\n+        ModelNode model = resource.getModel();\n+\n+        // NOTE: the old value does not contain an expression, but the new value contains an expression, so we need to resolve it first\n+        ModelNode resolvedNewValue = new ModelNode();\n+        try {\n+            resolvedNewValue = context.resolveExpressions(newValue);\n+        } catch(OperationFailedException ofe) {\n+            // TODO: handle any possible exception correctly", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwMjUzNw==", "bodyText": "Done.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r459802537", "createdAt": "2020-07-24T00:43:56Z", "author": {"login": "rachmatowicz"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemDefaultPoolWriteHandler.java", "diffHunk": "@@ -27,40 +27,84 @@\n import org.jboss.as.controller.OperationContext;\n import org.jboss.as.controller.OperationFailedException;\n import org.jboss.as.controller.PathAddress;\n+import org.jboss.as.controller.capability.RuntimeCapability;\n+import org.jboss.as.controller.registry.Resource;\n import org.jboss.as.ejb3.component.pool.PoolConfig;\n-import org.jboss.as.ejb3.component.pool.StrictMaxPoolConfigService;\n import org.jboss.dmr.ModelNode;\n import org.jboss.msc.service.ServiceController;\n import org.jboss.msc.service.ServiceName;\n import org.jboss.msc.service.ServiceRegistry;\n import org.jboss.msc.service.ValueInjectionService;\n \n+import static org.jboss.as.ejb3.subsystem.EJB3SubsystemModel.DEFAULT_MDB_INSTANCE_POOL;\n+import static org.jboss.as.ejb3.subsystem.EJB3SubsystemModel.DEFAULT_SLSB_INSTANCE_POOL;\n+\n /**\n  * User: jpai\n  */\n public class EJB3SubsystemDefaultPoolWriteHandler extends AbstractWriteAttributeHandler<Void> {\n \n-    public static final EJB3SubsystemDefaultPoolWriteHandler MDB_POOL =\n-            new EJB3SubsystemDefaultPoolWriteHandler(StrictMaxPoolConfigService.DEFAULT_MDB_POOL_CONFIG_SERVICE_NAME,\n-                    EJB3SubsystemRootResourceDefinition.DEFAULT_MDB_INSTANCE_POOL);\n+    private static final String STRICT_MAX_POOL_CONFIG_CAPABILITY_NAME = \"org.wildfly.ejb3.pool-config\";\n+    private static final String DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME = \"org.wildfly.ejb3.pool-config.slsb-default\";\n+    private static final String DEFAULT_MDB_POOL_CONFIG_CAPABILITY_NAME = \"org.wildfly.ejb3.pool-config.mdb-default\";\n+    private static final String DEFAULT_ENTITY_POOL_CONFIG_CAPABILITY_NAME = \"org.wildfly.ejb3.pool-config.entity-default\";\n \n     public static final EJB3SubsystemDefaultPoolWriteHandler SLSB_POOL =\n-            new EJB3SubsystemDefaultPoolWriteHandler(StrictMaxPoolConfigService.DEFAULT_SLSB_POOL_CONFIG_SERVICE_NAME,\n-                    EJB3SubsystemRootResourceDefinition.DEFAULT_SLSB_INSTANCE_POOL);\n+            new EJB3SubsystemDefaultPoolWriteHandler(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME, EJB3SubsystemRootResourceDefinition.DEFAULT_SLSB_INSTANCE_POOL);\n+\n+    public static final EJB3SubsystemDefaultPoolWriteHandler MDB_POOL =\n+            new EJB3SubsystemDefaultPoolWriteHandler(DEFAULT_MDB_POOL_CONFIG_CAPABILITY_NAME, EJB3SubsystemRootResourceDefinition.DEFAULT_MDB_INSTANCE_POOL);\n \n     public static final EJB3SubsystemDefaultPoolWriteHandler ENTITY_BEAN_POOL =\n-            new EJB3SubsystemDefaultPoolWriteHandler(StrictMaxPoolConfigService.DEFAULT_ENTITY_POOL_CONFIG_SERVICE_NAME,\n-                    EJB3SubsystemRootResourceDefinition.DEFAULT_ENTITY_BEAN_INSTANCE_POOL);\n+            new EJB3SubsystemDefaultPoolWriteHandler(DEFAULT_ENTITY_POOL_CONFIG_CAPABILITY_NAME, EJB3SubsystemRootResourceDefinition.DEFAULT_ENTITY_BEAN_INSTANCE_POOL);\n \n-    private final ServiceName poolConfigServiceName;\n+    private final String poolConfigCapabilityName;\n     private final AttributeDefinition poolAttribute;\n \n-    public EJB3SubsystemDefaultPoolWriteHandler(ServiceName poolConfigServiceName, AttributeDefinition poolAttribute) {\n+    public EJB3SubsystemDefaultPoolWriteHandler(String defaultPoolConfigCapabilityName, AttributeDefinition poolAttribute) {\n         super(poolAttribute);\n-        this.poolConfigServiceName = poolConfigServiceName;\n+        this.poolConfigCapabilityName = defaultPoolConfigCapabilityName;\n         this.poolAttribute = poolAttribute;\n     }\n \n+    /*\n+     * Update the conditional capabilities for the default bean instance pools if the attribute values have changed\n+     * This write handler is registered with the EJB3SubsystemRootResource\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, AttributeDefinition attributeDefinition, ModelNode newValue, ModelNode oldValue) {\n+        Resource resource = context.readResource(PathAddress.EMPTY_ADDRESS);\n+        ModelNode model = resource.getModel();\n+\n+        // NOTE: the old value does not contain an expression, but the new value contains an expression, so we need to resolve it first\n+        ModelNode resolvedNewValue = new ModelNode();\n+        try {\n+            resolvedNewValue = context.resolveExpressions(newValue);\n+        } catch(OperationFailedException ofe) {\n+            // TODO: handle any possible exception correctly", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyNDY1MQ=="}, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDcxNDQ4OnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemRemove.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjoyNzowMVrOG1MCWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMDoyMTo1MFrOG2fz5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyNDkyMg==", "bodyText": "See previous comment about try/catch", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r458424922", "createdAt": "2020-07-21T22:27:01Z", "author": {"login": "bstansberry"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemRemove.java", "diffHunk": "@@ -39,6 +47,35 @@\n     private EJB3SubsystemRemove() {\n     }\n \n+    /*\n+     * handle conditionally-defined capabilities for default bean instance pools\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, ModelNode operation, Resource resource) throws OperationFailedException {\n+        ModelNode model = resource.getModel();\n+\n+        // de-register the capability we are exporting as well as its capability requirement on the strict-max-pool that supports it\n+        if (model.hasDefined(DEFAULT_SLSB_INSTANCE_POOL)) {\n+            context.deregisterCapability(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultSLSBPoolName = context.resolveExpressions(model.get(DEFAULT_SLSB_INSTANCE_POOL)).asString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5NzQ3OA==", "bodyText": "Done", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r459797478", "createdAt": "2020-07-24T00:21:50Z", "author": {"login": "rachmatowicz"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemRemove.java", "diffHunk": "@@ -39,6 +47,35 @@\n     private EJB3SubsystemRemove() {\n     }\n \n+    /*\n+     * handle conditionally-defined capabilities for default bean instance pools\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, ModelNode operation, Resource resource) throws OperationFailedException {\n+        ModelNode model = resource.getModel();\n+\n+        // de-register the capability we are exporting as well as its capability requirement on the strict-max-pool that supports it\n+        if (model.hasDefined(DEFAULT_SLSB_INSTANCE_POOL)) {\n+            context.deregisterCapability(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultSLSBPoolName = context.resolveExpressions(model.get(DEFAULT_SLSB_INSTANCE_POOL)).asString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyNDkyMg=="}, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDcxNDcwOnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemRemove.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjoyNzowN1rOG1MCfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwMDoyMjowMFrOG2f0Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyNDk1Ng==", "bodyText": "See previous comment about try/catch", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r458424956", "createdAt": "2020-07-21T22:27:07Z", "author": {"login": "bstansberry"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemRemove.java", "diffHunk": "@@ -39,6 +47,35 @@\n     private EJB3SubsystemRemove() {\n     }\n \n+    /*\n+     * handle conditionally-defined capabilities for default bean instance pools\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, ModelNode operation, Resource resource) throws OperationFailedException {\n+        ModelNode model = resource.getModel();\n+\n+        // de-register the capability we are exporting as well as its capability requirement on the strict-max-pool that supports it\n+        if (model.hasDefined(DEFAULT_SLSB_INSTANCE_POOL)) {\n+            context.deregisterCapability(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultSLSBPoolName = context.resolveExpressions(model.get(DEFAULT_SLSB_INSTANCE_POOL)).asString();\n+            String defaultSLSBPoolRequirementName = RuntimeCapability.buildDynamicCapabilityName(STRICT_MAX_POOL_CONFIG_CAPABILITY_NAME, resolvedDefaultSLSBPoolName);\n+            context.deregisterCapabilityRequirement(defaultSLSBPoolRequirementName, DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME, DEFAULT_SLSB_INSTANCE_POOL);\n+        }\n+\n+        if (model.hasDefined(DEFAULT_MDB_INSTANCE_POOL)) {\n+            context.deregisterCapability(DEFAULT_MDB_POOL_CONFIG_CAPABILITY_NAME);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultMDBPoolName = context.resolveExpressions(model.get(DEFAULT_MDB_INSTANCE_POOL)).asString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5NzUwNw==", "bodyText": "Done.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r459797507", "createdAt": "2020-07-24T00:22:00Z", "author": {"login": "rachmatowicz"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/subsystem/EJB3SubsystemRemove.java", "diffHunk": "@@ -39,6 +47,35 @@\n     private EJB3SubsystemRemove() {\n     }\n \n+    /*\n+     * handle conditionally-defined capabilities for default bean instance pools\n+     */\n+    @Override\n+    protected void recordCapabilitiesAndRequirements(OperationContext context, ModelNode operation, Resource resource) throws OperationFailedException {\n+        ModelNode model = resource.getModel();\n+\n+        // de-register the capability we are exporting as well as its capability requirement on the strict-max-pool that supports it\n+        if (model.hasDefined(DEFAULT_SLSB_INSTANCE_POOL)) {\n+            context.deregisterCapability(DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultSLSBPoolName = context.resolveExpressions(model.get(DEFAULT_SLSB_INSTANCE_POOL)).asString();\n+            String defaultSLSBPoolRequirementName = RuntimeCapability.buildDynamicCapabilityName(STRICT_MAX_POOL_CONFIG_CAPABILITY_NAME, resolvedDefaultSLSBPoolName);\n+            context.deregisterCapabilityRequirement(defaultSLSBPoolRequirementName, DEFAULT_SLSB_POOL_CONFIG_CAPABILITY_NAME, DEFAULT_SLSB_INSTANCE_POOL);\n+        }\n+\n+        if (model.hasDefined(DEFAULT_MDB_INSTANCE_POOL)) {\n+            context.deregisterCapability(DEFAULT_MDB_POOL_CONFIG_CAPABILITY_NAME);\n+\n+            // need to resolve the attribute value before using it\n+            String resolvedDefaultMDBPoolName = context.resolveExpressions(model.get(DEFAULT_MDB_INSTANCE_POOL)).asString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyNDk1Ng=="}, "originalCommit": {"oid": "9e06abb10cf0a2d31e65a4963d2a60ba5405e3e0"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDczMDYyOnYy", "diffSide": "RIGHT", "path": "transactions/src/main/java/org/jboss/as/txn/subsystem/TransactionSubsystemRootResourceDefinition.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjozMjo1MFrOG1MLnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMjozMjo1MFrOG1MLnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQyNzI5NQ==", "bodyText": "@mmusgrov Any concerns about this?  To me RemotingTransactionService seems like a reasonable API to expose via a capability, and in any case it's already being used in other subsystems for MSC service wiring.  This addition of a capability just formalizes the contract a bit.", "url": "https://github.com/wildfly/wildfly/pull/13415#discussion_r458427295", "createdAt": "2020-07-21T22:32:50Z", "author": {"login": "bstansberry"}, "path": "transactions/src/main/java/org/jboss/as/txn/subsystem/TransactionSubsystemRootResourceDefinition.java", "diffHunk": "@@ -82,6 +83,11 @@\n     public static final RuntimeCapability<Void> TRANSACTION_SYNCHRONIZATION_REGISTRY_CAPABILITY =\n             RuntimeCapability.Builder.of(\"org.wildfly.transactions.transaction-synchronization-registry\", TransactionSynchronizationRegistry.class)\n                     .build();\n+\n+    public static final RuntimeCapability<Void> REMOTE_TRANSACTION_SERVICE_CAPABILITY =\n+            RuntimeCapability.Builder.of(\"org.wildfly.transactions.remote-transaction-service\", RemotingTransactionService.class)\n+                    .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e1cdf3f57056f37f286799cefb11bce44c22a3a"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4216, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}