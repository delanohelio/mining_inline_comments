{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0OTk2MTcx", "number": 13419, "title": "[WFLY-13435] / [WFLY-13509] / [WFLY-13434] / [WFLY-13319] DUP Refactoring for SecurityDomain resolution.", "bodyText": "This pull request depends upon wildfly/wildfly-core#4276\nAs described in the WildFly Core PR this is predominantly about refactoring deployment unit processors so a security domain can be identified early and re-used by later deployment unit processors without repeating domain resolution logic.\nThe end result also means any virtual security domain created for MP JWT can be reused within an EJB deployment and a test case is added verifying the propagation of an identify established using JWT from the servlet container to the EJB container.\nAs described in the WildFly Core PR it will still be desirable to pull this resolution earlier so the security policy is defined before entering Phase.INSTALL but presently a deployment can be converted to a web application later in the INSTALL Phase.\nhttps://issues.redhat.com/browse/WFLY-13435\nhttps://issues.redhat.com/browse/WFLY-13509\nhttps://issues.redhat.com/browse/WFLY-13434\nhttps://issues.redhat.com/browse/WFLY-13319", "createdAt": "2020-07-22T09:30:07Z", "url": "https://github.com/wildfly/wildfly/pull/13419", "merged": true, "mergeCommit": {"oid": "20854c91c896a8f793c7f9f68f325d1013f6ca42"}, "closed": true, "closedAt": "2020-08-05T22:40:53Z", "author": {"login": "darranl"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpMx8BgH2gAyNDU0OTk2MTcxOmZiNDgyYmEzZTliNTU1M2ZjODMxYWEyNDIzMDc2N2RiNDBhMDI1MWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7c136AFqTQ2MDQ0NzM1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fb482ba3e9b5553fc831aa24230767db40a0251b", "author": {"user": {"login": "darranl", "name": "Darran Lofthouse"}}, "url": "https://github.com/wildfly/wildfly/commit/fb482ba3e9b5553fc831aa24230767db40a0251b", "committedDate": "2020-06-08T09:10:23Z", "message": "[WFLY-13435] Move security domain name resolution before UndertowDeploymentProcessor.\n\nIdeally we would pull this all the way to Phase.PARSE but interaction with WS DUPs mean we need to wait until they have performed their own security domain resolution."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11c66705a3a621b13b1aa2779a4a58a8d72e8284", "author": {"user": {"login": "darranl", "name": "Darran Lofthouse"}}, "url": "https://github.com/wildfly/wildfly/commit/11c66705a3a621b13b1aa2779a4a58a8d72e8284", "committedDate": "2020-06-08T10:14:21Z", "message": "[WFLY-13435] Re-advertise the SecurityDomain as an alias to the ApplicationSecurityDomain service so a ServiceName can be advertised.\n\nFor virtual security domains obtain the ServiceName from the SecurityMetaDat attachment instead of generating again."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b86d39c1c3ec35d81881073625de7487cc44279", "author": {"user": {"login": "darranl", "name": "Darran Lofthouse"}}, "url": "https://github.com/wildfly/wildfly/commit/6b86d39c1c3ec35d81881073625de7487cc44279", "committedDate": "2020-06-08T10:14:21Z", "message": "[WFLY-13509] Convert the ApplicationSecurityDomain resource to use the new MSC APIs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15e0f3db06d52efb30d3695c0fac707d1d10f7b3", "author": {"user": {"login": "darranl", "name": "Darran Lofthouse"}}, "url": "https://github.com/wildfly/wildfly/commit/15e0f3db06d52efb30d3695c0fac707d1d10f7b3", "committedDate": "2020-06-08T10:14:21Z", "message": "[WFLY-13434] Also expose SecurityDomain from ApplicationSecurityDomain so we can re-use it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8c48dd26f77688117bda1d45d31307e69fc8d2f", "author": {"user": {"login": "darranl", "name": "Darran Lofthouse"}}, "url": "https://github.com/wildfly/wildfly/commit/c8c48dd26f77688117bda1d45d31307e69fc8d2f", "committedDate": "2020-07-23T15:47:42Z", "message": "[WFLY-13434] Adjust EJB deployment to make use of pre-defined security domain and advertise the name of any security domain selected during the EJB deployment process."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "521293d4554c7f1fe5f89a555ea4906f2149e93e", "author": {"user": {"login": "darranl", "name": "Darran Lofthouse"}}, "url": "https://github.com/wildfly/wildfly/commit/521293d4554c7f1fe5f89a555ea4906f2149e93e", "committedDate": "2020-07-23T15:47:42Z", "message": "[WFLY-13319] Add a test case to test EJB integration with MicroProfile JWT."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5b35648f28a3dcf826c051c1f2b3f2646703bc7", "author": {"user": {"login": "darranl", "name": "Darran Lofthouse"}}, "url": "https://github.com/wildfly/wildfly/commit/a5b35648f28a3dcf826c051c1f2b3f2646703bc7", "committedDate": "2020-07-22T09:24:40Z", "message": "[WFLY-13319] Add a test case to test EJB integration with MicroProfile JWT."}, "afterCommit": {"oid": "521293d4554c7f1fe5f89a555ea4906f2149e93e", "author": {"user": {"login": "darranl", "name": "Darran Lofthouse"}}, "url": "https://github.com/wildfly/wildfly/commit/521293d4554c7f1fe5f89a555ea4906f2149e93e", "committedDate": "2020-07-23T15:47:42Z", "message": "[WFLY-13319] Add a test case to test EJB integration with MicroProfile JWT."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzMyNjk2", "url": "https://github.com/wildfly/wildfly/pull/13419#pullrequestreview-454332696", "createdAt": "2020-07-23T17:07:30Z", "commit": {"oid": "521293d4554c7f1fe5f89a555ea4906f2149e93e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTgzMzY5", "url": "https://github.com/wildfly/wildfly/pull/13419#pullrequestreview-459583369", "createdAt": "2020-08-01T14:57:29Z", "commit": {"oid": "521293d4554c7f1fe5f89a555ea4906f2149e93e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQxNDo1NzoyOVrOG6edRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMVQxNDo1NzoyOVrOG6edRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk2OTYwNg==", "bodyText": "Nit: you don't need the null check any more as the line above ensures it's false.", "url": "https://github.com/wildfly/wildfly/pull/13419#discussion_r463969606", "createdAt": "2020-08-01T14:57:29Z", "author": {"login": "bstansberry"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/EJBSecurityDomainService.java", "diffHunk": "@@ -36,39 +41,81 @@\n import org.jboss.msc.service.StartException;\n import org.jboss.msc.service.StopContext;\n import org.jboss.msc.value.InjectedValue;\n+import org.wildfly.security.auth.server.SecurityDomain;\n+import org.wildfly.security.manager.WildFlySecurityManager;\n \n /**\n  * A service that sets up the security domain mapping for an EJB deployment.\n  *\n+ * This service is reponsible for deployment level actions such as registering a deployment with the resolved\n+ * application-security-domain mapping or associating the {@code SecurityDomain} with the deployment's {@code ClassLoader}.\n+ * Defined {@code ComponentConfigurator} instances will then provide the component specific installation.\n+ *\n  * @author <a href=\"mailto:fjuma@redhat.com\">Farah</a>\n  */\n public class EJBSecurityDomainService implements Service<Void> {\n     public static final ServiceName SERVICE_NAME = ServiceName.of(\"ejb3\", \"security-domain\");\n \n     private final InjectedValue<ApplicationSecurityDomain> applicationSecurityDomain = new InjectedValue<>();\n+    private final InjectedValue<SecurityDomain> securityDomain = new InjectedValue<>();\n+\n     private final DeploymentUnit deploymentUnit;\n-    private Registration registration;\n+\n+    private volatile Runnable cleanUpTask;\n \n     public EJBSecurityDomainService(final DeploymentUnit deploymentUnit) {\n         this.deploymentUnit = deploymentUnit;\n     }\n \n     @Override\n     public synchronized void start(StartContext context) throws StartException {\n-        ApplicationSecurityDomain applicationSecurityDomain = getApplicationSecurityDomain();\n-        BiFunction<String, ClassLoader, Registration> securityFunction = applicationSecurityDomain != null ? applicationSecurityDomain.getSecurityFunction() : null;\n-        if (securityFunction != null) {\n-            final String deploymentName = deploymentUnit.getParent() == null ? deploymentUnit.getName() : deploymentUnit.getParent().getName() + \".\" + deploymentUnit.getName();\n-            final Module module = deploymentUnit.getAttachment(Attachments.MODULE);\n-            final ClassLoader classLoader = module.getClassLoader();\n-            registration = securityFunction.apply(deploymentName, classLoader);\n+        final String deploymentName = deploymentUnit.getParent() == null ? deploymentUnit.getName()\n+                : deploymentUnit.getParent().getName() + \".\" + deploymentUnit.getName();\n+        final Module module = deploymentUnit.getAttachment(Attachments.MODULE);\n+        final ClassLoader classLoader = module.getClassLoader();\n+\n+        ApplicationSecurityDomain applicationSecurityDomain = this.applicationSecurityDomain.getOptionalValue();\n+        if (applicationSecurityDomain != null) {\n+            BiFunction<String, ClassLoader, Registration> securityFunction = applicationSecurityDomain != null ? applicationSecurityDomain.getSecurityFunction() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "521293d4554c7f1fe5f89a555ea4906f2149e93e"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01ca145144ba7ba8ec9c090ecf0f829c93611cd1", "author": {"user": {"login": "darranl", "name": "Darran Lofthouse"}}, "url": "https://github.com/wildfly/wildfly/commit/01ca145144ba7ba8ec9c090ecf0f829c93611cd1", "committedDate": "2020-08-03T14:34:47Z", "message": "[WFLY-13434] Combine SecurityDomain resolution with capability refactoring under WFLY-13433."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNDQ3MzUw", "url": "https://github.com/wildfly/wildfly/pull/13419#pullrequestreview-460447350", "createdAt": "2020-08-04T02:03:48Z", "commit": {"oid": "01ca145144ba7ba8ec9c090ecf0f829c93611cd1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3918, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}