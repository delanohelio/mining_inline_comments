{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMDk3OTU5", "number": 13410, "title": "[WFLY-13177] ManagedExecutorService: Wrong activeRequestCount at RequestController on RejectedExecutionException", "bodyText": "Issue: https://issues.redhat.com/browse/WFLY-13177", "createdAt": "2020-07-17T12:42:55Z", "url": "https://github.com/wildfly/wildfly/pull/13410", "merged": true, "mergeCommit": {"oid": "22d4c890aa0d3e3d8a08389e9da0ca9592fa29b6"}, "closed": true, "closedAt": "2020-08-29T19:53:59Z", "author": {"login": "istudens"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3DG9ZABqjM1NzAzNTA4NDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDqWLrgH2gAyNDUxMDk3OTU5OjVjOTJkNzA2NTFkYTk4NTVjZGNlY2RjZmYyOWZiMjliZmFlZGVlMjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f34dd547a0fe9a18a0fb477347c28ec28472376", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/2f34dd547a0fe9a18a0fb477347c28ec28472376", "committedDate": "2020-07-17T12:33:15Z", "message": "[WFLY-13177] a test-case"}, "afterCommit": {"oid": "c9dd59ef4dd1b69d8cc33fb08a56b0a5cef13ee9", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/c9dd59ef4dd1b69d8cc33fb08a56b0a5cef13ee9", "committedDate": "2020-07-21T09:48:17Z", "message": "[WFLY-13177] a test-case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTY3NDAz", "url": "https://github.com/wildfly/wildfly/pull/13410#pullrequestreview-455167403", "createdAt": "2020-07-24T20:29:52Z", "commit": {"oid": "c9dd59ef4dd1b69d8cc33fb08a56b0a5cef13ee9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDozMDowNlrOG2825g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDozNDo1MFrOG28-QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MzM4Mg==", "bodyText": "This is ok.", "url": "https://github.com/wildfly/wildfly/pull/13410#discussion_r460273382", "createdAt": "2020-07-24T20:30:06Z", "author": {"login": "emmartins"}, "path": "ee/src/main/java/org/jboss/as/ee/concurrent/ControlPointUtils.java", "diffHunk": "@@ -67,6 +87,24 @@ public static Runnable doWrap(Runnable runnable, ControlPoint controlPoint) {\n         }\n     }\n \n+    public static <T> Callable<T> doWrapOrThrowException(Callable<T> callable, ControlPoint controlPoint) {\n+        if (controlPoint == null || callable == null) {\n+            return callable;\n+        }\n+        try {\n+            RunResult result = controlPoint.forceBeginRequest();\n+            if (result == RunResult.REJECTED) {\n+                ROOT_LOGGER.rejectedDueToMaxRequests();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9dd59ef4dd1b69d8cc33fb08a56b0a5cef13ee9"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NDA4Nw==", "bodyText": "For exceptions in this line and below, request must be completed since forceBeginRequest succeeded.", "url": "https://github.com/wildfly/wildfly/pull/13410#discussion_r460274087", "createdAt": "2020-07-24T20:31:46Z", "author": {"login": "emmartins"}, "path": "ee/src/main/java/org/jboss/as/ee/concurrent/ControlPointUtils.java", "diffHunk": "@@ -67,6 +87,24 @@ public static Runnable doWrap(Runnable runnable, ControlPoint controlPoint) {\n         }\n     }\n \n+    public static <T> Callable<T> doWrapOrThrowException(Callable<T> callable, ControlPoint controlPoint) {\n+        if (controlPoint == null || callable == null) {\n+            return callable;\n+        }\n+        try {\n+            RunResult result = controlPoint.forceBeginRequest();\n+            if (result == RunResult.REJECTED) {\n+                ROOT_LOGGER.rejectedDueToMaxRequests();\n+            }\n+            final ControlledCallable controlledCallable = new ControlledCallable(callable, controlPoint);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9dd59ef4dd1b69d8cc33fb08a56b0a5cef13ee9"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NDE1NQ==", "bodyText": "instead of adding a new method you should fix the existent method, any usage of it has the issue", "url": "https://github.com/wildfly/wildfly/pull/13410#discussion_r460274155", "createdAt": "2020-07-24T20:31:58Z", "author": {"login": "emmartins"}, "path": "ee/src/main/java/org/jboss/as/ee/concurrent/ControlPointUtils.java", "diffHunk": "@@ -67,6 +87,24 @@ public static Runnable doWrap(Runnable runnable, ControlPoint controlPoint) {\n         }\n     }\n \n+    public static <T> Callable<T> doWrapOrThrowException(Callable<T> callable, ControlPoint controlPoint) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9dd59ef4dd1b69d8cc33fb08a56b0a5cef13ee9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NTI2NQ==", "bodyText": "this is not ok, for any exception the request should be completed, not just RejectedException", "url": "https://github.com/wildfly/wildfly/pull/13410#discussion_r460275265", "createdAt": "2020-07-24T20:34:50Z", "author": {"login": "emmartins"}, "path": "ee/src/main/java/org/jboss/as/ee/concurrent/ManagedExecutorServiceImpl.java", "diffHunk": "@@ -58,17 +60,35 @@ public ManagedExecutorServiceImpl(String name, ManagedThreadFactoryImpl managedT\n \n     @Override\n     public <T> Future<T> submit(Callable<T> task) {\n-        return super.submit(doIdentityWrap(doWrap(task, controlPoint)));\n+        final Callable<T> callable = doWrapOrThrowException(task, controlPoint);\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9dd59ef4dd1b69d8cc33fb08a56b0a5cef13ee9"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9dd59ef4dd1b69d8cc33fb08a56b0a5cef13ee9", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/c9dd59ef4dd1b69d8cc33fb08a56b0a5cef13ee9", "committedDate": "2020-07-21T09:48:17Z", "message": "[WFLY-13177] a test-case"}, "afterCommit": {"oid": "9a8104b316ffcc79633ee393fabe2568a468300e", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/9a8104b316ffcc79633ee393fabe2568a468300e", "committedDate": "2020-07-23T08:54:48Z", "message": "[WFLY-13177] a test-case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MzU2NTM3", "url": "https://github.com/wildfly/wildfly/pull/13410#pullrequestreview-457356537", "createdAt": "2020-07-29T09:37:04Z", "commit": {"oid": "9a8104b316ffcc79633ee393fabe2568a468300e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a8104b316ffcc79633ee393fabe2568a468300e", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/9a8104b316ffcc79633ee393fabe2568a468300e", "committedDate": "2020-07-23T08:54:48Z", "message": "[WFLY-13177] a test-case"}, "afterCommit": {"oid": "88eaf8d43649179ba67255d3d3d1ec56825836af", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/88eaf8d43649179ba67255d3d3d1ec56825836af", "committedDate": "2020-07-29T10:32:59Z", "message": "[WFLY-13177] a test-case"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88eaf8d43649179ba67255d3d3d1ec56825836af", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/88eaf8d43649179ba67255d3d3d1ec56825836af", "committedDate": "2020-07-29T10:32:59Z", "message": "[WFLY-13177] a test-case"}, "afterCommit": {"oid": "5d405e05e2f59fab24925cef12ecd932296209d2", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/5d405e05e2f59fab24925cef12ecd932296209d2", "committedDate": "2020-07-29T11:36:42Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjM2Mzgz", "url": "https://github.com/wildfly/wildfly/pull/13410#pullrequestreview-457636383", "createdAt": "2020-07-29T15:26:40Z", "commit": {"oid": "5d405e05e2f59fab24925cef12ecd932296209d2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNToyNjo0MFrOG494Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNToyNjo0MFrOG494Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM4NzIxNQ==", "bodyText": "should be catching Exception here too", "url": "https://github.com/wildfly/wildfly/pull/13410#discussion_r462387215", "createdAt": "2020-07-29T15:26:40Z", "author": {"login": "emmartins"}, "path": "ee/src/main/java/org/jboss/as/ee/concurrent/ManagedExecutorServiceImpl.java", "diffHunk": "@@ -58,22 +59,46 @@ public ManagedExecutorServiceImpl(String name, ManagedThreadFactoryImpl managedT\n \n     @Override\n     public <T> Future<T> submit(Callable<T> task) {\n-        return super.submit(doIdentityWrap(doWrap(task, controlPoint)));\n+        final Callable<T> callable = doWrap(task, controlPoint);\n+        try {\n+            return super.submit(doIdentityWrap(callable));\n+        } catch (Exception e) {\n+            controlPoint.requestComplete();\n+            throw e;\n+        }\n     }\n \n     @Override\n     public <T> Future<T> submit(Runnable task, T result) {\n-        return super.submit(doIdentityWrap(doWrap(task, controlPoint)), result);\n+        final Runnable runnable = doWrap(task, controlPoint);\n+        try {\n+            return super.submit(doIdentityWrap(runnable), result);\n+        } catch (Exception e) {\n+            controlPoint.requestComplete();\n+            throw e;\n+        }\n     }\n \n     @Override\n     public Future<?> submit(Runnable task) {\n-        return super.submit(doIdentityWrap(doWrap(task, controlPoint)));\n+        final Runnable runnable = doWrap(task, controlPoint);\n+        try {\n+            return super.submit(doIdentityWrap(runnable));\n+        } catch (Exception e) {\n+            controlPoint.requestComplete();\n+            throw e;\n+        }\n     }\n \n     @Override\n     public void execute(Runnable command) {\n-        super.execute(doIdentityWrap(doWrap(command, controlPoint)));\n+        final Runnable runnable = doWrap(command, controlPoint);\n+        try {\n+            super.execute(doIdentityWrap(runnable));\n+        } catch (RejectedExecutionException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d405e05e2f59fab24925cef12ecd932296209d2"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d405e05e2f59fab24925cef12ecd932296209d2", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/5d405e05e2f59fab24925cef12ecd932296209d2", "committedDate": "2020-07-29T11:36:42Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}, "afterCommit": {"oid": "c369ea4f973203035e809ea23e0d4aa77c786c9a", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/c369ea4f973203035e809ea23e0d4aa77c786c9a", "committedDate": "2020-07-30T12:42:07Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c369ea4f973203035e809ea23e0d4aa77c786c9a", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/c369ea4f973203035e809ea23e0d4aa77c786c9a", "committedDate": "2020-07-30T12:42:07Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}, "afterCommit": {"oid": "0d734a87cf603079eafdb0b85dda33225eabe407", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/0d734a87cf603079eafdb0b85dda33225eabe407", "committedDate": "2020-07-30T14:01:02Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d734a87cf603079eafdb0b85dda33225eabe407", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/0d734a87cf603079eafdb0b85dda33225eabe407", "committedDate": "2020-07-30T14:01:02Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}, "afterCommit": {"oid": "0106f31270067f5e9af9cef0dc5562a37e1a1f45", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/0106f31270067f5e9af9cef0dc5562a37e1a1f45", "committedDate": "2020-08-06T09:24:24Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85921e79258239eb57c6d303c39e1290d9f59373", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/85921e79258239eb57c6d303c39e1290d9f59373", "committedDate": "2020-08-06T09:32:30Z", "message": "[WFLY-13177] fixed up number of active requests in case of RejectedExecutionException thrown by executor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bc2e8921e96347830587ac45b2ee0440f9c7598", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/2bc2e8921e96347830587ac45b2ee0440f9c7598", "committedDate": "2020-08-06T09:32:45Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0106f31270067f5e9af9cef0dc5562a37e1a1f45", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/0106f31270067f5e9af9cef0dc5562a37e1a1f45", "committedDate": "2020-08-06T09:24:24Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}, "afterCommit": {"oid": "2bc2e8921e96347830587ac45b2ee0440f9c7598", "author": {"user": {"login": "istudens", "name": "Ivo Studensky"}}, "url": "https://github.com/wildfly/wildfly/commit/2bc2e8921e96347830587ac45b2ee0440f9c7598", "committedDate": "2020-08-06T09:32:45Z", "message": "[WFLY-13177] test-cases for active request number in case of\nRejectedExecutionException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNjUxNDg3", "url": "https://github.com/wildfly/wildfly/pull/13410#pullrequestreview-462651487", "createdAt": "2020-08-06T15:52:25Z", "commit": {"oid": "2bc2e8921e96347830587ac45b2ee0440f9c7598"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56e43f5cb43dd4d606afa5f097654098b490936b", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/56e43f5cb43dd4d606afa5f097654098b490936b", "committedDate": "2020-08-29T03:09:14Z", "message": "Merge branch 'master' into WFLY-13177"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDkzMjYx", "url": "https://github.com/wildfly/wildfly/pull/13410#pullrequestreview-478093261", "createdAt": "2020-08-29T03:10:22Z", "commit": {"oid": "56e43f5cb43dd4d606afa5f097654098b490936b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c92d70651da9855cdcecdcff29fb29bfaedee22", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/5c92d70651da9855cdcecdcff29fb29bfaedee22", "committedDate": "2020-08-29T14:19:15Z", "message": "Update ManagedExecutorServiceMetricsTestCase.java\n\nRemove trailing spaces introduced in the merge commit."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3900, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}