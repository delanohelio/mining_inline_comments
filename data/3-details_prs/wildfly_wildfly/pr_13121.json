{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NzU4ODE3", "number": 13121, "title": "WFLY-13147 Avoid processing deployments multiple times in Weld subsys\u2026", "bodyText": "\u2026tem.\nJIRA - https://issues.redhat.com/browse/WFLY-13147\nThis basically a copy of what the issue suggsested as code changes. All in all those changes make sense in avoiding loading dep modules that we know were/will be processed as separate units. Simple tests pass for me (as in tests in this repo executed with -DallTests).\nHowever, I don't have a big enough sample to actually measure the impact on re-deploy times on a kind of application that it was reported against - @bstansberry does WFLY have some perf tests for deployment where this could be measured?\nOr really, any more \"obscure\" deployment tests that we could/should run against.\nCCing @mkouba just in case he has some thoughts about these changes.", "createdAt": "2020-03-17T10:44:31Z", "url": "https://github.com/wildfly/wildfly/pull/13121", "merged": true, "mergeCommit": {"oid": "3ea226991c89da553da53b8ea6df97318c5689ab"}, "closed": true, "closedAt": "2020-04-08T14:36:36Z", "author": {"login": "manovotn"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPmj_ZgFqTM3ODc5MzE4NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVT3O4gBqjMyMTAwMjk1NDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NzkzMTg0", "url": "https://github.com/wildfly/wildfly/pull/13121#pullrequestreview-378793184", "createdAt": "2020-03-20T20:30:39Z", "commit": {"oid": "5b57472f80d59684c69d368283b14e92ace10f05"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMDozMDozOVrOF5iU0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMDozMDozOVrOF5iU0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3NTUzNg==", "bodyText": "This comment is confusing because for using the example values the code would amount to \"123abc.ear\".endsWith(\"deployment.123abc.ear\") which would never be true.", "url": "https://github.com/wildfly/wildfly/pull/13121#discussion_r395875536", "createdAt": "2020-03-20T20:30:39Z", "author": {"login": "bstansberry"}, "path": "weld/subsystem/src/main/java/org/jboss/as/weld/deployment/processors/ExternalBeanArchiveProcessor.java", "diffHunk": "@@ -162,6 +162,14 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n                 return;\n             }\n             for (DependencySpec dep : module.getDependencies()) {\n+                if (!(dep instanceof ModuleDependencySpec)) {\n+                    continue;\n+                }\n+                if (deploymentUnits.stream().anyMatch(d -> (((ModuleDependencySpec) dep).getName()).endsWith(d.getName()))) {\n+                    // d.getName() returns deployment.123abc.ear, whereas dep.getName() returns 123abc.ear", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b57472f80d59684c69d368283b14e92ace10f05"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b57472f80d59684c69d368283b14e92ace10f05", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/wildfly/wildfly/commit/5b57472f80d59684c69d368283b14e92ace10f05", "committedDate": "2020-03-17T10:26:35Z", "message": "WFLY-13147 Avoid processing deployments multiple times in Weld subsystem."}, "afterCommit": {"oid": "52af6b598178e57db1ca98dfef3b4adfd4dafaf6", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/wildfly/wildfly/commit/52af6b598178e57db1ca98dfef3b4adfd4dafaf6", "committedDate": "2020-04-07T11:55:30Z", "message": "WFLY-13147 Avoid processing deployments multiple times in Weld subsystem."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDkzNzEw", "url": "https://github.com/wildfly/wildfly/pull/13121#pullrequestreview-389093710", "createdAt": "2020-04-07T13:04:40Z", "commit": {"oid": "52af6b598178e57db1ca98dfef3b4adfd4dafaf6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzowNDo0MFrOGCCh-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzowNDo0MFrOGCCh-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5MTgwMQ==", "bodyText": "My only \"maybe\" suggestion is earlier in this method when looping through the DeploymentUnits, built up a Set containing \"deployment.\" + d.getName().  Then here just do a contains check against that set.", "url": "https://github.com/wildfly/wildfly/pull/13121#discussion_r404791801", "createdAt": "2020-04-07T13:04:40Z", "author": {"login": "bstansberry"}, "path": "weld/subsystem/src/main/java/org/jboss/as/weld/deployment/processors/ExternalBeanArchiveProcessor.java", "diffHunk": "@@ -162,6 +162,14 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n                 return;\n             }\n             for (DependencySpec dep : module.getDependencies()) {\n+                if (!(dep instanceof ModuleDependencySpec)) {\n+                    continue;\n+                }\n+                if (deploymentUnits.stream().anyMatch(d -> (((ModuleDependencySpec) dep).getName()).endsWith(d.getName()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52af6b598178e57db1ca98dfef3b4adfd4dafaf6"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "925e0858558fe351a356914031e146f8b5ee3f0b", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/wildfly/wildfly/commit/925e0858558fe351a356914031e146f8b5ee3f0b", "committedDate": "2020-04-07T13:50:44Z", "message": "WFLY-13147 Avoid processing deployments multiple times in Weld subsystem."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52af6b598178e57db1ca98dfef3b4adfd4dafaf6", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/wildfly/wildfly/commit/52af6b598178e57db1ca98dfef3b4adfd4dafaf6", "committedDate": "2020-04-07T11:55:30Z", "message": "WFLY-13147 Avoid processing deployments multiple times in Weld subsystem."}, "afterCommit": {"oid": "925e0858558fe351a356914031e146f8b5ee3f0b", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/wildfly/wildfly/commit/925e0858558fe351a356914031e146f8b5ee3f0b", "committedDate": "2020-04-07T13:50:44Z", "message": "WFLY-13147 Avoid processing deployments multiple times in Weld subsystem."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3566, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}