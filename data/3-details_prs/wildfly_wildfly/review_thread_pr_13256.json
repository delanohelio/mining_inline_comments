{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNjU3NDcw", "number": 13256, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOToxNzoyN1rOD4LHzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxMDoxNlrOD574zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjI5MDY5OnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOToxNzoyN1rOGO29SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOToxNzoyN1rOGO29SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIzMzY3Mw==", "bodyText": "This is more efficiently stored as:\n    Map<Class<? extends Annotation>, Set<String>> ejbTypes = new IdentityHashMap<>();\n    ejbTypes.put(javax.ejb.Stateful.class, new HashSet<>());\n    ejbTypes.put(javax.ejb.Stateless.class, new HashSet<>());\n    ejbTypes.put(javax.ejb.Singleton.class, new HashSet<>());", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r418233673", "createdAt": "2020-04-30T19:17:27Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        HashMap<String,HashSet<String>> ejbClassTypes = new HashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f35deab274f87b9a4d6a034158c3a0c9e70717ab"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjMzOTcyOnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOTozMzowNFrOGO3cWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOTozMzowNFrOGO3cWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0MTYyNQ==", "bodyText": "Using the above data structure, this method is unnecessary.", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r418241625", "createdAt": "2020-04-30T19:33:04Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -274,6 +283,32 @@ private void logBinding(final StringBuilder jndiBindingsLogMessage, final String\n         jndiBindingsLogMessage.append(System.lineSeparator());\n     }\n \n+    private boolean checkBeanTypeSpecViolation(HashMap<String,HashSet<String>> ejbClassTypes, SessionBeanComponentDescription ejbComponentDescription) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f35deab274f87b9a4d6a034158c3a0c9e70717ab"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjMzOTgyOnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOTozMzowNlrOGO3caA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxOTozMzowNlrOGO3caA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI0MTY0MA==", "bodyText": "Using the above data structure, this spec violation check is simple:\nEJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\nString ejbClassName = ejbComponentDescription.getEJBClassName();\nif (ejbClassTypes.putIfAbsent(ejbClassName, ejbComponentDescription) == null) {\n    this.setupJNDIBindings(ejbComponentDescription, deploymentUnit);\n} else {\n    EjbLogger.DEPLOYMENT_LOGGER.typeSpecViolation(ejbClassName);\n}", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r418241640", "createdAt": "2020-04-30T19:33:06Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        HashMap<String,HashSet<String>> ejbClassTypes = new HashMap();\n+        ejbClassTypes.put(\"isStateful\",new HashSet<>());\n+        ejbClassTypes.put(\"isStateless\",new HashSet<>());\n+        ejbClassTypes.put(\"isSingleton\",new HashSet<>());\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    if(!checkBeanTypeSpecViolation(ejbClassTypes,(SessionBeanComponentDescription)componentDescription))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f35deab274f87b9a4d6a034158c3a0c9e70717ab"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDgwNzc0OnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "isResolved": true, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTo1MDo1NlrOGQl0GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMjo0MjoyOVrOGRRGVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0OTk0NA==", "bodyText": "I don't understand the need for these other conditions.  An EJB class name should only ever have 1 ejb component description (regardless of it's type).  Consequently, a simple putIfAbsent should be all that is needed to ensure there are not multiple type declarations.\nTo me, these other checks look redundant.  Am I missing something?", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420049944", "createdAt": "2020-05-05T11:50:56Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        Map<String, EJBComponentDescription> ejbClassTypeDefined = new HashMap<>();\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    EJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\n+                    String ejbClassName = ejbComponentDescription.getEJBClassName();\n+                    if ((ejbClassTypeDefined.putIfAbsent(ejbClassName,ejbComponentDescription) == null || !((ejbClassTypeDefined.get(ejbClassName).isSingleton() && (ejbComponentDescription.isStateful() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateful() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateless() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateful()))))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA3MDU2Mw==", "bodyText": "Hello Paul. I am still doing some checks, but maybe there could exist multiple session beans (of same type) with different names from the same class  that should be allowed to be created.", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420070563", "createdAt": "2020-05-05T12:29:30Z", "author": {"login": "panossot"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        Map<String, EJBComponentDescription> ejbClassTypeDefined = new HashMap<>();\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    EJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\n+                    String ejbClassName = ejbComponentDescription.getEJBClassName();\n+                    if ((ejbClassTypeDefined.putIfAbsent(ejbClassName,ejbComponentDescription) == null || !((ejbClassTypeDefined.get(ejbClassName).isSingleton() && (ejbComponentDescription.isStateful() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateful() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateless() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateful()))))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0OTk0NA=="}, "originalCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE1MTA1Nw==", "bodyText": "maybe there could exist multiple session beans (of same type) with different names from the same class\n\nI don't think this is possible, but perhaps I have not fully understood your meaning.  Can you provide an example?\nAIUI, an EJB class has a single component description.  That description might have multiple views (e.g. @Local vs @Remote), but there is still only a single EJB component description which is of a single session type (@Stateless vs @Stateful vs @Singleton).", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420151057", "createdAt": "2020-05-05T14:25:32Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        Map<String, EJBComponentDescription> ejbClassTypeDefined = new HashMap<>();\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    EJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\n+                    String ejbClassName = ejbComponentDescription.getEJBClassName();\n+                    if ((ejbClassTypeDefined.putIfAbsent(ejbClassName,ejbComponentDescription) == null || !((ejbClassTypeDefined.get(ejbClassName).isSingleton() && (ejbComponentDescription.isStateful() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateful() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateless() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateful()))))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0OTk0NA=="}, "originalCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE5NzY3NQ==", "bodyText": "For example ...\nenterprise-beans>\nsession>\nejb-name>Name1\nejb-class>EjbClass1\nsession-type>Stateless\n/session>\nsession>\nejb-name>Name2\nejb-class>EjbClass1\nsession-type>Stateless\n/session>\n/enterprise-beans>", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420197675", "createdAt": "2020-05-05T15:26:46Z", "author": {"login": "panossot"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        Map<String, EJBComponentDescription> ejbClassTypeDefined = new HashMap<>();\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    EJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\n+                    String ejbClassName = ejbComponentDescription.getEJBClassName();\n+                    if ((ejbClassTypeDefined.putIfAbsent(ejbClassName,ejbComponentDescription) == null || !((ejbClassTypeDefined.get(ejbClassName).isSingleton() && (ejbComponentDescription.isStateful() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateful() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateless() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateful()))))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0OTk0NA=="}, "originalCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDIwMDMwMQ==", "bodyText": "Sorry about the format ...", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420200301", "createdAt": "2020-05-05T15:30:05Z", "author": {"login": "panossot"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        Map<String, EJBComponentDescription> ejbClassTypeDefined = new HashMap<>();\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    EJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\n+                    String ejbClassName = ejbComponentDescription.getEJBClassName();\n+                    if ((ejbClassTypeDefined.putIfAbsent(ejbClassName,ejbComponentDescription) == null || !((ejbClassTypeDefined.get(ejbClassName).isSingleton() && (ejbComponentDescription.isStateful() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateful() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateless() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateful()))))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0OTk0NA=="}, "originalCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM2MTU5Mg==", "bodyText": "I don't see anything in the EJB specification that suggests that a given module can contain multiple beans with the same ejb-class (where each has a distinct ejb-name).  On the contrary, this is explicitly disallowed via EJB annotations, evident by the fact that:\n\nthe name property of the @Stateless, @Stateful, and @Singleton annotations is a String, not a String[], e.g. @Stateless(name = { \"name1\", \"name2\" })\nthe @Stateless, @Stateful, and @Singleton annotations are not @Repeatable, which would otherwise allow the user to define multiple names for the same bean class, e.g.@Stateless(name = \"name1\") @Stateless(name = \"name2\")\n\nWhat possible use case would require multiple beans sharing the same implementation class within the same module?", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420361592", "createdAt": "2020-05-05T19:43:11Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        Map<String, EJBComponentDescription> ejbClassTypeDefined = new HashMap<>();\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    EJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\n+                    String ejbClassName = ejbComponentDescription.getEJBClassName();\n+                    if ((ejbClassTypeDefined.putIfAbsent(ejbClassName,ejbComponentDescription) == null || !((ejbClassTypeDefined.get(ejbClassName).isSingleton() && (ejbComponentDescription.isStateful() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateful() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateless() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateful()))))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0OTk0NA=="}, "originalCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU4NjIzOQ==", "bodyText": "Ejbs with different names could be enriched with different interceptors ...", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420586239", "createdAt": "2020-05-06T07:12:00Z", "author": {"login": "panossot"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        Map<String, EJBComponentDescription> ejbClassTypeDefined = new HashMap<>();\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    EJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\n+                    String ejbClassName = ejbComponentDescription.getEJBClassName();\n+                    if ((ejbClassTypeDefined.putIfAbsent(ejbClassName,ejbComponentDescription) == null || !((ejbClassTypeDefined.get(ejbClassName).isSingleton() && (ejbComponentDescription.isStateful() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateful() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateless() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateful()))))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0OTk0NA=="}, "originalCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc1OTEyNg==", "bodyText": "OK - I see how that could be useful.  Additionally, a quick stackoverflow search found that there are indeed users relying on this behavior (though I would still consider this unspecified spec behavior).\nWe can allow multiple beans of the same type per class and still simplify the expression above.\ne.g.\n        Map<String, SessionBeanComponentDescription> sessionBeanComponentDescriptions = new HashMap<>();\n        if (componentDescriptions != null) {\n            for (ComponentDescription componentDescription : componentDescriptions) {\n                // process only EJB session beans\n                if (componentDescription instanceof SessionBeanComponentDescription) {\n                    SessionBeanComponentDescription sessionBeanComponentDescription = (SessionBeanComponentDescription) componentDescription;\n                    String ejbClassName = sessionBeanComponentDescription.getEJBClassName();\n                    SessionBeanComponentDescription existingDescription = sessionBeanComponentDescription.putIfAbsent(ejbClassName, sessionBeanComponentDescription);\n                    if ((existingDescription == null) || existingDescription.getSessionBeanType() == sessionBeanComponentDescription.getSessionBeanType()) {\n                        this.setupJNDIBindings(ejbComponentDescription, deploymentUnit);\n                    } else {\n                        EjbLogger.DEPLOYMENT_LOGGER.typeSpecViolation(ejbClassName);\n                    }\n                }\n            }\n        }", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420759126", "createdAt": "2020-05-06T12:42:29Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/deployment/processors/EjbJndiBindingsDeploymentUnitProcessor.java", "diffHunk": "@@ -79,11 +81,18 @@ public void deploy(DeploymentPhaseContext phaseContext) throws DeploymentUnitPro\n \n         final EEModuleDescription eeModuleDescription = deploymentUnit.getAttachment(Attachments.EE_MODULE_DESCRIPTION);\n         final Collection<ComponentDescription> componentDescriptions = eeModuleDescription.getComponentDescriptions();\n+        Map<String, EJBComponentDescription> ejbClassTypeDefined = new HashMap<>();\n         if (componentDescriptions != null) {\n             for (ComponentDescription componentDescription : componentDescriptions) {\n                 // process only EJB session beans\n                 if (componentDescription instanceof SessionBeanComponentDescription) {\n-                    this.setupJNDIBindings((EJBComponentDescription) componentDescription, deploymentUnit);\n+                    EJBComponentDescription ejbComponentDescription = (EJBComponentDescription) componentDescription;\n+                    String ejbClassName = ejbComponentDescription.getEJBClassName();\n+                    if ((ejbClassTypeDefined.putIfAbsent(ejbClassName,ejbComponentDescription) == null || !((ejbClassTypeDefined.get(ejbClassName).isSingleton() && (ejbComponentDescription.isStateful() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateful() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateless())) || (ejbClassTypeDefined.get(ejbClassName).isStateless() && (ejbComponentDescription.isSingleton() || ejbComponentDescription.isStateful()))))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0OTk0NA=="}, "originalCommit": {"oid": "4749a30b879bf7bacf49deb9a8a802b72cc26377"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMDc2NjIxOnYy", "diffSide": "RIGHT", "path": "ejb3/src/main/java/org/jboss/as/ejb3/logging/EjbLogger.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxMDoxNlrOGRfUFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxODoxMDoxNlrOGRfUFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5MjAyMA==", "bodyText": "violetion should read violation\nSessionBeans should read Session EJBs", "url": "https://github.com/wildfly/wildfly/pull/13256#discussion_r420992020", "createdAt": "2020-05-06T18:10:16Z", "author": {"login": "pferraro"}, "path": "ejb3/src/main/java/org/jboss/as/ejb3/logging/EjbLogger.java", "diffHunk": "@@ -3204,4 +3204,8 @@\n     @LogMessage(level = WARN)\n     @Message(id = 515, value = \"[EJB3.2 spec, section 4.9.2] Singleton session beans are not allowed to implement 'javax.ejb.SessionBean' interface. This interface on bean '%s' is going to be ignored and should be removed.\")\n     void singletonCantImplementSessionBean(String className);\n+\n+    @LogMessage(level = ERROR)\n+    @Message(id = 517, value = \"[EJB3.2 spec, section 4.1] Spec violetion for class %s. SessionBeans should have only one of the following types : Stateful, Stateless, Singleton.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a59de3d694b25e88c595b34d5c1a0a960ebbd35c"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3916, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}