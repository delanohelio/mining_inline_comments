{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2ODQ0NjE4", "number": 13161, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOToyMTowN1rODtcoZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTozMzoyN1rODtc8hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTgxNjA2OnYy", "diffSide": "RIGHT", "path": "microprofile/opentracing-smallrye/src/main/java/org/wildfly/microprofile/opentracing/smallrye/TracingCDIExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOToyMTowN1rOF-3-YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOToyMTowN1rOF-3-YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ3MzEyMA==", "bodyText": "Remove this TODO, according to the log message, it is intentional to remove any other Trace implementation.", "url": "https://github.com/wildfly/wildfly/pull/13161#discussion_r401473120", "createdAt": "2020-04-01T09:21:07Z", "author": {"login": "manovotn"}, "path": "microprofile/opentracing-smallrye/src/main/java/org/wildfly/microprofile/opentracing/smallrye/TracingCDIExtension.java", "diffHunk": "@@ -19,26 +19,45 @@\n  * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n  * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n  */\n-\n package org.wildfly.microprofile.opentracing.smallrye;\n \n import io.opentracing.Tracer;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.WeakHashMap;\n \n import javax.enterprise.event.Observes;\n-import javax.enterprise.inject.spi.BeanManager;\n-import javax.enterprise.inject.spi.BeforeBeanDiscovery;\n+import javax.enterprise.inject.spi.AfterBeanDiscovery;\n+import javax.enterprise.inject.spi.BeforeShutdown;\n import javax.enterprise.inject.spi.Extension;\n import javax.enterprise.inject.spi.ProcessAnnotatedType;\n \n public class TracingCDIExtension implements Extension {\n \n-    public void observeBeforeBeanDiscovery(@Observes BeforeBeanDiscovery bbd, BeanManager manager) {\n-        String extensionName = TracingCDIExtension.class.getName();\n-        bbd.addAnnotatedType(manager.createAnnotatedType(TracerProducer.class), extensionName + \"-\" + TracerProducer.class.getName());\n+    private static final Map<ClassLoader, Tracer> TRACERS = Collections.synchronizedMap(new WeakHashMap<>());\n+\n+    public static void registerApplicationTracer(ClassLoader classLoader, Tracer tracerInstance) {\n+        TRACERS.put(classLoader, tracerInstance);\n+    }\n+\n+    public void registerTracerBean(@Observes AfterBeanDiscovery abd) {\n+        abd.addBean().addTransitiveTypeClosure(Tracer.class).produceWith(i -> {\n+            return TRACERS.get(Thread.currentThread().getContextClassLoader());\n+        });\n     }\n \n+    // TODO I suppose this somehow prevents other tracer impls from being picked up? Needs confirmation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80e053595bf4cdd61857e446404a7ef07df4626e"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTg0NzIyOnYy", "diffSide": "RIGHT", "path": "microprofile/opentracing-extension/src/main/java/org/wildfly/extension/microprofile/opentracing/TracingDeploymentProcessor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOToyODozN1rOF-4RYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMzoxMTowNFrOF-_3Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ3Nzk4NA==", "bodyText": "You could probably remove this now, the only usage is in TracerDynamicFeature which again needs req. context active (not sure if it can be a problem there). Instead, you could either @Inject the Tracer if that's supported (not sure now, I might just be confused from Quarkus) or use CDI.current() to grab it.", "url": "https://github.com/wildfly/wildfly/pull/13161#discussion_r401477984", "createdAt": "2020-04-01T09:28:37Z", "author": {"login": "manovotn"}, "path": "microprofile/opentracing-extension/src/main/java/org/wildfly/extension/microprofile/opentracing/TracingDeploymentProcessor.java", "diffHunk": "@@ -210,6 +211,7 @@ private void injectTracer(DeploymentPhaseContext deploymentPhaseContext, Capabil\n                 tracer = WildFlyTracerFactory.getTracer(tracerConfigurationName, serviceName);\n             }\n         }\n+        TracingCDIExtension.registerApplicationTracer(moduleCL, tracer);\n         deploymentUnit.addToAttachmentList(ServletContextAttribute.ATTACHMENT_KEY, new ServletContextAttribute(SMALLRYE_OPENTRACING_SERVICE_NAME, serviceName));\n         deploymentUnit.addToAttachmentList(ServletContextAttribute.ATTACHMENT_KEY, new ServletContextAttribute(SMALLRYE_OPENTRACING_TRACER, tracer));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80e053595bf4cdd61857e446404a7ef07df4626e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYwMjQwNw==", "bodyText": "It broke a lot of tests related to CDI", "url": "https://github.com/wildfly/wildfly/pull/13161#discussion_r401602407", "createdAt": "2020-04-01T13:11:04Z", "author": {"login": "ehsavoie"}, "path": "microprofile/opentracing-extension/src/main/java/org/wildfly/extension/microprofile/opentracing/TracingDeploymentProcessor.java", "diffHunk": "@@ -210,6 +211,7 @@ private void injectTracer(DeploymentPhaseContext deploymentPhaseContext, Capabil\n                 tracer = WildFlyTracerFactory.getTracer(tracerConfigurationName, serviceName);\n             }\n         }\n+        TracingCDIExtension.registerApplicationTracer(moduleCL, tracer);\n         deploymentUnit.addToAttachmentList(ServletContextAttribute.ATTACHMENT_KEY, new ServletContextAttribute(SMALLRYE_OPENTRACING_SERVICE_NAME, serviceName));\n         deploymentUnit.addToAttachmentList(ServletContextAttribute.ATTACHMENT_KEY, new ServletContextAttribute(SMALLRYE_OPENTRACING_TRACER, tracer));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ3Nzk4NA=="}, "originalCommit": {"oid": "80e053595bf4cdd61857e446404a7ef07df4626e"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTg2NzU2OnYy", "diffSide": "RIGHT", "path": "microprofile/opentracing-smallrye/src/main/java/org/wildfly/microprofile/opentracing/smallrye/TracingCDIExtension.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTozMzoyN1rOF-4d4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNDoyMjoxNlrOF_DBbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ4MTE4Nw==", "bodyText": "Maybe also add .scope(ApplicationScoped.class). This won't have any functional impact (apart from using proxy) as you are already sharing the instance, but it is a \"cleaner\" way to declare a bean that in fact is app-wide.", "url": "https://github.com/wildfly/wildfly/pull/13161#discussion_r401481187", "createdAt": "2020-04-01T09:33:27Z", "author": {"login": "manovotn"}, "path": "microprofile/opentracing-smallrye/src/main/java/org/wildfly/microprofile/opentracing/smallrye/TracingCDIExtension.java", "diffHunk": "@@ -19,26 +19,45 @@\n  * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n  * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n  */\n-\n package org.wildfly.microprofile.opentracing.smallrye;\n \n import io.opentracing.Tracer;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.WeakHashMap;\n \n import javax.enterprise.event.Observes;\n-import javax.enterprise.inject.spi.BeanManager;\n-import javax.enterprise.inject.spi.BeforeBeanDiscovery;\n+import javax.enterprise.inject.spi.AfterBeanDiscovery;\n+import javax.enterprise.inject.spi.BeforeShutdown;\n import javax.enterprise.inject.spi.Extension;\n import javax.enterprise.inject.spi.ProcessAnnotatedType;\n \n public class TracingCDIExtension implements Extension {\n \n-    public void observeBeforeBeanDiscovery(@Observes BeforeBeanDiscovery bbd, BeanManager manager) {\n-        String extensionName = TracingCDIExtension.class.getName();\n-        bbd.addAnnotatedType(manager.createAnnotatedType(TracerProducer.class), extensionName + \"-\" + TracerProducer.class.getName());\n+    private static final Map<ClassLoader, Tracer> TRACERS = Collections.synchronizedMap(new WeakHashMap<>());\n+\n+    public static void registerApplicationTracer(ClassLoader classLoader, Tracer tracerInstance) {\n+        TRACERS.put(classLoader, tracerInstance);\n+    }\n+\n+    public void registerTracerBean(@Observes AfterBeanDiscovery abd) {\n+        abd.addBean().addTransitiveTypeClosure(Tracer.class).produceWith(i -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80e053595bf4cdd61857e446404a7ef07df4626e"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU5MjI5OQ==", "bodyText": "@ehsavoie Did this input get dropped?", "url": "https://github.com/wildfly/wildfly/pull/13161#discussion_r401592299", "createdAt": "2020-04-01T12:55:14Z", "author": {"login": "bstansberry"}, "path": "microprofile/opentracing-smallrye/src/main/java/org/wildfly/microprofile/opentracing/smallrye/TracingCDIExtension.java", "diffHunk": "@@ -19,26 +19,45 @@\n  * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n  * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n  */\n-\n package org.wildfly.microprofile.opentracing.smallrye;\n \n import io.opentracing.Tracer;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.WeakHashMap;\n \n import javax.enterprise.event.Observes;\n-import javax.enterprise.inject.spi.BeanManager;\n-import javax.enterprise.inject.spi.BeforeBeanDiscovery;\n+import javax.enterprise.inject.spi.AfterBeanDiscovery;\n+import javax.enterprise.inject.spi.BeforeShutdown;\n import javax.enterprise.inject.spi.Extension;\n import javax.enterprise.inject.spi.ProcessAnnotatedType;\n \n public class TracingCDIExtension implements Extension {\n \n-    public void observeBeforeBeanDiscovery(@Observes BeforeBeanDiscovery bbd, BeanManager manager) {\n-        String extensionName = TracingCDIExtension.class.getName();\n-        bbd.addAnnotatedType(manager.createAnnotatedType(TracerProducer.class), extensionName + \"-\" + TracerProducer.class.getName());\n+    private static final Map<ClassLoader, Tracer> TRACERS = Collections.synchronizedMap(new WeakHashMap<>());\n+\n+    public static void registerApplicationTracer(ClassLoader classLoader, Tracer tracerInstance) {\n+        TRACERS.put(classLoader, tracerInstance);\n+    }\n+\n+    public void registerTracerBean(@Observes AfterBeanDiscovery abd) {\n+        abd.addBean().addTransitiveTypeClosure(Tracer.class).produceWith(i -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ4MTE4Nw=="}, "originalCommit": {"oid": "80e053595bf4cdd61857e446404a7ef07df4626e"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU5NzIyMw==", "bodyText": "We talked on zulip. Apparently the proxy interferes with some places where the contextual instance is needed.", "url": "https://github.com/wildfly/wildfly/pull/13161#discussion_r401597223", "createdAt": "2020-04-01T13:02:52Z", "author": {"login": "manovotn"}, "path": "microprofile/opentracing-smallrye/src/main/java/org/wildfly/microprofile/opentracing/smallrye/TracingCDIExtension.java", "diffHunk": "@@ -19,26 +19,45 @@\n  * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n  * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n  */\n-\n package org.wildfly.microprofile.opentracing.smallrye;\n \n import io.opentracing.Tracer;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.WeakHashMap;\n \n import javax.enterprise.event.Observes;\n-import javax.enterprise.inject.spi.BeanManager;\n-import javax.enterprise.inject.spi.BeforeBeanDiscovery;\n+import javax.enterprise.inject.spi.AfterBeanDiscovery;\n+import javax.enterprise.inject.spi.BeforeShutdown;\n import javax.enterprise.inject.spi.Extension;\n import javax.enterprise.inject.spi.ProcessAnnotatedType;\n \n public class TracingCDIExtension implements Extension {\n \n-    public void observeBeforeBeanDiscovery(@Observes BeforeBeanDiscovery bbd, BeanManager manager) {\n-        String extensionName = TracingCDIExtension.class.getName();\n-        bbd.addAnnotatedType(manager.createAnnotatedType(TracerProducer.class), extensionName + \"-\" + TracerProducer.class.getName());\n+    private static final Map<ClassLoader, Tracer> TRACERS = Collections.synchronizedMap(new WeakHashMap<>());\n+\n+    public static void registerApplicationTracer(ClassLoader classLoader, Tracer tracerInstance) {\n+        TRACERS.put(classLoader, tracerInstance);\n+    }\n+\n+    public void registerTracerBean(@Observes AfterBeanDiscovery abd) {\n+        abd.addBean().addTransitiveTypeClosure(Tracer.class).produceWith(i -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ4MTE4Nw=="}, "originalCommit": {"oid": "80e053595bf4cdd61857e446404a7ef07df4626e"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYwMTkyNg==", "bodyText": "I'm currently trying to fix the test suite which is talking more time then I thought", "url": "https://github.com/wildfly/wildfly/pull/13161#discussion_r401601926", "createdAt": "2020-04-01T13:10:20Z", "author": {"login": "ehsavoie"}, "path": "microprofile/opentracing-smallrye/src/main/java/org/wildfly/microprofile/opentracing/smallrye/TracingCDIExtension.java", "diffHunk": "@@ -19,26 +19,45 @@\n  * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n  * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n  */\n-\n package org.wildfly.microprofile.opentracing.smallrye;\n \n import io.opentracing.Tracer;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.WeakHashMap;\n \n import javax.enterprise.event.Observes;\n-import javax.enterprise.inject.spi.BeanManager;\n-import javax.enterprise.inject.spi.BeforeBeanDiscovery;\n+import javax.enterprise.inject.spi.AfterBeanDiscovery;\n+import javax.enterprise.inject.spi.BeforeShutdown;\n import javax.enterprise.inject.spi.Extension;\n import javax.enterprise.inject.spi.ProcessAnnotatedType;\n \n public class TracingCDIExtension implements Extension {\n \n-    public void observeBeforeBeanDiscovery(@Observes BeforeBeanDiscovery bbd, BeanManager manager) {\n-        String extensionName = TracingCDIExtension.class.getName();\n-        bbd.addAnnotatedType(manager.createAnnotatedType(TracerProducer.class), extensionName + \"-\" + TracerProducer.class.getName());\n+    private static final Map<ClassLoader, Tracer> TRACERS = Collections.synchronizedMap(new WeakHashMap<>());\n+\n+    public static void registerApplicationTracer(ClassLoader classLoader, Tracer tracerInstance) {\n+        TRACERS.put(classLoader, tracerInstance);\n+    }\n+\n+    public void registerTracerBean(@Observes AfterBeanDiscovery abd) {\n+        abd.addBean().addTransitiveTypeClosure(Tracer.class).produceWith(i -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ4MTE4Nw=="}, "originalCommit": {"oid": "80e053595bf4cdd61857e446404a7ef07df4626e"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY1NDEyNQ==", "bodyText": "This change breaks with ear as the tracer will now be shared across all the ear and so all its wars", "url": "https://github.com/wildfly/wildfly/pull/13161#discussion_r401654125", "createdAt": "2020-04-01T14:22:16Z", "author": {"login": "ehsavoie"}, "path": "microprofile/opentracing-smallrye/src/main/java/org/wildfly/microprofile/opentracing/smallrye/TracingCDIExtension.java", "diffHunk": "@@ -19,26 +19,45 @@\n  * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n  * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n  */\n-\n package org.wildfly.microprofile.opentracing.smallrye;\n \n import io.opentracing.Tracer;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.WeakHashMap;\n \n import javax.enterprise.event.Observes;\n-import javax.enterprise.inject.spi.BeanManager;\n-import javax.enterprise.inject.spi.BeforeBeanDiscovery;\n+import javax.enterprise.inject.spi.AfterBeanDiscovery;\n+import javax.enterprise.inject.spi.BeforeShutdown;\n import javax.enterprise.inject.spi.Extension;\n import javax.enterprise.inject.spi.ProcessAnnotatedType;\n \n public class TracingCDIExtension implements Extension {\n \n-    public void observeBeforeBeanDiscovery(@Observes BeforeBeanDiscovery bbd, BeanManager manager) {\n-        String extensionName = TracingCDIExtension.class.getName();\n-        bbd.addAnnotatedType(manager.createAnnotatedType(TracerProducer.class), extensionName + \"-\" + TracerProducer.class.getName());\n+    private static final Map<ClassLoader, Tracer> TRACERS = Collections.synchronizedMap(new WeakHashMap<>());\n+\n+    public static void registerApplicationTracer(ClassLoader classLoader, Tracer tracerInstance) {\n+        TRACERS.put(classLoader, tracerInstance);\n+    }\n+\n+    public void registerTracerBean(@Observes AfterBeanDiscovery abd) {\n+        abd.addBean().addTransitiveTypeClosure(Tracer.class).produceWith(i -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ4MTE4Nw=="}, "originalCommit": {"oid": "80e053595bf4cdd61857e446404a7ef07df4626e"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3949, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}