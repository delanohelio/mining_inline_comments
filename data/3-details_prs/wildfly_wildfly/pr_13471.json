{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0ODU2Mzc3", "number": 13471, "title": "WFLY-13736 Force weld restart more eagerly", "bodyText": "https://issues.redhat.com/browse/WFLY-13736\nFollows up on #13454 with a commit excluding the new test in testsuite executions that don't support EJB.", "createdAt": "2020-08-07T22:24:20Z", "url": "https://github.com/wildfly/wildfly/pull/13471", "merged": true, "mergeCommit": {"oid": "302d533c67505e789579d948c3118565a3300fd6"}, "closed": true, "closedAt": "2021-02-09T13:38:14Z", "author": {"login": "bstansberry"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABd0WkXoABqjQyNTc5MzE5NzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd4E67ngFqTU4NTM2NTkyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "980c370481f1c76b5dcaf1a216cd56d214ba3712", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/980c370481f1c76b5dcaf1a216cd56d214ba3712", "committedDate": "2020-08-07T22:21:58Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}, "afterCommit": {"oid": "e1282e10107221ecdcab9a84d552914cfc269d0a", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/e1282e10107221ecdcab9a84d552914cfc269d0a", "committedDate": "2021-01-27T05:35:23Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1282e10107221ecdcab9a84d552914cfc269d0a", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/e1282e10107221ecdcab9a84d552914cfc269d0a", "committedDate": "2021-01-27T05:35:23Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}, "afterCommit": {"oid": "e6b30f4dd69b23a162686e64f9fb0f8d1f89b097", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/e6b30f4dd69b23a162686e64f9fb0f8d1f89b097", "committedDate": "2021-01-28T01:00:04Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6b30f4dd69b23a162686e64f9fb0f8d1f89b097", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/e6b30f4dd69b23a162686e64f9fb0f8d1f89b097", "committedDate": "2021-01-28T01:00:04Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}, "afterCommit": {"oid": "9ce61a12ceb336f4633ceda1b76cc994034f21af", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/9ce61a12ceb336f4633ceda1b76cc994034f21af", "committedDate": "2021-01-28T04:20:33Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ce61a12ceb336f4633ceda1b76cc994034f21af", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/9ce61a12ceb336f4633ceda1b76cc994034f21af", "committedDate": "2021-01-28T04:20:33Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}, "afterCommit": {"oid": "4648457c7867f762448a2ced6e492837d97241e2", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/4648457c7867f762448a2ced6e492837d97241e2", "committedDate": "2021-01-28T05:53:32Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b590b5522c0c9c2977486f6fa4299591b4dff48", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/wildfly/wildfly/commit/5b590b5522c0c9c2977486f6fa4299591b4dff48", "committedDate": "2021-01-28T21:08:09Z", "message": "WFLY-13736 Force weld restart more eagerly\n\nThe avoids a situation where services that depend on the bootstrap\nservice will attempt to start and will fail as the service is no\nlonger usable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4648457c7867f762448a2ced6e492837d97241e2", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/4648457c7867f762448a2ced6e492837d97241e2", "committedDate": "2021-01-28T05:53:32Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}, "afterCommit": {"oid": "9d5f0a390c23c1c9c330bc4ea4d2175ccd1527e4", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/9d5f0a390c23c1c9c330bc4ea4d2175ccd1527e4", "committedDate": "2021-01-28T21:08:14Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgwOTY4MTg1", "url": "https://github.com/wildfly/wildfly/pull/13471#pullrequestreview-580968185", "createdAt": "2021-02-02T04:02:50Z", "commit": {"oid": "9d5f0a390c23c1c9c330bc4ea4d2175ccd1527e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMlQwNDowMjo1MVrOId-vNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMlQwNDowMjo1MVrOId-vNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODMwNzUwOQ==", "bodyText": "@stuartwdouglas Can this result in listenerDone not completing and fakeStabilityService leaking?", "url": "https://github.com/wildfly/wildfly/pull/13471#discussion_r568307509", "createdAt": "2021-02-02T04:02:51Z", "author": {"login": "bstansberry"}, "path": "weld/subsystem/src/main/java/org/jboss/as/weld/WeldBootstrapService.java", "diffHunk": "@@ -236,8 +305,91 @@ public boolean isStarted() {\n         return started;\n     }\n \n-    void setStarted(boolean started) {\n-        this.started = started;\n+    void startServiceShutdown() {\n+        //the start service has been shutdown, which means either we are being shutdown/undeployed\n+        //or we are going to need to bounce the whole deployment\n+        this.started = false;\n+        if (controller.getServiceContainer().isShutdown()) {\n+            //container is being shutdown, no action required\n+            return;\n+        }\n+        ServiceController<?> deploymentController = controller.getServiceContainer().getService(deploymentServiceName);\n+        if (deploymentController.getMode() != ServiceController.Mode.ACTIVE) {\n+            //deployment is not active, no action required\n+            return;\n+        }\n+        //add a listener to tentatively 'bounce' this service\n+        //if the service does actually restart then this will trigger a full deployment restart\n+        //we do it this way as we don't have visibility into MSC in the general sense\n+        //so we don't really know if this service is supposed to go away\n+        //this 'potential bounce' is hard to do in a non-racey manner\n+        //we need to add the listener first, but the listener may be invoked before the CAS to never\n+        CompletableFuture<Boolean> attemptingBounce = new CompletableFuture();\n+\n+        try {\n+            CompletableFuture<Boolean> listenerDone = new CompletableFuture<>();\n+            LifecycleListener listener = new LifecycleListener() {\n+                @Override\n+                public void handleEvent(final ServiceController<?> controller, final LifecycleEvent event) {\n+                    try {\n+                        try {\n+                            if (controller.getServiceContainer().isShutdown() || !attemptingBounce.get()) {\n+                                controller.removeListener(this);\n+                                return;\n+                            }\n+                        } catch (InterruptedException | ExecutionException e) {\n+                            throw new RuntimeException(e);\n+                        }\n+                        if (deploymentController.getMode() != ServiceController.Mode.ACTIVE ||\n+                                controller.getMode() == ServiceController.Mode.REMOVE) {\n+                            return;\n+                        }\n+                        if (event == LifecycleEvent.DOWN) {\n+                            controller.removeListener(this);\n+                            do {\n+                                if (controller.getMode() != ServiceController.Mode.NEVER) {\n+                                    return;\n+                                }\n+                            } while (!controller.compareAndSetMode(ServiceController.Mode.NEVER, ServiceController.Mode.ACTIVE));\n+                        }\n+                    } finally {\n+                        listenerDone.complete(true);\n+                    }\n+                }\n+            };\n+            //\n+            controller.getServiceContainer().addService(controller.getName().append(\"fakeStabilityService\")).setInstance(new Service() {\n+                @Override\n+                public void start(StartContext context) throws StartException {\n+                    context.asynchronous();\n+                    listenerDone.handle(new BiFunction<Boolean, Throwable, Object>() {\n+                        @Override\n+                        public Object apply(Boolean aBoolean, Throwable throwable) {\n+                            context.getController().setMode(ServiceController.Mode.REMOVE);\n+                            context.complete();\n+                            return null;\n+                        }\n+                    });\n+                }\n+\n+                @Override\n+                public void stop(StopContext context) {\n+\n+                }\n+            }).install();\n+            controller.addListener(listener);\n+            if (!controller.compareAndSetMode(ServiceController.Mode.ACTIVE, ServiceController.Mode.NEVER)) {\n+                controller.removeListener(listener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d5f0a390c23c1c9c330bc4ea4d2175ccd1527e4"}, "originalPosition": 279}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64b82e1a0bdb187f5f354fc06cd6d8fa319cdada", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/64b82e1a0bdb187f5f354fc06cd6d8fa319cdada", "committedDate": "2021-02-02T04:07:53Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d5f0a390c23c1c9c330bc4ea4d2175ccd1527e4", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/9d5f0a390c23c1c9c330bc4ea4d2175ccd1527e4", "committedDate": "2021-01-28T21:08:14Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}, "afterCommit": {"oid": "64b82e1a0bdb187f5f354fc06cd6d8fa319cdada", "author": {"user": {"login": "bstansberry", "name": " Brian Stansberry"}}, "url": "https://github.com/wildfly/wildfly/commit/64b82e1a0bdb187f5f354fc06cd6d8fa319cdada", "committedDate": "2021-02-02T04:07:53Z", "message": "[WFLY-13736] Disable EjbDependencyRestartTestCase in contexts that do not support EJB"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg1MzY1OTIx", "url": "https://github.com/wildfly/wildfly/pull/13471#pullrequestreview-585365921", "createdAt": "2021-02-08T10:40:59Z", "commit": {"oid": "64b82e1a0bdb187f5f354fc06cd6d8fa319cdada"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3955, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}