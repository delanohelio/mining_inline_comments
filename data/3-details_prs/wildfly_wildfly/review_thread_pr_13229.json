{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NjczMDg4", "number": 13229, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMDo0ODoxNFrOEkPA8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMDo0ODoxNFrOEkPA8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDMwMTk1OnYy", "diffSide": "RIGHT", "path": "testsuite/integration/elytron/src/test/java/org/wildfly/test/integration/elytron/ssl/UndertowTwoWaySslNeedClientAuthTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMDo0ODoxNFrOHTDqdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMDo0ODoxNFrOHTDqdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc0NTAxMw==", "bodyText": "The value returned from URL.getHost() is not valid input to new URI(String str).", "url": "https://github.com/wildfly/wildfly/pull/13229#discussion_r489745013", "createdAt": "2020-09-16T20:48:14Z", "author": {"login": "bstansberry"}, "path": "testsuite/integration/elytron/src/test/java/org/wildfly/test/integration/elytron/ssl/UndertowTwoWaySslNeedClientAuthTestCase.java", "diffHunk": "@@ -130,6 +146,153 @@ public void testSendingNoClientCertificateFails() {\n         closeClient(client);\n     }\n \n+    /**\n+     * RESTEasy client loads truststore from Elytron client configuration. This truststore contains correct server certificate.\n+     */\n+    @Test\n+    public void testResteasyElytronClientTrustedServer() {\n+        AuthenticationContext context = doPrivileged((PrivilegedAction<AuthenticationContext>) () -> {\n+            try {\n+                URL config = getClass().getResource(\"wildfly-config-correct-truststore.xml\");\n+                return ElytronXmlParser.parseAuthenticationClientConfiguration(config.toURI()).create();\n+            } catch (Throwable t) {\n+                throw new InvalidAuthenticationConfigurationException(t);\n+            }\n+        });\n+        context.run(() -> {\n+            ResteasyClientBuilder resteasyClientBuilder = (ResteasyClientBuilder) ClientBuilder.newBuilder().hostnameVerifier((s, sslSession) -> true);\n+            ResteasyClient client = resteasyClientBuilder.build();\n+            Response response = client.target(String.valueOf(securedRootUrl)).request().get();\n+            Assert.assertEquals(200, response.getStatus());\n+        });\n+    }\n+\n+    /**\n+     * RESTEasy client loads SSL Context from Elytron client config.\n+     * This SSL Context does not have truststore configured, so exception is expected.\n+     */\n+    @Test(expected = ProcessingException.class)\n+    public void testResteasyElytronClientMissingTruststore() {\n+        AuthenticationContext context = doPrivileged((PrivilegedAction<AuthenticationContext>) () -> {\n+            try {\n+                URL config = getClass().getResource(\"wildfly-config-correct-truststore-missing.xml\");\n+                return ElytronXmlParser.parseAuthenticationClientConfiguration(config.toURI()).create();\n+            } catch (Throwable t) {\n+                throw new InvalidAuthenticationConfigurationException(t);\n+            }\n+        });\n+        context.run(() -> {\n+            ResteasyClientBuilder resteasyClientBuilder = (ResteasyClientBuilder) ClientBuilder.newBuilder();\n+            ResteasyClient client = resteasyClientBuilder.build();\n+            Response response = client.target(String.valueOf(securedRootUrl)).request().get();\n+            Assert.assertEquals(\"Hello World!\", response.readEntity(String.class));\n+            Assert.assertEquals(200, response.getStatus());\n+        });\n+    }\n+\n+    /**\n+     * Elytron client has configured truststore that does not contain server's certificate.\n+     * Test will pass because Elytron config is ignored since different ssl context is specified on RESTEasy client builder specifically.\n+     */\n+    @Test\n+    public void testClientConfigProviderSSLContextIgnoredIfDifferentIsSet() throws URISyntaxException, GeneralSecurityException {\n+        AuthenticationContextConfigurationClient AUTH_CONTEXT_CLIENT =\n+                AccessController.doPrivileged((PrivilegedAction<AuthenticationContextConfigurationClient>) AuthenticationContextConfigurationClient::new);\n+\n+        AuthenticationContext context = doPrivileged((PrivilegedAction<AuthenticationContext>) () -> {\n+            try {\n+                URL config = getClass().getResource(\"wildfly-config-correct-truststore-missing.xml\");\n+                return ElytronXmlParser.parseAuthenticationClientConfiguration(config.toURI()).create();\n+            } catch (Throwable t) {\n+                throw new InvalidAuthenticationConfigurationException(t);\n+            }\n+        });\n+        AuthenticationContext contextWithTruststore = doPrivileged((PrivilegedAction<AuthenticationContext>) () -> {\n+            try {\n+                URL config = getClass().getResource(\"wildfly-config-correct-truststore.xml\");\n+                return ElytronXmlParser.parseAuthenticationClientConfiguration(config.toURI()).create();\n+            } catch (Throwable t) {\n+                throw new InvalidAuthenticationConfigurationException(t);\n+            }\n+        });\n+        SSLContext sslContext = AUTH_CONTEXT_CLIENT.getSSLContext(new URI(securedRootUrl.getHost()), contextWithTruststore);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4057f84e27204e4be0043f26dd9e3d27b92b405"}, "originalPosition": 122}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3896, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}