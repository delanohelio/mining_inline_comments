{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMzA1OTY0", "number": 3910, "title": "DB-9890 Skip column if column statistics object is too big", "bodyText": "", "createdAt": "2020-07-31T16:39:43Z", "url": "https://github.com/splicemachine/spliceengine/pull/3910", "merged": true, "mergeCommit": {"oid": "ec1a62ed5243bbe6a46feccca219bb66c625b063"}, "closed": true, "closedAt": "2020-08-13T20:56:09Z", "author": {"login": "ascend1"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6bsZOgFqTQ1OTUwMjMyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8VjTHAFqTQ2MjgzOTgzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTAyMzI3", "url": "https://github.com/splicemachine/spliceengine/pull/3910#pullrequestreview-459502327", "createdAt": "2020-07-31T22:09:38Z", "commit": {"oid": "95d8ff4177b4f233e2def6e5ac530d51f34ac1a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTA0NzA5", "url": "https://github.com/splicemachine/spliceengine/pull/3910#pullrequestreview-459504709", "createdAt": "2020-07-31T22:17:09Z", "commit": {"oid": "95d8ff4177b4f233e2def6e5ac530d51f34ac1a0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjoxNzoxMFrOG6YWMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjoxNzoxMFrOG6YWMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg2OTQ4OQ==", "bodyText": "Is it possible to return this warning as part of the analyze output in addition to the warning in the log? so that user is aware that some column stats are skipped.", "url": "https://github.com/splicemachine/spliceengine/pull/3910#discussion_r463869489", "createdAt": "2020-07-31T22:17:10Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/StatisticsAdmin.java", "diffHunk": "@@ -1045,8 +1045,19 @@ public boolean hasNext() {\n                                                 ObjectInputStream ois = new ObjectInputStream(bais);\n                                                 // compose the entry for a given column\n                                                 ExecRow statsRow = StatisticsAdmin.generateRowFromStats(conglomId, \"-All-\", columnId, (ColumnStatisticsImpl) ois.readObject());\n-                                                dataDictionary.addColumnStatistics(statsRow, tc);\n-                                                bais.close();\n+                                                try {\n+                                                    dataDictionary.addColumnStatistics(statsRow, tc);\n+                                                } catch (StandardException e) {\n+                                                    // DB-9890 Skip a column if its statistics object doesn't fit into HBase cell.\n+                                                    if (e.getCause().getMessage().contains(\"KeyValue size too large\")) {\n+                                                        SpliceLogUtils.warn(LOG, \"Statistics object of [ConglomID=%d, ColumnID=%d] exceeds max KeyValue size. Try increase hbase.client.keyvalue.maxsize.\",\n+                                                                conglomId, columnId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95d8ff4177b4f233e2def6e5ac530d51f34ac1a0"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd0c1032e01de6b81c8f385a1c0f50db34a5ae5d", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/dd0c1032e01de6b81c8f385a1c0f50db34a5ae5d", "committedDate": "2020-08-05T18:44:59Z", "message": "DB-9890 Skip column if column statistics object is too big"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc78c9b88a5517c53d096585a7aa75e4c0c78267", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/dc78c9b88a5517c53d096585a7aa75e4c0c78267", "committedDate": "2020-08-05T18:44:59Z", "message": "DB-9890 Show skipped column IDs in the result of ANALYZE command"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95d8ff4177b4f233e2def6e5ac530d51f34ac1a0", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/95d8ff4177b4f233e2def6e5ac530d51f34ac1a0", "committedDate": "2020-07-31T16:34:31Z", "message": "DB-9890 Skip column if column statistics object is too big"}, "afterCommit": {"oid": "dc78c9b88a5517c53d096585a7aa75e4c0c78267", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/dc78c9b88a5517c53d096585a7aa75e4c0c78267", "committedDate": "2020-08-05T18:44:59Z", "message": "DB-9890 Show skipped column IDs in the result of ANALYZE command"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTYzNDE1", "url": "https://github.com/splicemachine/spliceengine/pull/3910#pullrequestreview-461963415", "createdAt": "2020-08-05T19:33:33Z", "commit": {"oid": "dc78c9b88a5517c53d096585a7aa75e4c0c78267"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxOTozMzozM1rOG8Xssw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxOTozMzozM1rOG8Xssw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1NjAxOQ==", "bodyText": "For non-merged stats (that is, we output one row in the table stats table for each partition, so are the column stats), that means, we may add the same columnId multiple times to the skippedColIds list. Non-merged stats is a mode that we are not using currently, still I prefer to maintain it (in consideration in the future to support incremental stats) and add duplicate checks for this path. You may collect non-merged stats by calling the system procedure COLLECT_NONMERGED_TABLE_STATISTICS.", "url": "https://github.com/splicemachine/spliceengine/pull/3910#discussion_r465956019", "createdAt": "2020-08-05T19:33:33Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/StatisticsAdmin.java", "diffHunk": "@@ -1135,9 +1146,11 @@ public boolean hasNext() {\n                                             } catch (StandardException e) {\n                                                 // DB-9890 Skip a column if its statistics object doesn't fit into HBase cell.\n                                                 if (e.getCause().getMessage().contains(\"KeyValue size too large\")) {\n+                                                    int columnId = nextRow.getColumn(SYSCOLUMNSTATISTICSRowFactory.COLUMNID).getInt();\n                                                     SpliceLogUtils.warn(LOG, \"Statistics object of [ConglomID=%d, ColumnID=%d] exceeds max KeyValue size. Try increase hbase.client.keyvalue.maxsize.\",\n                                                             nextRow.getColumn(SYSCOLUMNSTATISTICSRowFactory.CONGLOMID).getInt(),\n-                                                            nextRow.getColumn(SYSCOLUMNSTATISTICSRowFactory.COLUMNID).getInt());\n+                                                            columnId);\n+                                                    skippedColIds.add(columnId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc78c9b88a5517c53d096585a7aa75e4c0c78267"}, "originalPosition": 93}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "984922b507811ebf949d40693c796dfe9d1ec308", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/984922b507811ebf949d40693c796dfe9d1ec308", "committedDate": "2020-08-05T19:43:33Z", "message": "DB-9890 Fix duplicates in skipped column IDs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyODM5ODMz", "url": "https://github.com/splicemachine/spliceengine/pull/3910#pullrequestreview-462839833", "createdAt": "2020-08-06T20:08:06Z", "commit": {"oid": "984922b507811ebf949d40693c796dfe9d1ec308"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1210, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}