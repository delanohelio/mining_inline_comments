{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMjc0Nzc4", "number": 4792, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMjowMjo1OFrOFBheqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNjowMzoyOFrOFCb2Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MTQxNDE4OnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/compile/CompilerContext.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMjowMjo1OFrOIAQB4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMjowMjo1OFrOIAQB4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzMzUzNw==", "bodyText": "I think you can remove this method.", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537133537", "createdAt": "2020-12-06T22:02:58Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/compile/CompilerContext.java", "diffHunk": "@@ -730,6 +731,9 @@\n     int getCurrentTimestampPrecision();\n \n     int getTimestampPrecision();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a25fbc5357297576da32f01ee607c2f2e6fbbe4"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MTQxNTk5OnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMjowNDoxMFrOIAQCtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMjowNDoxMFrOIAQCtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzMzc1MA==", "bodyText": "This can be removed.", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537133750", "createdAt": "2020-12-06T22:04:10Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -122,6 +127,10 @@ public void setStringFormat(int format) {\n         stringFormat = format;\n     }\n \n+    public void setTimestampFormat(String format) {\n+        timestampFormat = format;\n+    }\n+\n     public void setPrecision(int precision) {\n         this.precision = precision;\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a25fbc5357297576da32f01ee607c2f2e6fbbe4"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MTQxODM3OnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMjowNTo0OVrOIAQD0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMjowNTo0OVrOIAQD0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzNDAzMg==", "bodyText": "timestampPrecisionString can be removed along with the related logic from GenericStatement.", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537134032", "createdAt": "2020-12-06T22:05:49Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "diffHunk": "@@ -620,6 +622,21 @@ else if (newMergeJoinString.equals(\"forced\"))\n                 }\n                 cc.setCurrentTimestampPrecision(currentTimestampPrecision);\n \n+                String timestampFormatString =\n+                        PropertyUtil.getCachedDatabaseProperty(lcc, Property.SPLICE_TIMESTAMP_FORMAT);\n+                if(timestampFormatString == null)\n+                    cc.setTimestampFormat(CompilerContext.DEFAULT_TIMESTAMP_FORMAT);\n+                else {\n+                    try {\n+                        // DB-10968 we shouldn't even allow setting this to the wrong value\n+                        DateTimeFormatter.ofPattern(timestampFormatString);\n+                    } catch(Exception e)\n+                    {\n+                        timestampFormatString = CompilerContext.DEFAULT_TIMESTAMP_FORMAT;\n+                    }\n+                    cc.setTimestampFormat(timestampFormatString);\n+                }\n+\n                 String timestampPrecisionString =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a25fbc5357297576da32f01ee607c2f2e6fbbe4"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MTQyMDAxOnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CompilerContextImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMjowNjo0MFrOIAQEjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQyMjowNjo0MFrOIAQEjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEzNDIyMA==", "bodyText": "this can be removed.", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537134220", "createdAt": "2020-12-06T22:06:40Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CompilerContextImpl.java", "diffHunk": "@@ -1184,6 +1192,8 @@ public int getNextOJLevel() {\n     private       boolean                             allowOverflowSensitiveNativeSparkExpressions = DEFAULT_SPLICE_ALLOW_OVERFLOW_SENSITIVE_NATIVE_SPARK_EXPRESSIONS;\n     private       int                                 currentTimestampPrecision                    = DEFAULT_SPLICE_CURRENT_TIMESTAMP_PRECISION;\n     private       int                                 timestampPrecision                           = DEFAULT_TIMESTAMP_PRECISION;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a25fbc5357297576da32f01ee607c2f2e6fbbe4"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDEzNTk4OnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzozNzo0MFrOIAnGRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNToxNToyNlrOIArp6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMTQ5Mg==", "bodyText": "I would elevate it to a standard SQL exception with an error code. DB2 throws error with SQLState 22007 if one attempts e.g. the following:\nINSERT INTO t1 (c1) VALUES (TIMESTAMP_FORMAT('1999-12-31 23:59:59', 'YYYY-MM-sadsdDD HH24:MI:SXXXS'))\n\nSQL20447N  Format string \"YYYY-MM-sadsdDD HH24:MI:SXXXS\" is not valid for the \n\"SYSIBM.TIMESTAMP_FORMAT\" function.  SQLSTATE=22007\n\nI suggest to use the same here.", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537511492", "createdAt": "2020-12-07T13:37:40Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -169,12 +172,57 @@ public int estimateMemoryUsage()\n         return BASE_MEMORY_USAGE;\n     } // end of estimateMemoryUsage\n \n-    private static String format(Timestamp timestamp, String timeStampFormat) {\n+    /**\n+     * this also checks if the format is a valid fixed-size timestamp format\n+     * see also https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\n+     * we support:\n+     * yyyy, yy, uuuu, uu, eee, EEE, MM, mm, dd, HH, hh, ss, a\n+     * an arbitrary number of S, and other characters \" ,.-/:\"\n+     * @param format\n+     * @throws IllegalArgumentException if format is not supported\n+     * @return length of format\n+     */\n+    public static int getFormatLength(String format) throws IllegalArgumentException\n+    {\n+        byte[] b = format.getBytes(Bytes.UTF8_CHARSET);\n+        int repeat = 0;\n+        char last = (char)b[0];\n+        int length = b.length;\n+        for(int i=0; i<b.length+1; i++) {\n+            if (i != b.length && (char) b[i] == last) {\n+                repeat++;\n+                continue;\n+            }\n+            int r = repeat;\n+            char l = last;\n+            repeat = 1;\n+            if( i != b.length)\n+                last = (char) b[i];\n+            if ((l == 'y' || l == 'u') && (r == 4 || r == 2)) continue;\n+            else if (r == 2 &&  \"MmdHhs\".indexOf(l) != -1 ) continue;\n+            else if (r == 3 && (l == 'e' || l == 'E')) continue;\n+            else if (l == 'S') continue;\n+            else if (r == 1) {\n+                if (l == 'a') {\n+                    length++;\n+                    continue;\n+                }\n+                if(\" ,.-/:\".indexOf(l) != -1) continue;\n+            }\n+            throw new IllegalArgumentException(\"not supported format \\\"\" + format + \"\\\": '\" + l + \"' can't be repeated \" + r + \" times\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU4NjE1NA==", "bodyText": "i agree, however customer doesn't see this message currently since we don't check this at call SYSCS_UTIL.SYSCS_SET_GLOBAL_DATABASE_PROPERTY( 'splice.function.timestampFormat', 'yyyy-MM-dd-HH.mm.ss.SSSSSSSS'); but only later where we can't throw . i created a task/bug for this: DB-10968", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537586154", "createdAt": "2020-12-07T15:15:26Z", "author": {"login": "martinrupp"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -169,12 +172,57 @@ public int estimateMemoryUsage()\n         return BASE_MEMORY_USAGE;\n     } // end of estimateMemoryUsage\n \n-    private static String format(Timestamp timestamp, String timeStampFormat) {\n+    /**\n+     * this also checks if the format is a valid fixed-size timestamp format\n+     * see also https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\n+     * we support:\n+     * yyyy, yy, uuuu, uu, eee, EEE, MM, mm, dd, HH, hh, ss, a\n+     * an arbitrary number of S, and other characters \" ,.-/:\"\n+     * @param format\n+     * @throws IllegalArgumentException if format is not supported\n+     * @return length of format\n+     */\n+    public static int getFormatLength(String format) throws IllegalArgumentException\n+    {\n+        byte[] b = format.getBytes(Bytes.UTF8_CHARSET);\n+        int repeat = 0;\n+        char last = (char)b[0];\n+        int length = b.length;\n+        for(int i=0; i<b.length+1; i++) {\n+            if (i != b.length && (char) b[i] == last) {\n+                repeat++;\n+                continue;\n+            }\n+            int r = repeat;\n+            char l = last;\n+            repeat = 1;\n+            if( i != b.length)\n+                last = (char) b[i];\n+            if ((l == 'y' || l == 'u') && (r == 4 || r == 2)) continue;\n+            else if (r == 2 &&  \"MmdHhs\".indexOf(l) != -1 ) continue;\n+            else if (r == 3 && (l == 'e' || l == 'E')) continue;\n+            else if (l == 'S') continue;\n+            else if (r == 1) {\n+                if (l == 'a') {\n+                    length++;\n+                    continue;\n+                }\n+                if(\" ,.-/:\".indexOf(l) != -1) continue;\n+            }\n+            throw new IllegalArgumentException(\"not supported format \\\"\" + format + \"\\\": '\" + l + \"' can't be repeated \" + r + \" times\");\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxMTQ5Mg=="}, "originalCommit": {"oid": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDE4MTY3OnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzo0Nzo0NlrOIAngvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNToxMDoxMFrOIArZeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxODI2OA==", "bodyText": "Can you iterate i only until b.length and not b.length+1? i.e. can we rewrite to:\n        for(int i=0; i<b.length; i++) {\n            if ((char) b[i] == last) {\n                repeat++;\n                continue;\n            }\n            int r = repeat;\n            char l = last;\n            repeat = 1;\n            last = (char) b[i];\n            if ((l == 'y' || l == 'u') && (r == 4 || r == 2)) continue;\n            else if (r == 2 &&  \"MmdHhs\".indexOf(l) != -1 ) continue;\n            else if (r == 3 && (l == 'e' || l == 'E')) continue;\n            else if (l == 'S') continue;\n            else if (r == 1) {\n                if (l == 'a') {\n                    length++;\n                    continue;\n                }\n                if(\" ,.-/:\".indexOf(l) != -1) continue;\n            }\n            throw new IllegalArgumentException(\"not supported format \\\"\" + format + \"\\\": '\" + l + \"' can't be repeated \" + r + \" times\");\n        }", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537518268", "createdAt": "2020-12-07T13:47:46Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -169,12 +172,57 @@ public int estimateMemoryUsage()\n         return BASE_MEMORY_USAGE;\n     } // end of estimateMemoryUsage\n \n-    private static String format(Timestamp timestamp, String timeStampFormat) {\n+    /**\n+     * this also checks if the format is a valid fixed-size timestamp format\n+     * see also https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\n+     * we support:\n+     * yyyy, yy, uuuu, uu, eee, EEE, MM, mm, dd, HH, hh, ss, a\n+     * an arbitrary number of S, and other characters \" ,.-/:\"\n+     * @param format\n+     * @throws IllegalArgumentException if format is not supported\n+     * @return length of format\n+     */\n+    public static int getFormatLength(String format) throws IllegalArgumentException\n+    {\n+        byte[] b = format.getBytes(Bytes.UTF8_CHARSET);\n+        int repeat = 0;\n+        char last = (char)b[0];\n+        int length = b.length;\n+        for(int i=0; i<b.length+1; i++) {\n+            if (i != b.length && (char) b[i] == last) {\n+                repeat++;\n+                continue;\n+            }\n+            int r = repeat;\n+            char l = last;\n+            repeat = 1;\n+            if( i != b.length)\n+                last = (char) b[i];\n+            if ((l == 'y' || l == 'u') && (r == 4 || r == 2)) continue;\n+            else if (r == 2 &&  \"MmdHhs\".indexOf(l) != -1 ) continue;\n+            else if (r == 3 && (l == 'e' || l == 'E')) continue;\n+            else if (l == 'S') continue;\n+            else if (r == 1) {\n+                if (l == 'a') {\n+                    length++;\n+                    continue;\n+                }\n+                if(\" ,.-/:\".indexOf(l) != -1) continue;\n+            }\n+            throw new IllegalArgumentException(\"not supported format \\\"\" + format + \"\\\": '\" + l + \"' can't be repeated \" + r + \" times\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU4MTk0NA==", "bodyText": "iterating to b.length (inclusive) is weird i know but had to be done.\nthe solution you suggest is not checking the last part of the string. you would have to add the same if/else/else code again after the loop is done.\njust checked hh:mm:ss a, it would miss the 'a'.", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537581944", "createdAt": "2020-12-07T15:10:10Z", "author": {"login": "martinrupp"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -169,12 +172,57 @@ public int estimateMemoryUsage()\n         return BASE_MEMORY_USAGE;\n     } // end of estimateMemoryUsage\n \n-    private static String format(Timestamp timestamp, String timeStampFormat) {\n+    /**\n+     * this also checks if the format is a valid fixed-size timestamp format\n+     * see also https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\n+     * we support:\n+     * yyyy, yy, uuuu, uu, eee, EEE, MM, mm, dd, HH, hh, ss, a\n+     * an arbitrary number of S, and other characters \" ,.-/:\"\n+     * @param format\n+     * @throws IllegalArgumentException if format is not supported\n+     * @return length of format\n+     */\n+    public static int getFormatLength(String format) throws IllegalArgumentException\n+    {\n+        byte[] b = format.getBytes(Bytes.UTF8_CHARSET);\n+        int repeat = 0;\n+        char last = (char)b[0];\n+        int length = b.length;\n+        for(int i=0; i<b.length+1; i++) {\n+            if (i != b.length && (char) b[i] == last) {\n+                repeat++;\n+                continue;\n+            }\n+            int r = repeat;\n+            char l = last;\n+            repeat = 1;\n+            if( i != b.length)\n+                last = (char) b[i];\n+            if ((l == 'y' || l == 'u') && (r == 4 || r == 2)) continue;\n+            else if (r == 2 &&  \"MmdHhs\".indexOf(l) != -1 ) continue;\n+            else if (r == 3 && (l == 'e' || l == 'E')) continue;\n+            else if (l == 'S') continue;\n+            else if (r == 1) {\n+                if (l == 'a') {\n+                    length++;\n+                    continue;\n+                }\n+                if(\" ,.-/:\".indexOf(l) != -1) continue;\n+            }\n+            throw new IllegalArgumentException(\"not supported format \\\"\" + format + \"\\\": '\" + l + \"' can't be repeated \" + r + \" times\");\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUxODI2OA=="}, "originalCommit": {"oid": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDIwMjk1OnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzo1MjoxNFrOIAns2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNToxMzoyMFrOIArjQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMTM3MA==", "bodyText": "I guess this would also throw if we have a pattern that looks like this: yyyy----MM-dd HH:mm:ss (notice the tripple-dash), do we want to allow such pattern?", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537521370", "createdAt": "2020-12-07T13:52:14Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -169,12 +172,57 @@ public int estimateMemoryUsage()\n         return BASE_MEMORY_USAGE;\n     } // end of estimateMemoryUsage\n \n-    private static String format(Timestamp timestamp, String timeStampFormat) {\n+    /**\n+     * this also checks if the format is a valid fixed-size timestamp format\n+     * see also https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\n+     * we support:\n+     * yyyy, yy, uuuu, uu, eee, EEE, MM, mm, dd, HH, hh, ss, a\n+     * an arbitrary number of S, and other characters \" ,.-/:\"\n+     * @param format\n+     * @throws IllegalArgumentException if format is not supported\n+     * @return length of format\n+     */\n+    public static int getFormatLength(String format) throws IllegalArgumentException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU4NDQ1MA==", "bodyText": "you're right, we can allow such patterns", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537584450", "createdAt": "2020-12-07T15:13:20Z", "author": {"login": "martinrupp"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -169,12 +172,57 @@ public int estimateMemoryUsage()\n         return BASE_MEMORY_USAGE;\n     } // end of estimateMemoryUsage\n \n-    private static String format(Timestamp timestamp, String timeStampFormat) {\n+    /**\n+     * this also checks if the format is a valid fixed-size timestamp format\n+     * see also https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\n+     * we support:\n+     * yyyy, yy, uuuu, uu, eee, EEE, MM, mm, dd, HH, hh, ss, a\n+     * an arbitrary number of S, and other characters \" ,.-/:\"\n+     * @param format\n+     * @throws IllegalArgumentException if format is not supported\n+     * @return length of format\n+     */\n+    public static int getFormatLength(String format) throws IllegalArgumentException", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMTM3MA=="}, "originalCommit": {"oid": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDIwNTgyOnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzo1Mjo1MFrOIAnuig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMzo1Mjo1MFrOIAnuig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzUyMTgwMg==", "bodyText": "nice", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r537521802", "createdAt": "2020-12-07T13:52:50Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -127,6 +129,7 @@ public void setStringFormat(int format) {\n \n     public void setTimestampFormat(String format) {\n         timestampFormat = format;\n+        formatter = null; // recreate on demand", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e238fb626a6e9d5fb1b61090f86355ee3f6f2bee"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3ODg0MDgzOnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTo1ODo1NVrOIBQ_Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDoyOToyMFrOIBSTPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5Nzg1OA==", "bodyText": "Not quite related to this PR, but that one seems to only be used in SpliceAdmin and should therefore probably be moved out of this class.", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r538197858", "createdAt": "2020-12-08T09:58:55Z", "author": {"login": "arnaud-splice"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -98,8 +102,7 @@\n     public static final String defaultTimestampFormatString = \"yyyy-MM-dd HH:mm:ss\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7727a9fe9bd6ea5423f2eeeaae6758ccaf57914"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxOTMyNg==", "bodyText": "agreed", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r538219326", "createdAt": "2020-12-08T10:29:20Z", "author": {"login": "martinrupp"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/types/SQLTimestamp.java", "diffHunk": "@@ -98,8 +102,7 @@\n     public static final String defaultTimestampFormatString = \"yyyy-MM-dd HH:mm:ss\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5Nzg1OA=="}, "originalCommit": {"oid": "e7727a9fe9bd6ea5423f2eeeaae6758ccaf57914"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MDk3NzYzOnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/compile/CompilerContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNjowMzoyOFrOIBlzBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMDozNToxNFrOIPnYjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUzODc1OA==", "bodyText": "The current maximum on-disk timestamp precision is 6 decimal places.  Maybe we should make the default timestamp format match this.  Having a default format with 9 decimal places might make users mistakenly think they can input such data into tables as well.", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r538538758", "createdAt": "2020-12-08T16:03:28Z", "author": {"login": "msirek"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/compile/CompilerContext.java", "diffHunk": "@@ -183,7 +183,7 @@\n     NativeSparkModeType DEFAULT_SPLICE_NATIVE_SPARK_AGGREGATION_MODE = NativeSparkModeType.SYSTEM;\n     boolean DEFAULT_SPLICE_ALLOW_OVERFLOW_SENSITIVE_NATIVE_SPARK_EXPRESSIONS = true;\n     int DEFAULT_SPLICE_CURRENT_TIMESTAMP_PRECISION = 6;\n-    int DEFAULT_TIMESTAMP_PRECISION = 9;\n+    String DEFAULT_TIMESTAMP_FORMAT = \"yyyy-MM-dd HH:mm:ss.SSSSSSSSS\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7727a9fe9bd6ea5423f2eeeaae6758ccaf57914"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI0NDgxNA==", "bodyText": "agreed", "url": "https://github.com/splicemachine/spliceengine/pull/4792#discussion_r553244814", "createdAt": "2021-01-07T10:35:14Z", "author": {"login": "martinrupp"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/compile/CompilerContext.java", "diffHunk": "@@ -183,7 +183,7 @@\n     NativeSparkModeType DEFAULT_SPLICE_NATIVE_SPARK_AGGREGATION_MODE = NativeSparkModeType.SYSTEM;\n     boolean DEFAULT_SPLICE_ALLOW_OVERFLOW_SENSITIVE_NATIVE_SPARK_EXPRESSIONS = true;\n     int DEFAULT_SPLICE_CURRENT_TIMESTAMP_PRECISION = 6;\n-    int DEFAULT_TIMESTAMP_PRECISION = 9;\n+    String DEFAULT_TIMESTAMP_FORMAT = \"yyyy-MM-dd HH:mm:ss.SSSSSSSSS\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUzODc1OA=="}, "originalCommit": {"oid": "e7727a9fe9bd6ea5423f2eeeaae6758ccaf57914"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2711, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}