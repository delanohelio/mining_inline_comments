{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NTcyMDcy", "number": 3149, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOTo1OTowOVrODZ9VFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOTo1OTowOVrODZ9VFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTQ1ODE0OnYy", "diffSide": "RIGHT", "path": "hbase_storage/src/main/java/com/splicemachine/storage/ClientPartition.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOTo1OTowOVrOFgpKeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMjowMToyMlrOFgsgnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3MzE3OA==", "bodyText": "Is it OK to ignore offline regions?  The old code kept retrying until all regions were online.  Could we potentially end up not scanning all rows in the table?", "url": "https://github.com/splicemachine/spliceengine/pull/3149#discussion_r369773178", "createdAt": "2020-01-22T19:59:09Z", "author": {"login": "msirek"}, "path": "hbase_storage/src/main/java/com/splicemachine/storage/ClientPartition.java", "diffHunk": "@@ -155,32 +152,26 @@ public boolean checkAndPut(byte[] key,byte[] family,byte[] qualifier,byte[] expe\n             List<Partition> partitions;\n             if (!refresh) {\n                 partitions = partitionInfoCache.getIfPresent(tableName);\n-                if (partitions == null) {\n-                    partitions = formatPartitions(getAllRegionLocations(false));\n-                    assert partitions!=null:\"partitions are null\";\n-                    partitionInfoCache.put(tableName, partitions);\n+                if (partitions != null) {\n+                    return partitions;\n                 }\n-                return partitions;\n             }\n-            partitions = formatPartitions(getAllRegionLocations(true));\n-            partitionInfoCache.invalidate(tableName);\n-            assert partitions!=null:\"partitions are null\";\n-            partitionInfoCache.put(tableName,partitions);\n+            List<HRegionLocation> tableLocations = ((ClusterConnection) connection).locateRegions(tableName, !refresh, false);\n+            partitions = new ArrayList<>(tableLocations.size());\n+            for (HRegionLocation location : tableLocations){\n+                if (location.getServerName() == null) {     // ensure no offline regions\n+                    continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3c426aa1149c92fbd2e48cfb9c61c88397671f4"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwNjE2MQ==", "bodyText": "HRegionLocation.getServerName() == null causes the NPE. I believe it's an issue in HBase itself as serverName is used in HRegionLocation.hashCode() and throws NPE when null (making such HRegionLocation instances poorly defined and unusable).\nIn fact, ClusterConnection.locateRegions(..., false) already ensures that such locations are filtered out. I make that condition explicit..", "url": "https://github.com/splicemachine/spliceengine/pull/3149#discussion_r369806161", "createdAt": "2020-01-22T21:12:58Z", "author": {"login": "OlegMazurov"}, "path": "hbase_storage/src/main/java/com/splicemachine/storage/ClientPartition.java", "diffHunk": "@@ -155,32 +152,26 @@ public boolean checkAndPut(byte[] key,byte[] family,byte[] qualifier,byte[] expe\n             List<Partition> partitions;\n             if (!refresh) {\n                 partitions = partitionInfoCache.getIfPresent(tableName);\n-                if (partitions == null) {\n-                    partitions = formatPartitions(getAllRegionLocations(false));\n-                    assert partitions!=null:\"partitions are null\";\n-                    partitionInfoCache.put(tableName, partitions);\n+                if (partitions != null) {\n+                    return partitions;\n                 }\n-                return partitions;\n             }\n-            partitions = formatPartitions(getAllRegionLocations(true));\n-            partitionInfoCache.invalidate(tableName);\n-            assert partitions!=null:\"partitions are null\";\n-            partitionInfoCache.put(tableName,partitions);\n+            List<HRegionLocation> tableLocations = ((ClusterConnection) connection).locateRegions(tableName, !refresh, false);\n+            partitions = new ArrayList<>(tableLocations.size());\n+            for (HRegionLocation location : tableLocations){\n+                if (location.getServerName() == null) {     // ensure no offline regions\n+                    continue;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3MzE3OA=="}, "originalCommit": {"oid": "e3c426aa1149c92fbd2e48cfb9c61c88397671f4"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgyNzk5OQ==", "bodyText": "I see, thanks.", "url": "https://github.com/splicemachine/spliceengine/pull/3149#discussion_r369827999", "createdAt": "2020-01-22T22:01:22Z", "author": {"login": "msirek"}, "path": "hbase_storage/src/main/java/com/splicemachine/storage/ClientPartition.java", "diffHunk": "@@ -155,32 +152,26 @@ public boolean checkAndPut(byte[] key,byte[] family,byte[] qualifier,byte[] expe\n             List<Partition> partitions;\n             if (!refresh) {\n                 partitions = partitionInfoCache.getIfPresent(tableName);\n-                if (partitions == null) {\n-                    partitions = formatPartitions(getAllRegionLocations(false));\n-                    assert partitions!=null:\"partitions are null\";\n-                    partitionInfoCache.put(tableName, partitions);\n+                if (partitions != null) {\n+                    return partitions;\n                 }\n-                return partitions;\n             }\n-            partitions = formatPartitions(getAllRegionLocations(true));\n-            partitionInfoCache.invalidate(tableName);\n-            assert partitions!=null:\"partitions are null\";\n-            partitionInfoCache.put(tableName,partitions);\n+            List<HRegionLocation> tableLocations = ((ClusterConnection) connection).locateRegions(tableName, !refresh, false);\n+            partitions = new ArrayList<>(tableLocations.size());\n+            for (HRegionLocation location : tableLocations){\n+                if (location.getServerName() == null) {     // ensure no offline regions\n+                    continue;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc3MzE3OA=="}, "originalCommit": {"oid": "e3c426aa1149c92fbd2e48cfb9c61c88397671f4"}, "originalPosition": 54}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3330, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}