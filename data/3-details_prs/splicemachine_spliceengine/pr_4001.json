{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NDg2MDU0", "number": 4001, "title": "DB-9897 Change the default schema of CTEs from current to SESSION", "bodyText": "", "createdAt": "2020-08-18T13:06:10Z", "url": "https://github.com/splicemachine/spliceengine/pull/4001", "merged": true, "mergeCommit": {"oid": "361acf0999d39ea76e38d7db56ca725125b2097f"}, "closed": true, "closedAt": "2020-08-25T08:54:52Z", "author": {"login": "ascend1"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAGV6aAH2gAyNDY5NDg2MDU0OjY2OWRlYjZiNmY1NWUzZDI5MWQyODc0ZWQzNTg4Zjk3M2RkYWFlMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCNBiqAFqTQ3NDAzNDAzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "669deb6b6f55e3d291d2874ed3588f973ddaae2f", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/669deb6b6f55e3d291d2874ed3588f973ddaae2f", "committedDate": "2020-08-18T12:40:36Z", "message": "DB-9897 Change the default schema of CTEs from current to SESSION"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "226b78c6bcb17840eb24bf4867a44d55c38dfd86", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/226b78c6bcb17840eb24bf4867a44d55c38dfd86", "committedDate": "2020-08-18T13:38:10Z", "message": "DB-9897 Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTI5NTY4", "url": "https://github.com/splicemachine/spliceengine/pull/4001#pullrequestreview-470129568", "createdAt": "2020-08-19T05:13:46Z", "commit": {"oid": "226b78c6bcb17840eb24bf4867a44d55c38dfd86"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNToxMzo0N1rOHCzn_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNToxMzo0N1rOHCzn_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwNTAyMg==", "bodyText": "I think we should not remove this check completely, we allow dynamic view to be in session schema, but not regular views. Right now with the change, regular view will be created successfully using the session schema:\nsplice> create view session.v1 as select a1 from t1;\n0 rows inserted/updated/deleted\nELAPSED TIME = 129 milliseconds\nsplice> select * from session.v1;\nERROR XJ001: DERBY SQL error: SQLCODE: -1, SQLSTATE: XJ001, SQLERRMC: java.lang.NullPointerExceptionXJ001.U\nsplice> quit;", "url": "https://github.com/splicemachine/spliceengine/pull/4001#discussion_r472705022", "createdAt": "2020-08-19T05:13:47Z", "author": {"login": "yxia92"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CreateViewNode.java", "diffHunk": "@@ -291,9 +291,6 @@ public void bindStatement() throws StandardException\n \t\t\t//cannot define views on temporary tables\n \t\t\tif (queryExpr instanceof SelectNode)\n \t\t\t{\n-\t\t\t\t//If attempting to reference a SESSION schema table (temporary or permanent) in the view, throw an exception", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "226b78c6bcb17840eb24bf4867a44d55c38dfd86"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTMwNDIx", "url": "https://github.com/splicemachine/spliceengine/pull/4001#pullrequestreview-470130421", "createdAt": "2020-08-19T05:16:31Z", "commit": {"oid": "226b78c6bcb17840eb24bf4867a44d55c38dfd86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNToxNjozMVrOHCzukg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNToxNjozMVrOHCzukg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjcwNjcwNg==", "bodyText": "Could you add a test case to test that in two concurrent connections, we can create two dynamic views using the same name under the session schema, and they will not interfere with each other? Thanks!", "url": "https://github.com/splicemachine/spliceengine/pull/4001#discussion_r472706706", "createdAt": "2020-08-19T05:16:31Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/WithStatementIT.java", "diffHunk": "@@ -209,5 +231,34 @@ public void testInsertContainingWith() throws Exception {\n         assertEquals(expectedResult, TestUtils.FormattedResult.ResultFactory.toString(rs));\n     }\n \n+    @Test\n+    public void testWithInSchemaNotSufficientPrivilege() throws Exception {\n+        methodWatcher.executeUpdate(\"insert into t12 values (1)\");\n+        String expected = \"I |\\n\" +\n+                \"----\\n\" +\n+                \" 1 |\";\n+\n+        // user with enough privilege, dynamic view in SESSION schema\n+        try (ResultSet rs = methodWatcher.executeQuery(\"with dt as (select * from t12) select * from dt\")) {\n+            assertEquals(expected, TestUtils.FormattedResult.ResultFactory.toString(rs));\n+        }\n+        // user with enough privilege, dynamic view in current schema\n+        try (ResultSet rs = methodWatcher.executeQuery(format(\"with %s.dt as (select * from t12) select * from dt\", SCHEMA))) {\n+            assertEquals(expected, TestUtils.FormattedResult.ResultFactory.toString(rs));\n+        }\n+\n+        try (ResultSet rs = testUserConn.createStatement().executeQuery(\"values current schema\")) {\n+            String expectedSchema = \"1        |\\n\" +\n+                    \"-----------------\\n\" +\n+                    \"WITHSTATEMENTIT |\";\n+            assertEquals(expectedSchema, TestUtils.FormattedResult.ResultFactory.toString(rs));\n+        }\n \n+        // user with no write privilege, dynamic view in SESSION schema\n+        try (ResultSet rs = testUserConn.createStatement().executeQuery(format(\"with dt as (select * from t12) select * from dt\"))) {\n+            assertEquals(expected, TestUtils.FormattedResult.ResultFactory.toString(rs));\n+        }\n+        // user with no write privilege, dynamic view in current schema\n+        assertFailed(testUserConn, format(\"with %s.dt as (select * from t12) select * from dt\", SCHEMA), SQLState.AUTH_NO_ACCESS_NOT_OWNER);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "226b78c6bcb17840eb24bf4867a44d55c38dfd86"}, "originalPosition": 150}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cd7560726a94cdb92b3f3fc4e5485098ba55653", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/0cd7560726a94cdb92b3f3fc4e5485098ba55653", "committedDate": "2020-08-19T10:09:42Z", "message": "DB-9897 Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ca27a8cc617f1748602bd8d5185d4d639c2d47b", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/5ca27a8cc617f1748602bd8d5185d4d639c2d47b", "committedDate": "2020-08-20T14:52:59Z", "message": "DB-9897 Address minor comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyODYzMDQ0", "url": "https://github.com/splicemachine/spliceengine/pull/4001#pullrequestreview-472863044", "createdAt": "2020-08-21T23:18:05Z", "commit": {"oid": "5ca27a8cc617f1748602bd8d5185d4d639c2d47b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczOTY3ODk1", "url": "https://github.com/splicemachine/spliceengine/pull/4001#pullrequestreview-473967895", "createdAt": "2020-08-24T22:55:22Z", "commit": {"oid": "5ca27a8cc617f1748602bd8d5185d4d639c2d47b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MDM0MDM5", "url": "https://github.com/splicemachine/spliceengine/pull/4001#pullrequestreview-474034039", "createdAt": "2020-08-25T01:35:32Z", "commit": {"oid": "5ca27a8cc617f1748602bd8d5185d4d639c2d47b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1181, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}