{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4NDc2OTY4", "number": 3384, "title": "DB-9327 allow SSQ in update statement to be flattened, and disable BatchOnce optimization", "bodyText": "Also include the fix:\nDB-9343 fix wrong result for flattened SSQ where correlation is in a single table condition\nPlease see fix notes in DB-9327 and DB-9343.", "createdAt": "2020-04-04T06:21:59Z", "url": "https://github.com/splicemachine/spliceengine/pull/3384", "merged": true, "mergeCommit": {"oid": "ee61cadf17c97a0c5d866e2b764142f8e55311a5"}, "closed": true, "closedAt": "2020-04-09T04:06:37Z", "author": {"login": "yxia92"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUPFQUgH2gAyMzk4NDc2OTY4OmQ5NDAzZTNhNDlkYjk5NjYzMzU0NjZiNjY4MzU3NGQwZWI5NWMyNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVzqV9AFqTM5MDQ2MzQwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d9403e3a49db9966335466b6683574d0eb95c273", "author": {"user": {"login": "yxia92", "name": "Yi Xia"}}, "url": "https://github.com/splicemachine/spliceengine/commit/d9403e3a49db9966335466b6683574d0eb95c273", "committedDate": "2020-04-04T05:58:53Z", "message": "DB-9327 Project rowid for update\nDB-9327 Handle distinct expressions in BatchOnceFunction\nDB-9327 Fix BatchOnce resultcolumn list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "242d1c898bdcf1d79eed509277587e715cf16a7c", "author": {"user": {"login": "yxia92", "name": "Yi Xia"}}, "url": "https://github.com/splicemachine/spliceengine/commit/242d1c898bdcf1d79eed509277587e715cf16a7c", "committedDate": "2020-04-04T05:58:53Z", "message": "DB-9327 allow SSQ in update statement to be flattened, and disable BatchOnce optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4dad049ed9cb6fd06bc25142a1eabd0ee28b26f", "author": {"user": {"login": "yxia92", "name": "Yi Xia"}}, "url": "https://github.com/splicemachine/spliceengine/commit/c4dad049ed9cb6fd06bc25142a1eabd0ee28b26f", "committedDate": "2020-04-04T05:58:53Z", "message": "DB-9343 fix wrong result for flattened SSQ where correlation is in a single table condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c", "author": {"user": {"login": "yxia92", "name": "Yi Xia"}}, "url": "https://github.com/splicemachine/spliceengine/commit/c2e7f08a7d8554f2e8aaae53f6d31c9df492219c", "committedDate": "2020-04-04T05:58:53Z", "message": "DB-9327 add database property to disable SSQ flattening for update statement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MjAwODE1", "url": "https://github.com/splicemachine/spliceengine/pull/3384#pullrequestreview-388200815", "createdAt": "2020-04-06T12:29:42Z", "commit": {"oid": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjoyOTo0MlrOGBVaDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjoyOTo0MlrOGBVaDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA1MjQ5NQ==", "bodyText": "A warning could be logged here.", "url": "https://github.com/splicemachine/spliceengine/pull/3384#discussion_r404052495", "createdAt": "2020-04-06T12:29:42Z", "author": {"login": "arnaud-splice"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "diffHunk": "@@ -591,6 +591,20 @@ else if (nativeSparkAggregationModeString.equals(\"forced\"))\n                 }\n                 cc.setSparkVersion(sparkVersion);\n             }\n+\n+            String ssqFlatteningForUpdateDisabledString =\n+                    PropertyUtil.getCachedDatabaseProperty(lcc, Property.SSQ_FLATTENING_FOR_UPDATE_DISABLED);\n+            boolean ssqFlatteningForUpdateDisabled = CompilerContext.DEFAULT_SSQ_FLATTENING_FOR_UPDATE_DISABLED;\n+            try {\n+                if (ssqFlatteningForUpdateDisabledString != null)\n+                    ssqFlatteningForUpdateDisabled =\n+                            Boolean.valueOf(ssqFlatteningForUpdateDisabledString);\n+            } catch (Exception e) {\n+                // If the property value failed to convert to a boolean, don't throw an error,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODk4Nzk0", "url": "https://github.com/splicemachine/spliceengine/pull/3384#pullrequestreview-388898794", "createdAt": "2020-04-07T08:32:33Z", "commit": {"oid": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwODozMjozM1rOGB4ziA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QwODozODozMVrOGB5CLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzMjQ1Ng==", "bodyText": "Are we forcing the recompilation of stored prepared statements? Otherwise we might break some with this change (triggers for instance)", "url": "https://github.com/splicemachine/spliceengine/pull/3384#discussion_r404632456", "createdAt": "2020-04-07T08:32:33Z", "author": {"login": "dgomezferro"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/execute/ResultSetFactory.java", "diffHunk": "@@ -2105,60 +2105,62 @@ NoPutResultSet getRowCountResultSet(\n     /**\n      * Export\n      */\n-\tNoPutResultSet getExportResultSet(NoPutResultSet source,\n-\t\t\t\t\t\t\t\t\t  Activation activation,\n-\t\t\t\t\t\t\t\t\t  int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t  String exportPath,\n-\t\t\t\t\t\t\t\t\t  String compression,\n-\t\t\t\t\t\t\t\t\t  int replicationCount,\n-\t\t\t\t\t\t\t\t\t  String encoding,\n-\t\t\t\t\t\t\t\t\t  String fieldSeparator,\n-\t\t\t\t\t\t\t\t\t  String quoteChar,\n-\t\t\t\t\t\t\t\t\t  int srcResultDescriptionSavedObjectNum) throws StandardException;\n-\n-\n-\t/**\n-\t * Binary Export\n-\t */\n-\tNoPutResultSet getBinaryExportResultSet(NoPutResultSet source,\n-\t\t\t\t\t\t\t\t\t  Activation activation,\n-\t\t\t\t\t\t\t\t\t  int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t  String exportPath,\n-\t\t\t\t\t\t\t\t\t  String compression,\n-\t\t\t\t\t\t\t\t\t  String format,\n-\t\t\t\t\t\t\t\t\t  int srcResultDescriptionSavedObjectNum) throws StandardException;\n+    NoPutResultSet getExportResultSet(NoPutResultSet source,\n+                                      Activation activation,\n+                                      int resultSetNumber,\n+                                      String exportPath,\n+                                      String compression,\n+                                      int replicationCount,\n+                                      String encoding,\n+                                      String fieldSeparator,\n+                                      String quoteChar,\n+                                      int srcResultDescriptionSavedObjectNum) throws StandardException;\n+\n+\n+    /**\n+     * Binary Export\n+     */\n+    NoPutResultSet getBinaryExportResultSet(NoPutResultSet source,\n+                                      Activation activation,\n+                                      int resultSetNumber,\n+                                      String exportPath,\n+                                      String compression,\n+                                      String format,\n+                                      int srcResultDescriptionSavedObjectNum) throws StandardException;\n     /**\n      * Batch Once\n      */\n-\tNoPutResultSet getBatchOnceResultSet(NoPutResultSet source,\n-\t\t\t\t\t\t\t\t\t\t Activation activation,\n-\t\t\t\t\t\t\t\t\t\t int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t\t NoPutResultSet subqueryResultSet,\n-\t\t\t\t\t\t\t\t\t\t String updateResultSetFieldName,\n-\t\t\t\t\t\t\t\t\t\t int sourceCorrelatedColumnItem,\n-\t\t\t\t\t\t\t\t\t\t int subqueryCorrelatedColumnItem) throws StandardException;\n-\n-\t/**\n-\t * Recursive query\n-\t */\n-\tNoPutResultSet getSelfReferenceResultSet(Activation activation,\n-\t\t\t\t\t\t\t\t\t\t\t GeneratedMethod rowAllocator,\n-\t\t\t\t\t\t\t\t\t\t\t int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t\t\t double optimizerEstimatedRowCount,\n-\t\t\t\t\t\t\t\t\t\t\t double optimizerEstimatedCost,\n-\t\t\t\t\t\t\t\t\t\t\t String explainPlan) throws StandardException;\n-\n-\tNoPutResultSet getRecursiveUnionResultSet(NoPutResultSet leftResultSet,\n-\t\t\t\t\t\t\t\t\t\t\t  NoPutResultSet rightResultSet,\n-\t\t\t\t\t\t\t\t\t\t\t  int resultSetNumber,\n-\t\t\t\t\t\t\t\t\t\t\t  double optimizerEstimatedRowCount,\n-\t\t\t\t\t\t\t\t\t\t\t  double optimizerEstimatedCost,\n-\t\t\t\t\t\t\t\t\t\t\t  String explainPlan,\n-\t\t\t\t\t\t\t\t\t\t\t  int iterationLimit) throws StandardException;\n-\n-\tNoPutResultSet getSignalResultSet(Activation activation,\n-\t                                  String sqlState,\n-\t                                  GeneratedMethod errorTextGenerator) throws StandardException;\n+    NoPutResultSet getBatchOnceResultSet(NoPutResultSet source,\n+                                         Activation activation,\n+                                         int resultSetNumber,\n+                                         NoPutResultSet subqueryResultSet,\n+                                         String updateResultSetFieldName,\n+                                         int sourceCorrelatedColumnItem,\n+                                         int subqueryCorrelatedColumnItem,\n+                                         int sourceRowLoationColumnPosition,\n+                                         int cardinalityCheck) throws StandardException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c"}, "originalPosition": 3913}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYzNjIwNw==", "bodyText": "If we remove it from here we won't be using it anymore, right? I'd remove it altogether (BOVisitor, BONode and BOOperation)", "url": "https://github.com/splicemachine/spliceengine/pull/3384#discussion_r404636207", "createdAt": "2020-04-07T08:38:31Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/db/SpliceDatabase.java", "diffHunk": "@@ -129,7 +128,7 @@ private void setupASTVisitors(LanguageConnectionContext lctx) {\n         afterOptVisitors.add(RowLocationColumnVisitor.class);\n         afterOptVisitors.add(FixSubqueryColRefs.class);\n         afterOptVisitors.add(JoinConditionVisitor.class);\n-        afterOptVisitors.add(BatchOnceVisitor.class);\n+    //    afterOptVisitors.add(BatchOnceVisitor.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e7f08a7d8554f2e8aaae53f6d31c9df492219c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bebebd1360314680b08695853863efeaa2e8383e", "author": {"user": {"login": "yxia92", "name": "Yi Xia"}}, "url": "https://github.com/splicemachine/spliceengine/commit/bebebd1360314680b08695853863efeaa2e8383e", "committedDate": "2020-04-08T15:46:04Z", "message": "DB-9327 remove BatchOnce related modules and settings;\nDB-9327 add update script to invalidate all the stored prepared statements."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTcyMzI3", "url": "https://github.com/splicemachine/spliceengine/pull/3384#pullrequestreview-390172327", "createdAt": "2020-04-08T17:13:45Z", "commit": {"oid": "bebebd1360314680b08695853863efeaa2e8383e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDYzNDA0", "url": "https://github.com/splicemachine/spliceengine/pull/3384#pullrequestreview-390463404", "createdAt": "2020-04-09T03:09:54Z", "commit": {"oid": "bebebd1360314680b08695853863efeaa2e8383e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1407, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}