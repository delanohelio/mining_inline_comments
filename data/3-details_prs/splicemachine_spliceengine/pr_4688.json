{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NjA1MDY4", "number": 4688, "title": "DB-10878 more server-side logging.", "bodyText": "In this PR we add more DRDA logging on the server. The purpose of this is to log as many exceptions as possible for easier postmortems.", "createdAt": "2020-11-24T16:25:25Z", "url": "https://github.com/splicemachine/spliceengine/pull/4688", "merged": true, "mergeCommit": {"oid": "f42c04b53c0ea8916b7739e41e1f670c0b212f9a"}, "closed": true, "closedAt": "2020-11-25T20:06:16Z", "author": {"login": "hatyo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfr_t0AH2gAyNTI2NjA1MDY4OmVhYmY3ZDZlN2E0MGFkOWQ4OTBlMjY4MDYxYmEyZjQzYzY0NWI0Zjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgCJKnAH2gAyNTI2NjA1MDY4OmRkZDUzMTg0ZTJjNDNhMWIyOTQ5N2FhYjMwMGM3MWQ1YTlkZGU1M2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/eabf7d6e7a40ad9d890e268061ba2f43c645b4f8", "committedDate": "2020-11-24T16:04:24Z", "message": "DB-10878 more server-side logging."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODI2Mzc4", "url": "https://github.com/splicemachine/spliceengine/pull/4688#pullrequestreview-537826378", "createdAt": "2020-11-24T19:12:11Z", "commit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxOToxMjoxMVrOH5RcQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxOTozNDo0MlrOH5SN-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxNjY0Mg==", "bodyText": "log -> LOG for consistency", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529816642", "createdAt": "2020-11-24T19:12:11Z", "author": {"login": "OlegMazurov"}, "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -97,6 +97,8 @@\n \n     private static final Logger AUDITLOG =Logger.getLogger(\"splice-audit\");\n \n+    private static final Logger log = Logger.getLogger(DRDAConnThread.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxOTU3NQ==", "bodyText": "The reason we redundantly check if Debug/Trace levels are enabled outside the logging methods is to avoid argument evaluation which is done unconditionally and may have quite noticeable overhead.\nIntroducing an intermediate convenience method apparently defeats the purpose.\nThe existing trace() method doesn't conform to that principle and should be reworked (separately from this PR; also to use Logger). It should not be considered as acceptable still.", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529819575", "createdAt": "2020-11-24T19:17:31Z", "author": {"login": "OlegMazurov"}, "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -306,13 +309,22 @@ private void parsePRDDTA() throws DRDAProtocolException\n         initialize();\n     }\n \n+    private String getSessionName() {\n+        return session == null ? \"\" : session.toString();\n+    }\n+\n+    private void debug(String message) {\n+        if(log.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyNTg5MQ==", "bodyText": "Use LOG.debug(message, error). It will also print the error.getMessage() and the stack trace.", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529825891", "createdAt": "2020-11-24T19:28:39Z", "author": {"login": "OlegMazurov"}, "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -380,6 +393,8 @@ public void run() {\n                 // TODO: Could make use of Throwable.addSuppressed here when\n                 //       compiled as Java 7 (or newer).\n                 try {\n+                    debug(\"encountered error \" + error.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyODEwNg==", "bodyText": "Use LOG. Ideally we'll have just one logging system and it won't be the Derby one.", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529828106", "createdAt": "2020-11-24T19:32:22Z", "author": {"login": "OlegMazurov"}, "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -1188,6 +1200,9 @@ private void processCommands() throws DRDAProtocolException\n                     server.consoleExceptionPrint(sqle);\n                     SanityManager.THROWASSERT(\"Unexpected exception after \" +\n                             \"codePoint \"+cpStr, sqle);\n+                } catch (Exception e) {\n+                    server.consoleExceptionPrint(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyODUwOQ==", "bodyText": "LOG.debug(message, error)", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529828509", "createdAt": "2020-11-24T19:33:09Z", "author": {"login": "OlegMazurov"}, "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -8697,14 +8714,24 @@ private void closeSession()\n         server.removeFromSessionTable(session.connNum);\n         try {\n             session.close();\n-        } catch (SQLException se)\n+            debug(getSessionName() + \" closed\");\n+        }\n+        catch (SQLException se)\n         {\n             // If something went wrong closing down the session.\n             // Print an error to the console and close this\n             //thread. (6013)\n+            debug(\"encountered exception while closing session \" + getSessionName());\n             sendUnexpectedException(se);\n             close();\n         }\n+        catch (Exception e)\n+        {\n+            // log the exception and rethrow.\n+            debug(\"encountered exception while closing session \"+ getSessionName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyODcyNg==", "bodyText": "LOG.debug(message, error)", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529828726", "createdAt": "2020-11-24T19:33:34Z", "author": {"login": "OlegMazurov"}, "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/DRDAConnThread.java", "diffHunk": "@@ -8725,6 +8752,7 @@ private void handleException(Exception e)\n             if (e instanceof DRDAProtocolException) {\n                 // protocol error - write error message\n                 sendProtocolException((DRDAProtocolException) e);\n+                server.consoleExceptionPrintTrace(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgyOTM3MQ==", "bodyText": "LOG.debug(message, error)", "url": "https://github.com/splicemachine/spliceengine/pull/4688#discussion_r529829371", "createdAt": "2020-11-24T19:34:42Z", "author": {"login": "OlegMazurov"}, "path": "db-drda/src/main/java/com/splicemachine/db/impl/drda/NetworkServerControlImpl.java", "diffHunk": "@@ -3973,6 +3972,10 @@ void addSession(Socket clientSocket) throws Exception {\n                 if ((maxThreads == 0) || (threadList.size() < maxThreads)) {\n                     thread = new DRDAConnThread(session, this, getTimeSlice(),\n                                                 getLogConnections());\n+                    thread.setUncaughtExceptionHandler((t, e) -> {\n+                        consoleMessage(\"tracing unhandled exception originating from thread: '\" + t.getName() + \"'\", true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTQ1OTE3", "url": "https://github.com/splicemachine/spliceengine/pull/4688#pullrequestreview-538145917", "createdAt": "2020-11-25T04:19:04Z", "commit": {"oid": "eabf7d6e7a40ad9d890e268061ba2f43c645b4f8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f450bc03a75ab1409bdbfe727fc4be9e13eb298c", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f450bc03a75ab1409bdbfe727fc4be9e13eb298c", "committedDate": "2020-11-25T12:02:01Z", "message": "DB-10878 address comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NzA0NTMy", "url": "https://github.com/splicemachine/spliceengine/pull/4688#pullrequestreview-538704532", "createdAt": "2020-11-25T17:11:45Z", "commit": {"oid": "f450bc03a75ab1409bdbfe727fc4be9e13eb298c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NzExOTg5", "url": "https://github.com/splicemachine/spliceengine/pull/4688#pullrequestreview-538711989", "createdAt": "2020-11-25T17:21:33Z", "commit": {"oid": "f450bc03a75ab1409bdbfe727fc4be9e13eb298c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NzMwNDM2", "url": "https://github.com/splicemachine/spliceengine/pull/4688#pullrequestreview-538730436", "createdAt": "2020-11-25T17:46:43Z", "commit": {"oid": "f450bc03a75ab1409bdbfe727fc4be9e13eb298c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddd53184e2c43a1b29497aab300c71d5a9dde53b", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/ddd53184e2c43a1b29497aab300c71d5a9dde53b", "committedDate": "2020-11-25T17:52:38Z", "message": "Merge remote-tracking branch 'origin/master' into DB-10878"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1024, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}