{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NzA0MjA4", "number": 4740, "title": "DB-10898 DB-10897 configurable timestamp precision.", "bodyText": "In this PR we support configurable TIMESTAMP precision (between 0 and 9), this alters the behavior of CHAR(TIMESTAMP...)) making the resulting textual representation of the timestamp appear with different precision.\nChanging the precision can be done by running call SYSCS_UTIL.SYSCS_SET_GLOBAL_DATABASE_PROPERTY( 'splice.function.timestampPrecision', '9' ); where 9 in this example is the desired TIMESTAMP precision.", "createdAt": "2020-11-30T17:38:13Z", "url": "https://github.com/splicemachine/spliceengine/pull/4740", "merged": true, "mergeCommit": {"oid": "8fb8b6947c07340a6a78a357ffa4812f1dac0918"}, "closed": true, "closedAt": "2020-12-03T18:07:30Z", "author": {"login": "hatyo"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdho0ZNAH2gAyNTI5NzA0MjA4OmJmZGQ1NzU5ZDc0YWMyODQzOTU1NzVlY2ExOTc3ZGRhN2VjZDg0ZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdilZ_OAH2gAyNTI5NzA0MjA4Ojg1ZjQwNTI5NWRhM2JlMWFjOGNkMWEwZmJjN2NlYTQ2NTlhZTA2YmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bfdd5759d74ac284395575eca1977dda7ecd84e5", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/bfdd5759d74ac284395575eca1977dda7ecd84e5", "committedDate": "2020-11-30T17:30:10Z", "message": "DB-10898 DB-10897 configurable timestamp precision."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjMwOTI4", "url": "https://github.com/splicemachine/spliceengine/pull/4740#pullrequestreview-541230928", "createdAt": "2020-11-30T19:37:34Z", "commit": {"oid": "bfdd5759d74ac284395575eca1977dda7ecd84e5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxOTozNzozNVrOH8KnEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxOTo0MzoyMlrOH8K0bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1MDQ1MA==", "bodyText": "I guess we can't quite deprecate that one until we support an alternative that can be used for a transition though, but I agree we need to deprecate this in favour of a single parameter for timestamp precision, and a new way to specify the precision at function level: e.g. CURRENT TIMESTAMP(9)", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r532850450", "createdAt": "2020-11-30T19:37:35Z", "author": {"login": "arnaud-splice"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "diffHunk": "@@ -603,6 +604,10 @@ else if (newMergeJoinString.equals(\"forced\"))\n                 }\n                 cc.setDisablePerParallelTaskJoinCosting(disablePerParallelTaskJoinCosting);\n \n+                /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfdd5759d74ac284395575eca1977dda7ecd84e5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg1Mzg2OA==", "bodyText": "@martinrupp are you familiar with that? I seem to remember that you worked with precisions before.", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r532853868", "createdAt": "2020-11-30T19:43:22Z", "author": {"login": "arnaud-splice"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CastNode.java", "diffHunk": "@@ -1101,6 +1123,7 @@ private void genDataValueConversion(ExpressionClassBuilder acb,\n              * of VSDV.\n              */\n \n+            // not sure if this is important", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfdd5759d74ac284395575eca1977dda7ecd84e5"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d77b16d33bd09912bd4165c72897aa6c4a904a7", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/3d77b16d33bd09912bd4165c72897aa6c4a904a7", "committedDate": "2020-12-01T14:19:49Z", "message": "DB-10898 fix issues and add tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "400bba52bdac6135ea288688efd5b96eb7032ea8", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/400bba52bdac6135ea288688efd5b96eb7032ea8", "committedDate": "2020-12-01T14:35:11Z", "message": "Merge remote-tracking branch 'origin/master' into DB-10898"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ae7e5c41de442618a7625d3e2f8c3f8b44b7e4b", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/0ae7e5c41de442618a7625d3e2f8c3f8b44b7e4b", "committedDate": "2020-12-01T14:20:23Z", "message": "Merge remote-tracking branch 'origin/master' into DB-10898"}, "afterCommit": {"oid": "400bba52bdac6135ea288688efd5b96eb7032ea8", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/400bba52bdac6135ea288688efd5b96eb7032ea8", "committedDate": "2020-12-01T14:35:11Z", "message": "Merge remote-tracking branch 'origin/master' into DB-10898"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12fa21bc19a7fe4d1f288f241a000ac5c97c6d39", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/12fa21bc19a7fe4d1f288f241a000ac5c97c6d39", "committedDate": "2020-12-02T16:00:26Z", "message": "Merge remote-tracking branch 'origin/master' into DB-10898"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a04d9071a02ba10c7d9b62afea244e1c935729ed", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/a04d9071a02ba10c7d9b62afea244e1c935729ed", "committedDate": "2020-12-02T16:49:03Z", "message": "DB-10898 address spotbugs issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjIyNTQ3", "url": "https://github.com/splicemachine/spliceengine/pull/4740#pullrequestreview-543222547", "createdAt": "2020-12-02T20:45:33Z", "commit": {"oid": "a04d9071a02ba10c7d9b62afea244e1c935729ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDo0NTozM1rOH9tcNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMDo0NTozM1rOH9tcNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2OTY4NA==", "bodyText": "I like the idea of automatically forcing recompile for convenience, but are you sure we want to do this?  It may have a performance impact.  Every time a flag is changed we have to recompile all SQLs and triggers.  There is no option for the user to set a database property without calling these cache-clearing functions if they wish to avoid it.  Something we should think about, perhaps, before making this change.", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r534469684", "createdAt": "2020-12-02T20:45:33Z", "author": {"login": "msirek"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java", "diffHunk": "@@ -1283,6 +1283,9 @@ public static void SYSCS_SET_GLOBAL_DATABASE_PROPERTY(final String key,final Str\n             PropertyInfo.setDatabaseProperty(key, value);\n             DDLMessage.DDLChange ddlChange = ProtoUtil.createSetDatabaseProperty(tc.getActiveStateTxn().getTxnId(), key);\n             tc.prepareDataDictionaryChange(DDLUtils.notifyMetadataChange(ddlChange));\n+            // we need to invalidate the statement caches since we could set parameters that affect query plans.\n+            SYSCS_INVALIDATE_STORED_STATEMENTS();\n+            SYSCS_EMPTY_GLOBAL_STATEMENT_CACHE();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a04d9071a02ba10c7d9b62afea244e1c935729ed"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58e674947b07ff0d456be8080f7de64bd33fca3a", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/58e674947b07ff0d456be8080f7de64bd33fca3a", "committedDate": "2020-12-02T20:51:54Z", "message": "DB-10898 fix tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzY0NTA0", "url": "https://github.com/splicemachine/spliceengine/pull/4740#pullrequestreview-543364504", "createdAt": "2020-12-03T01:09:58Z", "commit": {"oid": "58e674947b07ff0d456be8080f7de64bd33fca3a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwMTowOTo1OFrOH901fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwMTowOTo1OFrOH901fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU5MDg0Nw==", "bodyText": "Better to throw the error so that the user can correct the property values", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r534590847", "createdAt": "2020-12-03T01:09:58Z", "author": {"login": "jyuanca"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "diffHunk": "@@ -619,6 +620,22 @@ else if (newMergeJoinString.equals(\"forced\"))\n                 }\n                 cc.setCurrentTimestampPrecision(currentTimestampPrecision);\n \n+                String timestampPrecisionString =\n+                        PropertyUtil.getCachedDatabaseProperty(lcc, Property.SPLICE_TIMESTAMP_PRECISION);\n+                int timestampPrecision = CompilerContext.DEFAULT_TIMESTAMP_PRECISION;\n+                try {\n+                    if (timestampPrecisionString != null)\n+                        timestampPrecision = Integer.parseInt(timestampPrecisionString);\n+                    if (timestampPrecision < Limits.MIN_TIMESTAMP_PRECISION)\n+                        timestampPrecision = Limits.MIN_TIMESTAMP_PRECISION;\n+                    if (timestampPrecision > Limits.MAX_TIMESTAMP_PRECISION)\n+                        timestampPrecision = Limits.MAX_TIMESTAMP_PRECISION;\n+                } catch (Exception e) {\n+                    // If the property value failed to convert to a boolean, don't throw an error,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58e674947b07ff0d456be8080f7de64bd33fca3a"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzg4NjUx", "url": "https://github.com/splicemachine/spliceengine/pull/4740#pullrequestreview-543388651", "createdAt": "2020-12-03T02:13:47Z", "commit": {"oid": "58e674947b07ff0d456be8080f7de64bd33fca3a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "197fc0143cc74829c199e04208ae1f8bd33f0e04", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/197fc0143cc74829c199e04208ae1f8bd33f0e04", "committedDate": "2020-12-03T08:58:41Z", "message": "Merge remote-tracking branch 'origin/master' into DB-10898"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODkxNjE5", "url": "https://github.com/splicemachine/spliceengine/pull/4740#pullrequestreview-543891619", "createdAt": "2020-12-03T12:12:46Z", "commit": {"oid": "197fc0143cc74829c199e04208ae1f8bd33f0e04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MDMxMjQx", "url": "https://github.com/splicemachine/spliceengine/pull/4740#pullrequestreview-544031241", "createdAt": "2020-12-03T14:50:43Z", "commit": {"oid": "197fc0143cc74829c199e04208ae1f8bd33f0e04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MTE0ODk3", "url": "https://github.com/splicemachine/spliceengine/pull/4740#pullrequestreview-544114897", "createdAt": "2020-12-03T16:00:35Z", "commit": {"oid": "197fc0143cc74829c199e04208ae1f8bd33f0e04"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjowMDozNVrOH-j_ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjowMDozNVrOH-j_ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2MzUxNA==", "bodyText": "This is not needed for all database properties. You can do this if the property is timestamp precision", "url": "https://github.com/splicemachine/spliceengine/pull/4740#discussion_r535363514", "createdAt": "2020-12-03T16:00:35Z", "author": {"login": "jyuanca"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/utils/SpliceAdmin.java", "diffHunk": "@@ -1283,6 +1283,9 @@ public static void SYSCS_SET_GLOBAL_DATABASE_PROPERTY(final String key,final Str\n             PropertyInfo.setDatabaseProperty(key, value);\n             DDLMessage.DDLChange ddlChange = ProtoUtil.createSetDatabaseProperty(tc.getActiveStateTxn().getTxnId(), key);\n             tc.prepareDataDictionaryChange(DDLUtils.notifyMetadataChange(ddlChange));\n+            // we need to invalidate the statement caches since we could set parameters that affect query plans.\n+            SYSCS_INVALIDATE_STORED_STATEMENTS();\n+            SYSCS_EMPTY_GLOBAL_STATEMENT_CACHE();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ2OTY4NA=="}, "originalCommit": {"oid": "a04d9071a02ba10c7d9b62afea244e1c935729ed"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85f405295da3be1ac8cd1a0fbc7cea4659ae06ba", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/85f405295da3be1ac8cd1a0fbc7cea4659ae06ba", "committedDate": "2020-12-03T16:05:32Z", "message": "DB-10898 adapt failing test."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1037, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}