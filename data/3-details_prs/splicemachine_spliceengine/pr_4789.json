{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNzAyMjIz", "number": 4789, "title": "DB-10963 Add timeouts to connection.close() and call abort() on timeout", "bodyText": "", "createdAt": "2020-12-04T18:15:28Z", "url": "https://github.com/splicemachine/spliceengine/pull/4789", "merged": true, "mergeCommit": {"oid": "c3b26a01ec93bf35a0f138cf86d8248d207be595"}, "closed": true, "closedAt": "2020-12-10T16:56:02Z", "author": {"login": "dgomezferro"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi7xqLAH2gAyNTMyNzAyMjIzOjQ2YjE3NjE5YTQwMzIxM2Y3OWZkNzBhMjJmNDA0MjcwNDE3YzkyN2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk1_8JgFqTU0OTM4NDYxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "46b17619a403213f79fd70a22f404270417c927c", "author": {"user": {"login": "dgomezferro", "name": "Daniel G\u00f3mez Ferro"}}, "url": "https://github.com/splicemachine/spliceengine/commit/46b17619a403213f79fd70a22f404270417c927c", "committedDate": "2020-12-04T18:09:18Z", "message": "DB-10963 Add timeouts to connection.close() and call abort() on timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126", "author": {"user": {"login": "dgomezferro", "name": "Daniel G\u00f3mez Ferro"}}, "url": "https://github.com/splicemachine/spliceengine/commit/cf96b9ee9ecfab3e890703e8f21a29662d1ce126", "committedDate": "2020-12-04T18:57:24Z", "message": "DB-10963 Fix spotbugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2OTc1NjAy", "url": "https://github.com/splicemachine/spliceengine/pull/4789#pullrequestreview-546975602", "createdAt": "2020-12-08T09:51:49Z", "commit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTo1MTo0OVrOIBQqvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTo1MTo0OVrOIBQqvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5MjU3NA==", "bodyText": "The thread pool is shared right? according to the doc:\n\npublic static ExecutorService newFixedThreadPool(int nThreads)\n... At any point, at most nThreads threads will be active processing tasks. If additional tasks are submitted when all threads are active, they will wait in the queue until a thread is available.\n\nIf we run Test suites in parallel which use SpliceWatcher, could it lead to competition between different suites calling closeConnection on parallel and causing some of them to time out (as they are given 10 seconds to finish per line 198).", "url": "https://github.com/splicemachine/spliceengine/pull/4789#discussion_r538192574", "createdAt": "2020-12-08T09:51:49Z", "author": {"login": "hatyo"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceWatcher.java", "diffHunk": "@@ -160,21 +173,61 @@ public PreparedStatement prepareStatement(String sql) throws SQLException {\n         return ps;\n     }\n \n+    /**\n+     * Try closing connections gracefully from different threads, if that takes long it could be some queries are stuck,\n+     * so abort the connections forcefully instead\n+     */\n     private void closeConnections() {\n+        int numThreads = connections.size() + 2; // two extra for the .abort() call\n+        ExecutorService executor = Executors.newFixedThreadPool(numThreads,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2OTc4MDQz", "url": "https://github.com/splicemachine/spliceengine/pull/4789#pullrequestreview-546978043", "createdAt": "2020-12-08T09:53:29Z", "commit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTo1MzoyOVrOIBQvjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTo1MzoyOVrOIBQvjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5MzgwNA==", "bodyText": "Does it make sense to at least log this exception?", "url": "https://github.com/splicemachine/spliceengine/pull/4789#discussion_r538193804", "createdAt": "2020-12-08T09:53:29Z", "author": {"login": "hatyo"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceWatcher.java", "diffHunk": "@@ -160,21 +173,61 @@ public PreparedStatement prepareStatement(String sql) throws SQLException {\n         return ps;\n     }\n \n+    /**\n+     * Try closing connections gracefully from different threads, if that takes long it could be some queries are stuck,\n+     * so abort the connections forcefully instead\n+     */\n     private void closeConnections() {\n+        int numThreads = connections.size() + 2; // two extra for the .abort() call\n+        ExecutorService executor = Executors.newFixedThreadPool(numThreads,\n+                new ThreadFactoryBuilder().setDaemon(true).setNameFormat(\"connection-close-%d\").build());\n+        CompletionService<Void> completionService =\n+                new ExecutorCompletionService<>(executor);\n         try {\n-            for (Connection connection : connections) {\n-                if (connection != null && !connection.isClosed()) {\n-                    try {\n-                        connection.close();\n-                    } catch (SQLException e) {\n-                        connection.rollback();\n+            connections.stream().forEach(connection -> completionService.submit(() -> {\n+                try {\n+                    if (connection != null && !connection.isClosed())\n                         connection.close();\n+                } catch (SQLException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2OTgxNzcx", "url": "https://github.com/splicemachine/spliceengine/pull/4789#pullrequestreview-546981771", "createdAt": "2020-12-08T09:55:26Z", "commit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTo1NToyNlrOIBQ1Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTo1NToyNlrOIBQ1Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5NTIzOA==", "bodyText": "we were verifying previously that the result set contained at least one row, this is removed now, is this intentional?", "url": "https://github.com/splicemachine/spliceengine/pull/4789#discussion_r538195238", "createdAt": "2020-12-08T09:55:26Z", "author": {"login": "hatyo"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceAdmin_OperationsIT.java", "diffHunk": "@@ -239,11 +246,9 @@ public void testKillLongRunningQuery(boolean useSpark) throws Exception {\n         Thread thread = new Thread(new Runnable() {\n             @Override\n             public void run() {\n-                PreparedStatement ps = null;\n-                try (TestConnection connection = methodWatcher.createConnection()) {\n-                    ps = connection.prepareStatement(sql);\n-                    ResultSet rs = ps.executeQuery();\n-                    assertTrue(rs.next());\n+                try (TestConnection connection = methodWatcher.createConnection();\n+                     PreparedStatement ps = connection.prepareStatement(sql);\n+                     ResultSet rs = ps.executeQuery()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MTA1Njky", "url": "https://github.com/splicemachine/spliceengine/pull/4789#pullrequestreview-547105692", "createdAt": "2020-12-08T11:06:02Z", "commit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMTowNjowMlrOIBUBLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMTowNjowMlrOIBUBLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0NzQ3MA==", "bodyText": "(minor comment) this would wait 10 second not for each, but 10 second every time you call it, so the first one is for 10s, the second 20s, third 30s etc.. Maybe sth like\nFuture<Void> future = completionService.poll(futures  == 0 ? 10 : 1, TimeUnit.SECONDS);\nI'm not entirely sure you need a CompletionService here at all, maybe a simple\nExecutorService.invokeAll(Callable, timeout, TimeUnit) would work.", "url": "https://github.com/splicemachine/spliceengine/pull/4789#discussion_r538247470", "createdAt": "2020-12-08T11:06:02Z", "author": {"login": "martinrupp"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceWatcher.java", "diffHunk": "@@ -160,21 +173,61 @@ public PreparedStatement prepareStatement(String sql) throws SQLException {\n         return ps;\n     }\n \n+    /**\n+     * Try closing connections gracefully from different threads, if that takes long it could be some queries are stuck,\n+     * so abort the connections forcefully instead\n+     */\n     private void closeConnections() {\n+        int numThreads = connections.size() + 2; // two extra for the .abort() call\n+        ExecutorService executor = Executors.newFixedThreadPool(numThreads,\n+                new ThreadFactoryBuilder().setDaemon(true).setNameFormat(\"connection-close-%d\").build());\n+        CompletionService<Void> completionService =\n+                new ExecutorCompletionService<>(executor);\n         try {\n-            for (Connection connection : connections) {\n-                if (connection != null && !connection.isClosed()) {\n-                    try {\n-                        connection.close();\n-                    } catch (SQLException e) {\n-                        connection.rollback();\n+            connections.stream().forEach(connection -> completionService.submit(() -> {\n+                try {\n+                    if (connection != null && !connection.isClosed())\n                         connection.close();\n+                } catch (SQLException e) {\n+                }\n+                return null;\n+            }));\n+\n+            int futures = 0;\n+            while(futures++ < connections.size()) {\n+                Future<Void> future = completionService.poll(10, TimeUnit.SECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTM2MzA4", "url": "https://github.com/splicemachine/spliceengine/pull/4789#pullrequestreview-547536308", "createdAt": "2020-12-08T18:55:58Z", "commit": {"oid": "cf96b9ee9ecfab3e890703e8f21a29662d1ce126"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b1d6b764af5a5eead983f685d6eb33b6f68d48e", "author": {"user": {"login": "dgomezferro", "name": "Daniel G\u00f3mez Ferro"}}, "url": "https://github.com/splicemachine/spliceengine/commit/8b1d6b764af5a5eead983f685d6eb33b6f68d48e", "committedDate": "2020-12-10T11:43:34Z", "message": "DB-10963 Address reviews"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MTIyMDM0", "url": "https://github.com/splicemachine/spliceengine/pull/4789#pullrequestreview-549122034", "createdAt": "2020-12-10T11:54:41Z", "commit": {"oid": "8b1d6b764af5a5eead983f685d6eb33b6f68d48e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMTo1NDo0MVrOIDFmWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMTo1NDo0MVrOIDFmWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEwODM3OA==", "bodyText": "wouldn't this cause problems when running tests in parallel?", "url": "https://github.com/splicemachine/spliceengine/pull/4789#discussion_r540108378", "createdAt": "2020-12-10T11:54:41Z", "author": {"login": "martinrupp"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceWatcher.java", "diffHunk": "@@ -51,6 +54,8 @@\n public class SpliceWatcher extends TestWatcher implements AutoCloseable {\n \n     private static final Logger LOG = Logger.getLogger(SpliceWatcher.class);\n+    private static ExecutorService executor = Executors.newCachedThreadPool(\n+            new ThreadFactoryBuilder().setDaemon(true).setNameFormat(\"connection-close-%d\").build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b1d6b764af5a5eead983f685d6eb33b6f68d48e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MTI2OTAz", "url": "https://github.com/splicemachine/spliceengine/pull/4789#pullrequestreview-549126903", "createdAt": "2020-12-10T12:01:04Z", "commit": {"oid": "8b1d6b764af5a5eead983f685d6eb33b6f68d48e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMjowMTowNFrOIDF18Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMjowMTowNFrOIDF18Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDExMjM2OQ==", "bodyText": "right, ok!", "url": "https://github.com/splicemachine/spliceengine/pull/4789#discussion_r540112369", "createdAt": "2020-12-10T12:01:04Z", "author": {"login": "martinrupp"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceWatcher.java", "diffHunk": "@@ -51,6 +54,8 @@\n public class SpliceWatcher extends TestWatcher implements AutoCloseable {\n \n     private static final Logger LOG = Logger.getLogger(SpliceWatcher.class);\n+    private static ExecutorService executor = Executors.newCachedThreadPool(\n+            new ThreadFactoryBuilder().setDaemon(true).setNameFormat(\"connection-close-%d\").build());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDEwODM3OA=="}, "originalCommit": {"oid": "8b1d6b764af5a5eead983f685d6eb33b6f68d48e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Mzg0NjEw", "url": "https://github.com/splicemachine/spliceengine/pull/4789#pullrequestreview-549384610", "createdAt": "2020-12-10T16:33:19Z", "commit": {"oid": "8b1d6b764af5a5eead983f685d6eb33b6f68d48e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 997, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}