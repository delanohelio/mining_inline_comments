{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MzAzMjY0", "number": 3828, "title": "DB-9620 Add ROWID SQL functions", "bodyText": "Add test to TO_INSTANT SQL function.\nAdd TO_HBASE_ESCAPED function.\nAdd tests and address SpotBug issues.", "createdAt": "2020-07-15T07:36:28Z", "url": "https://github.com/splicemachine/spliceengine/pull/3828", "merged": true, "mergeCommit": {"oid": "11afe727cd711d65243d5741fc0af28c5fb27e73"}, "closed": true, "closedAt": "2020-07-24T03:20:17Z", "author": {"login": "hatyo"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc026fHAH2gAyNDQ5MzAzMjY0Ojc2NDAxYjVhZWFiY2QyYzkwYjM1NzcyZjQ0ZDZjNTUxNTYyM2VlNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3rBoagFqTQ1MzkyMTk4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "76401b5aeabcd2c90b35772f44d6c5515623ee68", "author": {"user": {"login": "yxia92", "name": "Yi Xia"}}, "url": "https://github.com/splicemachine/spliceengine/commit/76401b5aeabcd2c90b35772f44d6c5515623ee68", "committedDate": "2020-07-14T14:28:54Z", "message": "DB-9826 add ProjectRestrictNode in the presence of rowid references in condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3e09699c0cc70ff39372bd4f26178af16399e83", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/c3e09699c0cc70ff39372bd4f26178af16399e83", "committedDate": "2020-07-14T14:35:19Z", "message": "DB-9826 Refactor for testing.\n\n- Refactor the logic for handling rowId in ProjectRestrictNode\n  in a separate function so it can be unit-tested.\n- Add unit test and integration test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e06bf8044a044951a7449539389d1830b1b67e2e", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/e06bf8044a044951a7449539389d1830b1b67e2e", "committedDate": "2020-07-14T15:48:54Z", "message": "DB-9826 revert unit test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bfd0d0451bbdb2f71a16aa2b62ae98734f9f681", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/4bfd0d0451bbdb2f71a16aa2b62ae98734f9f681", "committedDate": "2020-07-14T16:48:10Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9826"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b70fe61e3d04a4a04e52d280392b667e9794db4b", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/b70fe61e3d04a4a04e52d280392b667e9794db4b", "committedDate": "2020-07-14T17:04:43Z", "message": "DB-9620 Add utility functions to work with ROWIDs.\n\n- Add ToInstant function that maps ROWID to TIMESTAMP."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce7f3df96b8d63b8e28aac9ce2d2cb4c0dd2e917", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/ce7f3df96b8d63b8e28aac9ce2d2cb4c0dd2e917", "committedDate": "2020-07-14T17:10:19Z", "message": "Merge remote-tracking branch 'origin/DB-9826' into DB-9620"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf99894fab01eafa070a456085ba9141d441190d", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/cf99894fab01eafa070a456085ba9141d441190d", "committedDate": "2020-07-14T19:10:02Z", "message": "DB-9620 Add test to ToInstant SQL function.\n\n- Translate exceptions into customer-facing SQL exceptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f519d29cfe67c4c764f0ef919f6e52e3ad738748", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f519d29cfe67c4c764f0ef919f6e52e3ad738748", "committedDate": "2020-07-15T08:58:37Z", "message": "DB-9620 Add TO_HBASE_ESCAPED function.\n\n- Add tests.\n- Cleanup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d287b59bd87ed1e3b4bbbcf17fda859b1d670ea4", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/d287b59bd87ed1e3b4bbbcf17fda859b1d670ea4", "committedDate": "2020-07-15T14:33:40Z", "message": "DB-9620 Address SpotBug issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDQ5NTU2", "url": "https://github.com/splicemachine/spliceengine/pull/3828#pullrequestreview-449049556", "createdAt": "2020-07-15T15:01:50Z", "commit": {"oid": "d287b59bd87ed1e3b4bbbcf17fda859b1d670ea4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55b5f08d9bd32ace58377a0909002553c41f8fa2", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/55b5f08d9bd32ace58377a0909002553c41f8fa2", "committedDate": "2020-07-16T09:02:52Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9826"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5ODE3ODY1", "url": "https://github.com/splicemachine/spliceengine/pull/3828#pullrequestreview-449817865", "createdAt": "2020-07-16T12:54:53Z", "commit": {"oid": "d287b59bd87ed1e3b4bbbcf17fda859b1d670ea4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNDczNTc1", "url": "https://github.com/splicemachine/spliceengine/pull/3828#pullrequestreview-450473575", "createdAt": "2020-07-17T08:33:38Z", "commit": {"oid": "b70fe61e3d04a4a04e52d280392b667e9794db4b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwODozMzozOFrOGzKZSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwODo0MTozM1rOGzKprA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMwMDg3NQ==", "bodyText": "this could be a static function. then you could have a unit test for toLongTimestamp\npublic static long toLongTimestamp( String str, long time )\n{\n\tString hex = toHBaseEscaped( str );\n    long value = Bytes.toLong(Bytes.toBytesBinary(hex));\n    long ts = time & (~TIMESTAMP_MASK);\n    ts |= (value >> TIMESTAMP_SHIFT) & TIMESTAMP_MASK;\n    return ts;\n}\n\nstatic DateTimeDataValue toInstant(DataValueDescriptor s) throws StandardException {\n    if(s == null) {\n        return null;\n    }\n\n    long time = System.currentTimeMillis();\n    return new SQLTimestamp(new Timestamp( toLongTimestamp(s.getString(), time)));\n}", "url": "https://github.com/splicemachine/spliceengine/pull/3828#discussion_r456300875", "createdAt": "2020-07-17T08:33:38Z", "author": {"login": "martinrupp"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/util/RowIdUtil.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package com.splicemachine.db.iapi.util;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.types.*;\n+import com.splicemachine.primitives.Bytes;\n+\n+import java.sql.Timestamp;\n+import java.time.Instant;\n+\n+import static com.splicemachine.uuid.Snowflake.TIMESTAMP_MASK;\n+import static com.splicemachine.uuid.Snowflake.TIMESTAMP_SHIFT;\n+\n+public interface RowIdUtil {\n+\n+    static String toHBaseEscaped(String s) {\n+        StringBuilder sb = new StringBuilder();\n+        for (int i = 0; i < s.length(); i += 2) {\n+            sb.append(\"\\\\x\").append(s, i, i+2);\n+        }\n+        return sb.toString();\n+    }\n+\n+    static DateTimeDataValue toInstant(DataValueDescriptor s) throws StandardException {\n+        if(s == null) {\n+            return null;\n+        }\n+        String hex = toHBaseEscaped(s.getString());\n+        long value = Bytes.toLong(Bytes.toBytesBinary(hex));\n+        long ts = System.currentTimeMillis() & (~TIMESTAMP_MASK);\n+        ts |= (value >> TIMESTAMP_SHIFT) & TIMESTAMP_MASK;\n+        return new SQLTimestamp(new Timestamp(ts));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b70fe61e3d04a4a04e52d280392b667e9794db4b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMwNTAxMA==", "bodyText": "this looks like you're comparing the result against the result.\nmaybe instead of result use expectedEscaped.", "url": "https://github.com/splicemachine/spliceengine/pull/3828#discussion_r456305010", "createdAt": "2020-07-17T08:41:26Z", "author": {"login": "martinrupp"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/RowIdIT.java", "diffHunk": "@@ -450,4 +451,30 @@ public void testRowIdToInstantFunctionInvalidInput() {\n         }\n         fail(\"Expected: java.sql.SQLException: ERROR 22008: '33445567' is an invalid argument to the TO_INSTANT function.\");\n     }\n+\n+    @Test\n+    public void testRowIdToHbaseEscapedFunction() throws Exception {\n+        ResultSet resultSet  = methodWatcher.executeQuery(String.format(\"select cast(rowid as varchar(30)) from %s\",\n+                this.getTableReference(TABLE7_NAME)));\n+        Assert.assertTrue(resultSet.next());\n+        String rowId = resultSet.getString(1);\n+        Assert.assertFalse(resultSet.next());\n+        StringDataValue result = RowIdUtil.toHBaseEscaped(new SQLChar(rowId));\n+        resultSet = methodWatcher.executeQuery(String.format(\"select to_hbase_escaped(rowid) from %s\", this.getTableReference(TABLE7_NAME)));\n+        Assert.assertTrue(resultSet.next());\n+        Assert.assertEquals(result.getString(), resultSet.getString(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f519d29cfe67c4c764f0ef919f6e52e3ad738748"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjMwNTA2OA==", "bodyText": "can you add a test where you have input and output as strings? e.g.\nAssert.equals( RowIdUtil.toHBaseEscaped(\"HelloWorld\\x33asdf\\n\\t\") , \"HelloWorld\\\\x33asdf\\\\x0D\" ));\nOtherwise it somehow feels like you're testing toHBaseEscaped by using toHBaseEscaped.", "url": "https://github.com/splicemachine/spliceengine/pull/3828#discussion_r456305068", "createdAt": "2020-07-17T08:41:33Z", "author": {"login": "martinrupp"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/RowIdIT.java", "diffHunk": "@@ -450,4 +451,30 @@ public void testRowIdToInstantFunctionInvalidInput() {\n         }\n         fail(\"Expected: java.sql.SQLException: ERROR 22008: '33445567' is an invalid argument to the TO_INSTANT function.\");\n     }\n+\n+    @Test\n+    public void testRowIdToHbaseEscapedFunction() throws Exception {\n+        ResultSet resultSet  = methodWatcher.executeQuery(String.format(\"select cast(rowid as varchar(30)) from %s\",\n+                this.getTableReference(TABLE7_NAME)));\n+        Assert.assertTrue(resultSet.next());\n+        String rowId = resultSet.getString(1);\n+        Assert.assertFalse(resultSet.next());\n+        StringDataValue result = RowIdUtil.toHBaseEscaped(new SQLChar(rowId));\n+        resultSet = methodWatcher.executeQuery(String.format(\"select to_hbase_escaped(rowid) from %s\", this.getTableReference(TABLE7_NAME)));\n+        Assert.assertTrue(resultSet.next());\n+        Assert.assertEquals(result.getString(), resultSet.getString(1));\n+        Assert.assertFalse(resultSet.next());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f519d29cfe67c4c764f0ef919f6e52e3ad738748"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca85fb4695ab2eaa57748f9abd338104369a6ea3", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/ca85fb4695ab2eaa57748f9abd338104369a6ea3", "committedDate": "2020-07-22T16:01:14Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9826"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29663aaceddafd6e86a92c8fe33bc619bbc3aa2f", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/29663aaceddafd6e86a92c8fe33bc619bbc3aa2f", "committedDate": "2020-07-22T16:20:08Z", "message": "Merge remote-tracking branch 'origin/DB-9826' into DB-9620"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzOTIxOTg2", "url": "https://github.com/splicemachine/spliceengine/pull/3828#pullrequestreview-453921986", "createdAt": "2020-07-23T08:19:37Z", "commit": {"oid": "29663aaceddafd6e86a92c8fe33bc619bbc3aa2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1247, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}