{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNjgxMTgx", "number": 4896, "title": "DB-11067/DB-11111 SpliceCatalogUpgradeScripts UpgradeScriptForTablePriorities fix, cleanup, tests", "bodyText": "SpliceCatalogUpgradeScripts can run multiple scripts for one version\nfix UpgradeScriptForTablePriorities not running\nadded some sort of tests for SpliceCatalogUpgradeScripts\naligned master/3.0/3.1 code\ncleaned up upgrade scripts (see DB-11111)", "createdAt": "2020-12-18T17:34:13Z", "url": "https://github.com/splicemachine/spliceengine/pull/4896", "merged": true, "mergeCommit": {"oid": "72ed8c774ef5ba0b6bea577fdce50303486b3f7e"}, "closed": true, "closedAt": "2021-01-08T17:50:31Z", "author": {"login": "martinrupp"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnbshggBqjQxMzA3OTkwODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABduC_Z6gFqTU2NDAzNTQxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ed4015bf30bed5946c8a62eb6b516b3aa3ae620", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/4ed4015bf30bed5946c8a62eb6b516b3aa3ae620", "committedDate": "2020-12-18T17:33:54Z", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version"}, "afterCommit": {"oid": "f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b", "committedDate": "2020-12-18T17:36:14Z", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NjkwMDc3", "url": "https://github.com/splicemachine/spliceengine/pull/4896#pullrequestreview-555690077", "createdAt": "2020-12-18T17:46:47Z", "commit": {"oid": "f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNzo0Njo0N1rOIIslWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNzo0OToxOVrOIIsqyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk4OTk3OQ==", "bodyText": "Nitpick, you can use Long.compare(v1, v2);", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r545989979", "createdAt": "2020-12-18T17:46:47Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/Splice_DD_Version.java", "diffHunk": "@@ -117,4 +117,15 @@ public long toLong() {\n         return majorVersionNumber * 10000000000l + minorVersionNumber * 10000000l + patchVersionNumber * 10000l + sprintVersionNumber;\n     }\n \n+    static public int compare(Splice_DD_Version version1,Splice_DD_Version version2){\n+        long v1=version1.toLong();\n+        long v2=version2.toLong();\n+\n+        if(v1<v2)\n+            return -1;\n+        else if(v1==v2)\n+            return 0;\n+        else\n+            return 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk5MTM3MA==", "bodyText": "Move this one to the current version so that it gets executed with the new fixed logic. I think it already handles tables that have the expected priority, right?", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r545991370", "createdAt": "2020-12-18T17:49:19Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -35,52 +32,53 @@\n     SpliceDataDictionary sdd;\n     Splice_DD_Version catalogVersion;\n     TransactionController tc;\n-    TreeMap<Splice_DD_Version, UpgradeScript> scripts;\n-    Comparator<Splice_DD_Version> ddComparator;\n-    \n+\n+    List<VersionAndUpgrade> scripts;\n+\n+    static class VersionAndUpgrade {\n+        Splice_DD_Version version;\n+        UpgradeScript script;\n+\n+        public VersionAndUpgrade(Splice_DD_Version version,UpgradeScript script) {\n+            this.version = version;\n+            this.script = script;\n+        }\n+    }\n+\n+    public void addUpgradeScript(int major, int minor, int patch, int sprint, UpgradeScript script)\n+    {\n+        scripts.add(new VersionAndUpgrade(new Splice_DD_Version(sdd, major, minor, patch, sprint), script));\n+    }\n+\n     public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd,Splice_DD_Version catalogVersion,TransactionController tc){\n         this.sdd=sdd;\n         this.catalogVersion=catalogVersion;\n         this.tc=tc;\n \n-        ddComparator=new Comparator<Splice_DD_Version>(){\n-            @Override\n-            public int compare(Splice_DD_Version version1,Splice_DD_Version version2){\n-                long v1=version1.toLong();\n-                long v2=version2.toLong();\n-\n-                if(v1<v2)\n-                    return -1;\n-                else if(v1==v2)\n-                    return 0;\n-                else\n-                    return 1;\n-            }\n-        };\n-        scripts=new TreeMap<>(ddComparator);\n-        scripts.put(new Splice_DD_Version(sdd,2,8,0, 1901), new UpgradeScriptToRemoveUnusedBackupTables(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,2,8,0, 1909), new UpgradeScriptForReplication(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,2,8,0, 1917), new UpgradeScriptForMultiTenancy(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,2,8,0, 1924), new UpgradeScriptToAddPermissionViewsForMultiTenancy(sdd,tc));\n+        scripts = new ArrayList<>();\n+        addUpgradeScript(2,8,0, 1901, new UpgradeScriptToRemoveUnusedBackupTables(sdd,tc));\n+        addUpgradeScript(2,8,0, 1909, new UpgradeScriptForReplication(sdd, tc));\n+        addUpgradeScript(2,8,0, 1917, new UpgradeScriptForMultiTenancy(sdd,tc));\n+        addUpgradeScript(2,8,0, 1924, new UpgradeScriptToAddPermissionViewsForMultiTenancy(sdd,tc));\n \n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1933), new UpgradeScriptToUpdateViewForSYSCONGLOMERATEINSCHEMAS(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1938), new UpgradeScriptForTriggerWhenClause(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1940), new UpgradeScriptForReplicationSystemTables(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1941), new UpgradeScriptForTableColumnViewInSYSIBM(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1948), new UpgradeScriptForAddDefaultToColumnViewInSYSIBM(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1953), new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1959), new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1962), new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1964), new UpgradeScriptForAliasToTableView(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1970), new UpgradeScriptForAddTablesAndViewsInSYSIBMADM(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1971), new UpgradeScriptToAddCatalogVersion(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1974), new UpgradeScriptToAddMinRetentionPeriodColumnToSYSTABLES(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1977), new UpgradeScriptToAddSysKeyColUseViewInSYSIBM(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1979), new UpgradeScriptForTablePriorities(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1979), new UpgradeScriptToSetJavaClassNameColumnInSYSALIASES(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,2,0, 1983), new UpgradeScriptToAddBaseTableSchemaColumnsToSysTablesInSYSIBM(sdd,tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,2,0, 1985), new UpgradeScriptToAddSysNaturalNumbersTable(sdd, tc));\n-        scripts.put(new Splice_DD_Version(sdd,3,2,0, 1989), new UpgradeScriptToAddIndexColUseViewInSYSCAT(sdd, tc));\n+        addUpgradeScript(3,1,0, 1933, new UpgradeScriptToUpdateViewForSYSCONGLOMERATEINSCHEMAS(sdd,tc));\n+        addUpgradeScript(3,1,0, 1938, new UpgradeScriptForTriggerWhenClause(sdd,tc));\n+        addUpgradeScript(3,1,0, 1940, new UpgradeScriptForReplicationSystemTables(sdd,tc));\n+        addUpgradeScript(3,1,0, 1941, new UpgradeScriptForTableColumnViewInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1948, new UpgradeScriptForAddDefaultToColumnViewInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1953, new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n+        addUpgradeScript(3,1,0, 1959, new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n+        addUpgradeScript(3,1,0, 1962, new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));\n+        addUpgradeScript(3,1,0, 1964, new UpgradeScriptForAliasToTableView(sdd,tc));\n+        addUpgradeScript(3,1,0, 1970, new UpgradeScriptForAddTablesAndViewsInSYSIBMADM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1971, new UpgradeScriptToAddCatalogVersion(sdd,tc));\n+        addUpgradeScript(3,1,0, 1974, new UpgradeScriptToAddMinRetentionPeriodColumnToSYSTABLES(sdd, tc));\n+        addUpgradeScript(3,1,0, 1977, new UpgradeScriptToAddSysKeyColUseViewInSYSIBM(sdd, tc));\n+        addUpgradeScript(3,1,0, 1979, new UpgradeScriptForTablePriorities(sdd, tc));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b"}, "originalPosition": 98}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f13ac8b92e6afa3511ca90ba0c878cfbc3c5008b", "committedDate": "2020-12-18T17:36:14Z", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version"}, "afterCommit": {"oid": "dbe9d76f96466805e8995fdb7d52d62b1cd73fd4", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/dbe9d76f96466805e8995fdb7d52d62b1cd73fd4", "committedDate": "2020-12-18T17:56:24Z", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dbe9d76f96466805e8995fdb7d52d62b1cd73fd4", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/dbe9d76f96466805e8995fdb7d52d62b1cd73fd4", "committedDate": "2020-12-18T17:56:24Z", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version"}, "afterCommit": {"oid": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a", "committedDate": "2020-12-21T21:37:56Z", "message": "DB-11067 add tests for parts of SpliceCatalogUpgradeScripts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTYzNjAz", "url": "https://github.com/splicemachine/spliceengine/pull/4896#pullrequestreview-556963603", "createdAt": "2020-12-22T10:08:25Z", "commit": {"oid": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMDowODoyNVrOIJ1mmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMDoxMjoxNFrOIJ1uAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4NjMyOQ==", "bodyText": "Start method names with lowerCase", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r547186329", "createdAt": "2020-12-22T10:08:25Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -33,56 +30,81 @@\n     protected static final Logger LOG=Logger.getLogger(SpliceCatalogUpgradeScripts.class);\n \n     SpliceDataDictionary sdd;\n-    Splice_DD_Version catalogVersion;\n     TransactionController tc;\n-    TreeMap<Splice_DD_Version, UpgradeScript> scripts;\n-    Comparator<Splice_DD_Version> ddComparator;\n-    \n-    public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd,Splice_DD_Version catalogVersion,TransactionController tc){\n+\n+    List<VersionAndUpgrade> scripts;\n+\n+    public static class VersionAndUpgrade {\n+        public Splice_DD_Version version;\n+        public UpgradeScript script;\n+\n+        public VersionAndUpgrade(Splice_DD_Version version,UpgradeScript script) {\n+            this.version = version;\n+            this.script = script;\n+        }\n+    }\n+\n+    public void addUpgradeScript(int major, int minor, int patch, int sprint, UpgradeScript script)\n+    {\n+        scripts.add(new VersionAndUpgrade(new Splice_DD_Version(sdd, major, minor, patch, sprint), script));\n+    }\n+\n+    public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd, TransactionController tc){\n         this.sdd=sdd;\n-        this.catalogVersion=catalogVersion;\n         this.tc=tc;\n \n-        ddComparator=new Comparator<Splice_DD_Version>(){\n-            @Override\n-            public int compare(Splice_DD_Version version1,Splice_DD_Version version2){\n-                long v1=version1.toLong();\n-                long v2=version2.toLong();\n-\n-                if(v1<v2)\n-                    return -1;\n-                else if(v1==v2)\n-                    return 0;\n-                else\n-                    return 1;\n+        scripts = new ArrayList<>();\n+        addUpgradeScript(2,8,0, 1901, new UpgradeScriptToRemoveUnusedBackupTables(sdd,tc));\n+        addUpgradeScript(2,8,0, 1909, new UpgradeScriptForReplication(sdd, tc));\n+        addUpgradeScript(2,8,0, 1917, new UpgradeScriptForMultiTenancy(sdd,tc));\n+        addUpgradeScript(2,8,0, 1924, new UpgradeScriptToAddPermissionViewsForMultiTenancy(sdd,tc));\n+\n+        addUpgradeScript(3,1,0, 1933, new UpgradeScriptToUpdateViewForSYSCONGLOMERATEINSCHEMAS(sdd,tc));\n+        addUpgradeScript(3,1,0, 1938, new UpgradeScriptForTriggerWhenClause(sdd,tc));\n+        addUpgradeScript(3,1,0, 1940, new UpgradeScriptForReplicationSystemTables(sdd,tc));\n+        addUpgradeScript(3,1,0, 1941, new UpgradeScriptForTableColumnViewInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1948, new UpgradeScriptForAddDefaultToColumnViewInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1953, new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n+        addUpgradeScript(3,1,0, 1959, new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n+        addUpgradeScript(3,1,0, 1962, new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));\n+        addUpgradeScript(3,1,0, 1964, new UpgradeScriptForAliasToTableView(sdd,tc));\n+        addUpgradeScript(3,1,0, 1970, new UpgradeScriptForAddTablesAndViewsInSYSIBMADM(sdd,tc));\n+        addUpgradeScript(3,1,0, 1971, new UpgradeScriptToAddCatalogVersion(sdd,tc));\n+        addUpgradeScript(3,1,0, 1974, new UpgradeScriptToAddMinRetentionPeriodColumnToSYSTABLES(sdd, tc));\n+        addUpgradeScript(3,1,0, 1977, new UpgradeScriptToAddSysKeyColUseViewInSYSIBM(sdd, tc));\n+        addUpgradeScript(3,1,0, 1979, new UpgradeScriptToSetJavaClassNameColumnInSYSALIASES(sdd, tc));\n+        addUpgradeScript(3,2,0, 1983, new UpgradeScriptToAddBaseTableSchemaColumnsToSysTablesInSYSIBM(sdd,tc));\n+        addUpgradeScript(3,2,0, 1985, new UpgradeScriptToAddSysNaturalNumbersTable(sdd, tc));\n+        addUpgradeScript(3,2,0, 1989, new UpgradeScriptToAddIndexColUseViewInSYSCAT(sdd, tc));\n+        addUpgradeScript(3,2,0, 1990, new UpgradeScriptForTablePriorities(sdd, tc));\n+    }\n+\n+    public static List<VersionAndUpgrade> GetScriptsToUpgrade(List<VersionAndUpgrade> scripts,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE4ODIyNw==", "bodyText": "It'd be great to have more descriptive test names", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r547188227", "createdAt": "2020-12-22T10:12:14Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/utils/SpliceCatalogUpgradeScriptsTest.java", "diffHunk": "@@ -0,0 +1,110 @@\n+package com.splicemachine.derby.utils;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.derby.impl.sql.catalog.Splice_DD_Version;\n+import com.splicemachine.derby.impl.sql.catalog.upgrade.SpliceCatalogUpgradeScripts;\n+import com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScript;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class SpliceCatalogUpgradeScriptsTest {\n+    String s1 = \"3.1.0.1938: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTriggerWhenClause\\n\" +\n+            \"3.1.0.1940: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForReplicationSystemTables\\n\" +\n+            \"3.1.0.1941: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTableColumnViewInSYSIBM\\n\" +\n+            \"3.1.0.1948: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForAddDefaultToColumnViewInSYSIBM\\n\" +\n+            \"3.1.0.1953: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForRemoveUnusedIndexInSYSFILESTable\\n\" +\n+            \"3.1.0.1959: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTriggerMultipleStatements\\n\" +\n+            \"3.1.0.1962: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForAddDefaultToColumnViewInSYSVW\\n\" +\n+            \"3.1.0.1964: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForAliasToTableView\\n\" +\n+            \"3.1.0.1970: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForAddTablesAndViewsInSYSIBMADM\\n\" +\n+            \"3.1.0.1971: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddCatalogVersion\\n\" +\n+            \"3.1.0.1974: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddMinRetentionPeriodColumnToSYSTABLES\\n\" +\n+            \"3.1.0.1977: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddSysKeyColUseViewInSYSIBM\\n\" +\n+            \"3.1.0.1979: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToSetJavaClassNameColumnInSYSALIASES\\n\" +\n+            \"3.2.0.1983: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddBaseTableSchemaColumnsToSysTablesInSYSIBM\\n\" +\n+            \"3.2.0.1985: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddSysNaturalNumbersTable\\n\";\n+\n+    String s2 = \"3.2.0.1989: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptToAddIndexColUseViewInSYSCAT\\n\" +\n+            \"3.2.0.1990: com.splicemachine.derby.impl.sql.catalog.upgrade.UpgradeScriptForTablePriorities\\n\";\n+    // add more scripts here\n+\n+    @Test\n+    public void t1()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTY5Mjc3", "url": "https://github.com/splicemachine/spliceengine/pull/4896#pullrequestreview-556969277", "createdAt": "2020-12-22T10:17:14Z", "commit": {"oid": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMDoxNzoxNFrOIJ14jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxMDoxNzoxNFrOIJ14jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE5MDkyNQ==", "bodyText": "Instead of using a List and perform a linear search each time we want to perform an upgrade, I would keep the tree structure used before and replace it with something like Guava's MultiMap instead. To start iterating from version X you can lookup the key in log(N) : N #versions by doing multimap.keySet().ceiling(X)", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r547190925", "createdAt": "2020-12-22T10:17:14Z", "author": {"login": "hatyo"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -33,56 +30,81 @@\n     protected static final Logger LOG=Logger.getLogger(SpliceCatalogUpgradeScripts.class);\n \n     SpliceDataDictionary sdd;\n-    Splice_DD_Version catalogVersion;\n     TransactionController tc;\n-    TreeMap<Splice_DD_Version, UpgradeScript> scripts;\n-    Comparator<Splice_DD_Version> ddComparator;\n-    \n-    public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd,Splice_DD_Version catalogVersion,TransactionController tc){\n+\n+    List<VersionAndUpgrade> scripts;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/d80de21e0d5fc1f9d3ed5e119f2565e9b3436b7a", "committedDate": "2020-12-21T21:37:56Z", "message": "DB-11067 add tests for parts of SpliceCatalogUpgradeScripts"}, "afterCommit": {"oid": "6a028375093b261c33da358050b85371d032b50e", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/6a028375093b261c33da358050b85371d032b50e", "committedDate": "2021-01-05T22:25:34Z", "message": "DB-11067 address reviews"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a028375093b261c33da358050b85371d032b50e", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/6a028375093b261c33da358050b85371d032b50e", "committedDate": "2021-01-05T22:25:34Z", "message": "DB-11067 address reviews"}, "afterCommit": {"oid": "62d9168bd9b85c2f2621a45dd40953d2adcf73d7", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/62d9168bd9b85c2f2621a45dd40953d2adcf73d7", "committedDate": "2021-01-06T09:38:03Z", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d", "committedDate": "2021-01-07T10:17:47Z", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62d9168bd9b85c2f2621a45dd40953d2adcf73d7", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/62d9168bd9b85c2f2621a45dd40953d2adcf73d7", "committedDate": "2021-01-06T09:38:03Z", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version"}, "afterCommit": {"oid": "62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d", "committedDate": "2021-01-07T10:17:47Z", "message": "DB-11067 SpliceCatalogUpgradeScripts can run multiple scripts for one version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMzg0ODQy", "url": "https://github.com/splicemachine/spliceengine/pull/4896#pullrequestreview-563384842", "createdAt": "2021-01-07T10:43:10Z", "commit": {"oid": "62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMDo0MzoxMVrOIPnpWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxMDo0MzoxMVrOIPnpWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzI0OTExMg==", "bodyText": "Can you add two lines here explaining what the table means? It took me a while to understand", "url": "https://github.com/splicemachine/spliceengine/pull/4896#discussion_r553249112", "createdAt": "2021-01-07T10:43:11Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -33,79 +30,121 @@\n     protected static final Logger LOG=Logger.getLogger(SpliceCatalogUpgradeScripts.class);\n \n     SpliceDataDictionary sdd;\n-    Splice_DD_Version catalogVersion;\n     TransactionController tc;\n-    TreeMap<Splice_DD_Version, UpgradeScript> scripts;\n-    Comparator<Splice_DD_Version> ddComparator;\n-    \n-    public SpliceCatalogUpgradeScripts(SpliceDataDictionary sdd,Splice_DD_Version catalogVersion,TransactionController tc){\n+\n+    List<VersionAndUpgrade> scripts;\n+\n+    public static class VersionAndUpgrade {\n+        public Splice_DD_Version version;\n+        public UpgradeScript script;\n+\n+        public VersionAndUpgrade(Splice_DD_Version version,UpgradeScript script) {\n+            this.version = version;\n+            this.script = script;\n+        }\n+    }\n+\n+    public void addUpgradeScript(Splice_DD_Version version, int sprint, UpgradeScript script)\n+    {\n+        scripts.add(new VersionAndUpgrade(new Splice_DD_Version(sdd, version.getMajorVersionNumber(),\n+                version.getMinorVersionNumber(), version.getPatchVersionNumber(), sprint), script));\n+    }\n+\n+    // master / branch-3.0 / branch-3.1\n+    // baseVersion1 = 2.8.0 / 2.8.0 / 2.8.0\n+    // baseVersion2 = 3.1.0 / 3.1.0 / 3.0.0 // 3. fork\n+    // baseVersion3 = 3.1.0 / 3.1.0 / 3.0.1 // hickup on branch 3.0\n+    // baseVersion4 = 3.2.0 / 3.1.0 / 3.0.1 // 3.2 fork", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMzg4Nzgx", "url": "https://github.com/splicemachine/spliceengine/pull/4896#pullrequestreview-563388781", "createdAt": "2021-01-07T10:49:08Z", "commit": {"oid": "62e7e1a0b0e4a24e22ce3587a7732a6591c26a1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f96a670d00f341500633f866e8c311c61bedb61", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/8f96a670d00f341500633f866e8c311c61bedb61", "committedDate": "2021-01-07T12:13:57Z", "message": "DB-11067 address review comment (better comment about baseVersionX)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0MDM1NDE5", "url": "https://github.com/splicemachine/spliceengine/pull/4896#pullrequestreview-564035419", "createdAt": "2021-01-08T06:46:49Z", "commit": {"oid": "8f96a670d00f341500633f866e8c311c61bedb61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 989, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}