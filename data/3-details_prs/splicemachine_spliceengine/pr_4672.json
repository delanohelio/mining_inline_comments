{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1NDgyNzE3", "number": 4672, "title": "DB-10854 Fix txn leak in FROM FINAL TABLE.", "bodyText": "With autocommit off, the transaction stack would get pushed for every FROM FINAL TABLE statement, but never popped.\nThis is due to a missing needsSavepoint flag in the outermost prepared statement plus code from SPLICE-1625 that's no longer needed (trigger logic has added an extra transaction wrapping the statement since then) which caused the transaction to be elevated when the operation was closed (elevating it upon close causes it never to get popped).\nThe cleanup code in TriggerHandler was too convoluted and not kicking in, so it's been simplified.\nI also moved the ThreadLocals added by DB-10525 from DataDictionaryCache to TriggerReferencingStruct per DB-10738.", "createdAt": "2020-11-23T06:20:51Z", "url": "https://github.com/splicemachine/spliceengine/pull/4672", "merged": true, "mergeCommit": {"oid": "db81ea4ee285c24c5565cb6262f7ffa502dfa58d"}, "closed": true, "closedAt": "2020-11-24T16:57:36Z", "author": {"login": "msirek"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfOzebgH2gAyNTI1NDgyNzE3OjgzOWUyZjA3OTY0NjlkZjU5OTU5MWIwNDI4YzQ1YjM1OWNiY2FmMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfrBgXgFqTUzNzU3NDQ3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "839e2f0796469df599591b0428c45b359cbcaf21", "author": {"user": {"login": "msirek", "name": "Mark Sirek"}}, "url": "https://github.com/splicemachine/spliceengine/commit/839e2f0796469df599591b0428c45b359cbcaf21", "committedDate": "2020-11-23T06:03:47Z", "message": "DB-10854 Fix txn leak in FROM FINAL TABLE."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2Mjc2MzYx", "url": "https://github.com/splicemachine/spliceengine/pull/4672#pullrequestreview-536276361", "createdAt": "2020-11-23T09:04:30Z", "commit": {"oid": "839e2f0796469df599591b0428c45b359cbcaf21"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwOTowNDozMVrOH4EQ8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwOToxMDoyM1rOH4EdFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU1MjE3Ng==", "bodyText": "Can you rename BoundAndOptimizedStatement in all places to firstLowerCase?", "url": "https://github.com/splicemachine/spliceengine/pull/4672#discussion_r528552176", "createdAt": "2020-11-23T09:04:31Z", "author": {"login": "dgomezferro"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/GenericStatement.java", "diffHunk": "@@ -687,8 +685,14 @@ else if (newMergeJoinString.equals(\"forced\"))\n                 preparedStmt.compilingStatement=false;\n                 preparedStmt.notifyAll();\n             }\n-            DataDictionaryCache.fromTableTriggerDescriptor.remove();\n-            DataDictionaryCache.fromTableTriggerSPSDescriptor.remove();\n+            TriggerReferencingStruct.fromTableTriggerDescriptor.remove();\n+            TriggerReferencingStruct.fromTableTriggerSPSDescriptor.remove();\n+            // Communicate to the immediate parent statement if its child\n+            // contains a FROM TABLE clause.\n+            if (BoundAndOptimizedStatement != null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "839e2f0796469df599591b0428c45b359cbcaf21"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU1NDc3Nw==", "bodyText": "I think a try-with-resources would be better, in case we raise an exception for instance.", "url": "https://github.com/splicemachine/spliceengine/pull/4672#discussion_r528554777", "createdAt": "2020-11-23T09:09:28Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceWatcher.java", "diffHunk": "@@ -249,6 +249,7 @@ public ResultSet executeQuery(String sql, String userName, String password) thro\n         while (rs.next()) {\n             resultList.add((T) rs.getObject(1));\n         }\n+        rs.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "839e2f0796469df599591b0428c45b359cbcaf21"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU1NDgzMQ==", "bodyText": "Same", "url": "https://github.com/splicemachine/spliceengine/pull/4672#discussion_r528554831", "createdAt": "2020-11-23T09:09:33Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceWatcher.java", "diffHunk": "@@ -265,6 +266,7 @@ public ResultSet executeQuery(String sql, String userName, String password) thro\n             }\n             resultList.add(row);\n         }\n+        rs.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "839e2f0796469df599591b0428c45b359cbcaf21"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU1NTI4NA==", "bodyText": "Shouldn't this always be 0, since the test is Serial?", "url": "https://github.com/splicemachine/spliceengine/pull/4672#discussion_r528555284", "createdAt": "2020-11-23T09:10:23Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/test/java/com/splicemachine/db/impl/sql/compile/FromFinalTableIT.java", "diffHunk": "@@ -122,9 +127,16 @@ public static void createData(Connection conn, String schemaName) throws Excepti\n \n     @Before\n     public void createDataSet() throws Exception {\n+        runningOperations = getNumberOfRunningOperations();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "839e2f0796469df599591b0428c45b359cbcaf21"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2413b5ba131c899d873cdf09f6b7c07b443250d6", "author": {"user": {"login": "msirek", "name": "Mark Sirek"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2413b5ba131c899d873cdf09f6b7c07b443250d6", "committedDate": "2020-11-23T15:35:03Z", "message": "DB-10854 Address review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MzI2Nzgz", "url": "https://github.com/splicemachine/spliceengine/pull/4672#pullrequestreview-537326783", "createdAt": "2020-11-24T10:01:55Z", "commit": {"oid": "2413b5ba131c899d873cdf09f6b7c07b443250d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MzU2MzUy", "url": "https://github.com/splicemachine/spliceengine/pull/4672#pullrequestreview-537356352", "createdAt": "2020-11-24T10:34:49Z", "commit": {"oid": "2413b5ba131c899d873cdf09f6b7c07b443250d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MzY1MTI0", "url": "https://github.com/splicemachine/spliceengine/pull/4672#pullrequestreview-537365124", "createdAt": "2020-11-24T10:45:21Z", "commit": {"oid": "2413b5ba131c899d873cdf09f6b7c07b443250d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTc0NDc2", "url": "https://github.com/splicemachine/spliceengine/pull/4672#pullrequestreview-537574476", "createdAt": "2020-11-24T14:56:27Z", "commit": {"oid": "2413b5ba131c899d873cdf09f6b7c07b443250d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1017, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}