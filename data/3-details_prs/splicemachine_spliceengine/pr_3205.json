{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNjI0MjMx", "number": 3205, "title": "DB-9054: retrieve replication latency", "bodyText": "", "createdAt": "2020-02-05T22:49:17Z", "url": "https://github.com/splicemachine/spliceengine/pull/3205", "merged": true, "mergeCommit": {"oid": "869aaec9115d5a11019460ce69d4a81a0d0df79f"}, "closed": true, "closedAt": "2020-03-05T20:42:57Z", "author": {"login": "jyuanca"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBZ14QgH2gAyMzcxNjI0MjMxOmI4NzVjNTg3ZTkyMjY2OTUyNjM3NjRkYTMzOTk4ZDYxYzFhMDVlZGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKvUTDAFqTM2OTc4NjI1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b875c587e9226695263764da33998d61c1a05eda", "author": {"user": null}, "url": "https://github.com/splicemachine/spliceengine/commit/b875c587e9226695263764da33998d61c1a05eda", "committedDate": "2020-02-05T17:46:29Z", "message": "DB-9054: retrieve replication latency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzUyMjEz", "url": "https://github.com/splicemachine/spliceengine/pull/3205#pullrequestreview-362352213", "createdAt": "2020-02-21T01:38:39Z", "commit": {"oid": "b875c587e9226695263764da33998d61c1a05eda"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMTozODo0MFrOFspEqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMTo1NjoyM1rOFspWOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NDYwMw==", "bodyText": "typo in the result string, I guess it should be \"Information not available\".", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r382354603", "createdAt": "2020-02-21T01:38:40Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java", "diffHunk": "@@ -61,6 +62,19 @@\n \n     private static Logger LOG = Logger.getLogger(ReplicationSystemProcedure.class);\n \n+    public static void GET_REPLICATION_PROGRESS(ResultSet[] resultSets) throws StandardException, SQLException {\n+        ReplicationManager replicationManager = EngineDriver.driver().manager().getReplicationManager();\n+        long ts = replicationManager.getReplicationProgress();\n+        if (ts > 0) {\n+            DateTime dateTime = new DateTime(ts);\n+            resultSets[0] = ProcedureUtils.generateResult(\n+                    \"Replication progress\", dateTime.toString());\n+        }\n+        else {\n+            resultSets[0] = ProcedureUtils.generateResult(\"Error\", \"Information for available\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b875c587e9226695263764da33998d61c1a05eda"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1NDk0MQ==", "bodyText": "It seems that we assume only one replication slave cluster for this system procedure. Can this logic be extended in the future if we have  multiple slave clusters?", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r382354941", "createdAt": "2020-02-21T01:40:05Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/replication/ReplicationSystemProcedure.java", "diffHunk": "@@ -61,6 +62,19 @@\n \n     private static Logger LOG = Logger.getLogger(ReplicationSystemProcedure.class);\n \n+    public static void GET_REPLICATION_PROGRESS(ResultSet[] resultSets) throws StandardException, SQLException {\n+        ReplicationManager replicationManager = EngineDriver.driver().manager().getReplicationManager();\n+        long ts = replicationManager.getReplicationProgress();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b875c587e9226695263764da33998d61c1a05eda"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM1OTA5OQ==", "bodyText": "The call to CellUtil.cloneQualifier(cell) here seems redundant, should we just use colName?", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r382359099", "createdAt": "2020-02-21T01:56:23Z", "author": {"login": "yxia92"}, "path": "hbase_sql/src/main/java/com/splicemachine/hbase/SpliceReplicationSinkChore.java", "diffHunk": "@@ -260,19 +264,29 @@ private void updateProgress() throws IOException, KeeperException, InterruptedEx\n                     SpliceLogUtils.info(LOG, \"Checking snapshot taken at %d\", timestamp);\n                 //}\n                 CellScanner s = r.cellScanner();\n+                long ts = -1;\n                 while (s.advance()) {\n                     Cell cell = s.current();\n-                    String walName = Bytes.toString(CellUtil.cloneQualifier(cell));\n-                    Long position = Bytes.toLong(CellUtil.cloneValue(cell));\n-                    if (replicationProgress.containsKey(walName)) {\n-                        long appliedPosition = replicationProgress.get(walName);\n+                    byte[] colName = CellUtil.cloneQualifier(cell);\n+                    if(Arrays.equals(colName, HBaseConfiguration.REPLICATION_SNAPSHOT_TSCOL_BYTES)){\n+                        ts = Bytes.toLong(CellUtil.cloneValue(cell));\n                         //if (LOG.isDebugEnabled()) {\n+                        SpliceLogUtils.info(LOG, \"Process snapshot take at %s\", new DateTime(ts).toString());\n+                        //}\n+                    }\n+                    else {\n+                        String walName = Bytes.toString(CellUtil.cloneQualifier(cell));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b875c587e9226695263764da33998d61c1a05eda"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ee40083254205c30678165acdff3ac02d878d6c", "author": {"user": null}, "url": "https://github.com/splicemachine/spliceengine/commit/0ee40083254205c30678165acdff3ac02d878d6c", "committedDate": "2020-02-21T05:14:29Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNDAzNjAw", "url": "https://github.com/splicemachine/spliceengine/pull/3205#pullrequestreview-362403600", "createdAt": "2020-02-21T05:15:58Z", "commit": {"oid": "0ee40083254205c30678165acdff3ac02d878d6c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MjEwOTg2", "url": "https://github.com/splicemachine/spliceengine/pull/3205#pullrequestreview-367210986", "createdAt": "2020-03-02T13:50:39Z", "commit": {"oid": "0ee40083254205c30678165acdff3ac02d878d6c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMzo1MDo0MFrOFwgJzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMzo1MDo0MFrOFwgJzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMjc2NA==", "bodyText": "Why is that necessary?", "url": "https://github.com/splicemachine/spliceengine/pull/3205#discussion_r386402764", "createdAt": "2020-03-02T13:50:40Z", "author": {"login": "arnaud-splice"}, "path": "platform_it/src/test/java/com/splicemachine/test/SpliceTestPlatformConfig.java", "diffHunk": "@@ -321,8 +321,8 @@ public static Configuration create(String hbaseRootDirUri,\n         // Replication\n         //\n         config.setBoolean(\"replication.source.eof.autorecovery\", true);\n-        config.set(\"hbase.replication.source.service\", \"com.splicemachine.replication.SpliceReplication\");\n-        config.set(\"hbase.replication.sink.service\", \"com.splicemachine.replication.SpliceReplication\");\n+        //config.set(\"hbase.replication.source.service\", \"com.splicemachine.replication.SpliceReplication\");\n+        //config.set(\"hbase.replication.sink.service\", \"com.splicemachine.replication.SpliceReplication\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ee40083254205c30678165acdff3ac02d878d6c"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5Nzg2MjUy", "url": "https://github.com/splicemachine/spliceengine/pull/3205#pullrequestreview-369786252", "createdAt": "2020-03-05T17:53:02Z", "commit": {"oid": "0ee40083254205c30678165acdff3ac02d878d6c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 967, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}