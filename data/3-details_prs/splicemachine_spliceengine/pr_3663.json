{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNDIwMDM3", "number": 3663, "title": "DB-9615 Add file logging to SQL shell.", "bodyText": "Add commands logto, logstop, and logclear which give the user\nthe possibility to log SQL statements to a local file.\nlogto requires quoting the file path, i.e. logto '/tmp/log.txt'\n\nThis is still WIP, but I still wanted to take your input on this change, specially the way I extended the ij parser rules for the new logging commands.", "createdAt": "2020-06-08T22:01:37Z", "url": "https://github.com/splicemachine/spliceengine/pull/3663", "merged": true, "mergeCommit": {"oid": "af65a796159195d85b64bc2cc0d4c517a1c20bea"}, "closed": true, "closedAt": "2020-07-15T23:22:21Z", "author": {"login": "hatyo"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpnLOSAFqTQyNzMwOTUyMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0ZtLXgFqTQ0Njk3MzU2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MzA5NTIw", "url": "https://github.com/splicemachine/spliceengine/pull/3663#pullrequestreview-427309520", "createdAt": "2020-06-09T15:55:32Z", "commit": {"oid": "7f1bb0f9f9fc865b35ac94203749b3abe811ef53"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1700fb2dbf30a73b179fa5f6262ff6ce94bdd4bd", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/1700fb2dbf30a73b179fa5f6262ff6ce94bdd4bd", "committedDate": "2020-06-26T13:47:45Z", "message": "Add file logging to SQL shell.\n\n- Add commands spool <filename>, spool stop, and spool clear which\n  give the user the ability to log SQL statements to a local file.\n- spool <path> requires quoting the file path, i.e. spool '/tmp/log.txt'"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f1bb0f9f9fc865b35ac94203749b3abe811ef53", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/7f1bb0f9f9fc865b35ac94203749b3abe811ef53", "committedDate": "2020-06-08T21:55:43Z", "message": "Add file logging to SQL shell.\n\n- Add commands logto, logstop, and logclear which give the user\n  the possibility to log SQL statements to a local file.\n- logto requires quoting the file path, i.e. logto '/tmp/log.txt'"}, "afterCommit": {"oid": "1700fb2dbf30a73b179fa5f6262ff6ce94bdd4bd", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/1700fb2dbf30a73b179fa5f6262ff6ce94bdd4bd", "committedDate": "2020-06-26T13:47:45Z", "message": "Add file logging to SQL shell.\n\n- Add commands spool <filename>, spool stop, and spool clear which\n  give the user the ability to log SQL statements to a local file.\n- spool <path> requires quoting the file path, i.e. spool '/tmp/log.txt'"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "893e572e4b3fb9b1526cb5cddafc65eae3351c0a", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/893e572e4b3fb9b1526cb5cddafc65eae3351c0a", "committedDate": "2020-06-26T17:28:33Z", "message": "Fix SpotBugs issues."}, "afterCommit": {"oid": "1a0c4020d39fcd5c9886e4d3fcdee627082cdcd6", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/1a0c4020d39fcd5c9886e4d3fcdee627082cdcd6", "committedDate": "2020-06-29T16:20:39Z", "message": "Fix SpotBugs issues."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a0c4020d39fcd5c9886e4d3fcdee627082cdcd6", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/1a0c4020d39fcd5c9886e4d3fcdee627082cdcd6", "committedDate": "2020-06-29T16:20:39Z", "message": "Fix SpotBugs issues."}, "afterCommit": {"oid": "715199745c7e544031541daa25e0669469d3008b", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/715199745c7e544031541daa25e0669469d3008b", "committedDate": "2020-06-29T22:01:28Z", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "715199745c7e544031541daa25e0669469d3008b", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/715199745c7e544031541daa25e0669469d3008b", "committedDate": "2020-06-29T22:01:28Z", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug."}, "afterCommit": {"oid": "885c33d3e07aa5c5296d82f0298b842d0f271d84", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/885c33d3e07aa5c5296d82f0298b842d0f271d84", "committedDate": "2020-06-30T12:38:16Z", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5OTgwNzEx", "url": "https://github.com/splicemachine/spliceengine/pull/3663#pullrequestreview-439980711", "createdAt": "2020-06-30T12:51:43Z", "commit": {"oid": "885c33d3e07aa5c5296d82f0298b842d0f271d84"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjo1MTo0M1rOGq605w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjo1NjoxOFrOGq6_wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1NzE5MQ==", "bodyText": "You could use try with resource for both zf and bis to make this cleaner.", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r447657191", "createdAt": "2020-06-30T12:51:43Z", "author": {"login": "arnaud-splice"}, "path": "db-drda/src/main/java/com/splicemachine/db/impl/tools/sysinfo/Main.java", "diffHunk": "@@ -1035,43 +1022,61 @@ private static ZipInfoProperties checkDirectory(String dirname)\n     private static ZipInfoProperties checkFile(String filename)\n     {\n         // try to create a ZipFile from it\n+        InputStream bis = null;\n+        ZipFile zf = null;\n         try\n         {\n-            ZipFile zf = new ZipFile(filename);\n+            zf = new ZipFile(filename);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "885c33d3e07aa5c5296d82f0298b842d0f271d84"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1ODYzMA==", "bodyText": "Why is this necessary?", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r447658630", "createdAt": "2020-06-30T12:54:09Z", "author": {"login": "arnaud-splice"}, "path": "db-tools-ij/src/main/grammar/ij.jj", "diffHunk": "@@ -3374,6 +3378,7 @@ HelpStatement() :\n \t\twhile (st.hasMoreTokens()) {\n \t\t    v.addElement(st.nextToken());\n \t\t}\n+\t\tv.addElement(\"Something\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "885c33d3e07aa5c5296d82f0298b842d0f271d84"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY1OTk2OQ==", "bodyText": "You don't need lookaheads in the next functions if you have one function that consumes SPOOL in which you have the three alternatives that call their respective functions.", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r447659969", "createdAt": "2020-06-30T12:56:18Z", "author": {"login": "arnaud-splice"}, "path": "db-tools-ij/src/main/grammar/ij.jj", "diffHunk": "@@ -4043,7 +4061,42 @@ ijResult CP_DisconnectStatement() throws SQLException\n \n }\n \n+ijResult LogToStatement() throws IOException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "885c33d3e07aa5c5296d82f0298b842d0f271d84"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca3670857c0de63ddbd0a9ef99659d62d6ec4476", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/ca3670857c0de63ddbd0a9ef99659d62d6ec4476", "committedDate": "2020-07-06T13:10:42Z", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug.\n- address comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "885c33d3e07aa5c5296d82f0298b842d0f271d84", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/885c33d3e07aa5c5296d82f0298b842d0f271d84", "committedDate": "2020-06-30T12:38:16Z", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug."}, "afterCommit": {"oid": "ca3670857c0de63ddbd0a9ef99659d62d6ec4476", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/ca3670857c0de63ddbd0a9ef99659d62d6ec4476", "committedDate": "2020-07-06T13:10:42Z", "message": "Fix Spotbug issues.\n\n- add generated code the exclusion list of spotbug.\n- address comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da34950a266bfe071cd31a7adf905bedd3b66892", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/da34950a266bfe071cd31a7adf905bedd3b66892", "committedDate": "2020-07-06T13:12:34Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9615"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMDY1NTg5", "url": "https://github.com/splicemachine/spliceengine/pull/3663#pullrequestreview-443065589", "createdAt": "2020-07-06T13:17:39Z", "commit": {"oid": "da34950a266bfe071cd31a7adf905bedd3b66892"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzoxNzo0MFrOGtW1ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMzoxNzo0MFrOGtW1ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDIxMzI1OA==", "bodyText": "You don't need this zf.close anymore", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r450213258", "createdAt": "2020-07-06T13:17:40Z", "author": {"login": "arnaud-splice"}, "path": "db-drda/src/main/java/com/splicemachine/db/impl/tools/sysinfo/Main.java", "diffHunk": "@@ -1027,52 +1014,42 @@ private static ZipInfoProperties checkDirectory(String dirname)\n     /**\n      * Check inside a jar file for the presence of a Derby info properties file.\n      * \n-     * @param filename\n-     *            the jar file to check\n+     * @param filename the jar file to check\n      * @return ZipInfoProperties with the jar file set as the location or null\n-     *         if not found.\n+     *  if not found, or an IOException occurs.\n      */\n     private static ZipInfoProperties checkFile(String filename)\n     {\n-        // try to create a ZipFile from it\n-        try\n+        // try to create a ZipFile from the file name\n+        try(ZipFile zf = new ZipFile(filename))\n         {\n-            ZipFile zf = new ZipFile(filename);\n             // try to get a ZipEntry from the ZipFile\n-\n             ZipEntry thisEntry = null;\n-\n-            for (int i =0; i < infoNames.length; i++)\n-            {\n-                thisEntry = zf.getEntry(infoNames[i]);\n-                if (thisEntry != null)\n-                {\n+            for (String infoName : infoNames) {\n+                thisEntry = zf.getEntry(infoName);\n+                if (thisEntry != null) {\n                     break;\n                 }\n             }\n-\n             if (thisEntry == null)\n             {\n+                zf.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da34950a266bfe071cd31a7adf905bedd3b66892"}, "originalPosition": 140}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMTE1MzAz", "url": "https://github.com/splicemachine/spliceengine/pull/3663#pullrequestreview-443115303", "createdAt": "2020-07-06T14:14:54Z", "commit": {"oid": "e9e36db94ddb2babd36fa6f375ee4390995b17cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb2907da9ee0c66877ef505a24673cd9e90311b8", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/bb2907da9ee0c66877ef505a24673cd9e90311b8", "committedDate": "2020-07-06T14:18:56Z", "message": "Address further comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9e36db94ddb2babd36fa6f375ee4390995b17cc", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/e9e36db94ddb2babd36fa6f375ee4390995b17cc", "committedDate": "2020-07-06T14:04:28Z", "message": "Address further comments."}, "afterCommit": {"oid": "bb2907da9ee0c66877ef505a24673cd9e90311b8", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/bb2907da9ee0c66877ef505a24673cd9e90311b8", "committedDate": "2020-07-06T14:18:56Z", "message": "Address further comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDYzMjI3", "url": "https://github.com/splicemachine/spliceengine/pull/3663#pullrequestreview-445063227", "createdAt": "2020-07-08T19:23:41Z", "commit": {"oid": "bb2907da9ee0c66877ef505a24673cd9e90311b8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxOToyMzo0MVrOGu2G6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxOToyNjoyMlrOGu2MXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3NDE4NQ==", "bodyText": "We should close the FileOutputStream, relying on finalizers is very finicky", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r451774185", "createdAt": "2020-07-08T19:23:41Z", "author": {"login": "dgomezferro"}, "path": "db-tools-ij/src/main/java/com/splicemachine/db/impl/tools/ij/utilMain.java", "diffHunk": "@@ -845,4 +820,26 @@ int getCurrentRowNumber(ResultSet rs)\n \tpublic final Object run() {\n \t\treturn  getClass().getResourceAsStream(ProductGenusNames.TOOLS_INFO);\n \t}\n+\t@SuppressFBWarnings(value = \"RV_RETURN_VALUE_IGNORED_BAD_PRACTICE\",justification = \"Intentional, we don't care if the file already exists\")\n+\tpublic void startSpooling(String path) throws IOException {\n+\t\tdoSpool = true;\n+\t\tlogFileName = path;\n+\t\tFile f = new File(logFileName);\n+\t\tf.createNewFile(); // no-op if file exists.\n+\t\tthis.out = new LocalizedOutput(new ForkOutputStream(new FileOutputStream(f)));\n+\t}\n+\n+\tpublic void stopSpooling() {\n+\t\tdoSpool = false;\n+\t\tthis.out.flush();\n+\t\tthis.out = new LocalizedOutput(System.out);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb2907da9ee0c66877ef505a24673cd9e90311b8"}, "originalPosition": 194}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTc3NTU4Mw==", "bodyText": "Does this echo the commands to the terminal too? Is that what we want?", "url": "https://github.com/splicemachine/spliceengine/pull/3663#discussion_r451775583", "createdAt": "2020-07-08T19:26:22Z", "author": {"login": "dgomezferro"}, "path": "db-tools-ij/src/main/java/com/splicemachine/db/impl/tools/ij/utilMain.java", "diffHunk": "@@ -320,6 +295,11 @@ private int runScriptGuts() {\n \t\t\t\tout.flush();\n \t\t\t\tcommand = commandGrabber[currCE].nextStatement();\n \n+\t\t\t\tif(doSpool) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb2907da9ee0c66877ef505a24673cd9e90311b8"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4fbe29b299c6d6e36c14d20e8aa25d1282becfb", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/e4fbe29b299c6d6e36c14d20e8aa25d1282becfb", "committedDate": "2020-07-09T16:05:37Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9615"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "461510e9a6f95fee3f86dcb7dfb9acaeedc8ee7b", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/461510e9a6f95fee3f86dcb7dfb9acaeedc8ee7b", "committedDate": "2020-07-09T16:33:09Z", "message": "Address further comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a32754731d77606963f2e4c79ee0aeac97e4e578", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/a32754731d77606963f2e4c79ee0aeac97e4e578", "committedDate": "2020-07-10T12:21:18Z", "message": "Address Daniel's comment about writing twice to std out."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ccf4be3eb095222f98897f1e7f56547479bf920", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2ccf4be3eb095222f98897f1e7f56547479bf920", "committedDate": "2020-07-10T12:21:50Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9615"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MzYwMTg4", "url": "https://github.com/splicemachine/spliceengine/pull/3663#pullrequestreview-446360188", "createdAt": "2020-07-10T12:28:23Z", "commit": {"oid": "2ccf4be3eb095222f98897f1e7f56547479bf920"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bee802718a2528227168fcb9ece5c58d5397430b", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/bee802718a2528227168fcb9ece5c58d5397430b", "committedDate": "2020-07-10T12:58:23Z", "message": "Address SpotBug issue."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTczNTY4", "url": "https://github.com/splicemachine/spliceengine/pull/3663#pullrequestreview-446973568", "createdAt": "2020-07-13T04:27:07Z", "commit": {"oid": "bee802718a2528227168fcb9ece5c58d5397430b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1315, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}