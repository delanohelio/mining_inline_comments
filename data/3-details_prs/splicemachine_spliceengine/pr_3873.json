{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MjE2NzM2", "number": 3873, "title": "DB-9579 Fix broadcast decision in cross joins", "bodyText": "", "createdAt": "2020-07-22T16:11:26Z", "url": "https://github.com/splicemachine/spliceengine/pull/3873", "merged": true, "mergeCommit": {"oid": "c18ab15dacce1438e517a4786f26db7f0440d89f"}, "closed": true, "closedAt": "2020-08-06T15:15:04Z", "author": {"login": "ascend1"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3kGdIgFqTQ1Mzc0NDgwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8JFlZgFqTQ2MjE5OTk5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzQ0ODAw", "url": "https://github.com/splicemachine/spliceengine/pull/3873#pullrequestreview-453744800", "createdAt": "2020-07-22T23:08:18Z", "commit": {"oid": "673b6d93b937410a958579dae5226e9775b5218f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMzowODoxOVrOG13Rqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwMDoxNToyN1rOG14e8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTEzMzM1NQ==", "bodyText": "This line is not needed.", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459133355", "createdAt": "2020-07-22T23:08:19Z", "author": {"login": "yxia92"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/JoinNode.java", "diffHunk": "@@ -2005,6 +2005,15 @@ private int getJoinArguments(ActivationClassBuilder acb,\n         // Is the right from SSQ\n         mb.push(rightResultSet.getFromSSQ());\n \n+        if (isCrossJoin()) {\n+            assert rightResultSet instanceof Optimizable;\n+            Optimizable rightOpt = (Optimizable)rightResultSet;\n+            boolean broadcastRightSide = rightOpt.getTrulyTheBestAccessPath().getJoinStrategy().getBroadcastRight();\n+            acb.addItem(broadcastRightSide);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "673b6d93b937410a958579dae5226e9775b5218f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE0Mzg4Nw==", "bodyText": "Since the existing check in CrossJoinOperation does not check the heapsize, to minimize the impact on execution plans, I would leave out this check for now. We can put back in if we have the corresponding cross join hint enhanced.", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459143887", "createdAt": "2020-07-22T23:42:05Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/compile/CrossJoinStrategy.java", "diffHunk": "@@ -231,6 +232,13 @@ public void estimateCost(Optimizable innerTable,\n \n         // Only use cross join when it is inner join and run on Spark\n         innerCost.setBase(innerCost.cloneMe());\n+        double estimatedMemoryMB = innerCost.getEstimatedHeapSize()/1024d/1024d;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "673b6d93b937410a958579dae5226e9775b5218f"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE1MzEzOQ==", "bodyText": "Could you also add a check for static explain whether the table BIG is the picked as the left table of the cross join? Thanks!", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459153139", "createdAt": "2020-07-23T00:15:27Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/SparkExplainIT.java", "diffHunk": "@@ -805,11 +805,26 @@ public void testCrossJoinBroadcastRight() throws Exception {\n     }\n \n     @Test\n-    public void testCrossJoinBroadcastLeft() throws Exception {\n+    public void testCrossJoinNeverBroadcastLeft() throws Exception {\n+        /* DB-9579\n+         * In case of a cross join, we only check if the right side can be broadcast and never broadcast the left\n+         * side. Reason is that when the plan reaches Spark and it doesn't have a sort node, it might be the case\n+         * that there are sort keys but the sort node is optimized away because the left side row order satisfies\n+         * the sort keys. If we broadcast the left side, resulting row order might be different.\n+         */\n         if (useSpark.equalsIgnoreCase(\"false\")) return; // cross join only has Spark implementation\n         String sqlText = \"sparkexplain select count(*) from --splice-properties joinOrder=fixed\\n\" +\n                 \"        big --splice-properties useSpark=true, joinStrategy=cross\\n\" +\n                 \"        inner join t1 on 1=1\";\n-        testQueryContains(sqlText, \"BroadcastNestedLoopJoin BuildLeft, Cross\", methodWatcher, true);\n+        testQueryContains(sqlText, \"CartesianProduct\", methodWatcher, true);\n+    }\n+\n+    @Test\n+    public void testCrossJoinBroadcastRightNoHint() throws Exception {\n+        if (useSpark.equalsIgnoreCase(\"false\")) return; // cross join only has Spark implementation\n+        String sqlText = \"sparkexplain select count(*) from\\n\" +\n+                \"        t1 --splice-properties useSpark=true\\n\" +\n+                \"        inner join big on 1=1\";\n+        testQueryContains(sqlText, \"BroadcastNestedLoopJoin BuildRight, Cross\", methodWatcher, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "673b6d93b937410a958579dae5226e9775b5218f"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "673b6d93b937410a958579dae5226e9775b5218f", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/673b6d93b937410a958579dae5226e9775b5218f", "committedDate": "2020-07-22T15:43:32Z", "message": "DB-9579 Fix broadcast decision in cross joins"}, "afterCommit": {"oid": "2ce935b66293736b19d74c4ccf3415f7e64d016e", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2ce935b66293736b19d74c4ccf3415f7e64d016e", "committedDate": "2020-07-23T12:01:43Z", "message": "DB-9579 Fix broadcast decision in cross joins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzkwNDgy", "url": "https://github.com/splicemachine/spliceengine/pull/3873#pullrequestreview-454390482", "createdAt": "2020-07-23T18:27:01Z", "commit": {"oid": "2ce935b66293736b19d74c4ccf3415f7e64d016e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODoyNzowMVrOG2WhFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxODoyNzowMVrOG2WhFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0NTIwNg==", "bodyText": "I just realize that we share the same CrossJoinStrategy for all cross joins in the same query, so set the braodcastInner flag in one cross join will be applied to all cross joins in the query, which is not right.", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459645206", "createdAt": "2020-07-23T18:27:01Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/compile/CrossJoinStrategy.java", "diffHunk": "@@ -231,6 +232,11 @@ public void estimateCost(Optimizable innerTable,\n \n         // Only use cross join when it is inner join and run on Spark\n         innerCost.setBase(innerCost.cloneMe());\n+        double estimatedRowCount = innerCost.getEstimatedRowCount();\n+        SConfiguration configuration=EngineDriver.driver().getConfiguration();\n+        long rowCountThreshold = configuration.getBroadcastRegionRowThreshold();\n+        broadcastInner = estimatedRowCount < rowCountThreshold;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ce935b66293736b19d74c4ccf3415f7e64d016e"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ce935b66293736b19d74c4ccf3415f7e64d016e", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2ce935b66293736b19d74c4ccf3415f7e64d016e", "committedDate": "2020-07-23T12:01:43Z", "message": "DB-9579 Fix broadcast decision in cross joins"}, "afterCommit": {"oid": "4b5ec0996be764ec88cafa8d97c6411b36008ab5", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/4b5ec0996be764ec88cafa8d97c6411b36008ab5", "committedDate": "2020-07-23T21:34:58Z", "message": "DB-9579 Fix broadcast decision in cross joins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NjQzNTcw", "url": "https://github.com/splicemachine/spliceengine/pull/3873#pullrequestreview-454643570", "createdAt": "2020-07-24T05:37:47Z", "commit": {"oid": "4b5ec0996be764ec88cafa8d97c6411b36008ab5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNTozNzo0OFrOG2jpFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNTozNzo0OFrOG2jpFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MDI0Ng==", "bodyText": "@ascend1 Can you check further why we pick cross join over broadcast join? With equality join condition, we should pick pick broadcast join instead of cross join. Thanks!", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r459860246", "createdAt": "2020-07-24T05:37:48Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/joins/CrossJoinIT.java", "diffHunk": "@@ -328,7 +328,8 @@ public void testPickBroadcastEquality() throws Exception {\n                 format(\"explain select count(*) from %s as a inner join %s as b \" +\n                         \"--SPLICE-PROPERTIES useSpark=%s \\n\" +\n                         \" on a.a1 = b.a1\" , s1, s1, useSpark);\n-        rowContainsQuery(6, sqlText,\"Broadcast\", classWatcher);\n+        String expected = useSpark ? \"CrossJoin\" : \"Broadcast\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b5ec0996be764ec88cafa8d97c6411b36008ab5"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b5ec0996be764ec88cafa8d97c6411b36008ab5", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/4b5ec0996be764ec88cafa8d97c6411b36008ab5", "committedDate": "2020-07-23T21:34:58Z", "message": "DB-9579 Fix broadcast decision in cross joins"}, "afterCommit": {"oid": "568528eadf071583552b76aa2426044ca9df9cb0", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/568528eadf071583552b76aa2426044ca9df9cb0", "committedDate": "2020-07-24T08:50:13Z", "message": "DB-9579 Fix broadcast decision in cross joins"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "568528eadf071583552b76aa2426044ca9df9cb0", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/568528eadf071583552b76aa2426044ca9df9cb0", "committedDate": "2020-07-24T08:50:13Z", "message": "DB-9579 Fix broadcast decision in cross joins"}, "afterCommit": {"oid": "fc3e80a52d53224ee8be10e2d47c3afca30f52b7", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/fc3e80a52d53224ee8be10e2d47c3afca30f52b7", "committedDate": "2020-07-24T09:05:00Z", "message": "DB-9579 Fix broadcast decision in cross joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a014d560b86c1c329e24ce291a1ae6b1b65f636f", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/a014d560b86c1c329e24ce291a1ae6b1b65f636f", "committedDate": "2020-07-24T17:25:56Z", "message": "DB-9579 Fix broadcast decision in cross joins"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc3e80a52d53224ee8be10e2d47c3afca30f52b7", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/fc3e80a52d53224ee8be10e2d47c3afca30f52b7", "committedDate": "2020-07-24T09:05:00Z", "message": "DB-9579 Fix broadcast decision in cross joins"}, "afterCommit": {"oid": "a014d560b86c1c329e24ce291a1ae6b1b65f636f", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/a014d560b86c1c329e24ce291a1ae6b1b65f636f", "committedDate": "2020-07-24T17:25:56Z", "message": "DB-9579 Fix broadcast decision in cross joins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1OTI3ODM5", "url": "https://github.com/splicemachine/spliceengine/pull/3873#pullrequestreview-455927839", "createdAt": "2020-07-27T16:09:27Z", "commit": {"oid": "a014d560b86c1c329e24ce291a1ae6b1b65f636f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNzQxNzQx", "url": "https://github.com/splicemachine/spliceengine/pull/3873#pullrequestreview-460741741", "createdAt": "2020-08-04T11:53:50Z", "commit": {"oid": "a014d560b86c1c329e24ce291a1ae6b1b65f636f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMTo1Mzo1MFrOG7dCrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMTo1NDowN1rOG7dDVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5NDk4OA==", "bodyText": "use try-with-resources here to auto close the resultset", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r464994988", "createdAt": "2020-08-04T11:53:50Z", "author": {"login": "arnaud-splice"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/joins/CrossJoinIT.java", "diffHunk": "@@ -713,5 +713,42 @@ public void testCharTimestampColumnsCrossJoin() throws Exception {\n         rs.close();\n     }\n \n+    @Test\n+    public void testCrossJoinPreserveSortOrderNoJoinStrategyHint() throws Exception {\n+        String sqlText = format(\"select tt2.a from \\n\" +\n+                \"tab2 tt2 --splice-properties useSpark=%s\\n\" +\n+                \"inner join %s ttb\\n\" +\n+                \"on ttb.c2 < 5 and tt2.a < 4 order by tt2.a\", useSpark, bigTable);\n+\n+        if (useSpark) {\n+            ResultSet rs = classWatcher.executeQuery(\"explain \" + sqlText);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a014d560b86c1c329e24ce291a1ae6b1b65f636f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDk5NTE1Ng==", "bodyText": "same", "url": "https://github.com/splicemachine/spliceengine/pull/3873#discussion_r464995156", "createdAt": "2020-08-04T11:54:07Z", "author": {"login": "arnaud-splice"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/joins/CrossJoinIT.java", "diffHunk": "@@ -713,5 +713,42 @@ public void testCharTimestampColumnsCrossJoin() throws Exception {\n         rs.close();\n     }\n \n+    @Test\n+    public void testCrossJoinPreserveSortOrderNoJoinStrategyHint() throws Exception {\n+        String sqlText = format(\"select tt2.a from \\n\" +\n+                \"tab2 tt2 --splice-properties useSpark=%s\\n\" +\n+                \"inner join %s ttb\\n\" +\n+                \"on ttb.c2 < 5 and tt2.a < 4 order by tt2.a\", useSpark, bigTable);\n+\n+        if (useSpark) {\n+            ResultSet rs = classWatcher.executeQuery(\"explain \" + sqlText);\n+            String matchString = TestUtils.FormattedResult.ResultFactory.toStringUnsorted(rs);\n+            assertTrue(\"Cross join is not selected for OLAP\", matchString.contains(\"CrossJoin\"));\n+        }\n \n+        /* DB-9579\n+         * The plan of the query above may or may not have an OrderBy. It depends on optimizer\n+         * implementation and that could change over time. However, correctness should always\n+         * be guaranteed and result must be the same for both OLTP and OLAP.\n+         */\n+        String expected = \"A |\\n\" +\n+                \"----\\n\" +\n+                \" 1 |\\n\" +\n+                \" 1 |\\n\" +\n+                \" 1 |\\n\" +\n+                \" 1 |\\n\" +\n+                \" 2 |\\n\" +\n+                \" 2 |\\n\" +\n+                \" 2 |\\n\" +\n+                \" 2 |\\n\" +\n+                \" 3 |\\n\" +\n+                \" 3 |\\n\" +\n+                \" 3 |\\n\" +\n+                \" 3 |\";\n+\n+        ResultSet rs = classWatcher.executeQuery(sqlText);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a014d560b86c1c329e24ce291a1ae6b1b65f636f"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2abae8b4b1435ed1b6cb7a2cfcaa311d0ba0fb31", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2abae8b4b1435ed1b6cb7a2cfcaa311d0ba0fb31", "committedDate": "2020-08-04T11:59:40Z", "message": "DB-9579 Auto close ResultSet in tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxODcxNjMx", "url": "https://github.com/splicemachine/spliceengine/pull/3873#pullrequestreview-461871631", "createdAt": "2020-08-05T17:21:47Z", "commit": {"oid": "2abae8b4b1435ed1b6cb7a2cfcaa311d0ba0fb31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTk5OTk5", "url": "https://github.com/splicemachine/spliceengine/pull/3873#pullrequestreview-462199999", "createdAt": "2020-08-06T05:36:47Z", "commit": {"oid": "2abae8b4b1435ed1b6cb7a2cfcaa311d0ba0fb31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1264, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}