{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MDc0MzE0", "number": 3702, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNDoyNTozMlrOEHmEkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMzowOTo1MlrOELPuYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2Mzk5MjUwOnYy", "diffSide": "RIGHT", "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/SICompactionStateMutate.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNDoyNTozMlrOGnDCKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMjozOTo1NVrOGnnQeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NzM1NA==", "bodyText": "Here we are considering the begin timestamp of the transaction that wrote the data, but we need to consider the commit timestamp instead (there's the same problem with deletes too, https://splicemachine.atlassian.net/browse/DB-9640 )\nConsider the lowWaterMark is 1000 (and there is a transaction with timestamp 1000)\nIf we are processing an update with timestamp = 900 and commit timestamp 1200, we are adding it to the map. Then we remove the baseline insert @ ts 100.\nWhen the lowWatermark transaction @ 1000 goes to read, there's no baseline anymore and the row is gone.\nI think the race condition is pretty hard to hit but better to get it fixed.", "url": "https://github.com/splicemachine/spliceengine/pull/3702#discussion_r443597354", "createdAt": "2020-06-22T14:25:32Z", "author": {"login": "dgomezferro"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/SICompactionStateMutate.java", "diffHunk": "@@ -116,6 +120,27 @@ private void mutate(Cell element, TxnView txn) throws IOException {\n                     assert deleteRightAfterFirstWriteTimestamp == 0;\n                     deleteRightAfterFirstWriteTimestamp = element.getTimestamp();\n                     break;\n+                case USER_DATA: {\n+                    long t = element.getTimestamp();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0fa6eeb1448b78247ccd82cfebf18ddae1e2cf2"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDE5MDg0Mg==", "bodyText": "Very good point.\nI created separate PRs for DB-9640 against 2.8/3.0/master that address the deleted rows issue.\nI also updated this (DB-8781) to include the fix and extend it to updates.", "url": "https://github.com/splicemachine/spliceengine/pull/3702#discussion_r444190842", "createdAt": "2020-06-23T12:39:55Z", "author": {"login": "arnaud-splice"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/SICompactionStateMutate.java", "diffHunk": "@@ -116,6 +120,27 @@ private void mutate(Cell element, TxnView txn) throws IOException {\n                     assert deleteRightAfterFirstWriteTimestamp == 0;\n                     deleteRightAfterFirstWriteTimestamp = element.getTimestamp();\n                     break;\n+                case USER_DATA: {\n+                    long t = element.getTimestamp();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU5NzM1NA=="}, "originalCommit": {"oid": "a0fa6eeb1448b78247ccd82cfebf18ddae1e2cf2"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMjIyODU3OnYy", "diffSide": "RIGHT", "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/PurgeConfigBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMjo1MzozMFrOGsve5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNDoxNzo0MVrOGsxxVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU2ODQ4Ng==", "bodyText": "why is it not allowed to tolerate situations like:\nbuilder.purgeDeletes(true);\n... // oops business logic shows that we can't do that\nbuilder.purgeDeletes(false); // this will throw", "url": "https://github.com/splicemachine/spliceengine/pull/3702#discussion_r449568486", "createdAt": "2020-07-03T12:53:30Z", "author": {"login": "hatyo"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/PurgeConfigBuilder.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.splicemachine.si.impl.server;\n+\n+public class PurgeConfigBuilder {\n+    private PurgeConfig.PurgeLatestTombstone purgeLatestTombstone = null;\n+    private Boolean respectActiveTransactions = null;\n+    private Boolean purgeDeletes = null;\n+    private Boolean purgeUpdates = null;\n+\n+    public PurgeConfigBuilder purgeDeletes(boolean b) {\n+        assert purgeDeletes == null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb6c2fa16a04a0decf8c49bf7c1d9f6dc239f090"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYwNTk3Mw==", "bodyText": "At the moment, we set all of that in the same place, so I'd rather be defensive about it and force users to only call that function once.", "url": "https://github.com/splicemachine/spliceengine/pull/3702#discussion_r449605973", "createdAt": "2020-07-03T14:17:41Z", "author": {"login": "arnaud-splice"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/PurgeConfigBuilder.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.splicemachine.si.impl.server;\n+\n+public class PurgeConfigBuilder {\n+    private PurgeConfig.PurgeLatestTombstone purgeLatestTombstone = null;\n+    private Boolean respectActiveTransactions = null;\n+    private Boolean purgeDeletes = null;\n+    private Boolean purgeUpdates = null;\n+\n+    public PurgeConfigBuilder purgeDeletes(boolean b) {\n+        assert purgeDeletes == null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU2ODQ4Ng=="}, "originalCommit": {"oid": "eb6c2fa16a04a0decf8c49bf7c1d9f6dc239f090"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMjIzMjI2OnYy", "diffSide": "RIGHT", "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/PurgeConfig.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMjo1NDo1MlrOGsvhRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMjo1NDo1MlrOGsvhRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU2OTA5Mw==", "bodyText": "respectActiveTransactions I find the name a bit weird :) but it is ok", "url": "https://github.com/splicemachine/spliceengine/pull/3702#discussion_r449569093", "createdAt": "2020-07-03T12:54:52Z", "author": {"login": "hatyo"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/PurgeConfig.java", "diffHunk": "@@ -23,34 +23,16 @@\n \n     private final PurgeLatestTombstone purgeLatestTombstone;\n     private final boolean respectActiveTransactions;\n-    private final boolean purge;\n+    private final boolean purgeDeletes;\n+    private final boolean purgeUpdates;\n \n-    public PurgeConfig(boolean purge, PurgeLatestTombstone purgeLatestTombstone, boolean respectActiveTransactions) {\n-        this.purge = purge;\n+    public PurgeConfig(boolean purgeDeletes, PurgeLatestTombstone purgeLatestTombstone, boolean purgeUpdates, boolean respectActiveTransactions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb6c2fa16a04a0decf8c49bf7c1d9f6dc239f090"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMjI3MjAyOnYy", "diffSide": "RIGHT", "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/SICompactionStateMutate.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMzowOTowMlrOGsv5bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNDoxNDoxNVrOGsxreg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU3NTI3Ng==", "bodyText": "remove", "url": "https://github.com/splicemachine/spliceengine/pull/3702#discussion_r449575276", "createdAt": "2020-07-03T13:09:02Z", "author": {"login": "hatyo"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/SICompactionStateMutate.java", "diffHunk": "@@ -52,7 +56,7 @@ public void mutate(List<Cell> rawList, List<TxnView> txns, List<Cell> results) t\n         assert dataToReturn.isEmpty();\n         assert results.isEmpty();\n         assert maxTombstoneTimestamp == 0;\n-        assert isSorted(rawList): \"CompactionStateMutate: rawList not sorted\";\n+        //assert isSorted(rawList): \"CompactionStateMutate: rawList not sorted\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb6c2fa16a04a0decf8c49bf7c1d9f6dc239f090"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYwNDQ3NA==", "bodyText": "I would rather leave them there as they are quite handy when debugging", "url": "https://github.com/splicemachine/spliceengine/pull/3702#discussion_r449604474", "createdAt": "2020-07-03T14:14:15Z", "author": {"login": "arnaud-splice"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/SICompactionStateMutate.java", "diffHunk": "@@ -52,7 +56,7 @@ public void mutate(List<Cell> rawList, List<TxnView> txns, List<Cell> results) t\n         assert dataToReturn.isEmpty();\n         assert results.isEmpty();\n         assert maxTombstoneTimestamp == 0;\n-        assert isSorted(rawList): \"CompactionStateMutate: rawList not sorted\";\n+        //assert isSorted(rawList): \"CompactionStateMutate: rawList not sorted\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU3NTI3Ng=="}, "originalCommit": {"oid": "eb6c2fa16a04a0decf8c49bf7c1d9f6dc239f090"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMjI3NDI1OnYy", "diffSide": "RIGHT", "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/SICompactionStateMutate.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxMzowOTo1MlrOGsv61Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNDoxNDoyMVrOGsxrrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU3NTYzNw==", "bodyText": "dito", "url": "https://github.com/splicemachine/spliceengine/pull/3702#discussion_r449575637", "createdAt": "2020-07-03T13:09:52Z", "author": {"login": "hatyo"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/SICompactionStateMutate.java", "diffHunk": "@@ -61,15 +65,17 @@ public void mutate(List<Cell> rawList, List<TxnView> txns, List<Cell> results) t\n                 TxnView txn = it.next();\n                 mutate(aRawList, txn);\n             }\n-            if (purgeConfig.shouldPurge() &&\n-                    (!purgeConfig.shouldRespectActiveTransactions() || maxTombstoneTimestamp > 0)) {\n-                removeDeletedRows();\n-            }\n-            results.addAll(dataToReturn);\n-            assert isSorted(results) : \"CompactionStateMutate: results not sorted\";\n+            Stream<Cell> stream = dataToReturn.stream();\n+            if (shouldPurgeDeletes())\n+                stream = stream.filter(not(this::purgeableDeletedRow));\n+            if (shouldPurgeUpdates())\n+                stream = stream.filter(not(this::purgeableOldUpdate));\n+            stream.forEachOrdered(results::add);\n+            //assert isSorted(results) : \"CompactionStateMutate: results not sorted\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb6c2fa16a04a0decf8c49bf7c1d9f6dc239f090"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYwNDUyNg==", "bodyText": "same", "url": "https://github.com/splicemachine/spliceengine/pull/3702#discussion_r449604526", "createdAt": "2020-07-03T14:14:21Z", "author": {"login": "arnaud-splice"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/SICompactionStateMutate.java", "diffHunk": "@@ -61,15 +65,17 @@ public void mutate(List<Cell> rawList, List<TxnView> txns, List<Cell> results) t\n                 TxnView txn = it.next();\n                 mutate(aRawList, txn);\n             }\n-            if (purgeConfig.shouldPurge() &&\n-                    (!purgeConfig.shouldRespectActiveTransactions() || maxTombstoneTimestamp > 0)) {\n-                removeDeletedRows();\n-            }\n-            results.addAll(dataToReturn);\n-            assert isSorted(results) : \"CompactionStateMutate: results not sorted\";\n+            Stream<Cell> stream = dataToReturn.stream();\n+            if (shouldPurgeDeletes())\n+                stream = stream.filter(not(this::purgeableDeletedRow));\n+            if (shouldPurgeUpdates())\n+                stream = stream.filter(not(this::purgeableOldUpdate));\n+            stream.forEachOrdered(results::add);\n+            //assert isSorted(results) : \"CompactionStateMutate: results not sorted\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTU3NTYzNw=="}, "originalCommit": {"oid": "eb6c2fa16a04a0decf8c49bf7c1d9f6dc239f090"}, "originalPosition": 68}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3138, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}