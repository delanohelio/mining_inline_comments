{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNTgwMTc4", "number": 4781, "title": "DB-10817 Fix plan structure for non-flattenable nested joins", "bodyText": "", "createdAt": "2020-12-04T14:47:09Z", "url": "https://github.com/splicemachine/spliceengine/pull/4781", "merged": true, "mergeCommit": {"oid": "3935899add1f0c64ba685ed52aa1e2a742307fa2"}, "closed": true, "closedAt": "2020-12-08T21:47:39Z", "author": {"login": "ascend1"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi32DogH2gAyNTMyNTgwMTc4OjhjMmNkN2FhMjYwMWFjNjhmNzk5NGNmYzc3MjQzN2FmODRlNzFlYjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkQA7MAFqTU0NzU5NTg5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c2cd7aa2601ac68f7994cfc772437af84e71eb0", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/8c2cd7aa2601ac68f7994cfc772437af84e71eb0", "committedDate": "2020-12-04T13:34:29Z", "message": "DB-10817 Fix column reference remapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2afb04943476841e9f6baa42d993c580e35dff2", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/c2afb04943476841e9f6baa42d993c580e35dff2", "committedDate": "2020-12-04T14:39:02Z", "message": "DB-10817 Fix hash key columns for non-flattenable nested joins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f913266eca67f3a33682514ed0c3eb6b6f3ed40b", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f913266eca67f3a33682514ed0c3eb6b6f3ed40b", "committedDate": "2020-12-04T14:56:02Z", "message": "DB-10187 Add a comment explaining the fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzgxODI5", "url": "https://github.com/splicemachine/spliceengine/pull/4781#pullrequestreview-545381829", "createdAt": "2020-12-05T00:51:47Z", "commit": {"oid": "f913266eca67f3a33682514ed0c3eb6b6f3ed40b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQwMDo1MTo0N1rOH_nQ3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQwMDo1MTo0N1rOH_nQ3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ2NTYyOQ==", "bodyText": "It might be a good idea to introduce a new flag, such as 'needsProjectRestrict' so we don't overload flattenableJoin.  Is my understanding correct?  We can still flatten these child JoinNodes, but we just need to mark them so a ProjectRestrict is built?", "url": "https://github.com/splicemachine/spliceengine/pull/4781#discussion_r536465629", "createdAt": "2020-12-05T00:51:47Z", "author": {"login": "msirek"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/TableOperatorNode.java", "diffHunk": "@@ -529,6 +529,19 @@ protected FromTable getFromTableByName(String name,String schemaName,boolean exa\n      */\n     @Override\n     public ResultSetNode preprocess(int numTables, GroupByList gbl, FromList fromList) throws StandardException{\n+        /* DB-10817 note\n+         * For a non-flattenable join, set the non-flattenable flag to all nested joins.\n+         * This has nothing to do with flattening, but to build a PRN on top of each\n+         * nested joins. This is necessary because JoinConditionVisitor may add extra\n+         * hash key columns into children's result column lists. If any child is a\n+         * JoinNode, not PRN, then it breaks the equation that\n+         * resultColumns.size() = leftResultSet.resultColumns.size() + rightResultSet.resultColumns.size(),\n+         * which is the assumption in generated code.\n+         */\n+        if (!isFlattenableJoinNode()) {\n+            leftResultSet.notFlattenableJoin();\n+            rightResultSet.notFlattenableJoin();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f913266eca67f3a33682514ed0c3eb6b6f3ed40b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22517d82bbf63d551c555370bbb475a55e94a97f", "author": {"user": {"login": "ascend1", "name": "Zhen Li"}}, "url": "https://github.com/splicemachine/spliceengine/commit/22517d82bbf63d551c555370bbb475a55e94a97f", "committedDate": "2020-12-07T10:04:32Z", "message": "Merge branch 'master' into DB-10817"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDA2NDcy", "url": "https://github.com/splicemachine/spliceengine/pull/4781#pullrequestreview-547006472", "createdAt": "2020-12-08T10:08:29Z", "commit": {"oid": "22517d82bbf63d551c555370bbb475a55e94a97f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MDEyOTEz", "url": "https://github.com/splicemachine/spliceengine/pull/4781#pullrequestreview-547012913", "createdAt": "2020-12-08T10:12:54Z", "commit": {"oid": "22517d82bbf63d551c555370bbb475a55e94a97f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NDg5NjQx", "url": "https://github.com/splicemachine/spliceengine/pull/4781#pullrequestreview-547489641", "createdAt": "2020-12-08T18:00:20Z", "commit": {"oid": "22517d82bbf63d551c555370bbb475a55e94a97f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTk1ODk2", "url": "https://github.com/splicemachine/spliceengine/pull/4781#pullrequestreview-547595896", "createdAt": "2020-12-08T20:18:00Z", "commit": {"oid": "22517d82bbf63d551c555370bbb475a55e94a97f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 996, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}