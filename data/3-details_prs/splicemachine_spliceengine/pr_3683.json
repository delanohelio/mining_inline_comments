{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NjY3MDM4", "number": 3683, "title": "DB-9665 Clear ZNode for OlapServer app watcher", "bodyText": "Restart OlapServer if software version changed", "createdAt": "2020-06-15T17:10:30Z", "url": "https://github.com/splicemachine/spliceengine/pull/3683", "merged": true, "mergeCommit": {"oid": "3a2c5e446fd9bbdd4183fceb032e01cf179dbbcf"}, "closed": true, "closedAt": "2020-06-16T15:29:32Z", "author": {"login": "dgomezferro"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcriCs-gH2gAyNDM0NjY3MDM4OjgwZWRkNmVlMGYwMTkwN2RkYWUzMmUwODFiZWJkZTFiYTk2NzUxZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr2uODgFqTQzMTYwNzMwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "80edd6ee0f01907ddae32e081bebde1ba96751d3", "author": {"user": {"login": "dgomezferro", "name": "Daniel G\u00f3mez Ferro"}}, "url": "https://github.com/splicemachine/spliceengine/commit/80edd6ee0f01907ddae32e081bebde1ba96751d3", "committedDate": "2020-06-15T15:04:33Z", "message": "DB-9665 Clear ZNode for OlapServer app watcher\n\nRestart OlapServer if software version changed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTU5OTc0", "url": "https://github.com/splicemachine/spliceengine/pull/3683#pullrequestreview-430959974", "createdAt": "2020-06-15T20:14:08Z", "commit": {"oid": "80edd6ee0f01907ddae32e081bebde1ba96751d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoxNDowOFrOGkBJzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoxNDowOFrOGkBJzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMDgxMw==", "bodyText": "Is it needed to wrap the exception in a RuntimeException, can we just remove the catch?", "url": "https://github.com/splicemachine/spliceengine/pull/3683#discussion_r440420813", "createdAt": "2020-06-15T20:14:08Z", "author": {"login": "hatyo"}, "path": "hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java", "diffHunk": "@@ -244,6 +244,24 @@ public void run() {\n \n     }\n \n+    private byte[] getKeepAlivePayload() {\n+        DatabaseVersion version;\n+        try {\n+            version = JMXUtils.getLocalMBeanProxy(JMXUtils.SPLICEMACHINE_VERSION, DatabaseVersion.class);\n+        } catch (Exception e) {\n+            throw new RuntimeException(e);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80edd6ee0f01907ddae32e081bebde1ba96751d3"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwOTY1MTc5", "url": "https://github.com/splicemachine/spliceengine/pull/3683#pullrequestreview-430965179", "createdAt": "2020-06-15T20:22:19Z", "commit": {"oid": "80edd6ee0f01907ddae32e081bebde1ba96751d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoyMjoxOVrOGkBZkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMDoyMjoxOVrOGkBZkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyNDg1MA==", "bodyText": "Does version need to be re-read on every call? Can it be an instance, or even static, variable similar to OlapServerMaster?", "url": "https://github.com/splicemachine/spliceengine/pull/3683#discussion_r440424850", "createdAt": "2020-06-15T20:22:19Z", "author": {"login": "OlegMazurov"}, "path": "hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java", "diffHunk": "@@ -244,6 +244,24 @@ public void run() {\n \n     }\n \n+    private byte[] getKeepAlivePayload() {\n+        DatabaseVersion version;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80edd6ee0f01907ddae32e081bebde1ba96751d3"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTEzNTc5", "url": "https://github.com/splicemachine/spliceengine/pull/3683#pullrequestreview-431113579", "createdAt": "2020-06-16T02:17:37Z", "commit": {"oid": "80edd6ee0f01907ddae32e081bebde1ba96751d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMjoxNzozN1rOGkI4mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMjoxNzozN1rOGkI4mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0NzQ4MQ==", "bodyText": "Is this code possible after the change? Should we still ignore it?", "url": "https://github.com/splicemachine/spliceengine/pull/3683#discussion_r440547481", "createdAt": "2020-06-16T02:17:37Z", "author": {"login": "OlegMazurov"}, "path": "hbase_sql/src/main/java/com/splicemachine/olap/OlapServerSubmitter.java", "diffHunk": "@@ -166,10 +163,13 @@ public void run() {\n                         public void run() {\n                             RecoverableZooKeeper zk = ZkUtils.getRecoverableZooKeeper();\n                             String root = HConfiguration.getConfiguration().getSpliceRootPath();\n-                            String path = root + HBaseConfiguration.OLAP_SERVER_PATH + HBaseConfiguration.OLAP_SERVER_KEEP_ALIVE_PATH + \"/\" + appName;\n-                            byte[] payload = Bytes.toBytes(System.currentTimeMillis());\n+                            String keepAlivePath = root + HBaseConfiguration.OLAP_SERVER_PATH + HBaseConfiguration.OLAP_SERVER_KEEP_ALIVE_PATH + \"/\" + appName;\n+\n+                            byte[] payload = getKeepAlivePayload();\n                             try {\n-                                zk.create(path, payload, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n+                                // clean up node if it exists\n+                                ZkUtils.safeDelete(keepAlivePath, -1);\n+                                zk.create(keepAlivePath, payload, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n                             } catch (KeeperException ke) {\n                                 if (ke.code().equals(NODEEXISTS)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80edd6ee0f01907ddae32e081bebde1ba96751d3"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac3313fa3715aec4e56282b6fd498d92cd80fe91", "author": {"user": {"login": "dgomezferro", "name": "Daniel G\u00f3mez Ferro"}}, "url": "https://github.com/splicemachine/spliceengine/commit/ac3313fa3715aec4e56282b6fd498d92cd80fe91", "committedDate": "2020-06-16T08:33:52Z", "message": "DB-9665 Address reviews\n\nInitialize partial keepAlive message with version data once and update time when\ngenerating the payload"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNTU1NjE3", "url": "https://github.com/splicemachine/spliceengine/pull/3683#pullrequestreview-431555617", "createdAt": "2020-06-16T14:19:55Z", "commit": {"oid": "ac3313fa3715aec4e56282b6fd498d92cd80fe91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNTk0Nzg4", "url": "https://github.com/splicemachine/spliceengine/pull/3683#pullrequestreview-431594788", "createdAt": "2020-06-16T14:57:54Z", "commit": {"oid": "ac3313fa3715aec4e56282b6fd498d92cd80fe91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNjA3MzA5", "url": "https://github.com/splicemachine/spliceengine/pull/3683#pullrequestreview-431607309", "createdAt": "2020-06-16T15:10:12Z", "commit": {"oid": "ac3313fa3715aec4e56282b6fd498d92cd80fe91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1321, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}