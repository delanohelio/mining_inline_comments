{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4OTQ2MjEx", "number": 4364, "title": "DB-10558 Improve getTxnAt performance", "bodyText": "This PR addresses TPC-C performance regressions reported recently, the root cause was DB-10084 PR, in that PR we made our purge-during-flush logic play nicely with time travel's minimum retention period (MRP) such that if we want to flush we check whether the involved transaction is within MRP, if so, we skip the purging preserving as a result the validity of past transactions within MRP.\nThe new check leverages the getTxnAt RPC which we introduced a while ago with time travel. This method performs HBase scans in a very inefficient way potentially causing a full scan of Splice txn table. That is maybe OK if the system is not under heavy load.\nThe TPC-C benchmark is intentionally putting the system under a heavy transnational workload to benchmark its OLTP performance, as a result the Splice txn table could grow to a much larger size causing HBase scans on it to take considerable amount of time and exposing as a result the inefficiency in getTxnAt RPC implementation since now flushes are taking a considerable amount of time causing the overall performance to drop heavily.\nThe proposed fix includesm aking HBase scans needed by getTxnAt algorithm much more efficient by setting proper start/stop rows for the scan and return a single row instead of (unnecessary) many rows.", "createdAt": "2020-10-23T12:53:01Z", "url": "https://github.com/splicemachine/spliceengine/pull/4364", "merged": true, "mergeCommit": {"oid": "0d12d3e9014335da69c0e92455cdd4c595da3f52"}, "closed": true, "closedAt": "2020-10-30T07:37:42Z", "author": {"login": "hatyo"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVUq2agH2gAyNTA4OTQ2MjExOmYyYjJlNWVmMzg4Zjk2YTk0MjA0MmU1MjQ4MzUxMTRmZWFmZGExZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXb85pgFqTUyMDI1NjM4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f2b2e5ef388f96a942042e524835114feafda1d2", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f2b2e5ef388f96a942042e524835114feafda1d2", "committedDate": "2020-10-23T11:14:33Z", "message": "DB-10558 More efficient HBase scans in time travel."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "270ff9bda427f8729fb83714d5079c0ee176643e", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/270ff9bda427f8729fb83714d5079c0ee176643e", "committedDate": "2020-10-23T12:34:34Z", "message": "DB-10558 Add getTxnAt to high-priority queue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c4343a6e4191901fb4f7e5a54c0f8e57db9ebf2", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2c4343a6e4191901fb4f7e5a54c0f8e57db9ebf2", "committedDate": "2020-10-23T12:58:52Z", "message": "Merge remote-tracking branch 'origin/master' into DB-10558"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NjU2ODg2", "url": "https://github.com/splicemachine/spliceengine/pull/4364#pullrequestreview-515656886", "createdAt": "2020-10-23T13:17:26Z", "commit": {"oid": "270ff9bda427f8729fb83714d5079c0ee176643e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMzoxNzoyNlrOHnNbpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMzoxNzoyNlrOHnNbpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDg3NjU4MA==", "bodyText": "filterRowKey should only filter based on the rowkey, here you are looking at specific values. This is most likely called only once per row.\nI'm guessing the current implementation wouldn't work on SPLICE_TXN, since we'd inspect the latest written cell (COMMITTED or ROLLEDBACK), see that it's not the ACTIVE state and filter it out, which would filter out the whole row.", "url": "https://github.com/splicemachine/spliceengine/pull/4364#discussion_r510876580", "createdAt": "2020-10-23T13:17:26Z", "author": {"login": "dgomezferro"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/region/HBaseTxnFinder.java", "diffHunk": "@@ -89,15 +92,81 @@ public void close() throws IOException {\n         }\n     }\n \n+    private static class TxWithTimestampFilter extends FilterBase {\n+\n+        @Override\n+        public boolean filterRowKey(Cell cell) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270ff9bda427f8729fb83714d5079c0ee176643e"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a41c523928311bf0714444f8ca4fee67ae89f838", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/a41c523928311bf0714444f8ca4fee67ae89f838", "committedDate": "2020-10-23T17:29:25Z", "message": "DB-10558 address comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbbdd2ee3cd8ffc8f204df39ea108ff2c2f02ce5", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/fbbdd2ee3cd8ffc8f204df39ea108ff2c2f02ce5", "committedDate": "2020-10-23T17:29:52Z", "message": "Revert \"DB-10558 Add getTxnAt to high-priority queue.\"\n\nThis reverts commit 270ff9bda427f8729fb83714d5079c0ee176643e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb215160d298174daec0079a3d9ff456927e96d1", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/eb215160d298174daec0079a3d9ff456927e96d1", "committedDate": "2020-10-26T08:24:33Z", "message": "Merge remote-tracking branch 'origin/master' into DB-10558"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTE0MDEx", "url": "https://github.com/splicemachine/spliceengine/pull/4364#pullrequestreview-517514011", "createdAt": "2020-10-27T09:46:38Z", "commit": {"oid": "eb215160d298174daec0079a3d9ff456927e96d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMDA3NTY0", "url": "https://github.com/splicemachine/spliceengine/pull/4364#pullrequestreview-520007564", "createdAt": "2020-10-29T19:33:37Z", "commit": {"oid": "eb215160d298174daec0079a3d9ff456927e96d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMjU2Mzg4", "url": "https://github.com/splicemachine/spliceengine/pull/4364#pullrequestreview-520256388", "createdAt": "2020-10-30T00:51:28Z", "commit": {"oid": "eb215160d298174daec0079a3d9ff456927e96d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1072, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}