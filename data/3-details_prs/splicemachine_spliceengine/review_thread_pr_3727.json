{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNjM1NDgx", "number": 3727, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzo0NDowMlrOEJw5lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMToxODoyNVrOEKDQMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjczODE1OnYy", "diffSide": "RIGHT", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzo0NDowMlrOGqbfog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDo1Mjo1MFrOGq28FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0Mzg0Mg==", "bodyText": "The view is in SYSVW not SYSVM. Could you correct?", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447143842", "createdAt": "2020-06-29T17:44:02Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "diffHunk": "@@ -360,16 +360,25 @@ public void updateColumnViewInSysIBM(TransactionController tc) throws StandardEx\n                 // drop the view deifnition\n                 dropAllColumnDescriptors(td.getUUID(), tc);\n                 dropViewDescriptor(vd, tc);\n-                dropTableDescriptor(td, sysIBMSchemaDesc, tc);\n+                dropTableDescriptor(td, schemaDescriptor, tc);\n             }\n \n             // add new view deifnition\n-            createOneSystemView(tc, SYSCOLUMNS_CATALOG_NUM, \"SYSCOLUMNS\", 1, sysIBMSchemaDesc, SYSCOLUMNSRowFactory.SYSCOLUMNS_VIEW_IN_SYSIBM);\n+            createOneSystemView(tc, SYSCOLUMNS_CATALOG_NUM, tableName, viewIndex, schemaDescriptor, viewDef);\n \n-            SpliceLogUtils.info(LOG, \"The view syscolumns in SYSIBM has been updated with default column!\");\n+            SpliceLogUtils.info(LOG, String.format(\"The view %s in %s has been updated with default column!\", tableName, schemaDescriptor.getSchemaName()));\n         }\n     }\n \n+\n+    public void updateColumnViewInSysIBM(TransactionController tc) throws StandardException {\n+        updateColumnViewInSys(tc, \"SYSCOLUMNS\", 1, sysIBMSchemaDesc, SYSCOLUMNSRowFactory.SYSCOLUMNS_VIEW_IN_SYSIBM);\n+    }\n+\n+    public void updateColumnViewInSysVM(TransactionController tc) throws StandardException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU5MzQ5Mw==", "bodyText": "fixed", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447593493", "createdAt": "2020-06-30T10:52:50Z", "author": {"login": "ipraznik-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "diffHunk": "@@ -360,16 +360,25 @@ public void updateColumnViewInSysIBM(TransactionController tc) throws StandardEx\n                 // drop the view deifnition\n                 dropAllColumnDescriptors(td.getUUID(), tc);\n                 dropViewDescriptor(vd, tc);\n-                dropTableDescriptor(td, sysIBMSchemaDesc, tc);\n+                dropTableDescriptor(td, schemaDescriptor, tc);\n             }\n \n             // add new view deifnition\n-            createOneSystemView(tc, SYSCOLUMNS_CATALOG_NUM, \"SYSCOLUMNS\", 1, sysIBMSchemaDesc, SYSCOLUMNSRowFactory.SYSCOLUMNS_VIEW_IN_SYSIBM);\n+            createOneSystemView(tc, SYSCOLUMNS_CATALOG_NUM, tableName, viewIndex, schemaDescriptor, viewDef);\n \n-            SpliceLogUtils.info(LOG, \"The view syscolumns in SYSIBM has been updated with default column!\");\n+            SpliceLogUtils.info(LOG, String.format(\"The view %s in %s has been updated with default column!\", tableName, schemaDescriptor.getSchemaName()));\n         }\n     }\n \n+\n+    public void updateColumnViewInSysIBM(TransactionController tc) throws StandardException {\n+        updateColumnViewInSys(tc, \"SYSCOLUMNS\", 1, sysIBMSchemaDesc, SYSCOLUMNSRowFactory.SYSCOLUMNS_VIEW_IN_SYSIBM);\n+    }\n+\n+    public void updateColumnViewInSysVM(TransactionController tc) throws StandardException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0Mzg0Mg=="}, "originalCommit": {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4Njc0MDU0OnYy", "diffSide": "RIGHT", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/UpgradeScriptForAddDefaultToColumnViewInSYSVM.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzo0NDo0M1rOGqbhNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDo1Mzo1M1rOGq2-NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0NDI0NQ==", "bodyText": "It is in SYSVW schema.", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447144245", "createdAt": "2020-06-29T17:44:43Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/UpgradeScriptForAddDefaultToColumnViewInSYSVM.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.splicemachine.derby.impl.sql.catalog.upgrade;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.store.access.TransactionController;\n+import com.splicemachine.derby.impl.sql.catalog.SpliceDataDictionary;\n+import com.splicemachine.utils.SpliceLogUtils;\n+\n+/**\n+ * Created by Igor Praznik on 06/24/2020.\n+ */\n+public class UpgradeScriptForAddDefaultToColumnViewInSYSVM extends UpgradeScriptBase {\n+    public UpgradeScriptForAddDefaultToColumnViewInSYSVM(SpliceDataDictionary sdd, TransactionController tc) {\n+        super(sdd, tc);\n+    }\n+\n+    @Override\n+    protected void upgradeSystemTables() throws StandardException {\n+        sdd.updateColumnViewInSysVM(tc);\n+\n+        // we need to re-generate the metadataSPS if it is a change of definition of the table/column views in sysVM\n+        sdd.updateMetadataSPSes(tc);\n+\n+        SpliceLogUtils.info(LOG, \"Catalog upgraded: updated syscolumns view in SYSVM schema\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU5MzYwMg==", "bodyText": "fixed", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447593602", "createdAt": "2020-06-30T10:52:59Z", "author": {"login": "ipraznik-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/UpgradeScriptForAddDefaultToColumnViewInSYSVM.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.splicemachine.derby.impl.sql.catalog.upgrade;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.store.access.TransactionController;\n+import com.splicemachine.derby.impl.sql.catalog.SpliceDataDictionary;\n+import com.splicemachine.utils.SpliceLogUtils;\n+\n+/**\n+ * Created by Igor Praznik on 06/24/2020.\n+ */\n+public class UpgradeScriptForAddDefaultToColumnViewInSYSVM extends UpgradeScriptBase {\n+    public UpgradeScriptForAddDefaultToColumnViewInSYSVM(SpliceDataDictionary sdd, TransactionController tc) {\n+        super(sdd, tc);\n+    }\n+\n+    @Override\n+    protected void upgradeSystemTables() throws StandardException {\n+        sdd.updateColumnViewInSysVM(tc);\n+\n+        // we need to re-generate the metadataSPS if it is a change of definition of the table/column views in sysVM\n+        sdd.updateMetadataSPSes(tc);\n+\n+        SpliceLogUtils.info(LOG, \"Catalog upgraded: updated syscolumns view in SYSVM schema\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0NDI0NQ=="}, "originalCommit": {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU5NDAzNg==", "bodyText": "the upgrade has been tested, as you described", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447594036", "createdAt": "2020-06-30T10:53:53Z", "author": {"login": "ipraznik-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/UpgradeScriptForAddDefaultToColumnViewInSYSVM.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.splicemachine.derby.impl.sql.catalog.upgrade;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.store.access.TransactionController;\n+import com.splicemachine.derby.impl.sql.catalog.SpliceDataDictionary;\n+import com.splicemachine.utils.SpliceLogUtils;\n+\n+/**\n+ * Created by Igor Praznik on 06/24/2020.\n+ */\n+public class UpgradeScriptForAddDefaultToColumnViewInSYSVM extends UpgradeScriptBase {\n+    public UpgradeScriptForAddDefaultToColumnViewInSYSVM(SpliceDataDictionary sdd, TransactionController tc) {\n+        super(sdd, tc);\n+    }\n+\n+    @Override\n+    protected void upgradeSystemTables() throws StandardException {\n+        sdd.updateColumnViewInSysVM(tc);\n+\n+        // we need to re-generate the metadataSPS if it is a change of definition of the table/column views in sysVM\n+        sdd.updateMetadataSPSes(tc);\n+\n+        SpliceLogUtils.info(LOG, \"Catalog upgraded: updated syscolumns view in SYSVM schema\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0NDI0NQ=="}, "originalCommit": {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4OTc0NTE1OnYy", "diffSide": "RIGHT", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMToxODoyNVrOGq3tQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMDowNjoyOFrOGsGT0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYwNjA4MA==", "bodyText": "If we target this week's build, you will need to set this to 1962", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447606080", "createdAt": "2020-06-30T11:18:25Z", "author": {"login": "arnaud-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -83,6 +83,7 @@ else if(v1==v2)\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1953), new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1954), new UpgradeScriptToInvalidateStoredStatement(sdd,tc));\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1959), new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n+        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1961), new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9eec80c1d648bb3222589e582fe1323a3747181"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg5MzkwNg==", "bodyText": "The version has been updated", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r448893906", "createdAt": "2020-07-02T10:06:28Z", "author": {"login": "ipraznik-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -83,6 +83,7 @@ else if(v1==v2)\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1953), new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1954), new UpgradeScriptToInvalidateStoredStatement(sdd,tc));\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1959), new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n+        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1961), new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYwNjA4MA=="}, "originalCommit": {"oid": "d9eec80c1d648bb3222589e582fe1323a3747181"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3146, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}