{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0NjExMTU1", "number": 4808, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxOTo1ODowNFrOFCkZ2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDoyNToyMlrOFC2QlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4MjM3OTEyOnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/OperatorToString.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxOTo1ODowNFrOIBzmQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwMzozOTowNVrOICA0mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc2NDg2Nw==", "bodyText": "Is there a comma missing here in the parameter list?", "url": "https://github.com/splicemachine/spliceengine/pull/4808#discussion_r538764867", "createdAt": "2020-12-08T19:58:04Z", "author": {"login": "msirek"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/OperatorToString.java", "diffHunk": "@@ -679,23 +679,26 @@ else if (vars.buildExpressionTree)\n                 }\n                 else if (operand.getClass() == TernaryOperatorNode.class) {\n                     vars.relationalOpDepth.increment();\n-                    if (top.getOperator().equals(\"LOCATE\") ||\n-                        top.getOperator().equals(\"replace\") ||\n-                        (top.getOperator().equals(\"substring\") && top.getRightOperand() != null)) {\n-\n+                    if (top.getOperator().equals(\"LOCATE\") || top.getOperator().equals(\"replace\")) {\n                         vars.relationalOpDepth.decrement();\n                         String retval = format(\"%s(%s, %s, %s) \", top.getOperator(), opToString2(top.getReceiver(), vars),\n                                 opToString2(top.getLeftOperand(), vars), opToString2(top.getRightOperand(), vars));\n                         vars.relationalOpDepth.decrement();\n                         return retval;\n                     } else if (top.getOperator().equals(\"substring\")) {\n-                        assert top.getRightOperand() == null;\n                         vars.relationalOpDepth.decrement();\n-                        String retval = format(\"%s(%s, %s) \", top.getOperator(), opToString2(top.getReceiver(), vars),\n-                                opToString2(top.getLeftOperand(), vars));\n+                        String retval = format(\"%s(%s, %s %s)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f6f5957f6fa127610e09803273551b9969c2c07"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc5NzU5MA==", "bodyText": "No, the comma is added if a third parameter is necessary, see below.", "url": "https://github.com/splicemachine/spliceengine/pull/4808#discussion_r538797590", "createdAt": "2020-12-08T20:52:49Z", "author": {"login": "arnaud-splice"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/OperatorToString.java", "diffHunk": "@@ -679,23 +679,26 @@ else if (vars.buildExpressionTree)\n                 }\n                 else if (operand.getClass() == TernaryOperatorNode.class) {\n                     vars.relationalOpDepth.increment();\n-                    if (top.getOperator().equals(\"LOCATE\") ||\n-                        top.getOperator().equals(\"replace\") ||\n-                        (top.getOperator().equals(\"substring\") && top.getRightOperand() != null)) {\n-\n+                    if (top.getOperator().equals(\"LOCATE\") || top.getOperator().equals(\"replace\")) {\n                         vars.relationalOpDepth.decrement();\n                         String retval = format(\"%s(%s, %s, %s) \", top.getOperator(), opToString2(top.getReceiver(), vars),\n                                 opToString2(top.getLeftOperand(), vars), opToString2(top.getRightOperand(), vars));\n                         vars.relationalOpDepth.decrement();\n                         return retval;\n                     } else if (top.getOperator().equals(\"substring\")) {\n-                        assert top.getRightOperand() == null;\n                         vars.relationalOpDepth.decrement();\n-                        String retval = format(\"%s(%s, %s) \", top.getOperator(), opToString2(top.getReceiver(), vars),\n-                                opToString2(top.getLeftOperand(), vars));\n+                        String retval = format(\"%s(%s, %s %s)\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc2NDg2Nw=="}, "originalCommit": {"oid": "1f6f5957f6fa127610e09803273551b9969c2c07"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODk4MTUyOA==", "bodyText": "OK, I see.  Thanks.", "url": "https://github.com/splicemachine/spliceengine/pull/4808#discussion_r538981528", "createdAt": "2020-12-09T03:39:05Z", "author": {"login": "msirek"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/OperatorToString.java", "diffHunk": "@@ -679,23 +679,26 @@ else if (vars.buildExpressionTree)\n                 }\n                 else if (operand.getClass() == TernaryOperatorNode.class) {\n                     vars.relationalOpDepth.increment();\n-                    if (top.getOperator().equals(\"LOCATE\") ||\n-                        top.getOperator().equals(\"replace\") ||\n-                        (top.getOperator().equals(\"substring\") && top.getRightOperand() != null)) {\n-\n+                    if (top.getOperator().equals(\"LOCATE\") || top.getOperator().equals(\"replace\")) {\n                         vars.relationalOpDepth.decrement();\n                         String retval = format(\"%s(%s, %s, %s) \", top.getOperator(), opToString2(top.getReceiver(), vars),\n                                 opToString2(top.getLeftOperand(), vars), opToString2(top.getRightOperand(), vars));\n                         vars.relationalOpDepth.decrement();\n                         return retval;\n                     } else if (top.getOperator().equals(\"substring\")) {\n-                        assert top.getRightOperand() == null;\n                         vars.relationalOpDepth.decrement();\n-                        String retval = format(\"%s(%s, %s) \", top.getOperator(), opToString2(top.getReceiver(), vars),\n-                                opToString2(top.getLeftOperand(), vars));\n+                        String retval = format(\"%s(%s, %s %s)\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc2NDg2Nw=="}, "originalCommit": {"oid": "1f6f5957f6fa127610e09803273551b9969c2c07"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NTMwMTYxOnYy", "diffSide": "RIGHT", "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceUnitTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDoyNDo0NVrOICNRlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDoyNDo0NVrOICNRlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE4NTU1Nw==", "bodyText": "This logic is available as firstRowContainsQuery() in the same file. But it's just a minor issue and should not prevent the change from being merged.", "url": "https://github.com/splicemachine/spliceengine/pull/4808#discussion_r539185557", "createdAt": "2020-12-09T10:24:45Z", "author": {"login": "ascend1"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceUnitTest.java", "diffHunk": "@@ -1195,6 +1195,21 @@ protected void checkBooleanExpression(String input, boolean output, TestConnecti\n             rs.next();\n             Assert.assertEquals(output, rs.getBoolean(1));\n         }\n+    }\n+\n+    protected void checkExpressionType(String input, String expectedType, TestConnection conn) throws SQLException {\n+        String sql = format(\"select typeof(%s)\", input);\n+        try(ResultSet rs = conn.query(sql)) {\n+            rs.next();\n+            Assert.assertEquals(expectedType, rs.getString(1));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f6f5957f6fa127610e09803273551b9969c2c07"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NTMwNDUyOnYy", "diffSide": "RIGHT", "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceUnitTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDoyNToyMlrOICNTRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDoyNToyMlrOICNTRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE4NTk4OQ==", "bodyText": "Ditto.", "url": "https://github.com/splicemachine/spliceengine/pull/4808#discussion_r539185989", "createdAt": "2020-12-09T10:25:22Z", "author": {"login": "ascend1"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/test/framework/SpliceUnitTest.java", "diffHunk": "@@ -1195,6 +1195,21 @@ protected void checkBooleanExpression(String input, boolean output, TestConnecti\n             rs.next();\n             Assert.assertEquals(output, rs.getBoolean(1));\n         }\n+    }\n+\n+    protected void checkExpressionType(String input, String expectedType, TestConnection conn) throws SQLException {\n+        String sql = format(\"select typeof(%s)\", input);\n+        try(ResultSet rs = conn.query(sql)) {\n+            rs.next();\n+            Assert.assertEquals(expectedType, rs.getString(1));\n+        }\n+    }\n \n+    protected void checkStringExpression(String input, String expectedOutput, TestConnection conn) throws SQLException {\n+        String sql = format(\"select %s\", input);\n+        try(ResultSet rs = conn.query(sql)) {\n+            rs.next();\n+            Assert.assertEquals(expectedOutput, rs.getString(1));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f6f5957f6fa127610e09803273551b9969c2c07"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2717, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}