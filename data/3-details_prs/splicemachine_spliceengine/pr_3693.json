{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MDg1MjE1", "number": 3693, "title": "DB-9714 Support time travel SELECT statements with tx id", "bodyText": "add parser extensions to support AS OF clause.\nonly the tx id is supported.\npropagate the transaction id down the execution tree to\nTableScanOperation.\nadapt code generation to pass the tx id to TableScanOperation\nat runtime.\nadd tests", "createdAt": "2020-06-17T20:41:44Z", "url": "https://github.com/splicemachine/spliceengine/pull/3693", "merged": true, "mergeCommit": {"oid": "303aaa520b450c67edddda5e230e3b21f43886c5"}, "closed": true, "closedAt": "2020-07-17T18:23:08Z", "author": {"login": "hatyo"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsQCjOgH2gAyNDM2MDg1MjE1OjQ5ZWNiMGZkZTUyNmIxZjZiYWYxOTQ1MzQ2MmE2ZTI3NjBkYmU3YmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1bXaugH2gAyNDM2MDg1MjE1OjhlNTA0NmNmZDA4OTZiNmZjZWI1ZjVjYTNlY2FjNmM2MmJiNGE5YmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "49ecb0fde526b1f6baf19453462a6e2760dbe7bd", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/49ecb0fde526b1f6baf19453462a6e2760dbe7bd", "committedDate": "2020-06-17T20:40:01Z", "message": "Support time travel SELECT statements with tx id.\n\n- add parser extensions to support AS OF clause.\n- only the tx id is supported.\n- propagate the transaction id down the execution tree to\n  TableScanOperation.\n- adapt code generation to pass the tx id to TableScanOperation\n  at runtime.\n- add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTI1MjYw", "url": "https://github.com/splicemachine/spliceengine/pull/3693#pullrequestreview-434125260", "createdAt": "2020-06-19T14:33:23Z", "commit": {"oid": "49ecb0fde526b1f6baf19453462a6e2760dbe7bd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDozMzoyM1rOGmW-kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDo0ODozNlrOGmXezQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NTUzOA==", "bodyText": "Is this lookahead necessary?", "url": "https://github.com/splicemachine/spliceengine/pull/3693#discussion_r442875538", "createdAt": "2020-06-19T14:33:23Z", "author": {"login": "arnaud-splice"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/sqlgrammar.jj", "diffHunk": "@@ -12276,6 +12295,18 @@ windowDefinition(WindowList wl) throws StandardException :\n     }\n }\n \n+Long\n+asOfClause() throws StandardException :\n+{\n+    Long txId = null;\n+}\n+{\n+    LOOKAHEAD({(getToken(1).kind == AS && getToken(2).kind == OF)}) <AS> <OF> txId = exactNumber()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49ecb0fde526b1f6baf19453462a6e2760dbe7bd"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4MjEzMA==", "bodyText": "I think a dedicated parameter would be cleaner instead of shoehorning a long in a boolean parameter.", "url": "https://github.com/splicemachine/spliceengine/pull/3693#discussion_r442882130", "createdAt": "2020-06-19T14:45:32Z", "author": {"login": "arnaud-splice"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/FromBaseTable.java", "diffHunk": "@@ -196,36 +196,30 @@\n     private AggregateNode aggrForSpecialMaxScan;\n \n     private boolean isBulkDelete = false;\n+\n+    private long pastTxId = -1;\n+\n     @Override\n     public boolean isParallelizable(){\n         return false;\n     }\n \n     /**\n-     * Initializer for a table in a FROM list. Parameters are as follows:\n-     * <p/>\n-     * <ul>\n-     * <li>tableName            The name of the table</li>\n-     * <li>correlationName    The correlation name</li>\n-     * <li>derivedRCL        The derived column list</li>\n-     * <li>tableProperties    The Properties list associated with the table.</li>\n-     * </ul>\n-     * <p/>\n-     * <p>\n-     * - OR -\n-     * </p>\n-     * <p/>\n-     * <ul>\n-     * <li>tableName            The name of the table</li>\n-     * <li>correlationName    The correlation name</li>\n-     * <li>updateOrDelete    Table is being updated/deleted from. </li>\n-     * <li>derivedRCL        The derived column list</li>\n-     * </ul>\n+     * Initializer for a table in a FROM list.\n+     * @param tableName The name of the table\n+     * @param correlationName The correlation name\n+     * @param rclOrUD update/delete flag or result column list\n+     * @param propsOrRcl properties or result column list\n+     * @param isBulkDeleteOrTxId bulk delete flag or past tx id.\n      */\n     @Override\n-    public void init(Object tableName,Object correlationName,Object rclOrUD,Object propsOrRcl, Object isBulkDelete){\n+    public void init(Object tableName,Object correlationName,Object rclOrUD,Object propsOrRcl, Object isBulkDeleteOrTxId){\n+        if(isBulkDeleteOrTxId instanceof Boolean) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49ecb0fde526b1f6baf19453462a6e2760dbe7bd"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4Mzc4OQ==", "bodyText": "Please add a space before timeTravelTx.\nAlso, you could simply write \"as of\" instead, to echo the query, but that's unimportant.", "url": "https://github.com/splicemachine/spliceengine/pull/3693#discussion_r442883789", "createdAt": "2020-06-19T14:48:36Z", "author": {"login": "arnaud-splice"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/FromBaseTable.java", "diffHunk": "@@ -3410,7 +3408,11 @@ private String getClassName(String niceIndexName) throws StandardException {\n         if(niceIndexName!=null){\n             cName = \"IndexScan[\"+niceIndexName+\"]\";\n         }else{\n-            cName = \"TableScan[\"+getPrettyTableName()+\"]\";\n+            cName = \"TableScan[\"+getPrettyTableName();\n+            if(pastTxId >= 0){\n+                cName += \"timeTravelTx(\" + pastTxId + \")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49ecb0fde526b1f6baf19453462a6e2760dbe7bd"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3Njg4NzU5", "url": "https://github.com/splicemachine/spliceengine/pull/3693#pullrequestreview-437688759", "createdAt": "2020-06-25T17:02:12Z", "commit": {"oid": "49ecb0fde526b1f6baf19453462a6e2760dbe7bd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNzowMjoxMlrOGpDxlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNzowMjoxMlrOGpDxlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcwNjY0NA==", "bodyText": "Could we remove the lookahead with something like\n[ [ <AS> [ <OF> txnId = asOfClause() [ AS ] ] ...  ?", "url": "https://github.com/splicemachine/spliceengine/pull/3693#discussion_r445706644", "createdAt": "2020-06-25T17:02:12Z", "author": {"login": "dgomezferro"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/sqlgrammar.jj", "diffHunk": "@@ -10914,28 +10915,45 @@ tableReferenceTypes(boolean nestedInParens) throws StandardException :\n Object[]\n optionalTableClauses() throws StandardException :\n {\n-    Object[]             otc = null;\n-    Properties            tableProperties = null;\n-    ResultColumnList    derivedRCL = null;\n-    String                correlationName = null;\n+    Object[]         otc = null;\n+    Properties       tableProperties = null;\n+    ResultColumnList derivedRCL = null;\n+    String           correlationName = null;\n+    Long             txnId = null;\n }\n {\n     otc = optionalTableProperties()\n     {\n         otc[OPTIONAL_TABLE_CLAUSES_DERIVED_RCL] = derivedRCL;\n         otc[OPTIONAL_TABLE_CLAUSES_CORRELATION_NAME] = correlationName;\n+        otc[OPTIONAL_TABLE_CLAUSES_TXN_ID] = txnId;\n         return otc;\n     }\n |\n+    LOOKAHEAD( { getToken(1).kind != AS || getToken(2).kind != OF })\n     [ [ <AS> ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49ecb0fde526b1f6baf19453462a6e2760dbe7bd"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69c5064cfb517f637292c9a9198520b0667c49ff", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/69c5064cfb517f637292c9a9198520b0667c49ff", "committedDate": "2020-07-06T18:46:41Z", "message": "Addressed comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebae97a79a00a8a55d4c12047bc338909c2e06ec", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/ebae97a79a00a8a55d4c12047bc338909c2e06ec", "committedDate": "2020-07-06T18:47:54Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9714"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9c4480364623cc4fb382a64183e0d2ec70f18d0", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/d9c4480364623cc4fb382a64183e0d2ec70f18d0", "committedDate": "2020-07-06T20:14:46Z", "message": "Disallow time travel clause on external tables and views.\n\n- Add tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16e8ee799170ab2ef72aba0f4c7084085e8514e2", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/16e8ee799170ab2ef72aba0f4c7084085e8514e2", "committedDate": "2020-07-07T12:31:04Z", "message": "Fix SpotBug issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20abe7ca758cf03a863edc5c47ee7b9fe5c0bef6", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/20abe7ca758cf03a863edc5c47ee7b9fe5c0bef6", "committedDate": "2020-07-10T15:07:15Z", "message": "Add upgrade script to invalidate stored statements."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f544c86289748608ac77934e5bc1250f7fdfbae", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2f544c86289748608ac77934e5bc1250f7fdfbae", "committedDate": "2020-07-10T15:12:03Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9714"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NzQxOTQ4", "url": "https://github.com/splicemachine/spliceengine/pull/3693#pullrequestreview-447741948", "createdAt": "2020-07-14T02:31:57Z", "commit": {"oid": "2f544c86289748608ac77934e5bc1250f7fdfbae"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMjozMTo1OFrOGxBtNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwNjoxMDoyMVrOGxFiYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDA2MTM2Ng==", "bodyText": "I think this shouldn't be optional once we get into this branch.", "url": "https://github.com/splicemachine/spliceengine/pull/3693#discussion_r454061366", "createdAt": "2020-07-14T02:31:58Z", "author": {"login": "yxia92"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/sqlgrammar.jj", "diffHunk": "@@ -10914,28 +10916,45 @@ tableReferenceTypes(boolean nestedInParens) throws StandardException :\n Object[]\n optionalTableClauses() throws StandardException :\n {\n-    Object[]             otc = null;\n-    Properties            tableProperties = null;\n-    ResultColumnList    derivedRCL = null;\n-    String                correlationName = null;\n+    Object[]         otc = null;\n+    Properties       tableProperties = null;\n+    ResultColumnList derivedRCL = null;\n+    String           correlationName = null;\n+    Long             txnId = -1L;\n }\n {\n     otc = optionalTableProperties()\n     {\n         otc[OPTIONAL_TABLE_CLAUSES_DERIVED_RCL] = derivedRCL;\n         otc[OPTIONAL_TABLE_CLAUSES_CORRELATION_NAME] = correlationName;\n+        otc[OPTIONAL_TABLE_CLAUSES_TXN_ID] = txnId;\n         return otc;\n     }\n |\n+    LOOKAHEAD( { getToken(1).kind != AS || getToken(2).kind != OF })\n     [ [ <AS> ]\n         correlationName = identifier(Limits.MAX_IDENTIFIER_LENGTH, true)\n+        [txnId = asOfClause()]\n         [ <LEFT_PAREN> derivedRCL = derivedColumnList() <RIGHT_PAREN> ]\n         [tableProperties = propertyList(true) <CHECK_PROPERTIES>] ]\n     {\n         otc = new Object[OPTIONAL_TABLE_CLAUSES_SIZE];\n         otc[OPTIONAL_TABLE_CLAUSES_TABLE_PROPERTIES] = tableProperties;\n         otc[OPTIONAL_TABLE_CLAUSES_DERIVED_RCL] = derivedRCL;\n         otc[OPTIONAL_TABLE_CLAUSES_CORRELATION_NAME] = correlationName;\n+        otc[OPTIONAL_TABLE_CLAUSES_TXN_ID] = txnId;\n+        return otc;\n+    }\n+|\n+    [txnId = asOfClause()]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f544c86289748608ac77934e5bc1250f7fdfbae"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDExOTM1NA==", "bodyText": "We need to remove the closing bracket \"]\" for IndexScan here also", "url": "https://github.com/splicemachine/spliceengine/pull/3693#discussion_r454119354", "createdAt": "2020-07-14T05:56:39Z", "author": {"login": "yxia92"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/FromBaseTable.java", "diffHunk": "@@ -3411,7 +3422,11 @@ private String getClassName(String niceIndexName) throws StandardException {\n         if(niceIndexName!=null){\n             cName = \"IndexScan[\"+niceIndexName+\"]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f544c86289748608ac77934e5bc1250f7fdfbae"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDEyNDEzMQ==", "bodyText": "Can you add check for tableDescriptor.getTableType()==TableDescriptor.WITH_TYPE also?", "url": "https://github.com/splicemachine/spliceengine/pull/3693#discussion_r454124131", "createdAt": "2020-07-14T06:10:21Z", "author": {"login": "yxia92"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/FromBaseTable.java", "diffHunk": "@@ -1042,6 +1038,17 @@ public ResultSetNode bindNonVTITables(DataDictionary dataDictionary,\n                                           FromList fromListParam)throws StandardException{\n         TableDescriptor tableDescriptor=bindTableDescriptor();\n \n+        int tableType = tableDescriptor.getTableType();\n+        if(pastTxId >= 0)\n+        {\n+            if(tableType==TableDescriptor.VIEW_TYPE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f544c86289748608ac77934e5bc1250f7fdfbae"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a84933d44be77758a4b1603cd9ce7b2e841f569c", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/a84933d44be77758a4b1603cd9ce7b2e841f569c", "committedDate": "2020-07-14T15:14:29Z", "message": "Addressed further comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2405dcb59774fecad245895185f80c6170108e7e", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2405dcb59774fecad245895185f80c6170108e7e", "committedDate": "2020-07-14T15:15:31Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9714"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MjM4NzAz", "url": "https://github.com/splicemachine/spliceengine/pull/3693#pullrequestreview-448238703", "createdAt": "2020-07-14T15:51:32Z", "commit": {"oid": "2405dcb59774fecad245895185f80c6170108e7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODM0NTI5", "url": "https://github.com/splicemachine/spliceengine/pull/3693#pullrequestreview-448834529", "createdAt": "2020-07-15T10:40:26Z", "commit": {"oid": "2405dcb59774fecad245895185f80c6170108e7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDI4NjU1", "url": "https://github.com/splicemachine/spliceengine/pull/3693#pullrequestreview-449028655", "createdAt": "2020-07-15T14:43:56Z", "commit": {"oid": "2405dcb59774fecad245895185f80c6170108e7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjE4Mzkx", "url": "https://github.com/splicemachine/spliceengine/pull/3693#pullrequestreview-449618391", "createdAt": "2020-07-16T08:12:26Z", "commit": {"oid": "2405dcb59774fecad245895185f80c6170108e7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e5046cfd0896b6fceb5f5ca3ecac6c62bb4a9bf", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/8e5046cfd0896b6fceb5f5ca3ecac6c62bb4a9bf", "committedDate": "2020-07-16T08:57:05Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9714"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1272, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}