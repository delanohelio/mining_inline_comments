{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNjM1NDgx", "number": 3727, "title": "DB-9173 Select on SYS.SYSCOLUMNS fails when there is a table with column default specified.", "bodyText": "", "createdAt": "2020-06-26T15:01:54Z", "url": "https://github.com/splicemachine/spliceengine/pull/3727", "merged": true, "mergeCommit": {"oid": "364fa8fe9067215aca040c2371ecce14c11f3954"}, "closed": true, "closedAt": "2020-07-02T10:07:40Z", "author": {"login": "ipraznik-splice"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuqIYdAH2gAyNDQwNjM1NDgxOmY3ZWNjYTcwNDA3OTZjZDRkMmJjOTE0NDk5Njg4NGJlYjgyYWIwY2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw77nrAH2gAyNDQwNjM1NDgxOjg4MDJhNGYyODk3YmJiNDU5OTZlY2JkZGE5N2UwYmU2ZTYyNDljNDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7ecca7040796cd4d2bc9144996884beb82ab0cd", "author": {"user": {"login": "ipraznik-splice", "name": null}}, "url": "https://github.com/splicemachine/spliceengine/commit/f7ecca7040796cd4d2bc9144996884beb82ab0cd", "committedDate": "2020-06-25T08:11:46Z", "message": "DB-9173 Select on SYS.SYSCOLUMNS fails when there is a table with column default specified."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "875a214bf656489515e7beeca98ed08b0f7c8120", "author": {"user": {"login": "ipraznik-splice", "name": null}}, "url": "https://github.com/splicemachine/spliceengine/commit/875a214bf656489515e7beeca98ed08b0f7c8120", "committedDate": "2020-06-25T08:18:03Z", "message": "DB-9173 SYSVM upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c", "author": {"user": {"login": "ipraznik-splice", "name": null}}, "url": "https://github.com/splicemachine/spliceengine/commit/4946f5de15f9c6d10ffdec5cef8a140eed01060c", "committedDate": "2020-06-25T12:24:58Z", "message": "DB-9173 SpotBugs fixed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzY2Mzc4", "url": "https://github.com/splicemachine/spliceengine/pull/3727#pullrequestreview-439366378", "createdAt": "2020-06-29T17:44:02Z", "commit": {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzo0NDowMlrOGqbfog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzo0NDo0M1rOGqbhNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0Mzg0Mg==", "bodyText": "The view is in SYSVW not SYSVM. Could you correct?", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447143842", "createdAt": "2020-06-29T17:44:02Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "diffHunk": "@@ -360,16 +360,25 @@ public void updateColumnViewInSysIBM(TransactionController tc) throws StandardEx\n                 // drop the view deifnition\n                 dropAllColumnDescriptors(td.getUUID(), tc);\n                 dropViewDescriptor(vd, tc);\n-                dropTableDescriptor(td, sysIBMSchemaDesc, tc);\n+                dropTableDescriptor(td, schemaDescriptor, tc);\n             }\n \n             // add new view deifnition\n-            createOneSystemView(tc, SYSCOLUMNS_CATALOG_NUM, \"SYSCOLUMNS\", 1, sysIBMSchemaDesc, SYSCOLUMNSRowFactory.SYSCOLUMNS_VIEW_IN_SYSIBM);\n+            createOneSystemView(tc, SYSCOLUMNS_CATALOG_NUM, tableName, viewIndex, schemaDescriptor, viewDef);\n \n-            SpliceLogUtils.info(LOG, \"The view syscolumns in SYSIBM has been updated with default column!\");\n+            SpliceLogUtils.info(LOG, String.format(\"The view %s in %s has been updated with default column!\", tableName, schemaDescriptor.getSchemaName()));\n         }\n     }\n \n+\n+    public void updateColumnViewInSysIBM(TransactionController tc) throws StandardException {\n+        updateColumnViewInSys(tc, \"SYSCOLUMNS\", 1, sysIBMSchemaDesc, SYSCOLUMNSRowFactory.SYSCOLUMNS_VIEW_IN_SYSIBM);\n+    }\n+\n+    public void updateColumnViewInSysVM(TransactionController tc) throws StandardException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE0NDI0NQ==", "bodyText": "It is in SYSVW schema.", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447144245", "createdAt": "2020-06-29T17:44:43Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/UpgradeScriptForAddDefaultToColumnViewInSYSVM.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package com.splicemachine.derby.impl.sql.catalog.upgrade;\n+\n+import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.store.access.TransactionController;\n+import com.splicemachine.derby.impl.sql.catalog.SpliceDataDictionary;\n+import com.splicemachine.utils.SpliceLogUtils;\n+\n+/**\n+ * Created by Igor Praznik on 06/24/2020.\n+ */\n+public class UpgradeScriptForAddDefaultToColumnViewInSYSVM extends UpgradeScriptBase {\n+    public UpgradeScriptForAddDefaultToColumnViewInSYSVM(SpliceDataDictionary sdd, TransactionController tc) {\n+        super(sdd, tc);\n+    }\n+\n+    @Override\n+    protected void upgradeSystemTables() throws StandardException {\n+        sdd.updateColumnViewInSysVM(tc);\n+\n+        // we need to re-generate the metadataSPS if it is a change of definition of the table/column views in sysVM\n+        sdd.updateMetadataSPSes(tc);\n+\n+        SpliceLogUtils.info(LOG, \"Catalog upgraded: updated syscolumns view in SYSVM schema\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4946f5de15f9c6d10ffdec5cef8a140eed01060c"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9eec80c1d648bb3222589e582fe1323a3747181", "author": {"user": {"login": "ipraznik-splice", "name": null}}, "url": "https://github.com/splicemachine/spliceengine/commit/d9eec80c1d648bb3222589e582fe1323a3747181", "committedDate": "2020-06-30T10:17:11Z", "message": "DB-9173 SYSVM typo corrected"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5OTE1OTE1", "url": "https://github.com/splicemachine/spliceengine/pull/3727#pullrequestreview-439915915", "createdAt": "2020-06-30T11:18:24Z", "commit": {"oid": "d9eec80c1d648bb3222589e582fe1323a3747181"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMToxODoyNVrOGq3tQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMToxODoyNVrOGq3tQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYwNjA4MA==", "bodyText": "If we target this week's build, you will need to set this to 1962", "url": "https://github.com/splicemachine/spliceengine/pull/3727#discussion_r447606080", "createdAt": "2020-06-30T11:18:25Z", "author": {"login": "arnaud-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/upgrade/SpliceCatalogUpgradeScripts.java", "diffHunk": "@@ -83,6 +83,7 @@ else if(v1==v2)\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1953), new UpgradeScriptForRemoveUnusedIndexInSYSFILESTable(sdd,tc));\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1954), new UpgradeScriptToInvalidateStoredStatement(sdd,tc));\n         scripts.put(new Splice_DD_Version(sdd,3,1,0, 1959), new UpgradeScriptForTriggerMultipleStatements(sdd,tc));\n+        scripts.put(new Splice_DD_Version(sdd,3,1,0, 1961), new UpgradeScriptForAddDefaultToColumnViewInSYSVW(sdd,tc));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9eec80c1d648bb3222589e582fe1323a3747181"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDg4NzQ0", "url": "https://github.com/splicemachine/spliceengine/pull/3727#pullrequestreview-441088744", "createdAt": "2020-07-01T18:03:41Z", "commit": {"oid": "d9eec80c1d648bb3222589e582fe1323a3747181"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzc1OTc4", "url": "https://github.com/splicemachine/spliceengine/pull/3727#pullrequestreview-441375978", "createdAt": "2020-07-02T06:13:33Z", "commit": {"oid": "d9eec80c1d648bb3222589e582fe1323a3747181"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8802a4f2897bbb45996ecbdda97e0be6e6249c44", "author": {"user": {"login": "ipraznik-splice", "name": null}}, "url": "https://github.com/splicemachine/spliceengine/commit/8802a4f2897bbb45996ecbdda97e0be6e6249c44", "committedDate": "2020-07-02T10:03:58Z", "message": "DB-9173 Build version in upgrade updated"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1283, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}