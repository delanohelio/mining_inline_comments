{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyOTA4NTYx", "number": 3214, "title": "DB-9140 Support tuples in predicates", "bodyText": "", "createdAt": "2020-02-10T02:11:03Z", "url": "https://github.com/splicemachine/spliceengine/pull/3214", "merged": true, "mergeCommit": {"oid": "6d5b6a203fdaa103bdada5ca97944c0e581fe054"}, "closed": true, "closedAt": "2020-02-21T06:05:54Z", "author": {"login": "arnaud-splice"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDo7aSgFqTM1NzU5OTQ5Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGQbu4AH2gAyMzcyOTA4NTYxOjk0ZDY4YzljY2M3Zjk5NzQzNDgwNDU3Mjg5MTY1ZTkxZjFhODQ1M2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NTk5NDk2", "url": "https://github.com/splicemachine/spliceengine/pull/3214#pullrequestreview-357599496", "createdAt": "2020-02-12T16:28:57Z", "commit": {"oid": "8324ac362ee98f567de21e49f5f74b9d3d92ebe7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNjoyODo1N1rOFo1lAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNjoyODo1N1rOFo1lAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM2NTE4NQ==", "bodyText": "You may use the expression case when 1=0 then 1 end to generate a null value.", "url": "https://github.com/splicemachine/spliceengine/pull/3214#discussion_r378365185", "createdAt": "2020-02-12T16:28:57Z", "author": {"login": "yxia92"}, "path": "splice_machine/src/test/java/com/splicemachine/db/impl/sql/compile/PredicateTupleIT.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright (c) 2012 - 2020 Splice Machine, Inc.\n+ *\n+ * This file is part of Splice Machine.\n+ * Splice Machine is free software: you can redistribute it and/or modify it under the terms of the\n+ * GNU Affero General Public License as published by the Free Software Foundation, either\n+ * version 3, or (at your option) any later version.\n+ * Splice Machine is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Affero General Public License for more details.\n+ * You should have received a copy of the GNU Affero General Public License along with Splice Machine.\n+ * If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.splicemachine.db.impl.sql.compile;\n+\n+\n+import com.splicemachine.derby.test.framework.SpliceSchemaWatcher;\n+import com.splicemachine.derby.test.framework.SpliceUnitTest;\n+import com.splicemachine.derby.test.framework.SpliceWatcher;\n+import com.splicemachine.homeless.TestUtils;\n+import org.junit.*;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.spark_project.guava.collect.Lists;\n+\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLSyntaxErrorException;\n+import java.sql.Types;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import static org.junit.Assert.*;\n+import static org.hamcrest.Matchers.containsString;\n+\n+/**\n+ * Test predicate with tuples\n+ */\n+@RunWith(Parameterized.class)\n+public class PredicateTupleIT extends SpliceUnitTest {\n+\n+    private Boolean useSpark;\n+\n+    @Parameterized.Parameters\n+    public static Collection<Object[]> data() {\n+        Collection<Object[]> params = Lists.newArrayListWithCapacity(2);\n+        params.add(new Object[]{true});\n+        params.add(new Object[]{false});\n+        return params;\n+    }\n+    private static final String SCHEMA = PredicateTupleIT.class.getSimpleName();\n+\n+    @ClassRule\n+    public static SpliceSchemaWatcher schemaWatcher = new SpliceSchemaWatcher(SCHEMA);\n+\n+    @ClassRule\n+    public static SpliceWatcher classWatcher = new SpliceWatcher(SCHEMA);\n+\n+    @Rule\n+    public SpliceWatcher methodWatcher = new SpliceWatcher(SCHEMA);\n+\n+    @BeforeClass\n+    public static void createSharedTables() throws Exception {\n+        TestUtils.executeSqlFile(classWatcher.getOrCreateConnection(), \"subquery/PredSimplTestTables.sql\", \"\");\n+    }\n+\n+    @AfterClass\n+    public static void dropUDF() throws Exception {\n+        try {\n+            TestUtils.executeSqlFile(classWatcher.getOrCreateConnection(), \"subquery/PredSimplTestCleanup.sql\", \"\");\n+        }\n+        catch (Exception e) {\n+            // Don't error out if the UDF we want to drop does not exist.\n+        }\n+    }\n+\n+    public PredicateTupleIT(Boolean useSpark) {\n+        this.useSpark = useSpark;\n+    }\n+\n+\n+    private void testQuery(String sqlText, String expected) throws Exception {\n+        ResultSet rs = null;\n+        try {\n+            rs = methodWatcher.executeQuery(sqlText);\n+            assertEquals(\"\\n\" + sqlText + \"\\n\", expected, TestUtils.FormattedResult.ResultFactory.toStringUnsorted(rs));\n+        }\n+        finally {\n+            if (rs != null)\n+                rs.close();\n+        }\n+    }\n+\n+    @Test\n+    public void testSimpleTuple() throws Exception {\n+        String query = format(\"select * from A --SPLICE-PROPERTIES useSpark=%s\\n\" +\n+                \"where (a1, a2) = (1,10)\", useSpark);\n+        String expected = \"A1 |A2 |A3  |\\n\" +\n+                \"-------------\\n\" +\n+                \" 1 |10 |100 |\";\n+\n+        testQuery(query, expected);\n+    }\n+\n+    @Ignore(\"Find a way to pass nulls inside a tuple\")\n+    @Test\n+    public void testTupleWithNulls() throws Exception {\n+        String query = format(\"select count(*) from D --splice-properties useSpark=%s\\n\" +\n+                \"where (d1,d2,d3) = (null,null,null)\", useSpark);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8324ac362ee98f567de21e49f5f74b9d3d92ebe7"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "817a62c944a3b625cafa34785c31d741891bbbe6", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/817a62c944a3b625cafa34785c31d741891bbbe6", "committedDate": "2020-02-12T23:26:30Z", "message": "DB-9140 Support tuples in predicates"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8324ac362ee98f567de21e49f5f74b9d3d92ebe7", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/8324ac362ee98f567de21e49f5f74b9d3d92ebe7", "committedDate": "2020-02-10T21:59:22Z", "message": "DB-9140 Add prepare statement test"}, "afterCommit": {"oid": "817a62c944a3b625cafa34785c31d741891bbbe6", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/817a62c944a3b625cafa34785c31d741891bbbe6", "committedDate": "2020-02-12T23:26:30Z", "message": "DB-9140 Support tuples in predicates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTk2Njc0", "url": "https://github.com/splicemachine/spliceengine/pull/3214#pullrequestreview-359196674", "createdAt": "2020-02-14T20:20:02Z", "commit": {"oid": "817a62c944a3b625cafa34785c31d741891bbbe6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTY5MzE4", "url": "https://github.com/splicemachine/spliceengine/pull/3214#pullrequestreview-360569318", "createdAt": "2020-02-18T18:25:06Z", "commit": {"oid": "817a62c944a3b625cafa34785c31d741891bbbe6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMDUxNzA4", "url": "https://github.com/splicemachine/spliceengine/pull/3214#pullrequestreview-361051708", "createdAt": "2020-02-19T11:56:01Z", "commit": {"oid": "817a62c944a3b625cafa34785c31d741891bbbe6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMTo1NjowMVrOFrlaDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMTo1NjowMVrOFrlaDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI0NTk2Ng==", "bodyText": "I don't like changing all these return types from ValueNode to QueryTreeNode, I feel like a tuple should also be a ValueNode, either by making a ValueNodeList extend a ValueNode or by introducing another node type for tuples.", "url": "https://github.com/splicemachine/spliceengine/pull/3214#discussion_r381245966", "createdAt": "2020-02-19T11:56:01Z", "author": {"login": "dgomezferro"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/sqlgrammar.jj", "diffHunk": "@@ -6821,13 +6890,14 @@ multiplicativeOperator() throws StandardException :\n /*\n  * <A NAME=\"unaryExpression\">unaryExpression</A>\n  */\n-ValueNode", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "817a62c944a3b625cafa34785c31d741891bbbe6"}, "originalPosition": 331}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac8f9d03b7afbe2e8cf951b92cdccb47f8b4dddb", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/ac8f9d03b7afbe2e8cf951b92cdccb47f8b4dddb", "committedDate": "2020-02-19T14:21:38Z", "message": "DB-9140 Remove support for le/lt/gt/ge in tuple comparison until we support lexicographical comparison"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f88faddf2cfda2f73407da043dc8ab5436dc90ac", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f88faddf2cfda2f73407da043dc8ab5436dc90ac", "committedDate": "2020-02-19T23:23:31Z", "message": "DB-9140 Introduce ValueTupleNode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNzkzMjc2", "url": "https://github.com/splicemachine/spliceengine/pull/3214#pullrequestreview-361793276", "createdAt": "2020-02-20T10:33:13Z", "commit": {"oid": "f88faddf2cfda2f73407da043dc8ab5436dc90ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTQ3MzY1", "url": "https://github.com/splicemachine/spliceengine/pull/3214#pullrequestreview-362147365", "createdAt": "2020-02-20T18:50:45Z", "commit": {"oid": "f88faddf2cfda2f73407da043dc8ab5436dc90ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxODo1MDo0NVrOFsfDXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxODo1MDo0NVrOFsfDXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE5MDQyOA==", "bodyText": "@arnaud-splice Can you move the call of valueExpression() up. valueExpression() is part of the parser rule, although eventually it will be compiled into a function of the same name, I think it is better to keep it as a parser rule and put explicitly at the top as shown below, following the tradition of all other parser rules:\nValueTupleNode\nvalueTupleElement(ValueNode tupleOrFirstValue) throws StandardException:\n{\n    ValueTupleNode  valueTuple;\n    ValueNode       newValue;\n}\n{\n    newValue = valueExpression()\n    {\n        if (tupleOrFirstValue instanceof ValueTupleNode) {\n            valueTuple = (ValueTupleNode) tupleOrFirstValue;\n        } else {\n            valueTuple = (ValueTupleNode) nodeFactory.getNode(\n                                    C_NodeTypes.VALUE_TUPLE_NODE,\n                                    getContextManager());\n            valueTuple.addValueNode((ValueNode) tupleOrFirstValue);\n        }\n\n        if (newValue instanceof ValueTupleNode) {\n            throw StandardException.newException(SQLState.LANG_SYNTAX_ERROR,\n                \"Nested tuple not supported\");\n        }\n        valueTuple.addValueNode(newValue);\n        return valueTuple;\n    }\n}", "url": "https://github.com/splicemachine/spliceengine/pull/3214#discussion_r382190428", "createdAt": "2020-02-20T18:50:45Z", "author": {"login": "yxia92"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/sqlgrammar.jj", "diffHunk": "@@ -8003,6 +8063,35 @@ valueExpressionPrimary() throws StandardException :\n     }\n }\n \n+/*\n+ * <A NAME=\"valueTupleElement\">tupleValueElement</A>\n+ */\n+ValueTupleNode\n+valueTupleElement(ValueNode tupleOrFirstValue) throws StandardException:\n+{\n+    ValueTupleNode  valueTuple;\n+    ValueNode       newValue;\n+}\n+{\n+    {\n+        if (tupleOrFirstValue instanceof ValueTupleNode) {\n+            valueTuple = (ValueTupleNode) tupleOrFirstValue;\n+        } else {\n+            valueTuple = (ValueTupleNode) nodeFactory.getNode(\n+                                    C_NodeTypes.VALUE_TUPLE_NODE,\n+                                    getContextManager());\n+            valueTuple.addValueNode((ValueNode) tupleOrFirstValue);\n+        }\n+        newValue = valueExpression();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f88faddf2cfda2f73407da043dc8ab5436dc90ac"}, "originalPosition": 220}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94d68c9ccc7f99743480457289165e91f1a8453e", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/94d68c9ccc7f99743480457289165e91f1a8453e", "committedDate": "2020-02-20T19:38:24Z", "message": "DB-9140 Address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 973, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}