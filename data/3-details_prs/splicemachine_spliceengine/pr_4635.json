{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMzYwMzA1", "number": 4635, "title": "DB-10734 expose entire row history to foreign key child interceptor", "bodyText": "When adding a row in the child table, the child-interceptor logic was making decisions about the existence of the foreign key in the parent table using latest rows' latest versions from HBase which could lead to true negatives. This behavior is corrected by letting the child-interceptor examine the entire row history of the parent keys.", "createdAt": "2020-11-17T12:07:59Z", "url": "https://github.com/splicemachine/spliceengine/pull/4635", "merged": true, "mergeCommit": {"oid": "f5088104365db9c90a89699d65219a51a7233a9b"}, "closed": true, "closedAt": "2020-11-17T18:24:33Z", "author": {"login": "hatyo"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddYYoiAH2gAyNTIyMzYwMzA1OmRiMzU4MTEwZDQ1YjEyN2E0MmIwM2EyMzQxM2MxZDkyN2M4OWZjMTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddbuLhgFqTUzMjUyMjU0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "db358110d45b127a42b03a23413c1d927c89fc14", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/db358110d45b127a42b03a23413c1d927c89fc14", "committedDate": "2020-11-17T12:05:40Z", "message": "DB-10734 expose entire row history to foreign key child interceptor."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMzkzMjA2", "url": "https://github.com/splicemachine/spliceengine/pull/4635#pullrequestreview-532393206", "createdAt": "2020-11-17T14:04:55Z", "commit": {"oid": "db358110d45b127a42b03a23413c1d927c89fc14"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNDowNDo1NVrOH02YZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNDowNDo1NVrOH02YZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE3ODk4MQ==", "bodyText": "I don't like this long pause here. Without the pause I think most of the times the next insert will happen before we have a chance to remove the rollback (specially if we have everything set up, the connection, prepared statement, etc), so I'd rather do that than introduce 30 more seconds of runtime on ITs", "url": "https://github.com/splicemachine/spliceengine/pull/4635#discussion_r525178981", "createdAt": "2020-11-17T14:04:55Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/test/java/com/splicemachine/foreignkeys/ForeignKeyCheckIT.java", "diffHunk": "@@ -706,6 +707,36 @@ public void multipleTablesReferencingSameTable() throws Exception {\n     }\n \n \n+    @Test\n+    public void rowHistoryIsReadyCorrectly() throws Exception {\n+            new TableCreator(conn)\n+                    .withCreate(\"create table P(col1 int, col2 varchar(2), col3 int, col4 int, primary key (col2, col4))\")\n+                    .withInsert(\"insert into P values(?,?,?,?)\")\n+                    .withRows(rows(row(1, \"a\", 1, 1)))\n+                    .create();\n+            new TableCreator(conn)\n+                    .withCreate(\"create table C (col1 int primary key, col2 varchar(2), col3 int, col4 int, constraint CHILD_FKEY foreign key(col2, col3) references P(col2, col4) )\")\n+                    .create();\n+            conn.commit();\n+\n+        try(Connection c = newNoAutoCommitConnection()) {\n+            c.setAutoCommit(false);\n+\n+            try (Statement statement = c.createStatement()) {\n+                statement.executeUpdate(\"update P set col1 = 42\");\n+            }\n+            Thread.sleep(30 * 1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db358110d45b127a42b03a23413c1d927c89fc14"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62ae0a6d55f66923f3a4135c7e56991cb4e33928", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/62ae0a6d55f66923f3a4135c7e56991cb4e33928", "committedDate": "2020-11-17T14:46:29Z", "message": "DB-10734 address comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNDk4NDY3", "url": "https://github.com/splicemachine/spliceengine/pull/4635#pullrequestreview-532498467", "createdAt": "2020-11-17T15:36:53Z", "commit": {"oid": "62ae0a6d55f66923f3a4135c7e56991cb4e33928"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTAzNTAz", "url": "https://github.com/splicemachine/spliceengine/pull/4635#pullrequestreview-532503503", "createdAt": "2020-11-17T15:41:40Z", "commit": {"oid": "62ae0a6d55f66923f3a4135c7e56991cb4e33928"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo0MTo0MFrOH07ftQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo0MzowM1rOH07j_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2Mjc3Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try(Connection c = newNoAutoCommitConnection()) {\n          \n          \n            \n                        c.setAutoCommit(false);\n          \n          \n            \n            \n          \n          \n            \n                        try (Statement statement = c.createStatement()) {\n          \n          \n            \n                            statement.executeUpdate(\"update P set col1 = 42\");\n          \n          \n            \n                        }\n          \n          \n            \n                        c.rollback();\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    try(Connection conn = newNoAutoCommitConnection()) {\n          \n          \n            \n                        try(Statement s = conn.createStatement()) {\n          \n          \n            \n                            s.executeUpdate(\"insert into C values (400, 'a', 1, 42)\"); // should not fail\n          \n          \n            \n                        }\n          \n          \n            \n                        conn.commit();\n          \n          \n            \n                    }\n          \n          \n            \n                    try(Connection c = newNoAutoCommitConnection();\n          \n          \n            \n                    Connection c2 = newNoAutoCommitConnection();\n          \n          \n            \n                    PreparedStatement ps = c2.preparedQuery(\"insert into C values (400, 'a', 1, 42)\")) {\n          \n          \n            \n                        c.setAutoCommit(false);\n          \n          \n            \n            \n          \n          \n            \n                        try (Statement statement = c.createStatement()) {\n          \n          \n            \n                            statement.executeUpdate(\"update P set col1 = 42\");\n          \n          \n            \n                        }\n          \n          \n            \n                        c.rollback();\n          \n          \n            \n                        \n          \n          \n            \n                        ps.executeUpdate();\n          \n          \n            \n                        c2.commit();\n          \n          \n            \n                    }", "url": "https://github.com/splicemachine/spliceengine/pull/4635#discussion_r525262773", "createdAt": "2020-11-17T15:41:40Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/test/java/com/splicemachine/foreignkeys/ForeignKeyCheckIT.java", "diffHunk": "@@ -706,6 +707,35 @@ public void multipleTablesReferencingSameTable() throws Exception {\n     }\n \n \n+    @Test\n+    public void rowHistoryIsReadyCorrectly() throws Exception {\n+            new TableCreator(conn)\n+                    .withCreate(\"create table P(col1 int, col2 varchar(2), col3 int, col4 int, primary key (col2, col4))\")\n+                    .withInsert(\"insert into P values(?,?,?,?)\")\n+                    .withRows(rows(row(1, \"a\", 1, 1)))\n+                    .create();\n+            new TableCreator(conn)\n+                    .withCreate(\"create table C (col1 int primary key, col2 varchar(2), col3 int, col4 int, constraint CHILD_FKEY foreign key(col2, col3) references P(col2, col4) )\")\n+                    .create();\n+            conn.commit();\n+\n+        try(Connection c = newNoAutoCommitConnection()) {\n+            c.setAutoCommit(false);\n+\n+            try (Statement statement = c.createStatement()) {\n+                statement.executeUpdate(\"update P set col1 = 42\");\n+            }\n+            c.rollback();\n+        }\n+\n+        try(Connection conn = newNoAutoCommitConnection()) {\n+            try(Statement s = conn.createStatement()) {\n+                s.executeUpdate(\"insert into C values (400, 'a', 1, 42)\"); // should not fail\n+            }\n+            conn.commit();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ae0a6d55f66923f3a4135c7e56991cb4e33928"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2Mzg2OA==", "bodyText": "I think something like this would be better to reduce the window of time between the rollback and the update, but as it is it looks fine to me.", "url": "https://github.com/splicemachine/spliceengine/pull/4635#discussion_r525263868", "createdAt": "2020-11-17T15:43:03Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/test/java/com/splicemachine/foreignkeys/ForeignKeyCheckIT.java", "diffHunk": "@@ -706,6 +707,35 @@ public void multipleTablesReferencingSameTable() throws Exception {\n     }\n \n \n+    @Test\n+    public void rowHistoryIsReadyCorrectly() throws Exception {\n+            new TableCreator(conn)\n+                    .withCreate(\"create table P(col1 int, col2 varchar(2), col3 int, col4 int, primary key (col2, col4))\")\n+                    .withInsert(\"insert into P values(?,?,?,?)\")\n+                    .withRows(rows(row(1, \"a\", 1, 1)))\n+                    .create();\n+            new TableCreator(conn)\n+                    .withCreate(\"create table C (col1 int primary key, col2 varchar(2), col3 int, col4 int, constraint CHILD_FKEY foreign key(col2, col3) references P(col2, col4) )\")\n+                    .create();\n+            conn.commit();\n+\n+        try(Connection c = newNoAutoCommitConnection()) {\n+            c.setAutoCommit(false);\n+\n+            try (Statement statement = c.createStatement()) {\n+                statement.executeUpdate(\"update P set col1 = 42\");\n+            }\n+            c.rollback();\n+        }\n+\n+        try(Connection conn = newNoAutoCommitConnection()) {\n+            try(Statement s = conn.createStatement()) {\n+                s.executeUpdate(\"insert into C values (400, 'a', 1, 42)\"); // should not fail\n+            }\n+            conn.commit();\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2Mjc3Mw=="}, "originalCommit": {"oid": "62ae0a6d55f66923f3a4135c7e56991cb4e33928"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTE5NTg4", "url": "https://github.com/splicemachine/spliceengine/pull/4635#pullrequestreview-532519588", "createdAt": "2020-11-17T15:56:09Z", "commit": {"oid": "62ae0a6d55f66923f3a4135c7e56991cb4e33928"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo1NjowOVrOH08O5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNTo1NjowOVrOH08O5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3NDg1NQ==", "bodyText": "setAutoCommit(false) is redundant", "url": "https://github.com/splicemachine/spliceengine/pull/4635#discussion_r525274855", "createdAt": "2020-11-17T15:56:09Z", "author": {"login": "arnaud-splice"}, "path": "splice_machine/src/test/java/com/splicemachine/foreignkeys/ForeignKeyCheckIT.java", "diffHunk": "@@ -706,6 +707,35 @@ public void multipleTablesReferencingSameTable() throws Exception {\n     }\n \n \n+    @Test\n+    public void rowHistoryIsReadyCorrectly() throws Exception {\n+            new TableCreator(conn)\n+                    .withCreate(\"create table P(col1 int, col2 varchar(2), col3 int, col4 int, primary key (col2, col4))\")\n+                    .withInsert(\"insert into P values(?,?,?,?)\")\n+                    .withRows(rows(row(1, \"a\", 1, 1)))\n+                    .create();\n+            new TableCreator(conn)\n+                    .withCreate(\"create table C (col1 int primary key, col2 varchar(2), col3 int, col4 int, constraint CHILD_FKEY foreign key(col2, col3) references P(col2, col4) )\")\n+                    .create();\n+            conn.commit();\n+\n+        try(Connection c = newNoAutoCommitConnection()) {\n+            c.setAutoCommit(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ae0a6d55f66923f3a4135c7e56991cb4e33928"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTIyNTQx", "url": "https://github.com/splicemachine/spliceengine/pull/4635#pullrequestreview-532522541", "createdAt": "2020-11-17T15:58:55Z", "commit": {"oid": "62ae0a6d55f66923f3a4135c7e56991cb4e33928"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1056, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}