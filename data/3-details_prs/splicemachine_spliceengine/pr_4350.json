{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MzU4MzY0", "number": 4350, "title": "DB-10562 Refactor SpliceTransactionResourceImpl.getMarshallTransaction ", "bodyText": "", "createdAt": "2020-10-22T15:00:40Z", "url": "https://github.com/splicemachine/spliceengine/pull/4350", "merged": true, "mergeCommit": {"oid": "ce0761c0bff527eed2a72b2930d63a2b12d12e7d"}, "closed": true, "closedAt": "2020-11-04T16:51:06Z", "author": {"login": "arnaud-splice"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVDPLGAH2gAyNTA4MzU4MzY0OjQ2YWEyZDI5Njk5OGEzOTMzOThhMjA0ZTRkZmYzM2QwNjY3NjIwNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY7X5TgFqTUyMjY0NTU2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "46aa2d296998a393398a204e4dff33d06676204a", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/46aa2d296998a393398a204e4dff33d06676204a", "committedDate": "2020-10-22T14:55:56Z", "message": "DB-10562 Refactor SpliceTransactionResourceImpl.getMarshallTransaction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTMxNTc1", "url": "https://github.com/splicemachine/spliceengine/pull/4350#pullrequestreview-517531575", "createdAt": "2020-10-27T10:06:14Z", "commit": {"oid": "46aa2d296998a393398a204e4dff33d06676204a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTQ2MDg1", "url": "https://github.com/splicemachine/spliceengine/pull/4350#pullrequestreview-517546085", "createdAt": "2020-10-27T10:23:50Z", "commit": {"oid": "46aa2d296998a393398a204e4dff33d06676204a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDoyMzo1MFrOHo02Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDoyMzo1MFrOHo02Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MDkwNw==", "bodyText": "Returning the LCC here seems wrong. Rework that class a bit to not have to return a LCC whose contextmanager got closed", "url": "https://github.com/splicemachine/spliceengine/pull/4350#discussion_r512570907", "createdAt": "2020-10-27T10:23:50Z", "author": {"login": "arnaud-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/index/IndexTransformer.java", "diffHunk": "@@ -707,18 +707,12 @@ public int getMaxBaseColumnPosition() {\n     }\n \n     private LanguageConnectionContext getLcc(DDLMessage.TentativeIndex tentativeIndex) throws StandardException {\n-        boolean prepared = false;\n-        SpliceTransactionResourceImpl transactionResource = null;\n-        try {\n-            TxnView txn = DDLUtils.getLazyTransaction(tentativeIndex.getTxnId());\n-            transactionResource = new SpliceTransactionResourceImpl();\n-            prepared = transactionResource.marshallTransaction(txn);\n+        TxnView txn = DDLUtils.getLazyTransaction(tentativeIndex.getTxnId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46aa2d296998a393398a204e4dff33d06676204a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTQwNjgz", "url": "https://github.com/splicemachine/spliceengine/pull/4350#pullrequestreview-517540683", "createdAt": "2020-10-27T10:17:04Z", "commit": {"oid": "46aa2d296998a393398a204e4dff33d06676204a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDoxNzowNFrOHo0lfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDoyNToyOFrOHo06UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU2NjY1NQ==", "bodyText": "Looks like an additional logic besides refactoring right? Could you explain why this is necessary?", "url": "https://github.com/splicemachine/spliceengine/pull/4350#discussion_r512566655", "createdAt": "2020-10-27T10:17:04Z", "author": {"login": "hatyo"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/ddl/DDLUtils.java", "diffHunk": "@@ -376,36 +367,45 @@ public static void preAlterStats(DDLMessage.DDLChange change, DataDictionary dd,\n     public static void preDropSchema(DDLMessage.DDLChange change, DataDictionary dd, DependencyManager dm) throws StandardException {\n         if (LOG.isDebugEnabled())\n             SpliceLogUtils.debug(LOG,\"preDropSchema with change=%s\",change);\n-        dd.getDataDictionaryCache().schemaCacheRemove(change.getDropSchema().getSchemaName());\n-        dd.getDataDictionaryCache().oidSchemaCacheRemove(ProtoUtil.getDerbyUUID(change.getDropSchema().getSchemaUUID()));\n+        DDLMessage.DropSchema dropSchema = change.getDropSchema();\n+        UUID schemaId = ProtoUtil.getDerbyUUID(dropSchema.getSchemaUUID());\n+        try {\n+            try (SpliceTransactionResourceImpl transactionResource = new SpliceTransactionResourceImpl()) {\n+                TxnView txn = DDLUtils.getLazyTransaction(change.getTxnId());\n+                transactionResource.marshallTransaction(txn);\n+                SchemaDescriptor sd = dd.getSchemaDescriptor(schemaId, transactionResource.getLcc().getTransactionExecute());\n+                if(sd==null) // Schema Descriptor transaction never committed\n+                    return;\n+                dm.invalidateFor(sd,DependencyManager.DROP_SCHEMA,transactionResource.getLcc());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46aa2d296998a393398a204e4dff33d06676204a"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MTk4NQ==", "bodyText": "the method sets the updated to true and is public, so it is possible that it is called twice from the outside (which was permissible in the previous version)\nI think it is better to return immediately and maybe issue a log.WARN(\"unexpected\") or even throw an exception.\nI would also add more documentation about the intended usage of this method, and mark the class SpliceTransactionResourceImpl as thread-unsafe.", "url": "https://github.com/splicemachine/spliceengine/pull/4350#discussion_r512571985", "createdAt": "2020-10-27T10:25:28Z", "author": {"login": "hatyo"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/jdbc/SpliceTransactionResourceImpl.java", "diffHunk": "@@ -79,17 +80,17 @@ public SpliceTransactionResourceImpl(String url,Properties info) throws SQLExcep\n         }\n     }\n \n-    public boolean marshallTransaction(TxnView txn) throws StandardException, SQLException {\n-        return this.marshallTransaction(txn, null);\n+    public void marshallTransaction(TxnView txn) throws StandardException, SQLException {\n+        this.marshallTransaction(txn, null);\n     }\n \n-    public boolean marshallTransaction(TxnView txn, ManagedCache<String, Optional<String>> propertyCache) throws StandardException, SQLException {\n-        return this.marshallTransaction(txn, propertyCache, null, null, null);\n+    public void marshallTransaction(TxnView txn, ManagedCache<String, Optional<String>> propertyCache) throws StandardException, SQLException {\n+        this.marshallTransaction(txn, propertyCache, null, null, null);\n     }\n \n-    public boolean marshallTransaction(TxnView txn, ManagedCache<String, Optional<String>> propertyCache,\n+    public void marshallTransaction(TxnView txn, ManagedCache<String, Optional<String>> propertyCache,\n                                        TransactionController reuseTC, String localUserName, Integer sessionNumber) throws StandardException, SQLException{\n-        boolean updated = false;\n+        assert !updated;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46aa2d296998a393398a204e4dff33d06676204a"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2944fe6b4e8d59c694917f7d409346d1a5e0c770", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2944fe6b4e8d59c694917f7d409346d1a5e0c770", "committedDate": "2020-10-27T16:01:02Z", "message": "DB-10562 Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODk5MDkx", "url": "https://github.com/splicemachine/spliceengine/pull/4350#pullrequestreview-517899091", "createdAt": "2020-10-27T16:23:31Z", "commit": {"oid": "2944fe6b4e8d59c694917f7d409346d1a5e0c770"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDk5NjIx", "url": "https://github.com/splicemachine/spliceengine/pull/4350#pullrequestreview-518099621", "createdAt": "2020-10-27T20:06:57Z", "commit": {"oid": "2944fe6b4e8d59c694917f7d409346d1a5e0c770"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMDowNjo1N1rOHpO2yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMDowNjo1N1rOHpO2yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk5NzA2Nw==", "bodyText": "lcc is only used in getExecutableIndexExpression(). You can refactor to marshall transactions there only when it is being used", "url": "https://github.com/splicemachine/spliceengine/pull/4350#discussion_r512997067", "createdAt": "2020-10-27T20:06:57Z", "author": {"login": "jyuanca"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/index/IndexTransformer.java", "diffHunk": "@@ -707,18 +707,12 @@ public int getMaxBaseColumnPosition() {\n     }\n \n     private LanguageConnectionContext getLcc(DDLMessage.TentativeIndex tentativeIndex) throws StandardException {\n-        boolean prepared = false;\n-        SpliceTransactionResourceImpl transactionResource = null;\n-        try {\n-            TxnView txn = DDLUtils.getLazyTransaction(tentativeIndex.getTxnId());\n-            transactionResource = new SpliceTransactionResourceImpl();\n-            prepared = transactionResource.marshallTransaction(txn);\n+        TxnView txn = DDLUtils.getLazyTransaction(tentativeIndex.getTxnId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU3MDkwNw=="}, "originalCommit": {"oid": "46aa2d296998a393398a204e4dff33d06676204a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjQ1NTY4", "url": "https://github.com/splicemachine/spliceengine/pull/4350#pullrequestreview-522645568", "createdAt": "2020-11-03T16:01:55Z", "commit": {"oid": "2944fe6b4e8d59c694917f7d409346d1a5e0c770"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1116, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}