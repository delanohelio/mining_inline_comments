{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczMTI2MDI2", "number": 4046, "title": "DB-9749 sync user roles before running remote queries.", "bodyText": "Previously, certain code paths that run remote jobs such as ASQ where getting the user roles as-is from the current SQL session context. Problem is, the retrieved list of roles is not kept up to date, meaning if the DBA revoked some roles from the user running ASQ, it wouldn't have any effect since the list of roles is not updated and the revoked role is not removed from it.\nWith this fix, we always refresh the list of roles before retrieving it.\nI chose not to make refresh logic part of LanguageConnectionContext.getCurrentRoles as it might affect performance since it is used in many other locations that does proper cleansing of the role list already.", "createdAt": "2020-08-25T11:10:00Z", "url": "https://github.com/splicemachine/spliceengine/pull/4046", "merged": true, "mergeCommit": {"oid": "af1d26be45cca4ed31ddbdf899a3412489fe983a"}, "closed": true, "closedAt": "2020-08-26T22:54:50Z", "author": {"login": "hatyo"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCVAKWAH2gAyNDczMTI2MDI2OjU1MzY1Yzk5NjY5NjliZmZhZjdhMGRhOTA3OWQyZWUzNWM0MDdhYzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCnIGrAFqTQ3NTI0NDI0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "55365c9966969bffaf7a0da9079d2ee35c407ac0", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/55365c9966969bffaf7a0da9079d2ee35c407ac0", "committedDate": "2020-08-25T10:53:16Z", "message": "DB-9749 sync user roles before running remote queries."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NDAzNjY5", "url": "https://github.com/splicemachine/spliceengine/pull/4046#pullrequestreview-474403669", "createdAt": "2020-08-25T11:51:49Z", "commit": {"oid": "55365c9966969bffaf7a0da9079d2ee35c407ac0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NDM2ODgz", "url": "https://github.com/splicemachine/spliceengine/pull/4046#pullrequestreview-474436883", "createdAt": "2020-08-25T12:37:53Z", "commit": {"oid": "55365c9966969bffaf7a0da9079d2ee35c407ac0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NjI5MjUw", "url": "https://github.com/splicemachine/spliceengine/pull/4046#pullrequestreview-474629250", "createdAt": "2020-08-25T16:02:23Z", "commit": {"oid": "55365c9966969bffaf7a0da9079d2ee35c407ac0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowMjoyM1rOHGfC1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNjowMjoyM1rOHGfC1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU2MjEzNQ==", "bodyText": "We can skip the check of roles if user is database owner or he/belong to the admin group, and use the requestedQueue directly.", "url": "https://github.com/splicemachine/spliceengine/pull/4046#discussion_r476562135", "createdAt": "2020-08-25T16:02:23Z", "author": {"login": "yxia92"}, "path": "hbase_sql/src/main/java/com/splicemachine/stream/RemoteQueryClientImpl.java", "diffHunk": "@@ -122,6 +122,8 @@ public void submit() throws StandardException {\n                     streamingBatches, streamingBatchSize, parallelPartitions, shufflePartitionsProperty);\n \n             String requestedQueue = (String) activation.getLanguageConnectionContext().getSessionProperties().getProperty(SessionProperties.PROPERTYNAME.OLAPQUEUE);\n+            // remove any stale revoked roles (DB-9749)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55365c9966969bffaf7a0da9079d2ee35c407ac0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cbb514e24bc0e51855a23ee61a54ea3c5452770", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/4cbb514e24bc0e51855a23ee61a54ea3c5452770", "committedDate": "2020-08-25T18:02:23Z", "message": "DB-9749 avoid checking role for admin users.\n\n- refreshing roles could be an expensive operation. Since database\n  owner has all permissions, no need to check role checking, either\n  directly use the rqeuested queue, or fallback to default one if\n  the requested queue is null."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8c3493254738963f164370f4d8bb70b04fb9be1", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/b8c3493254738963f164370f4d8bb70b04fb9be1", "committedDate": "2020-08-25T18:15:53Z", "message": "DB-9749 Strengthen DBO check.\n\n- check not only whether the user is DBO, but also whether the user\n  is part of a DBO user group."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzU0MDI1", "url": "https://github.com/splicemachine/spliceengine/pull/4046#pullrequestreview-474754025", "createdAt": "2020-08-25T18:40:55Z", "commit": {"oid": "b8c3493254738963f164370f4d8bb70b04fb9be1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MjQ0MjQ0", "url": "https://github.com/splicemachine/spliceengine/pull/4046#pullrequestreview-475244244", "createdAt": "2020-08-26T08:00:14Z", "commit": {"oid": "b8c3493254738963f164370f4d8bb70b04fb9be1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1188, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}