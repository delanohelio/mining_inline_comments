{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5Mjg1Njc4", "number": 3247, "title": "DB-9176 Implement nested ContextManagers + DB-8883", "bodyText": "ContextManagers can now be nested: if a ContextManager is created with a parent ContextManager, all pushContext/popContext operations will still be performed on the current ContextManager but getContext will delegate to parent ContextManager (potentially owned by another thread but assumed unmodified until all parallel operations finish).\nSpliceTransactionManager.startNestedUserTransaction() is the only place where the new mechanism is used (ensuring that parallel trigger execution introduced by DB-8883 is thread safe).", "createdAt": "2020-02-24T23:35:10Z", "url": "https://github.com/splicemachine/spliceengine/pull/3247", "merged": true, "mergeCommit": {"oid": "0148a0af3053c7224deb1d7bdb459c9065d70133"}, "closed": true, "closedAt": "2020-03-19T01:36:12Z", "author": {"login": "OlegMazurov"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGT7t1gH2gAyMzc5Mjg1Njc4OjMwZWRmZDc4NmZiN2ZkOWVmZjc5Y2RlZjAzYjUwYWZkM2Q0ZjQzNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO_dSjAH2gAyMzc5Mjg1Njc4OjlkNGRjMzQ0OGY5YzU2M2FhNDMxMjBlMjBjN2IyOTgzMmU4OTUyZWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30edfd786fb7fd9eff79cdef03b50afd3d4f4363", "author": {"user": {"login": "OlegMazurov", "name": "Oleg Mazurov"}}, "url": "https://github.com/splicemachine/spliceengine/commit/30edfd786fb7fd9eff79cdef03b50afd3d4f4363", "committedDate": "2020-02-20T23:43:03Z", "message": "DB-9176 Implement nested ContextManagers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f73a1564e7541add435de8faf4282de30fccfe7a", "author": {"user": {"login": "OlegMazurov", "name": "Oleg Mazurov"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f73a1564e7541add435de8faf4282de30fccfe7a", "committedDate": "2020-02-21T02:51:45Z", "message": "DB-8883 Referencing clause for statement triggers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7c40fc1818b6b4ca5e10348c91ddb44d3ddfcde", "author": {"user": {"login": "OlegMazurov", "name": "Oleg Mazurov"}}, "url": "https://github.com/splicemachine/spliceengine/commit/a7c40fc1818b6b4ca5e10348c91ddb44d3ddfcde", "committedDate": "2020-02-22T00:46:27Z", "message": "Reset ContextManager in nested SpliceTransactionManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d447cc0e7a64b7b102eb1f21afc6bab0aea7a070", "author": {"user": {"login": "OlegMazurov", "name": "Oleg Mazurov"}}, "url": "https://github.com/splicemachine/spliceengine/commit/d447cc0e7a64b7b102eb1f21afc6bab0aea7a070", "committedDate": "2020-02-24T22:49:11Z", "message": "fixed IndexOutOfBoundsException in ContextManager.cleanupOnError()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69d2fd3b0ab65b34716d03a00366f0a0398698f8", "author": {"user": {"login": "OlegMazurov", "name": "Oleg Mazurov"}}, "url": "https://github.com/splicemachine/spliceengine/commit/69d2fd3b0ab65b34716d03a00366f0a0398698f8", "committedDate": "2020-03-02T18:14:13Z", "message": "Merge branch 'master' of https://github.com/splicemachine/spliceengine into DB-9176"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDI2ODYz", "url": "https://github.com/splicemachine/spliceengine/pull/3247#pullrequestreview-373426863", "createdAt": "2020-03-12T10:15:23Z", "commit": {"oid": "69d2fd3b0ab65b34716d03a00366f0a0398698f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1ODg0NTMx", "url": "https://github.com/splicemachine/spliceengine/pull/3247#pullrequestreview-375884531", "createdAt": "2020-03-17T09:55:37Z", "commit": {"oid": "30edfd786fb7fd9eff79cdef03b50afd3d4f4363"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwOTo1NTozOFrOF3VCeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMDoxMDoyN1rOF3Vjkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2MDY5OA==", "bodyText": "I think a while() loop would be a bit clearer, but it's nitpicking.", "url": "https://github.com/splicemachine/spliceengine/pull/3247#discussion_r393560698", "createdAt": "2020-03-17T09:55:38Z", "author": {"login": "dgomezferro"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/services/context/ContextManager.java", "diffHunk": "@@ -234,14 +246,23 @@ public final boolean isEmpty()\n \t * being traversed.\n \t * @param contextId the type of Context stack to return.\n \t * @return an unmodifiable \"view\" of the ArrayList backing the stack\n-\t * @see org.apache.derby.impl.sql.conn.GenericLanguageConnectionContext#resetSavepoints()\n \t * @see com.splicemachine.db.iapi.sql.conn.StatementContext#resetSavePoint()\n \t */\n \tpublic final List<Context> getContextStack(String contextId) {\n-\t\tfinal CtxStack cs = ctxTable.get(contextId);\n-\t\treturn (cs==null?Collections.EMPTY_LIST:cs.getUnmodifiableList());\n+\t\tList<Context> contexts= new ArrayList<>();\n+\t\tfor (ContextManager cm = this; cm != null; cm = cm.parent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30edfd786fb7fd9eff79cdef03b50afd3d4f4363"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU2OTE3MA==", "bodyText": "@OlegMazurov Do you think there's a chance of simplifying this now that we support nested context managers? Here's Mark's comment from the previous PR:\nYes it is messy. The ContextManager doesn't seem well designed for threading. The ExecutionStmtValidator is required to detect if we're doing DDL on a trigger table. The TriggerExecutionContext is required to be in both the LCC of the Activation and of the active ContextManager for proper trigger execution. A lot of the time the Activation and the ContextManager share the same LCC, which is what we want. But sometimes the ContextManager's LCC is pushed in someplace unexpected and we end up with a mismatch. I think the whole ContextManager logic should probably be revisited and maybe rewritten. I had tried some things to add more synchronization or use different data structures, e.g. ConcurrentHashMap in place of HashMap, but that either caused the database to run too slowly or caused hangs or other failures.", "url": "https://github.com/splicemachine/spliceengine/pull/3247#discussion_r393569170", "createdAt": "2020-03-17T10:10:27Z", "author": {"login": "dgomezferro"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/execute/TriggerEventActivator.java", "diffHunk": "@@ -31,49 +31,78 @@\n \n package com.splicemachine.db.impl.sql.execute;\n \n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Vector;\n-\n import com.splicemachine.db.catalog.UUID;\n import com.splicemachine.db.iapi.error.StandardException;\n+import com.splicemachine.db.iapi.jdbc.ConnectionContext;\n+import com.splicemachine.db.iapi.services.context.ContextService;\n import com.splicemachine.db.iapi.services.io.FormatableBitSet;\n import com.splicemachine.db.iapi.sql.Activation;\n+import com.splicemachine.db.iapi.sql.conn.ConnectionUtil;\n import com.splicemachine.db.iapi.sql.conn.LanguageConnectionContext;\n import com.splicemachine.db.iapi.sql.conn.StatementContext;\n import com.splicemachine.db.iapi.sql.dictionary.TriggerDescriptor;\n import com.splicemachine.db.iapi.sql.execute.CursorResultSet;\n \n+import java.sql.SQLException;\n+import java.util.*;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Future;\n+import java.util.function.Function;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import static com.splicemachine.db.impl.sql.execute.TriggerExecutionContext.pushLanguageConnectionContextToCM;\n+\n /**\n  * Responsible for firing a trigger or set of triggers based on an event.\n  */\n public class TriggerEventActivator {\n \n-    private LanguageConnectionContext lcc;\n     private TriggerInfo triggerInfo;\n     private TriggerExecutionContext tec;\n     private Map<TriggerEvent, List<GenericTriggerExecutor>> statementExecutorsMap = new HashMap<>();\n-    private Map<TriggerEvent, List<GenericTriggerExecutor>> rowExecutorsMap = new HashMap<>();\n+    private Map<TriggerEvent, List<TriggerDescriptor>> rowExecutorsMap = new HashMap<>();\n+    private Map<TriggerEvent, List<TriggerDescriptor>> rowConcurrentExecutorsMap = new HashMap<>();\n     private Activation activation;\n+    private ConnectionContext connectionContext;\n     private String statementText;\n     private UUID tableId;\n     private String tableName;\n-    private boolean tecPushed;\n+    private boolean triggerExecutionContextPushed;\n+    private boolean executionStmtValidatorPushed;\n+\n+    // getLcc() may return a different LanguageConnectionContext at the time\n+    // we pop the triggerExecutionContext and executionStmtValidator, versus\n+    // at the time they were pushed.  Saving the original \"LCC\" at the time of\n+    // the push ensures that we pop from the correct LCC.  We sometimes need to\n+    // save two versions LCCs because we may push to the LCC in the activation,\n+    // and also to the LCC stored in the current ContextManager, if they happen\n+    // to be different.  Trigger execution requires that both the activation and\n+    // the current ContextManager both have a triggerExecutionContext.\n+    private LanguageConnectionContext esvLCC1;\n+    private LanguageConnectionContext esvLCC2;\n+    private LanguageConnectionContext tecLCC1;\n+    private LanguageConnectionContext tecLCC2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f73a1564e7541add435de8faf4282de30fccfe7a"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d4dc3448f9c563aa43120e20c7b29832e8952ef", "author": {"user": {"login": "OlegMazurov", "name": "Oleg Mazurov"}}, "url": "https://github.com/splicemachine/spliceengine/commit/9d4dc3448f9c563aa43120e20c7b29832e8952ef", "committedDate": "2020-03-18T22:57:02Z", "message": "Merge branch 'master' of https://github.com/splicemachine/spliceengine into DB-9176"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1412, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}