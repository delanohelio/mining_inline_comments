{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4ODIyNDA0", "number": 3994, "title": "DB-9554 check for cancellation requests during long-running compactions.", "bodyText": "", "createdAt": "2020-08-17T13:10:48Z", "url": "https://github.com/splicemachine/spliceengine/pull/3994", "merged": true, "mergeCommit": {"oid": "c64ba0d1f737d4e4fa6ad5cf2471638e93021dae"}, "closed": true, "closedAt": "2020-08-20T17:05:48Z", "author": {"login": "hatyo"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-2lVDAH2gAyNDY4ODIyNDA0OmQ3MjZiMjhkMjUyN2FkMjJkZjkzY2MxNzI2OTNlYzNmODhlNGFlMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAq-9agH2gAyNDY4ODIyNDA0OjIwMDE4ZDc5NWM5NzVlMmE5MjNhZDA5NTgzMjYwNWFmYmZiYmQ4ZGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d726b28d2527ad22df93cc172693ec3f88e4ae2f", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/d726b28d2527ad22df93cc172693ec3f88e4ae2f", "committedDate": "2020-08-14T15:45:02Z", "message": "DB-9554 reactivate compaction-cancellation check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "449de3e7b902426d2f6c0c94078453047ec74586", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/449de3e7b902426d2f6c0c94078453047ec74586", "committedDate": "2020-08-17T09:50:48Z", "message": "DB-9554 refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72e21ccfbad8d51fc232bf72eb37f4425ad82bd7", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/72e21ccfbad8d51fc232bf72eb37f4425ad82bd7", "committedDate": "2020-08-17T13:04:05Z", "message": "DB-9554 calculate size of input in SICompationState.\n\n- Size of input cells is calculated in SICompactionState and propagated\n  to upper layers.\n- SpliceDefaultCompactor checks if an AbstractSICompactionScanner is\n  used for actual compaction, if so, it queries it for the actual input\n  cells' size for more accurate compaction cancellation check.\n- Add test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDYwMzAx", "url": "https://github.com/splicemachine/spliceengine/pull/3994#pullrequestreview-468460301", "createdAt": "2020-08-17T13:26:07Z", "commit": {"oid": "72e21ccfbad8d51fc232bf72eb37f4425ad82bd7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMzoyNjowN1rOHBoqGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMzoyNjowN1rOHBoqGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQ3Njc2Mg==", "bodyText": "This might always return false when running in Spark, can you verify that?", "url": "https://github.com/splicemachine/spliceengine/pull/3994#discussion_r471476762", "createdAt": "2020-08-17T13:26:07Z", "author": {"login": "dgomezferro"}, "path": "hbase_sql/src/main/java/com/splicemachine/compactions/SpliceDefaultCompactor.java", "diffHunk": "@@ -453,19 +458,20 @@ protected boolean performCompaction(Compactor.FileDetails fd, InternalScanner sc\n                 if (closeCheckInterval > 0) {\n                     bytesWritten += len;\n                     if (bytesWritten > closeCheckInterval) {\n-                        bytesWritten = 0;\n-//                        if (!store.areWritesEnabled()) {\n-//                            progress.cancel();\n-//                            return false;\n-//                        }\n+                        bytesWritten = 0; // reset so check whether cancellation is requested in the next\n+                                          // <closeCheckInterval>-bytes mark\n+                        if (!store.areWritesEnabled()) { // this call could be expensive.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72e21ccfbad8d51fc232bf72eb37f4425ad82bd7"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61f40d3154321bb8e13ac8fbdf4d98048e11612", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/b61f40d3154321bb8e13ac8fbdf4d98048e11612", "committedDate": "2020-08-17T16:05:57Z", "message": "DB-9554 check compaction cancellation only when running in HBase."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da46105a0ccc7e85eb4467311bd5c0c49754f57b", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/da46105a0ccc7e85eb4467311bd5c0c49754f57b", "committedDate": "2020-08-17T16:04:50Z", "message": "DB-9554 check compaction cancellation only when running in HBase."}, "afterCommit": {"oid": "b61f40d3154321bb8e13ac8fbdf4d98048e11612", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/b61f40d3154321bb8e13ac8fbdf4d98048e11612", "committedDate": "2020-08-17T16:05:57Z", "message": "DB-9554 check compaction cancellation only when running in HBase."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83877ab26dc125feedbac542d357f09c85298c4a", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/83877ab26dc125feedbac542d357f09c85298c4a", "committedDate": "2020-08-17T17:26:24Z", "message": "DB-9554 add compaction cancellation checks to Spark jobs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e4e353d8a9843856490ea7a5a35c5a383d479e5", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/6e4e353d8a9843856490ea7a5a35c5a383d479e5", "committedDate": "2020-08-17T18:21:23Z", "message": "DB-9554 restructure cancellation logic."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MTU1OTQ1", "url": "https://github.com/splicemachine/spliceengine/pull/3994#pullrequestreview-469155945", "createdAt": "2020-08-18T09:33:48Z", "commit": {"oid": "6e4e353d8a9843856490ea7a5a35c5a383d479e5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOTozMzo0OFrOHCLeHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOTo0MjoxMVrOHCLxEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA0NzEzNA==", "bodyText": "Setting isSpark here is redundant", "url": "https://github.com/splicemachine/spliceengine/pull/3994#discussion_r472047134", "createdAt": "2020-08-18T09:33:48Z", "author": {"login": "arnaud-splice"}, "path": "hbase_sql/src/main/java/com/splicemachine/compactions/SpliceDefaultCompactor.java", "diffHunk": "@@ -115,14 +116,16 @@ public SpliceDefaultCompactor(final Configuration conf, final Store store, long\n     @SuppressFBWarnings(value=\"ST_WRITE_TO_STATIC_FROM_INSTANCE_METHOD\", justification=\"static attribute hostname is set from here\")\n     public List<Path> compact(CompactionRequestImpl request, ThroughputController throughputController, User user) throws IOException {\n         assert request instanceof SpliceCompactionRequest;\n+        SpliceCompactionRequest spliceRequest = (SpliceCompactionRequest)request;\n         // Used if we cannot compact in Spark\n-        ((SpliceCompactionRequest) request).setPurgeConfig(buildPurgeConfig(request));\n+        spliceRequest.setPurgeConfig(buildPurgeConfig(request));\n \n-        if(!allowSpark || store.getRegionInfo().getTable().isSystemTable())\n+        if(!allowSpark || store.getRegionInfo().getTable().isSystemTable()) {\n+            isSpark = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4e353d8a9843856490ea7a5a35c5a383d479e5"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MTIwNw==", "bodyText": "Call to toString is redundant, isn't it?", "url": "https://github.com/splicemachine/spliceengine/pull/3994#discussion_r472051207", "createdAt": "2020-08-18T09:40:48Z", "author": {"login": "arnaud-splice"}, "path": "hbase_sql/src/main/java/com/splicemachine/compactions/SpliceDefaultCompactor.java", "diffHunk": "@@ -453,19 +462,19 @@ protected boolean performCompaction(Compactor.FileDetails fd, InternalScanner sc\n                 if (closeCheckInterval > 0) {\n                     bytesWritten += len;\n                     if (bytesWritten > closeCheckInterval) {\n-                        bytesWritten = 0;\n-//                        if (!store.areWritesEnabled()) {\n-//                            progress.cancel();\n-//                            return false;\n-//                        }\n+                        bytesWritten = 0; // reset so check whether cancellation is requested in the next <closeCheckInterval>-bytes mark\n+                        if ((isSpark && TaskContext.get().isInterrupted()) || (!isSpark && !store.areWritesEnabled())) {\n+                            SpliceLogUtils.debug(LOG, \"Compaction cancelled\");\n+                            progress.cancel();\n+                            return false;\n+                        }\n                     }\n                 }\n             }\n-            // Log the progress of long running compactions every minute if\n-            // logging at DEBUG level\n+            // Log the progress of long-running compactions every minute if logging at DEBUG level\n             if (LOG.isDebugEnabled()) {\n                 if ((now - lastMillis) >= 60 * 1000) {\n-                    LOG.debug(\"Compaction progress: \" + progress + String.format(\", rate=%.2f kB/sec\",\n+                    LOG.debug(String.format(\"Compaction progress: %s, rate=%.2f kB/sec\", progress.toString(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4e353d8a9843856490ea7a5a35c5a383d479e5"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MTk4Ng==", "bodyText": "I suggest renaming size to numberOfScannedBytes or something like this. The size of a scanner is a bit vague.", "url": "https://github.com/splicemachine/spliceengine/pull/3994#discussion_r472051986", "createdAt": "2020-08-18T09:42:11Z", "author": {"login": "arnaud-splice"}, "path": "hbase_storage/src/main/java/com/splicemachine/si/impl/server/AbstractSICompactionScanner.java", "diffHunk": "@@ -107,6 +109,10 @@ public boolean next(List<Cell> list) throws IOException {\n         }\n     }\n \n+    public long getSize() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4e353d8a9843856490ea7a5a35c5a383d479e5"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "952d6c2df34cc764be036af98978273dcb1248d5", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/952d6c2df34cc764be036af98978273dcb1248d5", "committedDate": "2020-08-18T15:40:12Z", "message": "DB-9554 address comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab52a7c7aa4b854f33159f8174ed474fc9e77d83", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/ab52a7c7aa4b854f33159f8174ed474fc9e77d83", "committedDate": "2020-08-18T15:40:32Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9554"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bf2f086e27b9927b4c454f7335e40b1cf549e5d", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/8bf2f086e27b9927b4c454f7335e40b1cf549e5d", "committedDate": "2020-08-18T16:31:01Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9554"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5OTA3NDEy", "url": "https://github.com/splicemachine/spliceengine/pull/3994#pullrequestreview-469907412", "createdAt": "2020-08-19T00:00:08Z", "commit": {"oid": "8bf2f086e27b9927b4c454f7335e40b1cf549e5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMjQ3MjU0", "url": "https://github.com/splicemachine/spliceengine/pull/3994#pullrequestreview-470247254", "createdAt": "2020-08-19T08:43:02Z", "commit": {"oid": "8bf2f086e27b9927b4c454f7335e40b1cf549e5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjExNTQ4", "url": "https://github.com/splicemachine/spliceengine/pull/3994#pullrequestreview-471211548", "createdAt": "2020-08-20T04:38:01Z", "commit": {"oid": "8bf2f086e27b9927b4c454f7335e40b1cf549e5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20018d795c975e2a923ad095832605afbfbbd8da", "author": {"user": {"login": "hatyo", "name": "Youssef Hatem"}}, "url": "https://github.com/splicemachine/spliceengine/commit/20018d795c975e2a923ad095832605afbfbbd8da", "committedDate": "2020-08-20T07:22:01Z", "message": "Merge remote-tracking branch 'origin/master' into DB-9554"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1178, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}