{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2ODczOTA2", "number": 4505, "title": "DB-10678 Modify accepted params for [VAR]CHAR function ", "bodyText": "", "createdAt": "2020-11-06T17:08:52Z", "url": "https://github.com/splicemachine/spliceengine/pull/4505", "merged": true, "mergeCommit": {"oid": "c54e7dda3499011300e6f3e2fbdc153e9e55e6c9"}, "closed": true, "closedAt": "2020-11-07T01:58:57Z", "author": {"login": "arnaud-splice"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ6EIggH2gAyNTE2ODczOTA2OmU2ZWQxYTJlMjU1ZGY3OWU4NTdmYjRlNGM3OGNhNTcyODJiODY4NGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ8SRMAFqTUyNTQzOTk4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e6ed1a2e255df79e857fb4e4c78ca57282b8684e", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/e6ed1a2e255df79e857fb4e4c78ca57282b8684e", "committedDate": "2020-11-06T17:04:21Z", "message": "DB-10678 Modify accepted parameters for [VAR]CHAR() function\n\nAs far as second parameters for the char function, we now accept:\nchar(<a character expression> ,  integer)\nor\nchar(<a datetime expression>, ISO/USA/EUR/...)\n\nif an integer is passed as a second param of char() but the first param is not a char expression -> throw\nIf a ISO/USA/\u2026 is passed as a second param of char() but the first param is not a datetime -> throw"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzQxNzgz", "url": "https://github.com/splicemachine/spliceengine/pull/4505#pullrequestreview-525341783", "createdAt": "2020-11-06T17:11:38Z", "commit": {"oid": "e6ed1a2e255df79e857fb4e4c78ca57282b8684e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzoxMTozOFrOHu2cQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzoxMTozOFrOHu2cQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4ODUxNQ==", "bodyText": "why not use SQLState.LANG_INVALID_CAST", "url": "https://github.com/splicemachine/spliceengine/pull/4505#discussion_r518888515", "createdAt": "2020-11-06T17:11:38Z", "author": {"login": "martinrupp"}, "path": "splice_machine/src/test/java/com/splicemachine/derby/impl/sql/execute/operations/FunctionIT.java", "diffHunk": "@@ -725,5 +726,46 @@ public void testDateTimeToCharVarcharConstants() throws Exception {\n             Assert.assertEquals(\"22018\", e.getSQLState());\n         }\n     }\n+\n+    @Test\n+    public void testCastToCharWithLength() throws Exception {\n+        try (ResultSet ignored = methodWatcher.executeQuery(\"select char(current date, 20)\")) {\n+            Assert.fail(\"expect failure since we cannot specify a length with something which is not a char/varchar\");\n+        } catch (SQLException e) {\n+            assertEquals(\"42846\", e.getSQLState());\n+            Assert.assertThat(e.getMessage(), containsString(\"Cannot set a length\"));\n+        }\n+        try (ResultSet ignored = methodWatcher.executeQuery(\"select char(42, 20)\")) {\n+            Assert.fail(\"expect failure since we cannot specify a length with something which is not a char/varchar\");\n+        } catch (SQLException e) {\n+            assertEquals(\"42846\", e.getSQLState());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6ed1a2e255df79e857fb4e4c78ca57282b8684e"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzU2NTMx", "url": "https://github.com/splicemachine/spliceengine/pull/4505#pullrequestreview-525356531", "createdAt": "2020-11-06T17:31:47Z", "commit": {"oid": "e6ed1a2e255df79e857fb4e4c78ca57282b8684e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzozMTo0N1rOHu3IaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzozNDozN1rOHu3OOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg5OTgxNg==", "bodyText": "Ah, now I see why the regression is there. Because they both start with <COMMA>, and the length one is shadowed. Thanks for the fix!", "url": "https://github.com/splicemachine/spliceengine/pull/4505#discussion_r518899816", "createdAt": "2020-11-06T17:31:47Z", "author": {"login": "ascend1"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/sqlgrammar.jj", "diffHunk": "@@ -9023,7 +9023,17 @@ ValueNode\n \n             return value;\n       }\n-     | charType = charOrVarchar() <LEFT_PAREN> operand = additiveExpression(null,0) [<COMMA> format = datetimeStringFormat()] [ <COMMA> length = length() ] <RIGHT_PAREN>\n+     |\n+     charType = charOrVarchar()\n+     <LEFT_PAREN>\n+     operand = additiveExpression(null,0)\n+     [\n+        <COMMA> (\n+            format = datetimeStringFormat()\n+        |\n+            length = length()\n+        )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6ed1a2e255df79e857fb4e4c78ca57282b8684e"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODkwMTMwNA==", "bodyText": "I'm not sure if this is always fine. I wanted to do check here, but then there are cases where sourceCTI is null.", "url": "https://github.com/splicemachine/spliceengine/pull/4505#discussion_r518901304", "createdAt": "2020-11-06T17:34:37Z", "author": {"login": "ascend1"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/CastNode.java", "diffHunk": "@@ -320,6 +324,20 @@ else if (this.targetCharType == Types.VARCHAR)\n \n         bindCastNodeOnly();\n \n+        if (getTypeId().isCharOrVarChar()) {\n+            if (requestedStringLength != -1 && !sourceCTI.isCharOrVarChar()) {\n+                throw StandardException.newException(\n+                        SQLState.LANG_INVALID_CAST_TO_CHAR_WITH_LENGTH_NOT_FROM_CHAR,\n+                        sourceCTI.getSQLTypeName(),\n+                        getTypeId().getSQLTypeName());\n+            }\n+            if (dateToStringFormat != -1 && !sourceCTI.isDateTimeTimeStampTypeID()) {\n+                throw StandardException.newException(\n+                        SQLState.LANG_INVALID_CAST_TO_CHAR_WITH_FORMAT_NOT_FROM_DATE\n+                );\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6ed1a2e255df79e857fb4e4c78ca57282b8684e"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99eb1c8540a23d02ee595c6b07f491b211ecafc4", "author": {"user": {"login": "arnaud-splice", "name": "Arnaud Lacurie"}}, "url": "https://github.com/splicemachine/spliceengine/commit/99eb1c8540a23d02ee595c6b07f491b211ecafc4", "committedDate": "2020-11-06T17:44:06Z", "message": "DB-10678 Add null check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NDE3MTg4", "url": "https://github.com/splicemachine/spliceengine/pull/4505#pullrequestreview-525417188", "createdAt": "2020-11-06T19:02:28Z", "commit": {"oid": "99eb1c8540a23d02ee595c6b07f491b211ecafc4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NDM5OTgx", "url": "https://github.com/splicemachine/spliceengine/pull/4505#pullrequestreview-525439981", "createdAt": "2020-11-06T19:39:36Z", "commit": {"oid": "99eb1c8540a23d02ee595c6b07f491b211ecafc4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1061, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}