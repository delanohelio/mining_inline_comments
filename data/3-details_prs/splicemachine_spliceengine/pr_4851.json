{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM3MDM0ODQ5", "number": 4851, "title": "DB-10961 remove node factory part 1", "bodyText": "Description\nThis is a first part of starting to remove the NodeFactory (spliceengine/db-engine/src/main/java/com/splicemachine/db/iapi/sql/compile/NodeFactory.java) that is currently used by our SQL Parser to create the nodes from the Syntax Tree (sqlfgrammar.jj).\nMotivation\nWe want to remove NodeFactory and replace with simple, strongly typed constructors, because:\n\n\nNode Factory is quite complicated code\n\n\nwe don't have safety when constructing the nodes. Potential errors that will ONLY be detected at run time include\n\n\ncalling getNode with wrong number of parameters. will result (at run time) in a throw in SanityManager.DEBUG, otherwise \u201cnothing\u201d, so Node will not be initialized)\n\n\ncalling getNode with wrong TYPE of parameters: will result (at run time) in java.lang.ClassCastException.\n\n\ncalling getNode, but forgot to add type to the getNode switch: will result (at run time) in a Not Implemented exception\n\n\ntypo in C_NodeNames.XXX_NAME : will result (at run time) in ClassNotFound Exceptions\n\n\n\n\nrefactoring is very hard, as e.g. Intellij can\u2019t help you add a parameter to all invocations. If you rename a class, you might forget rename the name in C_NodeNames.XXX_NAME.\n\n\nadding nodes is complicated and error-prone.\n\n\nFor all those reasons, Derby also decided to remove the node factory a long time ago, see https://issues.apache.org/jira/browse/DERBY-673 .\nThis is part 1 of the removal of the Node Factory. We decided to remove it in multiple steps to make this manageable and e.g. avoid one huge change that might cause a lot of merge conflicts. I suppose we have 2-4 of these changes.\nWhat the old code looks like\nCurrently, we create nodes like this:\n        StatementNode retval =\n                (StatementNode) nodeFactory.getNode(\n                        C_NodeTypes.UPDATE_NODE,\n                        tableName, /* target table for update */\n                        resultSet, /* SelectNode just created */\n                        getContextManager());\n\nwhich then calls this code:\nNode retval = getNode(nodeType, cm);\nWhere getNode will call basically a large switch statement mapping C_NodeTypes.UPDATE_NODE to C_NodeNames.UPDATE_NODE_NAME (\"com.splicemachine.db.impl.sql.compile.UpdateNode\u201d). This alone is already a bit dangerous, as a typo at creating or if someone adds another node will not be detected at compile time, but ONLY when running integrations tests and ONLY if the tests run exactly through that code (which they of course should, but maybe not).\nNext, we getNode will pass the parameters to the node like this\nretval.init(arg1, arg2);\nTo be able to do this, UpdateNode extends QueryTreeNode which implements Node, which has interfaces for all counts of parameters, e.g.\n   @Override\n    public void init(Object arg1, Object arg2) throws StandardException{\n        if(SanityManager.DEBUG){\n            SanityManager.THROWASSERT(\"Two-argument init() not implemented for \"+getClass().getName());\n        }\n    }\n\nWhat the new code looks like\n        UpdateNode node = new UpdateNode(\n                tableName, /* target table for update */\n                resultSet, /* SelectNode just created */\n                getContextManager());\n\nWhen we finally removed the NodeFactory, we will remove C_NodeNames.java (354 lines), SpliceNodeFactoryImpl.java (663 lines), NodeFactory (605 lines) and more code in other classes, AND get type safety at run compile time.\nHow to test\nThe new code is only a refactoring and doesn\u2019t add or remove any features or fix any bugs.", "createdAt": "2020-12-11T15:42:10Z", "url": "https://github.com/splicemachine/spliceengine/pull/4851", "merged": true, "mergeCommit": {"oid": "75b76ee4fa8008c1b77ac0e643fef135e375c406"}, "closed": true, "closedAt": "2021-01-21T20:47:33Z", "author": {"login": "martinrupp"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmWH6tgBqjQxMTMzMTI0MjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdyW844AFqTU3MzQ5ODc2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "feb3764f981a337261286b1e19a8d01d0f50a6c0", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/feb3764f981a337261286b1e19a8d01d0f50a6c0", "committedDate": "2020-12-11T22:29:42Z", "message": "DB-10961 fix SpotBugs"}, "afterCommit": {"oid": "421411012a3f7ef8f61a6d771d48123b3bc36409", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/421411012a3f7ef8f61a6d771d48123b3bc36409", "committedDate": "2020-12-15T08:23:47Z", "message": "DB-10961 fix SpotBugs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "421411012a3f7ef8f61a6d771d48123b3bc36409", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/421411012a3f7ef8f61a6d771d48123b3bc36409", "committedDate": "2020-12-15T08:23:47Z", "message": "DB-10961 fix SpotBugs"}, "afterCommit": {"oid": "a0998d80ca33fbffd2ea524ddfe0a03f70a3278c", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/a0998d80ca33fbffd2ea524ddfe0a03f70a3278c", "committedDate": "2020-12-15T10:43:26Z", "message": "DB-10961 fix SpotBugs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0998d80ca33fbffd2ea524ddfe0a03f70a3278c", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/a0998d80ca33fbffd2ea524ddfe0a03f70a3278c", "committedDate": "2020-12-15T10:43:26Z", "message": "DB-10961 fix SpotBugs"}, "afterCommit": {"oid": "310b0f078574e30d97405ed614a1f5af4d16b9d8", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/310b0f078574e30d97405ed614a1f5af4d16b9d8", "committedDate": "2021-01-04T13:15:59Z", "message": "DB-10961 fix SpotBugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2MTQzNzM3", "url": "https://github.com/splicemachine/spliceengine/pull/4851#pullrequestreview-566143737", "createdAt": "2021-01-12T10:42:49Z", "commit": {"oid": "310b0f078574e30d97405ed614a1f5af4d16b9d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "310b0f078574e30d97405ed614a1f5af4d16b9d8", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/310b0f078574e30d97405ed614a1f5af4d16b9d8", "committedDate": "2021-01-04T13:15:59Z", "message": "DB-10961 fix SpotBugs"}, "afterCommit": {"oid": "d347fa74cf4fd7811605bc96dcf232019bd9c930", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/d347fa74cf4fd7811605bc96dcf232019bd9c930", "committedDate": "2021-01-18T10:20:14Z", "message": "DB-10961 fix SpotBugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwMzk4OTEy", "url": "https://github.com/splicemachine/spliceengine/pull/4851#pullrequestreview-570398912", "createdAt": "2021-01-18T11:21:53Z", "commit": {"oid": "d347fa74cf4fd7811605bc96dcf232019bd9c930"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQxMToyMTo1M1rOIVk7lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQxMToyMTo1M1rOIVk7lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ5NjA4Nw==", "bodyText": "this is actually fixing a bug that was introduced because NodeFactory does no type checking (UpdateNode's init requires tableName, resultSet, cursorDelete, but would have only been given tableName, resultSet )", "url": "https://github.com/splicemachine/spliceengine/pull/4851#discussion_r559496087", "createdAt": "2021-01-18T11:21:53Z", "author": {"login": "martinrupp"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/DeleteNode.java", "diffHunk": "@@ -964,12 +974,7 @@ private StatementNode getEmptyUpdateNode(String schemaName,\n                                                      null, /* windows */\n                                                      getContextManager());\n \n-        return (StatementNode) nodeFactory.getNode(\n-                                                    C_NodeTypes.UPDATE_NODE,\n-                                                    tableName,\n-                                                    resultSet,\n-                                                    getContextManager());\n-\n+        return new UpdateNode( tableName, resultSet, cursorDelete, getContextManager());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d347fa74cf4fd7811605bc96dcf232019bd9c930"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwNDE0MjY4", "url": "https://github.com/splicemachine/spliceengine/pull/4851#pullrequestreview-570414268", "createdAt": "2021-01-18T11:44:13Z", "commit": {"oid": "d347fa74cf4fd7811605bc96dcf232019bd9c930"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d347fa74cf4fd7811605bc96dcf232019bd9c930", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/d347fa74cf4fd7811605bc96dcf232019bd9c930", "committedDate": "2021-01-18T10:20:14Z", "message": "DB-10961 fix SpotBugs"}, "afterCommit": {"oid": "2bf5732332574d0ae984d10f8bf06efd9c658e43", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2bf5732332574d0ae984d10f8bf06efd9c658e43", "committedDate": "2021-01-18T11:47:45Z", "message": "DB-10961 fix SpotBugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyOTg3MjA2", "url": "https://github.com/splicemachine/spliceengine/pull/4851#pullrequestreview-572987206", "createdAt": "2021-01-21T05:08:32Z", "commit": {"oid": "2bf5732332574d0ae984d10f8bf06efd9c658e43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "687ddd29074b8fddd8c61a92a4ac01be8e3c976b", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/687ddd29074b8fddd8c61a92a4ac01be8e3c976b", "committedDate": "2021-01-21T10:52:17Z", "message": "DB-10961 remove node factory part 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de17ae79bb2d020879d35ccfe3067a3ea5cfb945", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/de17ae79bb2d020879d35ccfe3067a3ea5cfb945", "committedDate": "2021-01-21T10:52:17Z", "message": "DB-10961 fix SpotBugs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bf5732332574d0ae984d10f8bf06efd9c658e43", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/2bf5732332574d0ae984d10f8bf06efd9c658e43", "committedDate": "2021-01-18T11:47:45Z", "message": "DB-10961 fix SpotBugs"}, "afterCommit": {"oid": "de17ae79bb2d020879d35ccfe3067a3ea5cfb945", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/de17ae79bb2d020879d35ccfe3067a3ea5cfb945", "committedDate": "2021-01-21T10:52:17Z", "message": "DB-10961 fix SpotBugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTczNDk4NzY3", "url": "https://github.com/splicemachine/spliceengine/pull/4851#pullrequestreview-573498767", "createdAt": "2021-01-21T16:17:52Z", "commit": {"oid": "de17ae79bb2d020879d35ccfe3067a3ea5cfb945"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1013, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}