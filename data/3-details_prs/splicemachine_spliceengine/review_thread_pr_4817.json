{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MjMyNDA3", "number": 4817, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjozMzoxNVrOFDBM5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMDozODo0N1rOFDIJfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NzA5NzM0OnYy", "diffSide": "RIGHT", "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjozMzoxNVrOICd71w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxODo0NjozNFrOICj_iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ1ODUxOQ==", "bodyText": "If it already exists, skip dropping and recreating the view.", "url": "https://github.com/splicemachine/spliceengine/pull/4817#discussion_r539458519", "createdAt": "2020-12-09T16:33:15Z", "author": {"login": "jyuanca"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "diffHunk": "@@ -351,6 +351,25 @@ public void createKeyColumnUseViewInSysIBM(TransactionController tc) throws Stan\n         SpliceLogUtils.info(LOG, \"View SYSKEYCOLUSE in SYSIBM is created!\");\n     }\n \n+    public void createIndexColumnUseViewInSysCat(TransactionController tc) throws StandardException {\n+        TableDescriptor td = getTableDescriptor(\"INDEXCOLUSE\", sysCatSchemaDesc, tc);\n+\n+        // drop it if it exists\n+        if (td != null) {\n+            ViewDescriptor vd = getViewDescriptor(td);\n+\n+            // drop the view deifnition\n+            dropAllColumnDescriptors(td.getUUID(), tc);\n+            dropViewDescriptor(vd, tc);\n+            dropTableDescriptor(td, sysCatSchemaDesc, tc);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c3d5ee460c98fea9646584e21cd4aee50b94e29"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ1OTkyMg==", "bodyText": "I accidentally approved it. Changing to \"request cahnges\"", "url": "https://github.com/splicemachine/spliceengine/pull/4817#discussion_r539459922", "createdAt": "2020-12-09T16:34:57Z", "author": {"login": "jyuanca"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "diffHunk": "@@ -351,6 +351,25 @@ public void createKeyColumnUseViewInSysIBM(TransactionController tc) throws Stan\n         SpliceLogUtils.info(LOG, \"View SYSKEYCOLUSE in SYSIBM is created!\");\n     }\n \n+    public void createIndexColumnUseViewInSysCat(TransactionController tc) throws StandardException {\n+        TableDescriptor td = getTableDescriptor(\"INDEXCOLUSE\", sysCatSchemaDesc, tc);\n+\n+        // drop it if it exists\n+        if (td != null) {\n+            ViewDescriptor vd = getViewDescriptor(td);\n+\n+            // drop the view deifnition\n+            dropAllColumnDescriptors(td.getUUID(), tc);\n+            dropViewDescriptor(vd, tc);\n+            dropTableDescriptor(td, sysCatSchemaDesc, tc);\n+        }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ1ODUxOQ=="}, "originalCommit": {"oid": "0c3d5ee460c98fea9646584e21cd4aee50b94e29"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ5Nzk3MA==", "bodyText": "Hi Jun, what do you mean by \"recreating the view\"? I mean, if the existing one is not dropped, we cannot create the view with the same name (createOneSystemView fails). Or do I miss anything here?", "url": "https://github.com/splicemachine/spliceengine/pull/4817#discussion_r539497970", "createdAt": "2020-12-09T17:22:30Z", "author": {"login": "ascend1"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "diffHunk": "@@ -351,6 +351,25 @@ public void createKeyColumnUseViewInSysIBM(TransactionController tc) throws Stan\n         SpliceLogUtils.info(LOG, \"View SYSKEYCOLUSE in SYSIBM is created!\");\n     }\n \n+    public void createIndexColumnUseViewInSysCat(TransactionController tc) throws StandardException {\n+        TableDescriptor td = getTableDescriptor(\"INDEXCOLUSE\", sysCatSchemaDesc, tc);\n+\n+        // drop it if it exists\n+        if (td != null) {\n+            ViewDescriptor vd = getViewDescriptor(td);\n+\n+            // drop the view deifnition\n+            dropAllColumnDescriptors(td.getUUID(), tc);\n+            dropViewDescriptor(vd, tc);\n+            dropTableDescriptor(td, sysCatSchemaDesc, tc);\n+        }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ1ODUxOQ=="}, "originalCommit": {"oid": "0c3d5ee460c98fea9646584e21cd4aee50b94e29"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU1Nzc2OQ==", "bodyText": "Hi Jun, as we talked previously, I tested doing an upgrade from 3.0.0.1989 to 3.2.0.1989 locally. Here is what I did:\n\ncompile DB-10976-3.0 branch and start a cdh6.3.0 cluster\ncheck SYSCAT.INDEXCOLUSE is there and query on it works (108 rows in fresh start state)\ncopy platform_it/target to another place\ncompile DB-10976 branch and start a cdh6.3.0 cluster, verify its version and the existence of SYSCAT_INDEXCOLUSE\nshutdown the cluster and replace platform_it/target with the previously copied 3.0.0.1989 version\nstart cdh6.3.0 cluster again using -b on the 3.0 persistent files\ncluster started normally and verify the existence of SYSCAT_INDEXCOLUSE , query on it should return 108 rows", "url": "https://github.com/splicemachine/spliceengine/pull/4817#discussion_r539557769", "createdAt": "2020-12-09T18:46:34Z", "author": {"login": "ascend1"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/catalog/SpliceDataDictionary.java", "diffHunk": "@@ -351,6 +351,25 @@ public void createKeyColumnUseViewInSysIBM(TransactionController tc) throws Stan\n         SpliceLogUtils.info(LOG, \"View SYSKEYCOLUSE in SYSIBM is created!\");\n     }\n \n+    public void createIndexColumnUseViewInSysCat(TransactionController tc) throws StandardException {\n+        TableDescriptor td = getTableDescriptor(\"INDEXCOLUSE\", sysCatSchemaDesc, tc);\n+\n+        // drop it if it exists\n+        if (td != null) {\n+            ViewDescriptor vd = getViewDescriptor(td);\n+\n+            // drop the view deifnition\n+            dropAllColumnDescriptors(td.getUUID(), tc);\n+            dropViewDescriptor(vd, tc);\n+            dropTableDescriptor(td, sysCatSchemaDesc, tc);\n+        }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ1ODUxOQ=="}, "originalCommit": {"oid": "0c3d5ee460c98fea9646584e21cd4aee50b94e29"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4ODIzNTQ4OnYy", "diffSide": "RIGHT", "path": "db-engine/src/main/java/com/splicemachine/db/catalog/types/IndexDescriptorImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMDozODo0N1rOICocUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMTo0Nzo0OVrOICrBCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzMDY3NQ==", "bodyText": "The code looks good.  I'm just wondering in the base code why both isAscending and isDescending return false for an out-of-range column.  I would assume that since ascending is the default, an out-of-range column should return true (unless we want to catch the out-of-range condition and throw an exception.", "url": "https://github.com/splicemachine/spliceengine/pull/4817#discussion_r539630675", "createdAt": "2020-12-09T20:38:47Z", "author": {"login": "msirek"}, "path": "db-engine/src/main/java/com/splicemachine/db/catalog/types/IndexDescriptorImpl.java", "diffHunk": "@@ -259,15 +259,15 @@ public String indexType()\n \t/** @see IndexDescriptor#isAscending */\n \tpublic boolean isAscending(Integer keyColumnPosition) {\n \t\tint i = keyColumnPosition - 1;\n-\t\tif (i < 0 || i >= baseColumnPositions.length)\n+\t\tif (i < 0 || i >= isAscending.length)\n \t\t\treturn false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c0b0626e4e1d5dccb540a109b7208a41b2f70e1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY3Mjg0Mw==", "bodyText": "Indeed, that's a good point. I'll take a look at the call sites of these two functions and file a Jira if there is no special logic relying on the false return values. Probably we should throw than returning a default to prevent subtle bugs.", "url": "https://github.com/splicemachine/spliceengine/pull/4817#discussion_r539672843", "createdAt": "2020-12-09T21:47:49Z", "author": {"login": "ascend1"}, "path": "db-engine/src/main/java/com/splicemachine/db/catalog/types/IndexDescriptorImpl.java", "diffHunk": "@@ -259,15 +259,15 @@ public String indexType()\n \t/** @see IndexDescriptor#isAscending */\n \tpublic boolean isAscending(Integer keyColumnPosition) {\n \t\tint i = keyColumnPosition - 1;\n-\t\tif (i < 0 || i >= baseColumnPositions.length)\n+\t\tif (i < 0 || i >= isAscending.length)\n \t\t\treturn false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzMDY3NQ=="}, "originalCommit": {"oid": "5c0b0626e4e1d5dccb540a109b7208a41b2f70e1"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2720, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}