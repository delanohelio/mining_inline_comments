{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNTA3NzM5", "number": 4266, "title": "DB-10350 Special import mode that does not check referential integrity or fire triggers", "bodyText": "Added new import function which behaves like IMPORT_DATA, but is replacing the content of the table without firing triggers and without checking Forein Key constraints (referential integrity).\ne.g.\ncall SYSCS_UTIL.LOAD_REPLACE('<schemaName>', '<tableName>', null, '<inFilePath>', null, null, null, null, null, -1,      '<badRecordLogDirectory>', true, null);\nFor this added special modes for INSERT and DELETE, also ignoring triggers / referential integrity:\nINSERT ... --splice-properties insertMode=LOAD_REPLACE \nDELETE ... --splice-properties  noTriggerRI=1", "createdAt": "2020-10-12T11:16:08Z", "url": "https://github.com/splicemachine/spliceengine/pull/4266", "merged": true, "mergeCommit": {"oid": "133b7fb1fb5bffe1c8d9a61c309b88fd00052d40"}, "closed": true, "closedAt": "2020-11-04T16:40:54Z", "author": {"login": "martinrupp"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTFSF6gBqjM4ODYwNjMzMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZJSpHgBqjM5NTYzMzg0NDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7351ca38c5031f125aed4259f0645fffd04eb570", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/7351ca38c5031f125aed4259f0645fffd04eb570", "committedDate": "2020-10-13T09:51:43Z", "message": "DB-10350 added LOAD_REPLACE function"}, "afterCommit": {"oid": "1eb3b09a7544320526e5a519348fb456c151ee91", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/1eb3b09a7544320526e5a519348fb456c151ee91", "committedDate": "2020-10-16T12:10:53Z", "message": "DB-10350 add DELETE mode noChecks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1eb3b09a7544320526e5a519348fb456c151ee91", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/1eb3b09a7544320526e5a519348fb456c151ee91", "committedDate": "2020-10-16T12:10:53Z", "message": "DB-10350 add DELETE mode noChecks"}, "afterCommit": {"oid": "c93ab4d2e90d386feb124c936fa532aad85c326b", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/c93ab4d2e90d386feb124c936fa532aad85c326b", "committedDate": "2020-10-16T13:35:01Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c93ab4d2e90d386feb124c936fa532aad85c326b", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/c93ab4d2e90d386feb124c936fa532aad85c326b", "committedDate": "2020-10-16T13:35:01Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}, "afterCommit": {"oid": "1d4de26af694c3d6d3ebfdfd1add6abe29c47412", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/1d4de26af694c3d6d3ebfdfd1add6abe29c47412", "committedDate": "2020-10-16T14:05:52Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d4de26af694c3d6d3ebfdfd1add6abe29c47412", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/1d4de26af694c3d6d3ebfdfd1add6abe29c47412", "committedDate": "2020-10-16T14:05:52Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}, "afterCommit": {"oid": "f8b3eebcf699edaf269cca77eaf25669ee9b09f2", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f8b3eebcf699edaf269cca77eaf25669ee9b09f2", "committedDate": "2020-10-16T14:12:00Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8b3eebcf699edaf269cca77eaf25669ee9b09f2", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f8b3eebcf699edaf269cca77eaf25669ee9b09f2", "committedDate": "2020-10-16T14:12:00Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}, "afterCommit": {"oid": "08d0083cbb87802eac20bb4020ff2676f0771ed8", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/08d0083cbb87802eac20bb4020ff2676f0771ed8", "committedDate": "2020-10-18T20:27:13Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08d0083cbb87802eac20bb4020ff2676f0771ed8", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/08d0083cbb87802eac20bb4020ff2676f0771ed8", "committedDate": "2020-10-18T20:27:13Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}, "afterCommit": {"oid": "f3d56a222cff1c704162a07936787ac681c75e63", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f3d56a222cff1c704162a07936787ac681c75e63", "committedDate": "2020-10-18T21:24:12Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3d56a222cff1c704162a07936787ac681c75e63", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f3d56a222cff1c704162a07936787ac681c75e63", "committedDate": "2020-10-18T21:24:12Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}, "afterCommit": {"oid": "fdc2afe1c0eef2c76e192dd9e080f09f29f3a99d", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/fdc2afe1c0eef2c76e192dd9e080f09f29f3a99d", "committedDate": "2020-10-19T15:47:24Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdc2afe1c0eef2c76e192dd9e080f09f29f3a99d", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/fdc2afe1c0eef2c76e192dd9e080f09f29f3a99d", "committedDate": "2020-10-19T15:47:24Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}, "afterCommit": {"oid": "4757cabd9efff16cb2e6e1b6454f8399f7c2212d", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/4757cabd9efff16cb2e6e1b6454f8399f7c2212d", "committedDate": "2020-10-19T18:54:24Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4757cabd9efff16cb2e6e1b6454f8399f7c2212d", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/4757cabd9efff16cb2e6e1b6454f8399f7c2212d", "committedDate": "2020-10-19T18:54:24Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}, "afterCommit": {"oid": "975a1528f2ffd0c3e289db92f7c07f65e26a2f6a", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/975a1528f2ffd0c3e289db92f7c07f65e26a2f6a", "committedDate": "2020-10-19T18:55:30Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "975a1528f2ffd0c3e289db92f7c07f65e26a2f6a", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/975a1528f2ffd0c3e289db92f7c07f65e26a2f6a", "committedDate": "2020-10-19T18:55:30Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}, "afterCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4", "committedDate": "2020-10-20T07:42:33Z", "message": "DB-10350 fix mem"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTM4NTM5", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-512538539", "createdAt": "2020-10-20T10:01:21Z", "commit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowMToyMlrOHk0hgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowMToyMlrOHk0hgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3MTMyOQ==", "bodyText": "makes sense to check, that conn != null, as SpliceAdmin.getDefaultConn can throw SQLException", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r508371329", "createdAt": "2020-10-20T10:01:22Z", "author": {"login": "ipraznik-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/load/HdfsImport.java", "diffHunk": "@@ -770,6 +828,9 @@ private static void doImport(String schemaName,\n                 rs.open();\n                 results[0] = new EmbedResultSet40((EmbedConnection) conn, rs, false, null, true);\n             } catch (SQLException | StandardException | IOException e) {\n+                if( isLoadReplaceMode ) {\n+                    conn.rollback();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "originalPosition": 174}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTQwODYz", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-512540863", "createdAt": "2020-10-20T10:04:04Z", "commit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowNDowNFrOHk0oCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowNDowNFrOHk0oCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3MzAwMQ==", "bodyText": "looks like not used", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r508373001", "createdAt": "2020-10-20T10:04:04Z", "author": {"login": "ipraznik-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/sql/execute/operations/InsertOperation.java", "diffHunk": "@@ -38,6 +38,7 @@\n import com.splicemachine.derby.impl.sql.execute.actions.InsertConstantOperation;\n import com.splicemachine.derby.impl.sql.execute.sequence.SequenceKey;\n import com.splicemachine.derby.impl.sql.execute.sequence.SpliceSequence;\n+import com.splicemachine.derby.stream.control.ControlDataSet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTQ1MTg0", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-512545184", "createdAt": "2020-10-20T10:08:55Z", "commit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowODo1NVrOHk00dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowODo1NVrOHk00dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3NjE4MQ==", "bodyText": "field name is not in Java style", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r508376181", "createdAt": "2020-10-20T10:08:55Z", "author": {"login": "ipraznik-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/stream/output/insert/InsertPipelineWriter.java", "diffHunk": "@@ -58,6 +57,7 @@\n     protected InsertOperation insertOperation;\n     protected boolean isUpsert;\n     private Partition table;\n+    private boolean load_replace_mode;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTQ1OTI0", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-512545924", "createdAt": "2020-10-20T10:09:49Z", "commit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowOTo1MFrOHk02og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowOTo1MFrOHk02og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3NjczOA==", "bodyText": "parameter load_replace_mode  name not in Java style", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r508376738", "createdAt": "2020-10-20T10:09:50Z", "author": {"login": "ipraznik-splice"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/stream/output/insert/InsertTableWriterBuilder.java", "diffHunk": "@@ -243,4 +247,16 @@ public static InsertTableWriterBuilder getInsertTableWriterBuilderFromBase64Stri\n     public String getInsertTableWriterBuilderBase64String() throws IOException, StandardException {\n         return Base64.encodeBase64String(SerializationUtils.serialize(this));\n     }\n+\n+\n+    @Override\n+    public DataSetWriterBuilder loadReplaceMode(boolean load_replace_mode) {\n+        this.loadReplaceMode = load_replace_mode;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTM3ODE3", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-512537817", "createdAt": "2020-10-20T10:00:33Z", "commit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDowMDozM1rOHk0fkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDozNDowMFrOHk1vVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3MDgzNA==", "bodyText": "maybe the last parameter should be argCount+4 as well?", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r508370834", "createdAt": "2020-10-20T10:00:33Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/DeleteNode.java", "diffHunk": "@@ -703,12 +730,14 @@ public void generate(ActivationClassBuilder acb,\n         if (\"getDeleteResultSet\".equals(resultSetGetter)) {\n             mb.push(this.printExplainInformationForActivation());\n             BaseJoinStrategy.pushNullableString(mb, bulkDeleteDirectory);\n+            BaseJoinStrategy.pushNullableString(mb, isNoTriggerRIMode() ? \"1\" : \"0\" );\n+\n             if (colMap != null && colMap.length > 0) {\n                 mb.push(acb.addItem(colMap));\n             } else {\n                 mb.push(-1);\n             }\n-            argCount += 3;\n+            argCount += 4;\n         }\n         mb.callMethod(VMOpcode.INVOKEINTERFACE, (String) null, resultSetGetter, ClassName.ResultSet, argCount+3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM4MzU1OQ==", "bodyText": "nice refactoring.", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r508383559", "createdAt": "2020-10-20T10:21:11Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/dictionary/TableDescriptor.java", "diffHunk": "@@ -784,6 +784,18 @@ public int getQualifiedNumberOfIndexes(int minColCount,boolean nonUniqeTrumpsCol\n         return matches;\n     }\n \n+    private static void assertValidStatementType(int statementType)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM4NTg1OQ==", "bodyText": "Out of curiosity, why do we call remove here causing a side-effect? If that's intentional, should be maybe change the method name into something like spliceDeleteProperties ( no puns intended! :) )", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r508385859", "createdAt": "2020-10-20T10:24:54Z", "author": {"login": "hatyo"}, "path": "db-engine/src/main/java/com/splicemachine/db/impl/sql/compile/DeleteNode.java", "diffHunk": "@@ -112,6 +114,32 @@ public void init(Object targetTableName,\n         this.targetProperties = (Properties) targetProperties;\n     }\n \n+    static public boolean isBulkDelete(Properties properties)\n+    {\n+        return properties == null ? false :\n+                properties.getProperty(BULK_DELETE_DIRECTORY) != null;\n+    }\n+\n+    static public Properties getDeleteProperties(Properties tableProperties)\n+    {\n+        if (tableProperties == null) {\n+            return null;\n+        }\n+        String dir = (String)tableProperties.remove(BULK_DELETE_DIRECTORY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM4OTY5Mg==", "bodyText": "I guess you want to have something similar to reverse iterator, right? (not that it exists AFAIK, but maybe you can wrap this in a special method to make the intention clear.", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r508389692", "createdAt": "2020-10-20T10:31:21Z", "author": {"login": "hatyo"}, "path": "hbase_pipeline/src/main/java/com/splicemachine/derby/hbase/SpliceIndexEndpoint.java", "diffHunk": "@@ -198,15 +199,26 @@ private boolean useToken(BulkWrites bulkWrites) {\n         return true;\n     }\n \n+    // todo: improve this\n+    private boolean isLoadReplaceMode(BulkWrites bulkWrites) {\n+        boolean loadReplaceMode = false;\n+        Iterator<BulkWrite> iterator = bulkWrites.getBulkWrites().iterator();\n+        if (iterator.hasNext()) {\n+            BulkWrite bw = iterator.next();\n+            loadReplaceMode = bw.isLoadReplaceMode();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM5MTI1Mg==", "bodyText": "please write a comment here explaining situations where foreignKeyChecks can be set to false.", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r508391252", "createdAt": "2020-10-20T10:34:00Z", "author": {"login": "hatyo"}, "path": "pipeline_api/src/main/java/com/splicemachine/pipeline/contextfactory/LocalWriteContextFactory.java", "diffHunk": "@@ -231,7 +222,8 @@ private void addWriteHandlerFactories(int expectedWrites, PipelineWriteContext c\n             ddlFactories.addFactories(context,true,expectedWrites);\n \n             // FK - child intercept (of inserts/updates)\n-            fkGroup.addFactories(context,false,expectedWrites);\n+            if( foreignKeyChecks )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f72f583f6f1ecd3e12917d696c3b00b6cd7c7bd4"}, "originalPosition": 77}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85b22794c75af0fc87671cba8150a40588c12c6d", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/85b22794c75af0fc87671cba8150a40588c12c6d", "committedDate": "2020-10-21T08:43:34Z", "message": "DB-10350 address code reviews"}, "afterCommit": {"oid": "28d61c9a0a096916a991681ae15a215590367942", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/28d61c9a0a096916a991681ae15a215590367942", "committedDate": "2020-10-21T11:22:20Z", "message": "DB-10350 address code reviews"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzODYwOTg2", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-513860986", "createdAt": "2020-10-21T16:11:42Z", "commit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NDkwNDUw", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-514490450", "createdAt": "2020-10-22T08:40:09Z", "commit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzQ0NTc5", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-517344579", "createdAt": "2020-10-27T04:44:10Z", "commit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NzA0NzA2", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-515704706", "createdAt": "2020-10-23T14:11:33Z", "commit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNDoxMTozM1rOHnPl2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMTo0NTozNVrOHo4ApQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDkxMTk2MA==", "bodyText": "Is it possible to get a better datatype here? are we expecting to pass more info in this parameter in the future?", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r510911960", "createdAt": "2020-10-23T14:11:33Z", "author": {"login": "dgomezferro"}, "path": "db-engine/src/main/java/com/splicemachine/db/iapi/sql/execute/ResultSetFactory.java", "diffHunk": "@@ -185,12 +185,13 @@ ResultSet getDeleteVTIResultSet(NoPutResultSet source, double optimizerEstimated\n      *               be deleted from the target table. This result set must\n      *               contain one column which provides RowLocations that are\n      *               valid in the target table.\n+     * @param noTriggerRI if set to 1, DELETE will not fire triggers or check foreign key constraints\n      * @return the delete operation as a result set.\n      * @throws StandardException thrown when unable to perform the delete\n      */\n     ResultSet getDeleteResultSet(NoPutResultSet source, double optimizerEstimatedRowCount,\n                                  double optimizerEstimatedCost, String tableVersion,\n-                                 String explainPlan, String bulkDeleteDirectory, int colMapRefItem)\n+                                 String explainPlan, String bulkDeleteDirectory, String noTriggerRI, int colMapRefItem)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYxNTAwOA==", "bodyText": "Isn't it possible you are changing here a shared writeConfiguration?", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r512615008", "createdAt": "2020-10-27T11:31:50Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/stream/output/delete/DeletePipelineWriter.java", "diffHunk": "@@ -44,23 +44,27 @@\n     public int rowsDeleted = 0;\n     protected DeleteOperation deleteOperation;\n \n-    public DeletePipelineWriter(TxnView txn,byte[] token,long heapConglom,long tempConglomID, String tableVersion, ExecRow execRowDefinition, OperationContext operationContext) throws StandardException {\n-        super(txn, token, heapConglom, tempConglomID, tableVersion, execRowDefinition, operationContext);\n+    public DeletePipelineWriter(TxnView txn, byte[] token, long heapConglom, long tempConglomID,\n+                                String tableVersion, ExecRow execRowDefinition, OperationContext operationContext,\n+                                boolean loadReplaceMode)\n+            throws StandardException {\n+        super(txn, token, heapConglom, tempConglomID, tableVersion, execRowDefinition, operationContext, loadReplaceMode);\n         if (operationContext != null) {\n             deleteOperation = (DeleteOperation)operationContext.getOperation();\n         }\n     }\n \n     public void open() throws StandardException {\n-        open(deleteOperation != null ? deleteOperation.getTriggerHandler() : null, deleteOperation);\n+        open(deleteOperation != null ? deleteOperation.getTriggerHandler() : null, deleteOperation, loadReplaceMode);\n     }\n \n-    public void open(TriggerHandler triggerHandler, SpliceOperation operation) throws StandardException {\n-        super.open(triggerHandler, operation);\n+    public void open(TriggerHandler triggerHandler, SpliceOperation operation, boolean loadReplaceMode) throws StandardException {\n+        super.open(triggerHandler, operation, loadReplaceMode);\n         try{\n             WriteConfiguration writeConfiguration = writeCoordinator.defaultWriteConfiguration();\n             if(rollforward)\n                 writeConfiguration = new RollforwardWriteConfiguration(writeConfiguration);\n+            writeConfiguration.setLoadReplaceMode(loadReplaceMode);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYyMDg0OQ==", "bodyText": "If the parent connection has autocommit=true, does this work? In any case it would be better to use savepoints I think, rather than rolling back the whole user transaction.", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r512620849", "createdAt": "2020-10-27T11:42:20Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/load/HdfsImport.java", "diffHunk": "@@ -770,6 +828,10 @@ private static void doImport(String schemaName,\n                 rs.open();\n                 results[0] = new EmbedResultSet40((EmbedConnection) conn, rs, false, null, true);\n             } catch (SQLException | StandardException | IOException e) {\n+                if( conn != null && isLoadReplaceMode ) {\n+                    // rolling back the DELETE we've done\n+                    conn.rollback();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYyMTM3OQ==", "bodyText": "Are we deleting all rows? Should we use truncate here instead?", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r512621379", "createdAt": "2020-10-27T11:43:21Z", "author": {"login": "dgomezferro"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/load/HdfsImport.java", "diffHunk": "@@ -670,18 +715,31 @@ private static void doImport(String schemaName,\n                 throw new SQLException(e);\n             }\n \n+            String insertMode = (isUpsert ? \"UPSERT\" : \"INSERT\");\n+            if( isLoadReplaceMode ) insertMode = InsertNode.LOAD_REPLACE;\n+\n             ColumnInfo columnInfo = new ColumnInfo(conn, schemaName, tableName, insertColumnList);\n             String selectList = generateColumnList(lcc,schemaName,tableName,insertColumnList, true, null);\n             String vtiTable = importVTI + \" AS importVTI (\" + columnInfo.getImportAsColumns() + \")\";\n             String insertSql = \"INSERT INTO \" + entityName + \"(\" + columnInfo.getInsertColumnNames() + \") \" +\n-                    \"--splice-properties useSpark=true , insertMode=\" + (isUpsert ? \"UPSERT\" : \"INSERT\") + \", statusDirectory=\" +\n+                    \"--splice-properties useSpark=true , insertMode=\" + insertMode + \", statusDirectory=\" +\n                     badRecordDirectory + \", badRecordsAllowed=\" + badRecordsAllowed + \", bulkImportDirectory=\" + bulkImportDirectory\n                     + \", samplingOnly=\" + samplingOnly + \", outputKeysOnly=\" + outputKeysOnly + \", skipSampling=\" + skipSampling\n                     + (skipConflictDetection ? \", skipConflictDetection=true\" : \"\") + (skipWAL ? \", skipWAL=true\" : \"\")\n                     + (indexName !=null ? (\", index=\" + indexName):\"\") + \"\\n\" +\n                     \" SELECT \"+ selectList +\n                     \" from \" + vtiTable;\n \n+            if(isLoadReplaceMode)\n+            {\n+                // delete table before inserting\n+                try (PreparedStatement ips = conn.prepareStatement(\"DELETE FROM \" + entityName + DeleteNode.NO_TRIGGER_RI_PROPERTY)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYyMjc1Nw==", "bodyText": "missing comment?", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r512622757", "createdAt": "2020-10-27T11:45:35Z", "author": {"login": "dgomezferro"}, "path": "pipeline_api/src/main/java/com/splicemachine/pipeline/contextfactory/LocalWriteContextFactory.java", "diffHunk": "@@ -216,11 +204,19 @@ private void isInitialized(TxnView txn) throws IOException, InterruptedException\n         }\n     }\n \n-    private void addWriteHandlerFactories(int expectedWrites, PipelineWriteContext context) throws IOException, InterruptedException {\n+    /**\n+     * addWriteHandlerFactories\n+     * @param foreignKeyChecks if set to false, we don't check referential integrity (foreign key checks)\n+     *                         this is used e.g. with INSERT ... insertMode=LOAD_REPLACE or DELETE ... noTriggerRI=1\n+     */\n+    private void addWriteHandlerFactories(int expectedWrites, PipelineWriteContext context,\n+                                          boolean foreignKeyChecks) throws IOException, InterruptedException {\n         isInitialized(context.getTxn());\n         //only add constraints and indices when we are in a RUNNING state\n         if (state.get() == State.RUNNING) {\n             //add Constraint checks before anything else\n+\n+            // ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzM2Nzkw", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-518336790", "createdAt": "2020-10-28T05:37:26Z", "commit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNTozNzoyNlrOHpaukw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwNTozNzoyNlrOHpaukw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE5MTU3MQ==", "bodyText": "My understanding is that not all rows are to be deleted from the table. Should join the table with input file using PK as join key, and delete all rows from the table whose PK is in the join result.", "url": "https://github.com/splicemachine/spliceengine/pull/4266#discussion_r513191571", "createdAt": "2020-10-28T05:37:26Z", "author": {"login": "jyuanca"}, "path": "splice_machine/src/main/java/com/splicemachine/derby/impl/load/HdfsImport.java", "diffHunk": "@@ -670,18 +715,31 @@ private static void doImport(String schemaName,\n                 throw new SQLException(e);\n             }\n \n+            String insertMode = (isUpsert ? \"UPSERT\" : \"INSERT\");\n+            if( isLoadReplaceMode ) insertMode = InsertNode.LOAD_REPLACE;\n+\n             ColumnInfo columnInfo = new ColumnInfo(conn, schemaName, tableName, insertColumnList);\n             String selectList = generateColumnList(lcc,schemaName,tableName,insertColumnList, true, null);\n             String vtiTable = importVTI + \" AS importVTI (\" + columnInfo.getImportAsColumns() + \")\";\n             String insertSql = \"INSERT INTO \" + entityName + \"(\" + columnInfo.getInsertColumnNames() + \") \" +\n-                    \"--splice-properties useSpark=true , insertMode=\" + (isUpsert ? \"UPSERT\" : \"INSERT\") + \", statusDirectory=\" +\n+                    \"--splice-properties useSpark=true , insertMode=\" + insertMode + \", statusDirectory=\" +\n                     badRecordDirectory + \", badRecordsAllowed=\" + badRecordsAllowed + \", bulkImportDirectory=\" + bulkImportDirectory\n                     + \", samplingOnly=\" + samplingOnly + \", outputKeysOnly=\" + outputKeysOnly + \", skipSampling=\" + skipSampling\n                     + (skipConflictDetection ? \", skipConflictDetection=true\" : \"\") + (skipWAL ? \", skipWAL=true\" : \"\")\n                     + (indexName !=null ? (\", index=\" + indexName):\"\") + \"\\n\" +\n                     \" SELECT \"+ selectList +\n                     \" from \" + vtiTable;\n \n+            if(isLoadReplaceMode)\n+            {\n+                // delete table before inserting\n+                try (PreparedStatement ips = conn.prepareStatement(\"DELETE FROM \" + entityName + DeleteNode.NO_TRIGGER_RI_PROPERTY)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjYyMTM3OQ=="}, "originalCommit": {"oid": "28d61c9a0a096916a991681ae15a215590367942"}, "originalPosition": 159}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28d61c9a0a096916a991681ae15a215590367942", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/28d61c9a0a096916a991681ae15a215590367942", "committedDate": "2020-10-21T11:22:20Z", "message": "DB-10350 address code reviews"}, "afterCommit": {"oid": "0d5aa2af43feea6340100e2a1059d262a53ae4a7", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/0d5aa2af43feea6340100e2a1059d262a53ae4a7", "committedDate": "2020-10-30T21:43:07Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d5aa2af43feea6340100e2a1059d262a53ae4a7", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/0d5aa2af43feea6340100e2a1059d262a53ae4a7", "committedDate": "2020-10-30T21:43:07Z", "message": "fix"}, "afterCommit": {"oid": "acac977240bf45649358961a128bc1e101bad440", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/acac977240bf45649358961a128bc1e101bad440", "committedDate": "2020-11-02T16:45:46Z", "message": "DB-10350 address code review, test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acac977240bf45649358961a128bc1e101bad440", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/acac977240bf45649358961a128bc1e101bad440", "committedDate": "2020-11-02T16:45:46Z", "message": "DB-10350 address code review, test"}, "afterCommit": {"oid": "979cf0f1be323dd12f615eddab473c00598d71c0", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/979cf0f1be323dd12f615eddab473c00598d71c0", "committedDate": "2020-11-02T21:42:05Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMzYwMTYz", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-522360163", "createdAt": "2020-11-03T10:26:36Z", "commit": {"oid": "e645c489e64aef9af555909030a966db686b823a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzY2NjQz", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-522766643", "createdAt": "2020-11-03T18:22:55Z", "commit": {"oid": "e645c489e64aef9af555909030a966db686b823a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDY3NjA4", "url": "https://github.com/splicemachine/spliceengine/pull/4266#pullrequestreview-523067608", "createdAt": "2020-11-04T06:16:27Z", "commit": {"oid": "e645c489e64aef9af555909030a966db686b823a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d052bcc44dc94d9248e3cb80084bd5794a9398d", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/7d052bcc44dc94d9248e3cb80084bd5794a9398d", "committedDate": "2020-11-04T08:12:11Z", "message": "DB-10350 Special import mode that does not check referential integrity or fire triggers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c61b10747be2e2fe020a9f2f95d42f174f7c20e8", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/c61b10747be2e2fe020a9f2f95d42f174f7c20e8", "committedDate": "2020-11-04T08:12:11Z", "message": "DB-10350 address code review: using savepoints to rollback failed inserts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e645c489e64aef9af555909030a966db686b823a", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/e645c489e64aef9af555909030a966db686b823a", "committedDate": "2020-11-03T09:54:06Z", "message": "DB-10350 address code review: using savepoints to rollback failed inserts"}, "afterCommit": {"oid": "c61b10747be2e2fe020a9f2f95d42f174f7c20e8", "author": {"user": {"login": "martinrupp", "name": "Martin Rupp"}}, "url": "https://github.com/splicemachine/spliceengine/commit/c61b10747be2e2fe020a9f2f95d42f174f7c20e8", "committedDate": "2020-11-04T08:12:11Z", "message": "DB-10350 address code review: using savepoints to rollback failed inserts"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1094, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}