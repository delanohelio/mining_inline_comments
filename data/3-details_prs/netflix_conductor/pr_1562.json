{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MjAzMjQz", "number": 1562, "title": "Add a new task def attribute to support task poll timeout", "bodyText": "As explained here: #407", "createdAt": "2020-03-05T10:50:56Z", "url": "https://github.com/Netflix/conductor/pull/1562", "merged": true, "mergeCommit": {"oid": "70743a612ae03f26ac2241015504cb1189bb618a"}, "closed": true, "closedAt": "2020-03-16T23:38:33Z", "author": {"login": "nbraquart"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKpTTZgBqjMxMDA2Njk5NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOW2WhAFqTM3NTY1MTM0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce51b9fcd80edd03574460317602536ff1644c1a", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/ce51b9fcd80edd03574460317602536ff1644c1a", "committedDate": "2020-03-05T10:48:59Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "d28d220cba9adf36efac7186d68bdfd88359521d", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/d28d220cba9adf36efac7186d68bdfd88359521d", "committedDate": "2020-03-05T10:52:11Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDg1Mjcz", "url": "https://github.com/Netflix/conductor/pull/1562#pullrequestreview-369485273", "createdAt": "2020-03-05T11:15:48Z", "commit": {"oid": "d28d220cba9adf36efac7186d68bdfd88359521d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMToxNTo0OFrOFyPo2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMToxNTo0OFrOFyPo2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIyOTMzNg==", "bodyText": "if taskDef.getPollTimeoutSeconds() is null (the case for all tasks defined before that functionality has been merged, and it's optional), this check is a bit weird.\nPerhaps only checking it's not null is enough instead.", "url": "https://github.com/Netflix/conductor/pull/1562#discussion_r388229336", "createdAt": "2020-03-05T11:15:48Z", "author": {"login": "Jiehong"}, "path": "core/src/main/java/com/netflix/conductor/core/execution/DeciderService.java", "diffHunk": "@@ -524,23 +524,38 @@ void checkTaskTimeout(TaskDef taskDef, Task task) {\n             LOGGER.warn(\"Missing task definition for task:{}/{} in workflow:{}\", task.getTaskId(), task.getTaskDefName(), task.getWorkflowInstanceId());\n             return;\n         }\n-        if (task.getStatus().isTerminal() || taskDef.getTimeoutSeconds() <= 0 || task.getStartTime() <= 0) {\n+        if (task.getStatus().isTerminal()) {\n             return;\n         }\n \n-        long timeout = 1000L * taskDef.getTimeoutSeconds();\n-        long now = System.currentTimeMillis();\n-        long elapsedTime = now - (task.getStartTime() + ((long) task.getStartDelayInSeconds() * 1000L));\n+        String reason = null;\n+        final long now = System.currentTimeMillis();\n+        final long startDelay = 1000L * task.getStartDelayInSeconds();\n \n-        if (elapsedTime < timeout) {\n-            return;\n+        if (task.getStatus().equals(SCHEDULED) && taskDef.getPollTimeoutSeconds() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d28d220cba9adf36efac7186d68bdfd88359521d"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDg2NTIy", "url": "https://github.com/Netflix/conductor/pull/1562#pullrequestreview-369486522", "createdAt": "2020-03-05T11:17:52Z", "commit": {"oid": "d28d220cba9adf36efac7186d68bdfd88359521d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMToxNzo1MlrOFyPsoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMToxNzo1MlrOFyPsoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIzMDMwNQ==", "bodyText": "This field shouldn't be allowed to be negative. Could you please add a @Min like for responseTimeoutSeconds ?", "url": "https://github.com/Netflix/conductor/pull/1562#discussion_r388230305", "createdAt": "2020-03-05T11:17:52Z", "author": {"login": "Jiehong"}, "path": "common/src/main/java/com/netflix/conductor/common/metadata/tasks/TaskDef.java", "diffHunk": "@@ -113,6 +113,9 @@\n \t@Email(message = \"ownerEmail should be valid email address\")\n \tprivate String ownerEmail;\n \n+\t@ProtoField(id = 19)\n+\tprivate Integer pollTimeoutSeconds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d28d220cba9adf36efac7186d68bdfd88359521d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTE5MDc5", "url": "https://github.com/Netflix/conductor/pull/1562#pullrequestreview-369519079", "createdAt": "2020-03-05T12:13:45Z", "commit": {"oid": "d28d220cba9adf36efac7186d68bdfd88359521d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMjoxMzo0NVrOFyRQGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMjoxMzo0NVrOFyRQGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1NTc2OQ==", "bodyText": "maybe use Optional?", "url": "https://github.com/Netflix/conductor/pull/1562#discussion_r388255769", "createdAt": "2020-03-05T12:13:45Z", "author": {"login": "andrea11"}, "path": "core/src/main/java/com/netflix/conductor/core/execution/DeciderService.java", "diffHunk": "@@ -524,23 +524,38 @@ void checkTaskTimeout(TaskDef taskDef, Task task) {\n             LOGGER.warn(\"Missing task definition for task:{}/{} in workflow:{}\", task.getTaskId(), task.getTaskDefName(), task.getWorkflowInstanceId());\n             return;\n         }\n-        if (task.getStatus().isTerminal() || taskDef.getTimeoutSeconds() <= 0 || task.getStartTime() <= 0) {\n+        if (task.getStatus().isTerminal()) {\n             return;\n         }\n \n-        long timeout = 1000L * taskDef.getTimeoutSeconds();\n-        long now = System.currentTimeMillis();\n-        long elapsedTime = now - (task.getStartTime() + ((long) task.getStartDelayInSeconds() * 1000L));\n+        String reason = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d28d220cba9adf36efac7186d68bdfd88359521d"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d28d220cba9adf36efac7186d68bdfd88359521d", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/d28d220cba9adf36efac7186d68bdfd88359521d", "committedDate": "2020-03-05T10:52:11Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "0c1ff54bbd03794327f02fce6cafba24194c84de", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/0c1ff54bbd03794327f02fce6cafba24194c84de", "committedDate": "2020-03-05T13:13:07Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c1ff54bbd03794327f02fce6cafba24194c84de", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/0c1ff54bbd03794327f02fce6cafba24194c84de", "committedDate": "2020-03-05T13:13:07Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "a71efb85b545e195f81fd5ead4d2b9a241bbed0f", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/a71efb85b545e195f81fd5ead4d2b9a241bbed0f", "committedDate": "2020-03-05T13:14:03Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a71efb85b545e195f81fd5ead4d2b9a241bbed0f", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/a71efb85b545e195f81fd5ead4d2b9a241bbed0f", "committedDate": "2020-03-05T13:14:03Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "1dc5bd18f62384ad9922260c32a0b4c0483e3f64", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/1dc5bd18f62384ad9922260c32a0b4c0483e3f64", "committedDate": "2020-03-05T13:16:57Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTU4OTUx", "url": "https://github.com/Netflix/conductor/pull/1562#pullrequestreview-369558951", "createdAt": "2020-03-05T13:18:32Z", "commit": {"oid": "1dc5bd18f62384ad9922260c32a0b4c0483e3f64"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1dc5bd18f62384ad9922260c32a0b4c0483e3f64", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/1dc5bd18f62384ad9922260c32a0b4c0483e3f64", "committedDate": "2020-03-05T13:16:57Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "4c9a464fe540a72d75e99f17af09451f42b5b853", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/4c9a464fe540a72d75e99f17af09451f42b5b853", "committedDate": "2020-03-05T13:18:52Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c9a464fe540a72d75e99f17af09451f42b5b853", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/4c9a464fe540a72d75e99f17af09451f42b5b853", "committedDate": "2020-03-05T13:18:52Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "555419ff2ad77feb255e8895772bc3b68883a19c", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/555419ff2ad77feb255e8895772bc3b68883a19c", "committedDate": "2020-03-05T13:20:08Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "555419ff2ad77feb255e8895772bc3b68883a19c", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/555419ff2ad77feb255e8895772bc3b68883a19c", "committedDate": "2020-03-05T13:20:08Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "3c0f0eb98f884674cd244bfa257a63e78842f72a", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/3c0f0eb98f884674cd244bfa257a63e78842f72a", "committedDate": "2020-03-05T13:20:51Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c0f0eb98f884674cd244bfa257a63e78842f72a", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/3c0f0eb98f884674cd244bfa257a63e78842f72a", "committedDate": "2020-03-05T13:20:51Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "87f03f88b2b872c8321f53061ed2998a7281dac2", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/87f03f88b2b872c8321f53061ed2998a7281dac2", "committedDate": "2020-03-05T13:23:11Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87f03f88b2b872c8321f53061ed2998a7281dac2", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/87f03f88b2b872c8321f53061ed2998a7281dac2", "committedDate": "2020-03-05T13:23:11Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "fb1c6f1715b3ae16b5143e7956f205f854998e00", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/fb1c6f1715b3ae16b5143e7956f205f854998e00", "committedDate": "2020-03-05T13:47:14Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzAzNTUy", "url": "https://github.com/Netflix/conductor/pull/1562#pullrequestreview-370703552", "createdAt": "2020-03-07T00:48:04Z", "commit": {"oid": "fb1c6f1715b3ae16b5143e7956f205f854998e00"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDo0ODowNFrOFzLW1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDo0ODowNFrOFzLW1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNzc2Ng==", "bodyText": "When a task is sent back from the worker with callbackAfterSeconds set and IN_PROGRESS status, Conductor will mark this task as SCHEDULED and set it to invisible state in the queue to be available for polling after the specified callbackAfterSeconds. Reference\nIn these cases, the pollElapsedTime calculation here would wrongly mark this task to be poll timed out. This calculation would need to take into account, this scenario of callbackAfterSeconds and invisibility period on the queues. A similar time calculation can be found in the isResponseTimedOut method in this class for reference.", "url": "https://github.com/Netflix/conductor/pull/1562#discussion_r389207766", "createdAt": "2020-03-07T00:48:04Z", "author": {"login": "apanicker-nflx"}, "path": "core/src/main/java/com/netflix/conductor/core/execution/DeciderService.java", "diffHunk": "@@ -536,8 +537,36 @@ void checkTaskTimeout(TaskDef taskDef, Task task) {\n             return;\n         }\n \n-        String reason = String.format(\"Task timed out after %d seconds. Timeout configured as %d. \"\n-            + \"Timeout policy configured to %s\", elapsedTime/1000L, timeout, taskDef.getTimeoutPolicy().name());\n+        String reason = String.format(\"Task timed out after %d seconds. Timeout configured as %d seconds. \"\n+            + \"Timeout policy configured to %s\", elapsedTime / 1000L, timeout / 1000L, taskDef.getTimeoutPolicy().name());\n+        timeoutTaskWithTimeoutPolicy(reason, taskDef, task);\n+    }\n+\n+    @VisibleForTesting\n+    void checkTaskPollTimeout(TaskDef taskDef, Task task) {\n+        if (taskDef == null) {\n+            LOGGER.warn(\"Missing task definition for task:{}/{} in workflow:{}\", task.getTaskId(), task.getTaskDefName(), task.getWorkflowInstanceId());\n+            return;\n+        }\n+        if (taskDef.getPollTimeoutSeconds() == null || taskDef.getPollTimeoutSeconds() <= 0 || !task.getStatus().equals(SCHEDULED)) {\n+            return;\n+        }\n+\n+        final long pollTimeout = 1000L * taskDef.getPollTimeoutSeconds();\n+        final long now = System.currentTimeMillis();\n+        final long pollElapsedTime = now - (task.getScheduledTime() + ((long) task.getStartDelayInSeconds() * 1000L));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1c6f1715b3ae16b5143e7956f205f854998e00"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f1cebde86ceb85913a62b6c422a1e53bb25372e", "author": {"user": {"login": "nbraquart", "name": "Nicolas"}}, "url": "https://github.com/Netflix/conductor/commit/4f1cebde86ceb85913a62b6c422a1e53bb25372e", "committedDate": "2020-03-09T09:05:39Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb1c6f1715b3ae16b5143e7956f205f854998e00", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/fb1c6f1715b3ae16b5143e7956f205f854998e00", "committedDate": "2020-03-05T13:47:14Z", "message": "Add a new task def attribute to support task poll timeout"}, "afterCommit": {"oid": "4f1cebde86ceb85913a62b6c422a1e53bb25372e", "author": {"user": {"login": "nbraquart", "name": "Nicolas"}}, "url": "https://github.com/Netflix/conductor/commit/4f1cebde86ceb85913a62b6c422a1e53bb25372e", "committedDate": "2020-03-09T09:05:39Z", "message": "Add a new task def attribute to support task poll timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjUxMzQ3", "url": "https://github.com/Netflix/conductor/pull/1562#pullrequestreview-375651347", "createdAt": "2020-03-16T23:38:18Z", "commit": {"oid": "4f1cebde86ceb85913a62b6c422a1e53bb25372e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 850, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}