{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMTE0ODY1", "number": 1480, "title": "fix task poll NPE", "bodyText": "Closes #1477", "createdAt": "2020-01-07T18:26:08Z", "url": "https://github.com/Netflix/conductor/pull/1480", "merged": true, "mergeCommit": {"oid": "0be10bb0cbd6448eaaf91c636698d55ce1765b74"}, "closed": true, "closedAt": "2020-01-07T19:29:44Z", "author": {"login": "apanicker-nflx"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4FBEjgH2gAyMzYwMTE0ODY1OmIxY2NiOGNkMjhlZTM4YzgxMTBiN2U3NjQ4YmU3ZDc3ZTc2ZGU5YjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4FxzsgFqTMzOTQ0OTIxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b1ccb8cd28ee38c8110b7e7648be7d77e76de9b4", "author": {"user": {"login": "apanicker-nflx", "name": "Anoop Panicker"}}, "url": "https://github.com/Netflix/conductor/commit/b1ccb8cd28ee38c8110b7e7648be7d77e76de9b4", "committedDate": "2020-01-07T18:25:23Z", "message": "fix task poll NPE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDQ5MjE1", "url": "https://github.com/Netflix/conductor/pull/1480#pullrequestreview-339449215", "createdAt": "2020-01-07T19:18:09Z", "commit": {"oid": "b1ccb8cd28ee38c8110b7e7648be7d77e76de9b4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxOToxODowOVrOFbDJYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxOToxODowOVrOFbDJYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzkwNzQyNw==", "bodyText": "Is it intentional to have two thenReturn statements?", "url": "https://github.com/Netflix/conductor/pull/1480#discussion_r363907427", "createdAt": "2020-01-07T19:18:09Z", "author": {"login": "kishorebanala"}, "path": "client/src/test/java/com/netflix/conductor/client/automator/TaskPollExecutorTest.java", "diffHunk": "@@ -166,14 +164,45 @@ public void testTaskPollException() {\n         Worker worker = mock(Worker.class);\n         when(worker.getPollingInterval()).thenReturn(3000);\n         when(worker.getTaskDefName()).thenReturn(\"test\");\n-        when(worker.preAck(any())).thenReturn(true);\n         when(worker.execute(any())).thenReturn(new TaskResult(task));\n \n         TaskClient taskClient = Mockito.mock(TaskClient.class);\n         when(taskClient.pollTask(any(), any(), any()))\n             .thenThrow(ConductorClientException.class)\n             .thenReturn(task);\n-        when(taskClient.ack(any(), any())).thenReturn(true);\n+\n+        TaskPollExecutor taskPollExecutor = new TaskPollExecutor(null, taskClient, 1, 1, \"test-worker-\");\n+        CountDownLatch latch = new CountDownLatch(1);\n+        doAnswer(invocation -> {\n+                Object[] args = invocation.getArguments();\n+                TaskResult result = (TaskResult) args[0];\n+                assertEquals(IN_PROGRESS, result.getStatus());\n+                assertEquals(task.getTaskId(), result.getTaskId());\n+                latch.countDown();\n+                return null;\n+            }\n+        ).when(taskClient).updateTask(any());\n+\n+        Executors.newSingleThreadScheduledExecutor()\n+            .scheduleAtFixedRate(() -> taskPollExecutor.pollAndExecute(worker), 0, 1, TimeUnit.SECONDS);\n+\n+        Uninterruptibles.awaitUninterruptibly(latch);\n+        verify(taskClient).updateTask(any());\n+    }\n+\n+    @Test\n+    public void testTaskPoll() {\n+        Task task = testTask();\n+\n+        Worker worker = mock(Worker.class);\n+        when(worker.getPollingInterval()).thenReturn(3000);\n+        when(worker.getTaskDefName()).thenReturn(\"test\");\n+        when(worker.execute(any())).thenReturn(new TaskResult(task));\n+\n+        TaskClient taskClient = Mockito.mock(TaskClient.class);\n+        when(taskClient.pollTask(any(), any(), any()))\n+            .thenReturn(new Task())\n+            .thenReturn(task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1ccb8cd28ee38c8110b7e7648be7d77e76de9b4"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 835, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}