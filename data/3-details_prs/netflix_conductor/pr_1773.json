{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MDcwMzkw", "number": 1773, "title": "added back the changes necessary to handle subworkflow termination", "bodyText": "@apanicker-nflx Sorry, it looks like you merged my PR #1608 right in the middle of my changes to support Kishore's last request to change an exception message. You merged it right as I had reverted WorkflowExecutor to the dev version so I could merge it. So now it doesn't contain any of my changes. This PR will add that code back. I see you made additional changes after that merge so I honored those changes in this PR.", "createdAt": "2020-07-09T20:12:46Z", "url": "https://github.com/Netflix/conductor/pull/1773", "merged": true, "mergeCommit": {"oid": "80c08604f5e78ac36f615bcde8877598a1d52381"}, "closed": true, "closedAt": "2020-08-03T23:23:42Z", "author": {"login": "rickfish"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczUxnhgH2gAyNDQ3MDcwMzkwOjBlZmZkNzQ5N2Q5OWE5NmQyYmU3ZGQwYWRjOWQzNGVhN2IyNmUzMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7ajHVAFqTQ2MDM5OTc4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0effd7497d99a96d2be7dd0adc9d34ea7b26e326", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/0effd7497d99a96d2be7dd0adc9d34ea7b26e326", "committedDate": "2020-07-09T20:08:31Z", "message": "added back the changes necessary to handle the termination of subworkflows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d667ec48cefa4abb2a1b4a2fe80a2ceb4700c8e", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/8d667ec48cefa4abb2a1b4a2fe80a2ceb4700c8e", "committedDate": "2020-07-21T14:08:01Z", "message": "Merge branch 'dev' of https://github.com/Netflix/conductor into terminate-task-handle-nonterminal-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54f8dac3cab52e0a560142d9d3252bfa1915fd94", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/54f8dac3cab52e0a560142d9d3252bfa1915fd94", "committedDate": "2020-07-27T19:34:28Z", "message": "work on test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe8e8e8bfd0563e486f8776cefe4e15b8a753c58", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/fe8e8e8bfd0563e486f8776cefe4e15b8a753c58", "committedDate": "2020-07-28T19:47:44Z", "message": "add test case for parent workflow with terminate task and subworkflow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef3db221c0813a67d5011a0555eaf2be5c51d801", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/ef3db221c0813a67d5011a0555eaf2be5c51d801", "committedDate": "2020-07-28T20:13:22Z", "message": "add import of TaskResult"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5e628b1ffc16b86ba883f0f1c25892adba31b1a", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/a5e628b1ffc16b86ba883f0f1c25892adba31b1a", "committedDate": "2020-07-28T20:43:24Z", "message": "allow SUB_WORKFLOW to be in either SCHEDULED or IN_PROGRESS state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb4f87b9469d4a8bd14f98d00ae5f2f32e999d53", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/eb4f87b9469d4a8bd14f98d00ae5f2f32e999d53", "committedDate": "2020-07-28T20:53:02Z", "message": "allow SUB_WORKFLOW to be in either SCHEDULED or IN_PROGRESS state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4215ac3b3d3efcb5016e28b59a3b4ea2c7c7143", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/d4215ac3b3d3efcb5016e28b59a3b4ea2c7c7143", "committedDate": "2020-07-28T21:13:33Z", "message": "take out condition for SUB_WORKFLOW status, not necessary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "069cd39089e55ebb367a7fd61c456f91347e5e92", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/069cd39089e55ebb367a7fd61c456f91347e5e92", "committedDate": "2020-07-28T21:34:16Z", "message": "make new test fail with the old code to verify that the new code fixed it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0126592a1381b3596b78168576d92dca8d49c999", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/0126592a1381b3596b78168576d92dca8d49c999", "committedDate": "2020-07-28T21:36:34Z", "message": "add back new code to fix the issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTM0MTcz", "url": "https://github.com/Netflix/conductor/pull/1773#pullrequestreview-457934173", "createdAt": "2020-07-29T22:11:37Z", "commit": {"oid": "0126592a1381b3596b78168576d92dca8d49c999"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjoxMTozN1rOG5MD7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMjoxMjozMlrOG5MFWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxOTYzMA==", "bodyText": "Instead of checking for negation, can we explicitly check for expected state? In this case SKIPPED.", "url": "https://github.com/Netflix/conductor/pull/1773#discussion_r462619630", "createdAt": "2020-07-29T22:11:37Z", "author": {"login": "kishorebanala"}, "path": "test-harness/src/test/groovy/com/netflix/counductor/integration/test/LambdaAndTerminalTaskSpec.groovy", "diffHunk": "@@ -110,6 +119,62 @@ class LambdaAndTerminalTaskSpec extends Specification {\n         }\n     }\n \n+    def \"Test workflow with a terminate task when the workflow has a subworkflow\"() {\n+        given: \"workflow input\"\n+        def workflowInput = new HashMap()\n+        workflowInput['a'] = 1\n+\n+        when: \"Start the workflow which has the terminate task\"\n+        def workflowInstanceId = workflowExecutor.startWorkflow(PARENT_WORKFLOW_WITH_TERMINATE_TASK, 1,\n+                '', workflowInput, null, null, null)\n+\n+        then: \"verify that the workflow has started and the tasks are as expected\"\n+        with(workflowExecutionService.getExecutionStatus(workflowInstanceId, true)) {\n+            status == Workflow.WorkflowStatus.RUNNING\n+            tasks.size() == 6\n+            tasks[0].status == Task.Status.COMPLETED\n+            tasks[0].taskType == 'FORK'\n+            tasks[1].status == Task.Status.COMPLETED\n+            tasks[1].taskType == 'LAMBDA'\n+            tasks[1].referenceTaskName == 'lambdaTask1'\n+            tasks[2].status == Task.Status.COMPLETED\n+            tasks[2].taskType == 'LAMBDA'\n+            tasks[2].referenceTaskName == 'lambdaTask2'\n+            tasks[3].status == Task.Status.IN_PROGRESS\n+            tasks[3].taskType == 'JOIN'\n+            tasks[4].taskType == 'SUB_WORKFLOW'\n+            tasks[5].status == Task.Status.IN_PROGRESS\n+            tasks[5].taskType == 'WAIT'\n+        }\n+\n+        when: \"Complete the WAIT task that should cause the TERMINATE task to execute\"\n+        def waitTask = workflowExecutionService.getExecutionStatus(workflowInstanceId, true).tasks[5]\n+        waitTask.status = Task.Status.COMPLETED\n+        workflowExecutor.updateTask(new TaskResult(waitTask))\n+\n+        then:\"Verify that the workflow has completed and the SUB_WORKFLOW is not still IN_PROGRESS (should be SKIPPED)\"\n+        with(workflowExecutionService.getExecutionStatus(workflowInstanceId, true)) {\n+            status == Workflow.WorkflowStatus.COMPLETED\n+            tasks.size() == 7\n+            tasks[0].status == Task.Status.COMPLETED\n+            tasks[0].taskType == 'FORK'\n+            tasks[1].status == Task.Status.COMPLETED\n+            tasks[1].taskType == 'LAMBDA'\n+            tasks[1].referenceTaskName == 'lambdaTask1'\n+            tasks[2].status == Task.Status.COMPLETED\n+            tasks[2].taskType == 'LAMBDA'\n+            tasks[2].referenceTaskName == 'lambdaTask2'\n+            tasks[3].status != Task.Status.IN_PROGRESS\n+            tasks[3].taskType == 'JOIN'\n+            tasks[4].status != Task.Status.IN_PROGRESS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0126592a1381b3596b78168576d92dca8d49c999"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYxOTk5NA==", "bodyText": "Shall we also verify that the Subworkflow is not IN_PROGRESS as mentioned in the test method name, to close the verifications loop.", "url": "https://github.com/Netflix/conductor/pull/1773#discussion_r462619994", "createdAt": "2020-07-29T22:12:32Z", "author": {"login": "kishorebanala"}, "path": "test-harness/src/test/groovy/com/netflix/counductor/integration/test/LambdaAndTerminalTaskSpec.groovy", "diffHunk": "@@ -110,6 +119,62 @@ class LambdaAndTerminalTaskSpec extends Specification {\n         }\n     }\n \n+    def \"Test workflow with a terminate task when the workflow has a subworkflow\"() {\n+        given: \"workflow input\"\n+        def workflowInput = new HashMap()\n+        workflowInput['a'] = 1\n+\n+        when: \"Start the workflow which has the terminate task\"\n+        def workflowInstanceId = workflowExecutor.startWorkflow(PARENT_WORKFLOW_WITH_TERMINATE_TASK, 1,\n+                '', workflowInput, null, null, null)\n+\n+        then: \"verify that the workflow has started and the tasks are as expected\"\n+        with(workflowExecutionService.getExecutionStatus(workflowInstanceId, true)) {\n+            status == Workflow.WorkflowStatus.RUNNING\n+            tasks.size() == 6\n+            tasks[0].status == Task.Status.COMPLETED\n+            tasks[0].taskType == 'FORK'\n+            tasks[1].status == Task.Status.COMPLETED\n+            tasks[1].taskType == 'LAMBDA'\n+            tasks[1].referenceTaskName == 'lambdaTask1'\n+            tasks[2].status == Task.Status.COMPLETED\n+            tasks[2].taskType == 'LAMBDA'\n+            tasks[2].referenceTaskName == 'lambdaTask2'\n+            tasks[3].status == Task.Status.IN_PROGRESS\n+            tasks[3].taskType == 'JOIN'\n+            tasks[4].taskType == 'SUB_WORKFLOW'\n+            tasks[5].status == Task.Status.IN_PROGRESS\n+            tasks[5].taskType == 'WAIT'\n+        }\n+\n+        when: \"Complete the WAIT task that should cause the TERMINATE task to execute\"\n+        def waitTask = workflowExecutionService.getExecutionStatus(workflowInstanceId, true).tasks[5]\n+        waitTask.status = Task.Status.COMPLETED\n+        workflowExecutor.updateTask(new TaskResult(waitTask))\n+\n+        then:\"Verify that the workflow has completed and the SUB_WORKFLOW is not still IN_PROGRESS (should be SKIPPED)\"\n+        with(workflowExecutionService.getExecutionStatus(workflowInstanceId, true)) {\n+            status == Workflow.WorkflowStatus.COMPLETED\n+            tasks.size() == 7\n+            tasks[0].status == Task.Status.COMPLETED\n+            tasks[0].taskType == 'FORK'\n+            tasks[1].status == Task.Status.COMPLETED\n+            tasks[1].taskType == 'LAMBDA'\n+            tasks[1].referenceTaskName == 'lambdaTask1'\n+            tasks[2].status == Task.Status.COMPLETED\n+            tasks[2].taskType == 'LAMBDA'\n+            tasks[2].referenceTaskName == 'lambdaTask2'\n+            tasks[3].status != Task.Status.IN_PROGRESS\n+            tasks[3].taskType == 'JOIN'\n+            tasks[4].status != Task.Status.IN_PROGRESS\n+            tasks[4].taskType == 'SUB_WORKFLOW'\n+            tasks[5].status == Task.Status.COMPLETED\n+            tasks[5].taskType == 'WAIT'\n+            tasks[6].status == Task.Status.COMPLETED\n+            tasks[6].taskType == 'TERMINATE'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0126592a1381b3596b78168576d92dca8d49c999"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e50dced5fcd2ab062c9167f8123e988750b2d202", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/e50dced5fcd2ab062c9167f8123e988750b2d202", "committedDate": "2020-07-30T10:58:32Z", "message": "Merge branch 'dev' of https://github.com/Netflix/conductor into terminate-task-handle-nonterminal-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cc242056b509c8e35033d889206df582a9c7110", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/0cc242056b509c8e35033d889206df582a9c7110", "committedDate": "2020-07-30T11:02:56Z", "message": "made changes to test cases based on feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzk5Nzg0", "url": "https://github.com/Netflix/conductor/pull/1773#pullrequestreview-460399784", "createdAt": "2020-08-03T23:23:30Z", "commit": {"oid": "0cc242056b509c8e35033d889206df582a9c7110"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 821, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}