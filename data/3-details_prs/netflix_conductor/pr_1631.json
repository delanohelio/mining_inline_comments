{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMDI5Mjgz", "number": 1631, "title": "Update elasticsearch when workflows get paused/resumed", "bodyText": "When workflows get paused or resumed, indexDAO.indexWorkflow() is not invoked so the workflow status stays at RUNNING even if it is PAUSED. Therefore you cannot get an accurate list of workflows when using workflow/search with freeText of status:PAUSED. This calls indexWorkflow() when the workflow is paused or resumed.", "createdAt": "2020-04-08T19:14:22Z", "url": "https://github.com/Netflix/conductor/pull/1631", "merged": true, "mergeCommit": {"oid": "8a3dfc1a91932f74af5485452bed797d3ee05691"}, "closed": true, "closedAt": "2020-04-28T00:04:45Z", "author": {"login": "rickfish"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVszstgH2gAyNDAxMDI5MjgzOjgxNGQ4NzkxNWRlZDlkOGE4MWNiMjM1YWI2MGRhY2E3ZmI3NGNmN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb4YszAFqTQwMTQwOTYzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "814d87915ded9d8a81cb235ab60daca7fb74cf7a", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/814d87915ded9d8a81cb235ab60daca7fb74cf7a", "committedDate": "2020-04-08T19:10:47Z", "message": "send paused and resumed workflows to elasticsearch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbd509ae1bb0075715549e51664ba972e521a708", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/dbd509ae1bb0075715549e51664ba972e521a708", "committedDate": "2020-04-08T19:16:05Z", "message": "send paused and resumed workflows to elasticsearch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c73ef9d9680b461c56fb6e317adeefe7e1a8c6d0", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/c73ef9d9680b461c56fb6e317adeefe7e1a8c6d0", "committedDate": "2020-04-15T15:24:40Z", "message": "Merge branch 'dev' of https://github.com/Netflix/conductor into bugfix/index-paused-workflows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81b9ee0f2046ae0695f0a68fbfbea9a2e517ac07", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/81b9ee0f2046ae0695f0a68fbfbea9a2e517ac07", "committedDate": "2020-04-15T16:46:07Z", "message": "always index workflows regardless of terminal state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzcwODE1", "url": "https://github.com/Netflix/conductor/pull/1631#pullrequestreview-397770815", "createdAt": "2020-04-22T00:52:36Z", "commit": {"oid": "81b9ee0f2046ae0695f0a68fbfbea9a2e517ac07"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMDo1MjozNlrOGJehhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMDo1MjozNlrOGJehhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU5MDQ2OA==", "bodyText": "As part of async indexing, the contract is that task data for a workflow will only be indexed when a workflow reaches a terminal state. Please move this line to within the if block above.", "url": "https://github.com/Netflix/conductor/pull/1631#discussion_r412590468", "createdAt": "2020-04-22T00:52:36Z", "author": {"login": "apanicker-nflx"}, "path": "core/src/main/java/com/netflix/conductor/core/orchestration/ExecutionDAOFacade.java", "diffHunk": "@@ -215,21 +215,19 @@ public String updateWorkflow(Workflow workflow) {\n             workflow.setEndTime(System.currentTimeMillis());\n         }\n         executionDAO.updateWorkflow(workflow);\n-        if (workflow.getStatus().isTerminal()) {\n-            if (config.enableAsyncIndexing()) {\n-                if (workflow.getEndTime() - workflow.getStartTime() < config.getAsyncUpdateShortRunningWorkflowDuration() * 1000) {\n-                    final String workflowId = workflow.getWorkflowId();\n-                    DelayWorkflowUpdate delayWorkflowUpdate = new DelayWorkflowUpdate(workflowId);\n-                    LOGGER.debug(\"Delayed updating workflow: {} in the index by {} seconds\", workflowId, config.getAsyncUpdateDelay());\n-                    scheduledThreadPoolExecutor.schedule(delayWorkflowUpdate, config.getAsyncUpdateDelay(), TimeUnit.SECONDS);\n-                    Monitors.recordWorkerQueueSize(\"delayQueue\", scheduledThreadPoolExecutor.getQueue().size());\n-                } else {\n-                    indexDAO.asyncIndexWorkflow(workflow);\n-                }\n-                workflow.getTasks().forEach(indexDAO::asyncIndexTask);\n+        if (config.enableAsyncIndexing()) {\n+            if (workflow.getStatus().isTerminal() && workflow.getEndTime() - workflow.getStartTime() < config.getAsyncUpdateShortRunningWorkflowDuration() * 1000) {\n+                final String workflowId = workflow.getWorkflowId();\n+                DelayWorkflowUpdate delayWorkflowUpdate = new DelayWorkflowUpdate(workflowId);\n+                LOGGER.debug(\"Delayed updating workflow: {} in the index by {} seconds\", workflowId, config.getAsyncUpdateDelay());\n+                scheduledThreadPoolExecutor.schedule(delayWorkflowUpdate, config.getAsyncUpdateDelay(), TimeUnit.SECONDS);\n+                Monitors.recordWorkerQueueSize(\"delayQueue\", scheduledThreadPoolExecutor.getQueue().size());\n             } else {\n-                indexDAO.indexWorkflow(workflow);\n+                indexDAO.asyncIndexWorkflow(workflow);\n             }\n+            workflow.getTasks().forEach(indexDAO::asyncIndexTask);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b9ee0f2046ae0695f0a68fbfbea9a2e517ac07"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ed49dfec320d3a3915bddf03d6037add5d8c91b", "author": {"user": null}, "url": "https://github.com/Netflix/conductor/commit/5ed49dfec320d3a3915bddf03d6037add5d8c91b", "committedDate": "2020-04-22T11:24:02Z", "message": "if asyncIndexing, only index tasks if workflow is in terminal state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDA5NjM0", "url": "https://github.com/Netflix/conductor/pull/1631#pullrequestreview-401409634", "createdAt": "2020-04-28T00:03:43Z", "commit": {"oid": "5ed49dfec320d3a3915bddf03d6037add5d8c91b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 756, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}