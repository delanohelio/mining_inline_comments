{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MDczNjQ2", "number": 3025, "title": "fix timeout inheritance in mirror.py", "bodyText": "This change fixes bug in timeout properties not being used in mirror.py at all unless configured on project level.\nThe added tests merely check parameter passing between functions. More robust test would be e.g. to use GitPython in git.py (as suggested in #2852), mock it to timeout the pull operation and verify the timeout in tests.", "createdAt": "2020-01-17T10:30:32Z", "url": "https://github.com/oracle/opengrok/pull/3025", "merged": true, "mergeCommit": {"oid": "cf1700cdb9b464f38055f898107a40ed92ddc04a"}, "closed": true, "closedAt": "2020-01-30T11:44:49Z", "author": {"login": "vladak"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7L2VjAH2gAyMzY0MDczNjQ2OjQyM2IwMWNiYmUyODUwYTFhZWUxNzg3NDNlODllODA0N2Q1MjY3ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_CMOJgFqTM0OTk0OTk2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "423b01cbbe2850a1aee178743e89e8047d526784", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/423b01cbbe2850a1aee178743e89e8047d526784", "committedDate": "2020-01-17T10:04:46Z", "message": "add basic tests\n\n- per-project timeouts in mirror_project()\n- basic repository factory test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f54599920307272664369745a1b6f5493b298184", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/f54599920307272664369745a1b6f5493b298184", "committedDate": "2020-01-17T10:06:37Z", "message": "log a message when terminating the process"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c256f54b71232725e7b7025f1cb560b60b21fb97", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/c256f54b71232725e7b7025f1cb560b60b21fb97", "committedDate": "2020-01-17T10:07:16Z", "message": "fix year"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NTYzMDk4", "url": "https://github.com/oracle/opengrok/pull/3025#pullrequestreview-344563098", "createdAt": "2020-01-17T13:03:10Z", "commit": {"oid": "8585961ee1fdf7181f043f2ee49f482c14d32201"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMzowMzoxMVrOFe4Vsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMzoxNjoxMlrOFe4o-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyNDY1OA==", "bodyText": "I understand you want to avoid modifying kwargs but this fix assumes it's safe to set timeout afterwards. It is fine as of today but it isn't guaranteed in the future. Someone may make Command immutable or change its internal logic for some reason (for example it may cache and/or prevent you from setting timeout).\nIt's cleaner if arguments like timeout are passed once, at object creation, as part of kwargs. For example keeping the original code but using a shallow copy dictionary:\nkwargs = kwargs.copy()\nkwargs['timeout'] = self.timeout\nreturn Command(cmd, **kwargs)\n\nIn case you wonder a shallow copy is lightweight unlike a deep copy.", "url": "https://github.com/oracle/opengrok/pull/3025#discussion_r367924658", "createdAt": "2020-01-17T13:03:11Z", "author": {"login": "eric-saintetienne"}, "path": "opengrok-tools/src/main/python/opengrok_tools/scm/repository.py", "diffHunk": "@@ -54,8 +54,9 @@ def __str__(self):\n         return self.path\n \n     def getCommand(self, cmd, **kwargs):\n-        kwargs['timeout'] = self.timeout\n-        return Command(cmd, **kwargs)\n+        cmd = Command(cmd, **kwargs)\n+        cmd.timeout = self.timeout", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8585961ee1fdf7181f043f2ee49f482c14d32201"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkyOTU5Mw==", "bodyText": "How about reworking get_repository() to accept a kwargs so you can tailor a dictionary and just pass it as **kwargs? It would be neater and cleaner.", "url": "https://github.com/oracle/opengrok/pull/3025#discussion_r367929593", "createdAt": "2020-01-17T13:16:12Z", "author": {"login": "eric-saintetienne"}, "path": "opengrok-tools/src/main/python/opengrok_tools/utils/mirror.py", "diffHunk": "@@ -99,7 +99,7 @@ def get_repos_for_project(project_name, ignored_repos, uri, source_root,\n                                   kwargs[COMMANDS_PROPERTY],\n                                   kwargs[PROXY_PROPERTY],\n                                   None,\n-                                  kwargs['command_timeout'])\n+                                  kwargs[CMD_TIMEOUT_PROPERTY])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8585961ee1fdf7181f043f2ee49f482c14d32201"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "367704c7738b9aee57e775359698c197c9dab769", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/367704c7738b9aee57e775359698c197c9dab769", "committedDate": "2020-01-28T15:11:52Z", "message": "add timeout inheritance testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f52cc1382817573faeafb0bc67a84326a4959af", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/7f52cc1382817573faeafb0bc67a84326a4959af", "committedDate": "2020-01-28T15:11:52Z", "message": "fix timeut inheritance\n\nfixes #3022"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8585961ee1fdf7181f043f2ee49f482c14d32201", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/8585961ee1fdf7181f043f2ee49f482c14d32201", "committedDate": "2020-01-17T10:24:18Z", "message": "fix timeut inheritance\n\nfixes #3022"}, "afterCommit": {"oid": "7f52cc1382817573faeafb0bc67a84326a4959af", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/7f52cc1382817573faeafb0bc67a84326a4959af", "committedDate": "2020-01-28T15:11:52Z", "message": "fix timeut inheritance\n\nfixes #3022"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5OTQ5OTYx", "url": "https://github.com/oracle/opengrok/pull/3025#pullrequestreview-349949961", "createdAt": "2020-01-29T09:05:19Z", "commit": {"oid": "7f52cc1382817573faeafb0bc67a84326a4959af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 271, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}