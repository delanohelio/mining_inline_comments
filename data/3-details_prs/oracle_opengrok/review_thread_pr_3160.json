{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2ODA0NzI5", "number": 3160, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMjowMjoxOVrOEB-dQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTozMDo1MFrOEjpjUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNTA3MzI4OnYy", "diffSide": "RIGHT", "path": "docker/start.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMjowMjoxOVrOGeJnRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMTo0NzoyNlrOGeYL2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2Nzk3NA==", "bodyText": "Nit: perhaps quote the variable expansion?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434267974", "createdAt": "2020-06-03T02:02:19Z", "author": {"login": "idodeclare"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war /usr/local/tomcat/webapps/${WAR_NAME}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNjcxNA==", "bodyText": "Of course. Not sure how I missed that. I'll fix it with a later patch set.", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434506714", "createdAt": "2020-06-03T11:47:26Z", "author": {"login": "timschumi"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war /usr/local/tomcat/webapps/${WAR_NAME}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2Nzk3NA=="}, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNTExMjY4OnYy", "diffSide": "RIGHT", "path": "docker/start.sh", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMjoyOToyNlrOGeJ_MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNzo1ODo0N1rOGgpxlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDA5Nw==", "bodyText": "In Tomcat, one might specify a context path of e.g. /source/opengrok with an archive named source#opengrok.war. Might that be supported with substitution here?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434274097", "createdAt": "2020-06-03T02:29:26Z", "author": {"login": "idodeclare"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwNzc1Nw==", "bodyText": "I'm unsure whether there are any advantages to that compared to simply filling in the URL-subfolder as-is (with minor changes to unify the format).\nI'd also prefer the path-based version personally, since it's easier to handle and understand (in my opinion).", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434507757", "createdAt": "2020-06-03T11:49:29Z", "author": {"login": "timschumi"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDA5Nw=="}, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0OTI5OQ==", "bodyText": "My question should have been more general: what will happen if the user specifies /source/opengrok as a context?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r436849299", "createdAt": "2020-06-08T16:48:44Z", "author": {"login": "idodeclare"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDA5Nw=="}, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg5MjA1Mg==", "bodyText": "I just noticed that what I intended doesn't actually work. I thought that tomcat resolves the used .war file by the full path (i.e. that a path of /usr/share/tomcat/webapp/source/opengrok.war would result in OpenGrok being accessible at /source/opengrok, although /source is a whole other story), but that apparently only works for ROOT and first-level files.\nI'll do some testing with your suggested substitutions and add a commit if everything seems fine.", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r436892052", "createdAt": "2020-06-08T17:58:47Z", "author": {"login": "timschumi"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDA5Nw=="}, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcwNTExNTIwOnYy", "diffSide": "RIGHT", "path": "docker/start.sh", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMjozMTowOFrOGeKAxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxMTo1MDoyM1rOGeYRvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDUwMQ==", "bodyText": "If OPENGROK_WEBAPP_CONTEXT is empty or contains whitespace, should it be reset earlier to / to benefit this conditional and later usage?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434274501", "createdAt": "2020-06-03T02:31:08Z", "author": {"login": "idodeclare"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDUwODIyMA==", "bodyText": "Sounds good, but we'll have to take a look at format restrictions for the variable later anyways (leading slash, trailing slash, etc.).", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434508220", "createdAt": "2020-06-03T11:50:23Z", "author": {"login": "timschumi"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDUwMQ=="}, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1ODE2NDAwOnYy", "diffSide": "RIGHT", "path": "docker/start.sh", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTozMDo1MFrOHSHpjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxODowNTozMlrOHSN6lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTc0Mw==", "bodyText": "I guess these commands will print errors when run multiple times (e.g. stop/start/stop/start)\nwould it make sense to make them idempotent?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r488761743", "createdAt": "2020-09-15T15:30:50Z", "author": {"login": "tarzanek"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,38 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [[ \"${URL_ROOT}\" = *\" \"* ]]; then\n+\tdate +\"%F %T Deployment path contains spaces. Deploying to root...\"\n+\texport URL_ROOT=\"/\"\n+fi\n+\n+# Remove leading and trailing slashes\n+URL_ROOT=\"${URL_ROOT#/}\"\n+URL_ROOT=\"${URL_ROOT%/}\"\n+\n+if [ \"${URL_ROOT}\" = \"\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${URL_ROOT//\\//#}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war \"/usr/local/tomcat/webapps/${WAR_NAME}\"\n+\n+\t# Set up redirect from /source\n+\tmkdir \"/usr/local/tomcat/webapps/source\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MjQxNQ==", "bodyText": "(while above was run only once when the docker container was created)", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r488762415", "createdAt": "2020-09-15T15:31:47Z", "author": {"login": "tarzanek"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,38 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [[ \"${URL_ROOT}\" = *\" \"* ]]; then\n+\tdate +\"%F %T Deployment path contains spaces. Deploying to root...\"\n+\texport URL_ROOT=\"/\"\n+fi\n+\n+# Remove leading and trailing slashes\n+URL_ROOT=\"${URL_ROOT#/}\"\n+URL_ROOT=\"${URL_ROOT%/}\"\n+\n+if [ \"${URL_ROOT}\" = \"\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${URL_ROOT//\\//#}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war \"/usr/local/tomcat/webapps/${WAR_NAME}\"\n+\n+\t# Set up redirect from /source\n+\tmkdir \"/usr/local/tomcat/webapps/source\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTc0Mw=="}, "originalCommit": {"oid": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgwMTA0Ng==", "bodyText": "Like this it's only running those commands if the .war file isn't located at the expected location (i.e. first start or after URL_ROOT has been changed), isn't it? Or am I missing/misunderstanding something?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r488801046", "createdAt": "2020-09-15T16:26:59Z", "author": {"login": "timschumi"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,38 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [[ \"${URL_ROOT}\" = *\" \"* ]]; then\n+\tdate +\"%F %T Deployment path contains spaces. Deploying to root...\"\n+\texport URL_ROOT=\"/\"\n+fi\n+\n+# Remove leading and trailing slashes\n+URL_ROOT=\"${URL_ROOT#/}\"\n+URL_ROOT=\"${URL_ROOT%/}\"\n+\n+if [ \"${URL_ROOT}\" = \"\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${URL_ROOT//\\//#}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war \"/usr/local/tomcat/webapps/${WAR_NAME}\"\n+\n+\t# Set up redirect from /source\n+\tmkdir \"/usr/local/tomcat/webapps/source\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTc0Mw=="}, "originalCommit": {"oid": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NDQwNw==", "bodyText": "Looks quite okay to me with these nits:\n\nif you restart the container with different URL_ROOT value the old one will probably be still lying around (not a big deal, just a note)\nthe exit codes of the commands are not checked (might as well run the script with set -e)", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r488864407", "createdAt": "2020-09-15T18:05:32Z", "author": {"login": "vladak"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,38 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [[ \"${URL_ROOT}\" = *\" \"* ]]; then\n+\tdate +\"%F %T Deployment path contains spaces. Deploying to root...\"\n+\texport URL_ROOT=\"/\"\n+fi\n+\n+# Remove leading and trailing slashes\n+URL_ROOT=\"${URL_ROOT#/}\"\n+URL_ROOT=\"${URL_ROOT%/}\"\n+\n+if [ \"${URL_ROOT}\" = \"\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${URL_ROOT//\\//#}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war \"/usr/local/tomcat/webapps/${WAR_NAME}\"\n+\n+\t# Set up redirect from /source\n+\tmkdir \"/usr/local/tomcat/webapps/source\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTc0Mw=="}, "originalCommit": {"oid": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4911, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}