{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5MDY2Mzk0", "number": 3312, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMjozMzo1NFrOExtQbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMTo1Nzo1OFrOEx3kzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNTU3MTY1OnYy", "diffSide": "RIGHT", "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMjozMzo1NFrOHn9H3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNDoyMDowM1rOHqeF7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY1Nzk0OA==", "bodyText": "could benefit from ConfiguratioChangeListener (#3270) so you could cache the tokens as it requires a lock on each secure request which contains the header", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511657948", "createdAt": "2020-10-25T22:33:54Z", "author": {"login": "tulinkry"}, "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "diffHunk": "@@ -86,14 +97,38 @@ public void filter(final ContainerRequestContext context) {\n         if (request == null) { // happens in tests\n             return;\n         }\n+\n         String path = context.getUriInfo().getPath();\n+\n+        if (request.isSecure()) {\n+            String authHeaderValue;\n+            if ((authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION)) != null &&\n+                    authHeaderValue.startsWith(BEARER)) {\n+                String tokenValue = authHeaderValue.substring(BEARER.length());\n+                if (RuntimeEnvironment.getInstance().getAuthenticationTokens().contains(tokenValue)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwMDA4Ng==", "bodyText": "good idea. Will wait for the PR to land.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511900086", "createdAt": "2020-10-26T11:45:40Z", "author": {"login": "vladak"}, "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "diffHunk": "@@ -86,14 +97,38 @@ public void filter(final ContainerRequestContext context) {\n         if (request == null) { // happens in tests\n             return;\n         }\n+\n         String path = context.getUriInfo().getPath();\n+\n+        if (request.isSecure()) {\n+            String authHeaderValue;\n+            if ((authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION)) != null &&\n+                    authHeaderValue.startsWith(BEARER)) {\n+                String tokenValue = authHeaderValue.substring(BEARER.length());\n+                if (RuntimeEnvironment.getInstance().getAuthenticationTokens().contains(tokenValue)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY1Nzk0OA=="}, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NTI3Nw==", "bodyText": "@ahornace was so kind to allow me to take the ConfiguratioChangedListener from his PR.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r514295277", "createdAt": "2020-10-29T14:20:03Z", "author": {"login": "vladak"}, "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "diffHunk": "@@ -86,14 +97,38 @@ public void filter(final ContainerRequestContext context) {\n         if (request == null) { // happens in tests\n             return;\n         }\n+\n         String path = context.getUriInfo().getPath();\n+\n+        if (request.isSecure()) {\n+            String authHeaderValue;\n+            if ((authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION)) != null &&\n+                    authHeaderValue.startsWith(BEARER)) {\n+                String tokenValue = authHeaderValue.substring(BEARER.length());\n+                if (RuntimeEnvironment.getInstance().getAuthenticationTokens().contains(tokenValue)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY1Nzk0OA=="}, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjI5MTA0OnYy", "diffSide": "RIGHT", "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzoyNDowNVrOHoDOkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMTo0MTo0OVrOHoLyEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Nzk2OQ==", "bodyText": "I've noticed this construct a few times in OpenGrok and I think it makes things a bit unreadable. Why not rewrite it as:\nString authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION);\nif (authHeaderValue != null && authHeaderValue.startsWith(BEARER)) {\n   ...\nThen the definition is directly tied to declaration.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511757969", "createdAt": "2020-10-26T07:24:05Z", "author": {"login": "ahornace"}, "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "diffHunk": "@@ -86,14 +97,38 @@ public void filter(final ContainerRequestContext context) {\n         if (request == null) { // happens in tests\n             return;\n         }\n+\n         String path = context.getUriInfo().getPath();\n+\n+        if (request.isSecure()) {\n+            String authHeaderValue;\n+            if ((authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION)) != null &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg5ODEzMA==", "bodyText": "yep, that looks nicer.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511898130", "createdAt": "2020-10-26T11:41:49Z", "author": {"login": "vladak"}, "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "diffHunk": "@@ -86,14 +97,38 @@ public void filter(final ContainerRequestContext context) {\n         if (request == null) { // happens in tests\n             return;\n         }\n+\n         String path = context.getUriInfo().getPath();\n+\n+        if (request.isSecure()) {\n+            String authHeaderValue;\n+            if ((authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION)) != null &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Nzk2OQ=="}, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjI5NDI3OnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzoyNToyNVrOHoDQcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwOTo0MzozM1rOHoHrRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1ODQ0OA==", "bodyText": "Should not we return a copy or at least return an unmodifiable collection? Theoretically, someone could change the content easily.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511758448", "createdAt": "2020-10-26T07:25:25Z", "author": {"login": "ahornace"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "diffHunk": "@@ -1336,6 +1339,14 @@ public void setDisabledRepositories(Set<String> disabledRepositories) {\n         this.disabledRepositories = disabledRepositories;\n     }\n \n+    public Set<String> getAuthenticationTokens() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyOTE3Mg==", "bodyText": "Good catch ! Definitely something to worry about given these are access tokens.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511829172", "createdAt": "2020-10-26T09:40:45Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "diffHunk": "@@ -1336,6 +1339,14 @@ public void setDisabledRepositories(Set<String> disabledRepositories) {\n         this.disabledRepositories = disabledRepositories;\n     }\n \n+    public Set<String> getAuthenticationTokens() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1ODQ0OA=="}, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgzMDg1NQ==", "bodyText": "Similar to #3312 (comment) but perhaps better to solve it here also", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511830855", "createdAt": "2020-10-26T09:43:33Z", "author": {"login": "tulinkry"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "diffHunk": "@@ -1336,6 +1339,14 @@ public void setDisabledRepositories(Set<String> disabledRepositories) {\n         this.disabledRepositories = disabledRepositories;\n     }\n \n+    public Set<String> getAuthenticationTokens() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1ODQ0OA=="}, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNzI2MjIxOnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMTo1Nzo1OFrOHoMTGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjowMTo1MVrOHoMatA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwNjU4Nw==", "bodyText": "// This list of calls is sorted alphabetically so please keep it.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511906587", "createdAt": "2020-10-26T11:57:58Z", "author": {"login": "tulinkry"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "diffHunk": "@@ -564,6 +566,7 @@ public Configuration() {\n         setUserPageSuffix(\"\");\n         setWebappLAF(\"default\");\n         // webappCtags is default(boolean)\n+        setAuthenticationTokens(new HashSet<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18ca4f4a141c11fa58f17f9e77eda2daababc388"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwODUzMg==", "bodyText": "fixed", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511908532", "createdAt": "2020-10-26T12:01:51Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "diffHunk": "@@ -564,6 +566,7 @@ public Configuration() {\n         setUserPageSuffix(\"\");\n         setWebappLAF(\"default\");\n         // webappCtags is default(boolean)\n+        setAuthenticationTokens(new HashSet<>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwNjU4Nw=="}, "originalCommit": {"oid": "18ca4f4a141c11fa58f17f9e77eda2daababc388"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 153, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}