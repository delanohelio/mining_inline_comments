{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMjg0NTUy", "number": 3061, "title": "Bugfix/perforce", "bodyText": "Hello,\nPlease consider for integration this patch to optimize Perforce executions to get history data.\n\nRun a p4 changes and p4 filelog, and integrate the results, so only two p4 commands are needed for History of a directory tree.\nParse file names from p4 commands so that HistoryEntry instances have defined files.\nRecognize binary file log for annotations.\n\nThank you.", "createdAt": "2020-03-04T01:16:03Z", "url": "https://github.com/oracle/opengrok/pull/3061", "merged": true, "mergeCommit": {"oid": "fba6feced27ce080461a983e7ab9f015404bd26c"}, "closed": true, "closedAt": "2020-03-05T09:02:41Z", "author": {"login": "idodeclare"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJ5vraAH2gAyMzgzMjg0NTUyOjc2MGYyZWI2MDE3NzhhNzU3NzIzY2E2Y2FhMWQxZWYyZTJhMzZjYWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKkDbTgH2gAyMzgzMjg0NTUyOmM1NzNhYWI1MWRjMWI1ZDNjYTk5MzFiYzI4NTFiMzM2YTJhM2I4ZDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "760f2eb601778a757723ca6caa1d1ef2e2a36cab", "author": {"user": {"login": "idodeclare", "name": "C Fraire"}}, "url": "https://github.com/oracle/opengrok/commit/760f2eb601778a757723ca6caa1d1ef2e2a36cab", "committedDate": "2020-03-03T03:28:04Z", "message": "Reorder repositories by cost and popularity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36201ddc5c7bf322fa1e2cc406827245f65182eb", "author": {"user": {"login": "idodeclare", "name": "C Fraire"}}, "url": "https://github.com/oracle/opengrok/commit/36201ddc5c7bf322fa1e2cc406827245f65182eb", "committedDate": "2020-03-04T01:13:24Z", "message": "Fix #2919 Fix #2797 Fix #981 Fix #878 Fix #502 Perforce refactoring\n\n- Run a p4-changes and p4-filelog, and integrate\n  the results, so only two p4 commands are needed\n  for History for a directory tree.\n- Parse file names from p4 commands so that\n  HistoryEntry instances have defined files.\n- Recognize binary file log for annotations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3", "author": {"user": {"login": "idodeclare", "name": "C Fraire"}}, "url": "https://github.com/oracle/opengrok/commit/f916bde247d3958e7eae0cc86504cdc0f670c4d3", "committedDate": "2020-03-04T01:14:00Z", "message": "Avoid IllegalArgumentException, and log condition\n\nAccommodate a repository that can transiently\nreturn errors, such as Perforce when a login\nexpires."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTk1MzQ4", "url": "https://github.com/oracle/opengrok/pull/3061#pullrequestreview-368595348", "createdAt": "2020-03-04T08:52:29Z", "commit": {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwODo1MjoyOVrOFxkifA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwODo1MjoyOVrOFxkifA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyMzE5Ng==", "bodyText": "I assume this needs some setup steps to populate the root somehow. Could you perhaps update the test case with the steps ?", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r387523196", "createdAt": "2020-03-04T08:52:29Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/history/PerforceRepositoryTest.java", "diffHunk": "@@ -40,36 +41,38 @@\n \n import static org.junit.Assert.assertNotNull;\n import static org.junit.Assert.assertEquals;\n-import org.opengrok.indexer.configuration.RuntimeEnvironment;\n import static org.opengrok.indexer.history.PerforceRepository.protectPerforceFilename;\n+import static org.opengrok.indexer.history.PerforceRepository.unprotectPerforceFilename;\n \n /**\n  * Do basic testing of the Perforce support\n  *\n  * @author Trond Norbye\n  */\n-@ConditionalRun(RepositoryInstalled.PerforceInstalled.class)\n public class PerforceRepositoryTest {\n \n     @Rule\n     public ConditionalRunRule rule = new ConditionalRunRule();\n     \n     private static boolean skip;\n     private static List<File> files;\n-    private static final File root = new File(\"/export/opengrok_p4_test\");\n+    private static final File root = new File(\"/var/opengrok/src/p4foo\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTk2OTM0", "url": "https://github.com/oracle/opengrok/pull/3061#pullrequestreview-368596934", "createdAt": "2020-03-04T08:55:00Z", "commit": {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwODo1NTowMVrOFxknVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwODo1NTowMVrOFxknVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyNDQzNw==", "bodyText": "good idea !", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r387524437", "createdAt": "2020-03-04T08:55:01Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/RepositoryFactory.java", "diffHunk": "@@ -51,21 +51,30 @@\n     private static final Logger LOGGER = LoggerFactory.getLogger(RepositoryFactory.class);\n \n     private static final Repository[] repositories = {\n-        new BitKeeperRepository(),\n-        new MercurialRepository(),\n-        new AccuRevRepository(),\n-        new BazaarRepository(),\n-        new GitRepository(),\n-        new MonotoneRepository(),\n-        new SubversionRepository(),\n-        new SCCSRepository(),\n-        new RazorRepository(),\n-        new ClearCaseRepository(),\n-        new PerforceRepository(),\n-        new RCSRepository(),\n-        new CVSRepository(),\n-        new RepoRepository(),\n-        new SSCMRepository()\n+            /*\n+             * The following do cheap checks to determine isRepositoryFor(),\n+             * but still put the most popular at the head of the repositories\n+             * array.\n+             */\n+            new GitRepository(),\n+            new MercurialRepository(),\n+            new RepoRepository(),\n+            new BitKeeperRepository(),\n+            new BazaarRepository(),\n+            new MonotoneRepository(),\n+            new SubversionRepository(),\n+            new SCCSRepository(),\n+            new RazorRepository(),\n+            new RCSRepository(),\n+            new CVSRepository(),\n+            new SSCMRepository(),\n+            /*\n+             * The following do expensive checks to determine isRepositoryFor(),\n+             * so put them at the end of the repositories array.\n+             */\n+            new AccuRevRepository(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTk4MDUy", "url": "https://github.com/oracle/opengrok/pull/3061#pullrequestreview-368598052", "createdAt": "2020-03-04T08:56:41Z", "commit": {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwODo1Njo0MVrOFxkqtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwODo1Njo0MVrOFxkqtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyNTMwMw==", "bodyText": "use isLoggable() also here ?", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r387525303", "createdAt": "2020-03-04T08:56:41Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/PerforceRepository.java", "diffHunk": "@@ -78,18 +78,31 @@ static String protectPerforceFilename(String name) {\n         return t;\n     }\n \n+    static String unprotectPerforceFilename(String name) {\n+        String t = name.replace(\"%40\", \"@\");\n+        t = t.replace(\"%23\", \"#\");\n+        t = t.replace(\"%2A\", \"*\");\n+        t = t.replace(\"%25\", \"%\");\n+        if (!name.equals(t)) {\n+            LOGGER.log(Level.FINEST,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NjAyNzAy", "url": "https://github.com/oracle/opengrok/pull/3061#pullrequestreview-368602702", "createdAt": "2020-03-04T09:03:49Z", "commit": {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwOTowMzo0OVrOFxk5Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwOTowMzo0OVrOFxk5Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUyOTAxOA==", "bodyText": "what does Lede stand for ?", "url": "https://github.com/oracle/opengrok/pull/3061#discussion_r387529018", "createdAt": "2020-03-04T09:03:49Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/PerforceHistoryParser.java", "diffHunk": "@@ -271,4 +304,56 @@ private static Date newDate(int year, int month, int day, int hour, int minute,\n         cal.set(year, month - 1, day, hour, minute, second);\n         return cal.getTime();\n     }\n+\n+    private static HistoryEntry parseLedeLine(List<HistoryEntry> entries, HistoryEntry entry,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f916bde247d3958e7eae0cc86504cdc0f670c4d3"}, "originalPosition": 400}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "665789e2b25f4b055561183cfd661b9d51d37d97", "author": {"user": {"login": "idodeclare", "name": "C Fraire"}}, "url": "https://github.com/oracle/opengrok/commit/665789e2b25f4b055561183cfd661b9d51d37d97", "committedDate": "2020-03-05T01:41:23Z", "message": "Revise after review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c573aab51dc1b5d3ca9931bc2851b336a2a3b8d8", "author": {"user": {"login": "idodeclare", "name": "C Fraire"}}, "url": "https://github.com/oracle/opengrok/commit/c573aab51dc1b5d3ca9931bc2851b336a2a3b8d8", "committedDate": "2020-03-05T04:45:39Z", "message": "Fix to escape > in JavaDoc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 296, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}