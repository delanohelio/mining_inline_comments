{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5MDY2Mzk0", "number": 3312, "title": "allow to access API using bearer token", "bodyText": "This change introduces bearer tokens to access the API over HTTPS. The configuration contains the tokens in verbatim form:\n  <void property=\"authenticationTokens\">\n   <void method=\"add\">\n    <string>bar</string>\n   </void>\n   <void method=\"add\">\n    <string>foo</string>\n   </void>\n  </void>\nOne can access the API e.g. like so:\ncurl -v -X POST -H 'Authorization: Bearer foo' -H 'Content-Type:text/plain' -d @paths.tsv https://foo:8080/source/api/v1/system/pathdesc", "createdAt": "2020-10-23T16:07:59Z", "url": "https://github.com/oracle/opengrok/pull/3312", "merged": true, "mergeCommit": {"oid": "ee4d3c85007717611cf566c499f97797895f3669"}, "closed": true, "closedAt": "2020-11-24T09:28:19Z", "author": {"login": "vladak"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWHl7eAFqTUxNjQwMzc1MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfl1NxAFqTUzNzI1OTM3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NDAzNzUw", "url": "https://github.com/oracle/opengrok/pull/3312#pullrequestreview-516403750", "createdAt": "2020-10-25T22:33:53Z", "commit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMjozMzo1NFrOHn9H3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNVQyMjozMzo1NFrOHn9H3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY1Nzk0OA==", "bodyText": "could benefit from ConfiguratioChangeListener (#3270) so you could cache the tokens as it requires a lock on each secure request which contains the header", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511657948", "createdAt": "2020-10-25T22:33:54Z", "author": {"login": "tulinkry"}, "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "diffHunk": "@@ -86,14 +97,38 @@ public void filter(final ContainerRequestContext context) {\n         if (request == null) { // happens in tests\n             return;\n         }\n+\n         String path = context.getUriInfo().getPath();\n+\n+        if (request.isSecure()) {\n+            String authHeaderValue;\n+            if ((authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION)) != null &&\n+                    authHeaderValue.startsWith(BEARER)) {\n+                String tokenValue = authHeaderValue.substring(BEARER.length());\n+                if (RuntimeEnvironment.getInstance().getAuthenticationTokens().contains(tokenValue)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NTE0OTM0", "url": "https://github.com/oracle/opengrok/pull/3312#pullrequestreview-516514934", "createdAt": "2020-10-26T07:24:05Z", "commit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzoyNDowNVrOHoDOkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzoyNToyNVrOHoDQcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Nzk2OQ==", "bodyText": "I've noticed this construct a few times in OpenGrok and I think it makes things a bit unreadable. Why not rewrite it as:\nString authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION);\nif (authHeaderValue != null && authHeaderValue.startsWith(BEARER)) {\n   ...\nThen the definition is directly tied to declaration.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511757969", "createdAt": "2020-10-26T07:24:05Z", "author": {"login": "ahornace"}, "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "diffHunk": "@@ -86,14 +97,38 @@ public void filter(final ContainerRequestContext context) {\n         if (request == null) { // happens in tests\n             return;\n         }\n+\n         String path = context.getUriInfo().getPath();\n+\n+        if (request.isSecure()) {\n+            String authHeaderValue;\n+            if ((authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION)) != null &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1ODQ0OA==", "bodyText": "Should not we return a copy or at least return an unmodifiable collection? Theoretically, someone could change the content easily.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511758448", "createdAt": "2020-10-26T07:25:25Z", "author": {"login": "ahornace"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "diffHunk": "@@ -1336,6 +1339,14 @@ public void setDisabledRepositories(Set<String> disabledRepositories) {\n         this.disabledRepositories = disabledRepositories;\n     }\n \n+    public Set<String> getAuthenticationTokens() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NzA2NDMw", "url": "https://github.com/oracle/opengrok/pull/3312#pullrequestreview-516706430", "createdAt": "2020-10-26T11:57:58Z", "commit": {"oid": "18ca4f4a141c11fa58f17f9e77eda2daababc388"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMTo1Nzo1OFrOHoMTGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMTo1Nzo1OFrOHoMTGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwNjU4Nw==", "bodyText": "// This list of calls is sorted alphabetically so please keep it.", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511906587", "createdAt": "2020-10-26T11:57:58Z", "author": {"login": "tulinkry"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "diffHunk": "@@ -564,6 +566,7 @@ public Configuration() {\n         setUserPageSuffix(\"\");\n         setWebappLAF(\"default\");\n         // webappCtags is default(boolean)\n+        setAuthenticationTokens(new HashSet<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18ca4f4a141c11fa58f17f9e77eda2daababc388"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61c3084c21a054ed3cfff32f39a618c16581a315", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/61c3084c21a054ed3cfff32f39a618c16581a315", "committedDate": "2020-10-26T12:01:31Z", "message": "keep it sorted"}, "afterCommit": {"oid": "07dc7f63632205ecc186e28b3e9a975baa3632eb", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/07dc7f63632205ecc186e28b3e9a975baa3632eb", "committedDate": "2020-10-27T22:18:31Z", "message": "keep it sorted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6d868bfae2f626c8852346dce315ce4f43327f4", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/b6d868bfae2f626c8852346dce315ce4f43327f4", "committedDate": "2020-11-01T13:39:23Z", "message": "initial stab at token authentication\n\nfixes #3222"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9be003c525a732dd4613cf1cf5b1b91a5076e79e", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/9be003c525a732dd4613cf1cf5b1b91a5076e79e", "committedDate": "2020-11-01T13:39:23Z", "message": "merge LocalhostFilter and TokenFilter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae297cef72493886df07d27c521b17d98d559895", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/ae297cef72493886df07d27c521b17d98d559895", "committedDate": "2020-11-01T13:39:23Z", "message": "add configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ddfa3e5ba958a4ac84ae1fea5e3a01435cbd470", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/2ddfa3e5ba958a4ac84ae1fea5e3a01435cbd470", "committedDate": "2020-11-01T13:39:23Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0100aa5b27e9f4f2f0d9bb9f8fe0f3ebcedef20", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/c0100aa5b27e9f4f2f0d9bb9f8fe0f3ebcedef20", "committedDate": "2020-11-01T13:39:23Z", "message": "mention the tokens"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b92c6f8fb5cc96bcc4f357bbbab1f7cf4e025f69", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/b92c6f8fb5cc96bcc4f357bbbab1f7cf4e025f69", "committedDate": "2020-11-01T13:39:23Z", "message": "adjust log message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a4fead3e90eaed2aa6f3379c81b255e93b435aa", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/1a4fead3e90eaed2aa6f3379c81b255e93b435aa", "committedDate": "2020-11-01T13:39:23Z", "message": "restructure allow cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d2e66f867a4c1b467cefce2fa5b5b3ad9b14886", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/2d2e66f867a4c1b467cefce2fa5b5b3ad9b14886", "committedDate": "2020-11-01T13:39:23Z", "message": "simplify conditions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57f10954de0bc478950d8a674c7cd3d934bde5da", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/57f10954de0bc478950d8a674c7cd3d934bde5da", "committedDate": "2020-11-01T13:39:23Z", "message": "deny proxied connections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90252cd5b4b7d4057d342675b1f40fb9f58dda79", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/90252cd5b4b7d4057d342675b1f40fb9f58dda79", "committedDate": "2020-11-01T13:39:23Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1eea296754fdbdad68419883cb51be2e7e52afde", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/1eea296754fdbdad68419883cb51be2e7e52afde", "committedDate": "2020-11-01T13:39:23Z", "message": "bearer token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bab5c139a13cc3f3d7aa219fd91e504689fe34a", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/3bab5c139a13cc3f3d7aa219fd91e504689fe34a", "committedDate": "2020-11-01T13:39:23Z", "message": "declare+define"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81ae0366d31ce2ccb4d5a5f4b91f6bd079992e0a", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/81ae0366d31ce2ccb4d5a5f4b91f6bd079992e0a", "committedDate": "2020-11-01T13:39:23Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b14b352f7d203d7d7ab9b9a1bdd0ef1ce3a0479e", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/b14b352f7d203d7d7ab9b9a1bdd0ef1ce3a0479e", "committedDate": "2020-11-01T13:39:23Z", "message": "cache the tokens\n\nneeds ConfigurationChangeListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6f7d75feb6357a78eaadead835068d56a655690", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/e6f7d75feb6357a78eaadead835068d56a655690", "committedDate": "2020-11-01T13:39:23Z", "message": "the token set should not be modifiable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd2631a679033d013b74b5c59e33ffffcfacc263", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/bd2631a679033d013b74b5c59e33ffffcfacc263", "committedDate": "2020-11-01T13:39:23Z", "message": "keep it sorted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1d08400e4d39bbb32e8334d734f8b32ed38d773", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/f1d08400e4d39bbb32e8334d734f8b32ed38d773", "committedDate": "2020-11-01T13:39:23Z", "message": "add comma"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "939bd9b0484747f1edf845727c0813fc85a7efda", "author": {"user": {"login": "ahornace", "name": "Adam Horn\u00e1\u010dek"}}, "url": "https://github.com/oracle/opengrok/commit/939bd9b0484747f1edf845727c0813fc85a7efda", "committedDate": "2020-11-01T13:39:23Z", "message": "introduce ConfigurationChangedListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39be1bfbc4ca4b123063c7289319423347435814", "author": {"user": {"login": "ahornace", "name": "Adam Horn\u00e1\u010dek"}}, "url": "https://github.com/oracle/opengrok/commit/39be1bfbc4ca4b123063c7289319423347435814", "committedDate": "2020-11-01T13:39:23Z", "message": "add registerListener()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67ca4d503f5f8c3d146b071bc02972cf922cbb82", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/67ca4d503f5f8c3d146b071bc02972cf922cbb82", "committedDate": "2020-11-01T13:39:23Z", "message": "use ConfigurationChangedListener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4958bf626971e8a2ff0f0906e885c28ed9432a1c", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/4958bf626971e8a2ff0f0906e885c28ed9432a1c", "committedDate": "2020-11-01T13:39:23Z", "message": "add test to cover configuration listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9331fbf4f39b756c3dc590078301cba39e78cff7", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/9331fbf4f39b756c3dc590078301cba39e78cff7", "committedDate": "2020-11-01T13:39:23Z", "message": "add docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dcc89e1ace5032db3285bfa23214ff2d0c38c7b", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/3dcc89e1ace5032db3285bfa23214ff2d0c38c7b", "committedDate": "2020-11-01T13:39:23Z", "message": "avoid wildcard imports"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40cb76031955ababae0a059b7db5527eb78c00bd", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/40cb76031955ababae0a059b7db5527eb78c00bd", "committedDate": "2020-10-31T17:13:40Z", "message": "avoid wildcard imports"}, "afterCommit": {"oid": "3dcc89e1ace5032db3285bfa23214ff2d0c38c7b", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/3dcc89e1ace5032db3285bfa23214ff2d0c38c7b", "committedDate": "2020-11-01T13:39:23Z", "message": "avoid wildcard imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MjU5Mzcz", "url": "https://github.com/oracle/opengrok/pull/3312#pullrequestreview-537259373", "createdAt": "2020-11-24T08:53:30Z", "commit": {"oid": "3dcc89e1ace5032db3285bfa23214ff2d0c38c7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 254, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}