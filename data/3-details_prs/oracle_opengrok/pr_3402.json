{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5MzAyMDk2", "number": 3402, "title": "Docker script refactoring and rewrite to Python", "bodyText": "This change rafactors the scripts used for Docker. The initial motivation was to avoid the non-existent-configuration exception thrown by the web app during the initial startup of a container based on the opengrok image.\nSome notable changes:\n\nno special casing between initial and non-initial indexing\nthe sequence goes like this:\n\ndeploy\nbare config is created (to avoid above mentioned exception)\nindexer is started in the background (waits for the Tomcat to come up before it enters the infinite loop)\nTomcat is started on foreground\n\n\nto preserve the locking I added filelock to the indexer program\n\nThis is a step towards #3221.\nEventually the start.sh script can be rewritten to Python and use native interfaces to opengrok-sync, opengrok-deploy.\nI used the opportunity to overhaul everything - the main Docker program is now based on the opengrok-sync and rewritten into Python.", "createdAt": "2020-12-14T09:35:49Z", "url": "https://github.com/oracle/opengrok/pull/3402", "merged": true, "mergeCommit": {"oid": "9bb1a6638d57dccdae01a05aea22b31d5f5470ca"}, "closed": true, "closedAt": "2021-02-19T13:14:02Z", "author": {"login": "vladak"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdwznshgFqTU2OTk2NjA3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABd7pZRsgH2gAyNTM5MzAyMDk2OjNiY2VkZWRkN2Q1YTE5YTMzOWQzYzgwY2NjYjY1OWJjZTRjMzk2YWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5OTY2MDc0", "url": "https://github.com/oracle/opengrok/pull/3402#pullrequestreview-569966074", "createdAt": "2021-01-16T20:34:07Z", "commit": {"oid": "8af27fffa088e2696b4f052c39b41061a0b37efc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "960d5698c74c45b497b0ef271c02a9b074c68418", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/960d5698c74c45b497b0ef271c02a9b074c68418", "committedDate": "2021-02-08T15:27:32Z", "message": "refactor to avoid special casing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fab2dc4592042b66e4e6cd37e8dc598fde02a945", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/fab2dc4592042b66e4e6cd37e8dc598fde02a945", "committedDate": "2021-02-08T15:27:32Z", "message": "add CDDL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55336778ed7f9257a9611f2cb65f126404953e1a", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/55336778ed7f9257a9611f2cb65f126404953e1a", "committedDate": "2021-02-08T15:27:32Z", "message": "add locking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a2a24f0694b4d755568bef4f62c836879bb2329", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/6a2a24f0694b4d755568bef4f62c836879bb2329", "committedDate": "2021-02-08T15:27:33Z", "message": "use opengrok-sync\n\nfixes #3221"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1878fc60334d2e862501969f3a44a7c367fb8fe4", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/1878fc60334d2e862501969f3a44a7c367fb8fe4", "committedDate": "2021-02-08T15:27:33Z", "message": "cleanup, add TODO/comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd4b901c6983459d40fb564fe7d85e571ceb06a2", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/cd4b901c6983459d40fb564fe7d85e571ceb06a2", "committedDate": "2021-02-08T15:27:33Z", "message": "replace URIs in sync configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01c3090b582f17e3312bda3a308a78eed098effb", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/01c3090b582f17e3312bda3a308a78eed098effb", "committedDate": "2021-02-08T15:27:33Z", "message": "fix option append"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8131058cf8bdf77d458e4503b81cc2004f09384", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/a8131058cf8bdf77d458e4503b81cc2004f09384", "committedDate": "2021-02-08T15:27:33Z", "message": "make sure URI ends with slash"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dd2ae10b989936c54b781e99171409ce72bad25", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/2dd2ae10b989936c54b781e99171409ce72bad25", "committedDate": "2021-02-08T15:27:33Z", "message": "avoid null pointer exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a083c180ab80b9f9ea173b2af32aca7253365924", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/a083c180ab80b9f9ea173b2af32aca7253365924", "committedDate": "2021-02-08T15:27:33Z", "message": "prepare programs executed from Docker to be callable from Python directly"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1c07406822ee280b49b33605fa12936bbcc15f8", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/f1c07406822ee280b49b33605fa12936bbcc15f8", "committedDate": "2021-02-08T15:24:19Z", "message": "rewrite main Docker script to Python\n\nfixes #3403"}, "afterCommit": {"oid": "3d7585749e2f2f03e4ea80386efa503fc0b2f7f6", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/3d7585749e2f2f03e4ea80386efa503fc0b2f7f6", "committedDate": "2021-02-08T15:27:33Z", "message": "rewrite main Docker script to Python\n\nfixes #3403"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e363f9c9d28bf78660f28dfefe3e5d34c592557", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/4e363f9c9d28bf78660f28dfefe3e5d34c592557", "committedDate": "2021-02-08T15:33:30Z", "message": "rewrite main Docker script to Python\n\nfixes #3403"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c2ec3a4694384326d84aac2978193fe13d29677", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/8c2ec3a4694384326d84aac2978193fe13d29677", "committedDate": "2021-02-08T15:29:54Z", "message": "remove old shell script"}, "afterCommit": {"oid": "4e363f9c9d28bf78660f28dfefe3e5d34c592557", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/4e363f9c9d28bf78660f28dfefe3e5d34c592557", "committedDate": "2021-02-08T15:33:30Z", "message": "rewrite main Docker script to Python\n\nfixes #3403"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg1NjY5MTQ1", "url": "https://github.com/oracle/opengrok/pull/3402#pullrequestreview-585669145", "createdAt": "2021-02-08T16:15:03Z", "commit": {"oid": "4e363f9c9d28bf78660f28dfefe3e5d34c592557"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOFQxNjoxNTowNFrOIhqwAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOFQxNjoxNTowNFrOIhqwAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjE3NDMzOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (map.get(project) != null) {\n          \n          \n            \n                            if (map.containsKey(project)) {\n          \n      \n    \n    \n  \n\nI think this is nicer :)", "url": "https://github.com/oracle/opengrok/pull/3402#discussion_r572174338", "createdAt": "2021-02-08T16:15:04Z", "author": {"login": "ahornace"}, "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/controller/ProjectsController.java", "diffHunk": "@@ -118,9 +118,11 @@ public Response addProject(String projectName) {\n                     }\n                 }\n                 // deleted repository\n-                for (RepositoryInfo repo : map.get(project)) {\n-                    if (!repos.contains(repo)) {\n-                        allrepos.remove(repo);\n+                if (map.get(project) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e363f9c9d28bf78660f28dfefe3e5d34c592557"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb14dfa1abed3310a5277ca85bee3789a9136327", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/cb14dfa1abed3310a5277ca85bee3789a9136327", "committedDate": "2021-02-08T16:20:30Z", "message": "use containsKey()\n\nCo-authored-by: Adam Horn\u00e1\u010dek <adam.hornacek@icloud.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c9736280cb7207d312fa5ac4ca801356e28136b", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/9c9736280cb7207d312fa5ac4ca801356e28136b", "committedDate": "2021-02-08T16:26:47Z", "message": "fix check()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "127f4eae2bf927a37a3f658096dc431812f4c9df", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/127f4eae2bf927a37a3f658096dc431812f4c9df", "committedDate": "2021-02-08T16:30:40Z", "message": "restore original driveon behavior"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bfc1ba9b3ab60d0c82c6429532f3933e29a262c", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/7bfc1ba9b3ab60d0c82c6429532f3933e29a262c", "committedDate": "2021-02-08T16:32:33Z", "message": "import sys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55b12fc70940242cf417183d3eb03ff5da82c6f7", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/55b12fc70940242cf417183d3eb03ff5da82c6f7", "committedDate": "2021-02-08T16:34:27Z", "message": "fix indent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b925f3096ea6ef985c3cf8c9ac7ba646e81edde", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/0b925f3096ea6ef985c3cf8c9ac7ba646e81edde", "committedDate": "2021-02-08T16:41:52Z", "message": "pylint fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e74a997504c30bbad48a82ecb95db13c1758f9a", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/5e74a997504c30bbad48a82ecb95db13c1758f9a", "committedDate": "2021-02-08T16:55:42Z", "message": "introduce main()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTkzNTM5OTMx", "url": "https://github.com/oracle/opengrok/pull/3402#pullrequestreview-593539931", "createdAt": "2021-02-18T18:47:49Z", "commit": {"oid": "5e74a997504c30bbad48a82ecb95db13c1758f9a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOFQxODo0Nzo0OVrOIn25pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOFQxODo0Nzo0OVrOIn25pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODY2NDg3MQ==", "bodyText": "What about this #TODO?", "url": "https://github.com/oracle/opengrok/pull/3402#discussion_r578664871", "createdAt": "2021-02-18T18:47:49Z", "author": {"login": "ahornace"}, "path": "tools/src/main/python/opengrok_tools/reindex_project.py", "diffHunk": "@@ -75,50 +75,68 @@ def get_config_file(logger, uri):\n def main():\n     parser = argparse.ArgumentParser(description='OpenGrok indexer wrapper '\n                                                  'for indexing single project',\n-                                     parents=[get_java_parser()])\n-    parser.add_argument('-t', '--template', required=True,\n+                                     parents=[get_java_parser()],\n+                                     prog=sys.argv[0])\n+    parser.add_argument('-t', '--template',\n                         help='Logging template file')\n-    parser.add_argument('-p', '--pattern', required=True,\n+    parser.add_argument('-p', '--pattern',\n                         help='Pattern to substitute in logging template with'\n                              'project name')\n     parser.add_argument('-P', '--project', required=True,\n                         help='Project name')\n-    parser.add_argument('-d', '--directory', required=True,\n+    parser.add_argument('-d', '--directory',\n                         help='Logging directory')\n     parser.add_argument('-U', '--uri', default='http://localhost:8080/source',\n                         help='URI of the webapp with context path')\n+    parser.add_argument('--printoutput', action='store_true', default=False)\n+\n+    cmd_args = sys.argv[1:]\n+    extra_opts = os.environ.get(\"OPENGROK_INDEXER_OPTIONAL_ARGS\")\n+    if extra_opts:\n+        cmd_args.extend(extra_opts.split())\n \n     try:\n-        args = parser.parse_args()\n+        args = parser.parse_args(cmd_args)\n     except ValueError as e:\n         fatal(e)\n \n     logger = get_console_logger(get_class_basename(), args.loglevel)\n \n+    logger.debug('Command arguments extended with {}'.format(extra_opts))\n+\n     # Make sure the log directory exists.\n-    if not os.path.isdir(args.directory):\n-        os.makedirs(args.directory)\n+    if args.directory:\n+        if not os.path.isdir(args.directory):\n+            os.makedirs(args.directory)\n \n     # Get files needed for per-project reindex.\n     conf_file = get_config_file(logger, args.uri)\n-    logprop_file = get_logprop_file(logger, args.template, args.pattern,\n-                                    args.project)\n+    logprop_file = None\n+    if args.template and args.pattern:\n+        logprop_file = get_logprop_file(logger, args.template, args.pattern,\n+                                        args.project)\n \n     # Reindex with the modified logging.properties file and read-only config.\n     command = ['-R', conf_file]\n     command.extend(args.options)\n     java_opts = []\n     if args.java_opts:\n         java_opts.extend(args.java_opts)\n-    java_opts.append(\"-Djava.util.logging.config.file={}\".\n-                     format(logprop_file))\n+    if logprop_file:\n+        java_opts.append(\"-Djava.util.logging.config.file={}\".\n+                         format(logprop_file))\n     indexer = Indexer(command, logger=logger, jar=args.jar,\n                       java=args.java, java_opts=java_opts,\n                       env_vars=args.environment, doprint=args.doprint)\n     indexer.execute()\n     ret = indexer.getretcode()\n     os.remove(conf_file)\n-    os.remove(logprop_file)\n+    if logprop_file:\n+        os.remove(logprop_file)\n+\n+    # TODO", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e74a997504c30bbad48a82ecb95db13c1758f9a"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bcededd7d5a19a339d3c80cccb659bce4c396aa", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/3bcededd7d5a19a339d3c80cccb659bce4c396aa", "committedDate": "2021-02-19T12:52:29Z", "message": "avoid printing the output twice"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 144, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}