{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2ODA0NzI5", "number": 3160, "title": "docker: Fix OPENGROK_WEBAPP_CONTEXT behaviour.", "bodyText": "This allows the user to correctly specify the URL subfolder that OpenGrok should run on,\nand the container appropriately reacts without having to fully rebuild it.\nFixes: #3153", "createdAt": "2020-06-02T20:10:55Z", "url": "https://github.com/oracle/opengrok/pull/3160", "merged": true, "mergeCommit": {"oid": "0f145a682256d1425aeb13e966aa77cf2f8689f5"}, "closed": true, "closedAt": "2020-09-15T18:07:01Z", "author": {"login": "timschumi"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclvzOPAH2gAyNDI2ODA0NzI5OjFjYjAwNzQzNDk3ZTczMTE4MDZhYjEzYjZmZTY4Mjc1YzM2ZjI3YjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJJj1BAFqTQ4ODgwODM5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1cb00743497e7311806ab13b6fe68275c36f27b5", "author": {"user": {"login": "timschumi", "name": "Tim Schumacher"}}, "url": "https://github.com/oracle/opengrok/commit/1cb00743497e7311806ab13b6fe68275c36f27b5", "committedDate": "2020-05-28T15:42:46Z", "message": "docker: Document `OPENGROK_WEBAPP_CONTEXT` environment variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5", "author": {"user": {"login": "timschumi", "name": "Tim Schumacher"}}, "url": "https://github.com/oracle/opengrok/commit/1f3a09750f54633e0fc68f3f06f440277ac149c5", "committedDate": "2020-05-28T18:30:30Z", "message": "docker: Move deployment to startup and adapt for custom path"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTY5NTA4", "url": "https://github.com/oracle/opengrok/pull/3160#pullrequestreview-423169508", "createdAt": "2020-06-03T02:00:57Z", "commit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMjowMjoxOVrOGeJnRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMjozMTowOFrOGeKAxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2Nzk3NA==", "bodyText": "Nit: perhaps quote the variable expansion?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434267974", "createdAt": "2020-06-03T02:02:19Z", "author": {"login": "idodeclare"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war /usr/local/tomcat/webapps/${WAR_NAME}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDA5Nw==", "bodyText": "In Tomcat, one might specify a context path of e.g. /source/opengrok with an archive named source#opengrok.war. Might that be supported with substitution here?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434274097", "createdAt": "2020-06-03T02:29:26Z", "author": {"login": "idodeclare"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${OPENGROK_WEBAPP_CONTEXT#/}.war\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI3NDUwMQ==", "bodyText": "If OPENGROK_WEBAPP_CONTEXT is empty or contains whitespace, should it be reset earlier to / to benefit this conditional and later usage?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r434274501", "createdAt": "2020-06-03T02:31:08Z", "author": {"login": "idodeclare"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,29 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [ \"${OPENGROK_WEBAPP_CONTEXT}\" = \"/\" ]; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f3a09750f54633e0fc68f3f06f440277ac149c5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9cc2c5e129bbfdf89736cc565060b5e38d76e7d", "author": {"user": {"login": "timschumi", "name": "Tim Schumacher"}}, "url": "https://github.com/oracle/opengrok/commit/c9cc2c5e129bbfdf89736cc565060b5e38d76e7d", "committedDate": "2020-06-08T01:28:13Z", "message": "docker: Quote variable expansion in deploy command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fac11ae4f51d428bbddadeebec7a7179ed1df94", "author": {"user": {"login": "timschumi", "name": "Tim Schumacher"}}, "url": "https://github.com/oracle/opengrok/commit/3fac11ae4f51d428bbddadeebec7a7179ed1df94", "committedDate": "2020-06-08T01:47:39Z", "message": "docker: Deploy to root if path contains whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c97d2afad7181426acf2609b71a4e1dd1f111d6b", "author": {"user": {"login": "timschumi", "name": "Tim Schumacher"}}, "url": "https://github.com/oracle/opengrok/commit/c97d2afad7181426acf2609b71a4e1dd1f111d6b", "committedDate": "2020-06-08T22:03:31Z", "message": "docker: Support sub-subdirectories as WEBAPP_CONTEXT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjgxNjg2", "url": "https://github.com/oracle/opengrok/pull/3160#pullrequestreview-426681686", "createdAt": "2020-06-08T23:08:59Z", "commit": {"oid": "c97d2afad7181426acf2609b71a4e1dd1f111d6b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2", "author": {"user": {"login": "timschumi", "name": "Tim Schumacher"}}, "url": "https://github.com/oracle/opengrok/commit/ff0eb2e83bc7d179f2679d018aac48e552c0d7e2", "committedDate": "2020-06-09T12:08:22Z", "message": "docker: Rename OPENGROK_WEBAPP_CONTEXT to URL_ROOT\n\nThe original OPENGROK_WEBAPP_CONTEXT variable has been\ndeprecated/not been in use since the deployment scripts have\nbeen rewritten in commit d5cc7b5dcc6133fb9f4a6764e933b4d8b234d461.\n\nRename the variable to URL_ROOT to avoid confusion and to\nkeep the docker command a bit shorter.\n\nWhile we're at it, remove the OPENGROK_TOMCAT_BASE variable,\nwhich has been deprecated at the same time."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MzU0MDkx", "url": "https://github.com/oracle/opengrok/pull/3160#pullrequestreview-427354091", "createdAt": "2020-06-09T16:47:41Z", "commit": {"oid": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4ODA4Mzk0", "url": "https://github.com/oracle/opengrok/pull/3160#pullrequestreview-488808394", "createdAt": "2020-09-15T15:30:50Z", "commit": {"oid": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTozMDo1MFrOHSHpjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTozMDo1MFrOHSHpjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTc0Mw==", "bodyText": "I guess these commands will print errors when run multiple times (e.g. stop/start/stop/start)\nwould it make sense to make them idempotent?", "url": "https://github.com/oracle/opengrok/pull/3160#discussion_r488761743", "createdAt": "2020-09-15T15:30:50Z", "author": {"login": "tarzanek"}, "path": "docker/start.sh", "diffHunk": "@@ -5,10 +5,38 @@ if [ -z \"$REINDEX\" ]; then\n \tREINDEX=10\n fi\n \n+if [[ \"${URL_ROOT}\" = *\" \"* ]]; then\n+\tdate +\"%F %T Deployment path contains spaces. Deploying to root...\"\n+\texport URL_ROOT=\"/\"\n+fi\n+\n+# Remove leading and trailing slashes\n+URL_ROOT=\"${URL_ROOT#/}\"\n+URL_ROOT=\"${URL_ROOT%/}\"\n+\n+if [ \"${URL_ROOT}\" = \"\" ]; then\n+\tWAR_NAME=\"ROOT.war\"\n+else\n+\tWAR_NAME=\"${URL_ROOT//\\//#}.war\"\n+fi\n+\n+if [ ! -f \"/usr/local/tomcat/webapps/${WAR_NAME}\" ]; then\n+\tdate +\"%F %T Deployment path changed. Redeploying...\"\n+\n+\t# Delete old deployment and (re)deploy\n+\trm -rf /usr/local/tomcat/webapps/*\n+\topengrok-deploy -c /opengrok/etc/configuration.xml \\\n+            /opengrok/lib/source.war \"/usr/local/tomcat/webapps/${WAR_NAME}\"\n+\n+\t# Set up redirect from /source\n+\tmkdir \"/usr/local/tomcat/webapps/source\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff0eb2e83bc7d179f2679d018aac48e552c0d7e2"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 158, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}