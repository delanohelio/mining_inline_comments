{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NDg2NjEw", "number": 3259, "title": "Fail CommandSequence if RESTful call fails", "bodyText": "This changes the processing of RESTful calls in CommandSequence. If the call fails, the \"command\" is considered as failed.", "createdAt": "2020-10-04T19:33:39Z", "url": "https://github.com/oracle/opengrok/pull/3259", "merged": true, "mergeCommit": {"oid": "38bf0d4784b8a87521070f9d6222c8f126ea9679"}, "closed": true, "closedAt": "2020-10-05T17:40:59Z", "author": {"login": "vladak"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPUdgpAH2gAyNDk3NDg2NjEwOmNmY2E4MGY0MmVlZjliMDNmMDkzZWFmZmZlNTQ2NGMzOTlmZDA0YmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPlRtmAFqTUwMjE1Nzg1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cfca80f42eef9b03f093eafffe5464c399fd04ba", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/cfca80f42eef9b03f093eafffe5464c399fd04ba", "committedDate": "2020-10-04T19:36:26Z", "message": "fail CommandSequence processing if RESTful call fails\n\nfixes #3026"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3121dd48f454bddc277bceeb231eaa5c056fc672", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/3121dd48f454bddc277bceeb231eaa5c056fc672", "committedDate": "2020-10-04T19:32:05Z", "message": "fail CommandSequence processing if RESTful call fails\n\nfixes #3026"}, "afterCommit": {"oid": "cfca80f42eef9b03f093eafffe5464c399fd04ba", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/cfca80f42eef9b03f093eafffe5464c399fd04ba", "committedDate": "2020-10-04T19:36:26Z", "message": "fail CommandSequence processing if RESTful call fails\n\nfixes #3026"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjUzNDEy", "url": "https://github.com/oracle/opengrok/pull/3259#pullrequestreview-501653412", "createdAt": "2020-10-04T19:43:39Z", "commit": {"oid": "cfca80f42eef9b03f093eafffe5464c399fd04ba"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxOTo0MzozOVrOHcJu7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxOTo0Nzo0M1rOHcJwQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTY0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if self.outputs.get(cmd):\n          \n          \n            \n                        for line in self.outputs[cmd]:\n          \n          \n            \n                            str += '{}{}'.format(indent, line)\n          \n          \n            \n                    for line in self.outputs.get(cmd, []):\n          \n          \n            \n                        str += '{}{}'.format(indent, line)", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499281644", "createdAt": "2020-10-04T19:43:39Z", "author": {"login": "eric-saintetienne"}, "path": "opengrok-tools/src/main/python/opengrok_tools/utils/commandsequence.py", "diffHunk": "@@ -60,7 +64,7 @@ def __str__(self):\n \n     def get_cmd_output(self, cmd, indent=\"\"):\n         str = \"\"\n-        if self.outputs[cmd]:\n+        if self.outputs.get(cmd):\n             for line in self.outputs[cmd]:\n                 str += '{}{}'.format(indent, line)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfca80f42eef9b03f093eafffe5464c399fd04ba"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4MTk4Ng==", "bodyText": "A lot of repetitions here, wouldn't it make sense to factor the common code into a single function (named, say request) that all verbs would call?", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499281986", "createdAt": "2020-10-04T19:47:43Z", "author": {"login": "eric-saintetienne"}, "path": "opengrok-tools/src/main/python/opengrok_tools/utils/webutil.py", "diffHunk": "@@ -27,45 +27,23 @@\n \n \n def get(logger, uri, params=None, headers=None):\n-    try:\n-        proxies = get_proxies(uri)\n-        return requests.get(uri, params=params, proxies=proxies)\n-    except Exception:\n-        logger.debug(traceback.format_exc())\n-        return None\n+    proxies = get_proxies(uri)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfca80f42eef9b03f093eafffe5464c399fd04ba"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab4931e74fef78b31dc81d41d85d51ca7f76d002", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/ab4931e74fef78b31dc81d41d85d51ca7f76d002", "committedDate": "2020-10-04T20:41:58Z", "message": "review comment\n\nCo-authored-by: ericsaintetienne <eric.saintetienne@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dab18f0c6b3246d9c00215ad77d58cfccc646a8c", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/dab18f0c6b3246d9c00215ad77d58cfccc646a8c", "committedDate": "2020-10-04T21:50:33Z", "message": "reduce repeated code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62052fbc3e01944d057174b6c8a285080ac4c86c", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/62052fbc3e01944d057174b6c8a285080ac4c86c", "committedDate": "2020-10-04T21:58:53Z", "message": "use getattr() to lookup method function name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76e40a062831d4ba91cd44dce1e31dd81807659f", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/76e40a062831d4ba91cd44dce1e31dd81807659f", "committedDate": "2020-10-04T22:02:31Z", "message": "shorten line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77867ea897954bfe53ffd1608c68d3ba8b5c0678", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/77867ea897954bfe53ffd1608c68d3ba8b5c0678", "committedDate": "2020-10-04T22:02:43Z", "message": "remove blank line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27369e7af2d2b348c194b13e8a2d0c9a1c3a03d4", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/27369e7af2d2b348c194b13e8a2d0c9a1c3a03d4", "committedDate": "2020-10-04T22:04:08Z", "message": "shorten lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a94d709d54597012aaddbd54ead39b177de5e4ab", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/a94d709d54597012aaddbd54ead39b177de5e4ab", "committedDate": "2020-10-04T22:08:43Z", "message": "use callable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98eae593f28b9f76c67e7d87a36bec6483b79ee0", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/98eae593f28b9f76c67e7d87a36bec6483b79ee0", "committedDate": "2020-10-04T22:09:25Z", "message": "add missing argument"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae9c08a0e45a638ab10ddec9ca6e733948f546e8", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/ae9c08a0e45a638ab10ddec9ca6e733948f546e8", "committedDate": "2020-10-05T06:44:03Z", "message": "remove verb check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d619ca92928bc9dcc0312025c2d719406db4620", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/1d619ca92928bc9dcc0312025c2d719406db4620", "committedDate": "2020-10-05T12:32:27Z", "message": "fix result handling, add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b847fa80c5c690ab597184ee47825d38a768d23", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/6b847fa80c5c690ab597184ee47825d38a768d23", "committedDate": "2020-10-05T12:39:59Z", "message": "propagate check() return code to program exit code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf396e409776f8fded2ef041e9a2328d606c50a2", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/cf396e409776f8fded2ef041e9a2328d606c50a2", "committedDate": "2020-10-05T12:45:08Z", "message": "add blank"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDcyMDQ5", "url": "https://github.com/oracle/opengrok/pull/3259#pullrequestreview-502072049", "createdAt": "2020-10-05T13:46:02Z", "commit": {"oid": "cf396e409776f8fded2ef041e9a2328d606c50a2"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzo0NjowMlrOHcdytQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzo1MzozM1rOHceIVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMDI5Mw==", "bodyText": "I believe you can pass the handler directly as do_api_call('http:/...', requests.put, ... ) which could simplify the code around it", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499610293", "createdAt": "2020-10-05T13:46:02Z", "author": {"login": "tulinkry"}, "path": "opengrok-tools/src/main/python/opengrok_tools/utils/restful.py", "diffHunk": "@@ -18,31 +18,27 @@\n #\n \n #\n-# Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.\n+# Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.\n #\n \n import logging\n import json\n+import requests\n \n-from .webutil import put, post, delete\n+from .webutil import get_proxies\n from .patterns import COMMAND_PROPERTY\n \n \n CONTENT_TYPE = 'Content-Type'\n APPLICATION_JSON = 'application/json'   # default\n \n \n-def do_api_call(command, uri, verb, headers, data):\n-    verbs = {\n-        'PUT': put,\n-        'POST': post,\n-        'DELETE': delete\n-    }\n-    handler = verbs.get(verb)\n-    if handler is not None:\n-        logger = logging.getLogger(__name__)\n-        return handler(logger, uri, headers=headers, data=data)\n-    raise Exception('Unknown HTTP verb in command {}'.format(command))\n+def do_api_call(uri, verb, headers=None, data=None):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf396e409776f8fded2ef041e9a2328d606c50a2"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMjA5NA==", "bodyText": "Also I would switch the order to verb -> uri as that is the usual order", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499612094", "createdAt": "2020-10-05T13:48:31Z", "author": {"login": "tulinkry"}, "path": "opengrok-tools/src/main/python/opengrok_tools/utils/restful.py", "diffHunk": "@@ -18,31 +18,27 @@\n #\n \n #\n-# Copyright (c) 2017, 2019, Oracle and/or its affiliates. All rights reserved.\n+# Copyright (c) 2017, 2020, Oracle and/or its affiliates. All rights reserved.\n #\n \n import logging\n import json\n+import requests\n \n-from .webutil import put, post, delete\n+from .webutil import get_proxies\n from .patterns import COMMAND_PROPERTY\n \n \n CONTENT_TYPE = 'Content-Type'\n APPLICATION_JSON = 'application/json'   # default\n \n \n-def do_api_call(command, uri, verb, headers, data):\n-    verbs = {\n-        'PUT': put,\n-        'POST': post,\n-        'DELETE': delete\n-    }\n-    handler = verbs.get(verb)\n-    if handler is not None:\n-        logger = logging.getLogger(__name__)\n-        return handler(logger, uri, headers=headers, data=data)\n-    raise Exception('Unknown HTTP verb in command {}'.format(command))\n+def do_api_call(uri, verb, headers=None, data=None):", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMDI5Mw=="}, "originalCommit": {"oid": "cf396e409776f8fded2ef041e9a2328d606c50a2"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMzUwOA==", "bodyText": "here the level is error but for other commands it is info (below)", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499613508", "createdAt": "2020-10-05T13:50:25Z", "author": {"login": "tulinkry"}, "path": "opengrok-tools/src/main/python/opengrok_tools/utils/commandsequence.py", "diffHunk": "@@ -156,7 +165,11 @@ def run_cleanup(self):\n \n         for cleanup_cmd in self.cleanup:\n             if is_web_uri(cleanup_cmd.get(COMMAND_PROPERTY)[0]):\n-                call_rest_api(cleanup_cmd, PROJECT_SUBST, self.name)\n+                try:\n+                    call_rest_api(cleanup_cmd, PROJECT_SUBST, self.name)\n+                except HTTPError as e:\n+                    self.logger.error(\"RESTful command {} failed: {}\".", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf396e409776f8fded2ef041e9a2328d606c50a2"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTA2OQ==", "bodyText": "missing break? the else branch has it", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499615069", "createdAt": "2020-10-05T13:52:31Z", "author": {"login": "tulinkry"}, "path": "opengrok-tools/src/main/python/opengrok_tools/utils/commandsequence.py", "diffHunk": "@@ -106,12 +109,18 @@ def run(self):\n         argument list of the command.\n \n         Any command entry that is a URI, will be used to submit RESTful API\n-        request. Return codes for these requests are not checked.\n+        request.\n         \"\"\"\n \n         for command in self.commands:\n             if is_web_uri(command.get(COMMAND_PROPERTY)[0]):\n-                call_rest_api(command, PROJECT_SUBST, self.name)\n+                try:\n+                    call_rest_api(command, PROJECT_SUBST, self.name)\n+                except HTTPError as e:\n+                    self.logger.error(\"RESTful command {} failed: {}\".\n+                                      format(command, e))\n+                    self.failed = True\n+                    self.retcodes[str(command)] = FAILURE_EXITVAL", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf396e409776f8fded2ef041e9a2328d606c50a2"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxNTgzMA==", "bodyText": "!= SUCCESS_EXITVAL?", "url": "https://github.com/oracle/opengrok/pull/3259#discussion_r499615830", "createdAt": "2020-10-05T13:53:33Z", "author": {"login": "tulinkry"}, "path": "opengrok-tools/src/main/python/opengrok_tools/sync.py", "diffHunk": "@@ -109,7 +111,11 @@ def do_sync(args, commands, config, directory, dirs_to_process, ignore_errors,\n                 cmds = CommandSequence(cmds_base)\n                 cmds.fill(cmds_base.retcodes, cmds_base.outputs,\n                           cmds_base.failed)\n-                cmds.check(ignore_errors)\n+                r = cmds.check(ignore_errors)\n+                if r != 0:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf396e409776f8fded2ef041e9a2328d606c50a2"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f55cfbf2d1d23c2434ac971605b2c1b539716ad5", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/f55cfbf2d1d23c2434ac971605b2c1b539716ad5", "committedDate": "2020-10-05T14:24:41Z", "message": "use SUCCESS_EXITVAL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a773fd437506d97c8a047c24246335cb0966e9b", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/0a773fd437506d97c8a047c24246335cb0966e9b", "committedDate": "2020-10-05T14:26:41Z", "message": "use error level consistently"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5496ee5f709f7fce7ff0ffe20a0bcfcc242b8015", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/5496ee5f709f7fce7ff0ffe20a0bcfcc242b8015", "committedDate": "2020-10-05T14:36:26Z", "message": "change do_api_call() signature to use verb first"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "353c0b1f1e2d3d0fefaf3be51ea48c902da4db0e", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/353c0b1f1e2d3d0fefaf3be51ea48c902da4db0e", "committedDate": "2020-10-05T14:37:36Z", "message": "break the cycle on restful failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTU3ODU5", "url": "https://github.com/oracle/opengrok/pull/3259#pullrequestreview-502157859", "createdAt": "2020-10-05T15:11:56Z", "commit": {"oid": "353c0b1f1e2d3d0fefaf3be51ea48c902da4db0e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 214, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}