{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNDYxNTUz", "number": 3086, "title": "make suggester popularity tests wait on rebuild", "bodyText": "This change fixes the popularity data related test failures tracked by #2704. After making increaseSearchCount() testable and adding logging it became evident that the failures stem from bailing on waiting on suggester rebuild.", "createdAt": "2020-03-23T15:37:17Z", "url": "https://github.com/oracle/opengrok/pull/3086", "merged": true, "mergeCommit": {"oid": "2bf11f3644e739201c5f80d7a12e1ea9f5d24027"}, "closed": true, "closedAt": "2020-04-01T09:46:13Z", "author": {"login": "vladak"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS0ba8AH2gAyMzkyNDYxNTUzOmMzMTE5MzkzODFjMmFiMzA4OWNiMDEwNWQ0ODhjMzFkNGFiZDIyMzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTUJuZABqjMxODY5ODY0MTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c311939381c2ab3089cb0105d488c31d4abd2238", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/c311939381c2ab3089cb0105d488c31d4abd2238", "committedDate": "2020-03-30T20:21:44Z", "message": "add TestCasePrinterRule and use it in SuggesterControllerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4c242759f69570144f88240e8646290785a269c", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/f4c242759f69570144f88240e8646290785a269c", "committedDate": "2020-03-30T20:21:44Z", "message": "re-enable testGetSuggestionsMultipleProjects()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67e73b199286d16dcdec62d67b3511d2974abc09", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/67e73b199286d16dcdec62d67b3511d2974abc09", "committedDate": "2020-03-30T20:21:44Z", "message": "make increaseSearchCount() testable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbdacc7d9d9d659359af452a91371a3feaf4b8a4", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/cbdacc7d9d9d659359af452a91371a3feaf4b8a4", "committedDate": "2020-03-30T20:21:44Z", "message": "add increaseSearchCount() definition that can wait on the suggester lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80afad3b3c0bea4c47c6f42d79e1a1a14c94ea88", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/80afad3b3c0bea4c47c6f42d79e1a1a14c94ea88", "committedDate": "2020-03-30T20:21:44Z", "message": "add method to wait for suggester rebuild synchronously"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4f700767bf99e6bff5334d4fb892c5734ee89dc", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/a4f700767bf99e6bff5334d4fb892c5734ee89dc", "committedDate": "2020-03-23T15:45:01Z", "message": "avoid wildcard imports"}, "afterCommit": {"oid": "80afad3b3c0bea4c47c6f42d79e1a1a14c94ea88", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/80afad3b3c0bea4c47c6f42d79e1a1a14c94ea88", "committedDate": "2020-03-30T20:21:44Z", "message": "add method to wait for suggester rebuild synchronously"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09f890ac8915d29776f1e7924cfd158a859913ba", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/09f890ac8915d29776f1e7924cfd158a859913ba", "committedDate": "2020-03-31T09:55:30Z", "message": "rename variable to match the use"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3020c9d7f364dff0c8988517263441ce1bd32fa", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/c3020c9d7f364dff0c8988517263441ce1bd32fa", "committedDate": "2020-03-31T09:55:30Z", "message": "add method to wait for suggester init"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c98fe320dd1974fc341e89c1cc3142e0463f1c25", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/c98fe320dd1974fc341e89c1cc3142e0463f1c25", "committedDate": "2020-03-31T09:55:30Z", "message": "fix waitForRebuild() comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Njk5Mjc5", "url": "https://github.com/oracle/opengrok/pull/3086#pullrequestreview-384699279", "createdAt": "2020-03-31T12:51:19Z", "commit": {"oid": "c98fe320dd1974fc341e89c1cc3142e0463f1c25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMjo1MToyMFrOF-UNRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMjo1MToyMFrOF-UNRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg4NzExMQ==", "bodyText": "Is it needed?", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r400887111", "createdAt": "2020-03-31T12:51:20Z", "author": {"login": "ahornace"}, "path": "suggester/src/main/java/org/opengrok/suggest/Suggester.java", "diffHunk": "@@ -234,6 +249,11 @@ public void rebuild(final Collection<NamedIndexDir> indexDirs) {\n             return;\n         }\n \n+        // for testing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c98fe320dd1974fc341e89c1cc3142e0463f1c25"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MDE0NDUw", "url": "https://github.com/oracle/opengrok/pull/3086#pullrequestreview-385014450", "createdAt": "2020-03-31T18:53:25Z", "commit": {"oid": "c98fe320dd1974fc341e89c1cc3142e0463f1c25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxODo1MzoyNVrOF-jp7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxODo1MzoyNVrOF-jp7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MDIwNg==", "bodyText": "Missing newline.", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r401140206", "createdAt": "2020-03-31T18:53:25Z", "author": {"login": "ahornace"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/TestCasePrinterRule.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+// taken from https://technicaltesting.wordpress.com/2012/10/23/junit-rule-for-printing-test-case-start-and-end-information/\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.text.DecimalFormat;\n+\n+import org.junit.rules.ExternalResource;\n+import org.junit.rules.TestRule;\n+import org.junit.runner.Description;\n+import org.junit.runners.model.Statement;\n+\n+public class TestCasePrinterRule implements TestRule {\n+\n+    private OutputStream out;\n+    private final TestCasePrinter printer = new TestCasePrinter();\n+\n+    private String beforeContent = null;\n+    private String afterContent = null;\n+    private long timeStart;\n+\n+    public TestCasePrinterRule() {\n+        this(System.out);\n+    }\n+\n+    public TestCasePrinterRule(OutputStream os) {\n+        out = os;\n+    }\n+\n+    private class TestCasePrinter extends ExternalResource {\n+        @Override\n+        protected void before() throws Throwable {\n+            timeStart = System.currentTimeMillis();\n+            out.write(beforeContent.getBytes());\n+        }\n+\n+        @Override\n+        protected void after() {\n+            try {\n+                long timeEnd = System.currentTimeMillis();\n+                double seconds = (timeEnd - timeStart) / 1000.0;\n+                out.write((afterContent + \"Time elapsed: \" + new DecimalFormat(\"0.000\").format(seconds) + \" sec\\n\").\n+                        getBytes());\n+            } catch (IOException ioe) { /* ignore */\n+            }\n+        }\n+    }\n+\n+    private static String getClassBasename(String inputName) {\n+        int idx;\n+        if (((idx = inputName.lastIndexOf('.')) > 0) && (idx < inputName.length())) {\n+            return inputName.substring(idx + 1);\n+        } else {\n+            return inputName;\n+        }\n+    }\n+\n+    public final Statement apply(Statement statement, Description description) {\n+        final String testDescription = getClassBasename(description.getClassName()) + \"#\" +  description.getMethodName();\n+        beforeContent = String.format(\"\\n[TEST START: %s]\\n\", testDescription);\n+        afterContent =  String.format(\"[TEST ENDED: %s] \", testDescription);\n+        return printer.apply(statement, description);\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c98fe320dd1974fc341e89c1cc3142e0463f1c25"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MDE0ODE5", "url": "https://github.com/oracle/opengrok/pull/3086#pullrequestreview-385014819", "createdAt": "2020-03-31T18:53:54Z", "commit": {"oid": "c98fe320dd1974fc341e89c1cc3142e0463f1c25"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxODo1Mzo1NFrOF-jrNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxODo1Mzo1NFrOF-jrNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0MDUzMg==", "bodyText": "Should be volatile.", "url": "https://github.com/oracle/opengrok/pull/3086#discussion_r401140532", "createdAt": "2020-03-31T18:53:54Z", "author": {"login": "ahornace"}, "path": "suggester/src/main/java/org/opengrok/suggest/Suggester.java", "diffHunk": "@@ -87,6 +91,12 @@\n \n     private final int rebuildParallelismLevel;\n \n+    private boolean rebuilding;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c98fe320dd1974fc341e89c1cc3142e0463f1c25"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "438884a5e3a8949f5cdd7628dc69baba3fc8a490", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/438884a5e3a8949f5cdd7628dc69baba3fc8a490", "committedDate": "2020-04-01T09:17:23Z", "message": "fix comments per @ahornace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9eba95a9c0cdbbb43a0d86cfb8a620336383f28", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/d9eba95a9c0cdbbb43a0d86cfb8a620336383f28", "committedDate": "2020-04-01T09:17:23Z", "message": "make the rebuilding boolean volatile"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9227b29c402fd56c5d0592f689df2310eca9fe13", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/9227b29c402fd56c5d0592f689df2310eca9fe13", "committedDate": "2020-04-01T09:16:24Z", "message": "fix javadoc"}, "afterCommit": {"oid": "d9eba95a9c0cdbbb43a0d86cfb8a620336383f28", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/d9eba95a9c0cdbbb43a0d86cfb8a620336383f28", "committedDate": "2020-04-01T09:17:23Z", "message": "make the rebuilding boolean volatile"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 311, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}