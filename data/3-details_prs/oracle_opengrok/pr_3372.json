{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzOTk2MDY3", "number": 3372, "title": "generate xref for non empty compressed files", "bodyText": "This change makes it possible to produce xref's for compressed files. The most complex part is trying to make sure that empty xref files are not lying around.", "createdAt": "2020-11-19T14:32:47Z", "url": "https://github.com/oracle/opengrok/pull/3372", "merged": true, "mergeCommit": {"oid": "d60211b24c761f9c52e69b71e0fc7cd1b7346f66"}, "closed": true, "closedAt": "2020-12-01T08:03:27Z", "author": {"login": "vladak"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeB4kBgH2gAyNTIzOTk2MDY3OjBhOWYzODkxZDk0ZTQ2ZWMzYTdhOGIyNTgzNmE0MTg4MzQzM2EzZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhpbZTAFqTU0MTE2ODYwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a9f3891d94e46ec3a7a8b25836a41883433a3ee", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/0a9f3891d94e46ec3a7a8b25836a41883433a3ee", "committedDate": "2020-11-19T12:26:39Z", "message": "always create xref writer\n\nfixes #858"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a92942b5e0153044f350d8abbafd6ddc4ffafab", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/7a92942b5e0153044f350d8abbafd6ddc4ffafab", "committedDate": "2020-11-19T12:43:05Z", "message": "check fa in newXrefWriter()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08991a1b1c8b0b72e969d4e40675a11360f673be", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/08991a1b1c8b0b72e969d4e40675a11360f673be", "committedDate": "2020-11-19T13:57:22Z", "message": "avoid empty xref files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c30af2bd362f4a61a7e3ca97ebbde3a57e76e032", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/c30af2bd362f4a61a7e3ca97ebbde3a57e76e032", "committedDate": "2020-11-19T14:21:58Z", "message": "bump copyright year"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ae1f0ba0a75752b667c101734a9eab87432a716", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/9ae1f0ba0a75752b667c101734a9eab87432a716", "committedDate": "2020-11-19T16:48:18Z", "message": "reuse basic indexer test as xref test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a8debca1220afd5011be27920e56dda74eedcea", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/8a8debca1220afd5011be27920e56dda74eedcea", "committedDate": "2020-11-19T19:31:42Z", "message": "move finishWriting() to the common finally block\n\nfixes #3373"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0ODQzMTU2", "url": "https://github.com/oracle/opengrok/pull/3372#pullrequestreview-534843156", "createdAt": "2020-11-19T20:55:03Z", "commit": {"oid": "8a8debca1220afd5011be27920e56dda74eedcea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDo1NTowM1rOH2xPxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDo1NTowM1rOH2xPxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE5MjAwNg==", "bodyText": "Please don't relocate this. That breaks known failure handling where we would actually not want to finish writing. I.e. finishWriting() in advance of a RuntimeException catch is deliberate.\nRecommend you swallow web exceptions as per your alternative idea. Web exceptions didn't used to abort an index run; you used to be able to index without Opengrok web running. Not sure what changed or when to break that.", "url": "https://github.com/oracle/opengrok/pull/3372#discussion_r527192006", "createdAt": "2020-11-19T20:55:03Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/index/IndexDatabase.java", "diffHunk": "@@ -486,17 +487,17 @@ public void update() throws IOException {\n                     reader.close();\n                 }\n             }\n-\n-            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a8debca1220afd5011be27920e56dda74eedcea"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0242d362ec1714ee2afa656c7d8abe3d4ab366b4", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/0242d362ec1714ee2afa656c7d8abe3d4ab366b4", "committedDate": "2020-11-20T08:30:11Z", "message": "Revert \"move finishWriting() to the common finally block\"\n\nThis reverts commit 8a8debca1220afd5011be27920e56dda74eedcea."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de0f83f32f3cf880db21ac5c40a53b3f475cb151", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/de0f83f32f3cf880db21ac5c40a53b3f475cb151", "committedDate": "2020-11-20T08:34:39Z", "message": "swallow exceptions in markProjectIndexed()\n\nfixes #3373"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a37e60f32e338d8e1e3f20823c70996ad07a952", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/0a37e60f32e338d8e1e3f20823c70996ad07a952", "committedDate": "2020-11-20T08:37:58Z", "message": "add comment per Chris"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f5708ab95ecbcbcde4944c312b89da6c08a8d8", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/64f5708ab95ecbcbcde4944c312b89da6c08a8d8", "committedDate": "2020-11-20T08:39:36Z", "message": "remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MTQyMjI5", "url": "https://github.com/oracle/opengrok/pull/3372#pullrequestreview-536142229", "createdAt": "2020-11-23T01:35:07Z", "commit": {"oid": "64f5708ab95ecbcbcde4944c312b89da6c08a8d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwMTozNTowN1rOH39TyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwMTozNTowN1rOH39TyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQzODIxNg==", "bodyText": "I worry on NTFS that a deletion of an open file wouldn't succeed as it would do on *nix. Perhaps instead schedule a PendingFileDeletion of the transientXref?", "url": "https://github.com/oracle/opengrok/pull/3372#discussion_r528438216", "createdAt": "2020-11-23T01:35:07Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/index/IndexDatabase.java", "diffHunk": "@@ -725,8 +739,28 @@ private void addFile(File file, String path, Ctags ctags)\n         fa.setFoldingEnabled(env.isFoldingEnabled());\n \n         Document doc = new Document();\n-        try (Writer xrefOut = newXrefWriter(fa, path)) {\n+        CountingWriter xrefOut = null;\n+        try {\n+            String xrefAbs = null;\n+            File transientXref = null;\n+            if (env.isGenerateHtml()) {\n+                xrefAbs = getXrefPath(path);\n+                transientXref = new File(TandemPath.join(xrefAbs,\n+                        PendingFileCompleter.PENDING_EXTENSION));\n+                xrefOut = newXrefWriter(path, transientXref, env.isCompressXref());\n+            }\n+\n             analyzerGuru.populateDocument(doc, file, path, fa, xrefOut);\n+\n+            // Avoid producing empty xref files.\n+            if (xrefOut != null && xrefOut.getCount() > 0) {\n+                PendingFileRenaming ren = new PendingFileRenaming(xrefAbs,\n+                        transientXref.getAbsolutePath());\n+                completer.add(ren);\n+            } else if (xrefOut != null) {\n+                LOGGER.log(Level.FINER, \"xref for {0} would be empty, removing\", path);\n+                transientXref.delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64f5708ab95ecbcbcde4944c312b89da6c08a8d8"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33a15e8d9e7a74c593fc2074921f810cddd9840e", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/33a15e8d9e7a74c593fc2074921f810cddd9840e", "committedDate": "2020-11-23T08:10:44Z", "message": "delete transient xref file via PendingFileCompleter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjY1NTA3", "url": "https://github.com/oracle/opengrok/pull/3372#pullrequestreview-538665507", "createdAt": "2020-11-25T16:25:19Z", "commit": {"oid": "33a15e8d9e7a74c593fc2074921f810cddd9840e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNjoyNToxOVrOH57EdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNjoyOToyM1rOH57Prw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ5ODY3Nw==", "bodyText": "Not sure the ramification, but usually we would see used the log(Level, String, Throwable) method when an entire Throwable is reported (versus e.g. just the getMessage())", "url": "https://github.com/oracle/opengrok/pull/3372#discussion_r530498677", "createdAt": "2020-11-25T16:25:19Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/index/IndexDatabase.java", "diffHunk": "@@ -353,27 +354,38 @@ private void markProjectIndexed(Project project) {\n         // Successfully indexed the project. The message is sent even if\n         // the project's isIndexed() is true because it triggers RepositoryInfo\n         // refresh.\n-        if (project != null) {\n-            // Also need to store the correct value in configuration\n-            // when indexer writes it to a file.\n-            project.setIndexed(true);\n-\n-            if (env.getConfigURI() != null) {\n-                Response r = ClientBuilder.newClient()\n-                        .target(env.getConfigURI())\n-                        .path(\"api\")\n-                        .path(\"v1\")\n-                        .path(\"projects\")\n-                        .path(Util.URIEncode(project.getName()))\n-                        .path(\"indexed\")\n-                        .request()\n-                        .put(Entity.text(\"\"));\n-\n-                if (r.getStatusInfo().getFamily() != Response.Status.Family.SUCCESSFUL) {\n-                    LOGGER.log(Level.WARNING, \"Couldn''t notify the webapp that project {0} was indexed: {1}\",\n-                            new Object[] {project, r});\n-                }\n-            }\n+        if (project == null) {\n+            return;\n+        }\n+\n+        // Also need to store the correct value in configuration\n+        // when indexer writes it to a file.\n+        project.setIndexed(true);\n+\n+        if (env.getConfigURI() == null) {\n+            return;\n+        }\n+\n+        Response r;\n+        try {\n+            r = ClientBuilder.newClient()\n+                    .target(env.getConfigURI())\n+                    .path(\"api\")\n+                    .path(\"v1\")\n+                    .path(\"projects\")\n+                    .path(Util.URIEncode(project.getName()))\n+                    .path(\"indexed\")\n+                    .request()\n+                    .put(Entity.text(\"\"));\n+        } catch (RuntimeException e) {\n+            LOGGER.log(Level.WARNING, \"Couldn''t notify the webapp that project {0} was indexed: {1}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33a15e8d9e7a74c593fc2074921f810cddd9840e"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUwMTU1MQ==", "bodyText": "redundant?", "url": "https://github.com/oracle/opengrok/pull/3372#discussion_r530501551", "createdAt": "2020-11-25T16:29:23Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/index/IndexDatabase.java", "diffHunk": "@@ -1629,46 +1666,63 @@ public int hashCode() {\n         return hash;\n     }\n \n-    private boolean isXrefWriter(AbstractAnalyzer fa) {\n-        AbstractAnalyzer.Genre g = fa.getFactory().getGenre();\n-        return (g == AbstractAnalyzer.Genre.PLAIN || g == AbstractAnalyzer.Genre.XREFABLE);\n+    private class CountingWriter extends Writer {\n+        private long count;\n+        private Writer out;\n+\n+        CountingWriter(Writer out) {\n+            super(out);\n+            this.out = out;\n+            this.count = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33a15e8d9e7a74c593fc2074921f810cddd9840e"}, "originalPosition": 140}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74b0fb81465d398d6eed90abc01ebdbce4c63c05", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/74b0fb81465d398d6eed90abc01ebdbce4c63c05", "committedDate": "2020-11-26T13:02:32Z", "message": "pass the exception as 3rd argument"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18dfe5ea678ab7e4bdd4547d9d4fe0d848eaaeb3", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/18dfe5ea678ab7e4bdd4547d9d4fe0d848eaaeb3", "committedDate": "2020-11-26T13:04:50Z", "message": "property changes for CountingWriter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTAwNzk4", "url": "https://github.com/oracle/opengrok/pull/3372#pullrequestreview-540500798", "createdAt": "2020-11-29T17:39:28Z", "commit": {"oid": "18dfe5ea678ab7e4bdd4547d9d4fe0d848eaaeb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxNzozOToyOFrOH7lcfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOVQxNzozOToyOFrOH7lcfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI0MTUzNA==", "bodyText": "Does {0} work with String.format?", "url": "https://github.com/oracle/opengrok/pull/3372#discussion_r532241534", "createdAt": "2020-11-29T17:39:28Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/index/IndexDatabase.java", "diffHunk": "@@ -353,27 +354,38 @@ private void markProjectIndexed(Project project) {\n         // Successfully indexed the project. The message is sent even if\n         // the project's isIndexed() is true because it triggers RepositoryInfo\n         // refresh.\n-        if (project != null) {\n-            // Also need to store the correct value in configuration\n-            // when indexer writes it to a file.\n-            project.setIndexed(true);\n-\n-            if (env.getConfigURI() != null) {\n-                Response r = ClientBuilder.newClient()\n-                        .target(env.getConfigURI())\n-                        .path(\"api\")\n-                        .path(\"v1\")\n-                        .path(\"projects\")\n-                        .path(Util.URIEncode(project.getName()))\n-                        .path(\"indexed\")\n-                        .request()\n-                        .put(Entity.text(\"\"));\n-\n-                if (r.getStatusInfo().getFamily() != Response.Status.Family.SUCCESSFUL) {\n-                    LOGGER.log(Level.WARNING, \"Couldn''t notify the webapp that project {0} was indexed: {1}\",\n-                            new Object[] {project, r});\n-                }\n-            }\n+        if (project == null) {\n+            return;\n+        }\n+\n+        // Also need to store the correct value in configuration\n+        // when indexer writes it to a file.\n+        project.setIndexed(true);\n+\n+        if (env.getConfigURI() == null) {\n+            return;\n+        }\n+\n+        Response r;\n+        try {\n+            r = ClientBuilder.newClient()\n+                    .target(env.getConfigURI())\n+                    .path(\"api\")\n+                    .path(\"v1\")\n+                    .path(\"projects\")\n+                    .path(Util.URIEncode(project.getName()))\n+                    .path(\"indexed\")\n+                    .request()\n+                    .put(Entity.text(\"\"));\n+        } catch (RuntimeException e) {\n+            LOGGER.log(Level.WARNING, String.format(\"Couldn''t notify the webapp that project {0} was indexed\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18dfe5ea678ab7e4bdd4547d9d4fe0d848eaaeb3"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNzgzNDY0", "url": "https://github.com/oracle/opengrok/pull/3372#pullrequestreview-540783464", "createdAt": "2020-11-30T10:37:22Z", "commit": {"oid": "18dfe5ea678ab7e4bdd4547d9d4fe0d848eaaeb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMDozNzoyM1rOH71FkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMDozNzoyM1rOH71FkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ5NzgwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        LOGGER.log(Level.WARNING, String.format(\"Couldn''t notify the webapp that project {0} was indexed\",\n          \n          \n            \n                        LOGGER.log(Level.WARNING, String.format(\"Couldn''t notify the webapp that project %s was indexed\",", "url": "https://github.com/oracle/opengrok/pull/3372#discussion_r532497809", "createdAt": "2020-11-30T10:37:23Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/index/IndexDatabase.java", "diffHunk": "@@ -353,27 +354,38 @@ private void markProjectIndexed(Project project) {\n         // Successfully indexed the project. The message is sent even if\n         // the project's isIndexed() is true because it triggers RepositoryInfo\n         // refresh.\n-        if (project != null) {\n-            // Also need to store the correct value in configuration\n-            // when indexer writes it to a file.\n-            project.setIndexed(true);\n-\n-            if (env.getConfigURI() != null) {\n-                Response r = ClientBuilder.newClient()\n-                        .target(env.getConfigURI())\n-                        .path(\"api\")\n-                        .path(\"v1\")\n-                        .path(\"projects\")\n-                        .path(Util.URIEncode(project.getName()))\n-                        .path(\"indexed\")\n-                        .request()\n-                        .put(Entity.text(\"\"));\n-\n-                if (r.getStatusInfo().getFamily() != Response.Status.Family.SUCCESSFUL) {\n-                    LOGGER.log(Level.WARNING, \"Couldn''t notify the webapp that project {0} was indexed: {1}\",\n-                            new Object[] {project, r});\n-                }\n-            }\n+        if (project == null) {\n+            return;\n+        }\n+\n+        // Also need to store the correct value in configuration\n+        // when indexer writes it to a file.\n+        project.setIndexed(true);\n+\n+        if (env.getConfigURI() == null) {\n+            return;\n+        }\n+\n+        Response r;\n+        try {\n+            r = ClientBuilder.newClient()\n+                    .target(env.getConfigURI())\n+                    .path(\"api\")\n+                    .path(\"v1\")\n+                    .path(\"projects\")\n+                    .path(Util.URIEncode(project.getName()))\n+                    .path(\"indexed\")\n+                    .request()\n+                    .put(Entity.text(\"\"));\n+        } catch (RuntimeException e) {\n+            LOGGER.log(Level.WARNING, String.format(\"Couldn''t notify the webapp that project {0} was indexed\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18dfe5ea678ab7e4bdd4547d9d4fe0d848eaaeb3"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d16b7bb8860126655609b487f470a54783b81c2b", "author": {"user": {"login": "vladak", "name": "Vladimir Kotal"}}, "url": "https://github.com/oracle/opengrok/commit/d16b7bb8860126655609b487f470a54783b81c2b", "committedDate": "2020-11-30T10:37:42Z", "message": "use correct format string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTY4NjA5", "url": "https://github.com/oracle/opengrok/pull/3372#pullrequestreview-541168609", "createdAt": "2020-11-30T18:12:46Z", "commit": {"oid": "d16b7bb8860126655609b487f470a54783b81c2b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 127, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}