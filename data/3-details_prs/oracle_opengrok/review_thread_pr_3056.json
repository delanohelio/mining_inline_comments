{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMzA3NzYx", "number": 3056, "reviewThreads": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNDo1MzowOVrODjG2hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwMTowNTowMFrODmD8vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTM5MDEyOnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/Annotation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNDo1MzowOVrOFuuoNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTo0MDozNlrOFuwpbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0Mjc3Mg==", "bodyText": "I don't see this being used in this changeset, was it a missing import?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384542772", "createdAt": "2020-02-26T14:53:09Z", "author": {"login": "tulinkry"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/Annotation.java", "diffHunk": "@@ -24,6 +24,7 @@\n \n package org.opengrok.indexer.history;\n \n+import com.fasterxml.jackson.annotation.JsonProperty;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NTg1NA==", "bodyText": "yes", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384575854", "createdAt": "2020-02-26T15:40:36Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/Annotation.java", "diffHunk": "@@ -24,6 +24,7 @@\n \n package org.opengrok.indexer.history;\n \n+import com.fasterxml.jackson.annotation.JsonProperty;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0Mjc3Mg=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTQxMTQxOnYy", "diffSide": "RIGHT", "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNDo1ODowMFrOFuu1Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNToxNTozNFrOFv4XsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NjEyNw==", "bodyText": "Could you refactor this function to throw related exceptions and map these exceptions in exception mapper? It would make it obvious and without side effects. If I imported this function from a library I would not know what it does ... it takes a path and a response for some reason and returning a file.\nAlso a javadoc on public util method would not hurt.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384546127", "createdAt": "2020-02-26T14:58:00Z", "author": {"login": "tulinkry"}, "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.util;\n+\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.File;\n+import java.io.IOException;\n+\n+public class FileUtil {\n+\n+    private static final RuntimeEnvironment env = RuntimeEnvironment.getInstance();\n+\n+    public static File getFile(String path, HttpServletResponse response) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1MDk2MA==", "bodyText": "Makes sense, thanks for pointing out the existence of exception mappers.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385750960", "createdAt": "2020-02-28T15:15:34Z", "author": {"login": "vladak"}, "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.util;\n+\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.File;\n+import java.io.IOException;\n+\n+public class FileUtil {\n+\n+    private static final RuntimeEnvironment env = RuntimeEnvironment.getInstance();\n+\n+    public static File getFile(String path, HttpServletResponse response) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NjEyNw=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTQxMzQ1OnYy", "diffSide": "RIGHT", "path": "apiary.apib", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNDo1ODoyOVrOFuu2ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNToxOToxMFrOFv4gPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NjQ0Mg==", "bodyText": "what is the number?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384546442", "createdAt": "2020-02-26T14:58:29Z", "author": {"login": "tulinkry"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3Nzg1OQ==", "bodyText": "just entry number, I guess that's not necessary.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384577859", "createdAt": "2020-02-26T15:43:23Z", "author": {"login": "vladak"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NjQ0Mg=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY1NDQyMg==", "bodyText": "you can include it but give it better name :-D", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385654422", "createdAt": "2020-02-28T11:50:29Z", "author": {"login": "tulinkry"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NjQ0Mg=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1MzE1MA==", "bodyText": "it would make sense to have it if pagination was supported.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385753150", "createdAt": "2020-02-28T15:19:10Z", "author": {"login": "vladak"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NjQ0Mg=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTQxNDk5OnYy", "diffSide": "RIGHT", "path": "apiary.apib", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNDo1ODo0OVrOFuu3gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNToyNzowMlrOFv4yQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NjY5MQ==", "bodyText": "can have long naming \"description\"", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384546691", "createdAt": "2020-02-26T14:58:49Z", "author": {"login": "tulinkry"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,\n+                \"revision\": \"e2736ff6\",\n+                \"author\": \"Vladimir Kotal\",\n+                \"desc\": \"changeset:&nbsp;e2736ff6&lt;br/&gt;summary:&nbsp;add&nbsp;microbadges&lt;br/&gt;user:&nbsp;Vladimir&nbsp;Kotal&nbsp;&#60;vlada@devnull.cz&#62;&lt;br/&gt;date:&nbsp;Fri&nbsp;Jun&nbsp;28&nbsp;21:33:41&nbsp;CEST&nbsp;2019\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NzgyMw==", "bodyText": "I wouldn't expect a html code inside json in a description field, is it easy to get rid of it?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384547823", "createdAt": "2020-02-26T15:00:29Z", "author": {"login": "tulinkry"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,\n+                \"revision\": \"e2736ff6\",\n+                \"author\": \"Vladimir Kotal\",\n+                \"desc\": \"changeset:&nbsp;e2736ff6&lt;br/&gt;summary:&nbsp;add&nbsp;microbadges&lt;br/&gt;user:&nbsp;Vladimir&nbsp;Kotal&nbsp;&#60;vlada@devnull.cz&#62;&lt;br/&gt;date:&nbsp;Fri&nbsp;Jun&nbsp;28&nbsp;21:33:41&nbsp;CEST&nbsp;2019\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NjY5MQ=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1Nzc2Mg==", "bodyText": "it turns out it is.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385757762", "createdAt": "2020-02-28T15:27:02Z", "author": {"login": "vladak"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,\n+                \"revision\": \"e2736ff6\",\n+                \"author\": \"Vladimir Kotal\",\n+                \"desc\": \"changeset:&nbsp;e2736ff6&lt;br/&gt;summary:&nbsp;add&nbsp;microbadges&lt;br/&gt;user:&nbsp;Vladimir&nbsp;Kotal&nbsp;&#60;vlada@devnull.cz&#62;&lt;br/&gt;date:&nbsp;Fri&nbsp;Jun&nbsp;28&nbsp;21:33:41&nbsp;CEST&nbsp;2019\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NjY5MQ=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTQxODAxOnYy", "diffSide": "RIGHT", "path": "apiary.apib", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNDo1OTozMlrOFuu5Zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNDoyMzowMlrOFv2lBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NzE3NQ==", "bodyText": "we also utilize the version number in all version of the file (like version 4 out of 22), can you include that as well?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384547175", "createdAt": "2020-02-26T14:59:32Z", "author": {"login": "tulinkry"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,\n+                \"revision\": \"e2736ff6\",\n+                \"author\": \"Vladimir Kotal\",\n+                \"desc\": \"changeset:&nbsp;e2736ff6&lt;br/&gt;summary:&nbsp;add&nbsp;microbadges&lt;br/&gt;user:&nbsp;Vladimir&nbsp;Kotal&nbsp;&#60;vlada@devnull.cz&#62;&lt;br/&gt;date:&nbsp;Fri&nbsp;Jun&nbsp;28&nbsp;21:33:41&nbsp;CEST&nbsp;2019\"\n+              },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4MjE5NA==", "bodyText": "I don't understand. Could you rephrase or provide example ?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384582194", "createdAt": "2020-02-26T15:49:25Z", "author": {"login": "vladak"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,\n+                \"revision\": \"e2736ff6\",\n+                \"author\": \"Vladimir Kotal\",\n+                \"desc\": \"changeset:&nbsp;e2736ff6&lt;br/&gt;summary:&nbsp;add&nbsp;microbadges&lt;br/&gt;user:&nbsp;Vladimir&nbsp;Kotal&nbsp;&#60;vlada@devnull.cz&#62;&lt;br/&gt;date:&nbsp;Fri&nbsp;Jun&nbsp;28&nbsp;21:33:41&nbsp;CEST&nbsp;2019\"\n+              },", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NzE3NQ=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxNzgwOA==", "bodyText": "", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385217808", "createdAt": "2020-02-27T16:22:30Z", "author": {"login": "tulinkry"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,\n+                \"revision\": \"e2736ff6\",\n+                \"author\": \"Vladimir Kotal\",\n+                \"desc\": \"changeset:&nbsp;e2736ff6&lt;br/&gt;summary:&nbsp;add&nbsp;microbadges&lt;br/&gt;user:&nbsp;Vladimir&nbsp;Kotal&nbsp;&#60;vlada@devnull.cz&#62;&lt;br/&gt;date:&nbsp;Fri&nbsp;Jun&nbsp;28&nbsp;21:33:41&nbsp;CEST&nbsp;2019\"\n+              },", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NzE3NQ=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcyMTYwNg==", "bodyText": "Oh that. I've not noticed it before :-)", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385721606", "createdAt": "2020-02-28T14:23:02Z", "author": {"login": "vladak"}, "path": "apiary.apib", "diffHunk": "@@ -6,6 +6,31 @@ OpenGrok RESTful API documentation. The following endpoints are accessible under\n \n Besides `/suggester` and `/search` endpoints, everything is accessible from `localhost` only.\n \n+## Annotation [/annotation{?path}]\n+\n+### Get annotation for a file [GET]\n+\n++ Parameters\n+  + path (string) - path of file, relative to source root\n+\n++ Response 200 (application/json)\n+  + Body\n+\n+            [\n+              {\n+                \"number\": 1,\n+                \"revision\": \"e2736ff6\",\n+                \"author\": \"Vladimir Kotal\",\n+                \"desc\": \"changeset:&nbsp;e2736ff6&lt;br/&gt;summary:&nbsp;add&nbsp;microbadges&lt;br/&gt;user:&nbsp;Vladimir&nbsp;Kotal&nbsp;&#60;vlada@devnull.cz&#62;&lt;br/&gt;date:&nbsp;Fri&nbsp;Jun&nbsp;28&nbsp;21:33:41&nbsp;CEST&nbsp;2019\"\n+              },", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0NzE3NQ=="}, "originalCommit": {"oid": "c74f3d552da703e568a8b4ff8259f0220463c10d"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzU0NjYzOnYy", "diffSide": "LEFT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMjoyOToxMVrOFvDT-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMToxOTo0MFrOFx-BCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MTY1Ng==", "bodyText": "No big problem here but some food for thought:\n\nExecutor.exec() and Executor.exec(boolean) actually spool the entire output of a program into memory. Probably that's not a burdensome amount with this removal of --max-count, given this is a rev-list of a single file.\nWhen the spooled bytes are read later at line 402, they are read with the default Java charset, which is locale dependent on the OS installation. For hashes of a rev-list, that is perhaps always OK \u2014 but I'm just remarking since elsewhere in GitRepository, specific effort is made to use a correct charset (see newLogReader()).\nTechnically when read later at line 402, a BufferedReader is overkill, given that the bytes are already fully spooled in-memory.\nIndeed all the output of a Process (via exec()) must be read or else a deadlock could happen as one awaits the process exit value. The default spool does consume everything.\n\nI wonder if this is an opportunity to create a HeadHandler implementation of Executor.StreamHandler that is line-oriented (e.g. characters out of bytes), that demands a specified encoding instead of allowing the default Java charset, and that reads and stores a maximum number of lines and then just consumes and discards bytes (without bothering with character conversion) to exhaust the stream and avoid allocating heap.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384881656", "createdAt": "2020-02-27T02:29:11Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -389,7 +389,6 @@ private String getFirstRevision(String fullpath) throws IOException {\n                 ensureCommand(CMD_PROPERTY_KEY, CMD_FALLBACK),\n                 \"rev-list\",\n                 \"--reverse\",\n-                \"--max-count=1\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01b9b774786bc4545231124bbf59829db6b601bf"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4MDE2Mg==", "bodyText": "Definitely good idea, I'd go for LineHandler (or similar) and then derive the HeadHandler out of it. For simplicity a lot of code could benefit from this.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385280162", "createdAt": "2020-02-27T18:06:28Z", "author": {"login": "tulinkry"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -389,7 +389,6 @@ private String getFirstRevision(String fullpath) throws IOException {\n                 ensureCommand(CMD_PROPERTY_KEY, CMD_FALLBACK),\n                 \"rev-list\",\n                 \"--reverse\",\n-                \"--max-count=1\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MTY1Ng=="}, "originalCommit": {"oid": "01b9b774786bc4545231124bbf59829db6b601bf"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUwMDQxNQ==", "bodyText": "Thank you, @tulinkry .\nMaybe the reverse though: a LineHandler might be an unbounded HeadHandler. The latter would need to interact low-level with the stream in order to be able to read and dump bytes when a line limit is reached.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385500415", "createdAt": "2020-02-28T04:17:26Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -389,7 +389,6 @@ private String getFirstRevision(String fullpath) throws IOException {\n                 ensureCommand(CMD_PROPERTY_KEY, CMD_FALLBACK),\n                 \"rev-list\",\n                 \"--reverse\",\n-                \"--max-count=1\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MTY1Ng=="}, "originalCommit": {"oid": "01b9b774786bc4545231124bbf59829db6b601bf"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc3MTc4MQ==", "bodyText": "Thanks guys. It occurred to me that this might be a problem but pushed the resolution aside. Will look into it.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385771781", "createdAt": "2020-02-28T15:49:48Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -389,7 +389,6 @@ private String getFirstRevision(String fullpath) throws IOException {\n                 ensureCommand(CMD_PROPERTY_KEY, CMD_FALLBACK),\n                 \"rev-list\",\n                 \"--reverse\",\n-                \"--max-count=1\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MTY1Ng=="}, "originalCommit": {"oid": "01b9b774786bc4545231124bbf59829db6b601bf"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0MDYxOQ==", "bodyText": "The latest changes have the basic HeadHandler (sans encoding).", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r387940619", "createdAt": "2020-03-04T21:19:40Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -389,7 +389,6 @@ private String getFirstRevision(String fullpath) throws IOException {\n                 ensureCommand(CMD_PROPERTY_KEY, CMD_FALLBACK),\n                 \"rev-list\",\n                 \"--reverse\",\n-                \"--max-count=1\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4MTY1Ng=="}, "originalCommit": {"oid": "01b9b774786bc4545231124bbf59829db6b601bf"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzU1Mzc0OnYy", "diffSide": "RIGHT", "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMjozMzoyNlrOFvDYXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwOTo1OTo0M1rOFvL79w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4Mjc4Mw==", "bodyText": "Should the constructor be made private for a static utility class?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r384882783", "createdAt": "2020-02-27T02:33:26Z", "author": {"login": "idodeclare"}, "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.util;\n+\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.File;\n+import java.io.IOException;\n+\n+public class FileUtil {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01b9b774786bc4545231124bbf59829db6b601bf"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAyMjk2Nw==", "bodyText": "yep, actually the checkstyle complains about it.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385022967", "createdAt": "2020-02-27T09:59:43Z", "author": {"login": "vladak"}, "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.util;\n+\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.File;\n+import java.io.IOException;\n+\n+public class FileUtil {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4Mjc4Mw=="}, "originalCommit": {"oid": "01b9b774786bc4545231124bbf59829db6b601bf"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTczMDg2OnYy", "diffSide": "RIGHT", "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjoyNToxNFrOFvX8CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNDoyMTo0MFrOFv2iNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxOTU5Mw==", "bodyText": "There is already FileNotFound (or similar) in java core", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385219593", "createdAt": "2020-02-27T16:25:14Z", "author": {"login": "tulinkry"}, "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.util;\n+\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.File;\n+\n+public class FileUtil {\n+\n+    private static final RuntimeEnvironment env = RuntimeEnvironment.getInstance();\n+\n+    // private to enforce static\n+    private FileUtil() {\n+    }\n+\n+    public static class NoFileException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoFileException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    public static class NoPathException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoPathException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    /**\n+     * @param path path relative to source root\n+     * @return file object corresponding to the file under source root\n+     * @throws NoFileException\n+     * @throws NoPathException\n+     */\n+    public static File getFile(String path, HttpServletResponse response) throws NoPathException, NoFileException {\n+        if (path == null) {\n+            throw new NoPathException(\"Missing path parameter\");\n+        }\n+\n+        File file = new File(env.getSourceRootFile(), path);\n+        if (!file.isFile()) {\n+            throw new NoFileException(\"File not found\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62bb464dc6a17fd1b4a76db542d77585f2fd9d9d"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcyMDg4NQ==", "bodyText": "aha ! thanks.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385720885", "createdAt": "2020-02-28T14:21:40Z", "author": {"login": "vladak"}, "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.util;\n+\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.File;\n+\n+public class FileUtil {\n+\n+    private static final RuntimeEnvironment env = RuntimeEnvironment.getInstance();\n+\n+    // private to enforce static\n+    private FileUtil() {\n+    }\n+\n+    public static class NoFileException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoFileException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    public static class NoPathException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoPathException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    /**\n+     * @param path path relative to source root\n+     * @return file object corresponding to the file under source root\n+     * @throws NoFileException\n+     * @throws NoPathException\n+     */\n+    public static File getFile(String path, HttpServletResponse response) throws NoPathException, NoFileException {\n+        if (path == null) {\n+            throw new NoPathException(\"Missing path parameter\");\n+        }\n+\n+        File file = new File(env.getSourceRootFile(), path);\n+        if (!file.isFile()) {\n+            throw new NoFileException(\"File not found\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxOTU5Mw=="}, "originalCommit": {"oid": "62bb464dc6a17fd1b4a76db542d77585f2fd9d9d"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTczNDU3OnYy", "diffSide": "RIGHT", "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjoyNTo1N1rOFvX-IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNDoyMToyN1rOFv2huA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIyMDEyOQ==", "bodyText": "I think I wrote it somewhere else too, I'm little bit against this naming. But if you feel comfortable, you can disregard.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385220129", "createdAt": "2020-02-27T16:25:57Z", "author": {"login": "tulinkry"}, "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.util;\n+\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.File;\n+\n+public class FileUtil {\n+\n+    private static final RuntimeEnvironment env = RuntimeEnvironment.getInstance();\n+\n+    // private to enforce static\n+    private FileUtil() {\n+    }\n+\n+    public static class NoFileException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoFileException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    public static class NoPathException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoPathException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    /**\n+     * @param path path relative to source root\n+     * @return file object corresponding to the file under source root\n+     * @throws NoFileException\n+     * @throws NoPathException\n+     */\n+    public static File getFile(String path, HttpServletResponse response) throws NoPathException, NoFileException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62bb464dc6a17fd1b4a76db542d77585f2fd9d9d"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcyMDc2MA==", "bodyText": "toFile() ?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385720760", "createdAt": "2020-02-28T14:21:27Z", "author": {"login": "vladak"}, "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.util;\n+\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.File;\n+\n+public class FileUtil {\n+\n+    private static final RuntimeEnvironment env = RuntimeEnvironment.getInstance();\n+\n+    // private to enforce static\n+    private FileUtil() {\n+    }\n+\n+    public static class NoFileException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoFileException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    public static class NoPathException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoPathException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    /**\n+     * @param path path relative to source root\n+     * @return file object corresponding to the file under source root\n+     * @throws NoFileException\n+     * @throws NoPathException\n+     */\n+    public static File getFile(String path, HttpServletResponse response) throws NoPathException, NoFileException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIyMDEyOQ=="}, "originalCommit": {"oid": "62bb464dc6a17fd1b4a76db542d77585f2fd9d9d"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NTczNjg2OnYy", "diffSide": "RIGHT", "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjoyNjoyN1rOFvX_hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjoyNjoyN1rOFvX_hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIyMDQ4Nw==", "bodyText": "response is not needed", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385220487", "createdAt": "2020-02-27T16:26:27Z", "author": {"login": "tulinkry"}, "path": "opengrok-web/src/main/java/org/opengrok/web/util/FileUtil.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.util;\n+\n+import org.opengrok.indexer.configuration.RuntimeEnvironment;\n+\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.File;\n+\n+public class FileUtil {\n+\n+    private static final RuntimeEnvironment env = RuntimeEnvironment.getInstance();\n+\n+    // private to enforce static\n+    private FileUtil() {\n+    }\n+\n+    public static class NoFileException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoFileException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    public static class NoPathException extends Exception {\n+        private static final long serialVersionUID = 1L;\n+\n+        public NoPathException(String message) {\n+            super(message);\n+        }\n+    }\n+\n+    /**\n+     * @param path path relative to source root\n+     * @return file object corresponding to the file under source root\n+     * @throws NoFileException\n+     * @throws NoPathException\n+     */\n+    public static File getFile(String path, HttpServletResponse response) throws NoPathException, NoFileException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62bb464dc6a17fd1b4a76db542d77585f2fd9d9d"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTE5NjkwOnYy", "diffSide": "RIGHT", "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/NoPathExceptionMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNToyNzoyNlrOFv4zRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNToyNzoyNlrOFv4zRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1ODAyMQ==", "bodyText": "#3050 (comment)", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r385758021", "createdAt": "2020-02-28T15:27:26Z", "author": {"login": "tulinkry"}, "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/NoPathExceptionMapper.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.web.api.v1;\n+\n+import org.opengrok.web.util.NoPathParameterException;\n+\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.ext.ExceptionMapper;\n+import javax.ws.rs.ext.Provider;\n+\n+@Provider\n+public class NoPathExceptionMapper implements ExceptionMapper<NoPathParameterException> {\n+    @Override\n+    public Response toResponse(NoPathParameterException e) {\n+        return Response.status(Response.Status.NOT_ACCEPTABLE).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9002f387c7fe4e9d000993741323ea5c1f10c4a9"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5MTA2OTg2OnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/Annotation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQxNjoxNzoyNlrOFwJ53Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwOTo0ODoyMlrOFw-xtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAzODIzNw==", "bodyText": "Any possibility to make this class non-HTML aware and move the encoding to -web or .web?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r386038237", "createdAt": "2020-02-29T16:17:26Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/Annotation.java", "diffHunk": "@@ -163,10 +163,14 @@ void addLine(String revision, String author, boolean enabled) {\n     }\n \n     void addDesc(String revision, String description) {\n-        desc.put(revision, Util.encode(description));\n+        desc.put(revision, description);\n     }\n \n     public String getDesc(String revision) {\n+        return Util.encode(desc.get(revision));\n+    }\n+\n+    public String getDescRaw(String revision) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d442dbb76724f2a009e6df8be59bbf9ec37a373d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwNDUwMg==", "bodyText": "Sure; thought the getDesc() is used more widely.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r386904502", "createdAt": "2020-03-03T09:48:22Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/Annotation.java", "diffHunk": "@@ -163,10 +163,14 @@ void addLine(String revision, String author, boolean enabled) {\n     }\n \n     void addDesc(String revision, String description) {\n-        desc.put(revision, Util.encode(description));\n+        desc.put(revision, description);\n     }\n \n     public String getDesc(String revision) {\n+        return Util.encode(desc.get(revision));\n+    }\n+\n+    public String getDescRaw(String revision) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAzODIzNw=="}, "originalCommit": {"oid": "d442dbb76724f2a009e6df8be59bbf9ec37a373d"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMDEzNDkwOnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/web/Util.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMjo0NzoxOFrOFxeScg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwODoyNzo1OFrOFxj0rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQyMDc4Ng==", "bodyText": "Given the pre-existing if (msg != null) check nearby below, should perhaps the new Util.encode() be done in that if-block?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r387420786", "createdAt": "2020-03-04T02:47:18Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/web/Util.java", "diffHunk": "@@ -713,82 +713,87 @@ public static void readableLine(int num, Writer out, Annotation annotation, Stri\n         out.write(closeQuotedTag);\n         out.write(snum);\n         out.write(anchorEnd);\n+\n         if (annotation != null) {\n-            String r = annotation.getRevision(num);\n-            boolean enabled = annotation.isEnabled(num);\n-            out.write(\"<span class=\\\"blame\\\">\");\n-            if (enabled) {\n-                out.write(anchorClassStart);\n-                out.write(\"r\");\n-                out.write(\"\\\" style=\\\"background-color: \");\n-                out.write(annotation.getColors().getOrDefault(r, \"inherit\"));\n-                out.write(\"\\\" href=\\\"\");\n-                out.write(URIEncode(annotation.getFilename()));\n-                out.write(\"?a=true&amp;r=\");\n-                out.write(URIEncode(r));\n-                String msg = annotation.getDesc(r);\n-                out.write(\"\\\" title=\\\"\");\n-                if (msg != null) {\n-                    out.write(msg);\n-                }\n-                if (annotation.getFileVersion(r) != 0) {\n-                    out.write(\"&lt;br/&gt;version: \" + annotation.getFileVersion(r) + \"/\"\n-                            + annotation.getRevisions().size());\n-                }\n-                out.write(closeQuotedTag);\n-            }\n-            StringBuilder buf = new StringBuilder();\n-            final boolean most_recent_revision = annotation.getFileVersion(r) == annotation.getRevisions().size();\n-            // print an asterisk for the most recent revision\n-            if (most_recent_revision) {\n-                buf.append(\"<span class=\\\"most_recent_revision\\\">\");\n-                buf.append('*');\n+            writeAnnotation(num, out, annotation, userPageLink, userPageSuffix, project);\n+        }\n+    }\n+\n+    private static void writeAnnotation(int num, Writer out, Annotation annotation, String userPageLink, String userPageSuffix, String project) throws IOException {\n+        String r = annotation.getRevision(num);\n+        boolean enabled = annotation.isEnabled(num);\n+        out.write(\"<span class=\\\"blame\\\">\");\n+        if (enabled) {\n+            out.write(anchorClassStart);\n+            out.write(\"r\");\n+            out.write(\"\\\" style=\\\"background-color: \");\n+            out.write(annotation.getColors().getOrDefault(r, \"inherit\"));\n+            out.write(\"\\\" href=\\\"\");\n+            out.write(URIEncode(annotation.getFilename()));\n+            out.write(\"?a=true&amp;r=\");\n+            out.write(URIEncode(r));\n+            String msg = Util.encode(annotation.getDesc(r));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76f343a7096e547628bc072c248219c358ad9e02"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUxMTQ2OQ==", "bodyText": "definitely. Should have done the testing. Thanks.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r387511469", "createdAt": "2020-03-04T08:27:58Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/web/Util.java", "diffHunk": "@@ -713,82 +713,87 @@ public static void readableLine(int num, Writer out, Annotation annotation, Stri\n         out.write(closeQuotedTag);\n         out.write(snum);\n         out.write(anchorEnd);\n+\n         if (annotation != null) {\n-            String r = annotation.getRevision(num);\n-            boolean enabled = annotation.isEnabled(num);\n-            out.write(\"<span class=\\\"blame\\\">\");\n-            if (enabled) {\n-                out.write(anchorClassStart);\n-                out.write(\"r\");\n-                out.write(\"\\\" style=\\\"background-color: \");\n-                out.write(annotation.getColors().getOrDefault(r, \"inherit\"));\n-                out.write(\"\\\" href=\\\"\");\n-                out.write(URIEncode(annotation.getFilename()));\n-                out.write(\"?a=true&amp;r=\");\n-                out.write(URIEncode(r));\n-                String msg = annotation.getDesc(r);\n-                out.write(\"\\\" title=\\\"\");\n-                if (msg != null) {\n-                    out.write(msg);\n-                }\n-                if (annotation.getFileVersion(r) != 0) {\n-                    out.write(\"&lt;br/&gt;version: \" + annotation.getFileVersion(r) + \"/\"\n-                            + annotation.getRevisions().size());\n-                }\n-                out.write(closeQuotedTag);\n-            }\n-            StringBuilder buf = new StringBuilder();\n-            final boolean most_recent_revision = annotation.getFileVersion(r) == annotation.getRevisions().size();\n-            // print an asterisk for the most recent revision\n-            if (most_recent_revision) {\n-                buf.append(\"<span class=\\\"most_recent_revision\\\">\");\n-                buf.append('*');\n+            writeAnnotation(num, out, annotation, userPageLink, userPageSuffix, project);\n+        }\n+    }\n+\n+    private static void writeAnnotation(int num, Writer out, Annotation annotation, String userPageLink, String userPageSuffix, String project) throws IOException {\n+        String r = annotation.getRevision(num);\n+        boolean enabled = annotation.isEnabled(num);\n+        out.write(\"<span class=\\\"blame\\\">\");\n+        if (enabled) {\n+            out.write(anchorClassStart);\n+            out.write(\"r\");\n+            out.write(\"\\\" style=\\\"background-color: \");\n+            out.write(annotation.getColors().getOrDefault(r, \"inherit\"));\n+            out.write(\"\\\" href=\\\"\");\n+            out.write(URIEncode(annotation.getFilename()));\n+            out.write(\"?a=true&amp;r=\");\n+            out.write(URIEncode(r));\n+            String msg = Util.encode(annotation.getDesc(r));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQyMDc4Ng=="}, "originalCommit": {"oid": "76f343a7096e547628bc072c248219c358ad9e02"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNDI0NDg5OnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNDoyMzo1N1rOFyGB9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwOToxNzo1M1rOFyLs1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA3MTkyNg==", "bodyText": "I recommend to avoid breaking encapsulation (though it's rampant in OpenGrok). E.g. rather than returning a private list, how about:\npublic int count() {\n...\n}\n\npublic String get(int index) {\n...\n}", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388071926", "createdAt": "2020-03-05T04:23:57Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide StreamHandler that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numlines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+\n+    // TODO add encoding\n+    public HeadHandler(int numlines) {\n+        this.numlines = numlines;\n+    }\n+\n+    public List<String> getLines() {\n+        return lines;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a38cc58e2566e81970e2115372e4217a441f1198"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE2NDgyMQ==", "bodyText": "I must admit OpenGrok code base has been primary source of my Java programming influence :-)", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388164821", "createdAt": "2020-03-05T09:17:53Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide StreamHandler that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numlines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+\n+    // TODO add encoding\n+    public HeadHandler(int numlines) {\n+        this.numlines = numlines;\n+    }\n+\n+    public List<String> getLines() {\n+        return lines;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA3MTkyNg=="}, "originalCommit": {"oid": "a38cc58e2566e81970e2115372e4217a441f1198"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNDI2MzgxOnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNDozOTozMVrOFyGNMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMToyNjo1NFrOFykw0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA3NDgwMA==", "bodyText": "Technically this is doing needless byte to char conversion. E.g. were it a multi-byte encoding, then decoding is not worthwhile.\nMy original thinking on HeadHandler was to have the principal buffering at the byte-level. E.g. a BufferedReader(InputStreamReader, /*tiny*/200) atop a BufferedInputStream. Then when all the needed readLine() calls are done to just read() and discard from the BufferedInputStream \u2014 probably not a byte at a time but with say a very small byte[1024] buffer.\n(Using readLine() here would defeat the goal of avoiding needless heap allocation.)", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388074800", "createdAt": "2020-03-05T04:39:31Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide StreamHandler that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numlines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+\n+    // TODO add encoding\n+    public HeadHandler(int numlines) {\n+        this.numlines = numlines;\n+    }\n+\n+    public List<String> getLines() {\n+        return lines;\n+    }\n+\n+    @Override\n+    public void processStream(InputStream input) throws IOException {\n+        // TODO specify encoding for InputStreamReader constructor\n+        BufferedReader reader = new BufferedReader(new InputStreamReader(input));\n+        int linenum = 0;\n+        while (linenum < numlines) {\n+            // TODO encoding\n+            String line = reader.readLine();\n+            if (line == null) { // EOF\n+                return;\n+            }\n+            lines.add(line);\n+            linenum++;\n+        }\n+        // Read and forget the rest. Need to use read() since it is not guaranteed\n+        // that newline will ensue.\n+        // TODO: would readline() get the job done ?\n+        while (reader.read() != -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a38cc58e2566e81970e2115372e4217a441f1198"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMjM4Ng==", "bodyText": "I see. Now, BufferedReader.read() will not read a single byte from the underlying stream - it will call fill() to fill the internal buffer.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388422386", "createdAt": "2020-03-05T16:48:17Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide StreamHandler that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numlines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+\n+    // TODO add encoding\n+    public HeadHandler(int numlines) {\n+        this.numlines = numlines;\n+    }\n+\n+    public List<String> getLines() {\n+        return lines;\n+    }\n+\n+    @Override\n+    public void processStream(InputStream input) throws IOException {\n+        // TODO specify encoding for InputStreamReader constructor\n+        BufferedReader reader = new BufferedReader(new InputStreamReader(input));\n+        int linenum = 0;\n+        while (linenum < numlines) {\n+            // TODO encoding\n+            String line = reader.readLine();\n+            if (line == null) { // EOF\n+                return;\n+            }\n+            lines.add(line);\n+            linenum++;\n+        }\n+        // Read and forget the rest. Need to use read() since it is not guaranteed\n+        // that newline will ensue.\n+        // TODO: would readline() get the job done ?\n+        while (reader.read() != -1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA3NDgwMA=="}, "originalCommit": {"oid": "a38cc58e2566e81970e2115372e4217a441f1198"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU3NTQ0MQ==", "bodyText": "Anyhow, the suggested layering sounds good so I have implemented that, together with charset choice.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388575441", "createdAt": "2020-03-05T21:26:54Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide StreamHandler that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numlines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+\n+    // TODO add encoding\n+    public HeadHandler(int numlines) {\n+        this.numlines = numlines;\n+    }\n+\n+    public List<String> getLines() {\n+        return lines;\n+    }\n+\n+    @Override\n+    public void processStream(InputStream input) throws IOException {\n+        // TODO specify encoding for InputStreamReader constructor\n+        BufferedReader reader = new BufferedReader(new InputStreamReader(input));\n+        int linenum = 0;\n+        while (linenum < numlines) {\n+            // TODO encoding\n+            String line = reader.readLine();\n+            if (line == null) { // EOF\n+                return;\n+            }\n+            lines.add(line);\n+            linenum++;\n+        }\n+        // Read and forget the rest. Need to use read() since it is not guaranteed\n+        // that newline will ensue.\n+        // TODO: would readline() get the job done ?\n+        while (reader.read() != -1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODA3NDgwMA=="}, "originalCommit": {"oid": "a38cc58e2566e81970e2115372e4217a441f1198"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTY5ODI3OnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzozODo1OVrOFyTy9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzo1MDowM1rOFyUL4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5NzQ2MA==", "bodyText": "I think the API requires if (headHandler.count() > 0) {", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388297460", "createdAt": "2020-03-05T13:38:59Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -389,23 +390,19 @@ private String getFirstRevision(String fullpath) throws IOException {\n                 ensureCommand(CMD_PROPERTY_KEY, CMD_FALLBACK),\n                 \"rev-list\",\n                 \"--reverse\",\n-                \"--max-count=1\",\n                 \"HEAD\",\n                 \"--\",\n                 fullpath\n         };\n \n         Executor executor = new Executor(Arrays.asList(argv), new File(getDirectoryName()),\n                 RuntimeEnvironment.getInstance().getInteractiveCommandTimeout());\n-        int status = executor.exec();\n-\n-        try (BufferedReader in = new BufferedReader(\n-                new InputStreamReader(executor.getOutputStream()))) {\n-            String line;\n+        HeadHandler headHandler = new HeadHandler(1);\n+        int status = executor.exec(false, headHandler);\n \n-            if ((line = in.readLine()) != null) {\n-                return line.trim();\n-            }\n+        String line;\n+        if ((line = headHandler.get(0)) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da17ed53943a07aa81c302266528b2b44c573013"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwMzg0Mw==", "bodyText": "I see, for some reason I thought it will return null.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388303843", "createdAt": "2020-03-05T13:50:03Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -389,23 +390,19 @@ private String getFirstRevision(String fullpath) throws IOException {\n                 ensureCommand(CMD_PROPERTY_KEY, CMD_FALLBACK),\n                 \"rev-list\",\n                 \"--reverse\",\n-                \"--max-count=1\",\n                 \"HEAD\",\n                 \"--\",\n                 fullpath\n         };\n \n         Executor executor = new Executor(Arrays.asList(argv), new File(getDirectoryName()),\n                 RuntimeEnvironment.getInstance().getInteractiveCommandTimeout());\n-        int status = executor.exec();\n-\n-        try (BufferedReader in = new BufferedReader(\n-                new InputStreamReader(executor.getOutputStream()))) {\n-            String line;\n+        HeadHandler headHandler = new HeadHandler(1);\n+        int status = executor.exec(false, headHandler);\n \n-            if ((line = in.readLine()) != null) {\n-                return line.trim();\n-            }\n+        String line;\n+        if ((line = headHandler.get(0)) != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5NzQ2MA=="}, "originalCommit": {"oid": "da17ed53943a07aa81c302266528b2b44c573013"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzM2Mjk0OnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDo1NzoyNFrOFyj50A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzozNzoxNlrOFy47mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2MTM2MA==", "bodyText": "Shifting the offset into buf would shrink the available target space until possibly only 0-byte reads were done endlessly. I think this should just use the simpler read(byte[]) to reuse the whole buffer each time.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388561360", "createdAt": "2020-03-05T20:57:24Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedInputStream;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide {@code StreamHandler} that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numLines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+    private Charset charset;\n+\n+    /**\n+     * Charset of the underlying reader is set to UTF-8.\n+     * @param numLines maximum number of lines to store\n+     */\n+    public HeadHandler(int numLines) {\n+        this.numLines = numLines;\n+        this.charset = StandardCharsets.UTF_8;\n+    }\n+\n+    public HeadHandler(int numLines, Charset charset) {\n+        this.numLines = numLines;\n+        this.charset = charset;\n+    }\n+\n+    /**\n+     * @return number of lines read\n+     */\n+    public int size() {\n+        return lines.size();\n+    }\n+\n+    /**\n+     * @param i index\n+     * @return line at given index\n+     */\n+    public String get(int i) {\n+        return lines.get(i);\n+    }\n+\n+    @Override\n+    public void processStream(InputStream input) throws IOException {\n+        BufferedInputStream bufStream = new BufferedInputStream(input);\n+        BufferedReader reader = new BufferedReader(new InputStreamReader(bufStream, this.charset), 200);\n+        int lineNum = 0;\n+        while (lineNum < numLines) {\n+            String line = reader.readLine();\n+            if (line == null) { // EOF\n+                return;\n+            }\n+            lines.add(line);\n+            lineNum++;\n+        }\n+\n+        // Read and forget the rest.\n+        byte[] buf = new byte[1024];\n+        int off = 0;\n+        int len;\n+        while ((len = bufStream.read(buf, off, buf.length)) != -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a9e760d9b403133d998d842ef746b2c8fd3fd70"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwNTg4Mw==", "bodyText": "okay, sounds reasonable.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388905883", "createdAt": "2020-03-06T13:37:16Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedInputStream;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide {@code StreamHandler} that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numLines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+    private Charset charset;\n+\n+    /**\n+     * Charset of the underlying reader is set to UTF-8.\n+     * @param numLines maximum number of lines to store\n+     */\n+    public HeadHandler(int numLines) {\n+        this.numLines = numLines;\n+        this.charset = StandardCharsets.UTF_8;\n+    }\n+\n+    public HeadHandler(int numLines, Charset charset) {\n+        this.numLines = numLines;\n+        this.charset = charset;\n+    }\n+\n+    /**\n+     * @return number of lines read\n+     */\n+    public int size() {\n+        return lines.size();\n+    }\n+\n+    /**\n+     * @param i index\n+     * @return line at given index\n+     */\n+    public String get(int i) {\n+        return lines.get(i);\n+    }\n+\n+    @Override\n+    public void processStream(InputStream input) throws IOException {\n+        BufferedInputStream bufStream = new BufferedInputStream(input);\n+        BufferedReader reader = new BufferedReader(new InputStreamReader(bufStream, this.charset), 200);\n+        int lineNum = 0;\n+        while (lineNum < numLines) {\n+            String line = reader.readLine();\n+            if (line == null) { // EOF\n+                return;\n+            }\n+            lines.add(line);\n+            lineNum++;\n+        }\n+\n+        // Read and forget the rest.\n+        byte[] buf = new byte[1024];\n+        int off = 0;\n+        int len;\n+        while ((len = bufStream.read(buf, off, buf.length)) != -1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2MTM2MA=="}, "originalCommit": {"oid": "3a9e760d9b403133d998d842ef746b2c8fd3fd70"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzM2NDUxOnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDo1Nzo1OVrOFyj61Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMDo1Nzo1OVrOFyj61Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2MTYyMQ==", "bodyText": "final possibly?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388561621", "createdAt": "2020-03-05T20:57:59Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedInputStream;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide {@code StreamHandler} that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numLines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+    private Charset charset;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a9e760d9b403133d998d842ef746b2c8fd3fd70"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzM3MjM2OnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTowMDo1NVrOFykAKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTowMDo1NVrOFykAKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU2Mjk4Nw==", "bodyText": "Nit: I think your implementation does ensure non-null for a valid index. Maybe that could be stated firmly in the Javadoc?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388562987", "createdAt": "2020-03-05T21:00:55Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/history/GitRepository.java", "diffHunk": "@@ -389,31 +390,24 @@ private String getFirstRevision(String fullpath) throws IOException {\n                 ensureCommand(CMD_PROPERTY_KEY, CMD_FALLBACK),\n                 \"rev-list\",\n                 \"--reverse\",\n-                \"--max-count=1\",\n                 \"HEAD\",\n                 \"--\",\n                 fullpath\n         };\n \n         Executor executor = new Executor(Arrays.asList(argv), new File(getDirectoryName()),\n                 RuntimeEnvironment.getInstance().getInteractiveCommandTimeout());\n-        int status = executor.exec();\n-\n-        try (BufferedReader in = new BufferedReader(\n-                new InputStreamReader(executor.getOutputStream()))) {\n-            String line;\n+        HeadHandler headHandler = new HeadHandler(1);\n+        int status = executor.exec(false, headHandler);\n \n-            if ((line = in.readLine()) != null) {\n-                return line.trim();\n-            }\n+        String line;\n+        if (headHandler.size() > 0 && (line = headHandler.get(0)) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a9e760d9b403133d998d842ef746b2c8fd3fd70"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzc1NDc0OnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMzoxNTowNlrOFynjjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzozMDowMVrOFy4t5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYyMTE5Nw==", "bodyText": "Oh I forgot to ask: would try-with-resources be appropriate here?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388621197", "createdAt": "2020-03-05T23:15:06Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedInputStream;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide {@code StreamHandler} that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numLines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+    private Charset charset;\n+\n+    /**\n+     * Charset of the underlying reader is set to UTF-8.\n+     * @param numLines maximum number of lines to store\n+     */\n+    public HeadHandler(int numLines) {\n+        this.numLines = numLines;\n+        this.charset = StandardCharsets.UTF_8;\n+    }\n+\n+    public HeadHandler(int numLines, Charset charset) {\n+        this.numLines = numLines;\n+        this.charset = charset;\n+    }\n+\n+    /**\n+     * @return number of lines read\n+     */\n+    public int size() {\n+        return lines.size();\n+    }\n+\n+    /**\n+     * @param i index\n+     * @return line at given index\n+     */\n+    public String get(int i) {\n+        return lines.get(i);\n+    }\n+\n+    @Override\n+    public void processStream(InputStream input) throws IOException {\n+        BufferedInputStream bufStream = new BufferedInputStream(input);\n+        BufferedReader reader = new BufferedReader(new InputStreamReader(bufStream, this.charset), 200);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a9e760d9b403133d998d842ef746b2c8fd3fd70"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwMjM3Mw==", "bodyText": "definitely. Wanted to do it but then forgot.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r388902373", "createdAt": "2020-03-06T13:30:01Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/HeadHandler.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import java.io.BufferedInputStream;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * The purpose of this class is to provide {@code StreamHandler} that limits the output\n+ * to specified number of lines. Compared to {@code SpoolHandler} it consumes\n+ * limited amount of heap.\n+ */\n+public class HeadHandler implements Executor.StreamHandler {\n+    private int numLines;\n+\n+    private final List<String> lines = new ArrayList<>();\n+    private Charset charset;\n+\n+    /**\n+     * Charset of the underlying reader is set to UTF-8.\n+     * @param numLines maximum number of lines to store\n+     */\n+    public HeadHandler(int numLines) {\n+        this.numLines = numLines;\n+        this.charset = StandardCharsets.UTF_8;\n+    }\n+\n+    public HeadHandler(int numLines, Charset charset) {\n+        this.numLines = numLines;\n+        this.charset = charset;\n+    }\n+\n+    /**\n+     * @return number of lines read\n+     */\n+    public int size() {\n+        return lines.size();\n+    }\n+\n+    /**\n+     * @param i index\n+     * @return line at given index\n+     */\n+    public String get(int i) {\n+        return lines.get(i);\n+    }\n+\n+    @Override\n+    public void processStream(InputStream input) throws IOException {\n+        BufferedInputStream bufStream = new BufferedInputStream(input);\n+        BufferedReader reader = new BufferedReader(new InputStreamReader(bufStream, this.charset), 200);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYyMTE5Nw=="}, "originalCommit": {"oid": "3a9e760d9b403133d998d842ef746b2c8fd3fd70"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjM2NTM5OnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwMDo0NzoyNlrOFzSdHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTozMjo0MlrOF0UZ1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNDA2Mw==", "bodyText": "Iterating in the conditional possibly miscounts since one last read() is done to get the -1.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r389324063", "createdAt": "2020-03-08T00:47:26Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class HeadHandlerTest {\n+    private class RandomInputStream extends InputStream {\n+        private final int maxcount;\n+        private int count;\n+        private final int maxlines;\n+        private int lines;\n+\n+        private String letters;\n+\n+        public RandomInputStream(int count, int lines) {\n+            this.maxcount = count;\n+            this.count = 0;\n+            this.maxlines = lines;\n+            this.lines = 0;\n+\n+            letters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n+            letters = letters + letters.toLowerCase();\n+            letters = letters + \"0123456789\";\n+        }\n+\n+        public int getCount() {\n+            return count;\n+        }\n+\n+        @Override\n+        public int read() throws IOException {\n+            if (++count < maxcount) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f484af98af0ba0a2349ca04b8d3e694107b4cc54"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwNDU2NQ==", "bodyText": "yes. was rough.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r390404565", "createdAt": "2020-03-10T15:32:42Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class HeadHandlerTest {\n+    private class RandomInputStream extends InputStream {\n+        private final int maxcount;\n+        private int count;\n+        private final int maxlines;\n+        private int lines;\n+\n+        private String letters;\n+\n+        public RandomInputStream(int count, int lines) {\n+            this.maxcount = count;\n+            this.count = 0;\n+            this.maxlines = lines;\n+            this.lines = 0;\n+\n+            letters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n+            letters = letters + letters.toLowerCase();\n+            letters = letters + \"0123456789\";\n+        }\n+\n+        public int getCount() {\n+            return count;\n+        }\n+\n+        @Override\n+        public int read() throws IOException {\n+            if (++count < maxcount) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNDA2Mw=="}, "originalCommit": {"oid": "f484af98af0ba0a2349ca04b8d3e694107b4cc54"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjM2ODMxOnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwMDo1NTozNlrOFzSehA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTo1MTo1NVrOF0VSmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNDQyMA==", "bodyText": "Perhaps some randomness in line lengths?", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r389324420", "createdAt": "2020-03-08T00:55:36Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class HeadHandlerTest {\n+    private class RandomInputStream extends InputStream {\n+        private final int maxcount;\n+        private int count;\n+        private final int maxlines;\n+        private int lines;\n+\n+        private String letters;\n+\n+        public RandomInputStream(int count, int lines) {\n+            this.maxcount = count;\n+            this.count = 0;\n+            this.maxlines = lines;\n+            this.lines = 0;\n+\n+            letters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n+            letters = letters + letters.toLowerCase();\n+            letters = letters + \"0123456789\";\n+        }\n+\n+        public int getCount() {\n+            return count;\n+        }\n+\n+        @Override\n+        public int read() throws IOException {\n+            if (++count < maxcount) {\n+                // Want the newlines to appear within the first half.\n+                if (count % ((maxcount / 2) / maxlines) == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f484af98af0ba0a2349ca04b8d3e694107b4cc54"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxOTA5Ng==", "bodyText": "good idea. I should randomize the test cases' parameters too.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r390419096", "createdAt": "2020-03-10T15:51:55Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class HeadHandlerTest {\n+    private class RandomInputStream extends InputStream {\n+        private final int maxcount;\n+        private int count;\n+        private final int maxlines;\n+        private int lines;\n+\n+        private String letters;\n+\n+        public RandomInputStream(int count, int lines) {\n+            this.maxcount = count;\n+            this.count = 0;\n+            this.maxlines = lines;\n+            this.lines = 0;\n+\n+            letters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n+            letters = letters + letters.toLowerCase();\n+            letters = letters + \"0123456789\";\n+        }\n+\n+        public int getCount() {\n+            return count;\n+        }\n+\n+        @Override\n+        public int read() throws IOException {\n+            if (++count < maxcount) {\n+                // Want the newlines to appear within the first half.\n+                if (count % ((maxcount / 2) / maxlines) == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNDQyMA=="}, "originalCommit": {"oid": "f484af98af0ba0a2349ca04b8d3e694107b4cc54"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjM2OTA1OnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwMDo1NzozMFrOFzSe4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwMDo1NzozMFrOFzSe4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNDUxMw==", "bodyText": "This might always result in 0 using %.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r389324513", "createdAt": "2020-03-08T00:57:30Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class HeadHandlerTest {\n+    private class RandomInputStream extends InputStream {\n+        private final int maxcount;\n+        private int count;\n+        private final int maxlines;\n+        private int lines;\n+\n+        private String letters;\n+\n+        public RandomInputStream(int count, int lines) {\n+            this.maxcount = count;\n+            this.count = 0;\n+            this.maxlines = lines;\n+            this.lines = 0;\n+\n+            letters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n+            letters = letters + letters.toLowerCase();\n+            letters = letters + \"0123456789\";\n+        }\n+\n+        public int getCount() {\n+            return count;\n+        }\n+\n+        @Override\n+        public int read() throws IOException {\n+            if (++count < maxcount) {\n+                // Want the newlines to appear within the first half.\n+                if (count % ((maxcount / 2) / maxlines) == 0) {\n+                    return '\\n';\n+                } else {\n+                    return letters.charAt((int) (Math.random() % letters.length()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f484af98af0ba0a2349ca04b8d3e694107b4cc54"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjM3MTgxOnYy", "diffSide": "RIGHT", "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwMTowNTowMFrOFzSgJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOTo1NjoyMFrOFzgvtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNDgzNw==", "bodyText": "With this approach using randomness, I wonder if it would be informative to compare the line content to what was generated.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r389324837", "createdAt": "2020-03-08T01:05:00Z", "author": {"login": "idodeclare"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class HeadHandlerTest {\n+    private class RandomInputStream extends InputStream {\n+        private final int maxcount;\n+        private int count;\n+        private final int maxlines;\n+        private int lines;\n+\n+        private String letters;\n+\n+        public RandomInputStream(int count, int lines) {\n+            this.maxcount = count;\n+            this.count = 0;\n+            this.maxlines = lines;\n+            this.lines = 0;\n+\n+            letters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n+            letters = letters + letters.toLowerCase();\n+            letters = letters + \"0123456789\";\n+        }\n+\n+        public int getCount() {\n+            return count;\n+        }\n+\n+        @Override\n+        public int read() throws IOException {\n+            if (++count < maxcount) {\n+                // Want the newlines to appear within the first half.\n+                if (count % ((maxcount / 2) / maxlines) == 0) {\n+                    return '\\n';\n+                } else {\n+                    return letters.charAt((int) (Math.random() % letters.length()));\n+                }\n+            }\n+\n+            return -1;\n+        }\n+    }\n+\n+    @Test\n+    public void testHeadHandler() throws IOException {\n+        final int lines = 5;\n+        final int headLines = 3;\n+        int totalCount = 8192;\n+\n+        RandomInputStream rndStream = new RandomInputStream(totalCount, lines);\n+        HeadHandler handler = new HeadHandler(headLines);\n+        assertTrue(totalCount > handler.getBufferedReaderSize());\n+        handler.processStream(rndStream);\n+        assertEquals(headLines, handler.size());\n+        assertEquals(totalCount + 1, rndStream.getCount());\n+        int linesLen = 0;\n+        for (int i = 0; i < headLines; i++) {\n+            linesLen += handler.get(i).length();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f484af98af0ba0a2349ca04b8d3e694107b4cc54"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUzNjUyNw==", "bodyText": "For me it seems a little much work for a test; I'd prepare some files as resources (perhaps with this generator) and assert the content.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r389536527", "createdAt": "2020-03-09T09:14:18Z", "author": {"login": "tulinkry"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class HeadHandlerTest {\n+    private class RandomInputStream extends InputStream {\n+        private final int maxcount;\n+        private int count;\n+        private final int maxlines;\n+        private int lines;\n+\n+        private String letters;\n+\n+        public RandomInputStream(int count, int lines) {\n+            this.maxcount = count;\n+            this.count = 0;\n+            this.maxlines = lines;\n+            this.lines = 0;\n+\n+            letters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n+            letters = letters + letters.toLowerCase();\n+            letters = letters + \"0123456789\";\n+        }\n+\n+        public int getCount() {\n+            return count;\n+        }\n+\n+        @Override\n+        public int read() throws IOException {\n+            if (++count < maxcount) {\n+                // Want the newlines to appear within the first half.\n+                if (count % ((maxcount / 2) / maxlines) == 0) {\n+                    return '\\n';\n+                } else {\n+                    return letters.charAt((int) (Math.random() % letters.length()));\n+                }\n+            }\n+\n+            return -1;\n+        }\n+    }\n+\n+    @Test\n+    public void testHeadHandler() throws IOException {\n+        final int lines = 5;\n+        final int headLines = 3;\n+        int totalCount = 8192;\n+\n+        RandomInputStream rndStream = new RandomInputStream(totalCount, lines);\n+        HeadHandler handler = new HeadHandler(headLines);\n+        assertTrue(totalCount > handler.getBufferedReaderSize());\n+        handler.processStream(rndStream);\n+        assertEquals(headLines, handler.size());\n+        assertEquals(totalCount + 1, rndStream.getCount());\n+        int linesLen = 0;\n+        for (int i = 0; i < headLines; i++) {\n+            linesLen += handler.get(i).length();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNDgzNw=="}, "originalCommit": {"oid": "f484af98af0ba0a2349ca04b8d3e694107b4cc54"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU1ODE5Nw==", "bodyText": "I wanted the test to adapt automatically based on changes to HeadHandler - in particular the internal buffer size.", "url": "https://github.com/oracle/opengrok/pull/3056#discussion_r389558197", "createdAt": "2020-03-09T09:56:20Z", "author": {"login": "vladak"}, "path": "opengrok-indexer/src/test/java/org/opengrok/indexer/util/HeadHandlerTest.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates. All rights reserved.\n+ */\n+\n+package org.opengrok.indexer.util;\n+\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class HeadHandlerTest {\n+    private class RandomInputStream extends InputStream {\n+        private final int maxcount;\n+        private int count;\n+        private final int maxlines;\n+        private int lines;\n+\n+        private String letters;\n+\n+        public RandomInputStream(int count, int lines) {\n+            this.maxcount = count;\n+            this.count = 0;\n+            this.maxlines = lines;\n+            this.lines = 0;\n+\n+            letters = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n+            letters = letters + letters.toLowerCase();\n+            letters = letters + \"0123456789\";\n+        }\n+\n+        public int getCount() {\n+            return count;\n+        }\n+\n+        @Override\n+        public int read() throws IOException {\n+            if (++count < maxcount) {\n+                // Want the newlines to appear within the first half.\n+                if (count % ((maxcount / 2) / maxlines) == 0) {\n+                    return '\\n';\n+                } else {\n+                    return letters.charAt((int) (Math.random() % letters.length()));\n+                }\n+            }\n+\n+            return -1;\n+        }\n+    }\n+\n+    @Test\n+    public void testHeadHandler() throws IOException {\n+        final int lines = 5;\n+        final int headLines = 3;\n+        int totalCount = 8192;\n+\n+        RandomInputStream rndStream = new RandomInputStream(totalCount, lines);\n+        HeadHandler handler = new HeadHandler(headLines);\n+        assertTrue(totalCount > handler.getBufferedReaderSize());\n+        handler.processStream(rndStream);\n+        assertEquals(headLines, handler.size());\n+        assertEquals(totalCount + 1, rndStream.getCount());\n+        int linesLen = 0;\n+        for (int i = 0; i < headLines; i++) {\n+            linesLen += handler.get(i).length();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTMyNDgzNw=="}, "originalCommit": {"oid": "f484af98af0ba0a2349ca04b8d3e694107b4cc54"}, "originalPosition": 87}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 186, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}