{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MjU0OTM0", "number": 1415, "title": "DeferredValue changes for ServerValue.increment()", "bodyText": "Ports firebase/firebase-ios-sdk@aa67e19", "createdAt": "2020-04-01T22:04:26Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415", "merged": true, "mergeCommit": {"oid": "068ca6f52a80ceb616fdb808d3018f16ad73c10c"}, "closed": true, "closedAt": "2020-04-02T00:32:25Z", "author": {"login": "schmidt-sebastian"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTfF_xgH2gAyMzk3MjU0OTM0OmNiOTg2ZmU5YzUzNzhjZGJhN2JhMWIxYWRkNzI1NWMzMmExODBhMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTgsqFgH2gAyMzk3MjU0OTM0OjJhMzdjYjI3NzI4NzQyMGVjMjg0N2Y0MjhmZDE4YjNkYjFkNDBhYzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cb986fe9c5378cdba7ba1b1add7255c32a180a35", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/cb986fe9c5378cdba7ba1b1add7255c32a180a35", "committedDate": "2020-04-01T22:04:15Z", "message": "DeferredValue changes for ServerValue.increment()\n\nPorts https://github.com/firebase/firebase-ios-sdk/pull/5149/commits/aa67e19051a9b92d6fca709e709d3ac58beb00ed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6410ea53df6618dbf040de6cb3f5fba4096de187", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/6410ea53df6618dbf040de6cb3f5fba4096de187", "committedDate": "2020-04-01T22:14:55Z", "message": "Format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MDA1Mjkw", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#pullrequestreview-386005290", "createdAt": "2020-04-01T22:56:26Z", "commit": {"oid": "6410ea53df6618dbf040de6cb3f5fba4096de187"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjo1NjoyN1rOF_VivA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMzowNDowNFrOF_VtZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NzU2NA==", "bodyText": "nit: boolean values should typically be named. E.g. serverIncrementOverwritesExistingData(/*online*/ true);", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401957564", "createdAt": "2020-04-01T22:56:27Z", "author": {"login": "inlined"}, "path": "firebase-database/src/androidTest/java/com/google/firebase/database/DataTest.java", "diffHunk": "@@ -2747,7 +2747,18 @@ public void onComplete(DatabaseError error, boolean committed, DataSnapshot curr\n   }\n \n   @Test\n-  public void testServerIncrementOverwritesExistingData()\n+  public void testServerIncrementOverwritesExistingDataOnline()\n+      throws DatabaseException, TimeoutException, InterruptedException {\n+    serverIncrementOverwritesExistingData(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6410ea53df6618dbf040de6cb3f5fba4096de187"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1ODUxNQ==", "bodyText": "You could reduce the number of files that people need to read if you have\nValueProvider\nValueProvider::Deferred\nValueProvider::Existing\n\nIDR if that requires you to make an abstract class rather than an interface though.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401958515", "createdAt": "2020-04-01T22:58:57Z", "author": {"login": "inlined"}, "path": "firebase-database/src/main/java/com/google/firebase/database/core/DeferredValueProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.database.core;\n+\n+import com.google.firebase.database.snapshot.ChildKey;\n+import com.google.firebase.database.snapshot.Node;\n+import java.util.ArrayList;\n+\n+/** A DeferredValueProvider computes the value of a Node only when {@link #node()} is invoked. */\n+public class DeferredValueProvider implements ValueProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6410ea53df6618dbf040de6cb3f5fba4096de187"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1OTUxMQ==", "bodyText": "Oof... I hate files and classes called utilities", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401959511", "createdAt": "2020-04-01T23:01:42Z", "author": {"login": "inlined"}, "path": "firebase-database/src/main/java/com/google/firebase/database/core/ServerValues.java", "diffHunk": "@@ -99,32 +100,29 @@ static Object resolveComplexDeferredValue(\n     return increment.doubleValue() + existingVal.doubleValue();\n   }\n \n-  public static SparseSnapshotTree resolveDeferredValueTree(\n-      SparseSnapshotTree tree, Node existing, final Map<String, Object> serverValues) {\n-    final SparseSnapshotTree resolvedTree = new SparseSnapshotTree();\n-    tree.forEachTree(\n-        new Path(\"\"),\n-        new SparseSnapshotTree.SparseSnapshotTreeVisitor() {\n-          @Override\n-          public void visitTree(Path prefixPath, Node tree) {\n-            resolvedTree.remember(\n-                prefixPath,\n-                resolveDeferredValueSnapshot(tree, existing.getChild(prefixPath), serverValues));\n-          }\n-        });\n-    return resolvedTree;\n+  public static Node resolveDeferredValueSnapshot(\n+      Node data, Node existing, final Map<String, Object> serverValues) {\n+    return resolveDeferredValueSnapshot(data, new ExistingValueProvider(existing), serverValues);\n   }\n \n   public static Node resolveDeferredValueSnapshot(\n-      Node data, Node existing, final Map<String, Object> serverValues) {\n-    Object priorityVal =\n-        resolveDeferredValue(data.getPriority().getValue(), existing.getPriority(), serverValues);\n-    Node priority = PriorityUtilities.parsePriority(priorityVal);\n+      Node data, SyncTree syncTree, Path path, final Map<String, Object> serverValues) {\n+    return resolveDeferredValueSnapshot(\n+        data, new DeferredValueProvider(syncTree, path), serverValues);\n+  }\n \n+  private static Node resolveDeferredValueSnapshot(\n+      Node data, ValueProvider existing, final Map<String, Object> serverValues) {\n+    Object rawPriority = data.getPriority().getValue();\n+    Object priority =\n+        resolveDeferredLeafValue(\n+            rawPriority,\n+            existing.getImmediateChild(ChildKey.fromString(\".priority\")),\n+            serverValues);\n     if (data.isLeafNode()) {\n-      Object value = resolveDeferredValue(data.getValue(), existing, serverValues);\n-      if (!value.equals(data.getValue()) || !priority.equals(data.getPriority())) {\n-        return NodeUtilities.NodeFromJSON(value, priority);\n+      Object value = resolveDeferredLeafValue(data.getValue(), existing, serverValues);\n+      if (!value.equals(data.getValue()) || !Utilities.equals(priority, rawPriority)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6410ea53df6618dbf040de6cb3f5fba4096de187"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MDAzNQ==", "bodyText": "Interesting. In iOS this starts as merge and is modified with addWrite only where the resolved value changes. Is this a pessimisation?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401960035", "createdAt": "2020-04-01T23:03:24Z", "author": {"login": "inlined"}, "path": "firebase-database/src/main/java/com/google/firebase/database/core/ServerValues.java", "diffHunk": "@@ -145,22 +143,22 @@ public void visitChild(ChildKey name, Node child) {\n             }\n           });\n       if (!holder.getRootNode().getPriority().equals(priority)) {\n-        return holder.getRootNode().updatePriority(priority);\n+        return holder.getRootNode().updatePriority(PriorityUtilities.parsePriority(priority));\n       } else {\n         return holder.getRootNode();\n       }\n     }\n   }\n \n   public static CompoundWrite resolveDeferredValueMerge(\n-      CompoundWrite merge, Node existing, final Map<String, Object> serverValues) {\n+      CompoundWrite merge, SyncTree syncTree, Path path, final Map<String, Object> serverValues) {\n     CompoundWrite write = CompoundWrite.emptyWrite();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6410ea53df6618dbf040de6cb3f5fba4096de187"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MDI5NQ==", "bodyText": "I think you can delete \"existing\" above.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401960295", "createdAt": "2020-04-01T23:04:04Z", "author": {"login": "inlined"}, "path": "firebase-database/src/main/java/com/google/firebase/database/core/SyncTree.java", "diffHunk": "@@ -249,12 +249,12 @@ public boolean isEmpty() {\n                 if (write.isOverwrite()) {\n                   Node resolvedNode =\n                       ServerValues.resolveDeferredValueSnapshot(\n-                          write.getOverwrite(), existing, serverValues);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6410ea53df6618dbf040de6cb3f5fba4096de187"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a37cb277287420ec2847f428fd18b3db1d40ac5", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/2a37cb277287420ec2847f428fd18b3db1d40ac5", "committedDate": "2020-04-01T23:56:23Z", "message": "Review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2739, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}