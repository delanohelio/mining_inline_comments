{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjkwNDQw", "number": 1308, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzozOTo1OVrODkiscw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDo0ODoxMFrODk3qJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NjQzNzYzOnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzozOTo1OVrOFw6_qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDo1NjoyMFrOFxcC8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0MjUzOA==", "bodyText": "Is the space on purpose between String and []?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r386842538", "createdAt": "2020-03-03T07:39:59Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -44,9 +44,9 @@\n   private static final String STORE_KEY_PUB = \"|S||P|\";\n   private static final String STORE_KEY_ID = \"|S|id\";\n   private static final String STORE_KEY_TOKEN = \"|T|\";\n-  private static final String DEFAULT_SCOPE = \"|*\";\n   private static final String JSON_TOKEN_KEY = \"token\";\n   private static final String JSON_ENCODED_PREFIX = \"{\";\n+  private static final String [] ALLOWABLE_SCOPES = new String[]{\"*\", \"FCM\", \"GCM\"};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7c5e593a485bcd3128b7c863a9a1acbfd0f6109"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4NDA1MA==", "bodyText": "no, done", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r387384050", "createdAt": "2020-03-04T00:56:20Z", "author": {"login": "fredquintana"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -44,9 +44,9 @@\n   private static final String STORE_KEY_PUB = \"|S||P|\";\n   private static final String STORE_KEY_ID = \"|S|id\";\n   private static final String STORE_KEY_TOKEN = \"|T|\";\n-  private static final String DEFAULT_SCOPE = \"|*\";\n   private static final String JSON_TOKEN_KEY = \"token\";\n   private static final String JSON_ENCODED_PREFIX = \"{\";\n+  private static final String [] ALLOWABLE_SCOPES = new String[]{\"*\", \"FCM\", \"GCM\"};", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0MjUzOA=="}, "originalCommit": {"oid": "a7c5e593a485bcd3128b7c863a9a1acbfd0f6109"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NjQzODMyOnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzo0MDoxOVrOFw7ADQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDo1NjoxM1rOFxcC4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0MjYzNw==", "bodyText": "constant for the pipe character \"|\"", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r386842637", "createdAt": "2020-03-03T07:40:19Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -86,14 +86,23 @@ private static String getDefaultSenderId(FirebaseApp app) {\n     return projectNumber;\n   }\n \n-  private String createTokenKey(@NonNull String senderId) {\n-    return STORE_KEY_TOKEN + senderId + DEFAULT_SCOPE;\n+  private String createTokenKey(@NonNull String senderId, @NonNull String scope) {\n+    return STORE_KEY_TOKEN + senderId + \" | \" + scope;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7c5e593a485bcd3128b7c863a9a1acbfd0f6109"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4NDAzNQ==", "bodyText": "done", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r387384035", "createdAt": "2020-03-04T00:56:13Z", "author": {"login": "fredquintana"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -86,14 +86,23 @@ private static String getDefaultSenderId(FirebaseApp app) {\n     return projectNumber;\n   }\n \n-  private String createTokenKey(@NonNull String senderId) {\n-    return STORE_KEY_TOKEN + senderId + DEFAULT_SCOPE;\n+  private String createTokenKey(@NonNull String senderId, @NonNull String scope) {\n+    return STORE_KEY_TOKEN + senderId + \" | \" + scope;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0MjYzNw=="}, "originalCommit": {"oid": "a7c5e593a485bcd3128b7c863a9a1acbfd0f6109"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NjQzOTAzOnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzo0MDo0NFrOFw7Aig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDozNzoxOVrOFxbsBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0Mjc2Mg==", "bodyText": "I know you would have removed it, but still annoying you with a comment, haha", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r386842762", "createdAt": "2020-03-03T07:40:44Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -86,14 +86,23 @@ private static String getDefaultSenderId(FirebaseApp app) {\n     return projectNumber;\n   }\n \n-  private String createTokenKey(@NonNull String senderId) {\n-    return STORE_KEY_TOKEN + senderId + DEFAULT_SCOPE;\n+  private String createTokenKey(@NonNull String senderId, @NonNull String scope) {\n+    return STORE_KEY_TOKEN + senderId + \" | \" + scope;\n   }\n \n   @Nullable\n   public String readToken() {\n     synchronized (iidPrefs) {\n-      String token = iidPrefs.getString(createTokenKey(defaultSenderId), null);\n+      Log.d(\"Rayo\", \"readToken: defaultSenderId: \" + defaultSenderId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7c5e593a485bcd3128b7c863a9a1acbfd0f6109"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3ODE4Mw==", "bodyText": "done", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r387378183", "createdAt": "2020-03-04T00:37:19Z", "author": {"login": "fredquintana"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -86,14 +86,23 @@ private static String getDefaultSenderId(FirebaseApp app) {\n     return projectNumber;\n   }\n \n-  private String createTokenKey(@NonNull String senderId) {\n-    return STORE_KEY_TOKEN + senderId + DEFAULT_SCOPE;\n+  private String createTokenKey(@NonNull String senderId, @NonNull String scope) {\n+    return STORE_KEY_TOKEN + senderId + \" | \" + scope;\n   }\n \n   @Nullable\n   public String readToken() {\n     synchronized (iidPrefs) {\n-      String token = iidPrefs.getString(createTokenKey(defaultSenderId), null);\n+      Log.d(\"Rayo\", \"readToken: defaultSenderId: \" + defaultSenderId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0Mjc2Mg=="}, "originalCommit": {"oid": "a7c5e593a485bcd3128b7c863a9a1acbfd0f6109"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NjQ1MTAxOnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzo0NjowNFrOFw7H3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDozNjo1M1rOFxbrdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0NDYzNg==", "bodyText": "How about we replace break; by this line:\nreturn (token.startsWith(JSON_ENCODED_PREFIX)) ? parseIidTokenFromJson(token) : token;\n\nAnd below instead of\nif (TextUtils.isEmpty(token)) {\n  return null;\n}\n\nWe just do return null;", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r386844636", "createdAt": "2020-03-03T07:46:04Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -86,14 +86,23 @@ private static String getDefaultSenderId(FirebaseApp app) {\n     return projectNumber;\n   }\n \n-  private String createTokenKey(@NonNull String senderId) {\n-    return STORE_KEY_TOKEN + senderId + DEFAULT_SCOPE;\n+  private String createTokenKey(@NonNull String senderId, @NonNull String scope) {\n+    return STORE_KEY_TOKEN + senderId + \" | \" + scope;\n   }\n \n   @Nullable\n   public String readToken() {\n     synchronized (iidPrefs) {\n-      String token = iidPrefs.getString(createTokenKey(defaultSenderId), null);\n+      Log.d(\"Rayo\", \"readToken: defaultSenderId: \" + defaultSenderId);\n+      String token = null;\n+\n+      for (String scope : ALLOWABLE_SCOPES) {\n+        token = iidPrefs.getString(createTokenKey(defaultSenderId, scope), null);\n+        if (!TextUtils.isEmpty(token)) {\n+          break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7c5e593a485bcd3128b7c863a9a1acbfd0f6109"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3ODAzNw==", "bodyText": "done", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r387378037", "createdAt": "2020-03-04T00:36:53Z", "author": {"login": "fredquintana"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -86,14 +86,23 @@ private static String getDefaultSenderId(FirebaseApp app) {\n     return projectNumber;\n   }\n \n-  private String createTokenKey(@NonNull String senderId) {\n-    return STORE_KEY_TOKEN + senderId + DEFAULT_SCOPE;\n+  private String createTokenKey(@NonNull String senderId, @NonNull String scope) {\n+    return STORE_KEY_TOKEN + senderId + \" | \" + scope;\n   }\n \n   @Nullable\n   public String readToken() {\n     synchronized (iidPrefs) {\n-      String token = iidPrefs.getString(createTokenKey(defaultSenderId), null);\n+      Log.d(\"Rayo\", \"readToken: defaultSenderId: \" + defaultSenderId);\n+      String token = null;\n+\n+      for (String scope : ALLOWABLE_SCOPES) {\n+        token = iidPrefs.getString(createTokenKey(defaultSenderId, scope), null);\n+        if (!TextUtils.isEmpty(token)) {\n+          break;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0NDYzNg=="}, "originalCommit": {"oid": "a7c5e593a485bcd3128b7c863a9a1acbfd0f6109"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTg1NjYxOnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDo0MToyNFrOFxbxDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDo0MToyNFrOFxbxDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM3OTQ2OQ==", "bodyText": "Is the space on purpose between String and []?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r387379469", "createdAt": "2020-03-04T00:41:24Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -44,9 +45,9 @@\n   private static final String STORE_KEY_PUB = \"|S||P|\";\n   private static final String STORE_KEY_ID = \"|S|id\";\n   private static final String STORE_KEY_TOKEN = \"|T|\";\n-  private static final String DEFAULT_SCOPE = \"|*\";\n   private static final String JSON_TOKEN_KEY = \"token\";\n   private static final String JSON_ENCODED_PREFIX = \"{\";\n+  private static final String [] ALLOWABLE_SCOPES = new String[]{\"*\", \"FCM\", \"GCM\", \"\"};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9651358a395f28a65bd6325cc7f6120573e4cdf9"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5OTg3MjM2OnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDo0ODoxMFrOFxb50A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMDo0ODoxMFrOFxb50A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzM4MTcxMg==", "bodyText": "Maybe a constant for the pipe \"|\"?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1308#discussion_r387381712", "createdAt": "2020-03-04T00:48:10Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/local/IidStore.java", "diffHunk": "@@ -86,23 +93,22 @@ private static String getDefaultSenderId(FirebaseApp app) {\n     return projectNumber;\n   }\n \n-  private String createTokenKey(@NonNull String senderId) {\n-    return STORE_KEY_TOKEN + senderId + DEFAULT_SCOPE;\n+  private String createTokenKey(@NonNull String senderId, @NonNull String scope) {\n+    return STORE_KEY_TOKEN + senderId + \"|\" + scope;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9651358a395f28a65bd6325cc7f6120573e4cdf9"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 834, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}