{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5NDk4MjQw", "number": 2100, "title": "Add custom domain support to callable functions", "bodyText": "Discussion\nGooglers: see API review here\nTesting\n\nAdded new unit tests\n\nAPI Changes\n\nAPI reviewed\n\nThis change is in line with other similar changes for JS and iOS sdk:\nJS implemented\niOS implemented", "createdAt": "2020-10-24T21:37:01Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100", "merged": true, "mergeCommit": {"oid": "4f3ffc57bb80d28a622e84cfb348d6b4dba79537"}, "closed": true, "closedAt": "2020-11-11T13:32:33Z", "author": {"login": "kroikie"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVyA-nAH2gAyNTA5NDk4MjQwOmFmZWFiOTFkYWY3YjZlZWQzOGQ3ZWRmODVhNDE1ZjczMjI2YmQ3MmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbObo3gFqTUyNzUzMzYwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "afeab91daf7b6eed38d7edf85a415f73226bd72b", "author": {"user": {"login": "kroikie", "name": "Arthur Thompson"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/afeab91daf7b6eed38d7edf85a415f73226bd72b", "committedDate": "2020-10-24T21:25:58Z", "message": "Add custom domain support to callable functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5d9a9f9ca7e2e83e3bfbde6b4a7c20aa8d7a661", "author": {"user": {"login": "kroikie", "name": "Arthur Thompson"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/a5d9a9f9ca7e2e83e3bfbde6b4a7c20aa8d7a661", "committedDate": "2020-10-24T21:46:05Z", "message": "fix formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eda2e66b45947fb72bf62937f935e4cb3ae68a42", "author": {"user": {"login": "kroikie", "name": "Arthur Thompson"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/eda2e66b45947fb72bf62937f935e4cb3ae68a42", "committedDate": "2020-10-24T21:49:27Z", "message": "update api.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9", "author": {"user": {"login": "kroikie", "name": "Arthur Thompson"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/02f76a2e22a3339a622c80b190ed1ecca4f5cda9", "committedDate": "2020-10-24T22:05:13Z", "message": "Add test for domains with path"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NjQwODEz", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#pullrequestreview-516640813", "createdAt": "2020-10-26T10:25:56Z", "commit": {"oid": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMDoyNTo1NlrOHoJPYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMDoyODoxNVrOHoJUoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NjQ4MA==", "bodyText": "I think we can get rid of this new dependency (see comments below)", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r511856480", "createdAt": "2020-10-26T10:25:56Z", "author": {"login": "samtstern"}, "path": "firebase-functions/firebase-functions.gradle", "diffHunk": "@@ -63,6 +69,7 @@ dependencies {\n     implementation 'com.google.firebase:firebase-iid-interop:17.0.0'\n \n     implementation 'com.squareup.okhttp3:okhttp:3.12.1'\n+    implementation 'commons-validator:commons-validator:1.7'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Njk2NA==", "bodyText": "I think we can just use the standard library URL class and do new URL(regionOrCustomDomain) and then catch MalformedUrlException:\nhttps://docs.oracle.com/javase/7/docs/api/java/net/URL.html#URL(java.lang.String)\nNot quite as good as what you have but worth saving a whole dependency.", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r511856964", "createdAt": "2020-10-26T10:26:44Z", "author": {"login": "samtstern"}, "path": "firebase-functions/src/main/java/com/google/firebase/functions/FirebaseFunctions.java", "diffHunk": "@@ -73,26 +74,40 @@\n   private final String projectId;\n \n   // The region to use for all function references.\n-  private final String region;\n+  @Nullable private final String region;\n+\n+  // A custom domain for the http trigger, such as \"https://mydomain.com\"\n+  @Nullable private final String customDomain;\n \n   // The format to use for constructing urls from region, projectId, and name.\n   private String urlFormat = \"https://%1$s-%2$s.cloudfunctions.net/%3$s\";\n \n+  // Allowed custom domain protocols.\n+  private String[] customDomainSchemes = {\"http\", \"https\"};\n+\n   // Emulator settings\n   @Nullable private EmulatedServiceSettings emulatorSettings;\n \n   FirebaseFunctions(\n       FirebaseApp app,\n       Context context,\n       String projectId,\n-      String region,\n+      String regionOrCustomDomain,\n       ContextProvider contextProvider) {\n     this.app = app;\n     this.client = new OkHttpClient();\n     this.serializer = new Serializer();\n     this.contextProvider = Preconditions.checkNotNull(contextProvider);\n     this.projectId = Preconditions.checkNotNull(projectId);\n-    this.region = Preconditions.checkNotNull(region);\n+\n+    UrlValidator validator = new UrlValidator(customDomainSchemes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NzMyMQ==", "bodyText": "If you look at the iOS and JS PRs we set region to the default value here.  This is needed in case the person calls useEmulator", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r511857321", "createdAt": "2020-10-26T10:27:22Z", "author": {"login": "samtstern"}, "path": "firebase-functions/src/main/java/com/google/firebase/functions/FirebaseFunctions.java", "diffHunk": "@@ -73,26 +74,40 @@\n   private final String projectId;\n \n   // The region to use for all function references.\n-  private final String region;\n+  @Nullable private final String region;\n+\n+  // A custom domain for the http trigger, such as \"https://mydomain.com\"\n+  @Nullable private final String customDomain;\n \n   // The format to use for constructing urls from region, projectId, and name.\n   private String urlFormat = \"https://%1$s-%2$s.cloudfunctions.net/%3$s\";\n \n+  // Allowed custom domain protocols.\n+  private String[] customDomainSchemes = {\"http\", \"https\"};\n+\n   // Emulator settings\n   @Nullable private EmulatedServiceSettings emulatorSettings;\n \n   FirebaseFunctions(\n       FirebaseApp app,\n       Context context,\n       String projectId,\n-      String region,\n+      String regionOrCustomDomain,\n       ContextProvider contextProvider) {\n     this.app = app;\n     this.client = new OkHttpClient();\n     this.serializer = new Serializer();\n     this.contextProvider = Preconditions.checkNotNull(contextProvider);\n     this.projectId = Preconditions.checkNotNull(projectId);\n-    this.region = Preconditions.checkNotNull(region);\n+\n+    UrlValidator validator = new UrlValidator(customDomainSchemes);\n+    if (validator.isValid(regionOrCustomDomain)) {\n+      this.region = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NzgyNQ==", "bodyText": "See my comment below, but add a test about using useEmulator with a custom domain.  I think it would fail right now.", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r511857825", "createdAt": "2020-10-26T10:28:15Z", "author": {"login": "samtstern"}, "path": "firebase-functions/src/androidTest/java/com/google/firebase/functions/FirebaseFunctionsTest.java", "diffHunk": "@@ -38,6 +38,14 @@ public void testGetUrl() {\n     functions = FirebaseFunctions.getInstance(app);\n     url = functions.getURL(\"my-endpoint\");\n     assertEquals(\"https://us-central1-my-project.cloudfunctions.net/my-endpoint\", url.toString());\n+\n+    functions = FirebaseFunctions.getInstance(app, \"https://mydomain.com\");\n+    url = functions.getURL(\"my-endpoint\");\n+    assertEquals(\"https://mydomain.com/my-endpoint\", url.toString());\n+\n+    functions = FirebaseFunctions.getInstance(app, \"https://mydomain.com/foo\");\n+    url = functions.getURL(\"my-endpoint\");\n+    assertEquals(\"https://mydomain.com/foo/my-endpoint\", url.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc0e4389dbfb140600ee03e03b679453a0ea5ac3", "author": {"user": {"login": "kroikie", "name": "Arthur Thompson"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/bc0e4389dbfb140600ee03e03b679453a0ea5ac3", "committedDate": "2020-10-27T00:34:32Z", "message": "add useEmulator test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTY5MzU3", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#pullrequestreview-517569357", "createdAt": "2020-10-27T10:48:11Z", "commit": {"oid": "bc0e4389dbfb140600ee03e03b679453a0ea5ac3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDo0ODoxMVrOHo1yaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMDo0ODoxMVrOHo1yaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NjM0Nw==", "bodyText": "Nit: you could just move this logic inside of the try/catch and not need isRegion at all.  But totally fine either way.", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r512586347", "createdAt": "2020-10-27T10:48:11Z", "author": {"login": "samtstern"}, "path": "firebase-functions/src/main/java/com/google/firebase/functions/FirebaseFunctions.java", "diffHunk": "@@ -85,14 +88,29 @@\n       FirebaseApp app,\n       Context context,\n       String projectId,\n-      String region,\n+      String regionOrCustomDomain,\n       ContextProvider contextProvider) {\n     this.app = app;\n     this.client = new OkHttpClient();\n     this.serializer = new Serializer();\n     this.contextProvider = Preconditions.checkNotNull(contextProvider);\n     this.projectId = Preconditions.checkNotNull(projectId);\n-    this.region = Preconditions.checkNotNull(region);\n+\n+    boolean isRegion;\n+    try {\n+      new URL(regionOrCustomDomain);\n+      isRegion = false;\n+    } catch (MalformedURLException malformedURLException) {\n+      isRegion = true;\n+    }\n+\n+    if (isRegion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc0e4389dbfb140600ee03e03b679453a0ea5ac3"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTcwMDky", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#pullrequestreview-517570092", "createdAt": "2020-10-27T10:49:10Z", "commit": {"oid": "bc0e4389dbfb140600ee03e03b679453a0ea5ac3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTMzNjA3", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#pullrequestreview-527533607", "createdAt": "2020-11-10T19:22:03Z", "commit": {"oid": "bc0e4389dbfb140600ee03e03b679453a0ea5ac3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2411, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}