{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MjExNTQz", "number": 1182, "title": "Canonical ID Schema Migration", "bodyText": "", "createdAt": "2020-01-30T18:01:54Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1182", "merged": true, "mergeCommit": {"oid": "d644fd6c33f36c28a699ace2c99a1f194f7b297e"}, "closed": true, "closedAt": "2020-01-31T23:07:44Z", "author": {"login": "schmidt-sebastian"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_efKigH2gAyMzY5MjExNTQzOjA2MmE2YzFlY2NiNjNkMWQ3Nzk1OTlmNjljNjAyN2Y2YjMwZTdmNGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_3VnmgFqTM1MTgyNTMxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "062a6c1eccb63d1d779599f69c6027f6b30e7f4b", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/062a6c1eccb63d1d779599f69c6027f6b30e7f4b", "committedDate": "2020-01-30T18:03:21Z", "message": "Canonical ID Schema Migration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed6348de3692f0feef435fd1741324f5b487dfbe", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/ed6348de3692f0feef435fd1741324f5b487dfbe", "committedDate": "2020-01-30T18:01:10Z", "message": "Canonical ID Schema Migration"}, "afterCommit": {"oid": "062a6c1eccb63d1d779599f69c6027f6b30e7f4b", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/062a6c1eccb63d1d779599f69c6027f6b30e7f4b", "committedDate": "2020-01-30T18:03:21Z", "message": "Canonical ID Schema Migration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDY5ODg2", "url": "https://github.com/firebase/firebase-android-sdk/pull/1182#pullrequestreview-351069886", "createdAt": "2020-01-30T19:07:17Z", "commit": {"oid": "062a6c1eccb63d1d779599f69c6027f6b30e7f4b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxOTowNzoxN1rOFj2gnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxOToxNjoyMVrOFj2yJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEzNzU2NA==", "bodyText": "Dumb question: this file doesn't appear to employ a transaction anywhere. Doesn't db.execSQL auto-commit if you don't? It seems like it would be bad if this partially committed.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1182#discussion_r373137564", "createdAt": "2020-01-30T19:07:17Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/local/SQLiteSchema.java", "diffHunk": "@@ -530,6 +537,26 @@ private boolean tableContainsColumn(String table, String column) {\n     return columns;\n   }\n \n+  private void rewriteCanonicalIds() {\n+    new SQLitePersistence.Query(db, \"SELECT target_id, target_proto FROM targets\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "062a6c1eccb63d1d779599f69c6027f6b30e7f4b"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzE0MjA1NQ==", "bodyText": "This migration can't be rolled back and has the potential to cause problems because target_id must be guaranteed unique (it's the primary key of the table).\nIf a user does roll back, will this actually cause a problem with duplicate target ids? I think probably not because the next target id is in target_globals and we're not changing that here, right?\nOne alternative that makes this slightly more rollback friendly would be to put the new target id in a new column and create an additional index on that column. I can't say I'm super excited about this prospect and likely would prefer to just document that this release includes a migration that can't be rolled-back from.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1182#discussion_r373142055", "createdAt": "2020-01-30T19:16:21Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/local/SQLiteSchema.java", "diffHunk": "@@ -530,6 +537,26 @@ private boolean tableContainsColumn(String table, String column) {\n     return columns;\n   }\n \n+  private void rewriteCanonicalIds() {\n+    new SQLitePersistence.Query(db, \"SELECT target_id, target_proto FROM targets\")\n+        .forEach(\n+            cursor -> {\n+              int targetId = cursor.getInt(0);\n+              byte[] targetProtoBytes = cursor.getBlob(1);\n+\n+              try {\n+                Target targetProto = Target.parseFrom(targetProtoBytes);\n+                TargetData targetData = serializer.decodeTargetData(targetProto);\n+                String updatedCanonicalId = targetData.getTarget().getCanonicalId();\n+                db.execSQL(\n+                    \"UPDATE targets SET canonical_id  = ? WHERE target_id = ?\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "062a6c1eccb63d1d779599f69c6027f6b30e7f4b"}, "originalPosition": 51}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ff001b3d12e6a49d1e95aa6e5a59adb01ff33ef", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/3ff001b3d12e6a49d1e95aa6e5a59adb01ff33ef", "committedDate": "2020-01-30T21:42:07Z", "message": "Support downgrades"}, "afterCommit": {"oid": "3e64a82f6e50811ed0f0852bfce1de6d4bf4890a", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/3e64a82f6e50811ed0f0852bfce1de6d4bf4890a", "committedDate": "2020-01-30T21:47:13Z", "message": "Support downgrades"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e64a82f6e50811ed0f0852bfce1de6d4bf4890a", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/3e64a82f6e50811ed0f0852bfce1de6d4bf4890a", "committedDate": "2020-01-30T21:47:13Z", "message": "Support downgrades"}, "afterCommit": {"oid": "062a6c1eccb63d1d779599f69c6027f6b30e7f4b", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/062a6c1eccb63d1d779599f69c6027f6b30e7f4b", "committedDate": "2020-01-30T18:03:21Z", "message": "Canonical ID Schema Migration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODI1MzE1", "url": "https://github.com/firebase/firebase-android-sdk/pull/1182#pullrequestreview-351825315", "createdAt": "2020-01-31T23:00:33Z", "commit": {"oid": "062a6c1eccb63d1d779599f69c6027f6b30e7f4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2286, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}