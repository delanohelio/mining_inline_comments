{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2Mzg1NzAx", "number": 1550, "title": "Fix FIAM Display lifecycle interactions", "bodyText": "Fixes: #1410\nFixes: #1092", "createdAt": "2020-05-11T22:40:49Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550", "merged": true, "mergeCommit": {"oid": "0483b0de63c4c8ccacb167706fc2b0de8aa28a36"}, "closed": true, "closedAt": "2020-05-12T23:37:39Z", "author": {"login": "JasonAHeron"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgnzO7gFqTQxMDI3MDMwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgs_DQgFqTQxMDQ5NDM5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjcwMzA2", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#pullrequestreview-410270306", "createdAt": "2020-05-12T17:33:55Z", "commit": {"oid": "9cc749c622e5bb4320a41a7139e7f84f033987a6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzozMzo1NVrOGURivQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzozMzo1NVrOGURivQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMjEyNQ==", "bodyText": "Can we add some comments on why we need to bind when this condition is true?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423912125", "createdAt": "2020-05-12T17:33:55Z", "author": {"login": "prakhar1989"}, "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -236,11 +221,42 @@ public void onActivityDestroyed(Activity activity) {\n   @Override\n   public void onActivityResumed(Activity activity) {\n     super.onActivityResumed(activity);\n+    bindFiamToActivity(activity);\n+  }\n+\n+  private void bindFiamToActivity(Activity activity) {\n+    if (!currentActivityName.equals(activity.getLocalClassName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cc749c622e5bb4320a41a7139e7f84f033987a6"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjcxMzM0", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#pullrequestreview-410271334", "createdAt": "2020-05-12T17:35:09Z", "commit": {"oid": "9cc749c622e5bb4320a41a7139e7f84f033987a6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzozNTowOVrOGURl0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzozNTowOVrOGURl0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMjkxMg==", "bodyText": "Should we set this to null and add @Nullable annotation on this variable? I think an empty name can be error prone", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423912912", "createdAt": "2020-05-12T17:35:09Z", "author": {"login": "prakhar1989"}, "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -236,11 +221,42 @@ public void onActivityDestroyed(Activity activity) {\n   @Override\n   public void onActivityResumed(Activity activity) {\n     super.onActivityResumed(activity);\n+    bindFiamToActivity(activity);\n+  }\n+\n+  private void bindFiamToActivity(Activity activity) {\n+    if (!currentActivityName.equals(activity.getLocalClassName())) {\n+      Logging.logi(\"Binding to activity: \" + activity.getLocalClassName());\n+      headlessInAppMessaging.setMessageDisplayComponent(\n+          (iam, cb) -> {\n+            // When we are in the middle of showing a message, we ignore other notifications these\n+            // messages will be fired when the corresponding events happen the next time.\n+            if (inAppMessage != null || headlessInAppMessaging.areMessagesSuppressed()) {\n+              Logging.logd(\"Active FIAM exists. Skipping trigger\");\n+              return;\n+            }\n+            inAppMessage = iam;\n+            callbacks = cb;\n+            showActiveFiam(activity);\n+          });\n+      // set the current activity to be the one passed in\n+      currentActivityName = activity.getLocalClassName();\n+    }\n     if (inAppMessage != null) {\n       showActiveFiam(activity);\n     }\n   }\n \n+  private void unbindFiamFromActivity(Activity activity) {\n+    if (currentActivityName.equals(activity.getLocalClassName())) {\n+      Logging.logi(\"Unbinding from activity: \" + activity.getLocalClassName());\n+      headlessInAppMessaging.clearDisplayListener();\n+      imageLoader.cancelTag(activity.getClass());\n+      removeDisplayedFiam(activity);\n+      currentActivityName = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cc749c622e5bb4320a41a7139e7f84f033987a6"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjcxNTU2", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#pullrequestreview-410271556", "createdAt": "2020-05-12T17:35:26Z", "commit": {"oid": "9cc749c622e5bb4320a41a7139e7f84f033987a6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzozNToyNlrOGURmdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzozNToyNlrOGURmdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMzA3OQ==", "bodyText": "nice ;)", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423913079", "createdAt": "2020-05-12T17:35:26Z", "author": {"login": "prakhar1989"}, "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -318,8 +334,7 @@ public void onClick(View v) {\n \n     Map<Action, View.OnClickListener> actionListeners = new HashMap<>();\n     // If the message has an action, but not an action url, we dismiss when the action\n-    // button is\n-    // clicked;\n+    // button is clicked", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cc749c622e5bb4320a41a7139e7f84f033987a6"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74b576b4062042bb9cd1a2cb3c625e16604860df", "author": {"user": {"login": "JasonAHeron", "name": "Jason Heron"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/74b576b4062042bb9cd1a2cb3c625e16604860df", "committedDate": "2020-05-12T18:34:20Z", "message": "fix display racecondition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dca9456df85c46ecfa39b4aead67daac31e6852", "author": {"user": {"login": "JasonAHeron", "name": "Jason Heron"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/0dca9456df85c46ecfa39b4aead67daac31e6852", "committedDate": "2020-05-12T18:34:24Z", "message": "format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a833d0ed2c05f348537018a05d9a53e0b7e9c0e4", "author": {"user": {"login": "JasonAHeron", "name": "Jason Heron"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/a833d0ed2c05f348537018a05d9a53e0b7e9c0e4", "committedDate": "2020-05-12T18:34:24Z", "message": "<3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b01c6a4ef6539949df3a3f0c43988a8d067dd9c6", "author": {"user": {"login": "JasonAHeron", "name": "Jason Heron"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/b01c6a4ef6539949df3a3f0c43988a8d067dd9c6", "committedDate": "2020-05-12T18:34:24Z", "message": "add api.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83aeac55ce63be01ada30b829708a199c2677a2d", "author": {"user": {"login": "JasonAHeron", "name": "Jason Heron"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/83aeac55ce63be01ada30b829708a199c2677a2d", "committedDate": "2020-05-12T18:34:24Z", "message": "kk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8aaa5508c1108a273009cae0a22b92c4a8856c2", "author": {"user": {"login": "JasonAHeron", "name": "Jason Heron"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/b8aaa5508c1108a273009cae0a22b92c4a8856c2", "committedDate": "2020-05-12T18:35:27Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64206a372dacfbd32cc87ed87e71cde11ee35cc5", "author": {"user": {"login": "JasonAHeron", "name": "Jason Heron"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/64206a372dacfbd32cc87ed87e71cde11ee35cc5", "committedDate": "2020-05-12T17:54:19Z", "message": "Address comments"}, "afterCommit": {"oid": "b8aaa5508c1108a273009cae0a22b92c4a8856c2", "author": {"user": {"login": "JasonAHeron", "name": "Jason Heron"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/b8aaa5508c1108a273009cae0a22b92c4a8856c2", "committedDate": "2020-05-12T18:35:27Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzQ5Njc1", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#pullrequestreview-410349675", "createdAt": "2020-05-12T19:19:44Z", "commit": {"oid": "b8aaa5508c1108a273009cae0a22b92c4a8856c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxOToxOTo0NFrOGUVZBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxOToxOTo0NFrOGUVZBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NTE3Mw==", "bodyText": "why do we need to bind from activity onstart and onresume? can't we just limit it to one place onResume?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423975173", "createdAt": "2020-05-12T19:19:44Z", "author": {"login": "eldhosembabu"}, "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -182,19 +184,7 @@ public void clearFiamListener() {\n   @Override\n   public void onActivityStarted(final Activity activity) {\n     super.onActivityStarted(activity);\n-    // Register FIAM listener with the headless sdk.\n-    headlessInAppMessaging.setMessageDisplayComponent(\n-        (iam, cb) -> {\n-          // When we are in the middle of showing a message, we ignore other notifications these\n-          // messages will be fired when the corresponding events happen the next time.\n-          if (inAppMessage != null || headlessInAppMessaging.areMessagesSuppressed()) {\n-            Logging.logd(\"Active FIAM exists. Skipping trigger\");\n-            return;\n-          }\n-          inAppMessage = iam;\n-          callbacks = cb;\n-          showActiveFiam(activity);\n-        });\n+    bindFiamToActivity(activity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8aaa5508c1108a273009cae0a22b92c4a8856c2"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzUwNDgw", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#pullrequestreview-410350480", "createdAt": "2020-05-12T19:20:48Z", "commit": {"oid": "b8aaa5508c1108a273009cae0a22b92c4a8856c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxOToyMDo0OFrOGUVbsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxOToyMDo0OFrOGUVbsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk3NTg1OQ==", "bodyText": "Similar to bind call, can we limit the unbind to a single place rather than having in onPause and onDestroy?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#discussion_r423975859", "createdAt": "2020-05-12T19:20:48Z", "author": {"login": "eldhosembabu"}, "path": "firebase-inappmessaging-display/src/main/java/com/google/firebase/inappmessaging/display/FirebaseInAppMessagingDisplay.java", "diffHunk": "@@ -205,10 +195,7 @@ public void onActivityStarted(final Activity activity) {\n   @Keep\n   @Override\n   public void onActivityPaused(Activity activity) {\n-    // clear all state scoped to activity and dismiss fiam\n-    headlessInAppMessaging.clearDisplayListener();\n-    imageLoader.cancelTag(activity.getClass());\n-    removeDisplayedFiam(activity);\n+    unbindFiamFromActivity(activity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8aaa5508c1108a273009cae0a22b92c4a8856c2"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ecc6cf51ce7448cd3d69be01e3e37c37d1e69fd", "author": {"user": {"login": "JasonAHeron", "name": "Jason Heron"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/1ecc6cf51ce7448cd3d69be01e3e37c37d1e69fd", "committedDate": "2020-05-12T20:19:44Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDk0Mzkx", "url": "https://github.com/firebase/firebase-android-sdk/pull/1550#pullrequestreview-410494391", "createdAt": "2020-05-12T23:36:21Z", "commit": {"oid": "1ecc6cf51ce7448cd3d69be01e3e37c37d1e69fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2666, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}