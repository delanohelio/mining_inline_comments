{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MTUwMTU0", "number": 1802, "title": "Re-implement Unified Emulator Settings", "bodyText": "History:\n#1672 #1688 #1690 #1712 #1737\nThis follows Proposal 2 at:\nhttp://go/firebase-emulator-connection-api\nTODO:\n\n Regenerate api.txt\n Version bumps", "createdAt": "2020-07-22T14:20:09Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802", "merged": true, "mergeCommit": {"oid": "57ffa1fe39460bd9b97a05371f742243cf3df248"}, "closed": true, "closedAt": "2020-07-27T13:03:44Z", "author": {"login": "samtstern"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3bRujgH2gAyNDU1MTUwMTU0OjU0YmI1MjdhNTg0NWJjOGU1MTdhYWZjYjQ4ODU0NzgyOTZhMWUwNGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5AVgDgH2gAyNDU1MTUwMTU0OmUzNTFmYTg1MGQxZGI5NmQ1MGE3NTBlYTk2MTllYjM5ZTAwOGE2OWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54bb527a5845bc8e517aafcb4885478296a1e04d", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/54bb527a5845bc8e517aafcb4885478296a1e04d", "committedDate": "2020-07-22T13:58:43Z", "message": "Database works"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d815a61bd825c477091ab7a365b40b48e21a7df6", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/d815a61bd825c477091ab7a365b40b48e21a7df6", "committedDate": "2020-07-22T14:03:28Z", "message": "Functions works"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4654ca4f4a462c1c12bbd9cedf430c4e05b9bb15", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/4654ca4f4a462c1c12bbd9cedf430c4e05b9bb15", "committedDate": "2020-07-22T14:18:47Z", "message": "Firestore and Functions work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "130a1a6dde06d931ce3f5a68c6d4b8c79a66fcc3", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/130a1a6dde06d931ce3f5a68c6d4b8c79a66fcc3", "committedDate": "2020-07-22T14:21:36Z", "message": "Uncomment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24f4808594d6fc7e2ceeaacf958e7e7db49183fb", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/24f4808594d6fc7e2ceeaacf958e7e7db49183fb", "committedDate": "2020-07-22T15:12:29Z", "message": "Fix test NPE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNDg1ODYx", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#pullrequestreview-453485861", "createdAt": "2020-07-22T16:26:37Z", "commit": {"oid": "24f4808594d6fc7e2ceeaacf958e7e7db49183fb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjoyNjozN1rOG1qY8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjoyNjozN1rOG1qY8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMjIyNw==", "bodyText": "If it should now only be called by useEmulator() methods, why does FirebaseApp need to host this functionality as opposed to each sdk handling it individually?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r458922227", "createdAt": "2020-07-22T16:26:37Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/FirebaseApp.java", "diffHunk": "@@ -324,23 +321,14 @@ public static FirebaseApp initializeApp(\n   }\n \n   /**\n-   * Specify which services should access local emulators for this FirebaseApp instance.\n-   *\n-   * <p>For example, if the {@link EmulatorSettings} contain {@link\n-   * com.google.firebase.emulators.EmulatedServiceSettings} for {@link FirebaseDatabase#EMULATOR},\n-   * then calls to Cloud Firestore will communicate with the emulator rather than production.\n-   *\n-   * <p>TODO(samstern): Un-hide this once Firestore, Database, and Functions are implemented\n+   * This should <b>only</b> ever be called from inside FirebaseFoo.useEmulator().", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24f4808594d6fc7e2ceeaacf958e7e7db49183fb"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60e30d08c496d15d26c3c2a8c55efe9b268a9ee3", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/60e30d08c496d15d26c3c2a8c55efe9b268a9ee3", "committedDate": "2020-07-23T14:47:11Z", "message": "Make a component"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MjE5MzEy", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#pullrequestreview-454219312", "createdAt": "2020-07-23T14:54:59Z", "commit": {"oid": "60e30d08c496d15d26c3c2a8c55efe9b268a9ee3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNDo1NDo1OVrOG2OZIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNDo1NDo1OVrOG2OZIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUxMjA5Nw==", "bodyText": "There will be one instance of EmulatorSettings per FirebaseApp so you don't need to prefix the map keys, and as a result it looks like you can drop the FirebaseApp dependency.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459512097", "createdAt": "2020-07-23T14:54:59Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/emulators/EmulatorSettings.java", "diffHunk": "@@ -0,0 +1,55 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.emulators;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.components.Component;\n+import com.google.firebase.components.Dependency;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/** @hide */\n+public class EmulatorSettings {\n+\n+  @NonNull\n+  public static Component<EmulatorSettings> component() {\n+    return Component.builder(EmulatorSettings.class)\n+        .add(Dependency.required(FirebaseApp.class))\n+        .factory(c -> new EmulatorSettings(c.get(FirebaseApp.class)))\n+        .build();\n+  }\n+\n+  private final Map<String, EmulatedServiceSettings> settings = new HashMap<>();\n+  private final FirebaseApp app;\n+\n+  EmulatorSettings(@NonNull FirebaseApp app) {\n+    this.app = app;\n+  }\n+\n+  @Nullable\n+  public EmulatedServiceSettings get(@NonNull String name) {\n+    return settings.get(getKeyFor(name));\n+  }\n+\n+  public void set(@NonNull String name, @Nullable EmulatedServiceSettings serviceSettings) {\n+    settings.put(getKeyFor(name), serviceSettings);\n+  }\n+\n+  private String getKeyFor(@NonNull String name) {\n+    return this.app.getName() + '-' + name;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60e30d08c496d15d26c3c2a8c55efe9b268a9ee3"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/a54e6a6806ef20283cc14a8e6c97a4665dfff6bd", "committedDate": "2020-07-23T15:21:36Z", "message": "Remove common component"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0Mjk3OTky", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#pullrequestreview-454297992", "createdAt": "2020-07-23T16:22:14Z", "commit": {"oid": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjoyMjoxNFrOG2SE-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjoyMjoxNFrOG2SE-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MjQ3NQ==", "bodyText": "@vkryachko what's the proper way to do this?  Lint says I shouldn't do this outside of getInstance but I can't store a reference to the component in getInstance since the instance comes from the component ...", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459572475", "createdAt": "2020-07-23T16:22:14Z", "author": {"login": "samtstern"}, "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -202,7 +192,9 @@ public DatabaseReference getReferenceFromUrl(@NonNull String url) {\n           \"Can't pass null for argument 'url' in \" + \"FirebaseDatabase.getReferenceFromUrl()\");\n     }\n \n-    ParsedUrl parsedUrl = Utilities.parseUrl(url, getEmulatorServiceSettings(this.app));\n+    ParsedUrl parsedUrl =\n+        Utilities.parseUrl(\n+            url, getApp().get(FirebaseDatabaseComponent.class).getEmulatorSettings());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzE3NDYz", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#pullrequestreview-454317463", "createdAt": "2020-07-23T16:47:35Z", "commit": {"oid": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjo0NzozNVrOG2TAsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNjo0NzozNVrOG2TAsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4Nzc2MQ==", "bodyText": "Why do we need to round-trip through Firebase App? It seems like this could now stay within the SDK.\nI am also not sure if I understand the merits of proposal 2. We now have two places next to each other which both configure settings that can end up conflicting. Isn't the thing that is actually missing from our settings object just an \"isEmulator\" property? Or even - is this something the Emulator could just tell us?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459587761", "createdAt": "2020-07-23T16:47:35Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -302,9 +294,23 @@ public synchronized void setPersistenceCacheSizeBytes(long cacheSizeInBytes) {\n     this.config.setPersistenceCacheSizeBytes(cacheSizeInBytes);\n   }\n \n-  @Nullable\n-  private static EmulatedServiceSettings getEmulatorServiceSettings(@NonNull FirebaseApp app) {\n-    return app.getEmulatorSettings().getServiceSettings(EMULATOR);\n+  /**\n+   * Modify this FirebaseDatabase instance to communicate with the Realtime Database emulator.\n+   *\n+   * <p>Note: this must be called before this instance has been used to do any database operations.\n+   *\n+   * @param host the emulator host (ex: 10.0.2.2)\n+   * @param port the emulator port (ex: 9000)\n+   */\n+  public void useEmulator(@NonNull String host, int port) {\n+    if (this.repo != null) {\n+      throw new IllegalStateException(\n+          \"Cannot call useEmulator() after instance has already been initialized.\");\n+    }\n+\n+    getApp()\n+        .get(FirebaseDatabaseComponent.class)\n+        .setEmulatorSettings(new EmulatedServiceSettings(host, port));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MzcwNTk1", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#pullrequestreview-454370595", "createdAt": "2020-07-23T17:58:45Z", "commit": {"oid": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNzo1ODo0NVrOG2Vjfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNzo1ODo0NVrOG2Vjfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyOTQzOA==", "bodyText": "What is the expected behavior in the following scenario?\nval custom = Firebase.database(\"http://localhost:8000\")\nreadAndWriteTo(custom)\nval default = Firebase.database.useEmulator(\"example.com\", 123)\nafaict this will cause custom to keep talking to localhost, while default will talk to the emulator.\nDo we want to throw in this case?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459629438", "createdAt": "2020-07-23T17:58:45Z", "author": {"login": "vkryachko"}, "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -302,9 +294,23 @@ public synchronized void setPersistenceCacheSizeBytes(long cacheSizeInBytes) {\n     this.config.setPersistenceCacheSizeBytes(cacheSizeInBytes);\n   }\n \n-  @Nullable\n-  private static EmulatedServiceSettings getEmulatorServiceSettings(@NonNull FirebaseApp app) {\n-    return app.getEmulatorSettings().getServiceSettings(EMULATOR);\n+  /**\n+   * Modify this FirebaseDatabase instance to communicate with the Realtime Database emulator.\n+   *\n+   * <p>Note: this must be called before this instance has been used to do any database operations.\n+   *\n+   * @param host the emulator host (ex: 10.0.2.2)\n+   * @param port the emulator port (ex: 9000)\n+   */\n+  public void useEmulator(@NonNull String host, int port) {\n+    if (this.repo != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed5844bcbbb2c8edac80ac775d23955b87db138e", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/ed5844bcbbb2c8edac80ac775d23955b87db138e", "committedDate": "2020-07-23T18:10:54Z", "message": "Make components hold the settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0a7dd4447e5c702fb8df93714b2faafc13d5749", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/c0a7dd4447e5c702fb8df93714b2faafc13d5749", "committedDate": "2020-07-23T18:14:45Z", "message": "Compilation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "487b89a936e344983acc53a76a3ce9c566cc1343", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/487b89a936e344983acc53a76a3ce9c566cc1343", "committedDate": "2020-07-24T09:37:31Z", "message": "Fix compilation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca6fc84734a22a6cd818608eeaa7adff07111d3f", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/ca6fc84734a22a6cd818608eeaa7adff07111d3f", "committedDate": "2020-07-24T10:13:06Z", "message": "Merge remote-tracking branch 'origin/master' into ss-emulator-settings-redo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cebb525ea02f3805c2cfbdef7cc08071876c983c", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/cebb525ea02f3805c2cfbdef7cc08071876c983c", "committedDate": "2020-07-24T10:38:20Z", "message": "api.txt files, versions, changelogs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06498788114d587bee8353bab24ded2af2d647e7", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/06498788114d587bee8353bab24ded2af2d647e7", "committedDate": "2020-07-24T16:47:04Z", "message": "No components at all"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebd55c6ecbd7648042389ccc900645a89e7ce88a", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/ebd55c6ecbd7648042389ccc900645a89e7ce88a", "committedDate": "2020-07-24T16:48:49Z", "message": "Missed a spot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "562b2839d32202a469c6bae41b15e3977c8a1b0e", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/562b2839d32202a469c6bae41b15e3977c8a1b0e", "committedDate": "2020-07-24T17:03:12Z", "message": "internalHost and nullability"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MDM4NzE0", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#pullrequestreview-455038714", "createdAt": "2020-07-24T16:50:27Z", "commit": {"oid": "ebd55c6ecbd7648042389ccc900645a89e7ce88a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNjo1MDoyN1rOG22o6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNzowNzoxOVrOG23Kvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3MTQ5OQ==", "bodyText": "Can you mark this Nullable?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460171499", "createdAt": "2020-07-24T16:50:27Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -40,20 +37,12 @@\n  */\n public class FirebaseDatabase {\n \n-  /**\n-   * Emulator identifier. See {@link FirebaseApp#enableEmulators(EmulatorSettings)}\n-   *\n-   * <p>TODO(samstern): Un-hide this once Firestore, Database, and Functions are implemented\n-   *\n-   * @hide\n-   */\n-  public static final FirebaseEmulator EMULATOR = FirebaseEmulator.forName(\"database\");\n-\n   private static final String SDK_VERSION = BuildConfig.VERSION_NAME;\n \n   private final FirebaseApp app;\n   private final RepoInfo repoInfo;\n   private final DatabaseConfig config;\n+  private EmulatedServiceSettings emulatorSettings;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd55c6ecbd7648042389ccc900645a89e7ce88a"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTMzMQ==", "bodyText": "Stray semicolon", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460179331", "createdAt": "2020-07-24T17:05:37Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirebaseFirestore.java", "diffHunk": "@@ -217,6 +203,25 @@ public void setFirestoreSettings(@NonNull FirebaseFirestoreSettings settings) {\n     }\n   }\n \n+  /**\n+   * Modify this FirebaseDatabase instance to communicate with the Cloud Firestore emulator.\n+   *\n+   * <p>Note: this must be called before this instance has been used to do any operations.\n+   *\n+   * @param host the emulator host (ex: 10.0.2.2)\n+   * @param port the emulator port (ex: 8080)\n+   */\n+  public void useEmulator(@NonNull String host, int port) {\n+    if (this.client != null) {\n+      throw new IllegalStateException(\n+          \"Cannot call useEmulator() after instance has already been initialized.\");\n+    }\n+\n+    this.emulatorSettings = new EmulatedServiceSettings(host, port);\n+    ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd55c6ecbd7648042389ccc900645a89e7ce88a"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTUzMA==", "bodyText": "As discussed offline, internalHost needs to be updated as well.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460179530", "createdAt": "2020-07-24T17:06:03Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-database/src/main/java/com/google/firebase/database/core/RepoInfo.java", "diffHunk": "@@ -61,6 +63,15 @@ public URI getConnectionURL(String optLastSessionId) {\n     return URI.create(url);\n   }\n \n+  public void applyEmulatorSettings(@Nullable EmulatedServiceSettings settings) {\n+    if (settings == null) {\n+      return;\n+    }\n+\n+    this.host = settings.getHost() + \":\" + settings.getPort();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd55c6ecbd7648042389ccc900645a89e7ce88a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4MDE1OA==", "bodyText": "This is allowed in the RTDB proposal. No strong opinion here, but just wanted to point this out.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460180158", "createdAt": "2020-07-24T17:07:19Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirebaseFirestore.java", "diffHunk": "@@ -244,7 +249,7 @@ private FirebaseFirestoreSettings mergeEmulatorSettings(\n \n     if (!FirebaseFirestoreSettings.DEFAULT_HOST.equals(settings.getHost())) {\n       throw new IllegalStateException(\n-          \"Cannot specify the host in FirebaseFirestoreSettings when EmulatedServiceSettings is provided.\");\n+          \"Cannot specify the host in FirebaseFirestoreSettings when emulator settings are provided.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd55c6ecbd7648042389ccc900645a89e7ce88a"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "370962c058afa96097255794c3ae5c4d791c6342", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/370962c058afa96097255794c3ae5c4d791c6342", "committedDate": "2020-07-24T17:15:16Z", "message": "Sebastian feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MDYzNjI0", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#pullrequestreview-455063624", "createdAt": "2020-07-24T17:29:16Z", "commit": {"oid": "370962c058afa96097255794c3ae5c4d791c6342"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNzoyOToxNlrOG231mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNzozMDoyNVrOG233_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5MTEyOA==", "bodyText": "I think this call needs to happen after the if statement below. You probably want to support this:\nvar db = FirebaseDatabase.getInstance('http://foo');\ndb.useEmulator('localhost');\ndb.getReferenceFromUrl('http://foo/bar');\n\nPlease add test as well.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460191128", "createdAt": "2020-07-24T17:29:16Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -202,7 +193,9 @@ public DatabaseReference getReferenceFromUrl(@NonNull String url) {\n           \"Can't pass null for argument 'url' in \" + \"FirebaseDatabase.getReferenceFromUrl()\");\n     }\n \n-    ParsedUrl parsedUrl = Utilities.parseUrl(url, getEmulatorServiceSettings(this.app));\n+    ParsedUrl parsedUrl = Utilities.parseUrl(url);\n+    parsedUrl.repoInfo.applyEmulatorSettings(this.emulatorSettings);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "370962c058afa96097255794c3ae5c4d791c6342"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5MTc0Mg==", "bodyText": "s/FirebaseDatabase/FirebaseFunctions/", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460191742", "createdAt": "2020-07-24T17:30:25Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-functions/src/main/java/com/google/firebase/functions/FirebaseFunctions.java", "diffHunk": "@@ -213,17 +209,24 @@ URL getURL(String function) {\n     }\n   }\n \n-  /**\n-   * Changes this instance to point to a Cloud Functions emulator running locally. See\n-   * https://firebase.google.com/docs/functions/local-emulator\n-   *\n-   * @param origin The origin of the local emulator, such as \"http://10.0.2.2:5005\".\n-   */\n+  /** @deprecated see {@link #useEmulator(String, int)} */\n   public void useFunctionsEmulator(@NonNull String origin) {\n     Preconditions.checkNotNull(origin, \"origin cannot be null\");\n     urlFormat = origin + \"/%2$s/%1$s/%3$s\";\n   }\n \n+  /**\n+   * Modify this FirebaseDatabase instance to communicate with the Cloud Functions emulator.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "370962c058afa96097255794c3ae5c4d791c6342"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b1b9ec76742887de70f4f13dfa25e7b5dd8933a", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/4b1b9ec76742887de70f4f13dfa25e7b5dd8933a", "committedDate": "2020-07-24T17:39:29Z", "message": "Typo, remove throw"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cbb7b9b8670501249d328882735d73aa80f3ea5", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/2cbb7b9b8670501249d328882735d73aa80f3ea5", "committedDate": "2020-07-24T17:46:18Z", "message": "Fix functions test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "911fea0f32e6c4867a1ee1891e98b3312ff7069f", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/911fea0f32e6c4867a1ee1891e98b3312ff7069f", "committedDate": "2020-07-24T17:52:59Z", "message": "One more test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fae4496baa0523de01073b627d0cdb2844fcf29", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/9fae4496baa0523de01073b627d0cdb2844fcf29", "committedDate": "2020-07-27T10:49:39Z", "message": "Remove failing test, not relevant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e351fa850d1db96d50a750ea9619eb39e008a69f", "author": {"user": {"login": "samtstern", "name": "Sam Stern"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/e351fa850d1db96d50a750ea9619eb39e008a69f", "committedDate": "2020-07-27T11:43:15Z", "message": "Compilation error"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2589, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}