{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNjMwMDYx", "number": 1206, "title": "Drop Array, Reference, Number, Integer and DoubleValue", "bodyText": "", "createdAt": "2020-02-05T23:08:00Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206", "merged": true, "mergeCommit": {"oid": "32e1e92da2700b3d9958ed86efb4174580ace5f3"}, "closed": true, "closedAt": "2020-02-06T19:03:11Z", "author": {"login": "schmidt-sebastian"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcA5eb_gH2gAyMzcxNjMwMDYxOjE2MDIwNjJjMjc2M2FiYWYyYTc3YTRmZDIwNjdhZTI2ZTZjOTY5NjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBvbUXgFqTM1NDY5MTM4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1602062c2763abaf2a77a4fd2067ae26e6c96965", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/1602062c2763abaf2a77a4fd2067ae26e6c96965", "committedDate": "2020-02-04T04:03:55Z", "message": "Protobuf-backed FieldValues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "804a1b7a9d0304f13a394b2f46054f2409c52b37", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/804a1b7a9d0304f13a394b2f46054f2409c52b37", "committedDate": "2020-02-04T21:39:54Z", "message": "Merge branch 'mrschmidt/rewritefieldvalue' into mrschmidt/final"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d5d7c2570b34f0797602f6dd46e407232b3bf8b", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/3d5d7c2570b34f0797602f6dd46e407232b3bf8b", "committedDate": "2020-02-04T23:44:07Z", "message": "Merge branch 'mrschmidt/rewritefieldvalue' into mrschmidt/final"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "120ca33e5a7299151357ae0e70c8b23acfe6b9b9", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/120ca33e5a7299151357ae0e70c8b23acfe6b9b9", "committedDate": "2020-02-05T19:01:41Z", "message": "Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82c0095659aa83194049693f1336af2864ce5287", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/82c0095659aa83194049693f1336af2864ce5287", "committedDate": "2020-02-05T19:03:43Z", "message": "Update test-only variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98953a323513bbc0ef685ab9ca1ee9b9d98ee091", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/98953a323513bbc0ef685ab9ca1ee9b9d98ee091", "committedDate": "2020-02-05T19:34:33Z", "message": "Add ProtoValues.contains()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "940a268825130e3c4c7609d8975d7c428f071f32", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/940a268825130e3c4c7609d8975d7c428f071f32", "committedDate": "2020-02-05T19:42:37Z", "message": "Migrate ArrayTransforms to use Values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ea5b3737b23638bb99bcb032893674414c18895", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/7ea5b3737b23638bb99bcb032893674414c18895", "committedDate": "2020-02-05T20:21:48Z", "message": "Migrate TransformResult to use Value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "637838b4497561644308d0eee7c3cedaee1a182d", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/637838b4497561644308d0eee7c3cedaee1a182d", "committedDate": "2020-02-05T23:15:14Z", "message": "Drop Array, Reference, Number, Integer and DoubleValue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e0ec91a9eeceb54444983b553b16d2b1cce36d3", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/8e0ec91a9eeceb54444983b553b16d2b1cce36d3", "committedDate": "2020-02-05T23:04:40Z", "message": "Drop Array, Reference, Number, Integer and DoubleValue"}, "afterCommit": {"oid": "637838b4497561644308d0eee7c3cedaee1a182d", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/637838b4497561644308d0eee7c3cedaee1a182d", "committedDate": "2020-02-05T23:15:14Z", "message": "Drop Array, Reference, Number, Integer and DoubleValue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5cc99840698f8fb2e799495fdd478ea1013bd04", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/b5cc99840698f8fb2e799495fdd478ea1013bd04", "committedDate": "2020-02-06T00:10:43Z", "message": "Fix Kotlin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "162f0715043961e3fd1057a583230095276fb487", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/162f0715043961e3fd1057a583230095276fb487", "committedDate": "2020-02-06T00:27:20Z", "message": "More Kotlin fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13e01c89451b123d4bfee2e51e6adef782f1b102", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/13e01c89451b123d4bfee2e51e6adef782f1b102", "committedDate": "2020-02-06T00:56:21Z", "message": "Review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baf650e876d47b345418466f40e36f3b97912801", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/baf650e876d47b345418466f40e36f3b97912801", "committedDate": "2020-02-06T01:54:45Z", "message": "Merge branch 'mrschmidt/rewritefieldvalue' into mrschmidt/final"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa7b3ec782537107693ce98d405190397e8c610f", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/aa7b3ec782537107693ce98d405190397e8c610f", "committedDate": "2020-02-06T01:54:57Z", "message": "Merge branch 'mrschmidt/final' into mrschmidt/migratevalues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTU5Mzcy", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206#pullrequestreview-354159372", "createdAt": "2020-02-06T01:54:25Z", "commit": {"oid": "162f0715043961e3fd1057a583230095276fb487"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwMTo1NDoyNlrOFmNH-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwMjoyODo0OVrOFmNkZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwNTI0MQ==", "bodyText": "If a caller other than wrapObject calls wrap on a Map<String, Object> this will return the wrong type.\nIt seems like this should parse the query value then check the type and wrap appropriately (or call FieldValue.valueOf). That would also mean that wrapObject wouldn't have change below.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206#discussion_r375605241", "createdAt": "2020-02-06T01:54:26Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/ktx/src/test/java/com/google/firebase/firestore/testutil/TestUtil.java", "diffHunk": "@@ -36,12 +36,12 @@ public static FieldValue wrap(Object value) {\n     UserDataReader dataReader = new UserDataReader(databaseId);\n     // HACK: We use parseQueryValue() since it accepts scalars as well as arrays / objects, and\n     // our tests currently use wrap() pretty generically so we don't know the intent.\n-    return dataReader.parseQueryValue(value);\n+    return new FieldValue(dataReader.parseQueryValue(value));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "162f0715043961e3fd1057a583230095276fb487"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwNjkwNQ==", "bodyText": "Nearly all callers check the array type before calling this. It seems like it would be worth adding an alternative like this:\npublic static boolean arrayContains(Value haystack, Value needle) {\n  return isArray(haystack) && contains(haystack.getArrayValue(), needle);\n}", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206#discussion_r375606905", "createdAt": "2020-02-06T02:01:48Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/model/value/ProtoValues.java", "diffHunk": "@@ -157,8 +164,8 @@ private static boolean objectEquals(Value left, Value right) {\n   }\n \n   /** Returns true if the Value list contains the specified element. */\n-  public static boolean contains(List<Value> haystack, Value needle) {\n-    for (Value haystackEl : haystack) {\n+  public static boolean contains(ArrayValueOrBuilder haystack, Value needle) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "162f0715043961e3fd1057a583230095276fb487"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwNzY3Mg==", "bodyText": "While we're fixing the format here, should we separate these values with something?\n(Optional; may not be worth it. Just a thought because it may make these more readable.)", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206#discussion_r375607672", "createdAt": "2020-02-06T02:05:24Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/core/Bound.java", "diffHunk": "@@ -64,8 +65,8 @@ public String canonicalString() {\n     } else {\n       builder.append(\"a:\");\n     }\n-    for (FieldValue indexComponent : position) {\n-      builder.append(indexComponent.toString());\n+    for (Value indexComponent : position) {\n+      builder.append(ProtoValues.canonicalId(indexComponent));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "162f0715043961e3fd1057a583230095276fb487"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwODA1Nw==", "bodyText": "doc.getFieldProto(getField())?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206#discussion_r375608057", "createdAt": "2020-02-06T02:07:21Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/core/InFilter.java", "diffHunk": "@@ -14,23 +14,24 @@\n \n package com.google.firebase.firestore.core;\n \n+import static com.google.firebase.firestore.util.Assert.hardAssert;\n+\n import com.google.firebase.firestore.model.Document;\n import com.google.firebase.firestore.model.FieldPath;\n-import com.google.firebase.firestore.model.value.ArrayValue;\n import com.google.firebase.firestore.model.value.FieldValue;\n import com.google.firebase.firestore.model.value.ProtoValues;\n+import com.google.firestore.v1.Value;\n \n /** A Filter that implements the IN operator. */\n public class InFilter extends FieldFilter {\n-  InFilter(FieldPath field, ArrayValue value) {\n+  InFilter(FieldPath field, Value value) {\n     super(field, Operator.IN, value);\n+    hardAssert(ProtoValues.isArray(value), \"InFilter expects an ArrayValue\");\n   }\n \n   @Override\n   public boolean matches(Document doc) {\n     FieldValue other = doc.getField(getField());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "162f0715043961e3fd1057a583230095276fb487"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYwODM5OQ==", "bodyText": "This seems like something we could store as a field. It doesn't change for every document we match.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206#discussion_r375608399", "createdAt": "2020-02-06T02:08:53Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/core/KeyFieldFilter.java", "diffHunk": "@@ -14,20 +14,25 @@\n \n package com.google.firebase.firestore.core;\n \n+import static com.google.firebase.firestore.util.Assert.hardAssert;\n+\n import com.google.firebase.firestore.model.Document;\n+import com.google.firebase.firestore.model.DocumentKey;\n import com.google.firebase.firestore.model.FieldPath;\n-import com.google.firebase.firestore.model.value.ReferenceValue;\n+import com.google.firebase.firestore.model.value.ProtoValues;\n+import com.google.firestore.v1.Value;\n \n /** Filter that matches on key fields (i.e. '__name__'). */\n public class KeyFieldFilter extends FieldFilter {\n-  KeyFieldFilter(FieldPath field, Operator operator, ReferenceValue value) {\n+  KeyFieldFilter(FieldPath field, Operator operator, Value value) {\n     super(field, operator, value);\n+    hardAssert(ProtoValues.isReferenceValue(value), \"KeyFieldFilter expects a ReferenceValue\");\n   }\n \n   @Override\n   public boolean matches(Document doc) {\n-    ReferenceValue referenceValue = (ReferenceValue) getValue();\n-    int comparator = doc.getKey().compareTo(referenceValue.getKey());\n+    DocumentKey referencedKey = DocumentKey.fromName(getValue().getReferenceValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "162f0715043961e3fd1057a583230095276fb487"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxMTUzMg==", "bodyText": "Similarly we could do this conversion once in the constructor and keep a list of document keys as a field.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206#discussion_r375611532", "createdAt": "2020-02-06T02:24:26Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/core/KeyFieldInFilter.java", "diffHunk": "@@ -17,26 +17,27 @@\n import static com.google.firebase.firestore.util.Assert.hardAssert;\n \n import com.google.firebase.firestore.model.Document;\n+import com.google.firebase.firestore.model.DocumentKey;\n import com.google.firebase.firestore.model.FieldPath;\n-import com.google.firebase.firestore.model.value.ArrayValue;\n-import com.google.firebase.firestore.model.value.FieldValue;\n-import com.google.firebase.firestore.model.value.ReferenceValue;\n+import com.google.firebase.firestore.model.value.ProtoValues;\n+import com.google.firestore.v1.Value;\n \n public class KeyFieldInFilter extends FieldFilter {\n-  KeyFieldInFilter(FieldPath field, ArrayValue value) {\n+  KeyFieldInFilter(FieldPath field, Value value) {\n     super(field, Operator.IN, value);\n-    for (FieldValue refValue : value.getValues()) {\n+    hardAssert(ProtoValues.isArray(value), \"KeyFieldInFilter expects an ArrayValue\");\n+    for (Value element : value.getArrayValue().getValuesList()) {\n       hardAssert(\n-          refValue instanceof ReferenceValue,\n+          ProtoValues.isReferenceValue(element),\n           \"Comparing on key with IN, but an array value was not a ReferenceValue\");\n     }\n   }\n \n   @Override\n   public boolean matches(Document doc) {\n-    ArrayValue arrayValue = (ArrayValue) getValue();\n-    for (FieldValue refValue : arrayValue.getValues()) {\n-      if (doc.getKey().equals(((ReferenceValue) refValue).getKey())) {\n+    for (Value refValue : getValue().getArrayValue().getValuesList()) {\n+      DocumentKey referencedKey = DocumentKey.fromName(refValue.getReferenceValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "162f0715043961e3fd1057a583230095276fb487"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYxMjUxNw==", "bodyText": "Nit: Java doesn't tend to abbreviate like this. Consider naming this just element, or haystackElement if you want to preserve the binding to the haystack.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206#discussion_r375612517", "createdAt": "2020-02-06T02:28:49Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/model/value/ProtoValues.java", "diffHunk": "@@ -157,8 +164,8 @@ private static boolean objectEquals(Value left, Value right) {\n   }\n \n   /** Returns true if the Value list contains the specified element. */\n-  public static boolean contains(List<Value> haystack, Value needle) {\n-    for (Value haystackEl : haystack) {\n+  public static boolean contains(ArrayValueOrBuilder haystack, Value needle) {\n+    for (Value haystackEl : haystack.getValuesList()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "162f0715043961e3fd1057a583230095276fb487"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "774598a7f912b8558e50109d7822b9bf421f717c", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/774598a7f912b8558e50109d7822b9bf421f717c", "committedDate": "2020-02-06T05:07:07Z", "message": "Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "490c924d4d77d91fa861f5cf7d6b7629808949a3", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/490c924d4d77d91fa861f5cf7d6b7629808949a3", "committedDate": "2020-02-06T05:11:08Z", "message": "Make FieldValue package-private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0abdfb1698347c81beed67ba720b9003d7766dd4", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/0abdfb1698347c81beed67ba720b9003d7766dd4", "committedDate": "2020-02-06T05:11:24Z", "message": "Merge branch 'mrschmidt/migratevalues' into mrschmidt/droparray"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ef7289eeae1ab4b2e421294929e675556fe1d68", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/6ef7289eeae1ab4b2e421294929e675556fe1d68", "committedDate": "2020-02-06T05:17:36Z", "message": "Merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjkxMzgz", "url": "https://github.com/firebase/firebase-android-sdk/pull/1206#pullrequestreview-354691383", "createdAt": "2020-02-06T18:55:23Z", "commit": {"oid": "6ef7289eeae1ab4b2e421294929e675556fe1d68"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2302, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}