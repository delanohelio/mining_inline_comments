{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2ODEwMTUx", "number": 1488, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo1Mjo1NVrOD0dDzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo1OTowMlrOD0eYqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzI4NjUyOnYy", "diffSide": "LEFT", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/ApiClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo1Mjo1NVrOGJaD-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoxNzo1NVrOGJa1GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUxNzM2OQ==", "bodyText": "Is there anything happening here other than moving things inline?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412517369", "createdAt": "2020-04-21T21:52:55Z", "author": {"login": "ashwinraghav"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/ApiClient.java", "diffHunk": "@@ -143,17 +111,11 @@ private ClientSignals getClientSignals() {\n   }\n \n   private ClientAppInfo getClientAppInfo(InstanceIdResult instanceIdResult) {\n-    ClientAppInfo.Builder builder =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd85fa4b0a7f63b093de8dcf770d3c18ecf0d0fc"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyOTk0NQ==", "bodyText": "no just removing the checks because now we do them outside of this class", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412529945", "createdAt": "2020-04-21T22:17:55Z", "author": {"login": "JasonAHeron"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/ApiClient.java", "diffHunk": "@@ -143,17 +111,11 @@ private ClientSignals getClientSignals() {\n   }\n \n   private ClientAppInfo getClientAppInfo(InstanceIdResult instanceIdResult) {\n-    ClientAppInfo.Builder builder =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUxNzM2OQ=="}, "originalCommit": {"oid": "bd85fa4b0a7f63b093de8dcf770d3c18ecf0d0fc"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzI4Nzg5OnYy", "diffSide": "RIGHT", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/GrpcClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo1MzoxMFrOGJaErg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo1MzoxMFrOGJaErg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUxNzU1MA==", "bodyText": "LGTM", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412517550", "createdAt": "2020-04-21T21:53:10Z", "author": {"login": "ashwinraghav"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/GrpcClient.java", "diffHunk": "@@ -35,6 +36,6 @@\n   }\n \n   public FetchEligibleCampaignsResponse fetchEligibleCampaigns(FetchEligibleCampaignsRequest req) {\n-    return stub.fetchEligibleCampaigns(req);\n+    return stub.withDeadlineAfter(30000, TimeUnit.MILLISECONDS).fetchEligibleCampaigns(req);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd85fa4b0a7f63b093de8dcf770d3c18ecf0d0fc"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzMyMTI3OnYy", "diffSide": "RIGHT", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjowMjoyNlrOGJaXoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoxODowNlrOGJa1jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyMjQwMA==", "bodyText": "consider using filter\nMaybe.fromCallable(getIID::blockingGet)\n.filter(validIID())\n.map(apiClient.getFiams(iid, campaignImpressionList))\n.switchIfEmpty(cacheExpiringResponse())", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412522400", "createdAt": "2020-04-21T22:02:26Z", "author": {"login": "ashwinraghav"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -232,22 +243,37 @@ private boolean shouldIgnoreCache(String event) {\n                       .defaultIfEmpty(CampaignImpressionList.getDefaultInstance())\n                       .onErrorResumeNext(Maybe.just(CampaignImpressionList.getDefaultInstance()));\n \n+              Maybe<InstanceIdResult> getIID = taskToMaybe(firebaseInstanceId.getInstanceId());\n+\n               Function<CampaignImpressionList, Maybe<FetchEligibleCampaignsResponse>> serviceFetch =\n-                  impressions ->\n-                      taskToMaybe(apiClient.getFiams(impressions))\n-                          .doOnSuccess(\n-                              resp ->\n-                                  Logging.logi(\n-                                      String.format(\n-                                          Locale.US,\n-                                          \"Successfully fetched %d messages from backend\",\n-                                          resp.getMessagesList().size())))\n-                          .doOnSuccess(\n-                              resp -> impressionStorageClient.clearImpressions(resp).subscribe())\n-                          .doOnSuccess(analyticsEventsManager::updateContextualTriggers)\n-                          .doOnSuccess(testDeviceHelper::processCampaignFetch)\n-                          .doOnError(e -> Logging.logw(\"Service fetch error: \" + e.getMessage()))\n-                          .onErrorResumeNext(Maybe.empty()); // Absorb service failures\n+                  campaignImpressionList -> {\n+                    if (!dataCollectionHelper.isAutomaticDataCollectionEnabled()) {\n+                      Logging.logi(\n+                          \"Automatic data collection is disabled, not attempting campaign fetch from service.\");\n+                      return Maybe.just(cacheExpiringResponse());\n+                    }\n+\n+                    // blocking get occurs on the IO thread because that's what we observeOn above\n+                    return Maybe.fromCallable(getIID::blockingGet)\n+                        .map(\n+                            iid ->\n+                                validIID(iid)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd85fa4b0a7f63b093de8dcf770d3c18ecf0d0fc"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUzMDA2MQ==", "bodyText": "done", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412530061", "createdAt": "2020-04-21T22:18:06Z", "author": {"login": "JasonAHeron"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -232,22 +243,37 @@ private boolean shouldIgnoreCache(String event) {\n                       .defaultIfEmpty(CampaignImpressionList.getDefaultInstance())\n                       .onErrorResumeNext(Maybe.just(CampaignImpressionList.getDefaultInstance()));\n \n+              Maybe<InstanceIdResult> getIID = taskToMaybe(firebaseInstanceId.getInstanceId());\n+\n               Function<CampaignImpressionList, Maybe<FetchEligibleCampaignsResponse>> serviceFetch =\n-                  impressions ->\n-                      taskToMaybe(apiClient.getFiams(impressions))\n-                          .doOnSuccess(\n-                              resp ->\n-                                  Logging.logi(\n-                                      String.format(\n-                                          Locale.US,\n-                                          \"Successfully fetched %d messages from backend\",\n-                                          resp.getMessagesList().size())))\n-                          .doOnSuccess(\n-                              resp -> impressionStorageClient.clearImpressions(resp).subscribe())\n-                          .doOnSuccess(analyticsEventsManager::updateContextualTriggers)\n-                          .doOnSuccess(testDeviceHelper::processCampaignFetch)\n-                          .doOnError(e -> Logging.logw(\"Service fetch error: \" + e.getMessage()))\n-                          .onErrorResumeNext(Maybe.empty()); // Absorb service failures\n+                  campaignImpressionList -> {\n+                    if (!dataCollectionHelper.isAutomaticDataCollectionEnabled()) {\n+                      Logging.logi(\n+                          \"Automatic data collection is disabled, not attempting campaign fetch from service.\");\n+                      return Maybe.just(cacheExpiringResponse());\n+                    }\n+\n+                    // blocking get occurs on the IO thread because that's what we observeOn above\n+                    return Maybe.fromCallable(getIID::blockingGet)\n+                        .map(\n+                            iid ->\n+                                validIID(iid)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyMjQwMA=="}, "originalCommit": {"oid": "bd85fa4b0a7f63b093de8dcf770d3c18ecf0d0fc"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzM2MTI2OnYy", "diffSide": "RIGHT", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoxMzo1OFrOGJatxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoyMDoyOFrOGJa5_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyODA2OQ==", "bodyText": "You should be able to just return getIID here, which is already a Maybe", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412528069", "createdAt": "2020-04-21T22:13:58Z", "author": {"login": "ashwinraghav"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -232,22 +243,37 @@ private boolean shouldIgnoreCache(String event) {\n                       .defaultIfEmpty(CampaignImpressionList.getDefaultInstance())\n                       .onErrorResumeNext(Maybe.just(CampaignImpressionList.getDefaultInstance()));\n \n+              Maybe<InstanceIdResult> getIID = taskToMaybe(firebaseInstanceId.getInstanceId());\n+\n               Function<CampaignImpressionList, Maybe<FetchEligibleCampaignsResponse>> serviceFetch =\n-                  impressions ->\n-                      taskToMaybe(apiClient.getFiams(impressions))\n-                          .doOnSuccess(\n-                              resp ->\n-                                  Logging.logi(\n-                                      String.format(\n-                                          Locale.US,\n-                                          \"Successfully fetched %d messages from backend\",\n-                                          resp.getMessagesList().size())))\n-                          .doOnSuccess(\n-                              resp -> impressionStorageClient.clearImpressions(resp).subscribe())\n-                          .doOnSuccess(analyticsEventsManager::updateContextualTriggers)\n-                          .doOnSuccess(testDeviceHelper::processCampaignFetch)\n-                          .doOnError(e -> Logging.logw(\"Service fetch error: \" + e.getMessage()))\n-                          .onErrorResumeNext(Maybe.empty()); // Absorb service failures\n+                  campaignImpressionList -> {\n+                    if (!dataCollectionHelper.isAutomaticDataCollectionEnabled()) {\n+                      Logging.logi(\n+                          \"Automatic data collection is disabled, not attempting campaign fetch from service.\");\n+                      return Maybe.just(cacheExpiringResponse());\n+                    }\n+\n+                    // blocking get occurs on the IO thread because that's what we observeOn above\n+                    return Maybe.fromCallable(getIID::blockingGet)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd85fa4b0a7f63b093de8dcf770d3c18ecf0d0fc"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUzMTE5OQ==", "bodyText": "ah but I need to do blocking get which turns it into a not maybe, if I don't do blocking get here the waiting ends up hitting the main thread below", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412531199", "createdAt": "2020-04-21T22:20:28Z", "author": {"login": "JasonAHeron"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -232,22 +243,37 @@ private boolean shouldIgnoreCache(String event) {\n                       .defaultIfEmpty(CampaignImpressionList.getDefaultInstance())\n                       .onErrorResumeNext(Maybe.just(CampaignImpressionList.getDefaultInstance()));\n \n+              Maybe<InstanceIdResult> getIID = taskToMaybe(firebaseInstanceId.getInstanceId());\n+\n               Function<CampaignImpressionList, Maybe<FetchEligibleCampaignsResponse>> serviceFetch =\n-                  impressions ->\n-                      taskToMaybe(apiClient.getFiams(impressions))\n-                          .doOnSuccess(\n-                              resp ->\n-                                  Logging.logi(\n-                                      String.format(\n-                                          Locale.US,\n-                                          \"Successfully fetched %d messages from backend\",\n-                                          resp.getMessagesList().size())))\n-                          .doOnSuccess(\n-                              resp -> impressionStorageClient.clearImpressions(resp).subscribe())\n-                          .doOnSuccess(analyticsEventsManager::updateContextualTriggers)\n-                          .doOnSuccess(testDeviceHelper::processCampaignFetch)\n-                          .doOnError(e -> Logging.logw(\"Service fetch error: \" + e.getMessage()))\n-                          .onErrorResumeNext(Maybe.empty()); // Absorb service failures\n+                  campaignImpressionList -> {\n+                    if (!dataCollectionHelper.isAutomaticDataCollectionEnabled()) {\n+                      Logging.logi(\n+                          \"Automatic data collection is disabled, not attempting campaign fetch from service.\");\n+                      return Maybe.just(cacheExpiringResponse());\n+                    }\n+\n+                    // blocking get occurs on the IO thread because that's what we observeOn above\n+                    return Maybe.fromCallable(getIID::blockingGet)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyODA2OQ=="}, "originalCommit": {"oid": "bd85fa4b0a7f63b093de8dcf770d3c18ecf0d0fc"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzM3NDM4OnYy", "diffSide": "RIGHT", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjoxNzo1NFrOGJa1FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjozNzozNVrOGJbYHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyOTk0MA==", "bodyText": "Previously: When IID was failing, you were previously returning an expired response from the API Client.\nI presume this would be cached, and the next time you lookup the cache, you would find that it has expired and make a service call.\nNow: You this maybe would resolve to an error, that on line 274 would print the service failure.\nCan you confirm that this logic is accurate by actually testing IID Fetch failure ?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412529940", "createdAt": "2020-04-21T22:17:54Z", "author": {"login": "ashwinraghav"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -232,22 +243,37 @@ private boolean shouldIgnoreCache(String event) {\n                       .defaultIfEmpty(CampaignImpressionList.getDefaultInstance())\n                       .onErrorResumeNext(Maybe.just(CampaignImpressionList.getDefaultInstance()));\n \n+              Maybe<InstanceIdResult> getIID = taskToMaybe(firebaseInstanceId.getInstanceId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd85fa4b0a7f63b093de8dcf770d3c18ecf0d0fc"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUzODkxMA==", "bodyText": "So right now the behavior is essentially FIAM will fetch infinitely if it encounters an error", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412538910", "createdAt": "2020-04-21T22:37:35Z", "author": {"login": "JasonAHeron"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -232,22 +243,37 @@ private boolean shouldIgnoreCache(String event) {\n                       .defaultIfEmpty(CampaignImpressionList.getDefaultInstance())\n                       .onErrorResumeNext(Maybe.just(CampaignImpressionList.getDefaultInstance()));\n \n+              Maybe<InstanceIdResult> getIID = taskToMaybe(firebaseInstanceId.getInstanceId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyOTk0MA=="}, "originalCommit": {"oid": "bd85fa4b0a7f63b093de8dcf770d3c18ecf0d0fc"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MzUwMzc3OnYy", "diffSide": "RIGHT", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjo1OTowMlrOGJb9Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMzoxNToxM1rOGJcXWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0ODQxMQ==", "bodyText": "Thinking out loud: Can this be modelled as an empty as well, similar to IID?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412548411", "createdAt": "2020-04-21T22:59:02Z", "author": {"login": "ashwinraghav"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -232,22 +243,35 @@ private boolean shouldIgnoreCache(String event) {\n                       .defaultIfEmpty(CampaignImpressionList.getDefaultInstance())\n                       .onErrorResumeNext(Maybe.just(CampaignImpressionList.getDefaultInstance()));\n \n+              Maybe<InstanceIdResult> getIID = taskToMaybe(firebaseInstanceId.getInstanceId());\n+\n               Function<CampaignImpressionList, Maybe<FetchEligibleCampaignsResponse>> serviceFetch =\n-                  impressions ->\n-                      taskToMaybe(apiClient.getFiams(impressions))\n-                          .doOnSuccess(\n-                              resp ->\n-                                  Logging.logi(\n-                                      String.format(\n-                                          Locale.US,\n-                                          \"Successfully fetched %d messages from backend\",\n-                                          resp.getMessagesList().size())))\n-                          .doOnSuccess(\n-                              resp -> impressionStorageClient.clearImpressions(resp).subscribe())\n-                          .doOnSuccess(analyticsEventsManager::updateContextualTriggers)\n-                          .doOnSuccess(testDeviceHelper::processCampaignFetch)\n-                          .doOnError(e -> Logging.logw(\"Service fetch error: \" + e.getMessage()))\n-                          .onErrorResumeNext(Maybe.empty()); // Absorb service failures\n+                  campaignImpressionList -> {\n+                    if (!dataCollectionHelper.isAutomaticDataCollectionEnabled()) {\n+                      Logging.logi(\n+                          \"Automatic data collection is disabled, not attempting campaign fetch from service.\");\n+                      return Maybe.just(cacheExpiringResponse());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d538bab6161d9b96bebfd7bd205581697af23a11"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU1NDU2Mw==", "bodyText": "hmm maybe but I think this is pretty clear", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412554563", "createdAt": "2020-04-21T23:13:50Z", "author": {"login": "JasonAHeron"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -232,22 +243,35 @@ private boolean shouldIgnoreCache(String event) {\n                       .defaultIfEmpty(CampaignImpressionList.getDefaultInstance())\n                       .onErrorResumeNext(Maybe.just(CampaignImpressionList.getDefaultInstance()));\n \n+              Maybe<InstanceIdResult> getIID = taskToMaybe(firebaseInstanceId.getInstanceId());\n+\n               Function<CampaignImpressionList, Maybe<FetchEligibleCampaignsResponse>> serviceFetch =\n-                  impressions ->\n-                      taskToMaybe(apiClient.getFiams(impressions))\n-                          .doOnSuccess(\n-                              resp ->\n-                                  Logging.logi(\n-                                      String.format(\n-                                          Locale.US,\n-                                          \"Successfully fetched %d messages from backend\",\n-                                          resp.getMessagesList().size())))\n-                          .doOnSuccess(\n-                              resp -> impressionStorageClient.clearImpressions(resp).subscribe())\n-                          .doOnSuccess(analyticsEventsManager::updateContextualTriggers)\n-                          .doOnSuccess(testDeviceHelper::processCampaignFetch)\n-                          .doOnError(e -> Logging.logw(\"Service fetch error: \" + e.getMessage()))\n-                          .onErrorResumeNext(Maybe.empty()); // Absorb service failures\n+                  campaignImpressionList -> {\n+                    if (!dataCollectionHelper.isAutomaticDataCollectionEnabled()) {\n+                      Logging.logi(\n+                          \"Automatic data collection is disabled, not attempting campaign fetch from service.\");\n+                      return Maybe.just(cacheExpiringResponse());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0ODQxMQ=="}, "originalCommit": {"oid": "d538bab6161d9b96bebfd7bd205581697af23a11"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU1NTA5OA==", "bodyText": "like it could map to empty or something like that but I think it's not worth it", "url": "https://github.com/firebase/firebase-android-sdk/pull/1488#discussion_r412555098", "createdAt": "2020-04-21T23:15:13Z", "author": {"login": "JasonAHeron"}, "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -232,22 +243,35 @@ private boolean shouldIgnoreCache(String event) {\n                       .defaultIfEmpty(CampaignImpressionList.getDefaultInstance())\n                       .onErrorResumeNext(Maybe.just(CampaignImpressionList.getDefaultInstance()));\n \n+              Maybe<InstanceIdResult> getIID = taskToMaybe(firebaseInstanceId.getInstanceId());\n+\n               Function<CampaignImpressionList, Maybe<FetchEligibleCampaignsResponse>> serviceFetch =\n-                  impressions ->\n-                      taskToMaybe(apiClient.getFiams(impressions))\n-                          .doOnSuccess(\n-                              resp ->\n-                                  Logging.logi(\n-                                      String.format(\n-                                          Locale.US,\n-                                          \"Successfully fetched %d messages from backend\",\n-                                          resp.getMessagesList().size())))\n-                          .doOnSuccess(\n-                              resp -> impressionStorageClient.clearImpressions(resp).subscribe())\n-                          .doOnSuccess(analyticsEventsManager::updateContextualTriggers)\n-                          .doOnSuccess(testDeviceHelper::processCampaignFetch)\n-                          .doOnError(e -> Logging.logw(\"Service fetch error: \" + e.getMessage()))\n-                          .onErrorResumeNext(Maybe.empty()); // Absorb service failures\n+                  campaignImpressionList -> {\n+                    if (!dataCollectionHelper.isAutomaticDataCollectionEnabled()) {\n+                      Logging.logi(\n+                          \"Automatic data collection is disabled, not attempting campaign fetch from service.\");\n+                      return Maybe.just(cacheExpiringResponse());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU0ODQxMQ=="}, "originalCommit": {"oid": "d538bab6161d9b96bebfd7bd205581697af23a11"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1321, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}