{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNDE0MTYx", "number": 1431, "title": "Add large payload support to datatransport.", "bodyText": "Large payloads are stored in a separate table as 80KB chunks of data keyed\nby (sequence_num,event_id).\nThe motivation for the change is to avoid the Android SQLite\nimplementation limitation, that uses CursorWindows of a limited size\nthat is unknown at runtime and vendors can change arbitrarily, hence the\nconservative choice of 80KB instead of 2048KB that is present in AOSP\nsource code.\nThe way it manifests is that it is possible to write rows in the the db\nthat is impossible to read back as an exception gets thrown.\nAn altertative approach that was considered was to store file paths in\nthe DB and store blobs in the file-system. But that would introduce more\ncomplexity to the storage system:\n\nLoss of ACID semantics, i.e. if we fail to commit we may fail to\ndelete the underlying file.\nShould we store it in cache dir or in file dir?\nWhat if cache is cleared but the event reference still exists in the db?\netc.", "createdAt": "2020-04-07T17:51:29Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431", "merged": true, "mergeCommit": {"oid": "4498fccb497a897f2832599c8db42cb34abc5ce9"}, "closed": true, "closedAt": "2020-04-14T13:30:31Z", "author": {"login": "vkryachko"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVXEFPAH2gAyNDAwNDE0MTYxOjUwN2U4YzYzYTE3MzNlOWRiMDYzMmYyMjg4ZGNjMmYzZGU5YmViMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWCZfSAFqTM5MTEwNDAwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "507e8c63a1733e9db0632f2288dcc2f3de9beb33", "author": {"user": {"login": "vkryachko", "name": "Vladimir Kryachko"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/507e8c63a1733e9db0632f2288dcc2f3de9beb33", "committedDate": "2020-04-07T17:50:46Z", "message": "Add large payload support to datatransport.\n\nLarge payloads are stored in a separate table as 80KB chunks of data keyed\nby (sequence_num,event_id).\nThe motivation for the change is to avoid the Android SQLite\nimplementation limitation, that uses `CursorWindow`s of a limited size\nthat is unknown at runtime and vendors can change arbitrarily, hence the\nconservative choice of 80KB instead of 2048KB that is present in AOSP\nsource code.\n\nThe way it manifests is that it is possible to write rows in the the db\nthat is impossible to read back as an exception gets thrown.\n\nAn altertative approach that was considered was to store file paths in\nthe DB and store blobs in the file-system. But that would introduce more\ncomplexity to the storage system:\n\n* Loss of ACID semantics, i.e. if we fail to commit we may fail to\n  delete the underlying file.\n* Should we store it in cache dir or in file dir?\n* What if cache is cleared but the event reference still exists in the db?\n* etc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ede9fa22e9e502753f9efd9708efed3fce9ede4", "author": {"user": {"login": "vkryachko", "name": "Vladimir Kryachko"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/5ede9fa22e9e502753f9efd9708efed3fce9ede4", "committedDate": "2020-04-07T20:52:41Z", "message": "Fix integ test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeeb09c14e29253ed547e10ea6d217c82400ef99", "author": {"user": {"login": "vkryachko", "name": "Vladimir Kryachko"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/aeeb09c14e29253ed547e10ea6d217c82400ef99", "committedDate": "2020-04-07T20:52:52Z", "message": "Upgrade to latest dagger."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e25a7f8211df2f03c271c7b7068964bd6e48db7", "author": {"user": {"login": "vkryachko", "name": "Vladimir Kryachko"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/2e25a7f8211df2f03c271c7b7068964bd6e48db7", "committedDate": "2020-04-08T17:01:28Z", "message": "Increase device coverage of sqlite tests.\n\nSpecifically moved sqlite tests to instrumentation such that they run on\nall configured devices in FTL.\n\nAdditionally added migration test from v3 to v4."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576", "author": {"user": {"login": "vkryachko", "name": "Vladimir Kryachko"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/3870f605a87c6216c4a01a385530ee10f9fb7576", "committedDate": "2020-04-08T17:04:48Z", "message": "upgrade robolectric."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzQzMTYw", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#pullrequestreview-390343160", "createdAt": "2020-04-08T21:24:41Z", "commit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMToyNDo0MlrOGDBiYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjowNjo1MVrOGDCroA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNDA5Nw==", "bodyText": "MAX_BLOB_SIZE_BYTES ?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405824097", "createdAt": "2020-04-08T21:24:42Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/androidTest/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStoreTest.java", "diffHunk": "@@ -52,8 +53,14 @@\n           .build();\n \n   private static final long HOUR = 60 * 60 * 1000;\n+  private static final int MAX_BLOB_SIZE = 6;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNDQ2Mw==", "bodyText": "setMaxBlobSizeBytesPerRow ?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405824463", "createdAt": "2020-04-08T21:25:28Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/EventStoreConfig.java", "diffHunk": "@@ -61,6 +66,8 @@ Builder toBuilder() {\n \n     abstract Builder setEventCleanUpAge(long value);\n \n+    abstract Builder setMaxBlobSizePerRow(int value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNTUyMQ==", "bodyText": "Can we move lines 99 to 103 up to the setup portion of the test  to conform to the pattern you have in here\n//setup\n//Act\n//assert", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405825521", "createdAt": "2020-04-08T21:27:44Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/androidTest/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStoreTest.java", "diffHunk": "@@ -75,6 +85,31 @@ public void persist_correctlyRoundTrips() {\n     assertThat(events).containsExactly(newEvent);\n   }\n \n+  @Test\n+  public void persist_withNonInlineBlob_correctlyRoundTrips() {\n+    byte[] payload = \"LongerThanSixBytes\".getBytes(Charset.defaultCharset());\n+    EventInternal event =\n+        EVENT.toBuilder().setEncodedPayload(new EncodedPayload(JSON_ENCODING, payload)).build();\n+    PersistedEvent newEvent = store.persist(TRANSPORT_CONTEXT, event);\n+    Iterable<PersistedEvent> events = store.loadBatch(TRANSPORT_CONTEXT);\n+\n+    assertThat(newEvent.getEvent()).isEqualTo(event);\n+    assertThat(events).containsExactly(newEvent);\n+    long expectedRows = payload.length / MAX_BLOB_SIZE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyODE0NA==", "bodyText": "Nit: I realize this is starting to look like an integration test. Consider splitting up.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405828144", "createdAt": "2020-04-08T21:33:13Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/androidTest/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStoreTest.java", "diffHunk": "@@ -75,6 +85,31 @@ public void persist_correctlyRoundTrips() {\n     assertThat(events).containsExactly(newEvent);\n   }\n \n+  @Test\n+  public void persist_withNonInlineBlob_correctlyRoundTrips() {\n+    byte[] payload = \"LongerThanSixBytes\".getBytes(Charset.defaultCharset());\n+    EventInternal event =\n+        EVENT.toBuilder().setEncodedPayload(new EncodedPayload(JSON_ENCODING, payload)).build();\n+    PersistedEvent newEvent = store.persist(TRANSPORT_CONTEXT, event);\n+    Iterable<PersistedEvent> events = store.loadBatch(TRANSPORT_CONTEXT);\n+\n+    assertThat(newEvent.getEvent()).isEqualTo(event);\n+    assertThat(events).containsExactly(newEvent);\n+    long expectedRows = payload.length / MAX_BLOB_SIZE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNTUyMQ=="}, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyODczMw==", "bodyText": "MAX_BLOB_SIZE_PER_ROW_BYTES ?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405828733", "createdAt": "2020-04-08T21:34:23Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/EventStoreConfig.java", "diffHunk": "@@ -22,13 +22,15 @@\n   private static final int LOAD_BATCH_SIZE = 200;\n   private static final int LOCK_TIME_OUT_MS = 10000;\n   private static final long DURATION_ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;\n+  private static final int MAX_BLOB_SIZE_PER_ROW = 80 * 1024;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzMTU4NA==", "bodyText": "Consider Math.ceil((double)payloadBytes.length / maxBlobSizePerRow)", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405831584", "createdAt": "2020-04-08T21:40:47Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStore.java", "diffHunk": "@@ -104,16 +106,39 @@ public PersistedEvent persist(TransportContext transportContext, EventInternal e\n               }\n \n               long contextId = ensureTransportContext(db, transportContext);\n+              int maxBlobSizePerRow = config.getMaxBlobSizePerRow();\n+\n+              byte[] payloadBytes = event.getEncodedPayload().getBytes();\n+              boolean inline = payloadBytes.length <= maxBlobSizePerRow;\n               ContentValues values = new ContentValues();\n               values.put(\"context_id\", contextId);\n               values.put(\"transport_name\", event.getTransportName());\n               values.put(\"timestamp_ms\", event.getEventMillis());\n               values.put(\"uptime_ms\", event.getUptimeMillis());\n               values.put(\"payload_encoding\", event.getEncodedPayload().getEncoding().getName());\n-              values.put(\"payload\", event.getEncodedPayload().getBytes());\n               values.put(\"code\", event.getCode());\n               values.put(\"num_attempts\", 0);\n+              values.put(\"inline\", inline);\n+              values.put(\"payload\", inline ? payloadBytes : new byte[0]);\n               long newEventId = db.insert(\"events\", null, values);\n+              if (!inline) {\n+                int numChunks = payloadBytes.length / maxBlobSizePerRow;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzMjgwMg==", "bodyText": "Dug around a bit and failed to find a way to avoid copying (sanely).", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405832802", "createdAt": "2020-04-08T21:43:34Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStore.java", "diffHunk": "@@ -104,16 +106,39 @@ public PersistedEvent persist(TransportContext transportContext, EventInternal e\n               }\n \n               long contextId = ensureTransportContext(db, transportContext);\n+              int maxBlobSizePerRow = config.getMaxBlobSizePerRow();\n+\n+              byte[] payloadBytes = event.getEncodedPayload().getBytes();\n+              boolean inline = payloadBytes.length <= maxBlobSizePerRow;\n               ContentValues values = new ContentValues();\n               values.put(\"context_id\", contextId);\n               values.put(\"transport_name\", event.getTransportName());\n               values.put(\"timestamp_ms\", event.getEventMillis());\n               values.put(\"uptime_ms\", event.getUptimeMillis());\n               values.put(\"payload_encoding\", event.getEncodedPayload().getEncoding().getName());\n-              values.put(\"payload\", event.getEncodedPayload().getBytes());\n               values.put(\"code\", event.getCode());\n               values.put(\"num_attempts\", 0);\n+              values.put(\"inline\", inline);\n+              values.put(\"payload\", inline ? payloadBytes : new byte[0]);\n               long newEventId = db.insert(\"events\", null, values);\n+              if (!inline) {\n+                int numChunks = payloadBytes.length / maxBlobSizePerRow;\n+                if (payloadBytes.length % maxBlobSizePerRow != 0) {\n+                  numChunks += 1;\n+                }\n+                for (int chunk = 1; chunk <= numChunks; chunk++) {\n+                  byte[] chunkBytes =\n+                      Arrays.copyOfRange(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNDU0OQ==", "bodyText": "Can be moved into the loop above?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405834549", "createdAt": "2020-04-08T21:47:45Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SQLiteEventStore.java", "diffHunk": "@@ -386,6 +418,37 @@ public void clearDb() {\n     return events;\n   }\n \n+  private byte[] readPayload(long eventId) {\n+    return tryWithCursor(\n+        getDb()\n+            .query(\n+                \"event_payloads\",\n+                new String[] {\"bytes\"},\n+                \"event_id = ?\",\n+                new String[] {String.valueOf(eventId)},\n+                null,\n+                null,\n+                \"sequence_num\"),\n+        cursor -> {\n+          List<byte[]> chunks = new ArrayList<>();\n+          while (cursor.moveToNext()) {\n+            chunks.add(cursor.getBlob(0));\n+          }\n+          int totalLength = 0;\n+          for (byte[] chunk : chunks) {\n+            totalLength += chunk.length;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzNzM2Mg==", "bodyText": "What does this do?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405837362", "createdAt": "2020-04-08T21:53:48Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SchemaManager.java", "diffHunk": "@@ -95,12 +104,24 @@\n   private static final SchemaManager.Migration MIGRATE_TO_V3 =\n       db -> db.execSQL(\"ALTER TABLE events ADD COLUMN payload_encoding TEXT\");\n \n+  private static final SchemaManager.Migration MIGRATE_TO_V4 =\n+      db -> {\n+        db.execSQL(\"ALTER TABLE events ADD COLUMN inline BOOLEAN DEFAULT 1\");\n+        ContentValues values = new ContentValues();\n+        values.put(\"inline\", 1);\n+        db.update(\"events\", values, null, new String[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0Mjg0OA==", "bodyText": "What happens to existing inline events that may be too large. Should we cleanup since migration seems impossible ?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#discussion_r405842848", "createdAt": "2020-04-08T22:06:51Z", "author": {"login": "ashwinraghav"}, "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SchemaManager.java", "diffHunk": "@@ -95,12 +104,24 @@\n   private static final SchemaManager.Migration MIGRATE_TO_V3 =\n       db -> db.execSQL(\"ALTER TABLE events ADD COLUMN payload_encoding TEXT\");\n \n+  private static final SchemaManager.Migration MIGRATE_TO_V4 =\n+      db -> {\n+        db.execSQL(\"ALTER TABLE events ADD COLUMN inline BOOLEAN DEFAULT 1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3870f605a87c6216c4a01a385530ee10f9fb7576"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "866abb7cb773646ac67552de5fa60536a2a36414", "author": {"user": {"login": "vkryachko", "name": "Vladimir Kryachko"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/866abb7cb773646ac67552de5fa60536a2a36414", "committedDate": "2020-04-09T15:19:13Z", "message": "Address review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTMzOTY0", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#pullrequestreview-390933964", "createdAt": "2020-04-09T16:10:19Z", "commit": {"oid": "866abb7cb773646ac67552de5fa60536a2a36414"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTA0MDAz", "url": "https://github.com/firebase/firebase-android-sdk/pull/1431#pullrequestreview-391104003", "createdAt": "2020-04-09T20:20:04Z", "commit": {"oid": "866abb7cb773646ac67552de5fa60536a2a36414"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2751, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}