{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NjE1OTcw", "number": 2254, "title": "Background update", "bodyText": "", "createdAt": "2020-12-14T15:58:12Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/2254", "merged": true, "mergeCommit": {"oid": "ec78ab8addb8f44967d551e316732bce96799cad"}, "closed": true, "closedAt": "2020-12-21T14:16:58Z", "author": {"login": "annzimmer"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlKxEmgH2gAyNTM5NjE1OTcwOjQyYjdiNmIxZDZiMGEzNmMxYjZlMWIzYzQ2ZDZmYjAzODQ3MDJiODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnLMlbgH2gAyNTM5NjE1OTcwOjUyMjAwNjIxODNhNDE1MjcwZTgyOTRmYWY2YzQ5ZjBkODFiOTUwZDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "42b7b6b1d6b0a36c1b6e1b3c46d6fb0384702b80", "author": {"user": {"login": "annzimmer", "name": "Ann Z"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/42b7b6b1d6b0a36c1b6e1b3c46d6fb0384702b80", "committedDate": "2020-12-11T16:45:05Z", "message": "Update in background"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baf554c22186a802f1dc0a47fada5313f8447242", "author": {"user": {"login": "annzimmer", "name": "Ann Z"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/baf554c22186a802f1dc0a47fada5313f8447242", "committedDate": "2020-12-14T15:56:30Z", "message": "Adding more download type handling and unit tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e5e5c2eac4495c5c545a38a247862c7f5d1d3a5", "author": {"user": {"login": "annzimmer", "name": "Ann Z"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/7e5e5c2eac4495c5c545a38a247862c7f5d1d3a5", "committedDate": "2020-12-14T18:02:52Z", "message": "Make internal files hidden"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11b9b635c66699d0ea20775e77c26e4478ad7eba", "author": {"user": {"login": "annzimmer", "name": "Ann Z"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/11b9b635c66699d0ea20775e77c26e4478ad7eba", "committedDate": "2020-12-14T18:08:02Z", "message": "Merge branch 'master' into backgroundUpdate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90018d91d790d8c0c4ef41ccaeb5e1a7b9bb9d0e", "author": {"user": {"login": "annzimmer", "name": "Ann Z"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/90018d91d790d8c0c4ef41ccaeb5e1a7b9bb9d0e", "committedDate": "2020-12-14T18:11:14Z", "message": "Clean up after merge."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODg5OTEz", "url": "https://github.com/firebase/firebase-android-sdk/pull/2254#pullrequestreview-554889913", "createdAt": "2020-12-17T18:48:07Z", "commit": {"oid": "90018d91d790d8c0c4ef41ccaeb5e1a7b9bb9d0e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxODo0ODowN1rOIIDytA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxODo1Njo1NVrOIIEMIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyMTY1Mg==", "bodyText": "Should localModel.getModelHash() be passed here, to avoid triggering a download if there is no newer model?", "url": "https://github.com/firebase/firebase-android-sdk/pull/2254#discussion_r545321652", "createdAt": "2020-12-17T18:48:07Z", "author": {"login": "rosalyntan"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/FirebaseModelDownloader.java", "diffHunk": "@@ -120,47 +120,87 @@ public static FirebaseModelDownloader getInstance(@NonNull FirebaseApp app) {\n       @Nullable CustomModelDownloadConditions conditions)\n       throws Exception {\n     CustomModel localModel = sharedPreferencesUtil.getCustomModelDetails(modelName);\n+    if (localModel == null) {\n+      // no local model - get latest.\n+      return getCustomModelTask(modelName, conditions);\n+    }\n+\n     switch (downloadType) {\n       case LOCAL_MODEL:\n-        if (localModel != null) {\n-          return Tasks.forResult(localModel);\n-        }\n-        Task<CustomModel> modelDetails =\n-            modelDownloadService.getCustomModelDetails(\n-                firebaseOptions.getProjectId(), modelName, null);\n-\n-        // no local model - start download.\n-        return modelDetails.continueWithTask(\n-            executor,\n-            modelDetailTask -> {\n-              if (modelDetailTask.isSuccessful()) {\n-                // start download\n-                return fileDownloadService\n-                    .download(modelDetailTask.getResult(), conditions)\n-                    .continueWithTask(\n-                        executor,\n-                        downloadTask -> {\n-                          if (downloadTask.isSuccessful()) {\n-                            // read the updated model\n-                            CustomModel downloadedModel =\n-                                sharedPreferencesUtil.getCustomModelDetails(modelName);\n-                            // TODO(annz) trigger file move here as well... right now it's temp\n-                            // call loadNewlyDownloadedModelFile\n-                            return Tasks.forResult(downloadedModel);\n-                          }\n-                          return Tasks.forException(new Exception(\"File download failed.\"));\n-                        });\n-              }\n-              return Tasks.forException(modelDetailTask.getException());\n-            });\n+        return Tasks.forResult(localModel);\n       case LATEST_MODEL:\n-        // check for latest model and download newest\n-        break;\n+        // check for latest model, wait for download if newer model exists\n+        return getCustomModelTask(modelName, conditions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90018d91d790d8c0c4ef41ccaeb5e1a7b9bb9d0e"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMyODE2Mw==", "bodyText": "Can this be null?", "url": "https://github.com/firebase/firebase-android-sdk/pull/2254#discussion_r545328163", "createdAt": "2020-12-17T18:56:55Z", "author": {"login": "rosalyntan"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/FirebaseModelDownloader.java", "diffHunk": "@@ -120,47 +120,87 @@ public static FirebaseModelDownloader getInstance(@NonNull FirebaseApp app) {\n       @Nullable CustomModelDownloadConditions conditions)\n       throws Exception {\n     CustomModel localModel = sharedPreferencesUtil.getCustomModelDetails(modelName);\n+    if (localModel == null) {\n+      // no local model - get latest.\n+      return getCustomModelTask(modelName, conditions);\n+    }\n+\n     switch (downloadType) {\n       case LOCAL_MODEL:\n-        if (localModel != null) {\n-          return Tasks.forResult(localModel);\n-        }\n-        Task<CustomModel> modelDetails =\n-            modelDownloadService.getCustomModelDetails(\n-                firebaseOptions.getProjectId(), modelName, null);\n-\n-        // no local model - start download.\n-        return modelDetails.continueWithTask(\n-            executor,\n-            modelDetailTask -> {\n-              if (modelDetailTask.isSuccessful()) {\n-                // start download\n-                return fileDownloadService\n-                    .download(modelDetailTask.getResult(), conditions)\n-                    .continueWithTask(\n-                        executor,\n-                        downloadTask -> {\n-                          if (downloadTask.isSuccessful()) {\n-                            // read the updated model\n-                            CustomModel downloadedModel =\n-                                sharedPreferencesUtil.getCustomModelDetails(modelName);\n-                            // TODO(annz) trigger file move here as well... right now it's temp\n-                            // call loadNewlyDownloadedModelFile\n-                            return Tasks.forResult(downloadedModel);\n-                          }\n-                          return Tasks.forException(new Exception(\"File download failed.\"));\n-                        });\n-              }\n-              return Tasks.forException(modelDetailTask.getException());\n-            });\n+        return Tasks.forResult(localModel);\n       case LATEST_MODEL:\n-        // check for latest model and download newest\n-        break;\n+        // check for latest model, wait for download if newer model exists\n+        return getCustomModelTask(modelName, conditions);\n       case LOCAL_MODEL_UPDATE_IN_BACKGROUND:\n-        // start download in back ground return current model if not null.\n-        break;\n+        // start download in back ground, return current model\n+        getCustomModelTask(modelName, conditions, localModel.getModelHash());\n+        // return local model\n+        return Tasks.forResult(localModel);\n     }\n-    throw new UnsupportedOperationException(\"Not yet implemented.\");\n+    throw new IllegalArgumentException(\n+        \"Unsupported downloadType, please chose LOCAL_MODEL, LATEST_MODEL, or LOCAL_MODEL_UPDATE_IN_BACKGROUND\");\n+  }\n+\n+  // This version of getCustomModelTask will always call the modelDownloadService and upon\n+  // success will then trigger file download.\n+  private Task<CustomModel> getCustomModelTask(\n+      @NonNull String modelName, @Nullable CustomModelDownloadConditions conditions)\n+      throws Exception {\n+    return getCustomModelTask(modelName, conditions, null);\n+  }\n+\n+  // This version of getCustomModelTask will call the modelDownloadService and upon\n+  // success will only trigger file download, if there is a new model hash value.\n+  private Task<CustomModel> getCustomModelTask(\n+      @NonNull String modelName,\n+      @Nullable CustomModelDownloadConditions conditions,\n+      @Nullable String modelHash)\n+      throws Exception {\n+    Task<CustomModel> incomingModelDetails =\n+        modelDownloadService.getCustomModelDetails(\n+            firebaseOptions.getProjectId(), modelName, modelHash);\n+\n+    return incomingModelDetails.continueWithTask(\n+        executor,\n+        incomingModelDetailTask -> {\n+          if (incomingModelDetailTask.isSuccessful()) {\n+            CustomModel currentModel = sharedPreferencesUtil.getCustomModelDetails(modelName);\n+            // null means we have the latest model\n+            if (incomingModelDetails.getResult() == null) {\n+              return Tasks.forResult(currentModel);\n+            }\n+\n+            // if modelHash matches current local model just return local model.\n+            if (currentModel", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90018d91d790d8c0c4ef41ccaeb5e1a7b9bb9d0e"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5220062183a415270e8294faf6c49f0d81b950d6", "author": {"user": {"login": "annzimmer", "name": "Ann Z"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/5220062183a415270e8294faf6c49f0d81b950d6", "committedDate": "2020-12-17T22:22:59Z", "message": "Updates FirebaseMlLogEvent ModelOption name to Options to make internal proto. This allows for proper json to proto conversion and in local tests messages now reach the spanner queue."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2346, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}