{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNTM4MDI5", "number": 1188, "title": "Fix queriesCannotBeSortedByAnUncommittedServerTimestamp test", "bodyText": "This test fails in my FieldValue rewrite when not run under the debugger.\nI believe the failure is expected when the WatchStream acknowledges the Write before the WriteStream does. I see three snapshots:\nisFromCache:true, hasPendingWrites:true\nofflineCallbackDone.setResult()\n\nWatch updates arrives\nisFromCache:false, hasPendingWrites:true\nWe now try to set the result for `offlineCallbackDone` again, which raises an exception.\n\nWrite updates arrives\nisFromCache:false, hasPendingWrites:false\nonlineCallbackDone.setResult()\n\nI believe a similar failure occurs today if the order is switched:\nisFromCache:true, hasPendingWrites:true\nofflineCallbackDone.setResult()\n\nWrite updates arrives\nisFromCache:true, hasPendingWrites:false\nonlineCallbackDone.setResult()\n\nisFromCache:false, hasPendingWrites:false\nWe now try to set the result for `onlineCallbackDone` again, which raises an exception. \nThis exceptions is however swallowed since it happens after the test finishes.", "createdAt": "2020-02-03T21:45:45Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1188", "merged": true, "mergeCommit": {"oid": "b89694a5dd04fe923080ac2e1cc5f876b06c583d"}, "closed": true, "closedAt": "2020-02-04T23:39:08Z", "author": {"login": "schmidt-sebastian"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcA0BPXAH2gAyMzcwNTM4MDI5OmM3YWUwMTU4MWI4NTQzMmI2YmM2MDgwZjIzMTNmMWNmYmUwYTljZjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBJ5_zAFqTM1MzM2OTEzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c7ae01581b85432b6bc6080f2313f1cfbe0a9cf8", "author": {"user": {"login": "schmidt-sebastian", "name": "Sebastian Schmidt"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/c7ae01581b85432b6bc6080f2313f1cfbe0a9cf8", "committedDate": "2020-02-03T21:42:30Z", "message": "Fix flaky queriesCannotBeSortedByAnUncommittedServerTimestamp test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNTg1NjMx", "url": "https://github.com/firebase/firebase-android-sdk/pull/1188#pullrequestreview-352585631", "createdAt": "2020-02-03T21:46:05Z", "commit": {"oid": "c7ae01581b85432b6bc6080f2313f1cfbe0a9cf8"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMTo0NjowNVrOFlBENA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMTo0NjoyOVrOFlBE3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM1OTA5Mg==", "bodyText": "This line changed", "url": "https://github.com/firebase/firebase-android-sdk/pull/1188#discussion_r374359092", "createdAt": "2020-02-03T21:46:05Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-firestore/src/androidTest/java/com/google/firebase/firestore/ValidationTest.java", "diffHunk": "@@ -461,44 +461,49 @@ public void queriesCannotBeSortedByAnUncommittedServerTimestamp() {\n     TaskCompletionSource<Void> offlineCallbackDone = new TaskCompletionSource<>();\n     TaskCompletionSource<Void> onlineCallbackDone = new TaskCompletionSource<>();\n \n-    collection.addSnapshotListener(\n-        (snapshot, error) -> {\n-          assertNotNull(snapshot);\n-\n-          // Skip the initial empty snapshot.\n-          if (snapshot.isEmpty()) return;\n-\n-          assertThat(snapshot.getDocuments()).hasSize(1);\n-          DocumentSnapshot docSnap = snapshot.getDocuments().get(0);\n-\n-          if (snapshot.getMetadata().hasPendingWrites()) {\n-            // Offline snapshot. Since the server timestamp is uncommitted, we shouldn't be able to\n-            // query by it.\n-            assertThrows(\n-                IllegalArgumentException.class,\n-                () ->\n-                    collection\n-                        .orderBy(\"timestamp\")\n-                        .endAt(docSnap)\n-                        .addSnapshotListener((snapshot2, error2) -> {}));\n-            offlineCallbackDone.setResult(null);\n-          } else {\n-            // Online snapshot. Since the server timestamp is committed, we should be able to query\n-            // by it.\n-            collection\n-                .orderBy(\"timestamp\")\n-                .endAt(docSnap)\n-                .addSnapshotListener((snapshot2, error2) -> {});\n-            onlineCallbackDone.setResult(null);\n-          }\n-        });\n+    ListenerRegistration listenerRegistration =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ae01581b85432b6bc6080f2313f1cfbe0a9cf8"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM1OTE3NQ==", "bodyText": "These tree lines changed", "url": "https://github.com/firebase/firebase-android-sdk/pull/1188#discussion_r374359175", "createdAt": "2020-02-03T21:46:16Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-firestore/src/androidTest/java/com/google/firebase/firestore/ValidationTest.java", "diffHunk": "@@ -461,44 +461,49 @@ public void queriesCannotBeSortedByAnUncommittedServerTimestamp() {\n     TaskCompletionSource<Void> offlineCallbackDone = new TaskCompletionSource<>();\n     TaskCompletionSource<Void> onlineCallbackDone = new TaskCompletionSource<>();\n \n-    collection.addSnapshotListener(\n-        (snapshot, error) -> {\n-          assertNotNull(snapshot);\n-\n-          // Skip the initial empty snapshot.\n-          if (snapshot.isEmpty()) return;\n-\n-          assertThat(snapshot.getDocuments()).hasSize(1);\n-          DocumentSnapshot docSnap = snapshot.getDocuments().get(0);\n-\n-          if (snapshot.getMetadata().hasPendingWrites()) {\n-            // Offline snapshot. Since the server timestamp is uncommitted, we shouldn't be able to\n-            // query by it.\n-            assertThrows(\n-                IllegalArgumentException.class,\n-                () ->\n-                    collection\n-                        .orderBy(\"timestamp\")\n-                        .endAt(docSnap)\n-                        .addSnapshotListener((snapshot2, error2) -> {}));\n-            offlineCallbackDone.setResult(null);\n-          } else {\n-            // Online snapshot. Since the server timestamp is committed, we should be able to query\n-            // by it.\n-            collection\n-                .orderBy(\"timestamp\")\n-                .endAt(docSnap)\n-                .addSnapshotListener((snapshot2, error2) -> {});\n-            onlineCallbackDone.setResult(null);\n-          }\n-        });\n+    ListenerRegistration listenerRegistration =\n+        collection.addSnapshotListener(\n+            (snapshot, error) -> {\n+              assertNotNull(snapshot);\n+\n+              // Skip the initial empty snapshot.\n+              if (snapshot.isEmpty()) return;\n+\n+              assertThat(snapshot.getDocuments()).hasSize(1);\n+              DocumentSnapshot docSnap = snapshot.getDocuments().get(0);\n+\n+              if (snapshot.getMetadata().hasPendingWrites()) {\n+                // Offline snapshot. Since the server timestamp is uncommitted, we shouldn't be able\n+                // to query by it.\n+                assertThrows(\n+                    IllegalArgumentException.class,\n+                    () ->\n+                        collection\n+                            .orderBy(\"timestamp\")\n+                            .endAt(docSnap)\n+                            .addSnapshotListener((snapshot2, error2) -> {}));\n+                // Use `trySetResult` since the callbacks fires twice if the WatchStream\n+                // acknowledges the Write before the WriteStream.\n+                offlineCallbackDone.trySetResult(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ae01581b85432b6bc6080f2313f1cfbe0a9cf8"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM1OTIxNQ==", "bodyText": "This line changed", "url": "https://github.com/firebase/firebase-android-sdk/pull/1188#discussion_r374359215", "createdAt": "2020-02-03T21:46:23Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-firestore/src/androidTest/java/com/google/firebase/firestore/ValidationTest.java", "diffHunk": "@@ -461,44 +461,49 @@ public void queriesCannotBeSortedByAnUncommittedServerTimestamp() {\n     TaskCompletionSource<Void> offlineCallbackDone = new TaskCompletionSource<>();\n     TaskCompletionSource<Void> onlineCallbackDone = new TaskCompletionSource<>();\n \n-    collection.addSnapshotListener(\n-        (snapshot, error) -> {\n-          assertNotNull(snapshot);\n-\n-          // Skip the initial empty snapshot.\n-          if (snapshot.isEmpty()) return;\n-\n-          assertThat(snapshot.getDocuments()).hasSize(1);\n-          DocumentSnapshot docSnap = snapshot.getDocuments().get(0);\n-\n-          if (snapshot.getMetadata().hasPendingWrites()) {\n-            // Offline snapshot. Since the server timestamp is uncommitted, we shouldn't be able to\n-            // query by it.\n-            assertThrows(\n-                IllegalArgumentException.class,\n-                () ->\n-                    collection\n-                        .orderBy(\"timestamp\")\n-                        .endAt(docSnap)\n-                        .addSnapshotListener((snapshot2, error2) -> {}));\n-            offlineCallbackDone.setResult(null);\n-          } else {\n-            // Online snapshot. Since the server timestamp is committed, we should be able to query\n-            // by it.\n-            collection\n-                .orderBy(\"timestamp\")\n-                .endAt(docSnap)\n-                .addSnapshotListener((snapshot2, error2) -> {});\n-            onlineCallbackDone.setResult(null);\n-          }\n-        });\n+    ListenerRegistration listenerRegistration =\n+        collection.addSnapshotListener(\n+            (snapshot, error) -> {\n+              assertNotNull(snapshot);\n+\n+              // Skip the initial empty snapshot.\n+              if (snapshot.isEmpty()) return;\n+\n+              assertThat(snapshot.getDocuments()).hasSize(1);\n+              DocumentSnapshot docSnap = snapshot.getDocuments().get(0);\n+\n+              if (snapshot.getMetadata().hasPendingWrites()) {\n+                // Offline snapshot. Since the server timestamp is uncommitted, we shouldn't be able\n+                // to query by it.\n+                assertThrows(\n+                    IllegalArgumentException.class,\n+                    () ->\n+                        collection\n+                            .orderBy(\"timestamp\")\n+                            .endAt(docSnap)\n+                            .addSnapshotListener((snapshot2, error2) -> {}));\n+                // Use `trySetResult` since the callbacks fires twice if the WatchStream\n+                // acknowledges the Write before the WriteStream.\n+                offlineCallbackDone.trySetResult(null);\n+              } else {\n+                // Online snapshot. Since the server timestamp is committed, we should be able to\n+                // query by it.\n+                collection\n+                    .orderBy(\"timestamp\")\n+                    .endAt(docSnap)\n+                    .addSnapshotListener((snapshot2, error2) -> {});\n+                onlineCallbackDone.trySetResult(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ae01581b85432b6bc6080f2313f1cfbe0a9cf8"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM1OTI2Mg==", "bodyText": "This is new", "url": "https://github.com/firebase/firebase-android-sdk/pull/1188#discussion_r374359262", "createdAt": "2020-02-03T21:46:29Z", "author": {"login": "schmidt-sebastian"}, "path": "firebase-firestore/src/androidTest/java/com/google/firebase/firestore/ValidationTest.java", "diffHunk": "@@ -461,44 +461,49 @@ public void queriesCannotBeSortedByAnUncommittedServerTimestamp() {\n     TaskCompletionSource<Void> offlineCallbackDone = new TaskCompletionSource<>();\n     TaskCompletionSource<Void> onlineCallbackDone = new TaskCompletionSource<>();\n \n-    collection.addSnapshotListener(\n-        (snapshot, error) -> {\n-          assertNotNull(snapshot);\n-\n-          // Skip the initial empty snapshot.\n-          if (snapshot.isEmpty()) return;\n-\n-          assertThat(snapshot.getDocuments()).hasSize(1);\n-          DocumentSnapshot docSnap = snapshot.getDocuments().get(0);\n-\n-          if (snapshot.getMetadata().hasPendingWrites()) {\n-            // Offline snapshot. Since the server timestamp is uncommitted, we shouldn't be able to\n-            // query by it.\n-            assertThrows(\n-                IllegalArgumentException.class,\n-                () ->\n-                    collection\n-                        .orderBy(\"timestamp\")\n-                        .endAt(docSnap)\n-                        .addSnapshotListener((snapshot2, error2) -> {}));\n-            offlineCallbackDone.setResult(null);\n-          } else {\n-            // Online snapshot. Since the server timestamp is committed, we should be able to query\n-            // by it.\n-            collection\n-                .orderBy(\"timestamp\")\n-                .endAt(docSnap)\n-                .addSnapshotListener((snapshot2, error2) -> {});\n-            onlineCallbackDone.setResult(null);\n-          }\n-        });\n+    ListenerRegistration listenerRegistration =\n+        collection.addSnapshotListener(\n+            (snapshot, error) -> {\n+              assertNotNull(snapshot);\n+\n+              // Skip the initial empty snapshot.\n+              if (snapshot.isEmpty()) return;\n+\n+              assertThat(snapshot.getDocuments()).hasSize(1);\n+              DocumentSnapshot docSnap = snapshot.getDocuments().get(0);\n+\n+              if (snapshot.getMetadata().hasPendingWrites()) {\n+                // Offline snapshot. Since the server timestamp is uncommitted, we shouldn't be able\n+                // to query by it.\n+                assertThrows(\n+                    IllegalArgumentException.class,\n+                    () ->\n+                        collection\n+                            .orderBy(\"timestamp\")\n+                            .endAt(docSnap)\n+                            .addSnapshotListener((snapshot2, error2) -> {}));\n+                // Use `trySetResult` since the callbacks fires twice if the WatchStream\n+                // acknowledges the Write before the WriteStream.\n+                offlineCallbackDone.trySetResult(null);\n+              } else {\n+                // Online snapshot. Since the server timestamp is committed, we should be able to\n+                // query by it.\n+                collection\n+                    .orderBy(\"timestamp\")\n+                    .endAt(docSnap)\n+                    .addSnapshotListener((snapshot2, error2) -> {});\n+                onlineCallbackDone.trySetResult(null);\n+              }\n+            });\n \n     DocumentReference document = collection.document();\n     document.set(map(\"timestamp\", FieldValue.serverTimestamp()));\n     waitFor(offlineCallbackDone.getTask());\n \n     waitFor(collection.firestore.getClient().enableNetwork());\n     waitFor(onlineCallbackDone.getTask());\n+\n+    listenerRegistration.remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ae01581b85432b6bc6080f2313f1cfbe0a9cf8"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzY5MTM4", "url": "https://github.com/firebase/firebase-android-sdk/pull/1188#pullrequestreview-353369138", "createdAt": "2020-02-04T23:11:45Z", "commit": {"oid": "c7ae01581b85432b6bc6080f2313f1cfbe0a9cf8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzoxMTo0NlrOFlmxHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQyMzoxMTo0NlrOFlmxHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3Njc5OA==", "bodyText": "FYI: You can enable a whitespace insensitive diff in the github UI which highlights these differences essentially just like your comments. You could just advise the reviewer enable that mode with less effort.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1188#discussion_r374976798", "createdAt": "2020-02-04T23:11:46Z", "author": {"login": "wilhuff"}, "path": "firebase-firestore/src/androidTest/java/com/google/firebase/firestore/ValidationTest.java", "diffHunk": "@@ -461,44 +461,49 @@ public void queriesCannotBeSortedByAnUncommittedServerTimestamp() {\n     TaskCompletionSource<Void> offlineCallbackDone = new TaskCompletionSource<>();\n     TaskCompletionSource<Void> onlineCallbackDone = new TaskCompletionSource<>();\n \n-    collection.addSnapshotListener(\n-        (snapshot, error) -> {\n-          assertNotNull(snapshot);\n-\n-          // Skip the initial empty snapshot.\n-          if (snapshot.isEmpty()) return;\n-\n-          assertThat(snapshot.getDocuments()).hasSize(1);\n-          DocumentSnapshot docSnap = snapshot.getDocuments().get(0);\n-\n-          if (snapshot.getMetadata().hasPendingWrites()) {\n-            // Offline snapshot. Since the server timestamp is uncommitted, we shouldn't be able to\n-            // query by it.\n-            assertThrows(\n-                IllegalArgumentException.class,\n-                () ->\n-                    collection\n-                        .orderBy(\"timestamp\")\n-                        .endAt(docSnap)\n-                        .addSnapshotListener((snapshot2, error2) -> {}));\n-            offlineCallbackDone.setResult(null);\n-          } else {\n-            // Online snapshot. Since the server timestamp is committed, we should be able to query\n-            // by it.\n-            collection\n-                .orderBy(\"timestamp\")\n-                .endAt(docSnap)\n-                .addSnapshotListener((snapshot2, error2) -> {});\n-            onlineCallbackDone.setResult(null);\n-          }\n-        });\n+    ListenerRegistration listenerRegistration =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM1OTA5Mg=="}, "originalCommit": {"oid": "c7ae01581b85432b6bc6080f2313f1cfbe0a9cf8"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2292, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}