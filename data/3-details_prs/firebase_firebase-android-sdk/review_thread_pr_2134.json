{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0OTA2NDA2", "number": 2134, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOTowNjoyM1rOE26Ttg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTo0NTozMVrOE5jGIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MDEzODc4OnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOTowNjoyM1rOHv9ZpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOTowNjoyM1rOHv9ZpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA1MTEwOA==", "bodyText": "I think the URL needs to be: \"https://firebaseml.googleapis.com/v1beta2/projects/%s/models/%s:download\".", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r520051108", "createdAt": "2020-11-09T19:06:23Z", "author": {"login": "manjanac"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "diffHunk": "@@ -0,0 +1,247 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader.internal;\n+\n+import android.os.Build.VERSION_CODES;\n+import android.util.JsonReader;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import com.google.android.gms.common.util.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.installations.FirebaseInstallationsApi;\n+import com.google.firebase.installations.InstallationTokenResult;\n+import com.google.firebase.ml.modeldownloader.CustomModel;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import javax.net.ssl.HttpsURLConnection;\n+\n+/**\n+ * Calls the Download Service API and returns the information related to the current status of a\n+ * custom model. If new model available returns 200 and new model details such as the download url;\n+ * If same model is available returns 304 (not modified) Otherwise returns an error.\n+ *\n+ * @hide\n+ */\n+@RequiresApi(api = VERSION_CODES.KITKAT)\n+final class CustomModelDownloadService {\n+\n+  private static final String TAG = \"CustomModelDownloadSer\";\n+  private final ExecutorService executorService;\n+\n+  private static final int CONNECTION_TIME_OUT_MS = 2000; // 2 seconds.\n+  private static final Charset UTF_8 = StandardCharsets.UTF_8;\n+\n+  private static final String ETAG_HEADER = \"ETag\";\n+\n+  @VisibleForTesting\n+  static final String INSTALLATIONS_AUTH_TOKEN_HEADER = \"X-Goog-Firebase-Installations-Auth\";\n+\n+  @VisibleForTesting\n+  static final String DOWNLOAD_MODEL_REGEX =\n+      \"https://firebaseml.googleapis.com/Model/v1beta2/projects/%s/models/%s:download\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70dabcac04485fb0577352d572df2e9170b46ed5"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDQ0MDY5OnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMTo1MDoxNlrOHzArvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMTo1MDoxNlrOHzArvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MDYyMA==", "bodyText": "may be \"in\" instead of \"is\"? Not sure :-)", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r523250620", "createdAt": "2020-11-13T21:50:16Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -42,7 +44,46 @@\n    */\n   public CustomModel(\n       @NonNull String name, long downloadId, long fileSize, @NonNull String modelHash) {\n-    this(name, downloadId, fileSize, modelHash, \"\");\n+    this(name, downloadId, fileSize, modelHash, \"\", \"\", 0);\n+  }\n+\n+  /**\n+   * Use when creating a custom model from a stored model with a new download is the background.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDQ0Mjk1OnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMTo1MToxMVrOHzAtFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODo1OToyMFrOH0NEmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MDk2Ng==", "bodyText": "spurious whitespace before tag", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r523250966", "createdAt": "2020-11-13T21:51:11Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -130,19 +177,43 @@ public boolean equals(Object o) {\n         && Objects.equal(modelHash, other.modelHash)\n         && Objects.equal(fileSize, other.fileSize)\n         && Objects.equal(localFilePath, other.localFilePath)\n-        && Objects.equal(downloadId, other.downloadId);\n+        && Objects.equal(downloadId, other.downloadId)\n+        && Objects.equal(downloadUrl, other.downloadUrl)\n+        && Objects.equal(downloadUrlExpiry, other.downloadUrlExpiry);\n   }\n \n   @Override\n   public int hashCode() {\n-    return Objects.hashCode(name, modelHash, fileSize, localFilePath, downloadId);\n+    return Objects.hashCode(\n+        name, modelHash, fileSize, localFilePath, downloadId, downloadUrl, downloadUrlExpiry);\n+  }\n+\n+  /**\n+   * The expiry time for the current download url.\n+   *\n+   * <p>Internal use only.\n+   *\n+   * @hide\n+   */\n+  public long getDownloadUrlExpiry() {\n+    return downloadUrlExpiry;\n+  }\n+\n+  /**\n+   * @return the model download url\n+   *     <p>Internal use only", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMjE3MA==", "bodyText": "formatting adds this back", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524502170", "createdAt": "2020-11-16T18:59:20Z", "author": {"login": "annzimmer"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -130,19 +177,43 @@ public boolean equals(Object o) {\n         && Objects.equal(modelHash, other.modelHash)\n         && Objects.equal(fileSize, other.fileSize)\n         && Objects.equal(localFilePath, other.localFilePath)\n-        && Objects.equal(downloadId, other.downloadId);\n+        && Objects.equal(downloadId, other.downloadId)\n+        && Objects.equal(downloadUrl, other.downloadUrl)\n+        && Objects.equal(downloadUrlExpiry, other.downloadUrlExpiry);\n   }\n \n   @Override\n   public int hashCode() {\n-    return Objects.hashCode(name, modelHash, fileSize, localFilePath, downloadId);\n+    return Objects.hashCode(\n+        name, modelHash, fileSize, localFilePath, downloadId, downloadUrl, downloadUrlExpiry);\n+  }\n+\n+  /**\n+   * The expiry time for the current download url.\n+   *\n+   * <p>Internal use only.\n+   *\n+   * @hide\n+   */\n+  public long getDownloadUrlExpiry() {\n+    return downloadUrlExpiry;\n+  }\n+\n+  /**\n+   * @return the model download url\n+   *     <p>Internal use only", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzI1MDk2Ng=="}, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 124}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzU2NTAyOnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/firebase-ml-modeldownloader.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNDo1ODo0MFrOH0ClrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNDo1ODo0MFrOH0ClrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzMDQxMg==", "bodyText": "intended?", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524330412", "createdAt": "2020-11-16T14:58:40Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/firebase-ml-modeldownloader.gradle", "diffHunk": "@@ -21,6 +21,7 @@ firebaseLibrary {\n     publishJavadoc = false\n }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzU2ODE2OnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/firebase-ml-modeldownloader.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNDo1OToxN1rOH0CneQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNDo1OToxN1rOH0CneQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzMDg3Mw==", "bodyText": "remove extra line", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524330873", "createdAt": "2020-11-16T14:59:17Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/firebase-ml-modeldownloader.gradle", "diffHunk": "@@ -45,16 +46,24 @@ android {\n dependencies {\n     implementation project(':firebase-common')\n     implementation project(':firebase-components')\n+    implementation project(':firebase-installations-interop')\n+    runtimeOnly project(':firebase-installations')\n \n     implementation 'com.google.android.gms:play-services-tasks:17.2.0'\n+    implementation 'com.google.auto.service:auto-service-annotations:1.0-rc6'\n     implementation 'javax.inject:javax.inject:1'\n \n     compileOnly \"com.google.auto.value:auto-value-annotations:1.6.6\"\n     annotationProcessor \"com.google.auto.value:auto-value:1.6.5\"\n \n     testImplementation 'androidx.test:core:1.3.0'\n-    testImplementation 'com.google.truth:truth:1.0.1'\n-    testImplementation 'junit:junit:4.13'\n+    testImplementation 'com.github.tomakehurst:wiremock-standalone:2.26.3'\n+    testImplementation \"com.google.truth:truth:$googleTruthVersion\"\n+    testImplementation 'junit:junit:4.13.1'\n+    //Android compatible version of Apache httpclient.\n+    testImplementation 'org.apache.httpcomponents:httpclient-android:4.3.5.1'\n     testImplementation 'org.mockito:mockito-core:3.3.3'\n     testImplementation \"org.robolectric:robolectric:$robolectricVersion\"\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzU4MjQzOnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowMjoxNlrOH0CwJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODo1NjoyNFrOH0M9_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzMzA5Mg==", "bodyText": "Although probably not a big deal, but the order of common args in this constructor and in the prev one doesn't match.", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524333092", "createdAt": "2020-11-16T15:02:16Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -42,7 +44,46 @@\n    */\n   public CustomModel(\n       @NonNull String name, long downloadId, long fileSize, @NonNull String modelHash) {\n-    this(name, downloadId, fileSize, modelHash, \"\");\n+    this(name, downloadId, fileSize, modelHash, \"\", \"\", 0);\n+  }\n+\n+  /**\n+   * Use when creating a custom model from a stored model with a new download is the background.\n+   *\n+   * @param name - model name\n+   * @param downloadId - Android Download Manger - download id\n+   * @param fileSize - model file size\n+   * @param modelHash - model hash size\n+   * @hide\n+   */\n+  public CustomModel(\n+      @NonNull String name,\n+      long downloadId,\n+      long fileSize,\n+      @NonNull String modelHash,\n+      String localFilePath) {\n+    this(name, downloadId, fileSize, modelHash, localFilePath, \"\", 0);\n+  }\n+\n+  /**\n+   * Use when creating a custom model from a download service response. Download url and download\n+   * url expiry should go together. These will not be stored in user preferences as this is a\n+   * temporary step towards setting the actual download id.\n+   *\n+   * @param name - model name\n+   * @param modelHash - model hash size\n+   * @param fileSize - model file size\n+   * @param downloadUrl - download url path\n+   * @param downloadUrlExpiry - time download url path expires\n+   * @hide\n+   */\n+  public CustomModel(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMDQ3Ng==", "bodyText": "Good catch - made more consistent.", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524500476", "createdAt": "2020-11-16T18:56:24Z", "author": {"login": "annzimmer"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -42,7 +44,46 @@\n    */\n   public CustomModel(\n       @NonNull String name, long downloadId, long fileSize, @NonNull String modelHash) {\n-    this(name, downloadId, fileSize, modelHash, \"\");\n+    this(name, downloadId, fileSize, modelHash, \"\", \"\", 0);\n+  }\n+\n+  /**\n+   * Use when creating a custom model from a stored model with a new download is the background.\n+   *\n+   * @param name - model name\n+   * @param downloadId - Android Download Manger - download id\n+   * @param fileSize - model file size\n+   * @param modelHash - model hash size\n+   * @hide\n+   */\n+  public CustomModel(\n+      @NonNull String name,\n+      long downloadId,\n+      long fileSize,\n+      @NonNull String modelHash,\n+      String localFilePath) {\n+    this(name, downloadId, fileSize, modelHash, localFilePath, \"\", 0);\n+  }\n+\n+  /**\n+   * Use when creating a custom model from a download service response. Download url and download\n+   * url expiry should go together. These will not be stored in user preferences as this is a\n+   * temporary step towards setting the actual download id.\n+   *\n+   * @param name - model name\n+   * @param modelHash - model hash size\n+   * @param fileSize - model file size\n+   * @param downloadUrl - download url path\n+   * @param downloadUrlExpiry - time download url path expires\n+   * @hide\n+   */\n+  public CustomModel(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzMzA5Mg=="}, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzU4NDczOnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowMjo0MlrOH0Cxig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowMjo0MlrOH0Cxig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzMzQ1MA==", "bodyText": "is it the size or the hash itself?", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524333450", "createdAt": "2020-11-16T15:02:42Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -42,7 +44,46 @@\n    */\n   public CustomModel(\n       @NonNull String name, long downloadId, long fileSize, @NonNull String modelHash) {\n-    this(name, downloadId, fileSize, modelHash, \"\");\n+    this(name, downloadId, fileSize, modelHash, \"\", \"\", 0);\n+  }\n+\n+  /**\n+   * Use when creating a custom model from a stored model with a new download is the background.\n+   *\n+   * @param name - model name\n+   * @param downloadId - Android Download Manger - download id\n+   * @param fileSize - model file size\n+   * @param modelHash - model hash size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzU4NTExOnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowMjo0NlrOH0Cxug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTowMjo0NlrOH0Cxug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDMzMzQ5OA==", "bodyText": "is it the size or the hash itself?", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524333498", "createdAt": "2020-11-16T15:02:46Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/CustomModel.java", "diffHunk": "@@ -42,7 +44,46 @@\n    */\n   public CustomModel(\n       @NonNull String name, long downloadId, long fileSize, @NonNull String modelHash) {\n-    this(name, downloadId, fileSize, modelHash, \"\");\n+    this(name, downloadId, fileSize, modelHash, \"\", \"\", 0);\n+  }\n+\n+  /**\n+   * Use when creating a custom model from a stored model with a new download is the background.\n+   *\n+   * @param name - model name\n+   * @param downloadId - Android Download Manger - download id\n+   * @param fileSize - model file size\n+   * @param modelHash - model hash size\n+   * @hide\n+   */\n+  public CustomModel(\n+      @NonNull String name,\n+      long downloadId,\n+      long fileSize,\n+      @NonNull String modelHash,\n+      String localFilePath) {\n+    this(name, downloadId, fileSize, modelHash, localFilePath, \"\", 0);\n+  }\n+\n+  /**\n+   * Use when creating a custom model from a download service response. Download url and download\n+   * url expiry should go together. These will not be stored in user preferences as this is a\n+   * temporary step towards setting the actual download id.\n+   *\n+   * @param name - model name\n+   * @param modelHash - model hash size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzYzMTc2OnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToxMzowMFrOH0DOXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToxMzowMFrOH0DOXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0MDgzMQ==", "bodyText": "sgtm", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524340831", "createdAt": "2020-11-16T15:13:00Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "diffHunk": "@@ -0,0 +1,296 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader.internal;\n+\n+import android.os.Build.VERSION_CODES;\n+import android.util.JsonReader;\n+import android.util.Log;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import com.google.android.gms.common.util.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.installations.FirebaseInstallationsApi;\n+import com.google.firebase.installations.InstallationTokenResult;\n+import com.google.firebase.ml.modeldownloader.CustomModel;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.TimeZone;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.zip.GZIPInputStream;\n+\n+/**\n+ * Calls the Download Service API and returns the information related to the current status of a\n+ * custom model. If new model available returns 200 and new model details such as the download url;\n+ * If same model is available returns 304 (not modified) Otherwise returns an error.\n+ *\n+ * @hide\n+ */\n+@RequiresApi(api = VERSION_CODES.KITKAT)\n+public final class CustomModelDownloadService {\n+\n+  private static final String TAG = \"CustomModelDownloadSer\";\n+  private final ExecutorService executorService;\n+\n+  private static final int CONNECTION_TIME_OUT_MS = 2000; // 2 seconds.\n+  private static final Charset UTF_8 = StandardCharsets.UTF_8;\n+\n+  @VisibleForTesting static final String ETAG_HEADER = \"etag\";\n+\n+  private static final String ACCEPT_ENCODING_HEADER_KEY = \"Accept-Encoding\";\n+  private static final String CONTENT_ENCODING_HEADER_KEY = \"Content-Encoding\";\n+  private static final String GZIP_CONTENT_ENCODING = \"gzip\";\n+  private static final String FIREBASE_DOWNLOAD_HOST = \"https://firebaseml.googleapis.com\";\n+  @VisibleForTesting static final String CONTENT_TYPE = \"Content-Type\";\n+  @VisibleForTesting static final String APPLICATION_JSON = \"application/json; charset=UTF-8\";\n+  @VisibleForTesting static final String IF_NONE_MATCH_HEADER_KEY = \"If-None-Match\";\n+\n+  @VisibleForTesting\n+  static final String INSTALLATIONS_AUTH_TOKEN_HEADER = \"X-Goog-Firebase-Installations-Auth\";\n+\n+  @VisibleForTesting static final String API_KEY_HEADER = \"x-goog-api-key\";\n+\n+  @VisibleForTesting\n+  static final String DOWNLOAD_MODEL_REGEX = \"%s/v1beta2/projects/%s/models/%s:download\";\n+\n+  private FirebaseInstallationsApi firebaseInstallations;\n+  private String apiKey;\n+  private String downloadHost = FIREBASE_DOWNLOAD_HOST;\n+\n+  public CustomModelDownloadService(\n+      FirebaseOptions firebaseOptions, FirebaseInstallationsApi installationsApi) {\n+    firebaseInstallations = installationsApi;\n+    apiKey = firebaseOptions.getApiKey();\n+    // is this an appropriate executor?\n+    executorService = Executors.newCachedThreadPool();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzY0MTY2OnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToxNTowOFrOH0DUZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODo1NjoxOFrOH0M9qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0MjM3NQ==", "bodyText": "maybe a class level constant?", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524342375", "createdAt": "2020-11-16T15:15:08Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "diffHunk": "@@ -0,0 +1,296 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader.internal;\n+\n+import android.os.Build.VERSION_CODES;\n+import android.util.JsonReader;\n+import android.util.Log;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import com.google.android.gms.common.util.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.installations.FirebaseInstallationsApi;\n+import com.google.firebase.installations.InstallationTokenResult;\n+import com.google.firebase.ml.modeldownloader.CustomModel;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.TimeZone;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.zip.GZIPInputStream;\n+\n+/**\n+ * Calls the Download Service API and returns the information related to the current status of a\n+ * custom model. If new model available returns 200 and new model details such as the download url;\n+ * If same model is available returns 304 (not modified) Otherwise returns an error.\n+ *\n+ * @hide\n+ */\n+@RequiresApi(api = VERSION_CODES.KITKAT)\n+public final class CustomModelDownloadService {\n+\n+  private static final String TAG = \"CustomModelDownloadSer\";\n+  private final ExecutorService executorService;\n+\n+  private static final int CONNECTION_TIME_OUT_MS = 2000; // 2 seconds.\n+  private static final Charset UTF_8 = StandardCharsets.UTF_8;\n+\n+  @VisibleForTesting static final String ETAG_HEADER = \"etag\";\n+\n+  private static final String ACCEPT_ENCODING_HEADER_KEY = \"Accept-Encoding\";\n+  private static final String CONTENT_ENCODING_HEADER_KEY = \"Content-Encoding\";\n+  private static final String GZIP_CONTENT_ENCODING = \"gzip\";\n+  private static final String FIREBASE_DOWNLOAD_HOST = \"https://firebaseml.googleapis.com\";\n+  @VisibleForTesting static final String CONTENT_TYPE = \"Content-Type\";\n+  @VisibleForTesting static final String APPLICATION_JSON = \"application/json; charset=UTF-8\";\n+  @VisibleForTesting static final String IF_NONE_MATCH_HEADER_KEY = \"If-None-Match\";\n+\n+  @VisibleForTesting\n+  static final String INSTALLATIONS_AUTH_TOKEN_HEADER = \"X-Goog-Firebase-Installations-Auth\";\n+\n+  @VisibleForTesting static final String API_KEY_HEADER = \"x-goog-api-key\";\n+\n+  @VisibleForTesting\n+  static final String DOWNLOAD_MODEL_REGEX = \"%s/v1beta2/projects/%s/models/%s:download\";\n+\n+  private FirebaseInstallationsApi firebaseInstallations;\n+  private String apiKey;\n+  private String downloadHost = FIREBASE_DOWNLOAD_HOST;\n+\n+  public CustomModelDownloadService(\n+      FirebaseOptions firebaseOptions, FirebaseInstallationsApi installationsApi) {\n+    firebaseInstallations = installationsApi;\n+    apiKey = firebaseOptions.getApiKey();\n+    // is this an appropriate executor?\n+    executorService = Executors.newCachedThreadPool();\n+  }\n+\n+  @VisibleForTesting\n+  CustomModelDownloadService(\n+      FirebaseInstallationsApi firebaseInstallations,\n+      ExecutorService executorService,\n+      String apiKey,\n+      String downloadHost) {\n+    this.firebaseInstallations = firebaseInstallations;\n+    this.executorService = executorService;\n+    this.apiKey = apiKey;\n+    this.downloadHost = downloadHost;\n+  }\n+\n+  /**\n+   * Calls the Firebase ML Download Service to retrieve the download url for the modelName. Use when\n+   * a download attempt fails due to an expired timestamp.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @return - updated model with new download url and expiry time\n+   * @throws Exception - errors when Firebase ML Download Service call fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getNewDownloadUrlWithExpiry(String projectNumber, String modelName)\n+      throws Exception {\n+    return getCustomModelDetails(projectNumber, modelName, \"\");\n+  }\n+\n+  /**\n+   * Gets the download details for the custom model, returns null if the current model is the\n+   * latest.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @param modelHash - current model hash - input empty string if no current download exists or to\n+   *     force retrieval of a new download url\n+   * @return The download details for the model or null if the current model hash matches the latest\n+   *     model.\n+   * @throws Exception -errors when call to API fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getCustomModelDetails(\n+      String projectNumber, String modelName, String modelHash) throws Exception {\n+    try {\n+      URL url =\n+          new URL(String.format(DOWNLOAD_MODEL_REGEX, downloadHost, projectNumber, modelName));\n+\n+      HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n+      connection.setConnectTimeout(CONNECTION_TIME_OUT_MS);\n+      connection.setRequestProperty(ACCEPT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n+      connection.setRequestProperty(CONTENT_TYPE, APPLICATION_JSON);\n+      if (modelHash != null && !modelHash.isEmpty()) {\n+        connection.setRequestProperty(IF_NONE_MATCH_HEADER_KEY, modelHash);\n+      }\n+\n+      Task<InstallationTokenResult> installationAuthTokenTask =\n+          firebaseInstallations.getToken(false);\n+      return installationAuthTokenTask.continueWithTask(\n+          executorService,\n+          (CustomModelTask) -> {\n+            if (!installationAuthTokenTask.isSuccessful()) {\n+              // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+              return Tasks.forException(\n+                  new Exception(\n+                      \"Firebase Installations failed to get installation auth token for fetch.\",\n+                      installationAuthTokenTask.getException()));\n+            }\n+\n+            connection.setRequestProperty(\n+                INSTALLATIONS_AUTH_TOKEN_HEADER, installationAuthTokenTask.getResult().getToken());\n+            connection.setRequestProperty(API_KEY_HEADER, apiKey);\n+\n+            return fetchDownloadDetails(modelName, connection);\n+          });\n+\n+    } catch (Exception e) {\n+      // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+      throw new Exception(\"Error reading custom model from download service: \" + e.getMessage(), e);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  static long parseTokenExpirationTimestamp(String expiresIn) {\n+    if (expiresIn == null || expiresIn.length() == 0) {\n+      return 0;\n+    }\n+\n+    try {\n+      String isoDatePattern = \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\";\n+      SimpleDateFormat iso8601Format = new SimpleDateFormat(isoDatePattern, Locale.US);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 181}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMDM5NA==", "bodyText": "done", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524500394", "createdAt": "2020-11-16T18:56:18Z", "author": {"login": "annzimmer"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "diffHunk": "@@ -0,0 +1,296 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader.internal;\n+\n+import android.os.Build.VERSION_CODES;\n+import android.util.JsonReader;\n+import android.util.Log;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import com.google.android.gms.common.util.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.installations.FirebaseInstallationsApi;\n+import com.google.firebase.installations.InstallationTokenResult;\n+import com.google.firebase.ml.modeldownloader.CustomModel;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.TimeZone;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.zip.GZIPInputStream;\n+\n+/**\n+ * Calls the Download Service API and returns the information related to the current status of a\n+ * custom model. If new model available returns 200 and new model details such as the download url;\n+ * If same model is available returns 304 (not modified) Otherwise returns an error.\n+ *\n+ * @hide\n+ */\n+@RequiresApi(api = VERSION_CODES.KITKAT)\n+public final class CustomModelDownloadService {\n+\n+  private static final String TAG = \"CustomModelDownloadSer\";\n+  private final ExecutorService executorService;\n+\n+  private static final int CONNECTION_TIME_OUT_MS = 2000; // 2 seconds.\n+  private static final Charset UTF_8 = StandardCharsets.UTF_8;\n+\n+  @VisibleForTesting static final String ETAG_HEADER = \"etag\";\n+\n+  private static final String ACCEPT_ENCODING_HEADER_KEY = \"Accept-Encoding\";\n+  private static final String CONTENT_ENCODING_HEADER_KEY = \"Content-Encoding\";\n+  private static final String GZIP_CONTENT_ENCODING = \"gzip\";\n+  private static final String FIREBASE_DOWNLOAD_HOST = \"https://firebaseml.googleapis.com\";\n+  @VisibleForTesting static final String CONTENT_TYPE = \"Content-Type\";\n+  @VisibleForTesting static final String APPLICATION_JSON = \"application/json; charset=UTF-8\";\n+  @VisibleForTesting static final String IF_NONE_MATCH_HEADER_KEY = \"If-None-Match\";\n+\n+  @VisibleForTesting\n+  static final String INSTALLATIONS_AUTH_TOKEN_HEADER = \"X-Goog-Firebase-Installations-Auth\";\n+\n+  @VisibleForTesting static final String API_KEY_HEADER = \"x-goog-api-key\";\n+\n+  @VisibleForTesting\n+  static final String DOWNLOAD_MODEL_REGEX = \"%s/v1beta2/projects/%s/models/%s:download\";\n+\n+  private FirebaseInstallationsApi firebaseInstallations;\n+  private String apiKey;\n+  private String downloadHost = FIREBASE_DOWNLOAD_HOST;\n+\n+  public CustomModelDownloadService(\n+      FirebaseOptions firebaseOptions, FirebaseInstallationsApi installationsApi) {\n+    firebaseInstallations = installationsApi;\n+    apiKey = firebaseOptions.getApiKey();\n+    // is this an appropriate executor?\n+    executorService = Executors.newCachedThreadPool();\n+  }\n+\n+  @VisibleForTesting\n+  CustomModelDownloadService(\n+      FirebaseInstallationsApi firebaseInstallations,\n+      ExecutorService executorService,\n+      String apiKey,\n+      String downloadHost) {\n+    this.firebaseInstallations = firebaseInstallations;\n+    this.executorService = executorService;\n+    this.apiKey = apiKey;\n+    this.downloadHost = downloadHost;\n+  }\n+\n+  /**\n+   * Calls the Firebase ML Download Service to retrieve the download url for the modelName. Use when\n+   * a download attempt fails due to an expired timestamp.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @return - updated model with new download url and expiry time\n+   * @throws Exception - errors when Firebase ML Download Service call fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getNewDownloadUrlWithExpiry(String projectNumber, String modelName)\n+      throws Exception {\n+    return getCustomModelDetails(projectNumber, modelName, \"\");\n+  }\n+\n+  /**\n+   * Gets the download details for the custom model, returns null if the current model is the\n+   * latest.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @param modelHash - current model hash - input empty string if no current download exists or to\n+   *     force retrieval of a new download url\n+   * @return The download details for the model or null if the current model hash matches the latest\n+   *     model.\n+   * @throws Exception -errors when call to API fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getCustomModelDetails(\n+      String projectNumber, String modelName, String modelHash) throws Exception {\n+    try {\n+      URL url =\n+          new URL(String.format(DOWNLOAD_MODEL_REGEX, downloadHost, projectNumber, modelName));\n+\n+      HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n+      connection.setConnectTimeout(CONNECTION_TIME_OUT_MS);\n+      connection.setRequestProperty(ACCEPT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n+      connection.setRequestProperty(CONTENT_TYPE, APPLICATION_JSON);\n+      if (modelHash != null && !modelHash.isEmpty()) {\n+        connection.setRequestProperty(IF_NONE_MATCH_HEADER_KEY, modelHash);\n+      }\n+\n+      Task<InstallationTokenResult> installationAuthTokenTask =\n+          firebaseInstallations.getToken(false);\n+      return installationAuthTokenTask.continueWithTask(\n+          executorService,\n+          (CustomModelTask) -> {\n+            if (!installationAuthTokenTask.isSuccessful()) {\n+              // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+              return Tasks.forException(\n+                  new Exception(\n+                      \"Firebase Installations failed to get installation auth token for fetch.\",\n+                      installationAuthTokenTask.getException()));\n+            }\n+\n+            connection.setRequestProperty(\n+                INSTALLATIONS_AUTH_TOKEN_HEADER, installationAuthTokenTask.getResult().getToken());\n+            connection.setRequestProperty(API_KEY_HEADER, apiKey);\n+\n+            return fetchDownloadDetails(modelName, connection);\n+          });\n+\n+    } catch (Exception e) {\n+      // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+      throw new Exception(\"Error reading custom model from download service: \" + e.getMessage(), e);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  static long parseTokenExpirationTimestamp(String expiresIn) {\n+    if (expiresIn == null || expiresIn.length() == 0) {\n+      return 0;\n+    }\n+\n+    try {\n+      String isoDatePattern = \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\";\n+      SimpleDateFormat iso8601Format = new SimpleDateFormat(isoDatePattern, Locale.US);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0MjM3NQ=="}, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 181}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzY0MzY5OnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToxNToyN1rOH0DViw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToxNToyN1rOH0DViw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0MjY2Nw==", "bodyText": "unnecessary extra line", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524342667", "createdAt": "2020-11-16T15:15:27Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "diffHunk": "@@ -0,0 +1,296 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader.internal;\n+\n+import android.os.Build.VERSION_CODES;\n+import android.util.JsonReader;\n+import android.util.Log;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import com.google.android.gms.common.util.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.installations.FirebaseInstallationsApi;\n+import com.google.firebase.installations.InstallationTokenResult;\n+import com.google.firebase.ml.modeldownloader.CustomModel;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.TimeZone;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.zip.GZIPInputStream;\n+\n+/**\n+ * Calls the Download Service API and returns the information related to the current status of a\n+ * custom model. If new model available returns 200 and new model details such as the download url;\n+ * If same model is available returns 304 (not modified) Otherwise returns an error.\n+ *\n+ * @hide\n+ */\n+@RequiresApi(api = VERSION_CODES.KITKAT)\n+public final class CustomModelDownloadService {\n+\n+  private static final String TAG = \"CustomModelDownloadSer\";\n+  private final ExecutorService executorService;\n+\n+  private static final int CONNECTION_TIME_OUT_MS = 2000; // 2 seconds.\n+  private static final Charset UTF_8 = StandardCharsets.UTF_8;\n+\n+  @VisibleForTesting static final String ETAG_HEADER = \"etag\";\n+\n+  private static final String ACCEPT_ENCODING_HEADER_KEY = \"Accept-Encoding\";\n+  private static final String CONTENT_ENCODING_HEADER_KEY = \"Content-Encoding\";\n+  private static final String GZIP_CONTENT_ENCODING = \"gzip\";\n+  private static final String FIREBASE_DOWNLOAD_HOST = \"https://firebaseml.googleapis.com\";\n+  @VisibleForTesting static final String CONTENT_TYPE = \"Content-Type\";\n+  @VisibleForTesting static final String APPLICATION_JSON = \"application/json; charset=UTF-8\";\n+  @VisibleForTesting static final String IF_NONE_MATCH_HEADER_KEY = \"If-None-Match\";\n+\n+  @VisibleForTesting\n+  static final String INSTALLATIONS_AUTH_TOKEN_HEADER = \"X-Goog-Firebase-Installations-Auth\";\n+\n+  @VisibleForTesting static final String API_KEY_HEADER = \"x-goog-api-key\";\n+\n+  @VisibleForTesting\n+  static final String DOWNLOAD_MODEL_REGEX = \"%s/v1beta2/projects/%s/models/%s:download\";\n+\n+  private FirebaseInstallationsApi firebaseInstallations;\n+  private String apiKey;\n+  private String downloadHost = FIREBASE_DOWNLOAD_HOST;\n+\n+  public CustomModelDownloadService(\n+      FirebaseOptions firebaseOptions, FirebaseInstallationsApi installationsApi) {\n+    firebaseInstallations = installationsApi;\n+    apiKey = firebaseOptions.getApiKey();\n+    // is this an appropriate executor?\n+    executorService = Executors.newCachedThreadPool();\n+  }\n+\n+  @VisibleForTesting\n+  CustomModelDownloadService(\n+      FirebaseInstallationsApi firebaseInstallations,\n+      ExecutorService executorService,\n+      String apiKey,\n+      String downloadHost) {\n+    this.firebaseInstallations = firebaseInstallations;\n+    this.executorService = executorService;\n+    this.apiKey = apiKey;\n+    this.downloadHost = downloadHost;\n+  }\n+\n+  /**\n+   * Calls the Firebase ML Download Service to retrieve the download url for the modelName. Use when\n+   * a download attempt fails due to an expired timestamp.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @return - updated model with new download url and expiry time\n+   * @throws Exception - errors when Firebase ML Download Service call fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getNewDownloadUrlWithExpiry(String projectNumber, String modelName)\n+      throws Exception {\n+    return getCustomModelDetails(projectNumber, modelName, \"\");\n+  }\n+\n+  /**\n+   * Gets the download details for the custom model, returns null if the current model is the\n+   * latest.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @param modelHash - current model hash - input empty string if no current download exists or to\n+   *     force retrieval of a new download url\n+   * @return The download details for the model or null if the current model hash matches the latest\n+   *     model.\n+   * @throws Exception -errors when call to API fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getCustomModelDetails(\n+      String projectNumber, String modelName, String modelHash) throws Exception {\n+    try {\n+      URL url =\n+          new URL(String.format(DOWNLOAD_MODEL_REGEX, downloadHost, projectNumber, modelName));\n+\n+      HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n+      connection.setConnectTimeout(CONNECTION_TIME_OUT_MS);\n+      connection.setRequestProperty(ACCEPT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n+      connection.setRequestProperty(CONTENT_TYPE, APPLICATION_JSON);\n+      if (modelHash != null && !modelHash.isEmpty()) {\n+        connection.setRequestProperty(IF_NONE_MATCH_HEADER_KEY, modelHash);\n+      }\n+\n+      Task<InstallationTokenResult> installationAuthTokenTask =\n+          firebaseInstallations.getToken(false);\n+      return installationAuthTokenTask.continueWithTask(\n+          executorService,\n+          (CustomModelTask) -> {\n+            if (!installationAuthTokenTask.isSuccessful()) {\n+              // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+              return Tasks.forException(\n+                  new Exception(\n+                      \"Firebase Installations failed to get installation auth token for fetch.\",\n+                      installationAuthTokenTask.getException()));\n+            }\n+\n+            connection.setRequestProperty(\n+                INSTALLATIONS_AUTH_TOKEN_HEADER, installationAuthTokenTask.getResult().getToken());\n+            connection.setRequestProperty(API_KEY_HEADER, apiKey);\n+\n+            return fetchDownloadDetails(modelName, connection);\n+          });\n+\n+    } catch (Exception e) {\n+      // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+      throw new Exception(\"Error reading custom model from download service: \" + e.getMessage(), e);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  static long parseTokenExpirationTimestamp(String expiresIn) {\n+    if (expiresIn == null || expiresIn.length() == 0) {\n+      return 0;\n+    }\n+\n+    try {\n+      String isoDatePattern = \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\";\n+      SimpleDateFormat iso8601Format = new SimpleDateFormat(isoDatePattern, Locale.US);\n+      iso8601Format.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+      Date date = iso8601Format.parse(expiresIn);\n+      return date.getTime();\n+    } catch (ParseException pe) {\n+      // log error and maybe throw an error\n+      Log.w(TAG, \"unable to parse datetime:\" + expiresIn, pe);\n+      return 0;\n+    }\n+  }\n+\n+  private Task<CustomModel> fetchDownloadDetails(String modelName, HttpURLConnection connection)\n+      throws Exception {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 194}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NzY2NjAzOnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyMDoyMFrOH0DjTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODo1NjoxMVrOH0M9Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0NjE4OQ==", "bodyText": "conditional could be simpler as\nif (httpResponseCode == HttpURLConnection.HTTP_OK) {\n  return Tasks.forResult(readCustomModelResponse(modelName, connection));\n}\nif (httpResponseCode == HttpURLConnection.HTTP_NOT_MODIFIED) {\n  return Tasks.forResult(null)\n}\n\n// handle error", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524346189", "createdAt": "2020-11-16T15:20:20Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "diffHunk": "@@ -0,0 +1,296 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader.internal;\n+\n+import android.os.Build.VERSION_CODES;\n+import android.util.JsonReader;\n+import android.util.Log;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import com.google.android.gms.common.util.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.installations.FirebaseInstallationsApi;\n+import com.google.firebase.installations.InstallationTokenResult;\n+import com.google.firebase.ml.modeldownloader.CustomModel;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.TimeZone;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.zip.GZIPInputStream;\n+\n+/**\n+ * Calls the Download Service API and returns the information related to the current status of a\n+ * custom model. If new model available returns 200 and new model details such as the download url;\n+ * If same model is available returns 304 (not modified) Otherwise returns an error.\n+ *\n+ * @hide\n+ */\n+@RequiresApi(api = VERSION_CODES.KITKAT)\n+public final class CustomModelDownloadService {\n+\n+  private static final String TAG = \"CustomModelDownloadSer\";\n+  private final ExecutorService executorService;\n+\n+  private static final int CONNECTION_TIME_OUT_MS = 2000; // 2 seconds.\n+  private static final Charset UTF_8 = StandardCharsets.UTF_8;\n+\n+  @VisibleForTesting static final String ETAG_HEADER = \"etag\";\n+\n+  private static final String ACCEPT_ENCODING_HEADER_KEY = \"Accept-Encoding\";\n+  private static final String CONTENT_ENCODING_HEADER_KEY = \"Content-Encoding\";\n+  private static final String GZIP_CONTENT_ENCODING = \"gzip\";\n+  private static final String FIREBASE_DOWNLOAD_HOST = \"https://firebaseml.googleapis.com\";\n+  @VisibleForTesting static final String CONTENT_TYPE = \"Content-Type\";\n+  @VisibleForTesting static final String APPLICATION_JSON = \"application/json; charset=UTF-8\";\n+  @VisibleForTesting static final String IF_NONE_MATCH_HEADER_KEY = \"If-None-Match\";\n+\n+  @VisibleForTesting\n+  static final String INSTALLATIONS_AUTH_TOKEN_HEADER = \"X-Goog-Firebase-Installations-Auth\";\n+\n+  @VisibleForTesting static final String API_KEY_HEADER = \"x-goog-api-key\";\n+\n+  @VisibleForTesting\n+  static final String DOWNLOAD_MODEL_REGEX = \"%s/v1beta2/projects/%s/models/%s:download\";\n+\n+  private FirebaseInstallationsApi firebaseInstallations;\n+  private String apiKey;\n+  private String downloadHost = FIREBASE_DOWNLOAD_HOST;\n+\n+  public CustomModelDownloadService(\n+      FirebaseOptions firebaseOptions, FirebaseInstallationsApi installationsApi) {\n+    firebaseInstallations = installationsApi;\n+    apiKey = firebaseOptions.getApiKey();\n+    // is this an appropriate executor?\n+    executorService = Executors.newCachedThreadPool();\n+  }\n+\n+  @VisibleForTesting\n+  CustomModelDownloadService(\n+      FirebaseInstallationsApi firebaseInstallations,\n+      ExecutorService executorService,\n+      String apiKey,\n+      String downloadHost) {\n+    this.firebaseInstallations = firebaseInstallations;\n+    this.executorService = executorService;\n+    this.apiKey = apiKey;\n+    this.downloadHost = downloadHost;\n+  }\n+\n+  /**\n+   * Calls the Firebase ML Download Service to retrieve the download url for the modelName. Use when\n+   * a download attempt fails due to an expired timestamp.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @return - updated model with new download url and expiry time\n+   * @throws Exception - errors when Firebase ML Download Service call fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getNewDownloadUrlWithExpiry(String projectNumber, String modelName)\n+      throws Exception {\n+    return getCustomModelDetails(projectNumber, modelName, \"\");\n+  }\n+\n+  /**\n+   * Gets the download details for the custom model, returns null if the current model is the\n+   * latest.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @param modelHash - current model hash - input empty string if no current download exists or to\n+   *     force retrieval of a new download url\n+   * @return The download details for the model or null if the current model hash matches the latest\n+   *     model.\n+   * @throws Exception -errors when call to API fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getCustomModelDetails(\n+      String projectNumber, String modelName, String modelHash) throws Exception {\n+    try {\n+      URL url =\n+          new URL(String.format(DOWNLOAD_MODEL_REGEX, downloadHost, projectNumber, modelName));\n+\n+      HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n+      connection.setConnectTimeout(CONNECTION_TIME_OUT_MS);\n+      connection.setRequestProperty(ACCEPT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n+      connection.setRequestProperty(CONTENT_TYPE, APPLICATION_JSON);\n+      if (modelHash != null && !modelHash.isEmpty()) {\n+        connection.setRequestProperty(IF_NONE_MATCH_HEADER_KEY, modelHash);\n+      }\n+\n+      Task<InstallationTokenResult> installationAuthTokenTask =\n+          firebaseInstallations.getToken(false);\n+      return installationAuthTokenTask.continueWithTask(\n+          executorService,\n+          (CustomModelTask) -> {\n+            if (!installationAuthTokenTask.isSuccessful()) {\n+              // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+              return Tasks.forException(\n+                  new Exception(\n+                      \"Firebase Installations failed to get installation auth token for fetch.\",\n+                      installationAuthTokenTask.getException()));\n+            }\n+\n+            connection.setRequestProperty(\n+                INSTALLATIONS_AUTH_TOKEN_HEADER, installationAuthTokenTask.getResult().getToken());\n+            connection.setRequestProperty(API_KEY_HEADER, apiKey);\n+\n+            return fetchDownloadDetails(modelName, connection);\n+          });\n+\n+    } catch (Exception e) {\n+      // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+      throw new Exception(\"Error reading custom model from download service: \" + e.getMessage(), e);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  static long parseTokenExpirationTimestamp(String expiresIn) {\n+    if (expiresIn == null || expiresIn.length() == 0) {\n+      return 0;\n+    }\n+\n+    try {\n+      String isoDatePattern = \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\";\n+      SimpleDateFormat iso8601Format = new SimpleDateFormat(isoDatePattern, Locale.US);\n+      iso8601Format.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+      Date date = iso8601Format.parse(expiresIn);\n+      return date.getTime();\n+    } catch (ParseException pe) {\n+      // log error and maybe throw an error\n+      Log.w(TAG, \"unable to parse datetime:\" + expiresIn, pe);\n+      return 0;\n+    }\n+  }\n+\n+  private Task<CustomModel> fetchDownloadDetails(String modelName, HttpURLConnection connection)\n+      throws Exception {\n+\n+    connection.connect();\n+    int httpResponseCode = connection.getResponseCode();\n+\n+    if ((httpResponseCode != HttpURLConnection.HTTP_OK)\n+        && (httpResponseCode != HttpURLConnection.HTTP_NOT_MODIFIED)) {\n+      String errorMessage = getErrorStream(connection);\n+\n+      // todo(annz) add more specific error handling. NOT_FOUND, etc.\n+      return Tasks.forException(\n+          new Exception(\n+              String.format(\n+                  Locale.getDefault(),\n+                  \"Failed to connect to Firebase ML download server with HTTP status code: %d\"\n+                      + \" and error message: %s\",\n+                  connection.getResponseCode(),\n+                  errorMessage)));\n+    } else if (httpResponseCode == HttpURLConnection.HTTP_NOT_MODIFIED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 211}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMDI5NA==", "bodyText": "updated.", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524500294", "createdAt": "2020-11-16T18:56:11Z", "author": {"login": "annzimmer"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "diffHunk": "@@ -0,0 +1,296 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader.internal;\n+\n+import android.os.Build.VERSION_CODES;\n+import android.util.JsonReader;\n+import android.util.Log;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import com.google.android.gms.common.util.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.installations.FirebaseInstallationsApi;\n+import com.google.firebase.installations.InstallationTokenResult;\n+import com.google.firebase.ml.modeldownloader.CustomModel;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.TimeZone;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.zip.GZIPInputStream;\n+\n+/**\n+ * Calls the Download Service API and returns the information related to the current status of a\n+ * custom model. If new model available returns 200 and new model details such as the download url;\n+ * If same model is available returns 304 (not modified) Otherwise returns an error.\n+ *\n+ * @hide\n+ */\n+@RequiresApi(api = VERSION_CODES.KITKAT)\n+public final class CustomModelDownloadService {\n+\n+  private static final String TAG = \"CustomModelDownloadSer\";\n+  private final ExecutorService executorService;\n+\n+  private static final int CONNECTION_TIME_OUT_MS = 2000; // 2 seconds.\n+  private static final Charset UTF_8 = StandardCharsets.UTF_8;\n+\n+  @VisibleForTesting static final String ETAG_HEADER = \"etag\";\n+\n+  private static final String ACCEPT_ENCODING_HEADER_KEY = \"Accept-Encoding\";\n+  private static final String CONTENT_ENCODING_HEADER_KEY = \"Content-Encoding\";\n+  private static final String GZIP_CONTENT_ENCODING = \"gzip\";\n+  private static final String FIREBASE_DOWNLOAD_HOST = \"https://firebaseml.googleapis.com\";\n+  @VisibleForTesting static final String CONTENT_TYPE = \"Content-Type\";\n+  @VisibleForTesting static final String APPLICATION_JSON = \"application/json; charset=UTF-8\";\n+  @VisibleForTesting static final String IF_NONE_MATCH_HEADER_KEY = \"If-None-Match\";\n+\n+  @VisibleForTesting\n+  static final String INSTALLATIONS_AUTH_TOKEN_HEADER = \"X-Goog-Firebase-Installations-Auth\";\n+\n+  @VisibleForTesting static final String API_KEY_HEADER = \"x-goog-api-key\";\n+\n+  @VisibleForTesting\n+  static final String DOWNLOAD_MODEL_REGEX = \"%s/v1beta2/projects/%s/models/%s:download\";\n+\n+  private FirebaseInstallationsApi firebaseInstallations;\n+  private String apiKey;\n+  private String downloadHost = FIREBASE_DOWNLOAD_HOST;\n+\n+  public CustomModelDownloadService(\n+      FirebaseOptions firebaseOptions, FirebaseInstallationsApi installationsApi) {\n+    firebaseInstallations = installationsApi;\n+    apiKey = firebaseOptions.getApiKey();\n+    // is this an appropriate executor?\n+    executorService = Executors.newCachedThreadPool();\n+  }\n+\n+  @VisibleForTesting\n+  CustomModelDownloadService(\n+      FirebaseInstallationsApi firebaseInstallations,\n+      ExecutorService executorService,\n+      String apiKey,\n+      String downloadHost) {\n+    this.firebaseInstallations = firebaseInstallations;\n+    this.executorService = executorService;\n+    this.apiKey = apiKey;\n+    this.downloadHost = downloadHost;\n+  }\n+\n+  /**\n+   * Calls the Firebase ML Download Service to retrieve the download url for the modelName. Use when\n+   * a download attempt fails due to an expired timestamp.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @return - updated model with new download url and expiry time\n+   * @throws Exception - errors when Firebase ML Download Service call fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getNewDownloadUrlWithExpiry(String projectNumber, String modelName)\n+      throws Exception {\n+    return getCustomModelDetails(projectNumber, modelName, \"\");\n+  }\n+\n+  /**\n+   * Gets the download details for the custom model, returns null if the current model is the\n+   * latest.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @param modelHash - current model hash - input empty string if no current download exists or to\n+   *     force retrieval of a new download url\n+   * @return The download details for the model or null if the current model hash matches the latest\n+   *     model.\n+   * @throws Exception -errors when call to API fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getCustomModelDetails(\n+      String projectNumber, String modelName, String modelHash) throws Exception {\n+    try {\n+      URL url =\n+          new URL(String.format(DOWNLOAD_MODEL_REGEX, downloadHost, projectNumber, modelName));\n+\n+      HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n+      connection.setConnectTimeout(CONNECTION_TIME_OUT_MS);\n+      connection.setRequestProperty(ACCEPT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n+      connection.setRequestProperty(CONTENT_TYPE, APPLICATION_JSON);\n+      if (modelHash != null && !modelHash.isEmpty()) {\n+        connection.setRequestProperty(IF_NONE_MATCH_HEADER_KEY, modelHash);\n+      }\n+\n+      Task<InstallationTokenResult> installationAuthTokenTask =\n+          firebaseInstallations.getToken(false);\n+      return installationAuthTokenTask.continueWithTask(\n+          executorService,\n+          (CustomModelTask) -> {\n+            if (!installationAuthTokenTask.isSuccessful()) {\n+              // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+              return Tasks.forException(\n+                  new Exception(\n+                      \"Firebase Installations failed to get installation auth token for fetch.\",\n+                      installationAuthTokenTask.getException()));\n+            }\n+\n+            connection.setRequestProperty(\n+                INSTALLATIONS_AUTH_TOKEN_HEADER, installationAuthTokenTask.getResult().getToken());\n+            connection.setRequestProperty(API_KEY_HEADER, apiKey);\n+\n+            return fetchDownloadDetails(modelName, connection);\n+          });\n+\n+    } catch (Exception e) {\n+      // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+      throw new Exception(\"Error reading custom model from download service: \" + e.getMessage(), e);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  static long parseTokenExpirationTimestamp(String expiresIn) {\n+    if (expiresIn == null || expiresIn.length() == 0) {\n+      return 0;\n+    }\n+\n+    try {\n+      String isoDatePattern = \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\";\n+      SimpleDateFormat iso8601Format = new SimpleDateFormat(isoDatePattern, Locale.US);\n+      iso8601Format.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+      Date date = iso8601Format.parse(expiresIn);\n+      return date.getTime();\n+    } catch (ParseException pe) {\n+      // log error and maybe throw an error\n+      Log.w(TAG, \"unable to parse datetime:\" + expiresIn, pe);\n+      return 0;\n+    }\n+  }\n+\n+  private Task<CustomModel> fetchDownloadDetails(String modelName, HttpURLConnection connection)\n+      throws Exception {\n+\n+    connection.connect();\n+    int httpResponseCode = connection.getResponseCode();\n+\n+    if ((httpResponseCode != HttpURLConnection.HTTP_OK)\n+        && (httpResponseCode != HttpURLConnection.HTTP_NOT_MODIFIED)) {\n+      String errorMessage = getErrorStream(connection);\n+\n+      // todo(annz) add more specific error handling. NOT_FOUND, etc.\n+      return Tasks.forException(\n+          new Exception(\n+              String.format(\n+                  Locale.getDefault(),\n+                  \"Failed to connect to Firebase ML download server with HTTP status code: %d\"\n+                      + \" and error message: %s\",\n+                  connection.getResponseCode(),\n+                  errorMessage)));\n+    } else if (httpResponseCode == HttpURLConnection.HTTP_NOT_MODIFIED) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0NjE4OQ=="}, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 211}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4Nzc5Mjk4OnYy", "diffSide": "RIGHT", "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTo0NTozMVrOH0ExGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODo1NjoxMFrOH0M9MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2NjEwNA==", "bodyText": "Use b/79920590\n(other instances fixed in #2174)", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524366104", "createdAt": "2020-11-16T15:45:31Z", "author": {"login": "rlazo"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "diffHunk": "@@ -0,0 +1,296 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader.internal;\n+\n+import android.os.Build.VERSION_CODES;\n+import android.util.JsonReader;\n+import android.util.Log;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import com.google.android.gms.common.util.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.installations.FirebaseInstallationsApi;\n+import com.google.firebase.installations.InstallationTokenResult;\n+import com.google.firebase.ml.modeldownloader.CustomModel;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.TimeZone;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.zip.GZIPInputStream;\n+\n+/**\n+ * Calls the Download Service API and returns the information related to the current status of a\n+ * custom model. If new model available returns 200 and new model details such as the download url;\n+ * If same model is available returns 304 (not modified) Otherwise returns an error.\n+ *\n+ * @hide\n+ */\n+@RequiresApi(api = VERSION_CODES.KITKAT)\n+public final class CustomModelDownloadService {\n+\n+  private static final String TAG = \"CustomModelDownloadSer\";\n+  private final ExecutorService executorService;\n+\n+  private static final int CONNECTION_TIME_OUT_MS = 2000; // 2 seconds.\n+  private static final Charset UTF_8 = StandardCharsets.UTF_8;\n+\n+  @VisibleForTesting static final String ETAG_HEADER = \"etag\";\n+\n+  private static final String ACCEPT_ENCODING_HEADER_KEY = \"Accept-Encoding\";\n+  private static final String CONTENT_ENCODING_HEADER_KEY = \"Content-Encoding\";\n+  private static final String GZIP_CONTENT_ENCODING = \"gzip\";\n+  private static final String FIREBASE_DOWNLOAD_HOST = \"https://firebaseml.googleapis.com\";\n+  @VisibleForTesting static final String CONTENT_TYPE = \"Content-Type\";\n+  @VisibleForTesting static final String APPLICATION_JSON = \"application/json; charset=UTF-8\";\n+  @VisibleForTesting static final String IF_NONE_MATCH_HEADER_KEY = \"If-None-Match\";\n+\n+  @VisibleForTesting\n+  static final String INSTALLATIONS_AUTH_TOKEN_HEADER = \"X-Goog-Firebase-Installations-Auth\";\n+\n+  @VisibleForTesting static final String API_KEY_HEADER = \"x-goog-api-key\";\n+\n+  @VisibleForTesting\n+  static final String DOWNLOAD_MODEL_REGEX = \"%s/v1beta2/projects/%s/models/%s:download\";\n+\n+  private FirebaseInstallationsApi firebaseInstallations;\n+  private String apiKey;\n+  private String downloadHost = FIREBASE_DOWNLOAD_HOST;\n+\n+  public CustomModelDownloadService(\n+      FirebaseOptions firebaseOptions, FirebaseInstallationsApi installationsApi) {\n+    firebaseInstallations = installationsApi;\n+    apiKey = firebaseOptions.getApiKey();\n+    // is this an appropriate executor?\n+    executorService = Executors.newCachedThreadPool();\n+  }\n+\n+  @VisibleForTesting\n+  CustomModelDownloadService(\n+      FirebaseInstallationsApi firebaseInstallations,\n+      ExecutorService executorService,\n+      String apiKey,\n+      String downloadHost) {\n+    this.firebaseInstallations = firebaseInstallations;\n+    this.executorService = executorService;\n+    this.apiKey = apiKey;\n+    this.downloadHost = downloadHost;\n+  }\n+\n+  /**\n+   * Calls the Firebase ML Download Service to retrieve the download url for the modelName. Use when\n+   * a download attempt fails due to an expired timestamp.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @return - updated model with new download url and expiry time\n+   * @throws Exception - errors when Firebase ML Download Service call fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getNewDownloadUrlWithExpiry(String projectNumber, String modelName)\n+      throws Exception {\n+    return getCustomModelDetails(projectNumber, modelName, \"\");\n+  }\n+\n+  /**\n+   * Gets the download details for the custom model, returns null if the current model is the\n+   * latest.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @param modelHash - current model hash - input empty string if no current download exists or to\n+   *     force retrieval of a new download url\n+   * @return The download details for the model or null if the current model hash matches the latest\n+   *     model.\n+   * @throws Exception -errors when call to API fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getCustomModelDetails(\n+      String projectNumber, String modelName, String modelHash) throws Exception {\n+    try {\n+      URL url =\n+          new URL(String.format(DOWNLOAD_MODEL_REGEX, downloadHost, projectNumber, modelName));\n+\n+      HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n+      connection.setConnectTimeout(CONNECTION_TIME_OUT_MS);\n+      connection.setRequestProperty(ACCEPT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n+      connection.setRequestProperty(CONTENT_TYPE, APPLICATION_JSON);\n+      if (modelHash != null && !modelHash.isEmpty()) {\n+        connection.setRequestProperty(IF_NONE_MATCH_HEADER_KEY, modelHash);\n+      }\n+\n+      Task<InstallationTokenResult> installationAuthTokenTask =\n+          firebaseInstallations.getToken(false);\n+      return installationAuthTokenTask.continueWithTask(\n+          executorService,\n+          (CustomModelTask) -> {\n+            if (!installationAuthTokenTask.isSuccessful()) {\n+              // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+              return Tasks.forException(\n+                  new Exception(\n+                      \"Firebase Installations failed to get installation auth token for fetch.\",\n+                      installationAuthTokenTask.getException()));\n+            }\n+\n+            connection.setRequestProperty(\n+                INSTALLATIONS_AUTH_TOKEN_HEADER, installationAuthTokenTask.getResult().getToken());\n+            connection.setRequestProperty(API_KEY_HEADER, apiKey);\n+\n+            return fetchDownloadDetails(modelName, connection);\n+          });\n+\n+    } catch (Exception e) {\n+      // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+      throw new Exception(\"Error reading custom model from download service: \" + e.getMessage(), e);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  static long parseTokenExpirationTimestamp(String expiresIn) {\n+    if (expiresIn == null || expiresIn.length() == 0) {\n+      return 0;\n+    }\n+\n+    try {\n+      String isoDatePattern = \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\";\n+      SimpleDateFormat iso8601Format = new SimpleDateFormat(isoDatePattern, Locale.US);\n+      iso8601Format.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+      Date date = iso8601Format.parse(expiresIn);\n+      return date.getTime();\n+    } catch (ParseException pe) {\n+      // log error and maybe throw an error\n+      Log.w(TAG, \"unable to parse datetime:\" + expiresIn, pe);\n+      return 0;\n+    }\n+  }\n+\n+  private Task<CustomModel> fetchDownloadDetails(String modelName, HttpURLConnection connection)\n+      throws Exception {\n+\n+    connection.connect();\n+    int httpResponseCode = connection.getResponseCode();\n+\n+    if ((httpResponseCode != HttpURLConnection.HTTP_OK)\n+        && (httpResponseCode != HttpURLConnection.HTTP_NOT_MODIFIED)) {\n+      String errorMessage = getErrorStream(connection);\n+\n+      // todo(annz) add more specific error handling. NOT_FOUND, etc.\n+      return Tasks.forException(\n+          new Exception(\n+              String.format(\n+                  Locale.getDefault(),\n+                  \"Failed to connect to Firebase ML download server with HTTP status code: %d\"\n+                      + \" and error message: %s\",\n+                  connection.getResponseCode(),\n+                  errorMessage)));\n+    } else if (httpResponseCode == HttpURLConnection.HTTP_NOT_MODIFIED) {\n+      return Tasks.forResult(null);\n+    }\n+\n+    return Tasks.forResult(readCustomModelResponse(modelName, connection));\n+  }\n+\n+  private CustomModel readCustomModelResponse(\n+      @NonNull String modelName, HttpURLConnection connection) throws IOException {\n+\n+    String encodingKey = connection.getHeaderField(CONTENT_ENCODING_HEADER_KEY);\n+    InputStream inputStream = maybeUnGzip(connection.getInputStream(), encodingKey);\n+    JsonReader reader = new JsonReader(new InputStreamReader(inputStream, UTF_8));\n+    long fileSize = 0L;\n+    String downloadUrl = \"\";\n+    long expireTime = 0L;\n+\n+    String modelHash = maybeUnGzipHeader(connection.getHeaderField(ETAG_HEADER), encodingKey);\n+\n+    if (modelHash == null || modelHash.isEmpty()) {\n+      // todo(annz) replace this...\n+      modelHash = connection.getResponseMessage();\n+    }\n+\n+    // JsonReader.peek will sometimes throw AssertionErrors in Android 8.0 and above. See\n+    // https://b.corp.google.com/issues/79920590 for details.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 236}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDUwMDI3Mg==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-android-sdk/pull/2134#discussion_r524500272", "createdAt": "2020-11-16T18:56:10Z", "author": {"login": "annzimmer"}, "path": "firebase-ml-modeldownloader/src/main/java/com/google/firebase/ml/modeldownloader/internal/CustomModelDownloadService.java", "diffHunk": "@@ -0,0 +1,296 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.ml.modeldownloader.internal;\n+\n+import android.os.Build.VERSION_CODES;\n+import android.util.JsonReader;\n+import android.util.Log;\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import androidx.annotation.RequiresApi;\n+import com.google.android.gms.common.util.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.installations.FirebaseInstallationsApi;\n+import com.google.firebase.installations.InstallationTokenResult;\n+import com.google.firebase.ml.modeldownloader.CustomModel;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.Charset;\n+import java.nio.charset.StandardCharsets;\n+import java.text.ParseException;\n+import java.text.SimpleDateFormat;\n+import java.util.Date;\n+import java.util.Locale;\n+import java.util.TimeZone;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.zip.GZIPInputStream;\n+\n+/**\n+ * Calls the Download Service API and returns the information related to the current status of a\n+ * custom model. If new model available returns 200 and new model details such as the download url;\n+ * If same model is available returns 304 (not modified) Otherwise returns an error.\n+ *\n+ * @hide\n+ */\n+@RequiresApi(api = VERSION_CODES.KITKAT)\n+public final class CustomModelDownloadService {\n+\n+  private static final String TAG = \"CustomModelDownloadSer\";\n+  private final ExecutorService executorService;\n+\n+  private static final int CONNECTION_TIME_OUT_MS = 2000; // 2 seconds.\n+  private static final Charset UTF_8 = StandardCharsets.UTF_8;\n+\n+  @VisibleForTesting static final String ETAG_HEADER = \"etag\";\n+\n+  private static final String ACCEPT_ENCODING_HEADER_KEY = \"Accept-Encoding\";\n+  private static final String CONTENT_ENCODING_HEADER_KEY = \"Content-Encoding\";\n+  private static final String GZIP_CONTENT_ENCODING = \"gzip\";\n+  private static final String FIREBASE_DOWNLOAD_HOST = \"https://firebaseml.googleapis.com\";\n+  @VisibleForTesting static final String CONTENT_TYPE = \"Content-Type\";\n+  @VisibleForTesting static final String APPLICATION_JSON = \"application/json; charset=UTF-8\";\n+  @VisibleForTesting static final String IF_NONE_MATCH_HEADER_KEY = \"If-None-Match\";\n+\n+  @VisibleForTesting\n+  static final String INSTALLATIONS_AUTH_TOKEN_HEADER = \"X-Goog-Firebase-Installations-Auth\";\n+\n+  @VisibleForTesting static final String API_KEY_HEADER = \"x-goog-api-key\";\n+\n+  @VisibleForTesting\n+  static final String DOWNLOAD_MODEL_REGEX = \"%s/v1beta2/projects/%s/models/%s:download\";\n+\n+  private FirebaseInstallationsApi firebaseInstallations;\n+  private String apiKey;\n+  private String downloadHost = FIREBASE_DOWNLOAD_HOST;\n+\n+  public CustomModelDownloadService(\n+      FirebaseOptions firebaseOptions, FirebaseInstallationsApi installationsApi) {\n+    firebaseInstallations = installationsApi;\n+    apiKey = firebaseOptions.getApiKey();\n+    // is this an appropriate executor?\n+    executorService = Executors.newCachedThreadPool();\n+  }\n+\n+  @VisibleForTesting\n+  CustomModelDownloadService(\n+      FirebaseInstallationsApi firebaseInstallations,\n+      ExecutorService executorService,\n+      String apiKey,\n+      String downloadHost) {\n+    this.firebaseInstallations = firebaseInstallations;\n+    this.executorService = executorService;\n+    this.apiKey = apiKey;\n+    this.downloadHost = downloadHost;\n+  }\n+\n+  /**\n+   * Calls the Firebase ML Download Service to retrieve the download url for the modelName. Use when\n+   * a download attempt fails due to an expired timestamp.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @return - updated model with new download url and expiry time\n+   * @throws Exception - errors when Firebase ML Download Service call fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getNewDownloadUrlWithExpiry(String projectNumber, String modelName)\n+      throws Exception {\n+    return getCustomModelDetails(projectNumber, modelName, \"\");\n+  }\n+\n+  /**\n+   * Gets the download details for the custom model, returns null if the current model is the\n+   * latest.\n+   *\n+   * @param projectNumber - firebase project number\n+   * @param modelName - model name\n+   * @param modelHash - current model hash - input empty string if no current download exists or to\n+   *     force retrieval of a new download url\n+   * @return The download details for the model or null if the current model hash matches the latest\n+   *     model.\n+   * @throws Exception -errors when call to API fails.\n+   */\n+  @Nullable\n+  public Task<CustomModel> getCustomModelDetails(\n+      String projectNumber, String modelName, String modelHash) throws Exception {\n+    try {\n+      URL url =\n+          new URL(String.format(DOWNLOAD_MODEL_REGEX, downloadHost, projectNumber, modelName));\n+\n+      HttpURLConnection connection = (HttpURLConnection) url.openConnection();\n+      connection.setConnectTimeout(CONNECTION_TIME_OUT_MS);\n+      connection.setRequestProperty(ACCEPT_ENCODING_HEADER_KEY, GZIP_CONTENT_ENCODING);\n+      connection.setRequestProperty(CONTENT_TYPE, APPLICATION_JSON);\n+      if (modelHash != null && !modelHash.isEmpty()) {\n+        connection.setRequestProperty(IF_NONE_MATCH_HEADER_KEY, modelHash);\n+      }\n+\n+      Task<InstallationTokenResult> installationAuthTokenTask =\n+          firebaseInstallations.getToken(false);\n+      return installationAuthTokenTask.continueWithTask(\n+          executorService,\n+          (CustomModelTask) -> {\n+            if (!installationAuthTokenTask.isSuccessful()) {\n+              // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+              return Tasks.forException(\n+                  new Exception(\n+                      \"Firebase Installations failed to get installation auth token for fetch.\",\n+                      installationAuthTokenTask.getException()));\n+            }\n+\n+            connection.setRequestProperty(\n+                INSTALLATIONS_AUTH_TOKEN_HEADER, installationAuthTokenTask.getResult().getToken());\n+            connection.setRequestProperty(API_KEY_HEADER, apiKey);\n+\n+            return fetchDownloadDetails(modelName, connection);\n+          });\n+\n+    } catch (Exception e) {\n+      // TODO(annz) update to better error handling (use FirebaseMLExceptions)\n+      throw new Exception(\"Error reading custom model from download service: \" + e.getMessage(), e);\n+    }\n+  }\n+\n+  @VisibleForTesting\n+  static long parseTokenExpirationTimestamp(String expiresIn) {\n+    if (expiresIn == null || expiresIn.length() == 0) {\n+      return 0;\n+    }\n+\n+    try {\n+      String isoDatePattern = \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\";\n+      SimpleDateFormat iso8601Format = new SimpleDateFormat(isoDatePattern, Locale.US);\n+      iso8601Format.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+      Date date = iso8601Format.parse(expiresIn);\n+      return date.getTime();\n+    } catch (ParseException pe) {\n+      // log error and maybe throw an error\n+      Log.w(TAG, \"unable to parse datetime:\" + expiresIn, pe);\n+      return 0;\n+    }\n+  }\n+\n+  private Task<CustomModel> fetchDownloadDetails(String modelName, HttpURLConnection connection)\n+      throws Exception {\n+\n+    connection.connect();\n+    int httpResponseCode = connection.getResponseCode();\n+\n+    if ((httpResponseCode != HttpURLConnection.HTTP_OK)\n+        && (httpResponseCode != HttpURLConnection.HTTP_NOT_MODIFIED)) {\n+      String errorMessage = getErrorStream(connection);\n+\n+      // todo(annz) add more specific error handling. NOT_FOUND, etc.\n+      return Tasks.forException(\n+          new Exception(\n+              String.format(\n+                  Locale.getDefault(),\n+                  \"Failed to connect to Firebase ML download server with HTTP status code: %d\"\n+                      + \" and error message: %s\",\n+                  connection.getResponseCode(),\n+                  errorMessage)));\n+    } else if (httpResponseCode == HttpURLConnection.HTTP_NOT_MODIFIED) {\n+      return Tasks.forResult(null);\n+    }\n+\n+    return Tasks.forResult(readCustomModelResponse(modelName, connection));\n+  }\n+\n+  private CustomModel readCustomModelResponse(\n+      @NonNull String modelName, HttpURLConnection connection) throws IOException {\n+\n+    String encodingKey = connection.getHeaderField(CONTENT_ENCODING_HEADER_KEY);\n+    InputStream inputStream = maybeUnGzip(connection.getInputStream(), encodingKey);\n+    JsonReader reader = new JsonReader(new InputStreamReader(inputStream, UTF_8));\n+    long fileSize = 0L;\n+    String downloadUrl = \"\";\n+    long expireTime = 0L;\n+\n+    String modelHash = maybeUnGzipHeader(connection.getHeaderField(ETAG_HEADER), encodingKey);\n+\n+    if (modelHash == null || modelHash.isEmpty()) {\n+      // todo(annz) replace this...\n+      modelHash = connection.getResponseMessage();\n+    }\n+\n+    // JsonReader.peek will sometimes throw AssertionErrors in Android 8.0 and above. See\n+    // https://b.corp.google.com/issues/79920590 for details.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2NjEwNA=="}, "originalCommit": {"oid": "c5b248e23d10ef9d3a791051caeadbc6b757b130"}, "originalPosition": 236}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1107, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}