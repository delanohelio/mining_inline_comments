{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5OTUwMTky", "number": 1358, "title": "Add session end fields to Crashlytics reports", "bodyText": "", "createdAt": "2020-03-17T16:42:13Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358", "merged": true, "mergeCommit": {"oid": "67af9130d090bbcd6a299e0487f67f914f7b226a"}, "closed": true, "closedAt": "2020-03-17T18:59:43Z", "author": {"login": "mrwillis21"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOkpQYAH2gAyMzg5OTUwMTkyOmM1N2I3ZjM5NDI0ZTc5N2ViNDUyNmMwZWE3OThkNzdjM2RkZjNiNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOnDUugFqTM3NjMwMDkyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c57b7f39424e797eb4526c0ea798d77c3ddf3b71", "author": {"user": {"login": "mrwillis21", "name": "Matt Willis"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/c57b7f39424e797eb4526c0ea798d77c3ddf3b71", "committedDate": "2020-03-17T15:42:40Z", "message": "Add new fields to CrashlyticsReport"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16af937fa368619e28498fe8098e7097134cb584", "author": {"user": {"login": "mrwillis21", "name": "Matt Willis"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/16af937fa368619e28498fe8098e7097134cb584", "committedDate": "2020-03-17T16:08:33Z", "message": "Add with function to set all session end fields at once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e97194f64c68451fdee0a00746086e4bc68a6f2", "author": {"user": {"login": "mrwillis21", "name": "Matt Willis"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/8e97194f64c68451fdee0a00746086e4bc68a6f2", "committedDate": "2020-03-17T16:39:22Z", "message": "Set fields at session finalize time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjIxNTQ4", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#pullrequestreview-376221548", "createdAt": "2020-03-17T16:51:33Z", "commit": {"oid": "8e97194f64c68451fdee0a00746086e4bc68a6f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjo1MTozM1rOF3lK1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjo1MTozM1rOF3lK1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgyNDk4MA==", "bodyText": "if it is not relevant to the test, I'm happy with inlining, e.g., 0L for all of these", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#discussion_r393824980", "createdAt": "2020-03-17T16:51:33Z", "author": {"login": "jakeouellette"}, "path": "firebase-crashlytics/src/androidTest/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistenceTest.java", "diffHunk": "@@ -199,7 +232,10 @@ public void testFinalizeReports_capsReports() throws IOException {\n     for (int i = 0; i < 10; i++) {\n       persistReportWithEvent(reportPersistence, \"testSession\" + i, true);\n     }\n-    reportPersistence.finalizeReports(\"skippedSession\");\n+\n+    final long endedAt = System.currentTimeMillis();\n+\n+    reportPersistence.finalizeReports(\"skippedSession\", endedAt);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97194f64c68451fdee0a00746086e4bc68a6f2"}, "originalPosition": 131}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjI2NDU0", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#pullrequestreview-376226454", "createdAt": "2020-03-17T16:57:07Z", "commit": {"oid": "8e97194f64c68451fdee0a00746086e4bc68a6f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjo1NzowOFrOF3lZuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjo1NzowOFrOF3lZuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgyODc5NQ==", "bodyText": "this finalizeReports call is pretty nested. Suggestion:\nRefactor to make it so this method is much shorter, like:\nwriteReport(...);\nrecursiveDelete(sessionDirectory);\n\nThen in writeReport(...), flip the two nested ifs into early terminating statements:\nif (eventFiles.isEmpty()) {\n  return;\n}\n...\nif (report == null) {\n  // TODO: Handle null case\n  return\n}```", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#discussion_r393828795", "createdAt": "2020-03-17T16:57:08Z", "author": {"login": "jakeouellette"}, "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -192,17 +192,20 @@ public void finalizeReports(String currentSessionId) {\n \n         CrashlyticsReport report =\n             TRANSFORM.reportFromJson(readTextFile(new File(sessionDirectory, REPORT_FILE_NAME)));\n-        final String sessionId = report.getSession().getIdentifier();\n \n-        if (userId != null) {\n-          report = report.withUserId(userId);\n-        }\n+        // TODO: Handle null case\n+\n+        if (report != null) {\n+          report = report.withSessionEndFields(sessionEndTime, isHighPriorityReport, userId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97194f64c68451fdee0a00746086e4bc68a6f2"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjI4OTY4", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#pullrequestreview-376228968", "createdAt": "2020-03-17T16:59:59Z", "commit": {"oid": "8e97194f64c68451fdee0a00746086e4bc68a6f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjo1OTo1OVrOF3lhSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjo1OTo1OVrOF3lhSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgzMDczMQ==", "bodyText": "This didn't break any CrashlyticsController tests. Do we not mock reportingCoordinator in those tests to check it was called in unit?\n... one pattern I often see (and implement) is a TimeProvider interface that would do new Date().getTime() / 1000, what's nice about that pattern is then you could pass it in and mock it to make the tests not break (if they had)", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#discussion_r393830731", "createdAt": "2020-03-17T16:59:59Z", "author": {"login": "jakeouellette"}, "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/common/CrashlyticsController.java", "diffHunk": "@@ -860,7 +860,7 @@ private void doCloseSessions(int maxCustomExceptionEvents, boolean includeCurren\n \n     closeOpenSessions(sessionBeginFiles, offset, maxCustomExceptionEvents);\n \n-    reportingCoordinator.finalizeSessions();\n+    reportingCoordinator.finalizeSessions(new Date().getTime() / 1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97194f64c68451fdee0a00746086e4bc68a6f2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c539d567deea60c68c0b52e83b8cd6f75f2f0052", "author": {"user": {"login": "mrwillis21", "name": "Matt Willis"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/c539d567deea60c68c0b52e83b8cd6f75f2f0052", "committedDate": "2020-03-17T17:04:27Z", "message": "Fix up tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d7de2d2de8c2d1472bce57963365ef69167c588", "author": {"user": {"login": "mrwillis21", "name": "Matt Willis"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/6d7de2d2de8c2d1472bce57963365ef69167c588", "committedDate": "2020-03-17T17:30:12Z", "message": "Add helper method and make code more readable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjYxMjg0", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#pullrequestreview-376261284", "createdAt": "2020-03-17T17:39:13Z", "commit": {"oid": "6d7de2d2de8c2d1472bce57963365ef69167c588"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzozOToxNFrOF3nDPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzozOToxNFrOF3nDPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1NTgwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  isHighPriorityReport = isHighPriorityReport || isHighPriorityEventFile(eventFile.getName());\n          \n          \n            \n                  isHighPriorityReport |= isHighPriorityEventFile(eventFile.getName());", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#discussion_r393855805", "createdAt": "2020-03-17T17:39:14Z", "author": {"login": "jakeouellette"}, "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -270,6 +234,61 @@ private void capFinalizedReports() {\n         getAllFilesInDirectory(priorityReportsDirectory), getAllFilesInDirectory(reportsDirectory));\n   }\n \n+  private File getSessionDirectoryById(String sessionId) {\n+    return new File(openSessionsDirectory, sessionId);\n+  }\n+\n+  private void synthesizeReportFile(File sessionDirectory, long sessionEndTime) {\n+    final List<File> eventFiles =\n+        getFilesInDirectory(sessionDirectory, (f, name) -> name.startsWith(EVENT_FILE_NAME_PREFIX));\n+\n+    // Only process the session if it has associated events\n+    if (eventFiles.isEmpty()) {\n+      return;\n+    }\n+\n+    // TODO: Handle all nullable return values\n+\n+    Collections.sort(eventFiles);\n+    final List<Event> events = new ArrayList<>();\n+    boolean isHighPriorityReport = false;\n+    for (File eventFile : eventFiles) {\n+      final String eventJson = readTextFile(eventFile);\n+      if (eventJson == null) {\n+        // TODO: Handle null case\n+        continue;\n+      }\n+      final Event event = TRANSFORM.eventFromJson(eventJson);\n+      isHighPriorityReport = isHighPriorityReport || isHighPriorityEventFile(eventFile.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d7de2d2de8c2d1472bce57963365ef69167c588"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjYyMjE2", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#pullrequestreview-376262216", "createdAt": "2020-03-17T17:40:23Z", "commit": {"oid": "6d7de2d2de8c2d1472bce57963365ef69167c588"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo0MDoyM1rOF3nGCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo0MDoyM1rOF3nGCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1NjUyMA==", "bodyText": "which values are the return values in this comment?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#discussion_r393856520", "createdAt": "2020-03-17T17:40:23Z", "author": {"login": "jakeouellette"}, "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -270,6 +234,61 @@ private void capFinalizedReports() {\n         getAllFilesInDirectory(priorityReportsDirectory), getAllFilesInDirectory(reportsDirectory));\n   }\n \n+  private File getSessionDirectoryById(String sessionId) {\n+    return new File(openSessionsDirectory, sessionId);\n+  }\n+\n+  private void synthesizeReportFile(File sessionDirectory, long sessionEndTime) {\n+    final List<File> eventFiles =\n+        getFilesInDirectory(sessionDirectory, (f, name) -> name.startsWith(EVENT_FILE_NAME_PREFIX));\n+\n+    // Only process the session if it has associated events\n+    if (eventFiles.isEmpty()) {\n+      return;\n+    }\n+\n+    // TODO: Handle all nullable return values", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d7de2d2de8c2d1472bce57963365ef69167c588"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjYyNjI5", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#pullrequestreview-376262629", "createdAt": "2020-03-17T17:40:51Z", "commit": {"oid": "6d7de2d2de8c2d1472bce57963365ef69167c588"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo0MDo1MVrOF3nHUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNzo0MDo1MVrOF3nHUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg1Njg1MQ==", "bodyText": "is it worth pulling (f, name) -> name.startsWith(EVENT_FILE_NAME_PREFIX) into a static constant?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#discussion_r393856851", "createdAt": "2020-03-17T17:40:51Z", "author": {"login": "jakeouellette"}, "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -270,6 +234,61 @@ private void capFinalizedReports() {\n         getAllFilesInDirectory(priorityReportsDirectory), getAllFilesInDirectory(reportsDirectory));\n   }\n \n+  private File getSessionDirectoryById(String sessionId) {\n+    return new File(openSessionsDirectory, sessionId);\n+  }\n+\n+  private void synthesizeReportFile(File sessionDirectory, long sessionEndTime) {\n+    final List<File> eventFiles =\n+        getFilesInDirectory(sessionDirectory, (f, name) -> name.startsWith(EVENT_FILE_NAME_PREFIX));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d7de2d2de8c2d1472bce57963365ef69167c588"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d9fa10f98ffd81d8adc467a3f597d3d5aab731d", "author": {"user": {"login": "mrwillis21", "name": "Matt Willis"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/7d9fa10f98ffd81d8adc467a3f597d3d5aab731d", "committedDate": "2020-03-17T17:52:46Z", "message": "Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63baf8eecbe38406e24d32c887666dc25a30085e", "author": {"user": {"login": "mrwillis21", "name": "Matt Willis"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/63baf8eecbe38406e24d32c887666dc25a30085e", "committedDate": "2020-03-17T18:26:14Z", "message": "Clarify timestamp seconds handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MzAwOTI5", "url": "https://github.com/firebase/firebase-android-sdk/pull/1358#pullrequestreview-376300929", "createdAt": "2020-03-17T18:30:57Z", "commit": {"oid": "63baf8eecbe38406e24d32c887666dc25a30085e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2706, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}