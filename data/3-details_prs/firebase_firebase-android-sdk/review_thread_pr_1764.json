{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1NzYyMjUx", "number": 1764, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDozMjozOVrOEMSdGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMTowMTo0N1rOEMSwHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMzIwNzI4OnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/GetIdListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDozMjozOVrOGuUGDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDozMjozOVrOGuUGDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIxNjkxMA==", "bodyText": "This class needs some JavaDoc.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1764#discussion_r451216910", "createdAt": "2020-07-08T00:32:39Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/GetIdListener.java", "diffHunk": "@@ -0,0 +1,43 @@\n+// Copyright 2019 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations;\n+\n+import com.google.android.gms.tasks.TaskCompletionSource;\n+import com.google.firebase.installations.local.PersistedInstallationEntry;\n+\n+class GetIdListener implements StateListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d17d57045ad0e678e7eaeb26d7b75efce0284265"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMzIwODQxOnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/GetIdListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDozMzoxOFrOGuUGsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDozMzoxOFrOGuUGsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIxNzA3Mw==", "bodyText": "Maybe add a comment what are the other states the entry could be in?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1764#discussion_r451217073", "createdAt": "2020-07-08T00:33:18Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/GetIdListener.java", "diffHunk": "@@ -0,0 +1,43 @@\n+// Copyright 2019 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations;\n+\n+import com.google.android.gms.tasks.TaskCompletionSource;\n+import com.google.firebase.installations.local.PersistedInstallationEntry;\n+\n+class GetIdListener implements StateListener {\n+  final TaskCompletionSource<String> taskCompletionSource;\n+\n+  public GetIdListener(TaskCompletionSource<String> taskCompletionSource) {\n+    this.taskCompletionSource = taskCompletionSource;\n+  }\n+\n+  @Override\n+  public boolean onStateReached(PersistedInstallationEntry persistedInstallationEntry) {\n+    if (persistedInstallationEntry.isUnregistered()\n+        || persistedInstallationEntry.isRegistered()\n+        || persistedInstallationEntry.isErrored()) {\n+      taskCompletionSource.trySetResult(persistedInstallationEntry.getFirebaseInstallationId());\n+      return true;\n+    }\n+    return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d17d57045ad0e678e7eaeb26d7b75efce0284265"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMzI0MTEwOnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDo1Mjo1MFrOGuUaCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMzo1OTozM1rOGu9HGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMjAyNg==", "bodyText": "The way I read the code this does not only do \"registration\", but also auth token refresh.\nThus, I think the new name is misleading.\nHow about something that describes what is happening?\nHere is a suggestion, maybe you have a better idea.\ngetLocalDataOrSendRequestToFirebaseInstallationsApi()", "url": "https://github.com/firebase/firebase-android-sdk/pull/1764#discussion_r451222026", "createdAt": "2020-07-08T00:52:50Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -322,7 +341,8 @@ private String doGetId() {\n    * @param forceRefresh true if this is for a getAuthToken call and if the caller wants to fetch a\n    *     new auth token from the server even if an unexpired auth token exists on the client.\n    */\n-  private void doGetAuthToken(boolean forceRefresh) {\n+  private final void doRegistrationInternal(boolean forceRefresh) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d17d57045ad0e678e7eaeb26d7b75efce0284265"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMjE5OA==", "bodyText": "As a related question: Where do you decide which request to actually send, i.e. #CreateInstallation (\"registration\") or #GenerateAuthToken (\"refresh\")?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1764#discussion_r451222198", "createdAt": "2020-07-08T00:53:31Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -322,7 +341,8 @@ private String doGetId() {\n    * @param forceRefresh true if this is for a getAuthToken call and if the caller wants to fetch a\n    *     new auth token from the server even if an unexpired auth token exists on the client.\n    */\n-  private void doGetAuthToken(boolean forceRefresh) {\n+  private final void doRegistrationInternal(boolean forceRefresh) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMjAyNg=="}, "originalCommit": {"oid": "d17d57045ad0e678e7eaeb26d7b75efce0284265"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg4ODgxMQ==", "bodyText": "In the below method called doNetworkCallIfNecessary", "url": "https://github.com/firebase/firebase-android-sdk/pull/1764#discussion_r451888811", "createdAt": "2020-07-08T23:59:08Z", "author": {"login": "ankitaj224"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -322,7 +341,8 @@ private String doGetId() {\n    * @param forceRefresh true if this is for a getAuthToken call and if the caller wants to fetch a\n    *     new auth token from the server even if an unexpired auth token exists on the client.\n    */\n-  private void doGetAuthToken(boolean forceRefresh) {\n+  private final void doRegistrationInternal(boolean forceRefresh) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMjAyNg=="}, "originalCommit": {"oid": "d17d57045ad0e678e7eaeb26d7b75efce0284265"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg4ODkyMA==", "bodyText": "changed it to doRegistrationOrRefresh.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1764#discussion_r451888920", "createdAt": "2020-07-08T23:59:33Z", "author": {"login": "ankitaj224"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -322,7 +341,8 @@ private String doGetId() {\n    * @param forceRefresh true if this is for a getAuthToken call and if the caller wants to fetch a\n    *     new auth token from the server even if an unexpired auth token exists on the client.\n    */\n-  private void doGetAuthToken(boolean forceRefresh) {\n+  private final void doRegistrationInternal(boolean forceRefresh) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMjAyNg=="}, "originalCommit": {"oid": "d17d57045ad0e678e7eaeb26d7b75efce0284265"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMzI0NzI2OnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDo1NjoyOVrOGuUdmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDo1NjoyOVrOGuUdmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMjkzNg==", "bodyText": "What do we need these methods for?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1764#discussion_r451222936", "createdAt": "2020-07-08T00:56:29Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -300,17 +320,16 @@ private synchronized String getCacheFid() {\n     return cachedFid;\n   }\n \n-  private String doGetId() {\n+  private final void doGetAuthTokenForceRefresh() {\n+    doRegistrationInternal(true);\n+  }\n \n-    String fid = getCacheFid();\n-    if (fid != null) {\n-      return fid;\n-    }\n-    PersistedInstallationEntry prefs = getPrefsWithGeneratedIdMultiProcessSafe();\n-    // Execute network calls (CreateInstallations) to the FIS Servers on a separate executor\n-    // i.e networkExecutor\n-    networkExecutor.execute(() -> doNetworkCallIfNecessary(false));\n-    return prefs.getFirebaseInstallationId();\n+  private final void doGetAuthTokenWithoutForceRefresh() {\n+    doRegistrationInternal(false);\n+  }\n+\n+  private final void doGetId() {\n+    doRegistrationInternal(false);\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d17d57045ad0e678e7eaeb26d7b75efce0284265"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMzI1MTA5OnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDo1ODo1N1rOGuUf1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMDo1ODo1N1rOGuUf1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyMzUxMA==", "bodyText": "Can we prevent code duplication from method below?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1764#discussion_r451223510", "createdAt": "2020-07-08T00:58:57Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -256,6 +267,15 @@ String getName() {\n     return Tasks.call(backgroundExecutor, this::deleteFirebaseInstallationId);\n   }\n \n+  private Task<String> addGetIdListener() {\n+    TaskCompletionSource<String> taskCompletionSource = new TaskCompletionSource<>();\n+    StateListener l = new GetIdListener(taskCompletionSource);\n+    synchronized (lock) {\n+      listeners.add(l);\n+    }\n+    return taskCompletionSource.getTask();\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d17d57045ad0e678e7eaeb26d7b75efce0284265"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMzI1NTk3OnYy", "diffSide": "RIGHT", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMTowMTo0N1rOGuUiwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwMTowMTo0N1rOGuUiwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTIyNDI1Nw==", "bodyText": "How about we just call #doGetAuthToken directly (or the new name respectively).\nbackgroundExecutor.execute(() -> this::doGetAuthToken(forceRefresh));", "url": "https://github.com/firebase/firebase-android-sdk/pull/1764#discussion_r451224257", "createdAt": "2020-07-08T01:01:47Z", "author": {"login": "andirayo"}, "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -241,7 +248,11 @@ String getName() {\n   public Task<InstallationTokenResult> getToken(boolean forceRefresh) {\n     preConditionChecks();\n     Task<InstallationTokenResult> task = addGetAuthTokenListener();\n-    backgroundExecutor.execute(() -> doGetAuthToken(forceRefresh));\n+    if (forceRefresh) {\n+      backgroundExecutor.execute(this::doGetAuthTokenForceRefresh);\n+    } else {\n+      backgroundExecutor.execute(this::doGetAuthTokenWithoutForceRefresh);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d17d57045ad0e678e7eaeb26d7b75efce0284265"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1264, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}