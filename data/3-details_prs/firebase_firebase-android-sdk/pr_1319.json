{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NjAzNzc0", "number": 1319, "title": "Make binary size report format compatible with the metrics service.", "bodyText": "", "createdAt": "2020-03-06T02:36:03Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319", "merged": true, "mergeCommit": {"oid": "0c694bcead6d76329891e9b943774a65108ce51e"}, "closed": true, "closedAt": "2020-03-11T17:35:22Z", "author": {"login": "yifanyang"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcK6j11ABqjMxMDQyMDUwMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMXK53AFqTM3MjIzMzQxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a581e4ec8b6b6f6ccfcabed7c9f60d6975c57128", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/a581e4ec8b6b6f6ccfcabed7c9f60d6975c57128", "committedDate": "2020-03-06T00:43:03Z", "message": "Make binary size report format compatible with the metrics service."}, "afterCommit": {"oid": "8201b10cdafba8991f9481769c0a0906da73cb35", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/8201b10cdafba8991f9481769c0a0906da73cb35", "committedDate": "2020-03-06T06:58:38Z", "message": "Make binary size report format compatible with the metrics service."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8201b10cdafba8991f9481769c0a0906da73cb35", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/8201b10cdafba8991f9481769c0a0906da73cb35", "committedDate": "2020-03-06T06:58:38Z", "message": "Make binary size report format compatible with the metrics service."}, "afterCommit": {"oid": "5b26e6ae27a304e2723be896e90eb1da2085f21b", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/5b26e6ae27a304e2723be896e90eb1da2085f21b", "committedDate": "2020-03-06T07:48:25Z", "message": "Make binary size report compatible with the metrics service."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b26e6ae27a304e2723be896e90eb1da2085f21b", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/5b26e6ae27a304e2723be896e90eb1da2085f21b", "committedDate": "2020-03-06T07:48:25Z", "message": "Make binary size report compatible with the metrics service."}, "afterCommit": {"oid": "78cc9d13991e7af720452da7f7236a1f7d5163c6", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/78cc9d13991e7af720452da7f7236a1f7d5163c6", "committedDate": "2020-03-06T08:39:11Z", "message": "Make binary size report compatible with the metrics service."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "78cc9d13991e7af720452da7f7236a1f7d5163c6", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/78cc9d13991e7af720452da7f7236a1f7d5163c6", "committedDate": "2020-03-06T08:39:11Z", "message": "Make binary size report compatible with the metrics service."}, "afterCommit": {"oid": "23f526467ea719f0131d3ec251f89750818b639b", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/23f526467ea719f0131d3ec251f89750818b639b", "committedDate": "2020-03-06T10:15:20Z", "message": "Make binary size report compatible with the metrics service."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/9305ba085f7fc4ad695a651564c498dc95d32ec6", "committedDate": "2020-03-06T10:33:00Z", "message": "Make binary size report compatible with the metrics service."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23f526467ea719f0131d3ec251f89750818b639b", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/23f526467ea719f0131d3ec251f89750818b639b", "committedDate": "2020-03-06T10:15:20Z", "message": "Make binary size report compatible with the metrics service."}, "afterCommit": {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/9305ba085f7fc4ad695a651564c498dc95d32ec6", "committedDate": "2020-03-06T10:33:00Z", "message": "Make binary size report compatible with the metrics service."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTMxMjY2", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#pullrequestreview-370531266", "createdAt": "2020-03-06T18:22:39Z", "commit": {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTI4OTEx", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#pullrequestreview-370528911", "createdAt": "2020-03-06T18:18:45Z", "commit": {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxODoxODo0NVrOFzCnRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxODoyMzowOFrOFzCvWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NDUxOA==", "bodyText": "Reverse the logic to reduce nesting\nif (!system.getenv...) {\nproject.logger.quiet\nreturn ?\n} \n...\n\nthe continue with the rest of the code", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389064518", "createdAt": "2020-03-06T18:18:45Z", "author": {"login": "rlazo"}, "path": "buildSrc/src/main/groovy/com/google/firebase/gradle/plugins/measurement/MetricsReportUploader.groovy", "diffHunk": "@@ -0,0 +1,72 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.gradle.plugins.measurement\n+\n+import org.gradle.api.Project\n+\n+/** A helper class for uploading a metric report to the metrics service. */\n+class MetricsReportUploader {\n+    private static final def METRICS_SERVICE_URL = System.getenv(\"METRICS_SERVICE_URL\")\n+\n+    /** Uploads the given metric report .*/\n+    static void upload(Project project, String report) {\n+        if (!System.getenv().containsKey(\"FIREBASE_CI\")) {\n+            project.logger.quiet \"Metrics upload is enabled only on CI.\"\n+            return\n+        }\n+\n+        def owner = null\n+        def repo = null\n+        def baseCommit = null\n+        def headCommit = null\n+        def pullRequest = null\n+\n+        if (System.getenv().containsKey(\"PROW_JOB_ID\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NDg2Mw==", "bodyText": "this post happens even if the CI is not prow", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389064863", "createdAt": "2020-03-06T18:19:27Z", "author": {"login": "rlazo"}, "path": "buildSrc/src/main/groovy/com/google/firebase/gradle/plugins/measurement/MetricsReportUploader.groovy", "diffHunk": "@@ -0,0 +1,72 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.gradle.plugins.measurement\n+\n+import org.gradle.api.Project\n+\n+/** A helper class for uploading a metric report to the metrics service. */\n+class MetricsReportUploader {\n+    private static final def METRICS_SERVICE_URL = System.getenv(\"METRICS_SERVICE_URL\")\n+\n+    /** Uploads the given metric report .*/\n+    static void upload(Project project, String report) {\n+        if (!System.getenv().containsKey(\"FIREBASE_CI\")) {\n+            project.logger.quiet \"Metrics upload is enabled only on CI.\"\n+            return\n+        }\n+\n+        def owner = null\n+        def repo = null\n+        def baseCommit = null\n+        def headCommit = null\n+        def pullRequest = null\n+\n+        if (System.getenv().containsKey(\"PROW_JOB_ID\")) {\n+            project.logger.quiet \"Prow CI detected.\"\n+\n+            owner = System.getenv(\"REPO_OWNER\")\n+            repo = System.getenv(\"REPO_NAME\")\n+            baseCommit = System.getenv(\"PULL_BASE_SHA\")\n+            headCommit = System.getenv(\"PULL_PULL_SHA\") ?: baseCommit\n+            pullRequest = System.getenv(\"PULL_NUMBER\")\n+        } else {\n+            project.logger.quiet \"CI other than Prow is not supported currently.\"\n+        }\n+\n+        post(project, report, owner, repo, headCommit, baseCommit, pullRequest)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NTc1OA==", "bodyText": "I'm not 100% sure that relying in curl for this is the best option, but I'll not object it.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389065758", "createdAt": "2020-03-06T18:21:22Z", "author": {"login": "rlazo"}, "path": "buildSrc/src/main/groovy/com/google/firebase/gradle/plugins/measurement/MetricsReportUploader.groovy", "diffHunk": "@@ -0,0 +1,72 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.gradle.plugins.measurement\n+\n+import org.gradle.api.Project\n+\n+/** A helper class for uploading a metric report to the metrics service. */\n+class MetricsReportUploader {\n+    private static final def METRICS_SERVICE_URL = System.getenv(\"METRICS_SERVICE_URL\")\n+\n+    /** Uploads the given metric report .*/\n+    static void upload(Project project, String report) {\n+        if (!System.getenv().containsKey(\"FIREBASE_CI\")) {\n+            project.logger.quiet \"Metrics upload is enabled only on CI.\"\n+            return\n+        }\n+\n+        def owner = null\n+        def repo = null\n+        def baseCommit = null\n+        def headCommit = null\n+        def pullRequest = null\n+\n+        if (System.getenv().containsKey(\"PROW_JOB_ID\")) {\n+            project.logger.quiet \"Prow CI detected.\"\n+\n+            owner = System.getenv(\"REPO_OWNER\")\n+            repo = System.getenv(\"REPO_NAME\")\n+            baseCommit = System.getenv(\"PULL_BASE_SHA\")\n+            headCommit = System.getenv(\"PULL_PULL_SHA\") ?: baseCommit\n+            pullRequest = System.getenv(\"PULL_NUMBER\")\n+        } else {\n+            project.logger.quiet \"CI other than Prow is not supported currently.\"\n+        }\n+\n+        post(project, report, owner, repo, headCommit, baseCommit, pullRequest)\n+    }\n+\n+    private static void post(Project project, String report, String owner, String repo,\n+                             String commit, String baseCommit, String pullRequest) {\n+        def post = '-X POST'\n+        def headerAuth = '-H \"Authorization: Bearer $(gcloud auth print-identity-token)\"'\n+        def headerContentType = '-H \"Content-Type: application/json\"'\n+        def body = \"-d @${report}\"\n+\n+        def endpoint = \"${METRICS_SERVICE_URL}/repos/${owner}/${repo}/commits/${commit}/reports\"\n+        if (baseCommit && pullRequest) {\n+            endpoint += \"?base_commit=${baseCommit}&pull_request=${pullRequest}\"\n+        }\n+\n+        def request = \"curl ${post} ${headerAuth} ${headerContentType} ${body} \\\"${endpoint}\\\"\"\n+\n+        project.logger.quiet \"Making post request: ${request} ...\"\n+\n+        project.exec {\n+            commandLine 'bash', '-c', request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA2NjU4Nw==", "bodyText": "nit: generateCurrentLogLink sounds like a better fit since you are generating the url, but it's a matter of style.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#discussion_r389066587", "createdAt": "2020-03-06T18:23:08Z", "author": {"login": "rlazo"}, "path": "buildSrc/src/main/groovy/com/google/firebase/gradle/plugins/measurement/TestLogFinder.groovy", "diffHunk": "@@ -0,0 +1,48 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.gradle.plugins.measurement\n+\n+/** A utility class that finds test log links on different CI systems. */\n+class TestLogFinder {\n+\n+    /** Returns the link to the current running test. */\n+    static String getCurrentLogLink() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9305ba085f7fc4ad695a651564c498dc95d32ec6"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4dc97d78f1851ea3fb821a84e0517aecc93e743c", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/4dc97d78f1851ea3fb821a84e0517aecc93e743c", "committedDate": "2020-03-06T20:25:03Z", "message": "Rewrite newly added groovy files in java."}, "afterCommit": {"oid": "53c85666e29c72a01beb7fee7b84877c7551a2f0", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/53c85666e29c72a01beb7fee7b84877c7551a2f0", "committedDate": "2020-03-06T20:28:05Z", "message": "Rewrite newly added groovy files in java."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53c85666e29c72a01beb7fee7b84877c7551a2f0", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/53c85666e29c72a01beb7fee7b84877c7551a2f0", "committedDate": "2020-03-06T20:28:05Z", "message": "Rewrite newly added groovy files in java."}, "afterCommit": {"oid": "a70552cba5d7f62fc6b0b26185aa280fae088d16", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/a70552cba5d7f62fc6b0b26185aa280fae088d16", "committedDate": "2020-03-06T20:39:46Z", "message": "Rewrite newly added groovy files in java."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a70552cba5d7f62fc6b0b26185aa280fae088d16", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/a70552cba5d7f62fc6b0b26185aa280fae088d16", "committedDate": "2020-03-06T20:39:46Z", "message": "Rewrite newly added groovy files in java."}, "afterCommit": {"oid": "b97d05f686aec8bbb1413eb647ccdfd709f0cebe", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/b97d05f686aec8bbb1413eb647ccdfd709f0cebe", "committedDate": "2020-03-09T19:02:44Z", "message": "Rewrite newly added groovy files in java."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8b422ac8ee62908eff778bc3db6567557cdc152", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/e8b422ac8ee62908eff778bc3db6567557cdc152", "committedDate": "2020-03-09T19:27:16Z", "message": "Rewrite newly added groovy files in java."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b97d05f686aec8bbb1413eb647ccdfd709f0cebe", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/b97d05f686aec8bbb1413eb647ccdfd709f0cebe", "committedDate": "2020-03-09T19:02:44Z", "message": "Rewrite newly added groovy files in java."}, "afterCommit": {"oid": "e8b422ac8ee62908eff778bc3db6567557cdc152", "author": {"user": {"login": "yifanyang", "name": "Yifan Yang"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/e8b422ac8ee62908eff778bc3db6567557cdc152", "committedDate": "2020-03-09T19:27:16Z", "message": "Rewrite newly added groovy files in java."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjMzNDE2", "url": "https://github.com/firebase/firebase-android-sdk/pull/1319#pullrequestreview-372233416", "createdAt": "2020-03-10T18:52:54Z", "commit": {"oid": "e8b422ac8ee62908eff778bc3db6567557cdc152"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2143, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}