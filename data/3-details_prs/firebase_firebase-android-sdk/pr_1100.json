{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMjM5NjAw", "number": 1100, "title": "Get the IID token before fetching Remote Config.", "bodyText": "Remote Config requires an IID token to evaluate certain conditions, but does not currently wait for the token from FirebaseInstanceId#getToken() before fetching. This returns the default condition value in some cases (ex. percentage conditions) rather than the evaluated result for an app instance.\nThis change replaces the use of the deprecated #getToken() with #getInstanceId(), which returns an async Task we can wait to complete before fetching, without otherwise blocking.", "createdAt": "2020-01-08T01:12:34Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100", "merged": true, "mergeCommit": {"oid": "2d3b7c25070d21f2058c5471c1831f7d8ac065fd"}, "closed": true, "closedAt": "2020-01-16T21:31:40Z", "author": {"login": "danasilver"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4JPr5AH2gAyMzYwMjM5NjAwOjYyYzUwZDllOTQxNzBkMTMzZTA1OTI3ODJmZjhhYzMwNDFkYTk5NTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7Avw_AH2gAyMzYwMjM5NjAwOjEyMTM0ZWMwNGE2NDhjM2IwODc0OTE5ODA1ODI2MjIxMWY3YzdjMzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62c50d9e94170d133e0592782ff8ac3041da9955", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/62c50d9e94170d133e0592782ff8ac3041da9955", "committedDate": "2020-01-07T23:20:58Z", "message": "Get IID token before fetching Remote Config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3302f7b82d98ec8c297c4c319fc01a874b5556f8", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/3302f7b82d98ec8c297c4c319fc01a874b5556f8", "committedDate": "2020-01-07T23:38:18Z", "message": "Revert log line in fetch request."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c998b982d68ed95804e5de9f13b89f25ed9c22b2", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/c998b982d68ed95804e5de9f13b89f25ed9c22b2", "committedDate": "2020-01-07T23:39:17Z", "message": "Remove whitespace."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c6e81d950bd31898b4fee60e0910bc3d0a3eff7", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/6c6e81d950bd31898b4fee60e0910bc3d0a3eff7", "committedDate": "2020-01-08T01:20:15Z", "message": "Add copyright to new file."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8f519be43eb9c9acfe0a09276ef76e4188631a0", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/a8f519be43eb9c9acfe0a09276ef76e4188631a0", "committedDate": "2020-01-08T19:28:12Z", "message": "Run googleJavaFormat."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8db94c581e13b8659b11a4e266546803cda116ea", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/8db94c581e13b8659b11a4e266546803cda116ea", "committedDate": "2020-01-09T00:54:55Z", "message": "Add getInstanceId() call to ensureInitialized()."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjM4NTYz", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#pullrequestreview-340238563", "createdAt": "2020-01-09T01:02:52Z", "commit": {"oid": "8db94c581e13b8659b11a4e266546803cda116ea"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMTowMjo1MlrOFboZWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMTowNToxMVrOFbobKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxNzcyMQ==", "bodyText": "nit: preserve order?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364517721", "createdAt": "2020-01-09T01:02:52Z", "author": {"login": "clp93"}, "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/FirebaseRemoteConfigTest.java", "diffHunk": "@@ -196,6 +205,7 @@ public void setUp() throws Exception {\n   public void ensureInitialized_notInitialized_isNotComplete() {\n     loadCacheWithConfig(mockFetchedCache, /*container=*/ null);\n     loadCacheWithConfig(mockDefaultsCache, /*container=*/ null);\n+    when(mockFirebaseInstanceId.getInstanceId()).thenReturn(Tasks.forResult(INSTANCE_ID_RESULT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db94c581e13b8659b11a4e266546803cda116ea"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxODE4Ng==", "bodyText": "in previous android changes tests, we have used methods like loadInstanceIdAndToken() (which you changed below). WDYT about doing something similar in this file? It does make it slightly more readable, but at this point, i'm just infavor of consistency :)  https://osscs.corp.google.com/firebase/firebase-android-sdk/+/master:firebase-config/src/test/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandlerTest.java;l=868-871;drc=5301121df4727b357293b3b7de00555362f90170", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364518186", "createdAt": "2020-01-09T01:05:11Z", "author": {"login": "clp93"}, "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/FirebaseRemoteConfigTest.java", "diffHunk": "@@ -196,6 +205,7 @@ public void setUp() throws Exception {\n   public void ensureInitialized_notInitialized_isNotComplete() {\n     loadCacheWithConfig(mockFetchedCache, /*container=*/ null);\n     loadCacheWithConfig(mockDefaultsCache, /*container=*/ null);\n+    when(mockFirebaseInstanceId.getInstanceId()).thenReturn(Tasks.forResult(INSTANCE_ID_RESULT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db94c581e13b8659b11a4e266546803cda116ea"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjY0MzUz", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#pullrequestreview-340264353", "createdAt": "2020-01-09T02:51:35Z", "commit": {"oid": "8db94c581e13b8659b11a4e266546803cda116ea"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMjo1MTozNVrOFbpsWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMzowMDo1MVrOFbpzCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUzODk2OA==", "bodyText": "Thinking out loud: this warms the cache", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364538968", "createdAt": "2020-01-09T02:51:35Z", "author": {"login": "erikeldridge"}, "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/FirebaseRemoteConfig.java", "diffHunk": "@@ -186,9 +191,14 @@ public static FirebaseRemoteConfig getInstance(@NonNull FirebaseApp app) {\n     Task<ConfigContainer> defaultsConfigsTask = defaultConfigsCache.get();\n     Task<ConfigContainer> fetchedConfigsTask = fetchedConfigsCache.get();\n     Task<FirebaseRemoteConfigInfo> metadataTask = Tasks.call(executor, this::getInfo);\n+    Task<InstanceIdResult> instanceIdTask = firebaseInstanceId.getInstanceId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db94c581e13b8659b11a4e266546803cda116ea"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUzOTQzNw==", "bodyText": "Thinking out loud: the instance ID can change any time, so it's good we're loading it from the IID SDK before each fetch, ie as opposed to caching the ID", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364539437", "createdAt": "2020-01-09T02:54:11Z", "author": {"login": "erikeldridge"}, "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandler.java", "diffHunk": "@@ -188,7 +189,21 @@ public ConfigFetchHandler(\n                   createThrottledMessage(backoffEndTime.getTime() - currentTime.getTime()),\n                   backoffEndTime.getTime()));\n     } else {\n-      fetchResponseTask = fetchFromBackendAndCacheResponse(currentTime);\n+      Task<InstanceIdResult> instanceIdTask = firebaseInstanceId.getInstanceId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db94c581e13b8659b11a4e266546803cda116ea"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU0MDA0Nw==", "bodyText": "I'm wondering if completedIidTask is passed in as a thread-safe reference, since this is an async operation. Seems easy enough to just use it, eg completedIidTask.isSuccessful().\nMinor: if it's fine to reference instanceIdTask and completedIidTask is unused, we could indicate that's intentional in the name, eg completedIidTask --> unusedTask.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364540047", "createdAt": "2020-01-09T02:57:20Z", "author": {"login": "erikeldridge"}, "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandler.java", "diffHunk": "@@ -188,7 +189,21 @@ public ConfigFetchHandler(\n                   createThrottledMessage(backoffEndTime.getTime() - currentTime.getTime()),\n                   backoffEndTime.getTime()));\n     } else {\n-      fetchResponseTask = fetchFromBackendAndCacheResponse(currentTime);\n+      Task<InstanceIdResult> instanceIdTask = firebaseInstanceId.getInstanceId();\n+      fetchResponseTask =\n+          instanceIdTask.continueWithTask(\n+              executor,\n+              (completedIidTask) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db94c581e13b8659b11a4e266546803cda116ea"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU0MDY4MA==", "bodyText": "Thinking out loud: this continues to be an instance var. Weird how it has getInstanceId and getId methods.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364540680", "createdAt": "2020-01-09T03:00:51Z", "author": {"login": "erikeldridge"}, "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandler.java", "diffHunk": "@@ -270,15 +286,16 @@ private String createThrottledMessage(long throttledDurationInMillis) {\n    *     error connecting to the server.\n    */\n   @WorkerThread\n-  private FetchResponse fetchFromBackend(Date currentTime) throws FirebaseRemoteConfigException {\n+  private FetchResponse fetchFromBackend(InstanceIdResult instanceId, Date currentTime)\n+      throws FirebaseRemoteConfigException {\n     try {\n       HttpURLConnection urlConnection = frcBackendApiClient.createHttpURLConnection();\n \n       FetchResponse response =\n           frcBackendApiClient.fetch(\n               urlConnection,\n-              firebaseInstanceId.getId(),\n-              firebaseInstanceId.getToken(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8db94c581e13b8659b11a4e266546803cda116ea"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b729eb183bf3970c8dd156677c3912950be98bdc", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/b729eb183bf3970c8dd156677c3912950be98bdc", "committedDate": "2020-01-09T18:41:21Z", "message": "Add iid to kotlin and re-order iid in RC constructor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55ce968c9c67ae5841a37d2a27d2a5dbf098fb89", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/55ce968c9c67ae5841a37d2a27d2a5dbf098fb89", "committedDate": "2020-01-09T20:15:50Z", "message": "Fix ktx test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f27393f95c3fe19d01931b200042e12f52d2a64a", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/f27393f95c3fe19d01931b200042e12f52d2a64a", "committedDate": "2020-01-09T21:08:50Z", "message": "Updates in response to review feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MTA0NzU1", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#pullrequestreview-344104755", "createdAt": "2020-01-16T17:55:50Z", "commit": {"oid": "f27393f95c3fe19d01931b200042e12f52d2a64a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MTc1NDc4", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#pullrequestreview-344175478", "createdAt": "2020-01-16T19:54:18Z", "commit": {"oid": "f27393f95c3fe19d01931b200042e12f52d2a64a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxOTo1NDoxOFrOFelquw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxOTo1NDoxOFrOFelquw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzYxODc0Nw==", "bodyText": "nit: just grab the exception from the callback arg", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r367618747", "createdAt": "2020-01-16T19:54:18Z", "author": {"login": "ciarand"}, "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandler.java", "diffHunk": "@@ -188,7 +189,21 @@ public ConfigFetchHandler(\n                   createThrottledMessage(backoffEndTime.getTime() - currentTime.getTime()),\n                   backoffEndTime.getTime()));\n     } else {\n-      fetchResponseTask = fetchFromBackendAndCacheResponse(currentTime);\n+      Task<InstanceIdResult> instanceIdTask = firebaseInstanceId.getInstanceId();\n+      fetchResponseTask =\n+          instanceIdTask.continueWithTask(\n+              executor,\n+              (completedIidTask) -> {\n+                if (!completedIidTask.isSuccessful()) {\n+                  return Tasks.forException(\n+                      new FirebaseRemoteConfigClientException(\n+                          \"Failed to get Firebase Instance ID token for fetch.\",\n+                          instanceIdTask.getException()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f27393f95c3fe19d01931b200042e12f52d2a64a"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12134ec04a648c3b08749198058262211f7c7c37", "author": {"user": {"login": "danasilver", "name": "Dana Silver"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/12134ec04a648c3b08749198058262211f7c7c37", "committedDate": "2020-01-16T21:08:38Z", "message": "Use completed task for IID token exception."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2208, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}