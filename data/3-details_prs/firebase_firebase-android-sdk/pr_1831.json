{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NTk3MDc2", "number": 1831, "title": "Add platform logging", "bodyText": "", "createdAt": "2020-07-29T18:05:17Z", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831", "merged": true, "mergeCommit": {"oid": "dbef46c49e927ebe60b82f4a0c8d9356fa6fd6a6"}, "closed": true, "closedAt": "2020-11-25T17:36:53Z", "author": {"login": "VinayGuthal"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5FqF6AH2gAyNDU4NTk3MDc2OmI3OGI0ZWRmYTFiNDU1YWM0Nzc5YzY0MDJlMTBhMDkyY2M1YzEwM2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfvmBEgH2gAyNDU4NTk3MDc2OmZkNmVkMjU4OTFkMzM5NzkyYjM5M2NjZGQ3NzFlNTVmMmZhODAwNWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b78b4edfa1b455ac4779c6402e10a092cc5c103d", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/b78b4edfa1b455ac4779c6402e10a092cc5c103d", "committedDate": "2020-07-27T17:55:16Z", "message": "heart beat info storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f6e2d94627a4e95c8b611ab1a3c2d705c7e2776", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/8f6e2d94627a4e95c8b611ab1a3c2d705c7e2776", "committedDate": "2020-07-29T18:04:07Z", "message": "added heartbeat info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6daab382882ee8977c42b6f81319dcb4a1683f4b", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/6daab382882ee8977c42b6f81319dcb4a1683f4b", "committedDate": "2020-07-29T18:24:10Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1be078808833fad15aadc6d9e89ce328a258eea", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/c1be078808833fad15aadc6d9e89ce328a258eea", "committedDate": "2020-07-30T18:11:03Z", "message": "add platform logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84e0ab773da68e36c2135bfe687c1f328e834c48", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/84e0ab773da68e36c2135bfe687c1f328e834c48", "committedDate": "2020-07-31T18:23:43Z", "message": "add tests for platform logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d621b58c74b80dc81230e468b09709629938a4b1", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/d621b58c74b80dc81230e468b09709629938a4b1", "committedDate": "2020-07-31T19:14:16Z", "message": "add docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "985104911bacbed0ffd14ce4b284386804dff2d9", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/985104911bacbed0ffd14ce4b284386804dff2d9", "committedDate": "2020-07-31T19:29:29Z", "message": "gjf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dd4641cf9c2a447937b1e8d4853e88494fa8b61", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/6dd4641cf9c2a447937b1e8d4853e88494fa8b61", "committedDate": "2020-08-05T17:45:31Z", "message": "default heartbeat info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e866390567718c432d00d857657ba413b6045a06", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/e866390567718c432d00d857657ba413b6045a06", "committedDate": "2020-08-05T18:15:24Z", "message": "test changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a207831bf669775ede223af7041176ef753aa6fa", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/a207831bf669775ede223af7041176ef753aa6fa", "committedDate": "2020-08-13T18:19:31Z", "message": "add calendar day storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bc1fecd256a7b96dfe4790687863c3dfa56afd6", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/2bc1fecd256a7b96dfe4790687863c3dfa56afd6", "committedDate": "2020-08-13T18:32:56Z", "message": "fix heart beat info storage test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/7d2e9477fd845d1d961113d02c7831a299c2e0e7", "committedDate": "2020-08-18T17:21:01Z", "message": "add log source"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NjcyMzUy", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#pullrequestreview-469672352", "createdAt": "2020-08-18T17:27:50Z", "commit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzoyNzo1MVrOHCevKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzozOTo0MFrOHCfLcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM2Mjc5Mg==", "bodyText": "To me it sounds like a \"consumer\" rather than a logSource, I would suggest you rename it to HeartBeatConsumer.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r472362792", "createdAt": "2020-08-18T17:27:51Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatLogSource.java", "diffHunk": "@@ -0,0 +1,29 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.heartbeatinfo;\n+\n+import com.google.auto.value.AutoValue;\n+import javax.annotation.Nonnull;\n+\n+/** The class is not public to ensure other components cannot depend on it. */\n+@AutoValue\n+abstract class HeartBeatLogSource {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM2Mzk2Nw==", "bodyText": "Additionally it could be just an empty interface rather than a class(you would have to make it public in this case).", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r472363967", "createdAt": "2020-08-18T17:29:55Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatLogSource.java", "diffHunk": "@@ -0,0 +1,29 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.heartbeatinfo;\n+\n+import com.google.auto.value.AutoValue;\n+import javax.annotation.Nonnull;\n+\n+/** The class is not public to ensure other components cannot depend on it. */\n+@AutoValue\n+abstract class HeartBeatLogSource {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM2Mjc5Mg=="}, "originalCommit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM2NDEzOA==", "bodyText": "this value is not used anywhere, consider removing altogether.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r472364138", "createdAt": "2020-08-18T17:30:12Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatLogSource.java", "diffHunk": "@@ -0,0 +1,29 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.heartbeatinfo;\n+\n+import com.google.auto.value.AutoValue;\n+import javax.annotation.Nonnull;\n+\n+/** The class is not public to ensure other components cannot depend on it. */\n+@AutoValue\n+abstract class HeartBeatLogSource {\n+  static HeartBeatLogSource create(String name) {\n+    return new AutoValue_HeartBeatLogSource(name);\n+  }\n+\n+  @Nonnull\n+  public abstract String getLogSourceName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3MDAzNA==", "bodyText": "pls change the javadocs in this class", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r472370034", "createdAt": "2020-08-18T17:39:40Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatLogSourceComponent.java", "diffHunk": "@@ -0,0 +1,27 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.heartbeatinfo;\n+\n+import com.google.firebase.components.Component;\n+\n+/** Factory to create a component that publishes the version of an SDK */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5Njg2Nzc4", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#pullrequestreview-469686778", "createdAt": "2020-08-18T17:45:02Z", "commit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzo0NTowMlrOHCfYHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzo0NTowMlrOHCfYHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3MzI3Ng==", "bodyText": "you may want to hold on to the set and check if it's empty every time, this will make it future proof for when we add support for dynamic loading.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r472373276", "createdAt": "2020-08-18T17:45:02Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -20,20 +20,27 @@\n import androidx.annotation.VisibleForTesting;\n import com.google.firebase.components.Component;\n import com.google.firebase.components.Dependency;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n \n /** Provides information as whether to send heart beat or not. */\n public class DefaultHeartBeatInfo implements HeartBeatInfo {\n \n   private HeartBeatInfoStorage storage;\n \n-  private DefaultHeartBeatInfo(Context context) {\n+  private boolean doesSourceExist;\n+\n+  private DefaultHeartBeatInfo(Context context, Set<HeartBeatLogSource> logSources) {\n     storage = HeartBeatInfoStorage.getInstance(context);\n+    doesSourceExist = (logSources.size() > 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5Njg3ODM3", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#pullrequestreview-469687837", "createdAt": "2020-08-18T17:46:31Z", "commit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzo0NjozMVrOHCfbSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzo0NjozMVrOHCfbSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3NDA4OQ==", "bodyText": "nit: delegate to the other constructor to avoid logic duplication.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                storage = HeartBeatInfoStorage.getInstance(context);\n          \n          \n            \n                doesSourceExist = (logSources.size() > 0);\n          \n          \n            \n                this(HeartBeatInfoStorage.getInstance(context), doesSourceExist = (logSources.size() > 0));", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r472374089", "createdAt": "2020-08-18T17:46:31Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -20,20 +20,27 @@\n import androidx.annotation.VisibleForTesting;\n import com.google.firebase.components.Component;\n import com.google.firebase.components.Dependency;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n \n /** Provides information as whether to send heart beat or not. */\n public class DefaultHeartBeatInfo implements HeartBeatInfo {\n \n   private HeartBeatInfoStorage storage;\n \n-  private DefaultHeartBeatInfo(Context context) {\n+  private boolean doesSourceExist;\n+\n+  private DefaultHeartBeatInfo(Context context, Set<HeartBeatLogSource> logSources) {\n     storage = HeartBeatInfoStorage.getInstance(context);\n+    doesSourceExist = (logSources.size() > 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d2e9477fd845d1d961113d02c7831a299c2e0e7"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b08f54e2fa63782606f8b1c5ae93178c8b4cdca", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/6b08f54e2fa63782606f8b1c5ae93178c8b4cdca", "committedDate": "2020-08-18T18:04:14Z", "message": "platform logging update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6bdea8e0bacc99389b601397001a4c722ae30c0", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/e6bdea8e0bacc99389b601397001a4c722ae30c0", "committedDate": "2020-08-18T18:37:23Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd57fe9b538769c958d76bcdff4e8d02efffbb8d", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/cd57fe9b538769c958d76bcdff4e8d02efffbb8d", "committedDate": "2020-09-15T01:53:37Z", "message": "make it a task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cd7aca65d67b09905858e5665c68c6274a8d9c0", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/1cd7aca65d67b09905858e5665c68c6274a8d9c0", "committedDate": "2020-09-15T01:57:09Z", "message": "Merge branch 'master' into add_platform_logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "513e894b414a78b945720a8f971f36ba826e0d2d", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/513e894b414a78b945720a8f971f36ba826e0d2d", "committedDate": "2020-09-15T14:10:49Z", "message": "android manifest update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "303ef7a223808bdc6f1249032d1446cff851bd30", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/303ef7a223808bdc6f1249032d1446cff851bd30", "committedDate": "2020-09-15T14:17:33Z", "message": "update common gradle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NzcxNDkx", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#pullrequestreview-488771491", "createdAt": "2020-09-15T14:54:15Z", "commit": {"oid": "303ef7a223808bdc6f1249032d1446cff851bd30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNDo1NDoxNVrOHSF7bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNDo1NDoxNVrOHSF7bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODczMzU0OA==", "bodyText": "iiuc you just wrapped the result in a Task but did not actually make it asynchronous, so it will block anyway.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488733548", "createdAt": "2020-09-15T14:54:15Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -51,10 +60,59 @@ private DefaultHeartBeatInfo(Context context) {\n     return HeartBeat.NONE;\n   }\n \n+  @Override\n+  public Task<List<HeartBeatResult>> getAndClearStoredHeartBeatInfo() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "303ef7a223808bdc6f1249032d1446cff851bd30"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f903248c10f91294f159300b69d3005c69cf481c", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/f903248c10f91294f159300b69d3005c69cf481c", "committedDate": "2020-09-15T17:04:58Z", "message": "run in an executor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/88ae2536e482d8ac0ab05e7c979cb88693064834", "committedDate": "2020-09-15T17:07:37Z", "message": "revert gradle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4ODk4NzI5", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#pullrequestreview-488898729", "createdAt": "2020-09-15T17:18:15Z", "commit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNzoxODoxNVrOHSL6Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNzo1MTo1NVrOHSNcsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzMTUzNQ==", "bodyText": "why do use a counter if the thread pool has at most one thread?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488831535", "createdAt": "2020-09-15T17:18:15Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -18,22 +18,57 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.RestrictTo;\n import androidx.annotation.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.TaskCompletionSource;\n import com.google.firebase.components.Component;\n import com.google.firebase.components.Dependency;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /** Provides information as whether to send heart beat or not. */\n public class DefaultHeartBeatInfo implements HeartBeatInfo {\n \n   private HeartBeatInfoStorage storage;\n \n-  private DefaultHeartBeatInfo(Context context) {\n+  private Set<HeartBeatConsumer> consumers;\n+\n+  private ExecutorService backgroundExecutor;\n+\n+  private static final ThreadFactory THREAD_FACTORY =\n+      new ThreadFactory() {\n+        private final AtomicInteger mCount = new AtomicInteger(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzMTgyOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private HeartBeatInfoStorage storage;\n          \n          \n            \n              private final HeartBeatInfoStorage storage;\n          \n      \n    \n    \n  \n\nhere and throughout", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488831828", "createdAt": "2020-09-15T17:18:46Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -18,22 +18,57 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.RestrictTo;\n import androidx.annotation.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.TaskCompletionSource;\n import com.google.firebase.components.Component;\n import com.google.firebase.components.Dependency;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /** Provides information as whether to send heart beat or not. */\n public class DefaultHeartBeatInfo implements HeartBeatInfo {\n \n   private HeartBeatInfoStorage storage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzMjU0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private ExecutorService backgroundExecutor;\n          \n          \n            \n              private Executor backgroundExecutor;\n          \n      \n    \n    \n  \n\nsince you only use the execute() method", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488832542", "createdAt": "2020-09-15T17:20:00Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -18,22 +18,57 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.RestrictTo;\n import androidx.annotation.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.TaskCompletionSource;\n import com.google.firebase.components.Component;\n import com.google.firebase.components.Dependency;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /** Provides information as whether to send heart beat or not. */\n public class DefaultHeartBeatInfo implements HeartBeatInfo {\n \n   private HeartBeatInfoStorage storage;\n \n-  private DefaultHeartBeatInfo(Context context) {\n+  private Set<HeartBeatConsumer> consumers;\n+\n+  private ExecutorService backgroundExecutor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzMzM4Mg==", "bodyText": "pls have this constructor delegate to the one below", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488833382", "createdAt": "2020-09-15T17:20:53Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -18,22 +18,57 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.RestrictTo;\n import androidx.annotation.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.TaskCompletionSource;\n import com.google.firebase.components.Component;\n import com.google.firebase.components.Dependency;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicInteger;\n \n /** Provides information as whether to send heart beat or not. */\n public class DefaultHeartBeatInfo implements HeartBeatInfo {\n \n   private HeartBeatInfoStorage storage;\n \n-  private DefaultHeartBeatInfo(Context context) {\n+  private Set<HeartBeatConsumer> consumers;\n+\n+  private ExecutorService backgroundExecutor;\n+\n+  private static final ThreadFactory THREAD_FACTORY =\n+      new ThreadFactory() {\n+        private final AtomicInteger mCount = new AtomicInteger(1);\n+\n+        @Override\n+        public Thread newThread(Runnable r) {\n+          return new Thread(\n+              r, String.format(\"heartbeat-information-executor-%d\", mCount.getAndIncrement()));\n+        }\n+      };\n+\n+  private DefaultHeartBeatInfo(Context context, Set<HeartBeatConsumer> consumers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzNDM2OA==", "bodyText": "if you don't need the indexes, pls use for(Result result: sdkHeartBeatResults)", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488834368", "createdAt": "2020-09-15T17:21:51Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -51,10 +86,69 @@ private DefaultHeartBeatInfo(Context context) {\n     return HeartBeat.NONE;\n   }\n \n+  @Override\n+  public Task<List<HeartBeatResult>> getAndClearStoredHeartBeatInfo() {\n+    TaskCompletionSource<List<HeartBeatResult>> taskCompletionSource = new TaskCompletionSource<>();\n+    this.backgroundExecutor.execute(\n+        () -> {\n+          ArrayList<HeartBeatResult> heartBeatResults = new ArrayList<>();\n+          boolean shouldSendGlobalHeartBeat = false;\n+          List<SdkHeartBeatResult> sdkHeartBeatResults = storage.getStoredHeartBeats(true);\n+          long lastGlobalHeartBeat = storage.getLastGlobalHeartBeat();\n+          for (int i = 0; i < sdkHeartBeatResults.size(); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1NDUxMg==", "bodyText": "Even though Tasks.call() is deprecated I suggest you use it as it makes sure that the task actually completes in the face of exceptions and errors, i.e. see b/157690112 for how tasks can hang indefinitely if an exception happens.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488854512", "createdAt": "2020-09-15T17:48:09Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -51,10 +86,69 @@ private DefaultHeartBeatInfo(Context context) {\n     return HeartBeat.NONE;\n   }\n \n+  @Override\n+  public Task<List<HeartBeatResult>> getAndClearStoredHeartBeatInfo() {\n+    TaskCompletionSource<List<HeartBeatResult>> taskCompletionSource = new TaskCompletionSource<>();\n+    this.backgroundExecutor.execute(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1NDkxMA==", "bodyText": "use Tasks.forResult(true) ?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488854910", "createdAt": "2020-09-15T17:48:52Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -51,10 +86,69 @@ private DefaultHeartBeatInfo(Context context) {\n     return HeartBeat.NONE;\n   }\n \n+  @Override\n+  public Task<List<HeartBeatResult>> getAndClearStoredHeartBeatInfo() {\n+    TaskCompletionSource<List<HeartBeatResult>> taskCompletionSource = new TaskCompletionSource<>();\n+    this.backgroundExecutor.execute(\n+        () -> {\n+          ArrayList<HeartBeatResult> heartBeatResults = new ArrayList<>();\n+          boolean shouldSendGlobalHeartBeat = false;\n+          List<SdkHeartBeatResult> sdkHeartBeatResults = storage.getStoredHeartBeats(true);\n+          long lastGlobalHeartBeat = storage.getLastGlobalHeartBeat();\n+          for (int i = 0; i < sdkHeartBeatResults.size(); i++) {\n+            SdkHeartBeatResult sdkHeartBeatResult = sdkHeartBeatResults.get(i);\n+            HeartBeat heartBeat;\n+            shouldSendGlobalHeartBeat =\n+                storage.isValidHeartBeat(lastGlobalHeartBeat, sdkHeartBeatResult.getMillis());\n+            if (shouldSendGlobalHeartBeat) {\n+              heartBeat = HeartBeat.COMBINED;\n+            } else {\n+              heartBeat = HeartBeat.SDK;\n+            }\n+            if (shouldSendGlobalHeartBeat) {\n+              lastGlobalHeartBeat = sdkHeartBeatResult.getMillis();\n+            }\n+            heartBeatResults.add(\n+                HeartBeatResult.create(\n+                    sdkHeartBeatResult.getSdkName(), sdkHeartBeatResult.getMillis(), heartBeat));\n+          }\n+          if (lastGlobalHeartBeat > 0) {\n+            storage.updateGlobalHeartBeat(lastGlobalHeartBeat);\n+          }\n+          taskCompletionSource.setResult(heartBeatResults);\n+        });\n+    return taskCompletionSource.getTask();\n+  }\n+\n+  @Override\n+  public Task storeHeartBeatInfo(@NonNull String heartBeatTag) {\n+    TaskCompletionSource<Boolean> taskCompletionSource = new TaskCompletionSource<>();\n+    if (consumers.size() <= 0) {\n+      taskCompletionSource.setResult(true);\n+      return taskCompletionSource.getTask();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1NTc3Nw==", "bodyText": "why is it a raw Task? should it be Task<Boolean>? also consider renaming the method to something like shouldStoreHeardBeatInfo()", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488855777", "createdAt": "2020-09-15T17:50:16Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatInfo.java", "diffHunk": "@@ -44,4 +49,10 @@ public int getCode() {\n \n   @NonNull\n   HeartBeat getHeartBeatCode(@NonNull String heartBeatTag);\n+\n+  @NonNull\n+  Task storeHeartBeatInfo(@NonNull String heartBeatTag);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1Njc1NQ==", "bodyText": "I wonder what will happen if the device changes timezone, can we use utc here? Additionally getDate() seems deprecated.\nAlso is it possible that the date is the same but the month is different?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r488856755", "createdAt": "2020-09-15T17:51:55Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatInfoStorage.java", "diffHunk": "@@ -50,15 +74,63 @@ static synchronized HeartBeatInfoStorage getInstance(Context applicationContext)\n     return instance;\n   }\n \n+  synchronized void storeHeartBeatInformation(String heartBeatTag, long millis) {\n+    this.heartBeatSharedPreferences.edit().putString(String.valueOf(millis), heartBeatTag).apply();\n+    this.heartBeatCount += 1;\n+    if (this.heartBeatCount > HEART_BEAT_COUNT_LIMIT) {\n+      this.cleanUpStoredHeartBeats();\n+    }\n+  }\n+\n+  private synchronized void cleanUpStoredHeartBeats() {\n+    ArrayList<Long> timestampList = new ArrayList<>();\n+    for (Map.Entry<String, ?> entry : heartBeatSharedPreferences.getAll().entrySet()) {\n+      timestampList.add(Long.parseLong(entry.getKey()));\n+    }\n+    Collections.sort(timestampList);\n+    for (Long millis : timestampList) {\n+      this.heartBeatSharedPreferences.edit().remove(String.valueOf(millis)).apply();\n+      this.heartBeatCount -= 1;\n+      if (this.heartBeatCount <= (HEART_BEAT_COUNT_LIMIT / 2)) return;\n+    }\n+  }\n+\n+  synchronized long getLastGlobalHeartBeat() {\n+    return sharedPreferences.getLong(GLOBAL, -1);\n+  }\n+\n+  synchronized void updateGlobalHeartBeat(long millis) {\n+    sharedPreferences.edit().putLong(GLOBAL, millis).apply();\n+  }\n+\n+  synchronized List<SdkHeartBeatResult> getStoredHeartBeats(boolean shouldClear) {\n+    ArrayList<SdkHeartBeatResult> sdkHeartBeatResults = new ArrayList<>();\n+    for (Map.Entry<String, ?> entry : heartBeatSharedPreferences.getAll().entrySet()) {\n+      long millis = Long.parseLong(entry.getKey());\n+      String sdkName = ((String) entry.getValue());\n+      sdkHeartBeatResults.add(SdkHeartBeatResult.create(sdkName, millis));\n+    }\n+    Collections.sort(sdkHeartBeatResults);\n+    if (shouldClear) clearStoredHeartBeats();\n+    return sdkHeartBeatResults;\n+  }\n+\n+  void clearStoredHeartBeats() {\n+    heartBeatSharedPreferences.edit().clear().apply();\n+  }\n+\n+  boolean isValidHeartBeat(long base, long target) {\n+    return !((new Date(base).getDate()) == (new Date(target).getDate()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ae2536e482d8ac0ab05e7c979cb88693064834"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9396e20c556263566a82737ea45a4126b2aa62b6", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/9396e20c556263566a82737ea45a4126b2aa62b6", "committedDate": "2020-09-16T01:48:34Z", "message": "gJF"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d27a72428fdaed96cbcd9061b99e9b4a3d4d9110", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/d27a72428fdaed96cbcd9061b99e9b4a3d4d9110", "committedDate": "2020-09-16T02:13:39Z", "message": "use utc format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eef22955d5fa7a4e2367f1daffbe4a065ca8c9dc", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/eef22955d5fa7a4e2367f1daffbe4a065ca8c9dc", "committedDate": "2020-09-17T16:29:59Z", "message": "default heartbeat update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNTQ1Mjc1", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#pullrequestreview-491545275", "createdAt": "2020-09-18T14:59:31Z", "commit": {"oid": "eef22955d5fa7a4e2367f1daffbe4a065ca8c9dc"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDo1OTozMVrOHUQ0HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNTowNzoyOFrOHURG4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwOTA1Mw==", "bodyText": "From the code below it looks like it's important that this executor is single-threaded, otherwise there will be race conditions, can you pls document it here for our future selves?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r491009053", "createdAt": "2020-09-18T14:59:31Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -18,22 +18,49 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.RestrictTo;\n import androidx.annotation.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n import com.google.firebase.components.Component;\n import com.google.firebase.components.Dependency;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n \n /** Provides information as whether to send heart beat or not. */\n public class DefaultHeartBeatInfo implements HeartBeatInfo {\n \n-  private HeartBeatInfoStorage storage;\n+  private final HeartBeatInfoStorage storage;\n \n-  private DefaultHeartBeatInfo(Context context) {\n+  private Set<HeartBeatConsumer> consumers;\n+\n+  private Executor backgroundExecutor;\n+\n+  private static final ThreadFactory THREAD_FACTORY =\n+      r -> new Thread(r, \"heartbeat-information-executor\");\n+\n+  private DefaultHeartBeatInfo(Context context, Set<HeartBeatConsumer> consumers) {\n     storage = HeartBeatInfoStorage.getInstance(context);\n+    this.consumers = consumers;\n+    this.backgroundExecutor =\n+        new ThreadPoolExecutor(\n+            0, 1, 30, TimeUnit.SECONDS, new LinkedBlockingQueue<>(), THREAD_FACTORY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eef22955d5fa7a4e2367f1daffbe4a065ca8c9dc"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAwOTQ1NQ==", "bodyText": "Please make these final as well, and in other places in this PR(if any).", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r491009455", "createdAt": "2020-09-18T15:00:07Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -18,22 +18,49 @@\n import androidx.annotation.NonNull;\n import androidx.annotation.RestrictTo;\n import androidx.annotation.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n import com.google.firebase.components.Component;\n import com.google.firebase.components.Dependency;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n \n /** Provides information as whether to send heart beat or not. */\n public class DefaultHeartBeatInfo implements HeartBeatInfo {\n \n-  private HeartBeatInfoStorage storage;\n+  private final HeartBeatInfoStorage storage;\n \n-  private DefaultHeartBeatInfo(Context context) {\n+  private Set<HeartBeatConsumer> consumers;\n+\n+  private Executor backgroundExecutor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eef22955d5fa7a4e2367f1daffbe4a065ca8c9dc"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxMjE4Mg==", "bodyText": "consider extracting this formatter into a constant since it never changes.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r491012182", "createdAt": "2020-09-18T15:04:47Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatInfoStorage.java", "diffHunk": "@@ -50,15 +75,66 @@ static synchronized HeartBeatInfoStorage getInstance(Context applicationContext)\n     return instance;\n   }\n \n+  synchronized void storeHeartBeatInformation(String heartBeatTag, long millis) {\n+    this.heartBeatSharedPreferences.edit().putString(String.valueOf(millis), heartBeatTag).apply();\n+    this.heartBeatCount += 1;\n+    if (this.heartBeatCount > HEART_BEAT_COUNT_LIMIT) {\n+      this.cleanUpStoredHeartBeats();\n+    }\n+  }\n+\n+  private synchronized void cleanUpStoredHeartBeats() {\n+    ArrayList<Long> timestampList = new ArrayList<>();\n+    for (Map.Entry<String, ?> entry : heartBeatSharedPreferences.getAll().entrySet()) {\n+      timestampList.add(Long.parseLong(entry.getKey()));\n+    }\n+    Collections.sort(timestampList);\n+    for (Long millis : timestampList) {\n+      this.heartBeatSharedPreferences.edit().remove(String.valueOf(millis)).apply();\n+      this.heartBeatCount -= 1;\n+      if (this.heartBeatCount <= (HEART_BEAT_COUNT_LIMIT / 2)) return;\n+    }\n+  }\n+\n+  synchronized long getLastGlobalHeartBeat() {\n+    return sharedPreferences.getLong(GLOBAL, -1);\n+  }\n+\n+  synchronized void updateGlobalHeartBeat(long millis) {\n+    sharedPreferences.edit().putLong(GLOBAL, millis).apply();\n+  }\n+\n+  synchronized List<SdkHeartBeatResult> getStoredHeartBeats(boolean shouldClear) {\n+    ArrayList<SdkHeartBeatResult> sdkHeartBeatResults = new ArrayList<>();\n+    for (Map.Entry<String, ?> entry : heartBeatSharedPreferences.getAll().entrySet()) {\n+      long millis = Long.parseLong(entry.getKey());\n+      String sdkName = ((String) entry.getValue());\n+      sdkHeartBeatResults.add(SdkHeartBeatResult.create(sdkName, millis));\n+    }\n+    Collections.sort(sdkHeartBeatResults);\n+    if (shouldClear) clearStoredHeartBeats();\n+    return sdkHeartBeatResults;\n+  }\n+\n+  void clearStoredHeartBeats() {\n+    heartBeatSharedPreferences.edit().clear().apply();\n+  }\n+\n+  boolean isValidHeartBeat(long base, long target) {\n+    Date baseDate = new Date(base);\n+    Date targetDate = new Date(target);\n+    SimpleDateFormat formatter = new SimpleDateFormat(\"dd/MM/yyyy z\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eef22955d5fa7a4e2367f1daffbe4a065ca8c9dc"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxMzg1OA==", "bodyText": "looking at the signature, iiuc this method does not have anything to do with heartbeat, but rather checks if 2 timestamps belong to the same day in utc, consider renaming the method to something like\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              boolean isValidHeartBeat(long base, long target) {\n          \n          \n            \n              boolean static isSameDateUtc(long oneMillis, long otherMillis) {\n          \n      \n    \n    \n  \n\nnot static, since you don't use any member state of this class.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r491013858", "createdAt": "2020-09-18T15:07:28Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatInfoStorage.java", "diffHunk": "@@ -50,15 +75,66 @@ static synchronized HeartBeatInfoStorage getInstance(Context applicationContext)\n     return instance;\n   }\n \n+  synchronized void storeHeartBeatInformation(String heartBeatTag, long millis) {\n+    this.heartBeatSharedPreferences.edit().putString(String.valueOf(millis), heartBeatTag).apply();\n+    this.heartBeatCount += 1;\n+    if (this.heartBeatCount > HEART_BEAT_COUNT_LIMIT) {\n+      this.cleanUpStoredHeartBeats();\n+    }\n+  }\n+\n+  private synchronized void cleanUpStoredHeartBeats() {\n+    ArrayList<Long> timestampList = new ArrayList<>();\n+    for (Map.Entry<String, ?> entry : heartBeatSharedPreferences.getAll().entrySet()) {\n+      timestampList.add(Long.parseLong(entry.getKey()));\n+    }\n+    Collections.sort(timestampList);\n+    for (Long millis : timestampList) {\n+      this.heartBeatSharedPreferences.edit().remove(String.valueOf(millis)).apply();\n+      this.heartBeatCount -= 1;\n+      if (this.heartBeatCount <= (HEART_BEAT_COUNT_LIMIT / 2)) return;\n+    }\n+  }\n+\n+  synchronized long getLastGlobalHeartBeat() {\n+    return sharedPreferences.getLong(GLOBAL, -1);\n+  }\n+\n+  synchronized void updateGlobalHeartBeat(long millis) {\n+    sharedPreferences.edit().putLong(GLOBAL, millis).apply();\n+  }\n+\n+  synchronized List<SdkHeartBeatResult> getStoredHeartBeats(boolean shouldClear) {\n+    ArrayList<SdkHeartBeatResult> sdkHeartBeatResults = new ArrayList<>();\n+    for (Map.Entry<String, ?> entry : heartBeatSharedPreferences.getAll().entrySet()) {\n+      long millis = Long.parseLong(entry.getKey());\n+      String sdkName = ((String) entry.getValue());\n+      sdkHeartBeatResults.add(SdkHeartBeatResult.create(sdkName, millis));\n+    }\n+    Collections.sort(sdkHeartBeatResults);\n+    if (shouldClear) clearStoredHeartBeats();\n+    return sdkHeartBeatResults;\n+  }\n+\n+  void clearStoredHeartBeats() {\n+    heartBeatSharedPreferences.edit().clear().apply();\n+  }\n+\n+  boolean isValidHeartBeat(long base, long target) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eef22955d5fa7a4e2367f1daffbe4a065ca8c9dc"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55515bd6efcfd11fbacfafae16ec55d5782829f7", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/55515bd6efcfd11fbacfafae16ec55d5782829f7", "committedDate": "2020-09-21T18:48:34Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTU0MDcy", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#pullrequestreview-493554072", "createdAt": "2020-09-22T14:57:47Z", "commit": {"oid": "55515bd6efcfd11fbacfafae16ec55d5782829f7"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDo1Nzo0N1rOHV-ZZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNTowNzoxNFrOHV-3rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwNDQ1Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Set<HeartBeatConsumer> consumers;\n          \n          \n            \n              private final Set<HeartBeatConsumer> consumers;", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r492804452", "createdAt": "2020-09-22T14:57:47Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -16,24 +16,48 @@\n \n import android.content.Context;\n import androidx.annotation.NonNull;\n-import androidx.annotation.RestrictTo;\n import androidx.annotation.VisibleForTesting;\n+import com.google.android.gms.tasks.Task;\n+import com.google.android.gms.tasks.Tasks;\n import com.google.firebase.components.Component;\n import com.google.firebase.components.Dependency;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n \n /** Provides information as whether to send heart beat or not. */\n public class DefaultHeartBeatInfo implements HeartBeatInfo {\n \n-  private HeartBeatInfoStorage storage;\n+  private final HeartBeatInfoStorage storage;\n \n-  private DefaultHeartBeatInfo(Context context) {\n-    storage = HeartBeatInfoStorage.getInstance(context);\n+  private Set<HeartBeatConsumer> consumers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55515bd6efcfd11fbacfafae16ec55d5782829f7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwNTk0OQ==", "bodyText": "constants should use CAPS_SNAKE_CASE, pls change throughout", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r492805949", "createdAt": "2020-09-22T14:59:34Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatInfoStorage.java", "diffHunk": "@@ -30,17 +36,38 @@\n \n   private static final String preferencesName = \"FirebaseAppHeartBeat\";\n \n+  // As soon as you hit the limit of heartbeats. The number of stored heartbeats is halved.\n+  private static final int HEART_BEAT_COUNT_LIMIT = 200;\n+\n+  private static final SimpleDateFormat FORMATTER = new SimpleDateFormat(\"dd/MM/yyyy z\");\n+\n+  // Stores a key value mapping from timestamp to the sdkName and heartBeat code.\n+  private static final String storagePreferencesName = \"FirebaseAppHeartBeatStorage\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55515bd6efcfd11fbacfafae16ec55d5782829f7"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwNzc5MQ==", "bodyText": "looks like you're updating it inside synchronized, but reading it unprotected, this is a race. consider making this method synchronized as well", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r492807791", "createdAt": "2020-09-22T15:01:47Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatInfoStorage.java", "diffHunk": "@@ -30,17 +36,38 @@\n \n   private static final String preferencesName = \"FirebaseAppHeartBeat\";\n \n+  // As soon as you hit the limit of heartbeats. The number of stored heartbeats is halved.\n+  private static final int HEART_BEAT_COUNT_LIMIT = 200;\n+\n+  private static final SimpleDateFormat FORMATTER = new SimpleDateFormat(\"dd/MM/yyyy z\");\n+\n+  // Stores a key value mapping from timestamp to the sdkName and heartBeat code.\n+  private static final String storagePreferencesName = \"FirebaseAppHeartBeatStorage\";\n+\n   private final SharedPreferences sharedPreferences;\n+  private final SharedPreferences heartBeatSharedPreferences;\n+  private int heartBeatCount;\n \n   private HeartBeatInfoStorage(Context applicationContext) {\n     this.sharedPreferences =\n         applicationContext.getSharedPreferences(preferencesName, Context.MODE_PRIVATE);\n+    this.heartBeatSharedPreferences =\n+        applicationContext.getSharedPreferences(preferencesName, Context.MODE_PRIVATE);\n+    this.heartBeatCount = 0;\n   }\n \n   @VisibleForTesting\n   @RestrictTo(RestrictTo.Scope.TESTS)\n-  HeartBeatInfoStorage(SharedPreferences preferences) {\n+  HeartBeatInfoStorage(\n+      SharedPreferences preferences, SharedPreferences heartBeatSharedPreferences) {\n     this.sharedPreferences = preferences;\n+    this.heartBeatSharedPreferences = heartBeatSharedPreferences;\n+  }\n+\n+  @VisibleForTesting\n+  @RestrictTo(RestrictTo.Scope.TESTS)\n+  int getHeartBeatCount() {\n+    return this.heartBeatCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55515bd6efcfd11fbacfafae16ec55d5782829f7"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxMDI0Ng==", "bodyText": "hm, actually: are you using this variable to control when to clean up stale heartbeats? if so, is it ok that this variable will not survive app restarts? wouldn't it cause storage to grow in an unbounded manner?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r492810246", "createdAt": "2020-09-22T15:04:50Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/HeartBeatInfoStorage.java", "diffHunk": "@@ -30,17 +36,38 @@\n \n   private static final String preferencesName = \"FirebaseAppHeartBeat\";\n \n+  // As soon as you hit the limit of heartbeats. The number of stored heartbeats is halved.\n+  private static final int HEART_BEAT_COUNT_LIMIT = 200;\n+\n+  private static final SimpleDateFormat FORMATTER = new SimpleDateFormat(\"dd/MM/yyyy z\");\n+\n+  // Stores a key value mapping from timestamp to the sdkName and heartBeat code.\n+  private static final String storagePreferencesName = \"FirebaseAppHeartBeatStorage\";\n+\n   private final SharedPreferences sharedPreferences;\n+  private final SharedPreferences heartBeatSharedPreferences;\n+  private int heartBeatCount;\n \n   private HeartBeatInfoStorage(Context applicationContext) {\n     this.sharedPreferences =\n         applicationContext.getSharedPreferences(preferencesName, Context.MODE_PRIVATE);\n+    this.heartBeatSharedPreferences =\n+        applicationContext.getSharedPreferences(preferencesName, Context.MODE_PRIVATE);\n+    this.heartBeatCount = 0;\n   }\n \n   @VisibleForTesting\n   @RestrictTo(RestrictTo.Scope.TESTS)\n-  HeartBeatInfoStorage(SharedPreferences preferences) {\n+  HeartBeatInfoStorage(\n+      SharedPreferences preferences, SharedPreferences heartBeatSharedPreferences) {\n     this.sharedPreferences = preferences;\n+    this.heartBeatSharedPreferences = heartBeatSharedPreferences;\n+  }\n+\n+  @VisibleForTesting\n+  @RestrictTo(RestrictTo.Scope.TESTS)\n+  int getHeartBeatCount() {\n+    return this.heartBeatCount;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwNzc5MQ=="}, "originalCommit": {"oid": "55515bd6efcfd11fbacfafae16ec55d5782829f7"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgxMjIwNw==", "bodyText": "what is the purpose of these listeners? why not just use Tasks.await(info.storeHeartBeatInfo(testSdk)) for example?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r492812207", "createdAt": "2020-09-22T15:07:14Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/test/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfoTest.java", "diffHunk": "@@ -15,20 +15,50 @@\n package com.google.firebase.heartbeatinfo;\n \n import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.ArgumentMatchers.anyBoolean;\n import static org.mockito.ArgumentMatchers.anyLong;\n import static org.mockito.ArgumentMatchers.anyString;\n import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n import static org.mockito.Mockito.when;\n \n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.LinkedBlockingQueue;\n+import java.util.concurrent.ThreadPoolExecutor;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.Before;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n import org.junit.runners.JUnit4;\n \n @RunWith(JUnit4.class)\n public class DefaultHeartBeatInfoTest {\n   private String testSdk = \"fire-test\";\n+  private ExecutorService executor;\n+  private TestOnCompleteListener<Boolean> storeOnCompleteListener;\n+  private TestOnCompleteListener<List<HeartBeatResult>> getOnCompleteListener;\n   private HeartBeatInfoStorage storage = mock(HeartBeatInfoStorage.class);\n-  private DefaultHeartBeatInfo heartBeatInfo = new DefaultHeartBeatInfo(storage);\n+  private Set<HeartBeatConsumer> logSources =\n+      new HashSet<HeartBeatConsumer>() {\n+        {\n+          add(new HeartBeatConsumer() {});\n+        }\n+      };\n+  private DefaultHeartBeatInfo heartBeatInfo;\n+\n+  @Before\n+  public void setUp() {\n+    executor = new ThreadPoolExecutor(0, 1, 30L, TimeUnit.SECONDS, new LinkedBlockingQueue<>());\n+    storeOnCompleteListener = new TestOnCompleteListener<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55515bd6efcfd11fbacfafae16ec55d5782829f7"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f453a7aab4fd1c779a152308340da7adbfcf1c84", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/f453a7aab4fd1c779a152308340da7adbfcf1c84", "committedDate": "2020-09-22T16:18:11Z", "message": "heartbeat storage update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "798ae23714edbecd6f8390656571fe20f48bd9a5", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/798ae23714edbecd6f8390656571fe20f48bd9a5", "committedDate": "2020-11-18T20:28:08Z", "message": "update platform logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e3d6b380a1ceb9fae6b739120ff038bf192a696", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/5e3d6b380a1ceb9fae6b739120ff038bf192a696", "committedDate": "2020-11-18T20:37:21Z", "message": "add heartbeat count clear"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a87ae35e49d55a141873c2422790fc68cc240a4", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/2a87ae35e49d55a141873c2422790fc68cc240a4", "committedDate": "2020-11-18T21:02:53Z", "message": "update background executor call"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0ODMwODkx", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#pullrequestreview-534830891", "createdAt": "2020-11-19T20:37:17Z", "commit": {"oid": "2a87ae35e49d55a141873c2422790fc68cc240a4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDozNzoxN1rOH2wq8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDozNzoxN1rOH2wq8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE4MjU3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public Task storeHeartBeatInfo(@NonNull String heartBeatTag) {\n          \n          \n            \n              public Task<Void> storeHeartBeatInfo(@NonNull String heartBeatTag) {", "url": "https://github.com/firebase/firebase-android-sdk/pull/1831#discussion_r527182579", "createdAt": "2020-11-19T20:37:17Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/heartbeatinfo/DefaultHeartBeatInfo.java", "diffHunk": "@@ -51,10 +80,64 @@ private DefaultHeartBeatInfo(Context context) {\n     return HeartBeat.NONE;\n   }\n \n+  @Override\n+  public Task<List<HeartBeatResult>> getAndClearStoredHeartBeatInfo() {\n+    return Tasks.call(\n+        backgroundExecutor,\n+        () -> {\n+          ArrayList<HeartBeatResult> heartBeatResults = new ArrayList<>();\n+          boolean shouldSendGlobalHeartBeat = false;\n+          HeartBeatInfoStorage storage = storageProvider.get();\n+          List<SdkHeartBeatResult> sdkHeartBeatResults = storage.getStoredHeartBeats(true);\n+          long lastGlobalHeartBeat = storage.getLastGlobalHeartBeat();\n+          HeartBeat heartBeat;\n+          for (SdkHeartBeatResult sdkHeartBeatResult : sdkHeartBeatResults) {\n+            shouldSendGlobalHeartBeat =\n+                HeartBeatInfoStorage.isSameDateUtc(\n+                    lastGlobalHeartBeat, sdkHeartBeatResult.getMillis());\n+            if (shouldSendGlobalHeartBeat) {\n+              heartBeat = HeartBeat.COMBINED;\n+            } else {\n+              heartBeat = HeartBeat.SDK;\n+            }\n+            if (shouldSendGlobalHeartBeat) {\n+              lastGlobalHeartBeat = sdkHeartBeatResult.getMillis();\n+            }\n+            heartBeatResults.add(\n+                HeartBeatResult.create(\n+                    sdkHeartBeatResult.getSdkName(), sdkHeartBeatResult.getMillis(), heartBeat));\n+          }\n+          if (lastGlobalHeartBeat > 0) {\n+            storage.updateGlobalHeartBeat(lastGlobalHeartBeat);\n+          }\n+          return heartBeatResults;\n+        });\n+  }\n+\n+  @Override\n+  public Task storeHeartBeatInfo(@NonNull String heartBeatTag) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a87ae35e49d55a141873c2422790fc68cc240a4"}, "originalPosition": 106}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd6ed25891d339792b393ccdd771e55f2fa8005b", "author": {"user": {"login": "VinayGuthal", "name": "Vinay Guthal"}}, "url": "https://github.com/firebase/firebase-android-sdk/commit/fd6ed25891d339792b393ccdd771e55f2fa8005b", "committedDate": "2020-11-24T20:15:57Z", "message": "gJF"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2463, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}