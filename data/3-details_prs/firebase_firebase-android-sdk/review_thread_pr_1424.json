{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MzM0NTAy", "number": 1424, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxODo1OTozNlrODuiDqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDo1Mzo1MFrODwcM0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwMTE5MDgyOnYy", "diffSide": "RIGHT", "path": "firebase-common/src/main/java/com/google/firebase/FirebaseApp.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxODo1OTozNlrOGAkSyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTowMjo0OFrOGAkcYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI0NzgxNg==", "bodyText": "I am pretty sure this is a breaking change for old SDKs that call this method.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403247816", "createdAt": "2020-04-03T18:59:36Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/FirebaseApp.java", "diffHunk": "@@ -370,7 +370,7 @@ public void setAutomaticResourceManagementEnabled(boolean enabled) {\n    * @hide\n    */\n   @KeepForSdk\n-  public boolean isDataCollectionDefaultEnabled() {\n+  public Boolean isDataCollectionDefaultEnabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c6d8908e3ae2bdfc4a1ebdadfb764bac4bf6ac"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI1MDI3NQ==", "bodyText": "hmm i thought none of the sdks used it so far?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403250275", "createdAt": "2020-04-03T19:02:48Z", "author": {"login": "VinayGuthal"}, "path": "firebase-common/src/main/java/com/google/firebase/FirebaseApp.java", "diffHunk": "@@ -370,7 +370,7 @@ public void setAutomaticResourceManagementEnabled(boolean enabled) {\n    * @hide\n    */\n   @KeepForSdk\n-  public boolean isDataCollectionDefaultEnabled() {\n+  public Boolean isDataCollectionDefaultEnabled() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI0NzgxNg=="}, "originalCommit": {"oid": "78c6d8908e3ae2bdfc4a1ebdadfb764bac4bf6ac"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwMTE5ODc5OnYy", "diffSide": "RIGHT", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTowMDo1N1rOGAkXOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxOTowMDo1N1rOGAkXOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI0ODk1NQ==", "bodyText": "Why is it no longer atomic? do we not care about concurrency anymore?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403248955", "createdAt": "2020-04-03T19:00:57Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -37,7 +36,7 @@\n   private final Context applicationContext;\n   private final SharedPreferences sharedPreferences;\n   private final Publisher publisher;\n-  private final AtomicBoolean dataCollectionDefaultEnabled;\n+  private Boolean dataCollectionDefaultEnabled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c6d8908e3ae2bdfc4a1ebdadfb764bac4bf6ac"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwMjEyMTc2OnYy", "diffSide": "RIGHT", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMzoxMjo0MlrOGAsSCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMzoyMjoyOFrOGAsbvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3ODY5OQ==", "bodyText": "Can be extracted into a function?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403378699", "createdAt": "2020-04-03T23:12:42Z", "author": {"login": "ashwinraghav"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();\n+      boolean manifestSetting = readManifestDataCollectionEnabled();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!manifestSetting, manifestSetting)) {\n+        publisher.publish(\n+            new Event<>(\n+                DataCollectionDefaultChange.class,\n+                new DataCollectionDefaultChange(manifestSetting)));\n+      }\n+    } else {\n+      boolean apiSetting = Boolean.TRUE.equals(enabled);\n+      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, apiSetting).apply();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!apiSetting, apiSetting)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MTE4Mg==", "bodyText": "The publisher part?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403381182", "createdAt": "2020-04-03T23:22:28Z", "author": {"login": "VinayGuthal"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();\n+      boolean manifestSetting = readManifestDataCollectionEnabled();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!manifestSetting, manifestSetting)) {\n+        publisher.publish(\n+            new Event<>(\n+                DataCollectionDefaultChange.class,\n+                new DataCollectionDefaultChange(manifestSetting)));\n+      }\n+    } else {\n+      boolean apiSetting = Boolean.TRUE.equals(enabled);\n+      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, apiSetting).apply();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!apiSetting, apiSetting)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3ODY5OQ=="}, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwMjEyODMyOnYy", "diffSide": "RIGHT", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMzoxNjo0NFrOGAsV4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODo0Mjo0NlrOGBlEyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw==", "bodyText": "Should this also live inside the synchronized block?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403379683", "createdAt": "2020-04-03T23:16:44Z", "author": {"login": "ashwinraghav"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MDk5OQ==", "bodyText": "I think shared preferences itself makes sure that it's synchornized", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403380999", "createdAt": "2020-04-03T23:21:37Z", "author": {"login": "VinayGuthal"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MDI2OA==", "bodyText": "Sure, you may however run into a situation where one thread sets the shared prefs value and another one broadcasts the message. So they need to be synchronized around the same mutex", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404280268", "createdAt": "2020-04-06T17:53:52Z", "author": {"login": "ashwinraghav"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwMzkwMw==", "bodyText": "I dont think a synchronized block is needed in this case. Since the method is doing only one write and no read from the shared prefs. And since readManifestDataCollectionEnabled always returns the same value based on the manifest file", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404303903", "createdAt": "2020-04-06T18:33:44Z", "author": {"login": "VinayGuthal"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwODQ4OQ==", "bodyText": "You do need to synchronize here, before your change synchronization was happening with the atomic bool, but since you are checking for null now, a bunch of races become possible, i.e. concurrent threads can enter different branches of this if block and cause mess up the resulting state.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404308489", "createdAt": "2020-04-06T18:41:31Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwOTE5NQ==", "bodyText": "actually nvm the setEnabled method should be in a sync block..\nsetEnabled(true) -> Thread1\nsetEnabled(false) -> Thread2\nThis might result in the shared preferences having the value of false but the dataCollection having the value of True based on the order of execution", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404309195", "createdAt": "2020-04-06T18:42:46Z", "author": {"login": "VinayGuthal"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwMjEyODkzOnYy", "diffSide": "RIGHT", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMzoxNzowNFrOGAsWNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODoxNjo1MVrOGBkIpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTc2NA==", "bodyText": "Synchronized block?", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403379764", "createdAt": "2020-04-03T23:17:04Z", "author": {"login": "ashwinraghav"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();\n+      boolean manifestSetting = readManifestDataCollectionEnabled();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!manifestSetting, manifestSetting)) {\n+        publisher.publish(\n+            new Event<>(\n+                DataCollectionDefaultChange.class,\n+                new DataCollectionDefaultChange(manifestSetting)));\n+      }\n+    } else {\n+      boolean apiSetting = Boolean.TRUE.equals(enabled);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MTEwNA==", "bodyText": "I think shared preferences itself makes sure that it's synchornized", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403381104", "createdAt": "2020-04-03T23:22:07Z", "author": {"login": "VinayGuthal"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();\n+      boolean manifestSetting = readManifestDataCollectionEnabled();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!manifestSetting, manifestSetting)) {\n+        publisher.publish(\n+            new Event<>(\n+                DataCollectionDefaultChange.class,\n+                new DataCollectionDefaultChange(manifestSetting)));\n+      }\n+    } else {\n+      boolean apiSetting = Boolean.TRUE.equals(enabled);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTc2NA=="}, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MTI1NQ==", "bodyText": "I mean Lines 69-73 and lines 77-82 seem extractable into a reusable function", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404281255", "createdAt": "2020-04-06T17:55:27Z", "author": {"login": "ashwinraghav"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();\n+      boolean manifestSetting = readManifestDataCollectionEnabled();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!manifestSetting, manifestSetting)) {\n+        publisher.publish(\n+            new Event<>(\n+                DataCollectionDefaultChange.class,\n+                new DataCollectionDefaultChange(manifestSetting)));\n+      }\n+    } else {\n+      boolean apiSetting = Boolean.TRUE.equals(enabled);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTc2NA=="}, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5Mzc5OQ==", "bodyText": "yeah makes sense i will do that", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404293799", "createdAt": "2020-04-06T18:16:51Z", "author": {"login": "VinayGuthal"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();\n+      boolean manifestSetting = readManifestDataCollectionEnabled();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!manifestSetting, manifestSetting)) {\n+        publisher.publish(\n+            new Event<>(\n+                DataCollectionDefaultChange.class,\n+                new DataCollectionDefaultChange(manifestSetting)));\n+      }\n+    } else {\n+      boolean apiSetting = Boolean.TRUE.equals(enabled);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTc2NA=="}, "originalCommit": {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzE4MzczOnYy", "diffSide": "RIGHT", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo1NDo1MFrOGCPaNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNTo0MDoyOFrOGC1K6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwMjgwNw==", "bodyText": "You may want to rename this to deviceProtectedContext since you changed the logic inside", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405002807", "createdAt": "2020-04-07T17:54:50Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -43,15 +43,14 @@ public DataCollectionConfigStorage(\n       Context applicationContext, String persistenceKey, Publisher publisher) {\n     this.applicationContext = directBootSafe(applicationContext);\n     this.sharedPreferences =\n-        applicationContext.getSharedPreferences(\n+        this.applicationContext.getSharedPreferences(\n             FIREBASE_APP_PREFS + persistenceKey, Context.MODE_PRIVATE);\n     this.publisher = publisher;\n     this.dataCollectionDefaultEnabled = new AtomicBoolean(readAutoDataCollectionEnabled());\n   }\n \n   private static Context directBootSafe(Context applicationContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa6bb6f446366be05e6e2ca41a757e214ac47868"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYyMTQ4MQ==", "bodyText": "Actually I think this method is even redundant and you can just use ContextCompat.createDeviceProtectedStorageContext() directly as it does the same version check.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405621481", "createdAt": "2020-04-08T15:40:28Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -43,15 +43,14 @@ public DataCollectionConfigStorage(\n       Context applicationContext, String persistenceKey, Publisher publisher) {\n     this.applicationContext = directBootSafe(applicationContext);\n     this.sharedPreferences =\n-        applicationContext.getSharedPreferences(\n+        this.applicationContext.getSharedPreferences(\n             FIREBASE_APP_PREFS + persistenceKey, Context.MODE_PRIVATE);\n     this.publisher = publisher;\n     this.dataCollectionDefaultEnabled = new AtomicBoolean(readAutoDataCollectionEnabled());\n   }\n \n   private static Context directBootSafe(Context applicationContext) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwMjgwNw=="}, "originalCommit": {"oid": "aa6bb6f446366be05e6e2ca41a757e214ac47868"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzE4NzM4OnYy", "diffSide": "RIGHT", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo1NTo1MlrOGCPctQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo1NTo1MlrOGCPctQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwMzQ0NQ==", "bodyText": "Since the method is now synchronized there is no point for the bool to be atomic. Also very important to make isEnabled() synchronized as well.", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405003445", "createdAt": "2020-04-07T17:55:52Z", "author": {"login": "vkryachko"}, "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +60,26 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n+  private synchronized void updateDataCollectionDefaultEnabled(boolean enabled) {\n     if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa6bb6f446366be05e6e2ca41a757e214ac47868"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzgxNTI3OnYy", "diffSide": "RIGHT", "path": "firebase-common/data-collection-tests/src/test/java/com/google/firebase/DataCollectionTestUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDo0OTo0MFrOGCVkvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDo1MDo1OFrOGCVndg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMzgwNQ==", "bodyText": "How does this test work if it's using user credential encrypted context?(i.e. not the direct boot one?)", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405103805", "createdAt": "2020-04-07T20:49:40Z", "author": {"login": "vkryachko"}, "path": "firebase-common/data-collection-tests/src/test/java/com/google/firebase/DataCollectionTestUtil.java", "diffHunk": "@@ -52,10 +52,17 @@ static SharedPreferences getSharedPreferences() {\n             Context.MODE_PRIVATE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8287d48663a19d31f63fb01f323031f52c834a6"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwNDUwMg==", "bodyText": "Its because of the config sdk=19", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405104502", "createdAt": "2020-04-07T20:50:58Z", "author": {"login": "VinayGuthal"}, "path": "firebase-common/data-collection-tests/src/test/java/com/google/firebase/DataCollectionTestUtil.java", "diffHunk": "@@ -52,10 +52,17 @@ static SharedPreferences getSharedPreferences() {\n             Context.MODE_PRIVATE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMzgwNQ=="}, "originalCommit": {"oid": "c8287d48663a19d31f63fb01f323031f52c834a6"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTIwMjc1OnYy", "diffSide": "LEFT", "path": "firebase-crashlytics/src/androidTest/java/com/google/firebase/crashlytics/internal/common/CrashlyticsControllerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDo1Mzo1MFrOGDcZbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDo1Mzo1MFrOGDcZbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2NDE3NA==", "bodyText": "pls revert this change, lgtm otherwise", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r406264174", "createdAt": "2020-04-09T14:53:50Z", "author": {"login": "vkryachko"}, "path": "firebase-crashlytics/src/androidTest/java/com/google/firebase/crashlytics/internal/common/CrashlyticsControllerTest.java", "diffHunk": "@@ -842,9 +842,8 @@ public void testUploadDisabledThenEnabled() throws Exception {\n     Task<Void> task = controller.submitAllReports(1.0f, testSettingsDataProvider.getAppSettings());\n \n     arbiter.setCrashlyticsDataCollectionEnabled(true);\n-\n+    \n     await(task);\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e5dcb9e759fadbd740c57c1d523fb5f52a8d0f7"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1440, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}