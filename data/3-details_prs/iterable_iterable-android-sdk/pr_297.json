{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM4NzE0Mjcz", "number": 297, "title": "[MOB-2373] Call request callbacks on task completion", "bodyText": "\ud83d\udd39 Jira Ticket(s) if any\n\nMOB-2373\n\n\u270f\ufe0f Description\nCall original request callbacks when a task is completed.", "createdAt": "2020-12-13T03:05:51Z", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297", "merged": true, "mergeCommit": {"oid": "22dc33622668d07681b3ce534d42da3ee382ef16"}, "closed": true, "closedAt": "2020-12-15T19:57:26Z", "author": {"login": "vbabenkoru"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdl1irogFqTU1MDk0NzA4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmUYDiABqjQxMTI5MTE2NjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTQ3MDgy", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#pullrequestreview-550947082", "createdAt": "2020-12-13T18:35:16Z", "commit": {"oid": "1ca497aeae0c6ace9220f66dc024a0250b3d2315"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxODozNToxN1rOIE3zMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxODozNToxN1rOIE3zMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk3OTQ0MA==", "bodyText": "Wow!!! I didn't know we have this feature in java!", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#discussion_r541979440", "createdAt": "2020-12-13T18:35:17Z", "author": {"login": "Ayyanchira"}, "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableTaskRunner.java", "diffHunk": "@@ -67,15 +90,33 @@ private boolean processNextTask() {\n         }\n \n         if (task.taskType == IterableTaskType.API) {\n+            IterableApiResponse response = null;\n+            TaskResult result = TaskResult.FAILURE;\n             try {\n                 IterableApiRequest request = IterableApiRequest.fromJSON(new JSONObject(task.data), null, null);\n-                IterableApiResponse response = IterableRequestTask.executeApiRequest(request);\n+                response = IterableRequestTask.executeApiRequest(request);\n             } catch (Exception e) {\n                 IterableLogger.e(TAG, \"Error while processing request task\", e);\n             }\n+            if (response != null) {\n+                result = response.success ? TaskResult.SUCCESS : TaskResult.FAILURE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ca497aeae0c6ace9220f66dc024a0250b3d2315"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTQ3MTUy", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#pullrequestreview-550947152", "createdAt": "2020-12-13T18:36:06Z", "commit": {"oid": "1ca497aeae0c6ace9220f66dc024a0250b3d2315"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxODozNjowN1rOIE3zqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxODozNjowN1rOIE3zqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk3OTU2Mw==", "bodyText": "reiterating form previous PR, if the delete task should happen here regardless of success or failure.", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#discussion_r541979563", "createdAt": "2020-12-13T18:36:07Z", "author": {"login": "Ayyanchira"}, "path": "iterableapi/src/main/java/com/iterable/iterableapi/IterableTaskRunner.java", "diffHunk": "@@ -67,15 +90,33 @@ private boolean processNextTask() {\n         }\n \n         if (task.taskType == IterableTaskType.API) {\n+            IterableApiResponse response = null;\n+            TaskResult result = TaskResult.FAILURE;\n             try {\n                 IterableApiRequest request = IterableApiRequest.fromJSON(new JSONObject(task.data), null, null);\n-                IterableApiResponse response = IterableRequestTask.executeApiRequest(request);\n+                response = IterableRequestTask.executeApiRequest(request);\n             } catch (Exception e) {\n                 IterableLogger.e(TAG, \"Error while processing request task\", e);\n             }\n+            if (response != null) {\n+                result = response.success ? TaskResult.SUCCESS : TaskResult.FAILURE;\n+            }\n+            callTaskCompletedListeners(task.id, result, response);\n             taskStorage.deleteTask(task.id);\n             return true;\n         }\n         return false;\n     }\n+\n+    @WorkerThread\n+    private void callTaskCompletedListeners(final String taskId, final TaskResult result, final IterableApiResponse response) {\n+        for (final TaskCompletedListener listener : taskCompletedListeners) {\n+            new Handler(Looper.getMainLooper()).post(new Runnable() {\n+                @Override\n+                public void run() {\n+                    listener.onTaskCompleted(taskId, result, response);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ca497aeae0c6ace9220f66dc024a0250b3d2315"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTQ3MjQ0", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#pullrequestreview-550947244", "createdAt": "2020-12-13T18:37:07Z", "commit": {"oid": "1ca497aeae0c6ace9220f66dc024a0250b3d2315"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxODozNzowN1rOIE30Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxODozNzowN1rOIE30Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk3OTczOA==", "bodyText": "or should the delete task happen here? \ud83e\udd37\u200d\u2642\ufe0f", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#discussion_r541979738", "createdAt": "2020-12-13T18:37:07Z", "author": {"login": "Ayyanchira"}, "path": "iterableapi/src/main/java/com/iterable/iterableapi/OfflineRequestProcessor.java", "diffHunk": "@@ -59,4 +63,18 @@ void scheduleTask(IterableApiRequest request, @Nullable IterableHelper.SuccessHa\n         successCallbackMap.put(taskId, onSuccess);\n         failureCallbackMap.put(taskId, onFailure);\n     }\n+\n+    @MainThread\n+    @Override\n+    public void onTaskCompleted(String taskId, IterableTaskRunner.TaskResult result, IterableApiResponse response) {\n+        IterableHelper.SuccessHandler onSuccess = successCallbackMap.get(taskId);\n+        IterableHelper.FailureHandler onFailure = failureCallbackMap.get(taskId);\n+        successCallbackMap.remove(taskId);\n+        failureCallbackMap.remove(taskId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ca497aeae0c6ace9220f66dc024a0250b3d2315"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTQ3MzI3", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#pullrequestreview-550947327", "createdAt": "2020-12-13T18:38:15Z", "commit": {"oid": "1ca497aeae0c6ace9220f66dc024a0250b3d2315"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ca497aeae0c6ace9220f66dc024a0250b3d2315", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/1ca497aeae0c6ace9220f66dc024a0250b3d2315", "committedDate": "2020-12-13T03:05:03Z", "message": "Call request callbacks on task completion"}, "afterCommit": {"oid": "c246feb17653ee82c0ecc2499b49086067637bbd", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/c246feb17653ee82c0ecc2499b49086067637bbd", "committedDate": "2020-12-15T04:51:41Z", "message": "Call request callbacks on task completion"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c246feb17653ee82c0ecc2499b49086067637bbd", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/c246feb17653ee82c0ecc2499b49086067637bbd", "committedDate": "2020-12-15T04:51:41Z", "message": "Call request callbacks on task completion"}, "afterCommit": {"oid": "e1430f8ecd19cba9f62491971e72f71917018721", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/e1430f8ecd19cba9f62491971e72f71917018721", "committedDate": "2020-12-15T04:55:33Z", "message": "Call request callbacks on task completion"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1430f8ecd19cba9f62491971e72f71917018721", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/e1430f8ecd19cba9f62491971e72f71917018721", "committedDate": "2020-12-15T04:55:33Z", "message": "Call request callbacks on task completion"}, "afterCommit": {"oid": "3e61e7f50e3d671ade373a9cfc2dcb0e8227df48", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/3e61e7f50e3d671ade373a9cfc2dcb0e8227df48", "committedDate": "2020-12-15T05:48:32Z", "message": "Call request callbacks on task completion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTMzNjMx", "url": "https://github.com/Iterable/iterable-android-sdk/pull/297#pullrequestreview-552133631", "createdAt": "2020-12-15T06:13:17Z", "commit": {"oid": "3e61e7f50e3d671ade373a9cfc2dcb0e8227df48"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28419e1a6bd4b2395e3bc5a52019e0324cf9229c", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/28419e1a6bd4b2395e3bc5a52019e0324cf9229c", "committedDate": "2020-12-15T06:30:14Z", "message": "Call request callbacks on task completion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd14af5103816e82b14063b1562a559e4bdd619b", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/bd14af5103816e82b14063b1562a559e4bdd619b", "committedDate": "2020-12-15T06:30:34Z", "message": "Add tests for callbacks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e61e7f50e3d671ade373a9cfc2dcb0e8227df48", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/3e61e7f50e3d671ade373a9cfc2dcb0e8227df48", "committedDate": "2020-12-15T05:48:32Z", "message": "Call request callbacks on task completion"}, "afterCommit": {"oid": "bd14af5103816e82b14063b1562a559e4bdd619b", "author": {"user": {"login": "vbabenkoru", "name": "Victor Babenko"}}, "url": "https://github.com/Iterable/iterable-android-sdk/commit/bd14af5103816e82b14063b1562a559e4bdd619b", "committedDate": "2020-12-15T06:30:34Z", "message": "Add tests for callbacks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 569, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}