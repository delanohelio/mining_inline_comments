{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4ODAzMzkx", "number": 3305, "title": "feat: add DIREGAPIC support for PHP", "bodyText": "Resubmission of #3301 from origin so all tests pass\n\nAdds supportsGrpcTransport, which returns false when transport_protocol is set to REST\nModifies PHP GAPIC to:\n\nensure documentation for transport and transportConfig service clients options omit grpc\nomit gcpApiConfigPath config in getClientDefaults\nomit importing any grpc-related classes\nAdds defaultTransport and getSupportedTransport functions to override the transport verification functionality in google/gax\n\n\nAdds new baseline test for DIREGAPIC PHP\nUpdates PHP bazel rules to allow for REST transport", "createdAt": "2020-11-10T22:31:11Z", "url": "https://github.com/googleapis/gapic-generator/pull/3305", "merged": true, "mergeCommit": {"oid": "04562898ae3c15199dcc5c2f45670edf3ac58886"}, "closed": true, "closedAt": "2020-12-08T21:47:55Z", "author": {"login": "bshaffer"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbRHbAgH2gAyNTE4ODAzMzkxOjI4N2E2NTg2YjM0OTdhZjIwYjBiYWViOThlNDI5YWY5ZWVhNzU3YTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkQyAygH2gAyNTE4ODAzMzkxOjM4ODY5OTczZjAzOGM5NGNmN2U4MDhiYTEwYmEyNTE4ZWY3OGMyZDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "287a6586b3497af20b0baeb98e429af9eea757a7", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/287a6586b3497af20b0baeb98e429af9eea757a7", "committedDate": "2020-11-10T22:29:41Z", "message": "add transport to php gapic bazel rules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab81e22a2a2042e28b311d45537be53d3736a014", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/ab81e22a2a2042e28b311d45537be53d3736a014", "committedDate": "2020-11-10T22:29:41Z", "message": "feat: adds support for PHP DIREGAPIC (WIP)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66e206cf2c70550923732264ad0ff36d14fe489d", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/66e206cf2c70550923732264ad0ff36d14fe489d", "committedDate": "2020-11-10T22:29:41Z", "message": "adds DIREGAPIC baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f7e4eebbee015bc190ec66448e14bf4eec101a3", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/0f7e4eebbee015bc190ec66448e14bf4eec101a3", "committedDate": "2020-11-10T22:29:41Z", "message": "ensures streaming protos cannot be generated for PHP REST-only GAPICs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dcab1b2adb4a6480cfa5a14cf5c8e4d2b8cd9b3", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/3dcab1b2adb4a6480cfa5a14cf5c8e4d2b8cd9b3", "committedDate": "2020-11-10T22:29:41Z", "message": "addresses two review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b783693ddab947cde275479c82c8c5de9c5ca440", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/b783693ddab947cde275479c82c8c5de9c5ca440", "committedDate": "2020-11-10T22:29:41Z", "message": "simplifies gapic.yaml for v2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88d5714c74bd2bf2b4ddc1b5232c2056726eae82", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/88d5714c74bd2bf2b4ddc1b5232c2056726eae82", "committedDate": "2020-11-10T22:29:41Z", "message": "uses supportsGrpcTransport instead of isRestOnlyTransport"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e59c21f82cfba8a63428626b1c0a2d1e7f0cf0f", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/6e59c21f82cfba8a63428626b1c0a2d1e7f0cf0f", "committedDate": "2020-11-10T22:29:41Z", "message": "simplify gapic v2 yaml even more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc89f181dbfd92e811c1f65ccd5a186ddb235ea4", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/dc89f181dbfd92e811c1f65ccd5a186ddb235ea4", "committedDate": "2020-11-13T20:55:48Z", "message": "Merge branch 'master' into add-rest-only-transport-option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8", "committedDate": "2020-11-13T21:12:09Z", "message": "fix baseline test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNzc0NDgz", "url": "https://github.com/googleapis/gapic-generator/pull/3305#pullrequestreview-531774483", "createdAt": "2020-11-16T20:58:35Z", "commit": {"oid": "9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMDo1ODozNVrOH0RS4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTowNDoyNlrOH0RsRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3MTM2MA==", "bodyText": "I would add a comment before this if block making it explicitly that we're generating GAPICs that support only one transport for now.", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r524571360", "createdAt": "2020-11-16T20:58:35Z", "author": {"login": "vchudnov-g"}, "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -191,14 +195,19 @@ private ViewModel buildGapicClientViewModel(GapicInterfaceContext context) {\n     apiImplClass.clientConfigPath(namer.getClientConfigPath(context.getInterfaceConfig()));\n     apiImplClass.clientConfigName(namer.getClientConfigName(context.getInterfaceConfig()));\n     apiImplClass.interfaceKey(context.getInterface().getFullName());\n-    String grpcClientTypeName =\n-        namer.getAndSaveNicknameForGrpcClientTypeName(\n-            context.getImportTypeTable(), context.getInterfaceModel());\n-    apiImplClass.grpcClientTypeName(grpcClientTypeName);\n+    if (supportsGrpcTransport()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3NTQ3Nw==", "bodyText": "tiny nit: What about: \"Streaming methods only valid for gRPC transport\"", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r524575477", "createdAt": "2020-11-16T21:02:15Z", "author": {"login": "vchudnov-g"}, "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -426,6 +435,9 @@ private RestPlaceholderConfigView generateRestPlaceholderConfigView(\n     List<GrpcStreamingDetailView> result = new ArrayList<>();\n \n     for (MethodModel method : context.getGrpcStreamingMethods()) {\n+      if (!supportsGrpcTransport()) {\n+        throw new RuntimeException(\"Streaming methods invalid for REST-only transport\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3Nzg2MA==", "bodyText": "tiny nit: Does order matter here? If not, I would move this to be the least one, for readability.", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r524577860", "createdAt": "2020-11-16T21:04:26Z", "author": {"login": "vchudnov-g"}, "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -453,7 +465,9 @@ private void addApiImports(GapicInterfaceContext context) {\n     typeTable.saveNicknameFor(\"\\\\Google\\\\ApiCore\\\\CredentialsWrapper\");\n     typeTable.saveNicknameFor(\"\\\\Google\\\\ApiCore\\\\GapicClientTrait\");\n     typeTable.saveNicknameFor(\"\\\\Google\\\\ApiCore\\\\PathTemplate\");\n-    typeTable.saveNicknameFor(\"\\\\Google\\\\ApiCore\\\\RequestParamsHeaderDescriptor\");\n+    if (supportsGrpcTransport()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e0fd512c7fd5dc7649ef46360ca742e4f3d60a8"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f6c1423d76931e18022ed65710c6c77c62100c", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/76f6c1423d76931e18022ed65710c6c77c62100c", "committedDate": "2020-11-17T14:20:33Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8daae83eec821dafb993d5793018d484f11b1156", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/8daae83eec821dafb993d5793018d484f11b1156", "committedDate": "2020-11-17T14:21:18Z", "message": "Merge branch 'master' into add-rest-only-transport-option"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNzQ4NDE1", "url": "https://github.com/googleapis/gapic-generator/pull/3305#pullrequestreview-532748415", "createdAt": "2020-11-17T19:40:03Z", "commit": {"oid": "8daae83eec821dafb993d5793018d484f11b1156"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0MDowM1rOH1GW3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0MzozNlrOH1GnhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0MDczNQ==", "bodyText": "nit: probably Collections.emptyList() is what you need here.", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r525440735", "createdAt": "2020-11-17T19:40:03Z", "author": {"login": "vam-google"}, "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -191,15 +195,22 @@ private ViewModel buildGapicClientViewModel(GapicInterfaceContext context) {\n     apiImplClass.clientConfigPath(namer.getClientConfigPath(context.getInterfaceConfig()));\n     apiImplClass.clientConfigName(namer.getClientConfigName(context.getInterfaceConfig()));\n     apiImplClass.interfaceKey(context.getInterface().getFullName());\n-    String grpcClientTypeName =\n-        namer.getAndSaveNicknameForGrpcClientTypeName(\n-            context.getImportTypeTable(), context.getInterfaceModel());\n-    apiImplClass.grpcClientTypeName(grpcClientTypeName);\n+    if (supportsGrpcTransport()) {\n+      // PHP generates a client that supports both gRPC and REST\n+      String grpcClientTypeName =\n+          namer.getAndSaveNicknameForGrpcClientTypeName(\n+              context.getImportTypeTable(), context.getInterfaceModel());\n+      apiImplClass.grpcClientTypeName(grpcClientTypeName);\n+\n+      apiImplClass.stubs(grpcStubTransformer.generateGrpcStubs(context));\n+    } else {\n+      // PHP generates a client that only supports REST\n+      apiImplClass.grpcClientTypeName(\"\");\n+      apiImplClass.stubs(new ArrayList<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8daae83eec821dafb993d5793018d484f11b1156"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0NDk5Ng==", "bodyText": "How will this behave for existing APIs? There are many APIs that PHP generates the multitransport client and those have streaming methods. I believe in that case PHP still creates a client, just the streaming methods are no-op, but the generation itself does not fail and all the non-streaming methods are present in the generated surface. Will make gapic-generator throwing exception for such APIs and failing the whole generation process as a result?\nAlso, please do not use RuntimeException directly. It is an exception designed to be a base for the other specific exceptions. Please pick something more specific (UnsupportedOperation or something like that)", "url": "https://github.com/googleapis/gapic-generator/pull/3305#discussion_r525444996", "createdAt": "2020-11-17T19:43:36Z", "author": {"login": "vam-google"}, "path": "src/main/java/com/google/api/codegen/transformer/php/PhpGapicSurfaceTransformer.java", "diffHunk": "@@ -426,6 +437,9 @@ private RestPlaceholderConfigView generateRestPlaceholderConfigView(\n     List<GrpcStreamingDetailView> result = new ArrayList<>();\n \n     for (MethodModel method : context.getGrpcStreamingMethods()) {\n+      if (!supportsGrpcTransport()) {\n+        throw new RuntimeException(\"Streaming methods only valid for gRPC transport\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8daae83eec821dafb993d5793018d484f11b1156"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNzc2NTA1", "url": "https://github.com/googleapis/gapic-generator/pull/3305#pullrequestreview-532776505", "createdAt": "2020-11-17T20:18:22Z", "commit": {"oid": "8daae83eec821dafb993d5793018d484f11b1156"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9704b5b9bbbf3c9c50db389b94565e0c94dca9c", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/e9704b5b9bbbf3c9c50db389b94565e0c94dca9c", "committedDate": "2020-12-01T18:43:59Z", "message": "Merge branch 'master' into add-rest-only-transport-option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38869973f038c94cf7e808ba10ba2518ef78c2d8", "author": {"user": {"login": "bshaffer", "name": "Brent Shaffer"}}, "url": "https://github.com/googleapis/gapic-generator/commit/38869973f038c94cf7e808ba10ba2518ef78c2d8", "committedDate": "2020-12-08T21:11:37Z", "message": "Merge branch 'master' into add-rest-only-transport-option"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1361, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}