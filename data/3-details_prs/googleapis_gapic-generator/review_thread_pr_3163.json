{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5OTg2MTQw", "number": 3163, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjoyNzoyMlrODv2ZxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjoyNzoyMlrODv2ZxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTAwOTk2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/api/codegen/config/ResourceNameMessageConfigs.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNjoyNzoyMlrOGCgsHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxODo0OTozNVrOGC8cHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NTkxOA==", "bodyText": "I think it might be clearer to move the earlier put call to an else block - so that every branch of this switch statement calls fieldEntityMap.put exactly once. (You could even extract this to a method which just returns \"the value to put in the map\" so you only have a single fieldEntityMap.put call.)", "url": "https://github.com/googleapis/gapic-generator/pull/3163#discussion_r405285918", "createdAt": "2020-04-08T06:27:22Z", "author": {"login": "jskeet"}, "path": "src/main/java/com/google/api/codegen/config/ResourceNameMessageConfigs.java", "diffHunk": "@@ -134,36 +140,40 @@ private static void loadFieldEntityPairFromResourceReferenceAnnotation(\n           \"Only one of child_type and type should be set: %s\",\n           field);\n \n-      if (!childType.isEmpty()) {\n-        List<ResourceDescriptorConfig> parents =\n-            childParentResourceMap.getOrDefault(childType, Collections.emptyList());\n-        for (ResourceDescriptorConfig parentResourceDescriptor : parents) {\n-          String derivedEntityName = parentResourceDescriptor.getDerivedEntityName();\n-          ResourceNameConfig parentResource = resourceNameConfigs.get(derivedEntityName);\n-          Preconditions.checkArgument(\n-              parentResource != null, \"Referencing non-existing parent resource: %s\", childType);\n-          fieldEntityMap.put(field.getSimpleName(), parentResource.getEntityId());\n-        }\n+      if (type.equals(\"*\") || childType.equals(\"*\")) {\n+        fieldEntityMap.put(field.getSimpleName(), \"*\");\n         continue;\n       }\n \n-      if (type.equals(\"*\")) {\n-        fieldEntityMap.put(field.getSimpleName(), \"*\");\n-        continue;\n+      List<ResourceDescriptorConfig> referencedResources;\n+      if (!childType.isEmpty()) {\n+        referencedResources = childParentResourceMap.get(childType);\n+      } else {\n+        referencedResources = Collections.singletonList(descriptorConfigMap.get(type));\n       }\n \n-      String unqualifiedResourceType = ResourceDescriptorConfig.getUnqualifiedTypeName(type);\n-      ResourceNameConfig resourceNameConfig =\n-          resourceNameConfigs.get(unqualifiedResourceType + \"Oneof\");\n-      if (resourceNameConfig != null\n-          && resourceNameConfig.getResourceNameType() == ResourceNameType.ONEOF) {\n-        fieldEntityMap.put(field.getSimpleName(), unqualifiedResourceType + \"Oneof\");\n-        continue;\n+      for (ResourceDescriptorConfig descriptor : referencedResources) {\n+        String unqualifiedName = descriptor.getDerivedEntityName();\n+        ResourceNameConfig resource = resourceNameConfigs.get(unqualifiedName);\n+\n+        switch (resource.getResourceNameType()) {\n+          case ANY:\n+            fieldEntityMap.put(field.getSimpleName(), \"*\");\n+            break;\n+          case SINGLE:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            break;\n+          case ONEOF:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            if (((ResourceNameOneofConfig) resource).hasAnyResourceNamePattern()) {\n+              fieldEntityMap.put(field.getSimpleName(), \"*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74feb00d6b94ff04fed06c784bfcd826529246b3"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcwODMxNA==", "bodyText": "I might be missing your point Jon, but the former put needs to be executed regardless of whether the resource has a * pattern, so I can't move it to the else block.", "url": "https://github.com/googleapis/gapic-generator/pull/3163#discussion_r405708314", "createdAt": "2020-04-08T17:55:10Z", "author": {"login": "yihanzhen"}, "path": "src/main/java/com/google/api/codegen/config/ResourceNameMessageConfigs.java", "diffHunk": "@@ -134,36 +140,40 @@ private static void loadFieldEntityPairFromResourceReferenceAnnotation(\n           \"Only one of child_type and type should be set: %s\",\n           field);\n \n-      if (!childType.isEmpty()) {\n-        List<ResourceDescriptorConfig> parents =\n-            childParentResourceMap.getOrDefault(childType, Collections.emptyList());\n-        for (ResourceDescriptorConfig parentResourceDescriptor : parents) {\n-          String derivedEntityName = parentResourceDescriptor.getDerivedEntityName();\n-          ResourceNameConfig parentResource = resourceNameConfigs.get(derivedEntityName);\n-          Preconditions.checkArgument(\n-              parentResource != null, \"Referencing non-existing parent resource: %s\", childType);\n-          fieldEntityMap.put(field.getSimpleName(), parentResource.getEntityId());\n-        }\n+      if (type.equals(\"*\") || childType.equals(\"*\")) {\n+        fieldEntityMap.put(field.getSimpleName(), \"*\");\n         continue;\n       }\n \n-      if (type.equals(\"*\")) {\n-        fieldEntityMap.put(field.getSimpleName(), \"*\");\n-        continue;\n+      List<ResourceDescriptorConfig> referencedResources;\n+      if (!childType.isEmpty()) {\n+        referencedResources = childParentResourceMap.get(childType);\n+      } else {\n+        referencedResources = Collections.singletonList(descriptorConfigMap.get(type));\n       }\n \n-      String unqualifiedResourceType = ResourceDescriptorConfig.getUnqualifiedTypeName(type);\n-      ResourceNameConfig resourceNameConfig =\n-          resourceNameConfigs.get(unqualifiedResourceType + \"Oneof\");\n-      if (resourceNameConfig != null\n-          && resourceNameConfig.getResourceNameType() == ResourceNameType.ONEOF) {\n-        fieldEntityMap.put(field.getSimpleName(), unqualifiedResourceType + \"Oneof\");\n-        continue;\n+      for (ResourceDescriptorConfig descriptor : referencedResources) {\n+        String unqualifiedName = descriptor.getDerivedEntityName();\n+        ResourceNameConfig resource = resourceNameConfigs.get(unqualifiedName);\n+\n+        switch (resource.getResourceNameType()) {\n+          case ANY:\n+            fieldEntityMap.put(field.getSimpleName(), \"*\");\n+            break;\n+          case SINGLE:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            break;\n+          case ONEOF:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            if (((ResourceNameOneofConfig) resource).hasAnyResourceNamePattern()) {\n+              fieldEntityMap.put(field.getSimpleName(), \"*\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NTkxOA=="}, "originalCommit": {"oid": "74feb00d6b94ff04fed06c784bfcd826529246b3"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTcxMzY3MA==", "bodyText": "You've currently got (pseudo-code)\nput (key, value1)\nif (condition)\n  put (key, value2)\n\nI'm suggesting that's better as:\nif (condition)\n  put (key, value2)\nelse\n  put (key, value1)\n\nSo it's easy to see that in every path, the key is put exactly once. What's the benefit of putting unqualifiedName as the value and then putting \"*\" as the value? That's just overwriting it, right?", "url": "https://github.com/googleapis/gapic-generator/pull/3163#discussion_r405713670", "createdAt": "2020-04-08T18:04:09Z", "author": {"login": "jskeet"}, "path": "src/main/java/com/google/api/codegen/config/ResourceNameMessageConfigs.java", "diffHunk": "@@ -134,36 +140,40 @@ private static void loadFieldEntityPairFromResourceReferenceAnnotation(\n           \"Only one of child_type and type should be set: %s\",\n           field);\n \n-      if (!childType.isEmpty()) {\n-        List<ResourceDescriptorConfig> parents =\n-            childParentResourceMap.getOrDefault(childType, Collections.emptyList());\n-        for (ResourceDescriptorConfig parentResourceDescriptor : parents) {\n-          String derivedEntityName = parentResourceDescriptor.getDerivedEntityName();\n-          ResourceNameConfig parentResource = resourceNameConfigs.get(derivedEntityName);\n-          Preconditions.checkArgument(\n-              parentResource != null, \"Referencing non-existing parent resource: %s\", childType);\n-          fieldEntityMap.put(field.getSimpleName(), parentResource.getEntityId());\n-        }\n+      if (type.equals(\"*\") || childType.equals(\"*\")) {\n+        fieldEntityMap.put(field.getSimpleName(), \"*\");\n         continue;\n       }\n \n-      if (type.equals(\"*\")) {\n-        fieldEntityMap.put(field.getSimpleName(), \"*\");\n-        continue;\n+      List<ResourceDescriptorConfig> referencedResources;\n+      if (!childType.isEmpty()) {\n+        referencedResources = childParentResourceMap.get(childType);\n+      } else {\n+        referencedResources = Collections.singletonList(descriptorConfigMap.get(type));\n       }\n \n-      String unqualifiedResourceType = ResourceDescriptorConfig.getUnqualifiedTypeName(type);\n-      ResourceNameConfig resourceNameConfig =\n-          resourceNameConfigs.get(unqualifiedResourceType + \"Oneof\");\n-      if (resourceNameConfig != null\n-          && resourceNameConfig.getResourceNameType() == ResourceNameType.ONEOF) {\n-        fieldEntityMap.put(field.getSimpleName(), unqualifiedResourceType + \"Oneof\");\n-        continue;\n+      for (ResourceDescriptorConfig descriptor : referencedResources) {\n+        String unqualifiedName = descriptor.getDerivedEntityName();\n+        ResourceNameConfig resource = resourceNameConfigs.get(unqualifiedName);\n+\n+        switch (resource.getResourceNameType()) {\n+          case ANY:\n+            fieldEntityMap.put(field.getSimpleName(), \"*\");\n+            break;\n+          case SINGLE:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            break;\n+          case ONEOF:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            if (((ResourceNameOneofConfig) resource).hasAnyResourceNamePattern()) {\n+              fieldEntityMap.put(field.getSimpleName(), \"*\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NTkxOA=="}, "originalCommit": {"oid": "74feb00d6b94ff04fed06c784bfcd826529246b3"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTczODE1Nw==", "bodyText": "Ahh I see the confusion here. fieldEntityMap is a Multimap- it supports duplicate keys.\nhttps://github.com/googleapis/gapic-generator/pull/3163/files/74feb00d6b94ff04fed06c784bfcd826529246b3#diff-a0f27b8e4c41d2ebf887482b72314a58R82", "url": "https://github.com/googleapis/gapic-generator/pull/3163#discussion_r405738157", "createdAt": "2020-04-08T18:45:21Z", "author": {"login": "yihanzhen"}, "path": "src/main/java/com/google/api/codegen/config/ResourceNameMessageConfigs.java", "diffHunk": "@@ -134,36 +140,40 @@ private static void loadFieldEntityPairFromResourceReferenceAnnotation(\n           \"Only one of child_type and type should be set: %s\",\n           field);\n \n-      if (!childType.isEmpty()) {\n-        List<ResourceDescriptorConfig> parents =\n-            childParentResourceMap.getOrDefault(childType, Collections.emptyList());\n-        for (ResourceDescriptorConfig parentResourceDescriptor : parents) {\n-          String derivedEntityName = parentResourceDescriptor.getDerivedEntityName();\n-          ResourceNameConfig parentResource = resourceNameConfigs.get(derivedEntityName);\n-          Preconditions.checkArgument(\n-              parentResource != null, \"Referencing non-existing parent resource: %s\", childType);\n-          fieldEntityMap.put(field.getSimpleName(), parentResource.getEntityId());\n-        }\n+      if (type.equals(\"*\") || childType.equals(\"*\")) {\n+        fieldEntityMap.put(field.getSimpleName(), \"*\");\n         continue;\n       }\n \n-      if (type.equals(\"*\")) {\n-        fieldEntityMap.put(field.getSimpleName(), \"*\");\n-        continue;\n+      List<ResourceDescriptorConfig> referencedResources;\n+      if (!childType.isEmpty()) {\n+        referencedResources = childParentResourceMap.get(childType);\n+      } else {\n+        referencedResources = Collections.singletonList(descriptorConfigMap.get(type));\n       }\n \n-      String unqualifiedResourceType = ResourceDescriptorConfig.getUnqualifiedTypeName(type);\n-      ResourceNameConfig resourceNameConfig =\n-          resourceNameConfigs.get(unqualifiedResourceType + \"Oneof\");\n-      if (resourceNameConfig != null\n-          && resourceNameConfig.getResourceNameType() == ResourceNameType.ONEOF) {\n-        fieldEntityMap.put(field.getSimpleName(), unqualifiedResourceType + \"Oneof\");\n-        continue;\n+      for (ResourceDescriptorConfig descriptor : referencedResources) {\n+        String unqualifiedName = descriptor.getDerivedEntityName();\n+        ResourceNameConfig resource = resourceNameConfigs.get(unqualifiedName);\n+\n+        switch (resource.getResourceNameType()) {\n+          case ANY:\n+            fieldEntityMap.put(field.getSimpleName(), \"*\");\n+            break;\n+          case SINGLE:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            break;\n+          case ONEOF:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            if (((ResourceNameOneofConfig) resource).hasAnyResourceNamePattern()) {\n+              fieldEntityMap.put(field.getSimpleName(), \"*\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NTkxOA=="}, "originalCommit": {"oid": "74feb00d6b94ff04fed06c784bfcd826529246b3"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc0MDU3NQ==", "bodyText": "Ah, that would definitely explain it. Thanks for clarifying.", "url": "https://github.com/googleapis/gapic-generator/pull/3163#discussion_r405740575", "createdAt": "2020-04-08T18:49:35Z", "author": {"login": "jskeet"}, "path": "src/main/java/com/google/api/codegen/config/ResourceNameMessageConfigs.java", "diffHunk": "@@ -134,36 +140,40 @@ private static void loadFieldEntityPairFromResourceReferenceAnnotation(\n           \"Only one of child_type and type should be set: %s\",\n           field);\n \n-      if (!childType.isEmpty()) {\n-        List<ResourceDescriptorConfig> parents =\n-            childParentResourceMap.getOrDefault(childType, Collections.emptyList());\n-        for (ResourceDescriptorConfig parentResourceDescriptor : parents) {\n-          String derivedEntityName = parentResourceDescriptor.getDerivedEntityName();\n-          ResourceNameConfig parentResource = resourceNameConfigs.get(derivedEntityName);\n-          Preconditions.checkArgument(\n-              parentResource != null, \"Referencing non-existing parent resource: %s\", childType);\n-          fieldEntityMap.put(field.getSimpleName(), parentResource.getEntityId());\n-        }\n+      if (type.equals(\"*\") || childType.equals(\"*\")) {\n+        fieldEntityMap.put(field.getSimpleName(), \"*\");\n         continue;\n       }\n \n-      if (type.equals(\"*\")) {\n-        fieldEntityMap.put(field.getSimpleName(), \"*\");\n-        continue;\n+      List<ResourceDescriptorConfig> referencedResources;\n+      if (!childType.isEmpty()) {\n+        referencedResources = childParentResourceMap.get(childType);\n+      } else {\n+        referencedResources = Collections.singletonList(descriptorConfigMap.get(type));\n       }\n \n-      String unqualifiedResourceType = ResourceDescriptorConfig.getUnqualifiedTypeName(type);\n-      ResourceNameConfig resourceNameConfig =\n-          resourceNameConfigs.get(unqualifiedResourceType + \"Oneof\");\n-      if (resourceNameConfig != null\n-          && resourceNameConfig.getResourceNameType() == ResourceNameType.ONEOF) {\n-        fieldEntityMap.put(field.getSimpleName(), unqualifiedResourceType + \"Oneof\");\n-        continue;\n+      for (ResourceDescriptorConfig descriptor : referencedResources) {\n+        String unqualifiedName = descriptor.getDerivedEntityName();\n+        ResourceNameConfig resource = resourceNameConfigs.get(unqualifiedName);\n+\n+        switch (resource.getResourceNameType()) {\n+          case ANY:\n+            fieldEntityMap.put(field.getSimpleName(), \"*\");\n+            break;\n+          case SINGLE:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            break;\n+          case ONEOF:\n+            fieldEntityMap.put(field.getSimpleName(), unqualifiedName);\n+            if (((ResourceNameOneofConfig) resource).hasAnyResourceNamePattern()) {\n+              fieldEntityMap.put(field.getSimpleName(), \"*\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI4NTkxOA=="}, "originalCommit": {"oid": "74feb00d6b94ff04fed06c784bfcd826529246b3"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3645, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}