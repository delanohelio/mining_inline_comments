{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NjE0Mzk5", "number": 1384, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMjozMzozMlrOEGk-2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjo0Njo1NlrOEHcjew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzMyODI0OnYy", "diffSide": "RIGHT", "path": "server/src/assembly/resources/conf/iotdb-engine.properties", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMjozMzozMlrOGldh-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwMjozNjo1OFrOGldlOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNDMyOQ==", "bodyText": "Hi~ You should specify the unit of this config. Is it second or millisecond\uff1f", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441934329", "createdAt": "2020-06-18T02:33:32Z", "author": {"login": "SilverNarcissus"}, "path": "server/src/assembly/resources/conf/iotdb-engine.properties", "diffHunk": "@@ -204,6 +204,9 @@ tag_attribute_total_size=700\n # if enable partial insert, one measurement failure will not impact other measurements\n enable_partial_insert=true\n \n+# The interval line numbers of mlog.txt when creating a checkpoint and saving snapshot of mtree", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNTE2MQ==", "bodyText": "I understand it.. It's line number. Forget me XD", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441935161", "createdAt": "2020-06-18T02:36:58Z", "author": {"login": "SilverNarcissus"}, "path": "server/src/assembly/resources/conf/iotdb-engine.properties", "diffHunk": "@@ -204,6 +204,9 @@ tag_attribute_total_size=700\n # if enable partial insert, one measurement failure will not impact other measurements\n enable_partial_insert=true\n \n+# The interval line numbers of mlog.txt when creating a checkpoint and saving snapshot of mtree", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTkzNDMyOQ=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzU3MTE5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNToxNDo1NFrOGlf3mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNzozOToyNFrOGm1L-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MjYzNA==", "bodyText": "Actually, it means the line number of mlog file that is serialized in snapshot. And the current name may be confusing because it's referred to the line number in snapshot log file. So you'd better rename this variable as serializedLineNumber.", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441972634", "createdAt": "2020-06-18T05:14:54Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -72,27 +80,34 @@\n public class MTree implements Serializable {\n \n   private static final long serialVersionUID = -4200394435237291964L;\n+\n   private MNode root;\n+  private int snapshotLineNumber;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5MDQwMQ==", "bodyText": "snapshotedLineNumber is ok...", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441990401", "createdAt": "2020-06-18T06:14:37Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -72,27 +80,34 @@\n public class MTree implements Serializable {\n \n   private static final long serialVersionUID = -4200394435237291964L;\n+\n   private MNode root;\n+  private int snapshotLineNumber;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MjYzNA=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAzNTg4NA==", "bodyText": "Both are good for me. @samperson1997 think mine is better. :D", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r442035884", "createdAt": "2020-06-18T07:52:51Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -72,27 +80,34 @@\n public class MTree implements Serializable {\n \n   private static final long serialVersionUID = -4200394435237291964L;\n+\n   private MNode root;\n+  private int snapshotLineNumber;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MjYzNA=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2MTI3Mw==", "bodyText": "@qiaojialin the past participle of snapshot is snapshot ... When I changed it to snapshoted or snapshotted, the IDE will just give a spelling error hint:", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r442061273", "createdAt": "2020-06-18T08:35:31Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -72,27 +80,34 @@\n public class MTree implements Serializable {\n \n   private static final long serialVersionUID = -4200394435237291964L;\n+\n   private MNode root;\n+  private int snapshotLineNumber;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MjYzNA=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NjE1NQ==", "bodyText": "snapshot is ok", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443346155", "createdAt": "2020-06-22T06:43:37Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -72,27 +80,34 @@\n public class MTree implements Serializable {\n \n   private static final long serialVersionUID = -4200394435237291964L;\n+\n   private MNode root;\n+  private int snapshotLineNumber;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MjYzNA=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NjIxNg==", "bodyText": "add some comment", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443346216", "createdAt": "2020-06-22T06:43:50Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -72,27 +80,34 @@\n public class MTree implements Serializable {\n \n   private static final long serialVersionUID = -4200394435237291964L;\n+\n   private MNode root;\n+  private int snapshotLineNumber;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MjYzNA=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM3MDQ5MA==", "bodyText": "Added", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443370490", "createdAt": "2020-06-22T07:39:24Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -72,27 +80,34 @@\n public class MTree implements Serializable {\n \n   private static final long serialVersionUID = -4200394435237291964L;\n+\n   private MNode root;\n+  private int snapshotLineNumber;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3MjYzNA=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzY2Mjc5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjowNDo1MFrOGlgv7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODozNzowNVrOGllV5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4NzA1Mw==", "bodyText": "whether to enable data partition. If disabled, all data belongs to partition 0", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441987053", "createdAt": "2020-06-18T06:04:50Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -568,11 +568,15 @@\n   private int primitiveArraySize = 64;\n \n   /**\n-   * whether enable data partition\n-   * if disabled, all data belongs to partition 0\n+   * whether enable data partition if disabled, all data belongs to partition 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2MjMxMA==", "bodyText": "Sorry for the wrong format. Fixed", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r442062310", "createdAt": "2020-06-18T08:37:05Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -568,11 +568,15 @@\n   private int primitiveArraySize = 64;\n \n   /**\n-   * whether enable data partition\n-   * if disabled, all data belongs to partition 0\n+   * whether enable data partition if disabled, all data belongs to partition 0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4NzA1Mw=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzY3MDcyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MLogWriter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjowODoyN1rOGlg0mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODozODo0NFrOGllZxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4ODI0OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return lineNumber++;\n          \n          \n            \n                return ++lineNumber;", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441988248", "createdAt": "2020-06-18T06:08:27Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MLogWriter.java", "diffHunk": "@@ -158,17 +149,23 @@ public static void upgradeMLog(String schemaDir, String logFileName) throws IOEx\n         writer.write(buf.toString());\n         writer.newLine();\n         writer.flush();\n-        \n       }\n     }\n \n     // upgrade finished, delete old mlog file\n     if (!logFile.delete()) {\n       throw new IOException(\"Deleting \" + logFile + \"failed.\");\n     }\n-    \n+\n     // rename tmpLogFile to mlog\n     FSFactoryProducer.getFSFactory().moveFile(tmpLogFile, logFile);\n   }\n-  \n+\n+  private int newLine() throws IOException {\n+    writer.newLine();\n+    writer.flush();\n+\n+    // Every MTREE_SNAPSHOT_INTERVAL lines, create a checkpoint and save the MTree as a snapshot\n+    return lineNumber++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2MzMwMg==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r442063302", "createdAt": "2020-06-18T08:38:44Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MLogWriter.java", "diffHunk": "@@ -158,17 +149,23 @@ public static void upgradeMLog(String schemaDir, String logFileName) throws IOEx\n         writer.write(buf.toString());\n         writer.newLine();\n         writer.flush();\n-        \n       }\n     }\n \n     // upgrade finished, delete old mlog file\n     if (!logFile.delete()) {\n       throw new IOException(\"Deleting \" + logFile + \"failed.\");\n     }\n-    \n+\n     // rename tmpLogFile to mlog\n     FSFactoryProducer.getFSFactory().moveFile(tmpLogFile, logFile);\n   }\n-  \n+\n+  private int newLine() throws IOException {\n+    writer.newLine();\n+    writer.flush();\n+\n+    // Every MTREE_SNAPSHOT_INTERVAL lines, create a checkpoint and save the MTree as a snapshot\n+    return lineNumber++;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4ODI0OA=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 116}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzY3OTM0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjoxMjoxMVrOGlg5xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODozODo1OVrOGllaVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4OTU3NQ==", "bodyText": "should this be < ?", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441989575", "createdAt": "2020-06-18T06:12:11Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -199,11 +203,16 @@ public synchronized void init() {\n \n   private void initFromLog(File logFile) throws IOException {\n     // init the metadata from the operation log\n-    mtree = new MTree();\n+    mtree = MTree.deserializeFrom(mtreeSnapshotPath);\n     if (logFile.exists()) {\n       try (FileReader fr = new FileReader(logFile);\n           BufferedReader br = new BufferedReader(fr)) {\n         String cmd;\n+        int idx = 0;\n+        while (idx <= mtree.getSnapshotLineNumber()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAzMzU1NA==", "bodyText": "Well, return lineNumber++ above affects the logic here. Based on your suggection, it's < here.", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r442033554", "createdAt": "2020-06-18T07:48:40Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -199,11 +203,16 @@ public synchronized void init() {\n \n   private void initFromLog(File logFile) throws IOException {\n     // init the metadata from the operation log\n-    mtree = new MTree();\n+    mtree = MTree.deserializeFrom(mtreeSnapshotPath);\n     if (logFile.exists()) {\n       try (FileReader fr = new FileReader(logFile);\n           BufferedReader br = new BufferedReader(fr)) {\n         String cmd;\n+        int idx = 0;\n+        while (idx <= mtree.getSnapshotLineNumber()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4OTU3NQ=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2MzQ0Nw==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r442063447", "createdAt": "2020-06-18T08:38:59Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -199,11 +203,16 @@ public synchronized void init() {\n \n   private void initFromLog(File logFile) throws IOException {\n     // init the metadata from the operation log\n-    mtree = new MTree();\n+    mtree = MTree.deserializeFrom(mtreeSnapshotPath);\n     if (logFile.exists()) {\n       try (FileReader fr = new FileReader(logFile);\n           BufferedReader br = new BufferedReader(fr)) {\n         String cmd;\n+        int idx = 0;\n+        while (idx <= mtree.getSnapshotLineNumber()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk4OTU3NQ=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzY5MDM5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjoxNzoxMlrOGlhAlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwMToyMjozMVrOGmvmRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5MTMxOQ==", "bodyText": "You may need to serialize to a tmp snapshot file first and then rename it to avoid a shutdown when serializing.", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441991319", "createdAt": "2020-06-18T06:17:12Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -899,6 +914,70 @@ private void findNodes(MNode node, String path, List<String> res, int targetLeve\n     }\n   }\n \n+  public int getSnapshotLineNumber() {\n+    return snapshotLineNumber;\n+  }\n+\n+  public void serializeTo(String snapshotPath, int lineNumber) throws IOException {\n+    try (BufferedWriter bw = new BufferedWriter(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI3ODkxNw==", "bodyText": "Updated in latest commit.", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443278917", "createdAt": "2020-06-22T01:22:31Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -899,6 +914,70 @@ private void findNodes(MNode node, String path, List<String> res, int targetLeve\n     }\n   }\n \n+  public int getSnapshotLineNumber() {\n+    return snapshotLineNumber;\n+  }\n+\n+  public void serializeTo(String snapshotPath, int lineNumber) throws IOException {\n+    try (BufferedWriter bw = new BufferedWriter(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5MTMxOQ=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzcwOTg4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjoyNTowOFrOGlhMJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODo0MDowNVrOGlldFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5NDI3Ng==", "bodyText": "We use LinkedHashMap before.", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441994276", "createdAt": "2020-06-18T06:25:08Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -899,6 +914,70 @@ private void findNodes(MNode node, String path, List<String> res, int targetLeve\n     }\n   }\n \n+  public int getSnapshotLineNumber() {\n+    return snapshotLineNumber;\n+  }\n+\n+  public void serializeTo(String snapshotPath, int lineNumber) throws IOException {\n+    try (BufferedWriter bw = new BufferedWriter(\n+        new FileWriter(SystemFileFactory.INSTANCE.getFile(snapshotPath)))) {\n+      bw.write(String.valueOf(lineNumber));\n+      bw.newLine();\n+      root.serializeTo(bw);\n+    }\n+  }\n+\n+  public static MTree deserializeFrom(String mtreeSnapshotPath) throws IOException {\n+    File mtreeSnapshot = SystemFileFactory.INSTANCE.getFile(mtreeSnapshotPath);\n+    if (!mtreeSnapshot.exists()) {\n+      return new MTree();\n+    }\n+\n+    try (BufferedReader br = new BufferedReader(new FileReader(mtreeSnapshot))) {\n+      int snapshotLineNumber = Integer.parseInt(br.readLine());\n+      String s;\n+      Deque<MNode> nodeStack = new ArrayDeque<>();\n+      MNode node = null;\n+\n+      while ((s = br.readLine()) != null) {\n+        String[] nodeInfo = s.split(\",\");\n+        short nodeType = Short.parseShort(nodeInfo[0]);\n+        if (nodeType == MetadataConstant.STORAGE_GROUP_MNODE_TYPE) {\n+          node = StorageGroupMNode.deserializeFrom(nodeInfo);\n+        } else if (nodeType == MetadataConstant.MEASUREMENT_MNODE_TYPE) {\n+          node = MeasurementMNode.deserializeFrom(nodeInfo);\n+        } else {\n+          node = new MNode(null, nodeInfo[1]);\n+        }\n+\n+        int childrenSize = Integer.parseInt(nodeInfo[nodeInfo.length - 1]);\n+        if (childrenSize == 0) {\n+          nodeStack.push(node);\n+        } else {\n+          Map<String, MNode> childrenMap = new TreeMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NDE1MQ==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r442064151", "createdAt": "2020-06-18T08:40:05Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -899,6 +914,70 @@ private void findNodes(MNode node, String path, List<String> res, int targetLeve\n     }\n   }\n \n+  public int getSnapshotLineNumber() {\n+    return snapshotLineNumber;\n+  }\n+\n+  public void serializeTo(String snapshotPath, int lineNumber) throws IOException {\n+    try (BufferedWriter bw = new BufferedWriter(\n+        new FileWriter(SystemFileFactory.INSTANCE.getFile(snapshotPath)))) {\n+      bw.write(String.valueOf(lineNumber));\n+      bw.newLine();\n+      root.serializeTo(bw);\n+    }\n+  }\n+\n+  public static MTree deserializeFrom(String mtreeSnapshotPath) throws IOException {\n+    File mtreeSnapshot = SystemFileFactory.INSTANCE.getFile(mtreeSnapshotPath);\n+    if (!mtreeSnapshot.exists()) {\n+      return new MTree();\n+    }\n+\n+    try (BufferedReader br = new BufferedReader(new FileReader(mtreeSnapshot))) {\n+      int snapshotLineNumber = Integer.parseInt(br.readLine());\n+      String s;\n+      Deque<MNode> nodeStack = new ArrayDeque<>();\n+      MNode node = null;\n+\n+      while ((s = br.readLine()) != null) {\n+        String[] nodeInfo = s.split(\",\");\n+        short nodeType = Short.parseShort(nodeInfo[0]);\n+        if (nodeType == MetadataConstant.STORAGE_GROUP_MNODE_TYPE) {\n+          node = StorageGroupMNode.deserializeFrom(nodeInfo);\n+        } else if (nodeType == MetadataConstant.MEASUREMENT_MNODE_TYPE) {\n+          node = MeasurementMNode.deserializeFrom(nodeInfo);\n+        } else {\n+          node = new MNode(null, nodeInfo[1]);\n+        }\n+\n+        int childrenSize = Integer.parseInt(nodeInfo[nodeInfo.length - 1]);\n+        if (childrenSize == 0) {\n+          nodeStack.push(node);\n+        } else {\n+          Map<String, MNode> childrenMap = new TreeMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5NDI3Ng=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 154}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MzcxNjM5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjoyNzo0MFrOGlhQGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODo0MToyOVrOGllggA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5NTI4OQ==", "bodyText": "catch all exception and return an empty MTree if meet a broken file", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r441995289", "createdAt": "2020-06-18T06:27:40Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -899,6 +914,70 @@ private void findNodes(MNode node, String path, List<String> res, int targetLeve\n     }\n   }\n \n+  public int getSnapshotLineNumber() {\n+    return snapshotLineNumber;\n+  }\n+\n+  public void serializeTo(String snapshotPath, int lineNumber) throws IOException {\n+    try (BufferedWriter bw = new BufferedWriter(\n+        new FileWriter(SystemFileFactory.INSTANCE.getFile(snapshotPath)))) {\n+      bw.write(String.valueOf(lineNumber));\n+      bw.newLine();\n+      root.serializeTo(bw);\n+    }\n+  }\n+\n+  public static MTree deserializeFrom(String mtreeSnapshotPath) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NTAyNA==", "bodyText": "Good point! Fixed.", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r442065024", "createdAt": "2020-06-18T08:41:29Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -899,6 +914,70 @@ private void findNodes(MNode node, String path, List<String> res, int targetLeve\n     }\n   }\n \n+  public int getSnapshotLineNumber() {\n+    return snapshotLineNumber;\n+  }\n+\n+  public void serializeTo(String snapshotPath, int lineNumber) throws IOException {\n+    try (BufferedWriter bw = new BufferedWriter(\n+        new FileWriter(SystemFileFactory.INSTANCE.getFile(snapshotPath)))) {\n+      bw.write(String.valueOf(lineNumber));\n+      bw.newLine();\n+      root.serializeTo(bw);\n+    }\n+  }\n+\n+  public static MTree deserializeFrom(String mtreeSnapshotPath) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk5NTI4OQ=="}, "originalCommit": {"oid": "4a105fd9b726e15c28b3c39c2fb140ddfb9e619c"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjM3NDg0OnYy", "diffSide": "RIGHT", "path": "docs/SystemDesign/SchemaManager/SchemaManager.md", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjoyMToyN1rOGmzPXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNzoyMzozNlrOGm0uVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzODU5MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            * Common MNode: 0,name,children size\n          \n          \n            \n            * MNode: 0,name,children size", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443338591", "createdAt": "2020-06-22T06:21:27Z", "author": {"login": "qiaojialin"}, "path": "docs/SystemDesign/SchemaManager/SchemaManager.md", "diffHunk": "@@ -175,6 +175,16 @@ The root node exists by default. Creating storage groups, deleting storage group\n \n * Deleting a storage group is similar to deleting a time series. That is, the storage group or time series node is deleted in its parent node. The time series node also needs to delete its alias in the parent node; if in the deletion process, a node is found not to have any child node, needs to be deleted recursively.\n \t\n+## MTree checkpoint\n+\n+To speed up restarting of IoTDB, we set checkpoint for MTree. Every several minutes, background thread checks the last modified time of MTree. If users haven\u2019t modified MTree for more than 1 hour (which means `mlog.txt` hasn\u2019t been updated for more than 1 hour), and `mlog.txt` has reached the threshold line number of user configuration, MTree snapshot is created. In this way, we could avoid reading mlog.txt and executing the commands line by line. \n+\n+The serialization of MTree is depth-first from children to parent. Information of nodes are converted into String according to different node types, which is convenient for deserialization.\n+\n+* Common MNode: 0,name,children size", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2MjkwMQ==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443362901", "createdAt": "2020-06-22T07:23:36Z", "author": {"login": "samperson1997"}, "path": "docs/SystemDesign/SchemaManager/SchemaManager.md", "diffHunk": "@@ -175,6 +175,16 @@ The root node exists by default. Creating storage groups, deleting storage group\n \n * Deleting a storage group is similar to deleting a time series. That is, the storage group or time series node is deleted in its parent node. The time series node also needs to delete its alias in the parent node; if in the deletion process, a node is found not to have any child node, needs to be deleted recursively.\n \t\n+## MTree checkpoint\n+\n+To speed up restarting of IoTDB, we set checkpoint for MTree. Every several minutes, background thread checks the last modified time of MTree. If users haven\u2019t modified MTree for more than 1 hour (which means `mlog.txt` hasn\u2019t been updated for more than 1 hour), and `mlog.txt` has reached the threshold line number of user configuration, MTree snapshot is created. In this way, we could avoid reading mlog.txt and executing the commands line by line. \n+\n+The serialization of MTree is depth-first from children to parent. Information of nodes are converted into String according to different node types, which is convenient for deserialization.\n+\n+* Common MNode: 0,name,children size", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMzODU5MQ=="}, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjM5NzY0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjozMTozM1rOGmzcrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNzoyMzo1OVrOGm0vDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0MTk5OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private int mtreeSnapshotInterval = 1000000;\n          \n          \n            \n              private int mtreeSnapshotInterval = 100000;", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443341998", "createdAt": "2020-06-22T06:31:33Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -568,11 +568,21 @@\n   private int primitiveArraySize = 64;\n \n   /**\n-   * whether enable data partition\n-   * if disabled, all data belongs to partition 0\n+   * whether enable data partition. If disabled, all data belongs to partition 0\n    */\n   private boolean enablePartition = false;\n \n+  /**\n+   * Interval line number of mlog.txt when creating a checkpoint and saving snapshot of mtree\n+   */\n+  private int mtreeSnapshotInterval = 1000000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2MzA4Ng==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443363086", "createdAt": "2020-06-22T07:23:59Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -568,11 +568,21 @@\n   private int primitiveArraySize = 64;\n \n   /**\n-   * whether enable data partition\n-   * if disabled, all data belongs to partition 0\n+   * whether enable data partition. If disabled, all data belongs to partition 0\n    */\n   private boolean enablePartition = false;\n \n+  /**\n+   * Interval line number of mlog.txt when creating a checkpoint and saving snapshot of mtree\n+   */\n+  private int mtreeSnapshotInterval = 1000000;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0MTk5OA=="}, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjQxNzMyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjo0MDozN1rOGmzouQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNzozMDozM1rOGm07rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NTA4MQ==", "bodyText": "replace this by config", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443345081", "createdAt": "2020-06-22T06:40:37Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1702,4 +1766,31 @@ public void cacheSchema(String path, MeasurementSchema schema) {\n       mRemoteSchemaCache.put(path, schema);\n     }\n   }\n+\n+  private void checkMTreeModified() {\n+    if (System.currentTimeMillis() - logFile.lastModified() < 60 * 60 * 1000) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 381}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2NjMxOA==", "bodyText": "Moved as a static final value", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443366318", "createdAt": "2020-06-22T07:30:33Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1702,4 +1766,31 @@ public void cacheSchema(String path, MeasurementSchema schema) {\n       mRemoteSchemaCache.put(path, schema);\n     }\n   }\n+\n+  private void checkMTreeModified() {\n+    if (System.currentTimeMillis() - logFile.lastModified() < 60 * 60 * 1000) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NTA4MQ=="}, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 381}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjQxOTMxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjo0MToyN1rOGmzp6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNzozMTo1OFrOGm0-Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NTM4NQ==", "bodyText": "remove tmp file", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443345385", "createdAt": "2020-06-22T06:41:27Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1702,4 +1766,31 @@ public void cacheSchema(String path, MeasurementSchema schema) {\n       mRemoteSchemaCache.put(path, schema);\n     }\n   }\n+\n+  private void checkMTreeModified() {\n+    if (System.currentTimeMillis() - logFile.lastModified() < 60 * 60 * 1000) {\n+      logger.info(\"MTree snapshot is not created because of active modification\");\n+    } else if (logWriter.getLineNumber() - lastSnapshotLogLineNumber < mtreeSnapshotInterval) {\n+      logger.info(\"MTree snapshot need not be created\");\n+    } else {\n+      lock.writeLock().lock();\n+      logger.info(\"Start creating MTree snapshot. This may take a while...\");\n+      try {\n+        mtree.serializeTo(mtreeSnapshotTmpPath, logWriter.getLineNumber());\n+        lastSnapshotLogLineNumber = logWriter.getLineNumber();\n+        File tmpFile = SystemFileFactory.INSTANCE.getFile(mtreeSnapshotTmpPath);\n+        File snapshotFile = SystemFileFactory.INSTANCE.getFile(mtreeSnapshotPath);\n+        if (snapshotFile.exists()) {\n+          Files.delete(snapshotFile.toPath());\n+        }\n+        if (tmpFile.renameTo(snapshotFile)) {\n+          logger.info(\"Finish creating MTree snapshot to {}.\", mtreeSnapshotPath);\n+        }\n+      } catch (IOException e) {\n+        logger.warn(\"Failed to create MTree snapshot to {}\", mtreeSnapshotPath, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 400}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2Njk1OA==", "bodyText": "No need. It will be removed when restarting", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443366958", "createdAt": "2020-06-22T07:31:58Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1702,4 +1766,31 @@ public void cacheSchema(String path, MeasurementSchema schema) {\n       mRemoteSchemaCache.put(path, schema);\n     }\n   }\n+\n+  private void checkMTreeModified() {\n+    if (System.currentTimeMillis() - logFile.lastModified() < 60 * 60 * 1000) {\n+      logger.info(\"MTree snapshot is not created because of active modification\");\n+    } else if (logWriter.getLineNumber() - lastSnapshotLogLineNumber < mtreeSnapshotInterval) {\n+      logger.info(\"MTree snapshot need not be created\");\n+    } else {\n+      lock.writeLock().lock();\n+      logger.info(\"Start creating MTree snapshot. This may take a while...\");\n+      try {\n+        mtree.serializeTo(mtreeSnapshotTmpPath, logWriter.getLineNumber());\n+        lastSnapshotLogLineNumber = logWriter.getLineNumber();\n+        File tmpFile = SystemFileFactory.INSTANCE.getFile(mtreeSnapshotTmpPath);\n+        File snapshotFile = SystemFileFactory.INSTANCE.getFile(mtreeSnapshotPath);\n+        if (snapshotFile.exists()) {\n+          Files.delete(snapshotFile.toPath());\n+        }\n+        if (tmpFile.renameTo(snapshotFile)) {\n+          logger.info(\"Finish creating MTree snapshot to {}.\", mtreeSnapshotPath);\n+        }\n+      } catch (IOException e) {\n+        logger.warn(\"Failed to create MTree snapshot to {}\", mtreeSnapshotPath, e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NTM4NQ=="}, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 400}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjQyMjM2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjo0MjozN1rOGmzroA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNzozMzoxOVrOGm1AkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NTgyNA==", "bodyText": "log the line number", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443345824", "createdAt": "2020-06-22T06:42:37Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1702,4 +1766,31 @@ public void cacheSchema(String path, MeasurementSchema schema) {\n       mRemoteSchemaCache.put(path, schema);\n     }\n   }\n+\n+  private void checkMTreeModified() {\n+    if (System.currentTimeMillis() - logFile.lastModified() < 60 * 60 * 1000) {\n+      logger.info(\"MTree snapshot is not created because of active modification\");\n+    } else if (logWriter.getLineNumber() - lastSnapshotLogLineNumber < mtreeSnapshotInterval) {\n+      logger.info(\"MTree snapshot need not be created\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 384}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2NzU2OA==", "bodyText": "Added", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443367568", "createdAt": "2020-06-22T07:33:19Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1702,4 +1766,31 @@ public void cacheSchema(String path, MeasurementSchema schema) {\n       mRemoteSchemaCache.put(path, schema);\n     }\n   }\n+\n+  private void checkMTreeModified() {\n+    if (System.currentTimeMillis() - logFile.lastModified() < 60 * 60 * 1000) {\n+      logger.info(\"MTree snapshot is not created because of active modification\");\n+    } else if (logWriter.getLineNumber() - lastSnapshotLogLineNumber < mtreeSnapshotInterval) {\n+      logger.info(\"MTree snapshot need not be created\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NTgyNA=="}, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 384}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjQyMzczOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjo0MzoxM1rOGmzsag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNzozMzoyOVrOGm1A5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NjAyNg==", "bodyText": "use read lock", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443346026", "createdAt": "2020-06-22T06:43:13Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1702,4 +1766,31 @@ public void cacheSchema(String path, MeasurementSchema schema) {\n       mRemoteSchemaCache.put(path, schema);\n     }\n   }\n+\n+  private void checkMTreeModified() {\n+    if (System.currentTimeMillis() - logFile.lastModified() < 60 * 60 * 1000) {\n+      logger.info(\"MTree snapshot is not created because of active modification\");\n+    } else if (logWriter.getLineNumber() - lastSnapshotLogLineNumber < mtreeSnapshotInterval) {\n+      logger.info(\"MTree snapshot need not be created\");\n+    } else {\n+      lock.writeLock().lock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 386}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2NzY1Mg==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443367652", "createdAt": "2020-06-22T07:33:29Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -1702,4 +1766,31 @@ public void cacheSchema(String path, MeasurementSchema schema) {\n       mRemoteSchemaCache.put(path, schema);\n     }\n   }\n+\n+  private void checkMTreeModified() {\n+    if (System.currentTimeMillis() - logFile.lastModified() < 60 * 60 * 1000) {\n+      logger.info(\"MTree snapshot is not created because of active modification\");\n+    } else if (logWriter.getLineNumber() - lastSnapshotLogLineNumber < mtreeSnapshotInterval) {\n+      logger.info(\"MTree snapshot need not be created\");\n+    } else {\n+      lock.writeLock().lock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NjAyNg=="}, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 386}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2MjQzMzIzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNjo0Njo1NlrOGmzx_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNzozNjo1OFrOGm1HSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NzQ1Mg==", "bodyText": "just remind, make sure if the snapshot is crashed, we can still recover the MTree from mlog", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443347452", "createdAt": "2020-06-22T06:46:56Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -899,6 +918,69 @@ private void findNodes(MNode node, String path, List<String> res, int targetLeve\n     }\n   }\n \n+  public int getSnapshotLineNumber() {\n+    return snapshotLineNumber;\n+  }\n+\n+  public void serializeTo(String snapshotPath, int lineNumber) throws IOException {\n+    try (BufferedWriter bw = new BufferedWriter(\n+        new FileWriter(SystemFileFactory.INSTANCE.getFile(snapshotPath)))) {\n+      bw.write(String.valueOf(lineNumber));\n+      bw.newLine();\n+      root.serializeTo(bw);\n+    }\n+  }\n+\n+  public static MTree deserializeFrom(File mtreeSnapshot) {\n+    try (BufferedReader br = new BufferedReader(new FileReader(mtreeSnapshot))) {\n+      int snapshotLineNumber = Integer.parseInt(br.readLine());\n+      String s;\n+      Deque<MNode> nodeStack = new ArrayDeque<>();\n+      MNode node = null;\n+\n+      while ((s = br.readLine()) != null) {\n+        String[] nodeInfo = s.split(\",\");\n+        short nodeType = Short.parseShort(nodeInfo[0]);\n+        if (nodeType == MetadataConstant.STORAGE_GROUP_MNODE_TYPE) {\n+          node = StorageGroupMNode.deserializeFrom(nodeInfo);\n+        } else if (nodeType == MetadataConstant.MEASUREMENT_MNODE_TYPE) {\n+          node = MeasurementMNode.deserializeFrom(nodeInfo);\n+        } else {\n+          node = new MNode(null, nodeInfo[1]);\n+        }\n+\n+        int childrenSize = Integer.parseInt(nodeInfo[nodeInfo.length - 1]);\n+        if (childrenSize == 0) {\n+          nodeStack.push(node);\n+        } else {\n+          Map<String, MNode> childrenMap = new LinkedHashMap<>();\n+          for (int i = 0; i < childrenSize; i++) {\n+            MNode child = nodeStack.removeFirst();\n+            child.setParent(node);\n+            childrenMap.put(child.getName(), child);\n+            if (child instanceof MeasurementMNode) {\n+              String alias = ((MeasurementMNode) child).getAlias();\n+              if (alias != null) {\n+                node.addAlias(alias, child);\n+              }\n+            }\n+          }\n+          node.setChildren(childrenMap);\n+          nodeStack.push(node);\n+        }\n+      }\n+      return new MTree(node, snapshotLineNumber);\n+    } catch (IOException e) {\n+      logger.warn(\"Failed to deserialize from {}. Use a new MTree.\", mtreeSnapshot.getPath());\n+      return new MTree();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 181}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM2OTI4OQ==", "bodyText": "Sure, the logic is in MManager:\n   if (!mtreeSnapshot.exists()) {\n      mtree = new MTree();\n    } else {\n      mtree = MTree.deserializeFrom(mtreeSnapshot);\n    }\n\nWe could always ensure the correctness of .snapshot file since we have .snapshot.tmp file as a \"buffer\" file", "url": "https://github.com/apache/iotdb/pull/1384#discussion_r443369289", "createdAt": "2020-06-22T07:36:58Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -899,6 +918,69 @@ private void findNodes(MNode node, String path, List<String> res, int targetLeve\n     }\n   }\n \n+  public int getSnapshotLineNumber() {\n+    return snapshotLineNumber;\n+  }\n+\n+  public void serializeTo(String snapshotPath, int lineNumber) throws IOException {\n+    try (BufferedWriter bw = new BufferedWriter(\n+        new FileWriter(SystemFileFactory.INSTANCE.getFile(snapshotPath)))) {\n+      bw.write(String.valueOf(lineNumber));\n+      bw.newLine();\n+      root.serializeTo(bw);\n+    }\n+  }\n+\n+  public static MTree deserializeFrom(File mtreeSnapshot) {\n+    try (BufferedReader br = new BufferedReader(new FileReader(mtreeSnapshot))) {\n+      int snapshotLineNumber = Integer.parseInt(br.readLine());\n+      String s;\n+      Deque<MNode> nodeStack = new ArrayDeque<>();\n+      MNode node = null;\n+\n+      while ((s = br.readLine()) != null) {\n+        String[] nodeInfo = s.split(\",\");\n+        short nodeType = Short.parseShort(nodeInfo[0]);\n+        if (nodeType == MetadataConstant.STORAGE_GROUP_MNODE_TYPE) {\n+          node = StorageGroupMNode.deserializeFrom(nodeInfo);\n+        } else if (nodeType == MetadataConstant.MEASUREMENT_MNODE_TYPE) {\n+          node = MeasurementMNode.deserializeFrom(nodeInfo);\n+        } else {\n+          node = new MNode(null, nodeInfo[1]);\n+        }\n+\n+        int childrenSize = Integer.parseInt(nodeInfo[nodeInfo.length - 1]);\n+        if (childrenSize == 0) {\n+          nodeStack.push(node);\n+        } else {\n+          Map<String, MNode> childrenMap = new LinkedHashMap<>();\n+          for (int i = 0; i < childrenSize; i++) {\n+            MNode child = nodeStack.removeFirst();\n+            child.setParent(node);\n+            childrenMap.put(child.getName(), child);\n+            if (child instanceof MeasurementMNode) {\n+              String alias = ((MeasurementMNode) child).getAlias();\n+              if (alias != null) {\n+                node.addAlias(alias, child);\n+              }\n+            }\n+          }\n+          node.setChildren(childrenMap);\n+          nodeStack.push(node);\n+        }\n+      }\n+      return new MTree(node, snapshotLineNumber);\n+    } catch (IOException e) {\n+      logger.warn(\"Failed to deserialize from {}. Use a new MTree.\", mtreeSnapshot.getPath());\n+      return new MTree();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM0NzQ1Mg=="}, "originalCommit": {"oid": "1c01f8c85ed4441f8f2498de54374658c17698fe"}, "originalPosition": 181}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4791, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}