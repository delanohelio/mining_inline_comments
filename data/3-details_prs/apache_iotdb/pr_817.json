{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1OTQ0NTk0", "number": 817, "title": "[IOTDB-497] Apache Flink Connector Support", "bodyText": "We all know that Apache Flink is one of the most popular stream computing engine, which is widely used in IOT scenes.\nThis module is the IoTDB integration for Apache Flink, including the IoTDB sink that allows a Flink job to write events into timeseries.\nThe changes are as following:\n\nFlink IoTDB Sink\nUser defined IoTSerializationSchema  interface and the default implementation DefaultIoTSerializationSchema\nUTs for IoTDB Sink in iotdb-flink-connector/test\nExamples for IoTDB Sink in example/flink-example\nDocuments", "createdAt": "2020-02-17T05:18:15Z", "url": "https://github.com/apache/iotdb/pull/817", "merged": true, "mergeCommit": {"oid": "f7c850f89772579f7d1b8a1589929c28754efbca"}, "closed": true, "closedAt": "2020-03-07T13:20:48Z", "author": {"login": "vesense"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFGND6AH2gAyMzc1OTQ0NTk0OjBhZmE0ZmVjOGRhNjc4NTI0OTBjMDNhZjcwZTI5ZWJiMDRlNDQyOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLL5nOAH2gAyMzc1OTQ0NTk0OjMyZjMyZjYyZjYyYTVmZGI1OWZhNzUxYTAwNTU2NTA1ZmI2MDQxMTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0afa4fec8da67852490c03af70e29ebb04e4429f", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/0afa4fec8da67852490c03af70e29ebb04e4429f", "committedDate": "2020-02-17T05:09:24Z", "message": "[IOTDB-497] Apache Flink Connector Support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d74e6cbb325f5fbdac7e019356eb953dcad6a427", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/d74e6cbb325f5fbdac7e019356eb953dcad6a427", "committedDate": "2020-02-18T14:17:18Z", "message": "[IOTDB-503] Add checkTimeseriesExists for session"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDAxNTAw", "url": "https://github.com/apache/iotdb/pull/817#pullrequestreview-360401500", "createdAt": "2020-02-18T14:52:51Z", "commit": {"oid": "0afa4fec8da67852490c03af70e29ebb04e4429f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDo1Mjo1MlrOFrFXVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDo1Mjo1MlrOFrFXVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcyMDk4MQ==", "bodyText": "Hi, is that possible to get the datatype of the sensor?\nAs IoTDB compresses int/long/float/double better than text, and in some applications, users know what data type their data is.\nBy the way, it is recommended that using CompressionType.SNAPPY by default.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r380720981", "createdAt": "2020-02-18T14:52:52Z", "author": {"login": "jixuan1989"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTDBSink.java", "diffHunk": "@@ -0,0 +1,155 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.runtime.state.FunctionInitializationContext;\n+import org.apache.flink.runtime.state.FunctionSnapshotContext;\n+import org.apache.flink.streaming.api.checkpoint.CheckpointedFunction;\n+import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;\n+import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;\n+import org.apache.iotdb.service.rpc.thrift.TSStatus;\n+import org.apache.iotdb.session.Session;\n+import org.apache.iotdb.tsfile.file.metadata.enums.CompressionType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSEncoding;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+public class IoTDBSink<IN> extends RichSinkFunction<IN> implements CheckpointedFunction {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final Logger LOG = LoggerFactory.getLogger(IoTDBSink.class);\n+\n+    private IoTSerializationSchema<IN> serializationSchema;\n+    private IoTDBOptions options;\n+    private transient Session session;\n+\n+    private boolean batchFlushOnCheckpoint; // false by default\n+    private int batchSize = 100;\n+    private List<Event> batchList;\n+\n+    public IoTDBSink(IoTDBOptions options, IoTSerializationSchema<IN> schema) {\n+        this.options = options;\n+        this.serializationSchema = schema;\n+    }\n+\n+    @Override\n+    public void open(Configuration parameters) throws Exception {\n+        batchList = new LinkedList<>();\n+\n+        session = new Session(options.getHost(), options.getPort(), options.getUser(), options.getPassword());\n+        session.open();\n+\n+        session.setStorageGroup(options.getStorageGroup());\n+        for (String sensor : options.getTimeseries()) {\n+            session.createTimeseries(sensor, TSDataType.TEXT, TSEncoding.PLAIN, CompressionType.UNCOMPRESSED);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0afa4fec8da67852490c03af70e29ebb04e4429f"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDA3Njg5", "url": "https://github.com/apache/iotdb/pull/817#pullrequestreview-360407689", "createdAt": "2020-02-18T14:59:40Z", "commit": {"oid": "0afa4fec8da67852490c03af70e29ebb04e4429f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDo1OTo0MFrOFrFpiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDo1OTo0MFrOFrFpiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcyNTY0Mw==", "bodyText": "In many applications, when a monitored device sends data to the server, it does not just send one data point.\nInstead, it sends a \"row\", i.e., several measurements and their values. (And in some applications, they even sends data with several timestamps, but it is not very common.)\nAs far as I know, a device may have more than 100 measurements in the industrial applications. In this case, splitting a \"row\" into many Events may burden Flink as well as IoTDB (because there are too many small TCP packets).\nHow do you think?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r380725643", "createdAt": "2020-02-18T14:59:40Z", "author": {"login": "jixuan1989"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/Event.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+public class Event {\n+    private String device;\n+    private Long timestamp;\n+    private String measurement;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0afa4fec8da67852490c03af70e29ebb04e4429f"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2e23005a92add66988556579f4bf412741b7733", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/d2e23005a92add66988556579f4bf412741b7733", "committedDate": "2020-02-20T15:27:01Z", "message": "[IOTDB-503] Add checkTimeseriesExists for session"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/115b8cec1082524ff5ef18af2e4ede53762fdc8b", "committedDate": "2020-02-20T15:32:09Z", "message": "[IOTDB-497] Addressed review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTgwOTY2", "url": "https://github.com/apache/iotdb/pull/817#pullrequestreview-362980966", "createdAt": "2020-02-21T23:50:19Z", "commit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "state": "COMMENTED", "comments": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMzo1MDoxOVrOFtHxAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQwMzo0Mzo0NlrOFtJUKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1NzQ3NA==", "bodyText": "Add newline at end of file.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382857474", "createdAt": "2020-02-21T23:50:19Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/DefaultIoTSerializationSchema.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DefaultIoTSerializationSchema implements IoTSerializationSchema<Map<String,String>> {\n+    public static final String FIELD_DEVICE = \"device\";\n+    public static final String FIELD_TIMESTAMP = \"timestamp\";\n+    public static final String FIELD_MEASUREMENTS = \"measurements\";\n+    public static final String FIELD_VALUES = \"values\";\n+    public static final String DEFAULT_SEPARATOR = \",\";\n+\n+    private Map<String, IoTDBOptions.TimeseriesOption> timeseriesOptionMap;\n+\n+    public DefaultIoTSerializationSchema(IoTDBOptions ioTDBOptions) {\n+        timeseriesOptionMap = new HashMap<>();\n+        for (IoTDBOptions.TimeseriesOption timeseriesOption : ioTDBOptions.getTimeseriesOptionList()) {\n+            timeseriesOptionMap.put(timeseriesOption.getPath(), timeseriesOption);\n+        }\n+    }\n+\n+    @Override\n+    public Event serialize(Map<String,String> tuple) {\n+        if (tuple == null) {\n+            return null;\n+        }\n+\n+        String device = tuple.get(FIELD_DEVICE);\n+\n+        String ts = tuple.get(FIELD_TIMESTAMP);\n+        Long timestamp = ts == null ? System.currentTimeMillis() : Long.parseLong(ts);\n+\n+        List<String> measurements = null;\n+        if (tuple.get(FIELD_MEASUREMENTS) != null) {\n+            measurements = Arrays.asList(tuple.get(FIELD_MEASUREMENTS).split(DEFAULT_SEPARATOR));\n+        }\n+\n+        List<String> values = null;\n+        if (tuple.get(FIELD_VALUES) != null) {\n+            values = Arrays.asList(tuple.get(FIELD_VALUES).split(DEFAULT_SEPARATOR));\n+        }\n+\n+        if (device != null && measurements != null && values != null && measurements.size() == values.size()) {\n+            for (int i = 0; i < measurements.size(); i++) {\n+                String measurement = device + \".\" + measurements.get(i);\n+                IoTDBOptions.TimeseriesOption timeseriesOption = timeseriesOptionMap.get(measurement);\n+                if (timeseriesOption!= null && TSDataType.TEXT.equals(timeseriesOption.getDataType())) {\n+                    // The TEXT data type should be covered by \" or '\n+                    values.set(i, \"'\" + values.get(i) + \"'\");\n+                }\n+            }\n+        }\n+\n+        return new Event(device, timestamp, measurements, values);\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1NzUxMg==", "bodyText": "Add newline at end of file.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382857512", "createdAt": "2020-02-21T23:50:27Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/Event.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import java.util.List;\n+\n+public class Event {\n+    private String device;\n+    private Long timestamp;\n+    private List<String> measurements;\n+    private List<String> values;\n+\n+    public Event(String device, Long timestamp, List<String> measurements, List<String> values) {\n+        this.device = device;\n+        this.timestamp = timestamp;\n+        this.measurements = measurements;\n+        this.values = values;\n+    }\n+\n+    public String getDevice() {\n+        return device;\n+    }\n+\n+    public Long getTimestamp() {\n+        return timestamp;\n+    }\n+\n+    public List<String> getMeasurements() {\n+        return measurements;\n+    }\n+\n+    public List<String> getValues() {\n+        return values;\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1NzYxNA==", "bodyText": "Add newline at end of file.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382857614", "createdAt": "2020-02-21T23:50:54Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTSerializationSchema.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import java.io.Serializable;\n+\n+public interface IoTSerializationSchema<T> extends Serializable {\n+\n+    Event serialize(T tuple);\n+\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1NzY1OA==", "bodyText": "Add newline at end of file.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382857658", "createdAt": "2020-02-21T23:51:03Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/test/java/org/apache/iotdb/flink/IoTDBSinkTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.iotdb.session.Session;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+\n+public class IoTDBSinkTest {\n+\n+    private IoTDBSink ioTDBSink;\n+    private Session session;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.D01.temperature\")));\n+        ioTDBSink = new IoTDBSink(options, new DefaultIoTSerializationSchema(options));\n+\n+        session = mock(Session.class);\n+        ioTDBSink.setSession(session);\n+    }\n+\n+    @Test\n+    public void testSink() throws Exception {\n+        Map tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293000\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"36.5\");\n+\n+        ioTDBSink.invoke(tuple, null);\n+        verify(session).insert(any(String.class), any(Long.class), any(List.class), any(List.class));\n+    }\n+\n+    @Test\n+    public void close() throws Exception {\n+        ioTDBSink.close();\n+        verify(session).close();\n+    }\n+\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1NzgzNA==", "bodyText": "Could you please upgrade the flink version from 1.7.0 to 1.10.0 due to 1.7.0 is not maintained in flink now. detail can be found in\uff1ahttps://flink.apache.org/downloads.html#update-policy-for-old-releases", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382857834", "createdAt": "2020-02-21T23:51:54Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/pom.xml", "diffHunk": "@@ -0,0 +1,78 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+ Licensed to the Apache Software Foundation (ASF) under one or more\n+ contributor license agreements.  See the NOTICE file distributed with\n+ this work for additional information regarding copyright ownership.\n+ The ASF licenses this file to You under the Apache License, Version 2.0\n+ (the \"License\"); you may not use this file except in compliance with\n+ the License.  You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+    <parent>\n+        <groupId>org.apache.iotdb</groupId>\n+        <artifactId>iotdb-parent</artifactId>\n+        <version>0.10.0-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+    <artifactId>flink-iotdb-connector</artifactId>\n+    <packaging>jar</packaging>\n+    <properties>\n+        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+        <compile.version>1.8</compile.version>\n+        <flink.version>1.7.0</flink.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg1ODQzNQ==", "bodyText": "Move to previous line\uff1f", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382858435", "createdAt": "2020-02-21T23:54:49Z", "author": {"login": "sunjincheng121"}, "path": "example/flink-example/src/main/java/org/apache/iotdb/flink/Example.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\n+import org.apache.flink.streaming.api.functions.source.SourceFunction;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class Example {\n+    public static void main(String[] args) {\n+        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+        env.enableCheckpointing(3000);\n+\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setHost(\"127.0.0.1\");\n+        options.setPort(6667);\n+        options.setUser(\"root\");\n+        options.setPassword(\"root\");\n+        options.setStorageGroup(\"root.sg\");\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.d1.s1\")));\n+\n+        IoTSerializationSchema serializationSchema = new DefaultIoTSerializationSchema(options);\n+        IoTDBSink ioTDBSink = new IoTDBSink(options, serializationSchema)\n+                // enable batching\n+                .withBatchFlushOnCheckpoint(true)\n+                .withBatchSize(10)\n+                ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MDAzOQ==", "bodyText": "What if it is set batchsize but not turned on BatchFlushOnCheckpoint? I mean that user always want enable batching if user set batchsize, if so, do we really need  withBatchFlushOnCheckpoint?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382860039", "createdAt": "2020-02-22T00:02:56Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/README.md", "diffHunk": "@@ -0,0 +1,65 @@\n+# IoTDB-Flink-Connector\n+\n+IoTDB integration for [Apache Flink](https://flink.apache.org/). This module includes the iotdb sink that allows a flink job to write events into timeseries.\n+\n+## IoTDBSink\n+To use the `IoTDBSink`,  you need construct an instance of it by specifying `IoTDBOptions` and `IoTSerializationSchema` instances.\n+The `IoTDBSink` send only one event after another by default, but you can change to batch by invoking `withBatchFlushOnCheckpoint(true)`. \n+\n+## Examples\n+The following is an example which receiving events from sensor source and then sending events to iotdb.\n+\n+ ```java\n+StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+        env.enableCheckpointing(3000);\n+\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setHost(\"127.0.0.1\");\n+        options.setPort(6667);\n+        options.setUser(\"root\");\n+        options.setPassword(\"root\");\n+        options.setStorageGroup(\"root.sg\");\n+        options.setTimeseries(Lists.newArrayList(\"root.sg.d1.s1\"));\n+\n+        IoTSerializationSchema serializationSchema = new DefaultIoTSerializationSchema();\n+        IoTDBSink ioTDBSink = new IoTDBSink(options, serializationSchema)\n+                // enable batching\n+                .withBatchFlushOnCheckpoint(true)\n+                .withBatchSize(10)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MDczNg==", "bodyText": "It's better to add java doc for Class :) What do you think?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382860736", "createdAt": "2020-02-22T00:06:38Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/DefaultIoTSerializationSchema.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DefaultIoTSerializationSchema implements IoTSerializationSchema<Map<String,String>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2MzYzOA==", "bodyText": "Do not need add this dependency here as It's already added in parent pom.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382863638", "createdAt": "2020-02-22T00:22:53Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/pom.xml", "diffHunk": "@@ -0,0 +1,78 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+ Licensed to the Apache Software Foundation (ASF) under one or more\n+ contributor license agreements.  See the NOTICE file distributed with\n+ this work for additional information regarding copyright ownership.\n+ The ASF licenses this file to You under the Apache License, Version 2.0\n+ (the \"License\"); you may not use this file except in compliance with\n+ the License.  You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+    <parent>\n+        <groupId>org.apache.iotdb</groupId>\n+        <artifactId>iotdb-parent</artifactId>\n+        <version>0.10.0-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+    <artifactId>flink-iotdb-connector</artifactId>\n+    <packaging>jar</packaging>\n+    <properties>\n+        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+        <compile.version>1.8</compile.version>\n+        <flink.version>1.7.0</flink.version>\n+        <scala.binary.version>2.11</scala.binary.version>\n+    </properties>\n+    <dependencies>\n+        <dependency>\n+            <groupId>org.apache.iotdb</groupId>\n+            <artifactId>iotdb-session</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-java</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-streaming-java_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-clients_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-queryable-state-runtime_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>com.google.guava</groupId>\n+            <artifactId>guava</artifactId>\n+            <version>23.0</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>junit</groupId>\n+            <artifactId>junit</artifactId>\n+            <scope>test</scope>\n+            <version>4.12</version>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2Mzg5NQ==", "bodyText": "We do not need define the version here as  It's already added in parent pom.\nAnd It's better to upgrade the parent pom version of guava if we really need the higher version.\nNOTE: I suggest remove this dependency as it's only using in test code(do some change  in test class), or change the scope of this dependency.\nWhat do you think?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382863895", "createdAt": "2020-02-22T00:24:22Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/pom.xml", "diffHunk": "@@ -0,0 +1,78 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+ Licensed to the Apache Software Foundation (ASF) under one or more\n+ contributor license agreements.  See the NOTICE file distributed with\n+ this work for additional information regarding copyright ownership.\n+ The ASF licenses this file to You under the Apache License, Version 2.0\n+ (the \"License\"); you may not use this file except in compliance with\n+ the License.  You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+    <parent>\n+        <groupId>org.apache.iotdb</groupId>\n+        <artifactId>iotdb-parent</artifactId>\n+        <version>0.10.0-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+    <artifactId>flink-iotdb-connector</artifactId>\n+    <packaging>jar</packaging>\n+    <properties>\n+        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+        <compile.version>1.8</compile.version>\n+        <flink.version>1.7.0</flink.version>\n+        <scala.binary.version>2.11</scala.binary.version>\n+    </properties>\n+    <dependencies>\n+        <dependency>\n+            <groupId>org.apache.iotdb</groupId>\n+            <artifactId>iotdb-session</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-java</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-streaming-java_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-clients_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-queryable-state-runtime_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>com.google.guava</groupId>\n+            <artifactId>guava</artifactId>\n+            <version>23.0</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2Mzk1Mg==", "bodyText": "Do we really need add this dependency here?.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382863952", "createdAt": "2020-02-22T00:24:44Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/pom.xml", "diffHunk": "@@ -0,0 +1,78 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+ Licensed to the Apache Software Foundation (ASF) under one or more\n+ contributor license agreements.  See the NOTICE file distributed with\n+ this work for additional information regarding copyright ownership.\n+ The ASF licenses this file to You under the Apache License, Version 2.0\n+ (the \"License\"); you may not use this file except in compliance with\n+ the License.  You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+    <parent>\n+        <groupId>org.apache.iotdb</groupId>\n+        <artifactId>iotdb-parent</artifactId>\n+        <version>0.10.0-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+    <artifactId>flink-iotdb-connector</artifactId>\n+    <packaging>jar</packaging>\n+    <properties>\n+        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+        <compile.version>1.8</compile.version>\n+        <flink.version>1.7.0</flink.version>\n+        <scala.binary.version>2.11</scala.binary.version>\n+    </properties>\n+    <dependencies>\n+        <dependency>\n+            <groupId>org.apache.iotdb</groupId>\n+            <artifactId>iotdb-session</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-java</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-streaming-java_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-clients_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-queryable-state-runtime_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>com.google.guava</groupId>\n+            <artifactId>guava</artifactId>\n+            <version>23.0</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>junit</groupId>\n+            <artifactId>junit</artifactId>\n+            <scope>test</scope>\n+            <version>4.12</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.powermock</groupId>\n+            <artifactId>powermock-module-junit4</artifactId>\n+            <version>1.5.5</version>\n+            <scope>test</scope>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg2ODY5Ng==", "bodyText": "Can we remove this flag as I think batchSize can express the same semantics  with \uff08batchSize+batchFlushOnCheckpoint)?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382868696", "createdAt": "2020-02-22T00:55:17Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTDBSink.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.runtime.state.FunctionInitializationContext;\n+import org.apache.flink.runtime.state.FunctionSnapshotContext;\n+import org.apache.flink.streaming.api.checkpoint.CheckpointedFunction;\n+import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;\n+import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;\n+import org.apache.iotdb.service.rpc.thrift.TSStatus;\n+import org.apache.iotdb.session.Session;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+public class IoTDBSink<IN> extends RichSinkFunction<IN> implements CheckpointedFunction {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final Logger LOG = LoggerFactory.getLogger(IoTDBSink.class);\n+\n+    private IoTSerializationSchema<IN> serializationSchema;\n+    private IoTDBOptions options;\n+    private transient Session session;\n+\n+    private boolean batchFlushOnCheckpoint; // false by default", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3Mjc5MQ==", "bodyText": "100->0", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382872791", "createdAt": "2020-02-22T01:29:00Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTDBSink.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.runtime.state.FunctionInitializationContext;\n+import org.apache.flink.runtime.state.FunctionSnapshotContext;\n+import org.apache.flink.streaming.api.checkpoint.CheckpointedFunction;\n+import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;\n+import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;\n+import org.apache.iotdb.service.rpc.thrift.TSStatus;\n+import org.apache.iotdb.session.Session;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+public class IoTDBSink<IN> extends RichSinkFunction<IN> implements CheckpointedFunction {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final Logger LOG = LoggerFactory.getLogger(IoTDBSink.class);\n+\n+    private IoTSerializationSchema<IN> serializationSchema;\n+    private IoTDBOptions options;\n+    private transient Session session;\n+\n+    private boolean batchFlushOnCheckpoint; // false by default\n+    private int batchSize = 100;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3Nzk3NA==", "bodyText": "Could you please move the License to the top of this file, then we can keep same style with other connector, such as [1][2]?\n[1] https://raw.githubusercontent.com/apache/incubator-iotdb/master/example/rocketmq/readme.md\n[2]https://raw.githubusercontent.com/apache/incubator-iotdb/master/example/kafka/readme.md", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382877974", "createdAt": "2020-02-22T02:24:27Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/README.md", "diffHunk": "@@ -0,0 +1,65 @@\n+# IoTDB-Flink-Connector\n+\n+IoTDB integration for [Apache Flink](https://flink.apache.org/). This module includes the iotdb sink that allows a flink job to write events into timeseries.\n+\n+## IoTDBSink\n+To use the `IoTDBSink`,  you need construct an instance of it by specifying `IoTDBOptions` and `IoTSerializationSchema` instances.\n+The `IoTDBSink` send only one event after another by default, but you can change to batch by invoking `withBatchFlushOnCheckpoint(true)`. \n+\n+## Examples\n+The following is an example which receiving events from sensor source and then sending events to iotdb.\n+\n+ ```java\n+StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+        env.enableCheckpointing(3000);\n+\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setHost(\"127.0.0.1\");\n+        options.setPort(6667);\n+        options.setUser(\"root\");\n+        options.setPassword(\"root\");\n+        options.setStorageGroup(\"root.sg\");\n+        options.setTimeseries(Lists.newArrayList(\"root.sg.d1.s1\"));\n+\n+        IoTSerializationSchema serializationSchema = new DefaultIoTSerializationSchema();\n+        IoTDBSink ioTDBSink = new IoTDBSink(options, serializationSchema)\n+                // enable batching\n+                .withBatchFlushOnCheckpoint(true)\n+                .withBatchSize(10)\n+                ;\n+\n+        env.addSource(new SensorSource())\n+                .name(\"sensor-source\")\n+                .setParallelism(1)\n+\n+                .addSink(ioTDBSink)\n+                .name(\"iotdb-sink\")\n+                .setParallelism(1)\n+        ;\n+\n+        try {\n+            env.execute(\"iotdb-flink-example\");\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+        }\n+ ```\n+\n+\n+## License\n+\n+Licensed to the Apache Software Foundation (ASF) under one", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3ODIwMw==", "bodyText": "I think the folder name for flink example can be named flink for simple. keep the same style with hadoop, kafaka, rocketmq etc. ?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382878203", "createdAt": "2020-02-22T02:27:49Z", "author": {"login": "sunjincheng121"}, "path": "example/flink-example/README.md", "diffHunk": "@@ -0,0 +1,26 @@\n+# IoTDB-Flink-Connector Example", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3ODQ3OA==", "bodyText": "I think the class name Example is little bit not specific enough, and would be great to add a very popular word count example\uff0c What do you think\uff1f", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382878478", "createdAt": "2020-02-22T02:31:45Z", "author": {"login": "sunjincheng121"}, "path": "example/flink-example/src/main/java/org/apache/iotdb/flink/Example.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\n+import org.apache.flink.streaming.api.functions.source.SourceFunction;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class Example {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3ODg1OA==", "bodyText": "Can we move this logic into example(Such as bring up a Thread for IoTDB Server), due to IoTDB.main is really simple to use. Even I think that starting an IoTDB server can be described in the Readme, just like Kafka's readme.[1]\nWhat to you think?\n[1] https://github.com/apache/incubator-iotdb/tree/master/example/kafka", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382878858", "createdAt": "2020-02-22T02:37:38Z", "author": {"login": "sunjincheng121"}, "path": "example/flink-example/src/main/java/org/apache/iotdb/flink/LocalDBServer.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.flink;\n+\n+import org.apache.iotdb.db.service.IoTDB;\n+\n+public class LocalDBServer {\n+    public static void main(String[] args) {\n+        IoTDB.main(args);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3OTczMg==", "bodyText": "If the batch size > 0, then we need a timer for flush the buffer data.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382879732", "createdAt": "2020-02-22T02:51:24Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTDBSink.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.runtime.state.FunctionInitializationContext;\n+import org.apache.flink.runtime.state.FunctionSnapshotContext;\n+import org.apache.flink.streaming.api.checkpoint.CheckpointedFunction;\n+import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;\n+import org.apache.flink.streaming.api.operators.StreamingRuntimeContext;\n+import org.apache.iotdb.service.rpc.thrift.TSStatus;\n+import org.apache.iotdb.session.Session;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+public class IoTDBSink<IN> extends RichSinkFunction<IN> implements CheckpointedFunction {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final Logger LOG = LoggerFactory.getLogger(IoTDBSink.class);\n+\n+    private IoTSerializationSchema<IN> serializationSchema;\n+    private IoTDBOptions options;\n+    private transient Session session;\n+\n+    private boolean batchFlushOnCheckpoint; // false by default\n+    private int batchSize = 100;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MDEyMA==", "bodyText": "Could you please move the License to the top of this file, then we can keep same style with other connector, such as [1][2]?\n[1] https://raw.githubusercontent.com/apache/incubator-iotdb/master/example/rocketmq/readme.md\n[2]https://raw.githubusercontent.com/apache/incubator-iotdb/master/example/kafka/readme.md", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382880120", "createdAt": "2020-02-22T02:57:04Z", "author": {"login": "sunjincheng121"}, "path": "example/flink-example/README.md", "diffHunk": "@@ -0,0 +1,26 @@\n+# IoTDB-Flink-Connector Example\n+\n+## Usage\n+\n+1. Run `LocalDBServer` to launch the iotdb\n+2. Run `Example` to execute the flink job \n+\n+\n+## License\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MDI0OA==", "bodyText": "It's better to add more device data?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382880248", "createdAt": "2020-02-22T02:59:20Z", "author": {"login": "sunjincheng121"}, "path": "example/flink-example/src/main/java/org/apache/iotdb/flink/Example.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\n+import org.apache.flink.streaming.api.functions.source.SourceFunction;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class Example {\n+    public static void main(String[] args) {\n+        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+        env.enableCheckpointing(3000);\n+\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setHost(\"127.0.0.1\");\n+        options.setPort(6667);\n+        options.setUser(\"root\");\n+        options.setPassword(\"root\");\n+        options.setStorageGroup(\"root.sg\");\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.d1.s1\")));\n+\n+        IoTSerializationSchema serializationSchema = new DefaultIoTSerializationSchema(options);\n+        IoTDBSink ioTDBSink = new IoTDBSink(options, serializationSchema)\n+                // enable batching\n+                .withBatchFlushOnCheckpoint(true)\n+                .withBatchSize(10)\n+                ;\n+\n+        env.addSource(new SensorSource())\n+                .name(\"sensor-source\")\n+                .setParallelism(1)\n+\n+                .addSink(ioTDBSink)\n+                .name(\"iotdb-sink\")\n+                .setParallelism(1)\n+        ;\n+\n+        try {\n+            env.execute(\"iotdb-flink-example\");\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    private static class SensorSource implements SourceFunction<Map<String,String>> {\n+        boolean running = true;\n+\n+        @Override\n+        public void run(SourceContext context) throws Exception {\n+            Random random = new Random();\n+            while (running) {\n+                Map tuple = new HashMap();\n+                tuple.put(\"device\", \"root.sg.d1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MDU5MA==", "bodyText": "This is not necessary in this PR, right? [1]\nhttps://github.com/apache/incubator-iotdb/pull/824/files", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382880590", "createdAt": "2020-02-22T03:03:55Z", "author": {"login": "sunjincheng121"}, "path": "example/session/src/main/java/org/apache/iotdb/SessionExample.java", "diffHunk": "@@ -44,9 +44,15 @@ public static void main(String[] args)\n     session.open();\n \n     session.setStorageGroup(\"root.sg1\");\n-    session.createTimeseries(\"root.sg1.d1.s1\", TSDataType.INT64, TSEncoding.RLE, CompressionType.SNAPPY);\n-    session.createTimeseries(\"root.sg1.d1.s2\", TSDataType.INT64, TSEncoding.RLE, CompressionType.SNAPPY);\n-    session.createTimeseries(\"root.sg1.d1.s3\", TSDataType.INT64, TSEncoding.RLE, CompressionType.SNAPPY);\n+    if (session.checkTimeseriesExists(\"root.sg1.d1.s1\")) {\n+      session.createTimeseries(\"root.sg1.d1.s1\", TSDataType.INT64, TSEncoding.RLE, CompressionType.SNAPPY);\n+    }\n+    if (session.checkTimeseriesExists(\"root.sg1.d1.s2\")) {\n+      session.createTimeseries(\"root.sg1.d1.s2\", TSDataType.INT64, TSEncoding.RLE, CompressionType.SNAPPY);\n+    }\n+    if (session.checkTimeseriesExists(\"root.sg1.d1.s3\")) {\n+      session.createTimeseries(\"root.sg1.d1.s3\", TSDataType.INT64, TSEncoding.RLE, CompressionType.SNAPPY);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MDY2MA==", "bodyText": "Move to previous line\uff1f", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382880660", "createdAt": "2020-02-22T03:05:29Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/README.md", "diffHunk": "@@ -0,0 +1,65 @@\n+# IoTDB-Flink-Connector\n+\n+IoTDB integration for [Apache Flink](https://flink.apache.org/). This module includes the iotdb sink that allows a flink job to write events into timeseries.\n+\n+## IoTDBSink\n+To use the `IoTDBSink`,  you need construct an instance of it by specifying `IoTDBOptions` and `IoTSerializationSchema` instances.\n+The `IoTDBSink` send only one event after another by default, but you can change to batch by invoking `withBatchFlushOnCheckpoint(true)`. \n+\n+## Examples\n+The following is an example which receiving events from sensor source and then sending events to iotdb.\n+\n+ ```java\n+StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+        env.enableCheckpointing(3000);\n+\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setHost(\"127.0.0.1\");\n+        options.setPort(6667);\n+        options.setUser(\"root\");\n+        options.setPassword(\"root\");\n+        options.setStorageGroup(\"root.sg\");\n+        options.setTimeseries(Lists.newArrayList(\"root.sg.d1.s1\"));\n+\n+        IoTSerializationSchema serializationSchema = new DefaultIoTSerializationSchema();\n+        IoTDBSink ioTDBSink = new IoTDBSink(options, serializationSchema)\n+                // enable batching\n+                .withBatchFlushOnCheckpoint(true)\n+                .withBatchSize(10)\n+                ;\n+\n+        env.addSource(new SensorSource())\n+                .name(\"sensor-source\")\n+                .setParallelism(1)\n+\n+                .addSink(ioTDBSink)\n+                .name(\"iotdb-sink\")\n+                .setParallelism(1)\n+        ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MDgxMA==", "bodyText": "This is not necessary in this PR, right? [1]\nhttps://github.com/apache/incubator-iotdb/pull/824/files", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382880810", "createdAt": "2020-02-22T03:07:47Z", "author": {"login": "sunjincheng121"}, "path": "session/src/main/java/org/apache/iotdb/session/Session.java", "diffHunk": "@@ -558,6 +558,15 @@ public TSStatus createTimeseries(String path, TSDataType dataType,\n     }\n   }\n \n+  public boolean checkTimeseriesExists(String path) throws IoTDBSessionException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MDk2Mg==", "bodyText": "Why we need this dependency?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382880962", "createdAt": "2020-02-22T03:10:09Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/pom.xml", "diffHunk": "@@ -0,0 +1,78 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+ Licensed to the Apache Software Foundation (ASF) under one or more\n+ contributor license agreements.  See the NOTICE file distributed with\n+ this work for additional information regarding copyright ownership.\n+ The ASF licenses this file to You under the Apache License, Version 2.0\n+ (the \"License\"); you may not use this file except in compliance with\n+ the License.  You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+    <parent>\n+        <groupId>org.apache.iotdb</groupId>\n+        <artifactId>iotdb-parent</artifactId>\n+        <version>0.10.0-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+    <artifactId>flink-iotdb-connector</artifactId>\n+    <packaging>jar</packaging>\n+    <properties>\n+        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+        <compile.version>1.8</compile.version>\n+        <flink.version>1.7.0</flink.version>\n+        <scala.binary.version>2.11</scala.binary.version>\n+    </properties>\n+    <dependencies>\n+        <dependency>\n+            <groupId>org.apache.iotdb</groupId>\n+            <artifactId>iotdb-session</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-java</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MDk2Nw==", "bodyText": "Why we need this dependency?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382880967", "createdAt": "2020-02-22T03:10:22Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/pom.xml", "diffHunk": "@@ -0,0 +1,78 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+ Licensed to the Apache Software Foundation (ASF) under one or more\n+ contributor license agreements.  See the NOTICE file distributed with\n+ this work for additional information regarding copyright ownership.\n+ The ASF licenses this file to You under the Apache License, Version 2.0\n+ (the \"License\"); you may not use this file except in compliance with\n+ the License.  You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+    <parent>\n+        <groupId>org.apache.iotdb</groupId>\n+        <artifactId>iotdb-parent</artifactId>\n+        <version>0.10.0-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+    <artifactId>flink-iotdb-connector</artifactId>\n+    <packaging>jar</packaging>\n+    <properties>\n+        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+        <compile.version>1.8</compile.version>\n+        <flink.version>1.7.0</flink.version>\n+        <scala.binary.version>2.11</scala.binary.version>\n+    </properties>\n+    <dependencies>\n+        <dependency>\n+            <groupId>org.apache.iotdb</groupId>\n+            <artifactId>iotdb-session</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-java</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-streaming-java_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-clients_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MDk3Mw==", "bodyText": "Why we need this dependency?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382880973", "createdAt": "2020-02-22T03:10:32Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/pom.xml", "diffHunk": "@@ -0,0 +1,78 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+ Licensed to the Apache Software Foundation (ASF) under one or more\n+ contributor license agreements.  See the NOTICE file distributed with\n+ this work for additional information regarding copyright ownership.\n+ The ASF licenses this file to You under the Apache License, Version 2.0\n+ (the \"License\"); you may not use this file except in compliance with\n+ the License.  You may obtain a copy of the License at\n+\n+     http://www.apache.org/licenses/LICENSE-2.0\n+\n+ Unless required by applicable law or agreed to in writing, software\n+ distributed under the License is distributed on an \"AS IS\" BASIS,\n+ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ See the License for the specific language governing permissions and\n+ limitations under the License.\n+-->\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+    <parent>\n+        <groupId>org.apache.iotdb</groupId>\n+        <artifactId>iotdb-parent</artifactId>\n+        <version>0.10.0-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+    <artifactId>flink-iotdb-connector</artifactId>\n+    <packaging>jar</packaging>\n+    <properties>\n+        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n+        <compile.version>1.8</compile.version>\n+        <flink.version>1.7.0</flink.version>\n+        <scala.binary.version>2.11</scala.binary.version>\n+    </properties>\n+    <dependencies>\n+        <dependency>\n+            <groupId>org.apache.iotdb</groupId>\n+            <artifactId>iotdb-session</artifactId>\n+            <version>${project.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-java</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-streaming-java_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-clients_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.flink</groupId>\n+            <artifactId>flink-queryable-state-runtime_${scala.binary.version}</artifactId>\n+            <version>${flink.version}</version>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MTIxNg==", "bodyText": "Could you please add some Java Doc for the class :)", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382881216", "createdAt": "2020-02-22T03:14:54Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/Event.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import java.util.List;\n+\n+public class Event {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MjQ4Mg==", "bodyText": "It's better to add test case for batchFlushOnCheckpoint=true?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382882482", "createdAt": "2020-02-22T03:36:54Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/test/java/org/apache/iotdb/flink/IoTDBSinkTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.iotdb.session.Session;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+\n+public class IoTDBSinkTest {\n+\n+    private IoTDBSink ioTDBSink;\n+    private Session session;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.D01.temperature\")));\n+        ioTDBSink = new IoTDBSink(options, new DefaultIoTSerializationSchema(options));\n+\n+        session = mock(Session.class);\n+        ioTDBSink.setSession(session);\n+    }\n+\n+    @Test\n+    public void testSink() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4MjU0OQ==", "bodyText": "It's better to add test case for this class, What do you think?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382882549", "createdAt": "2020-02-22T03:38:30Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/DefaultIoTSerializationSchema.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class DefaultIoTSerializationSchema implements IoTSerializationSchema<Map<String,String>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg4Mjg1OQ==", "bodyText": "It's better add Java Doc for this interface.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r382882859", "createdAt": "2020-02-22T03:43:46Z", "author": {"login": "sunjincheng121"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTSerializationSchema.java", "diffHunk": "@@ -0,0 +1,27 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import java.io.Serializable;\n+\n+public interface IoTSerializationSchema<T> extends Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "115b8cec1082524ff5ef18af2e4ede53762fdc8b"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f12978cc65cfc47f659b837e174d535fe2f53af", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/2f12978cc65cfc47f659b837e174d535fe2f53af", "committedDate": "2020-02-22T11:29:01Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b10c17af87692b9992a07eabd224bf4407600937", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/b10c17af87692b9992a07eabd224bf4407600937", "committedDate": "2020-02-22T11:31:23Z", "message": "Merge branch 'master' into flink_iotdb_connector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/83fc8b53ff4a3bdab7f7839b195ca8addb09901e", "committedDate": "2020-02-25T15:52:23Z", "message": "[IOTDB-497] Addressed review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODQ1Nzcx", "url": "https://github.com/apache/iotdb/pull/817#pullrequestreview-366845771", "createdAt": "2020-03-01T09:23:36Z", "commit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "state": "COMMENTED", "comments": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwOToyMzozNlrOFwNKCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwOTo0ODo1NlrOFwNROQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MTUyOA==", "bodyText": "IMO the separator should be configurable because users' data may contains \",\".", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386091528", "createdAt": "2020-03-01T09:23:36Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/DefaultIoTSerializationSchema.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * @inheritDoc\n+ * The default implementation of IoTSerializationSchema. Gets info from a map struct.\n+ */\n+public class DefaultIoTSerializationSchema implements IoTSerializationSchema<Map<String,String>> {\n+    public static final String FIELD_DEVICE = \"device\";\n+    public static final String FIELD_TIMESTAMP = \"timestamp\";\n+    public static final String FIELD_MEASUREMENTS = \"measurements\";\n+    public static final String FIELD_VALUES = \"values\";\n+    public static final String DEFAULT_SEPARATOR = \",\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MTUzOA==", "bodyText": "Map -> Map<String, String> ?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386091538", "createdAt": "2020-03-01T09:23:48Z", "author": {"login": "WeiZhong94"}, "path": "example/flink/src/main/java/org/apache/iotdb/flink/FlinkIoTDBSink.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\n+import org.apache.flink.streaming.api.functions.source.SourceFunction;\n+import org.apache.iotdb.db.service.IoTDB;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class FlinkIoTDBSink {\n+    public static void main(String[] args) throws Exception {\n+        // launch the local iotDB server at default port: 6667\n+        IoTDB.main(args);\n+\n+        Thread.sleep(3000);\n+\n+        // run the flink job on local mini cluster\n+        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+        env.enableCheckpointing(3000);\n+\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setHost(\"127.0.0.1\");\n+        options.setPort(6667);\n+        options.setUser(\"root\");\n+        options.setPassword(\"root\");\n+        options.setStorageGroup(\"root.sg\");\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.d1.s1\")));\n+\n+        IoTSerializationSchema serializationSchema = new DefaultIoTSerializationSchema(options);\n+        IoTDBSink ioTDBSink = new IoTDBSink(options, serializationSchema)\n+                // enable batching\n+                .withBatchSize(10);\n+\n+        env.addSource(new SensorSource())\n+                .name(\"sensor-source\")\n+                .setParallelism(1)\n+\n+                .addSink(ioTDBSink)\n+                .name(\"iotdb-sink\")\n+                .setParallelism(1);\n+\n+        env.execute(\"iotdb-flink-example\");\n+    }\n+\n+    private static class SensorSource implements SourceFunction<Map<String,String>> {\n+        boolean running = true;\n+\n+        @Override\n+        public void run(SourceContext context) throws Exception {\n+            Random random = new Random();\n+            while (running) {\n+                Map tuple = new HashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MTYyOQ==", "bodyText": "It looks like this method was not covered by the tests.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386091629", "createdAt": "2020-03-01T09:25:09Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTDBSink.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;\n+import org.apache.iotdb.service.rpc.thrift.TSStatus;\n+import org.apache.iotdb.session.Session;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The `IoTDBSink` allows flink jobs to write events into IoTDB timeseries.\n+ * By default send only one event after another, but you can change to batch by invoking `withBatchSize(int)`.\n+ * @param <IN> input type\n+ */\n+public class IoTDBSink<IN> extends RichSinkFunction<IN> {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final Logger LOG = LoggerFactory.getLogger(IoTDBSink.class);\n+\n+    private IoTSerializationSchema<IN> serializationSchema;\n+    private IoTDBOptions options;\n+    private transient Session session;\n+    private transient ScheduledExecutorService scheduledExecutor;\n+\n+    private int batchSize = 0;\n+    private int flushIntervalMs = 3000;\n+    private transient List<Event> batchList;\n+\n+    public IoTDBSink(IoTDBOptions options, IoTSerializationSchema<IN> schema) {\n+        this.options = options;\n+        this.serializationSchema = schema;\n+    }\n+\n+    @Override\n+    public void open(Configuration parameters) throws Exception {\n+        batchList = new LinkedList<>();\n+\n+        session = new Session(options.getHost(), options.getPort(), options.getUser(), options.getPassword());\n+        session.open();\n+\n+        session.setStorageGroup(options.getStorageGroup());\n+        for (IoTDBOptions.TimeseriesOption option : options.getTimeseriesOptionList()) {\n+            if (!session.checkTimeseriesExists(option.getPath())) {\n+                session.createTimeseries(option.getPath(), option.getDataType(), option.getEncoding(), option.getCompressor());\n+            }\n+        }\n+\n+        if (batchSize > 0) {\n+            scheduledExecutor = Executors.newSingleThreadScheduledExecutor();\n+            scheduledExecutor.scheduleAtFixedRate(() -> {\n+                try {\n+                    flush();\n+                } catch (Exception e) {\n+                    LOG.error(\"flush error\", e);\n+                }\n+            }, flushIntervalMs, flushIntervalMs, TimeUnit.MILLISECONDS);\n+        }\n+    }\n+\n+    //  for testing\n+    void setSession(Session session) {\n+        this.session = session;\n+    }\n+\n+    void setBatchList(List<Event> batchList) {\n+        this.batchList = batchList;\n+    }\n+\n+    @Override\n+    public void invoke(IN input, Context context) throws Exception {\n+        Event event = serializationSchema.serialize(input);\n+        if (event == null) {\n+            return;\n+        }\n+\n+        if (batchSize > 0) {\n+            batchList.add(event);\n+            if (batchList.size() >= batchSize) {\n+                flush();\n+            }\n+            return;\n+        }\n+\n+        TSStatus status = session.insert(event.getDevice(), event.getTimestamp(),\n+                event.getMeasurements(), event.getValues());\n+        LOG.debug(\"send event result: {}\", status);\n+    }\n+\n+    public IoTDBSink<IN> withBatchSize(int batchSize) {\n+        Preconditions.checkArgument(batchSize >= 0);\n+        this.batchSize = batchSize;\n+        return this;\n+    }\n+\n+    public IoTDBSink<IN> withFlushIntervalMs(int flushIntervalMs) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MTYzMg==", "bodyText": "It would be better if we can add some description for the param T.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386091632", "createdAt": "2020-03-01T09:25:14Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTSerializationSchema.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import java.io.Serializable;\n+\n+/**\n+ * IoTSerializationSchema serializes the input tuple data into events for inserting into IoTDB server.\n+ * @param <T>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MTgyMQ==", "bodyText": "IMO it would be better if we replace this class with existed class MeasurementSchema. They look similar.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386091821", "createdAt": "2020-03-01T09:27:40Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTDBOptions.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.iotdb.tsfile.file.metadata.enums.CompressionType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSEncoding;\n+\n+import java.io.Serializable;\n+import java.util.List;\n+\n+/**\n+ * IoTDBOptions describes the configuration related information for IoTDB and timeseries.\n+ */\n+public class IoTDBOptions implements Serializable {\n+    private String host;\n+    private int port;\n+    private String user;\n+    private String password;\n+    private String storageGroup;\n+    private List<TimeseriesOption> timeseriesOptionList;\n+\n+    public IoTDBOptions() {\n+    }\n+\n+    public IoTDBOptions(String host, int port, String user, String password,\n+                        String storageGroup, List<TimeseriesOption> timeseriesOptionList) {\n+        this.host = host;\n+        this.port = port;\n+        this.user = user;\n+        this.password = password;\n+        this.storageGroup = storageGroup;\n+        this.timeseriesOptionList = timeseriesOptionList;\n+    }\n+\n+    public String getHost() {\n+        return host;\n+    }\n+\n+    public void setHost(String host) {\n+        this.host = host;\n+    }\n+\n+    public int getPort() {\n+        return port;\n+    }\n+\n+    public void setPort(int port) {\n+        this.port = port;\n+    }\n+\n+    public String getUser() {\n+        return user;\n+    }\n+\n+    public void setUser(String user) {\n+        this.user = user;\n+    }\n+\n+    public String getPassword() {\n+        return password;\n+    }\n+\n+    public void setPassword(String password) {\n+        this.password = password;\n+    }\n+\n+    public String getStorageGroup() {\n+        return storageGroup;\n+    }\n+\n+    public void setStorageGroup(String storageGroup) {\n+        this.storageGroup = storageGroup;\n+    }\n+\n+    public List<TimeseriesOption> getTimeseriesOptionList() {\n+        return timeseriesOptionList;\n+    }\n+\n+    public void setTimeseriesOptionList(List<TimeseriesOption> timeseriesOptionList) {\n+        this.timeseriesOptionList = timeseriesOptionList;\n+    }\n+\n+    public static class TimeseriesOption implements Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MTk2Mw==", "bodyText": "IMO the operations on the batchList also need synchronization as it is possible to read/write this object concurrently.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386091963", "createdAt": "2020-03-01T09:29:35Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTDBSink.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;\n+import org.apache.iotdb.service.rpc.thrift.TSStatus;\n+import org.apache.iotdb.session.Session;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The `IoTDBSink` allows flink jobs to write events into IoTDB timeseries.\n+ * By default send only one event after another, but you can change to batch by invoking `withBatchSize(int)`.\n+ * @param <IN> input type\n+ */\n+public class IoTDBSink<IN> extends RichSinkFunction<IN> {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final Logger LOG = LoggerFactory.getLogger(IoTDBSink.class);\n+\n+    private IoTSerializationSchema<IN> serializationSchema;\n+    private IoTDBOptions options;\n+    private transient Session session;\n+    private transient ScheduledExecutorService scheduledExecutor;\n+\n+    private int batchSize = 0;\n+    private int flushIntervalMs = 3000;\n+    private transient List<Event> batchList;\n+\n+    public IoTDBSink(IoTDBOptions options, IoTSerializationSchema<IN> schema) {\n+        this.options = options;\n+        this.serializationSchema = schema;\n+    }\n+\n+    @Override\n+    public void open(Configuration parameters) throws Exception {\n+        batchList = new LinkedList<>();\n+\n+        session = new Session(options.getHost(), options.getPort(), options.getUser(), options.getPassword());\n+        session.open();\n+\n+        session.setStorageGroup(options.getStorageGroup());\n+        for (IoTDBOptions.TimeseriesOption option : options.getTimeseriesOptionList()) {\n+            if (!session.checkTimeseriesExists(option.getPath())) {\n+                session.createTimeseries(option.getPath(), option.getDataType(), option.getEncoding(), option.getCompressor());\n+            }\n+        }\n+\n+        if (batchSize > 0) {\n+            scheduledExecutor = Executors.newSingleThreadScheduledExecutor();\n+            scheduledExecutor.scheduleAtFixedRate(() -> {\n+                try {\n+                    flush();\n+                } catch (Exception e) {\n+                    LOG.error(\"flush error\", e);\n+                }\n+            }, flushIntervalMs, flushIntervalMs, TimeUnit.MILLISECONDS);\n+        }\n+    }\n+\n+    //  for testing\n+    void setSession(Session session) {\n+        this.session = session;\n+    }\n+\n+    void setBatchList(List<Event> batchList) {\n+        this.batchList = batchList;\n+    }\n+\n+    @Override\n+    public void invoke(IN input, Context context) throws Exception {\n+        Event event = serializationSchema.serialize(input);\n+        if (event == null) {\n+            return;\n+        }\n+\n+        if (batchSize > 0) {\n+            batchList.add(event);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MTk4Ng==", "bodyText": "Map -> Map<String, String> ?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386091986", "createdAt": "2020-03-01T09:30:08Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/test/java/org/apache/iotdb/flink/DefaultIoTSerializationSchemaTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.junit.Test;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.Assert.*;\n+\n+public class DefaultIoTSerializationSchemaTest {\n+\n+    @Test\n+    public void serialize() {\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.D01.temperature\")));\n+        DefaultIoTSerializationSchema serializationSchema = new DefaultIoTSerializationSchema(options);\n+\n+        Map tuple = new HashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MjA0NQ==", "bodyText": "ditto", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386092045", "createdAt": "2020-03-01T09:31:04Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/test/java/org/apache/iotdb/flink/IoTDBSinkBatchInsertTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.iotdb.session.Session;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.*;\n+\n+public class IoTDBSinkBatchInsertTest {\n+\n+    private IoTDBSink ioTDBSink;\n+    private Session session;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.D01.temperature\")));\n+        ioTDBSink = new IoTDBSink(options, new DefaultIoTSerializationSchema(options));\n+        ioTDBSink.withBatchSize(3);\n+\n+        session = mock(Session.class);\n+        ioTDBSink.setSession(session);\n+        ioTDBSink.setBatchList(new ArrayList<>());\n+    }\n+\n+    @Test\n+    public void testBatchInsert() throws Exception {\n+        Map tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293000\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"36.5\");\n+        ioTDBSink.invoke(tuple, null);\n+\n+        verifyZeroInteractions(session);\n+\n+        tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293001\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"37.2\");\n+        ioTDBSink.invoke(tuple, null);\n+\n+        verifyZeroInteractions(session);\n+\n+        tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293003\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"37.1\");\n+        ioTDBSink.invoke(tuple, null);\n+\n+        verify(session).insertInBatch(any(List.class), any(List.class), any(List.class), any(List.class));\n+\n+        tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293005\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"36.5\");\n+        ioTDBSink.invoke(tuple, null);\n+\n+        verifyZeroInteractions(session);\n+    }\n+\n+    @Test\n+    public void close() throws Exception {\n+        Map tuple = new HashMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MjMzNA==", "bodyText": "It seems the comment above it are no longer needed and makes this line confusing. It would be better if we can remove the comment or move this line to upper place?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386092334", "createdAt": "2020-03-01T09:35:27Z", "author": {"login": "WeiZhong94"}, "path": "pom.xml", "diffHunk": "@@ -94,6 +95,7 @@\n         <!-- Exclude all generated code -->\n         <sonar.exclusions>**/generated-sources</sonar.exclusions>\n         <!-- By default, the argLine is empty-->\n+        <guava.version>21.0</guava.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MjczNQ==", "bodyText": "As this logic may be reused in other IoTSerializationSchema (user implemented or RowIoTSerializationSchema in future if we want to support IotDB in Flink Table API), IMO it would be better to move it to IoTDBSink.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386092735", "createdAt": "2020-03-01T09:40:43Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/DefaultIoTSerializationSchema.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * @inheritDoc\n+ * The default implementation of IoTSerializationSchema. Gets info from a map struct.\n+ */\n+public class DefaultIoTSerializationSchema implements IoTSerializationSchema<Map<String,String>> {\n+    public static final String FIELD_DEVICE = \"device\";\n+    public static final String FIELD_TIMESTAMP = \"timestamp\";\n+    public static final String FIELD_MEASUREMENTS = \"measurements\";\n+    public static final String FIELD_VALUES = \"values\";\n+    public static final String DEFAULT_SEPARATOR = \",\";\n+\n+    private Map<String, IoTDBOptions.TimeseriesOption> timeseriesOptionMap;\n+\n+    public DefaultIoTSerializationSchema(IoTDBOptions ioTDBOptions) {\n+        timeseriesOptionMap = new HashMap<>();\n+        for (IoTDBOptions.TimeseriesOption timeseriesOption : ioTDBOptions.getTimeseriesOptionList()) {\n+            timeseriesOptionMap.put(timeseriesOption.getPath(), timeseriesOption);\n+        }\n+    }\n+\n+    @Override\n+    public Event serialize(Map<String,String> tuple) {\n+        if (tuple == null) {\n+            return null;\n+        }\n+\n+        String device = tuple.get(FIELD_DEVICE);\n+\n+        String ts = tuple.get(FIELD_TIMESTAMP);\n+        Long timestamp = ts == null ? System.currentTimeMillis() : Long.parseLong(ts);\n+\n+        List<String> measurements = null;\n+        if (tuple.get(FIELD_MEASUREMENTS) != null) {\n+            measurements = Arrays.asList(tuple.get(FIELD_MEASUREMENTS).split(DEFAULT_SEPARATOR));\n+        }\n+\n+        List<String> values = null;\n+        if (tuple.get(FIELD_VALUES) != null) {\n+            values = Arrays.asList(tuple.get(FIELD_VALUES).split(DEFAULT_SEPARATOR));\n+        }\n+\n+        if (device != null && measurements != null && values != null && measurements.size() == values.size()) {\n+            for (int i = 0; i < measurements.size(); i++) {\n+                String measurement = device + \".\" + measurements.get(i);\n+                IoTDBOptions.TimeseriesOption timeseriesOption = timeseriesOptionMap.get(measurement);\n+                if (timeseriesOption!= null && TSDataType.TEXT.equals(timeseriesOption.getDataType())) {\n+                    // The TEXT data type should be covered by \" or '\n+                    values.set(i, \"'\" + values.get(i) + \"'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5Mjg0OA==", "bodyText": "It seems only the list of TimeseriesOption is needed. We can pass a List<TimeseriesOption> to this constructor directly. (or List<MeasurementSchema> if we replace the class TimeseriesOption with class MeasurementSchema as I suggested above)", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386092848", "createdAt": "2020-03-01T09:41:51Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/DefaultIoTSerializationSchema.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * @inheritDoc\n+ * The default implementation of IoTSerializationSchema. Gets info from a map struct.\n+ */\n+public class DefaultIoTSerializationSchema implements IoTSerializationSchema<Map<String,String>> {\n+    public static final String FIELD_DEVICE = \"device\";\n+    public static final String FIELD_TIMESTAMP = \"timestamp\";\n+    public static final String FIELD_MEASUREMENTS = \"measurements\";\n+    public static final String FIELD_VALUES = \"values\";\n+    public static final String DEFAULT_SEPARATOR = \",\";\n+\n+    private Map<String, IoTDBOptions.TimeseriesOption> timeseriesOptionMap;\n+\n+    public DefaultIoTSerializationSchema(IoTDBOptions ioTDBOptions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MzA4Ng==", "bodyText": "As we do not depends the checkpointing to flush data anymore, this line seems unnecessary.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386093086", "createdAt": "2020-03-01T09:45:28Z", "author": {"login": "WeiZhong94"}, "path": "example/flink/src/main/java/org/apache/iotdb/flink/FlinkIoTDBSink.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\n+import org.apache.flink.streaming.api.functions.source.SourceFunction;\n+import org.apache.iotdb.db.service.IoTDB;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class FlinkIoTDBSink {\n+    public static void main(String[] args) throws Exception {\n+        // launch the local iotDB server at default port: 6667\n+        IoTDB.main(args);\n+\n+        Thread.sleep(3000);\n+\n+        // run the flink job on local mini cluster\n+        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+        env.enableCheckpointing(3000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MzI5MA==", "bodyText": "This empty line looks strange from my side... but it's up to you.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386093290", "createdAt": "2020-03-01T09:48:02Z", "author": {"login": "WeiZhong94"}, "path": "example/flink/src/main/java/org/apache/iotdb/flink/FlinkIoTDBSink.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;\n+import org.apache.flink.streaming.api.functions.source.SourceFunction;\n+import org.apache.iotdb.db.service.IoTDB;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Random;\n+\n+public class FlinkIoTDBSink {\n+    public static void main(String[] args) throws Exception {\n+        // launch the local iotDB server at default port: 6667\n+        IoTDB.main(args);\n+\n+        Thread.sleep(3000);\n+\n+        // run the flink job on local mini cluster\n+        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+        env.enableCheckpointing(3000);\n+\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setHost(\"127.0.0.1\");\n+        options.setPort(6667);\n+        options.setUser(\"root\");\n+        options.setPassword(\"root\");\n+        options.setStorageGroup(\"root.sg\");\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.d1.s1\")));\n+\n+        IoTSerializationSchema serializationSchema = new DefaultIoTSerializationSchema(options);\n+        IoTDBSink ioTDBSink = new IoTDBSink(options, serializationSchema)\n+                // enable batching\n+                .withBatchSize(10);\n+\n+        env.addSource(new SensorSource())\n+                .name(\"sensor-source\")\n+                .setParallelism(1)\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA5MzM2OQ==", "bodyText": "ditto", "url": "https://github.com/apache/iotdb/pull/817#discussion_r386093369", "createdAt": "2020-03-01T09:48:56Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/README.md", "diffHunk": "@@ -0,0 +1,60 @@\n+<!--\n+\n+    Licensed to the Apache Software Foundation (ASF) under one\n+    or more contributor license agreements.  See the NOTICE file\n+    distributed with this work for additional information\n+    regarding copyright ownership.  The ASF licenses this file\n+    to you under the Apache License, Version 2.0 (the\n+    \"License\"); you may not use this file except in compliance\n+    with the License.  You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+    Unless required by applicable law or agreed to in writing,\n+    software distributed under the License is distributed on an\n+    \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+    KIND, either express or implied.  See the License for the\n+    specific language governing permissions and limitations\n+    under the License.\n+\n+-->\n+# IoTDB-Flink-Connector\n+\n+IoTDB integration for [Apache Flink](https://flink.apache.org/). This module includes the iotdb sink that allows a flink job to write events into timeseries.\n+\n+## IoTDBSink\n+To use the `IoTDBSink`,  you need construct an instance of it by specifying `IoTDBOptions` and `IoTSerializationSchema` instances.\n+The `IoTDBSink` send only one event after another by default, but you can change to batch by invoking `withBatchSize(int)`. \n+\n+## Examples\n+The following is an example which receiving events from sensor source and then sending events to iotdb.\n+\n+ ```java\n+StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n+        env.enableCheckpointing(3000);\n+\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setHost(\"127.0.0.1\");\n+        options.setPort(6667);\n+        options.setUser(\"root\");\n+        options.setPassword(\"root\");\n+        options.setStorageGroup(\"root.sg\");\n+        options.setTimeseries(Lists.newArrayList(\"root.sg.d1.s1\"));\n+\n+        IoTSerializationSchema serializationSchema = new DefaultIoTSerializationSchema();\n+        IoTDBSink ioTDBSink = new IoTDBSink(options, serializationSchema)\n+                // enable batching\n+                .withBatchSize(10)\n+                ;\n+\n+        env.addSource(new SensorSource())\n+                .name(\"sensor-source\")\n+                .setParallelism(1)\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83fc8b53ff4a3bdab7f7839b195ca8addb09901e"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b693c5b6c14bb3528e0fab31aaa033a3318507d", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/7b693c5b6c14bb3528e0fab31aaa033a3318507d", "committedDate": "2020-03-04T08:19:58Z", "message": "[IOTDB-497] Addressed review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78778429d60212a6b983d855a955c07e3d93eb69", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/78778429d60212a6b983d855a955c07e3d93eb69", "committedDate": "2020-03-06T03:14:04Z", "message": "[IOTDB-497] Addressed review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9ba5d4cc35fb6f4faaacac4077a1b7ecda6067b", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/b9ba5d4cc35fb6f4faaacac4077a1b7ecda6067b", "committedDate": "2020-03-06T05:02:15Z", "message": "[IOTDB-497] fix ci build error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzUxMTk2", "url": "https://github.com/apache/iotdb/pull/817#pullrequestreview-370351196", "createdAt": "2020-03-06T14:15:51Z", "commit": {"oid": "b9ba5d4cc35fb6f4faaacac4077a1b7ecda6067b"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNDoxNTo1MVrOFy6JGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNDoxODowMlrOFy6N5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNTcyMA==", "bodyText": "Keep the indentation consistent?", "url": "https://github.com/apache/iotdb/pull/817#discussion_r388925720", "createdAt": "2020-03-06T14:15:51Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/README.md", "diffHunk": "@@ -0,0 +1,58 @@\n+<!--\n+\n+    Licensed to the Apache Software Foundation (ASF) under one\n+    or more contributor license agreements.  See the NOTICE file\n+    distributed with this work for additional information\n+    regarding copyright ownership.  The ASF licenses this file\n+    to you under the Apache License, Version 2.0 (the\n+    \"License\"); you may not use this file except in compliance\n+    with the License.  You may obtain a copy of the License at\n+\n+        http://www.apache.org/licenses/LICENSE-2.0\n+\n+    Unless required by applicable law or agreed to in writing,\n+    software distributed under the License is distributed on an\n+    \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+    KIND, either express or implied.  See the License for the\n+    specific language governing permissions and limitations\n+    under the License.\n+\n+-->\n+# IoTDB-Flink-Connector\n+\n+IoTDB integration for [Apache Flink](https://flink.apache.org/). This module includes the iotdb sink that allows a flink job to write events into timeseries.\n+\n+## IoTDBSink\n+To use the `IoTDBSink`,  you need construct an instance of it by specifying `IoTDBOptions` and `IoTSerializationSchema` instances.\n+The `IoTDBSink` send only one event after another by default, but you can change to batch by invoking `withBatchSize(int)`. \n+\n+## Examples\n+The following is an example which receiving events from sensor source and then sending events to iotdb.\n+\n+ ```java\n+StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9ba5d4cc35fb6f4faaacac4077a1b7ecda6067b"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNjI4Ng==", "bodyText": "Unnecessary empty line.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r388926286", "createdAt": "2020-03-06T14:16:48Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/main/java/org/apache/iotdb/flink/IoTDBSink.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.flink.configuration.Configuration;\n+import org.apache.flink.streaming.api.functions.sink.RichSinkFunction;\n+import org.apache.iotdb.service.rpc.thrift.TSStatus;\n+import org.apache.iotdb.session.Session;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * The `IoTDBSink` allows flink jobs to write events into IoTDB timeseries.\n+ * By default send only one event after another, but you can change to batch by invoking `withBatchSize(int)`.\n+ * @param <IN> the input data type\n+ */\n+public class IoTDBSink<IN> extends RichSinkFunction<IN> {\n+\n+    private static final long serialVersionUID = 1L;\n+    private static final Logger LOG = LoggerFactory.getLogger(IoTDBSink.class);\n+\n+    private IoTDBOptions options;\n+    private IoTSerializationSchema<IN> serializationSchema;\n+    private Map<String, IoTDBOptions.TimeseriesOption> timeseriesOptionMap;\n+    private transient Session session;\n+    private transient ScheduledExecutorService scheduledExecutor;\n+\n+    private int batchSize = 0;\n+    private int flushIntervalMs = 3000;\n+    private List<Event> batchList;\n+\n+    public IoTDBSink(IoTDBOptions options, IoTSerializationSchema<IN> schema) {\n+        this.options = options;\n+        this.serializationSchema = schema;\n+        this.batchList = new LinkedList<>();\n+        this.timeseriesOptionMap = new HashMap<>();\n+        for (IoTDBOptions.TimeseriesOption timeseriesOption : options.getTimeseriesOptionList()) {\n+            timeseriesOptionMap.put(timeseriesOption.getPath(), timeseriesOption);\n+        }\n+    }\n+\n+    @Override\n+    public void open(Configuration parameters) throws Exception {\n+        initSession();\n+        initScheduler();\n+    }\n+\n+    void initSession() throws Exception {\n+        session = new Session(options.getHost(), options.getPort(), options.getUser(), options.getPassword());\n+        session.open();\n+\n+        session.setStorageGroup(options.getStorageGroup());\n+        for (IoTDBOptions.TimeseriesOption option : options.getTimeseriesOptionList()) {\n+            if (!session.checkTimeseriesExists(option.getPath())) {\n+                session.createTimeseries(option.getPath(), option.getDataType(), option.getEncoding(), option.getCompressor());\n+            }\n+        }\n+    }\n+\n+    void initScheduler() {\n+        if (batchSize > 0) {\n+            scheduledExecutor = Executors.newSingleThreadScheduledExecutor();\n+            scheduledExecutor.scheduleAtFixedRate(() -> {\n+                try {\n+                    flush();\n+                } catch (Exception e) {\n+                    LOG.error(\"flush error\", e);\n+                }\n+            }, flushIntervalMs, flushIntervalMs, TimeUnit.MILLISECONDS);\n+        }\n+    }\n+\n+    //  for testing\n+    void setSession(Session session) {\n+        this.session = session;\n+    }\n+\n+    @Override\n+    public void invoke(IN input, Context context) throws Exception {\n+        Event event = serializationSchema.serialize(input);\n+        if (event == null) {\n+            return;\n+        }\n+\n+        if (batchSize > 0) {\n+            synchronized (batchList) {\n+                batchList.add(event);\n+                if (batchList.size() >= batchSize) {\n+                    flush();\n+                }\n+                return;\n+            }\n+        }\n+\n+        convertText(event.getDevice(), event.getMeasurements(), event.getValues());\n+        TSStatus status = session.insert(event.getDevice(), event.getTimestamp(),\n+                event.getMeasurements(), event.getValues());\n+        LOG.debug(\"send event result: {}\", status);\n+    }\n+\n+    public IoTDBSink<IN> withBatchSize(int batchSize) {\n+        Preconditions.checkArgument(batchSize >= 0);\n+        this.batchSize = batchSize;\n+        return this;\n+    }\n+\n+    public IoTDBSink<IN> withFlushIntervalMs(int flushIntervalMs) {\n+        Preconditions.checkArgument(flushIntervalMs > 0);\n+        this.flushIntervalMs = flushIntervalMs;\n+        return this;\n+    }\n+\n+    @Override\n+    public void close() throws Exception {\n+        if (session != null) {\n+            try {\n+                flush();\n+            } catch (Exception e) {\n+                LOG.error(\"flush error\", e);\n+            }\n+            session.close();\n+        }\n+        if (scheduledExecutor != null) {\n+            scheduledExecutor.shutdown();\n+        }\n+    }\n+\n+    private void convertText(String device, List<String> measurements, List<String> values) {\n+        if (device != null && measurements != null && values != null && measurements.size() == values.size()) {\n+            for (int i = 0; i < measurements.size(); i++) {\n+                String measurement = device + \".\" + measurements.get(i);\n+                IoTDBOptions.TimeseriesOption timeseriesOption = timeseriesOptionMap.get(measurement);\n+                if (timeseriesOption!= null && TSDataType.TEXT.equals(timeseriesOption.getDataType())) {\n+                    // The TEXT data type should be covered by \" or '\n+                    values.set(i, \"'\" + values.get(i) + \"'\");\n+                }\n+            }\n+        }\n+    }\n+\n+    private void flush() throws Exception {\n+        if (batchSize > 0) {\n+            synchronized (batchList) {\n+                if (batchList.size() > 0) {\n+                    List<String> deviceIds = new ArrayList<>();\n+                    List<Long> timestamps = new ArrayList<>();\n+                    List<List<String>> measurementsList = new ArrayList<>();\n+                    List<List<String>> valuesList = new ArrayList<>();\n+\n+                    for (Event event : batchList) {\n+                        convertText(event.getDevice(), event.getMeasurements(), event.getValues());\n+                        deviceIds.add(event.getDevice());\n+                        timestamps.add(event.getTimestamp());\n+                        measurementsList.add(event.getMeasurements());\n+                        valuesList.add(event.getValues());\n+                    }\n+                    List<TSStatus> statusList = session.insertInBatch(deviceIds, timestamps, measurementsList, valuesList);\n+                    LOG.debug(\"send events result: {}\", statusList);\n+                    batchList.clear();\n+                }\n+            }\n+        }\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9ba5d4cc35fb6f4faaacac4077a1b7ecda6067b"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNjU5Mw==", "bodyText": "Unnecessary empty line.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r388926593", "createdAt": "2020-03-06T14:17:26Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/test/java/org/apache/iotdb/flink/IoTDBSinkBatchInsertTest.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.iotdb.session.Session;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.*;\n+\n+public class IoTDBSinkBatchInsertTest {\n+\n+    private IoTDBSink ioTDBSink;\n+    private Session session;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.D01.temperature\")));\n+        ioTDBSink = new IoTDBSink(options, new DefaultIoTSerializationSchema());\n+        ioTDBSink.withBatchSize(3);\n+\n+        session = mock(Session.class);\n+        ioTDBSink.setSession(session);\n+    }\n+\n+    @Test\n+    public void testBatchInsert() throws Exception {\n+        Map<String,String> tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293000\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"36.5\");\n+        ioTDBSink.invoke(tuple, null);\n+\n+        verifyZeroInteractions(session);\n+\n+        tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293001\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"37.2\");\n+        ioTDBSink.invoke(tuple, null);\n+\n+        verifyZeroInteractions(session);\n+\n+        tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293003\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"37.1\");\n+        ioTDBSink.invoke(tuple, null);\n+\n+        verify(session).insertInBatch(any(List.class), any(List.class), any(List.class), any(List.class));\n+\n+        tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293005\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"36.5\");\n+        ioTDBSink.invoke(tuple, null);\n+\n+        verifyZeroInteractions(session);\n+    }\n+\n+    @Test\n+    public void close() throws Exception {\n+        Map<String,String> tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293005\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"36.5\");\n+        ioTDBSink.invoke(tuple, null);\n+        verifyZeroInteractions(session);\n+\n+        ioTDBSink.close();\n+        verify(session).insertInBatch(any(List.class), any(List.class), any(List.class), any(List.class));\n+        verify(session).close();\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9ba5d4cc35fb6f4faaacac4077a1b7ecda6067b"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNjgzOA==", "bodyText": "Unnecessary empty line.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r388926838", "createdAt": "2020-03-06T14:17:50Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/test/java/org/apache/iotdb/flink/IoTDBSinkBatchTimerTest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.iotdb.session.Session;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.*;\n+\n+public class IoTDBSinkBatchTimerTest {\n+\n+    private IoTDBSink ioTDBSink;\n+    private Session session;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.D01.temperature\")));\n+        ioTDBSink = new IoTDBSink(options, new DefaultIoTSerializationSchema());\n+        ioTDBSink.withBatchSize(3);\n+        ioTDBSink.withFlushIntervalMs(1000);\n+        ioTDBSink.initScheduler();\n+\n+        session = mock(Session.class);\n+        ioTDBSink.setSession(session);\n+    }\n+\n+    @Test\n+    public void testBatchInsert() throws Exception {\n+        Map<String,String> tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293000\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"36.5\");\n+        ioTDBSink.invoke(tuple, null);\n+\n+        Thread.sleep(2500);\n+\n+        verify(session).insertInBatch(any(List.class), any(List.class), any(List.class), any(List.class));\n+\n+        Thread.sleep(1000);\n+\n+        verifyZeroInteractions(session);\n+    }\n+\n+    @Test\n+    public void close() throws Exception {\n+        ioTDBSink.close();\n+        verify(session).close();\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9ba5d4cc35fb6f4faaacac4077a1b7ecda6067b"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNjk1MA==", "bodyText": "Unnecessary empty line.", "url": "https://github.com/apache/iotdb/pull/817#discussion_r388926950", "createdAt": "2020-03-06T14:18:02Z", "author": {"login": "WeiZhong94"}, "path": "flink-iotdb-connector/src/test/java/org/apache/iotdb/flink/IoTDBSinkInsertTest.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.iotdb.flink;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.iotdb.session.Session;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+\n+public class IoTDBSinkInsertTest {\n+\n+    private IoTDBSink ioTDBSink;\n+    private Session session;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        IoTDBOptions options = new IoTDBOptions();\n+        options.setTimeseriesOptionList(Lists.newArrayList(new IoTDBOptions.TimeseriesOption(\"root.sg.D01.temperature\")));\n+        ioTDBSink = new IoTDBSink(options, new DefaultIoTSerializationSchema());\n+\n+        session = mock(Session.class);\n+        ioTDBSink.setSession(session);\n+    }\n+\n+    @Test\n+    public void testInsert() throws Exception {\n+        Map<String,String> tuple = new HashMap();\n+        tuple.put(\"device\", \"root.sg.D01\");\n+        tuple.put(\"timestamp\", \"1581861293000\");\n+        tuple.put(\"measurements\", \"temperature\");\n+        tuple.put(\"values\", \"36.5\");\n+\n+        ioTDBSink.invoke(tuple, null);\n+        verify(session).insert(any(String.class), any(Long.class), any(List.class), any(List.class));\n+    }\n+\n+    @Test\n+    public void close() throws Exception {\n+        ioTDBSink.close();\n+        verify(session).close();\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9ba5d4cc35fb6f4faaacac4077a1b7ecda6067b"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32f32f62f62a5fdb59fa751a00556505fb604114", "author": {"user": {"login": "vesense", "name": "Xin Wang"}}, "url": "https://github.com/apache/iotdb/commit/32f32f62f62a5fdb59fa751a00556505fb604114", "committedDate": "2020-03-07T03:11:08Z", "message": "[IOTDB-497] remove unnecessary empty lines"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3084, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}