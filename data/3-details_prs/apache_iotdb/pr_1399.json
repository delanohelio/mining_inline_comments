{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NTY4MDE5", "number": 1399, "title": "[IOTDB-736] Query performance tracing", "bodyText": "This PR provides the performance tracing function by adding a performance log and gives a switch statement \"Tracing on/off\" to control whether to print this log, which is off by default.\nThe log records including:\n\nthe query sql, and the start time of this query\nthe number of series paths\nthe number of distinct tsfiles, including sequence and unsequence\nthe number of chunks, and average size of each chunk.\n\nThis pr concentrates on raw data query, it may modify something for aggregation query and group by query later.", "createdAt": "2020-06-21T16:28:33Z", "url": "https://github.com/apache/iotdb/pull/1399", "merged": true, "mergeCommit": {"oid": "a019a90a33e46b1d6aaf2f1eb45df8c52458e6f6"}, "closed": true, "closedAt": "2020-06-29T03:40:34Z", "author": {"login": "Alima777"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctZHSwAH2gAyNDM3NTY4MDE5OjU5N2MzMDU5ZTRiNWEyZGQ4NmY0N2UzMGUyOGQyOGM1ZjE4MGM2ZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcv4KbmAFqTQzODg2MDIxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "597c3059e4b5a2dd86f47e30e28d28c5f180c6e5", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/597c3059e4b5a2dd86f47e30e28d28c5f180c6e5", "committedDate": "2020-06-21T09:48:16Z", "message": "Add tracing on/off statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da3e8f8adcb2ad7e955cb13a50769538a794ab32", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/da3e8f8adcb2ad7e955cb13a50769538a794ab32", "committedDate": "2020-06-21T15:13:40Z", "message": "Add performance log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fa057a0c0baaa1e7faa6c815e621ea91bc5c776", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/8fa057a0c0baaa1e7faa6c815e621ea91bc5c776", "committedDate": "2020-06-21T15:22:01Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71149d4f42a766401ecf85d7c997e9afcaab0564", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/71149d4f42a766401ecf85d7c997e9afcaab0564", "committedDate": "2020-06-21T15:22:27Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd27f1a820ac25a45b7ba7e8717d49195af9db10", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/bd27f1a820ac25a45b7ba7e8717d49195af9db10", "committedDate": "2020-06-21T16:14:17Z", "message": "fix conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45602e0ca15fcf76a193c9794a479b29aa03a005", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/45602e0ca15fcf76a193c9794a479b29aa03a005", "committedDate": "2020-06-21T16:20:05Z", "message": "Remove unused function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/d7899f49e8f43a6be3c6a556dabd8bb32350644a", "committedDate": "2020-06-22T02:48:31Z", "message": "Write the log directly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NzYxNDc3", "url": "https://github.com/apache/iotdb/pull/1399#pullrequestreview-434761477", "createdAt": "2020-06-22T09:37:59Z", "commit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwOTozODowMFrOGm5OYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMToyNDozN1rOGm8i2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzNjY0Mg==", "bodyText": "put this to logs folder or data/performance is better", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r443436642", "createdAt": "2020-06-22T09:38:00Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -185,6 +184,11 @@\n    */\n   private String syncDir = \"data\" + File.separator + \"system\" + File.separator + \"sync\";\n \n+  /**\n+   * Performance tracing directory, stores performance tracing files\n+   */\n+  private String performanceDir = \"data\" + File.separator + \"system\" + File.separator + \"performance\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzNzA4Nw==", "bodyText": "this is not an invariant parameter, no need to put it here", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r443437087", "createdAt": "2020-06-22T09:38:50Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfigCheck.java", "diffHunk": "@@ -80,11 +87,16 @@\n \n   private static final String ERROR_LOG = \"Wrong %s, please set as: %s !\";\n \n+  private static final String ENABLE_PERFORMANCE_TRACING = \"enable_performance_tracing\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzNzI0MQ==", "bodyText": "do not modify this class", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r443437241", "createdAt": "2020-06-22T09:39:07Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfigCheck.java", "diffHunk": "@@ -125,24 +138,23 @@ private IoTDBConfigCheck() {\n     systemProperties.put(PARTITION_INTERVAL_STRING, String.valueOf(partitionInterval));\n     systemProperties.put(TSFILE_FILE_SYSTEM_STRING, tsfileFileSystem);\n     systemProperties.put(ENABLE_PARTITION_STRING, String.valueOf(enablePartition));\n+    systemProperties.put(ENABLE_PERFORMANCE_TRACING, String.valueOf(enablePerformanceTracing));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzNzM0NQ==", "bodyText": "format all changes of this class back..", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r443437345", "createdAt": "2020-06-22T09:39:18Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfigCheck.java", "diffHunk": "@@ -125,24 +138,23 @@ private IoTDBConfigCheck() {\n     systemProperties.put(PARTITION_INTERVAL_STRING, String.valueOf(partitionInterval));\n     systemProperties.put(TSFILE_FILE_SYSTEM_STRING, tsfileFileSystem);\n     systemProperties.put(ENABLE_PARTITION_STRING, String.valueOf(enablePartition));\n+    systemProperties.put(ENABLE_PERFORMANCE_TRACING, String.valueOf(enablePerformanceTracing));\n     systemProperties.put(TAG_ATTRIBUTE_SIZE_STRING, tagAttributeTotalSize);\n     systemProperties.put(MAX_DEGREE_OF_INDEX_STRING, maxDegreeOfIndexNode);\n   }\n \n \n   /**\n    * check configuration in system.properties when starting IoTDB\n-   *\n+   * <p>\n    * When init: create system.properties directly\n-   *\n-   * When upgrading the system.properties:\n-   * (1) create system.properties.tmp\n-   * (2) delete system.properties\n-   * (2) rename system.properties.tmp to system.properties\n+   * <p>\n+   * When upgrading the system.properties: (1) create system.properties.tmp (2) delete", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ0MjMzNA==", "bodyText": "I suggest adding a parameter boolean in TracingOperator and TracingPlan, then set the config in PlanExecutor.", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r443442334", "createdAt": "2020-06-22T09:48:15Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/LogicalGenerator.java", "diffHunk": "@@ -223,6 +226,20 @@ public void enterFlush(FlushContext ctx) {\n     initializedOperator = flushOperator;\n   }\n \n+  @Override\n+  public void enterTracingOn(TracingOnContext ctx) {\n+    super.enterTracingOn(ctx);\n+    IoTDBDescriptor.getInstance().getConfig().setEnablePerformanceTracing(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ0Mzg4Nw==", "bodyText": "I suggest adding a parameter boolean in TracingOperator and TracingPlan, then set the config in PlanExecutor.", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r443443887", "createdAt": "2020-06-22T09:50:55Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/LogicalGenerator.java", "diffHunk": "@@ -223,6 +226,20 @@ public void enterFlush(FlushContext ctx) {\n     initializedOperator = flushOperator;\n   }\n \n+  @Override\n+  public void enterTracingOn(TracingOnContext ctx) {\n+    super.enterTracingOn(ctx);\n+    IoTDBDescriptor.getInstance().getConfig().setEnablePerformanceTracing(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ0NTU2MQ==", "bodyText": "This method may be called many times before the cachedChunkMetadata is all consumed. You can put this tracing in unpackOneTimeSeriesMetadata, i.e., when we call FileLoaderUtils.", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r443445561", "createdAt": "2020-06-22T09:53:49Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "diffHunk": "@@ -251,6 +257,13 @@ private void unpackAllOverlappedTimeSeriesMetadataToCachedChunkMetadata(\n       unpackOneTimeSeriesMetadata(firstTimeSeriesMetadata);\n       firstTimeSeriesMetadata = null;\n     }\n+\n+    // try to calculate the total number of chunk and time-value points in chunk\n+    if (IoTDBDescriptor.getInstance().getConfig().isEnablePerformanceTracing()) {\n+      totalChunkNum += cachedChunkMetadata.size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MDUzMA==", "bodyText": "put all these performance related to a class TracingManager, which manage a writer, log file.", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r443490530", "createdAt": "2020-06-22T11:23:28Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -524,10 +546,30 @@ public TSExecuteStatementResp executeQueryStatement(TSExecuteStatementReq req) {\n    *             AuthorPlan\n    */\n   private TSExecuteStatementResp internalExecuteQueryStatement(String statement,\n-      long statementId, PhysicalPlan plan, int fetchSize, String username) {\n+      long statementId, PhysicalPlan plan, int fetchSize, String username) throws IOException {\n     auditLogger.info(\"Session {} execute Query: {}\", currSessionId.get(), statement);\n     long startTime = System.currentTimeMillis();\n     long queryId = -1;\n+    if (plan instanceof QueryPlan && config.isEnablePerformanceTracing()) {\n+      File performanceDir = SystemFileFactory.INSTANCE.getFile(config.getPerformanceDir());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MTAzNA==", "bodyText": "If I query multiple times, when do you clear this?", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r443491034", "createdAt": "2020-06-22T11:24:37Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -1233,6 +1237,20 @@ public QueryDataSource query(String deviceId, String measurementId, QueryContext\n       if (filePathsManager != null) {\n         filePathsManager.addUsedFilesForQuery(context.getQueryId(), dataSource);\n       }\n+\n+      // exclude repetitive tsFile to calculate the number of it\n+      if (config.isEnablePerformanceTracing()) {\n+        if (seqFile == null) {\n+          seqFile = new HashSet<>(seqResources);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7899f49e8f43a6be3c6a556dabd8bb32350644a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0afd154aa550e809ce7f13aeb092e713784032fa", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/0afd154aa550e809ce7f13aeb092e713784032fa", "committedDate": "2020-06-22T12:50:02Z", "message": "Change dir"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "372044d5be1f1c73d506aad6e98bdd51031be677", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/372044d5be1f1c73d506aad6e98bdd51031be677", "committedDate": "2020-06-22T13:01:56Z", "message": "Move the location of calculating chunks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4997f0c47cd4d8141a482922624eb52f9b96856", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/f4997f0c47cd4d8141a482922624eb52f9b96856", "committedDate": "2020-06-22T14:03:58Z", "message": "remove imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fddc7c39011215d88b4d143357f16bdc9b919a51", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/fddc7c39011215d88b4d143357f16bdc9b919a51", "committedDate": "2020-06-22T15:22:38Z", "message": "Add tracing manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d90e857714733661b24e2c260f24b46c05cfcf97", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/d90e857714733661b24e2c260f24b46c05cfcf97", "committedDate": "2020-06-22T15:56:22Z", "message": "QueryRouter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f47e97b1975760f853971a93c5829add737782bd", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/f47e97b1975760f853971a93c5829add737782bd", "committedDate": "2020-06-22T15:58:08Z", "message": "RawDataQueryExecutor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c63885a7d7eea0671d15f99215157eaa23d7a2d", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/0c63885a7d7eea0671d15f99215157eaa23d7a2d", "committedDate": "2020-06-23T02:12:24Z", "message": "Modify tracing on/off"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca197964dc4091de451c564624c2f134cbc6d9d4", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/ca197964dc4091de451c564624c2f134cbc6d9d4", "committedDate": "2020-06-23T07:33:43Z", "message": "Thread safe"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/f55733002ed8306b7bc3bea0dc64faa903b04b3d", "committedDate": "2020-06-23T07:45:24Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NTMwOTIz", "url": "https://github.com/apache/iotdb/pull/1399#pullrequestreview-435530923", "createdAt": "2020-06-23T07:55:04Z", "commit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNzo1NTowNVrOGndl0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwODoxOTo0MlrOGneczA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAzMjQ2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private String performanceDir = \"data\" + File.separator + \"performance\";\n          \n          \n            \n              private String performanceDir = \"data\" + File.separator + \"tracing\";", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r444032467", "createdAt": "2020-06-23T07:55:05Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -185,6 +184,11 @@\n    */\n   private String syncDir = \"data\" + File.separator + \"system\" + File.separator + \"sync\";\n \n+  /**\n+   * Performance tracing directory, stores performance tracing files\n+   */\n+  private String performanceDir = \"data\" + File.separator + \"performance\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAzMzI0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static final String PERFORMANCE_FOLDER_NAME = \"performance\";\n          \n          \n            \n              public static final String TRACING_FOLDER_NAME = \"tracing\";", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r444033246", "createdAt": "2020-06-23T07:56:19Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConstant.java", "diffHunk": "@@ -97,6 +97,8 @@ private IoTDBConstant() {\n   public static final String SCHEMA_FOLDER_NAME = \"schema\";\n   public static final String SYNC_FOLDER_NAME = \"sync\";\n   public static final String QUERY_FOLDER_NAME = \"query\";\n+  public static final String PERFORMANCE_FOLDER_NAME = \"performance\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAzMzM0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static final String PERFORMANCE_LOG = \"performance.txt\";\n          \n          \n            \n              public static final String PERFORMANCE_LOG = \"tracing.txt\";", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r444033344", "createdAt": "2020-06-23T07:56:29Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConstant.java", "diffHunk": "@@ -97,6 +97,8 @@ private IoTDBConstant() {\n   public static final String SCHEMA_FOLDER_NAME = \"schema\";\n   public static final String SYNC_FOLDER_NAME = \"sync\";\n   public static final String QUERY_FOLDER_NAME = \"query\";\n+  public static final String PERFORMANCE_FOLDER_NAME = \"performance\";\n+  public static final String PERFORMANCE_LOG = \"performance.txt\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAzMzkwMg==", "bodyText": "add javadoc, the chunk size is the number of points in chunk", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r444033902", "createdAt": "2020-06-23T07:57:26Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryResourceManager.java", "diffHunk": "@@ -47,6 +55,14 @@\n \r\n   private AtomicLong queryIdAtom = new AtomicLong();\r\n   private QueryFileManager filePathsManager;\r\n+  private static final Logger logger = LoggerFactory.getLogger(QueryResourceManager.class);\r\n+  // record the total number and size of chunks for each query id\r\n+  private Map<Long, Long> chunkNumMap = new ConcurrentHashMap<>();\r\n+  private Map<Long, Long> chunkSizeMap = new ConcurrentHashMap<>();\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDAzOTgyMA==", "bodyText": "you could use computeIfAbsent", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r444039820", "createdAt": "2020-06-23T08:07:56Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryResourceManager.java", "diffHunk": "@@ -85,20 +109,49 @@ public void registerTempExternalSortFile(long queryId,\n     externalSortFileMap.computeIfAbsent(queryId, x -> new ArrayList<>()).add(deserializer);\r\n   }\r\n \r\n-\r\n   public QueryDataSource getQueryDataSource(Path selectedPath,\r\n       QueryContext context, Filter filter) throws StorageEngineException, QueryProcessException {\r\n \r\n     SingleSeriesExpression singleSeriesExpression = new SingleSeriesExpression(selectedPath,\r\n         filter);\r\n-    return StorageEngine.getInstance().query(singleSeriesExpression, context, filePathsManager);\r\n+    QueryDataSource queryDataSource = StorageEngine.getInstance()\r\n+        .query(singleSeriesExpression, context, filePathsManager);\r\n+    // calculate the distinct number of seq and unseq tsfiles\r\n+    if (config.isEnablePerformanceTracing()) {\r\n+      Set<TsFileResource> seqFileNum = seqFileNumMap.get(context.getQueryId());\r\n+      Set<TsFileResource> unseqFileNum = unseqFileNumMap.get(context.getQueryId());\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA0MTY3OA==", "bodyText": "put it to one method, this method write one line and \\n", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r444041678", "createdAt": "2020-06-23T08:11:06Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -548,6 +568,11 @@ private TSExecuteStatementResp internalExecuteQueryStatement(String statement,\n       resp.setOperationType(plan.getOperatorType().toString());\n       // generate the queryId for the operation\n       queryId = generateQueryId(true);\n+      if (plan instanceof QueryPlan && config.isEnablePerformanceTracing()) {\n+        TracingManager.getInstance().writeQueryId(queryId);\n+        TracingManager.getInstance().writeStartTime();\n+        TracingManager.getInstance().writePathsNum(plan.getPaths().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA0NjA5OA==", "bodyText": "Not all query unpacks the TimeseriesMetadata, we only unpack it when needed. So the chunkNumMap may do not contain the queryId, you'd better check the seqFileNum or check one by one", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r444046098", "createdAt": "2020-06-23T08:18:57Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryResourceManager.java", "diffHunk": "@@ -85,20 +109,49 @@ public void registerTempExternalSortFile(long queryId,\n     externalSortFileMap.computeIfAbsent(queryId, x -> new ArrayList<>()).add(deserializer);\r\n   }\r\n \r\n-\r\n   public QueryDataSource getQueryDataSource(Path selectedPath,\r\n       QueryContext context, Filter filter) throws StorageEngineException, QueryProcessException {\r\n \r\n     SingleSeriesExpression singleSeriesExpression = new SingleSeriesExpression(selectedPath,\r\n         filter);\r\n-    return StorageEngine.getInstance().query(singleSeriesExpression, context, filePathsManager);\r\n+    QueryDataSource queryDataSource = StorageEngine.getInstance()\r\n+        .query(singleSeriesExpression, context, filePathsManager);\r\n+    // calculate the distinct number of seq and unseq tsfiles\r\n+    if (config.isEnablePerformanceTracing()) {\r\n+      Set<TsFileResource> seqFileNum = seqFileNumMap.get(context.getQueryId());\r\n+      Set<TsFileResource> unseqFileNum = unseqFileNumMap.get(context.getQueryId());\r\n+      if (seqFileNum == null) {\r\n+        seqFileNumMap.put(context.getQueryId(), new HashSet<>(queryDataSource.getSeqResources()));\r\n+      } else {\r\n+        seqFileNum.addAll(queryDataSource.getSeqResources());\r\n+      }\r\n+      if (unseqFileNum == null) {\r\n+        unseqFileNumMap.put(context.getQueryId(), new HashSet<>(queryDataSource.getUnseqResources()));\r\n+      } else {\r\n+        unseqFileNum.addAll(queryDataSource.getUnseqResources());\r\n+      }\r\n+    }\r\n+    return queryDataSource;\r\n   }\r\n \r\n   /**\r\n    * Whenever the jdbc request is closed normally or abnormally, this method must be invoked. All\r\n    * query tokens created by this jdbc request must be cleared.\r\n    */\r\n   public void endQuery(long queryId) throws StorageEngineException {\r\n+    try {\r\n+      if (config.isEnablePerformanceTracing() && chunkNumMap.get(queryId) != null) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA0NjU0MA==", "bodyText": "each line should have a QueryId in prefix", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r444046540", "createdAt": "2020-06-23T08:19:42Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!performanceDir.exists()) {\n+      if (performanceDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", performanceDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", performanceDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeSeperator() throws IOException {\n+    writer.write(\"-----------------------------\");\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writeStatement(String statement) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55733002ed8306b7bc3bea0dc64faa903b04b3d"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a15cace80b751e912c7d7d8e96dc0b5774a99a3", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/4a15cace80b751e912c7d7d8e96dc0b5774a99a3", "committedDate": "2020-06-23T08:59:58Z", "message": "Change based on review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/354d0e56eaeab96f213b3531cf9b4fda863f788e", "committedDate": "2020-06-23T14:10:42Z", "message": "Change log format and fix alignbydevice bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MjgyNjU4", "url": "https://github.com/apache/iotdb/pull/1399#pullrequestreview-437282658", "createdAt": "2020-06-25T08:35:29Z", "commit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwODozNToyOVrOGow5Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwODo0NDo1MlrOGoxOAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5NzI3NA==", "bodyText": "not used", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445397274", "createdAt": "2020-06-25T08:35:29Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConstant.java", "diffHunk": "@@ -97,6 +97,8 @@ private IoTDBConstant() {\n   public static final String SCHEMA_FOLDER_NAME = \"schema\";\n   public static final String SYNC_FOLDER_NAME = \"sync\";\n   public static final String QUERY_FOLDER_NAME = \"query\";\n+  public static final String TRACING_FOLDER_NAME = \"tracing\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5NzU2NQ==", "bodyText": "perfromanceDir -> tracingDir", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445397565", "createdAt": "2020-06-25T08:35:58Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5ODUyOQ==", "bodyText": "writer.write() should be protected by synchnorized", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445398529", "createdAt": "2020-06-25T08:37:40Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!performanceDir.exists()) {\n+      if (performanceDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", performanceDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", performanceDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeQueryInfo(long queryId, String statement, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    writer.write(builder.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5ODkyMQ==", "bodyText": "no need to call flush", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445398921", "createdAt": "2020-06-25T08:38:21Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!performanceDir.exists()) {\n+      if (performanceDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", performanceDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", performanceDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeQueryInfo(long queryId, String statement, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5OTAxNA==", "bodyText": "same issue.", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445399014", "createdAt": "2020-06-25T08:38:30Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!performanceDir.exists()) {\n+      if (performanceDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", performanceDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", performanceDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeQueryInfo(long queryId, String statement, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  // for align by device query\n+  public void writeQueryInfo(long queryId, String statement) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()));\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5OTA3Mg==", "bodyText": "same issue", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445399072", "createdAt": "2020-06-25T08:38:37Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!performanceDir.exists()) {\n+      if (performanceDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", performanceDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", performanceDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeQueryInfo(long queryId, String statement, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  // for align by device query\n+  public void writeQueryInfo(long queryId, String statement) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()));\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writePathsNum(long queryId, int pathsNum) throws IOException {\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum).toString());\n+    writer.newLine();\n+    writer.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5OTYwMw==", "bodyText": "use StringBuilder to get string first (do not need to wrap with sync), and wrap writer.write with sync", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445399603", "createdAt": "2020-06-25T08:39:35Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!performanceDir.exists()) {\n+      if (performanceDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", performanceDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", performanceDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeQueryInfo(long queryId, String statement, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  // for align by device query\n+  public void writeQueryInfo(long queryId, String statement) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()));\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writePathsNum(long queryId, int pathsNum) throws IOException {\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum).toString());\n+    writer.newLine();\n+    writer.flush();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5OTA3Mg=="}, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5OTY2OA==", "bodyText": "same issue", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445399668", "createdAt": "2020-06-25T08:39:41Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!performanceDir.exists()) {\n+      if (performanceDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", performanceDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", performanceDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeQueryInfo(long queryId, String statement, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  // for align by device query\n+  public void writeQueryInfo(long queryId, String statement) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()));\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writePathsNum(long queryId, int pathsNum) throws IOException {\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum).toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writeTsFileInfo(long queryId, int seqFileNum, int unseqFileNum) throws IOException {\n+    // to avoid the disorder info of multi query\n+    // add query id as prefix of each info\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of tsfiles: \").append(seqFileNum + unseqFileNum)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of sequence files: \").append(seqFileNum)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of unsequence files: \").append(unseqFileNum).toString());\n+    writer.newLine();\n+    writer.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5OTc2Nw==", "bodyText": "same issue", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445399767", "createdAt": "2020-06-25T08:39:51Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!performanceDir.exists()) {\n+      if (performanceDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", performanceDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", performanceDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeQueryInfo(long queryId, String statement, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  // for align by device query\n+  public void writeQueryInfo(long queryId, String statement) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()));\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writePathsNum(long queryId, int pathsNum) throws IOException {\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum).toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writeTsFileInfo(long queryId, int seqFileNum, int unseqFileNum) throws IOException {\n+    // to avoid the disorder info of multi query\n+    // add query id as prefix of each info\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of tsfiles: \").append(seqFileNum + unseqFileNum)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of sequence files: \").append(seqFileNum)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of unsequence files: \").append(unseqFileNum).toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writeChunksInfo(long queryId, long totalChunkNum, long totalChunkSize) throws IOException {\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of chunks: \").append(totalChunkNum)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Average size of chunks: \").append(totalChunkSize / totalChunkNum).toString());\n+    writer.newLine();\n+    writer.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM5OTgzMQ==", "bodyText": "same issue", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445399831", "createdAt": "2020-06-25T08:39:57Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName){\n+    File performanceDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!performanceDir.exists()) {\n+      if (performanceDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", performanceDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", performanceDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeQueryInfo(long queryId, String statement, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  // for align by device query\n+  public void writeQueryInfo(long queryId, String statement) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()));\n+    writer.write(builder.toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writePathsNum(long queryId, int pathsNum) throws IOException {\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum).toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writeTsFileInfo(long queryId, int seqFileNum, int unseqFileNum) throws IOException {\n+    // to avoid the disorder info of multi query\n+    // add query id as prefix of each info\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of tsfiles: \").append(seqFileNum + unseqFileNum)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of sequence files: \").append(seqFileNum)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of unsequence files: \").append(unseqFileNum).toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writeChunksInfo(long queryId, long totalChunkNum, long totalChunkSize) throws IOException {\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of chunks: \").append(totalChunkNum)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Average size of chunks: \").append(totalChunkSize / totalChunkNum).toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  public void writeEndTime(long queryId) throws IOException {\n+    writer.write(new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - End time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .toString());\n+    writer.newLine();\n+    writer.flush();\n+  }\n+\n+  private static class TracingManagerHelper {\n+\n+    private static final TracingManager INSTANCE = new TracingManager(\n+        IoTDBDescriptor.getInstance().getConfig().getTracingDir(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 129}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQwMjYyNA==", "bodyText": "Though currently we put all TsResources into the memory, but we may change this design in the future.\nHowever, you put the TsResources into the map here, which will lead to the GC failed for those objects.\nHow about considering Weak/PhantomReference references  (not sure whether it is ok. https://juejin.im/post/5b82c02df265da436152f5ad)", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r445402624", "createdAt": "2020-06-25T08:44:52Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryResourceManager.java", "diffHunk": "@@ -85,20 +110,50 @@ public void registerTempExternalSortFile(long queryId,\n     externalSortFileMap.computeIfAbsent(queryId, x -> new ArrayList<>()).add(deserializer);\r\n   }\r\n \r\n-\r\n   public QueryDataSource getQueryDataSource(Path selectedPath,\r\n       QueryContext context, Filter filter) throws StorageEngineException, QueryProcessException {\r\n \r\n     SingleSeriesExpression singleSeriesExpression = new SingleSeriesExpression(selectedPath,\r\n         filter);\r\n-    return StorageEngine.getInstance().query(singleSeriesExpression, context, filePathsManager);\r\n+    QueryDataSource queryDataSource = StorageEngine.getInstance()\r\n+        .query(singleSeriesExpression, context, filePathsManager);\r\n+    // calculate the distinct number of seq and unseq tsfiles\r\n+    if (config.isEnablePerformanceTracing()) {\r\n+      seqFileNumMap.computeIfAbsent(context.getQueryId(), k -> new HashSet<>())\r\n+          .addAll(queryDataSource.getSeqResources());\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "354d0e56eaeab96f213b3531cf9b4fda863f788e"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b66a9b06aab4b98fcd265a21902edb8574ec297c", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/b66a9b06aab4b98fcd265a21902edb8574ec297c", "committedDate": "2020-06-25T14:23:31Z", "message": "Writer thread safety"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MjQ0Mzgw", "url": "https://github.com/apache/iotdb/pull/1399#pullrequestreview-438244380", "createdAt": "2020-06-26T12:13:27Z", "commit": {"oid": "b66a9b06aab4b98fcd265a21902edb8574ec297c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoxMzoyOFrOGpemgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoxMzoyOFrOGpemgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0NjE3OA==", "bodyText": "here should be \"TRACING_FOLDER_NAME\"..", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r446146178", "createdAt": "2020-06-26T12:13:28Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -185,6 +184,11 @@\n    */\n   private String syncDir = \"data\" + File.separator + \"system\" + File.separator + \"sync\";\n \n+  /**\n+   * Performance tracing directory, stores performance tracing files\n+   */\n+  private String tracingDir = \"data\" + File.separator + \"tracing\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66a9b06aab4b98fcd265a21902edb8574ec297c"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MjQ2NTc4", "url": "https://github.com/apache/iotdb/pull/1399#pullrequestreview-438246578", "createdAt": "2020-06-26T12:17:25Z", "commit": {"oid": "b66a9b06aab4b98fcd265a21902edb8574ec297c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoxNzoyNVrOGpetMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoxNzoyNVrOGpetMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0Nzg5MA==", "bodyText": "writer.newLine()  also needs to be wrapped...", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r446147890", "createdAt": "2020-06-26T12:17:25Z", "author": {"login": "jixuan1989"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/TracingManager.java", "diffHunk": "@@ -0,0 +1,145 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.text.SimpleDateFormat;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.fileSystem.SystemFileFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class TracingManager {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(TracingManager.class);\n+  private BufferedWriter writer;\n+\n+  public TracingManager(String dirName, String logFileName) {\n+    File tracingDir = SystemFileFactory.INSTANCE.getFile(dirName);\n+    if (!tracingDir.exists()) {\n+      if (tracingDir.mkdirs()) {\n+        logger.info(\"create performance folder {}.\", tracingDir);\n+      } else {\n+        logger.info(\"create performance folder {} failed.\", tracingDir);\n+      }\n+    }\n+    File logFile = SystemFileFactory.INSTANCE.getFile(dirName + File.separator + logFileName);\n+\n+    FileWriter fileWriter = null;\n+    try {\n+      fileWriter = new FileWriter(logFile, true);\n+    } catch (IOException e) {\n+      logger.error(\"Meeting error while creating TracingManager: {}\", e);\n+    }\n+    writer = new BufferedWriter(fileWriter);\n+  }\n+\n+  public static TracingManager getInstance() {\n+    return TracingManagerHelper.INSTANCE;\n+  }\n+\n+  public void writeQueryInfo(long queryId, String statement, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()))\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    synchronized (writer) {\n+      writer.write(builder.toString());\n+    }\n+    writer.newLine();\n+  }\n+\n+  // for align by device query\n+  public void writeQueryInfo(long queryId, String statement) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"-----------------------------\\n\");\n+    builder.append(\"Query Id: \").append(queryId)\n+        .append(\" - Query Statement: \").append(statement)\n+        .append(\"\\nQuery Id: \").append(queryId)\n+        .append(\" - Start time: \")\n+        .append(new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss.SSS\").format(System.currentTimeMillis()));\n+    synchronized (writer) {\n+      writer.write(builder.toString());\n+    }\n+    writer.newLine();\n+  }\n+\n+  public void writePathsNum(long queryId, int pathsNum) throws IOException {\n+    StringBuilder builder = new StringBuilder(\"Query Id: \").append(queryId)\n+        .append(\" - Number of series paths: \").append(pathsNum);\n+    synchronized (writer) {\n+      writer.write(builder.toString());\n+    }\n+    writer.newLine();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66a9b06aab4b98fcd265a21902edb8574ec297c"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83a59730b38404890199cea5c011a034348e2d24", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/83a59730b38404890199cea5c011a034348e2d24", "committedDate": "2020-06-26T14:50:37Z", "message": "Thread safe and constant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61078a029a35f565b3a6769f192630e0a94fb36c", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/61078a029a35f565b3a6769f192630e0a94fb36c", "committedDate": "2020-06-28T02:59:57Z", "message": "replace with weak reference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0a63803a9eafc6de9c0ae96f0ae4461e954c2e1", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/a0a63803a9eafc6de9c0ae96f0ae4461e954c2e1", "committedDate": "2020-06-29T02:07:07Z", "message": "Fix conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f961713a66a1947386a8c93481d6be9402bfb2f1", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/f961713a66a1947386a8c93481d6be9402bfb2f1", "committedDate": "2020-06-29T02:47:00Z", "message": "Fix conflict"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4ODU2Mzg5", "url": "https://github.com/apache/iotdb/pull/1399#pullrequestreview-438856389", "createdAt": "2020-06-29T02:49:54Z", "commit": {"oid": "a0a63803a9eafc6de9c0ae96f0ae4461e954c2e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjAxNzQw", "url": "https://github.com/apache/iotdb/pull/1399#pullrequestreview-435601740", "createdAt": "2020-06-23T09:23:56Z", "commit": {"oid": "4a15cace80b751e912c7d7d8e96dc0b5774a99a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOToyMzo1NlrOGng4wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOToyMzo1NlrOGng4wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4NjQ2NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      config.getTracingDir() + File.separator + IoTDBConstant.TRACING_LOG, e);\n          \n          \n            \n                      config.getTracingDir() + File.separator + IoTDBConstant.TRACING_LOG, e.getMessage());", "url": "https://github.com/apache/iotdb/pull/1399#discussion_r444086465", "createdAt": "2020-06-23T09:23:56Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryResourceManager.java", "diffHunk": "@@ -85,20 +110,53 @@ public void registerTempExternalSortFile(long queryId,\n     externalSortFileMap.computeIfAbsent(queryId, x -> new ArrayList<>()).add(deserializer);\r\n   }\r\n \r\n-\r\n   public QueryDataSource getQueryDataSource(Path selectedPath,\r\n       QueryContext context, Filter filter) throws StorageEngineException, QueryProcessException {\r\n \r\n     SingleSeriesExpression singleSeriesExpression = new SingleSeriesExpression(selectedPath,\r\n         filter);\r\n-    return StorageEngine.getInstance().query(singleSeriesExpression, context, filePathsManager);\r\n+    QueryDataSource queryDataSource = StorageEngine.getInstance()\r\n+        .query(singleSeriesExpression, context, filePathsManager);\r\n+    // calculate the distinct number of seq and unseq tsfiles\r\n+    if (config.isEnablePerformanceTracing()) {\r\n+      Set<TsFileResource> seqFileNum = seqFileNumMap.get(context.getQueryId());\r\n+      Set<TsFileResource> unseqFileNum = unseqFileNumMap.get(context.getQueryId());\r\n+      if (seqFileNum == null) {\r\n+        seqFileNumMap.put(context.getQueryId(), new HashSet<>(queryDataSource.getSeqResources()));\r\n+      } else {\r\n+        seqFileNum.addAll(queryDataSource.getSeqResources());\r\n+      }\r\n+      if (unseqFileNum == null) {\r\n+        unseqFileNumMap.put(context.getQueryId(), new HashSet<>(queryDataSource.getUnseqResources()));\r\n+      } else {\r\n+        unseqFileNum.addAll(queryDataSource.getUnseqResources());\r\n+      }\r\n+    }\r\n+    return queryDataSource;\r\n   }\r\n \r\n   /**\r\n    * Whenever the jdbc request is closed normally or abnormally, this method must be invoked. All\r\n    * query tokens created by this jdbc request must be cleared.\r\n    */\r\n   public void endQuery(long queryId) throws StorageEngineException {\r\n+    try {\r\n+      if (config.isEnablePerformanceTracing()) {\r\n+        if (seqFileNumMap.get(queryId) != null && unseqFileNumMap.get(queryId) != null) {\r\n+          TracingManager.getInstance().writeTsFileInfo(queryId, seqFileNumMap.remove(queryId).size(),\r\n+              unseqFileNumMap.remove(queryId).size());\r\n+        }\r\n+        if (chunkNumMap.get(queryId) != null && chunkSizeMap.get(queryId) != null) {\r\n+          TracingManager.getInstance()\r\n+              .writeChunksInfo(queryId, chunkNumMap.remove(queryId), chunkSizeMap.remove(queryId));\r\n+        }\r\n+      }\r\n+    } catch (IOException e) {\r\n+      logger.error(\r\n+          \"Error while writing performance info to {}, {}\",\r\n+          config.getTracingDir() + File.separator + IoTDBConstant.TRACING_LOG, e);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a15cace80b751e912c7d7d8e96dc0b5774a99a3"}, "originalPosition": 119}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7ed2bed6cfedfc4aecc597e07a1b08f05e15f8f", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/a7ed2bed6cfedfc4aecc597e07a1b08f05e15f8f", "committedDate": "2020-06-29T03:02:36Z", "message": "fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4ODYwMjEy", "url": "https://github.com/apache/iotdb/pull/1399#pullrequestreview-438860212", "createdAt": "2020-06-29T03:06:36Z", "commit": {"oid": "a7ed2bed6cfedfc4aecc597e07a1b08f05e15f8f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3602, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}