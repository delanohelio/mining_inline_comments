{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNjQ5MzYy", "number": 1448, "title": "[IOTDB-716] add lZ4 compress method", "bodyText": "Support lZ4 compress method", "createdAt": "2020-07-01T11:53:51Z", "url": "https://github.com/apache/iotdb/pull/1448", "merged": true, "mergeCommit": {"oid": "7e628d29d20d39db0473f2d8303a28510b61d0c5"}, "closed": true, "closedAt": "2020-07-14T01:15:24Z", "author": {"login": "SilverNarcissus"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBMiFnAH2gAyNDQyNjQ5MzYyOmNlODQxZWZjZWM1NjJlZGNkODBjMzBmYmY4MzYxZjg5MmJlMGRiZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0iYrIAFqTQ0NzMwODkxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ce841efcec562edcd80c30fbf8361f892be0dbf0", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/ce841efcec562edcd80c30fbf8361f892be0dbf0", "committedDate": "2020-02-05T02:16:06Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c82abe4d67253a889a4dedbe18bf28bd9b62b921", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/c82abe4d67253a889a4dedbe18bf28bd9b62b921", "committedDate": "2020-02-11T01:32:18Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "202e7fa8b36d8487e6a7b1f9b641786608c2891b", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/202e7fa8b36d8487e6a7b1f9b641786608c2891b", "committedDate": "2020-02-17T01:19:37Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "610082b233713e76f2a8067724cb7dc3de60938e", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/610082b233713e76f2a8067724cb7dc3de60938e", "committedDate": "2020-02-17T02:20:25Z", "message": "add time partition when recovery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "829e6a883704bdbe0e6dcc34a6b3cdca4fd83ce4", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/829e6a883704bdbe0e6dcc34a6b3cdca4fd83ce4", "committedDate": "2020-02-19T11:55:08Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "890566ed46eef36c6b2be09fc9bfa634f6c166bf", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/890566ed46eef36c6b2be09fc9bfa634f6c166bf", "committedDate": "2020-02-26T08:23:14Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45d9323493116511f1f2aeb5ce0d1707c4dc2ea6", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/45d9323493116511f1f2aeb5ce0d1707c4dc2ea6", "committedDate": "2020-03-27T10:45:03Z", "message": "merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f0465a32097202eda3422ab4bb7b362c6169f5c", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/2f0465a32097202eda3422ab4bb7b362c6169f5c", "committedDate": "2020-03-27T10:45:59Z", "message": "fix deletion bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "693832e459d59baa365301dbbf6868eb8d7b6ab7", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/693832e459d59baa365301dbbf6868eb8d7b6ab7", "committedDate": "2020-03-27T10:47:27Z", "message": "Revert \"fix deletion bug\"\n\nThis reverts commit 2f0465a32097202eda3422ab4bb7b362c6169f5c."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "275fe1816f1a7fa88f439af7ee3960730abd3a56", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/275fe1816f1a7fa88f439af7ee3960730abd3a56", "committedDate": "2020-04-23T02:37:13Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "495eabb3b61dfb5d672c1e46168ecba02c2b42d4", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/495eabb3b61dfb5d672c1e46168ecba02c2b42d4", "committedDate": "2020-05-01T02:57:34Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24b3da2f2a9e14c89bf90f9488afc1cc2eab5ece", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/24b3da2f2a9e14c89bf90f9488afc1cc2eab5ece", "committedDate": "2020-05-08T02:49:41Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77c090e4711f905c8f03118f9a7f25bfc739ce01", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/77c090e4711f905c8f03118f9a7f25bfc739ce01", "committedDate": "2020-06-08T04:21:49Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9204d952fc4ece331c4a902d9361341583513f21", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/9204d952fc4ece331c4a902d9361341583513f21", "committedDate": "2020-06-08T05:07:21Z", "message": "init"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e67fed1157b0902dbc54ed83f574721dc29c8f3", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/7e67fed1157b0902dbc54ed83f574721dc29c8f3", "committedDate": "2020-06-09T18:02:26Z", "message": "add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1784c5a97c40a59aa8bb81f5a8476cfe6a7eaf29", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/1784c5a97c40a59aa8bb81f5a8476cfe6a7eaf29", "committedDate": "2020-06-11T04:29:48Z", "message": "add Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e56b941cd5e96cccf900e0efbce9534726daa5", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/73e56b941cd5e96cccf900e0efbce9534726daa5", "committedDate": "2020-07-01T11:52:55Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eaef644dd434423516e86d1bf592c9112953b57", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/9eaef644dd434423516e86d1bf592c9112953b57", "committedDate": "2020-07-01T11:55:07Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "122a6c97e54a08d6b44f2b11b76cd367b30b4167", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/122a6c97e54a08d6b44f2b11b76cd367b30b4167", "committedDate": "2020-07-02T02:08:05Z", "message": "fix bugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNDI1Njg5", "url": "https://github.com/apache/iotdb/pull/1448#pullrequestreview-441425689", "createdAt": "2020-07-02T07:41:22Z", "commit": {"oid": "122a6c97e54a08d6b44f2b11b76cd367b30b4167"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNzo0MToyMlrOGsBG9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNzo0MToyMlrOGsBG9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODgwODY5NQ==", "bodyText": "I think we should update the LICENSE-binary as well. :)", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r448808695", "createdAt": "2020-07-02T07:41:22Z", "author": {"login": "HTHou"}, "path": "tsfile/pom.xml", "diffHunk": "@@ -53,6 +53,11 @@\n             <groupId>commons-io</groupId>\n             <artifactId>commons-io</artifactId>\n         </dependency>\n+        <dependency>\n+            <groupId>net.jpountz.lz4</groupId>\n+            <artifactId>lz4</artifactId>\n+            <version>1.3.0</version>\n+        </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "122a6c97e54a08d6b44f2b11b76cd367b30b4167"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20cf2e31843d664e8e1ec43e1dc7bf1e72028488", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/20cf2e31843d664e8e1ec43e1dc7bf1e72028488", "committedDate": "2020-07-02T16:00:47Z", "message": "add license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab543a55d1b84fec94dc7927213f22bc7596842d", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/ab543a55d1b84fec94dc7927213f22bc7596842d", "committedDate": "2020-07-05T13:13:46Z", "message": "fix bugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzYwMTI5", "url": "https://github.com/apache/iotdb/pull/1448#pullrequestreview-444360129", "createdAt": "2020-07-08T01:53:15Z", "commit": {"oid": "ab543a55d1b84fec94dc7927213f22bc7596842d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTA5Mjc2", "url": "https://github.com/apache/iotdb/pull/1448#pullrequestreview-444509276", "createdAt": "2020-07-08T08:10:42Z", "commit": {"oid": "ab543a55d1b84fec94dc7927213f22bc7596842d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed2a9314a4676f94be81734050ee08afa7bcb26", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/bed2a9314a4676f94be81734050ee08afa7bcb26", "committedDate": "2020-07-09T06:24:18Z", "message": "solve conflict"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MjcxNTQ5", "url": "https://github.com/apache/iotdb/pull/1448#pullrequestreview-447271549", "createdAt": "2020-07-13T13:52:48Z", "commit": {"oid": "bed2a9314a4676f94be81734050ee08afa7bcb26"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo1Mjo0OVrOGwpjzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMzo1NDoyM1rOGwpoGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NTc0Mw==", "bodyText": "To be consistent with LZ4UnCompressor and simplified, rename this to LZ4Compressor?", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r453665743", "createdAt": "2020-07-13T13:52:49Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/compress/ICompressor.java", "diffHunk": "@@ -52,6 +52,8 @@ static ICompressor getCompressor(CompressionType name) {\n         return new NoCompressor();\n       case SNAPPY:\n         return new SnappyCompressor();\n+      case LZ4:\n+        return new IOTDBLZ4Compressor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bed2a9314a4676f94be81734050ee08afa7bcb26"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2NjUzOA==", "bodyText": "I think it's better to throw this exception and let the upper level handle it.", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r453666538", "createdAt": "2020-07-13T13:53:58Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/compress/IUnCompressor.java", "diffHunk": "@@ -184,4 +186,82 @@ public CompressionType getCodecName() {\n       return CompressionType.SNAPPY;\n     }\n   }\n+\n+\n+  class LZ4UnCompressor implements IUnCompressor {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(LZ4Compressor.class);\n+    private static final int MAX_COMPRESS_RATIO = 255;\n+    private LZ4SafeDecompressor decompressor;\n+\n+\n+    public LZ4UnCompressor() {\n+      LZ4Factory factory = LZ4Factory.fastestInstance();\n+      decompressor = factory.safeDecompressor();\n+    }\n+\n+    @Override\n+    public int getUncompressedLength(byte[] array, int offset, int length) throws IOException {\n+      throw new UnsupportedOperationException(\"unsupported get uncompress length\");\n+    }\n+\n+    @Override\n+    public int getUncompressedLength(ByteBuffer buffer) throws IOException {\n+      throw new UnsupportedOperationException(\"unsupported get uncompress length\");\n+    }\n+\n+    /**\n+     * We don't recommend using this method because we have to allocate MAX_COMPRESS_RATIO *\n+     * compressedSize to ensure uncompress safety, you can use other method if you know the\n+     * uncompressed size\n+     */\n+    @Override\n+    public byte[] uncompress(byte[] bytes) {\n+      if (bytes == null) {\n+        return new byte[0];\n+      }\n+\n+      try {\n+        return decompressor.decompress(bytes, MAX_COMPRESS_RATIO * bytes.length);\n+      } catch (RuntimeException e) {\n+        logger.error(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bed2a9314a4676f94be81734050ee08afa7bcb26"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY2Njg0Mg==", "bodyText": "throw IOException", "url": "https://github.com/apache/iotdb/pull/1448#discussion_r453666842", "createdAt": "2020-07-13T13:54:23Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/compress/IUnCompressor.java", "diffHunk": "@@ -184,4 +186,82 @@ public CompressionType getCodecName() {\n       return CompressionType.SNAPPY;\n     }\n   }\n+\n+\n+  class LZ4UnCompressor implements IUnCompressor {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(LZ4Compressor.class);\n+    private static final int MAX_COMPRESS_RATIO = 255;\n+    private LZ4SafeDecompressor decompressor;\n+\n+\n+    public LZ4UnCompressor() {\n+      LZ4Factory factory = LZ4Factory.fastestInstance();\n+      decompressor = factory.safeDecompressor();\n+    }\n+\n+    @Override\n+    public int getUncompressedLength(byte[] array, int offset, int length) throws IOException {\n+      throw new UnsupportedOperationException(\"unsupported get uncompress length\");\n+    }\n+\n+    @Override\n+    public int getUncompressedLength(ByteBuffer buffer) throws IOException {\n+      throw new UnsupportedOperationException(\"unsupported get uncompress length\");\n+    }\n+\n+    /**\n+     * We don't recommend using this method because we have to allocate MAX_COMPRESS_RATIO *\n+     * compressedSize to ensure uncompress safety, you can use other method if you know the\n+     * uncompressed size\n+     */\n+    @Override\n+    public byte[] uncompress(byte[] bytes) {\n+      if (bytes == null) {\n+        return new byte[0];\n+      }\n+\n+      try {\n+        return decompressor.decompress(bytes, MAX_COMPRESS_RATIO * bytes.length);\n+      } catch (RuntimeException e) {\n+        logger.error(\n+            \"tsfile-compression LZ4UnCompressor: errors occurs when uncompress input byte\", e);\n+      }\n+      return new byte[0];\n+    }\n+\n+    @Override\n+    public int uncompress(byte[] byteArray, int offset, int length, byte[] output, int outOffset)\n+        throws IOException {\n+      try {\n+        return decompressor.decompress(byteArray, offset, length, output, offset);\n+      }\n+      catch (RuntimeException e){\n+        logger.error(\n+            \"tsfile-compression LZ4UnCompressor: errors occurs when uncompress input byte\", e);\n+        throw new IOException(e);\n+      }\n+    }\n+\n+    @Override\n+    public int uncompress(ByteBuffer compressed, ByteBuffer uncompressed) {\n+      if (compressed == null || !compressed.hasRemaining()) {\n+        return 0;\n+      }\n+\n+      try {\n+        decompressor.decompress(compressed, uncompressed);\n+        return compressed.limit();\n+      } catch (RuntimeException e) {\n+        logger.error(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bed2a9314a4676f94be81734050ee08afa7bcb26"}, "originalPosition": 143}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a241aca1d31b7a48f917cba2b3c8c90da60680b", "author": {"user": {"login": "SilverNarcissus", "name": null}}, "url": "https://github.com/apache/iotdb/commit/8a241aca1d31b7a48f917cba2b3c8c90da60680b", "committedDate": "2020-07-13T14:01:44Z", "message": "fix bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzA4OTEy", "url": "https://github.com/apache/iotdb/pull/1448#pullrequestreview-447308912", "createdAt": "2020-07-13T14:33:52Z", "commit": {"oid": "8a241aca1d31b7a48f917cba2b3c8c90da60680b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3664, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}