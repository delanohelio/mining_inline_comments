{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MjkyMDgw", "number": 966, "title": "Fix visible metadata, version, work processor bugs when recovering", "bodyText": "Fix many bugs when recovering:\n(1) when recovering the last unclosed SEQ file, the TsFileProcessor is added to workUnsequenceTsFileProcessors.\n(2) when recovering the last unclosed UNSEQ file, the TsFileProcessor isn's added to any workTsFileProcessors.\n(3) when recovering, the metadata get from TsFile is set to chunkMetadataListMap, however, visibale metadata is recovered from chunkGroupInfoList. Therefore, the persisted Chunk is not visible.\n(4) when recovering, the TsFileRecoverPerformer needs to receive a partitionId. However, before recovering, the startTime & endTime maps are empty. So the partitionId is -1, which leads to the wrong version of Deletion and memtable version in recovery. I get the partitionId from resource path. No more -1 partitions in the future.", "createdAt": "2020-03-31T12:13:57Z", "url": "https://github.com/apache/iotdb/pull/966", "merged": true, "mergeCommit": {"oid": "c6c23a3c88145fe9f4615b6987ce6842f51b91e3"}, "closed": true, "closedAt": "2020-04-01T06:31:02Z", "author": {"login": "qiaojialin"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTBJO7AH2gAyMzk2MjkyMDgwOjIzMGRkNTQxOTI0MmRlZDM5NDMxYmE4OGVmYTU1NGZhNzZkNGVhZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTQpe1AH2gAyMzk2MjkyMDgwOjBhNGMzNjk2MGQ2NjJmNDVmMTMzZmM4MzgyNzUyNDAyN2M0MGY3ODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "230dd5419242ded39431ba88efa554fa76d4eaea", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/230dd5419242ded39431ba88efa554fa76d4eaea", "committedDate": "2020-03-31T11:10:38Z", "message": "fix recover bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7c387d5ee4ba2d7afeec7be498a845f08d56882", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/e7c387d5ee4ba2d7afeec7be498a845f08d56882", "committedDate": "2020-03-31T12:02:08Z", "message": "fix partition -1 when recover"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f56d8397e5ad1f0dec7174557a87976d67458e30", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/f56d8397e5ad1f0dec7174557a87976d67458e30", "committedDate": "2020-03-31T12:13:40Z", "message": "fix conilct javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10c1bee3aa53a760e708d0a25b57dcec46f34302", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/10c1bee3aa53a760e708d0a25b57dcec46f34302", "committedDate": "2020-03-31T13:11:30Z", "message": "add restart IT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e16e61ce1cb50f2c6c1f7561c62448feb18231", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/20e16e61ce1cb50f2c6c1f7561c62448feb18231", "committedDate": "2020-03-31T13:42:17Z", "message": "move getPartition to TsFileResource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dc091cac195888284f6d92380f4eb2faa1891da", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/7dc091cac195888284f6d92380f4eb2faa1891da", "committedDate": "2020-03-31T14:12:09Z", "message": "fix sonar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20ae6bfe1710ab70b5cc9e1a79ec1f5c314ff96c", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/20ae6bfe1710ab70b5cc9e1a79ec1f5c314ff96c", "committedDate": "2020-03-31T14:27:57Z", "message": "optimize TsFileSequenceReader selfCheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab7aee45f6f1c2ed4744e24708600db324ee6262", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/ab7aee45f6f1c2ed4744e24708600db324ee6262", "committedDate": "2020-03-31T14:30:01Z", "message": "restore goon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a48a519a26671cd23fde9d8815a667cb1261617b", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/a48a519a26671cd23fde9d8815a667cb1261617b", "committedDate": "2020-03-31T14:37:18Z", "message": "optimize TsFileSequenceReader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/35c675127dabc5d2766ff8f2a255472b5a5160e2", "committedDate": "2020-03-31T14:37:35Z", "message": "optimize TsFileSequenceReader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTMwMTM2", "url": "https://github.com/apache/iotdb/pull/966#pullrequestreview-384930136", "createdAt": "2020-03-31T17:00:13Z", "commit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzowMDoxM1rOF-faiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzowMDoxM1rOF-faiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDcyOA==", "bodyText": "If we sync a tsfile from other iotdb, will this tsfile has time partition directory? Maybe we should use startTimeMap to get time partition", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401070728", "createdAt": "2020-03-31T17:00:13Z", "author": {"login": "SilverNarcissus"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -471,4 +473,12 @@ public void setProcessor(TsFileProcessor processor) {\n   public TimeseriesMetadata getTimeSeriesMetadata() {\n     return timeSeriesMetadata;\n   }\n+\n+  public long getTimePartition() {\n+    if (startTimeMap != null && !startTimeMap.isEmpty()) {\n+      return StorageEngine.getTimePartition(startTimeMap.values().iterator().next());\n+    }\n+    String[] splits = FilePathUtils.splitTsFilePath(this);\n+    return Long.parseLong(splits[splits.length - 2]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTQ0ODI3", "url": "https://github.com/apache/iotdb/pull/966#pullrequestreview-384944827", "createdAt": "2020-03-31T17:19:21Z", "commit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzoxOToyMVrOF-gJag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzoxOToyMVrOF-gJag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4MjczMA==", "bodyText": "Since Pair<String, List<ChunkMetadata> > is similar to previous ChunkGroupMetadata, I'm thinking if it's necessary to add ChunkGroupMetadata back instead of using the pair.", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401082730", "createdAt": "2020-03-31T17:19:21Z", "author": {"login": "HTHou"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/writer/TsFileIOWriter.java", "diffHunk": "@@ -65,14 +66,19 @@\n   }\n \n   protected TsFileOutput out;\n-  protected List<Pair<String, List<ChunkMetadata>>> chunkGroupInfoList = new ArrayList<>();\n   protected boolean canWrite = true;\n   protected int totalChunkNum = 0;\n   protected int invalidChunkNum;\n   protected File file;\n-  protected List<ChunkMetadata> chunkMetadataList = new ArrayList<>();\n-  protected Map<Path, List<ChunkMetadata>> chunkMetadataListMap = new TreeMap<>();\n+\n+\n+  // current flushed Chunk\n   private ChunkMetadata currentChunkMetadata;\n+  // current flushed ChunkGroup\n+  protected List<ChunkMetadata> chunkMetadataList = new ArrayList<>();\n+  // all flushed ChunkGroup,  device -> List<ChunkMetadata>\n+  protected List<Pair<String, List<ChunkMetadata>>> chunkGroupMetadataList = new ArrayList<>();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjAzNDQy", "url": "https://github.com/apache/iotdb/pull/966#pullrequestreview-385203442", "createdAt": "2020-04-01T01:04:26Z", "commit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df92e70a4b40d124ed02145975f6bcae1fe0ed24", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/df92e70a4b40d124ed02145975f6bcae1fe0ed24", "committedDate": "2020-04-01T01:15:15Z", "message": "add ChunkGroupMetadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjM1NjMz", "url": "https://github.com/apache/iotdb/pull/966#pullrequestreview-385235633", "createdAt": "2020-04-01T03:01:18Z", "commit": {"oid": "df92e70a4b40d124ed02145975f6bcae1fe0ed24"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d9a4ef6069ca2a6ab41394939e9a95520f7a3bc", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/9d9a4ef6069ca2a6ab41394939e9a95520f7a3bc", "committedDate": "2020-04-01T03:39:25Z", "message": "add a getTimePartitionWithCheck in TsFileResource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a4c36960d662f45f133fc83827524027c40f785", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/0a4c36960d662f45f133fc83827524027c40f785", "committedDate": "2020-04-01T05:14:26Z", "message": "fix sonar"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3049, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}