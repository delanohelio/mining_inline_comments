{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MjgwNzc0", "number": 1624, "title": "[IOTDB-836] [To rel/0.10] Fix merging statistics failed when endFile", "bodyText": "Clear the chunkGroupMetadataList when perform a delete timeseries operation to avoid merging statistics failed when endFile:\norg.apache.iotdb.tsfile.exception.filter.StatisticsClassException: Statistics classes mismatched: class org.apache.iotdb.tsfile.file.metadata.statistics.LongStatistics vs. class org.apache.iotdb.tsfile.file.metadata.statistics.DoubleStatistics\nat org.apache.iotdb.tsfile.file.metadata.statistics.Statistics.mergeStatistics(Statistics.java:164)\nat org.apache.iotdb.tsfile.write.writer.TsFileIOWriter.flushMetadataIndex(TsFileIOWriter.java:304)\nat org.apache.iotdb.tsfile.write.writer.TsFileIOWriter.endFile(TsFileIOWriter.java:239)\n...", "createdAt": "2020-08-15T08:39:23Z", "url": "https://github.com/apache/iotdb/pull/1624", "merged": true, "mergeCommit": {"oid": "d766679cd23c67ce780a0eb2f6f29bdc6820a343"}, "closed": true, "closedAt": "2020-08-22T08:41:27Z", "author": {"login": "samperson1997"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_FDEHgH2gAyNDY4MjgwNzc0OmJmZjM4YjJiZTg5YzI3MTEzM2M0OGE2YjViNTg2ODAwYzAxMGUwZGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBVULEAFqTQ3MjkwODQwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bff38b2be89c271133c48a6b5b586800c010e0da", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/bff38b2be89c271133c48a6b5b586800c010e0da", "committedDate": "2020-08-15T08:36:11Z", "message": "[IOTDB-836] Fix merging statistics failed when endFile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4006e0a4362bc999a67e7ffe4ed6b8b6e6ad9362", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/4006e0a4362bc999a67e7ffe4ed6b8b6e6ad9362", "committedDate": "2020-08-15T08:48:13Z", "message": "Fix sonar problem"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDI5MzIx", "url": "https://github.com/apache/iotdb/pull/1624#pullrequestreview-468029321", "createdAt": "2020-08-16T02:42:41Z", "commit": {"oid": "4006e0a4362bc999a67e7ffe4ed6b8b6e6ad9362"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQwMjo0Mjo0MVrOHBPA1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNlQwMjo0Mjo0MVrOHBPA1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA1NjU5Ng==", "bodyText": "what's this for?", "url": "https://github.com/apache/iotdb/pull/1624#discussion_r471056596", "createdAt": "2020-08-16T02:42:41Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/writer/TsFileIOWriter.java", "diffHunk": "@@ -335,6 +335,21 @@ public long getPos() throws IOException {\n     return deviceChunkMetadataMap;\n   }\n \n+  public void deleteMeasurementFromChunkGroupMetadataList(String deviceId, String measurementId) {\n+    for (ChunkGroupMetadata chunkGroupMetadata : chunkGroupMetadataList) {\n+      VersionUtils.applyVersion(chunkGroupMetadata.getChunkMetadataList(), versionInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4006e0a4362bc999a67e7ffe4ed6b8b6e6ad9362"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MDI5OTE3", "url": "https://github.com/apache/iotdb/pull/1624#pullrequestreview-468029917", "createdAt": "2020-08-16T03:02:03Z", "commit": {"oid": "4006e0a4362bc999a67e7ffe4ed6b8b6e6ad9362"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "696fbdc4cf2bc71fd15b97bcf6eda156c8273269", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/696fbdc4cf2bc71fd15b97bcf6eda156c8273269", "committedDate": "2020-08-17T06:35:22Z", "message": "Fix recover"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d1dc85fe5c8d7f5a69303775f120f2da89065d8", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/8d1dc85fe5c8d7f5a69303775f120f2da89065d8", "committedDate": "2020-08-17T06:37:12Z", "message": "Remove applying version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTE5MDA0", "url": "https://github.com/apache/iotdb/pull/1624#pullrequestreview-468519004", "createdAt": "2020-08-17T14:33:49Z", "commit": {"oid": "8d1dc85fe5c8d7f5a69303775f120f2da89065d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTI4OTUx", "url": "https://github.com/apache/iotdb/pull/1624#pullrequestreview-468528951", "createdAt": "2020-08-17T14:45:04Z", "commit": {"oid": "8d1dc85fe5c8d7f5a69303775f120f2da89065d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo0NTowNVrOHBr2NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo0NTowNVrOHBr2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUyOTAxMg==", "bodyText": "this does not take effect?", "url": "https://github.com/apache/iotdb/pull/1624#discussion_r471529012", "createdAt": "2020-08-17T14:45:05Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -244,6 +244,13 @@ public void deleteDataInMemory(Deletion deletion) {\n         workMemTable\n             .delete(deletion.getDevice(), deletion.getMeasurement(), deletion.getTimestamp());\n       }\n+\n+      // clear ChunkMetaData of the deleted timeseries\n+      if (deletion.getTimestamp() == Long.MAX_VALUE) {\n+        writer.deleteMeasurementFromChunkGroupMetadataList(deletion.getDevice(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d1dc85fe5c8d7f5a69303775f120f2da89065d8"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdc9d6d9f093533f416a7549444dd033929b44b1", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/cdc9d6d9f093533f416a7549444dd033929b44b1", "committedDate": "2020-08-17T15:13:25Z", "message": "Update logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMDg2MTgx", "url": "https://github.com/apache/iotdb/pull/1624#pullrequestreview-470086181", "createdAt": "2020-08-19T02:42:26Z", "commit": {"oid": "cdc9d6d9f093533f416a7549444dd033929b44b1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e82ecb3c13e55ff44bb506b3c1e47fe35c9a075", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/9e82ecb3c13e55ff44bb506b3c1e47fe35c9a075", "committedDate": "2020-08-20T01:52:48Z", "message": "Filter chunkMetadata when endFile"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c2987b94d4d2f900de2a976d4266911afb40d02", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/4c2987b94d4d2f900de2a976d4266911afb40d02", "committedDate": "2020-08-20T01:14:38Z", "message": "Rename \"chunkMetadataList\" which hides the field declared"}, "afterCommit": {"oid": "9e82ecb3c13e55ff44bb506b3c1e47fe35c9a075", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/9e82ecb3c13e55ff44bb506b3c1e47fe35c9a075", "committedDate": "2020-08-20T01:52:48Z", "message": "Filter chunkMetadata when endFile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96b24a6cbe2a63f1fe11f0b88f165965d8c44424", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/96b24a6cbe2a63f1fe11f0b88f165965d8c44424", "committedDate": "2020-08-20T02:24:05Z", "message": "Add test and comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "829fab88bceee82c5717c4bf70bdc5e634e27503", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/829fab88bceee82c5717c4bf70bdc5e634e27503", "committedDate": "2020-08-20T07:14:25Z", "message": "Remove deleting ChunkMetadata while deleting timeseries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71a4dde4efb12514b0bb12d2961a5ee9777509ca", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/71a4dde4efb12514b0bb12d2961a5ee9777509ca", "committedDate": "2020-08-20T07:46:12Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dd013925d6e255362a674040d0a082745a18eab", "author": {"user": {"login": "samperson1997", "name": "Zesong Sun"}}, "url": "https://github.com/apache/iotdb/commit/9dd013925d6e255362a674040d0a082745a18eab", "committedDate": "2020-08-20T12:02:06Z", "message": "Refactor codes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTA4NDAy", "url": "https://github.com/apache/iotdb/pull/1624#pullrequestreview-472908402", "createdAt": "2020-08-22T08:41:12Z", "commit": {"oid": "9dd013925d6e255362a674040d0a082745a18eab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3381, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}