{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExOTYwMzU1", "number": 1894, "title": "limit log size of logDispatcher", "bodyText": "", "createdAt": "2020-10-29T02:05:24Z", "url": "https://github.com/apache/iotdb/pull/1894", "merged": true, "mergeCommit": {"oid": "af26334b37e47ccfb3916a294f389d4da3f1fb99"}, "closed": true, "closedAt": "2020-11-02T06:33:49Z", "author": {"login": "mychaow"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXJFG0gH2gAyNTExOTYwMzU1OjM1ZmEwNjA4ZDRmOTA5YTQ3ZjRmNWRjYTQ1NWQ4OTY2OWU4OTBkNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYK9rLAH2gAyNTExOTYwMzU1OjM2Y2NmYzMyODc5MTBhYWIzMmU5NjU0YTkwZGYxZGUzMzBhNzI4NjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "35fa0608d4f909a47f4f5dca455d89669e890d50", "author": {"user": {"login": "mychaow", "name": "chaow"}}, "url": "https://github.com/apache/iotdb/commit/35fa0608d4f909a47f4f5dca455d89669e890d50", "committedDate": "2020-10-29T02:52:13Z", "message": "limit log size of logDispatcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70550c129a07da292230643e43324b765a3760c3", "author": {"user": {"login": "mychaow", "name": "chaow"}}, "url": "https://github.com/apache/iotdb/commit/70550c129a07da292230643e43324b765a3760c3", "committedDate": "2020-10-29T02:52:13Z", "message": "fix log level"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83fa7ff2593e686661d33577a5891b54dca3edbc", "author": {"user": {"login": "mychaow", "name": "chaow"}}, "url": "https://github.com/apache/iotdb/commit/83fa7ff2593e686661d33577a5891b54dca3edbc", "committedDate": "2020-10-29T02:08:56Z", "message": "fix log level"}, "afterCommit": {"oid": "70550c129a07da292230643e43324b765a3760c3", "author": {"user": {"login": "mychaow", "name": "chaow"}}, "url": "https://github.com/apache/iotdb/commit/70550c129a07da292230643e43324b765a3760c3", "committedDate": "2020-10-29T02:52:13Z", "message": "fix log level"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDk4NjU2", "url": "https://github.com/apache/iotdb/pull/1894#pullrequestreview-519498656", "createdAt": "2020-10-29T09:55:20Z", "commit": {"oid": "70550c129a07da292230643e43324b765a3760c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwOTo1NToyMVrOHqUQsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwOTo1NToyMVrOHqUQsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEzNDE5NA==", "bodyText": "maybe we can move the line outside of the while loop", "url": "https://github.com/apache/iotdb/pull/1894#discussion_r514134194", "createdAt": "2020-10-29T09:55:21Z", "author": {"login": "neuyilan"}, "path": "cluster/src/main/java/org/apache/iotdb/cluster/log/LogDispatcher.java", "diffHunk": "@@ -289,32 +294,44 @@ private AppendEntriesRequest prepareRequest(List<ByteBuffer> logList,\n \n       request.setEntries(logList);\n       // set index for raft\n-      request.setPrevLogIndex(currBatch.get(0).getLog().getCurrLogIndex() - 1);\n+      request.setPrevLogIndex(currBatch.get(firstIndex).getLog().getCurrLogIndex() - 1);\n       try {\n-        request.setPrevLogTerm(currBatch.get(0).getAppendEntryRequest().prevLogTerm);\n+        request.setPrevLogTerm(currBatch.get(firstIndex).getAppendEntryRequest().prevLogTerm);\n       } catch (Exception e) {\n         logger.error(\"getTerm failed for newly append entries\", e);\n       }\n       return request;\n     }\n \n     private void sendLogs(List<SendLogRequest> currBatch) throws TException {\n-      List<ByteBuffer> logList = new ArrayList<>();\n-      for (SendLogRequest request : currBatch) {\n-        Timer.Statistic.LOG_DISPATCHER_LOG_IN_QUEUE\n-            .calOperationCostTimeFromStart(request.getLog().getCreateTime());\n-        logList.add(request.getAppendEntryRequest().entry);\n-      }\n+      int logIndex = 0;\n+      logger.info(\"send logs from index {} to {}\", currBatch.get(0).getLog().getCurrLogIndex(),\n+        currBatch.get(currBatch.size() - 1).getLog().getCurrLogIndex());\n+      while (logIndex < currBatch.size()) {\n+        long logSize = IoTDBDescriptor.getInstance().getConfig().getThriftMaxFrameSize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70550c129a07da292230643e43324b765a3760c3"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDY2NjU0", "url": "https://github.com/apache/iotdb/pull/1894#pullrequestreview-520466654", "createdAt": "2020-10-30T08:43:01Z", "commit": {"oid": "70550c129a07da292230643e43324b765a3760c3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODo0MzowMlrOHrFvHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODo0MzowMlrOHrFvHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0NDc5OQ==", "bodyText": "be blocked", "url": "https://github.com/apache/iotdb/pull/1894#discussion_r514944799", "createdAt": "2020-10-30T08:43:02Z", "author": {"login": "jt2594838"}, "path": "cluster/src/main/java/org/apache/iotdb/cluster/server/member/RaftMember.java", "diffHunk": "@@ -1524,7 +1529,7 @@ private AppendLogResult sendLogToFollowers(Log log, AtomicInteger voteCounter) {\n     try {\n       if (allNodes.size() > 2) {\n         // if there are more than one followers, send the requests in parallel so that one slow\n-        // follower will not\n+        // follower will not blocked", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70550c129a07da292230643e43324b765a3760c3"}, "originalPosition": 160}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "773e9f8264df138aec4574fc2d62e5b53abff6f0", "author": {"user": {"login": "mychaow", "name": "chaow"}}, "url": "https://github.com/apache/iotdb/commit/773e9f8264df138aec4574fc2d62e5b53abff6f0", "committedDate": "2020-10-30T08:56:18Z", "message": "fix grammer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "badc6f5e3fb9cc1fe0cb40b88099c5c2a92f0b1a", "author": {"user": {"login": "mychaow", "name": "chaow"}}, "url": "https://github.com/apache/iotdb/commit/badc6f5e3fb9cc1fe0cb40b88099c5c2a92f0b1a", "committedDate": "2020-11-01T07:22:19Z", "message": "add ut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36ccfc3287910aab32e9654a90df1de330a72861", "author": {"user": {"login": "mychaow", "name": "chaow"}}, "url": "https://github.com/apache/iotdb/commit/36ccfc3287910aab32e9654a90df1de330a72861", "committedDate": "2020-11-01T07:37:50Z", "message": "add some log"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3770, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}