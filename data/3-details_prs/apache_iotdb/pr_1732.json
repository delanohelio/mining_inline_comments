{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2OTQ2NjQ2", "number": 1732, "title": "[IOTDB-829] Accelerate delete timeseries", "bodyText": "JIRA issue: https://issues.apache.org/jira/browse/IOTDB-829\nLocal Performance Test result\nDelete test result:\n\n1 device with 100k timeseries\uff0coriginal cost is 500s, after the improvement it reduce down to 100ms.\n1 device with 300k timeseries. Before improvement it costs 1900s. While with the improvement, the cost reduce down to 210ms\n\nInfluence to querying:\n100 timeseries\uff0cinserted 10000 points and executed M deletes.\nWe tested 1000000 queries with SQL:\n select sensor_name from device_name\n\nM = 5000\nBefore delete improvement: average cost 19729ms\nAfter delete improvement: average cost 20901ms\nincreased 5.9%\nM = 10000\nBefore delete improvement:average cost 21185ms\nAfter delete improvement: average cost 22414ms\nIncreased 5.8%\n\nRe-tested after revision in 10.15\nTest SQL\ndelete timeseries root.sg1.d1.*\n\nDelete test result:\n\n100k timeseries under root.sg1.d1. master branch cost is 632s, the cost of this PR reduce down to 76ms.\n300k timeseries under root.sg1.d1. master branch cost is 2040s. the cost of this PR reduce down to 111ms", "createdAt": "2020-09-14T23:41:34Z", "url": "https://github.com/apache/iotdb/pull/1732", "merged": true, "mergeCommit": {"oid": "102bd1656c39e05e91ae492c31f6ca5389e19965"}, "closed": true, "closedAt": "2020-10-19T04:02:30Z", "author": {"login": "wshao08"}, "timelineItems": {"totalCount": 53, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdItqhQAH2gAyNDg2OTQ2NjQ2OmVmY2QwMDc4ZTEyZWQ2MTI3ZDU4N2MwMGUxODk5MjFhNjVlNWE4MDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdT7FveAH2gAyNDg2OTQ2NjQ2OmExYWU1NTNkYTY4YzFhNGFiNDkyMzkyYTFhNGQxYjc1OGFjYzI5Njc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "efcd0078e12ed6127d587c00e189921a65e5a805", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/efcd0078e12ed6127d587c00e189921a65e5a805", "committedDate": "2020-09-14T07:00:48Z", "message": "Optimize performance of delete from and delete timeseries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63c6d05db822b5c591d6e60c6013e4edcfadc644", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/63c6d05db822b5c591d6e60c6013e4edcfadc644", "committedDate": "2020-09-14T07:07:02Z", "message": "Merge remote-tracking branch 'upstream/master' into delete_perf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "577217e361b2cef23224a6684dfe98d531b636c2", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/577217e361b2cef23224a6684dfe98d531b636c2", "committedDate": "2020-09-14T23:53:57Z", "message": "optimize partialpath match()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfed1a36143ca4a05660d8e26a78604fe47761c9", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/dfed1a36143ca4a05660d8e26a78604fe47761c9", "committedDate": "2020-09-15T06:49:18Z", "message": "Fix bugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NjYwMDM3", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-488660037", "createdAt": "2020-09-15T13:05:34Z", "commit": {"oid": "dfed1a36143ca4a05660d8e26a78604fe47761c9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzowNTozNFrOHSA10Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMzoyODowMVrOHSB1jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY1MDE5Mw==", "bodyText": "remove this", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r488650193", "createdAt": "2020-09-15T13:05:34Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/StorageEngine.java", "diffHunk": "@@ -447,27 +447,36 @@ public void update(String deviceId, String measurementId, long startTime, long e\n     // TODO\n   }\n \n+  public void delete(PartialPath path, long startTime, long endTime)\n+          throws StorageEngineException {\n+    StorageGroupProcessor storageGroupProcessor = getProcessor(path);\n+    try {\n+      storageGroupProcessor.delete(path, startTime, endTime);\n+    } catch (IOException e) {\n+      throw new StorageEngineException(e.getMessage());\n+    }\n+  }\n   /**\n    * delete data of timeseries \"{deviceId}.{measurementId}\" with time <= timestamp.\n    */\n-  public void delete(PartialPath deviceId, String measurementId, long startTime, long endTime)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfed1a36143ca4a05660d8e26a78604fe47761c9"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY2NjUxMQ==", "bodyText": "what if the path is root.*?", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r488666511", "createdAt": "2020-09-15T13:28:01Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/StorageEngine.java", "diffHunk": "@@ -447,27 +447,36 @@ public void update(String deviceId, String measurementId, long startTime, long e\n     // TODO\n   }\n \n+  public void delete(PartialPath path, long startTime, long endTime)\n+          throws StorageEngineException {\n+    StorageGroupProcessor storageGroupProcessor = getProcessor(path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfed1a36143ca4a05660d8e26a78604fe47761c9"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1c408364babee15cfd4a7a3f2b27672c5253862", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/e1c408364babee15cfd4a7a3f2b27672c5253862", "committedDate": "2020-09-16T00:02:21Z", "message": "Remove unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7604daf9aaf1c2b5927dacf7bcc460cf0ee67b50", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/7604daf9aaf1c2b5927dacf7bcc460cf0ee67b50", "committedDate": "2020-09-16T06:35:32Z", "message": "Fix pr review issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db3514c159aa3a220378dd71a44908f216ea508d", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/db3514c159aa3a220378dd71a44908f216ea508d", "committedDate": "2020-09-17T09:00:36Z", "message": "deal with delete root.* case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "598b95df66882a84b5e3d72166627888f579fdab", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/598b95df66882a84b5e3d72166627888f579fdab", "committedDate": "2020-09-17T09:07:16Z", "message": "remove redundant imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "042d06c61e3e10182f8a8efcdeee16ce778c7c88", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/042d06c61e3e10182f8a8efcdeee16ce778c7c88", "committedDate": "2020-09-18T03:31:21Z", "message": "Remove unused code and imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9720b26925115a8ffbe9d84c25097d8c4d8b074e", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/9720b26925115a8ffbe9d84c25097d8c4d8b074e", "committedDate": "2020-09-18T06:36:32Z", "message": "Revert \"deal with delete root.* case\"\n\nThis reverts commit db3514c159aa3a220378dd71a44908f216ea508d."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "085c5b0721ead85ddf78b77dc7e0400889504b48", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/085c5b0721ead85ddf78b77dc7e0400889504b48", "committedDate": "2020-09-18T06:37:30Z", "message": "Revert \"Fix pr review issues\"\n\nThis reverts commit 7604daf9aaf1c2b5927dacf7bcc460cf0ee67b50."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a550d410349314da2337bc10d25a97b824eec5fa", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/a550d410349314da2337bc10d25a97b824eec5fa", "committedDate": "2020-09-18T08:02:03Z", "message": "deal with delete root.* case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f04134fb573b5a7ac2096600b29987b1fcd21ec", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/3f04134fb573b5a7ac2096600b29987b1fcd21ec", "committedDate": "2020-09-18T08:52:56Z", "message": "Add logs to debug CI issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "830645fbabcba4e8a592194499706062d6da53cd", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/830645fbabcba4e8a592194499706062d6da53cd", "committedDate": "2020-09-18T09:31:05Z", "message": "Revert \"deal with delete root.* case\"\n\nThis reverts commit a550d410349314da2337bc10d25a97b824eec5fa."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0535d430540b774d66f62be666f948af59734bd2", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/0535d430540b774d66f62be666f948af59734bd2", "committedDate": "2020-09-18T10:04:20Z", "message": "Revert \"Revert \"deal with delete root.* case\"\"\n\nThis reverts commit 830645fbabcba4e8a592194499706062d6da53cd."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaa26007bb4885fccc5f640d155b513f54d03adb", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/aaa26007bb4885fccc5f640d155b513f54d03adb", "committedDate": "2020-09-18T14:30:44Z", "message": "Add more testing log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e3ba83870c29c062c4f8a064b152a61fd33c04b", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/9e3ba83870c29c062c4f8a064b152a61fd33c04b", "committedDate": "2020-09-18T14:35:03Z", "message": "Merge remote-tracking branch 'upstream/master' into delete_perf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b39026aa61b50891089b6a44a3bacf634913063f", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/b39026aa61b50891089b6a44a3bacf634913063f", "committedDate": "2020-09-18T15:57:09Z", "message": "Fix attempts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "064599916fc9c12a2b8f376c376819a77f26ec6e", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/064599916fc9c12a2b8f376c376819a77f26ec6e", "committedDate": "2020-09-19T02:17:18Z", "message": "add logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8c560e7218d7ed04c727ab761a2c214caa88819", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/d8c560e7218d7ed04c727ab761a2c214caa88819", "committedDate": "2020-09-21T01:37:49Z", "message": "Add additional interface  to get all related storage path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7d77af0d1b9054cba9248864faafd996ff9714c", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/b7d77af0d1b9054cba9248864faafd996ff9714c", "committedDate": "2020-09-21T02:15:36Z", "message": "utilize new interface in delete timeseries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMjY4NjA2", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-492268606", "createdAt": "2020-09-21T04:01:06Z", "commit": {"oid": "b7d77af0d1b9054cba9248864faafd996ff9714c"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwNDowMTowNlrOHVAIyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwNjoyMzo0M1rOHVB7ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4NDM5Mw==", "bodyText": "put the for into the if", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r491784393", "createdAt": "2020-09-21T04:01:06Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -226,17 +229,18 @@ public void insertTablet(InsertTabletPlan insertTabletPlan, int start, int end,\n    * <p>\n    * Delete data in both working MemTable and flushing MemTables.\n    */\n-  public void deleteDataInMemory(Deletion deletion) {\n+  public void deleteDataInMemory(Deletion deletion) throws MetadataException {\n     flushQueryLock.writeLock().lock();\n     if (logger.isDebugEnabled()) {\n       logger\n           .debug(FLUSH_QUERY_WRITE_LOCKED, storageGroupName, tsFileResource.getTsFile().getName());\n     }\n     try {\n-      if (workMemTable != null) {\n-        workMemTable\n-            .delete(deletion.getDevice(), deletion.getMeasurement(), deletion.getStartTime(),\n-                deletion.getEndTime());\n+      for (PartialPath p : IoTDB.metaManager.getAllTimeseriesPath(deletion.getPath())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d77af0d1b9054cba9248864faafd996ff9714c"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4NTI1MA==", "bodyText": "add javadoc", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r491785250", "createdAt": "2020-09-21T04:06:34Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/PartialPath.java", "diffHunk": "@@ -99,6 +105,41 @@ public PartialPath concatNode(String node) {\n     return nodes;\n   }\n \n+  public int getNodeLength() {\n+    return nodes.length;\n+  }\n+\n+  public PartialPath alterPrefixPath(PartialPath prefixPath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d77af0d1b9054cba9248864faafd996ff9714c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4NTQxNQ==", "bodyText": "add an example", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r491785415", "createdAt": "2020-09-21T04:07:27Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -503,7 +503,22 @@ private void findStorageGroup(\n   }\n \n   /**\n-   * Get all storage group under give path\n+   * Get the storage group that given path belonged to or under given path", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d77af0d1b9054cba9248864faafd996ff9714c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc4NjM1OA==", "bodyText": "change the fullPath in concatPath()", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r491786358", "createdAt": "2020-09-21T04:13:55Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/PartialPath.java", "diffHunk": "@@ -99,6 +105,41 @@ public PartialPath concatNode(String node) {\n     return nodes;\n   }\n \n+  public int getNodeLength() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d77af0d1b9054cba9248864faafd996ff9714c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgxMzQzMQ==", "bodyText": "add javadoc and give an example for each case", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r491813431", "createdAt": "2020-09-21T06:22:36Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/PartialPath.java", "diffHunk": "@@ -99,6 +105,41 @@ public PartialPath concatNode(String node) {\n     return nodes;\n   }\n \n+  public int getNodeLength() {\n+    return nodes.length;\n+  }\n+\n+  public PartialPath alterPrefixPath(PartialPath prefixPath) {\n+    String[] newNodes = Arrays.copyOf(nodes, Math.max(nodes.length, prefixPath.getNodeLength()));\n+    System.arraycopy(prefixPath.getNodes(), 0, newNodes, 0, prefixPath.getNodeLength());\n+    return new PartialPath(newNodes);\n+  }\n+\n+  public void setPrefixPath(PartialPath prefixPath) {\n+    this.nodes = Arrays.copyOf(nodes, Math.max(nodes.length, prefixPath.getNodeLength()));\n+    System.arraycopy(prefixPath.getNodes(), 0, nodes, 0, prefixPath.getNodeLength());\n+    fullPath = String.join(TsFileConstant.PATH_SEPARATOR, nodes);\n+  }\n+\n+  public boolean matchFullPath(String rPath) throws IllegalPathException {\n+    return matchFullPath(new PartialPath(rPath));\n+  }\n+\n+  public boolean matchFullPath(PartialPath rPath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d77af0d1b9054cba9248864faafd996ff9714c"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgxMzc5NQ==", "bodyText": "add javadoc", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r491813795", "createdAt": "2020-09-21T06:23:43Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -771,6 +771,15 @@ public PartialPath getStorageGroupPath(PartialPath path) throws StorageGroupNotS\n     }\n   }\n \n+  public List<PartialPath> getRelatedStorageGroups(PartialPath path) throws MetadataException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7d77af0d1b9054cba9248864faafd996ff9714c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "970220d7af0ec3a1d61c85fb755119927e15f003", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/970220d7af0ec3a1d61c85fb755119927e15f003", "committedDate": "2020-09-22T09:45:00Z", "message": "Add java doc and update design docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDQzODYx", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-497043861", "createdAt": "2020-09-27T02:17:20Z", "commit": {"oid": "970220d7af0ec3a1d61c85fb755119927e15f003"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjoxNzoyMVrOHYj-QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMjoxNzo0MVrOHYj-Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNzI0OQ==", "bodyText": "I think you also write every mod record into tsfile resource's mod file. In jira, you said that\nWe need to record N*M modifications, which is time consuming. \n\nCould you explain that?   Thanks~", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r495517249", "createdAt": "2020-09-27T02:17:21Z", "author": {"login": "SilverNarcissus"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -1443,13 +1443,15 @@ private void logDeletion(long startTime, long endTime, PartialPath deviceId, Str\n \n   private void deleteDataInFiles(Collection<TsFileResource> tsFileResourceList, Deletion deletion,\n       List<ModificationFile> updatedModFiles)\n-      throws IOException {\n-    String deviceId = deletion.getDevice();\n+          throws IOException, MetadataException {\n     for (TsFileResource tsFileResource : tsFileResourceList) {\n-      if (!tsFileResource.containsDevice(deviceId) ||\n-          deletion.getEndTime() < tsFileResource.getStartTime(deviceId) ||\n-          deletion.getStartTime() > tsFileResource.getOrDefaultEndTime(deviceId, Long.MAX_VALUE)) {\n-        continue;\n+      for (PartialPath p : IoTDB.metaManager.getAllTimeseriesPath(deletion.getPath())) {\n+        String deviceId = p.getDevice();\n+        if (!tsFileResource.containsDevice(deviceId) ||\n+                deletion.getEndTime() < tsFileResource.getStartTime(deviceId) ||\n+                deletion.getStartTime() > tsFileResource.getOrDefaultEndTime(deviceId, Long.MAX_VALUE)) {\n+          continue;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "970220d7af0ec3a1d61c85fb755119927e15f003"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNzI3OQ==", "bodyText": "Have you finish the TODO?", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r495517279", "createdAt": "2020-09-27T02:17:41Z", "author": {"login": "SilverNarcissus"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -1378,26 +1375,30 @@ public void delete(PartialPath deviceId, String measurementId, long startTime, l\n     List<ModificationFile> updatedModFiles = new ArrayList<>();\n \n     try {\n-      Long lastUpdateTime = null;\n-      for (Map<String, Long> latestTimeMap : latestTimeForEachDevice.values()) {\n-        Long curTime = latestTimeMap.get(deviceId.getFullPath());\n-        if (curTime != null && (lastUpdateTime == null || lastUpdateTime < curTime)) {\n-          lastUpdateTime = curTime;\n+      for (PartialPath p : IoTDB.metaManager.getAllTimeseriesPath(path)) {\n+        PartialPath deviceId = p.getDevicePath();\n+        String measurementId = p.getMeasurement();\n+        Long lastUpdateTime = null;\n+        for (Map<String, Long> latestTimeMap : latestTimeForEachDevice.values()) {\n+          Long curTime = latestTimeMap.get(deviceId.getFullPath());\n+          if (curTime != null && (lastUpdateTime == null || lastUpdateTime < curTime)) {\n+            lastUpdateTime = curTime;\n+          }\n         }\n-      }\n-\n-      // There is no tsfile data, the delete operation is invalid\n-      if (lastUpdateTime == null) {\n-        logger.debug(\"No device {} in SG {}, deletion invalid\", deviceId, storageGroupName);\n-        return;\n+        // There is no tsfile data, the delete operation is invalid\n+        if (lastUpdateTime == null) {\n+          logger.debug(\"No device {} in SG {}, deletion invalid\", deviceId, storageGroupName);\n+          return;\n+        }\n+        // delete Last cache record if necessary\n+        tryToDeleteLastCache(deviceId, measurementId, startTime, endTime);\n       }\n \n       // write log to impacted working TsFileProcessors\n-      logDeletion(startTime, endTime, deviceId, measurementId);\n-      // delete Last cache record if necessary\n-      tryToDeleteLastCache(deviceId, measurementId, startTime, endTime);\n-      Deletion deletion = new Deletion(deviceId.concatNode(measurementId),\n-          MERGE_MOD_START_VERSION_NUM, startTime, endTime);\n+      // TODO rewrite logDeletion", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "970220d7af0ec3a1d61c85fb755119927e15f003"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4c5f61d98794046ca380d4b273609f79a4c2249", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/f4c5f61d98794046ca380d4b273609f79a4c2249", "committedDate": "2020-09-27T08:33:14Z", "message": "remove TODO tag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6f49d7e39365e2efa314a8ce8739b0329f3ef42", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/f6f49d7e39365e2efa314a8ce8739b0329f3ef42", "committedDate": "2020-09-27T09:56:35Z", "message": "Add tests and fix errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MTM4ODg5", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-497138889", "createdAt": "2020-09-28T01:25:37Z", "commit": {"oid": "f6f49d7e39365e2efa314a8ce8739b0329f3ef42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MTAzNDU4", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-499103458", "createdAt": "2020-09-30T05:56:41Z", "commit": {"oid": "f6f49d7e39365e2efa314a8ce8739b0329f3ef42"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNTo1Njo0MVrOHaOSfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwNTo1Njo0MVrOHaOSfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI1OTEzNQ==", "bodyText": "The for (PartialPath p ) statement is of no use. Check the code carefully.\ninsert into root.turbine1.a.d1(timestamp,s1) values(1,1);\ninsert into root.turbine1.a.d2(timestamp,s1) values(1,1);\nflush\ninsert into root.turbine1.b.d1(timestamp,s1) values(2,1);\ninsert into root.turbine1.b.d2(timestamp,s1) values(2,1);\nflush\ndelete from root.turbine1 where time < 5\nYou will record all files a mod.", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r497259135", "createdAt": "2020-09-30T05:56:41Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -1443,13 +1443,15 @@ private void logDeletion(long startTime, long endTime, PartialPath deviceId, Str\n \n   private void deleteDataInFiles(Collection<TsFileResource> tsFileResourceList, Deletion deletion,\n       List<ModificationFile> updatedModFiles)\n-      throws IOException {\n-    String deviceId = deletion.getDevice();\n+          throws IOException, MetadataException {\n     for (TsFileResource tsFileResource : tsFileResourceList) {\n-      if (!tsFileResource.containsDevice(deviceId) ||\n-          deletion.getEndTime() < tsFileResource.getStartTime(deviceId) ||\n-          deletion.getStartTime() > tsFileResource.getOrDefaultEndTime(deviceId, Long.MAX_VALUE)) {\n-        continue;\n+      for (PartialPath p : IoTDB.metaManager.getAllTimeseriesPath(deletion.getPath())) {\n+        String deviceId = p.getDevice();\n+        if (!tsFileResource.containsDevice(deviceId) ||\n+                deletion.getEndTime() < tsFileResource.getStartTime(deviceId) ||\n+                deletion.getStartTime() > tsFileResource.getOrDefaultEndTime(deviceId, Long.MAX_VALUE)) {\n+          continue;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNzI0OQ=="}, "originalCommit": {"oid": "970220d7af0ec3a1d61c85fb755119927e15f003"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8981086502773305e6bb6b5023edd7ca4836e259", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/8981086502773305e6bb6b5023edd7ca4836e259", "committedDate": "2020-10-05T03:12:44Z", "message": "Fix delete filter bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29685af3908820a8eb3f1aed78936efcd90fc2a4", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/29685af3908820a8eb3f1aed78936efcd90fc2a4", "committedDate": "2020-10-05T04:20:38Z", "message": "Remove unnecessary if condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f0e44d3213c038c6afebc095e5fcb23bf25bd2e", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/9f0e44d3213c038c6afebc095e5fcb23bf25bd2e", "committedDate": "2020-10-05T05:47:20Z", "message": "Fix bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c680d9118db64a80b0921d7fa4e115f66475b31", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/3c680d9118db64a80b0921d7fa4e115f66475b31", "committedDate": "2020-10-05T06:13:27Z", "message": "bug fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7f882e3b68b727f1fc8ebfecb8ecb83d2ef1904", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/a7f882e3b68b727f1fc8ebfecb8ecb83d2ef1904", "committedDate": "2020-10-05T07:33:11Z", "message": "Fix test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/b39d815078c79b90c94453275f814f15c2f60a5a", "committedDate": "2020-10-05T08:28:02Z", "message": "Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNjI1MzA4", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-502625308", "createdAt": "2020-10-06T06:43:23Z", "commit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNjo0MzoyM1rOHc39yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNjo0MzoyM1rOHc39yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAzOTExMw==", "bodyText": "This may cause OOM, you'd better provide a match method for TsFileResource.\nFor each device in TsFileResource, check if it matches the given path", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r500039113", "createdAt": "2020-10-06T06:43:23Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -1440,15 +1439,26 @@ private void logDeletion(long startTime, long endTime, PartialPath deviceId, Str\n     }\n   }\n \n+  private boolean canSkipDelete(TsFileResource tsFileResource, Deletion deletion)\n+      throws MetadataException {\n+    for (PartialPath p : IoTDB.metaManager.getAllTimeseriesPath(deletion.getPath())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzQ5NzEw", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-502749710", "createdAt": "2020-10-06T09:26:23Z", "commit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOToyNjoyM1rOHc9uJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMTowMDoxMlrOHdA7dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzMzQxNA==", "bodyText": "It seems that deleteTimeseries function can directly call the delete function to avoid code duplication.", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r500133414", "createdAt": "2020-10-06T09:26:23Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/StorageEngine.java", "diffHunk": "@@ -447,28 +447,32 @@ public void update(String deviceId, String measurementId, long startTime, long e\n     // TODO\n   }\n \n-  /**\n-   * delete data of timeseries \"{deviceId}.{measurementId}\" with time <= timestamp.\n-   */\n-  public void delete(PartialPath deviceId, String measurementId, long startTime, long endTime)\n-      throws StorageEngineException {\n-    StorageGroupProcessor storageGroupProcessor = getProcessor(deviceId);\n+  public void delete(PartialPath path, long startTime, long endTime)\n+          throws StorageEngineException {\n     try {\n-      storageGroupProcessor.delete(deviceId, measurementId, startTime, endTime);\n-    } catch (IOException e) {\n+      List<PartialPath> sgPaths = IoTDB.metaManager.searchAllRelatedStorageGroups(path);\n+      for (PartialPath storageGroupPath : sgPaths) {\n+        StorageGroupProcessor storageGroupProcessor = getProcessor(storageGroupPath);\n+        PartialPath newPath = path.alterPrefixPath(storageGroupPath);\n+        storageGroupProcessor.delete(newPath, startTime, endTime);\n+      }\n+    } catch (IOException | MetadataException e) {\n       throw new StorageEngineException(e.getMessage());\n     }\n   }\n \n   /**\n    * delete data of timeseries \"{deviceId}.{measurementId}\"\n    */\n-  public void deleteTimeseries(PartialPath deviceId, String measurementId)\n+  public void deleteTimeseries(PartialPath path)\n       throws StorageEngineException {\n-    StorageGroupProcessor storageGroupProcessor = getProcessor(deviceId);\n     try {\n-      storageGroupProcessor.delete(deviceId, measurementId, Long.MIN_VALUE, Long.MAX_VALUE);\n-    } catch (IOException e) {\n+      for (PartialPath storageGroupPath : IoTDB.metaManager.searchAllRelatedStorageGroups(path)) {\n+        StorageGroupProcessor storageGroupProcessor = getProcessor(storageGroupPath);\n+        PartialPath newPath = path.alterPrefixPath(storageGroupPath);\n+        storageGroupProcessor.delete(newPath, Long.MIN_VALUE, Long.MAX_VALUE);\n+      }\n+    } catch (IOException | MetadataException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzOTMzOA==", "bodyText": "Before, the modication record corresponds to only one timeseries, so it's safe to delete it while occuring one matched time series. However. now, one modification record could correspond to many timeseries, it won't be right to delete it.", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r500139338", "createdAt": "2020-10-06T09:36:01Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/merge/manage/MergeResource.java", "diffHunk": "@@ -184,7 +184,7 @@ public IChunkWriter getChunkWriter(MeasurementSchema measurementSchema) {\n     // each path is visited only once in a merge, so the modifications can be removed after visiting\n     while (modificationIterator.hasNext()) {\n       Modification modification = modificationIterator.next();\n-      if (modification.getPath().equals(path)) {\n+      if (modification.getPath().matchFullPath(path)) {\n         pathModifications.add(modification);\n         modificationIterator.remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3MTE4OQ==", "bodyText": "The if condition is wrong. Maybe you can change a way, think about when it will return true.Like:\n!tsFileResource.containsDevice(deviceId) ||\t      if (canSkipDelete(tsFileResource, deletion)) {\ndeletion.getEndTime() < tsFileResource.getStartTime(deviceId) ||\ndeletion.getStartTime() > tsFileResource.getOrDefaultEndTime(deviceId, Long.MAX_VALUE)", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r500171189", "createdAt": "2020-10-06T10:32:21Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -1440,15 +1439,26 @@ private void logDeletion(long startTime, long endTime, PartialPath deviceId, Str\n     }\n   }\n \n+  private boolean canSkipDelete(TsFileResource tsFileResource, Deletion deletion)\n+      throws MetadataException {\n+    for (PartialPath p : IoTDB.metaManager.getAllTimeseriesPath(deletion.getPath())) {\n+      String deviceId = p.getDevice();\n+      if (tsFileResource.containsDevice(deviceId) &&\n+          (deletion.getStartTime() <= tsFileResource.getStartTime(deviceId)\n+              && tsFileResource.getStartTime(deviceId) <= deletion.getEndTime())\n+          || (deletion.getStartTime() >= tsFileResource.getStartTime(deviceId)\n+          && deletion.getStartTime() <= tsFileResource.getOrDefaultEndTime(deviceId, Long.MAX_VALUE))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3Mjc1MQ==", "bodyText": "The canSkipDelete function will can the IoTDB.metaManager.getAllTimeseriesPath(deletion.getPath()), it shouldn't be in the for loop, and actually, you already have it in the caller of this function.", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r500172751", "createdAt": "2020-10-06T10:35:22Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -1440,15 +1439,26 @@ private void logDeletion(long startTime, long endTime, PartialPath deviceId, Str\n     }\n   }\n \n+  private boolean canSkipDelete(TsFileResource tsFileResource, Deletion deletion)\n+      throws MetadataException {\n+    for (PartialPath p : IoTDB.metaManager.getAllTimeseriesPath(deletion.getPath())) {\n+      String deviceId = p.getDevice();\n+      if (tsFileResource.containsDevice(deviceId) &&\n+          (deletion.getStartTime() <= tsFileResource.getStartTime(deviceId)\n+              && tsFileResource.getStartTime(deviceId) <= deletion.getEndTime())\n+          || (deletion.getStartTime() >= tsFileResource.getStartTime(deviceId)\n+          && deletion.getStartTime() <= tsFileResource.getOrDefaultEndTime(deviceId, Long.MAX_VALUE))) {\n+        return false;\n+      }\n+    }\n+    return true;\n+  }\n \n   private void deleteDataInFiles(Collection<TsFileResource> tsFileResourceList, Deletion deletion,\n       List<ModificationFile> updatedModFiles)\n-      throws IOException {\n-    String deviceId = deletion.getDevice();\n+          throws IOException, MetadataException {\n     for (TsFileResource tsFileResource : tsFileResourceList) {\n-      if (!tsFileResource.containsDevice(deviceId) ||\n-          deletion.getEndTime() < tsFileResource.getStartTime(deviceId) ||\n-          deletion.getStartTime() > tsFileResource.getOrDefaultEndTime(deviceId, Long.MAX_VALUE)) {\n+      if (canSkipDelete(tsFileResource, deletion)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE3Mzg0Mw==", "bodyText": "no need to call getAllTimeseriesPath again, you can pass it from the caller.", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r500173843", "createdAt": "2020-10-06T10:37:22Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -226,17 +229,18 @@ public void insertTablet(InsertTabletPlan insertTabletPlan, int start, int end,\n    * <p>\n    * Delete data in both working MemTable and flushing MemTables.\n    */\n-  public void deleteDataInMemory(Deletion deletion) {\n+  public void deleteDataInMemory(Deletion deletion) throws MetadataException {\n     flushQueryLock.writeLock().lock();\n     if (logger.isDebugEnabled()) {\n       logger\n           .debug(FLUSH_QUERY_WRITE_LOCKED, storageGroupName, tsFileResource.getTsFile().getName());\n     }\n     try {\n       if (workMemTable != null) {\n-        workMemTable\n-            .delete(deletion.getDevice(), deletion.getMeasurement(), deletion.getStartTime(),\n-                deletion.getEndTime());\n+        for (PartialPath p : IoTDB.metaManager.getAllTimeseriesPath(deletion.getPath())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4MDY3Ng==", "bodyText": "No need to get full path here.", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r500180676", "createdAt": "2020-10-06T10:50:38Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/PartialPath.java", "diffHunk": "@@ -50,11 +50,17 @@ public PartialPath(String path) throws IllegalPathException {\n     this.fullPath = path;\n   }\n \n+  public PartialPath(String device, String measurement) throws IllegalPathException {\n+    this.fullPath = device + TsFileConstant.PATH_SEPARATOR + measurement;\n+    this.nodes = MetaUtils.splitPathToDetachedPath(fullPath);\n+  }\n+\n   /**\n    * @param partialNodes nodes of a time series path\n    */\n   public PartialPath(String[] partialNodes) {\n-    nodes = partialNodes;\n+    this.nodes = partialNodes;\n+    this.fullPath = String.join(TsFileConstant.PATH_SEPARATOR, nodes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4MDc5MQ==", "bodyText": "Same as above.", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r500180791", "createdAt": "2020-10-06T10:50:50Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/PartialPath.java", "diffHunk": "@@ -87,6 +93,7 @@ void concatPath(String[] otherNodes) {\n     int len = nodes.length;\n     this.nodes = Arrays.copyOf(nodes, nodes.length + otherNodes.length);\n     System.arraycopy(otherNodes, 0, nodes, len, otherNodes.length);\n+    fullPath = String.join(TsFileConstant.PATH_SEPARATOR, nodes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4NTk3Mw==", "bodyText": "It seems that you have get all the timeseries for each path here, there is no need for you to call it again somewhere else, you can pass it from here.", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r500185973", "createdAt": "2020-10-06T11:00:12Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -713,7 +713,9 @@ public void delete(DeletePlan deletePlan) throws QueryProcessException {\n     try {\n       Set<PartialPath> existingPaths = new HashSet<>();\n       for (PartialPath p : deletePlan.getPaths()) {\n-        existingPaths.addAll(getPathsName(p));\n+        if (!getPathsName(p).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b39d815078c79b90c94453275f814f15c2f60a5a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a2bf2d54d465373e3828f27b8d94685a9c23534", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/6a2bf2d54d465373e3828f27b8d94685a9c23534", "committedDate": "2020-10-08T07:58:20Z", "message": "Merge remote-tracking branch 'upstream/master' into delete_perf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5273d6e78821e625d96853f8c0e53b563bc7891", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/b5273d6e78821e625d96853f8c0e53b563bc7891", "committedDate": "2020-10-11T23:56:34Z", "message": "Fix review issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0288c133edaacdd2a7625b3f74cb524c5ac34d70", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/0288c133edaacdd2a7625b3f74cb524c5ac34d70", "committedDate": "2020-10-12T01:04:26Z", "message": "Fix delete merge bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e93a3e3ff1f82e4879a8d603c81413802ba62ee9", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/e93a3e3ff1f82e4879a8d603c81413802ba62ee9", "committedDate": "2020-10-12T01:14:02Z", "message": "Fix testing issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3957519a17f44a599da55ede7a67f9268b8ea1b9", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/3957519a17f44a599da55ede7a67f9268b8ea1b9", "committedDate": "2020-10-12T03:06:56Z", "message": "remove some comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be11e765597280173e627e3b8db76bb7b429ae06", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/be11e765597280173e627e3b8db76bb7b429ae06", "committedDate": "2020-10-13T06:19:31Z", "message": "Remove incorrect change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f12db202e063ed1fe934afc7aa0dc360107acc00", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/f12db202e063ed1fe934afc7aa0dc360107acc00", "committedDate": "2020-10-13T10:46:33Z", "message": "Avoid invoking getAllTimeseriesPath() for performance's sake"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e214434c80920cc417962d8662476c0544a2e7a3", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/e214434c80920cc417962d8662476c0544a2e7a3", "committedDate": "2020-10-13T11:56:37Z", "message": "modifications for performance reason"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDE0NjQ0", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-507414644", "createdAt": "2020-10-13T13:09:49Z", "commit": {"oid": "e214434c80920cc417962d8662476c0544a2e7a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f98f213c1b67e182a83079f3351a96c734568fb5", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/f98f213c1b67e182a83079f3351a96c734568fb5", "committedDate": "2020-10-15T02:31:16Z", "message": "Fix testing issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54760ee4a7cce5eea8bce8b75b92d56998a2189e", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/54760ee4a7cce5eea8bce8b75b92d56998a2189e", "committedDate": "2020-10-15T02:56:29Z", "message": "Fix logreplayer test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTA5NTA5", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-508909509", "createdAt": "2020-10-15T03:20:57Z", "commit": {"oid": "54760ee4a7cce5eea8bce8b75b92d56998a2189e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMzoyMDo1N1rOHhvXCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMzoyMjo0OVrOHhvY4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE0MTAwMg==", "bodyText": "hi, why clear the deviceMap?   if originalPath is root.ln.sg and devicePath is root.ln.sg.d1, we only need to delete the points in time range [89, 100], but the memChunk maybe have points in time range [0, 100].  Same as the second condition which check  the last path is *.", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r505141002", "createdAt": "2020-10-15T03:20:57Z", "author": {"login": "mychaow"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/memtable/AbstractMemTable.java", "diffHunk": "@@ -230,20 +233,27 @@ public ReadOnlyMemChunk query(String deviceId, String measurement, TSDataType da\n   }\n \n   @Override\n-  public void delete(String deviceId, String measurementId, long startTimestamp, long endTimestamp) {\n-    Map<String, IWritableMemChunk> deviceMap = memTableMap.get(deviceId);\n-    if (deviceMap != null) {\n-      IWritableMemChunk chunk = deviceMap.get(measurementId);\n-      if (chunk == null) {\n-        return;\n-      }\n-      // If startTimestamp == Long.MIN_VALUE && endTimestamp == Long.MAX_VALUE,\n-      // it means that the whole timeseries is deleted\n-      if (startTimestamp == Long.MIN_VALUE && endTimestamp == Long.MAX_VALUE) {\n-        deviceMap.remove(measurementId);\n+  public void delete(PartialPath originalPath, PartialPath devicePath, long startTimestamp, long endTimestamp) {\n+    Map<String, IWritableMemChunk> deviceMap = memTableMap.get(devicePath.getFullPath());\n+    if (deviceMap == null) {\n+      return;\n+    }\n+    if (originalPath.getNodes().length <= devicePath.getNodes().length ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54760ee4a7cce5eea8bce8b75b92d56998a2189e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE0MTQ3Mw==", "bodyText": "help me change the MManager.getInstance() to IoTDB.metaManager", "url": "https://github.com/apache/iotdb/pull/1732#discussion_r505141473", "createdAt": "2020-10-15T03:22:49Z", "author": {"login": "mychaow"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -1467,26 +1473,30 @@ private void deleteDataInFiles(Collection<TsFileResource> tsFileResourceList, De\n       // delete data in memory of unsealed file\n       if (!tsFileResource.isClosed()) {\n         TsFileProcessor tsfileProcessor = tsFileResource.getUnsealedFileProcessor();\n-        tsfileProcessor.deleteDataInMemory(deletion);\n+        tsfileProcessor.deleteDataInMemory(deletion, devicePaths);\n       }\n \n       // add a record in case of rollback\n       updatedModFiles.add(tsFileResource.getModFile());\n     }\n   }\n \n-  private void tryToDeleteLastCache(PartialPath deviceId, String measurementId, long startTime,\n-      long endTime) throws WriteProcessException {\n+  private void tryToDeleteLastCache(PartialPath deviceId, PartialPath originalPath,\n+      long startTime, long endTime) throws WriteProcessException {\n+    if (!IoTDBDescriptor.getInstance().getConfig().isLastCacheEnabled()) {\n+      return;\n+    }\n     try {\n       MManager manager = MManager.getInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54760ee4a7cce5eea8bce8b75b92d56998a2189e"}, "originalPosition": 144}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efbf00a70c1614c2783d4ab46e300a1a3ba05e0f", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/efbf00a70c1614c2783d4ab46e300a1a3ba05e0f", "committedDate": "2020-10-15T23:23:45Z", "message": "Fix code bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d03ddd7fb3174727e9b320d73dbeee62c276c87", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/2d03ddd7fb3174727e9b320d73dbeee62c276c87", "committedDate": "2020-10-16T02:11:33Z", "message": "Fix testing issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMzUyOTcy", "url": "https://github.com/apache/iotdb/pull/1732#pullrequestreview-511352972", "createdAt": "2020-10-19T00:30:59Z", "commit": {"oid": "e214434c80920cc417962d8662476c0544a2e7a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1ae553da68c1a4ab492392a1a4d1b758acc2967", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/a1ae553da68c1a4ab492392a1a4d1b758acc2967", "committedDate": "2020-10-19T02:52:28Z", "message": "modify java doc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3847, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}