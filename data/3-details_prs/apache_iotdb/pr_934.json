{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMjc2NjE3", "number": 934, "title": "Delete dataTypeMapping etc fields in QueryPlan", "bodyText": "DataTypeMapping, deviceTomeasurementMap etc fields take lots of memory space while they can be replaced by other fields actually. Therefore, I delete these two fields here.\nTip: If some fields are no need to add, please use existing fields to replace them.", "createdAt": "2020-03-23T09:54:14Z", "url": "https://github.com/apache/iotdb/pull/934", "merged": true, "mergeCommit": {"oid": "94411e01a123cdc83cb0353c31ccd0fd008fdea7"}, "closed": true, "closedAt": "2020-03-24T12:00:53Z", "author": {"login": "Alima777"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFHxndAH2gAyMzkyMjc2NjE3OmM5Y2NlMmM5MzUyZjkwZGNhOTM0NmY2M2ZlMTczMGNlMzViYWUyNmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQvp1PABqjMxNTg4MzQyNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c9cce2c9352f90dca9346f63fe1730ce35bae26f", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/c9cce2c9352f90dca9346f63fe1730ce35bae26f", "committedDate": "2020-02-17T06:59:14Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27d100885dbcad4c0e11f4eca354c31e8bf5f1d5", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/27d100885dbcad4c0e11f4eca354c31e8bf5f1d5", "committedDate": "2020-03-03T04:15:08Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87dcd5ccfbdfb632295a8602df2a5d6d059f4f87", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/87dcd5ccfbdfb632295a8602df2a5d6d059f4f87", "committedDate": "2020-03-05T03:28:01Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c75572625cfb6d41e411b1701c672b2148e526d1", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/c75572625cfb6d41e411b1701c672b2148e526d1", "committedDate": "2020-03-05T08:50:10Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "951624b62ae7d9a447e942939247b860b0912e2c", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/951624b62ae7d9a447e942939247b860b0912e2c", "committedDate": "2020-03-10T06:28:23Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4ce841b0af3d5c7da5c5adf30e19cdf7fd4020c", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/e4ce841b0af3d5c7da5c5adf30e19cdf7fd4020c", "committedDate": "2020-03-10T10:14:56Z", "message": "Modify doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5966bff1c49845d34cacbc10cce63b0b6028b194", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/5966bff1c49845d34cacbc10cce63b0b6028b194", "committedDate": "2020-03-11T10:12:33Z", "message": "Fix conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e71fb8080350cbf0a88c86fee62013189a4e0c24", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/e71fb8080350cbf0a88c86fee62013189a4e0c24", "committedDate": "2020-03-23T06:51:06Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-iotdb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d226b9c1d4c63db737625b54933551bb8820e19d", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/d226b9c1d4c63db737625b54933551bb8820e19d", "committedDate": "2020-03-23T09:40:59Z", "message": "Changes to QueryPlan dataTypeMapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "875794363bc29fa27bdfeb110146fce3a88dd111", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/875794363bc29fa27bdfeb110146fce3a88dd111", "committedDate": "2020-03-23T09:57:11Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4d4ae474fd81fdcd00d87c54e04509e61aeb5ad", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/a4d4ae474fd81fdcd00d87c54e04509e61aeb5ad", "committedDate": "2020-03-23T13:59:47Z", "message": "Optimize some process"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDY3Mzgy", "url": "https://github.com/apache/iotdb/pull/934#pullrequestreview-380067382", "createdAt": "2020-03-24T07:55:50Z", "commit": {"oid": "0cf1cfb9efb26cb81288fde31dfc6cf07d5f72d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDc4NDI3", "url": "https://github.com/apache/iotdb/pull/934#pullrequestreview-380078427", "createdAt": "2020-03-24T08:14:50Z", "commit": {"oid": "0cf1cfb9efb26cb81288fde31dfc6cf07d5f72d1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODoxNDo1MVrOF6k_GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODoyMTozMlrOF6lM8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2NzcwNA==", "bodyText": "Actually I think it's better to use String here so that you won't use getFullPath() when call this method ... What do you think?", "url": "https://github.com/apache/iotdb/pull/934#discussion_r396967704", "createdAt": "2020-03-24T08:14:51Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -548,13 +548,13 @@ public TSDataType getSeriesType(String path) throws MetadataException {\n \n \n   /**\n-   * Get all devices under given prefixPath.\n+   * Get all device nodes under given prefixPath.\n    *\n    * @param prefixPath a prefix of a full path. if the wildcard is not at the tail, then each\n    * wildcard can only match one level, otherwise it can match to the tail.\n-   * @return A HashSet instance which stores devices names with given prefixPath.\n+   * @return A list which stores device nodes with given prefixPath.\n    */\n-  public Set<String> getDevices(String prefixPath) throws MetadataException {\n+  public List<MNode> getDevices(String prefixPath) throws MetadataException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cf1cfb9efb26cb81288fde31dfc6cf07d5f72d1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2OTI5MQ==", "bodyText": "Remove some useless imports", "url": "https://github.com/apache/iotdb/pull/934#discussion_r396969291", "createdAt": "2020-03-24T08:17:50Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java", "diffHunk": "@@ -21,12 +21,16 @@\n import java.io.IOException;\n import java.util.ArrayList;\n import java.util.HashMap;\n+import java.util.HashSet;\n import java.util.Iterator;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n import org.apache.iotdb.db.exception.StorageEngineException;\n+import org.apache.iotdb.db.exception.metadata.MetadataException;\n import org.apache.iotdb.db.exception.query.QueryProcessException;\n+import org.apache.iotdb.db.metadata.MManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cf1cfb9efb26cb81288fde31dfc6cf07d5f72d1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk3MTI1MA==", "bodyText": "try to extract the same process to avoid duplicated codes:\nString measurement = column;\n        if (dataSetType == DataSetType.GROUPBY || dataSetType == DataSetType.AGGREGATE) {\n          measurement = column.substring(column.indexOf('(') + 1, column.indexOf(')'));\n          if (measurementOfGivenDevice.contains(measurement)) {\n            executeAggregations.add(column.substring(0, column.indexOf('(')));\n          }\n        }\n        if (measurementOfGivenDevice.contains(measurement)) {\n          executeColumns.add(measurement);\n          executePaths.add(new Path(currentDevice.getFullPath(), measurement));\n          tsDataTypes.add(measurementDataTpeMap.get(measurement));\n        }\n\n(please first ensure codes above work : ) )", "url": "https://github.com/apache/iotdb/pull/934#discussion_r396971250", "createdAt": "2020-03-24T08:21:32Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java", "diffHunk": "@@ -116,25 +119,29 @@ protected boolean hasNextWithoutConstraint() throws IOException {\n \n     while (deviceIterator.hasNext()) {\n       currentDevice = deviceIterator.next();\n-      Set<String> measurementColumnsOfGivenDevice = deviceToMeasurementsMap\n-          .get(currentDevice);\n-      executeColumns = new ArrayList<>(measurementColumnsOfGivenDevice);\n-\n-      // extract paths and aggregations if exist from executeColumns\n+      // get all measurements of current device\n+      Set<String> measurementOfGivenDevice = currentDevice.getChildren().keySet();\n+      // extract paths and aggregations queried from all measurements\n+      // executeColumns is for calculating rowRecord\n+      executeColumns = new ArrayList<>();\n       List<Path> executePaths = new ArrayList<>();\n       List<TSDataType> tsDataTypes = new ArrayList<>();\n       List<String> executeAggregations = new ArrayList<>();\n-      for (String column : executeColumns) {\n+      for (String column : measurementDataTpeMap.keySet()) {\n         if (dataSetType == DataSetType.GROUPBY || dataSetType == DataSetType.AGGREGATE) {\n-          Path path = new Path(currentDevice,\n-              column.substring(column.indexOf('(') + 1, column.indexOf(')')));\n-          tsDataTypes.add(tsDataTypeMap.get(path));\n-          executePaths.add(path);\n-          executeAggregations.add(column.substring(0, column.indexOf('(')));\n+          String measurement = column.substring(column.indexOf('(') + 1, column.indexOf(')'));\n+          if (measurementOfGivenDevice.contains(measurement)){\n+            executeColumns.add(column);\n+            executePaths.add(new Path(currentDevice.getFullPath(), measurement));\n+            tsDataTypes.add(measurementDataTpeMap.get(column));\n+            executeAggregations.add(column.substring(0, column.indexOf('(')));\n+          }\n         } else {\n-          Path path = new Path(currentDevice, column);\n-          tsDataTypes.add(tsDataTypeMap.get(path));\n-          executePaths.add(path);\n+          if (measurementOfGivenDevice.contains(column)) {\n+            executeColumns.add(column);\n+            executePaths.add(new Path(currentDevice.getFullPath(), column));\n+            tsDataTypes.add(measurementDataTpeMap.get(column));\n+          }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cf1cfb9efb26cb81288fde31dfc6cf07d5f72d1"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTE5MDA5", "url": "https://github.com/apache/iotdb/pull/934#pullrequestreview-380119009", "createdAt": "2020-03-24T09:12:36Z", "commit": {"oid": "61574c5cafa177b6f04952e33631c4bc0eeb4490"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61574c5cafa177b6f04952e33631c4bc0eeb4490", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/61574c5cafa177b6f04952e33631c4bc0eeb4490", "committedDate": "2020-03-24T09:01:45Z", "message": "Remove unused code"}, "afterCommit": {"oid": "938e144af8c656466824e0e229a977c5f1ce0d82", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/938e144af8c656466824e0e229a977c5f1ce0d82", "committedDate": "2020-03-24T09:22:04Z", "message": "Change getDevices structure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e79efddedb8b889226c6abea79ebd9ad15ddce3", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/2e79efddedb8b889226c6abea79ebd9ad15ddce3", "committedDate": "2020-03-24T09:39:34Z", "message": "Remove unused code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "670ec987e72cc8f1741dcc703a2a148b2eb3f8d7", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/670ec987e72cc8f1741dcc703a2a148b2eb3f8d7", "committedDate": "2020-03-24T09:23:24Z", "message": "Fix typo"}, "afterCommit": {"oid": "2e79efddedb8b889226c6abea79ebd9ad15ddce3", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/2e79efddedb8b889226c6abea79ebd9ad15ddce3", "committedDate": "2020-03-24T09:39:34Z", "message": "Remove unused code"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3025, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}