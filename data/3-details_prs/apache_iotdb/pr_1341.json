{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMjY0Mzgz", "number": 1341, "title": "[ISSUE-1281] Show timeseries with heat sort", "bodyText": "The 'orderByHeatClause' is added to support this feature. The detailed syntax is:\norderByHeatClause\n: ORDER BY HEAT\n;\nIt's an optional clause, if user doesn't specify it. The action of 'show timeseries' will just be like before, the result set is sorted by the registered time of the time series.\nIf it is specified, firstly we will obtain all the satisfying timeseries as before, then we will sort them by the last point's timestamp. That means if the timeseries is inserted recently, it will be shown in the front.\nIn the implementation, as we have got the LeafMNode before, so we can use the cachedLastValuePair field in it to get last timestamp, if the cachedLastValuePair is null, we will construct a LastQueryPlan to get it.", "createdAt": "2020-06-10T07:39:13Z", "url": "https://github.com/apache/iotdb/pull/1341", "merged": true, "mergeCommit": {"oid": "785d119ed152717c97eca6c8fb41c55efc3e653d"}, "closed": true, "closedAt": "2020-06-16T13:30:02Z", "author": {"login": "JackieTien97"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpPLlCAH2gAyNDMyMjY0MzgzOjU0MmE1OWJmYjNiYjA5N2RhZTM0NzFkNDc2ZDY5NjI2YjQ0M2MyYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr1SPVgFqTQzMTUwMjY4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "542a59bfb3bb097dae3471d476d69626b443c2a4", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/542a59bfb3bb097dae3471d476d69626b443c2a4", "committedDate": "2020-06-08T11:58:12Z", "message": "init"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88e2118e4637dd36671a4acf6f447710ca8c3d26", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/88e2118e4637dd36671a4acf6f447710ca8c3d26", "committedDate": "2020-06-10T07:29:43Z", "message": "show timeseries with sort"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bea06346acfdd01c4ca36da2c5abb5be0bdbbdd", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/8bea06346acfdd01c4ca36da2c5abb5be0bdbbdd", "committedDate": "2020-06-10T07:34:26Z", "message": "resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16d6082583a1ca848f51f80f579a95676318c3d7", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/16d6082583a1ca848f51f80f579a95676318c3d7", "committedDate": "2020-06-10T07:35:29Z", "message": "resolve conflicts twice"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3ODQzMjAx", "url": "https://github.com/apache/iotdb/pull/1341#pullrequestreview-427843201", "createdAt": "2020-06-10T08:47:39Z", "commit": {"oid": "16d6082583a1ca848f51f80f579a95676318c3d7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwODo0Nzo0MFrOGhrKBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwODo1NDowMFrOGhrZmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk2MzI3MA==", "bodyText": "do we need to order by path?", "url": "https://github.com/apache/iotdb/pull/1341#discussion_r437963270", "createdAt": "2020-06-10T08:47:40Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -798,6 +800,18 @@ public int getNodesCountInGivenLevel(String prefixPath, int level) throws Metada\n           }\n         }\n       }\n+\n+      // if ordered by heat, we sort all the timeseries by the descending order of the last insert timestamp\n+      if (plan.isOrderByHeat()) {\n+        allMatchedNodes = allMatchedNodes.stream().sorted(\n+            Comparator.comparingLong(MTree::getLastTimeStamp).reversed()\n+                .thenComparing(MNode::getFullPath)).collect(toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d6082583a1ca848f51f80f579a95676318c3d7"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk2NzI1Ng==", "bodyText": "it's better to return List<MeasurementMNode> instead of List<String>, Zesong may be working on this.", "url": "https://github.com/apache/iotdb/pull/1341#discussion_r437967256", "createdAt": "2020-06-10T08:54:00Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -657,7 +713,8 @@ private int getCountInGivenLevel(MNode node, int targetLevel) {\n   /**\n    * Iterate through MTree to fetch metadata info of all leaf nodes under the given seriesPath\n    *\n-   * @param timeseriesSchemaList List<timeseriesSchema>\n+   * @param timeseriesSchemaList Collection<timeseriesSchema> result: [name, alias, storage group,\n+   *                          dataType, encoding, compression, offset, lastTimeStamp]\n    */\n   private void findPath(MNode node, String[] nodes, int idx, String parent,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d6082583a1ca848f51f80f579a95676318c3d7"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1cfa47e295d9326ccb6b3d35ed407867b2fac07", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/c1cfa47e295d9326ccb6b3d35ed407867b2fac07", "committedDate": "2020-06-10T09:09:47Z", "message": "chaneg comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3OTE3ODAx", "url": "https://github.com/apache/iotdb/pull/1341#pullrequestreview-427917801", "createdAt": "2020-06-10T10:22:37Z", "commit": {"oid": "c1cfa47e295d9326ccb6b3d35ed407867b2fac07"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMDoyMjozOFrOGhumAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMDozNjo1MVrOGhvCGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAxOTU4Nw==", "bodyText": "@qiaojialin Hi, in my opinion, order by path is better than disorder relatively.", "url": "https://github.com/apache/iotdb/pull/1341#discussion_r438019587", "createdAt": "2020-06-10T10:22:38Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MManager.java", "diffHunk": "@@ -798,6 +800,18 @@ public int getNodesCountInGivenLevel(String prefixPath, int level) throws Metada\n           }\n         }\n       }\n+\n+      // if ordered by heat, we sort all the timeseries by the descending order of the last insert timestamp\n+      if (plan.isOrderByHeat()) {\n+        allMatchedNodes = allMatchedNodes.stream().sorted(\n+            Comparator.comparingLong(MTree::getLastTimeStamp).reversed()\n+                .thenComparing(MNode::getFullPath)).collect(toList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk2MzI3MA=="}, "originalCommit": {"oid": "16d6082583a1ca848f51f80f579a95676318c3d7"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAyNjc3OA==", "bodyText": "Hi, you forgot the lastTimestamp column here~", "url": "https://github.com/apache/iotdb/pull/1341#discussion_r438026778", "createdAt": "2020-06-10T10:36:51Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -624,6 +631,34 @@ private int getCountInGivenLevel(MNode node, int targetLevel) {\n     return cnt;\n   }\n \n+  /**\n+   * Get all time series schema under the given path order by insert frequency\n+   *\n+   * <p>result: [name, alias, storage group, dataType, encoding, compression, offset]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1cfa47e295d9326ccb6b3d35ed407867b2fac07"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fb01459dc1cd923d53ec2504fdf222ab082f83f", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/9fb01459dc1cd923d53ec2504fdf222ab082f83f", "committedDate": "2020-06-12T07:41:32Z", "message": "change the syntax"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMTIyNDg5", "url": "https://github.com/apache/iotdb/pull/1341#pullrequestreview-430122489", "createdAt": "2020-06-13T08:00:57Z", "commit": {"oid": "9fb01459dc1cd923d53ec2504fdf222ab082f83f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1beb270a0fd8c8781fd15d22798d4f9045563bd", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/a1beb270a0fd8c8781fd15d22798d4f9045563bd", "committedDate": "2020-06-15T03:43:36Z", "message": "resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b3e8acbdbec414c5efe9188f094b60b5eb8a8ef", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/3b3e8acbdbec414c5efe9188f094b60b5eb8a8ef", "committedDate": "2020-06-15T09:58:57Z", "message": "add operation manual"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNTAyNjgw", "url": "https://github.com/apache/iotdb/pull/1341#pullrequestreview-431502680", "createdAt": "2020-06-16T13:29:43Z", "commit": {"oid": "3b3e8acbdbec414c5efe9188f094b60b5eb8a8ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3790, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}