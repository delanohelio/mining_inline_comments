{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MzY3NzEx", "number": 1480, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjozOTozMVrOEOPXPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzowMToyOFrOEOP2qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzY3MjMwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjozOTozMVrOGxR1mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjozOTozMVrOGxR1mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyNTY1OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  String vmVersionStr = f.getPath()\n          \n          \n            \n                  String vmLevel = f.getPath()", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454325658", "createdAt": "2020-07-14T12:39:31Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -574,16 +575,25 @@ else if (upgradeFolder.exists()) {\n       }\n     }\n \n-    Map<String, List<TsFileResource>> vmTsFileResourceMap = new HashMap<>();\n+    Map<String, List<List<TsFileResource>>> vmTsFileResourceMap = new HashMap<>();\n     for (File f : vmFiles) {\n       TsFileResource fileResource = new TsFileResource(f);\n       fileResource.setClosed(false);\n       String tsfilePrefix = f.getPath()\n-          .substring(0, f.getPath().lastIndexOf(FILE_NAME_SEPARATOR));\n-      vmTsFileResourceMap.computeIfAbsent(tsfilePrefix, k -> new ArrayList<>()).add(fileResource);\n+          .substring(0, f.getPath().lastIndexOf(TSFILE_SUFFIX)) + TSFILE_SUFFIX;\n+      String vmVersionStr = f.getPath()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f8527990dfa66926f8876ae94f45f36eaeeb65"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzczNzg5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1NzozMlrOGxSeAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1NzozMlrOGxSeAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNjAwMQ==", "bodyText": "I prefer to put the level ahead of system time...", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454336001", "createdAt": "2020-07-14T12:57:32Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -586,12 +603,23 @@ private void releaseFlushedMemTable(IMemTable memTable) {\n     }\n   }\n \n-  public static File createNewVMFile(TsFileResource tsFileResource) {\n-    File parent = tsFileResource.getTsFile().getParentFile();\n-    return FSFactoryProducer.getFSFactory().getFile(parent,\n-        tsFileResource.getTsFile().getName() + IoTDBConstant.FILE_NAME_SEPARATOR + System\n-            .currentTimeMillis()\n-            + VM_SUFFIX);\n+  public File createNewVMFile(TsFileResource tsFileResource, int level) {\n+    vmFileCreateLock.writeLock().lock();\n+    try {\n+      TimeUnit.MILLISECONDS.sleep(1);\n+      File parent = tsFileResource.getTsFile().getParentFile();\n+      File newVmFile = FSFactoryProducer.getFSFactory().getFile(parent,\n+          tsFileResource.getTsFile().getName() + IoTDBConstant.FILE_NAME_SEPARATOR + System\n+              .currentTimeMillis() + IoTDBConstant.FILE_NAME_SEPARATOR + level", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "originalPosition": 124}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzc0MTMxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1ODoyMlrOGxSgJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1ODoyMlrOGxSgJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNjU0OQ==", "bodyText": "change to debug level", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454336549", "createdAt": "2020-07-14T12:58:22Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -600,11 +628,13 @@ private void deleteVmFiles(List<TsFileResource> vmMergeTsFiles,\n         tsFileResource.getTsFile().getName());\n     for (int i = 0; i < vmMergeTsFiles.size(); i++) {\n       vmMergeWriters.get(i).close();\n-      logger.info(\"{} vm file open a writer\", vmMergeWriters.get(i).getFile().getName());\n+      logger.info(\"{} vm file close a writer\", vmMergeWriters.get(i).getFile().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzc0NjAyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1OTozN1rOGxSjFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1OTozN1rOGxSjFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNzMwMw==", "bodyText": "are they consistent and can be put together?", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454337303", "createdAt": "2020-07-14T12:59:37Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -683,10 +715,16 @@ public void flushOneMemTable() {\n         RestorableTsFileIOWriter curWriter;\n         if (config.isEnableVm()) {\n           logger.info(\"[Flush] flush a vm\");\n-          File newVmFile = createNewVMFile(tsFileResource);\n-          vmTsFileResources.add(new TsFileResource(newVmFile));\n+          File newVmFile = createNewVMFile(tsFileResource, 0);\n+          if (vmWriters.size() <= 0) {\n+            vmWriters.add(new ArrayList<>());\n+          }\n+          if (vmTsFileResources.size() <= 0) {\n+            vmTsFileResources.add(new ArrayList<>());\n+          }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "originalPosition": 186}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzc1Mjc1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzowMToyOFrOGxSnbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzowMToyOFrOGxSnbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzODQxNQ==", "bodyText": "add javadoc, or rename this to copiedVmTsFileResources", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454338415", "createdAt": "2020-07-14T13:01:28Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -802,9 +840,17 @@ public void flushOneMemTable() {\n         mergeWorking = true;\n         logger.info(\"{}: {} submit a vm merge task\", storageGroupName,\n             tsFileResource.getTsFile().getName());\n+        List<List<TsFileResource>> currVmTsFileResources = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "originalPosition": 198}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4715, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}