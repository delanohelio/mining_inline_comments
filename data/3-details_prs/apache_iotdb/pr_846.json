{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMjQ2NjEy", "number": 846, "title": "[IOTDB-512] file reader close bug", "bodyText": "", "createdAt": "2020-02-26T13:12:48Z", "url": "https://github.com/apache/iotdb/pull/846", "merged": true, "mergeCommit": {"oid": "53376960c0fe00fb3d71bf29a3a3b80252879d5e"}, "closed": true, "closedAt": "2020-02-27T11:13:23Z", "author": {"login": "JackieTien97"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHc833gH2gAyMzgwMjQ2NjEyOjdiODc0ZDlmMWU3NTJkZThiYjNhZTAxNGQ4NWEwNjJkZmNjMDg2MDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIU653gFqTM2NTQzMDgzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7b874d9f1e752de8bb3ae014d85a062dfcc08608", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/7b874d9f1e752de8bb3ae014d85a062dfcc08608", "committedDate": "2020-02-24T12:47:23Z", "message": "add more logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffc64df3a220a9291fe83c8f833390efa05ca629", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/ffc64df3a220a9291fe83c8f833390efa05ca629", "committedDate": "2020-02-24T14:59:34Z", "message": "add close reason log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b40f446acc7e667957d553b6da74af1d1647a663", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/b40f446acc7e667957d553b6da74af1d1647a663", "committedDate": "2020-02-25T01:56:51Z", "message": "PrintAllStackInfo while calling close()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd7944d1b6f0320c3232352309319e43a23ef252", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/bd7944d1b6f0320c3232352309319e43a23ef252", "committedDate": "2020-02-25T07:53:53Z", "message": "change some remove"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "318763575d9da8066f9ddd13c7dba3a850d3b85f", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/318763575d9da8066f9ddd13c7dba3a850d3b85f", "committedDate": "2020-02-25T11:52:03Z", "message": "more logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c5f8a263fdc59d270523f795f7eb7d8f6560c94", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/7c5f8a263fdc59d270523f795f7eb7d8f6560c94", "committedDate": "2020-02-25T12:28:52Z", "message": "delete useless logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8413a613ff20dbfd37ea88f5297b9ee1eae0d5fe", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/8413a613ff20dbfd37ea88f5297b9ee1eae0d5fe", "committedDate": "2020-02-25T12:34:18Z", "message": "add reopen operation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ba9fe508b6a2984f296328894856e8a7abfaace", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/5ba9fe508b6a2984f296328894856e8a7abfaace", "committedDate": "2020-02-25T13:24:11Z", "message": "s"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1b41e8b870203e0982d8b0d42c2f8a9550967e4", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/e1b41e8b870203e0982d8b0d42c2f8a9550967e4", "committedDate": "2020-02-26T07:40:05Z", "message": "prove"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8edcfd94cbdd56f28314e5c837989d3b627dce36", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/8edcfd94cbdd56f28314e5c837989d3b627dce36", "committedDate": "2020-02-26T08:50:06Z", "message": "add count print"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "962ebe9b37df8b2ec4113c94b3d8e92fae6f8165", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/962ebe9b37df8b2ec4113c94b3d8e92fae6f8165", "committedDate": "2020-02-26T13:08:26Z", "message": "final bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fe2210a9c1a025d40f064220b8aa288749cf392", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/0fe2210a9c1a025d40f064220b8aa288749cf392", "committedDate": "2020-02-26T13:14:43Z", "message": "delete some useless change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "550a0ef577cc609ef36373a89cd36ec76efc8e1e", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/550a0ef577cc609ef36373a89cd36ec76efc8e1e", "committedDate": "2020-02-26T13:29:24Z", "message": "try finally"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a13aa85df18c265019a874523abc6b669ff11613", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/a13aa85df18c265019a874523abc6b669ff11613", "committedDate": "2020-02-26T13:32:22Z", "message": "add catch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d06cd002698b9c30f3988a12fc1639ea14e4b277", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/d06cd002698b9c30f3988a12fc1639ea14e4b277", "committedDate": "2020-02-27T01:02:44Z", "message": "Merge remote-tracking branch 'origin/master' into FileClosedDebug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MzU4NzU1", "url": "https://github.com/apache/iotdb/pull/846#pullrequestreview-365358755", "createdAt": "2020-02-27T01:22:28Z", "commit": {"oid": "d06cd002698b9c30f3988a12fc1639ea14e4b277"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMToyMjoyOFrOFvCP0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMToyNzozOVrOFvCVFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NDIwOQ==", "bodyText": "change to debug", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384864209", "createdAt": "2020-02-27T01:22:28Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/FileReaderManager.java", "diffHunk": "@@ -199,6 +202,26 @@ void decreaseFileReaderReference(TsFileResource tsFile, boolean isClosed) {\n    * integration tests will not conflict with each other.\n    */\n   public synchronized void closeAndRemoveAllOpenedReaders() throws IOException {\n+    Iterator<Map.Entry<TsFileResource, TsFileSequenceReader>> iterator = closedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d06cd002698b9c30f3988a12fc1639ea14e4b277"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NDUwMQ==", "bodyText": "duplicated?", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384864501", "createdAt": "2020-02-27T01:23:38Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/FileReaderManager.java", "diffHunk": "@@ -199,6 +202,26 @@ void decreaseFileReaderReference(TsFileResource tsFile, boolean isClosed) {\n    * integration tests will not conflict with each other.\n    */\n   public synchronized void closeAndRemoveAllOpenedReaders() throws IOException {\n+    Iterator<Map.Entry<TsFileResource, TsFileSequenceReader>> iterator = closedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} closedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      closedReferenceMap.remove(entry.getKey());\n+      iterator.remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d06cd002698b9c30f3988a12fc1639ea14e4b277"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NDkwOA==", "bodyText": "duplicated", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384864908", "createdAt": "2020-02-27T01:25:21Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/FileReaderManager.java", "diffHunk": "@@ -199,6 +202,26 @@ void decreaseFileReaderReference(TsFileResource tsFile, boolean isClosed) {\n    * integration tests will not conflict with each other.\n    */\n   public synchronized void closeAndRemoveAllOpenedReaders() throws IOException {\n+    Iterator<Map.Entry<TsFileResource, TsFileSequenceReader>> iterator = closedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} closedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      closedReferenceMap.remove(entry.getKey());\n+      iterator.remove();\n+    }\n+    iterator = unclosedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} unclosedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      unclosedReferenceMap.remove(entry.getKey());\n+      iterator.remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d06cd002698b9c30f3988a12fc1639ea14e4b277"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NTExMQ==", "bodyText": "this should be removed..", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384865111", "createdAt": "2020-02-27T01:26:07Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/FileReaderManager.java", "diffHunk": "@@ -199,6 +202,26 @@ void decreaseFileReaderReference(TsFileResource tsFile, boolean isClosed) {\n    * integration tests will not conflict with each other.\n    */\n   public synchronized void closeAndRemoveAllOpenedReaders() throws IOException {\n+    Iterator<Map.Entry<TsFileResource, TsFileSequenceReader>> iterator = closedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} closedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      closedReferenceMap.remove(entry.getKey());\n+      iterator.remove();\n+    }\n+    iterator = unclosedFileReaderMap.entrySet().iterator();\n+    while (iterator.hasNext()) {\n+      Map.Entry<TsFileResource, TsFileSequenceReader> entry = iterator.next();\n+      entry.getValue().close();\n+      if (resourceLogger.isInfoEnabled()) {\n+        resourceLogger.info(\"{} unclosedTsFileReader is closed.\", entry.getValue().getFileName());\n+      }\n+      unclosedReferenceMap.remove(entry.getKey());\n+      iterator.remove();\n+    }\n     for (Map.Entry<TsFileResource, TsFileSequenceReader> entry : closedFileReaderMap.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d06cd002698b9c30f3988a12fc1639ea14e4b277"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg2NTU1Nw==", "bodyText": "what If does not contain the tsfileResource, is it a bug?", "url": "https://github.com/apache/iotdb/pull/846#discussion_r384865557", "createdAt": "2020-02-27T01:27:39Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryFileManager.java", "diffHunk": "@@ -77,8 +74,9 @@ private void addUsedFilesForQuery(long queryId, List<TsFileResource> resources)\n       // this file may be deleted just before we lock it\r\n       if (tsFileResource.isDeleted()) {\r\n         Map<Long, Set<TsFileResource>> pathMap = !isClosed ? unsealedFilePathsMap : sealedFilePathsMap;\r\n-        pathMap.get(queryId).remove(tsFileResource);\r\n-        FileReaderManager.getInstance().decreaseFileReaderReference(tsFileResource, isClosed);\r\n+        if (pathMap.get(queryId).remove(tsFileResource)) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d06cd002698b9c30f3988a12fc1639ea14e4b277"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bbf15d757412417e8b60b0cca7ae8535fb65b33", "author": {"user": {"login": "JackieTien97", "name": "Jackie Tien"}}, "url": "https://github.com/apache/iotdb/commit/5bbf15d757412417e8b60b0cca7ae8535fb65b33", "committedDate": "2020-02-27T02:42:48Z", "message": "change for qiao"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NDMwODM4", "url": "https://github.com/apache/iotdb/pull/846#pullrequestreview-365430838", "createdAt": "2020-02-27T05:59:55Z", "commit": {"oid": "5bbf15d757412417e8b60b0cca7ae8535fb65b33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3119, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}