{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMTYzNTY2", "number": 1698, "title": "[IOTDB-850] check list user/role privilege ", "bodyText": "user can only LIST USER or LIST ROLE if he is granted list_user / list_role privilege, check if he is granted in plan executor", "createdAt": "2020-09-07T08:03:22Z", "url": "https://github.com/apache/iotdb/pull/1698", "merged": true, "mergeCommit": {"oid": "da54ec5bdeafcf54ff797ec89098f3e470db48a1"}, "closed": true, "closedAt": "2020-09-16T03:50:46Z", "author": {"login": "haimeiguo"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGeIm0AH2gAyNDgxMTYzNTY2OmY5ZDA2M2I3YTYzODQ4YWMyNmM1NjViNzllYTUyNmUyZTcwOGNjNjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJUFlIgFqTQ4OTI1MjAzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f9d063b7a63848ac26c565b79ea526e2e708cc69", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/f9d063b7a63848ac26c565b79ea526e2e708cc69", "committedDate": "2020-09-07T07:47:20Z", "message": "commit code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc4cf8fa0c1940535873d909facc2d7544f3eba4", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/cc4cf8fa0c1940535873d909facc2d7544f3eba4", "committedDate": "2020-09-07T07:49:04Z", "message": "edit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c80d274f487d3edcc06a3ac45aa72391279575d8", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/c80d274f487d3edcc06a3ac45aa72391279575d8", "committedDate": "2020-09-07T07:55:42Z", "message": "commit code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6f48efb43b96e8ccef505f3cce3cae3e5c18b88", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/e6f48efb43b96e8ccef505f3cce3cae3e5c18b88", "committedDate": "2020-09-07T07:57:10Z", "message": "edit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d5c4a4d0ce7a5be921b9bd5d5b567ded6fcc70c", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/3d5c4a4d0ce7a5be921b9bd5d5b567ded6fcc70c", "committedDate": "2020-09-07T08:04:23Z", "message": "Merge branch 'master' into master_list_user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aade19f9c195c06499dee8d981e05d5977b4d515", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/aade19f9c195c06499dee8d981e05d5977b4d515", "committedDate": "2020-09-07T08:33:34Z", "message": "commit code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a3ffd5c08bb85aa856a715c1c180eb06c89e0e1", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/4a3ffd5c08bb85aa856a715c1c180eb06c89e0e1", "committedDate": "2020-09-07T08:33:34Z", "message": "edit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f6472fee21b50a670d6dcd4b117106ff8c73bc5", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/5f6472fee21b50a670d6dcd4b117106ff8c73bc5", "committedDate": "2020-09-07T08:33:34Z", "message": "edit username"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b093fbe89c2309caeeca0221cf9cefcd7531e42d", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/b093fbe89c2309caeeca0221cf9cefcd7531e42d", "committedDate": "2020-09-07T08:38:31Z", "message": "Merge branch 'master_list_user' of github.com:kelggu/incubator-iotdb into master_list_user"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjE4MDEz", "url": "https://github.com/apache/iotdb/pull/1698#pullrequestreview-484618013", "createdAt": "2020-09-09T02:24:48Z", "commit": {"oid": "b093fbe89c2309caeeca0221cf9cefcd7531e42d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMjoyNDo0OVrOHO0Uhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMjoyNDo0OVrOHO0Uhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI5OTMzNQ==", "bodyText": "Does every physical plan have to have a userName?\nfor OOP, I do not think its a good design.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r485299335", "createdAt": "2020-09-09T02:24:49Z", "author": {"login": "neuyilan"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java", "diffHunk": "@@ -48,6 +48,7 @@\n \n   private static final String SERIALIZATION_UNIMPLEMENTED = \"serialization unimplemented\";\n \n+  protected String userName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b093fbe89c2309caeeca0221cf9cefcd7531e42d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0839efb75458ec6ed8daa2648526009ddb268c9d", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/0839efb75458ec6ed8daa2648526009ddb268c9d", "committedDate": "2020-09-10T02:10:36Z", "message": "edited username to author plan only; add list role privilege check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjY1NjE4", "url": "https://github.com/apache/iotdb/pull/1698#pullrequestreview-485665618", "createdAt": "2020-09-10T07:46:12Z", "commit": {"oid": "0839efb75458ec6ed8daa2648526009ddb268c9d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo0NjoxMlrOHPnPxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo0NjozOFrOHPnQwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzcwMA==", "bodyText": "delete the blank space.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486133700", "createdAt": "2020-09-10T07:46:12Z", "author": {"login": "mychaow"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1059,7 +1060,7 @@ protected boolean deleteStorageGroups(DeleteStorageGroupPlan deleteStorageGroupP\n     }\n     return true;\n   }\n-\n+  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0839efb75458ec6ed8daa2648526009ddb268c9d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzk1Mw==", "bodyText": "delete the blank space.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486133953", "createdAt": "2020-09-10T07:46:38Z", "author": {"login": "mychaow"}, "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBAuthorizationIT.java", "diffHunk": "@@ -793,15 +793,19 @@ public void testListRolePrivileges() throws ClassNotFoundException, SQLException\n \n     try {\n       adminStmt.execute(\"CREATE ROLE role1\");\n-      adminStmt.execute(\n+      ResultSet resultSet = adminStmt.executeQuery(\"LIST ROLE PRIVILEGES role1\");\n+      String ans = \"\";\n+      try {\n+        //not granted list role privilege, should return empty\n+        validateResultSet(resultSet, ans);\n+\n+        adminStmt.execute(\n           \"GRANT ROLE role1 PRIVILEGES 'READ_TIMESERIES','INSERT_TIMESERIES','DELETE_TIMESERIES' ON root.a.b.c\");\n-      adminStmt.execute(\n+        adminStmt.execute(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0839efb75458ec6ed8daa2648526009ddb268c9d"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1590c1f4f5ff48694a291978cfd07e07ada46d3a", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/1590c1f4f5ff48694a291978cfd07e07ada46d3a", "committedDate": "2020-09-10T09:33:31Z", "message": "add loginUserName"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3", "committedDate": "2020-09-10T10:01:21Z", "message": "delete space"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NDEwMTc0", "url": "https://github.com/apache/iotdb/pull/1698#pullrequestreview-486410174", "createdAt": "2020-09-11T01:15:05Z", "commit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxNTowNVrOHQK2mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxODo0M1rOHQK6Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzA4MA==", "bodyText": "What is this index for?", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717080", "createdAt": "2020-09-11T01:15:05Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1116,14 +1125,26 @@ private ListDataSet executeListRole() {\n     return dataSet;\n   }\n \n-  private ListDataSet executeListUser() {\n-    List<String> userList = authorizer.listAllUsers();\n+  private ListDataSet executeListUser(AuthorPlan plan) throws AuthException {\n+    List<PartialPath> paths = new ArrayList<>();\n+    paths.add(plan.getNodeName());\n+    // check if current user is granted list_user privilege\n+    boolean hasListUserPrivilege = AuthorityChecker\n+        .check(plan.getLoginUserName(), paths, plan.getOperatorType(), plan.getLoginUserName());\n+\n     List<PartialPath> headerList = new ArrayList<>();\n     List<TSDataType> typeList = new ArrayList<>();\n     headerList.add(new PartialPath(COLUMN_USER, false));\n     typeList.add(TSDataType.TEXT);\n-    int index = 0;\n     ListDataSet dataSet = new ListDataSet(headerList, typeList);\n+\n+    if (!hasListUserPrivilege) {\n+      return dataSet;\n+    }\n+\n+    List<String> userList = authorizer.listAllUsers();\n+    int index = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzM4MQ==", "bodyText": "Better replaced with Collections.singletonList()", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717381", "createdAt": "2020-09-11T01:16:08Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1116,14 +1125,26 @@ private ListDataSet executeListRole() {\n     return dataSet;\n   }\n \n-  private ListDataSet executeListUser() {\n-    List<String> userList = authorizer.listAllUsers();\n+  private ListDataSet executeListUser(AuthorPlan plan) throws AuthException {\n+    List<PartialPath> paths = new ArrayList<>();\n+    paths.add(plan.getNodeName());\n+    // check if current user is granted list_user privilege", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzQ5Nw==", "bodyText": "Better replaced with Collections.emptyList().", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717497", "createdAt": "2020-09-11T01:16:36Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1098,13 +1099,21 @@ protected QueryDataSet processAuthorQuery(AuthorPlan plan)\n     return dataSet;\n   }\n \n-  private ListDataSet executeListRole() {\n+  private ListDataSet executeListRole(AuthorPlan plan) throws AuthException {\n     int index = 0;\n     List<PartialPath> headerList = new ArrayList<>();\n     List<TSDataType> typeList = new ArrayList<>();\n     headerList.add(new PartialPath(COLUMN_ROLE, false));\n     typeList.add(TSDataType.TEXT);\n     ListDataSet dataSet = new ListDataSet(headerList, typeList);\n+\n+    boolean hasListRolePrivilege = AuthorityChecker\n+        .check(plan.getLoginUserName(), new ArrayList<>(), plan.getOperatorType(), plan.getLoginUserName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxODA0Nw==", "bodyText": "I think maybe we can push loginUserName down to PhysicalPlan. It is often meaningful to know who issued this plan.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486718047", "createdAt": "2020-09-11T01:18:43Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/sys/AuthorPlan.java", "diffHunk": "@@ -39,12 +39,13 @@\n public class AuthorPlan extends PhysicalPlan {\n \n   private AuthorOperator.AuthorType authorType;\n-  private String userName;\n   private String roleName;\n   private String password;\n   private String newPassword;\n   private Set<Integer> permissions;\n   private PartialPath nodeName;\n+  private String userName;\n+  private String loginUserName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bb8f5dfb07254b213cf3adf937a1a5cc496cb37", "author": {"user": {"login": "haimeiguo", "name": "Haimei Guo"}}, "url": "https://github.com/apache/iotdb/commit/5bb8f5dfb07254b213cf3adf937a1a5cc496cb37", "committedDate": "2020-09-11T04:05:04Z", "message": "moved loginUserName to physical plan"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MjUxMzE2", "url": "https://github.com/apache/iotdb/pull/1698#pullrequestreview-489251316", "createdAt": "2020-09-16T03:44:02Z", "commit": {"oid": "5bb8f5dfb07254b213cf3adf937a1a5cc496cb37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MjUyMDMy", "url": "https://github.com/apache/iotdb/pull/1698#pullrequestreview-489252032", "createdAt": "2020-09-16T03:46:45Z", "commit": {"oid": "5bb8f5dfb07254b213cf3adf937a1a5cc496cb37"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3946, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}