{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMzQ1MDAy", "number": 2063, "title": "Refactor LastQueryExecutor to separate the execution into multiple stages", "bodyText": "A merge lock has already been added locking the whole Last query procedure, however, this procedure may take a long time.\nThis PR refactor the Last query execution process, separating it into multiple stages:\n\nGet Last result by accessing cache.\nHold merge lock and obtain query resource.\nScan TsFiles to get Last value.\n\nNow only the stage 2 will be locked.", "createdAt": "2020-11-17T11:40:34Z", "url": "https://github.com/apache/iotdb/pull/2063", "merged": true, "mergeCommit": {"oid": "6aad5c7152736cbf2f63a5f5791ad3310bcb77ca"}, "closed": true, "closedAt": "2020-11-18T10:38:51Z", "author": {"login": "wshao08"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddXzDQgH2gAyNTIyMzQ1MDAyOjM5NjkxMzIzYTViM2FiYjZlNWUxNDRiMTc2YWNkZDEzMmY3YzZiNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddrvQ_gFqTUzMjkzMTI0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "39691323a5b3abb6e5e144b176acdd132f7c6b6b", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/39691323a5b3abb6e5e144b176acdd132f7c6b6b", "committedDate": "2020-11-17T11:24:37Z", "message": "Refactor LastQueryExecutor to separate the execution into multiple stages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "370a06b56e648a8c6e3fdfe260c03590e9330b34", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/370a06b56e648a8c6e3fdfe260c03590e9330b34", "committedDate": "2020-11-17T13:13:04Z", "message": "Fix codesmell"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMzYyNDY4", "url": "https://github.com/apache/iotdb/pull/2063#pullrequestreview-532362468", "createdAt": "2020-11-17T13:33:12Z", "commit": {"oid": "370a06b56e648a8c6e3fdfe260c03590e9330b34"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMzozMzoxMlrOH006hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMzozMzoxMlrOH006hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTE1NDk0OA==", "bodyText": "this may be used in cluster @jt2594838", "url": "https://github.com/apache/iotdb/pull/2063#discussion_r525154948", "createdAt": "2020-11-17T13:33:12Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/executor/QueryRouter.java", "diffHunk": "@@ -225,12 +225,8 @@ public QueryDataSet groupByFill(GroupByTimeFillPlan groupByFillPlan, QueryContex\n   @Override\n   public QueryDataSet lastQuery(LastQueryPlan lastQueryPlan, QueryContext context)\n       throws StorageEngineException, QueryProcessException, IOException {\n-    LastQueryExecutor lastQueryExecutor = getLastQueryExecutor(lastQueryPlan);\n+    LastQueryExecutor lastQueryExecutor = new LastQueryExecutor(lastQueryPlan);\n     return lastQueryExecutor.execute(context, lastQueryPlan);\n   }\n \n-  protected LastQueryExecutor getLastQueryExecutor(LastQueryPlan lastQueryPlan) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "370a06b56e648a8c6e3fdfe260c03590e9330b34"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26508e9b7a158c4efb831eb225706414fa610daa", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/26508e9b7a158c4efb831eb225706414fa610daa", "committedDate": "2020-11-18T02:12:35Z", "message": "Fix some issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b2e4ab02af84347de663486912bc55de8473ed6", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/9b2e4ab02af84347de663486912bc55de8473ed6", "committedDate": "2020-11-18T04:52:54Z", "message": "Fix review issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12f569db2b633dca611e4af22b99dc54e6ba3d7e", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/12f569db2b633dca611e4af22b99dc54e6ba3d7e", "committedDate": "2020-11-18T06:27:55Z", "message": "Fix error in MTree"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e646559330b3e4cecce2addeef0d937c3fa7bdf9", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/e646559330b3e4cecce2addeef0d937c3fa7bdf9", "committedDate": "2020-11-18T06:42:01Z", "message": "Fix test case error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9fc75000629277b242e8fc1a44dabfa73b3f6ca", "author": {"user": {"login": "wshao08", "name": null}}, "url": "https://github.com/apache/iotdb/commit/b9fc75000629277b242e8fc1a44dabfa73b3f6ca", "committedDate": "2020-11-18T07:13:11Z", "message": "codesmell fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTMxMjQy", "url": "https://github.com/apache/iotdb/pull/2063#pullrequestreview-532931242", "createdAt": "2020-11-18T00:51:07Z", "commit": {"oid": "370a06b56e648a8c6e3fdfe260c03590e9330b34"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDo1MTowN1rOH1RerQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMDo1MTowN1rOH1RerQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYyMjk1Nw==", "bodyText": "it should be a Collections.single() instead of an emptySet()", "url": "https://github.com/apache/iotdb/pull/2063#discussion_r525622957", "createdAt": "2020-11-18T00:51:07Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -107,8 +109,12 @@ static long getLastTimeStamp(MeasurementMNode node, QueryContext queryContext) {\n       return node.getCachedLast().getTimestamp();\n     } else {\n       try {\n-        last = calculateLastPairForOneSeriesLocally(node.getPartialPath(),\n-            node.getSchema().getType(), queryContext, null, Collections.emptySet());\n+        QueryDataSource dataSource = QueryResourceManager.getInstance().\n+                getQueryDataSource(node.getPartialPath(), queryContext, null);\n+        LastPointReader lastReader = new LastPointReader(node.getPartialPath(),\n+                node.getSchema().getType(), Collections.emptySet(), queryContext,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "370a06b56e648a8c6e3fdfe260c03590e9330b34"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4141, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}