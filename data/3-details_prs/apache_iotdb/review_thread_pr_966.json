{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MjkyMDgw", "number": 966, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzowMDoxM1rODtM79Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzoxOToyMVrODtNZAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NzI0NDY5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzowMDoxM1rOF-faiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMzozMjo1NFrOF-vpfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDcyOA==", "bodyText": "If we sync a tsfile from other iotdb, will this tsfile has time partition directory? Maybe we should use startTimeMap to get time partition", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401070728", "createdAt": "2020-03-31T17:00:13Z", "author": {"login": "SilverNarcissus"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -471,4 +473,12 @@ public void setProcessor(TsFileProcessor processor) {\n   public TimeseriesMetadata getTimeSeriesMetadata() {\n     return timeSeriesMetadata;\n   }\n+\n+  public long getTimePartition() {\n+    if (startTimeMap != null && !startTimeMap.isEmpty()) {\n+      return StorageEngine.getTimePartition(startTimeMap.values().iterator().next());\n+    }\n+    String[] splits = FilePathUtils.splitTsFilePath(this);\n+    return Long.parseLong(splits[splits.length - 2]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI5ODMyMA==", "bodyText": "Thanks, I use the startTimeMap first, then the path", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401298320", "createdAt": "2020-04-01T00:58:37Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -471,4 +473,12 @@ public void setProcessor(TsFileProcessor processor) {\n   public TimeseriesMetadata getTimeSeriesMetadata() {\n     return timeSeriesMetadata;\n   }\n+\n+  public long getTimePartition() {\n+    if (startTimeMap != null && !startTimeMap.isEmpty()) {\n+      return StorageEngine.getTimePartition(startTimeMap.values().iterator().next());\n+    }\n+    String[] splits = FilePathUtils.splitTsFilePath(this);\n+    return Long.parseLong(splits[splits.length - 2]);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDcyOA=="}, "originalCommit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzMDA5OQ==", "bodyText": "It is not guaranteed that the other IoTDB will use the same partition interval, so it is better to check the whole startTimeMap and endTimeMap to see if any device has crossed a partition and report an exception if so.", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401330099", "createdAt": "2020-04-01T03:05:17Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -471,4 +473,12 @@ public void setProcessor(TsFileProcessor processor) {\n   public TimeseriesMetadata getTimeSeriesMetadata() {\n     return timeSeriesMetadata;\n   }\n+\n+  public long getTimePartition() {\n+    if (startTimeMap != null && !startTimeMap.isEmpty()) {\n+      return StorageEngine.getTimePartition(startTimeMap.values().iterator().next());\n+    }\n+    String[] splits = FilePathUtils.splitTsFilePath(this);\n+    return Long.parseLong(splits[splits.length - 2]);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDcyOA=="}, "originalCommit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMzNjcwMg==", "bodyText": "restart and load could use different getPartition method, one check partition and the other not. I will add a method with partition check", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401336702", "createdAt": "2020-04-01T03:32:54Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -471,4 +473,12 @@ public void setProcessor(TsFileProcessor processor) {\n   public TimeseriesMetadata getTimeSeriesMetadata() {\n     return timeSeriesMetadata;\n   }\n+\n+  public long getTimePartition() {\n+    if (startTimeMap != null && !startTimeMap.isEmpty()) {\n+      return StorageEngine.getTimePartition(startTimeMap.values().iterator().next());\n+    }\n+    String[] splits = FilePathUtils.splitTsFilePath(this);\n+    return Long.parseLong(splits[splits.length - 2]);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDcyOA=="}, "originalCommit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4NzMxOTA2OnYy", "diffSide": "RIGHT", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/writer/TsFileIOWriter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzoxOToyMVrOF-gJag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMToyNjo1NlrOF-tvwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4MjczMA==", "bodyText": "Since Pair<String, List<ChunkMetadata> > is similar to previous ChunkGroupMetadata, I'm thinking if it's necessary to add ChunkGroupMetadata back instead of using the pair.", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401082730", "createdAt": "2020-03-31T17:19:21Z", "author": {"login": "HTHou"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/writer/TsFileIOWriter.java", "diffHunk": "@@ -65,14 +66,19 @@\n   }\n \n   protected TsFileOutput out;\n-  protected List<Pair<String, List<ChunkMetadata>>> chunkGroupInfoList = new ArrayList<>();\n   protected boolean canWrite = true;\n   protected int totalChunkNum = 0;\n   protected int invalidChunkNum;\n   protected File file;\n-  protected List<ChunkMetadata> chunkMetadataList = new ArrayList<>();\n-  protected Map<Path, List<ChunkMetadata>> chunkMetadataListMap = new TreeMap<>();\n+\n+\n+  // current flushed Chunk\n   private ChunkMetadata currentChunkMetadata;\n+  // current flushed ChunkGroup\n+  protected List<ChunkMetadata> chunkMetadataList = new ArrayList<>();\n+  // all flushed ChunkGroup,  device -> List<ChunkMetadata>\n+  protected List<Pair<String, List<ChunkMetadata>>> chunkGroupMetadataList = new ArrayList<>();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMwNTUzOA==", "bodyText": "Good idea, I have added it", "url": "https://github.com/apache/iotdb/pull/966#discussion_r401305538", "createdAt": "2020-04-01T01:26:56Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/write/writer/TsFileIOWriter.java", "diffHunk": "@@ -65,14 +66,19 @@\n   }\n \n   protected TsFileOutput out;\n-  protected List<Pair<String, List<ChunkMetadata>>> chunkGroupInfoList = new ArrayList<>();\n   protected boolean canWrite = true;\n   protected int totalChunkNum = 0;\n   protected int invalidChunkNum;\n   protected File file;\n-  protected List<ChunkMetadata> chunkMetadataList = new ArrayList<>();\n-  protected Map<Path, List<ChunkMetadata>> chunkMetadataListMap = new TreeMap<>();\n+\n+\n+  // current flushed Chunk\n   private ChunkMetadata currentChunkMetadata;\n+  // current flushed ChunkGroup\n+  protected List<ChunkMetadata> chunkMetadataList = new ArrayList<>();\n+  // all flushed ChunkGroup,  device -> List<ChunkMetadata>\n+  protected List<Pair<String, List<ChunkMetadata>>> chunkGroupMetadataList = new ArrayList<>();\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA4MjczMA=="}, "originalCommit": {"oid": "35c675127dabc5d2766ff8f2a255472b5a5160e2"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 172, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}