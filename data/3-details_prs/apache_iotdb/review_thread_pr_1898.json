{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExOTcwNDA0", "number": 1898, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNzozMzoyOVrOEzLHcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNzozNjo0MVrOEzLLHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMDk0OTYwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/executor/LastQueryExecutor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNzozMzoyOVrOHqPWjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNToyMjo1NVrOHqhJ4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1Mzc3NA==", "bodyText": "if the filter is null, shoudn't we return true?", "url": "https://github.com/apache/iotdb/pull/1898#discussion_r514053774", "createdAt": "2020-10-29T07:33:29Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/executor/LastQueryExecutor.java", "diffHunk": "@@ -127,103 +127,64 @@ protected TimeValuePair calculateLastPairForOneSeries(\n    * @param context query context\n    * @return TimeValuePair\n    */\n-  @SuppressWarnings(\"squid:S3776\") // Suppress high Cognitive Complexity warning\n   public static TimeValuePair calculateLastPairForOneSeriesLocally(\n-      PartialPath seriesPath, TSDataType tsDataType, QueryContext context, Set<String> deviceMeasurements)\n+      PartialPath seriesPath, TSDataType tsDataType, QueryContext context,\n+      IExpression expression, Set<String> deviceMeasurements)\n       throws IOException, QueryProcessException, StorageEngineException {\n \n     // Retrieve last value from MNode\n     MeasurementMNode node = null;\n+    Filter filter = null;\n     if (lastCacheEnabled) {\n+      if (expression != null) {\n+        filter = ((GlobalTimeExpression) expression).getFilter();\n+      }\n       try {\n         node = (MeasurementMNode) IoTDB.metaManager.getNodeByPath(seriesPath);\n       } catch (MetadataException e) {\n         TimeValuePair timeValuePair = IoTDB.metaManager.getLastCache(seriesPath);\n-        if (timeValuePair != null) {\n+        if (timeValuePair != null && satisfyFilter(filter, timeValuePair)) {\n           return timeValuePair;\n         }\n       }\n \n       if (node != null && node.getCachedLast() != null) {\n-        return node.getCachedLast();\n+        TimeValuePair timeValuePair =  node.getCachedLast();\n+        if (timeValuePair != null && satisfyFilter(filter, timeValuePair)) {\n+          return timeValuePair;\n+        }\n       }\n     }\n \n-    return calculateLastPairByScanningTsFiles(seriesPath, tsDataType, context, deviceMeasurements, node);\n+    return calculateLastPairByScanningTsFiles(\n+        seriesPath, tsDataType, context, filter, deviceMeasurements, node);\n   }\n \n   private static TimeValuePair calculateLastPairByScanningTsFiles(\n-          PartialPath seriesPath, TSDataType tsDataType, QueryContext context, Set<String> deviceMeasurements,\n-          MeasurementMNode node) throws QueryProcessException, StorageEngineException, IOException {\n+          PartialPath seriesPath, TSDataType tsDataType, QueryContext context,\n+          Filter filter, Set<String> deviceMeasurements, MeasurementMNode node)\n+      throws QueryProcessException, StorageEngineException, IOException {\n \n     QueryDataSource dataSource =\n-        QueryResourceManager.getInstance().getQueryDataSource(seriesPath, context, null);\n-\n-    List<TsFileResource> seqFileResources = dataSource.getSeqResources();\n-    List<TsFileResource> unseqFileResources = dataSource.getUnseqResources();\n-\n-    TimeValuePair resultPair = new TimeValuePair(Long.MIN_VALUE, null);\n-\n-    if (!seqFileResources.isEmpty()) {\n-      for (int i = seqFileResources.size() - 1; i >= 0; i--) {\n-        TimeseriesMetadata timeseriesMetadata = FileLoaderUtils.loadTimeSeriesMetadata(\n-            seqFileResources.get(i), seriesPath, context, null, deviceMeasurements);\n-        if (timeseriesMetadata != null) {\n-          if (!timeseriesMetadata.isModified()) {\n-            Statistics timeseriesMetadataStats = timeseriesMetadata.getStatistics();\n-            resultPair = constructLastPair(\n-                timeseriesMetadataStats.getEndTime(),\n-                timeseriesMetadataStats.getLastValue(),\n-                tsDataType);\n-            break;\n-          } else {\n-            List<ChunkMetadata> chunkMetadataList = timeseriesMetadata.loadChunkMetadataList();\n-            if (!chunkMetadataList.isEmpty()) {\n-              ChunkMetadata lastChunkMetaData = chunkMetadataList.get(chunkMetadataList.size() - 1);\n-              Statistics chunkStatistics = lastChunkMetaData.getStatistics();\n-              resultPair =\n-                  constructLastPair(\n-                      chunkStatistics.getEndTime(), chunkStatistics.getLastValue(), tsDataType);\n-              break;\n-            }\n-          }\n-        }\n-      }\n-    }\n+        QueryResourceManager.getInstance().getQueryDataSource(seriesPath, context, filter);\n \n-    long version = 0;\n-    for (TsFileResource resource : unseqFileResources) {\n-      if (resource.getEndTime(seriesPath.getDevice()) < resultPair.getTimestamp()) {\n-        continue;\n-      }\n-      TimeseriesMetadata timeseriesMetadata =\n-          FileLoaderUtils\n-              .loadTimeSeriesMetadata(resource, seriesPath, context, null, deviceMeasurements);\n-      if (timeseriesMetadata != null) {\n-        for (ChunkMetadata chunkMetaData : timeseriesMetadata.loadChunkMetadataList()) {\n-          if (chunkMetaData.getEndTime() > resultPair.getTimestamp()\n-              || (chunkMetaData.getEndTime() == resultPair.getTimestamp()\n-              && chunkMetaData.getVersion() > version)) {\n-            Statistics chunkStatistics = chunkMetaData.getStatistics();\n-            resultPair =\n-                constructLastPair(\n-                    chunkStatistics.getEndTime(), chunkStatistics.getLastValue(), tsDataType);\n-            version = chunkMetaData.getVersion();\n-          }\n-        }\n-      }\n-    }\n+    LastPointReader lastReader = new LastPointReader(\n+        seriesPath, tsDataType, deviceMeasurements, context, dataSource, Long.MAX_VALUE, filter);\n+    TimeValuePair resultPair = lastReader.readLastPoint();\n \n-    // Update cached last value with low priority\n-    if (lastCacheEnabled) {\n-      IoTDB.metaManager.updateLastCache(seriesPath,\n-              resultPair, false, Long.MIN_VALUE, node);\n+    // Update cached last value with low priority unless \"FROM\" expression exists\n+    if (lastCacheEnabled && filter == null) {\n+      IoTDB.metaManager.updateLastCache(\n+          seriesPath, resultPair, false, Long.MIN_VALUE, node);\n     }\n     return resultPair;\n   }\n \n-  private static TimeValuePair constructLastPair(long timestamp, Object value,\n-                                                 TSDataType dataType) {\n-    return new TimeValuePair(timestamp, TsPrimitiveType.getByType(dataType, value));\n+  private static boolean satisfyFilter(Filter filter, TimeValuePair tvPair) {\n+    if (filter != null &&\n+        filter.satisfy(tvPair.getTimestamp(), tvPair.getValue().getValue())) {\n+      return true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0d4ef0fa34451057de106c4b2607b956d503b78"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM0NTQ0MA==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1898#discussion_r514345440", "createdAt": "2020-10-29T15:22:55Z", "author": {"login": "wshao08"}, "path": "server/src/main/java/org/apache/iotdb/db/query/executor/LastQueryExecutor.java", "diffHunk": "@@ -127,103 +127,64 @@ protected TimeValuePair calculateLastPairForOneSeries(\n    * @param context query context\n    * @return TimeValuePair\n    */\n-  @SuppressWarnings(\"squid:S3776\") // Suppress high Cognitive Complexity warning\n   public static TimeValuePair calculateLastPairForOneSeriesLocally(\n-      PartialPath seriesPath, TSDataType tsDataType, QueryContext context, Set<String> deviceMeasurements)\n+      PartialPath seriesPath, TSDataType tsDataType, QueryContext context,\n+      IExpression expression, Set<String> deviceMeasurements)\n       throws IOException, QueryProcessException, StorageEngineException {\n \n     // Retrieve last value from MNode\n     MeasurementMNode node = null;\n+    Filter filter = null;\n     if (lastCacheEnabled) {\n+      if (expression != null) {\n+        filter = ((GlobalTimeExpression) expression).getFilter();\n+      }\n       try {\n         node = (MeasurementMNode) IoTDB.metaManager.getNodeByPath(seriesPath);\n       } catch (MetadataException e) {\n         TimeValuePair timeValuePair = IoTDB.metaManager.getLastCache(seriesPath);\n-        if (timeValuePair != null) {\n+        if (timeValuePair != null && satisfyFilter(filter, timeValuePair)) {\n           return timeValuePair;\n         }\n       }\n \n       if (node != null && node.getCachedLast() != null) {\n-        return node.getCachedLast();\n+        TimeValuePair timeValuePair =  node.getCachedLast();\n+        if (timeValuePair != null && satisfyFilter(filter, timeValuePair)) {\n+          return timeValuePair;\n+        }\n       }\n     }\n \n-    return calculateLastPairByScanningTsFiles(seriesPath, tsDataType, context, deviceMeasurements, node);\n+    return calculateLastPairByScanningTsFiles(\n+        seriesPath, tsDataType, context, filter, deviceMeasurements, node);\n   }\n \n   private static TimeValuePair calculateLastPairByScanningTsFiles(\n-          PartialPath seriesPath, TSDataType tsDataType, QueryContext context, Set<String> deviceMeasurements,\n-          MeasurementMNode node) throws QueryProcessException, StorageEngineException, IOException {\n+          PartialPath seriesPath, TSDataType tsDataType, QueryContext context,\n+          Filter filter, Set<String> deviceMeasurements, MeasurementMNode node)\n+      throws QueryProcessException, StorageEngineException, IOException {\n \n     QueryDataSource dataSource =\n-        QueryResourceManager.getInstance().getQueryDataSource(seriesPath, context, null);\n-\n-    List<TsFileResource> seqFileResources = dataSource.getSeqResources();\n-    List<TsFileResource> unseqFileResources = dataSource.getUnseqResources();\n-\n-    TimeValuePair resultPair = new TimeValuePair(Long.MIN_VALUE, null);\n-\n-    if (!seqFileResources.isEmpty()) {\n-      for (int i = seqFileResources.size() - 1; i >= 0; i--) {\n-        TimeseriesMetadata timeseriesMetadata = FileLoaderUtils.loadTimeSeriesMetadata(\n-            seqFileResources.get(i), seriesPath, context, null, deviceMeasurements);\n-        if (timeseriesMetadata != null) {\n-          if (!timeseriesMetadata.isModified()) {\n-            Statistics timeseriesMetadataStats = timeseriesMetadata.getStatistics();\n-            resultPair = constructLastPair(\n-                timeseriesMetadataStats.getEndTime(),\n-                timeseriesMetadataStats.getLastValue(),\n-                tsDataType);\n-            break;\n-          } else {\n-            List<ChunkMetadata> chunkMetadataList = timeseriesMetadata.loadChunkMetadataList();\n-            if (!chunkMetadataList.isEmpty()) {\n-              ChunkMetadata lastChunkMetaData = chunkMetadataList.get(chunkMetadataList.size() - 1);\n-              Statistics chunkStatistics = lastChunkMetaData.getStatistics();\n-              resultPair =\n-                  constructLastPair(\n-                      chunkStatistics.getEndTime(), chunkStatistics.getLastValue(), tsDataType);\n-              break;\n-            }\n-          }\n-        }\n-      }\n-    }\n+        QueryResourceManager.getInstance().getQueryDataSource(seriesPath, context, filter);\n \n-    long version = 0;\n-    for (TsFileResource resource : unseqFileResources) {\n-      if (resource.getEndTime(seriesPath.getDevice()) < resultPair.getTimestamp()) {\n-        continue;\n-      }\n-      TimeseriesMetadata timeseriesMetadata =\n-          FileLoaderUtils\n-              .loadTimeSeriesMetadata(resource, seriesPath, context, null, deviceMeasurements);\n-      if (timeseriesMetadata != null) {\n-        for (ChunkMetadata chunkMetaData : timeseriesMetadata.loadChunkMetadataList()) {\n-          if (chunkMetaData.getEndTime() > resultPair.getTimestamp()\n-              || (chunkMetaData.getEndTime() == resultPair.getTimestamp()\n-              && chunkMetaData.getVersion() > version)) {\n-            Statistics chunkStatistics = chunkMetaData.getStatistics();\n-            resultPair =\n-                constructLastPair(\n-                    chunkStatistics.getEndTime(), chunkStatistics.getLastValue(), tsDataType);\n-            version = chunkMetaData.getVersion();\n-          }\n-        }\n-      }\n-    }\n+    LastPointReader lastReader = new LastPointReader(\n+        seriesPath, tsDataType, deviceMeasurements, context, dataSource, Long.MAX_VALUE, filter);\n+    TimeValuePair resultPair = lastReader.readLastPoint();\n \n-    // Update cached last value with low priority\n-    if (lastCacheEnabled) {\n-      IoTDB.metaManager.updateLastCache(seriesPath,\n-              resultPair, false, Long.MIN_VALUE, node);\n+    // Update cached last value with low priority unless \"FROM\" expression exists\n+    if (lastCacheEnabled && filter == null) {\n+      IoTDB.metaManager.updateLastCache(\n+          seriesPath, resultPair, false, Long.MIN_VALUE, node);\n     }\n     return resultPair;\n   }\n \n-  private static TimeValuePair constructLastPair(long timestamp, Object value,\n-                                                 TSDataType dataType) {\n-    return new TimeValuePair(timestamp, TsPrimitiveType.getByType(dataType, value));\n+  private static boolean satisfyFilter(Filter filter, TimeValuePair tvPair) {\n+    if (filter != null &&\n+        filter.satisfy(tvPair.getTimestamp(), tvPair.getValue().getValue())) {\n+      return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1Mzc3NA=="}, "originalCommit": {"oid": "a0d4ef0fa34451057de106c4b2607b956d503b78"}, "originalPosition": 183}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMDk1OTAwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNzozNjo0MVrOHqPcEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNToyMzowMFrOHqhKEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1NTE4NA==", "bodyText": "Same as before, if the filter is null, shoudn't we return true?", "url": "https://github.com/apache/iotdb/pull/1898#discussion_r514055184", "createdAt": "2020-10-29T07:36:41Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java", "diffHunk": "@@ -216,6 +216,9 @@ private boolean shouldUpdate(long time, long version, long newTime, long newVers\n   }\n \n   private boolean endtimeContainedByTimeFilter(Statistics statistics) {\n+    if (timeFilter == null) {\n+      return false;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0d4ef0fa34451057de106c4b2607b956d503b78"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM0NTQ5MQ==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1898#discussion_r514345491", "createdAt": "2020-10-29T15:23:00Z", "author": {"login": "wshao08"}, "path": "server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java", "diffHunk": "@@ -216,6 +216,9 @@ private boolean shouldUpdate(long time, long version, long newTime, long newVers\n   }\n \n   private boolean endtimeContainedByTimeFilter(Statistics statistics) {\n+    if (timeFilter == null) {\n+      return false;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1NTE4NA=="}, "originalCommit": {"oid": "a0d4ef0fa34451057de106c4b2607b956d503b78"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 677, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}