{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMTExMDQ2", "number": 1635, "title": "[IOTDB-860] Emend the async log applier", "bodyText": "", "createdAt": "2020-08-19T11:46:52Z", "url": "https://github.com/apache/iotdb/pull/1635", "merged": true, "mergeCommit": {"oid": "8fda67135fbb4e1062afed24a1bd028e4dd94ed2"}, "closed": true, "closedAt": "2020-09-04T01:28:28Z", "author": {"login": "neuyilan"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAmP-ygFqTQ3MTA3Mzk2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFa6e4AFqTQ4MjI5OTkwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDczOTYw", "url": "https://github.com/apache/iotdb/pull/1635#pullrequestreview-471073960", "createdAt": "2020-08-20T01:51:05Z", "commit": {"oid": "c8e482f932948de0aa81c40ddb22f016accee673"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bd864cb9ea857ec938f3ebd641fd425cc80020e", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/6bd864cb9ea857ec938f3ebd641fd425cc80020e", "committedDate": "2020-08-21T09:07:10Z", "message": "fix conflict"}, "afterCommit": {"oid": "e644498cf876097131f03bc43ed5a85a0a6ae714", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/e644498cf876097131f03bc43ed5a85a0a6ae714", "committedDate": "2020-08-21T09:22:25Z", "message": "add UT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b82d6cc16dd914b18cede3634c5fbecc42b43a43", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/b82d6cc16dd914b18cede3634c5fbecc42b43a43", "committedDate": "2020-08-21T09:44:50Z", "message": "fix conflicts"}, "afterCommit": {"oid": "8cf4003dd7bab3328bb9a8be3ff30ca29000280e", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/8cf4003dd7bab3328bb9a8be3ff30ca29000280e", "committedDate": "2020-08-21T12:28:34Z", "message": "add UT\n\nfix the UT\n\nasync applier refine\n\nfix the async log applier bug\n\nfix conflict\n\nremove useless code\n\nresolve bug\n\nadd UT\n\nfix conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "487a4674942738be35d68f5d0dcce0b1ee317086", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/487a4674942738be35d68f5d0dcce0b1ee317086", "committedDate": "2020-08-27T05:39:03Z", "message": "async applier refine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52ff188444129083577d97315e1684a893e697a2", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/52ff188444129083577d97315e1684a893e697a2", "committedDate": "2020-08-27T05:39:04Z", "message": "fix the async log applier bug\n\nfix conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6602e8e793e9679b1612d661148891003a13437d", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/6602e8e793e9679b1612d661148891003a13437d", "committedDate": "2020-08-27T05:39:04Z", "message": "add UT\n\nfix the UT\n\nasync applier refine\n\nfix the async log applier bug\n\nfix conflict\n\nremove useless code\n\nresolve bug\n\nadd UT\n\nfix conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f79474501a3a93d267292f10c942b68008e1458a", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/f79474501a3a93d267292f10c942b68008e1458a", "committedDate": "2020-08-27T05:39:04Z", "message": "remove useless thread pool"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d2fbbef93eada0e4d219d5d841528c8c84279dd", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/0d2fbbef93eada0e4d219d5d841528c8c84279dd", "committedDate": "2020-08-27T05:39:53Z", "message": "support flush plan when do snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae1540fcdc2626361d9202603c5b68d4038b2d42", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/ae1540fcdc2626361d9202603c5b68d4038b2d42", "committedDate": "2020-08-27T05:39:53Z", "message": "refine syncCloseOneProcessor method in StorageGroupProcessor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecb1a525d31a45230df5891b1d9f7378f7ee56f7", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/ecb1a525d31a45230df5891b1d9f7378f7ee56f7", "committedDate": "2020-08-27T05:39:53Z", "message": "change the log msg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1101cfb651648d486867f65c073125f90d19e997", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/1101cfb651648d486867f65c073125f90d19e997", "committedDate": "2020-08-27T05:39:53Z", "message": "fix the license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3833718e2d0397688abe3d6f36e4214766df348f", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/3833718e2d0397688abe3d6f36e4214766df348f", "committedDate": "2020-08-27T05:39:53Z", "message": "fix the check applir log index"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d1fa0d0d1f305fc9fc3e23e89073be7c12be452", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/7d1fa0d0d1f305fc9fc3e23e89073be7c12be452", "committedDate": "2020-08-27T05:39:53Z", "message": "fix checkAppliedLogIndex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1071bdeaa8c3246e3ff9f8e4d10ea2b24e79bdc", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/f1071bdeaa8c3246e3ff9f8e4d10ea2b24e79bdc", "committedDate": "2020-08-27T05:39:53Z", "message": "fix flushPlan bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "261dbfe8dc938e82e9138f6724abf450e114e421", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/261dbfe8dc938e82e9138f6724abf450e114e421", "committedDate": "2020-08-27T05:39:54Z", "message": "fix flushPlan bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e8e25d6a8ed359c054bb547ae1be7e2678511bf", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/4e8e25d6a8ed359c054bb547ae1be7e2678511bf", "committedDate": "2020-08-27T05:39:54Z", "message": "add more log message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "162edfb0eec66d065ba1d7412ff485dce3cbaf51", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/162edfb0eec66d065ba1d7412ff485dce3cbaf51", "committedDate": "2020-08-27T05:39:54Z", "message": "make"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9624981aebad91afbe332fafc96a76a092f4272c", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/9624981aebad91afbe332fafc96a76a092f4272c", "committedDate": "2020-08-27T05:39:54Z", "message": "Delete the extra blank lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ae9f80421cf59203752778fc8dbec51be83848b", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/7ae9f80421cf59203752778fc8dbec51be83848b", "committedDate": "2020-08-27T05:39:54Z", "message": "fix flushplan serialize bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5187c10ca22eff46834d23371e037c36f34fbf60", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/5187c10ca22eff46834d23371e037c36f34fbf60", "committedDate": "2020-08-27T05:39:54Z", "message": "fix flushplan serialize bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e299193d58130cb009446a07cbadcc609b4d9eff", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/e299193d58130cb009446a07cbadcc609b4d9eff", "committedDate": "2020-08-27T05:39:54Z", "message": "add flushPlan test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4027bba30ac09c53acdb558fea2be28b4e4f0f4a", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/4027bba30ac09c53acdb558fea2be28b4e4f0f4a", "committedDate": "2020-08-27T05:39:54Z", "message": "Delete the extra blank lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94b5a10d61a90ab5c2441dfb54cafc7e5a5841ee", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/94b5a10d61a90ab5c2441dfb54cafc7e5a5841ee", "committedDate": "2020-08-27T05:39:54Z", "message": "move syncFlushAllProcessor out of synchronized (logmanager) in"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c3f239c3cdd59860141d85c9e3110ccc92bd110", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/5c3f239c3cdd59860141d85c9e3110ccc92bd110", "committedDate": "2020-08-27T05:39:54Z", "message": "make the applyEntries in one seperate thread"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d639d8b6accf1cc9463fad796e64e7c8a0d5d628", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/d639d8b6accf1cc9463fad796e64e7c8a0d5d628", "committedDate": "2020-08-27T05:33:33Z", "message": "make the applyEntries in one seperate thread"}, "afterCommit": {"oid": "5c3f239c3cdd59860141d85c9e3110ccc92bd110", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/5c3f239c3cdd59860141d85c9e3110ccc92bd110", "committedDate": "2020-08-27T05:39:54Z", "message": "make the applyEntries in one seperate thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MTg0MTk3", "url": "https://github.com/apache/iotdb/pull/1635#pullrequestreview-477184197", "createdAt": "2020-08-28T01:27:07Z", "commit": {"oid": "5c3f239c3cdd59860141d85c9e3110ccc92bd110"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMToyNzowN1rOHImdyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwMToyNzowN1rOHImdyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc4MDg3NA==", "bodyText": "I am afraid that we cannot flush the whole storage group when time partitioning is enabled. Because in that case, a storage group will be managed by several data groups, if you flush one storage group without notifying other data groups, the file integrity of other data groups will be broken.\nSo you should either flush other related groups (which is rather hard to find), or only flush partitions that belong to the data group.", "url": "https://github.com/apache/iotdb/pull/1635#discussion_r478780874", "createdAt": "2020-08-28T01:27:07Z", "author": {"login": "jt2594838"}, "path": "cluster/src/main/java/org/apache/iotdb/cluster/log/manage/FilePartitionedSnapshotLogManager.java", "diffHunk": "@@ -47,22 +52,47 @@\n       .getLogger(FilePartitionedSnapshotLogManager.class);\n \n   public FilePartitionedSnapshotLogManager(LogApplier logApplier, PartitionTable partitionTable,\n-      Node header, Node thisNode) {\n-    super(logApplier, partitionTable, header, thisNode, FileSnapshot::new);\n+      Node header, Node thisNode, DataGroupMember dataGroupMember) {\n+    super(logApplier, partitionTable, header, thisNode, FileSnapshot::new, dataGroupMember);\n+  }\n+\n+  /**\n+   * send FlushPlan to all nodes in one dataGroup\n+   */\n+  public void syncFlushAllProcessor() {\n+    logger.info(\"{}: Start flush all storage group processor in one data group\", getName());\n+    ConcurrentHashMap<String, StorageGroupProcessor> processorMap = StorageEngine.getInstance()\n+        .getProcessorMap();\n+    if (processorMap.size() == 0) {\n+      logger.info(\"{}: no need to flush processor\", getName());\n+      return;\n+    }\n+    List<Path> storageGroups = new ArrayList<>();\n+    for (Map.Entry<String, StorageGroupProcessor> entry : processorMap.entrySet()) {\n+      Path path = new Path(entry.getKey());\n+      storageGroups.add(path);\n+    }\n+    FlushPlan plan = new FlushPlan(null, true, storageGroups);\n+    dataGroupMember.flushFileWhenDoSnapshot(plan);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c3f239c3cdd59860141d85c9e3110ccc92bd110"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ac7bf3fa9e2affaeedfa4eef804bde515361890", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/5ac7bf3fa9e2affaeedfa4eef804bde515361890", "committedDate": "2020-08-29T03:12:06Z", "message": "flush the partitions belong to the datagroup and fix some UT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjk5OTA0", "url": "https://github.com/apache/iotdb/pull/1635#pullrequestreview-482299904", "createdAt": "2020-09-04T01:28:16Z", "commit": {"oid": "5ac7bf3fa9e2affaeedfa4eef804bde515361890"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3394, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}