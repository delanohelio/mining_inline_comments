{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MzY3NzEx", "number": 1480, "title": "update log and add some reader close", "bodyText": "", "createdAt": "2020-07-10T10:44:52Z", "url": "https://github.com/apache/iotdb/pull/1480", "merged": true, "mergeCommit": {"oid": "4b023b75fae1354fb90d335e46b99e8f08827413"}, "closed": true, "closedAt": "2020-07-15T02:47:32Z", "author": {"login": "zhanglingzhe0820"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczhTTJAH2gAyNDQ3MzY3NzExOjliMmYxNzg5NDFlYjE3YTc0MjgyOGQ0NmQ0MWI3ZGZlNmEwNDU3NDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1AzksAFqTQ0ODU3ODg2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b2f178941eb17a742828d46d41b7dfe6a045743", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/9b2f178941eb17a742828d46d41b7dfe6a045743", "committedDate": "2020-07-10T10:44:10Z", "message": "update log and add some reader close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48d79624c698371a3cbb704ab2d567b87c3a4232", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/48d79624c698371a3cbb704ab2d567b87c3a4232", "committedDate": "2020-07-10T12:24:55Z", "message": "try test reader and writer open and close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38ee495a42635f194fef575380ac90f31c1db3ab", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/38ee495a42635f194fef575380ac90f31c1db3ab", "committedDate": "2020-07-10T13:29:23Z", "message": "try to figure same file bug in windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "567339591fa673f836f896da7e49960cba3fd07e", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/567339591fa673f836f896da7e49960cba3fd07e", "committedDate": "2020-07-10T13:51:09Z", "message": "Revert \"try test reader and writer open and close\"\n\nThis reverts commit 48d79624c698371a3cbb704ab2d567b87c3a4232."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf350566317422299d13572c363fc35bd33547da", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/bf350566317422299d13572c363fc35bd33547da", "committedDate": "2020-07-10T13:52:33Z", "message": "remove useless reader close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44f8527990dfa66926f8876ae94f45f36eaeeb65", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/44f8527990dfa66926f8876ae94f45f36eaeeb65", "committedDate": "2020-07-14T11:36:52Z", "message": "update vm file to version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61c097466a73da5f46b2c55cba0fd8c3088d27a", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/b61c097466a73da5f46b2c55cba0fd8c3088d27a", "committedDate": "2020-07-14T12:38:19Z", "message": "merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MDY2NTgx", "url": "https://github.com/apache/iotdb/pull/1480#pullrequestreview-448066581", "createdAt": "2020-07-14T12:39:31Z", "commit": {"oid": "44f8527990dfa66926f8876ae94f45f36eaeeb65"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjozOTozMVrOGxR1mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjozOTozMVrOGxR1mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyNTY1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  String vmVersionStr = f.getPath()\n          \n          \n            \n                  String vmLevel = f.getPath()", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454325658", "createdAt": "2020-07-14T12:39:31Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -574,16 +575,25 @@ else if (upgradeFolder.exists()) {\n       }\n     }\n \n-    Map<String, List<TsFileResource>> vmTsFileResourceMap = new HashMap<>();\n+    Map<String, List<List<TsFileResource>>> vmTsFileResourceMap = new HashMap<>();\n     for (File f : vmFiles) {\n       TsFileResource fileResource = new TsFileResource(f);\n       fileResource.setClosed(false);\n       String tsfilePrefix = f.getPath()\n-          .substring(0, f.getPath().lastIndexOf(FILE_NAME_SEPARATOR));\n-      vmTsFileResourceMap.computeIfAbsent(tsfilePrefix, k -> new ArrayList<>()).add(fileResource);\n+          .substring(0, f.getPath().lastIndexOf(TSFILE_SUFFIX)) + TSFILE_SUFFIX;\n+      String vmVersionStr = f.getPath()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44f8527990dfa66926f8876ae94f45f36eaeeb65"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36", "committedDate": "2020-07-14T12:46:18Z", "message": "update version and level"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MDc5OTIx", "url": "https://github.com/apache/iotdb/pull/1480#pullrequestreview-448079921", "createdAt": "2020-07-14T12:57:32Z", "commit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1NzozMlrOGxSeAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1NzozMlrOGxSeAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNjAwMQ==", "bodyText": "I prefer to put the level ahead of system time...", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454336001", "createdAt": "2020-07-14T12:57:32Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -586,12 +603,23 @@ private void releaseFlushedMemTable(IMemTable memTable) {\n     }\n   }\n \n-  public static File createNewVMFile(TsFileResource tsFileResource) {\n-    File parent = tsFileResource.getTsFile().getParentFile();\n-    return FSFactoryProducer.getFSFactory().getFile(parent,\n-        tsFileResource.getTsFile().getName() + IoTDBConstant.FILE_NAME_SEPARATOR + System\n-            .currentTimeMillis()\n-            + VM_SUFFIX);\n+  public File createNewVMFile(TsFileResource tsFileResource, int level) {\n+    vmFileCreateLock.writeLock().lock();\n+    try {\n+      TimeUnit.MILLISECONDS.sleep(1);\n+      File parent = tsFileResource.getTsFile().getParentFile();\n+      File newVmFile = FSFactoryProducer.getFSFactory().getFile(parent,\n+          tsFileResource.getTsFile().getName() + IoTDBConstant.FILE_NAME_SEPARATOR + System\n+              .currentTimeMillis() + IoTDBConstant.FILE_NAME_SEPARATOR + level", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MDgwNjE2", "url": "https://github.com/apache/iotdb/pull/1480#pullrequestreview-448080616", "createdAt": "2020-07-14T12:58:22Z", "commit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1ODoyMlrOGxSgJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1ODoyMlrOGxSgJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNjU0OQ==", "bodyText": "change to debug level", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454336549", "createdAt": "2020-07-14T12:58:22Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -600,11 +628,13 @@ private void deleteVmFiles(List<TsFileResource> vmMergeTsFiles,\n         tsFileResource.getTsFile().getName());\n     for (int i = 0; i < vmMergeTsFiles.size(); i++) {\n       vmMergeWriters.get(i).close();\n-      logger.info(\"{} vm file open a writer\", vmMergeWriters.get(i).getFile().getName());\n+      logger.info(\"{} vm file close a writer\", vmMergeWriters.get(i).getFile().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MDgxNjI3", "url": "https://github.com/apache/iotdb/pull/1480#pullrequestreview-448081627", "createdAt": "2020-07-14T12:59:37Z", "commit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1OTozN1rOGxSjFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjo1OTozN1rOGxSjFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzNzMwMw==", "bodyText": "are they consistent and can be put together?", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454337303", "createdAt": "2020-07-14T12:59:37Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -683,10 +715,16 @@ public void flushOneMemTable() {\n         RestorableTsFileIOWriter curWriter;\n         if (config.isEnableVm()) {\n           logger.info(\"[Flush] flush a vm\");\n-          File newVmFile = createNewVMFile(tsFileResource);\n-          vmTsFileResources.add(new TsFileResource(newVmFile));\n+          File newVmFile = createNewVMFile(tsFileResource, 0);\n+          if (vmWriters.size() <= 0) {\n+            vmWriters.add(new ArrayList<>());\n+          }\n+          if (vmTsFileResources.size() <= 0) {\n+            vmTsFileResources.add(new ArrayList<>());\n+          }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "originalPosition": 186}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MDgzMTAy", "url": "https://github.com/apache/iotdb/pull/1480#pullrequestreview-448083102", "createdAt": "2020-07-14T13:01:28Z", "commit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzowMToyOFrOGxSnbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzowMToyOFrOGxSnbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMzODQxNQ==", "bodyText": "add javadoc, or rename this to copiedVmTsFileResources", "url": "https://github.com/apache/iotdb/pull/1480#discussion_r454338415", "createdAt": "2020-07-14T13:01:28Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -802,9 +840,17 @@ public void flushOneMemTable() {\n         mergeWorking = true;\n         logger.info(\"{}: {} submit a vm merge task\", storageGroupName,\n             tsFileResource.getTsFile().getName());\n+        List<List<TsFileResource>> currVmTsFileResources = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4ad3ff676ba573ac7d6de4d792f72dd6b6e1f36"}, "originalPosition": 198}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1d36c6566deed0a68cedcf4f2689ef7e0ac3387", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/a1d36c6566deed0a68cedcf4f2689ef7e0ac3387", "committedDate": "2020-07-14T13:01:44Z", "message": "merge if condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be8e4198861871c6687eaf698cd3476333de3a00", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/be8e4198861871c6687eaf698cd3476333de3a00", "committedDate": "2020-07-14T13:12:32Z", "message": "fix comment code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTc4ODY4", "url": "https://github.com/apache/iotdb/pull/1480#pullrequestreview-448578868", "createdAt": "2020-07-15T02:00:24Z", "commit": {"oid": "be8e4198861871c6687eaf698cd3476333de3a00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3467, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}