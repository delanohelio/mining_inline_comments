{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MDExNTUw", "number": 1956, "title": "[Distributed] bug fix, remove the persist logs when follower receives a snapshot", "bodyText": "", "createdAt": "2020-11-05T12:00:26Z", "url": "https://github.com/apache/iotdb/pull/1956", "merged": true, "mergeCommit": {"oid": "9da74d218d38b0be541b5ab2f63dc175c659791d"}, "closed": true, "closedAt": "2020-11-10T01:43:42Z", "author": {"login": "neuyilan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZg-Z6AH2gAyNTE2MDExNTUwOjhhMzIyODhlNGJjMDM2MjE5NTUzYzE3ZmJhMmQyZDg0MGIyMDgwZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda_ShbgFqTUyNjc5MDQ4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8a32288e4bc036219553c17fba2d2d840b2080ec", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/8a32288e4bc036219553c17fba2d2d840b2080ec", "committedDate": "2020-11-05T11:50:28Z", "message": "fix bug: remove the logs when follower receives a snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5b85e50e3c0f094faf78c98f1b8a2a59dabc06d", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/e5b85e50e3c0f094faf78c98f1b8a2a59dabc06d", "committedDate": "2020-11-05T11:58:59Z", "message": "fix conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b14cf581783ef816b236c948b5110fda9b2593c", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/3b14cf581783ef816b236c948b5110fda9b2593c", "committedDate": "2020-11-06T06:35:55Z", "message": "merge with clsuter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cddd0ef64f0a2a3dcb4ad485c91d28b383bb13c", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/2cddd0ef64f0a2a3dcb4ad485c91d28b383bb13c", "committedDate": "2020-11-06T07:02:27Z", "message": "Merge branch 'apache_cluster_new' into apache_cluster_new_1105_clean_all_logs_after_snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c92a26cc42cf417c190bfda618e04cebe280fc86", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/c92a26cc42cf417c190bfda618e04cebe280fc86", "committedDate": "2020-11-06T09:32:57Z", "message": "fix read log bug when logs are delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d43ba95fc7e66aea700dca1cdd72a64bbb4d4b1b", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/d43ba95fc7e66aea700dca1cdd72a64bbb4d4b1b", "committedDate": "2020-11-06T09:33:41Z", "message": "Merge branch 'apache_cluster_new' into apache_cluster_new_1105_clean_all_logs_after_snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7cdf51e1497d6fc37c32e479e13c8766860a80a", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/e7cdf51e1497d6fc37c32e479e13c8766860a80a", "committedDate": "2020-11-07T02:49:38Z", "message": "fix close bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1ODgwNDg5", "url": "https://github.com/apache/iotdb/pull/1956#pullrequestreview-525880489", "createdAt": "2020-11-09T01:59:05Z", "commit": {"oid": "e7cdf51e1497d6fc37c32e479e13c8766860a80a"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwMTo1OTowNlrOHvcuEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwMjowNjoxNFrOHvczOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUxNTY2NA==", "bodyText": "Can be simplified with Files.deleteIfExists", "url": "https://github.com/apache/iotdb/pull/1956#discussion_r519515664", "createdAt": "2020-11-09T01:59:06Z", "author": {"login": "jt2594838"}, "path": "cluster/src/main/java/org/apache/iotdb/cluster/log/manage/serializable/SyncLogDequeSerializer.java", "diffHunk": "@@ -835,6 +834,59 @@ public void close() {\n     }\n   }\n \n+  @Override\n+  public void clearAllLogs(long commitIndex) {\n+    lock.writeLock().lock();\n+    try {\n+      // 1. delete\n+      forceFlushLogBuffer();\n+      closeCurrentFile(meta.getCommitLogIndex());\n+      for (int i = 0; i < logDataFileList.size(); i++) {\n+        deleteLogDataAndIndexFile(i);\n+      }\n+      deleteMetaFile();\n+\n+      logDataFileList.clear();\n+      logIndexFileList.clear();\n+\n+      // 2. init\n+      if (!logIndexOffsetList.isEmpty()) {\n+        this.firstLogIndex = Math\n+            .max(commitIndex + 1, firstLogIndex + logIndexOffsetList.size());\n+      } else {\n+        this.firstLogIndex = commitIndex + 1;\n+      }\n+      this.logIndexOffsetList.clear();\n+      recoverMetaFile();\n+      meta = new LogManagerMeta();\n+      createNewLogFile(logDir, firstLogIndex);\n+      logger.info(\"{}, clean all logs success, the new firstLogIndex={}\", this, firstLogIndex);\n+    } catch (IOException e) {\n+      logger.error(\"clear all logs failed,\", e);\n+    } finally {\n+      lock.writeLock().unlock();\n+    }\n+  }\n+\n+  private void deleteMetaFile() {\n+    lock.writeLock().lock();\n+    try {\n+      File tmpMetaFile = SystemFileFactory.INSTANCE.getFile(logDir + \"logMeta.tmp\");\n+      if (tmpMetaFile.exists()) {\n+        Files.delete(tmpMetaFile.toPath());\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7cdf51e1497d6fc37c32e479e13c8766860a80a"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUxNjIyNQ==", "bodyText": "\"will be deleted\"", "url": "https://github.com/apache/iotdb/pull/1956#discussion_r519516225", "createdAt": "2020-11-09T02:01:55Z", "author": {"login": "jt2594838"}, "path": "cluster/src/main/java/org/apache/iotdb/cluster/log/manage/serializable/SyncLogDequeSerializer.java", "diffHunk": "@@ -945,23 +1008,34 @@ private int comparePersistLogFileName(File file1, File file2) {\n     if (endIndex - startIndex > maxNumberOfLogsPerFetchOnDisk) {\n       newEndIndex = startIndex + maxNumberOfLogsPerFetchOnDisk;\n     }\n-    logger.debug(\"intend to get logs between[{}, {}], actually get logs between[{},{}]\", startIndex,\n-        endIndex, startIndex, newEndIndex);\n+    logger\n+        .debug(\"intend to get logs between[{}, {}], actually get logs between[{},{}]\", startIndex,\n+            endIndex, startIndex, newEndIndex);\n \n-    List<Pair<File, Pair<Long, Long>>> logDataFileAndOffsetList = getLogDataFileAndOffset(\n-        startIndex, newEndIndex);\n-    if (logDataFileAndOffsetList.isEmpty()) {\n-      return Collections.emptyList();\n-    }\n+    // maybe the logs will be delete during checkDeletePersistRaftLog or clearAllLogs,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7cdf51e1497d6fc37c32e479e13c8766860a80a"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUxNjM1NA==", "bodyText": "\"being deleted\"", "url": "https://github.com/apache/iotdb/pull/1956#discussion_r519516354", "createdAt": "2020-11-09T02:02:39Z", "author": {"login": "jt2594838"}, "path": "cluster/src/main/java/org/apache/iotdb/cluster/log/manage/serializable/SyncLogDequeSerializer.java", "diffHunk": "@@ -945,23 +1008,34 @@ private int comparePersistLogFileName(File file1, File file2) {\n     if (endIndex - startIndex > maxNumberOfLogsPerFetchOnDisk) {\n       newEndIndex = startIndex + maxNumberOfLogsPerFetchOnDisk;\n     }\n-    logger.debug(\"intend to get logs between[{}, {}], actually get logs between[{},{}]\", startIndex,\n-        endIndex, startIndex, newEndIndex);\n+    logger\n+        .debug(\"intend to get logs between[{}, {}], actually get logs between[{},{}]\", startIndex,\n+            endIndex, startIndex, newEndIndex);\n \n-    List<Pair<File, Pair<Long, Long>>> logDataFileAndOffsetList = getLogDataFileAndOffset(\n-        startIndex, newEndIndex);\n-    if (logDataFileAndOffsetList.isEmpty()) {\n-      return Collections.emptyList();\n-    }\n+    // maybe the logs will be delete during checkDeletePersistRaftLog or clearAllLogs,\n+    // use writeLock for two reasons:\n+    // 1.if the log file to read is the last log file, we need to get write lock to flush logBuffer,\n+    // 2.avoid log files be deleted", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7cdf51e1497d6fc37c32e479e13c8766860a80a"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUxNjk4Ng==", "bodyText": "Is there anywhere using read lock of this lock? If not, maybe it is better to consider using a more light-weighted lock.", "url": "https://github.com/apache/iotdb/pull/1956#discussion_r519516986", "createdAt": "2020-11-09T02:06:14Z", "author": {"login": "jt2594838"}, "path": "cluster/src/main/java/org/apache/iotdb/cluster/log/manage/serializable/SyncLogDequeSerializer.java", "diffHunk": "@@ -945,23 +1008,34 @@ private int comparePersistLogFileName(File file1, File file2) {\n     if (endIndex - startIndex > maxNumberOfLogsPerFetchOnDisk) {\n       newEndIndex = startIndex + maxNumberOfLogsPerFetchOnDisk;\n     }\n-    logger.debug(\"intend to get logs between[{}, {}], actually get logs between[{},{}]\", startIndex,\n-        endIndex, startIndex, newEndIndex);\n+    logger\n+        .debug(\"intend to get logs between[{}, {}], actually get logs between[{},{}]\", startIndex,\n+            endIndex, startIndex, newEndIndex);\n \n-    List<Pair<File, Pair<Long, Long>>> logDataFileAndOffsetList = getLogDataFileAndOffset(\n-        startIndex, newEndIndex);\n-    if (logDataFileAndOffsetList.isEmpty()) {\n-      return Collections.emptyList();\n-    }\n+    // maybe the logs will be delete during checkDeletePersistRaftLog or clearAllLogs,\n+    // use writeLock for two reasons:\n+    // 1.if the log file to read is the last log file, we need to get write lock to flush logBuffer,\n+    // 2.avoid log files be deleted\n+    lock.writeLock().lock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7cdf51e1497d6fc37c32e479e13c8766860a80a"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "429d82762ee623c4094f6cff9b0d85d90034908c", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/429d82762ee623c4094f6cff9b0d85d90034908c", "committedDate": "2020-11-09T04:19:07Z", "message": "fix review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "253a5708b617417a227d362e245410c41e8f389e", "author": {"user": {"login": "neuyilan", "name": "Houliang Qi"}}, "url": "https://github.com/apache/iotdb/commit/253a5708b617417a227d362e245410c41e8f389e", "committedDate": "2020-11-09T04:20:44Z", "message": "Merge branch 'apache_cluster_new' into apache_cluster_new_1105_clean_all_logs_after_snapshot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NzkwNDg2", "url": "https://github.com/apache/iotdb/pull/1956#pullrequestreview-526790486", "createdAt": "2020-11-10T01:43:31Z", "commit": {"oid": "253a5708b617417a227d362e245410c41e8f389e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3643, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}