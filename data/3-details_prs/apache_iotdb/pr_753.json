{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MTExNzAz", "number": 753, "title": "[IOTDB-433] Add iterators to TVList to prevent data copy", "bodyText": "In the previous design, when you used in-memory data:\n\n\nthe TVList structure was clone into an IWritableMemChunk named chunkCopy\n\n\nAnd then copied again into a List<TimeValuePair> structure\n\n\nIf multiple data happens to exist in flushingMemTable, MemSeriesLazyMerger will use addAll(List<TimeValuePair>) to copy again\n\n\nso, I think we should directly use TVList to implement IPointReader interface and use it externally\n\nAdd the Iterator class and getIterator method for TVlist\n\nNow, Data was copied only when it is used", "createdAt": "2020-01-17T12:08:53Z", "url": "https://github.com/apache/iotdb/pull/753", "merged": true, "mergeCommit": {"oid": "aa229d2068e259f7699ebfd80b936fc38ef1ca46"}, "closed": true, "closedAt": "2020-01-20T06:48:39Z", "author": {"login": "liutaohua"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7M8fyAH2gAyMzY0MTExNzAzOjk2Mzg2ZjlhZjZmMTYwNzk2ZmM3NTA2MGMxNzBhNDJkZWM4NDYwYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7x_g5gFqTM0NDk4MDA2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "96386f9af6f160796fc75060c170a42dec8460c5", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/96386f9af6f160796fc75060c170a42dec8460c5", "committedDate": "2020-01-17T11:21:24Z", "message": "write tvlist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "694f84875dc9b7946f71298195c4e7a60df1de20", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/694f84875dc9b7946f71298195c4e7a60df1de20", "committedDate": "2020-01-17T12:12:33Z", "message": "fixbug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f1dd69139c8c02a17adccc68428ebcf527066c5", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/9f1dd69139c8c02a17adccc68428ebcf527066c5", "committedDate": "2020-01-17T12:20:04Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20d22368449a65e2c5d73fe74b0c7c28cbc32555", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/20d22368449a65e2c5d73fe74b0c7c28cbc32555", "committedDate": "2020-01-17T12:35:42Z", "message": "fix bug of format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44e3958c1ca560e8a77a7f8dba278fa3e88e983d", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/44e3958c1ca560e8a77a7f8dba278fa3e88e983d", "committedDate": "2020-01-17T12:38:56Z", "message": "delete unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b22338202c2d2db62f1023bae1bd459b186a27bd", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/b22338202c2d2db62f1023bae1bd459b186a27bd", "committedDate": "2020-01-17T13:06:35Z", "message": "fix asf header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/180c0345f998a57f8ff38eabea610d87eeaee2d0", "committedDate": "2020-01-18T05:08:26Z", "message": "fix asf header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTczNDQ5", "url": "https://github.com/apache/iotdb/pull/753#pullrequestreview-344973449", "createdAt": "2020-01-19T02:58:43Z", "commit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwMjo1ODo0M1rOFfM6cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwMjo1ODo0M1rOFfM6cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MTc0NQ==", "bodyText": "put this to clone method of TVList", "url": "https://github.com/apache/iotdb/pull/753#discussion_r368261745", "createdAt": "2020-01-19T02:58:43Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/memtable/AbstractMemTable.java", "diffHunk": "@@ -195,19 +199,19 @@ public boolean isEmpty() {\n   }\n \n   @Override\n-  public ReadOnlyMemChunk query(String deviceId, String measurement, TSDataType dataType,\n+  public TVList query(String deviceId, String measurement, TSDataType dataType,\n       Map<String, String> props, long timeLowerBound) {\n-    TimeValuePairSorter sorter;\n     if (!checkPath(deviceId, measurement)) {\n       return null;\n-    } else {\n-      long undeletedTime = findUndeletedTime(deviceId, measurement, timeLowerBound);\n-      IWritableMemChunk memChunk = memTableMap.get(deviceId).get(measurement);\n-      IWritableMemChunk chunkCopy = new WritableMemChunk(dataType, memChunk.getTVList().clone());\n-      chunkCopy.setTimeOffset(undeletedTime);\n-      sorter = chunkCopy;\n     }\n-    return new ReadOnlyMemChunk(measurement, dataType, sorter, props);\n+    long undeletedTime = findUndeletedTime(deviceId, measurement, timeLowerBound);\n+    IWritableMemChunk memChunk = memTableMap.get(deviceId).get(measurement);\n+    TVList chunkCopy = memChunk.getTVList().clone();\n+\n+    chunkCopy.setVersion(getVersion());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTczODM0", "url": "https://github.com/apache/iotdb/pull/753#pullrequestreview-344973834", "createdAt": "2020-01-19T03:10:55Z", "commit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwMzoxMDo1NVrOFfM8IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOVQwMzozNjowMlrOFfM__Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MjE3Ng==", "bodyText": "remove the sortedList field in this class and unused import", "url": "https://github.com/apache/iotdb/pull/753#discussion_r368262176", "createdAt": "2020-01-19T03:10:55Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/memtable/WritableMemChunk.java", "diffHunk": "@@ -223,51 +223,6 @@ public void setTimeOffset(long offset) {\n     list.setTimeOffset(offset);\n   }\n \n-  @Override\n-  public synchronized List<TimeValuePair> getSortedTimeValuePairList() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MjcyOA==", "bodyText": "I suggest using one ReadOnlyMemChunk to store one chunk in a memtable. The TsFileProcessor return a Pair<List, List>\nInit the chunk metadata in the constructor in this class and cache it.\nTherefore, we only need one chunkreader, and it should not be a mergereader, we could directly get the  IPointReader in TVList.\nIn the AbstractMemTable, the version should be init by Long.MAX_VALUE for a working memtable, the memtable version is set only when it comes to a  flushing memtable.", "url": "https://github.com/apache/iotdb/pull/753#discussion_r368262728", "createdAt": "2020-01-19T03:24:32Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/querycontext/ReadOnlyMemChunk.java", "diffHunk": "@@ -18,106 +18,69 @@\n  */\n package org.apache.iotdb.db.engine.querycontext;\n \n-import java.util.Collections;\n-import java.util.Iterator;\n+import java.io.IOException;\n import java.util.List;\n import java.util.Map;\n-import org.apache.iotdb.db.engine.memtable.MemSeriesLazyMerger;\n-import org.apache.iotdb.db.engine.memtable.TimeValuePairSorter;\n import org.apache.iotdb.db.query.reader.MemChunkLoader;\n-import org.apache.iotdb.db.utils.MathUtils;\n-import org.apache.iotdb.tsfile.read.TimeValuePair;\n+import org.apache.iotdb.db.query.reader.universal.PriorityMergeReader;\n+import org.apache.iotdb.db.utils.datastructure.TVList;\n import org.apache.iotdb.tsfile.common.conf.TSFileDescriptor;\n import org.apache.iotdb.tsfile.encoding.encoder.Encoder;\n import org.apache.iotdb.tsfile.file.metadata.ChunkMetaData;\n import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n import org.apache.iotdb.tsfile.file.metadata.statistics.Statistics;\n-import org.apache.iotdb.tsfile.utils.TsPrimitiveType.TsDouble;\n-import org.apache.iotdb.tsfile.utils.TsPrimitiveType.TsFloat;\n+import org.apache.iotdb.tsfile.read.IPointReader;\n+import org.apache.iotdb.tsfile.read.TimeValuePair;\n \n //TODO: merge ReadOnlyMemChunk and WritableMemChunk and IWritableMemChunk\n-public class ReadOnlyMemChunk implements TimeValuePairSorter {\n+public class ReadOnlyMemChunk {\n \n-  private boolean initialized;\n   private String measurementUid;\n   private TSDataType dataType;\n-  private TimeValuePairSorter memSeries;\n-  private List<TimeValuePair> sortedTimeValuePairList;\n \n   Map<String, String> props;\n   private int floatPrecision = TSFileDescriptor.getInstance().getConfig().getFloatPrecision();\n+  private ChunkMetaData cachedMetaData;\n+\n+  private PriorityMergeReader mergeReader;\n+  private PriorityMergeReader chunkedReader;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2Mjk0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                for (TVList pair : memSeries) {\n          \n          \n            \n                for (TVList tvlist : memSeries) {", "url": "https://github.com/apache/iotdb/pull/753#discussion_r368262947", "createdAt": "2020-01-19T03:30:37Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/querycontext/ReadOnlyMemChunk.java", "diffHunk": "@@ -18,106 +18,69 @@\n  */\n package org.apache.iotdb.db.engine.querycontext;\n \n-import java.util.Collections;\n-import java.util.Iterator;\n+import java.io.IOException;\n import java.util.List;\n import java.util.Map;\n-import org.apache.iotdb.db.engine.memtable.MemSeriesLazyMerger;\n-import org.apache.iotdb.db.engine.memtable.TimeValuePairSorter;\n import org.apache.iotdb.db.query.reader.MemChunkLoader;\n-import org.apache.iotdb.db.utils.MathUtils;\n-import org.apache.iotdb.tsfile.read.TimeValuePair;\n+import org.apache.iotdb.db.query.reader.universal.PriorityMergeReader;\n+import org.apache.iotdb.db.utils.datastructure.TVList;\n import org.apache.iotdb.tsfile.common.conf.TSFileDescriptor;\n import org.apache.iotdb.tsfile.encoding.encoder.Encoder;\n import org.apache.iotdb.tsfile.file.metadata.ChunkMetaData;\n import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n import org.apache.iotdb.tsfile.file.metadata.statistics.Statistics;\n-import org.apache.iotdb.tsfile.utils.TsPrimitiveType.TsDouble;\n-import org.apache.iotdb.tsfile.utils.TsPrimitiveType.TsFloat;\n+import org.apache.iotdb.tsfile.read.IPointReader;\n+import org.apache.iotdb.tsfile.read.TimeValuePair;\n \n //TODO: merge ReadOnlyMemChunk and WritableMemChunk and IWritableMemChunk\n-public class ReadOnlyMemChunk implements TimeValuePairSorter {\n+public class ReadOnlyMemChunk {\n \n-  private boolean initialized;\n   private String measurementUid;\n   private TSDataType dataType;\n-  private TimeValuePairSorter memSeries;\n-  private List<TimeValuePair> sortedTimeValuePairList;\n \n   Map<String, String> props;\n   private int floatPrecision = TSFileDescriptor.getInstance().getConfig().getFloatPrecision();\n+  private ChunkMetaData cachedMetaData;\n+\n+  private PriorityMergeReader mergeReader;\n+  private PriorityMergeReader chunkedReader;\n \n   /**\n    * init by TSDataType and TimeValuePairSorter.\n    */\n-  public ReadOnlyMemChunk(String measurementUid, TSDataType dataType, TimeValuePairSorter memSeries,\n-      Map<String, String> props) {\n+  public ReadOnlyMemChunk(String measurementUid, TSDataType dataType,\n+      List<TVList> memSeries, Map<String, String> props) throws IOException {\n     this.measurementUid = measurementUid;\n     this.dataType = dataType;\n-    this.memSeries = memSeries;\n-    this.initialized = false;\n     this.props = props;\n     if (props.containsKey(Encoder.MAX_POINT_NUMBER)) {\n       this.floatPrecision = Integer.parseInt(props.get(Encoder.MAX_POINT_NUMBER));\n     }\n-  }\n-\n-  private void checkInitialized() {\n-    if (!initialized) {\n-      init();\n-    }\n-  }\n-\n-  private void init() {\n-    sortedTimeValuePairList = memSeries.getSortedTimeValuePairList();\n-    if (!(memSeries instanceof MemSeriesLazyMerger)) {\n-      switch (dataType) {\n-        case FLOAT:\n-          sortedTimeValuePairList.replaceAll(x -> new TimeValuePair(x.getTimestamp(),\n-              new TsFloat(\n-                  MathUtils.roundWithGivenPrecision(x.getValue().getFloat(), floatPrecision))));\n-          break;\n-        case DOUBLE:\n-          sortedTimeValuePairList.replaceAll(x -> new TimeValuePair(x.getTimestamp(),\n-              new TsDouble(\n-                  MathUtils.roundWithGivenPrecision(x.getValue().getDouble(), floatPrecision))));\n-          break;\n-        default:\n-          break;\n-      }\n+    mergeReader = new PriorityMergeReader(floatPrecision);\n+    chunkedReader = new PriorityMergeReader(floatPrecision);\n+    for (TVList pair : memSeries) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MzAxNA==", "bodyText": "replace this with List", "url": "https://github.com/apache/iotdb/pull/753#discussion_r368263014", "createdAt": "2020-01-19T03:32:00Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessor.java", "diffHunk": "@@ -583,28 +587,28 @@ public String getStorageGroupName() {\n       String measurementId, TSDataType dataType, Map<String, String> props, QueryContext context) {\n     flushQueryLock.readLock().lock();\n     try {\n-      MemSeriesLazyMerger memSeriesLazyMerger = new MemSeriesLazyMerger();\n+      List<TVList> tvLists = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MzA5NA==", "bodyText": "If we use a List , this class should not be changed.\nis this a bug before?", "url": "https://github.com/apache/iotdb/pull/753#discussion_r368263094", "createdAt": "2020-01-19T03:33:54Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/reader/universal/PriorityMergeReader.java", "diffHunk": "@@ -42,6 +47,11 @@\n   public PriorityMergeReader() {\n   }\n \n+  public PriorityMergeReader(int floatPrecision) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODI2MzE2NQ==", "bodyText": "if (hasCachedPair || hasNextTimeValuePair) {\nhasCachedPair = false\nreturn cachedTimeValuePair\n} else {\nthrow new IOException(\"no next time value pair\");\n}", "url": "https://github.com/apache/iotdb/pull/753#discussion_r368263165", "createdAt": "2020-01-19T03:36:02Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/utils/datastructure/TVList.java", "diffHunk": "@@ -452,11 +470,62 @@ void updateMinTimeAndSorted(long[] time, int start, int end) {\n     boolean inputSorted = true;\n     for (int i = start; i < end; i++) {\n       inPutMinTime = inPutMinTime <= time[i] ? inPutMinTime : time[i];\n-      if (inputSorted && i < length - 1 && time[i] > time[i+1]) {\n+      if (inputSorted && i < length - 1 && time[i] > time[i + 1]) {\n         inputSorted = false;\n       }\n     }\n     minTime = inPutMinTime < minTime ? inPutMinTime : minTime;\n     sorted = sorted && inputSorted && (size == 0 || inPutMinTime >= getTime(size - 1));\n   }\n+\n+  protected abstract TimeValuePair getTimeValuePair(int index, long time);\n+\n+  public IPointReader getIterator() {\n+    return new Ite();\n+  }\n+\n+  private class Ite implements IPointReader {\n+\n+    private TimeValuePair cachedTimeValuePair;\n+    private boolean hasCachedPair;\n+    private int cur;\n+\n+    @Override\n+    public boolean hasNextTimeValuePair() {\n+      if (hasCachedPair) {\n+        return true;\n+      }\n+\n+      while (cur < size) {\n+        long time = getTime(cur);\n+        if (time < getTimeOffset() || (cur + 1 < size() && (time == getTime(cur + 1)))) {\n+          cur++;\n+          continue;\n+        }\n+        cachedTimeValuePair = getTimeValuePair(cur, time);\n+        hasCachedPair = true;\n+        cur++;\n+        return true;\n+      }\n+      return hasCachedPair;\n+    }\n+\n+    @Override\n+    public TimeValuePair nextTimeValuePair() {\n+      hasCachedPair = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180c0345f998a57f8ff38eabea610d87eeaee2d0"}, "originalPosition": 184}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b26bcc41a356091c90f82f9224eb6d49eecd90a", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/1b26bcc41a356091c90f82f9224eb6d49eecd90a", "committedDate": "2020-01-19T06:06:22Z", "message": "ReadOnlyMemChunk to save one TVList"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTgwMDY5", "url": "https://github.com/apache/iotdb/pull/753#pullrequestreview-344980069", "createdAt": "2020-01-19T06:31:11Z", "commit": {"oid": "1b26bcc41a356091c90f82f9224eb6d49eecd90a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3252, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}