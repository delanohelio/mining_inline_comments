{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1OTg2Njg1", "number": 818, "title": "[IOTDB-482] Vectorized TimeGenerator", "bodyText": "", "createdAt": "2020-02-17T07:47:46Z", "url": "https://github.com/apache/iotdb/pull/818", "merged": true, "mergeCommit": {"oid": "7a161eded61193c0871ade7385f4ec15aa5e62b9"}, "closed": true, "closedAt": "2020-02-18T09:46:44Z", "author": {"login": "liutaohua"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFIc3CAH2gAyMzc1OTg2Njg1OjA1M2Y1ZTA5MTUzNTkzZWExMWE0ZjM1NDU2YzFhMjYwOGUwMzQxOTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFbcyXgH2gAyMzc1OTg2Njg1OjBhYjVhZGFhYjk3ODFiMGE0MTllNDRiMjYwYjI2NGIxZTE3ZjRmMGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "053f5e09153593ea11a4f35456c1a2608e034197", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/053f5e09153593ea11a4f35456c1a2608e034197", "committedDate": "2020-02-17T07:46:28Z", "message": "[IOTDB-482] Vectorized TimeGenerator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/f932713089b92bdf869f7668ed835c3c3eb2daa1", "committedDate": "2020-02-17T07:57:25Z", "message": "add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NTQyNDI0", "url": "https://github.com/apache/iotdb/pull/818#pullrequestreview-359542424", "createdAt": "2020-02-17T07:59:54Z", "commit": {"oid": "053f5e09153593ea11a4f35456c1a2608e034197"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwNzo1OTo1NFrOFqbGSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QwODo0NToyM1rOFqcL5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAyODQ5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class TimeSeries {\n          \n          \n            \n            public class TimeColumn {\n          \n      \n    \n    \n  \n\nWe usually use TimeSeries to represent  time-value, time-value, time-value...", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380028491", "createdAt": "2020-02-17T07:59:54Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/common/TimeSeries.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package org.apache.iotdb.tsfile.read.common;\n+\n+\n+public class TimeSeries {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "053f5e09153593ea11a4f35456c1a2608e034197"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAyOTE2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public boolean hasNext() throws IOException {\n          \n          \n            \n              public boolean hasNextTimeColumn() throws IOException {", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380029162", "createdAt": "2020-02-17T08:01:58Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/timegenerator/EngineLeafNode.java", "diffHunk": "@@ -20,26 +20,27 @@\n package org.apache.iotdb.db.query.timegenerator;\n \n import java.io.IOException;\n-import org.apache.iotdb.tsfile.read.reader.IPointReader;\n+import org.apache.iotdb.tsfile.read.common.TimeSeries;\n+import org.apache.iotdb.tsfile.read.reader.IBatchReader;\n import org.apache.iotdb.tsfile.read.query.timegenerator.node.Node;\n import org.apache.iotdb.tsfile.read.query.timegenerator.node.NodeType;\n \n public class EngineLeafNode implements Node {\n \n-  private IPointReader reader;\n+  private IBatchReader reader;\n \n-  public EngineLeafNode(IPointReader reader) {\n+  public EngineLeafNode(IBatchReader reader) {\n     this.reader = reader;\n   }\n \n   @Override\n   public boolean hasNext() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAyOTI1Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public TimeSeries next() throws IOException {\n          \n          \n            \n              public TimeSeries nextTimeColumn() throws IOException {", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380029256", "createdAt": "2020-02-17T08:02:16Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/timegenerator/EngineLeafNode.java", "diffHunk": "@@ -20,26 +20,27 @@\n package org.apache.iotdb.db.query.timegenerator;\n \n import java.io.IOException;\n-import org.apache.iotdb.tsfile.read.reader.IPointReader;\n+import org.apache.iotdb.tsfile.read.common.TimeSeries;\n+import org.apache.iotdb.tsfile.read.reader.IBatchReader;\n import org.apache.iotdb.tsfile.read.query.timegenerator.node.Node;\n import org.apache.iotdb.tsfile.read.query.timegenerator.node.NodeType;\n \n public class EngineLeafNode implements Node {\n \n-  private IPointReader reader;\n+  private IBatchReader reader;\n \n-  public EngineLeafNode(IPointReader reader) {\n+  public EngineLeafNode(IBatchReader reader) {\n     this.reader = reader;\n   }\n \n   @Override\n   public boolean hasNext() throws IOException {\n-    return reader.hasNextTimeValuePair();\n+    return reader.hasNextBatch();\n   }\n \n   @Override\n-  public long next() throws IOException {\n-    return reader.nextTimeValuePair().getTimestamp();\n+  public TimeSeries next() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzMjIwMQ==", "bodyText": "I prefer to fill the cacheTimes in hasNext.", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380032201", "createdAt": "2020-02-17T08:11:00Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/timegenerator/EngineTimeGenerator.java", "diffHunk": "@@ -51,12 +54,17 @@ private void initNode(QueryContext context) throws StorageEngineException {\n \n   @Override\n   public boolean hasNext() throws IOException {\n-    return operatorNode.hasNext();\n+    return (cacheTimes != null && cacheTimes.hasMoreData()) || operatorNode.hasNext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzMjcwOA==", "bodyText": "I prefer to implement next() like this:\npublic BatchData nextBatch() throws IOException {\nif (hasCachedBatchData || hasNextBatch()) {\nhasCachedBatchData = false;\nreturn batchData;\n}\nthrow new IOException(\"no next batch\");\n}", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380032708", "createdAt": "2020-02-17T08:12:21Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/timegenerator/EngineTimeGenerator.java", "diffHunk": "@@ -51,12 +54,17 @@ private void initNode(QueryContext context) throws StorageEngineException {\n \n   @Override\n   public boolean hasNext() throws IOException {\n-    return operatorNode.hasNext();\n+    return (cacheTimes != null && cacheTimes.hasMoreData()) || operatorNode.hasNext();\n   }\n \n   @Override\n   public long next() throws IOException {\n-    return operatorNode.next();\n+    if (cacheTimes == null || !cacheTimes.hasMoreData()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzMzQwNA==", "bodyText": "could you ensure hasMoreData() ?", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380033404", "createdAt": "2020-02-17T08:14:18Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/timegenerator/EngineTimeGenerator.java", "diffHunk": "@@ -51,12 +54,17 @@ private void initNode(QueryContext context) throws StorageEngineException {\n \n   @Override\n   public boolean hasNext() throws IOException {\n-    return operatorNode.hasNext();\n+    return (cacheTimes != null && cacheTimes.hasMoreData()) || operatorNode.hasNext();\n   }\n \n   @Override\n   public long next() throws IOException {\n-    return operatorNode.next();\n+    if (cacheTimes == null || !cacheTimes.hasMoreData()) {\n+      cacheTimes = operatorNode.next();\n+    }\n+    long currentTime = cacheTimes.currentTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzMzg4MA==", "bodyText": "how about support a nextTimes method?", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380033880", "createdAt": "2020-02-17T08:15:30Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/timegenerator/EngineTimeGenerator.java", "diffHunk": "@@ -51,12 +54,17 @@ private void initNode(QueryContext context) throws StorageEngineException {\n \n   @Override\n   public boolean hasNext() throws IOException {\n-    return operatorNode.hasNext();\n+    return (cacheTimes != null && cacheTimes.hasMoreData()) || operatorNode.hasNext();\n   }\n \n   @Override\n   public long next() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzNDY3MA==", "bodyText": "remove this line", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380034670", "createdAt": "2020-02-17T08:17:34Z", "author": {"login": "qiaojialin"}, "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBEngineTimeGeneratorIT.java", "diffHunk": "@@ -249,7 +249,7 @@ public void testMultiSeriesWithValueFilterAndTimeFilter()\n       long time = timeGenerator.next();\n       assertTrue(satisfyTimeFilter2(time));\n       cnt++;\n-      // System.out.println(\"cnt =\" + cnt + \"; time = \" + time);\n+//       System.out.println(\"cnt =\" + cnt + \"; time = \" + time);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzNTI1Mw==", "bodyText": "the same as TimestampGenerator", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380035253", "createdAt": "2020-02-17T08:19:07Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/TimeGeneratorImpl.java", "diffHunk": "@@ -65,12 +68,17 @@ public TimeGeneratorImpl(IExpression iexpression, IChunkLoader chunkLoader,\n \n   @Override\n   public boolean hasNext() throws IOException {\n-    return operatorNode.hasNext();\n+    return (cacheTimes != null && cacheTimes.hasMoreData()) || operatorNode.hasNext();\n   }\n \n   @Override\n   public long next() throws IOException {\n-    return operatorNode.next();\n+    if (cacheTimes == null || !cacheTimes.hasMoreData()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzODQzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public TimeSeries next() throws IOException {\n          \n          \n            \n              public TimeSeries nextTimes() throws IOException {", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380038431", "createdAt": "2020-02-17T08:26:59Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/LeafNode.java", "diffHunk": "@@ -20,44 +20,28 @@\n \n import java.io.IOException;\n import org.apache.iotdb.tsfile.read.common.BatchData;\n+import org.apache.iotdb.tsfile.read.common.TimeSeries;\n import org.apache.iotdb.tsfile.read.reader.series.AbstractFileSeriesReader;\n \n public class LeafNode implements Node {\n \n   private AbstractFileSeriesReader reader;\n \n-  private BatchData data = null;\n-\n-  private boolean gotData = false;\n+  private BatchData cacheData;\n \n   public LeafNode(AbstractFileSeriesReader reader) {\n     this.reader = reader;\n   }\n \n   @Override\n   public boolean hasNext() throws IOException {\n-\n-    if (gotData) {\n-      data.next();\n-      gotData = false;\n-    }\n-\n-    if (data == null || !data.hasCurrent()) {\n-      if (reader.hasNextBatch()) {\n-        data = reader.nextBatch();\n-      } else {\n-        return false;\n-      }\n-    }\n-\n-    return data.hasCurrent();\n+    return reader.hasNextBatch();\n   }\n \n   @Override\n-  public long next() {\n-    long time = data.currentTime();\n-    gotData = true;\n-    return time;\n+  public TimeSeries next() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzODY2NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              TimeSeries next() throws IOException;\n          \n          \n            \n              TimeSeries nextTimeColumn() throws IOException;", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380038665", "createdAt": "2020-02-17T08:27:31Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/Node.java", "diffHunk": "@@ -19,12 +19,13 @@\n package org.apache.iotdb.tsfile.read.query.timegenerator.node;\n \n import java.io.IOException;\n+import org.apache.iotdb.tsfile.read.common.TimeSeries;\n \n public interface Node {\n \n   boolean hasNext() throws IOException;\n \n-  long next() throws IOException;\n+  TimeSeries next() throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzODczMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              boolean hasNext() throws IOException;\n          \n          \n            \n              boolean hasNextTimeColumn() throws IOException;", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380038731", "createdAt": "2020-02-17T08:27:41Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/Node.java", "diffHunk": "@@ -19,12 +19,13 @@\n package org.apache.iotdb.tsfile.read.query.timegenerator.node;\n \n import java.io.IOException;\n+import org.apache.iotdb.tsfile.read.common.TimeSeries;\n \n public interface Node {\n \n   boolean hasNext() throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzOTIzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private TimeSeries cachedValue;\n          \n          \n            \n              private TimeSeries cachedTimeColumn;", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380039233", "createdAt": "2020-02-17T08:28:53Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/AndNode.java", "diffHunk": "@@ -19,19 +19,24 @@\n package org.apache.iotdb.tsfile.read.query.timegenerator.node;\n \n import java.io.IOException;\n+import org.apache.iotdb.tsfile.read.common.TimeSeries;\n \n public class AndNode implements Node {\n \n   private Node leftChild;\n   private Node rightChild;\n \n-  private long cachedValue;\n+  private TimeSeries cachedValue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzOTM1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private TimeSeries leftPageData;\n          \n          \n            \n              private TimeSeries leftTimeColumn;", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380039354", "createdAt": "2020-02-17T08:29:11Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/AndNode.java", "diffHunk": "@@ -19,19 +19,24 @@\n package org.apache.iotdb.tsfile.read.query.timegenerator.node;\n \n import java.io.IOException;\n+import org.apache.iotdb.tsfile.read.common.TimeSeries;\n \n public class AndNode implements Node {\n \n   private Node leftChild;\n   private Node rightChild;\n \n-  private long cachedValue;\n+  private TimeSeries cachedValue;\n   private boolean hasCachedValue;\n \n+\n+  private TimeSeries leftPageData;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDAzOTQzNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private TimeSeries rightPageData;\n          \n          \n            \n              private TimeSeries rightTimeColumn;", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380039434", "createdAt": "2020-02-17T08:29:24Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/AndNode.java", "diffHunk": "@@ -19,19 +19,24 @@\n package org.apache.iotdb.tsfile.read.query.timegenerator.node;\n \n import java.io.IOException;\n+import org.apache.iotdb.tsfile.read.common.TimeSeries;\n \n public class AndNode implements Node {\n \n   private Node leftChild;\n   private Node rightChild;\n \n-  private long cachedValue;\n+  private TimeSeries cachedValue;\n   private boolean hasCachedValue;\n \n+\n+  private TimeSeries leftPageData;\n+  private TimeSeries rightPageData;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0MDQ0OQ==", "bodyText": "add javadoc: no more data in cache and has more data in child", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380040449", "createdAt": "2020-02-17T08:31:46Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/AndNode.java", "diffHunk": "@@ -45,42 +50,78 @@ public boolean hasNext() throws IOException {\n     if (hasCachedValue) {\n       return true;\n     }\n-    if (leftChild.hasNext() && rightChild.hasNext()) {\n-      long leftValue = leftChild.next();\n-      long rightValue = rightChild.next();\n-      while (true) {\n-        if (leftValue == rightValue) {\n-          this.hasCachedValue = true;\n-          this.cachedValue = leftValue;\n-          return true;\n-        } else if (leftValue > rightValue) {\n-          if (rightChild.hasNext()) {\n-            rightValue = rightChild.next();\n-          } else {\n-            return false;\n-          }\n-        } else { // leftValue < rightValue\n-          if (leftChild.hasNext()) {\n-            leftValue = leftChild.next();\n-          } else {\n-            return false;\n-          }\n+    cachedValue = new TimeSeries(1000);\n+    //fill data\n+    fillLeftData();\n+    fillRightData();\n+    /*\n+     *  [1,2,3,4,5]   <-   that was stopBatchTime mean\n+     *  [1,2,3,4,5,6]\n+     */\n+    long stopBatchTime = getStopBatchTime();\n+\n+    while (leftPageData.hasMoreData() && rightPageData.hasMoreData()) {\n+      long leftValue = leftPageData.currentTime();\n+      long rightValue = rightPageData.currentTime();\n+      if (leftValue == rightValue) {\n+        this.hasCachedValue = true;\n+        this.cachedValue.add(leftValue);\n+        leftPageData.next();\n+        rightPageData.next();\n+      } else if (leftValue > rightValue) {\n+        rightPageData.next();\n+      } else { // leftValue < rightValue\n+        leftPageData.next();\n+      }\n+\n+      if (leftValue > stopBatchTime && rightValue > stopBatchTime) {\n+        if (hasCachedValue) {\n+          break;\n         }\n       }\n+      /*\n+       *  [1,2,3,4,5]   <-   reFill data and cal stopBatchTime\n+       *             [6,7,8,9,10,11]\n+       */\n+      fillLeftData();\n+      fillRightData();\n+      stopBatchTime = getStopBatchTime();\n     }\n-    return false;\n+    return hasCachedValue;\n+  }\n+\n+  private long getStopBatchTime() {\n+    long rMax = leftPageData.getLastTime();\n+    long lMax = rightPageData.getLastTime();\n+    return rMax > lMax ? lMax : rMax;\n+  }\n+\n+  private void fillRightData() throws IOException {\n+    if (hasMoreData(rightPageData, rightChild)) {\n+      rightPageData = rightChild.next();\n+    }\n+  }\n+\n+  private void fillLeftData() throws IOException {\n+    if (hasMoreData(leftPageData, leftChild)) {\n+      leftPageData = leftChild.next();\n+    }\n+  }\n+\n+  private boolean hasMoreData(TimeSeries timeSeries, Node child) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NjA2OQ==", "bodyText": "this seems to be update again and again, consider the following case:\nleft child:  [1,2,3]  [4,5,6] [7,8,9]...\nright child: [1,2,3,4]  [5,6,7,8] [9,10,11]...\nI suggest to stop at 4 in this next(), only call one getStopBatchTime at the beginning.", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380046069", "createdAt": "2020-02-17T08:44:53Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/AndNode.java", "diffHunk": "@@ -45,42 +50,78 @@ public boolean hasNext() throws IOException {\n     if (hasCachedValue) {\n       return true;\n     }\n-    if (leftChild.hasNext() && rightChild.hasNext()) {\n-      long leftValue = leftChild.next();\n-      long rightValue = rightChild.next();\n-      while (true) {\n-        if (leftValue == rightValue) {\n-          this.hasCachedValue = true;\n-          this.cachedValue = leftValue;\n-          return true;\n-        } else if (leftValue > rightValue) {\n-          if (rightChild.hasNext()) {\n-            rightValue = rightChild.next();\n-          } else {\n-            return false;\n-          }\n-        } else { // leftValue < rightValue\n-          if (leftChild.hasNext()) {\n-            leftValue = leftChild.next();\n-          } else {\n-            return false;\n-          }\n+    cachedValue = new TimeSeries(1000);\n+    //fill data\n+    fillLeftData();\n+    fillRightData();\n+    /*\n+     *  [1,2,3,4,5]   <-   that was stopBatchTime mean\n+     *  [1,2,3,4,5,6]\n+     */\n+    long stopBatchTime = getStopBatchTime();\n+\n+    while (leftPageData.hasMoreData() && rightPageData.hasMoreData()) {\n+      long leftValue = leftPageData.currentTime();\n+      long rightValue = rightPageData.currentTime();\n+      if (leftValue == rightValue) {\n+        this.hasCachedValue = true;\n+        this.cachedValue.add(leftValue);\n+        leftPageData.next();\n+        rightPageData.next();\n+      } else if (leftValue > rightValue) {\n+        rightPageData.next();\n+      } else { // leftValue < rightValue\n+        leftPageData.next();\n+      }\n+\n+      if (leftValue > stopBatchTime && rightValue > stopBatchTime) {\n+        if (hasCachedValue) {\n+          break;\n         }\n       }\n+      /*\n+       *  [1,2,3,4,5]   <-   reFill data and cal stopBatchTime\n+       *             [6,7,8,9,10,11]\n+       */\n+      fillLeftData();\n+      fillRightData();\n+      stopBatchTime = getStopBatchTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA0NjMwOA==", "bodyText": "if stop time is 4, the time 5 seems could be cached at this round", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380046308", "createdAt": "2020-02-17T08:45:23Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/AndNode.java", "diffHunk": "@@ -45,42 +50,78 @@ public boolean hasNext() throws IOException {\n     if (hasCachedValue) {\n       return true;\n     }\n-    if (leftChild.hasNext() && rightChild.hasNext()) {\n-      long leftValue = leftChild.next();\n-      long rightValue = rightChild.next();\n-      while (true) {\n-        if (leftValue == rightValue) {\n-          this.hasCachedValue = true;\n-          this.cachedValue = leftValue;\n-          return true;\n-        } else if (leftValue > rightValue) {\n-          if (rightChild.hasNext()) {\n-            rightValue = rightChild.next();\n-          } else {\n-            return false;\n-          }\n-        } else { // leftValue < rightValue\n-          if (leftChild.hasNext()) {\n-            leftValue = leftChild.next();\n-          } else {\n-            return false;\n-          }\n+    cachedValue = new TimeSeries(1000);\n+    //fill data\n+    fillLeftData();\n+    fillRightData();\n+    /*\n+     *  [1,2,3,4,5]   <-   that was stopBatchTime mean\n+     *  [1,2,3,4,5,6]\n+     */\n+    long stopBatchTime = getStopBatchTime();\n+\n+    while (leftPageData.hasMoreData() && rightPageData.hasMoreData()) {\n+      long leftValue = leftPageData.currentTime();\n+      long rightValue = rightPageData.currentTime();\n+      if (leftValue == rightValue) {\n+        this.hasCachedValue = true;\n+        this.cachedValue.add(leftValue);\n+        leftPageData.next();\n+        rightPageData.next();\n+      } else if (leftValue > rightValue) {\n+        rightPageData.next();\n+      } else { // leftValue < rightValue\n+        leftPageData.next();\n+      }\n+\n+      if (leftValue > stopBatchTime && rightValue > stopBatchTime) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f932713089b92bdf869f7668ed835c3c3eb2daa1"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee12a4149f05aebba4c7e8a5780cbf85e6a8085c", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/ee12a4149f05aebba4c7e8a5780cbf85e6a8085c", "committedDate": "2020-02-17T10:10:31Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd8e0d08ff27c9f5a29d4e9dfea1e424ebd8c2c4", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/fd8e0d08ff27c9f5a29d4e9dfea1e424ebd8c2c4", "committedDate": "2020-02-17T10:37:04Z", "message": "review change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8ce5d29df0de7c1e65b2757085a58fcf3c0ce4d", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/b8ce5d29df0de7c1e65b2757085a58fcf3c0ce4d", "committedDate": "2020-02-17T10:37:46Z", "message": "Merge branch 'new_series_reader' of https://github.com/apache/incubator-iotdb into batch_time_generator\n\n\u0001 Conflicts:\n\u0001\ttsfile/src/test/java/org/apache/iotdb/tsfile/read/ReadTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4834efd207763ff04879c446d7b61c2b6d263751", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/4834efd207763ff04879c446d7b61c2b6d263751", "committedDate": "2020-02-17T10:50:06Z", "message": "fix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1a49b29849b4d1856f314f48d444fe8e9da146c", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/f1a49b29849b4d1856f314f48d444fe8e9da146c", "committedDate": "2020-02-17T10:58:06Z", "message": "add comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4728e702b8c8b92f31199f71a498bc506369de2c", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/4728e702b8c8b92f31199f71a498bc506369de2c", "committedDate": "2020-02-17T11:20:04Z", "message": "Optimize AndNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61ba9dfeafb51c8425d5636331c3de7ff719224f", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/61ba9dfeafb51c8425d5636331c3de7ff719224f", "committedDate": "2020-02-17T11:25:20Z", "message": "revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7cca8a346709e02dec6ffeb38aa4daef019d5c0", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/e7cca8a346709e02dec6ffeb38aa4daef019d5c0", "committedDate": "2020-02-17T11:35:03Z", "message": "fix stop time bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NjcwNTY5", "url": "https://github.com/apache/iotdb/pull/818#pullrequestreview-359670569", "createdAt": "2020-02-17T11:34:00Z", "commit": {"oid": "61ba9dfeafb51c8425d5636331c3de7ff719224f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNDowMFrOFqhWKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMTozNjo1MVrOFqha-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMDg1Nw==", "bodyText": "This unused import could be removed", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380130857", "createdAt": "2020-02-17T11:34:00Z", "author": {"login": "samperson1997"}, "path": "server/src/main/java/org/apache/iotdb/db/query/timegenerator/EngineNodeConstructor.java", "diffHunk": "@@ -25,6 +25,7 @@\n import org.apache.iotdb.db.metadata.MManager;\n import org.apache.iotdb.db.query.context.QueryContext;\n import org.apache.iotdb.db.query.control.QueryResourceManager;\n+import org.apache.iotdb.db.query.reader.series.SeriesRawDataBatchReader;\n import org.apache.iotdb.db.query.reader.series.SeriesRawDataPointReader;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61ba9dfeafb51c8425d5636331c3de7ff719224f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMTQ4MA==", "bodyText": "How about changing to getTimeColumn, as all the naming in this method", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380131480", "createdAt": "2020-02-17T11:35:33Z", "author": {"login": "samperson1997"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/common/BatchData.java", "diffHunk": "@@ -515,6 +515,14 @@ public long getMaxTimestamp() {\n     return getTimeByIndex(length() - 1);\n   }\n \n+  public TimeColumn getTimeSeries() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61ba9dfeafb51c8425d5636331c3de7ff719224f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzMjA4OQ==", "bodyText": "This constructor is not used?", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380132089", "createdAt": "2020-02-17T11:36:51Z", "author": {"login": "samperson1997"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/common/TimeColumn.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.tsfile.read.common;\n+\n+\n+public class TimeColumn {\n+\n+  private long[] times;\n+\n+  private int size;\n+\n+  private int cur;\n+\n+\n+  public TimeColumn(int initSize) {\n+    times = new long[initSize];\n+  }\n+\n+\n+  public TimeColumn(long[] times) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61ba9dfeafb51c8425d5636331c3de7ff719224f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0017c2e64a8d8632261c5a8115611bbc60a24eef", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/0017c2e64a8d8632261c5a8115611bbc60a24eef", "committedDate": "2020-02-17T11:55:36Z", "message": "rename getTimeSeries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NjkzODQw", "url": "https://github.com/apache/iotdb/pull/818#pullrequestreview-359693840", "createdAt": "2020-02-17T12:17:42Z", "commit": {"oid": "0017c2e64a8d8632261c5a8115611bbc60a24eef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMjoxNzo0M1rOFqieWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMzowNDowMlrOFqjt7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE0OTMzNw==", "bodyText": "Actually, I can't get the meaning of AbstractNodeConstructor. Why we need constructNotSeriesNode() and construct() these two methods. These two methods call each other iteratively. I think we can combine these two to reduce the meaningless function call costs.", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380149337", "createdAt": "2020-02-17T12:17:43Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/timegenerator/EngineNodeConstructor.java", "diffHunk": "@@ -19,22 +19,22 @@\n \n package org.apache.iotdb.db.query.timegenerator;\n \n+import static org.apache.iotdb.tsfile.read.expression.ExpressionType.SERIES;\n+\n import org.apache.iotdb.db.engine.querycontext.QueryDataSource;\n import org.apache.iotdb.db.exception.StorageEngineException;\n import org.apache.iotdb.db.exception.path.PathException;\n import org.apache.iotdb.db.metadata.MManager;\n import org.apache.iotdb.db.query.context.QueryContext;\n import org.apache.iotdb.db.query.control.QueryResourceManager;\n-import org.apache.iotdb.db.query.reader.series.SeriesRawDataPointReader;\n+import org.apache.iotdb.db.query.reader.series.SeriesRawDataBatchReader;\n import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n import org.apache.iotdb.tsfile.read.common.Path;\n import org.apache.iotdb.tsfile.read.expression.IExpression;\n import org.apache.iotdb.tsfile.read.expression.impl.SingleSeriesExpression;\n import org.apache.iotdb.tsfile.read.filter.basic.Filter;\n import org.apache.iotdb.tsfile.read.query.timegenerator.node.Node;\n \n-import static org.apache.iotdb.tsfile.read.expression.ExpressionType.SERIES;\n-\n public class EngineNodeConstructor extends AbstractNodeConstructor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0017c2e64a8d8632261c5a8115611bbc60a24eef"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1MTEyOQ==", "bodyText": "I think the logic here should be same as TimeGeneratorImpl in tsfile, hasCache should not be set to false directly. It may be better to be set to cacheTimes.hasNext();", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380151129", "createdAt": "2020-02-17T12:21:51Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/timegenerator/EngineTimeGenerator.java", "diffHunk": "@@ -51,12 +55,32 @@ private void initNode(QueryContext context) throws StorageEngineException {\n \n   @Override\n   public boolean hasNext() throws IOException {\n-    return operatorNode.hasNext();\n+    if (hasCache) {\n+      return true;\n+    }\n+    if (cacheTimes != null && cacheTimes.hasMoreData()) {\n+      hasCache = true;\n+      return true;\n+    }\n+    while (operatorNode.hasNextTimeColumn()) {\n+      cacheTimes = operatorNode.nextTimeColumn();\n+      if (cacheTimes != null && cacheTimes.hasMoreData()) {\n+        hasCache = true;\n+        break;\n+      }\n+    }\n+    return hasCache;\n   }\n \n   @Override\n   public long next() throws IOException {\n-    return operatorNode.next();\n+    if (hasCache || hasNext()) {\n+      hasCache = false;\n+      long currentTime = cacheTimes.currentTime();\n+      cacheTimes.next();\n+      return currentTime;\n+    }\n+    throw new IOException(\"no more data\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0017c2e64a8d8632261c5a8115611bbc60a24eef"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1NTU4Mg==", "bodyText": "Here can be replaced by Math.min(); It will be more readable", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380155582", "createdAt": "2020-02-17T12:32:04Z", "author": {"login": "JackieTien97"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/AndNode.java", "diffHunk": "@@ -41,46 +46,90 @@ public AndNode(Node leftChild, Node rightChild) {\n   }\n \n   @Override\n-  public boolean hasNext() throws IOException {\n+  public boolean hasNextTimeColumn() throws IOException {\n     if (hasCachedValue) {\n       return true;\n     }\n-    if (leftChild.hasNext() && rightChild.hasNext()) {\n-      long leftValue = leftChild.next();\n-      long rightValue = rightChild.next();\n-      while (true) {\n-        if (leftValue == rightValue) {\n-          this.hasCachedValue = true;\n-          this.cachedValue = leftValue;\n-          return true;\n-        } else if (leftValue > rightValue) {\n-          if (rightChild.hasNext()) {\n-            rightValue = rightChild.next();\n-          } else {\n-            return false;\n-          }\n-        } else { // leftValue < rightValue\n-          if (leftChild.hasNext()) {\n-            leftValue = leftChild.next();\n-          } else {\n-            return false;\n-          }\n+    cachedTimeColumn = new TimeColumn(1000);\n+    //fill data\n+    fillLeftData();\n+    fillRightData();\n+    /*\n+     *  [1,2,3,4,5]   <-   that was stopBatchTime mean\n+     *  [1,2,3,4,5,6]\n+     */\n+    long stopBatchTime = getStopBatchTime();\n+\n+    while (leftTimeColumn.hasMoreData() && rightTimeColumn.hasMoreData()) {\n+      long leftValue = leftTimeColumn.currentTime();\n+      long rightValue = rightTimeColumn.currentTime();\n+\n+      if (leftValue == rightValue) {\n+        this.hasCachedValue = true;\n+        this.cachedTimeColumn.add(leftValue);\n+        leftTimeColumn.next();\n+        rightTimeColumn.next();\n+      } else if (leftValue > rightValue) {\n+        rightTimeColumn.next();\n+      } else { // leftValue < rightValue\n+        leftTimeColumn.next();\n+      }\n+\n+      if (leftValue == stopBatchTime || rightValue == stopBatchTime) {\n+        if (hasCachedValue) {\n+          break;\n         }\n       }\n+      /*\n+       *  [1,2,3,4,5]   <-   reFill data and cal stopBatchTime\n+       *             [6,7,8,9,10,11]\n+       */\n+      fillLeftData();\n+      fillRightData();\n+      stopBatchTime = getStopBatchTime();\n+    }\n+    return hasCachedValue;\n+  }\n+\n+  private long getStopBatchTime() {\n+    long rMax = Long.MAX_VALUE;\n+    long lMax = Long.MAX_VALUE;\n+    if (leftTimeColumn.hasMoreData()) {\n+      lMax = leftTimeColumn.getLastTime();\n     }\n-    return false;\n+    if (rightTimeColumn.hasMoreData()) {\n+      rMax = rightTimeColumn.getLastTime();\n+    }\n+    return rMax > lMax ? lMax : rMax;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0017c2e64a8d8632261c5a8115611bbc60a24eef"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE1Nzc4MA==", "bodyText": "Why we need this field. Why not set a fixed size for cachedTimeColumn", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380157780", "createdAt": "2020-02-17T12:37:05Z", "author": {"login": "JackieTien97"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/AndNode.java", "diffHunk": "@@ -41,46 +46,90 @@ public AndNode(Node leftChild, Node rightChild) {\n   }\n \n   @Override\n-  public boolean hasNext() throws IOException {\n+  public boolean hasNextTimeColumn() throws IOException {\n     if (hasCachedValue) {\n       return true;\n     }\n-    if (leftChild.hasNext() && rightChild.hasNext()) {\n-      long leftValue = leftChild.next();\n-      long rightValue = rightChild.next();\n-      while (true) {\n-        if (leftValue == rightValue) {\n-          this.hasCachedValue = true;\n-          this.cachedValue = leftValue;\n-          return true;\n-        } else if (leftValue > rightValue) {\n-          if (rightChild.hasNext()) {\n-            rightValue = rightChild.next();\n-          } else {\n-            return false;\n-          }\n-        } else { // leftValue < rightValue\n-          if (leftChild.hasNext()) {\n-            leftValue = leftChild.next();\n-          } else {\n-            return false;\n-          }\n+    cachedTimeColumn = new TimeColumn(1000);\n+    //fill data\n+    fillLeftData();\n+    fillRightData();\n+    /*\n+     *  [1,2,3,4,5]   <-   that was stopBatchTime mean\n+     *  [1,2,3,4,5,6]\n+     */\n+    long stopBatchTime = getStopBatchTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0017c2e64a8d8632261c5a8115611bbc60a24eef"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE2OTcxMQ==", "bodyText": "use Math.max()", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380169711", "createdAt": "2020-02-17T13:04:02Z", "author": {"login": "JackieTien97"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/OrNode.java", "diffHunk": "@@ -19,80 +19,119 @@\n package org.apache.iotdb.tsfile.read.query.timegenerator.node;\n \n import java.io.IOException;\n+import org.apache.iotdb.tsfile.read.common.TimeColumn;\n \n public class OrNode implements Node {\n \n   private Node leftChild;\n   private Node rightChild;\n \n-  private boolean hasCachedLeftValue;\n-  private long cachedLeftValue;\n-  private boolean hasCachedRightValue;\n-  private long cachedRightValue;\n+  private TimeColumn leftTimes;\n+  private TimeColumn rightTimes;\n+\n+  private TimeColumn cachedValue;\n+  private boolean hasCachedValue;\n+\n \n   public OrNode(Node leftChild, Node rightChild) {\n     this.leftChild = leftChild;\n     this.rightChild = rightChild;\n-    this.hasCachedLeftValue = false;\n-    this.hasCachedRightValue = false;\n   }\n \n   @Override\n-  public boolean hasNext() throws IOException {\n-    if (hasCachedLeftValue || hasCachedRightValue) {\n+  public boolean hasNextTimeColumn() throws IOException {\n+    if (hasCachedValue) {\n       return true;\n     }\n-    return leftChild.hasNext() || rightChild.hasNext();\n-  }\n \n-  private boolean hasLeftValue() throws IOException {\n-    return hasCachedLeftValue || leftChild.hasNext();\n+    return leftChild.hasNextTimeColumn() || rightChild.hasNextTimeColumn()\n+        || leftTimes.hasMoreData() || rightTimes.hasMoreData();\n   }\n \n-  private long getLeftValue() throws IOException {\n-    if (hasCachedLeftValue) {\n-      hasCachedLeftValue = false;\n-      return cachedLeftValue;\n+  @Override\n+  public TimeColumn nextTimeColumn() throws IOException {\n+    if (hasCachedValue) {\n+      hasCachedValue = false;\n+      return cachedValue;\n     }\n-    return leftChild.next();\n-  }\n-\n-  private boolean hasRightValue() throws IOException {\n-    return hasCachedRightValue || rightChild.hasNext();\n-  }\n+    hasCachedValue = false;\n+    cachedValue = new TimeColumn(1000);\n \n-  private long getRightValue() throws IOException {\n-    if (hasCachedRightValue) {\n-      hasCachedRightValue = false;\n-      return cachedRightValue;\n+    if (!hasLeftValue() && leftChild.hasNextTimeColumn()) {\n+      leftTimes = leftChild.nextTimeColumn();\n+    }\n+    if (!hasRightValue() && rightChild.hasNextTimeColumn()) {\n+      rightTimes = rightChild.nextTimeColumn();\n     }\n-    return rightChild.next();\n-  }\n \n-  @Override\n-  public long next() throws IOException {\n     if (hasLeftValue() && !hasRightValue()) {\n-      return getLeftValue();\n+      return leftTimes;\n     } else if (!hasLeftValue() && hasRightValue()) {\n-      return getRightValue();\n-    } else if (hasLeftValue() && hasRightValue()) {\n-      long leftValue = getLeftValue();\n-      long rightValue = getRightValue();\n+      return rightTimes;\n+    }\n+\n+    long stopBatchTime = getStopBatchTime();\n+\n+    while (hasLeftValue() && hasRightValue()) {\n+      long leftValue = leftTimes.currentTime();\n+      long rightValue = rightTimes.currentTime();\n+\n       if (leftValue < rightValue) {\n-        hasCachedRightValue = true;\n-        cachedRightValue = rightValue;\n-        return leftValue;\n+        hasCachedValue = true;\n+        cachedValue.add(leftValue);\n+        leftTimes.next();\n+        if (!leftTimes.hasMoreData() && leftChild.hasNextTimeColumn()) {\n+          leftTimes = leftChild.nextTimeColumn();\n+        }\n       } else if (leftValue > rightValue) {\n-        hasCachedLeftValue = true;\n-        cachedLeftValue = leftValue;\n-        return rightValue;\n+        hasCachedValue = true;\n+        cachedValue.add(rightValue);\n+        rightTimes.next();\n+        if (!rightTimes.hasMoreData() && rightChild.hasNextTimeColumn()) {\n+          rightTimes = rightChild.nextTimeColumn();\n+        }\n       } else {\n-        return leftValue;\n+        hasCachedValue = true;\n+        cachedValue.add(leftValue);\n+        leftTimes.next();\n+        rightTimes.next();\n+        if (!leftTimes.hasMoreData() && leftChild.hasNextTimeColumn()) {\n+          leftTimes = leftChild.nextTimeColumn();\n+        }\n+        if (!rightTimes.hasMoreData() && rightChild.hasNextTimeColumn()) {\n+          rightTimes = rightChild.nextTimeColumn();\n+        }\n+      }\n+\n+      if (leftValue > stopBatchTime && rightValue > stopBatchTime) {\n+        break;\n       }\n     }\n-    return -1;\n+    hasCachedValue = false;\n+    return cachedValue;\n+  }\n+\n+  private long getStopBatchTime() {\n+    long rMax = Long.MAX_VALUE;\n+    long lMax = Long.MAX_VALUE;\n+    if (leftTimes.hasMoreData()) {\n+      lMax = leftTimes.getLastTime();\n+    }\n+    if (rightTimes.hasMoreData()) {\n+      rMax = rightTimes.getLastTime();\n+    }\n+    return rMax > lMax ? lMax : rMax;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0017c2e64a8d8632261c5a8115611bbc60a24eef"}, "originalPosition": 148}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "501e4fb9ff17be9bf15a34c925dbe46e530376ff", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/501e4fb9ff17be9bf15a34c925dbe46e530376ff", "committedDate": "2020-02-17T14:43:16Z", "message": "del AbstractNodeConstructor and add fetchSize config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMDE3MTgz", "url": "https://github.com/apache/iotdb/pull/818#pullrequestreview-360017183", "createdAt": "2020-02-18T00:48:16Z", "commit": {"oid": "501e4fb9ff17be9bf15a34c925dbe46e530376ff"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwMDo0ODoxNlrOFqyV_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwMDo0OTozNlrOFqyW1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQwOTM0MA==", "bodyText": "This magic number can be replaced by a constant.", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380409340", "createdAt": "2020-02-18T00:48:16Z", "author": {"login": "JackieTien97"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/AndNode.java", "diffHunk": "@@ -41,46 +50,68 @@ public AndNode(Node leftChild, Node rightChild) {\n   }\n \n   @Override\n-  public boolean hasNext() throws IOException {\n+  public boolean hasNextTimeColumn() throws IOException {\n     if (hasCachedValue) {\n       return true;\n     }\n-    if (leftChild.hasNext() && rightChild.hasNext()) {\n-      long leftValue = leftChild.next();\n-      long rightValue = rightChild.next();\n-      while (true) {\n-        if (leftValue == rightValue) {\n-          this.hasCachedValue = true;\n-          this.cachedValue = leftValue;\n-          return true;\n-        } else if (leftValue > rightValue) {\n-          if (rightChild.hasNext()) {\n-            rightValue = rightChild.next();\n-          } else {\n-            return false;\n-          }\n-        } else { // leftValue < rightValue\n-          if (leftChild.hasNext()) {\n-            leftValue = leftChild.next();\n-          } else {\n-            return false;\n-          }\n+    cachedTimeColumn = new TimeColumn(1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "501e4fb9ff17be9bf15a34c925dbe46e530376ff"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQwOTU1Ng==", "bodyText": "The same magic number here. You can use a constant and put it into Node.java", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380409556", "createdAt": "2020-02-18T00:49:36Z", "author": {"login": "JackieTien97"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/OrNode.java", "diffHunk": "@@ -19,80 +19,109 @@\n package org.apache.iotdb.tsfile.read.query.timegenerator.node;\n \n import java.io.IOException;\n+import org.apache.iotdb.tsfile.common.conf.TSFileDescriptor;\n+import org.apache.iotdb.tsfile.read.common.TimeColumn;\n \n public class OrNode implements Node {\n \n+  private final int fetchSize = TSFileDescriptor.getInstance().getConfig()\n+      .getFetchSizeOfTimeGenerator();\n+\n   private Node leftChild;\n   private Node rightChild;\n \n-  private boolean hasCachedLeftValue;\n-  private long cachedLeftValue;\n-  private boolean hasCachedRightValue;\n-  private long cachedRightValue;\n+  private TimeColumn leftTimeColumn;\n+  private TimeColumn rightTimeColumn;\n+\n+  private TimeColumn cachedTimeColumn;\n+  private boolean hasCachedValue;\n+\n \n   public OrNode(Node leftChild, Node rightChild) {\n     this.leftChild = leftChild;\n     this.rightChild = rightChild;\n-    this.hasCachedLeftValue = false;\n-    this.hasCachedRightValue = false;\n   }\n \n   @Override\n-  public boolean hasNext() throws IOException {\n-    if (hasCachedLeftValue || hasCachedRightValue) {\n+  public boolean hasNextTimeColumn() throws IOException {\n+    if (hasCachedValue) {\n       return true;\n     }\n-    return leftChild.hasNext() || rightChild.hasNext();\n-  }\n \n-  private boolean hasLeftValue() throws IOException {\n-    return hasCachedLeftValue || leftChild.hasNext();\n+    return leftChild.hasNextTimeColumn() || rightChild.hasNextTimeColumn()\n+        || leftTimeColumn.hasCurrent() || rightTimeColumn.hasCurrent();\n   }\n \n-  private long getLeftValue() throws IOException {\n-    if (hasCachedLeftValue) {\n-      hasCachedLeftValue = false;\n-      return cachedLeftValue;\n+  @Override\n+  public TimeColumn nextTimeColumn() throws IOException {\n+    if (hasCachedValue) {\n+      hasCachedValue = false;\n+      return cachedTimeColumn;\n     }\n-    return leftChild.next();\n-  }\n+    hasCachedValue = false;\n+    cachedTimeColumn = new TimeColumn(1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "501e4fb9ff17be9bf15a34c925dbe46e530376ff"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aeb7698db38f407e891d9b17740f01d7b305057", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/2aeb7698db38f407e891d9b17740f01d7b305057", "committedDate": "2020-02-18T01:56:44Z", "message": "use BatchSize replace FetchSizeOfTimeGenerator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMDMzMDI2", "url": "https://github.com/apache/iotdb/pull/818#pullrequestreview-360033026", "createdAt": "2020-02-18T02:04:52Z", "commit": {"oid": "2aeb7698db38f407e891d9b17740f01d7b305057"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwMjowNDo1M1rOFqzLgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwMjowNDo1M1rOFqzLgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQyMzA0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      properties.getProperty(\"fetch_size_time_generator\",\n          \n          \n            \n                      properties.getProperty(\"batch_size\",", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380423040", "createdAt": "2020-02-18T02:04:53Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/common/conf/TSFileDescriptor.java", "diffHunk": "@@ -128,6 +130,9 @@ private void loadProps() {\n       conf.setTimeEncoder(properties.getProperty(\"time_encoder\", conf.getTimeEncoder()));\r\n       conf.setValueEncoder(properties.getProperty(\"value_encoder\", conf.getValueEncoder()));\r\n       conf.setCompressor(properties.getProperty(\"compressor\", conf.getCompressor()));\r\n+      conf.setFetchSizeOfTimeGenerator(Integer.parseInt(\r\n+          properties.getProperty(\"fetch_size_time_generator\",\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2aeb7698db38f407e891d9b17740f01d7b305057"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e7f605fb4ecc1d051a095198ced621d59162123", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/1e7f605fb4ecc1d051a095198ced621d59162123", "committedDate": "2020-02-18T02:12:27Z", "message": "rename fetchSizeOfTimeGenerator to batchSize"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMDU4MTU1", "url": "https://github.com/apache/iotdb/pull/818#pullrequestreview-360058155", "createdAt": "2020-02-18T03:55:49Z", "commit": {"oid": "1e7f605fb4ecc1d051a095198ced621d59162123"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwMzo1NTo1MFrOFq0dww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwMzo1NTo1MFrOFq0dww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ0NDA5OQ==", "bodyText": "this field is unsless now", "url": "https://github.com/apache/iotdb/pull/818#discussion_r380444099", "createdAt": "2020-02-18T03:55:50Z", "author": {"login": "qiaojialin"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/query/timegenerator/node/OrNode.java", "diffHunk": "@@ -19,80 +19,109 @@\n package org.apache.iotdb.tsfile.read.query.timegenerator.node;\n \n import java.io.IOException;\n+import org.apache.iotdb.tsfile.common.conf.TSFileDescriptor;\n+import org.apache.iotdb.tsfile.read.common.TimeColumn;\n \n public class OrNode implements Node {\n \n+  private final int fetchSize = TSFileDescriptor.getInstance().getConfig()\n+      .getBatchSize();\n+\n   private Node leftChild;\n   private Node rightChild;\n \n-  private boolean hasCachedLeftValue;\n-  private long cachedLeftValue;\n-  private boolean hasCachedRightValue;\n-  private long cachedRightValue;\n+  private TimeColumn leftTimeColumn;\n+  private TimeColumn rightTimeColumn;\n+\n+  private TimeColumn cachedTimeColumn;\n+  private boolean hasCachedValue;\n+\n \n   public OrNode(Node leftChild, Node rightChild) {\n     this.leftChild = leftChild;\n     this.rightChild = rightChild;\n-    this.hasCachedLeftValue = false;\n-    this.hasCachedRightValue = false;\n   }\n \n   @Override\n-  public boolean hasNext() throws IOException {\n-    if (hasCachedLeftValue || hasCachedRightValue) {\n+  public boolean hasNextTimeColumn() throws IOException {\n+    if (hasCachedValue) {\n       return true;\n     }\n-    return leftChild.hasNext() || rightChild.hasNext();\n-  }\n \n-  private boolean hasLeftValue() throws IOException {\n-    return hasCachedLeftValue || leftChild.hasNext();\n+    return leftChild.hasNextTimeColumn() || rightChild.hasNextTimeColumn()\n+        || leftTimeColumn.hasCurrent() || rightTimeColumn.hasCurrent();\n   }\n \n-  private long getLeftValue() throws IOException {\n-    if (hasCachedLeftValue) {\n-      hasCachedLeftValue = false;\n-      return cachedLeftValue;\n+  @Override\n+  public TimeColumn nextTimeColumn() throws IOException {\n+    if (hasCachedValue) {\n+      hasCachedValue = false;\n+      return cachedTimeColumn;\n     }\n-    return leftChild.next();\n-  }\n+    hasCachedValue = false;\n+    cachedTimeColumn = new TimeColumn(fetchSize);\n \n-  private boolean hasRightValue() throws IOException {\n-    return hasCachedRightValue || rightChild.hasNext();\n-  }\n-\n-  private long getRightValue() throws IOException {\n-    if (hasCachedRightValue) {\n-      hasCachedRightValue = false;\n-      return cachedRightValue;\n+    if (!hasLeftValue() && leftChild.hasNextTimeColumn()) {\n+      leftTimeColumn = leftChild.nextTimeColumn();\n+    }\n+    if (!hasRightValue() && rightChild.hasNextTimeColumn()) {\n+      rightTimeColumn = rightChild.nextTimeColumn();\n     }\n-    return rightChild.next();\n-  }\n \n-  @Override\n-  public long next() throws IOException {\n     if (hasLeftValue() && !hasRightValue()) {\n-      return getLeftValue();\n+      return leftTimeColumn;\n     } else if (!hasLeftValue() && hasRightValue()) {\n-      return getRightValue();\n-    } else if (hasLeftValue() && hasRightValue()) {\n-      long leftValue = getLeftValue();\n-      long rightValue = getRightValue();\n+      return rightTimeColumn;\n+    }\n+\n+    while (hasLeftValue() && hasRightValue()) {\n+      long leftValue = leftTimeColumn.currentTime();\n+      long rightValue = rightTimeColumn.currentTime();\n+\n       if (leftValue < rightValue) {\n-        hasCachedRightValue = true;\n-        cachedRightValue = rightValue;\n-        return leftValue;\n+        hasCachedValue = true;\n+        cachedTimeColumn.add(leftValue);\n+        leftTimeColumn.next();\n+        if (!leftTimeColumn.hasCurrent() && leftChild.hasNextTimeColumn()) {\n+          leftTimeColumn = leftChild.nextTimeColumn();\n+        }\n       } else if (leftValue > rightValue) {\n-        hasCachedLeftValue = true;\n-        cachedLeftValue = leftValue;\n-        return rightValue;\n+        hasCachedValue = true;\n+        cachedTimeColumn.add(rightValue);\n+        rightTimeColumn.next();\n+        if (!rightTimeColumn.hasCurrent() && rightChild.hasNextTimeColumn()) {\n+          rightTimeColumn = rightChild.nextTimeColumn();\n+        }\n       } else {\n-        return leftValue;\n+        hasCachedValue = true;\n+        cachedTimeColumn.add(leftValue);\n+        leftTimeColumn.next();\n+        rightTimeColumn.next();\n+        if (!leftTimeColumn.hasCurrent() && leftChild.hasNextTimeColumn()) {\n+          leftTimeColumn = leftChild.nextTimeColumn();\n+        }\n+        if (!rightTimeColumn.hasCurrent() && rightChild.hasNextTimeColumn()) {\n+          rightTimeColumn = rightChild.nextTimeColumn();\n+        }\n+      }\n+\n+      if (cachedTimeColumn.size() >= fetchSize) {\n+        break;\n       }\n     }\n-    return -1;\n+    hasCachedValue = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e7f605fb4ecc1d051a095198ced621d59162123"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad26a2328e4ba14e7bf0f80e4d816252a03fe4d6", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/ad26a2328e4ba14e7bf0f80e4d816252a03fe4d6", "committedDate": "2020-02-18T04:26:14Z", "message": "rename and abstract TimeGenerator, combine LeafNode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMDgzMjA3", "url": "https://github.com/apache/iotdb/pull/818#pullrequestreview-360083207", "createdAt": "2020-02-18T05:48:36Z", "commit": {"oid": "ad26a2328e4ba14e7bf0f80e4d816252a03fe4d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ab5adaab9781b0a419e44b260b264b1e17f4f0c", "author": {"user": null}, "url": "https://github.com/apache/iotdb/commit/0ab5adaab9781b0a419e44b260b264b1e17f4f0c", "committedDate": "2020-02-18T05:54:35Z", "message": "remove unused cache in AbstractFileSeriesReader"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3087, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}