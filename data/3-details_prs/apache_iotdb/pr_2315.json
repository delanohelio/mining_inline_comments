{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NjQwMzY4", "number": 2315, "title": "[IOTDB-1069] restrict the flushing memtable number to avoid OOM when mem_control is disabled", "bodyText": "To reproduce this bug,\nset JVM memory size to 32GB,\ntsfile_size_threshold=268435456\nmemtable_size_threshold=268435456\nenable_mem_control=false\nand insert 200 timeseries to IoTDB.\nThis pr restricts the flushing memtable size in one TsfileProcessor to one.", "createdAt": "2020-12-23T08:14:48Z", "url": "https://github.com/apache/iotdb/pull/2315", "merged": true, "mergeCommit": {"oid": "af1da9dae5736d062f3cdc4f94f14a71ec83c5c5"}, "closed": true, "closedAt": "2020-12-31T07:35:19Z", "author": {"login": "HTHou"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdo6dipAH2gAyNTQ0NjQwMzY4OmY2MjEzNmYzMzYzZGI4NDY5ZmRmY2UzZTczNDg1NDUxODZkYjU4YTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdre4nNAFqTU2MDI4Mjg5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f62136f3363db8469fdfce3e7348545186db58a1", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/f62136f3363db8469fdfce3e7348545186db58a1", "committedDate": "2020-12-23T08:00:58Z", "message": "restrict flushing memtable number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07df497cbf34cedf124f595eb77a62b2698f7363", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/07df497cbf34cedf124f595eb77a62b2698f7363", "committedDate": "2020-12-23T08:25:11Z", "message": "restrict flushing memtable number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4999691988258a889002eb2fe535e3091a752bbc", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/4999691988258a889002eb2fe535e3091a752bbc", "committedDate": "2020-12-23T08:42:06Z", "message": "fix code smells"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "000ba5a54acc3a770bc0f9592fd7c4c7f4123542", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/000ba5a54acc3a770bc0f9592fd7c4c7f4123542", "committedDate": "2020-12-24T05:04:12Z", "message": "fix flushing memtable size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d314b79577e20ffd7ed3d53b34d58ba20857c64", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/2d314b79577e20ffd7ed3d53b34d58ba20857c64", "committedDate": "2020-12-24T06:09:54Z", "message": "fix code smell"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a86fcfbb663e89a425694fc58c0d23fb4001e30a", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/a86fcfbb663e89a425694fc58c0d23fb4001e30a", "committedDate": "2020-12-24T06:27:42Z", "message": "fix synchronized"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4d2c5d02027fe1a6fcd17aa6c0ac7b605657911", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/c4d2c5d02027fe1a6fcd17aa6c0ac7b605657911", "committedDate": "2020-12-25T00:58:37Z", "message": "change 1000 to 100"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a3e48195fd804d2057747e5884e13cbe111e646", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/1a3e48195fd804d2057747e5884e13cbe111e646", "committedDate": "2020-12-25T06:04:12Z", "message": "add max memtable number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ebc3272dac83ad25052545369de515b2474c1d5", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/6ebc3272dac83ad25052545369de515b2474c1d5", "committedDate": "2020-12-25T08:43:05Z", "message": "change max memtable number to 0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e113ff9fb4f752349b977ae84482ec58ba0b3a12", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/e113ff9fb4f752349b977ae84482ec58ba0b3a12", "committedDate": "2020-12-25T09:09:38Z", "message": "add synchronized"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8b6411fd9d382807faa6bb8f393d8c9c5f3a7b4", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/e8b6411fd9d382807faa6bb8f393d8c9c5f3a7b4", "committedDate": "2020-12-25T15:11:34Z", "message": "add memtable manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc710bd67bcf47b2199717559d27a7fefa7f4f3", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/4fc710bd67bcf47b2199717559d27a7fefa7f4f3", "committedDate": "2020-12-26T07:18:05Z", "message": "fix name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTA1NTMw", "url": "https://github.com/apache/iotdb/pull/2315#pullrequestreview-558905530", "createdAt": "2020-12-27T06:01:35Z", "commit": {"oid": "4fc710bd67bcf47b2199717559d27a7fefa7f4f3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QwNjowMTozNlrOILolYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QwNjowMTozNlrOILolYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA3MDE3Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // wait until the size of flushingMemTables is less than 2\n          \n          \n            \n                  // wait until the total number of memtable is less than the system capacity", "url": "https://github.com/apache/iotdb/pull/2315#discussion_r549070176", "createdAt": "2020-12-27T06:01:36Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.rescon;\n+\n+import org.apache.iotdb.db.conf.IoTDBConfig;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.memtable.IMemTable;\n+import org.apache.iotdb.db.engine.memtable.PrimitiveMemTable;\n+import org.apache.iotdb.db.engine.storagegroup.TsFileResource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+public class MemTableManager {\n+\n+  private static final IoTDBConfig CONFIG = IoTDBDescriptor.getInstance().getConfig();\n+\n+  private static final Logger logger = LoggerFactory.getLogger(MemTableManager.class);\n+\n+  private static final int WAIT_TIME = 100;\n+  public static final int MEMTABLE_NUM_FOR_EACH_PARTITION = 4;\n+  private int currentMemtableNumber = 0;\n+\n+  private MemTableManager() {\n+  }\n+\n+  public static MemTableManager getInstance() {\n+    return InstanceHolder.INSTANCE;\n+  }\n+\n+  /**\n+   * Called when memory control is disabled\n+   */\n+  public synchronized IMemTable getAvailableMemTable(TsFileResource tsFileResource) {\n+    if (!reachMaxMemtableNumber()) {\n+      currentMemtableNumber++;\n+      return new PrimitiveMemTable();\n+    } else {\n+      // wait until the size of flushingMemTables is less than 2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fc710bd67bcf47b2199717559d27a7fefa7f4f3"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "102df092a6134e44976ab4a43b5bf9ed7db2ecc6", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/102df092a6134e44976ab4a43b5bf9ed7db2ecc6", "committedDate": "2020-12-27T06:01:43Z", "message": "Update server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fac3a19d5cd8115ae233f2bf0123da3c98139a5", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/3fac3a19d5cd8115ae233f2bf0123da3c98139a5", "committedDate": "2020-12-27T06:58:28Z", "message": "fix wait"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52bcdef9fc775023a97ccd5ce74034d727c7fa22", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/52bcdef9fc775023a97ccd5ce74034d727c7fa22", "committedDate": "2020-12-27T07:06:19Z", "message": "code smell"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1032423db1f178d9f5ab2e990f128923c7b08f63", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/1032423db1f178d9f5ab2e990f128923c7b08f63", "committedDate": "2020-12-28T09:15:14Z", "message": "fix review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c0c1193a64846651ce03c9e5f755afb3e5f7f1f", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/2c0c1193a64846651ce03c9e5f755afb3e5f7f1f", "committedDate": "2020-12-29T06:46:42Z", "message": "fix concurrent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwMjgyODk3", "url": "https://github.com/apache/iotdb/pull/2315#pullrequestreview-560282897", "createdAt": "2020-12-31T07:34:58Z", "commit": {"oid": "2c0c1193a64846651ce03c9e5f755afb3e5f7f1f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3964, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}