{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NjQ0MTg5", "number": 2317, "title": "[To rel/0.11] [IOTDB-1069] restrict the flushing memtable number to avoid OOM when mem_control is disabled ", "bodyText": "Same as #2315", "createdAt": "2020-12-23T08:24:28Z", "url": "https://github.com/apache/iotdb/pull/2317", "merged": true, "mergeCommit": {"oid": "5afe2920d32a42b1adfd98161127e495f08d963d"}, "closed": true, "closedAt": "2020-12-27T06:00:35Z", "author": {"login": "HTHou"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdo6vOegH2gAyNTQ0NjQ0MTg5OmY5NzgwYTkzNzBmYzQ2ZjEyY2VlMGM1NDU2MGI2ODY5M2U4MzFmZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqK9cUgH2gAyNTQ0NjQ0MTg5OjhiMTdhNjI4ODUzNmFmOTI1NGI2MjI0ODFiZTRlZjU2OGJjZDZjODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f9780a9370fc46f12cee0c54560b68693e831fe7", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/f9780a9370fc46f12cee0c54560b68693e831fe7", "committedDate": "2020-12-23T08:20:17Z", "message": "restrict flushing memtable number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db70c362929c10d326c9047ca1ba90a1705f46ef", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/db70c362929c10d326c9047ca1ba90a1705f46ef", "committedDate": "2020-12-23T08:23:28Z", "message": "restrict flushing memtable number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "360750937d282f47de4264df66e041caaa7afd59", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/360750937d282f47de4264df66e041caaa7afd59", "committedDate": "2020-12-24T01:38:16Z", "message": "fix code smells"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa02e4ef5185057477f0d9ceff57cc8c41da5e78", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/fa02e4ef5185057477f0d9ceff57cc8c41da5e78", "committedDate": "2020-12-24T05:01:43Z", "message": "fix flushing memtable size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2cca41e7227c000547ea4fb5813af6684cd8170", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/c2cca41e7227c000547ea4fb5813af6684cd8170", "committedDate": "2020-12-24T06:08:57Z", "message": "fix code smell"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d6d89ead67e5bdd4a6a935f1c29974be070d2fe", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/3d6d89ead67e5bdd4a6a935f1c29974be070d2fe", "committedDate": "2020-12-24T06:28:25Z", "message": "fix synchronized"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "921ac8af1afd790e313d48d1b75da9e6e91d9163", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/921ac8af1afd790e313d48d1b75da9e6e91d9163", "committedDate": "2020-12-25T00:59:31Z", "message": "change 1000 to 100"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e67c336ad1fa1b511dbb760b0de2054395c512f6", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/e67c336ad1fa1b511dbb760b0de2054395c512f6", "committedDate": "2020-12-25T05:49:18Z", "message": "add max memtable number"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd833f52775ffdb4a3ed9fe467f51b291c602362", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/dd833f52775ffdb4a3ed9fe467f51b291c602362", "committedDate": "2020-12-25T08:45:49Z", "message": "change max memtable number to 0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "888c769eaf7d06fd4e4174250f3c8db00e2beb02", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/888c769eaf7d06fd4e4174250f3c8db00e2beb02", "committedDate": "2020-12-25T09:08:35Z", "message": "add synchronized"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0084d06d8255f422bc790e251cc81be8edbfd2", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/bd0084d06d8255f422bc790e251cc81be8edbfd2", "committedDate": "2020-12-25T16:25:36Z", "message": "add memtable manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eeb002ce00e2bad7975633f87ca373d7259fa72", "author": {"user": {"login": "HTHou", "name": "Haonan"}}, "url": "https://github.com/apache/iotdb/commit/6eeb002ce00e2bad7975633f87ca373d7259fa72", "committedDate": "2020-12-26T07:19:02Z", "message": "fix name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTA1MDg1", "url": "https://github.com/apache/iotdb/pull/2317#pullrequestreview-558905085", "createdAt": "2020-12-27T05:47:07Z", "commit": {"oid": "6eeb002ce00e2bad7975633f87ca373d7259fa72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QwNTo0NzowN1rOILohEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yN1QwNTo0NzowN1rOILohEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA2OTA3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // wait until the size of flushingMemTables is less than 2\n          \n          \n            \n                  // wait until the total memtable number is less than the capacity of the system", "url": "https://github.com/apache/iotdb/pull/2317#discussion_r549069072", "createdAt": "2020-12-27T05:47:07Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.rescon;\n+\n+import org.apache.iotdb.db.conf.IoTDBConfig;\n+import org.apache.iotdb.db.conf.IoTDBDescriptor;\n+import org.apache.iotdb.db.engine.memtable.IMemTable;\n+import org.apache.iotdb.db.engine.memtable.PrimitiveMemTable;\n+import org.apache.iotdb.db.engine.storagegroup.TsFileResource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+public class MemTableManager {\n+\n+  private static final IoTDBConfig CONFIG = IoTDBDescriptor.getInstance().getConfig();\n+\n+  private static final Logger logger = LoggerFactory.getLogger(MemTableManager.class);\n+\n+  private static final int WAIT_TIME = 100;\n+  public static final int MEMTABLE_NUM_FOR_EACH_PARTITION = 4;\n+  private int currentMemtableNumber = 0;\n+\n+  private MemTableManager() {\n+  }\n+\n+  public static MemTableManager getInstance() {\n+    return InstanceHolder.INSTANCE;\n+  }\n+\n+  /**\n+   * Called when memory control is disabled\n+   */\n+  public synchronized IMemTable getAvailableMemTable(TsFileResource tsFileResource) {\n+    if (!reachMaxMemtableNumber()) {\n+      currentMemtableNumber++;\n+      return new PrimitiveMemTable();\n+    } else {\n+      // wait until the size of flushingMemTables is less than 2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6eeb002ce00e2bad7975633f87ca373d7259fa72"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTA1MTE2", "url": "https://github.com/apache/iotdb/pull/2317#pullrequestreview-558905116", "createdAt": "2020-12-27T05:48:01Z", "commit": {"oid": "6eeb002ce00e2bad7975633f87ca373d7259fa72"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b17a6288536af9254b622481be4ef568bcd6c84", "author": {"user": {"login": "qiaojialin", "name": "Jialin Qiao"}}, "url": "https://github.com/apache/iotdb/commit/8b17a6288536af9254b622481be4ef568bcd6c84", "committedDate": "2020-12-27T05:48:13Z", "message": "Update server/src/main/java/org/apache/iotdb/db/rescon/MemTableManager.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3967, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}