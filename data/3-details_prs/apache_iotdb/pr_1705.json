{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxODk5NzY0", "number": 1705, "title": "[IOTDB-873] Add count devices DDL", "bodyText": "", "createdAt": "2020-09-08T09:09:57Z", "url": "https://github.com/apache/iotdb/pull/1705", "merged": true, "mergeCommit": {"oid": "62f009c83ff26abe7bf87a6117258c0a8f11b3d3"}, "closed": true, "closedAt": "2020-09-10T11:33:32Z", "author": {"login": "yanhongwangg"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGzz1CgH2gAyNDgxODk5NzY0OmM4MGFjYjQyZGQ4MDVlM2Y3ZGIwZWQyOTNhMWRiNzI3N2MxZjNhNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHenqpgFqTQ4NTgxMzIwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c80acb42dd805e3f7db0ed293a1db7277c1f3a76", "author": {"user": {"login": "yanhongwangg", "name": "yanhong wang"}}, "url": "https://github.com/apache/iotdb/commit/c80acb42dd805e3f7db0ed293a1db7277c1f3a76", "committedDate": "2020-09-08T09:02:33Z", "message": "[IOTDB-873] Add count devices DDL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db2e468109f9f506c62ef137511c1d171c3632c3", "author": {"user": {"login": "yanhongwangg", "name": "yanhong wang"}}, "url": "https://github.com/apache/iotdb/commit/db2e468109f9f506c62ef137511c1d171c3632c3", "committedDate": "2020-09-08T10:05:41Z", "message": "[IOTDB-873] Make sure it is a prefix path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f49ba52f85b76b5f4d904470281de1ce3909f250", "author": {"user": {"login": "yanhongwangg", "name": "yanhong wang"}}, "url": "https://github.com/apache/iotdb/commit/f49ba52f85b76b5f4d904470281de1ce3909f250", "committedDate": "2020-09-08T12:49:46Z", "message": "[IOTDB-873] fix IoTDBMetadataFetchIT and MTree"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjE0NzMz", "url": "https://github.com/apache/iotdb/pull/1705#pullrequestreview-484614733", "createdAt": "2020-09-09T02:13:54Z", "commit": {"oid": "f49ba52f85b76b5f4d904470281de1ce3909f250"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMjoxMzo1NFrOHO0Jrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMjoxMzo1NFrOHO0Jrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI5NjU1OA==", "bodyText": "code format\n}else{   ->  } else {\nif( !deviceAdded){    ->   if (!deviceAdded) {\nplease use google style format: http://iotdb.apache.org/zh/Development/ContributeGuide.html", "url": "https://github.com/apache/iotdb/pull/1705#discussion_r485296558", "createdAt": "2020-09-09T02:13:54Z", "author": {"login": "neuyilan"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -695,6 +708,38 @@ private int getCount(MNode node, String[] nodes, int idx) throws MetadataExcepti\n     }\n   }\n \n+  /**\n+   * Traverse the MTree to get the count of devices.\n+   */\n+  private int getDevicesCount(MNode node, String[] nodes, int idx) throws MetadataException {\n+    String nodeReg = MetaUtils.getNodeRegByIdx(idx, nodes);\n+    int cnt = 0;\n+    if (!(PATH_WILDCARD).equals(nodeReg)) {\n+      if (node.hasChild(nodeReg)) {\n+        if (node.getChild(nodeReg) instanceof MeasurementMNode && idx >= nodes.length) {\n+          cnt++;\n+        } else {\n+          cnt += getDevicesCount(node.getChild(nodeReg), nodes, idx + 1);\n+        }\n+      }\n+    } else {\n+      boolean deviceAdded = false;\n+      for (MNode child : node.getChildren().values()) {\n+        if (child instanceof MeasurementMNode ) {\n+          if( !deviceAdded){\n+            cnt++;\n+            deviceAdded = true;\n+          }else{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f49ba52f85b76b5f4d904470281de1ce3909f250"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjE3OTk1", "url": "https://github.com/apache/iotdb/pull/1705#pullrequestreview-484617995", "createdAt": "2020-09-09T02:24:45Z", "commit": {"oid": "f49ba52f85b76b5f4d904470281de1ce3909f250"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d3fb198c9387fbdaa0c58d836e340b7091671d6", "author": {"user": {"login": "yanhongwangg", "name": "yanhong wang"}}, "url": "https://github.com/apache/iotdb/commit/7d3fb198c9387fbdaa0c58d836e340b7091671d6", "committedDate": "2020-09-09T02:27:34Z", "message": "[IOTDB-873] code format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0Njk5Nzcx", "url": "https://github.com/apache/iotdb/pull/1705#pullrequestreview-484699771", "createdAt": "2020-09-09T06:36:32Z", "commit": {"oid": "7d3fb198c9387fbdaa0c58d836e340b7091671d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MDAyNTEy", "url": "https://github.com/apache/iotdb/pull/1705#pullrequestreview-485002512", "createdAt": "2020-09-09T13:23:08Z", "commit": {"oid": "7d3fb198c9387fbdaa0c58d836e340b7091671d6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMzoyMzowOFrOHPHGDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMzoyNzozMFrOHPHSpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwNjkyNQ==", "bodyText": "Hi, we support subdevice like \"root.sg.device1.subdevice1.sensor1\" while subdevice1 is a measurementNode and a device. In your case, the subdevice1 will be ignored.\nYou can refer to the Mtree.findDevice() method.", "url": "https://github.com/apache/iotdb/pull/1705#discussion_r485606925", "createdAt": "2020-09-09T13:23:08Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/metadata/MTree.java", "diffHunk": "@@ -695,6 +708,38 @@ private int getCount(MNode node, String[] nodes, int idx) throws MetadataExcepti\n     }\n   }\n \n+  /**\n+   * Traverse the MTree to get the count of devices.\n+   */\n+  private int getDevicesCount(MNode node, String[] nodes, int idx) throws MetadataException {\n+    String nodeReg = MetaUtils.getNodeRegByIdx(idx, nodes);\n+    int cnt = 0;\n+    if (!(PATH_WILDCARD).equals(nodeReg)) {\n+      if (node.hasChild(nodeReg)) {\n+        if (node.getChild(nodeReg) instanceof MeasurementMNode && idx >= nodes.length) {\n+          cnt++;\n+        } else {\n+          cnt += getDevicesCount(node.getChild(nodeReg), nodes, idx + 1);\n+        }\n+      }\n+    } else {\n+      boolean deviceAdded = false;\n+      for (MNode child : node.getChildren().values()) {\n+        if (child instanceof MeasurementMNode) {\n+          if (!deviceAdded) {\n+            cnt++;\n+            deviceAdded = true;\n+          } else {\n+            break;\n+          }\n+        } else {\n+          cnt += getDevicesCount(child, nodes, idx + 1);\n+        }\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d3fb198c9387fbdaa0c58d836e340b7091671d6"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwOTY5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  logger.error(\"insertSQL failed\", e);\n          \n          \n            \n                  logger.error(\"insertSQL() failed\", e);", "url": "https://github.com/apache/iotdb/pull/1705#discussion_r485609691", "createdAt": "2020-09-09T13:26:52Z", "author": {"login": "Alima777"}, "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBMetadataFetchIT.java", "diffHunk": "@@ -53,7 +56,7 @@ private static void insertSQL() throws ClassNotFoundException, SQLException {\n         statement.execute(sql);\n       }\n     } catch (Exception e) {\n-      e.printStackTrace();\n+      logger.error(\"insertSQL failed\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d3fb198c9387fbdaa0c58d836e340b7091671d6"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYxMDE1MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      logger.error(\"showTimeseriesTest failed\", e);\n          \n          \n            \n                      logger.error(\"showTimeseriesTest() failed\", e);\n          \n      \n    \n    \n  \n\nOthers same :D", "url": "https://github.com/apache/iotdb/pull/1705#discussion_r485610150", "createdAt": "2020-09-09T13:27:30Z", "author": {"login": "Alima777"}, "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBMetadataFetchIT.java", "diffHunk": "@@ -118,7 +121,7 @@ public void showTimeseriesTest() throws ClassNotFoundException, SQLException {\n           }\n           Assert.assertEquals(standard, builder.toString());\n         } catch (SQLException e) {\n-          e.printStackTrace();\n+          logger.error(\"showTimeseriesTest failed\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d3fb198c9387fbdaa0c58d836e340b7091671d6"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7292a2ffc6477c031fdc5f9a1021d4da33022fc", "author": {"user": {"login": "yanhongwangg", "name": "yanhong wang"}}, "url": "https://github.com/apache/iotdb/commit/d7292a2ffc6477c031fdc5f9a1021d4da33022fc", "committedDate": "2020-09-10T03:13:49Z", "message": "[IOTDB-873] Modify to support subdevice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f4d6b988fd5868ffe8dadbd083993dbbb586407", "author": {"user": {"login": "yanhongwangg", "name": "yanhong wang"}}, "url": "https://github.com/apache/iotdb/commit/4f4d6b988fd5868ffe8dadbd083993dbbb586407", "committedDate": "2020-09-10T03:20:41Z", "message": "[IOTDB-873]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fd467214ad90b4ca66f3d640429ee49e5a80de3", "author": {"user": {"login": "yanhongwangg", "name": "yanhong wang"}}, "url": "https://github.com/apache/iotdb/commit/9fd467214ad90b4ca66f3d640429ee49e5a80de3", "committedDate": "2020-09-10T03:40:54Z", "message": "[IOTDB-873]"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjA4NzU3", "url": "https://github.com/apache/iotdb/pull/1705#pullrequestreview-485608757", "createdAt": "2020-09-10T06:11:24Z", "commit": {"oid": "9fd467214ad90b4ca66f3d640429ee49e5a80de3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1ODEzMjA1", "url": "https://github.com/apache/iotdb/pull/1705#pullrequestreview-485813205", "createdAt": "2020-09-10T10:55:11Z", "commit": {"oid": "9fd467214ad90b4ca66f3d640429ee49e5a80de3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3797, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}