{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1ODg4OTk5", "number": 2352, "reviewThreads": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwODozMzoxOVrOFKPxmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwMTo1NTowMlrOFN9Alw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2Mjg4NTM5OnYy", "diffSide": "RIGHT", "path": "jdbc/src/main/java/org/apache/iotdb/jdbc/IoTDBStatement.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwODozMzoxOVrOIM7fcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwODozMzoxOVrOIM7fcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQyODUzMA==", "bodyText": "better to add a comment to indicate the unit is second.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r550428530", "createdAt": "2020-12-31T08:33:19Z", "author": {"login": "JackieTien97"}, "path": "jdbc/src/main/java/org/apache/iotdb/jdbc/IoTDBStatement.java", "diffHunk": "@@ -48,7 +48,7 @@\n   private ResultSet resultSet = null;\n   private IoTDBConnection connection;\n   private int fetchSize;\n-  private int queryTimeout = 10;\n+  private int queryTimeout = 60;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2Mjg4Nzc5OnYy", "diffSide": "RIGHT", "path": "server/src/assembly/resources/conf/iotdb-engine.properties", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwODozNDo1OFrOIM7gtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwODozNDo1OFrOIM7gtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQyODg1NQ==", "bodyText": "Specify the unit in comment.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r550428855", "createdAt": "2020-12-31T08:34:58Z", "author": {"login": "JackieTien97"}, "path": "server/src/assembly/resources/conf/iotdb-engine.properties", "diffHunk": "@@ -367,6 +367,9 @@ compaction_thread_num=10\n # The limit of write throughput merge can reach per second\n merge_write_throughput_mb_per_sec=8\n \n+# The max executing time of query.\n+query_time_threshold=60000", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODA2Mjc3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjowMTozOVrOINjtYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwOToyNzoxN1rOINqmbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA4NzQ1Ng==", "bodyText": "killQuery function will change the map while iterating the map keyset. This may cause ConcurrentModificationException.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551087456", "createdAt": "2021-01-04T02:01:39Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -319,6 +331,25 @@ private void operateCreateSnapshot() {\n     IoTDB.metaManager.createMTreeSnapshot();\n   }\n \n+  private void operateKillQuery(KillQueryPlan killQueryPlan) throws QueryIdNotExsitException {\n+    QueryTimeManager queryTimeManager = QueryTimeManager.getInstance();\n+    if (killQueryPlan.getQueryId() != -1) {\n+      if (queryTimeManager.getQueryThreadMap().get(killQueryPlan.getQueryId()) != null) {\n+        queryTimeManager.killQuery(killQueryPlan.getQueryId());\n+      } else {\n+        throw new QueryIdNotExsitException(String\n+            .format(\"Query Id %d is not exist, please check it.\", killQueryPlan.getQueryId()));\n+      }\n+    } else {\n+      // if queryId is not specified, kill all running queries\n+      if (!queryTimeManager.getQueryThreadMap().isEmpty()) {\n+        for (Long queryId : queryTimeManager.getQueryThreadMap().keySet()) {\n+          queryTimeManager.killQuery(queryId);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIwMDM2Ng==", "bodyText": "Fixed. Thanks for the reminder.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551200366", "createdAt": "2021-01-04T09:27:17Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -319,6 +331,25 @@ private void operateCreateSnapshot() {\n     IoTDB.metaManager.createMTreeSnapshot();\n   }\n \n+  private void operateKillQuery(KillQueryPlan killQueryPlan) throws QueryIdNotExsitException {\n+    QueryTimeManager queryTimeManager = QueryTimeManager.getInstance();\n+    if (killQueryPlan.getQueryId() != -1) {\n+      if (queryTimeManager.getQueryThreadMap().get(killQueryPlan.getQueryId()) != null) {\n+        queryTimeManager.killQuery(killQueryPlan.getQueryId());\n+      } else {\n+        throw new QueryIdNotExsitException(String\n+            .format(\"Query Id %d is not exist, please check it.\", killQueryPlan.getQueryId()));\n+      }\n+    } else {\n+      // if queryId is not specified, kill all running queries\n+      if (!queryTimeManager.getQueryThreadMap().isEmpty()) {\n+        for (Long queryId : queryTimeManager.getQueryThreadMap().keySet()) {\n+          queryTimeManager.killQuery(queryId);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA4NzQ1Ng=="}, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODA3MzYyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryTimeManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoxMToxNlrOINjy8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwOTo0ODozMVrOINrRpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA4ODg4Mw==", "bodyText": "It will have some parallel errors. If I manually do the kill operation after the if statement has been judged, then my kill operation will successfully remove it from map, but the scheduled thread will cause nullpointerexception in the killQuery function, vice versa.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551088883", "createdAt": "2021-01-04T02:11:16Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryTimeManager.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.iotdb.db.concurrent.IoTDBThreadPoolFactory;\n+import org.apache.iotdb.db.exception.query.QueryTimeoutRuntimeException;\n+import org.apache.iotdb.db.service.IService;\n+import org.apache.iotdb.db.service.ServiceType;\n+import org.apache.iotdb.tsfile.utils.Pair;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class is used to monitor the executing time of each query.\n+ * </p>\n+ * Once one is over the threshold, it will be killed and return the time out exception.\n+ */\n+public class QueryTimeManager implements IService {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(QueryTimeManager.class);\n+\n+  /**\n+   * the key of queryStartTimeMap is the query id and the value of queryStartTimeMap is the start\n+   * time and the sql of this query.\n+   */\n+  private Map<Long, Pair<Long, String>> queryInfoMap;\n+  /**\n+   * the key of queryThreadMap is the query id and the value of queryThreadMap is the executing\n+   * thread of this query.\n+   * Only main thread is put in this map since the sub threads are maintained by the thread pool.\n+   * The thread allocated for readTask will change every time, so we have to access this map\n+   * frequently, which will lead to big performance cost.\n+   */\n+  private Map<Long, Thread> queryThreadMap;\n+\n+  private ScheduledExecutorService executorService;\n+\n+  private QueryTimeManager() {\n+    queryInfoMap = new ConcurrentHashMap<>();\n+    queryThreadMap = new ConcurrentHashMap<>();\n+    executorService = IoTDBThreadPoolFactory.newScheduledThreadPool(1,\n+        \"query-time-manager\");\n+  }\n+\n+  public void registerQuery(long queryId, long startTime, String sql, long timeout,\n+      Thread queryThread) {\n+    queryInfoMap.put(queryId, new Pair<>(startTime, sql));\n+    queryThreadMap.put(queryId, queryThread);\n+    // submit a scheduled task to judge whether query is still running after timeout\n+    executorService.schedule(() -> {\n+      if (queryThreadMap.get(queryId) != null) {\n+        killQuery(queryId);\n+        logger.error(String.format(\"Query is time out with queryId %d\", queryId));\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA4OTA0MQ==", "bodyText": "You should try the computeIfPresent() function, it can guarantee atomicity.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551089041", "createdAt": "2021-01-04T02:12:21Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryTimeManager.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.iotdb.db.concurrent.IoTDBThreadPoolFactory;\n+import org.apache.iotdb.db.exception.query.QueryTimeoutRuntimeException;\n+import org.apache.iotdb.db.service.IService;\n+import org.apache.iotdb.db.service.ServiceType;\n+import org.apache.iotdb.tsfile.utils.Pair;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class is used to monitor the executing time of each query.\n+ * </p>\n+ * Once one is over the threshold, it will be killed and return the time out exception.\n+ */\n+public class QueryTimeManager implements IService {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(QueryTimeManager.class);\n+\n+  /**\n+   * the key of queryStartTimeMap is the query id and the value of queryStartTimeMap is the start\n+   * time and the sql of this query.\n+   */\n+  private Map<Long, Pair<Long, String>> queryInfoMap;\n+  /**\n+   * the key of queryThreadMap is the query id and the value of queryThreadMap is the executing\n+   * thread of this query.\n+   * Only main thread is put in this map since the sub threads are maintained by the thread pool.\n+   * The thread allocated for readTask will change every time, so we have to access this map\n+   * frequently, which will lead to big performance cost.\n+   */\n+  private Map<Long, Thread> queryThreadMap;\n+\n+  private ScheduledExecutorService executorService;\n+\n+  private QueryTimeManager() {\n+    queryInfoMap = new ConcurrentHashMap<>();\n+    queryThreadMap = new ConcurrentHashMap<>();\n+    executorService = IoTDBThreadPoolFactory.newScheduledThreadPool(1,\n+        \"query-time-manager\");\n+  }\n+\n+  public void registerQuery(long queryId, long startTime, String sql, long timeout,\n+      Thread queryThread) {\n+    queryInfoMap.put(queryId, new Pair<>(startTime, sql));\n+    queryThreadMap.put(queryId, queryThread);\n+    // submit a scheduled task to judge whether query is still running after timeout\n+    executorService.schedule(() -> {\n+      if (queryThreadMap.get(queryId) != null) {\n+        killQuery(queryId);\n+        logger.error(String.format(\"Query is time out with queryId %d\", queryId));\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA4ODg4Mw=="}, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxMTQzMA==", "bodyText": "Fixed. Thanks.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551211430", "createdAt": "2021-01-04T09:48:31Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryTimeManager.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.iotdb.db.concurrent.IoTDBThreadPoolFactory;\n+import org.apache.iotdb.db.exception.query.QueryTimeoutRuntimeException;\n+import org.apache.iotdb.db.service.IService;\n+import org.apache.iotdb.db.service.ServiceType;\n+import org.apache.iotdb.tsfile.utils.Pair;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class is used to monitor the executing time of each query.\n+ * </p>\n+ * Once one is over the threshold, it will be killed and return the time out exception.\n+ */\n+public class QueryTimeManager implements IService {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(QueryTimeManager.class);\n+\n+  /**\n+   * the key of queryStartTimeMap is the query id and the value of queryStartTimeMap is the start\n+   * time and the sql of this query.\n+   */\n+  private Map<Long, Pair<Long, String>> queryInfoMap;\n+  /**\n+   * the key of queryThreadMap is the query id and the value of queryThreadMap is the executing\n+   * thread of this query.\n+   * Only main thread is put in this map since the sub threads are maintained by the thread pool.\n+   * The thread allocated for readTask will change every time, so we have to access this map\n+   * frequently, which will lead to big performance cost.\n+   */\n+  private Map<Long, Thread> queryThreadMap;\n+\n+  private ScheduledExecutorService executorService;\n+\n+  private QueryTimeManager() {\n+    queryInfoMap = new ConcurrentHashMap<>();\n+    queryThreadMap = new ConcurrentHashMap<>();\n+    executorService = IoTDBThreadPoolFactory.newScheduledThreadPool(1,\n+        \"query-time-manager\");\n+  }\n+\n+  public void registerQuery(long queryId, long startTime, String sql, long timeout,\n+      Thread queryThread) {\n+    queryInfoMap.put(queryId, new Pair<>(startTime, sql));\n+    queryThreadMap.put(queryId, queryThread);\n+    // submit a scheduled task to judge whether query is still running after timeout\n+    executorService.schedule(() -> {\n+      if (queryThreadMap.get(queryId) != null) {\n+        killQuery(queryId);\n+        logger.error(String.format(\"Query is time out with queryId %d\", queryId));\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA4ODg4Mw=="}, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODA4Njg3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/NonAlignEngineDataSet.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyMTo0OVrOINj54Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyMTo0OVrOINj54Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA5MDY1Nw==", "bodyText": "The static method interrupted() in Thread class will clear the interrupt flag, you should call the instance method isInterrupted().", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551090657", "createdAt": "2021-01-04T02:21:49Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/NonAlignEngineDataSet.java", "diffHunk": "@@ -286,6 +293,11 @@ public TSQueryNonAlignDataSet fillBuffer(int fetchSize, WatermarkEncoder encoder\n \n     for (int seriesIndex = 0; seriesIndex < seriesNum; seriesIndex++) {\n       if (!noMoreDataInQueueArray[seriesIndex]) {\n+        // check the interrupted status of main thread before take next batch\n+        if (Thread.interrupted()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODA5MTMxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/RawQueryDataSetWithoutValueFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyNToyN1rOINj8Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyNToyN1rOINj8Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA5MTI1NQ==", "bodyText": "Same as above.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551091255", "createdAt": "2021-01-04T02:25:27Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/RawQueryDataSetWithoutValueFilter.java", "diffHunk": "@@ -175,9 +182,15 @@ private void init() throws IOException, InterruptedException {\n       reader.setHasRemaining(true);\n       reader.setManagedByQueryManager(true);\n       TASK_POOL_MANAGER\n-          .submit(new ReadTask(reader, blockingQueueArray[i], paths.get(i).getFullPath()));\n+          .submit(new ReadTask(reader, blockingQueueArray[i], paths.get(i).getFullPath(),\n+              Thread.currentThread()));\n     }\n     for (int i = 0; i < seriesReaderList.size(); i++) {\n+      // check the interrupted status of main thread before taking next batch\n+      if (Thread.interrupted()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODA5NDI3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/NonAlignEngineDataSet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyNzoyM1rOINj9sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyNzoyM1rOINj9sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA5MTYzNQ==", "bodyText": "Check the main thread's interrupt flag in the init method.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551091635", "createdAt": "2021-01-04T02:27:23Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/NonAlignEngineDataSet.java", "diffHunk": "@@ -264,7 +271,7 @@ private void init(WatermarkEncoder encoder, int fetchSize) {\n       ManagedSeriesReader reader = seriesReaderWithoutValueFilterList.get(i);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODA5NDYwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/RawQueryDataSetWithoutValueFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyNzo0M1rOINj96Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyNzo0M1rOINj96Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA5MTY4OQ==", "bodyText": "Same as above", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551091689", "createdAt": "2021-01-04T02:27:43Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/RawQueryDataSetWithoutValueFilter.java", "diffHunk": "@@ -283,7 +296,12 @@ public TSQueryDataSet fillBuffer(int fetchSize, WatermarkEncoder encoder)\n           // move next\n           cachedBatchDataArray[seriesIndex].next();\n \n-          // get next batch if current batch is empty and  still have remaining batch data in queue\n+          // check the interrupted status of main thread before taking next batch\n+          if (Thread.interrupted()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODA5NDc5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/RawQueryDataSetWithoutValueFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyNzo1M1rOINj-AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyNzo1M1rOINj-AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA5MTcxMw==", "bodyText": "Same as above", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551091713", "createdAt": "2021-01-04T02:27:53Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/RawQueryDataSetWithoutValueFilter.java", "diffHunk": "@@ -430,6 +448,11 @@ public RowRecord nextWithoutConstraint() throws IOException {\n         // move next\n         cachedBatchDataArray[seriesIndex].next();\n \n+        // check the interrupted status of main thread before taking next batch\n+        if (Thread.interrupted()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODA5NTYwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyODozMlrOINj-bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyODozMlrOINj-bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA5MTgyMw==", "bodyText": "Same as above", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551091823", "createdAt": "2021-01-04T02:28:32Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "diffHunk": "@@ -173,6 +174,10 @@ public boolean isEmpty() throws IOException {\n   }\n \n   boolean hasNextFile() throws IOException {\n+    if (Thread.interrupted()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODA5NTk0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyODo0NVrOINj-mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjoyODo0NVrOINj-mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA5MTg2NQ==", "bodyText": "Same as above.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551091865", "createdAt": "2021-01-04T02:28:45Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/query/reader/series/SeriesReader.java", "diffHunk": "@@ -351,6 +361,10 @@ void skipCurrentChunk() {\n   @SuppressWarnings(\"squid:S3776\")\n   // Suppress high Cognitive Complexity warning\n   boolean hasNextPage() throws IOException {\n+    if (Thread.interrupted()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODEwMjYwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjozNDowMVrOINkCHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwMjozNDowMVrOINkCHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA5Mjc2NQ==", "bodyText": "Query may not finish in one rpc call, user may call two or more rpc to fetch complete result set. So, you shouldn't remove it after the first call finished.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r551092765", "createdAt": "2021-01-04T02:34:01Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -769,17 +779,22 @@ private TSExecuteStatementResp internalExecuteQueryStatement(String statement,\n         }\n       }\n \n+      // remove query info in QueryTimeManager\n+      QueryTimeManager.getInstance().unRegisterQuery(queryId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4599429d30c348cd493a4049a7c314cc924185d"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NjMwNTY5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwMjo1MTo0NFrOIOv4lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNDowNDo0MlrOIOxMxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjMzNTUwOQ==", "bodyText": "No need to do the if judgement, computeIfPresent already enough", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r552335509", "createdAt": "2021-01-06T02:51:44Z", "author": {"login": "JackieTien97"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -327,6 +339,32 @@ private void operateCreateSnapshot() {\n     IoTDB.metaManager.createMTreeSnapshot();\n   }\n \n+  private void operateKillQuery(KillQueryPlan killQueryPlan) throws QueryIdNotExsitException {\n+    QueryTimeManager queryTimeManager = QueryTimeManager.getInstance();\n+    long killQueryId = killQueryPlan.getQueryId();\n+    if (killQueryId != -1) {\n+      if (queryTimeManager.getQueryThreadMap().get(killQueryId) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1NzA2MQ==", "bodyText": "It's for the else statement actually.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r552357061", "createdAt": "2021-01-06T04:04:42Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -327,6 +339,32 @@ private void operateCreateSnapshot() {\n     IoTDB.metaManager.createMTreeSnapshot();\n   }\n \n+  private void operateKillQuery(KillQueryPlan killQueryPlan) throws QueryIdNotExsitException {\n+    QueryTimeManager queryTimeManager = QueryTimeManager.getInstance();\n+    long killQueryId = killQueryPlan.getQueryId();\n+    if (killQueryId != -1) {\n+      if (queryTimeManager.getQueryThreadMap().get(killQueryId) != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjMzNTUwOQ=="}, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzQ5ODQ4OnYy", "diffSide": "RIGHT", "path": "jdbc/src/main/java/org/apache/iotdb/jdbc/IoTDBStatement.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDowOToxNVrOIROuMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjo1ODowMlrOIRUQjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkzNzkwNg==", "bodyText": "I think it's better to check the timeoutInMS parameter at the very begeinning of the function call.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554937906", "createdAt": "2021-01-11T10:09:15Z", "author": {"login": "SteveYurongSu"}, "path": "jdbc/src/main/java/org/apache/iotdb/jdbc/IoTDBStatement.java", "diffHunk": "@@ -319,10 +328,14 @@ public ResultSet executeQuery(String sql) throws SQLException {\n     }\n   }\n \n-  private ResultSet executeQuerySQL(String sql) throws TException, SQLException {\n+  private ResultSet executeQuerySQL(String sql, long timeoutInMS) throws TException, SQLException {\n     isCancelled = false;\n     TSExecuteStatementReq execReq = new TSExecuteStatementReq(sessionId, sql, stmtId);\n     execReq.setFetchSize(fetchSize);\n+    if (timeoutInMS <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkzODY5Mw==", "bodyText": "in public ResultSet executeQuery(String sql, long timeoutInMS) or somewhere...", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554938693", "createdAt": "2021-01-11T10:10:36Z", "author": {"login": "SteveYurongSu"}, "path": "jdbc/src/main/java/org/apache/iotdb/jdbc/IoTDBStatement.java", "diffHunk": "@@ -319,10 +328,14 @@ public ResultSet executeQuery(String sql) throws SQLException {\n     }\n   }\n \n-  private ResultSet executeQuerySQL(String sql) throws TException, SQLException {\n+  private ResultSet executeQuerySQL(String sql, long timeoutInMS) throws TException, SQLException {\n     isCancelled = false;\n     TSExecuteStatementReq execReq = new TSExecuteStatementReq(sessionId, sql, stmtId);\n     execReq.setFetchSize(fetchSize);\n+    if (timeoutInMS <= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkzNzkwNg=="}, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAyODYyMw==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555028623", "createdAt": "2021-01-11T12:58:02Z", "author": {"login": "Alima777"}, "path": "jdbc/src/main/java/org/apache/iotdb/jdbc/IoTDBStatement.java", "diffHunk": "@@ -319,10 +328,14 @@ public ResultSet executeQuery(String sql) throws SQLException {\n     }\n   }\n \n-  private ResultSet executeQuerySQL(String sql) throws TException, SQLException {\n+  private ResultSet executeQuerySQL(String sql, long timeoutInMS) throws TException, SQLException {\n     isCancelled = false;\n     TSExecuteStatementReq execReq = new TSExecuteStatementReq(sessionId, sql, stmtId);\n     execReq.setFetchSize(fetchSize);\n+    if (timeoutInMS <= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDkzNzkwNg=="}, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzUxODE1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDoxNDozM1rOIRO5zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDoxNDozM1rOIRO5zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk0MDg3OA==", "bodyText": "Specify the unit please.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554940878", "createdAt": "2021-01-11T10:14:33Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/conf/IoTDBConfig.java", "diffHunk": "@@ -475,6 +475,11 @@\n    */\n   private long cacheFileReaderClearPeriod = 100000;\n \n+  /**\n+   * the max executing time of query.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzUyMzM0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/exception/QueryIdNotExsitException.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDoxNTo1MFrOIRO8wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDoxNTo1MFrOIRO8wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk0MTYzMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class QueryIdNotExsitException extends IoTDBException {\n          \n          \n            \n            public class QueryIdNotExistedException extends IoTDBException {", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554941632", "createdAt": "2021-01-11T10:15:50Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/exception/QueryIdNotExsitException.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.exception;\n+\n+import org.apache.iotdb.rpc.TSStatusCode;\n+\n+public class QueryIdNotExsitException extends IoTDBException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzY4OTI0OnYy", "diffSide": "RIGHT", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDo1OToxM1rOIRQdpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDo1OToxM1rOIRQdpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk2NjQzOQ==", "bodyText": "?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554966439", "createdAt": "2021-01-11T10:59:13Z", "author": {"login": "SteveYurongSu"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "diffHunk": "@@ -115,8 +132,11 @@ public InputStream wrapAsInputStream() {\n   public void close() throws IOException {\n     try {\n       channel.close();\n+    } catch (ClosedByInterruptException e) {\n+      throw new QueryTimeoutRuntimeException(\n+          QueryTimeoutRuntimeException.TIMEOUT_EXCEPTION_MESSAGE);\n     } catch (IOException e) {\n-      logger.error(\"Error happened while closing {}\", filePath);\n+      logger.error(\"Error happened while getting {} size\", filePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzY5MDA2OnYy", "diffSide": "RIGHT", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDo1OToyN1rOIRQeKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDo1OToyN1rOIRQeKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk2NjU2OQ==", "bodyText": "?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554966569", "createdAt": "2021-01-11T10:59:27Z", "author": {"login": "SteveYurongSu"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "diffHunk": "@@ -85,8 +99,11 @@ public int read(ByteBuffer dst) throws IOException {\n   public int read(ByteBuffer dst, long position) throws IOException {\n     try {\n       return channel.read(dst, position);\n+    } catch (ClosedByInterruptException e) {\n+      throw new QueryTimeoutRuntimeException(\n+          QueryTimeoutRuntimeException.TIMEOUT_EXCEPTION_MESSAGE);\n     } catch (IOException e) {\n-      logger.error(\"Error happened while reading {} from position {}\", filePath, position);\n+      logger.error(\"Error happened while getting {} size\", filePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzY5MDg4OnYy", "diffSide": "RIGHT", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDo1OTo0MlrOIRQesw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDo1OTo0MlrOIRQesw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk2NjcwNw==", "bodyText": "?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554966707", "createdAt": "2021-01-11T10:59:42Z", "author": {"login": "SteveYurongSu"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "diffHunk": "@@ -75,8 +86,11 @@ public TsFileInput position(long newPosition) throws IOException {\n   public int read(ByteBuffer dst) throws IOException {\n     try {\n       return channel.read(dst);\n+    } catch (ClosedByInterruptException e) {\n+      throw new QueryTimeoutRuntimeException(\n+          QueryTimeoutRuntimeException.TIMEOUT_EXCEPTION_MESSAGE);\n     } catch (IOException e) {\n-      logger.error(\"Error happened while reading {} from current position\", filePath);\n+      logger.error(\"Error happened while getting {} size\", filePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzY5MTUxOnYy", "diffSide": "RIGHT", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDo1OTo1NFrOIRQfGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMDo1OTo1NFrOIRQfGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk2NjgxMQ==", "bodyText": "?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554966811", "createdAt": "2021-01-11T10:59:54Z", "author": {"login": "SteveYurongSu"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "diffHunk": "@@ -65,8 +73,11 @@ public TsFileInput position(long newPosition) throws IOException {\n     try {\n       channel.position(newPosition);\n       return this;\n+    } catch (ClosedByInterruptException e) {\n+      throw new QueryTimeoutRuntimeException(\n+          QueryTimeoutRuntimeException.TIMEOUT_EXCEPTION_MESSAGE);\n     } catch (IOException e) {\n-      logger.error(\"Error happened while changing {} position to {}\", filePath, newPosition);\n+      logger.error(\"Error happened while getting {} size\", filePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzY5MjAxOnYy", "diffSide": "RIGHT", "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMTowMDowNFrOIRQfbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMTowMDowNFrOIRQfbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk2Njg5Mw==", "bodyText": "?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554966893", "createdAt": "2021-01-11T11:00:04Z", "author": {"login": "SteveYurongSu"}, "path": "tsfile/src/main/java/org/apache/iotdb/tsfile/read/reader/LocalTsFileInput.java", "diffHunk": "@@ -54,8 +59,11 @@ public long size() throws IOException {\n   public long position() throws IOException {\n     try {\n       return channel.position();\n+    } catch (ClosedByInterruptException e) {\n+      throw new QueryTimeoutRuntimeException(\n+          QueryTimeoutRuntimeException.TIMEOUT_EXCEPTION_MESSAGE);\n     } catch (IOException e) {\n-      logger.error(\"Error happened while getting {} current position\", filePath);\n+      logger.error(\"Error happened while getting {} size\", filePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzcwMjg2OnYy", "diffSide": "RIGHT", "path": "service-rpc/src/main/java/org/apache/iotdb/rpc/TSStatusCode.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMTowMjozOVrOIRQlsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMzo0NTozMVrOIRV7UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk2ODQ5Ng==", "bodyText": "Add it to the user doc.\nLink: https://iotdb.apache.org/UserGuide/Master/Client/Status%20Codes.html", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554968496", "createdAt": "2021-01-11T11:02:39Z", "author": {"login": "SteveYurongSu"}, "path": "service-rpc/src/main/java/org/apache/iotdb/rpc/TSStatusCode.java", "diffHunk": "@@ -60,6 +60,7 @@\n   QUERY_PROCESS_ERROR(411),\n   WRITE_PROCESS_ERROR(412),\n   WRITE_PROCESS_REJECT(413),\n+  QUERY_ID_NOT_EXIST(414),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA1NTk1Mw==", "bodyText": "Fixed.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555055953", "createdAt": "2021-01-11T13:45:31Z", "author": {"login": "Alima777"}, "path": "service-rpc/src/main/java/org/apache/iotdb/rpc/TSStatusCode.java", "diffHunk": "@@ -60,6 +60,7 @@\n   QUERY_PROCESS_ERROR(411),\n   WRITE_PROCESS_ERROR(412),\n   WRITE_PROCESS_REJECT(413),\n+  QUERY_ID_NOT_EXIST(414),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk2ODQ5Ng=="}, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5Mzc0MTQzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMToxMzozMFrOIRQ9DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMzowMTo0MlrOIRUXwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk3NDQ3Nw==", "bodyText": "Make QueryIdNotExsitException extended from QueryProcessException?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554974477", "createdAt": "2021-01-11T11:13:30Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -291,6 +296,13 @@ public boolean processNonQuery(PhysicalPlan plan)\n         throw new QueryProcessException(\"Create index hasn't been supported yet\");\n       case DROP_INDEX:\n         throw new QueryProcessException(\"Drop index hasn't been supported yet\");\n+      case KILL:\n+        try {\n+          operateKillQuery((KillQueryPlan) plan);\n+        } catch (QueryIdNotExsitException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAzMDQ2NQ==", "bodyText": "It's ok now I think.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555030465", "createdAt": "2021-01-11T13:01:42Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -291,6 +296,13 @@ public boolean processNonQuery(PhysicalPlan plan)\n         throw new QueryProcessException(\"Create index hasn't been supported yet\");\n       case DROP_INDEX:\n         throw new QueryProcessException(\"Drop index hasn't been supported yet\");\n+      case KILL:\n+        try {\n+          operateKillQuery((KillQueryPlan) plan);\n+        } catch (QueryIdNotExsitException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk3NDQ3Nw=="}, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5Mzg3MDUyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMTo1MjozM1rOIRSKdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMzowMjowNVrOIRUYgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk5NDI5Mg==", "bodyText": "Why using synchronized here?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554994292", "createdAt": "2021-01-11T11:52:33Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -327,6 +339,32 @@ private void operateCreateSnapshot() {\n     IoTDB.metaManager.createMTreeSnapshot();\n   }\n \n+  private void operateKillQuery(KillQueryPlan killQueryPlan) throws QueryIdNotExsitException {\n+    QueryTimeManager queryTimeManager = QueryTimeManager.getInstance();\n+    long killQueryId = killQueryPlan.getQueryId();\n+    if (killQueryId != -1) {\n+      if (queryTimeManager.getQueryThreadMap().get(killQueryId) != null) {\n+        queryTimeManager.getQueryThreadMap().computeIfPresent(killQueryId, (k, v) -> {\n+          queryTimeManager.killQuery(k);\n+          return null;\n+        });\n+      } else {\n+        throw new QueryIdNotExsitException(String\n+            .format(\"Query Id %d is not exist, please check it.\", killQueryPlan.getQueryId()));\n+      }\n+    } else {\n+      // if queryId is not specified, kill all running queries\n+      if (!queryTimeManager.getQueryThreadMap().isEmpty()) {\n+        synchronized (queryTimeManager.getQueryThreadMap()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAzMDY1Nw==", "bodyText": "To keep thread safe while iterating.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555030657", "createdAt": "2021-01-11T13:02:05Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -327,6 +339,32 @@ private void operateCreateSnapshot() {\n     IoTDB.metaManager.createMTreeSnapshot();\n   }\n \n+  private void operateKillQuery(KillQueryPlan killQueryPlan) throws QueryIdNotExsitException {\n+    QueryTimeManager queryTimeManager = QueryTimeManager.getInstance();\n+    long killQueryId = killQueryPlan.getQueryId();\n+    if (killQueryId != -1) {\n+      if (queryTimeManager.getQueryThreadMap().get(killQueryId) != null) {\n+        queryTimeManager.getQueryThreadMap().computeIfPresent(killQueryId, (k, v) -> {\n+          queryTimeManager.killQuery(k);\n+          return null;\n+        });\n+      } else {\n+        throw new QueryIdNotExsitException(String\n+            .format(\"Query Id %d is not exist, please check it.\", killQueryPlan.getQueryId()));\n+      }\n+    } else {\n+      // if queryId is not specified, kill all running queries\n+      if (!queryTimeManager.getQueryThreadMap().isEmpty()) {\n+        synchronized (queryTimeManager.getQueryThreadMap()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk5NDI5Mg=="}, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzkwMDA1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjowMToyOFrOIRScIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjowMToyOFrOIRScIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDk5ODgxOA==", "bodyText": "ignoreTimeStamp is false by default... This statement is unneccessary...", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r554998818", "createdAt": "2021-01-11T12:01:28Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -744,7 +753,9 @@ private TSExecuteStatementResp internalExecuteQueryStatement(String statement,\n       resp.setOperationType(plan.getOperatorType().toString());\n       if (plan.getOperatorType() == OperatorType.AGGREGATION) {\n         resp.setIgnoreTimeStamp(true);\n-      } // else default ignoreTimeStamp is false\n+      } else if (plan instanceof ShowQueryProcesslistPlan) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzkyMTY0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjowODowMlrOIRSpUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjowODowMlrOIRSpUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAwMjE5Mw==", "bodyText": "What if exceptions occur before unRegisterQuery  is executed?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555002193", "createdAt": "2021-01-11T12:08:02Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -769,17 +780,24 @@ private TSExecuteStatementResp internalExecuteQueryStatement(String statement,\n         }\n       }\n \n+      // remove query info in QueryTimeManager\n+      if (!(plan instanceof ShowQueryProcesslistPlan)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzkyODkwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjoxMDoxNVrOIRStuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjoxMDoxNVrOIRStuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAwMzMyMw==", "bodyText": "It's better to save the stack trace.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555003323", "createdAt": "2021-01-11T12:10:15Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -769,17 +780,24 @@ private TSExecuteStatementResp internalExecuteQueryStatement(String statement,\n         }\n       }\n \n+      // remove query info in QueryTimeManager\n+      if (!(plan instanceof ShowQueryProcesslistPlan)) {\n+        queryTimeManager.unRegisterQuery(queryId);\n+      }\n       return resp;\n     } catch (Exception e) {\n-      if (e instanceof NullPointerException) {\n+      if (e instanceof QueryTimeoutRuntimeException && Thread.interrupted()) {\n+        // do nothing, just recover the state of thread here\n+        logger.error(\"Recover the state of the thread interrupted\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzkzMjEzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjoxMToxNFrOIRSvrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjoxMToxNFrOIRSvrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAwMzgyMg==", "bodyText": "What if exceptions occur before unRegisterQuery is executed?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555003822", "createdAt": "2021-01-11T12:11:14Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -998,6 +1021,8 @@ public TSFetchResultsResp fetchResults(TSFetchResultsReq req) {\n         resp.setHasResultSet(hasResultSet);\n         resp.setQueryDataSet(result);\n         resp.setIsAlign(true);\n+\n+        queryTimeManager.unRegisterQuery(req.queryId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 158}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5MzkzMjQwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjoxMToyMFrOIRSv3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjoxMToyMFrOIRSv3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAwMzg2OA==", "bodyText": "What if exceptions occur before unRegisterQuery is executed?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555003868", "createdAt": "2021-01-11T12:11:20Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -1017,9 +1042,15 @@ public TSFetchResultsResp fetchResults(TSFetchResultsReq req) {\n         resp.setHasResultSet(hasResultSet);\n         resp.setNonAlignQueryDataSet(nonAlignResult);\n         resp.setIsAlign(false);\n+\n+        queryTimeManager.unRegisterQuery(req.queryId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5Mzk2ODAyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryTimeManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjoyMTozNVrOIRTFPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMzo0Mzo0NlrOIRV25w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAwOTM0MQ==", "bodyText": "Package queryInfoMap and queryThreadMap?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555009341", "createdAt": "2021-01-11T12:21:35Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryTimeManager.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.iotdb.db.concurrent.IoTDBThreadPoolFactory;\n+import org.apache.iotdb.db.exception.query.QueryTimeoutRuntimeException;\n+import org.apache.iotdb.db.service.IService;\n+import org.apache.iotdb.db.service.ServiceType;\n+import org.apache.iotdb.tsfile.utils.Pair;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class is used to monitor the executing time of each query.\n+ * </p>\n+ * Once one is over the threshold, it will be killed and return the time out exception.\n+ */\n+public class QueryTimeManager implements IService {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(QueryTimeManager.class);\n+\n+  /**\n+   * the key of queryStartTimeMap is the query id and the value of queryStartTimeMap is the start\n+   * time and the sql of this query.\n+   */\n+  private Map<Long, Pair<Long, String>> queryInfoMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA1NDgyMw==", "bodyText": "Good suggestion~ I have packaged them.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r555054823", "createdAt": "2021-01-11T13:43:46Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/query/control/QueryTimeManager.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.query.control;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+import org.apache.iotdb.db.concurrent.IoTDBThreadPoolFactory;\n+import org.apache.iotdb.db.exception.query.QueryTimeoutRuntimeException;\n+import org.apache.iotdb.db.service.IService;\n+import org.apache.iotdb.db.service.ServiceType;\n+import org.apache.iotdb.tsfile.utils.Pair;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class is used to monitor the executing time of each query.\n+ * </p>\n+ * Once one is over the threshold, it will be killed and return the time out exception.\n+ */\n+public class QueryTimeManager implements IService {\n+\n+  private static final Logger logger = LoggerFactory.getLogger(QueryTimeManager.class);\n+\n+  /**\n+   * the key of queryStartTimeMap is the query id and the value of queryStartTimeMap is the start\n+   * time and the sql of this query.\n+   */\n+  private Map<Long, Pair<Long, String>> queryInfoMap;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAwOTM0MQ=="}, "originalCommit": {"oid": "095281f968d153530ebd113efd648631e2d6e8e9"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMTc1MzgzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwMTo1NTowMlrOISchGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwMjo0ODozN1rOISdhrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIxMjUwNw==", "bodyText": "Use DETAILED_FAILURE_QUERY_TRACE_LOGGER instead ?", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r556212507", "createdAt": "2021-01-13T01:55:02Z", "author": {"login": "SteveYurongSu"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -1573,7 +1604,10 @@ private TSStatus onQueryException(Exception e, String operation) {\n   }\n \n   private TSStatus tryCatchQueryException(Exception e) {\n-    if (e instanceof ParseCancellationException) {\n+    if (e instanceof QueryTimeoutRuntimeException && Thread.interrupted()) {\n+      // do nothing, just recover the state of thread here\n+      LOGGER.error(\"Recover the state of the thread interrupted\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76e2249ddb32e016f680c45a0c2898b8ff452ca8"}, "originalPosition": 176}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIyOTAzOA==", "bodyText": "Fixed.", "url": "https://github.com/apache/iotdb/pull/2352#discussion_r556229038", "createdAt": "2021-01-13T02:48:37Z", "author": {"login": "Alima777"}, "path": "server/src/main/java/org/apache/iotdb/db/service/TSServiceImpl.java", "diffHunk": "@@ -1573,7 +1604,10 @@ private TSStatus onQueryException(Exception e, String operation) {\n   }\n \n   private TSStatus tryCatchQueryException(Exception e) {\n-    if (e instanceof ParseCancellationException) {\n+    if (e instanceof QueryTimeoutRuntimeException && Thread.interrupted()) {\n+      // do nothing, just recover the state of thread here\n+      LOGGER.error(\"Recover the state of the thread interrupted\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjIxMjUwNw=="}, "originalCommit": {"oid": "76e2249ddb32e016f680c45a0c2898b8ff452ca8"}, "originalPosition": 176}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 481, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}