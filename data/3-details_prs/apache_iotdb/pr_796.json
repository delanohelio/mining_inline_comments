{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MTM0Mjg3", "number": 796, "title": "[IoTDB-468] Restructure QueryPlan", "bodyText": "The AlignByDevice query ( which is called groupByDevice before ) and general query aligning by time are both storaged in QueryPlan now. However, they invoke different query process bascially, so it's necessary to restructure the QueryPlan and seperate the AlignByDeviceQuery from it.\nThe QueryPlan is designed as base class, which has RawDataQueryPlan and AlignByDevicePlan as subclasses. This restructure may bring some usage changes, because the general query which uses QueryPlan directly before has to instantiate RawDataQueryPlan now.\nIf you think the design is not friendly to users, welcome to comment.", "createdAt": "2020-02-12T06:37:28Z", "url": "https://github.com/apache/iotdb/pull/796", "merged": true, "mergeCommit": {"oid": "753239a74366e4116b29036728102d6f19c24aae"}, "closed": true, "closedAt": "2020-02-13T07:06:20Z", "author": {"login": "Alima777"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDgYw8AH2gAyMzc0MTM0Mjg3OmQ4NGRlNGQ1NTY1ZGUzMTM0ZDBlYjlhOGI5NDM2ZmU5ZWFiMWYwYmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDy1QsgFqTM1Nzk0MTk3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "committedDate": "2020-02-12T06:31:52Z", "message": "Restructure QueryPlan"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d54050b5f747913df6e59ac713499b284cb708b0", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/d54050b5f747913df6e59ac713499b284cb708b0", "committedDate": "2020-02-12T08:24:36Z", "message": "Modify isGroupByDevice to isAlignByDevice"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MjM0NTky", "url": "https://github.com/apache/iotdb/pull/796#pullrequestreview-357234592", "createdAt": "2020-02-12T07:29:09Z", "commit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwNzoyOToxMFrOFokDDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwOToyNjowM1rOFonHXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3Nzk2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private List<String> measurements; // for group by device sql, e.g. temperature\n          \n          \n            \n              private List<String> measurements; // e.g. temperature\n          \n      \n    \n    \n  \n\ngive a more complex example, such as m1, m2, m3", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378077967", "createdAt": "2020-02-12T07:29:10Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODA3OQ==", "bodyText": "the same as above", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378078079", "createdAt": "2020-02-12T07:29:27Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODcyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n          \n          \n            \n              private Map<String, TSDataType> seriesTypeMap; // e.g. root.ln.d1.temperature -> Float\n          \n      \n    \n    \n  \n\nmake the field name clear", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378078727", "createdAt": "2020-02-12T07:31:26Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODk4NA==", "bodyText": "why there isn't a RawDataQueryPan", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378078984", "createdAt": "2020-02-12T07:32:14Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n+  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3OTE4Ng==", "bodyText": "put fields in the front of the class", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378079186", "createdAt": "2020-02-12T07:32:48Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n+  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;\n+\n+  public AlignByDevicePlan() {\n+    super();\n+  }\n+\n+  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n+    super(isQuery, operatorType);\n+  }\n+\n+  public void setMeasurements(List<String> measurements) {\n+    this.measurements = measurements;\n+  }\n+\n+  public List<String> getMeasurements() {\n+    return measurements;\n+  }\n+\n+  public void setMeasurementsGroupByDevice(\n+      Map<String, Set<String>> deviceToMeasurementsMap) {\n+    this.deviceToMeasurementsMap = deviceToMeasurementsMap;\n+  }\n+\n+  public Map<String, Set<String>> getDeviceToMeasurementsMap() {\n+    return deviceToMeasurementsMap;\n+  }\n+\n+  public void setDataTypeConsistencyChecker(\n+      Map<String, TSDataType> dataTypeConsistencyChecker) {\n+    this.dataTypeConsistencyChecker = dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, TSDataType> getDataTypeConsistencyChecker() {\n+    return dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, IExpression> getDeviceToFilterMap() {\n+    return deviceToFilterMap;\n+  }\n+\n+  public void setDeviceToFilterMap(Map<String, IExpression> deviceToFilterMap) {\n+    this.deviceToFilterMap = deviceToFilterMap;\n+  }\n+\n+  public GroupByPlan getGroupByPlan() {\n+    return groupByPlan;\n+  }\n+\n+  public void setGroupByPlan(GroupByPlan groupByPlan) {\n+    this.groupByPlan = groupByPlan;\n+    this.setOperatorType(OperatorType.GROUPBY);\n+  }\n+\n+  public FillQueryPlan getFillQueryPlan() {\n+    return fillQueryPlan;\n+  }\n+\n+  public void setFillQueryPlan(FillQueryPlan fillQueryPlan) {\n+    this.fillQueryPlan = fillQueryPlan;\n+    this.setOperatorType(OperatorType.FILL);\n+  }\n+\n+  public AggregationPlan getAggregationPlan() {\n+    return aggregationPlan;\n+  }\n+\n+  public void setAggregationPlan(AggregationPlan aggregationPlan) {\n+    this.aggregationPlan = aggregationPlan;\n+    this.setOperatorType(Operator.OperatorType.AGGREGATION);\n+  }\n+\n+  //the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  ; // for group by device sql\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>(); // for group by device sql\n+  //the measurements that have quotation mark. e.g., \"abc\",\n+  // '11', the data type is considered as String and the value  is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>(); // for group by device sql\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>(); // for group by device sql", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3OTYwMg==", "bodyText": "remove this", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378079602", "createdAt": "2020-02-12T07:34:07Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n+  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;\n+\n+  public AlignByDevicePlan() {\n+    super();\n+  }\n+\n+  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n+    super(isQuery, operatorType);\n+  }\n+\n+  public void setMeasurements(List<String> measurements) {\n+    this.measurements = measurements;\n+  }\n+\n+  public List<String> getMeasurements() {\n+    return measurements;\n+  }\n+\n+  public void setMeasurementsGroupByDevice(\n+      Map<String, Set<String>> deviceToMeasurementsMap) {\n+    this.deviceToMeasurementsMap = deviceToMeasurementsMap;\n+  }\n+\n+  public Map<String, Set<String>> getDeviceToMeasurementsMap() {\n+    return deviceToMeasurementsMap;\n+  }\n+\n+  public void setDataTypeConsistencyChecker(\n+      Map<String, TSDataType> dataTypeConsistencyChecker) {\n+    this.dataTypeConsistencyChecker = dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, TSDataType> getDataTypeConsistencyChecker() {\n+    return dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, IExpression> getDeviceToFilterMap() {\n+    return deviceToFilterMap;\n+  }\n+\n+  public void setDeviceToFilterMap(Map<String, IExpression> deviceToFilterMap) {\n+    this.deviceToFilterMap = deviceToFilterMap;\n+  }\n+\n+  public GroupByPlan getGroupByPlan() {\n+    return groupByPlan;\n+  }\n+\n+  public void setGroupByPlan(GroupByPlan groupByPlan) {\n+    this.groupByPlan = groupByPlan;\n+    this.setOperatorType(OperatorType.GROUPBY);\n+  }\n+\n+  public FillQueryPlan getFillQueryPlan() {\n+    return fillQueryPlan;\n+  }\n+\n+  public void setFillQueryPlan(FillQueryPlan fillQueryPlan) {\n+    this.fillQueryPlan = fillQueryPlan;\n+    this.setOperatorType(OperatorType.FILL);\n+  }\n+\n+  public AggregationPlan getAggregationPlan() {\n+    return aggregationPlan;\n+  }\n+\n+  public void setAggregationPlan(AggregationPlan aggregationPlan) {\n+    this.aggregationPlan = aggregationPlan;\n+    this.setOperatorType(Operator.OperatorType.AGGREGATION);\n+  }\n+\n+  //the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  ; // for group by device sql", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA4MjczNQ==", "bodyText": "min what?", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378082735", "createdAt": "2020-02-12T07:43:20Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n+  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;\n+\n+  public AlignByDevicePlan() {\n+    super();\n+  }\n+\n+  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n+    super(isQuery, operatorType);\n+  }\n+\n+  public void setMeasurements(List<String> measurements) {\n+    this.measurements = measurements;\n+  }\n+\n+  public List<String> getMeasurements() {\n+    return measurements;\n+  }\n+\n+  public void setMeasurementsGroupByDevice(\n+      Map<String, Set<String>> deviceToMeasurementsMap) {\n+    this.deviceToMeasurementsMap = deviceToMeasurementsMap;\n+  }\n+\n+  public Map<String, Set<String>> getDeviceToMeasurementsMap() {\n+    return deviceToMeasurementsMap;\n+  }\n+\n+  public void setDataTypeConsistencyChecker(\n+      Map<String, TSDataType> dataTypeConsistencyChecker) {\n+    this.dataTypeConsistencyChecker = dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, TSDataType> getDataTypeConsistencyChecker() {\n+    return dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, IExpression> getDeviceToFilterMap() {\n+    return deviceToFilterMap;\n+  }\n+\n+  public void setDeviceToFilterMap(Map<String, IExpression> deviceToFilterMap) {\n+    this.deviceToFilterMap = deviceToFilterMap;\n+  }\n+\n+  public GroupByPlan getGroupByPlan() {\n+    return groupByPlan;\n+  }\n+\n+  public void setGroupByPlan(GroupByPlan groupByPlan) {\n+    this.groupByPlan = groupByPlan;\n+    this.setOperatorType(OperatorType.GROUPBY);\n+  }\n+\n+  public FillQueryPlan getFillQueryPlan() {\n+    return fillQueryPlan;\n+  }\n+\n+  public void setFillQueryPlan(FillQueryPlan fillQueryPlan) {\n+    this.fillQueryPlan = fillQueryPlan;\n+    this.setOperatorType(OperatorType.FILL);\n+  }\n+\n+  public AggregationPlan getAggregationPlan() {\n+    return aggregationPlan;\n+  }\n+\n+  public void setAggregationPlan(AggregationPlan aggregationPlan) {\n+    this.aggregationPlan = aggregationPlan;\n+    this.setOperatorType(Operator.OperatorType.AGGREGATION);\n+  }\n+\n+  //the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  ; // for group by device sql\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>(); // for group by device sql\n+  //the measurements that have quotation mark. e.g., \"abc\",\n+  // '11', the data type is considered as String and the value  is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>(); // for group by device sql\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>(); // for group by device sql\n+\n+  //we use the following algorithm to reproduce the order of measurements that user writes.\n+  //suppose user writes SELECT 'c1',a1,b1,b2,'c2',a2,a3,'c3',b3,a4,a5 FROM ... where for each a_i\n+  // column there is at least one device having it, and for each b_i column there is no device\n+  // having it, and 'c_i' is a const column.\n+  // Then, measurements = {a1, a2, a3, a4, a5};\n+  // notExistMeasurements = {b1, b2, b3}, and positionOfNotExistMeasurements = {2, 3, 8};\n+  // constMeasurements = {'c1', 'c2', 'c3'}, and positionOfConstMeasurements = {0, 4, 7}.\n+  // When to reproduce the order of measurements. The pseudocode is:\n+  //<pre>\n+  // current = 0;\n+  // if (min(notExist, const) <= current) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA4Nzg0Nw==", "bodyText": "What's the difference between this measurements with the paths in QueryPlan?\nRefactor the organization or rename this field", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378087847", "createdAt": "2020-02-12T07:58:25Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3Nzk2Nw=="}, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MDI3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (queryOperator.isGroupByDevice()) {\n          \n          \n            \n                if (queryOperator.isAlignByDevice()) {", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378090272", "createdAt": "2020-02-12T08:04:51Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "diffHunk": "@@ -242,16 +244,26 @@ private PhysicalPlan transformQuery(QueryOperator queryOperator)\n       ((AggregationPlan) queryPlan)\n           .setAggregations(queryOperator.getSelectOperator().getAggregations());\n     } else {\n-      queryPlan = new QueryPlan();\n+      queryPlan = new RawDataQueryPlan();\n     }\n     if (queryOperator.isGroupByDevice()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MDYzMw==", "bodyText": "Futher, should the QueryOperator be separate to different type?", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378090633", "createdAt": "2020-02-12T08:05:49Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "diffHunk": "@@ -242,16 +244,26 @@ private PhysicalPlan transformQuery(QueryOperator queryOperator)\n       ((AggregationPlan) queryPlan)\n           .setAggregations(queryOperator.getSelectOperator().getAggregations());\n     } else {\n-      queryPlan = new QueryPlan();\n+      queryPlan = new RawDataQueryPlan();\n     }\n     if (queryOperator.isGroupByDevice()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MDI3Mg=="}, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MTkxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  ((AlignByDevicePlan) queryPlan).setDataTypeConsistencyChecker(dataTypeConsistencyChecker);\n          \n          \n            \n                  ((AlignByDevicePlan) queryPlan).setDataTypeConsistencyChecker(seriesTypeMap);", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378091913", "createdAt": "2020-02-12T08:09:29Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "diffHunk": "@@ -373,17 +386,17 @@ private PhysicalPlan transformQuery(QueryOperator queryOperator)\n       }\n \n       // assigns to queryPlan\n-      queryPlan.setGroupByDevice(true);\n-      queryPlan.setMeasurements(measurements);\n-      queryPlan.setMeasurementsGroupByDevice(measurementsGroupByDevice);\n-      queryPlan.setDataTypeConsistencyChecker(dataTypeConsistencyChecker);\n+      ((AlignByDevicePlan) queryPlan).setMeasurements(measurements);\n+      ((AlignByDevicePlan) queryPlan).setMeasurementsGroupByDevice(deviceToMeasurementsMap);\n+      ((AlignByDevicePlan) queryPlan).setDataTypeConsistencyChecker(dataTypeConsistencyChecker);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MzA2Nw==", "bodyText": "This line could be put in the last, then you do not need to convert query plan to an AlignByDevicePlan each time", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378093067", "createdAt": "2020-02-12T08:12:32Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "diffHunk": "@@ -242,16 +244,26 @@ private PhysicalPlan transformQuery(QueryOperator queryOperator)\n       ((AggregationPlan) queryPlan)\n           .setAggregations(queryOperator.getSelectOperator().getAggregations());\n     } else {\n-      queryPlan = new QueryPlan();\n+      queryPlan = new RawDataQueryPlan();\n     }\n     if (queryOperator.isGroupByDevice()) {\n-      // below is the core realization of GROUP_BY_DEVICE sql logic\n+      // below is the core realization of ALIGN_BY_DEVICE sql logic\n+      AlignByDevicePlan alignByDevicePlan = new AlignByDevicePlan();\n+      if (queryPlan instanceof GroupByPlan) {\n+        alignByDevicePlan.setGroupByPlan((GroupByPlan) queryPlan);\n+      } else if (queryPlan instanceof FillQueryPlan) {\n+        alignByDevicePlan.setFillQueryPlan((FillQueryPlan) queryPlan);\n+      } else if (queryPlan instanceof AggregationPlan) {\n+        alignByDevicePlan.setAggregationPlan((AggregationPlan) queryPlan);\n+      }\n+\n+      queryPlan = alignByDevicePlan;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MzU1NQ==", "bodyText": "There is a typo in line 426, divice", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378093555", "createdAt": "2020-02-12T08:13:51Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "diffHunk": "@@ -395,7 +408,7 @@ private PhysicalPlan transformQuery(QueryOperator queryOperator)\n \n       if (filterOperator != null) {\n         IExpression expression = filterOperator.transformToExpression();\n-        queryPlan.setExpression(expression);\n+        ((RawDataQueryPlan) queryPlan).setExpression(expression);\n       }\n     }\n     generateDataTypes(queryPlan);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5NDk3Ng==", "bodyText": "remove the for group by device comment", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378094976", "createdAt": "2020-02-12T08:17:16Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5OTE5OA==", "bodyText": "remove this comment", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378099198", "createdAt": "2020-02-12T08:26:52Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();\n \n-    if (queryPlan instanceof GroupByPlan) {\n+    if (alignByDevicePlan.getGroupByPlan() != null) {\n       this.dataSetType = DataSetType.GROUPBY;\n       // assign parameters", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5OTM5MA==", "bodyText": "remove this", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378099390", "createdAt": "2020-02-12T08:27:19Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5OTQ5MQ==", "bodyText": "remove this", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378099491", "createdAt": "2020-02-12T08:27:33Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();\n \n-    if (queryPlan instanceof GroupByPlan) {\n+    if (alignByDevicePlan.getGroupByPlan() != null) {\n       this.dataSetType = DataSetType.GROUPBY;\n       // assign parameters\n-      this.unit = ((GroupByPlan) queryPlan).getInterval();\n-      this.slidingStep = ((GroupByPlan) queryPlan).getSlidingStep();\n-      this.startTime = ((GroupByPlan) queryPlan).getStartTime();\n-      this.endTime = ((GroupByPlan) queryPlan).getEndTime();\n+      this.unit = alignByDevicePlan.getGroupByPlan().getInterval();\n+      this.slidingStep = alignByDevicePlan.getGroupByPlan().getSlidingStep();\n+      this.startTime = alignByDevicePlan.getGroupByPlan().getStartTime();\n+      this.endTime = alignByDevicePlan.getGroupByPlan().getEndTime();\n \n-    } else if (queryPlan instanceof AggregationPlan) {\n+    } else if (alignByDevicePlan.getAggregationPlan() != null) {\n       this.dataSetType = DataSetType.AGGREGATE;\n \n-    } else if (queryPlan instanceof FillQueryPlan) {\n+    } else if (alignByDevicePlan.getFillQueryPlan() != null) {\n       this.dataSetType = DataSetType.FILL;\n       // assign parameters", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyNjE3Ng==", "bodyText": "We could add a queryType in AlignByDevicePlan, and use switch here", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378126176", "createdAt": "2020-02-12T09:22:19Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();\n \n-    if (queryPlan instanceof GroupByPlan) {\n+    if (alignByDevicePlan.getGroupByPlan() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyNzkxNg==", "bodyText": "Don't you save three plans in AlignByDevicePlan? They could be reused", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378127916", "createdAt": "2020-02-12T09:25:32Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -207,7 +211,7 @@ protected boolean hasNextWithoutConstraint() throws IOException {\n             currentDataSet = queryRouter.fill(fillQueryPlan, context);\n             break;\n           case QUERY:\n-            QueryPlan queryPlan = new QueryPlan();\n+            RawDataQueryPlan queryPlan = new RawDataQueryPlan();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyODIyMg==", "bodyText": "Reuse the query plan in AlignByDevicePlan, no need to set the parameters again and again", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378128222", "createdAt": "2020-02-12T09:26:03Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();\n \n-    if (queryPlan instanceof GroupByPlan) {\n+    if (alignByDevicePlan.getGroupByPlan() != null) {\n       this.dataSetType = DataSetType.GROUPBY;\n       // assign parameters\n-      this.unit = ((GroupByPlan) queryPlan).getInterval();\n-      this.slidingStep = ((GroupByPlan) queryPlan).getSlidingStep();\n-      this.startTime = ((GroupByPlan) queryPlan).getStartTime();\n-      this.endTime = ((GroupByPlan) queryPlan).getEndTime();\n+      this.unit = alignByDevicePlan.getGroupByPlan().getInterval();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/85fe556e2fc701f6816d39262bbdc367778c4c06", "committedDate": "2020-02-12T11:00:46Z", "message": "Fix bugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NDIxNTUz", "url": "https://github.com/apache/iotdb/pull/796#pullrequestreview-357421553", "createdAt": "2020-02-12T12:44:20Z", "commit": {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMjo0NDoyMFrOFotK2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMzowMToyMlrOFotpvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIyNzQxNg==", "bodyText": "but you need to do a RawData query for each device a", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378227416", "createdAt": "2020-02-12T12:44:20Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n+  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODk4NA=="}, "originalCommit": {"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMDkwNw==", "bodyText": "remove this unused", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378230907", "createdAt": "2020-02-12T12:51:57Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // e.g. temperature, status, speed\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // e.g. root.ln.d1 -> temperature\n+  // to check data type consistency for the same name sensor of different devices\n+  private Map<String, TSDataType> dataTypeConsistencyChecker;\n+  private Map<String, IExpression> deviceToFilterMap;\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;\n+\n+  // the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>();\n+  // the measurements that have quotation mark. e.g. \"abc\",\n+  // '11', the data type is considered as String and the value is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>();\n+\n+  public AlignByDevicePlan() {\n+    super();\n+  }\n+\n+  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMjQxMg==", "bodyText": "ha?", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378232412", "createdAt": "2020-02-12T12:55:12Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java", "diffHunk": "@@ -20,7 +20,8 @@\n \n import org.apache.iotdb.db.qp.logical.Operator;\n \n-public class GroupByPlan extends AggregationPlan {\n+public class\n+GroupByPlan extends AggregationPlan {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMjc2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            GroupByPlan extends AggregationPlan {\n          \n          \n            \n            GroupByTimePlan extends AggregationPlan {", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378232769", "createdAt": "2020-02-12T12:55:55Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java", "diffHunk": "@@ -20,7 +20,8 @@\n \n import org.apache.iotdb.db.qp.logical.Operator;\n \n-public class GroupByPlan extends AggregationPlan {\n+public class\n+GroupByPlan extends AggregationPlan {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMzExMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private boolean isAlignByDevice = false;\n          \n          \n            \n              private boolean alignByDevice = false;", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378233113", "createdAt": "2020-02-12T12:56:29Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/logical/crud/QueryOperator.java", "diffHunk": "@@ -45,8 +45,8 @@\n   private int seriesLimit = 0;\n   private int seriesOffset = 0;\n \n-  private boolean isGroupByDevice = false;\n-  private boolean isAlign = true;\n+  private boolean isAlignByDevice = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMzIwMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private boolean isAlignByTime = true;\n          \n          \n            \n              private boolean alignByTime = true;", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378233202", "createdAt": "2020-02-12T12:56:39Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/logical/crud/QueryOperator.java", "diffHunk": "@@ -45,8 +45,8 @@\n   private int seriesLimit = 0;\n   private int seriesOffset = 0;\n \n-  private boolean isGroupByDevice = false;\n-  private boolean isAlign = true;\n+  private boolean isAlignByDevice = false;\n+  private boolean isAlignByTime = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzNTAxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This QueryDataSet is used for GROUP_BY_DEVICE query result.\n          \n          \n            \n             * This QueryDataSet is used for align by device query result.", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378235019", "createdAt": "2020-02-12T13:00:43Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -36,9 +42,6 @@\n import org.apache.iotdb.tsfile.read.query.dataset.QueryDataSet;\n import org.apache.iotdb.tsfile.utils.Binary;\n \n-import java.io.IOException;\n-import java.util.*;\n-\n \n /**\n  * This QueryDataSet is used for GROUP_BY_DEVICE query result.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzNTMyNQ==", "bodyText": "how about renaming this class to AlignByDeviceDataset", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378235325", "createdAt": "2020-02-12T13:01:22Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,45 +77,41 @@\n   private int[] currentColumnMapRelation;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/c991383bb5e55b2f3f2ba75072cd214207d8034d", "committedDate": "2020-02-12T15:41:10Z", "message": "always endeavoring to do still better"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODk5NDgw", "url": "https://github.com/apache/iotdb/pull/796#pullrequestreview-357899480", "createdAt": "2020-02-13T01:18:45Z", "commit": {"oid": "c991383bb5e55b2f3f2ba75072cd214207d8034d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMToxODo0NlrOFpEJ9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMToxODo0NlrOFpEJ9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODYwNDAyMg==", "bodyText": "This logic is a little strange", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378604022", "createdAt": "2020-02-13T01:18:46Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java", "diffHunk": "@@ -80,45 +78,42 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public AlignByDeviceDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n-    //BuildOutDataTypes();\n+    this.deviceToMeasurementsMap = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n \n-    if (queryPlan instanceof GroupByPlan) {\n-      this.dataSetType = DataSetType.GROUPBY;\n-      // assign parameters\n-      this.unit = ((GroupByPlan) queryPlan).getInterval();\n-      this.slidingStep = ((GroupByPlan) queryPlan).getSlidingStep();\n-      this.startTime = ((GroupByPlan) queryPlan).getStartTime();\n-      this.endTime = ((GroupByPlan) queryPlan).getEndTime();\n-\n-    } else if (queryPlan instanceof AggregationPlan) {\n-      this.dataSetType = DataSetType.AGGREGATE;\n-\n-    } else if (queryPlan instanceof FillQueryPlan) {\n-      this.dataSetType = DataSetType.FILL;\n-      // assign parameters\n-      this.queryTime = ((FillQueryPlan) queryPlan).getQueryTime();\n-      this.fillType = ((FillQueryPlan) queryPlan).getFillType();\n-    } else {\n-      this.dataSetType = DataSetType.QUERY;\n+    switch (alignByDevicePlan.getOperatorType()){\n+      case GROUPBY:\n+        this.dataSetType = DataSetType.GROUPBY;\n+        this.groupByPlan = alignByDevicePlan.getGroupByPlan();\n+        break;\n+      case AGGREGATION:\n+        this.dataSetType = DataSetType.AGGREGATE;\n+        this.aggregationPlan = alignByDevicePlan.getAggregationPlan();\n+        break;\n+      case FILL:\n+        this.dataSetType = DataSetType.FILL;\n+        this.fillQueryPlan = alignByDevicePlan.getFillQueryPlan();\n+        break;\n+      default:\n+        this.dataSetType = DataSetType.QUERY;\n+        this.rawDataQueryPlan = new RawDataQueryPlan();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c991383bb5e55b2f3f2ba75072cd214207d8034d"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "749fb8f6105f369d81a6c22960ebefcc3584d2c0", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/749fb8f6105f369d81a6c22960ebefcc3584d2c0", "committedDate": "2020-02-13T03:54:43Z", "message": "Fix a comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66b118723808602c8fb149e3deacb689f857c2f9", "author": {"user": {"login": "Alima777", "name": "Xiangwei Wei"}}, "url": "https://github.com/apache/iotdb/commit/66b118723808602c8fb149e3deacb689f857c2f9", "committedDate": "2020-02-13T03:55:49Z", "message": "Fix a comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3OTQxOTcy", "url": "https://github.com/apache/iotdb/pull/796#pullrequestreview-357941972", "createdAt": "2020-02-13T04:01:17Z", "commit": {"oid": "66b118723808602c8fb149e3deacb689f857c2f9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3331, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}