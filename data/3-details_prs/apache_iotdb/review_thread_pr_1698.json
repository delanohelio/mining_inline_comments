{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMTYzNTY2", "number": 1698, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMjoyNDo0OFrOEhex3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxODo0M1rOEiWH1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTQyNzQ4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMjoyNDo0OVrOHO0Uhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwMzozOTo1N1rOHSe4WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI5OTMzNQ==", "bodyText": "Does every physical plan have to have a userName?\nfor OOP, I do not think its a good design.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r485299335", "createdAt": "2020-09-09T02:24:49Z", "author": {"login": "neuyilan"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java", "diffHunk": "@@ -48,6 +48,7 @@\n \n   private static final String SERIALIZATION_UNIMPLEMENTED = \"serialization unimplemented\";\n \n+  protected String userName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b093fbe89c2309caeeca0221cf9cefcd7531e42d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMyNzAxMQ==", "bodyText": "Yes, I will change it to AuthorPlan only. Thank you for your comment!", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r485327011", "createdAt": "2020-09-09T04:15:38Z", "author": {"login": "haimeiguo"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java", "diffHunk": "@@ -48,6 +48,7 @@\n \n   private static final String SERIALIZATION_UNIMPLEMENTED = \"serialization unimplemented\";\n \n+  protected String userName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI5OTMzNQ=="}, "originalCommit": {"oid": "b093fbe89c2309caeeca0221cf9cefcd7531e42d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE0MjM2MA==", "bodyText": "I have a different opinion. Every physical plan is issued by a user and keeping this information will help us tracking user behaviors in the future.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r489142360", "createdAt": "2020-09-16T03:39:57Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/PhysicalPlan.java", "diffHunk": "@@ -48,6 +48,7 @@\n \n   private static final String SERIALIZATION_UNIMPLEMENTED = \"serialization unimplemented\";\n \n+  protected String userName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI5OTMzNQ=="}, "originalCommit": {"oid": "b093fbe89c2309caeeca0221cf9cefcd7531e42d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MDc5NzQ4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo0NjoxMlrOHPnPxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo0NjoxMlrOHPnPxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzcwMA==", "bodyText": "delete the blank space.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486133700", "createdAt": "2020-09-10T07:46:12Z", "author": {"login": "mychaow"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1059,7 +1060,7 @@ protected boolean deleteStorageGroups(DeleteStorageGroupPlan deleteStorageGroupP\n     }\n     return true;\n   }\n-\n+  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0839efb75458ec6ed8daa2648526009ddb268c9d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MDc5OTEwOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBAuthorizationIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo0NjozOFrOHPnQwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxNjoxOFrOHQK37w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzk1Mw==", "bodyText": "delete the blank space.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486133953", "createdAt": "2020-09-10T07:46:38Z", "author": {"login": "mychaow"}, "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBAuthorizationIT.java", "diffHunk": "@@ -793,15 +793,19 @@ public void testListRolePrivileges() throws ClassNotFoundException, SQLException\n \n     try {\n       adminStmt.execute(\"CREATE ROLE role1\");\n-      adminStmt.execute(\n+      ResultSet resultSet = adminStmt.executeQuery(\"LIST ROLE PRIVILEGES role1\");\n+      String ans = \"\";\n+      try {\n+        //not granted list role privilege, should return empty\n+        validateResultSet(resultSet, ans);\n+\n+        adminStmt.execute(\n           \"GRANT ROLE role1 PRIVILEGES 'READ_TIMESERIES','INSERT_TIMESERIES','DELETE_TIMESERIES' ON root.a.b.c\");\n-      adminStmt.execute(\n+        adminStmt.execute(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0839efb75458ec6ed8daa2648526009ddb268c9d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzQyMw==", "bodyText": "done. Thank you :)", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717423", "createdAt": "2020-09-11T01:16:18Z", "author": {"login": "haimeiguo"}, "path": "server/src/test/java/org/apache/iotdb/db/integration/IoTDBAuthorizationIT.java", "diffHunk": "@@ -793,15 +793,19 @@ public void testListRolePrivileges() throws ClassNotFoundException, SQLException\n \n     try {\n       adminStmt.execute(\"CREATE ROLE role1\");\n-      adminStmt.execute(\n+      ResultSet resultSet = adminStmt.executeQuery(\"LIST ROLE PRIVILEGES role1\");\n+      String ans = \"\";\n+      try {\n+        //not granted list role privilege, should return empty\n+        validateResultSet(resultSet, ans);\n+\n+        adminStmt.execute(\n           \"GRANT ROLE role1 PRIVILEGES 'READ_TIMESERIES','INSERT_TIMESERIES','DELETE_TIMESERIES' ON root.a.b.c\");\n-      adminStmt.execute(\n+        adminStmt.execute(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzMzk1Mw=="}, "originalCommit": {"oid": "0839efb75458ec6ed8daa2648526009ddb268c9d"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDQ4ODM1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxNTowNVrOHQK2mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxNTowNVrOHQK2mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzA4MA==", "bodyText": "What is this index for?", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717080", "createdAt": "2020-09-11T01:15:05Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1116,14 +1125,26 @@ private ListDataSet executeListRole() {\n     return dataSet;\n   }\n \n-  private ListDataSet executeListUser() {\n-    List<String> userList = authorizer.listAllUsers();\n+  private ListDataSet executeListUser(AuthorPlan plan) throws AuthException {\n+    List<PartialPath> paths = new ArrayList<>();\n+    paths.add(plan.getNodeName());\n+    // check if current user is granted list_user privilege\n+    boolean hasListUserPrivilege = AuthorityChecker\n+        .check(plan.getLoginUserName(), paths, plan.getOperatorType(), plan.getLoginUserName());\n+\n     List<PartialPath> headerList = new ArrayList<>();\n     List<TSDataType> typeList = new ArrayList<>();\n     headerList.add(new PartialPath(COLUMN_USER, false));\n     typeList.add(TSDataType.TEXT);\n-    int index = 0;\n     ListDataSet dataSet = new ListDataSet(headerList, typeList);\n+\n+    if (!hasListUserPrivilege) {\n+      return dataSet;\n+    }\n+\n+    List<String> userList = authorizer.listAllUsers();\n+    int index = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDQ5MDQ5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxNjowOFrOHQK3xQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxNjowOFrOHQK3xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzM4MQ==", "bodyText": "Better replaced with Collections.singletonList()", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717381", "createdAt": "2020-09-11T01:16:08Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1116,14 +1125,26 @@ private ListDataSet executeListRole() {\n     return dataSet;\n   }\n \n-  private ListDataSet executeListUser() {\n-    List<String> userList = authorizer.listAllUsers();\n+  private ListDataSet executeListUser(AuthorPlan plan) throws AuthException {\n+    List<PartialPath> paths = new ArrayList<>();\n+    paths.add(plan.getNodeName());\n+    // check if current user is granted list_user privilege", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDQ5MTIxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxNjozNlrOHQK4OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxNjozNlrOHQK4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxNzQ5Nw==", "bodyText": "Better replaced with Collections.emptyList().", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486717497", "createdAt": "2020-09-11T01:16:36Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/executor/PlanExecutor.java", "diffHunk": "@@ -1098,13 +1099,21 @@ protected QueryDataSet processAuthorQuery(AuthorPlan plan)\n     return dataSet;\n   }\n \n-  private ListDataSet executeListRole() {\n+  private ListDataSet executeListRole(AuthorPlan plan) throws AuthException {\n     int index = 0;\n     List<PartialPath> headerList = new ArrayList<>();\n     List<TSDataType> typeList = new ArrayList<>();\n     headerList.add(new PartialPath(COLUMN_ROLE, false));\n     typeList.add(TSDataType.TEXT);\n     ListDataSet dataSet = new ListDataSet(headerList, typeList);\n+\n+    boolean hasListRolePrivilege = AuthorityChecker\n+        .check(plan.getLoginUserName(), new ArrayList<>(), plan.getOperatorType(), plan.getLoginUserName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDQ5NDk0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/sys/AuthorPlan.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMToxODo0M1rOHQK6Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMjo1MjowMFrOHQdj-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxODA0Nw==", "bodyText": "I think maybe we can push loginUserName down to PhysicalPlan. It is often meaningful to know who issued this plan.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r486718047", "createdAt": "2020-09-11T01:18:43Z", "author": {"login": "jt2594838"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/sys/AuthorPlan.java", "diffHunk": "@@ -39,12 +39,13 @@\n public class AuthorPlan extends PhysicalPlan {\n \n   private AuthorOperator.AuthorType authorType;\n-  private String userName;\n   private String roleName;\n   private String password;\n   private String newPassword;\n   private Set<Integer> permissions;\n   private PartialPath nodeName;\n+  private String userName;\n+  private String loginUserName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAyMzYwOA==", "bodyText": "done. thank you!\nindex is for rowRocord, it was there before my edit.", "url": "https://github.com/apache/iotdb/pull/1698#discussion_r487023608", "createdAt": "2020-09-11T12:52:00Z", "author": {"login": "haimeiguo"}, "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/sys/AuthorPlan.java", "diffHunk": "@@ -39,12 +39,13 @@\n public class AuthorPlan extends PhysicalPlan {\n \n   private AuthorOperator.AuthorType authorType;\n-  private String userName;\n   private String roleName;\n   private String password;\n   private String newPassword;\n   private Set<Integer> permissions;\n   private PartialPath nodeName;\n+  private String userName;\n+  private String loginUserName;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcxODA0Nw=="}, "originalCommit": {"oid": "2e1f8c28da17a3b5b6eb3966fbb368738e74f5b3"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 791, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}