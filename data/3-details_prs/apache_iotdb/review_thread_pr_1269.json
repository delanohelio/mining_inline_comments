{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMTEwNzE2", "number": 1269, "reviewThreads": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMDoxNToyNlrOD_nFbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzo0ODozN1rOEAGhvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDI3MjQ1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMDoxNToyNlrOGaXxIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNDowMToxM1rOGa4qAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMwNTU2OA==", "bodyText": "I'm not sure if this init array size is good or not. Please take a look.", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430305568", "createdAt": "2020-05-26T10:15:26Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -63,16 +63,22 @@\n   public static final String RESOURCE_SUFFIX = \".resource\";\n   static final String TEMP_SUFFIX = \".temp\";\n   private static final String CLOSING_SUFFIX = \".closing\";\n+  private static final int INIT_ARRAY_SIZE = 64;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84b57b081267dc21d213db2cc0d9f3053dba9887"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxNzY5MA==", "bodyText": "In the worst case, it may waste nearly half memory of startTimes and endTimes. From this point of view, I think it may be not a better choice than Map<String, long[]> deviceToStartEndTime.", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430817690", "createdAt": "2020-05-27T02:07:11Z", "author": {"login": "fanhualta"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -63,16 +63,22 @@\n   public static final String RESOURCE_SUFFIX = \".resource\";\n   static final String TEMP_SUFFIX = \".temp\";\n   private static final String CLOSING_SUFFIX = \".closing\";\n+  private static final int INIT_ARRAY_SIZE = 64;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMwNTU2OA=="}, "originalCommit": {"oid": "84b57b081267dc21d213db2cc0d9f3053dba9887"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0NDQxOQ==", "bodyText": "Here is an advice from @qiaojialin. When closing a resource, remove the redundant length of startTimes and endTimes. And when enlarging the arrays, use  * 1.5 instead.\nBy the way, the maximum number of devices in this TsFileResource shouldn't exceed the number of devices in the storage group. I'm looking for a way to find out this number.", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430844419", "createdAt": "2020-05-27T04:01:13Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -63,16 +63,22 @@\n   public static final String RESOURCE_SUFFIX = \".resource\";\n   static final String TEMP_SUFFIX = \".temp\";\n   private static final String CLOSING_SUFFIX = \".closing\";\n+  private static final int INIT_ARRAY_SIZE = 64;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMwNTU2OA=="}, "originalCommit": {"oid": "84b57b081267dc21d213db2cc0d9f3053dba9887"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzQxMTczOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMTo1Nzo0MVrOGa244A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0ODo1NVrOGa4ffg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxNTQ1Ng==", "bodyText": "You will read the time twice if it's valid. It's better to recording the result of getStartTime(deviceId) with temporary variables.", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430815456", "createdAt": "2020-05-27T01:57:41Z", "author": {"login": "fanhualta"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -339,12 +363,91 @@ public long getFileSize() {\n     return file.length();\n   }\n \n-  public Map<String, Long> getStartTimeMap() {\n-    return startTimeMap;\n+  public long getStartTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return startTimes[deviceToIndex.get(deviceId)];\n   }\n \n-  public Map<String, Long> getEndTimeMap() {\n-    return endTimeMap;\n+  public long getEndTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return endTimes[deviceToIndex.get(deviceId)];\n+  }\n+\n+  public long getOrDefaultStartTime(String deviceId, long defaultTime) {\n+    return getStartTime(deviceId) >= 0 ? startTimes[deviceToIndex.get(deviceId)] : defaultTime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 212}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MTcyNg==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430841726", "createdAt": "2020-05-27T03:48:55Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -339,12 +363,91 @@ public long getFileSize() {\n     return file.length();\n   }\n \n-  public Map<String, Long> getStartTimeMap() {\n-    return startTimeMap;\n+  public long getStartTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return startTimes[deviceToIndex.get(deviceId)];\n   }\n \n-  public Map<String, Long> getEndTimeMap() {\n-    return endTimeMap;\n+  public long getEndTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return endTimes[deviceToIndex.get(deviceId)];\n+  }\n+\n+  public long getOrDefaultStartTime(String deviceId, long defaultTime) {\n+    return getStartTime(deviceId) >= 0 ? startTimes[deviceToIndex.get(deviceId)] : defaultTime;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxNTQ1Ng=="}, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 212}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzQxMjAxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMTo1Nzo1MFrOGa25DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0OTowNVrOGa4foQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxNTUwMQ==", "bodyText": "You will read the time twice if it's valid. It's better to recording the result of getStartTime(deviceId) with temporary variables.", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430815501", "createdAt": "2020-05-27T01:57:50Z", "author": {"login": "fanhualta"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -339,12 +363,91 @@ public long getFileSize() {\n     return file.length();\n   }\n \n-  public Map<String, Long> getStartTimeMap() {\n-    return startTimeMap;\n+  public long getStartTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return startTimes[deviceToIndex.get(deviceId)];\n   }\n \n-  public Map<String, Long> getEndTimeMap() {\n-    return endTimeMap;\n+  public long getEndTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return endTimes[deviceToIndex.get(deviceId)];\n+  }\n+\n+  public long getOrDefaultStartTime(String deviceId, long defaultTime) {\n+    return getStartTime(deviceId) >= 0 ? startTimes[deviceToIndex.get(deviceId)] : defaultTime;\n+  }\n+\n+  public long getOrDefaultEndTime(String deviceId, long defaultTime) {\n+    return getEndTime(deviceId) >= 0 ? endTimes[deviceToIndex.get(deviceId)] : defaultTime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 216}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MTc2MQ==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430841761", "createdAt": "2020-05-27T03:49:05Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -339,12 +363,91 @@ public long getFileSize() {\n     return file.length();\n   }\n \n-  public Map<String, Long> getStartTimeMap() {\n-    return startTimeMap;\n+  public long getStartTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return startTimes[deviceToIndex.get(deviceId)];\n   }\n \n-  public Map<String, Long> getEndTimeMap() {\n-    return endTimeMap;\n+  public long getEndTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return endTimes[deviceToIndex.get(deviceId)];\n+  }\n+\n+  public long getOrDefaultStartTime(String deviceId, long defaultTime) {\n+    return getStartTime(deviceId) >= 0 ? startTimes[deviceToIndex.get(deviceId)] : defaultTime;\n+  }\n+\n+  public long getOrDefaultEndTime(String deviceId, long defaultTime) {\n+    return getEndTime(deviceId) >= 0 ? endTimes[deviceToIndex.get(deviceId)] : defaultTime;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxNTUwMQ=="}, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 216}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzQyOTcyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMjoxMDowNlrOGa3ERA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0OTozNlrOGa4gFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxODM3Mg==", "bodyText": "Same issue as above.", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430818372", "createdAt": "2020-05-27T02:10:06Z", "author": {"login": "fanhualta"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -318,12 +318,18 @@ private void recover() throws StorageGroupProcessorException {\n \n     for (TsFileResource resource : sequenceFileTreeSet) {\n       long timePartitionId = resource.getTimePartition();\n+      Map<String, Long> endTimeMap = new HashMap<>();\n+      for (Entry<String, Integer> entry : resource.getDeviceToIndexMap().entrySet()) {\n+        String deviceId = entry.getKey();\n+        long endTime = resource.getEndTime(deviceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MTg3Nw==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430841877", "createdAt": "2020-05-27T03:49:36Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -318,12 +318,18 @@ private void recover() throws StorageGroupProcessorException {\n \n     for (TsFileResource resource : sequenceFileTreeSet) {\n       long timePartitionId = resource.getTimePartition();\n+      Map<String, Long> endTimeMap = new HashMap<>();\n+      for (Entry<String, Integer> entry : resource.getDeviceToIndexMap().entrySet()) {\n+        String deviceId = entry.getKey();\n+        long endTime = resource.getEndTime(deviceId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxODM3Mg=="}, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzQzNTQzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/merge/selector/MaxFileMergeFileSelector.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMjoxNDowMVrOGa3H4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo0OTo1MlrOGa4gVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxOTI5OQ==", "bodyText": "If we already have the index info, that is entry.getValue(). It will be more efficient to get from endTimes by index directly. Otherwise, it will hash twice and find in bucket in ConcurrentHashMap. Other iterations have similar problems, please have a look too.", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430819299", "createdAt": "2020-05-27T02:14:01Z", "author": {"login": "fanhualta"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/merge/selector/MaxFileMergeFileSelector.java", "diffHunk": "@@ -213,18 +213,18 @@ private boolean checkClosed(TsFileResource unseqFile) {\n   private void selectOverlappedSeqFiles(TsFileResource unseqFile) {\n \n     int tmpSelectedNum = 0;\n-    for (Entry<String, Long> deviceStartTimeEntry : unseqFile.getStartTimeMap().entrySet()) {\n+    for (Entry<String, Integer> deviceStartTimeEntry : unseqFile.getDeviceToIndexMap().entrySet()) {\n       String deviceId = deviceStartTimeEntry.getKey();\n-      Long unseqStartTime = deviceStartTimeEntry.getValue();\n-      Long unseqEndTime = unseqFile.getEndTimeMap().get(deviceId);\n+      long unseqStartTime = unseqFile.getStartTime(deviceId);\n+      long unseqEndTime = unseqFile.getEndTime(deviceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MTk0Mw==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430841943", "createdAt": "2020-05-27T03:49:52Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/merge/selector/MaxFileMergeFileSelector.java", "diffHunk": "@@ -213,18 +213,18 @@ private boolean checkClosed(TsFileResource unseqFile) {\n   private void selectOverlappedSeqFiles(TsFileResource unseqFile) {\n \n     int tmpSelectedNum = 0;\n-    for (Entry<String, Long> deviceStartTimeEntry : unseqFile.getStartTimeMap().entrySet()) {\n+    for (Entry<String, Integer> deviceStartTimeEntry : unseqFile.getDeviceToIndexMap().entrySet()) {\n       String deviceId = deviceStartTimeEntry.getKey();\n-      Long unseqStartTime = deviceStartTimeEntry.getValue();\n-      Long unseqEndTime = unseqFile.getEndTimeMap().get(deviceId);\n+      long unseqStartTime = unseqFile.getStartTime(deviceId);\n+      long unseqEndTime = unseqFile.getEndTime(deviceId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxOTI5OQ=="}, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzQzNjQ1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMjoxNDozOVrOGa3IeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo1MDowNFrOGa4gjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxOTQ0OQ==", "bodyText": "Same issue as above.", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430819449", "createdAt": "2020-05-27T02:14:39Z", "author": {"login": "fanhualta"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -344,16 +350,16 @@ private void updateLastestFlushedTime() throws IOException {\n     VersionController versionController = new SimpleFileVersionController(storageGroupSysDir.getPath());\n     long currentVersion = versionController.currVersion();\n     for (TsFileResource resource : upgradeSeqFileList) {\n-      for (Entry<String, Long> entry : resource.getEndTimeMap().entrySet()) {\n+      for (Entry<String, Integer> entry : resource.getDeviceToIndexMap().entrySet()) {\n         String deviceId = entry.getKey();\n-        long endTime = entry.getValue();\n+        long endTime = resource.getEndTime(deviceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MTk5OQ==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430841999", "createdAt": "2020-05-27T03:50:04Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -344,16 +350,16 @@ private void updateLastestFlushedTime() throws IOException {\n     VersionController versionController = new SimpleFileVersionController(storageGroupSysDir.getPath());\n     long currentVersion = versionController.currVersion();\n     for (TsFileResource resource : upgradeSeqFileList) {\n-      for (Entry<String, Long> entry : resource.getEndTimeMap().entrySet()) {\n+      for (Entry<String, Integer> entry : resource.getDeviceToIndexMap().entrySet()) {\n         String deviceId = entry.getKey();\n-        long endTime = entry.getValue();\n+        long endTime = resource.getEndTime(deviceId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxOTQ0OQ=="}, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MzQzNjYyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMjoxNDo0NlrOGa3InA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwMzo1MDoxOFrOGa4gwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxOTQ4NA==", "bodyText": "Same issue as above.", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430819484", "createdAt": "2020-05-27T02:14:46Z", "author": {"login": "fanhualta"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -344,16 +350,16 @@ private void updateLastestFlushedTime() throws IOException {\n     VersionController versionController = new SimpleFileVersionController(storageGroupSysDir.getPath());\n     long currentVersion = versionController.currVersion();\n     for (TsFileResource resource : upgradeSeqFileList) {\n-      for (Entry<String, Long> entry : resource.getEndTimeMap().entrySet()) {\n+      for (Entry<String, Integer> entry : resource.getDeviceToIndexMap().entrySet()) {\n         String deviceId = entry.getKey();\n-        long endTime = entry.getValue();\n+        long endTime = resource.getEndTime(deviceId);\n         long endTimePartitionId = StorageEngine.getTimePartition(endTime);\n         latestTimeForEachDevice.computeIfAbsent(endTimePartitionId, l -> new HashMap<>())\n                 .put(deviceId, endTime);\n-        globalLatestFlushedTimeForEachDevice.putAll(resource.getEndTimeMap());\n+        globalLatestFlushedTimeForEachDevice.put(deviceId, endTime);\n \n         // set all the covered partition's LatestFlushedTime to Long.MAX_VALUE\n-        long partitionId = StorageEngine.getTimePartition(resource.startTimeMap.get(deviceId));\n+        long partitionId = StorageEngine.getTimePartition(resource.getStartTime(deviceId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg0MjA0OQ==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r430842049", "createdAt": "2020-05-27T03:50:18Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/StorageGroupProcessor.java", "diffHunk": "@@ -344,16 +350,16 @@ private void updateLastestFlushedTime() throws IOException {\n     VersionController versionController = new SimpleFileVersionController(storageGroupSysDir.getPath());\n     long currentVersion = versionController.currVersion();\n     for (TsFileResource resource : upgradeSeqFileList) {\n-      for (Entry<String, Long> entry : resource.getEndTimeMap().entrySet()) {\n+      for (Entry<String, Integer> entry : resource.getDeviceToIndexMap().entrySet()) {\n         String deviceId = entry.getKey();\n-        long endTime = entry.getValue();\n+        long endTime = resource.getEndTime(deviceId);\n         long endTimePartitionId = StorageEngine.getTimePartition(endTime);\n         latestTimeForEachDevice.computeIfAbsent(endTimePartitionId, l -> new HashMap<>())\n                 .put(deviceId, endTime);\n-        globalLatestFlushedTimeForEachDevice.putAll(resource.getEndTimeMap());\n+        globalLatestFlushedTimeForEachDevice.put(deviceId, endTime);\n \n         // set all the covered partition's LatestFlushedTime to Long.MAX_VALUE\n-        long partitionId = StorageEngine.getTimePartition(resource.startTimeMap.get(deviceId));\n+        long partitionId = StorageEngine.getTimePartition(resource.getStartTime(deviceId));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDgxOTQ4NA=="}, "originalCommit": {"oid": "063a02d4e87ce12506ce3ffbbf7f01df88cc871b"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTMyNDU1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzoyNjowN1rOGbKAuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo0ODo1NlrOGbi9mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEyODc2Mw==", "bodyText": "You can fill startTime by MAX_VALUE and fill endTimes by MIN_VALUE", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431128763", "createdAt": "2020-05-27T13:26:07Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -221,18 +237,22 @@ private void generateTimeSeriesMetadata() throws IOException {\n     }\n   }\n \n+  private void initTimes(long[] times) {\n+    Arrays.fill(times, -1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzNzU2Mg==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431537562", "createdAt": "2020-05-28T01:48:56Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -221,18 +237,22 @@ private void generateTimeSeriesMetadata() throws IOException {\n     }\n   }\n \n+  private void initTimes(long[] times) {\n+    Arrays.fill(times, -1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEyODc2Mw=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTMyOTA3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzoyNzowOVrOGbKDpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo0OTowN1rOGbi9wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEyOTUwOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * end times array. The values in this array are -1 if it's an unsealed sequence tsfile\n          \n          \n            \n               * end times array. The values in this array are Long.MIN_VALUE if it's an unsealed sequence tsfile", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431129509", "createdAt": "2020-05-27T13:27:09Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -63,16 +64,22 @@\n   public static final String RESOURCE_SUFFIX = \".resource\";\n   static final String TEMP_SUFFIX = \".temp\";\n   private static final String CLOSING_SUFFIX = \".closing\";\n+  private static final int INIT_ARRAY_SIZE = 64;\n \n   /**\n-   * device -> start time\n+   * start times array. \n    */\n-  protected Map<String, Long> startTimeMap;\n+  private long[] startTimes;\n \n   /**\n-   * device -> end time. It is null if it's an unsealed sequence tsfile\n+   * end times array. The values in this array are -1 if it's an unsealed sequence tsfile", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzNzYwMA==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431537600", "createdAt": "2020-05-28T01:49:07Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -63,16 +64,22 @@\n   public static final String RESOURCE_SUFFIX = \".resource\";\n   static final String TEMP_SUFFIX = \".temp\";\n   private static final String CLOSING_SUFFIX = \".closing\";\n+  private static final int INIT_ARRAY_SIZE = 64;\n \n   /**\n-   * device -> start time\n+   * start times array. \n    */\n-  protected Map<String, Long> startTimeMap;\n+  private long[] startTimes;\n \n   /**\n-   * device -> end time. It is null if it's an unsealed sequence tsfile\n+   * end times array. The values in this array are -1 if it's an unsealed sequence tsfile", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEyOTUwOQ=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTM2MDM0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzozNDoyOVrOGbKXtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1NDoyM1rOGbjDFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEzNDY0NQ==", "bodyText": "You can fill startTime by MAX_VALUE and fill endTimes by MIN_VALUE", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431134645", "createdAt": "2020-05-27T13:34:29Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -283,16 +306,16 @@ public void deserialize() throws IOException {\n   }\n \n   public void updateStartTime(String device, long time) {\n-    long startTime = startTimeMap.getOrDefault(device, Long.MAX_VALUE);\n+    long startTime = getOrDefaultStartTime(device, Long.MAX_VALUE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODk2NQ==", "bodyText": "Fixed", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431538965", "createdAt": "2020-05-28T01:54:23Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -283,16 +306,16 @@ public void deserialize() throws IOException {\n   }\n \n   public void updateStartTime(String device, long time) {\n-    long startTime = startTimeMap.getOrDefault(device, Long.MAX_VALUE);\n+    long startTime = getOrDefaultStartTime(device, Long.MAX_VALUE);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEzNDY0NQ=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 161}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTM2NTQ5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzozNTozOFrOGbKbDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1MDo1N1rOGbi_vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEzNTUwMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return -1;\n          \n          \n            \n                  return Long.MAX_VALUE;\n          \n      \n    \n    \n  \n\nis this ok?", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431135501", "createdAt": "2020-05-27T13:35:38Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -339,12 +362,106 @@ public long getFileSize() {\n     return file.length();\n   }\n \n-  public Map<String, Long> getStartTimeMap() {\n-    return startTimeMap;\n+  public long getStartTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODEwOA==", "bodyText": "Yes, of course.  Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431538108", "createdAt": "2020-05-28T01:50:57Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -339,12 +362,106 @@ public long getFileSize() {\n     return file.length();\n   }\n \n-  public Map<String, Long> getStartTimeMap() {\n-    return startTimeMap;\n+  public long getStartTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEzNTUwMQ=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 203}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTM2NzQwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzozNjowNFrOGbKcVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1MToxOVrOGbjACg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEzNTgyOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return -1;\n          \n          \n            \n                  return Long.MIN_TIME;", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431135828", "createdAt": "2020-05-27T13:36:04Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -339,12 +362,106 @@ public long getFileSize() {\n     return file.length();\n   }\n \n-  public Map<String, Long> getStartTimeMap() {\n-    return startTimeMap;\n+  public long getStartTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return startTimes[deviceToIndex.get(deviceId)];\n+  }\n+\n+  public long getStartTime(int index) {\n+    return startTimes[index];\n+  }\n+\n+  public long getEndTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 214}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODE4Ng==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431538186", "createdAt": "2020-05-28T01:51:19Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/storagegroup/TsFileResource.java", "diffHunk": "@@ -339,12 +362,106 @@ public long getFileSize() {\n     return file.length();\n   }\n \n-  public Map<String, Long> getStartTimeMap() {\n-    return startTimeMap;\n+  public long getStartTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;\n+    }\n+    return startTimes[deviceToIndex.get(deviceId)];\n+  }\n+\n+  public long getStartTime(int index) {\n+    return startTimes[index];\n+  }\n+\n+  public long getEndTime(String deviceId) {\n+    if (!deviceToIndex.containsKey(deviceId)) {\n+      return -1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEzNTgyOA=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 214}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTM5MTQ3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzo0MTo0OFrOGbKsZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1MToyNlrOGbjAIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEzOTk0MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          Long minTimeOfO1 = o1.getEndTime(seriesPath.getDevice());\n          \n          \n            \n                          Long minTimeOfO2 = o2.getEndTime(seriesPath.getDevice());\n          \n          \n            \n                          Long maxTimeOfO1 = o1.getEndTime(seriesPath.getDevice());\n          \n          \n            \n                          Long maxTimeOfO2 = o2.getEndTime(seriesPath.getDevice());", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431139940", "createdAt": "2020-05-27T13:41:48Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java", "diffHunk": "@@ -183,11 +182,8 @@ private boolean shouldUpdate(long time, long version, long newTime, long newVers\n     PriorityQueue<TsFileResource> unseqTsFilesSet =\n         new PriorityQueue<>(\n             (o1, o2) -> {\n-              Map<String, Long> startTimeMap = o1.getEndTimeMap();\n-              Long minTimeOfO1 = startTimeMap.get(seriesPath.getDevice());\n-              Map<String, Long> startTimeMap2 = o2.getEndTimeMap();\n-              Long minTimeOfO2 = startTimeMap2.get(seriesPath.getDevice());\n-\n+              Long minTimeOfO1 = o1.getEndTime(seriesPath.getDevice());\n+              Long minTimeOfO2 = o2.getEndTime(seriesPath.getDevice());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODIxMQ==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431538211", "createdAt": "2020-05-28T01:51:26Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/query/executor/fill/LastPointReader.java", "diffHunk": "@@ -183,11 +182,8 @@ private boolean shouldUpdate(long time, long version, long newTime, long newVers\n     PriorityQueue<TsFileResource> unseqTsFilesSet =\n         new PriorityQueue<>(\n             (o1, o2) -> {\n-              Map<String, Long> startTimeMap = o1.getEndTimeMap();\n-              Long minTimeOfO1 = startTimeMap.get(seriesPath.getDevice());\n-              Map<String, Long> startTimeMap2 = o2.getEndTimeMap();\n-              Long minTimeOfO2 = startTimeMap2.get(seriesPath.getDevice());\n-\n+              Long minTimeOfO1 = o1.getEndTime(seriesPath.getDevice());\n+              Long minTimeOfO2 = o2.getEndTime(seriesPath.getDevice());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTEzOTk0MA=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTM5Njc2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/writelog/recover/LogReplayer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzo0Mjo1NlrOGbKvpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1MTozNVrOGbjAQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0MDc3Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (lastEndTime >= 0 && lastEndTime >= insertTabletPlan.getMinTime() &&\n          \n          \n            \n                  if (lastEndTime != Long.MIN_VALUE && lastEndTime >= insertTabletPlan.getMinTime() &&", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431140773", "createdAt": "2020-05-27T13:42:56Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/writelog/recover/LogReplayer.java", "diffHunk": "@@ -127,8 +127,8 @@ private void replayBatchInsert(InsertTabletPlan insertTabletPlan)\n       throws WriteProcessException, QueryProcessException {\n     if (currentTsFileResource != null) {\n       // the last chunk group may contain the same data with the logs, ignore such logs in seq file\n-      Long lastEndTime = currentTsFileResource.getEndTimeMap().get(insertTabletPlan.getDeviceId());\n-      if (lastEndTime != null && lastEndTime >= insertTabletPlan.getMinTime() &&\n+      long lastEndTime = currentTsFileResource.getEndTime(insertTabletPlan.getDeviceId());\n+      if (lastEndTime >= 0 && lastEndTime >= insertTabletPlan.getMinTime() &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODI0Mg==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431538242", "createdAt": "2020-05-28T01:51:35Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/writelog/recover/LogReplayer.java", "diffHunk": "@@ -127,8 +127,8 @@ private void replayBatchInsert(InsertTabletPlan insertTabletPlan)\n       throws WriteProcessException, QueryProcessException {\n     if (currentTsFileResource != null) {\n       // the last chunk group may contain the same data with the logs, ignore such logs in seq file\n-      Long lastEndTime = currentTsFileResource.getEndTimeMap().get(insertTabletPlan.getDeviceId());\n-      if (lastEndTime != null && lastEndTime >= insertTabletPlan.getMinTime() &&\n+      long lastEndTime = currentTsFileResource.getEndTime(insertTabletPlan.getDeviceId());\n+      if (lastEndTime >= 0 && lastEndTime >= insertTabletPlan.getMinTime() &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0MDc3Mw=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTM5NzYyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/writelog/recover/LogReplayer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzo0MzowNVrOGbKwLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1MTo0NVrOGbjAbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0MDkwOA==", "bodyText": "the same", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431140908", "createdAt": "2020-05-27T13:43:05Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/writelog/recover/LogReplayer.java", "diffHunk": "@@ -155,8 +155,8 @@ private void replayBatchInsert(InsertTabletPlan insertTabletPlan)\n   private void replayInsert(InsertPlan insertPlan) {\n     if (currentTsFileResource != null) {\n       // the last chunk group may contain the same data with the logs, ignore such logs in seq file\n-      Long lastEndTime = currentTsFileResource.getEndTimeMap().get(insertPlan.getDeviceId());\n-      if (lastEndTime != null && lastEndTime >= insertPlan.getTime() &&\n+      long lastEndTime = currentTsFileResource.getEndTime(insertPlan.getDeviceId());\n+      if (lastEndTime >= 0 && lastEndTime >= insertPlan.getTime() &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODI4NQ==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431538285", "createdAt": "2020-05-28T01:51:45Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/writelog/recover/LogReplayer.java", "diffHunk": "@@ -155,8 +155,8 @@ private void replayBatchInsert(InsertTabletPlan insertTabletPlan)\n   private void replayInsert(InsertPlan insertPlan) {\n     if (currentTsFileResource != null) {\n       // the last chunk group may contain the same data with the logs, ignore such logs in seq file\n-      Long lastEndTime = currentTsFileResource.getEndTimeMap().get(insertPlan.getDeviceId());\n-      if (lastEndTime != null && lastEndTime >= insertPlan.getTime() &&\n+      long lastEndTime = currentTsFileResource.getEndTime(insertPlan.getDeviceId());\n+      if (lastEndTime >= 0 && lastEndTime >= insertPlan.getTime() &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0MDkwOA=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTQxNjc0OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessorTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzo0NzoyNVrOGbK8mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMjoxOToxMFrOGbjbZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0NDA4OA==", "bodyText": "I don't understand why here set start time to end time before.....", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431144088", "createdAt": "2020-05-27T13:47:25Z", "author": {"login": "qiaojialin"}, "path": "server/src/test/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessorTest.java", "diffHunk": "@@ -282,9 +282,8 @@ public void testWriteAndClose() throws IOException, WriteProcessException{\n   private void closeTsFileProcessor(TsFileProcessor unsealedTsFileProcessor) throws TsFileProcessorException {\n     TsFileResource resource = unsealedTsFileProcessor.getTsFileResource();\n     synchronized (resource) {\n-      for (Entry<String, Long> startTime : resource.getStartTimeMap().entrySet()) {\n-        String deviceId = startTime.getKey();\n-        resource.getEndTimeMap().put(deviceId, resource.getStartTimeMap().get(deviceId));\n+      for (Entry<String, Integer> entry : resource.getDeviceToIndexMap().entrySet()) {\n+        resource.putEndTime(entry.getKey(), resource.getStartTime(entry.getValue()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0NTE5MA==", "bodyText": "I am confusing too...", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431545190", "createdAt": "2020-05-28T02:19:10Z", "author": {"login": "HTHou"}, "path": "server/src/test/java/org/apache/iotdb/db/engine/storagegroup/TsFileProcessorTest.java", "diffHunk": "@@ -282,9 +282,8 @@ public void testWriteAndClose() throws IOException, WriteProcessException{\n   private void closeTsFileProcessor(TsFileProcessor unsealedTsFileProcessor) throws TsFileProcessorException {\n     TsFileResource resource = unsealedTsFileProcessor.getTsFileResource();\n     synchronized (resource) {\n-      for (Entry<String, Long> startTime : resource.getStartTimeMap().entrySet()) {\n-        String deviceId = startTime.getKey();\n-        resource.getEndTimeMap().put(deviceId, resource.getStartTimeMap().get(deviceId));\n+      for (Entry<String, Integer> entry : resource.getDeviceToIndexMap().entrySet()) {\n+        resource.putEndTime(entry.getKey(), resource.getStartTime(entry.getValue()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0NDA4OA=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTQyMzk5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeMultiChunkTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzo0ODozOFrOGbLBVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1MTo1M1rOGbjAlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0NTMwMQ==", "bodyText": "== MAX_VALUE", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431145301", "createdAt": "2020-05-27T13:48:38Z", "author": {"login": "qiaojialin"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeMultiChunkTask.java", "diffHunk": "@@ -152,9 +152,9 @@ private void pathsMergeOneFile(int seqFileIdx, IPointReader[] unseqReaders)\n       throws IOException {\n     TsFileResource currTsFile = resource.getSeqFiles().get(seqFileIdx);\n     String deviceId = currMergingPaths.get(0).getDevice();\n-    Long currDeviceMinTime = currTsFile.getStartTimeMap().get(deviceId);\n+    long currDeviceMinTime = currTsFile.getStartTime(deviceId);\n     //COMMENTS: is this correct? how about if there are other devices (in the currMergingPaths) that have unseq data?\n-    if (currDeviceMinTime == null) {\n+    if (currDeviceMinTime < 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODMyNQ==", "bodyText": "Fixed~", "url": "https://github.com/apache/iotdb/pull/1269#discussion_r431538325", "createdAt": "2020-05-28T01:51:53Z", "author": {"login": "HTHou"}, "path": "server/src/main/java/org/apache/iotdb/db/engine/merge/task/MergeMultiChunkTask.java", "diffHunk": "@@ -152,9 +152,9 @@ private void pathsMergeOneFile(int seqFileIdx, IPointReader[] unseqReaders)\n       throws IOException {\n     TsFileResource currTsFile = resource.getSeqFiles().get(seqFileIdx);\n     String deviceId = currMergingPaths.get(0).getDevice();\n-    Long currDeviceMinTime = currTsFile.getStartTimeMap().get(deviceId);\n+    long currDeviceMinTime = currTsFile.getStartTime(deviceId);\n     //COMMENTS: is this correct? how about if there are other devices (in the currMergingPaths) that have unseq data?\n-    if (currDeviceMinTime == null) {\n+    if (currDeviceMinTime < 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0NTMwMQ=="}, "originalCommit": {"oid": "85277e9a2121370bdfc38f1ecd605f359707808a"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4877, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}