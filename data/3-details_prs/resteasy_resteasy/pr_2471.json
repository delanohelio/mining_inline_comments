{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MjI5Njk4", "number": 2471, "title": "[RESTEASY-2646]:Fix match cache in  RootNode grows infinitely", "bodyText": "", "createdAt": "2020-07-13T12:40:30Z", "url": "https://github.com/resteasy/resteasy/pull/2471", "merged": true, "mergeCommit": {"oid": "556fa437f4913848d60a9fdfe2369aceedc71397"}, "closed": true, "closedAt": "2020-07-17T09:06:00Z", "author": {"login": "jimma"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0fuwIAH2gAyNDQ4MjI5Njk4OjJhODQ4YWMyM2U2ZDBkMjI5N2RiODE1NTU1NGMzMzI4MWZkNGNhMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1avfEAFqTQ0OTYxOTE1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a848ac23e6d0d2297db8155554c33281fd4ca15", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/2a848ac23e6d0d2297db8155554c33281fd4ca15", "committedDate": "2020-07-13T11:28:16Z", "message": "[RESTEASY-2646]:Initial fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5875cf445737db02c6e9665da7ee2e140da22423", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/5875cf445737db02c6e9665da7ee2e140da22423", "committedDate": "2020-07-13T11:34:33Z", "message": "[RESTEASY-2646]:More improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/91036412da9ae08c3959d7b4ec33ddc2a584c0d8", "committedDate": "2020-07-13T12:31:27Z", "message": "[RESTEASY-2646]:Get match catch config from system property"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MjgzOTkw", "url": "https://github.com/resteasy/resteasy/pull/2471#pullrequestreview-447283990", "createdAt": "2020-07-13T14:06:29Z", "commit": {"oid": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDowNjoyOVrOGwqJxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDowNjoyOVrOGwqJxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3NTQ2Mw==", "bodyText": "You will never get a cache hit with \"boundary\" as equals() still checks parameters being equal.  Maybe just not cache at all if there is a \"boundary\"?", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r453675463", "createdAt": "2020-07-13T14:06:29Z", "author": {"login": "patriot1burke"}, "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/MatchCache.java", "diffHunk": "@@ -26,7 +26,11 @@ public Key(final HttpRequest request, final int start) {\n             this.path = start == 0 ? matchingPath : matchingPath.substring(start);\n             this.start = start;\n             this.method = request.getHttpMethod();\n-            this.contentType = request.getHttpHeaders().getMediaType();\n+            if (request.getHttpHeaders().getMediaType().getParameters().containsKey(\"boundary\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3OTk0Mjgz", "url": "https://github.com/resteasy/resteasy/pull/2471#pullrequestreview-447994283", "createdAt": "2020-07-14T10:45:27Z", "commit": {"oid": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMDo0NToyOFrOGxOSVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMDo0NToyOFrOGxOSVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI2NzQ3Ng==", "bodyText": "Why are here these extra braces?", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454267476", "createdAt": "2020-07-14T10:45:28Z", "author": {"login": "rsvoboda"}, "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/RootNode.java", "diffHunk": "@@ -56,10 +69,12 @@ public ResourceInvoker match(HttpRequest request, int start)\n          request.setAttribute(RESTEASY_CHOSEN_ACCEPT, match.chosen);\r\n       } else {\r\n          match = root.match(request, start);\r\n-         if (match.match != null && match.match.expression.getNumGroups() == 0 && match.invoker instanceof ResourceMethodInvoker) {\r\n+         if (cache.size() < CACHE_SIZE && match.match != null && match.match.expression.getNumGroups() == 0 && match.invoker instanceof ResourceMethodInvoker) {\r\n             //System.out.println(\"*** caching: \" + key.method + \" \" + key.path);\r\n             match.match = null;\r\n-            cache.putIfAbsent(key, match);\r\n+            {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3OTk2NzU1", "url": "https://github.com/resteasy/resteasy/pull/2471#pullrequestreview-447996755", "createdAt": "2020-07-14T10:49:30Z", "commit": {"oid": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMDo0OTozMFrOGxOaCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMDo0OTozMFrOGxOaCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDI2OTQ0OQ==", "bodyText": "So once the cache is full, nothing gets added / old entries removed?", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454269449", "createdAt": "2020-07-14T10:49:30Z", "author": {"login": "rsvoboda"}, "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/RootNode.java", "diffHunk": "@@ -56,10 +69,12 @@ public ResourceInvoker match(HttpRequest request, int start)\n          request.setAttribute(RESTEASY_CHOSEN_ACCEPT, match.chosen);\r\n       } else {\r\n          match = root.match(request, start);\r\n-         if (match.match != null && match.match.expression.getNumGroups() == 0 && match.invoker instanceof ResourceMethodInvoker) {\r\n+         if (cache.size() < CACHE_SIZE && match.match != null && match.match.expression.getNumGroups() == 0 && match.invoker instanceof ResourceMethodInvoker) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91036412da9ae08c3959d7b4ec33ddc2a584c0d8"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bb24dbd5e987353118dd26bd445a158c01b0f47", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/2bb24dbd5e987353118dd26bd445a158c01b0f47", "committedDate": "2020-07-14T11:55:21Z", "message": "Code cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MjAwNDUy", "url": "https://github.com/resteasy/resteasy/pull/2471#pullrequestreview-448200452", "createdAt": "2020-07-14T15:09:16Z", "commit": {"oid": "2bb24dbd5e987353118dd26bd445a158c01b0f47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNTowOToxN1rOGxYLTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNTowOToxN1rOGxYLTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQyOTUxOQ==", "bodyText": "is request.getHttpHeaders().getMediaType() always not null ? Just to be sure no NPE can jump from this.", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454429519", "createdAt": "2020-07-14T15:09:17Z", "author": {"login": "rsvoboda"}, "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/MatchCache.java", "diffHunk": "@@ -26,7 +26,11 @@ public Key(final HttpRequest request, final int start) {\n             this.path = start == 0 ? matchingPath : matchingPath.substring(start);\n             this.start = start;\n             this.method = request.getHttpMethod();\n-            this.contentType = request.getHttpHeaders().getMediaType();\n+            if (request.getHttpHeaders().getMediaType().getParameters().containsKey(\"boundary\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bb24dbd5e987353118dd26bd445a158c01b0f47"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTUwMDUx", "url": "https://github.com/resteasy/resteasy/pull/2471#pullrequestreview-448550051", "createdAt": "2020-07-15T00:21:53Z", "commit": {"oid": "2bb24dbd5e987353118dd26bd445a158c01b0f47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDoyMTo1M1rOGxpz_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMDoyMTo1M1rOGxpz_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcxODQ2Mw==", "bodyText": "MediaType.equals() checks the parameters, so I question removing all of the parameters when \"boundary\" is present. Actually, I guess, in principle, that it's possible to use the boundary parameter in a @consumes annotation, but it doesn't seem likely. So it seems reasonable to me to remove only the \"boundary\" parameter and leave the others in place.", "url": "https://github.com/resteasy/resteasy/pull/2471#discussion_r454718463", "createdAt": "2020-07-15T00:21:53Z", "author": {"login": "ronsigal"}, "path": "resteasy-core/src/main/java/org/jboss/resteasy/core/registry/MatchCache.java", "diffHunk": "@@ -26,7 +26,11 @@ public Key(final HttpRequest request, final int start) {\n             this.path = start == 0 ? matchingPath : matchingPath.substring(start);\n             this.start = start;\n             this.method = request.getHttpMethod();\n-            this.contentType = request.getHttpHeaders().getMediaType();\n+            if (request.getHttpHeaders().getMediaType().getParameters().containsKey(\"boundary\")) {\n+               this.contentType = new MediaType(request.getHttpHeaders().getMediaType().getType(), request.getHttpHeaders().getMediaType().getSubtype());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bb24dbd5e987353118dd26bd445a158c01b0f47"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "954578a0b0722140eb10b086915f300ac314898f", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/954578a0b0722140eb10b086915f300ac314898f", "committedDate": "2020-07-15T08:33:30Z", "message": "[RESTEASY-2646]:Without caching match if the ContentType contains parameters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db6a338a1a51c82a2ad8b5f8ab57ee3bbc7c98ea", "author": {"user": {"login": "rsvoboda", "name": "Rostislav Svoboda"}}, "url": "https://github.com/resteasy/resteasy/commit/db6a338a1a51c82a2ad8b5f8ab57ee3bbc7c98ea", "committedDate": "2020-07-15T09:04:21Z", "message": "Test for RootNode cache size limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f93993f3d7d18b3687206c2728c3b654796a6c3", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/5f93993f3d7d18b3687206c2728c3b654796a6c3", "committedDate": "2020-07-15T09:46:30Z", "message": "Fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2803010d91cd3b99a3293bcac2f5fe7ae2a3cd6", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/c2803010d91cd3b99a3293bcac2f5fe7ae2a3cd6", "committedDate": "2020-07-15T09:26:51Z", "message": "Fix test"}, "afterCommit": {"oid": "5f93993f3d7d18b3687206c2728c3b654796a6c3", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/5f93993f3d7d18b3687206c2728c3b654796a6c3", "committedDate": "2020-07-15T09:46:30Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NDI4MDg5", "url": "https://github.com/resteasy/resteasy/pull/2471#pullrequestreview-449428089", "createdAt": "2020-07-16T00:23:08Z", "commit": {"oid": "5f93993f3d7d18b3687206c2728c3b654796a6c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NjE5MTU4", "url": "https://github.com/resteasy/resteasy/pull/2471#pullrequestreview-449619158", "createdAt": "2020-07-16T08:13:28Z", "commit": {"oid": "5f93993f3d7d18b3687206c2728c3b654796a6c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1669, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}