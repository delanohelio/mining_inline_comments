{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NjQ0ODc0", "number": 2474, "title": "RESTEASY-2650: Use web.xml servlets for app path", "bodyText": "Also handle single class that is both an App and a resource class.\nResolves RESTEASY-2650", "createdAt": "2020-07-15T18:02:14Z", "url": "https://github.com/resteasy/resteasy/pull/2474", "merged": true, "mergeCommit": {"oid": "857b2040b81ffb69409d7ab3d8ff5eb6d32a0d85"}, "closed": true, "closedAt": "2020-12-18T03:37:23Z", "author": {"login": "andymc12"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGCvldAFqTQ4MzEwMTE2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMB-YTABqjM4MDM1MDI1Mjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTAxMTYw", "url": "https://github.com/resteasy/resteasy/pull/2474#pullrequestreview-483101160", "createdAt": "2020-09-05T23:52:33Z", "commit": {"oid": "a4857ca8c13d11b8e9e46d3279d72367e04d6165"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMzo1MjozM1rOHNlGJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMzo1MjozM1rOHNlGJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAwMTMxNw==", "bodyText": "Related to my question on RESTEASY-2650, about using the same Application on two different paths, wouldn't you want to add a servlet for each path? Maybe I'm on the wrong track here.", "url": "https://github.com/resteasy/resteasy/pull/2474#discussion_r484001317", "createdAt": "2020-09-05T23:52:33Z", "author": {"login": "ronsigal"}, "path": "resteasy-servlet-initializer/src/main/java/org/jboss/resteasy/plugins/servlet/ResteasyServletInitializer.java", "diffHunk": "@@ -99,69 +91,82 @@ protected void handleNoApplicationClass(Set<Class<?>> providers, Set<Class<?>> r\n    protected void register(Class<?> applicationClass, Set<Class<?>> providers, Set<Class<?>> resources, ServletContext servletContext)\r\n    {\r\n       ApplicationPath path = applicationClass.getAnnotation(ApplicationPath.class);\r\n+      ServletRegistration.Dynamic reg;\r\n+      String mapping;\r\n+      String prefix;\r\n       if (path == null)\r\n       {\r\n-         // todo we don't support this yet, i'm not sure if partial deployments are supported in all servlet containers\r\n-         return;\r\n+          if (servletContext.getServletRegistration(applicationClass.getName()) == null)\r\n+          {\r\n+              // Application subclass has no @ApplicationPath and no declared mappings to use\r\n+              return;\r\n+          }\r\n+          reg = servletContext.addServlet(applicationClass.getName(), HttpServlet30Dispatcher.class);\r\n+          Collection<String> mappings = reg.getMappings();\r\n+          if (mappings == null || mappings.isEmpty())\r\n+          {\r\n+              // no declared mappings\r\n+              return;\r\n+          }\r\n+          mapping = mappings.iterator().next();\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4857ca8c13d11b8e9e46d3279d72367e04d6165"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTAxMjM3", "url": "https://github.com/resteasy/resteasy/pull/2474#pullrequestreview-483101237", "createdAt": "2020-09-05T23:55:02Z", "commit": {"oid": "a4857ca8c13d11b8e9e46d3279d72367e04d6165"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMzo1NTowMlrOHNlG4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMzo1NTowMlrOHNlG4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAwMTUwNQ==", "bodyText": "Shouldn't this go after the test \"if (mappings == null || mappings.isEmpty())\"?", "url": "https://github.com/resteasy/resteasy/pull/2474#discussion_r484001505", "createdAt": "2020-09-05T23:55:02Z", "author": {"login": "ronsigal"}, "path": "resteasy-servlet-initializer/src/main/java/org/jboss/resteasy/plugins/servlet/ResteasyServletInitializer.java", "diffHunk": "@@ -99,69 +91,82 @@ protected void handleNoApplicationClass(Set<Class<?>> providers, Set<Class<?>> r\n    protected void register(Class<?> applicationClass, Set<Class<?>> providers, Set<Class<?>> resources, ServletContext servletContext)\r\n    {\r\n       ApplicationPath path = applicationClass.getAnnotation(ApplicationPath.class);\r\n+      ServletRegistration.Dynamic reg;\r\n+      String mapping;\r\n+      String prefix;\r\n       if (path == null)\r\n       {\r\n-         // todo we don't support this yet, i'm not sure if partial deployments are supported in all servlet containers\r\n-         return;\r\n+          if (servletContext.getServletRegistration(applicationClass.getName()) == null)\r\n+          {\r\n+              // Application subclass has no @ApplicationPath and no declared mappings to use\r\n+              return;\r\n+          }\r\n+          reg = servletContext.addServlet(applicationClass.getName(), HttpServlet30Dispatcher.class);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4857ca8c13d11b8e9e46d3279d72367e04d6165"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4857ca8c13d11b8e9e46d3279d72367e04d6165", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/a4857ca8c13d11b8e9e46d3279d72367e04d6165", "committedDate": "2020-07-15T18:00:36Z", "message": "RESTEASY-2650: Use web.xml servlets for app path\n\nAlso handle single class that is both an App and a resource class.\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}, "afterCommit": {"oid": "da66d849a24c348564a4f582d9d008b0511c34b8", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/da66d849a24c348564a4f582d9d008b0511c34b8", "committedDate": "2020-09-10T03:36:53Z", "message": "RESTEASY-2650: Use web.xml servlets for app path\n\nAlso handle single class that is both an App and a resource class.\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da66d849a24c348564a4f582d9d008b0511c34b8", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/da66d849a24c348564a4f582d9d008b0511c34b8", "committedDate": "2020-09-10T03:36:53Z", "message": "RESTEASY-2650: Use web.xml servlets for app path\n\nAlso handle single class that is both an App and a resource class.\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}, "afterCommit": {"oid": "9fd833f0a7841b69c36200be7b6a0e021b5470e2", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/9fd833f0a7841b69c36200be7b6a0e021b5470e2", "committedDate": "2020-09-10T15:16:59Z", "message": "RESTEASY-2650: Use web.xml servlets for app path\n\nAlso handle single class that is both an App and a resource class.\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mzg0MDg5", "url": "https://github.com/resteasy/resteasy/pull/2474#pullrequestreview-486384089", "createdAt": "2020-09-10T23:49:01Z", "commit": {"oid": "9fd833f0a7841b69c36200be7b6a0e021b5470e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo0OTowMVrOHQJcXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo0OTowMVrOHQJcXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5Mzk4Mg==", "bodyText": "I'm just speculating here, not objecting.\nIn the JIRA you mentioned having two different servlets for the same Application. I suppose, in general, you would have two explicit  declarations, but I gather this is legal:\n<web-app>\n   <servlet-mapping>\n      <servlet-name>org.example.MyApplication</servlet-name>\n      <url-pattern>/myresources/*</url-pattern>\n      <url-pattern>/secure/myresources/*</url-pattern>\n   </servlet-mapping>\n</web-app>\n\nThe JAX-RS spec doesn't seem to say anything about that, so I guess it would be a new feature. Is it worth doing for RESTEasy 4.x?", "url": "https://github.com/resteasy/resteasy/pull/2474#discussion_r486693982", "createdAt": "2020-09-10T23:49:01Z", "author": {"login": "ronsigal"}, "path": "resteasy-servlet-initializer/src/main/java/org/jboss/resteasy/plugins/servlet/ResteasyServletInitializer.java", "diffHunk": "@@ -95,51 +85,91 @@ protected void handleNoApplicationClass(Set<Class<?>> providers, Set<Class<?>> r\n \r\n    }\r\n \r\n+   private Set<ServletRegistration> getServletsForApplication(Class<?> applicationClass, ServletContext servletContext)\r\n+   {\r\n+      Set<ServletRegistration> set = new HashSet<>();\r\n+      ServletRegistration reg = servletContext.getServletRegistration(applicationClass.getName());\r\n+      if (reg != null && reg.getMappings().size() == 1)\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fd833f0a7841b69c36200be7b6a0e021b5470e2"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mzg0Mjg2", "url": "https://github.com/resteasy/resteasy/pull/2474#pullrequestreview-486384286", "createdAt": "2020-09-10T23:49:31Z", "commit": {"oid": "9fd833f0a7841b69c36200be7b6a0e021b5470e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo0OTozMlrOHQJdHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo0OTozMlrOHQJdHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5NDE3NQ==", "bodyText": "Same comment.", "url": "https://github.com/resteasy/resteasy/pull/2474#discussion_r486694175", "createdAt": "2020-09-10T23:49:32Z", "author": {"login": "ronsigal"}, "path": "resteasy-servlet-initializer/src/main/java/org/jboss/resteasy/plugins/servlet/ResteasyServletInitializer.java", "diffHunk": "@@ -95,51 +85,91 @@ protected void handleNoApplicationClass(Set<Class<?>> providers, Set<Class<?>> r\n \r\n    }\r\n \r\n+   private Set<ServletRegistration> getServletsForApplication(Class<?> applicationClass, ServletContext servletContext)\r\n+   {\r\n+      Set<ServletRegistration> set = new HashSet<>();\r\n+      ServletRegistration reg = servletContext.getServletRegistration(applicationClass.getName());\r\n+      if (reg != null && reg.getMappings().size() == 1)\r\n+         set.add(reg);\r\n+\r\n+      for (ServletRegistration sr : servletContext.getServletRegistrations().values())\r\n+      {\r\n+         String appClassName = sr.getInitParameter(APPLICATION);\r\n+         if (applicationClass.getName().equals(appClassName) && sr.getMappings().size() == 1)\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fd833f0a7841b69c36200be7b6a0e021b5470e2"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mzg1Nzc4", "url": "https://github.com/resteasy/resteasy/pull/2474#pullrequestreview-486385778", "createdAt": "2020-09-10T23:53:50Z", "commit": {"oid": "9fd833f0a7841b69c36200be7b6a0e021b5470e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo1Mzo1MFrOHQJiLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMzo1Mzo1MFrOHQJiLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY5NTQ2OQ==", "bodyText": "The spec says\nIf the Application subclass is annotated with @ApplicationPath, implementations are REQUIRED to use\nthe value of this annotation appended with \u201d/*\u201d to define a mapping for the added server.  Otherwise,\nthe application MUST be packaged with a web.xml that specifies a servlet mapping. \n\nShouldn't this bit go first?", "url": "https://github.com/resteasy/resteasy/pull/2474#discussion_r486695469", "createdAt": "2020-09-10T23:53:50Z", "author": {"login": "ronsigal"}, "path": "resteasy-servlet-initializer/src/main/java/org/jboss/resteasy/plugins/servlet/ResteasyServletInitializer.java", "diffHunk": "@@ -95,51 +85,91 @@ protected void handleNoApplicationClass(Set<Class<?>> providers, Set<Class<?>> r\n \r\n    }\r\n \r\n+   private Set<ServletRegistration> getServletsForApplication(Class<?> applicationClass, ServletContext servletContext)\r\n+   {\r\n+      Set<ServletRegistration> set = new HashSet<>();\r\n+      ServletRegistration reg = servletContext.getServletRegistration(applicationClass.getName());\r\n+      if (reg != null && reg.getMappings().size() == 1)\r\n+         set.add(reg);\r\n+\r\n+      for (ServletRegistration sr : servletContext.getServletRegistrations().values())\r\n+      {\r\n+         String appClassName = sr.getInitParameter(APPLICATION);\r\n+         if (applicationClass.getName().equals(appClassName) && sr.getMappings().size() == 1)\r\n+            set.add(sr);\r\n+      }\r\n+      return set;\r\n+   }\r\n \r\n    protected void register(Class<?> applicationClass, Set<Class<?>> providers, Set<Class<?>> resources, ServletContext servletContext)\r\n    {\r\n+      Set<ServletRegistration> servletsForApp = getServletsForApplication(applicationClass, servletContext);\r\n+      // ignore @ApplicationPath if application is already mapped in web.xml\r\n+      if (!servletsForApp.isEmpty())\r\n+      {\r\n+         for (ServletRegistration servletReg : servletsForApp)\r\n+         {\r\n+            String servletClassName = servletReg.getClassName();\r\n+            if (servletClassName == null)\r\n+               servletContext.addServlet(servletReg.getName(), HttpServlet30Dispatcher.class);\r\n+            String prefix = servletReg.getMappings().iterator().next();\r\n+            if (prefix.endsWith(\"*\"))\r\n+               prefix = prefix.substring(0, prefix.length() - 1);\r\n+            if (prefix.length() > 1 && prefix.endsWith(\"/\"))\r\n+               prefix = prefix.substring(0, prefix.length() - 1);\r\n+            registerResourcesAndProviders(servletReg, providers, resources, applicationClass, prefix);\r\n+         }\r\n+         return;\r\n+      }\r\n       ApplicationPath path = applicationClass.getAnnotation(ApplicationPath.class);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fd833f0a7841b69c36200be7b6a0e021b5470e2"}, "originalPosition": 98}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "431c27a5e8e4203662ace8b16e7707619eb741fb", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/431c27a5e8e4203662ace8b16e7707619eb741fb", "committedDate": "2020-09-11T15:40:38Z", "message": "2650: Ensure `@ApplicationPath` is not overridden\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}, "afterCommit": {"oid": "9fd833f0a7841b69c36200be7b6a0e021b5470e2", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/9fd833f0a7841b69c36200be7b6a0e021b5470e2", "committedDate": "2020-09-10T15:16:59Z", "message": "RESTEASY-2650: Use web.xml servlets for app path\n\nAlso handle single class that is both an App and a resource class.\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ac1fc518c31ae5f9127ccb4450714bf73be5093", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/7ac1fc518c31ae5f9127ccb4450714bf73be5093", "committedDate": "2020-09-24T14:22:15Z", "message": "RESTEASY-2650: Use web.xml servlets for app path\n\nAlso handle single class that is both an App and a resource class.\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bf0e2396d460932b47637a6dd673bf83b2fa8d6", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/1bf0e2396d460932b47637a6dd673bf83b2fa8d6", "committedDate": "2020-09-24T14:22:15Z", "message": "Review comments - remove app-and-resource\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fd833f0a7841b69c36200be7b6a0e021b5470e2", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/9fd833f0a7841b69c36200be7b6a0e021b5470e2", "committedDate": "2020-09-10T15:16:59Z", "message": "RESTEASY-2650: Use web.xml servlets for app path\n\nAlso handle single class that is both an App and a resource class.\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}, "afterCommit": {"oid": "1bf0e2396d460932b47637a6dd673bf83b2fa8d6", "author": {"user": {"login": "andymc12", "name": "Andy McCright"}}, "url": "https://github.com/resteasy/resteasy/commit/1bf0e2396d460932b47637a6dd673bf83b2fa8d6", "committedDate": "2020-09-24T14:22:15Z", "message": "Review comments - remove app-and-resource\n\nSigned-off-by: Andy McCright <j.andrew.mccright@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1672, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}