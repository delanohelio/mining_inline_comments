{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5ODc3NjU3", "number": 2582, "title": "Add test for https://github.com/resteasy/Resteasy/pull/2578", "bodyText": "This PR is rebased with #2578 and changes  the following things:\n\nAdd executor to SSEPublisher to avoid block the Publisher emit\nAdd system property \"resteasy.microprofile.sseclient.buffersize\" to configure the Subscription queue size.\nAdd test for #2578 and configure the Subscription queue size to 5 to check the overflow behavior.", "createdAt": "2020-10-26T08:56:05Z", "url": "https://github.com/resteasy/resteasy/pull/2582", "merged": true, "mergeCommit": {"oid": "1cad12e3c0e99f1013218f262ca363a1d6cf1cfe"}, "closed": true, "closedAt": "2020-10-27T11:58:27Z", "author": {"login": "jimma"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVDYtcgH2gAyNTA5ODc3NjU3OjNiZTMzYmFlYjQxZjA2NWMzOGIwMmZkYWI1N2EzZjRhMDg2MjFlNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWnsKLAFqTUxNzYyNDMyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3be33baeb41f065c38b02fdab57a3f4a08621e45", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/resteasy/resteasy/commit/3be33baeb41f065c38b02fdab57a3f4a08621e45", "committedDate": "2020-10-22T15:06:21Z", "message": "Dependency-free implementation of the SSE Publisher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d1c950100a39d8e0db959010853a594ae066c6c", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/3d1c950100a39d8e0db959010853a594ae066c6c", "committedDate": "2020-10-23T11:50:55Z", "message": "Add sse publisher test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0b6049a4a9fbb8fd00dcad646c4c3a1acd99a4a", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/d0b6049a4a9fbb8fd00dcad646c4c3a1acd99a4a", "committedDate": "2020-10-26T08:33:04Z", "message": "Add executor to SSEPublisher;Refactor test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NTk4MTg1", "url": "https://github.com/resteasy/resteasy/pull/2582#pullrequestreview-516598185", "createdAt": "2020-10-26T09:30:51Z", "commit": {"oid": "d0b6049a4a9fbb8fd00dcad646c4c3a1acd99a4a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwOTozMDo1MVrOHoHM4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwOTozMjoxNFrOHoHQkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyMzA3NQ==", "bodyText": "Shouldn't we remove this commented line?", "url": "https://github.com/resteasy/resteasy/pull/2582#discussion_r511823075", "createdAt": "2020-10-26T09:30:51Z", "author": {"login": "cescoffier"}, "path": "resteasy-client-microprofile-base/src/main/java/org/jboss/resteasy/microprofile/client/RestClientBuilderImpl.java", "diffHunk": "@@ -20,6 +20,8 @@\n import org.jboss.resteasy.microprofile.client.header.ClientHeadersRequestFilter;\n import org.jboss.resteasy.microprofile.client.impl.MpClient;\n import org.jboss.resteasy.microprofile.client.impl.MpClientBuilderImpl;\n+import org.jboss.resteasy.microprofile.client.publisher.MpPublisherMessageBodyReader;\n+//import org.jboss.resteasy.microprofile.client.publisher.MpPublisherMessageBodyReader;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b6049a4a9fbb8fd00dcad646c4c3a1acd99a4a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyNDAxNw==", "bodyText": "should it handle rejection?", "url": "https://github.com/resteasy/resteasy/pull/2582#discussion_r511824017", "createdAt": "2020-10-26T09:32:14Z", "author": {"login": "cescoffier"}, "path": "resteasy-client-microprofile-base/src/main/java/org/jboss/resteasy/microprofile/client/publisher/SSEPublisher.java", "diffHunk": "@@ -0,0 +1,290 @@\n+package org.jboss.resteasy.microprofile.client.publisher;\n+\n+import org.jboss.logging.Logger;\n+import org.jboss.resteasy.core.ResteasyContext;\n+import org.jboss.resteasy.plugins.providers.sse.SseEventInputImpl;\n+import org.reactivestreams.Publisher;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+import javax.ws.rs.ext.Providers;\n+import javax.ws.rs.sse.InboundSseEvent;\n+\n+import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+import java.util.Queue;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+/**\n+ * Publisher implementation emitting server-sent-event downstream.\n+ *\n+ * @param <T> the type of event.\n+ */\n+@SuppressWarnings(\"ReactiveStreamsPublisherImplementation\")\n+public class SSEPublisher<T> implements Publisher<T> {\n+\n+    private static final Runnable CLEARED = () -> {\n+        // sentinel indicating we are done.\n+    };\n+\n+    private final SseEventInputImpl input;\n+    private final Type genericType;\n+    private final Providers providers;\n+    private final ExecutorService executor;\n+\n+    private static final Logger LOGGER = Logger.getLogger(SSEPublisher.class);\n+\n+    public SSEPublisher(final Type genericType, final Providers providers, final SseEventInputImpl input, final ExecutorService es) {\n+        this.genericType = genericType;\n+        this.input = input;\n+        this.providers = providers;\n+        this.executor = es;\n+    }\n+\n+    @Override\n+    public void subscribe(final Subscriber<? super T> downstream) {\n+        SSEProcessor<? super T> processor = new SSEProcessor<>(downstream,\n+                Integer.getInteger(\"resteasy.microprofile.sseclient.buffersize\", 512));\n+        downstream.onSubscribe(processor);\n+        pump(processor, input);\n+    }\n+\n+    /**\n+     * Reads the server-sent event from the {@code input} and pass them to the processor.\n+     * The processor handles the downstream requests and buffer/drop items according to them.\n+     *\n+     * @param processor the stream\n+     * @param input     the SSE input\n+     */\n+    @SuppressWarnings({ \"rawtypes\", \"unchecked\" })\n+    private void pump(final SSEProcessor processor, final SseEventInputImpl input) {\n+        Map<Class<?>, Object> contextDataMap = ResteasyContext.getContextDataMap();\n+        executor.execute(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0b6049a4a9fbb8fd00dcad646c4c3a1acd99a4a"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7db7d440f8d0ed9ae0855134edbe1236b48f2be9", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/7db7d440f8d0ed9ae0855134edbe1236b48f2be9", "committedDate": "2020-10-26T09:52:28Z", "message": "Minor change : clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee2dd61705623ae6f1ed448a82fe67ebe2c6a0d2", "author": {"user": {"login": "jimma", "name": "jimma"}}, "url": "https://github.com/resteasy/resteasy/commit/ee2dd61705623ae6f1ed448a82fe67ebe2c6a0d2", "committedDate": "2020-10-26T14:54:11Z", "message": "Handle RejectedExecutionException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTY5MTgx", "url": "https://github.com/resteasy/resteasy/pull/2582#pullrequestreview-516969181", "createdAt": "2020-10-26T16:41:05Z", "commit": {"oid": "ee2dd61705623ae6f1ed448a82fe67ebe2c6a0d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NjI0MzIy", "url": "https://github.com/resteasy/resteasy/pull/2582#pullrequestreview-517624322", "createdAt": "2020-10-27T11:58:06Z", "commit": {"oid": "ee2dd61705623ae6f1ed448a82fe67ebe2c6a0d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1648, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}