{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NjM2Njg0", "number": 1555, "title": "Customized handler parser in Dubbo provider filter.", "bodyText": "Describe what this PR does / why we need it\nI make dubbo provider can customized origin by DubboOrigin interface. Not only application name.\nDoes this pull request fix one issue?\nFixes #1476 Customized handler parser in Dubbo provider filter.\nDescribe how you did it\nRefer to DubboFallback\uff0cI create DubboOriginParser.\nDescribe how to verify it\nLook the DubboOriginParserRegistryTest.\nSpecial notes for reviews\nThis task is simple, but make sure this design is elegant.", "createdAt": "2020-06-17T06:42:23Z", "url": "https://github.com/alibaba/Sentinel/pull/1555", "merged": true, "mergeCommit": {"oid": "d8714cacebeafd3adb463a58573d5b7940f4fab8"}, "closed": true, "closedAt": "2020-06-28T03:48:36Z", "author": {"login": "cityiron"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsDu3HgH2gAyNDM1NjM2Njg0OjRiYjk1OTA2NTNlZDJjNGY2ZTM2Zjg3NGQyNmIwMmU3MzU0ZmY5MTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvkJeJgFqTQzODc0MTAxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4bb9590653ed2c4f6e36f874d26b02e7354ff914", "author": {"user": {"login": "cityiron", "name": "ChengTie(\u9435\u624b)"}}, "url": "https://github.com/alibaba/Sentinel/commit/4bb9590653ed2c4f6e36f874d26b02e7354ff914", "committedDate": "2020-06-17T06:19:39Z", "message": "Customized handler parser in Dubbo provider filter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTA4NTEz", "url": "https://github.com/alibaba/Sentinel/pull/1555#pullrequestreview-432108513", "createdAt": "2020-06-17T06:56:42Z", "commit": {"oid": "4bb9590653ed2c4f6e36f874d26b02e7354ff914"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjo1Njo0MlrOGk4GjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjo1NzozNVrOGk4IVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMyMTEwMQ==", "bodyText": "We may need to check null here (and replace with empty string).", "url": "https://github.com/alibaba/Sentinel/pull/1555#discussion_r441321101", "createdAt": "2020-06-17T06:56:42Z", "author": {"login": "sczyh30"}, "path": "sentinel-adapter/sentinel-dubbo-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/dubbo/SentinelDubboProviderFilter.java", "diffHunk": "@@ -55,14 +56,14 @@ public SentinelDubboProviderFilter() {\n     @Override\n     public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException {\n         // Get origin caller.\n-        String application = DubboUtils.getApplication(invocation, \"\");\n+        String origin = DubboOriginRegistry.getDubboOrigin().handler(invoker, invocation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bb9590653ed2c4f6e36f874d26b02e7354ff914"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMyMTQ0Nw==", "bodyText": "Maybe DubboOriginParser is better?", "url": "https://github.com/alibaba/Sentinel/pull/1555#discussion_r441321447", "createdAt": "2020-06-17T06:57:21Z", "author": {"login": "sczyh30"}, "path": "sentinel-adapter/sentinel-dubbo-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/dubbo/origin/DubboOrigin.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.alibaba.csp.sentinel.adapter.dubbo.origin;\n+\n+import com.alibaba.csp.sentinel.context.Context;\n+import com.alibaba.dubbo.rpc.Invocation;\n+import com.alibaba.dubbo.rpc.Invoker;\n+\n+/**\n+ * Customized handler parser in Dubbo provider filter. {@link Context#getOrigin()}\n+ *\n+ * @author tc\n+ * @date 2020/6/10\n+ */\n+public interface DubboOrigin {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bb9590653ed2c4f6e36f874d26b02e7354ff914"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMyMTU1Nw==", "bodyText": "Maybe parseOrigin is better?", "url": "https://github.com/alibaba/Sentinel/pull/1555#discussion_r441321557", "createdAt": "2020-06-17T06:57:35Z", "author": {"login": "sczyh30"}, "path": "sentinel-adapter/sentinel-dubbo-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/dubbo/origin/DubboOrigin.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package com.alibaba.csp.sentinel.adapter.dubbo.origin;\n+\n+import com.alibaba.csp.sentinel.context.Context;\n+import com.alibaba.dubbo.rpc.Invocation;\n+import com.alibaba.dubbo.rpc.Invoker;\n+\n+/**\n+ * Customized handler parser in Dubbo provider filter. {@link Context#getOrigin()}\n+ *\n+ * @author tc\n+ * @date 2020/6/10\n+ */\n+public interface DubboOrigin {\n+\n+    /**\n+     * Handle the handler parser.\n+     *\n+     * @param invoker    Dubbo invoker\n+     * @param invocation Dubbo invocation\n+     * @return handler result\n+     */\n+    String handler(Invoker<?> invoker, Invocation invocation);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bb9590653ed2c4f6e36f874d26b02e7354ff914"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2b7759828729e3e5f9a156924ae93fc1c1e0d53", "author": {"user": {"login": "cityiron", "name": "ChengTie(\u9435\u624b)"}}, "url": "https://github.com/alibaba/Sentinel/commit/f2b7759828729e3e5f9a156924ae93fc1c1e0d53", "committedDate": "2020-06-17T10:55:21Z", "message": "1. rename to DubboOriginParser#parse\n2. add DubboOriginParser feature to README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9396092a185935d3de29f1097dabf477a26b6ff2", "author": {"user": {"login": "cityiron", "name": "ChengTie(\u9435\u624b)"}}, "url": "https://github.com/alibaba/Sentinel/commit/9396092a185935d3de29f1097dabf477a26b6ff2", "committedDate": "2020-06-17T10:57:03Z", "message": "1. rename to DubboOriginParser#parse\n2. add DubboOriginParser feature to README.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dcf059322174f25e4070c7a84abfe9927f490a1", "author": {"user": {"login": "cityiron", "name": "ChengTie(\u9435\u624b)"}}, "url": "https://github.com/alibaba/Sentinel/commit/6dcf059322174f25e4070c7a84abfe9927f490a1", "committedDate": "2020-06-17T10:58:39Z", "message": "Merge remote-tracking branch 'origin/dubbo_origin' into dubbo_origin\n\n# Conflicts:\n#\tsentinel-adapter/sentinel-dubbo-adapter/README.md"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMzEyMTAz", "url": "https://github.com/alibaba/Sentinel/pull/1555#pullrequestreview-432312103", "createdAt": "2020-06-17T11:35:00Z", "commit": {"oid": "6dcf059322174f25e4070c7a84abfe9927f490a1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMTozNTowMFrOGlBtTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMTozNToxM1rOGlBtwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3ODQ3Nw==", "bodyText": "Could you please add the license header?", "url": "https://github.com/alibaba/Sentinel/pull/1555#discussion_r441478477", "createdAt": "2020-06-17T11:35:00Z", "author": {"login": "sczyh30"}, "path": "sentinel-adapter/sentinel-dubbo-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/dubbo/origin/DefaultDubboOriginParser.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package com.alibaba.csp.sentinel.adapter.dubbo.origin;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dcf059322174f25e4070c7a84abfe9927f490a1"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3ODU5Mg==", "bodyText": "We may remove the date here.", "url": "https://github.com/alibaba/Sentinel/pull/1555#discussion_r441478592", "createdAt": "2020-06-17T11:35:13Z", "author": {"login": "sczyh30"}, "path": "sentinel-adapter/sentinel-dubbo-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/dubbo/origin/DefaultDubboOriginParser.java", "diffHunk": "@@ -0,0 +1,20 @@\n+package com.alibaba.csp.sentinel.adapter.dubbo.origin;\n+\n+import com.alibaba.csp.sentinel.adapter.dubbo.DubboUtils;\n+import com.alibaba.dubbo.rpc.Invocation;\n+import com.alibaba.dubbo.rpc.Invoker;\n+\n+/**\n+ * Default Dubbo origin parse.\n+ *\n+ * @author tc\n+ * @date 2020/6/10", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dcf059322174f25e4070c7a84abfe9927f490a1"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ade21b47d932eda4385db27506cb71cbfc45776", "author": {"user": {"login": "cityiron", "name": "ChengTie(\u9435\u624b)"}}, "url": "https://github.com/alibaba/Sentinel/commit/0ade21b47d932eda4385db27506cb71cbfc45776", "committedDate": "2020-06-17T13:17:38Z", "message": "1. add license header\n2. remove date"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2e5f51894dd3c7a6a502d2127c24d209624bf02", "author": {"user": {"login": "cityiron", "name": "ChengTie(\u9435\u624b)"}}, "url": "https://github.com/alibaba/Sentinel/commit/d2e5f51894dd3c7a6a502d2127c24d209624bf02", "committedDate": "2020-06-19T01:53:54Z", "message": "effect on SentinelDubboProviderFilterTest when mvn integration-test, so set default parser when run testCustomOriginParser."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzODk2NjY1", "url": "https://github.com/alibaba/Sentinel/pull/1555#pullrequestreview-433896665", "createdAt": "2020-06-19T08:27:06Z", "commit": {"oid": "d2e5f51894dd3c7a6a502d2127c24d209624bf02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwODoyNzowN1rOGmMpRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwODoyNzowN1rOGmMpRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNjI0Nw==", "bodyText": "It may better that we use uniform clean method before and after each test case.\nsuch as:\n@Before\npublic void setUp() {\n    DubboOriginParserRegistry.setDubboOriginParser(new DefaultDubboOriginParser());\n}\n\n@After\npublic void cleanUp() {\n    DubboOriginParserRegistry.setDubboOriginParser(new DefaultDubboOriginParser());\n}", "url": "https://github.com/alibaba/Sentinel/pull/1555#discussion_r442706247", "createdAt": "2020-06-19T08:27:07Z", "author": {"login": "cdfive"}, "path": "sentinel-adapter/sentinel-dubbo-adapter/src/test/java/com/alibaba/csp/sentinel/adapter/dubbo/origin/DubboOriginRegistryTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright 1999-2020 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.dubbo.origin;\n+\n+import com.alibaba.csp.sentinel.adapter.dubbo.DubboUtils;\n+import com.alibaba.dubbo.rpc.Invocation;\n+import com.alibaba.dubbo.rpc.Invoker;\n+import com.alibaba.dubbo.rpc.RpcInvocation;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+/**\n+ * @author tiecheng\n+ */\n+public class DubboOriginRegistryTest {\n+\n+    @Test(expected = IllegalArgumentException.class)\n+    public void testDefaultOriginParserFail() {\n+        DubboOriginParserRegistry.getDubboOriginParser().parse(null, null);\n+    }\n+\n+    @Test\n+    public void testDefaultOriginParserSuccess() {\n+        RpcInvocation invocation = new RpcInvocation();\n+        String dubboName = \"sentinel\";\n+        invocation.setAttachment(DubboUtils.DUBBO_APPLICATION_KEY, dubboName);\n+        String origin = DubboOriginParserRegistry.getDubboOriginParser().parse(null, invocation);\n+        Assert.assertEquals(dubboName, origin);\n+    }\n+\n+    @Test\n+    public void testCustomOriginParser() {\n+        DubboOriginParserRegistry.setDubboOriginParser(new DubboOriginParser() {\n+            @Override\n+            public String parse(Invoker<?> invoker, Invocation invocation) {\n+                return invocation.getAttachment(DubboUtils.DUBBO_APPLICATION_KEY, \"default\") + \"_\" + invocation\n+                    .getMethodName();\n+            }\n+        });\n+\n+        RpcInvocation invocation = new RpcInvocation();\n+        String origin = DubboOriginParserRegistry.getDubboOriginParser().parse(null, invocation);\n+        Assert.assertEquals(\"default_null\", origin);\n+\n+        String dubboName = \"sentinel\";\n+        invocation.setAttachment(DubboUtils.DUBBO_APPLICATION_KEY, dubboName);\n+        origin = DubboOriginParserRegistry.getDubboOriginParser().parse(null, invocation);\n+        Assert.assertEquals(dubboName + \"_null\", origin);\n+\n+        invocation.setMethodName(\"hello\");\n+        origin = DubboOriginParserRegistry.getDubboOriginParser().parse(null, invocation);\n+        Assert.assertEquals(dubboName + \"_hello\", origin);\n+\n+        // if not set default, effect on SentinelDubboProviderFilterTest when mvn integration-test\n+        DubboOriginParserRegistry.setDubboOriginParser(new DefaultDubboOriginParser());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e5f51894dd3c7a6a502d2127c24d209624bf02"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzODk4MTUw", "url": "https://github.com/alibaba/Sentinel/pull/1555#pullrequestreview-433898150", "createdAt": "2020-06-19T08:29:21Z", "commit": {"oid": "d2e5f51894dd3c7a6a502d2127c24d209624bf02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwODoyOToyMVrOGmMtlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwODoyOToyMVrOGmMtlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjcwNzM1MA==", "bodyText": "The parameter name such as dubboOriginParser is clearer semantically.", "url": "https://github.com/alibaba/Sentinel/pull/1555#discussion_r442707350", "createdAt": "2020-06-19T08:29:21Z", "author": {"login": "cdfive"}, "path": "sentinel-adapter/sentinel-dubbo-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/dubbo/origin/DubboOriginParserRegistry.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 1999-2020 Alibaba Group Holding Ltd.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *      https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.alibaba.csp.sentinel.adapter.dubbo.origin;\n+\n+/**\n+ * Global origin parser registry for Dubbo.\n+ *\n+ * @author tiecheng\n+ */\n+public final class DubboOriginParserRegistry {\n+\n+    private static volatile DubboOriginParser dubboOriginParser = new DefaultDubboOriginParser();\n+\n+    public static DubboOriginParser getDubboOriginParser() {\n+        return dubboOriginParser;\n+    }\n+\n+    public static void setDubboOriginParser(DubboOriginParser dubboOrigin) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2e5f51894dd3c7a6a502d2127c24d209624bf02"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa5e8f6eb7fa36dba6a25452a2eb089ce361fbf0", "author": {"user": {"login": "cityiron", "name": "ChengTie(\u9435\u624b)"}}, "url": "https://github.com/alibaba/Sentinel/commit/aa5e8f6eb7fa36dba6a25452a2eb089ce361fbf0", "committedDate": "2020-06-19T10:03:40Z", "message": "make code clearer."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NzQxMDEy", "url": "https://github.com/alibaba/Sentinel/pull/1555#pullrequestreview-438741012", "createdAt": "2020-06-28T03:47:27Z", "commit": {"oid": "aa5e8f6eb7fa36dba6a25452a2eb089ce361fbf0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3976, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}