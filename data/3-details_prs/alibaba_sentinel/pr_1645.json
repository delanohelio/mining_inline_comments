{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNjQ4NjA4", "number": 1645, "title": "Refactor the flow of request to fix #1638 for circuit breakers", "bodyText": "Describe what this PR does / why we need it\nCurrent implementation of circuit breakers will fire a bug when do examination in half-open state. The examination will be interrupted if the detecting request was blocked by other breakers or slots.\nFor details please refer to #1490 (comment)\nDoes this pull request fix one issue?\n#1638\nDescribe how you did it\nFor initial concepts we can illustrate design of circuit breakers, including below scenarios:\n\nAnd a new design could be shown as:\n\nIn afterRequestPassed we:\n\nDo calculations needed by specific breaker\nDetermine the new state(closed -> open, half-open -> open/closed)\n\nIn Exit Handlers we:\n\nExecute extra blocks bond to specific entry(Which we should do only if necessary because it will cost extra memory)\n\nThus, we recycle failed detecting attempt in handler bond to specific entry. Handlers also enable users or developers of adapter doing necessary extra work.\nDescribe how to verify it\nA new unit test can verify it which will fail in previous design: CircuitBreakingIntegrationTest.testMultipleHalfOpenedBreaders\nSpecial notes for reviews\nNo.", "createdAt": "2020-08-04T09:34:00Z", "url": "https://github.com/alibaba/Sentinel/pull/1645", "merged": true, "mergeCommit": {"oid": "ee2772b5139eb946aff4f62ef67bcdc0e2a290f9"}, "closed": true, "closedAt": "2020-08-18T03:04:49Z", "author": {"login": "jasonjoo2010"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7kPHBAH2gAyNDYyNjQ4NjA4OjdjOTljNDYwYjI1N2YwMjAxNTY3NzQ1Mzg5ZDg0ZjhiZmQwODVjNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_-A7FAFqTQ2ODk1NzkyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c99c460b257f0201567745389d84f8bfd085c62", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/7c99c460b257f0201567745389d84f8bfd085c62", "committedDate": "2020-08-04T10:40:42Z", "message": "Refactor the flow of request to fix #1638 of circuit breakers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2a78be9dfd4cc69783f95e584482d4b703db772", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/b2a78be9dfd4cc69783f95e584482d4b703db772", "committedDate": "2020-08-04T10:40:42Z", "message": "fix unit tests related"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b5a235452386c8924761322086241497d360eb4", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/8b5a235452386c8924761322086241497d360eb4", "committedDate": "2020-08-04T10:33:35Z", "message": "fix unit tests related"}, "afterCommit": {"oid": "b2a78be9dfd4cc69783f95e584482d4b703db772", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/b2a78be9dfd4cc69783f95e584482d4b703db772", "committedDate": "2020-08-04T10:40:42Z", "message": "fix unit tests related"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMzI2Mzc4", "url": "https://github.com/alibaba/Sentinel/pull/1645#pullrequestreview-463326378", "createdAt": "2020-08-07T13:47:25Z", "commit": {"oid": "b2a78be9dfd4cc69783f95e584482d4b703db772"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0NzoyNVrOG9ajIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzo0NzoyNVrOG9ajIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzA1MTI5OA==", "bodyText": "Thread-safe forwhenComplete.\nOther requests blocked by half-open state also can transform half-open to open, so the one request allowed by half-state maybe not  transform half-open to close.", "url": "https://github.com/alibaba/Sentinel/pull/1645#discussion_r467051298", "createdAt": "2020-08-07T13:47:25Z", "author": {"login": "wavesZh"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/degrade/circuitbreaker/AbstractCircuitBreaker.java", "diffHunk": "@@ -99,11 +103,24 @@ protected boolean fromCloseToOpen(double snapshotValue) {\n         return false;\n     }\n \n-    protected boolean fromOpenToHalfOpen() {\n+    protected boolean fromOpenToHalfOpen(Context context) {\n         if (currentState.compareAndSet(State.OPEN, State.HALF_OPEN)) {\n             for (CircuitBreakerStateChangeObserver observer : observerRegistry.getStateChangeObservers()) {\n                 observer.onStateChange(State.OPEN, State.HALF_OPEN, rule, null);\n             }\n+            Entry entry = context.getCurEntry();\n+            entry.whenComplete(new BiConsumer<Context, Entry>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a78be9dfd4cc69783f95e584482d4b703db772"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzE4NTk4", "url": "https://github.com/alibaba/Sentinel/pull/1645#pullrequestreview-466718598", "createdAt": "2020-08-13T12:36:38Z", "commit": {"oid": "b2a78be9dfd4cc69783f95e584482d4b703db772"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMjozNjozOFrOHAJjCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMjozNjozOFrOHAJjCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkxODQ3NA==", "bodyText": "Actually IMHO \"complete\" might be more concrete. In Sentinel, \"pass\" means allowed by Sentinel (not started but pending), and \"complete\" means an invocation has completed (the blocked requests never started, so never completed).", "url": "https://github.com/alibaba/Sentinel/pull/1645#discussion_r469918474", "createdAt": "2020-08-13T12:36:38Z", "author": {"login": "sczyh30"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/degrade/circuitbreaker/CircuitBreaker.java", "diffHunk": "@@ -46,13 +50,12 @@\n     State currentState();\n \n     /**\n-     * Record a completed request with the given response time and error (if present) and\n-     * handle state transformation of the circuit breaker.\n+     * Called when a passed invocation finished.\n      *\n-     * @param rt the response time of this entry\n-     * @param error the error of this entry (if present)\n+     * @param context context of current invocation\n+     * @param wrapper current resource\n      */\n-    void onRequestComplete(long rt, Throwable error);\n+    void afterRequestPassed(Context context, ResourceWrapper wrapper);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a78be9dfd4cc69783f95e584482d4b703db772"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2Nzg5MjY5", "url": "https://github.com/alibaba/Sentinel/pull/1645#pullrequestreview-466789269", "createdAt": "2020-08-13T14:00:05Z", "commit": {"oid": "b2a78be9dfd4cc69783f95e584482d4b703db772"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDowMDowNlrOHAM4Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDowMDowNlrOHAM4Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTk3MzA3OA==", "bodyText": "Maybe the state change need to notify CircuitBreakerStateChangeObserver.", "url": "https://github.com/alibaba/Sentinel/pull/1645#discussion_r469973078", "createdAt": "2020-08-13T14:00:06Z", "author": {"login": "louyuting"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/degrade/circuitbreaker/AbstractCircuitBreaker.java", "diffHunk": "@@ -99,11 +103,24 @@ protected boolean fromCloseToOpen(double snapshotValue) {\n         return false;\n     }\n \n-    protected boolean fromOpenToHalfOpen() {\n+    protected boolean fromOpenToHalfOpen(Context context) {\n         if (currentState.compareAndSet(State.OPEN, State.HALF_OPEN)) {\n             for (CircuitBreakerStateChangeObserver observer : observerRegistry.getStateChangeObservers()) {\n                 observer.onStateChange(State.OPEN, State.HALF_OPEN, rule, null);\n             }\n+            Entry entry = context.getCurEntry();\n+            entry.whenComplete(new BiConsumer<Context, Entry>() {\n+                \n+                @Override\n+                public void accept(Context context, Entry entry) {\n+                    if (entry.getBlockError() != null) {\n+                        // blocked\n+                        currentState.compareAndSet(State.HALF_OPEN, State.OPEN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2a78be9dfd4cc69783f95e584482d4b703db772"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddd62dd68b34e9bcea1c495fdabb0fb62f29bf50", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/ddd62dd68b34e9bcea1c495fdabb0fb62f29bf50", "committedDate": "2020-08-13T14:15:41Z", "message": "Notify observers in abandoned detecting request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a39d44027b46a2f8693227e191bce5f9804d1455", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/a39d44027b46a2f8693227e191bce5f9804d1455", "committedDate": "2020-08-13T16:42:22Z", "message": "Rename onRequestComplete back"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTU3OTIx", "url": "https://github.com/alibaba/Sentinel/pull/1645#pullrequestreview-468957921", "createdAt": "2020-08-18T02:58:26Z", "commit": {"oid": "a39d44027b46a2f8693227e191bce5f9804d1455"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4013, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}