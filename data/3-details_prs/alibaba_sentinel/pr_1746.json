{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MTA0NDAz", "number": 1746, "title": "Improve performance of TimeUtil in different load conditions", "bodyText": "Describe what this PR does / why we need it\nCurrent design of TimeUtil may cost much more than users think in mind in idle systems.\nDoes this pull request fix one issue?\n#1702\nDescribe how you did it\nTo achieve this by making TimeUtil have multiple running states:\n\nIDLE: Direct invocation state for idle conditions.\nRUNNING: Legacy mode for busy conditions.\nREQUEST: Temporary state from IDLE to RUNNING.\n\nBy this design TimeUtil won't cost much in idle systems any more.\nDescribe how to verify it\nRefer to the unit test TimeUtilTest or generate different loads to demo projects.\nSpecial notes for reviews\nNo", "createdAt": "2020-09-18T06:22:24Z", "url": "https://github.com/alibaba/Sentinel/pull/1746", "merged": true, "mergeCommit": {"oid": "f64699701148875c4d04a7a849e6d46a32f187ef"}, "closed": true, "closedAt": "2021-06-29T09:02:13Z", "author": {"login": "jasonjoo2010"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKBtn8gBqjM3ODE2MjYyOTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABelb_0mAFqTY5NDc3NDIwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7f8e0c37950edb066412a75af0110c13ce55922", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/c7f8e0c37950edb066412a75af0110c13ce55922", "committedDate": "2020-09-18T08:31:21Z", "message": "reduce concurrency"}, "afterCommit": {"oid": "33fd8445f1106072d9c0e3b4d0cca107a1e65bf2", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/33fd8445f1106072d9c0e3b4d0cca107a1e65bf2", "committedDate": "2020-09-18T08:55:31Z", "message": "Make TimeUtil have multiple running states:\n\n- IDLE: Direct invocation state for idle conditions.\n- RUNNING: Legacy mode for busy conditions.\n- REQUEST: Temporary state from IDLE to RUNNING.\n\nThough this design TimeUtil won't cost much in idle systems any more.\n\nSigned-off-by: Jason Joo <hblzxsj@163.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNjI4OTk2", "url": "https://github.com/alibaba/Sentinel/pull/1746#pullrequestreview-492628996", "createdAt": "2020-09-21T13:57:43Z", "commit": {"oid": "33fd8445f1106072d9c0e3b4d0cca107a1e65bf2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo1Nzo0M1rOHVRUsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo1Nzo0M1rOHVRUsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA2NTk3MA==", "bodyText": "I think state should be a volatile variable.", "url": "https://github.com/alibaba/Sentinel/pull/1746#discussion_r492065970", "createdAt": "2020-09-21T13:57:43Z", "author": {"login": "liqiangz"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/util/TimeUtil.java", "diffHunk": "@@ -15,38 +15,199 @@\n  */\n package com.alibaba.csp.sentinel.util;\n \n+import java.util.List;\n import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import com.alibaba.csp.sentinel.log.RecordLog;\n+import com.alibaba.csp.sentinel.slots.statistic.base.LeapArray;\n+import com.alibaba.csp.sentinel.slots.statistic.base.LongAdder;\n+import com.alibaba.csp.sentinel.slots.statistic.base.WindowWrap;\n+import com.alibaba.csp.sentinel.util.function.Tuple2;\n \n /**\n  * Provides millisecond-level time of OS.\n+ * <p>\n+ * Here we should see that not all the time TimeUtil should \n+ * keep looping 1_000 times every second (Actually about 800/s due to some losses).\n+ * <pre>\n+ * * In idle conditions it just acts as System.currentTimeMillis();\n+ * * In busy conditions (significantly more than 1_000/s) it keeps loop to reduce costs.\n+ * </pre>\n+ * For detail design and proposals please goto \n+ * <a href=\"https://github.com/alibaba/Sentinel/issues/1702#issuecomment-692151160\">https://github.com/alibaba/Sentinel/issues/1702</a>\n  *\n  * @author qinan.qn\n+ * @author jason\n  */\n-public final class TimeUtil {\n+public final class TimeUtil implements Runnable {\n+    private static final long CHECK_INTERVAL = 3000;\n+    \n+    public static enum STATE {\n+        IDLE, PREPARE, RUNNING;\n+    }\n+    private static class Statistic {\n+        private LongAdder writes = new LongAdder();\n+        private LongAdder reads = new LongAdder();\n+        public LongAdder getWrites() {\n+            return writes;\n+        }\n+        public LongAdder getReads() {\n+            return reads;\n+        }\n+    }\n+    private static TimeUtil INSTANCE;\n \n-    private static volatile long currentTimeMillis;\n+    private volatile long currentTimeMillis;\n+    private AtomicLong lastCheck = new AtomicLong();\n+    private LeapArray<Statistic> statistics;\n+    private STATE state = STATE.IDLE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33fd8445f1106072d9c0e3b4d0cca107a1e65bf2"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b4acdacdca67ced8a3ee5df2b3b20fc938ba8b3", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/7b4acdacdca67ced8a3ee5df2b3b20fc938ba8b3", "committedDate": "2020-09-22T02:59:41Z", "message": "Make TimeUtil have multiple running states:\n\n- IDLE: Direct invocation state for idle conditions.\n- RUNNING: Legacy mode for busy conditions.\n- REQUEST: Temporary state from IDLE to RUNNING.\n\nThrough this design TimeUtil won't cost much in idle systems any more.\n\nSigned-off-by: Jason Joo <hblzxsj@163.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50e541768e229454e6a4d201e6e0e53231f0e88f", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/50e541768e229454e6a4d201e6e0e53231f0e88f", "committedDate": "2020-09-22T02:51:40Z", "message": "Remove CAS and make state volatile\n\nSigned-off-by: Jason Joo <hblzxsj@163.com>"}, "afterCommit": {"oid": "7b4acdacdca67ced8a3ee5df2b3b20fc938ba8b3", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/7b4acdacdca67ced8a3ee5df2b3b20fc938ba8b3", "committedDate": "2020-09-22T02:59:41Z", "message": "Make TimeUtil have multiple running states:\n\n- IDLE: Direct invocation state for idle conditions.\n- RUNNING: Legacy mode for busy conditions.\n- REQUEST: Temporary state from IDLE to RUNNING.\n\nThrough this design TimeUtil won't cost much in idle systems any more.\n\nSigned-off-by: Jason Joo <hblzxsj@163.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTk1NzY0", "url": "https://github.com/alibaba/Sentinel/pull/1746#pullrequestreview-546195764", "createdAt": "2020-12-07T14:23:25Z", "commit": {"oid": "7b4acdacdca67ced8a3ee5df2b3b20fc938ba8b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njk0Nzc0MjA1", "url": "https://github.com/alibaba/Sentinel/pull/1746#pullrequestreview-694774205", "createdAt": "2021-06-29T09:00:44Z", "commit": {"oid": "7b4acdacdca67ced8a3ee5df2b3b20fc938ba8b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3858, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}