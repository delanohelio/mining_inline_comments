{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4Njg5NDE1", "number": 1783, "title": "fix the potential concurrence issue when rules updates", "bodyText": "Describe what this PR does / why we need it\nfix the potential concurrence issue when rules updates\nDoes this pull request fix one issue?\nFixes #1782.\nDescribe how you did it\nmake the map wrapped in AtomicReference\nDescribe how to verify it\nRun the new-added UT\nSpecial notes for reviews\nIf this pr can be acceptable, I plan to fix the same issue in other rule managers.\nCode seems to be strange in DegradeRuleManager because the same piece of code uses synchronized keyword. It seems to be realized, but in the wrong way to fix it.", "createdAt": "2020-10-06T16:42:47Z", "url": "https://github.com/alibaba/Sentinel/pull/1783", "merged": true, "mergeCommit": {"oid": "4459ab2caf2029be2d48ed0bd8110757059a9a84"}, "closed": true, "closedAt": "2020-10-08T07:03:57Z", "author": {"login": "vipweihua"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP5rroAH2gAyNDk4Njg5NDE1OjZhODQ1ZWVkYTNiZDU5N2JiNGE5NGE1NTQ2ZDAzYTk2ZjNiODBjMGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQb8UugFqTUwNDQ3NDk3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6a845eeda3bd597bb4a94a5546d03a96f3b80c0a", "author": {"user": {"login": "vipweihua", "name": "Weihua"}}, "url": "https://github.com/alibaba/Sentinel/commit/6a845eeda3bd597bb4a94a5546d03a96f3b80c0a", "committedDate": "2020-10-06T14:58:24Z", "message": "Merge pull request #1 from alibaba/master\n\nsync with alibaba master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edd3b80f6fb8011338519cd654c173c311f9857f", "author": {"user": {"login": "vipweihua", "name": "Weihua"}}, "url": "https://github.com/alibaba/Sentinel/commit/edd3b80f6fb8011338519cd654c173c311f9857f", "committedDate": "2020-10-06T16:35:02Z", "message": "fix the potential concurrence issue when rules updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c72752f233d231e2522fecc063e64ec1462c4796", "author": {"user": {"login": "vipweihua", "name": "Weihua"}}, "url": "https://github.com/alibaba/Sentinel/commit/c72752f233d231e2522fecc063e64ec1462c4796", "committedDate": "2020-10-06T16:45:18Z", "message": "add license statement and remove wrong version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTgwMTky", "url": "https://github.com/alibaba/Sentinel/pull/1783#pullrequestreview-503180192", "createdAt": "2020-10-06T17:04:51Z", "commit": {"oid": "c72752f233d231e2522fecc063e64ec1462c4796"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzowNDo1MVrOHdRjOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzowNDo1MVrOHdRjOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1ODI5Ng==", "bodyText": "Maybe the variable in logging message should be updated now.", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r500458296", "createdAt": "2020-10-06T17:04:51Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -129,20 +130,16 @@ public static boolean isOtherOrigin(String origin, String resourceName) {\n         @Override\n         public void configUpdate(List<FlowRule> value) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(value);\n-            if (rules != null) {\n-                flowRules.clear();\n-                flowRules.putAll(rules);\n-            }\n+            //the rules was always not null, it's no need to check nullable\n+            //remove checking to avoid IDE warning\n+            flowRules.set(rules);\n             RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c72752f233d231e2522fecc063e64ec1462c4796"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78ce0773ab90bd11c8a04b8bf390b3c95ee06ad7", "author": {"user": {"login": "vipweihua", "name": "Weihua"}}, "url": "https://github.com/alibaba/Sentinel/commit/78ce0773ab90bd11c8a04b8bf390b3c95ee06ad7", "committedDate": "2020-10-07T01:06:44Z", "message": "update message in logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "703e6cc1c161ad0c78bda590e401ca0fa69167b2", "author": {"user": {"login": "vipweihua", "name": "Weihua"}}, "url": "https://github.com/alibaba/Sentinel/commit/703e6cc1c161ad0c78bda590e401ca0fa69167b2", "committedDate": "2020-10-07T13:53:15Z", "message": "remove system.out"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "815f049341361009383bb84af0baba447e9a3ce9", "author": {"user": {"login": "vipweihua", "name": "Weihua"}}, "url": "https://github.com/alibaba/Sentinel/commit/815f049341361009383bb84af0baba447e9a3ce9", "committedDate": "2020-10-07T14:29:02Z", "message": "make compatible with low jdk version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDgzNjcy", "url": "https://github.com/alibaba/Sentinel/pull/1783#pullrequestreview-504083672", "createdAt": "2020-10-07T16:56:07Z", "commit": {"oid": "815f049341361009383bb84af0baba447e9a3ce9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo1NjowN1rOHd8zyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo1OTowN1rOHd87jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2NzA1MQ==", "bodyText": "Is it necessary to initial its value (flowRules) to be an empty map obviously?\nIt's tricky now because the initial empty value is initialized by currentProperty.addListener(LISTENER); in static block. It may trigger a bug if anyone change any of them in future.", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501167051", "createdAt": "2020-10-07T16:56:07Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -83,7 +85,7 @@ public static void register2Property(SentinelProperty<List<FlowRule>> property)\n      */\n     public static List<FlowRule> getRules() {\n         List<FlowRule> rules = new ArrayList<FlowRule>();\n-        for (Map.Entry<String, List<FlowRule>> entry : flowRules.entrySet()) {\n+        for (Map.Entry<String, List<FlowRule>> entry : flowRules.get().entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "815f049341361009383bb84af0baba447e9a3ce9"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2OTAzOA==", "bodyText": "For eventual consistency maybe rules is better. Because there may be duplicated logs with same content when races occurred.", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501169038", "createdAt": "2020-10-07T16:59:07Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -129,21 +131,17 @@ public static boolean isOtherOrigin(String origin, String resourceName) {\n         @Override\n         public void configUpdate(List<FlowRule> value) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(value);\n-            if (rules != null) {\n-                flowRules.clear();\n-                flowRules.putAll(rules);\n-            }\n-            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules);\n+            //the rules was always not null, it's no need to check nullable\n+            //remove checking to avoid IDE warning\n+            flowRules.set(rules);\n+            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "815f049341361009383bb84af0baba447e9a3ce9"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fab0863e1ef5630cc2ab229d0ed7843ecab0918", "author": {"user": {"login": "vipweihua", "name": "Weihua"}}, "url": "https://github.com/alibaba/Sentinel/commit/3fab0863e1ef5630cc2ab229d0ed7843ecab0918", "committedDate": "2020-10-08T04:43:05Z", "message": "initialize flowRules map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35282f63a2329e5af90a51fb376a4f92a8d24e0e", "author": {"user": {"login": "vipweihua", "name": "Weihua"}}, "url": "https://github.com/alibaba/Sentinel/commit/35282f63a2329e5af90a51fb376a4f92a8d24e0e", "committedDate": "2020-10-08T04:47:23Z", "message": "initialize flowRules map"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NDc0ODQ5", "url": "https://github.com/alibaba/Sentinel/pull/1783#pullrequestreview-504474849", "createdAt": "2020-10-08T06:53:06Z", "commit": {"oid": "35282f63a2329e5af90a51fb376a4f92a8d24e0e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NDc0OTc5", "url": "https://github.com/alibaba/Sentinel/pull/1783#pullrequestreview-504474979", "createdAt": "2020-10-08T06:53:21Z", "commit": {"oid": "35282f63a2329e5af90a51fb376a4f92a8d24e0e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3872, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}