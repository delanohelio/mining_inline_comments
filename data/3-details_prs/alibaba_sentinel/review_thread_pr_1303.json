{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4OTExNDc1", "number": 1303, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDo1MTo0NlrODiWqoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNTo1MTo0MFrODiYJjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzQ5NTM3OnYy", "diffSide": "RIGHT", "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDo1MTo0NlrOFtjXeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDo1MTo0NlrOFtjXeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMwOTY4OA==", "bodyText": "Maybe it's not necessary to log here, as we also checked and warned in the constructor of the HeartbeatSender impls.", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r383309688", "createdAt": "2020-02-24T14:51:46Z", "author": {"login": "sczyh30"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -104,7 +106,8 @@ public HttpHeartbeatSender() {\n \n     @Override\n     public boolean sendHeartbeat() throws Exception {\n-        if (StringUtil.isEmpty(consoleHost)) {\n+        if (StringUtil.isEmpty(consoleHost) || invalidPort(consolePort)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat for invalid args consoleHost:{0} consolePort:{1}\", consoleHost, consolePort);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "654d73a973ad5ddc09d6e2f1a5cdca4ed8a16b48"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzczODM3OnYy", "diffSide": "RIGHT", "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "isResolved": false, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNTo1MTo0MFrOFtlr5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMTo0MzoxN1rOFw1oGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng==", "bodyText": "Here we may need use placeholder for log: RecordLog.warn(\"xxx{},{}\", arg1,arg2);.\nOr just concat all message string.\nBesides, I found that SimpleHttpResponse#toString may throws NPE, when body is null,\nIn SimpleHttpResponse#108L, maybe need add checking logic.", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r383347686", "createdAt": "2020-02-24T15:51:40Z", "author": {"login": "cdfive"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM3NzEzMw==", "bodyText": "Yes. Maybe just logging the response status code is enough?", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r383377133", "createdAt": "2020-02-24T16:37:26Z", "author": {"login": "sczyh30"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYxMjM0Mg==", "bodyText": "emm. I check  the response Headers. It is a supplement of the server version\u3001location \u3001name, may be it is not necessary to print.", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r383612342", "createdAt": "2020-02-25T01:32:01Z", "author": {"login": "linlinisme"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQzNDg4NQ==", "bodyText": "How about else branch, do we need to add some log?  The NPE remains in SimpleHttpResponse#getBodyAsString() at line 108, when body is null it throws.", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r384434885", "createdAt": "2020-02-26T11:29:37Z", "author": {"login": "cdfive"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg4Nzk4Mg==", "bodyText": "emm..  it seems there more than one point need to handle the NPE\n1.com.alibaba.csp.sentinel.transport.heartbeat.client.SimpleHttpResponseParser#parse\n2.com.alibaba.csp.sentinel.transport.heartbeat.client.SimpleHttpResponse#parseCharset\n3.com.alibaba.csp.sentinel.transport.heartbeat.client.SimpleHttpResponse#getBodyAsString\u3001 return new String(body, charset);", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r384887982", "createdAt": "2020-02-27T02:54:34Z", "author": {"login": "linlinisme"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE3ODM2Ng==", "bodyText": "any suggestion?", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386178366", "createdAt": "2020-03-02T02:59:22Z", "author": {"login": "linlinisme"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIwMjU2Nw==", "bodyText": "I think that 3 need to check.To verify it, we can throw Exception in MachineRegistryController#receiveHeartBeat of dashboard, and call SimpleHttpResponse#toString().", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386202567", "createdAt": "2020-03-02T05:26:07Z", "author": {"login": "cdfive"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIxNTgwMQ==", "bodyText": "I think that 3 need to check.To verify it, we can throw Exception in MachineRegistryController#receiveHeartBeat of dashboard, and call SimpleHttpResponse#toString().\n\nIt still will return http 200 ok response code, even though  throw ex.  It seems SimpleHttpResponseParser  don't check the response data, which may  need to be checked. How about we open another issue to discuss ?", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386215801", "createdAt": "2020-03-02T06:30:24Z", "author": {"login": "linlinisme"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ2NTY3NQ==", "bodyText": "I think that 3 need to check.To verify it, we can throw Exception in MachineRegistryController#receiveHeartBeat of dashboard, and call SimpleHttpResponse#toString().\n\nIt still will return http 200 ok response code, even though throw ex. It seems SimpleHttpResponseParser don't check the response data, which may need to be checked. How about we open another issue to discuss ?\n\nYeah, we could open another issue to discuss how to improve it :)", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386465675", "createdAt": "2020-03-02T15:34:47Z", "author": {"login": "sczyh30"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc1NDU4Nw==", "bodyText": "Yes, one issue one PR is clean and consistent.\n\nIt still will return http 200 ok response code, even though throw ex. It seems SimpleHttpResponseParser don't check the response data\nI got http 500 and the SimpleHttpResponseParser checked the response.\n\nAdd this in MachineRegistryController#receiveHeartBeat\nif (true) {\n    throw new RuntimeException(\"test\");\n}\nThen add in SimpleHttpHeartbeatSender#sendHeartbeat\ntry {\n    System.out.println(response);\n} catch (Exception e) {\n    e.printStackTrace();\n}\nThen the response code 500 got, and NPE occured.", "url": "https://github.com/alibaba/Sentinel/pull/1303#discussion_r386754587", "createdAt": "2020-03-03T01:43:17Z", "author": {"login": "cdfive"}, "path": "sentinel-transport/sentinel-transport-netty-http/src/main/java/com/alibaba/csp/sentinel/transport/heartbeat/HttpHeartbeatSender.java", "diffHunk": "@@ -89,11 +91,43 @@ public boolean sendHeartbeat() throws Exception {\n         // Send heartbeat request.\n         CloseableHttpResponse response = client.execute(request);\n         response.close();\n-        return true;\n+        int statusCode = response.getStatusLine().getStatusCode();\n+        if (statusCode == OK_STATUS) {\n+            return true;\n+        } else if (clientErrorCode(statusCode) || serverErrorCode(statusCode)) {\n+            RecordLog.warn(\"[HttpHeartbeatSender] Failed to send heartbeat to \"\n+                    + consoleHost + \":\" + consolePort + \", response : \", response);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM0NzY4Ng=="}, "originalCommit": {"oid": "f3a32dd08c28bd49ae5a3ba6282266d76fb4536e"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4236, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}