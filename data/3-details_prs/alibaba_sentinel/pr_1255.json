{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyOTc4NjA1", "number": 1255, "title": "Fix the parsing issue in large post request for transport-simple-http", "bodyText": "Describe what this PR does / why we need it\nPlease refer to #1253\nImprove unit test for HttpEventTask.\nDoes this pull request fix one issue?\nYes.\nDescribe how you did it\nChange single read into iteration.\nDescribe how to verify it\nDo post request larger than 10kB.\nSpecial notes for reviews\nNope", "createdAt": "2020-01-15T06:31:22Z", "url": "https://github.com/alibaba/Sentinel/pull/1255", "merged": true, "mergeCommit": {"oid": "05e3caf618ef00a2e9d24204262295e7e36693bf"}, "closed": true, "closedAt": "2020-03-13T03:15:46Z", "author": {"login": "jasonjoo2010"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6fj6OgH2gAyMzYyOTc4NjA1OmVjZTQ1NjFjYjliMjRkM2NiOTgzMTBjZjA5Mzk5YTUxNTZmYjA5YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNHjVvAFqTM3NDAyNzY0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ece4561cb9b24d3cb98310cf09399a5156fb09a5", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/ece4561cb9b24d3cb98310cf09399a5156fb09a5", "committedDate": "2020-01-15T06:28:49Z", "message": "Fix the parsing issue in large post request for transport-simple-http\nPlease refer to #1253"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28f20d01b15f81942387ec6b3bb0cb00839428aa", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/28f20d01b15f81942387ec6b3bb0cb00839428aa", "committedDate": "2020-01-15T08:16:49Z", "message": "fix pmd"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b7d56f64a86e55e56627495a4918c9860fab192", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/9b7d56f64a86e55e56627495a4918c9860fab192", "committedDate": "2020-01-16T03:12:41Z", "message": "Make Content-Type more compatible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c9150ae06b65eb42fdda5351dca51c189343d8b", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/0c9150ae06b65eb42fdda5351dca51c189343d8b", "committedDate": "2020-01-19T11:32:53Z", "message": "Supply the missing license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9d8a008f6f3f64ed6226782bec6ea8347247e1a", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/e9d8a008f6f3f64ed6226782bec6ea8347247e1a", "committedDate": "2020-03-09T17:38:07Z", "message": "deal with addition secenarios"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e08c2ed31ed12315db98618c2db8e1aae4a2d990", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/e08c2ed31ed12315db98618c2db8e1aae4a2d990", "committedDate": "2020-03-10T04:53:35Z", "message": "for compatible with Content-Length use InputerStream instead of Reader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9278baf0dcabf2da03facf5e10d60ddc47044317", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/9278baf0dcabf2da03facf5e10d60ddc47044317", "committedDate": "2020-03-10T05:01:37Z", "message": "Supply license header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d44078e6b82714e9d15ed7dd4c541f9b50b9cc28", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/d44078e6b82714e9d15ed7dd4c541f9b50b9cc28", "committedDate": "2020-03-10T05:03:13Z", "message": "code style problem"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDY1NDU4", "url": "https://github.com/alibaba/Sentinel/pull/1255#pullrequestreview-373465458", "createdAt": "2020-03-12T11:12:46Z", "commit": {"oid": "d44078e6b82714e9d15ed7dd4c541f9b50b9cc28"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMToxMjo0NlrOF1aXlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMToxMjo0NlrOF1aXlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MDg3MQ==", "bodyText": "The content length here is wrong when the message contains non-ASCII characters (e.g. Chinese characters). Maybe we should use message.getBytes().length instead?", "url": "https://github.com/alibaba/Sentinel/pull/1255#discussion_r391550871", "createdAt": "2020-03-12T11:12:46Z", "author": {"login": "sczyh30"}, "path": "sentinel-transport/sentinel-transport-simple-http/src/main/java/com/alibaba/csp/sentinel/transport/command/http/HttpEventTask.java", "diffHunk": "@@ -190,56 +303,31 @@ private void closeResource(Closeable closeable) {\n         }\n     }\n \n-    private void handleResponse(CommandResponse response, /*@NonNull*/ final PrintWriter printWriter,\n-        /*@NonNull*/ final OutputStream rawOutputStream) throws Exception {\n+    private <T> void handleResponse(CommandResponse<T> response, final PrintWriter printWriter) throws Exception {\n         if (response.isSuccess()) {\n             if (response.getResult() == null) {\n-                writeOkStatusLine(printWriter);\n+                writeResponse(printWriter, StatusCode.OK, null);\n                 return;\n             }\n-            // Write 200 OK status line.\n-            writeOkStatusLine(printWriter);\n             // Here we directly use `toString` to encode the result to plain text.\n             byte[] buffer = response.getResult().toString().getBytes(SentinelConfig.charset());\n-            rawOutputStream.write(buffer);\n-            rawOutputStream.flush();\n+            writeResponse(printWriter, StatusCode.OK, new String(buffer));\n         } else {\n             String msg = SERVER_ERROR_MESSAGE;\n             if (response.getException() != null) {\n                 msg = response.getException().getMessage();\n             }\n-            badRequest(printWriter, msg);\n+            writeResponse(printWriter, StatusCode.BAD_REQUEST, msg);\n         }\n     }\n-\n-    /**\n-     * Write `400 Bad Request` HTTP response status line and message body, then flush.\n-     */\n-    private void badRequest(/*@NonNull*/ final PrintWriter out, String message) {\n-        out.print(\"HTTP/1.1 400 Bad Request\\r\\n\"\n-            + \"Connection: close\\r\\n\\r\\n\");\n-        out.print(message);\n-        out.flush();\n-        writtenHead = true;\n-    }\n-\n-    /**\n-     * Write `500 Internal Server Error` HTTP response status line and message body, then flush.\n-     */\n-    private void internalError(/*@NonNull*/ final PrintWriter out, String message) {\n-        out.print(\"HTTP/1.1 500 Internal Server Error\\r\\n\"\n-            + \"Connection: close\\r\\n\\r\\n\");\n-        out.print(message);\n-        out.flush();\n-        writtenHead = true;\n-    }\n-\n-    /**\n-     * Write `200 OK` HTTP response status line and flush.\n-     */\n-    private void writeOkStatusLine(/*@NonNull*/ final PrintWriter out) {\n-        out.print(\"HTTP/1.1 200 OK\\r\\n\"\n-            + \"Connection: close\\r\\n\\r\\n\");\n+    \n+    private void writeResponse(PrintWriter out, StatusCode statusCode, String message) {\n+        out.print(\"HTTP/1.0 \" + statusCode.toString() + \"\\r\\n\"\n+                + \"Content-Length: \" + (message == null ? 0 : message.length()) + \"\\r\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d44078e6b82714e9d15ed7dd4c541f9b50b9cc28"}, "originalPosition": 410}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed3525003581d9c30c08419f740ed011ea5e46a", "author": {"user": {"login": "jasonjoo2010", "name": "Jason Joo"}}, "url": "https://github.com/alibaba/Sentinel/commit/1ed3525003581d9c30c08419f740ed011ea5e46a", "committedDate": "2020-03-13T01:47:25Z", "message": "fix Content-Length in response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MDI3NjQ2", "url": "https://github.com/alibaba/Sentinel/pull/1255#pullrequestreview-374027646", "createdAt": "2020-03-13T03:15:02Z", "commit": {"oid": "1ed3525003581d9c30c08419f740ed011ea5e46a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4016, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}