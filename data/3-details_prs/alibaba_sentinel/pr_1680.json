{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMTk0ODMw", "number": 1680, "title": "Fix bugs and improve default fallback logic of Apache Dubbo adapter", "bodyText": "Describe what this PR does / why we need it\nThere are some problems in Apache Dubbo adapter (since 1.8.0-SNAPSHOT):\n\nUnexpected behavior will occur when there are non-biz errors (e.g. Dubbo RPC timeout), which is caused by NPE in whenComplete hook in consumer filter.\nThe default fallback logic (wrap an error result with SentinelRpcException, which wraps a BlockException) may cause error when deserialization.\n\nThis PR fixes the bug and improves the default fallback of Apache Dubbo 2.7.x adapter.\nDoes this pull request fix one issue?\nNONE\nDescribe how you did it\n\nAdd RuntimeException converting method (toRuntimeException) in BlockException and polish logic for BlockException validation\nFix NPE bug in consumer filter (when non-biz error occurred)\nImprove default fallback in Dubbo 2.7.x adapter: convert the BlockException to a simple RuntimeException (with necessary message)\nPolish code and comments\n\nDescribe how to verify it\nRun the test cases.\nSpecial notes for reviews\nNONE", "createdAt": "2020-08-19T14:15:39Z", "url": "https://github.com/alibaba/Sentinel/pull/1680", "merged": true, "mergeCommit": {"oid": "5905874dd8fabc671fd9d996a2d56a7d493614c1"}, "closed": true, "closedAt": "2020-08-20T02:22:08Z", "author": {"login": "sczyh30"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAcCKEAH2gAyNDcwMTk0ODMwOmIyZGQxMGYyODhlZWM3OWZlNmY2ZWRiOTEwNDVkMDI0YTI2OGU5NGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAmrJEgFqTQ3MTA4MjYyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b2dd10f288eec79fe6f6edb91045d024a268e94a", "author": {"user": {"login": "sczyh30", "name": "Eric Zhao"}}, "url": "https://github.com/alibaba/Sentinel/commit/b2dd10f288eec79fe6f6edb91045d024a268e94a", "committedDate": "2020-08-19T13:56:56Z", "message": "Add RuntimeException converting method in BlockException and polish logic for validation\n\nSigned-off-by: Eric Zhao <sczyh16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjg5MTEw", "url": "https://github.com/alibaba/Sentinel/pull/1680#pullrequestreview-470689110", "createdAt": "2020-08-19T17:28:45Z", "commit": {"oid": "20229fc2c9a47c38a0ec07c6609a72b17cdedc0b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyODo0NVrOHDSFPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzoyODo0NVrOHDSFPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwNDAzMQ==", "bodyText": "Maybe the priority list is throwable -> r.exception indicating throwable is more fatal. How do you think about it?", "url": "https://github.com/alibaba/Sentinel/pull/1680#discussion_r473204031", "createdAt": "2020-08-19T17:28:45Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-adapter/sentinel-apache-dubbo-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/dubbo/SentinelDubboConsumerFilter.java", "diffHunk": "@@ -98,24 +101,26 @@ private Result syncInvoke(Invoker<?> invoker, Invocation invocation) {\n         }\n     }\n \n-\n     private Result asyncInvoke(Invoker<?> invoker, Invocation invocation) {\n         LinkedList<EntryHolder> queue = new LinkedList<>();\n         String prefix = DubboAdapterGlobalConfig.getDubboConsumerResNamePrefixKey();\n         String interfaceResourceName = getInterfaceName(invoker, prefix);\n         String methodResourceName = getMethodName(invoker, invocation, prefix);\n         try {\n-            queue.push(new EntryHolder(SphU.asyncEntry(interfaceResourceName, ResourceTypeConstants.COMMON_RPC, EntryType.OUT), null));\n-            queue.push(new EntryHolder(SphU.asyncEntry(methodResourceName, ResourceTypeConstants.COMMON_RPC, EntryType.OUT, 1, invocation.getArguments()), invocation.getArguments()));\n+            queue.push(new EntryHolder(\n+                SphU.asyncEntry(interfaceResourceName, ResourceTypeConstants.COMMON_RPC, EntryType.OUT), null));\n+            queue.push(new EntryHolder(\n+                SphU.asyncEntry(methodResourceName, ResourceTypeConstants.COMMON_RPC,\n+                    EntryType.OUT, 1, invocation.getArguments()), invocation.getArguments()));\n             Result result = invoker.invoke(invocation);\n-            result.whenCompleteWithContext(new BiConsumer<Result, Throwable>() {\n-                @Override\n-                public void accept(Result result, Throwable throwable) {\n-                    while (!queue.isEmpty()) {\n-                        EntryHolder holder = queue.pop();\n-                        Tracer.traceEntry(result.getException(), holder.entry);\n-                        exitEntry(holder);\n-                    }\n+            result.whenCompleteWithContext((r, throwable) -> {\n+                while (!queue.isEmpty()) {\n+                    EntryHolder holder = queue.pop();\n+                    Throwable error = Optional.ofNullable(r)\n+                        .map(Result::getException)\n+                        .orElse(throwable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20229fc2c9a47c38a0ec07c6609a72b17cdedc0b"}, "originalPosition": 72}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20229fc2c9a47c38a0ec07c6609a72b17cdedc0b", "author": {"user": {"login": "sczyh30", "name": "Eric Zhao"}}, "url": "https://github.com/alibaba/Sentinel/commit/20229fc2c9a47c38a0ec07c6609a72b17cdedc0b", "committedDate": "2020-08-19T14:10:02Z", "message": "Fix NPE bug and improve default fallback in Dubbo 2.7.x adapter\n\n- Fix NPE bug in consumer filter (when non-biz error occurred)\n- Improve default fallback in Dubbo 2.7.x adapter: convert the BlockException to a simple RuntimeException (with necessary message)\n- Polish code and comments\n\nSigned-off-by: Eric Zhao <sczyh16@gmail.com>"}, "afterCommit": {"oid": "e0280b9b3dbe893dbd30f55de1e4cc5e6fabf83f", "author": {"user": {"login": "sczyh30", "name": "Eric Zhao"}}, "url": "https://github.com/alibaba/Sentinel/commit/e0280b9b3dbe893dbd30f55de1e4cc5e6fabf83f", "committedDate": "2020-08-20T01:48:10Z", "message": "Fix NPE bug and improve default fallback in Dubbo 2.7.x adapter\n\n- Fix NPE bug in consumer filter (when non-biz error occurred)\n- Improve default fallback in Dubbo 2.7.x adapter: convert the BlockException to a simple RuntimeException (with necessary message)\n- Polish code and comments\n\nSigned-off-by: Eric Zhao <sczyh16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDc2NTY2", "url": "https://github.com/alibaba/Sentinel/pull/1680#pullrequestreview-471076566", "createdAt": "2020-08-20T01:59:27Z", "commit": {"oid": "e0280b9b3dbe893dbd30f55de1e4cc5e6fabf83f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMTo1OToyN1rOHDmCgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMTo1OToyN1rOHDmCgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzUzMTAwOQ==", "bodyText": "It's better to set error outside the loop because there are always more than one elements in stack.", "url": "https://github.com/alibaba/Sentinel/pull/1680#discussion_r473531009", "createdAt": "2020-08-20T01:59:27Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-adapter/sentinel-apache-dubbo-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/dubbo/SentinelDubboConsumerFilter.java", "diffHunk": "@@ -98,24 +101,27 @@ private Result syncInvoke(Invoker<?> invoker, Invocation invocation) {\n         }\n     }\n \n-\n     private Result asyncInvoke(Invoker<?> invoker, Invocation invocation) {\n         LinkedList<EntryHolder> queue = new LinkedList<>();\n         String prefix = DubboAdapterGlobalConfig.getDubboConsumerResNamePrefixKey();\n         String interfaceResourceName = getInterfaceName(invoker, prefix);\n         String methodResourceName = getMethodName(invoker, invocation, prefix);\n         try {\n-            queue.push(new EntryHolder(SphU.asyncEntry(interfaceResourceName, ResourceTypeConstants.COMMON_RPC, EntryType.OUT), null));\n-            queue.push(new EntryHolder(SphU.asyncEntry(methodResourceName, ResourceTypeConstants.COMMON_RPC, EntryType.OUT, 1, invocation.getArguments()), invocation.getArguments()));\n+            queue.push(new EntryHolder(\n+                SphU.asyncEntry(interfaceResourceName, ResourceTypeConstants.COMMON_RPC, EntryType.OUT), null));\n+            queue.push(new EntryHolder(\n+                SphU.asyncEntry(methodResourceName, ResourceTypeConstants.COMMON_RPC,\n+                    EntryType.OUT, 1, invocation.getArguments()), invocation.getArguments()));\n             Result result = invoker.invoke(invocation);\n-            result.whenCompleteWithContext(new BiConsumer<Result, Throwable>() {\n-                @Override\n-                public void accept(Result result, Throwable throwable) {\n-                    while (!queue.isEmpty()) {\n-                        EntryHolder holder = queue.pop();\n-                        Tracer.traceEntry(result.getException(), holder.entry);\n-                        exitEntry(holder);\n+            result.whenCompleteWithContext((r, throwable) -> {\n+                while (!queue.isEmpty()) {\n+                    EntryHolder holder = queue.pop();\n+                    Throwable error = throwable;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0280b9b3dbe893dbd30f55de1e4cc5e6fabf83f"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02e23d19f681a52571a630419da82cc38a4e6944", "author": {"user": {"login": "sczyh30", "name": "Eric Zhao"}}, "url": "https://github.com/alibaba/Sentinel/commit/02e23d19f681a52571a630419da82cc38a4e6944", "committedDate": "2020-08-20T02:02:01Z", "message": "Fix NPE bug and improve default fallback in Dubbo 2.7.x adapter\n\n- Fix NPE bug in consumer filter (when non-biz error occurred)\n- Improve default fallback in Dubbo 2.7.x adapter: convert the BlockException to a simple RuntimeException (with necessary message)\n- Polish code and comments\n\nSigned-off-by: Eric Zhao <sczyh16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0280b9b3dbe893dbd30f55de1e4cc5e6fabf83f", "author": {"user": {"login": "sczyh30", "name": "Eric Zhao"}}, "url": "https://github.com/alibaba/Sentinel/commit/e0280b9b3dbe893dbd30f55de1e4cc5e6fabf83f", "committedDate": "2020-08-20T01:48:10Z", "message": "Fix NPE bug and improve default fallback in Dubbo 2.7.x adapter\n\n- Fix NPE bug in consumer filter (when non-biz error occurred)\n- Improve default fallback in Dubbo 2.7.x adapter: convert the BlockException to a simple RuntimeException (with necessary message)\n- Polish code and comments\n\nSigned-off-by: Eric Zhao <sczyh16@gmail.com>"}, "afterCommit": {"oid": "02e23d19f681a52571a630419da82cc38a4e6944", "author": {"user": {"login": "sczyh30", "name": "Eric Zhao"}}, "url": "https://github.com/alibaba/Sentinel/commit/02e23d19f681a52571a630419da82cc38a4e6944", "committedDate": "2020-08-20T02:02:01Z", "message": "Fix NPE bug and improve default fallback in Dubbo 2.7.x adapter\n\n- Fix NPE bug in consumer filter (when non-biz error occurred)\n- Improve default fallback in Dubbo 2.7.x adapter: convert the BlockException to a simple RuntimeException (with necessary message)\n- Polish code and comments\n\nSigned-off-by: Eric Zhao <sczyh16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDgyNjI5", "url": "https://github.com/alibaba/Sentinel/pull/1680#pullrequestreview-471082629", "createdAt": "2020-08-20T02:20:45Z", "commit": {"oid": "02e23d19f681a52571a630419da82cc38a4e6944"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3838, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}