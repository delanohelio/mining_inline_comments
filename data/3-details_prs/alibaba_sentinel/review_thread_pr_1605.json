{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MzA3NjYz", "number": 1605, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQyMTo1MzoyN1rOEP5Oiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMjowMzo0MFrOEelmVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1MTAxNzA3OnYy", "diffSide": "RIGHT", "path": "sentinel-adapter/sentinel-zuul-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/api/route/RegexRoutePathMatcher.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQyMTo1MzoyN1rOGzyoDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNzoyNjowOFrOG2lldA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk2MDAxMg==", "bodyText": "Could there be a case like pathInfo is not trimmed or pathInfo is full of spaces? Isn't apache common StringUtils isBlank better?", "url": "https://github.com/alibaba/Sentinel/pull/1605#discussion_r456960012", "createdAt": "2020-07-19T21:53:27Z", "author": {"login": "lfzCarlosC"}, "path": "sentinel-adapter/sentinel-zuul-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/api/route/RegexRoutePathMatcher.java", "diffHunk": "@@ -39,7 +40,13 @@ public RegexRoutePathMatcher(String pattern) {\n \n     @Override\n     public boolean test(RequestContext context) {\n-        String path = context.getRequest().getServletPath();\n+        //Solve the problem of prefix and suffix matching\n+        HttpServletRequest request = context.getRequest();\n+        String path = request.getServletPath();\n+        String pathInfo = request.getPathInfo();\n+        if (StringUtils.length(pathInfo) > 0) {\n+            path = path + pathInfo;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a046ccbf915bcf6e3708e03b160a136596d85a4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk5NDIyMg==", "bodyText": "Ok, this piece is really my incomplete consideration, thank you for correcting, and it has been fixed", "url": "https://github.com/alibaba/Sentinel/pull/1605#discussion_r456994222", "createdAt": "2020-07-20T02:18:09Z", "author": {"login": "JiangZian"}, "path": "sentinel-adapter/sentinel-zuul-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/api/route/RegexRoutePathMatcher.java", "diffHunk": "@@ -39,7 +40,13 @@ public RegexRoutePathMatcher(String pattern) {\n \n     @Override\n     public boolean test(RequestContext context) {\n-        String path = context.getRequest().getServletPath();\n+        //Solve the problem of prefix and suffix matching\n+        HttpServletRequest request = context.getRequest();\n+        String path = request.getServletPath();\n+        String pathInfo = request.getPathInfo();\n+        if (StringUtils.length(pathInfo) > 0) {\n+            path = path + pathInfo;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk2MDAxMg=="}, "originalCommit": {"oid": "2a046ccbf915bcf6e3708e03b160a136596d85a4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE3OTMyNw==", "bodyText": "Maybe using the embedded com.alibaba.csp.sentinel.util.StringUtil is enough.", "url": "https://github.com/alibaba/Sentinel/pull/1605#discussion_r459179327", "createdAt": "2020-07-23T02:05:58Z", "author": {"login": "sczyh30"}, "path": "sentinel-adapter/sentinel-zuul-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/api/route/RegexRoutePathMatcher.java", "diffHunk": "@@ -39,7 +40,13 @@ public RegexRoutePathMatcher(String pattern) {\n \n     @Override\n     public boolean test(RequestContext context) {\n-        String path = context.getRequest().getServletPath();\n+        //Solve the problem of prefix and suffix matching\n+        HttpServletRequest request = context.getRequest();\n+        String path = request.getServletPath();\n+        String pathInfo = request.getPathInfo();\n+        if (StringUtils.length(pathInfo) > 0) {\n+            path = path + pathInfo;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk2MDAxMg=="}, "originalCommit": {"oid": "2a046ccbf915bcf6e3708e03b160a136596d85a4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg5MjA4NA==", "bodyText": "Ok, this piece is really my incomplete consideration, thank you for correcting, and it has been fixed", "url": "https://github.com/alibaba/Sentinel/pull/1605#discussion_r459892084", "createdAt": "2020-07-24T07:26:08Z", "author": {"login": "JiangZian"}, "path": "sentinel-adapter/sentinel-zuul-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/api/route/RegexRoutePathMatcher.java", "diffHunk": "@@ -39,7 +40,13 @@ public RegexRoutePathMatcher(String pattern) {\n \n     @Override\n     public boolean test(RequestContext context) {\n-        String path = context.getRequest().getServletPath();\n+        //Solve the problem of prefix and suffix matching\n+        HttpServletRequest request = context.getRequest();\n+        String path = request.getServletPath();\n+        String pathInfo = request.getPathInfo();\n+        if (StringUtils.length(pathInfo) > 0) {\n+            path = path + pathInfo;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk2MDAxMg=="}, "originalCommit": {"oid": "2a046ccbf915bcf6e3708e03b160a136596d85a4"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNTA4NzU3OnYy", "diffSide": "RIGHT", "path": "sentinel-adapter/sentinel-zuul-adapter/src/test/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/route/SentinelZuulRouteTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMjowMzo0MFrOHKU6Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMzo1MTozMVrOHQNVMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDU5MDMzOQ==", "bodyText": "The  pattern /service[^\\s]+.jsp seems lack of considered.\n\\.jsp should be better than .jsp.\nAnd [^\\s] which indicates non-space subsequence i don't quite understand here because no space is allowed in URI as we know.\nTalk to unit test it's better to have both positive and negative cases. So if you familiar with this could you improve it? Otherwise we can improve it later.", "url": "https://github.com/alibaba/Sentinel/pull/1605#discussion_r480590339", "createdAt": "2020-09-01T02:03:40Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-adapter/sentinel-zuul-adapter/src/test/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/route/SentinelZuulRouteTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.alibaba.csp.sentinel.adapter.gateway.zuul.route;\n+\n+import com.alibaba.csp.sentinel.adapter.gateway.zuul.api.route.PrefixRoutePathMatcher;\n+import com.alibaba.csp.sentinel.adapter.gateway.zuul.api.route.RegexRoutePathMatcher;\n+import com.netflix.zuul.context.RequestContext;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+\n+import static com.alibaba.csp.sentinel.adapter.gateway.zuul.constants.ZuulConstant.SERVICE_ID_KEY;\n+\n+/**\n+ * @author: jiangzian\n+ **/\n+public class SentinelZuulRouteTest {\n+\n+    private final String SERVICE_ID = \"servicea\";\n+\n+    private final String SERVER_NAME = \"www.example.com\";\n+    private final String REQUEST_URI = \"/servicea/test.jsp\";\n+    private final String QUERY_STRING = \"param1=value1&param\";\n+\n+    private RequestContext requestContext = new RequestContext();\n+\n+\n+    @Before\n+    public void setUp() {\n+        MockHttpServletRequest request = new MockHttpServletRequest();\n+        request.setServerName(SERVER_NAME);\n+        request.setRequestURI(REQUEST_URI);\n+        request.setQueryString(QUERY_STRING);\n+        requestContext.set(SERVICE_ID_KEY, SERVICE_ID);\n+        requestContext.setRequest(request);\n+        RequestContext.testSetCurrentContext(requestContext);\n+    }\n+\n+    @Test\n+    public void testPrefixRoutePathMatche() {\n+        PrefixRoutePathMatcher prefixRoutePathMatcher = new PrefixRoutePathMatcher(\"/servicea/????.jsp\");\n+        Assert.assertTrue(prefixRoutePathMatcher.test(requestContext));\n+    }\n+\n+    @Test\n+    public void testRegexRoutePathMatcher() {\n+        RegexRoutePathMatcher regexRoutePathMatcher = new RegexRoutePathMatcher(\"/servicea[^\\\\s]+.jsp\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9594562398aca6adaa063fb7badf04c58ee54be2"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDcxMzY4MA==", "bodyText": "Thank you very much for your Suggestions, but these are my lack of consideration. Now I have resubmitted them", "url": "https://github.com/alibaba/Sentinel/pull/1605#discussion_r480713680", "createdAt": "2020-09-01T03:38:28Z", "author": {"login": "JiangZian"}, "path": "sentinel-adapter/sentinel-zuul-adapter/src/test/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/route/SentinelZuulRouteTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.alibaba.csp.sentinel.adapter.gateway.zuul.route;\n+\n+import com.alibaba.csp.sentinel.adapter.gateway.zuul.api.route.PrefixRoutePathMatcher;\n+import com.alibaba.csp.sentinel.adapter.gateway.zuul.api.route.RegexRoutePathMatcher;\n+import com.netflix.zuul.context.RequestContext;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+\n+import static com.alibaba.csp.sentinel.adapter.gateway.zuul.constants.ZuulConstant.SERVICE_ID_KEY;\n+\n+/**\n+ * @author: jiangzian\n+ **/\n+public class SentinelZuulRouteTest {\n+\n+    private final String SERVICE_ID = \"servicea\";\n+\n+    private final String SERVER_NAME = \"www.example.com\";\n+    private final String REQUEST_URI = \"/servicea/test.jsp\";\n+    private final String QUERY_STRING = \"param1=value1&param\";\n+\n+    private RequestContext requestContext = new RequestContext();\n+\n+\n+    @Before\n+    public void setUp() {\n+        MockHttpServletRequest request = new MockHttpServletRequest();\n+        request.setServerName(SERVER_NAME);\n+        request.setRequestURI(REQUEST_URI);\n+        request.setQueryString(QUERY_STRING);\n+        requestContext.set(SERVICE_ID_KEY, SERVICE_ID);\n+        requestContext.setRequest(request);\n+        RequestContext.testSetCurrentContext(requestContext);\n+    }\n+\n+    @Test\n+    public void testPrefixRoutePathMatche() {\n+        PrefixRoutePathMatcher prefixRoutePathMatcher = new PrefixRoutePathMatcher(\"/servicea/????.jsp\");\n+        Assert.assertTrue(prefixRoutePathMatcher.test(requestContext));\n+    }\n+\n+    @Test\n+    public void testRegexRoutePathMatcher() {\n+        RegexRoutePathMatcher regexRoutePathMatcher = new RegexRoutePathMatcher(\"/servicea[^\\\\s]+.jsp\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDU5MDMzOQ=="}, "originalCommit": {"oid": "9594562398aca6adaa063fb7badf04c58ee54be2"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc1NzY4MA==", "bodyText": "@jasonjoo2010 Do you have time to check my logic", "url": "https://github.com/alibaba/Sentinel/pull/1605#discussion_r486757680", "createdAt": "2020-09-11T03:51:31Z", "author": {"login": "JiangZian"}, "path": "sentinel-adapter/sentinel-zuul-adapter/src/test/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/route/SentinelZuulRouteTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.alibaba.csp.sentinel.adapter.gateway.zuul.route;\n+\n+import com.alibaba.csp.sentinel.adapter.gateway.zuul.api.route.PrefixRoutePathMatcher;\n+import com.alibaba.csp.sentinel.adapter.gateway.zuul.api.route.RegexRoutePathMatcher;\n+import com.netflix.zuul.context.RequestContext;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+\n+import static com.alibaba.csp.sentinel.adapter.gateway.zuul.constants.ZuulConstant.SERVICE_ID_KEY;\n+\n+/**\n+ * @author: jiangzian\n+ **/\n+public class SentinelZuulRouteTest {\n+\n+    private final String SERVICE_ID = \"servicea\";\n+\n+    private final String SERVER_NAME = \"www.example.com\";\n+    private final String REQUEST_URI = \"/servicea/test.jsp\";\n+    private final String QUERY_STRING = \"param1=value1&param\";\n+\n+    private RequestContext requestContext = new RequestContext();\n+\n+\n+    @Before\n+    public void setUp() {\n+        MockHttpServletRequest request = new MockHttpServletRequest();\n+        request.setServerName(SERVER_NAME);\n+        request.setRequestURI(REQUEST_URI);\n+        request.setQueryString(QUERY_STRING);\n+        requestContext.set(SERVICE_ID_KEY, SERVICE_ID);\n+        requestContext.setRequest(request);\n+        RequestContext.testSetCurrentContext(requestContext);\n+    }\n+\n+    @Test\n+    public void testPrefixRoutePathMatche() {\n+        PrefixRoutePathMatcher prefixRoutePathMatcher = new PrefixRoutePathMatcher(\"/servicea/????.jsp\");\n+        Assert.assertTrue(prefixRoutePathMatcher.test(requestContext));\n+    }\n+\n+    @Test\n+    public void testRegexRoutePathMatcher() {\n+        RegexRoutePathMatcher regexRoutePathMatcher = new RegexRoutePathMatcher(\"/servicea[^\\\\s]+.jsp\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDU5MDMzOQ=="}, "originalCommit": {"oid": "9594562398aca6adaa063fb7badf04c58ee54be2"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4209, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}