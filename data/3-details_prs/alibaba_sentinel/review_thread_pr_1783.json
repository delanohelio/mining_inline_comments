{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4Njg5NDE1", "number": 1783, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzowNDo1MVrOEq1pyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo1OTowN1rOErRd6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzU0Njk4OnYy", "diffSide": "RIGHT", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzowNDo1MVrOHdRjOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNDozMzozNFrOHd2cRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1ODI5Ng==", "bodyText": "Maybe the variable in logging message should be updated now.", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r500458296", "createdAt": "2020-10-06T17:04:51Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -129,20 +130,16 @@ public static boolean isOtherOrigin(String origin, String resourceName) {\n         @Override\n         public void configUpdate(List<FlowRule> value) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(value);\n-            if (rules != null) {\n-                flowRules.clear();\n-                flowRules.putAll(rules);\n-            }\n+            //the rules was always not null, it's no need to check nullable\n+            //remove checking to avoid IDE warning\n+            flowRules.set(rules);\n             RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c72752f233d231e2522fecc063e64ec1462c4796"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTA2MjcyNw==", "bodyText": "fixed", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501062727", "createdAt": "2020-10-07T14:33:34Z", "author": {"login": "vipweihua"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -129,20 +130,16 @@ public static boolean isOtherOrigin(String origin, String resourceName) {\n         @Override\n         public void configUpdate(List<FlowRule> value) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(value);\n-            if (rules != null) {\n-                flowRules.clear();\n-                flowRules.putAll(rules);\n-            }\n+            //the rules was always not null, it's no need to check nullable\n+            //remove checking to avoid IDE warning\n+            flowRules.set(rules);\n             RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1ODI5Ng=="}, "originalCommit": {"oid": "c72752f233d231e2522fecc063e64ec1462c4796"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODA5MTk0OnYy", "diffSide": "RIGHT", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo1NjowN1rOHd8zyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMzoxMzowNVrOHeMdyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2NzA1MQ==", "bodyText": "Is it necessary to initial its value (flowRules) to be an empty map obviously?\nIt's tricky now because the initial empty value is initialized by currentProperty.addListener(LISTENER); in static block. It may trigger a bug if anyone change any of them in future.", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501167051", "createdAt": "2020-10-07T16:56:07Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -83,7 +85,7 @@ public static void register2Property(SentinelProperty<List<FlowRule>> property)\n      */\n     public static List<FlowRule> getRules() {\n         List<FlowRule> rules = new ArrayList<FlowRule>();\n-        for (Map.Entry<String, List<FlowRule>> entry : flowRules.entrySet()) {\n+        for (Map.Entry<String, List<FlowRule>> entry : flowRules.get().entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "815f049341361009383bb84af0baba447e9a3ce9"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQyMzU2Mw==", "bodyText": "Totally agree.", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501423563", "createdAt": "2020-10-08T03:13:05Z", "author": {"login": "vipweihua"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -83,7 +85,7 @@ public static void register2Property(SentinelProperty<List<FlowRule>> property)\n      */\n     public static List<FlowRule> getRules() {\n         List<FlowRule> rules = new ArrayList<FlowRule>();\n-        for (Map.Entry<String, List<FlowRule>> entry : flowRules.entrySet()) {\n+        for (Map.Entry<String, List<FlowRule>> entry : flowRules.get().entrySet()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2NzA1MQ=="}, "originalCommit": {"oid": "815f049341361009383bb84af0baba447e9a3ce9"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzODEwNDEwOnYy", "diffSide": "RIGHT", "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNjo1OTowN1rOHd87jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMzoxNTo0NVrOHeMgmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2OTAzOA==", "bodyText": "For eventual consistency maybe rules is better. Because there may be duplicated logs with same content when races occurred.", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501169038", "createdAt": "2020-10-07T16:59:07Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -129,21 +131,17 @@ public static boolean isOtherOrigin(String origin, String resourceName) {\n         @Override\n         public void configUpdate(List<FlowRule> value) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(value);\n-            if (rules != null) {\n-                flowRules.clear();\n-                flowRules.putAll(rules);\n-            }\n-            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules);\n+            //the rules was always not null, it's no need to check nullable\n+            //remove checking to avoid IDE warning\n+            flowRules.set(rules);\n+            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "815f049341361009383bb84af0baba447e9a3ce9"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQyNDI4MA==", "bodyText": "Agree.", "url": "https://github.com/alibaba/Sentinel/pull/1783#discussion_r501424280", "createdAt": "2020-10-08T03:15:45Z", "author": {"login": "vipweihua"}, "path": "sentinel-core/src/main/java/com/alibaba/csp/sentinel/slots/block/flow/FlowRuleManager.java", "diffHunk": "@@ -129,21 +131,17 @@ public static boolean isOtherOrigin(String origin, String resourceName) {\n         @Override\n         public void configUpdate(List<FlowRule> value) {\n             Map<String, List<FlowRule>> rules = FlowRuleUtil.buildFlowRuleMap(value);\n-            if (rules != null) {\n-                flowRules.clear();\n-                flowRules.putAll(rules);\n-            }\n-            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules);\n+            //the rules was always not null, it's no need to check nullable\n+            //remove checking to avoid IDE warning\n+            flowRules.set(rules);\n+            RecordLog.info(\"[FlowRuleManager] Flow rules received: {}\", flowRules.get());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2OTAzOA=="}, "originalCommit": {"oid": "815f049341361009383bb84af0baba447e9a3ce9"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4126, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}