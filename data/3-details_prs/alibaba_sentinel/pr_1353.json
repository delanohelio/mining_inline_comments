{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxOTUxNTU1", "number": 1353, "title": "Fixes exit context when request is blocked in springwebmvc adaptor", "bodyText": "Describe what this PR does / why we need it\nWhen a request is blocked, the current context hasn't exited, and it may affect other request,\nsince the context is ThreadLocal and web server will usually reuse thread.\nDoes this pull request fix one issue?\nFixes #1350\nDescribe how you did it\nWhen AbstractSentinelInterceptor#preHandle catch BlockException, the function return false\nor throws Exception in it, then afterCompletion will not be executed, so context can't be exited.\nNow ContextUtil.exit(); is added in in catch Block to exit the context.\nDescribe how to verify it\nRun test case SentinelSpringMvcIntegrationTest#testOriginParser.\nSpecial notes for reviews\nContextUtil.exit(); is added in front of handleBlockException(request, response, e);\nsince if add it after, when handleBlockException throws Exception, exit can't be executed.\nanother way is to use try finally, not very sure which is better, maybe it's concise.\nIn test case, small typo in comment has been fixed and add more comment.\nPTAL.", "createdAt": "2020-03-22T03:35:54Z", "url": "https://github.com/alibaba/Sentinel/pull/1353", "merged": true, "mergeCommit": {"oid": "43b5e65ab3848520975eaabc22b8ce4832db678c"}, "closed": true, "closedAt": "2020-03-24T14:14:01Z", "author": {"login": "cdfive"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMAPyWgH2gAyMzkxOTUxNTU1OmU4YjI5NzgzOWNmN2VkNTg1MTVlZTU5MGEzMzQ4OGJhMGU2YTVhNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQzi7ngFqTM4MDM0NzU1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8b297839cf7ed58515ee590a33488ba0e6a5a47", "author": {"user": {"login": "cdfive", "name": null}}, "url": "https://github.com/alibaba/Sentinel/commit/e8b297839cf7ed58515ee590a33488ba0e6a5a47", "committedDate": "2020-03-09T16:10:25Z", "message": "Add \"web-context-unify\" configuration to support \"chain\" relation flow strategy in Spring webmvc adapter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43ecd462fbd9f137a4364db35f5c931d32fd6793", "author": {"user": {"login": "cdfive", "name": null}}, "url": "https://github.com/alibaba/Sentinel/commit/43ecd462fbd9f137a4364db35f5c931d32fd6793", "committedDate": "2020-03-14T14:35:44Z", "message": "Merge remote-tracking branch 'Sentinel/master'\n\n# Conflicts:\n#\tsentinel-adapter/sentinel-spring-webmvc-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/spring/webmvc/config/SentinelWebMvcConfig.java\n#\tsentinel-demo/sentinel-demo-spring-webmvc/src/main/java/com/alibaba/csp/sentinel/demo/spring/webmvc/config/InterceptorConfig.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2286e0b1a706ee0fff40e073af8e9a68f1aac75", "author": {"user": {"login": "cdfive", "name": null}}, "url": "https://github.com/alibaba/Sentinel/commit/f2286e0b1a706ee0fff40e073af8e9a68f1aac75", "committedDate": "2020-03-18T14:56:39Z", "message": "Merge remote-tracking branch 'Sentinel/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fbb10750c5c9e63b4b4978d71e65c1385cade33", "author": {"user": {"login": "cdfive", "name": null}}, "url": "https://github.com/alibaba/Sentinel/commit/1fbb10750c5c9e63b4b4978d71e65c1385cade33", "committedDate": "2020-03-22T02:56:46Z", "message": "Merge remote-tracking branch 'Sentinel/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65ff6761162a6473a8cede311c1a2216f469be66", "author": {"user": {"login": "cdfive", "name": null}}, "url": "https://github.com/alibaba/Sentinel/commit/65ff6761162a6473a8cede311c1a2216f469be66", "committedDate": "2020-03-22T03:20:45Z", "message": "Exit context if request is blocked and improve test case."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MTUyODc3", "url": "https://github.com/alibaba/Sentinel/pull/1353#pullrequestreview-379152877", "createdAt": "2020-03-23T06:11:25Z", "commit": {"oid": "65ff6761162a6473a8cede311c1a2216f469be66"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNjoxMToyNlrOF538Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwNjoxMToyNlrOF538Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIyOTY1OA==", "bodyText": "Maybe a try-catch here is better? Users may need the context in the block handler.", "url": "https://github.com/alibaba/Sentinel/pull/1353#discussion_r396229658", "createdAt": "2020-03-23T06:11:26Z", "author": {"login": "sczyh30"}, "path": "sentinel-adapter/sentinel-spring-webmvc-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/spring/webmvc/AbstractSentinelInterceptor.java", "diffHunk": "@@ -67,6 +67,7 @@ public boolean preHandle(HttpServletRequest request, HttpServletResponse respons\n             }\n             return true;\n         } catch (BlockException e) {\n+            ContextUtil.exit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65ff6761162a6473a8cede311c1a2216f469be66"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84dfe5e72f2c07af85787825b041d66b7b4a433c", "author": {"user": {"login": "cdfive", "name": null}}, "url": "https://github.com/alibaba/Sentinel/commit/84dfe5e72f2c07af85787825b041d66b7b4a433c", "committedDate": "2020-03-23T07:08:28Z", "message": "Using try finally block, since user may need the context in the block handler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMzQ3NTUw", "url": "https://github.com/alibaba/Sentinel/pull/1353#pullrequestreview-380347550", "createdAt": "2020-03-24T14:12:11Z", "commit": {"oid": "84dfe5e72f2c07af85787825b041d66b7b4a433c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3895, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}