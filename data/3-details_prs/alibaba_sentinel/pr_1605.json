{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MzA3NjYz", "number": 1605, "title": "Solve the problem of prefix and suffix matching #1109", "bodyText": "Describe what this PR does / why we need it\nSolve the problem of prefix and suffix matching #1109", "createdAt": "2020-07-15T07:46:05Z", "url": "https://github.com/alibaba/Sentinel/pull/1605", "merged": true, "mergeCommit": {"oid": "b50ce662bd3ae5cbdeb252d56773a4a6f3458672"}, "closed": true, "closedAt": "2020-09-13T17:46:08Z", "author": {"login": "JiangZian"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1FuHjAH2gAyNDQ5MzA3NjYzOjJhMDQ2Y2NiZjkxNWJjZjZlMzcwOGUwM2IxNjBhMTM2NTk2ZDg1YTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIiO6AgFqTQ4NzMyNjU0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a046ccbf915bcf6e3708e03b160a136596d85a4", "author": {"user": {"login": "JiangZian", "name": "M4Y"}}, "url": "https://github.com/alibaba/Sentinel/commit/2a046ccbf915bcf6e3708e03b160a136596d85a4", "committedDate": "2020-07-15T07:43:58Z", "message": "Solve the problem of prefix and suffix matching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMTY2MjA3", "url": "https://github.com/alibaba/Sentinel/pull/1605#pullrequestreview-451166207", "createdAt": "2020-07-19T21:53:27Z", "commit": {"oid": "2a046ccbf915bcf6e3708e03b160a136596d85a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQyMTo1MzoyN1rOGzyoDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOVQyMTo1MzoyN1rOGzyoDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Njk2MDAxMg==", "bodyText": "Could there be a case like pathInfo is not trimmed or pathInfo is full of spaces? Isn't apache common StringUtils isBlank better?", "url": "https://github.com/alibaba/Sentinel/pull/1605#discussion_r456960012", "createdAt": "2020-07-19T21:53:27Z", "author": {"login": "lfzCarlosC"}, "path": "sentinel-adapter/sentinel-zuul-adapter/src/main/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/api/route/RegexRoutePathMatcher.java", "diffHunk": "@@ -39,7 +40,13 @@ public RegexRoutePathMatcher(String pattern) {\n \n     @Override\n     public boolean test(RequestContext context) {\n-        String path = context.getRequest().getServletPath();\n+        //Solve the problem of prefix and suffix matching\n+        HttpServletRequest request = context.getRequest();\n+        String path = request.getServletPath();\n+        String pathInfo = request.getPathInfo();\n+        if (StringUtils.length(pathInfo) > 0) {\n+            path = path + pathInfo;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a046ccbf915bcf6e3708e03b160a136596d85a4"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89671f0f1fa1c8735fccdc1bbed580d93e2a7b36", "author": {"user": {"login": "JiangZian", "name": "M4Y"}}, "url": "https://github.com/alibaba/Sentinel/commit/89671f0f1fa1c8735fccdc1bbed580d93e2a7b36", "committedDate": "2020-07-20T02:10:16Z", "message": "Use Apache Common StringUtils isBlank to improve the robustness of judgment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b438232ff622db42c1b52de08a0c82bed5f5094", "author": {"user": {"login": "JiangZian", "name": "M4Y"}}, "url": "https://github.com/alibaba/Sentinel/commit/7b438232ff622db42c1b52de08a0c82bed5f5094", "committedDate": "2020-07-24T07:27:41Z", "message": "using the embedded com.alibaba.csp.sentinel.util.StringUtil\uff0cAdd test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12d4240bd6619296b99750a8b01b9ecdcfbc24c2", "author": {"user": {"login": "JiangZian", "name": "M4Y"}}, "url": "https://github.com/alibaba/Sentinel/commit/12d4240bd6619296b99750a8b01b9ecdcfbc24c2", "committedDate": "2020-07-24T09:29:30Z", "message": "reformat code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMDMwNDcy", "url": "https://github.com/alibaba/Sentinel/pull/1605#pullrequestreview-473030472", "createdAt": "2020-08-23T17:53:56Z", "commit": {"oid": "12d4240bd6619296b99750a8b01b9ecdcfbc24c2"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9594562398aca6adaa063fb7badf04c58ee54be2", "author": {"user": {"login": "JiangZian", "name": "M4Y"}}, "url": "https://github.com/alibaba/Sentinel/commit/9594562398aca6adaa063fb7badf04c58ee54be2", "committedDate": "2020-08-31T10:14:41Z", "message": "Change the mock method to MockHttpServletRequest, and change the URL fetching method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MzMyNDA4", "url": "https://github.com/alibaba/Sentinel/pull/1605#pullrequestreview-479332408", "createdAt": "2020-09-01T02:03:40Z", "commit": {"oid": "9594562398aca6adaa063fb7badf04c58ee54be2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMjowMzo0MFrOHKU6Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwMjowMzo0MFrOHKU6Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDU5MDMzOQ==", "bodyText": "The  pattern /service[^\\s]+.jsp seems lack of considered.\n\\.jsp should be better than .jsp.\nAnd [^\\s] which indicates non-space subsequence i don't quite understand here because no space is allowed in URI as we know.\nTalk to unit test it's better to have both positive and negative cases. So if you familiar with this could you improve it? Otherwise we can improve it later.", "url": "https://github.com/alibaba/Sentinel/pull/1605#discussion_r480590339", "createdAt": "2020-09-01T02:03:40Z", "author": {"login": "jasonjoo2010"}, "path": "sentinel-adapter/sentinel-zuul-adapter/src/test/java/com/alibaba/csp/sentinel/adapter/gateway/zuul/route/SentinelZuulRouteTest.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.alibaba.csp.sentinel.adapter.gateway.zuul.route;\n+\n+import com.alibaba.csp.sentinel.adapter.gateway.zuul.api.route.PrefixRoutePathMatcher;\n+import com.alibaba.csp.sentinel.adapter.gateway.zuul.api.route.RegexRoutePathMatcher;\n+import com.netflix.zuul.context.RequestContext;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.mock.web.MockHttpServletRequest;\n+\n+import static com.alibaba.csp.sentinel.adapter.gateway.zuul.constants.ZuulConstant.SERVICE_ID_KEY;\n+\n+/**\n+ * @author: jiangzian\n+ **/\n+public class SentinelZuulRouteTest {\n+\n+    private final String SERVICE_ID = \"servicea\";\n+\n+    private final String SERVER_NAME = \"www.example.com\";\n+    private final String REQUEST_URI = \"/servicea/test.jsp\";\n+    private final String QUERY_STRING = \"param1=value1&param\";\n+\n+    private RequestContext requestContext = new RequestContext();\n+\n+\n+    @Before\n+    public void setUp() {\n+        MockHttpServletRequest request = new MockHttpServletRequest();\n+        request.setServerName(SERVER_NAME);\n+        request.setRequestURI(REQUEST_URI);\n+        request.setQueryString(QUERY_STRING);\n+        requestContext.set(SERVICE_ID_KEY, SERVICE_ID);\n+        requestContext.setRequest(request);\n+        RequestContext.testSetCurrentContext(requestContext);\n+    }\n+\n+    @Test\n+    public void testPrefixRoutePathMatche() {\n+        PrefixRoutePathMatcher prefixRoutePathMatcher = new PrefixRoutePathMatcher(\"/servicea/????.jsp\");\n+        Assert.assertTrue(prefixRoutePathMatcher.test(requestContext));\n+    }\n+\n+    @Test\n+    public void testRegexRoutePathMatcher() {\n+        RegexRoutePathMatcher regexRoutePathMatcher = new RegexRoutePathMatcher(\"/servicea[^\\\\s]+.jsp\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9594562398aca6adaa063fb7badf04c58ee54be2"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e96a35f599ac37d9e2faeb2d7f2c5e0c66b87ceb", "author": {"user": {"login": "JiangZian", "name": "M4Y"}}, "url": "https://github.com/alibaba/Sentinel/commit/e96a35f599ac37d9e2faeb2d7f2c5e0c66b87ceb", "committedDate": "2020-09-01T03:25:37Z", "message": "Modify the regex matching rule to add an unexpected value test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MzI2NTQ3", "url": "https://github.com/alibaba/Sentinel/pull/1605#pullrequestreview-487326547", "createdAt": "2020-09-13T17:41:41Z", "commit": {"oid": "e96a35f599ac37d9e2faeb2d7f2c5e0c66b87ceb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3994, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}