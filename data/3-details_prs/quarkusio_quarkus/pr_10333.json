{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMzIzMDQy", "number": 10333, "title": "Fix broken sidecar handling", "bodyText": "Fixes: #10308", "createdAt": "2020-06-29T11:07:14Z", "url": "https://github.com/quarkusio/quarkus/pull/10333", "merged": true, "mergeCommit": {"oid": "e84411a32047238ea2b150ab0dc9966fcf370e2e"}, "closed": true, "closedAt": "2020-06-29T13:51:30Z", "author": {"login": "geoand"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv_H9RABqjM0OTIxMjA0NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwBUQwgFqTQzOTE1OTQ0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae5485672bddfe66f710dfd766ee80dfb1ef02c8", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/ae5485672bddfe66f710dfd766ee80dfb1ef02c8", "committedDate": "2020-06-29T11:06:48Z", "message": "Fix broken sidecar handling\n\nFixes: #10308"}, "afterCommit": {"oid": "f23d210cb551039a3c72e52a4c4befe397159bd8", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/f23d210cb551039a3c72e52a4c4befe397159bd8", "committedDate": "2020-06-29T11:13:06Z", "message": "Fix broken sidecar handling\n\nFixes: #10308"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "committedDate": "2020-06-29T11:23:34Z", "message": "Fix broken sidecar handling\n\nFixes: #10308"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f23d210cb551039a3c72e52a4c4befe397159bd8", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/f23d210cb551039a3c72e52a4c4befe397159bd8", "committedDate": "2020-06-29T11:13:06Z", "message": "Fix broken sidecar handling\n\nFixes: #10308"}, "afterCommit": {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad", "committedDate": "2020-06-29T11:23:34Z", "message": "Fix broken sidecar handling\n\nFixes: #10308"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MTQyMTI2", "url": "https://github.com/quarkusio/quarkus/pull/10333#pullrequestreview-439142126", "createdAt": "2020-06-29T13:27:56Z", "commit": {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMzoyNzo1N1rOGqQ7jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMzozODozNFrOGqRXuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3MDc2NA==", "bodyText": "The class seems identical to the upstream version. Can you please point out the difference?", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446970764", "createdAt": "2020-06-29T13:27:57Z", "author": {"login": "iocanel"}, "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/AddSidecarDecorator.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.ObjectMeta;\n+import io.dekorate.deps.kubernetes.api.model.PodSpecBuilder;\n+import io.dekorate.kubernetes.config.Container;\n+import io.dekorate.kubernetes.decorator.Decorator;\n+import io.dekorate.kubernetes.decorator.NamedResourceDecorator;\n+import io.dekorate.kubernetes.decorator.ResourceProvidingDecorator;\n+\n+/**\n+ * Copied from dekorate in order to fix some issues\n+ */\n+class AddSidecarDecorator extends NamedResourceDecorator<PodSpecBuilder> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NDIwMA==", "bodyText": "It's not obvious to me what's wrong with the upstream version.\nAlso, keep in mind that this implementation will result in the port being applied to all containers of all deployments (including init containers, sidecars or any other kind of container generated, or found under /src/main/kubernetes).", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446974200", "createdAt": "2020-06-29T13:32:53Z", "author": {"login": "iocanel"}, "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/AddContainerPortDecorator.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.ContainerBuilder;\n+import io.dekorate.kubernetes.annotation.Protocol;\n+import io.dekorate.kubernetes.config.Port;\n+import io.dekorate.kubernetes.decorator.AddSidecarDecorator;\n+import io.dekorate.kubernetes.decorator.ContainerDecorator;\n+import io.dekorate.kubernetes.decorator.Decorator;\n+import io.dekorate.kubernetes.decorator.ResourceProvidingDecorator;\n+\n+/**\n+ * Adapted from Dekorate's {@link io.dekorate.kubernetes.decorator.AddPortDecorator} in order to\n+ * address the limitation that the port was not being added (due to missing metadata)\n+ */\n+class AddContainerPortDecorator extends Decorator<ContainerBuilder> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NDk3Mw==", "bodyText": "Ok, I now see why you needed to copy the sidecar decorator...", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446974973", "createdAt": "2020-06-29T13:34:06Z", "author": {"login": "iocanel"}, "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/ContainerAdapter.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.Container;\n+import io.dekorate.deps.kubernetes.api.model.ContainerBuilder;\n+import io.dekorate.kubernetes.config.Env;\n+import io.dekorate.kubernetes.config.Mount;\n+import io.dekorate.kubernetes.config.Port;\n+import io.dekorate.kubernetes.decorator.AddEnvVarDecorator;\n+import io.dekorate.kubernetes.decorator.AddLivenessProbeDecorator;\n+import io.dekorate.kubernetes.decorator.AddMountDecorator;\n+import io.dekorate.kubernetes.decorator.AddReadinessProbeDecorator;\n+import io.dekorate.kubernetes.decorator.ApplyImagePullPolicyDecorator;\n+import io.dekorate.utils.Images;\n+import io.dekorate.utils.Strings;\n+\n+/**\n+ * Copied from dekorate in order to fix some issues\n+ */\n+public class ContainerAdapter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3NjYxMg==", "bodyText": "We will have to apply that upstream as well", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446976612", "createdAt": "2020-06-29T13:36:34Z", "author": {"login": "iocanel"}, "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/ContainerAdapter.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.Container;\n+import io.dekorate.deps.kubernetes.api.model.ContainerBuilder;\n+import io.dekorate.kubernetes.config.Env;\n+import io.dekorate.kubernetes.config.Mount;\n+import io.dekorate.kubernetes.config.Port;\n+import io.dekorate.kubernetes.decorator.AddEnvVarDecorator;\n+import io.dekorate.kubernetes.decorator.AddLivenessProbeDecorator;\n+import io.dekorate.kubernetes.decorator.AddMountDecorator;\n+import io.dekorate.kubernetes.decorator.AddReadinessProbeDecorator;\n+import io.dekorate.kubernetes.decorator.ApplyImagePullPolicyDecorator;\n+import io.dekorate.utils.Images;\n+import io.dekorate.utils.Strings;\n+\n+/**\n+ * Copied from dekorate in order to fix some issues\n+ */\n+public class ContainerAdapter {\n+\n+    public static Container adapt(io.dekorate.kubernetes.config.Container container) {\n+        String name = container.getName();\n+        if (Strings.isNullOrEmpty(name)) {\n+            name = Images.getName(container.getImage());\n+        }\n+\n+        ContainerBuilder builder = new ContainerBuilder()\n+                .withName(name)\n+                .withImage(container.getImage())\n+                // this was changed to add working dir", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk3Nzk3OQ==", "bodyText": "What happens if the container you add has a port named after the port you are trying to add?", "url": "https://github.com/quarkusio/quarkus/pull/10333#discussion_r446977979", "createdAt": "2020-06-29T13:38:34Z", "author": {"login": "iocanel"}, "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/AddContainerPortDecorator.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.kubernetes.deployment;\n+\n+import io.dekorate.deps.kubernetes.api.model.ContainerBuilder;\n+import io.dekorate.kubernetes.annotation.Protocol;\n+import io.dekorate.kubernetes.config.Port;\n+import io.dekorate.kubernetes.decorator.AddSidecarDecorator;\n+import io.dekorate.kubernetes.decorator.ContainerDecorator;\n+import io.dekorate.kubernetes.decorator.Decorator;\n+import io.dekorate.kubernetes.decorator.ResourceProvidingDecorator;\n+\n+/**\n+ * Adapted from Dekorate's {@link io.dekorate.kubernetes.decorator.AddPortDecorator} in order to\n+ * address the limitation that the port was not being added (due to missing metadata)\n+ */\n+class AddContainerPortDecorator extends Decorator<ContainerBuilder> {\n+\n+    private final Port port;\n+\n+    AddContainerPortDecorator(Port port) {\n+        this.port = port;\n+    }\n+\n+    @Override\n+    public void visit(ContainerBuilder containerBuilder) {\n+        containerBuilder.addNewPort()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MTU5NDQx", "url": "https://github.com/quarkusio/quarkus/pull/10333#pullrequestreview-439159441", "createdAt": "2020-06-29T13:46:29Z", "commit": {"oid": "6ac62dd29f5aec0d9cd9b4c82dadbd67f49c4dad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4181, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}