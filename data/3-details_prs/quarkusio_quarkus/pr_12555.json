{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NzA1NzY1", "number": 12555, "title": "Create default OIDC TokenStateManager", "bodyText": "Fixes #12254\nThis PR is a new attempt to resolve #12254, following the discussion at the closed #12290.\nSo, what it does it:\n\n\nintroduces SessionManager interface\n\n\nAll the existing code dealing with the session cookie is moved to DefaultSessionManager\n\n\nAdded an option for DefaultSessionManager to keep an id token only: if the users don't need access or refresh tokens then the session cookie length is reduced by /3. I've been thinking if it can be deduced (for ex we already have a refresh-expired property) but came to a conclusion that it will be too messy - for example, even if we check all the injection points for AT and RT, we still won't be able to detect SecurityIdentity.getCredential(AccessTokenCredential) etc. So the users can just set the keep-id-token-only.\n\n\nHowever, there will always be cases where all 3 tokens are needed, so if a combined cookie value becomes too large then DefaultSessionManager can be configured to create a cookie per token, id-token is still bound to the q_session token (the #12290 idea).\n\n\ntests are added (custom session manager, DefaultSessionManager keeping the id token only and creating 3 cookies)\n\n\nI'll follow up with creating an enhancement request to create a DB-based SessionManager - and in total we'll have a very comprehensive support for the OIDC adapter session state management", "createdAt": "2020-10-06T17:12:15Z", "url": "https://github.com/quarkusio/quarkus/pull/12555", "merged": true, "mergeCommit": {"oid": "2202210f7e8aa640952ab7f728b2139f081046c1"}, "closed": true, "closedAt": "2020-10-13T20:09:52Z", "author": {"login": "sberyozkin"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP7zh9gBqjM4NDY3MTE5NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSKuoBgFqTUwNzU5MzQ0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29bfcf5ff2f6fd023b67a17edce09d9c2f585365", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/29bfcf5ff2f6fd023b67a17edce09d9c2f585365", "committedDate": "2020-10-06T16:51:43Z", "message": "Create default OIDC SessionManager"}, "afterCommit": {"oid": "551be881f58e2f19e21dd0924d36b49408207bc9", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/551be881f58e2f19e21dd0924d36b49408207bc9", "committedDate": "2020-10-06T17:26:33Z", "message": "Create default OIDC SessionManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "551be881f58e2f19e21dd0924d36b49408207bc9", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/551be881f58e2f19e21dd0924d36b49408207bc9", "committedDate": "2020-10-06T17:26:33Z", "message": "Create default OIDC SessionManager"}, "afterCommit": {"oid": "2e615675089e7896ef105272792f47f249e37b90", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/2e615675089e7896ef105272792f47f249e37b90", "committedDate": "2020-10-06T17:30:23Z", "message": "Create default OIDC SessionManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e615675089e7896ef105272792f47f249e37b90", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/2e615675089e7896ef105272792f47f249e37b90", "committedDate": "2020-10-06T17:30:23Z", "message": "Create default OIDC SessionManager"}, "afterCommit": {"oid": "0dde0c06be643a481f048d9b712c76b207784749", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/0dde0c06be643a481f048d9b712c76b207784749", "committedDate": "2020-10-06T17:32:37Z", "message": "Create default OIDC SessionManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0dde0c06be643a481f048d9b712c76b207784749", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/0dde0c06be643a481f048d9b712c76b207784749", "committedDate": "2020-10-06T17:32:37Z", "message": "Create default OIDC SessionManager"}, "afterCommit": {"oid": "7336fbfbc73e3a0aa70fd6dc64a59c9f042125cd", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/7336fbfbc73e3a0aa70fd6dc64a59c9f042125cd", "committedDate": "2020-10-06T21:39:54Z", "message": "Create default OIDC SessionManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7336fbfbc73e3a0aa70fd6dc64a59c9f042125cd", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/7336fbfbc73e3a0aa70fd6dc64a59c9f042125cd", "committedDate": "2020-10-06T21:39:54Z", "message": "Create default OIDC SessionManager"}, "afterCommit": {"oid": "b6a1a74085de89a210c99e1ece2930e982c74c31", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/b6a1a74085de89a210c99e1ece2930e982c74c31", "committedDate": "2020-10-07T12:21:49Z", "message": "Create default OIDC SessionManager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjgyNjg2", "url": "https://github.com/quarkusio/quarkus/pull/12555#pullrequestreview-504682686", "createdAt": "2020-10-08T11:25:44Z", "commit": {"oid": "b6a1a74085de89a210c99e1ece2930e982c74c31"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMToyNTo0NFrOHeZ_Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMTozODowOVrOHeaZWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY0NTE0Ng==", "bodyText": "Maybe rename this to CookieManager ?", "url": "https://github.com/quarkusio/quarkus/pull/12555#discussion_r501645146", "createdAt": "2020-10-08T11:25:44Z", "author": {"login": "pedroigor"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/OidcTenantConfig.java", "diffHunk": "@@ -229,6 +235,45 @@ public void setPostLogoutPath(Optional<String> postLogoutPath) {\n         }\n     }\n \n+    /**\n+     * Default session manager configuration\n+     */\n+    @ConfigGroup\n+    public static class SessionManager {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6a1a74085de89a210c99e1ece2930e982c74c31"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY0ODU3OA==", "bodyText": "Maybe an enum such as CookieStrategy which SINGLE, SPLIT, IDTOKEN, ACCESSTOKEN, REFRESHTOKEN.\nWhere people could choose what type of token should be included in the token. For instance, ACCESSTOKEN might be useful if the application wants to relay the token to other services while still tracking session lifetime by either a local introspection or a call to the introspection endpoint.", "url": "https://github.com/quarkusio/quarkus/pull/12555#discussion_r501648578", "createdAt": "2020-10-08T11:31:58Z", "author": {"login": "pedroigor"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/OidcTenantConfig.java", "diffHunk": "@@ -229,6 +235,45 @@ public void setPostLogoutPath(Optional<String> postLogoutPath) {\n         }\n     }\n \n+    /**\n+     * Default session manager configuration\n+     */\n+    @ConfigGroup\n+    public static class SessionManager {\n+\n+        /**\n+         * Default SessionManager will only keep ID token out of three tokens (ID, access and refresh)\n+         * returned in the authorization code grant response if this property is enabled.\n+         */\n+        @ConfigItem(defaultValue = \"false\")\n+        public boolean keepIdTokenOnly;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6a1a74085de89a210c99e1ece2930e982c74c31"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY0OTMxNQ==", "bodyText": "Perhaps SessionState ?", "url": "https://github.com/quarkusio/quarkus/pull/12555#discussion_r501649315", "createdAt": "2020-10-08T11:33:18Z", "author": {"login": "pedroigor"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/SessionContent.java", "diffHunk": "@@ -0,0 +1,44 @@\n+package io.quarkus.oidc;\n+\n+/**\n+ * Authorization Code Flow Session content\n+ */\n+public class SessionContent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6a1a74085de89a210c99e1ece2930e982c74c31"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY1MTgwMg==", "bodyText": "Perhaps SessionManager should be solely responsible for managing cookies and this method just returns void. My point is that we remove any session cookie related code from the mechanism and move here.\nI would then just rename these methods to create, get and delete.", "url": "https://github.com/quarkusio/quarkus/pull/12555#discussion_r501651802", "createdAt": "2020-10-08T11:38:09Z", "author": {"login": "pedroigor"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/SessionManager.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package io.quarkus.oidc;\n+\n+import io.vertx.ext.web.RoutingContext;\n+\n+/**\n+ * Authorization Code Flow Session Manager\n+ */\n+public interface SessionManager {\n+\n+    String createSessionState(RoutingContext routingContext, OidcTenantConfig oidcConfig, SessionContent sessionContent);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6a1a74085de89a210c99e1ece2930e982c74c31"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6a1a74085de89a210c99e1ece2930e982c74c31", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/b6a1a74085de89a210c99e1ece2930e982c74c31", "committedDate": "2020-10-07T12:21:49Z", "message": "Create default OIDC SessionManager"}, "afterCommit": {"oid": "b4bf3ed874012acb2464f3cdc7b860701a3f2ce4", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/b4bf3ed874012acb2464f3cdc7b860701a3f2ce4", "committedDate": "2020-10-12T10:56:32Z", "message": "Create default OIDC TokenStateManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "187f0f6b9b7f8415b48ca0f418360e475df66ca1", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/187f0f6b9b7f8415b48ca0f418360e475df66ca1", "committedDate": "2020-10-13T09:36:59Z", "message": "Create default OIDC TokenStateManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4bf3ed874012acb2464f3cdc7b860701a3f2ce4", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/b4bf3ed874012acb2464f3cdc7b860701a3f2ce4", "committedDate": "2020-10-12T10:56:32Z", "message": "Create default OIDC TokenStateManager"}, "afterCommit": {"oid": "187f0f6b9b7f8415b48ca0f418360e475df66ca1", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/187f0f6b9b7f8415b48ca0f418360e475df66ca1", "committedDate": "2020-10-13T09:36:59Z", "message": "Create default OIDC TokenStateManager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NTkzNDQ4", "url": "https://github.com/quarkusio/quarkus/pull/12555#pullrequestreview-507593448", "createdAt": "2020-10-13T15:57:51Z", "commit": {"oid": "187f0f6b9b7f8415b48ca0f418360e475df66ca1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1875, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}