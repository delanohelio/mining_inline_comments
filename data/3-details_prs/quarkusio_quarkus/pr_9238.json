{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NzI2OTI0", "number": 9238, "title": "Fix #9036: support filters on queries", "bodyText": "", "createdAt": "2020-05-12T13:30:13Z", "url": "https://github.com/quarkusio/quarkus/pull/9238", "merged": true, "mergeCommit": {"oid": "eb63c71de3ffe849c9c49d113f1c0dac4d650511"}, "closed": true, "closedAt": "2020-05-15T12:48:16Z", "author": {"login": "FroMage"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgnyl6gFqTQxMDI2NDIyOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg68LagBqjMzMzI3NDgxNzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjY0MjI5", "url": "https://github.com/quarkusio/quarkus/pull/9238#pullrequestreview-410264229", "createdAt": "2020-05-12T17:26:12Z", "commit": {"oid": "644133ce34c1e95d56a01e6f245def2dc9153ce6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzoyNjoxM1rOGURPwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzozMTo1MFrOGURdhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzI2NA==", "bodyText": "Maybe use withFilter as we already have withHint and withLock ?", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r423907264", "createdAt": "2020-05-12T17:26:13Z", "author": {"login": "loicmathieu"}, "path": "extensions/panache/hibernate-orm-panache-common/runtime/src/main/java/io/quarkus/hibernate/orm/panache/common/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -93,6 +109,12 @@ private CommonPanacheQueryImpl(CommonPanacheQueryImpl<?> previousQuery, String n\n         return new CommonPanacheQueryImpl<>(this, select.toString() + query, \"select count(*) \" + query);\n     }\n \n+    public void filter(String filterName, Map<String, Object> parameters) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "644133ce34c1e95d56a01e6f245def2dc9153ce6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwNzc5OA==", "bodyText": "We didn't lazily instantiate the hint Map.\nIf you think it worth it, can you refactor the hint Map to be lazily instantiated for coherence sake ?", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r423907798", "createdAt": "2020-05-12T17:27:09Z", "author": {"login": "loicmathieu"}, "path": "extensions/panache/hibernate-orm-panache-common/runtime/src/main/java/io/quarkus/hibernate/orm/panache/common/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -93,6 +109,12 @@ private CommonPanacheQueryImpl(CommonPanacheQueryImpl<?> previousQuery, String n\n         return new CommonPanacheQueryImpl<>(this, select.toString() + query, \"select count(*) \" + query);\n     }\n \n+    public void filter(String filterName, Map<String, Object> parameters) {\n+        if (filters == null)\n+            filters = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "644133ce34c1e95d56a01e6f245def2dc9153ce6"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkwOTYxMg==", "bodyText": "We usually describe the return type as this query, modified", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r423909612", "createdAt": "2020-05-12T17:29:57Z", "author": {"login": "loicmathieu"}, "path": "extensions/panache/hibernate-orm-panache-kotlin/runtime/src/main/kotlin/io/quarkus/hibernate/orm/panache/kotlin/PanacheQuery.kt", "diffHunk": "@@ -148,6 +152,53 @@ interface PanacheQuery<Entity: Any> {\n      */\n     fun withHint(hintName: String, value: Any): PanacheQuery<Entity>\n \n+    /**\n+     * <p>\n+     * Enables a Hibernate filter during fetching of results for this query. Your filter must be declared\n+     * with [FilterDef] on your entity or package, and enabled with [Filter] on your entity.\n+     * <p>\n+     * WARNING: setting filters can only be done on the underlying Hibernate [Session] and so this\n+     * will modify the session's filters for the duration of obtaining the results (not while building\n+     * the query). Enabled filters will be removed from the session afterwards, but no effort is made to\n+     * preserve filters enabled on the session outside of this API.\n+     * \n+     * @param filterName The name of the filter to enable\n+     * @param parameters The set of parameters for the filter, if the filter requires parameters\n+     * @return this query", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "644133ce34c1e95d56a01e6f245def2dc9153ce6"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxMDc4OA==", "bodyText": "This is not a bug but a feature ;)\nMaybe testIssue9036 or testFilter ?", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r423910788", "createdAt": "2020-05-12T17:31:50Z", "author": {"login": "loicmathieu"}, "path": "integration-tests/hibernate-orm-panache-kotlin/src/main/kotlin/io/quarkus/it/panache/kotlin/TestEndpoint.kt", "diffHunk": "@@ -1018,4 +1018,45 @@ class TestEndpoint {\n         Assertions.assertNull(f.getAnnotation(XmlAttribute::class.java))\n         Assertions.assertNotNull(f.getAnnotation(XmlTransient::class.java))\n     }\n+\n+\n+    @GET\n+    @Path(\"9036\")\n+    @Transactional\n+    fun testBug9036(): String {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "644133ce34c1e95d56a01e6f245def2dc9153ce6"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "644133ce34c1e95d56a01e6f245def2dc9153ce6", "author": {"user": {"login": "FroMage", "name": "St\u00e9phane \u00c9pardaud"}}, "url": "https://github.com/quarkusio/quarkus/commit/644133ce34c1e95d56a01e6f245def2dc9153ce6", "committedDate": "2020-05-12T13:28:50Z", "message": "Fix #9036: support filters on queries"}, "afterCommit": {"oid": "e4e7a6e4ec697a696970bb6d6278355e6584f10e", "author": {"user": {"login": "FroMage", "name": "St\u00e9phane \u00c9pardaud"}}, "url": "https://github.com/quarkusio/quarkus/commit/e4e7a6e4ec697a696970bb6d6278355e6584f10e", "committedDate": "2020-05-13T08:21:33Z", "message": "Fix #9036: support filters on queries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNjk3OTA1", "url": "https://github.com/quarkusio/quarkus/pull/9238#pullrequestreview-410697905", "createdAt": "2020-05-13T08:24:42Z", "commit": {"oid": "e4e7a6e4ec697a696970bb6d6278355e6584f10e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4e7a6e4ec697a696970bb6d6278355e6584f10e", "author": {"user": {"login": "FroMage", "name": "St\u00e9phane \u00c9pardaud"}}, "url": "https://github.com/quarkusio/quarkus/commit/e4e7a6e4ec697a696970bb6d6278355e6584f10e", "committedDate": "2020-05-13T08:21:33Z", "message": "Fix #9036: support filters on queries"}, "afterCommit": {"oid": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f", "author": {"user": {"login": "FroMage", "name": "St\u00e9phane \u00c9pardaud"}}, "url": "https://github.com/quarkusio/quarkus/commit/9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f", "committedDate": "2020-05-13T09:07:37Z", "message": "Fix #9036: support filters on queries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDU4MzQ4", "url": "https://github.com/quarkusio/quarkus/pull/9238#pullrequestreview-411058348", "createdAt": "2020-05-13T15:44:13Z", "commit": {"oid": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNTo0NDoxM1rOGU37Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNTo0OTo0OFrOGU4LQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0MDk1MA==", "bodyText": "Can we make this a default? Would some typing later on :)", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424540950", "createdAt": "2020-05-13T15:44:13Z", "author": {"login": "geoand"}, "path": "extensions/panache/hibernate-orm-panache-common/runtime/src/main/java/io/quarkus/hibernate/orm/panache/common/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -26,6 +29,17 @@\n     private static final Pattern SELECT_PATTERN = Pattern.compile(\"^\\\\s*SELECT\\\\s+((?:DISTINCT\\\\s+)?[^\\\\s]+)\\\\s+([^\\\\s]+.*)$\",\n             Pattern.CASE_INSENSITIVE);\n \n+    private interface NonThrowingCloseable extends AutoCloseable {\n+        @Override\n+        void close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NDU2OQ==", "bodyText": "Damn Kotlin and your when keyword...", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424544569", "createdAt": "2020-05-13T15:49:04Z", "author": {"login": "geoand"}, "path": "integration-tests/hibernate-orm-panache-kotlin/src/test/kotlin/io/quarkus/it/panache/KotlinPanacheFunctionalityTest.kt", "diffHunk": "@@ -71,4 +71,8 @@ open class KotlinPanacheFunctionalityTest {\n                 personAsString)\n     }\n \n+    @Test\n+    fun testBug9036() {\n+        RestAssured.`when`()[\"/test/9036\"].then().body(Matchers.`is`(\"OK\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU0NTA4OQ==", "bodyText": "You need to be careful man... \ud83d\ude06", "url": "https://github.com/quarkusio/quarkus/pull/9238#discussion_r424545089", "createdAt": "2020-05-13T15:49:48Z", "author": {"login": "geoand"}, "path": "integration-tests/hibernate-orm-panache/src/main/java/io/quarkus/it/panache/TestEndpoint.java", "diffHunk": "@@ -1299,4 +1299,45 @@ public String testBug8254() {\n \n         return \"OK\";\n     }\n+\n+    @GET\n+    @Path(\"9036\")\n+    @Transactional\n+    public String testBug9036() {\n+        Person.deleteAll();\n+\n+        Person emptyPerson = new Person();\n+        emptyPerson.persist();\n+\n+        Person deadPerson = new Person();\n+        deadPerson.name = \"Stef\";\n+        deadPerson.status = Status.DECEASED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f154d4eea2eae8fd12d9837b337be807da6df437", "author": {"user": {"login": "FroMage", "name": "St\u00e9phane \u00c9pardaud"}}, "url": "https://github.com/quarkusio/quarkus/commit/f154d4eea2eae8fd12d9837b337be807da6df437", "committedDate": "2020-05-13T15:51:44Z", "message": "Fix #9036: support filters on queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f", "author": {"user": {"login": "FroMage", "name": "St\u00e9phane \u00c9pardaud"}}, "url": "https://github.com/quarkusio/quarkus/commit/9d0ef62eccb526dc9d5dfb5367f092bbd75eb91f", "committedDate": "2020-05-13T09:07:37Z", "message": "Fix #9036: support filters on queries"}, "afterCommit": {"oid": "f154d4eea2eae8fd12d9837b337be807da6df437", "author": {"user": {"login": "FroMage", "name": "St\u00e9phane \u00c9pardaud"}}, "url": "https://github.com/quarkusio/quarkus/commit/f154d4eea2eae8fd12d9837b337be807da6df437", "committedDate": "2020-05-13T15:51:44Z", "message": "Fix #9036: support filters on queries"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3417, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}