{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5NDM5OTUz", "number": 12916, "title": "Update pom files if create mojo is called inside a parent project", "bodyText": "I implemented this inside CreateProjectMojo. Is this enough or should I take the long road and implement it through the CreateProject class (which requires modifiying ftl templates found in /devtools/platform-descriptor-json)?\nFixes: #12829\nSigned-off-by: ghokun gokhun@gmail.com", "createdAt": "2020-10-24T14:29:04Z", "url": "https://github.com/quarkusio/quarkus/pull/12916", "merged": true, "mergeCommit": {"oid": "3f9f139d5fc4867e055a31352503be7d919d2c68"}, "closed": true, "closedAt": "2020-11-03T10:06:51Z", "author": {"login": "ghokun"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWPIYbAFqTUxNjUxMzYxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXnY-MAFqTUyMDcwNTQ5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NTEzNjEx", "url": "https://github.com/quarkusio/quarkus/pull/12916#pullrequestreview-516513611", "createdAt": "2020-10-26T07:21:17Z", "commit": {"oid": "c92ac9cf1d76b1cd1466a3476db8cc140857d425"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzoyMToxN1rOHoDKkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzoyMToxN1rOHoDKkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Njk0NA==", "bodyText": "We could also achieve that part directly in the maven codestart.. @aloubyansky what do you reckon?", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511756944", "createdAt": "2020-10-26T07:21:17Z", "author": {"login": "ia3andy"}, "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateProjectMojo.java", "diffHunk": "@@ -202,7 +218,18 @@ public void execute() throws MojoExecutionException {\n             }\n \n             success = createProject.execute().isSuccess();\n-\n+            if (success && parentPomModel != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c92ac9cf1d76b1cd1466a3476db8cc140857d425"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NTI2OTA5", "url": "https://github.com/quarkusio/quarkus/pull/12916#pullrequestreview-516526909", "createdAt": "2020-10-26T07:47:16Z", "commit": {"oid": "c92ac9cf1d76b1cd1466a3476db8cc140857d425"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzo0NzoxNlrOHoDyjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNzo0Nzo1NlrOHoDzlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2NzE4Mw==", "bodyText": "Probably, yes. This could be accepted until the codestarts provide this feature.", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511767183", "createdAt": "2020-10-26T07:47:16Z", "author": {"login": "aloubyansky"}, "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateProjectMojo.java", "diffHunk": "@@ -202,7 +218,18 @@ public void execute() throws MojoExecutionException {\n             }\n \n             success = createProject.execute().isSuccess();\n-\n+            if (success && parentPomModel != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Njk0NA=="}, "originalCommit": {"oid": "c92ac9cf1d76b1cd1466a3476db8cc140857d425"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc2NzQ0Nw==", "bodyText": "The parent pom should not be update unless the project generation succeeds.", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511767447", "createdAt": "2020-10-26T07:47:56Z", "author": {"login": "aloubyansky"}, "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateProjectMojo.java", "diffHunk": "@@ -162,16 +165,29 @@ public void execute() throws MojoExecutionException {\n         }\n         File projectRoot = outputDirectory;\n         File pom = new File(projectRoot, \"pom.xml\");\n+        Model parentPomModel = null;\n \n         if (pom.isFile()) {\n-            throw new MojoExecutionException(\"Unable to generate the project in a directory that already contains a pom.xml\");\n+            try {\n+                parentPomModel = MojoUtils.readPom(pom);\n+                if (!\"pom\".equals(parentPomModel.getPackaging())) {\n+                    throw new MojoExecutionException(\"The parent project must have a packaging type of POM. Current packaging: \"\n+                            + parentPomModel.getPackaging());\n+                }\n+                askTheUserForMissingValues();\n+                if (!parentPomModel.getModules().contains(this.projectArtifactId)) {\n+                    parentPomModel.addModule(this.projectArtifactId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c92ac9cf1d76b1cd1466a3476db8cc140857d425"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NzUwNTM4", "url": "https://github.com/quarkusio/quarkus/pull/12916#pullrequestreview-516750538", "createdAt": "2020-10-26T13:00:44Z", "commit": {"oid": "a4969efbf9eea9ba420209e8238e5aec209702ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzowMDo0NFrOHoOX8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzowMDo0NFrOHoOX8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0MDU5Mg==", "bodyText": "This import isn't really required, correct? The generated module will import whatever it does today. This kind of integration with the parent is the tricky part.", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511940592", "createdAt": "2020-10-26T13:00:44Z", "author": {"login": "aloubyansky"}, "path": "integration-tests/maven/src/test/resources/projects/parent-pom-it/pom.xml", "diffHunk": "@@ -0,0 +1,26 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\" xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n+  <modelVersion>4.0.0</modelVersion>\n+  <groupId>io.acme.it</groupId>\n+  <artifactId>acme-parent-pom</artifactId>\n+  <version>0.0.1.BUILD-SNAPSHOT</version>\n+  <packaging>pom</packaging>\n+  <properties>\n+    <quarkus.platform.group-id>io.quarkus</quarkus.platform.group-id>\n+    <quarkus.platform.artifact-id>quarkus-bom</quarkus.platform.artifact-id>\n+    <quarkus.platform.version>@project.version@</quarkus.platform.version>\n+  </properties>\n+  <dependencyManagement>\n+    <dependencies>\n+      <!-- insert managed dependencies here -->\n+      <dependency>\n+        <groupId>${quarkus.platform.group-id}</groupId>\n+        <artifactId>${quarkus.platform.artifact-id}</artifactId>\n+        <version>${quarkus.platform.version}</version>\n+        <type>pom</type>\n+        <scope>import</scope>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4969efbf9eea9ba420209e8238e5aec209702ed"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NzYzMjU2", "url": "https://github.com/quarkusio/quarkus/pull/12916#pullrequestreview-516763256", "createdAt": "2020-10-26T13:16:03Z", "commit": {"oid": "a4969efbf9eea9ba420209e8238e5aec209702ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzoxNjowNFrOHoO8Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzoxNjowNFrOHoO8Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0OTg0Mw==", "bodyText": "Why are we changing the behavior for non pom project?", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r511949843", "createdAt": "2020-10-26T13:16:04Z", "author": {"login": "ia3andy"}, "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateProjectMojo.java", "diffHunk": "@@ -162,16 +165,26 @@ public void execute() throws MojoExecutionException {\n         }\n         File projectRoot = outputDirectory;\n         File pom = new File(projectRoot, \"pom.xml\");\n+        Model parentPomModel = null;\n \n         if (pom.isFile()) {\n-            throw new MojoExecutionException(\"Unable to generate the project in a directory that already contains a pom.xml\");\n+            try {\n+                parentPomModel = MojoUtils.readPom(pom);\n+                if (!\"pom\".equals(parentPomModel.getPackaging())) {\n+                    throw new MojoExecutionException(\"The parent project must have a packaging type of POM. Current packaging: \"\n+                            + parentPomModel.getPackaging());\n+                }\n+                askTheUserForMissingValues();\n+            } catch (IOException e) {\n+                throw new MojoExecutionException(\"Could not access parent pom.\", e);\n+            }\n         } else {\n             askTheUserForMissingValues();\n-            projectRoot = new File(outputDirectory, projectArtifactId);\n-            if (projectRoot.exists()) {\n-                throw new MojoExecutionException(\"Unable to create the project, \" +\n-                        \"the directory \" + projectRoot.getAbsolutePath() + \" already exists\");\n-            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4969efbf9eea9ba420209e8238e5aec209702ed"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTQ4OTY5", "url": "https://github.com/quarkusio/quarkus/pull/12916#pullrequestreview-518548969", "createdAt": "2020-10-28T11:09:01Z", "commit": {"oid": "4e5f51c519e4e6a45e81ebab0ccacda7d9362328"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMTowOTowMVrOHpk6YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMTowOTowMVrOHpk6YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM1ODQzMw==", "bodyText": "Here is one thing I noticed which is not necessarily related to your changes but may help anyway.\nChecking whether we are in the context of an existing Maven project could be done with project.getFile() != null, if it's true, the Maven project exists. And that would be the pom above. Which will also support -f custom.xml use-case. Would you like to re-write it using that?\nAnother class that may be helpful is io.quarkus.bootstrap.utils.BuildToolHelper it includes isGradleProject(Path project) method, although it goes all the way up in the FS tree, so, perhaps not the best choice here.\nOtherwise, it looks good to me. Thanks!", "url": "https://github.com/quarkusio/quarkus/pull/12916#discussion_r513358433", "createdAt": "2020-10-28T11:09:01Z", "author": {"login": "aloubyansky"}, "path": "devtools/maven/src/main/java/io/quarkus/maven/CreateProjectMojo.java", "diffHunk": "@@ -160,18 +163,52 @@ public void execute() throws MojoExecutionException {\n         } catch (IOException e) {\n             throw new MojoExecutionException(\"Could not create directory \" + outputDirectory, e);\n         }\n+\n         File projectRoot = outputDirectory;\n         File pom = new File(projectRoot, \"pom.xml\");\n+        Model parentPomModel = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e5f51c519e4e6a45e81ebab0ccacda7d9362328"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a036e4da239c5078b62a611c53eea874697f9b3", "author": {"user": {"login": "ghokun", "name": "G\u00f6khun"}}, "url": "https://github.com/quarkusio/quarkus/commit/5a036e4da239c5078b62a611c53eea874697f9b3", "committedDate": "2020-10-30T13:38:28Z", "message": "Update pom files of parent and child if create mojo is called inside a parent project. Fixes: #12829\n\nSigned-off-by: ghokun <gokhun@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzA1NDk5", "url": "https://github.com/quarkusio/quarkus/pull/12916#pullrequestreview-520705499", "createdAt": "2020-10-30T14:11:04Z", "commit": {"oid": "5a036e4da239c5078b62a611c53eea874697f9b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1720, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}