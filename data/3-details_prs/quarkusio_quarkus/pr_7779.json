{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NzkxMjEx", "number": 7779, "title": "Support for repeating qualifiers in ArC plus automated tests", "bodyText": "Fixes #7732", "createdAt": "2020-03-11T16:22:30Z", "url": "https://github.com/quarkusio/quarkus/pull/7779", "merged": true, "mergeCommit": {"oid": "c0fdd2d6d21e2efb346239a309c4f20505f905e0"}, "closed": true, "closedAt": "2020-03-17T09:33:59Z", "author": {"login": "manovotn"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM4UVWAFqTM3MzM4MzczMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcONVSDAFqTM3NTE3MTYwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMzgzNzMx", "url": "https://github.com/quarkusio/quarkus/pull/7779#pullrequestreview-373383731", "createdAt": "2020-03-12T09:14:14Z", "commit": {"oid": "ceb75decbb2adee02ca41db5674e1b433e77ea49"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOToxNDoxNFrOF1WbZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwOToyMjo0M1rOF1WsNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ4NjMxMQ==", "bodyText": "I don't think we need to run this for every annotation. I'd place this if  block outside the loop.", "url": "https://github.com/quarkusio/quarkus/pull/7779#discussion_r391486311", "createdAt": "2020-03-12T09:14:14Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/Beans.java", "diffHunk": "@@ -51,11 +51,12 @@ static BeanInfo createClassBean(ClassInfo beanClass, BeanDeployment beanDeployme\n         String name = null;\n \n         for (AnnotationInstance annotation : beanDeployment.getAnnotations(beanClass)) {\n-            if (beanDeployment.getQualifier(annotation.name()) != null) {\n+            for (AnnotationInstance qualifierAnnotation : beanDeployment.getQualifierExtractor(annotation.name())\n+                    .apply(annotation)) {\n                 // Qualifiers\n-                qualifiers.add(annotation);\n-                if (DotNames.NAMED.equals(annotation.name())) {\n-                    AnnotationValue nameValue = annotation.value();\n+                qualifiers.add(qualifierAnnotation);\n+                if (DotNames.NAMED.equals(qualifierAnnotation.name())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb75decbb2adee02ca41db5674e1b433e77ea49"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ5MDYxNQ==", "bodyText": "Hm, maybe we could simplify the code a little bit. Function<> getQualifierExtractor(annotation.name()) -> Collection<AnnotationInstance> getQualifiers(annotation) and the loop could be replaced with beanDeployment.getQualifiers(annotation).forEach(qualifiers::add);. WDYT?", "url": "https://github.com/quarkusio/quarkus/pull/7779#discussion_r391490615", "createdAt": "2020-03-12T09:22:43Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/Beans.java", "diffHunk": "@@ -51,11 +51,12 @@ static BeanInfo createClassBean(ClassInfo beanClass, BeanDeployment beanDeployme\n         String name = null;\n \n         for (AnnotationInstance annotation : beanDeployment.getAnnotations(beanClass)) {\n-            if (beanDeployment.getQualifier(annotation.name()) != null) {\n+            for (AnnotationInstance qualifierAnnotation : beanDeployment.getQualifierExtractor(annotation.name())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb75decbb2adee02ca41db5674e1b433e77ea49"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ceb75decbb2adee02ca41db5674e1b433e77ea49", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/ceb75decbb2adee02ca41db5674e1b433e77ea49", "committedDate": "2020-03-11T16:21:29Z", "message": "Support for repeating qualifiers in ArC plus automated tests."}, "afterCommit": {"oid": "f0767cca53966ea6203445b3a438c753faca6e0e", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/f0767cca53966ea6203445b3a438c753faca6e0e", "committedDate": "2020-03-12T13:03:24Z", "message": "Support for repeating qualifiers in ArC plus automated tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0OTk4MDEz", "url": "https://github.com/quarkusio/quarkus/pull/7779#pullrequestreview-374998013", "createdAt": "2020-03-16T08:29:58Z", "commit": {"oid": "f0767cca53966ea6203445b3a438c753faca6e0e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwODoyOTo1OFrOF2pyaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwODozMTo0M1rOF2p1vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1MjA3NQ==", "bodyText": "Looking at the usage I wonder if it makes sense to return a function. Collection<AnnotationInstance> getQualifiers(AnnotationInstance annotation) would be sufficient and more convenient in most cases. Alternatively, we could add a convenient method like this:\nCollection<AnnotationInstance> getQualifiers(AnnotationInstance annotation) {\n    return getQualifierExtractor(annotation.name()).apply(annotation);\n}", "url": "https://github.com/quarkusio/quarkus/pull/7779#discussion_r392852075", "createdAt": "2020-03-16T08:29:58Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanDeployment.java", "diffHunk": "@@ -363,6 +372,20 @@ ClassInfo getQualifier(DotName name) {\n         return qualifiers.get(name);\n     }\n \n+    Function<AnnotationInstance, Collection<AnnotationInstance>> getQualifierExtractor(DotName name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0767cca53966ea6203445b3a438c753faca6e0e"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1MjIwNg==", "bodyText": "These could be final... but it's just a minor.", "url": "https://github.com/quarkusio/quarkus/pull/7779#discussion_r392852206", "createdAt": "2020-03-16T08:30:16Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanDeployment.java", "diffHunk": "@@ -95,6 +97,12 @@\n     private final boolean removeFinalForProxyableMethods;\n     private final boolean jtaCapabilities;\n \n+    private Function<AnnotationInstance, Collection<AnnotationInstance>> singletonFunction = annotationInstance -> Collections", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0767cca53966ea6203445b3a438c753faca6e0e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1MjkyNQ==", "bodyText": "resultingQualifiers::add?", "url": "https://github.com/quarkusio/quarkus/pull/7779#discussion_r392852925", "createdAt": "2020-03-16T08:31:43Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/DisposerInfo.java", "diffHunk": "@@ -71,9 +72,11 @@ void init(List<Throwable> errors) {\n     }\n \n     Collection<AnnotationInstance> getDisposedParameterQualifiers() {\n-        return Annotations.getParameterAnnotations(declaringBean.getDeployment(), disposerMethod, disposedParameter.position())\n-                .stream().filter(a -> declaringBean.getDeployment().getQualifier(a.name()) != null)\n-                .collect(Collectors.toList());\n+        Set<AnnotationInstance> resultingQualifiers = new HashSet<>();\n+        Annotations.getParameterAnnotations(declaringBean.getDeployment(), disposerMethod, disposedParameter.position())\n+                .stream().forEach(a -> declaringBean.getDeployment().getQualifierExtractor(a.name()).apply(a)\n+                        .forEach(an -> resultingQualifiers.add(an)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0767cca53966ea6203445b3a438c753faca6e0e"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0767cca53966ea6203445b3a438c753faca6e0e", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/f0767cca53966ea6203445b3a438c753faca6e0e", "committedDate": "2020-03-12T13:03:24Z", "message": "Support for repeating qualifiers in ArC plus automated tests."}, "afterCommit": {"oid": "7f7a03a22ddf2a06368aab4e55902b3f8f040245", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/7f7a03a22ddf2a06368aab4e55902b3f8f040245", "committedDate": "2020-03-16T11:53:46Z", "message": "Support for repeating qualifiers in ArC plus automated tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "341ec1eec0a8816b890db6392a8824b5b432cee7", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/341ec1eec0a8816b890db6392a8824b5b432cee7", "committedDate": "2020-03-16T12:30:05Z", "message": "Support for repeating qualifiers in ArC plus automated tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f7a03a22ddf2a06368aab4e55902b3f8f040245", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/7f7a03a22ddf2a06368aab4e55902b3f8f040245", "committedDate": "2020-03-16T11:53:46Z", "message": "Support for repeating qualifiers in ArC plus automated tests."}, "afterCommit": {"oid": "341ec1eec0a8816b890db6392a8824b5b432cee7", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/341ec1eec0a8816b890db6392a8824b5b432cee7", "committedDate": "2020-03-16T12:30:05Z", "message": "Support for repeating qualifiers in ArC plus automated tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTcxNjAz", "url": "https://github.com/quarkusio/quarkus/pull/7779#pullrequestreview-375171603", "createdAt": "2020-03-16T12:33:02Z", "commit": {"oid": "341ec1eec0a8816b890db6392a8824b5b432cee7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3827, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}