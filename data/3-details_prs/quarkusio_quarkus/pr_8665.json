{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MzQwNDk5", "number": 8665, "title": "Fix quarkus-quartz duplicating clustered jobs", "bodyText": "Fix #8661\nThe first commit should fix the issue. Upon my attempt to reproduce it I came to a conclusion that this only occurs if you re-build the application but once the application is built, the name (\"identity\") is maintained across several runs as the list of triggers (methods) has already been recorded - during deployment time.\n/cc @mkouba @gsmet opening as draft to get feedback\n/cc @brunobat & @joao-rafael-tdx this should address the issue.", "createdAt": "2020-04-17T21:06:28Z", "url": "https://github.com/quarkusio/quarkus/pull/8665", "merged": true, "mergeCommit": {"oid": "2ab139fe900283c9632e4b4052b790f0d3ef837b"}, "closed": true, "closedAt": "2020-04-21T07:06:18Z", "author": {"login": "machi1990"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYxC-qAFqTM5NTg5MTQ5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZuOz8AFqTM5NzA0MjgzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODkxNDkx", "url": "https://github.com/quarkusio/quarkus/pull/8665#pullrequestreview-395891491", "createdAt": "2020-04-18T07:48:52Z", "commit": {"oid": "1ecbc37152bbdc48f079f95c0f83da67a97fa347"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwNzo0ODo1MlrOGHo83Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwNzo0ODo1MlrOGHo83Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY2NDE1Nw==", "bodyText": "You can't remove the BuildProducer<BeanConfiguratorBuildItem> beans even though it's unused. This ensures this build step is executed before ArcProcessor#validate(). See the BeanRegistrationPhaseBuildItem javadoc.", "url": "https://github.com/quarkusio/quarkus/pull/8665#discussion_r410664157", "createdAt": "2020-04-18T07:48:52Z", "author": {"login": "mkouba"}, "path": "extensions/scheduler/deployment/src/main/java/io/quarkus/scheduler/deployment/SchedulerProcessor.java", "diffHunk": "@@ -117,27 +115,21 @@ public void transform(TransformationContext context) {\n     }\n \n     @BuildStep\n-    void collectScheduledMethods(\n-            SchedulerConfig config,\n-            BeanArchiveIndexBuildItem beanArchives,\n-            BeanRegistrationPhaseBuildItem beanRegistrationPhase,\n-            BuildProducer<ScheduledBusinessMethodItem> scheduledBusinessMethods,\n-            BuildProducer<BeanConfiguratorBuildItem> beans) {\n+    void collectScheduledMethods(BeanArchiveIndexBuildItem beanArchives, BeanRegistrationPhaseBuildItem beanRegistrationPhase,\n+            BuildProducer<ScheduledBusinessMethodItem> scheduledBusinessMethods) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ecbc37152bbdc48f079f95c0f83da67a97fa347"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODkxNjI5", "url": "https://github.com/quarkusio/quarkus/pull/8665#pullrequestreview-395891629", "createdAt": "2020-04-18T07:51:13Z", "commit": {"oid": "1ecbc37152bbdc48f079f95c0f83da67a97fa347"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwNzo1MToxNFrOGHo9qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOFQwNzo1MToxNFrOGHo9qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDY2NDM2MQ==", "bodyText": "We should also use Scheduled.identity() in the SimpleScheduler.", "url": "https://github.com/quarkusio/quarkus/pull/8665#discussion_r410664361", "createdAt": "2020-04-18T07:51:14Z", "author": {"login": "mkouba"}, "path": "extensions/scheduler/runtime/src/main/java/io/quarkus/scheduler/Scheduled.java", "diffHunk": "@@ -39,6 +39,16 @@\n @Repeatable(Schedules.class)\n public @interface Scheduled {\n \n+    /**\n+     * Optionally defines a unique identifier for this job.\n+     * <p>\n+     * If the value is not given, Quarkus will generate a unique id.\n+     * <p>\n+     * \n+     * @return the unique identity of the schedule\n+     */\n+    String identity() default \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ecbc37152bbdc48f079f95c0f83da67a97fa347"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ecbc37152bbdc48f079f95c0f83da67a97fa347", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/1ecbc37152bbdc48f079f95c0f83da67a97fa347", "committedDate": "2020-04-17T20:52:10Z", "message": "feat(quartz): add a possibility to define Job identity via the Scheduled annotation"}, "afterCommit": {"oid": "556b32f0c20a4e0c28e3e3465e88c099e76b41b7", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/556b32f0c20a4e0c28e3e3465e88c099e76b41b7", "committedDate": "2020-04-18T10:28:00Z", "message": "feat(scheduler): add a possibility to define Job identity via the Scheduled annotation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef1be6885924403f7ca1076084f748569b31caba", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/ef1be6885924403f7ca1076084f748569b31caba", "committedDate": "2020-04-18T12:20:20Z", "message": "feat(scheduler): add a possibility to define Job identity via the Scheduled annotation"}, "afterCommit": {"oid": "1670e592403e8fe41f0a5eef1260b30b63286ec4", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/1670e592403e8fe41f0a5eef1260b30b63286ec4", "committedDate": "2020-04-18T12:20:36Z", "message": "feat(scheduler): add a possibility to define Job identity via the Scheduled annotation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1OTkyMzI1", "url": "https://github.com/quarkusio/quarkus/pull/8665#pullrequestreview-395992325", "createdAt": "2020-04-19T08:43:56Z", "commit": {"oid": "1670e592403e8fe41f0a5eef1260b30b63286ec4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQwODo0Mzo1NlrOGH0gsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQwODo0NDowNlrOGH0gyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg1MzU1Mg==", "bodyText": "We could probably get rid of SimpleScheduler.triggerNameSequence and SimpleScheduler.config fields as they are only used in the constructor, in createTrigger()...", "url": "https://github.com/quarkusio/quarkus/pull/8665#discussion_r410853552", "createdAt": "2020-04-19T08:43:56Z", "author": {"login": "mkouba"}, "path": "extensions/scheduler/runtime/src/main/java/io/quarkus/scheduler/runtime/SimpleScheduler.java", "diffHunk": "@@ -148,7 +148,10 @@ public void resume() {\n     }\n \n     SimpleTrigger createTrigger(String invokerClass, CronParser parser, Scheduled scheduled) {\n-        String id = triggerNameSequence.getAndIncrement() + \"_\" + invokerClass;\n+        String id = scheduled.identity().trim();\n+        if (id.isEmpty()) {\n+            id = triggerNameSequence.getAndIncrement() + \"_\" + invokerClass;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1670e592403e8fe41f0a5eef1260b30b63286ec4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg1MzU3OQ==", "bodyText": "Hm, we don't need AtomicInteger here, right? We could use int and triggerNameSequence++...", "url": "https://github.com/quarkusio/quarkus/pull/8665#discussion_r410853579", "createdAt": "2020-04-19T08:44:06Z", "author": {"login": "mkouba"}, "path": "extensions/quartz/runtime/src/main/java/io/quarkus/quartz/runtime/QuartzScheduler.java", "diffHunk": "@@ -92,11 +89,15 @@ public QuartzScheduler(SchedulerContext context, QuartzSupport quartzSupport, Co\n                 for (ScheduledMethodMetadata method : context.getScheduledMethods()) {\n \n                     invokers.put(method.getInvokerClassName(), context.createInvoker(method.getInvokerClassName()));\n+                    AtomicInteger triggerNameSequence = new AtomicInteger();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1670e592403e8fe41f0a5eef1260b30b63286ec4"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf9951a49677fc0f622031b8a3a3550400a34e8e", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/bf9951a49677fc0f622031b8a3a3550400a34e8e", "committedDate": "2020-04-19T09:59:11Z", "message": "fix(quartz): make sure that job identity is unique and deterministic across several builds\n\nFix #8661 - by making sure that the sequence is unique for each invoker class i.e a scheduled methods."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c918947d0c32c952cf337cc4c1bd122decf0f4af", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/c918947d0c32c952cf337cc4c1bd122decf0f4af", "committedDate": "2020-04-19T09:59:11Z", "message": "refactor: remove some unused parameters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25ed4d8da8545db9deb7b86ed29d092ff46b0fd5", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/25ed4d8da8545db9deb7b86ed29d092ff46b0fd5", "committedDate": "2020-04-19T09:59:11Z", "message": "feat(scheduler): add a possibility to define Job identity via the Scheduled annotation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1670e592403e8fe41f0a5eef1260b30b63286ec4", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/1670e592403e8fe41f0a5eef1260b30b63286ec4", "committedDate": "2020-04-18T12:20:36Z", "message": "feat(scheduler): add a possibility to define Job identity via the Scheduled annotation"}, "afterCommit": {"oid": "25ed4d8da8545db9deb7b86ed29d092ff46b0fd5", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/25ed4d8da8545db9deb7b86ed29d092ff46b0fd5", "committedDate": "2020-04-19T09:59:11Z", "message": "feat(scheduler): add a possibility to define Job identity via the Scheduled annotation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MjUzMjky", "url": "https://github.com/quarkusio/quarkus/pull/8665#pullrequestreview-396253292", "createdAt": "2020-04-20T08:43:01Z", "commit": {"oid": "25ed4d8da8545db9deb7b86ed29d092ff46b0fd5"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwODo0MzowMVrOGIJrPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwODo0MzowMVrOGIJrPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIwMDMxOQ==", "bodyText": "I'm not sure I see how this solves the issue?", "url": "https://github.com/quarkusio/quarkus/pull/8665#discussion_r411200319", "createdAt": "2020-04-20T08:43:01Z", "author": {"login": "gsmet"}, "path": "extensions/quartz/runtime/src/main/java/io/quarkus/quartz/runtime/QuartzScheduler.java", "diffHunk": "@@ -92,11 +88,15 @@ public QuartzScheduler(SchedulerContext context, QuartzSupport quartzSupport, Co\n                 for (ScheduledMethodMetadata method : context.getScheduledMethods()) {\n \n                     invokers.put(method.getInvokerClassName(), context.createInvoker(method.getInvokerClassName()));\n+                    int nameSequence = 0;\n \n                     for (Scheduled scheduled : method.getSchedules()) {\n-                        String name = triggerNameSequence.getAndIncrement() + \"_\" + method.getInvokerClassName();\n+                        String identity = scheduled.identity().trim();\n+                        if (identity.isEmpty()) {\n+                            identity = ++nameSequence + \"_\" + method.getInvokerClassName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ed4d8da8545db9deb7b86ed29d092ff46b0fd5"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MDQyODMw", "url": "https://github.com/quarkusio/quarkus/pull/8665#pullrequestreview-397042830", "createdAt": "2020-04-21T07:06:00Z", "commit": {"oid": "25ed4d8da8545db9deb7b86ed29d092ff46b0fd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4437, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}