{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2NzM0ODEx", "number": 8318, "title": "Don't remove classes from the resettable elements", "bodyText": "Fixes #8301", "createdAt": "2020-04-01T03:21:23Z", "url": "https://github.com/quarkusio/quarkus/pull/8318", "merged": true, "mergeCommit": {"oid": "e931b13dcfec28aa93da1f99af10f2c4cd8fdf91"}, "closed": true, "closedAt": "2020-04-01T12:03:00Z", "author": {"login": "stuartwdouglas"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTPBU0AH2gAyMzk2NzM0ODExOmMxNDE2ZWZmZjUyOWEyMGM5OGEzZjdkY2E1ZmQ5MDQyOTk4Y2E1YjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTUX6mAFqTM4NTQxODM0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c1416efff529a20c98a3f7dca5fd9042998ca5b3", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/c1416efff529a20c98a3f7dca5fd9042998ca5b3", "committedDate": "2020-04-01T03:20:40Z", "message": "Don't remove classes from the resettable elements\n\nFixes #8301"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzU1Nzky", "url": "https://github.com/quarkusio/quarkus/pull/8318#pullrequestreview-385355792", "createdAt": "2020-04-01T08:12:03Z", "commit": {"oid": "c1416efff529a20c98a3f7dca5fd9042998ca5b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxMjowM1rOF-1dxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxMjowM1rOF-1dxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMjAwNQ==", "bodyText": "So if I understand it correctly when we generate a fwk class that is not marked as an application class it's loaded by the \"Base Runtime ClassLoader\" which is persistent but always reset during restart (because the generated classes may differ). But even if gizmo generates a different name for a function the new generated fwk class should reference this new name, or? I mean the generated class cannot not survive the hot reload, can it?", "url": "https://github.com/quarkusio/quarkus/pull/8318#discussion_r401432005", "createdAt": "2020-04-01T08:12:03Z", "author": {"login": "mkouba"}, "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/classloading/MemoryClassPathElement.java", "diffHunk": "@@ -22,7 +23,21 @@ public MemoryClassPathElement(Map<String, byte[]> resources) {\n     }\n \n     public void reset(Map<String, byte[]> resources) {\n-        this.resources = resources;\n+        Map<String, byte[]> newResources = new HashMap<>(resources);\n+        //we can't delete .class files from the loader\n+        //gizmo may not generate the same function names on restart\n+        //so if we delete them already loaded classes may have problems, as functions they reference", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1416efff529a20c98a3f7dca5fd9042998ca5b3"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NDA4OTc5", "url": "https://github.com/quarkusio/quarkus/pull/8318#pullrequestreview-385408979", "createdAt": "2020-04-01T09:23:10Z", "commit": {"oid": "c1416efff529a20c98a3f7dca5fd9042998ca5b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NDE4MzQ2", "url": "https://github.com/quarkusio/quarkus/pull/8318#pullrequestreview-385418346", "createdAt": "2020-04-01T09:34:52Z", "commit": {"oid": "c1416efff529a20c98a3f7dca5fd9042998ca5b3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTozNDo1MlrOF-4hUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTozNDo1MlrOF-4hUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ4MjA2Ng==", "bodyText": "I wonder if we should make the io.quarkus.gizmo.BytecodeCreatorImpl.FUNCTION field public and use it here?", "url": "https://github.com/quarkusio/quarkus/pull/8318#discussion_r401482066", "createdAt": "2020-04-01T09:34:52Z", "author": {"login": "mkouba"}, "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/classloading/MemoryClassPathElement.java", "diffHunk": "@@ -22,7 +23,21 @@ public MemoryClassPathElement(Map<String, byte[]> resources) {\n     }\n \n     public void reset(Map<String, byte[]> resources) {\n-        this.resources = resources;\n+        Map<String, byte[]> newResources = new HashMap<>(resources);\n+        //we can't delete .class files from the loader\n+        //gizmo may not generate the same function names on restart\n+        //so if we delete them already loaded classes may have problems, as functions they reference\n+        //may have been removed\n+        //see https://github.com/quarkusio/quarkus/issues/8301\n+        for (Map.Entry<String, byte[]> e : this.resources.entrySet()) {\n+            if (newResources.containsKey(e.getKey())) {\n+                continue;\n+            }\n+            if (e.getKey().endsWith(\".class\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1416efff529a20c98a3f7dca5fd9042998ca5b3"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4660, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}