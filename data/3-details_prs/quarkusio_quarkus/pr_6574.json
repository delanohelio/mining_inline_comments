{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNDEwMjg4", "number": 6574, "title": "Support both GraalVM 19.2.1 and 19.3.1", "bodyText": "Fixes #6483", "createdAt": "2020-01-16T01:14:43Z", "url": "https://github.com/quarkusio/quarkus/pull/6574", "merged": true, "mergeCommit": {"oid": "8d0b94e16bfa85f9fa68c9fbbf92c4f8b49f1d17"}, "closed": true, "closedAt": "2020-01-17T07:27:05Z", "author": {"login": "gwenneg"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6wBUMgFqTM0MzYyOTc3Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7JlNdgFqTM0NDQwMDE0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjI5Nzc2", "url": "https://github.com/quarkusio/quarkus/pull/6574#pullrequestreview-343629776", "createdAt": "2020-01-16T01:39:24Z", "commit": {"oid": "45aa64f8b350a9fa63d2a1cb8f6770124a7b54f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMTozOToyNVrOFeLuiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMTozOToyNVrOFeLuiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE5MzczNg==", "bodyText": "I tried to find a simpler expression to force the exception throw here, but I didn't find anything that worked. I'm sure this expression could be much shorter...", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367193736", "createdAt": "2020-01-16T01:39:25Z", "author": {"login": "gwenneg"}, "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/NativeImageAutoFeatureStep.java", "diffHunk": "@@ -205,7 +208,26 @@ public void write(String s, byte[] bytes) {\n         }\n \n         if (!resourceBundles.isEmpty()) {\n-            ResultHandle locClass = overallCatch.loadClass(LOCALIZATION_FEATURE);\n+            /*\n+             * Start of a temporary workaround to support both GraalVM 19.2.1 and 19.3.1 at the same time.\n+             * TODO: Delete this workaround when Quarkus no longer supports GraalVM 19.2.1.\n+             */\n+            AssignableResultHandle locClass = overallCatch.createVariable(Class.class);\n+            TryBlock workaroundTryBlock = overallCatch.tryBlock();\n+            workaroundTryBlock.assign(locClass, workaroundTryBlock.loadClass(LOCALIZATION_FEATURE));\n+            // The following line is required to throw an exception and make sure we load the 19.2.1 class when needed.\n+            workaroundTryBlock.invokeVirtualMethod(\n+                    ofMethod(Class.class, \"getDeclaredMethod\", Method.class, String.class, Class[].class), locClass,\n+                    workaroundTryBlock.load(\"addBundleToCache\"),\n+                    workaroundTryBlock.marshalAsArray(Class.class, workaroundTryBlock.loadClass(String.class)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45aa64f8b350a9fa63d2a1cb8f6770124a7b54f2"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50abff446723c9009d1f86202ae101d52f88dddf", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/50abff446723c9009d1f86202ae101d52f88dddf", "committedDate": "2020-01-16T06:55:20Z", "message": "Remove useless project.version in quarkus-narayana-stm-deployment"}, "afterCommit": {"oid": "dc2ff882ebf5d4a6925c2a6fb051ee35b9dea3f2", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/dc2ff882ebf5d4a6925c2a6fb051ee35b9dea3f2", "committedDate": "2020-01-16T11:02:23Z", "message": "Disable JNI by default with GraalVM 19.2.1"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a779dc876d2e66ca6e9c6a2acf793394c5c5c3e9", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/a779dc876d2e66ca6e9c6a2acf793394c5c5c3e9", "committedDate": "2020-01-16T13:57:17Z", "message": "Force a CI cache refresh"}, "afterCommit": {"oid": "2621c832511a45be48157652079ae8eaf02d98df", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/2621c832511a45be48157652079ae8eaf02d98df", "committedDate": "2020-01-16T14:38:26Z", "message": "Disable JNI by default with GraalVM 19.2.1"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2621c832511a45be48157652079ae8eaf02d98df", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/2621c832511a45be48157652079ae8eaf02d98df", "committedDate": "2020-01-16T14:38:26Z", "message": "Disable JNI by default with GraalVM 19.2.1"}, "afterCommit": {"oid": "d68ff6af1983de0368aed05b51cbad00c96322f2", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/d68ff6af1983de0368aed05b51cbad00c96322f2", "committedDate": "2020-01-16T14:47:08Z", "message": "Fix build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDcxNDk3", "url": "https://github.com/quarkusio/quarkus/pull/6574#pullrequestreview-344071497", "createdAt": "2020-01-16T17:02:02Z", "commit": {"oid": "d68ff6af1983de0368aed05b51cbad00c96322f2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNzowMjowMlrOFeg0Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNzowNTozOFrOFeg7Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzOTIxOA==", "bodyText": "Please add parentheses here. And I would have  19.2. as the pattern (with a leading space).", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367539218", "createdAt": "2020-01-16T17:02:02Z", "author": {"login": "gsmet"}, "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java", "diffHunk": "@@ -266,7 +266,7 @@ public NativeImageBuildItem build(NativeConfig nativeConfig, NativeImageSourceJa\n             if (!nativeConfig.enableIsolates) {\n                 command.add(\"-H:-SpawnIsolates\");\n             }\n-            if (nativeConfig.enableJni) {\n+            if (nativeConfig.enableJni || graalVMVersion.isPresent() && !graalVMVersion.get().contains(\" 19.2.1 \")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d68ff6af1983de0368aed05b51cbad00c96322f2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzUzOTgwMg==", "bodyText": "I don't think this logic should be changed in this patch. This is too restrictive.\nI'm OK for the error message change but I would keep the logic as it was and replace experimental with preview.", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367539802", "createdAt": "2020-01-16T17:03:11Z", "author": {"login": "gsmet"}, "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java", "diffHunk": "@@ -322,12 +322,11 @@ public NativeImageBuildItem build(NativeConfig nativeConfig, NativeImageSourceJa\n \n     private void checkGraalVMVersion(String version) {\n         log.info(\"Running Quarkus native-image plugin on \" + version);\n-        final List<String> obsoleteGraalVmVersions = Arrays.asList(\"1.0.0\", \"19.0.\", \"19.1.\", \"19.2.\");\n-        final boolean vmVersionIsObsolete = version.contains(\" 19.3.0 \")\n-                || obsoleteGraalVmVersions.stream().anyMatch(v -> version.contains(\" \" + v));\n-        if (vmVersionIsObsolete) {\n-            throw new IllegalStateException(\n-                    \"Out of date build of GraalVM detected: \" + version + \". Please upgrade to GraalVM 19.3.0.2\");\n+        List<String> supportedGraalVmVersions = Arrays.asList(\" 19.2.1 \", \" 19.3.1 \");\n+        if (supportedGraalVmVersions.stream().noneMatch(version::contains)) {\n+            throw new IllegalStateException(\"Unsupported version of GraalVM detected: \" + version + \".\"\n+                    + \" Quarkus currently offers a stable support of GraalVM 19.2.1 and an experimental support of GraalVM 19.3.1.\"\n+                    + \" Please upgrade GraalVM to one of these versions.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d68ff6af1983de0368aed05b51cbad00c96322f2"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MDczMw==", "bodyText": "I'm not sure I understand why you are adding all those lines?", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367540733", "createdAt": "2020-01-16T17:05:03Z", "author": {"login": "gsmet"}, "path": "integration-tests/jpa-without-entity/pom.xml", "diffHunk": "@@ -105,6 +105,7 @@\n                                     <cleanupServer>true</cleanupServer>\n                                     <enableHttpUrlHandler>true</enableHttpUrlHandler>\n                                     <graalvmHome>${graalvmHome}</graalvmHome>\n+                                    <enableJni>false</enableJni>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d68ff6af1983de0368aed05b51cbad00c96322f2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MTAzNQ==", "bodyText": "I don't understand that? I mean the extensions themselves should trigger the enablement of JNI, no?", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367541035", "createdAt": "2020-01-16T17:05:38Z", "author": {"login": "gsmet"}, "path": "integration-tests/vertx-http/pom.xml", "diffHunk": "@@ -103,6 +103,7 @@\n                                         <additionalBuildArg>-H:EnableURLProtocols=http,https</additionalBuildArg>\n                                     </additionalBuildArgs>\n                                     <graalvmHome>${graalvmHome}</graalvmHome>\n+                                    <enableJni>true</enableJni>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d68ff6af1983de0368aed05b51cbad00c96322f2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDc1MDgz", "url": "https://github.com/quarkusio/quarkus/pull/6574#pullrequestreview-344075083", "createdAt": "2020-01-16T17:07:20Z", "commit": {"oid": "44cc35ee5d8c892bf0860a028338c560321d4686"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNzowNzoyMFrOFeg-vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNzowNzoyMFrOFeg-vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0MTk1MA==", "bodyText": "This fixes an exception that appeared with ubi-quarkus-native-image:19.3.1-java8:\nCaused by: com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method org.h2.engine.Engine.getInstance() is reachable: The declaring class of this element has been substituted, but this element is not present in the substitution class", "url": "https://github.com/quarkusio/quarkus/pull/6574#discussion_r367541950", "createdAt": "2020-01-16T17:07:20Z", "author": {"login": "gwenneg"}, "path": "extensions/jdbc/jdbc-h2/runtime/src/main/java/io/quarkus/jdbc/h2/runtime/graal/Engine.java", "diffHunk": "@@ -3,13 +3,19 @@\n import org.h2.engine.ConnectionInfo;\n import org.h2.engine.Session;\n \n+import com.oracle.svm.core.SubstrateUtil;\n import com.oracle.svm.core.annotate.Substitute;\n import com.oracle.svm.core.annotate.TargetClass;\n \n @TargetClass(className = \"org.h2.engine.Engine\")\n @Substitute\n public final class Engine {\n \n+    @Substitute\n+    public static org.h2.engine.Engine getInstance() {\n+        return SubstrateUtil.cast(new Engine(), org.h2.engine.Engine.class);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44cc35ee5d8c892bf0860a028338c560321d4686"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33ea19d16e8b16e470617989577e00d26cb74638", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/33ea19d16e8b16e470617989577e00d26cb74638", "committedDate": "2020-01-16T19:56:10Z", "message": "Support both GraalVM 19.2.1 and 19.3.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27af95ccbf1643dfd5ecbb36c18ec3d36747eeef", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/27af95ccbf1643dfd5ecbb36c18ec3d36747eeef", "committedDate": "2020-01-16T19:56:46Z", "message": "Fix quarkus-integration-test-infinispan-embedded in native mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b74e0e327cbdcd7fd87b54a265602c57d5904e9", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/9b74e0e327cbdcd7fd87b54a265602c57d5904e9", "committedDate": "2020-01-16T19:57:02Z", "message": "Disable quarkus-integration-test-jsch in native mode temporarily"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cbefa6ffcd9fec6a5677ee1b6ab481db9214466", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/5cbefa6ffcd9fec6a5677ee1b6ab481db9214466", "committedDate": "2020-01-16T19:59:41Z", "message": "Remove useless project.version in quarkus-narayana-stm-deployment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dea977da7c72e6e18f79cf709199ff411ebe9205", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/dea977da7c72e6e18f79cf709199ff411ebe9205", "committedDate": "2020-01-16T20:02:44Z", "message": "Disable JNI by default with GraalVM 19.2.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d68b721bcc3ccba976221c5cc2f32dc02374429", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/2d68b721bcc3ccba976221c5cc2f32dc02374429", "committedDate": "2020-01-16T20:02:57Z", "message": "Fix H2 native DeletedElementException"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "147e8e4291f86d0408e6ece0822818c4e8913a54", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/147e8e4291f86d0408e6ece0822818c4e8913a54", "committedDate": "2020-01-16T18:41:19Z", "message": "Apply review suggestions"}, "afterCommit": {"oid": "2d68b721bcc3ccba976221c5cc2f32dc02374429", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/2d68b721bcc3ccba976221c5cc2f32dc02374429", "committedDate": "2020-01-16T20:02:57Z", "message": "Fix H2 native DeletedElementException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NDAwMTQy", "url": "https://github.com/quarkusio/quarkus/pull/6574#pullrequestreview-344400142", "createdAt": "2020-01-17T07:26:15Z", "commit": {"oid": "2d68b721bcc3ccba976221c5cc2f32dc02374429"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 205, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}