{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NDQ2NTU1", "number": 12198, "title": "Add OIDC SecurityEvent", "bodyText": "Fixes #12145\nThis PR adds a listener which can capture some important login/session/logout events based on the conversation with the user. Login (i.e creating a new session after a successful code flow) is of primary interest, but other events (4 of them for now, more can be added easily) will let users have a better view into what is going on.\nNote I'm passing a blocking API ref as a context attribute (in case some expensive action will need to be done), @stuartwdouglas, if you prefer, I can have a dedicated parameter.\nAlso updated the RP-initiated doc section as the user could not make it work (was not obvious the logout path had to be authenticated)", "createdAt": "2020-09-18T17:25:18Z", "url": "https://github.com/quarkusio/quarkus/pull/12198", "merged": true, "mergeCommit": {"oid": "109af54f7c3e91cd521848499673d59e428456c3"}, "closed": true, "closedAt": "2020-10-01T14:47:54Z", "author": {"login": "sberyozkin"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKJERCgBqjM3ODM1ODYyOTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOQi1JAFqTUwMDI5MzcyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f1e2fb5f172e2f34a31a3d02a8f797b1bdde0f8", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/5f1e2fb5f172e2f34a31a3d02a8f797b1bdde0f8", "committedDate": "2020-09-18T17:19:07Z", "message": "Add OIDC CodeAuthenticationListener"}, "afterCommit": {"oid": "550a522c220209b2d9a12167ada84a9d58523609", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/550a522c220209b2d9a12167ada84a9d58523609", "committedDate": "2020-09-18T17:30:04Z", "message": "Add OIDC CodeAuthenticationListener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "550a522c220209b2d9a12167ada84a9d58523609", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/550a522c220209b2d9a12167ada84a9d58523609", "committedDate": "2020-09-18T17:30:04Z", "message": "Add OIDC CodeAuthenticationListener"}, "afterCommit": {"oid": "fc8f4bfd187fc00c71e954ee8758324018e06c86", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/fc8f4bfd187fc00c71e954ee8758324018e06c86", "committedDate": "2020-09-20T17:05:41Z", "message": "Add OIDC CodeAuthenticationListener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc8f4bfd187fc00c71e954ee8758324018e06c86", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/fc8f4bfd187fc00c71e954ee8758324018e06c86", "committedDate": "2020-09-20T17:05:41Z", "message": "Add OIDC CodeAuthenticationListener"}, "afterCommit": {"oid": "1513299a79fbe98bed39ff873be1ae091d859788", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/1513299a79fbe98bed39ff873be1ae091d859788", "committedDate": "2020-09-21T16:36:34Z", "message": "Add OIDC CodeAuthenticationListener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1513299a79fbe98bed39ff873be1ae091d859788", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/1513299a79fbe98bed39ff873be1ae091d859788", "committedDate": "2020-09-21T16:36:34Z", "message": "Add OIDC CodeAuthenticationListener"}, "afterCommit": {"oid": "41925637c81fcc269dac552d33062b2ef02586a5", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/41925637c81fcc269dac552d33062b2ef02586a5", "committedDate": "2020-09-23T12:51:52Z", "message": "Add OIDC CodeAuthenticationListener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41925637c81fcc269dac552d33062b2ef02586a5", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/41925637c81fcc269dac552d33062b2ef02586a5", "committedDate": "2020-09-23T12:51:52Z", "message": "Add OIDC CodeAuthenticationListener"}, "afterCommit": {"oid": "5526efcf20b91a11c81771cb1c9007389146f539", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/5526efcf20b91a11c81771cb1c9007389146f539", "committedDate": "2020-09-23T12:57:22Z", "message": "Add OIDC CodeAuthenticationListener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5526efcf20b91a11c81771cb1c9007389146f539", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/5526efcf20b91a11c81771cb1c9007389146f539", "committedDate": "2020-09-23T12:57:22Z", "message": "Add OIDC CodeAuthenticationListener"}, "afterCommit": {"oid": "15059f7e362e5000e86ec5727506b9ffce3702db", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/15059f7e362e5000e86ec5727506b9ffce3702db", "committedDate": "2020-09-24T10:35:05Z", "message": "Add OIDC CodeAuthenticationListener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15059f7e362e5000e86ec5727506b9ffce3702db", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/15059f7e362e5000e86ec5727506b9ffce3702db", "committedDate": "2020-09-24T10:35:05Z", "message": "Add OIDC CodeAuthenticationListener"}, "afterCommit": {"oid": "8596f3c9e5e9265e7dd8bf00ed38c9220b9a8bac", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/8596f3c9e5e9265e7dd8bf00ed38c9220b9a8bac", "committedDate": "2020-09-24T16:22:41Z", "message": "Add OIDC CodeAuthenticationListener"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8596f3c9e5e9265e7dd8bf00ed38c9220b9a8bac", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/8596f3c9e5e9265e7dd8bf00ed38c9220b9a8bac", "committedDate": "2020-09-24T16:22:41Z", "message": "Add OIDC CodeAuthenticationListener"}, "afterCommit": {"oid": "578b8e445273e53dbcf120250caf107a595669c1", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/578b8e445273e53dbcf120250caf107a595669c1", "committedDate": "2020-09-29T16:14:15Z", "message": "Add OIDC SecurityEvent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "578b8e445273e53dbcf120250caf107a595669c1", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/578b8e445273e53dbcf120250caf107a595669c1", "committedDate": "2020-09-29T16:14:15Z", "message": "Add OIDC SecurityEvent"}, "afterCommit": {"oid": "9ad2aa4bffb7cf34375b329a74cec07148a1ab59", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/9ad2aa4bffb7cf34375b329a74cec07148a1ab59", "committedDate": "2020-09-29T16:29:08Z", "message": "Add OIDC SecurityEvent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ad2aa4bffb7cf34375b329a74cec07148a1ab59", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/9ad2aa4bffb7cf34375b329a74cec07148a1ab59", "committedDate": "2020-09-29T16:29:08Z", "message": "Add OIDC SecurityEvent"}, "afterCommit": {"oid": "65667ad317c5abe7393f6fc25c67eb1238141289", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/65667ad317c5abe7393f6fc25c67eb1238141289", "committedDate": "2020-09-30T15:07:07Z", "message": "Add OIDC SecurityEvent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "105c05d125716c236f6f3b01cc6b14b50ace5d74", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/105c05d125716c236f6f3b01cc6b14b50ace5d74", "committedDate": "2020-09-30T17:19:45Z", "message": "Check observers with ValidationPhaseBuildItem"}, "afterCommit": {"oid": "4e15e67f9f74eadbd985d2c057330da12421e4c9", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/4e15e67f9f74eadbd985d2c057330da12421e4c9", "committedDate": "2020-09-30T17:47:24Z", "message": "Add OIDC SecurityEvent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e15e67f9f74eadbd985d2c057330da12421e4c9", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/4e15e67f9f74eadbd985d2c057330da12421e4c9", "committedDate": "2020-09-30T17:47:24Z", "message": "Add OIDC SecurityEvent"}, "afterCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce", "committedDate": "2020-09-30T20:02:52Z", "message": "Add OIDC SecurityEvent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5OTM3ODQx", "url": "https://github.com/quarkusio/quarkus/pull/12198#pullrequestreview-499937841", "createdAt": "2020-10-01T00:21:30Z", "commit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTA4MDkx", "url": "https://github.com/quarkusio/quarkus/pull/12198#pullrequestreview-500108091", "createdAt": "2020-10-01T08:15:07Z", "commit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoxNTowN1rOHa_W7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoyMToyMFrOHa_lbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2MzA4NQ==", "bodyText": "You should read the ValidationPhaseBuildItem javadoc more carefully ;-). Your build step should produce or pretend that it produces a ValidationErrorBuildItem.", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498063085", "createdAt": "2020-10-01T08:15:07Z", "author": {"login": "mkouba"}, "path": "extensions/oidc/deployment/src/main/java/io/quarkus/oidc/deployment/OidcBuildStep.java", "diffHunk": "@@ -90,6 +97,18 @@ public SyntheticBeanBuildItem setup(\n                 .done();\n     }\n \n+    @BuildStep(onlyIf = IsEnabled.class)\n+    @Record(ExecutionTime.RUNTIME_INIT)\n+    public void findSecurityEventObservers(\n+            OidcRecorder recorder,\n+            ValidationPhaseBuildItem validationPhase) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NTM0Nw==", "bodyText": "You should rather create and cache an Event object for perf reasons, i.e. Event<SecurityEvent> event = Arc.container().beanManager().getEvent().select(SecurityEvent.class) and then event.fire(...).", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498065347", "createdAt": "2020-10-01T08:18:57Z", "author": {"login": "mkouba"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -390,6 +396,13 @@ private void processSuccessfulAuthentication(RoutingContext context,\n             maxAge += configContext.oidcConfig.authentication.sessionAgeExtension.getSeconds();\n         }\n         createCookie(context, configContext, getSessionCookieName(configContext), cookieValue, maxAge);\n+        fireEvent(SecurityEvent.Type.OIDC_LOGIN, securityIdentity);\n+    }\n+\n+    private void fireEvent(SecurityEvent.Type eventType, SecurityIdentity securityIdentity) {\n+        if (resolver.isSecurityEventObserved()) {\n+            Arc.container().beanManager().fireEvent(new SecurityEvent(eventType, securityIdentity));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NjA0Mg==", "bodyText": "Or even inject the Event object if possible...", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498066042", "createdAt": "2020-10-01T08:20:04Z", "author": {"login": "mkouba"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -390,6 +396,13 @@ private void processSuccessfulAuthentication(RoutingContext context,\n             maxAge += configContext.oidcConfig.authentication.sessionAgeExtension.getSeconds();\n         }\n         createCookie(context, configContext, getSessionCookieName(configContext), cookieValue, maxAge);\n+        fireEvent(SecurityEvent.Type.OIDC_LOGIN, securityIdentity);\n+    }\n+\n+    private void fireEvent(SecurityEvent.Type eventType, SecurityIdentity securityIdentity) {\n+        if (resolver.isSecurityEventObserved()) {\n+            Arc.container().beanManager().fireEvent(new SecurityEvent(eventType, securityIdentity));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NTM0Nw=="}, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2Njc5OQ==", "bodyText": "This field should be probably volatile...", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498066799", "createdAt": "2020-10-01T08:21:20Z", "author": {"login": "mkouba"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/TenantConfigBean.java", "diffHunk": "@@ -10,6 +10,7 @@\n     private final Map<String, TenantConfigContext> staticTenantsConfig;\n     private final TenantConfigContext defaultTenant;\n     private final Function<OidcTenantConfig, TenantConfigContext> tenantConfigContextFactory;\n+    private boolean securityEventObserved;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce", "committedDate": "2020-09-30T20:02:52Z", "message": "Add OIDC SecurityEvent"}, "afterCommit": {"oid": "fa6f2014bd41130e6e99816ae029bff18c5c7373", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/fa6f2014bd41130e6e99816ae029bff18c5c7373", "committedDate": "2020-10-01T09:48:10Z", "message": "Add OIDC SecurityEvent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0f4eac26f78ad92827b0e548dd68c1030f143ea", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/a0f4eac26f78ad92827b0e548dd68c1030f143ea", "committedDate": "2020-10-01T11:27:25Z", "message": "Add OIDC SecurityEvent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa6f2014bd41130e6e99816ae029bff18c5c7373", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/fa6f2014bd41130e6e99816ae029bff18c5c7373", "committedDate": "2020-10-01T09:48:10Z", "message": "Add OIDC SecurityEvent"}, "afterCommit": {"oid": "a0f4eac26f78ad92827b0e548dd68c1030f143ea", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/a0f4eac26f78ad92827b0e548dd68c1030f143ea", "committedDate": "2020-10-01T11:27:25Z", "message": "Add OIDC SecurityEvent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMjkzNzI2", "url": "https://github.com/quarkusio/quarkus/pull/12198#pullrequestreview-500293726", "createdAt": "2020-10-01T12:28:42Z", "commit": {"oid": "a0f4eac26f78ad92827b0e548dd68c1030f143ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 369, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}