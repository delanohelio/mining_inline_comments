{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5MDM2NTc4", "number": 13863, "title": "Add OpenTracing Command Listener to MongoDB client", "bodyText": "Following the instructions in the OpenTracing Mongo Driver Instrumentation there is a way to include the tracing information simply adding a CommandListener to the mongoclient settings.\nAfter the work done on #12082, it is accomplished by adding the MongoTracingCommandListener to the list of CommandListeners to be set to the mongoclient settings.\nProject sample https://github.com/juazugas/quarkus-mongodb-opentracing/\nDiscussion: https://quarkusio.zulipchat.com/#narrow/stream/187030-users/topic/possible.20new.20extension.20for.20mongodb.20client.20and.20opentracing", "createdAt": "2020-12-13T22:52:54Z", "url": "https://github.com/quarkusio/quarkus/pull/13863", "merged": true, "mergeCommit": {"oid": "fa50d364b12df474f3223de7be791a578b992548"}, "closed": true, "closedAt": "2021-04-02T07:42:01Z", "author": {"login": "juazugas"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmAhdLABqjQxMDc1ODQ5Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeI1ohsgBqjQ1NDEwODQxMTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4fa8a5f6f011ac2c5fd181ee73490101317db99", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/d4fa8a5f6f011ac2c5fd181ee73490101317db99", "committedDate": "2020-12-13T22:38:43Z", "message": "Add OpenTracing command listener to Mongo client."}, "afterCommit": {"oid": "03a721763a90cc3401198631f4c299a504be5a05", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/03a721763a90cc3401198631f4c299a504be5a05", "committedDate": "2020-12-14T07:21:10Z", "message": "Add OpenTracing command listener to Mongo client."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMjcwNjE5", "url": "https://github.com/quarkusio/quarkus/pull/13863#pullrequestreview-551270619", "createdAt": "2020-12-14T11:15:29Z", "commit": {"oid": "03a721763a90cc3401198631f4c299a504be5a05"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMToxNToyOVrOIFLqQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMToyMzoyNlrOIFL9Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNDgzMg==", "bodyText": "You also need to add the opentracing mongo client.\nTo avoid duplicating configuration, better add a link to the related section on the OpenTracing guide", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r542304832", "createdAt": "2020-12-14T11:15:29Z", "author": {"login": "loicmathieu"}, "path": "docs/src/main/asciidoc/mongodb.adoc", "diffHunk": "@@ -596,6 +596,12 @@ This behavior must first be enabled by setting the `quarkus.mongodb.metrics.enab\n So when you access the `/q/metrics` endpoint of your application you will have information about the connection pool status.\n When using link:microprofile-metrics[SmallRye Metrics], connection pool metrics will be available under the `vendor` scope.\n \n+== Tracing\n+\n+If you are using the `quarkus-smallrye-opentracing` extension, `quarkus-mongodb-client` can register traces about the commands executed.\n+This behavior must first be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03a721763a90cc3401198631f4c299a504be5a05"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwNzYxMw==", "bodyText": "Don't index it if you don't want to include it automatically later !", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r542307613", "createdAt": "2020-12-14T11:20:04Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -66,6 +72,20 @@\n     private static final DotName MONGO_CLIENT = DotName.createSimple(MongoClient.class.getName());\n     private static final DotName REACTIVE_MONGO_CLIENT = DotName.createSimple(ReactiveMongoClient.class.getName());\n \n+    static class MongoClientTracingEnabled implements BooleanSupplier {\n+        MongoClientBuildTimeConfig mConfig;\n+\n+        @Override\n+        public boolean getAsBoolean() {\n+            return mConfig.tracingEnabled;\n+        }\n+    }\n+\n+    @BuildStep(onlyIf = MongoClientTracingEnabled.class)\n+    IndexDependencyBuildItem addMongoTracingDependencies() {\n+        return new IndexDependencyBuildItem(\"io.opentracing.contrib\", \"opentracing-mongo-common\");\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03a721763a90cc3401198631f4c299a504be5a05"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwODI2MA==", "bodyText": "You should index your MongoTracingCommandListener if tracing is enabled and the capability is present in a dedicated step. By this you will not have to remove the TracingCommandListene and add your own", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r542308260", "createdAt": "2020-12-14T11:21:05Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -93,10 +113,20 @@ BsonDiscriminatorBuildItem collectBsonDiscriminators(CombinedIndexBuildItem inde\n     }\n \n     @BuildStep\n-    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem) {\n+    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem, Capabilities capabilities,\n+            MongoClientBuildTimeConfig buildTimeConfig) {\n+        Predicate<String> isTracingCommandListenerPredicate = name -> name\n+                .equalsIgnoreCase(\"io.opentracing.contrib.mongo.common.TracingCommandListener\");\n         Collection<ClassInfo> commandListenerClasses = indexBuildItem.getIndex()\n                 .getAllKnownImplementors(DotName.createSimple(CommandListener.class.getName()));\n-        List<String> names = commandListenerClasses.stream().map(ci -> ci.name().toString()).collect(Collectors.toList());\n+        List<String> names = commandListenerClasses.stream()\n+                .map(ci -> ci.name().toString())\n+                // filter the TracingCommandListener to avoid the non-default constructor class.\n+                .filter(isTracingCommandListenerPredicate.negate())\n+                .collect(Collectors.toList());\n+        if (buildTimeConfig.tracingEnabled && capabilities.isPresent(Capability.OPENTRACING)) {\n+            names.add(MongoTracingCommandListener.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03a721763a90cc3401198631f4c299a504be5a05"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwOTY5MQ==", "bodyText": "If this is the only reason why we cannot directly use the TracingCommandListener maybe open an issue upstream (and propose a PR) to avoid maintaining this MongoTracingCommandListener that only build the TracingCommandListener with the GlobalTracer.\nYou can keep this class while waiting for the fix upstream as a workaround", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r542309691", "createdAt": "2020-12-14T11:23:26Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/tracing/MongoTracingCommandListener.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.mongodb.tracing;\n+\n+import com.mongodb.event.CommandFailedEvent;\n+import com.mongodb.event.CommandListener;\n+import com.mongodb.event.CommandStartedEvent;\n+import com.mongodb.event.CommandSucceededEvent;\n+\n+import io.opentracing.contrib.mongo.common.TracingCommandListener;\n+import io.opentracing.util.GlobalTracer;\n+import io.vertx.core.logging.Logger;\n+import io.vertx.core.logging.LoggerFactory;\n+\n+/**\n+ * Command Listener for Mongo client delegated to {@link TracingCommandListener}.\n+ * \n+ */\n+public class MongoTracingCommandListener implements CommandListener {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(MongoTracingCommandListener.class);\n+\n+    private TracingCommandListener delegate;\n+\n+    public MongoTracingCommandListener() {\n+        this.delegate = new TracingCommandListener.Builder(GlobalTracer.get()).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03a721763a90cc3401198631f4c299a504be5a05"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03a721763a90cc3401198631f4c299a504be5a05", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/03a721763a90cc3401198631f4c299a504be5a05", "committedDate": "2020-12-14T07:21:10Z", "message": "Add OpenTracing command listener to Mongo client."}, "afterCommit": {"oid": "754517b0b7c45253568bf732739b05b94fa74410", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/754517b0b7c45253568bf732739b05b94fa74410", "committedDate": "2021-02-09T18:32:07Z", "message": "Add OpenTracing command listener to Mongo client."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg3Mzg2NzIz", "url": "https://github.com/quarkusio/quarkus/pull/13863#pullrequestreview-587386723", "createdAt": "2021-02-10T09:07:06Z", "commit": {"oid": "754517b0b7c45253568bf732739b05b94fa74410"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xMFQwOTowNzowNlrOIi_I2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xMFQwOToxODowNlrOIi_lKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU1Njk1NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            This behavior must be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties` and adding the dependency `io.opentracing.contrib:opentracing-mongo-common` to your pom.xml (for more info read the link:opentracing#mongodb-client[MongoDB client])\n          \n          \n            \n            This behavior must be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties` and adding the dependency `io.opentracing.contrib:opentracing-mongo-common` to your pom.xml (for more info read the link:opentracing#mongodb-client[OpenTracing - MongoDB client] section)", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573556954", "createdAt": "2021-02-10T09:07:06Z", "author": {"login": "loicmathieu"}, "path": "docs/src/main/asciidoc/mongodb.adoc", "diffHunk": "@@ -596,6 +596,12 @@ This behavior must first be enabled by setting the `quarkus.mongodb.metrics.enab\n So when you access the `/q/metrics` endpoint of your application you will have information about the connection pool status.\n When using link:microprofile-metrics[SmallRye Metrics], connection pool metrics will be available under the `vendor` scope.\n \n+== Tracing\n+\n+If you are using the `quarkus-smallrye-opentracing` extension, `quarkus-mongodb-client` can register traces about the commands executed.\n+This behavior must be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties` and adding the dependency `io.opentracing.contrib:opentracing-mongo-common` to your pom.xml (for more info read the link:opentracing#mongodb-client[MongoDB client])", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754517b0b7c45253568bf732739b05b94fa74410"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU1NzI5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Read the link:opentracing[OpenTracing] guide, to configure and how to use the jaeger tracer.\n          \n          \n            \n            Read the link:opentracing[OpenTracing] guide, for how to configure OpenTracing and use the Jaeger tracer.", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573557290", "createdAt": "2021-02-10T09:07:39Z", "author": {"login": "loicmathieu"}, "path": "docs/src/main/asciidoc/mongodb.adoc", "diffHunk": "@@ -596,6 +596,12 @@ This behavior must first be enabled by setting the `quarkus.mongodb.metrics.enab\n So when you access the `/q/metrics` endpoint of your application you will have information about the connection pool status.\n When using link:microprofile-metrics[SmallRye Metrics], connection pool metrics will be available under the `vendor` scope.\n \n+== Tracing\n+\n+If you are using the `quarkus-smallrye-opentracing` extension, `quarkus-mongodb-client` can register traces about the commands executed.\n+This behavior must be enabled by setting the `quarkus.mongodb.tracing.enabled` property to `true` in your `application.properties` and adding the dependency `io.opentracing.contrib:opentracing-mongo-common` to your pom.xml (for more info read the link:opentracing#mongodb-client[MongoDB client])\n+\n+Read the link:opentracing[OpenTracing] guide, to configure and how to use the jaeger tracer.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754517b0b7c45253568bf732739b05b94fa74410"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2MzMwNw==", "bodyText": "Can you use a String here to avoid loading the class inside the deployment module ?", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573563307", "createdAt": "2021-02-10T09:16:51Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -93,10 +106,16 @@ BsonDiscriminatorBuildItem collectBsonDiscriminators(CombinedIndexBuildItem inde\n     }\n \n     @BuildStep\n-    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem) {\n+    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem,\n+            MongoClientBuildTimeConfig buildTimeConfig, Capabilities capabilities) {\n         Collection<ClassInfo> commandListenerClasses = indexBuildItem.getIndex()\n                 .getAllKnownImplementors(DotName.createSimple(CommandListener.class.getName()));\n-        List<String> names = commandListenerClasses.stream().map(ci -> ci.name().toString()).collect(Collectors.toList());\n+        List<String> names = commandListenerClasses.stream()\n+                .map(ci -> ci.name().toString())\n+                .collect(Collectors.toList());\n+        if (buildTimeConfig.tracingEnabled && capabilities.isPresent(Capability.OPENTRACING)) {\n+            names.add(MongoTracingCommandListener.class.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754517b0b7c45253568bf732739b05b94fa74410"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzU2NDIwMA==", "bodyText": "I don't see this being used anywhere ?", "url": "https://github.com/quarkusio/quarkus/pull/13863#discussion_r573564200", "createdAt": "2021-02-10T09:18:06Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -66,6 +70,15 @@\n     private static final DotName MONGO_CLIENT = DotName.createSimple(MongoClient.class.getName());\n     private static final DotName REACTIVE_MONGO_CLIENT = DotName.createSimple(ReactiveMongoClient.class.getName());\n \n+    static class MongoClientTracingEnabled implements BooleanSupplier {\n+        MongoClientBuildTimeConfig mConfig;\n+\n+        @Override\n+        public boolean getAsBoolean() {\n+            return mConfig.tracingEnabled;\n+        }\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "754517b0b7c45253568bf732739b05b94fa74410"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "754517b0b7c45253568bf732739b05b94fa74410", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/754517b0b7c45253568bf732739b05b94fa74410", "committedDate": "2021-02-09T18:32:07Z", "message": "Add OpenTracing command listener to Mongo client."}, "afterCommit": {"oid": "6bf459cd22fb4b3ac0436a0277841c13fa9dea96", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/6bf459cd22fb4b3ac0436a0277841c13fa9dea96", "committedDate": "2021-02-10T18:44:09Z", "message": "Add OpenTracing command listener to Mongo client."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg4MzI3NTM1", "url": "https://github.com/quarkusio/quarkus/pull/13863#pullrequestreview-588327535", "createdAt": "2021-02-11T08:34:14Z", "commit": {"oid": "6bf459cd22fb4b3ac0436a0277841c13fa9dea96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bf459cd22fb4b3ac0436a0277841c13fa9dea96", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/6bf459cd22fb4b3ac0436a0277841c13fa9dea96", "committedDate": "2021-02-10T18:44:09Z", "message": "Add OpenTracing command listener to Mongo client."}, "afterCommit": {"oid": "9439c6c00f69fa32a32dd4a904a93dd112dd1b5c", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/9439c6c00f69fa32a32dd4a904a93dd112dd1b5c", "committedDate": "2021-03-17T12:22:48Z", "message": "Add OpenTracing command listener to Mongo client."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2c5349b111c83ad452df6fd7a063ccd3bfdae4d", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/b2c5349b111c83ad452df6fd7a063ccd3bfdae4d", "committedDate": "2021-04-01T12:28:44Z", "message": "Add OpenTracing command listener to Mongo client."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ca78b0b8fac7c616d4e04a61e92a27e84a97939", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/8ca78b0b8fac7c616d4e04a61e92a27e84a97939", "committedDate": "2021-03-30T13:42:04Z", "message": "Merge branch 'main' into ext-mongodb-opentracing-listener"}, "afterCommit": {"oid": "b2c5349b111c83ad452df6fd7a063ccd3bfdae4d", "author": {"user": {"login": "juazugas", "name": "Juan Zuriaga"}}, "url": "https://github.com/quarkusio/quarkus/commit/b2c5349b111c83ad452df6fd7a063ccd3bfdae4d", "committedDate": "2021-04-01T12:28:44Z", "message": "Add OpenTracing command listener to Mongo client."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4310, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}