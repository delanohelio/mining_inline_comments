{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2NjY0MTg3", "number": 12082, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToxMzoxM1rOEjMA-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQyMDo0OTo1NlrOEvf8Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzMyNDc1OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientRecorder.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToxMzoxM1rOHRZ28A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo0ODo0N1rOHWazCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxMTUwNA==", "bodyText": "Shouldn't we support multiple CommandListeners given it looks like MongoDB supports it?", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r488011504", "createdAt": "2020-09-14T15:13:13Z", "author": {"login": "gsmet"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientRecorder.java", "diffHunk": "@@ -26,12 +27,19 @@\n         return new Supplier<MongoClientSupport>() {\n             @Override\n             public MongoClientSupport get() {\n+\n                 List<ConnectionPoolListener> connectionPoolListeners = new ArrayList<>(connectionPoolListenerSuppliers.size());\n                 for (Supplier<ConnectionPoolListener> item : connectionPoolListenerSuppliers) {\n                     connectionPoolListeners.add(item.get());\n                 }\n+                final CommandListener commandListener = Arc.container().instance(CommandListener.class).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28f82b796cdab6709adf041362f1ccaffeca70d6"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxNzgzNw==", "bodyText": "Agree", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r488017837", "createdAt": "2020-09-14T15:21:49Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientRecorder.java", "diffHunk": "@@ -26,12 +27,19 @@\n         return new Supplier<MongoClientSupport>() {\n             @Override\n             public MongoClientSupport get() {\n+\n                 List<ConnectionPoolListener> connectionPoolListeners = new ArrayList<>(connectionPoolListenerSuppliers.size());\n                 for (Supplier<ConnectionPoolListener> item : connectionPoolListenerSuppliers) {\n                     connectionPoolListeners.add(item.get());\n                 }\n+                final CommandListener commandListener = Arc.container().instance(CommandListener.class).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxMTUwNA=="}, "originalCommit": {"oid": "28f82b796cdab6709adf041362f1ccaffeca70d6"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxOTM4OA==", "bodyText": "Agree. The limitation is on my knowledge of how to retrieve the List of CDI beans of a given type. any help?", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r488019388", "createdAt": "2020-09-14T15:23:55Z", "author": {"login": "juazugas"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientRecorder.java", "diffHunk": "@@ -26,12 +27,19 @@\n         return new Supplier<MongoClientSupport>() {\n             @Override\n             public MongoClientSupport get() {\n+\n                 List<ConnectionPoolListener> connectionPoolListeners = new ArrayList<>(connectionPoolListenerSuppliers.size());\n                 for (Supplier<ConnectionPoolListener> item : connectionPoolListenerSuppliers) {\n                     connectionPoolListeners.add(item.get());\n                 }\n+                final CommandListener commandListener = Arc.container().instance(CommandListener.class).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxMTUwNA=="}, "originalCommit": {"oid": "28f82b796cdab6709adf041362f1ccaffeca70d6"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI2OTc3MA==", "bodyText": "Set<Bean<?>> beans = Arc.container().beanManager().getBeans(CommandListener.class); will return all beans of type CommandListener.\nThen you can get the bean from Arc by type if the name is null or by name.\nYou can find an example here but there may be an easier way to do it if you don't rely on CDI but instead use Jandex and retrieve all implementors of CommandListener.", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r493269770", "createdAt": "2020-09-23T07:48:47Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientRecorder.java", "diffHunk": "@@ -26,12 +27,19 @@\n         return new Supplier<MongoClientSupport>() {\n             @Override\n             public MongoClientSupport get() {\n+\n                 List<ConnectionPoolListener> connectionPoolListeners = new ArrayList<>(connectionPoolListenerSuppliers.size());\n                 for (Supplier<ConnectionPoolListener> item : connectionPoolListenerSuppliers) {\n                     connectionPoolListeners.add(item.get());\n                 }\n+                final CommandListener commandListener = Arc.container().instance(CommandListener.class).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxMTUwNA=="}, "originalCommit": {"oid": "28f82b796cdab6709adf041362f1ccaffeca70d6"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzMyNjYzOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientSupport.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToxMzo0MVrOHRZ4HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToyNjowN1rOHRab9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxMTgwNA==", "bodyText": "I would drop this method, it's useless, right?", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r488011804", "createdAt": "2020-09-14T15:13:41Z", "author": {"login": "gsmet"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientSupport.java", "diffHunk": "@@ -31,6 +45,22 @@ public MongoClientSupport(List<String> codecProviders, List<String> bsonDiscrimi\n         return connectionPoolListeners;\n     }\n \n+    public List<CommandListener> getCommandListeners() {\n+        return commandListeners;\n+    }\n+\n+    public void setCommandListenerList(List<CommandListener> commandListenersList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28f82b796cdab6709adf041362f1ccaffeca70d6"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyMDk4Mw==", "bodyText": "It depends on the above comment (#12082 (comment)). If we need to add a single CommandListener or a full list. But finally it should exist only the one that it's used.", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r488020983", "createdAt": "2020-09-14T15:26:07Z", "author": {"login": "juazugas"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientSupport.java", "diffHunk": "@@ -31,6 +45,22 @@ public MongoClientSupport(List<String> codecProviders, List<String> bsonDiscrimi\n         return connectionPoolListeners;\n     }\n \n+    public List<CommandListener> getCommandListeners() {\n+        return commandListeners;\n+    }\n+\n+    public void setCommandListenerList(List<CommandListener> commandListenersList) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxMTgwNA=="}, "originalCommit": {"oid": "28f82b796cdab6709adf041362f1ccaffeca70d6"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MzMyOTgwOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientSupport.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToxNDoyMlrOHRZ6Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToxNDoyMlrOHRZ6Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxMjI5MA==", "bodyText": "You already test the caller, I think we can drop this test here and consider it will be called with a non-null commandListener.", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r488012290", "createdAt": "2020-09-14T15:14:22Z", "author": {"login": "gsmet"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientSupport.java", "diffHunk": "@@ -31,6 +45,22 @@ public MongoClientSupport(List<String> codecProviders, List<String> bsonDiscrimi\n         return connectionPoolListeners;\n     }\n \n+    public List<CommandListener> getCommandListeners() {\n+        return commandListeners;\n+    }\n+\n+    public void setCommandListenerList(List<CommandListener> commandListenersList) {\n+        if (null != commandListenersList && !commandListenersList.isEmpty()) {\n+            commandListeners.addAll(commandListenersList);\n+        }\n+    }\n+\n+    public void addCommandListener(CommandListener commandListener) {\n+        if (null != commandListener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28f82b796cdab6709adf041362f1ccaffeca70d6"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTQ1NzkwOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjowNzoyN1rOHRt1cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMjowNzoyN1rOHRt1cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMzODgwMA==", "bodyText": "What's wrong with passing an empty list? No need to check here I guess", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r488338800", "createdAt": "2020-09-15T02:07:27Z", "author": {"login": "gastaldi"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "diffHunk": "@@ -249,6 +249,10 @@ private MongoClientSettings createMongoConfiguration(MongoClientConfig config) {\n                 CodecRegistries.fromProviders(providers));\n         settings.codecRegistry(registry);\n \n+        if (!mongoClientSupport.getCommandListeners().isEmpty()) {\n+            settings.commandListenerList(mongoClientSupport.getCommandListeners());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1c101a8a8f44cbab7dde57b6ae949bf5ba8da58"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NzE3NDQ0OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientSupport.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1MTo0OVrOHWa68A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1MTo0OVrOHWa68A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3MTc5Mg==", "bodyText": "I don't think this is needed to provides methods with and without the List of CommandListener. This method is only used inside the deployment module so it's signature can be modified.", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r493271792", "createdAt": "2020-09-23T07:51:49Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientSupport.java", "diffHunk": "@@ -1,21 +1,35 @@\n package io.quarkus.mongodb.runtime;\n \n+import java.util.ArrayList;\n import java.util.List;\n \n+import com.mongodb.event.CommandListener;\n import com.mongodb.event.ConnectionPoolListener;\n \n public class MongoClientSupport {\n \n     private final List<String> codecProviders;\n     private final List<String> bsonDiscriminators;\n     private final List<ConnectionPoolListener> connectionPoolListeners;\n+    private final List<CommandListener> commandListeners;\n     private final boolean disableSslSupport;\n \n     public MongoClientSupport(List<String> codecProviders, List<String> bsonDiscriminators,\n             List<ConnectionPoolListener> connectionPoolListeners, boolean disableSslSupport) {\n         this.codecProviders = codecProviders;\n         this.bsonDiscriminators = bsonDiscriminators;\n         this.connectionPoolListeners = connectionPoolListeners;\n+        this.commandListeners = new ArrayList<>();\n+        this.disableSslSupport = disableSslSupport;\n+    }\n+\n+    public MongoClientSupport(List<String> codecProviders, List<String> bsonDiscriminators,\n+            List<ConnectionPoolListener> connectionPoolListeners, List<CommandListener> commandListeners,\n+            boolean disableSslSupport) {\n+        this.codecProviders = codecProviders;\n+        this.bsonDiscriminators = bsonDiscriminators;\n+        this.connectionPoolListeners = connectionPoolListeners;\n+        this.commandListeners = commandListeners;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7092f2019e54e7013b3578e5f6aa779064f4e2e"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NzE4MDg3OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientRecorder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1MzowOFrOHWa_GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1MzowOFrOHWa_GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3Mjg1Ng==", "bodyText": "This should not be needed, just pass the Command listener list as we do for all other MongoDB related classes", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r493272856", "createdAt": "2020-09-23T07:53:08Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClientRecorder.java", "diffHunk": "@@ -26,12 +27,19 @@\n         return new Supplier<MongoClientSupport>() {\n             @Override\n             public MongoClientSupport get() {\n+\n                 List<ConnectionPoolListener> connectionPoolListeners = new ArrayList<>(connectionPoolListenerSuppliers.size());\n                 for (Supplier<ConnectionPoolListener> item : connectionPoolListenerSuppliers) {\n                     connectionPoolListeners.add(item.get());\n                 }\n+                final CommandListener commandListener = Arc.container().instance(CommandListener.class).get();\n \n-                return new MongoClientSupport(codecProviders, bsonDiscriminators, connectionPoolListeners, disableSslSupport);\n+                MongoClientSupport mongoClientSupport = new MongoClientSupport(codecProviders, bsonDiscriminators,\n+                        connectionPoolListeners, disableSslSupport);\n+                if (null != commandListener) {\n+                    mongoClientSupport.addCommandListener(commandListener);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7092f2019e54e7013b3578e5f6aa779064f4e2e"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNDA4MTM2OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMToxMjo1MFrOHaYmeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMToxMjo1MFrOHaYmeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQyODA4OQ==", "bodyText": "You create a List fo CommandListener in the getCommandListener method so this one is not needed.", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r497428089", "createdAt": "2020-09-30T11:12:50Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "diffHunk": "@@ -249,6 +250,12 @@ private MongoClientSettings createMongoConfiguration(MongoClientConfig config) {\n                 CodecRegistries.fromProviders(providers));\n         settings.codecRegistry(registry);\n \n+        List<CommandListener> listeners = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b33b286af447efdc2b2150ef05475efc8d150ef4"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNDE3NjU1OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/test/java/io/quarkus/mongodb/MockCommandListener.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMTo0MTo1NVrOHaZghw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMTo0MTo1NVrOHaZghw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0Mjk1MQ==", "bodyText": "Having the insertions here is not realy readable for a test.\nCan you instead register the CommandEvent in a static List and assert in the test that the event is present inside the list ?", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r497442951", "createdAt": "2020-09-30T11:41:55Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/src/test/java/io/quarkus/mongodb/MockCommandListener.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package io.quarkus.mongodb;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.anyOf;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.notNullValue;\n+\n+import com.mongodb.event.CommandListener;\n+import com.mongodb.event.CommandStartedEvent;\n+\n+public class MockCommandListener implements CommandListener {\n+\n+    private CommandStartedEvent commandStartedEvent;\n+\n+    @Override\n+    public void commandStarted(CommandStartedEvent startedEvent) {\n+        this.commandStartedEvent = startedEvent;\n+        assertThat(startedEvent, notNullValue());\n+        assertThat(startedEvent.getCommandName(), anyOf(equalTo(\"listDatabases\"), equalTo(\"endSessions\")));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b33b286af447efdc2b2150ef05475efc8d150ef4"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNDgwNTczOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/test/java/io/quarkus/mongodb/MockCommandListener.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoxNDozN1rOHafsDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoxNDozN1rOHafsDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0NDIwNQ==", "bodyText": "constants should be uppercase", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r497544205", "createdAt": "2020-09-30T14:14:37Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/src/test/java/io/quarkus/mongodb/MockCommandListener.java", "diffHunk": "@@ -1,26 +1,18 @@\n package io.quarkus.mongodb;\n \n-import static org.hamcrest.MatcherAssert.assertThat;\n-import static org.hamcrest.Matchers.anyOf;\n-import static org.hamcrest.Matchers.equalTo;\n-import static org.hamcrest.Matchers.notNullValue;\n+import java.util.ArrayList;\n+import java.util.List;\n \n import com.mongodb.event.CommandListener;\n import com.mongodb.event.CommandStartedEvent;\n \n public class MockCommandListener implements CommandListener {\n \n-    private CommandStartedEvent commandStartedEvent;\n+    public static final List<String> events = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7715e922a6e645bdf0e10bc7633055f6955bff92"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDQxMTczOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/CommandListenerBuildItem.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODowMDo1NVrOHeSe-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoyMjoxM1rOHgA11w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMjE3MQ==", "bodyText": "I see this is done to be symmetrical. But I fail to see why we need build items for that, rather than just having private methods.\nIs there any point for the others? In this case it makes sense to be consistent and have it here too.", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r501522171", "createdAt": "2020-10-08T08:00:55Z", "author": {"login": "gsmet"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/CommandListenerBuildItem.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package io.quarkus.mongodb.deployment;\n+\n+import java.util.List;\n+\n+import io.quarkus.builder.item.SimpleBuildItem;\n+\n+public final class CommandListenerBuildItem extends SimpleBuildItem {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a5a0208005084d909999c7eadf788a369f44512"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzMDI2Mw==", "bodyText": "I'm not an expert but my guess would be that in case we use private methods,\nwe still would need to pass the CombinedIndexBuildItem to the buildsteps, the index lists process would be run two times and also we would be postponing the class name filtering to the Static init phase instead of doing it during the augmentation.\nAlso having BuildItems and BuildSteps makes the flow more clear about what it is needed to build the final objects.", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r503330263", "createdAt": "2020-10-12T14:22:13Z", "author": {"login": "juazugas"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/CommandListenerBuildItem.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package io.quarkus.mongodb.deployment;\n+\n+import java.util.List;\n+\n+import io.quarkus.builder.item.SimpleBuildItem;\n+\n+public final class CommandListenerBuildItem extends SimpleBuildItem {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMjE3MQ=="}, "originalCommit": {"oid": "8a5a0208005084d909999c7eadf788a369f44512"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDQxMzA4OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODowMToyMVrOHeSf3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoyMjoyMlrOHgA2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMjM5Nw==", "bodyText": "Maybe rename the method to addExtensionPointsToNative ?", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r501522397", "createdAt": "2020-10-08T08:01:21Z", "author": {"login": "gsmet"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -82,11 +83,21 @@ BsonDiscriminatorBuildItem collectBsonDiscriminators(CombinedIndexBuildItem inde\n     }\n \n     @BuildStep\n-    List<ReflectiveClassBuildItem> addCodecsAndDiscriminatorsToNative(CodecProviderBuildItem codecProviders,\n-            BsonDiscriminatorBuildItem bsonDiscriminators) {\n+    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem) {\n+        Collection<ClassInfo> commandListenerClasses = indexBuildItem.getIndex()\n+                .getAllKnownImplementors(DotName.createSimple(CommandListener.class.getName()));\n+        List<String> names = commandListenerClasses.stream().map(ci -> ci.name().toString()).collect(Collectors.toList());\n+        return new CommandListenerBuildItem(names);\n+    }\n+\n+    @BuildStep\n+    List<ReflectiveClassBuildItem> addCodecsAndDiscriminatorsAndListenersToNative(CodecProviderBuildItem codecProviders,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a5a0208005084d909999c7eadf788a369f44512"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzMDM1Ng==", "bodyText": "Sure", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r503330356", "createdAt": "2020-10-12T14:22:22Z", "author": {"login": "juazugas"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -82,11 +83,21 @@ BsonDiscriminatorBuildItem collectBsonDiscriminators(CombinedIndexBuildItem inde\n     }\n \n     @BuildStep\n-    List<ReflectiveClassBuildItem> addCodecsAndDiscriminatorsToNative(CodecProviderBuildItem codecProviders,\n-            BsonDiscriminatorBuildItem bsonDiscriminators) {\n+    CommandListenerBuildItem collectCommandListeners(CombinedIndexBuildItem indexBuildItem) {\n+        Collection<ClassInfo> commandListenerClasses = indexBuildItem.getIndex()\n+                .getAllKnownImplementors(DotName.createSimple(CommandListener.class.getName()));\n+        List<String> names = commandListenerClasses.stream().map(ci -> ci.name().toString()).collect(Collectors.toList());\n+        return new CommandListenerBuildItem(names);\n+    }\n+\n+    @BuildStep\n+    List<ReflectiveClassBuildItem> addCodecsAndDiscriminatorsAndListenersToNative(CodecProviderBuildItem codecProviders,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMjM5Nw=="}, "originalCommit": {"oid": "8a5a0208005084d909999c7eadf788a369f44512"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDQyMDYwOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODowMzoyNlrOHeSkVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoyMzo0MlrOHgA5ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMzU0Mw==", "bodyText": "Could we use Class.forName here instead?", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r501523543", "createdAt": "2020-10-08T08:03:26Z", "author": {"login": "gsmet"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "diffHunk": "@@ -384,6 +387,21 @@ private AuthenticationMechanism getAuthenticationMechanism(String authMechanism)\n         return providers;\n     }\n \n+    private List<CommandListener> getCommandListeners(List<String> classNames) {\n+        List<CommandListener> listeners = new ArrayList<>();\n+        for (String name : classNames) {\n+            try {\n+                Class<?> clazz = Thread.currentThread().getContextClassLoader().loadClass(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a5a0208005084d909999c7eadf788a369f44512"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzMTI1OA==", "bodyText": "Ok. Tested on a project with the jar and the native image does not make the difference, I suppose because we do\nthe initialization immediately after loading the class.", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r503331258", "createdAt": "2020-10-12T14:23:42Z", "author": {"login": "juazugas"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "diffHunk": "@@ -384,6 +387,21 @@ private AuthenticationMechanism getAuthenticationMechanism(String authMechanism)\n         return providers;\n     }\n \n+    private List<CommandListener> getCommandListeners(List<String> classNames) {\n+        List<CommandListener> listeners = new ArrayList<>();\n+        for (String name : classNames) {\n+            try {\n+                Class<?> clazz = Thread.currentThread().getContextClassLoader().loadClass(name);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMzU0Mw=="}, "originalCommit": {"oid": "8a5a0208005084d909999c7eadf788a369f44512"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDQyMTYzOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODowMzo0NVrOHeSlDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoyNjo0NVrOHgBBsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMzcyNw==", "bodyText": "Maybe call this one commandListeners?", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r501523727", "createdAt": "2020-10-08T08:03:45Z", "author": {"login": "gsmet"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "diffHunk": "@@ -249,6 +250,8 @@ private MongoClientSettings createMongoConfiguration(MongoClientConfig config) {\n                 CodecRegistries.fromProviders(providers));\n         settings.codecRegistry(registry);\n \n+        settings.commandListenerList(getCommandListeners(mongoClientSupport.getCommandListeners()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a5a0208005084d909999c7eadf788a369f44512"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzMzI5Nw==", "bodyText": "I'm not sure about this suggestion.\n\nThe settings class is from mongodb driver (com.mongodb.MongoClientSettings.Builder)\nThe MongoClientSupport class has all its fields exposed to getter methods\nThe private method getCommandListeners is called after the same naming pattern as the getCodeProviders method.\n\nIt could be ... extracting the call to the getter function to a variable called commandListeners (very likely to happen in a future PR). For example:\nList<CommandListeners> commandListeners = getCommandListeners(mongoClientSupport.getCommandListeners());\nsettings.commandListenerList(commandListeners);", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r503333297", "createdAt": "2020-10-12T14:26:45Z", "author": {"login": "juazugas"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/MongoClients.java", "diffHunk": "@@ -249,6 +250,8 @@ private MongoClientSettings createMongoConfiguration(MongoClientConfig config) {\n                 CodecRegistries.fromProviders(providers));\n         settings.codecRegistry(registry);\n \n+        settings.commandListenerList(getCommandListeners(mongoClientSupport.getCommandListeners()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyMzcyNw=="}, "originalCommit": {"oid": "8a5a0208005084d909999c7eadf788a369f44512"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MjQxODgzOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/CommandListenerBuildItem.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQyMDo0OTo1NlrOHkhIjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQyMDo0OTo1NlrOHkhIjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA1MzY0Ng==", "bodyText": "Can you please add some Javadoc to this class? This is necessary for the All Build Items page", "url": "https://github.com/quarkusio/quarkus/pull/12082#discussion_r508053646", "createdAt": "2020-10-19T20:49:56Z", "author": {"login": "gastaldi"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/CommandListenerBuildItem.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package io.quarkus.mongodb.deployment;\n+\n+import java.util.List;\n+\n+import io.quarkus.builder.item.SimpleBuildItem;\n+\n+public final class CommandListenerBuildItem extends SimpleBuildItem {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12302721b651dad84a486bc0183676fc19f39a7c"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 262, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}