{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNjgwODc4", "number": 12977, "title": "Reimplement the QuarkusJTAPlatform to avoid leaking the ORM registry", "bodyText": "Fixes #12976", "createdAt": "2020-10-27T11:30:02Z", "url": "https://github.com/quarkusio/quarkus/pull/12977", "merged": true, "mergeCommit": {"oid": "d1f9b48e1510827066872fb0aa6ae9709c4af7eb"}, "closed": true, "closedAt": "2020-10-27T21:31:05Z", "author": {"login": "Sanne"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWnR9agH2gAyNTEwNjgwODc4OmEzM2RhZWFlMTljODE4NDZiZjYxYjgxN2Q3YTJmNzYyOTc3OTJkNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWv4pjgFqTUxODE2NjY5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a33daeae19c81846bf61b817d7a2f76297792d47", "author": {"user": {"login": "Sanne", "name": "Sanne Grinovero"}}, "url": "https://github.com/quarkusio/quarkus/commit/a33daeae19c81846bf61b817d7a2f76297792d47", "committedDate": "2020-10-27T11:29:29Z", "message": "Reimplement the QuarkusJTAPlatform to avoid leaking the ORM registry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDI3Nzkw", "url": "https://github.com/quarkusio/quarkus/pull/12977#pullrequestreview-518027790", "createdAt": "2020-10-27T18:39:36Z", "commit": {"oid": "a33daeae19c81846bf61b817d7a2f76297792d47"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODozOTozNlrOHpLVuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODo0MDo0M1rOHpLYXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkzOTQ0OA==", "bodyText": "Looks like some double checked locking except I don't see the synchronized part.\nIs it safe?", "url": "https://github.com/quarkusio/quarkus/pull/12977#discussion_r512939448", "createdAt": "2020-10-27T18:39:36Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/customized/QuarkusJtaPlatform.java", "diffHunk": "@@ -1,26 +1,72 @@\n package io.quarkus.hibernate.orm.runtime.customized;\n \n+import javax.transaction.Synchronization;\n+import javax.transaction.SystemException;\n+import javax.transaction.Transaction;\n import javax.transaction.TransactionManager;\n import javax.transaction.UserTransaction;\n \n-import org.hibernate.engine.transaction.jta.platform.internal.AbstractJtaPlatform;\n+import org.hibernate.engine.transaction.jta.platform.internal.JtaSynchronizationStrategy;\n+import org.hibernate.engine.transaction.jta.platform.internal.TransactionManagerAccess;\n+import org.hibernate.engine.transaction.jta.platform.internal.TransactionManagerBasedSynchronizationStrategy;\n+import org.hibernate.engine.transaction.jta.platform.spi.JtaPlatform;\n \n-public final class QuarkusJtaPlatform extends AbstractJtaPlatform {\n+public final class QuarkusJtaPlatform implements JtaPlatform, TransactionManagerAccess {\n \n     public static final QuarkusJtaPlatform INSTANCE = new QuarkusJtaPlatform();\n \n+    private final JtaSynchronizationStrategy tmSynchronizationStrategy = new TransactionManagerBasedSynchronizationStrategy(\n+            this);\n+    private volatile TransactionManager transactionManager;\n+    private volatile UserTransaction userTransaction;\n+\n     private QuarkusJtaPlatform() {\n         //nothing\n     }\n \n     @Override\n-    protected TransactionManager locateTransactionManager() {\n-        return com.arjuna.ats.jta.TransactionManager.transactionManager();\n+    public TransactionManager retrieveTransactionManager() {\n+        TransactionManager transactionManager = this.transactionManager;\n+        if (transactionManager == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a33daeae19c81846bf61b817d7a2f76297792d47"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0MDEyNw==", "bodyText": "Same question here.", "url": "https://github.com/quarkusio/quarkus/pull/12977#discussion_r512940127", "createdAt": "2020-10-27T18:40:43Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/customized/QuarkusJtaPlatform.java", "diffHunk": "@@ -1,26 +1,72 @@\n package io.quarkus.hibernate.orm.runtime.customized;\n \n+import javax.transaction.Synchronization;\n+import javax.transaction.SystemException;\n+import javax.transaction.Transaction;\n import javax.transaction.TransactionManager;\n import javax.transaction.UserTransaction;\n \n-import org.hibernate.engine.transaction.jta.platform.internal.AbstractJtaPlatform;\n+import org.hibernate.engine.transaction.jta.platform.internal.JtaSynchronizationStrategy;\n+import org.hibernate.engine.transaction.jta.platform.internal.TransactionManagerAccess;\n+import org.hibernate.engine.transaction.jta.platform.internal.TransactionManagerBasedSynchronizationStrategy;\n+import org.hibernate.engine.transaction.jta.platform.spi.JtaPlatform;\n \n-public final class QuarkusJtaPlatform extends AbstractJtaPlatform {\n+public final class QuarkusJtaPlatform implements JtaPlatform, TransactionManagerAccess {\n \n     public static final QuarkusJtaPlatform INSTANCE = new QuarkusJtaPlatform();\n \n+    private final JtaSynchronizationStrategy tmSynchronizationStrategy = new TransactionManagerBasedSynchronizationStrategy(\n+            this);\n+    private volatile TransactionManager transactionManager;\n+    private volatile UserTransaction userTransaction;\n+\n     private QuarkusJtaPlatform() {\n         //nothing\n     }\n \n     @Override\n-    protected TransactionManager locateTransactionManager() {\n-        return com.arjuna.ats.jta.TransactionManager.transactionManager();\n+    public TransactionManager retrieveTransactionManager() {\n+        TransactionManager transactionManager = this.transactionManager;\n+        if (transactionManager == null) {\n+            transactionManager = com.arjuna.ats.jta.TransactionManager.transactionManager();\n+            this.transactionManager = transactionManager;\n+        }\n+        return transactionManager;\n+    }\n+\n+    @Override\n+    public TransactionManager getTransactionManager() {\n+        return retrieveTransactionManager();\n+    }\n+\n+    @Override\n+    public UserTransaction retrieveUserTransaction() {\n+        UserTransaction userTransaction = this.userTransaction;\n+        if (this.userTransaction == null) {\n+            userTransaction = com.arjuna.ats.jta.UserTransaction.userTransaction();\n+            this.userTransaction = userTransaction;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a33daeae19c81846bf61b817d7a2f76297792d47"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MTY2Njk4", "url": "https://github.com/quarkusio/quarkus/pull/12977#pullrequestreview-518166698", "createdAt": "2020-10-27T21:30:59Z", "commit": {"oid": "a33daeae19c81846bf61b817d7a2f76297792d47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1572, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}