{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NDA5MTM1", "number": 8343, "title": "Support having a bean enabled only when a build time profile is enabled or disabled", "bodyText": "", "createdAt": "2020-04-02T07:41:22Z", "url": "https://github.com/quarkusio/quarkus/pull/8343", "merged": true, "mergeCommit": {"oid": "7c646af3db6447fe3216d9adaa8b1dc465189d15"}, "closed": true, "closedAt": "2020-04-06T12:59:37Z", "author": {"login": "geoand"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTu16nABqjMxOTI5OTI3OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcU9pmggFqTM4ODE4OTQ4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb621b0f7daa133bcf882ddce660f379cd96f8cc", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/cb621b0f7daa133bcf882ddce660f379cd96f8cc", "committedDate": "2020-04-02T07:37:51Z", "message": "Support having a bean enabled only when a build time profile is enabled"}, "afterCommit": {"oid": "e9c1e1472829e5a375b1603ed61ede692a8054bd", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/e9c1e1472829e5a375b1603ed61ede692a8054bd", "committedDate": "2020-04-02T16:24:59Z", "message": "Support having a bean enabled only when a build time profile is enabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTg1ODU4", "url": "https://github.com/quarkusio/quarkus/pull/8343#pullrequestreview-386985858", "createdAt": "2020-04-03T07:13:45Z", "commit": {"oid": "e9c1e1472829e5a375b1603ed61ede692a8054bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzoxMzo0NVrOGAHtAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzoxMzo0NVrOGAHtAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc3OTM5NA==", "bodyText": "Hm, this should remove any annotation on a class that is annotated with a scope. Is that intentional? If so, then this could be replaced with something like:\nif (scopes.isScopeIn(ctx.getAnnotations())) {\n  ctx.transform().removeAll().done();\n}", "url": "https://github.com/quarkusio/quarkus/pull/8343#discussion_r402779394", "createdAt": "2020-04-03T07:13:45Z", "author": {"login": "mkouba"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/WhenBuildTimeProfileProcessor.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package io.quarkus.arc.deployment;\n+\n+import static io.quarkus.arc.processor.Annotations.find;\n+\n+import javax.enterprise.inject.Produces;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.ClassInfo;\n+import org.jboss.jandex.DotName;\n+\n+import io.quarkus.arc.WhenBuildTimeProfile;\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.arc.processor.DotNames;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.runtime.configuration.ProfileManager;\n+\n+public class WhenBuildTimeProfileProcessor {\n+\n+    private static final DotName WHEN_BUILD_TIME_PROFILE = DotName.createSimple(WhenBuildTimeProfile.class.getName());\n+\n+    /**\n+     * Uses {@link AnnotationsTransformer} to:\n+     *\n+     * Remove the {@code @Produces} annotation from a producer method or field when that member is also annotated with\n+     * {@code @WhenBuildTimeProfile} and the current build profile doesn't match the one specified on the annotation\n+     *\n+     * Remove the scope annotation from a class bean that is also annotated with\n+     * {@code @WhenBuildTimeProfile} and the current build profile doesn't match the one specified on the annotation\n+     *\n+     * This effectively means that a bean annotated with {@code @WhenBuildTimeProfile} is only enabled when\n+     * the current profile matches that of the annotation\n+     */\n+    @BuildStep\n+    void annotationTransformer(BeanArchiveIndexBuildItem beanArchiveIndex,\n+            CustomScopeAnnotationsBuildItem scopes,\n+            BuildProducer<AnnotationsTransformerBuildItem> annotationsTransformer) {\n+        annotationsTransformer.produce(new AnnotationsTransformerBuildItem(new AnnotationsTransformer() {\n+            @Override\n+            public boolean appliesTo(AnnotationTarget.Kind kind) {\n+                return kind == AnnotationTarget.Kind.METHOD || kind == AnnotationTarget.Kind.CLASS\n+                        || kind == AnnotationTarget.Kind.FIELD;\n+            }\n+\n+            @Override\n+            public int getPriority() {\n+                // Make sure this annotation transformer is invoked after all others\n+                return 10;\n+            }\n+\n+            @Override\n+            public void transform(TransformationContext ctx) {\n+                AnnotationInstance whenBuildTimeProfileInstance = getWhenBuildTimeProfileInstance(ctx);\n+                if (whenBuildTimeProfileInstance == null) {\n+                    return;\n+                }\n+\n+                String profileOnInstance = whenBuildTimeProfileInstance.value().asString();\n+                if (profileOnInstance.equals(ProfileManager.getActiveProfile())) {\n+                    return;\n+                }\n+\n+                if (ctx.isMethod() || ctx.isField()) {\n+                    ctx.transform().remove(ann -> DotNames.PRODUCES.equals(ann.name())).done();\n+                } else if (ctx.isClass()) {\n+                    ctx.transform().remove(ann -> scopes.isScopeDeclaredOn(ann.target().asClass())).done();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9c1e1472829e5a375b1603ed61ede692a8054bd"}, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9c1e1472829e5a375b1603ed61ede692a8054bd", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/e9c1e1472829e5a375b1603ed61ede692a8054bd", "committedDate": "2020-04-02T16:24:59Z", "message": "Support having a bean enabled only when a build time profile is enabled"}, "afterCommit": {"oid": "1f432c266285dbf2530fc61aa28672f42585498a", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/1f432c266285dbf2530fc61aa28672f42585498a", "committedDate": "2020-04-03T08:42:17Z", "message": "Support having a bean enabled only when a build time profile is enabled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f432c266285dbf2530fc61aa28672f42585498a", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/1f432c266285dbf2530fc61aa28672f42585498a", "committedDate": "2020-04-03T08:42:17Z", "message": "Support having a bean enabled only when a build time profile is enabled"}, "afterCommit": {"oid": "b7912e48fdab44c94cb01594727e08708745508d", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/b7912e48fdab44c94cb01594727e08708745508d", "committedDate": "2020-04-06T06:15:17Z", "message": "Support having a bean enabled only when a build time profile is enabled\n\nCo-Authored-By: Martin Kouba <mkouba@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b7912e48fdab44c94cb01594727e08708745508d", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/b7912e48fdab44c94cb01594727e08708745508d", "committedDate": "2020-04-06T06:15:17Z", "message": "Support having a bean enabled only when a build time profile is enabled\n\nCo-Authored-By: Martin Kouba <mkouba@redhat.com>"}, "afterCommit": {"oid": "80c5bdfb9ed71e19ba42b974760e186983711e6a", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/80c5bdfb9ed71e19ba42b974760e186983711e6a", "committedDate": "2020-04-06T06:16:34Z", "message": "Support having a bean enabled only when a build time profile is enabled\n\nCo-Authored-By: Martin Kouba <mkouba@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80c5bdfb9ed71e19ba42b974760e186983711e6a", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/80c5bdfb9ed71e19ba42b974760e186983711e6a", "committedDate": "2020-04-06T06:16:34Z", "message": "Support having a bean enabled only when a build time profile is enabled\n\nCo-Authored-By: Martin Kouba <mkouba@redhat.com>"}, "afterCommit": {"oid": "e1eee0d67de86fabb3af4d51c18a5968670dc98d", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/e1eee0d67de86fabb3af4d51c18a5968670dc98d", "committedDate": "2020-04-06T06:31:17Z", "message": "Support having a bean enabled only when a build time profile is enabled\n\nCo-Authored-By: Martin Kouba <mkouba@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3OTkzMjQ0", "url": "https://github.com/quarkusio/quarkus/pull/8343#pullrequestreview-387993244", "createdAt": "2020-04-06T07:28:24Z", "commit": {"oid": "c44b9c4ea62bd5b06443fcfeea53302c67f802c8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MDg1MTM1", "url": "https://github.com/quarkusio/quarkus/pull/8343#pullrequestreview-388085135", "createdAt": "2020-04-06T09:38:09Z", "commit": {"oid": "c44b9c4ea62bd5b06443fcfeea53302c67f802c8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwOTozODoxMFrOGBPlOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwOTo0Mzo0MVrOGBPzZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk1NzA1MA==", "bodyText": "Recently we added the ability to enable alternatives via config file and those also use Integer.MAX_VALUE.\nSo if a user has an alternative bean that is enabled that way and then adds another bean just for one given profile, he will actually end up with two alternatives with maximum priority (which I think should blow up). Not sure if this corner case is something we want to address right away, just writing it down :)", "url": "https://github.com/quarkusio/quarkus/pull/8343#discussion_r403957050", "createdAt": "2020-04-06T09:38:10Z", "author": {"login": "manovotn"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/BuildTimeProfileProcessor.java", "diffHunk": "@@ -0,0 +1,115 @@\n+package io.quarkus.arc.deployment;\n+\n+import static io.quarkus.arc.processor.Annotations.find;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+\n+import io.quarkus.arc.WhenBuildTimeProfile;\n+import io.quarkus.arc.WhenNotBuildTimeProfile;\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.arc.processor.DotNames;\n+import io.quarkus.arc.processor.Transformation;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.runtime.configuration.ProfileManager;\n+\n+public class BuildTimeProfileProcessor {\n+\n+    private static final DotName WHEN_BUILD_TIME_PROFILE = DotName.createSimple(WhenBuildTimeProfile.class.getName());\n+    private static final DotName WHEN_NOT_BUILD_TIME_PROFILE = DotName.createSimple(WhenNotBuildTimeProfile.class.getName());\n+\n+    /**\n+     * Uses {@link AnnotationsTransformer} to do the following:\n+     *\n+     * Adds the {@code @Alternative} annotation to any class or producer that is annotated with {code @WhenBuildTimeProfile}\n+     * when the specified profile doesn't match the current one.\n+     *\n+     * Adds the {@code @AlternativePriority} annotation to any class or producer that is annotated with\n+     * {code @WhenBuildTimeProfile} when the specified profile does match the current one.\n+     *\n+     * This effectively means that a bean annotated with {@code @WhenBuildTimeProfile} is only enabled when\n+     * the current profile matches that of the annotation\n+     */\n+    @BuildStep\n+    void whenBuildTimeProfile(BeanArchiveIndexBuildItem beanArchiveIndex,\n+            CustomScopeAnnotationsBuildItem scopes,\n+            BuildProducer<AnnotationsTransformerBuildItem> annotationsTransformer) {\n+        annotationsTransformer.produce(new AnnotationsTransformerBuildItem(new AnnotationsTransformer() {\n+            @Override\n+            public boolean appliesTo(AnnotationTarget.Kind kind) {\n+                return kind == AnnotationTarget.Kind.METHOD || kind == AnnotationTarget.Kind.CLASS\n+                        || kind == AnnotationTarget.Kind.FIELD;\n+            }\n+\n+            @Override\n+            public void transform(TransformationContext ctx) {\n+                AnnotationInstance whenBuildTimeProfileInstance = find(ctx.getAnnotations(), WHEN_BUILD_TIME_PROFILE);\n+                if (whenBuildTimeProfileInstance == null) {\n+                    return;\n+                }\n+\n+                Transformation transform = ctx.transform();\n+\n+                String profileOnInstance = whenBuildTimeProfileInstance.value().asString();\n+                if (profileOnInstance.equals(ProfileManager.getActiveProfile())) {\n+                    transform.add(DotNames.ALTERNATIVE_PRIORITY,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c44b9c4ea62bd5b06443fcfeea53302c67f802c8"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk2MDY3Nw==", "bodyText": "Accidental double grave accent(`) around WhenNotBuildTimeProfile?", "url": "https://github.com/quarkusio/quarkus/pull/8343#discussion_r403960677", "createdAt": "2020-04-06T09:43:41Z", "author": {"login": "manovotn"}, "path": "docs/src/main/asciidoc/cdi-reference.adoc", "diffHunk": "@@ -426,6 +426,57 @@ public class CustomTracerConfiguration {\n `@DefaultBean` allows extensions (or any other code for that matter) to provide defaults while backing off if beans of that type are supplied in any\n way Quarkus supports.\n \n+=== Enabling Beans for Quarkus Build Profile\n+\n+Quarkus adds a capability that CDI currently does not support which is to conditionally enable a bean when a Quarkus build-time profile is enabled,\n+via the `@WhenBuildTimeProfile` and ``@WhenNotBuildTimeProfile`` annotations.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c44b9c4ea62bd5b06443fcfeea53302c67f802c8"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24caf7ebe6a849e990cea161f167dc27552793f", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/f24caf7ebe6a849e990cea161f167dc27552793f", "committedDate": "2020-04-06T11:35:47Z", "message": "Support having a bean enabled only when a build time profile is not enabled\n\nCo-Authored-By: Martin Kouba <mkouba@redhat.com>\nCo-Authored-By: Matej Novotny <manovotn@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c44b9c4ea62bd5b06443fcfeea53302c67f802c8", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/c44b9c4ea62bd5b06443fcfeea53302c67f802c8", "committedDate": "2020-04-06T06:58:15Z", "message": "Support having a bean enabled only when a build time profile is not enabled"}, "afterCommit": {"oid": "f24caf7ebe6a849e990cea161f167dc27552793f", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/f24caf7ebe6a849e990cea161f167dc27552793f", "committedDate": "2020-04-06T11:35:47Z", "message": "Support having a bean enabled only when a build time profile is not enabled\n\nCo-Authored-By: Martin Kouba <mkouba@redhat.com>\nCo-Authored-By: Matej Novotny <manovotn@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MTcxMjc0", "url": "https://github.com/quarkusio/quarkus/pull/8343#pullrequestreview-388171274", "createdAt": "2020-04-06T11:46:58Z", "commit": {"oid": "f24caf7ebe6a849e990cea161f167dc27552793f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MTg5NDgy", "url": "https://github.com/quarkusio/quarkus/pull/8343#pullrequestreview-388189482", "createdAt": "2020-04-06T12:14:13Z", "commit": {"oid": "f24caf7ebe6a849e990cea161f167dc27552793f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4695, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}