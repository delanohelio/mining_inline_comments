{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NTM2MjI0", "number": 11798, "title": "Add the @TestTransaction annotation", "bodyText": "This allows you to run tests in a rollback only transaction.\nFixes #6463", "createdAt": "2020-09-02T02:59:30Z", "url": "https://github.com/quarkusio/quarkus/pull/11798", "merged": true, "mergeCommit": {"oid": "2f645d48f03a412519c6f13ebae9851fab963967"}, "closed": true, "closedAt": "2020-09-07T21:25:57Z", "author": {"login": "stuartwdouglas"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE3kSmgFqTQ4MDU4Mjc5Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGkHW6AFqTQ4MzYwNzY4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTgyNzk3", "url": "https://github.com/quarkusio/quarkus/pull/11798#pullrequestreview-480582797", "createdAt": "2020-09-02T08:10:14Z", "commit": {"oid": "f7b47c80524d067315cbc541a1d3903e21084f2b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODoxMDoxNFrOHLizlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODoxNjo1MFrOHLjKoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2NjY0NA==", "bodyText": "\"The allows\" is a typo probably?", "url": "https://github.com/quarkusio/quarkus/pull/11798#discussion_r481866644", "createdAt": "2020-09-02T08:10:14Z", "author": {"login": "mkouba"}, "path": "test-framework/common/src/main/java/io/quarkus/test/TestTransaction.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package io.quarkus.test;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+import javax.interceptor.InterceptorBinding;\n+\n+/**\n+ * Indicates that this method should be run in a rollback only transaction.\n+ *\n+ * The allows the test method to modify the database as required, and then have", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7b47c80524d067315cbc541a1d3903e21084f2b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3MjU0NQ==", "bodyText": "Hm, so you generate an interceptor class because you can't add the @TestTransaction interceptor binding, right? Ok, that's probably the simplest solution. However, I'd move as much as possible logic to the parent class, i.e. injection field of UserTransaction and the whole @AroundInvoke method. If it doesn't work then we have a bug in ArC...", "url": "https://github.com/quarkusio/quarkus/pull/11798#discussion_r481872545", "createdAt": "2020-09-02T08:16:50Z", "author": {"login": "mkouba"}, "path": "extensions/narayana-jta/deployment/src/main/java/io/quarkus/narayana/jta/deployment/NarayanaJtaProcessor.java", "diffHunk": "@@ -96,6 +114,40 @@ public void build(NarayanaJtaRecorder recorder,\n         recorder.setDefaultTimeout(transactions);\n     }\n \n+    @BuildStep\n+    void testTx(LaunchModeBuildItem lm, BuildProducer<GeneratedBeanBuildItem> generatedBeanBuildItemBuildProducer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7b47c80524d067315cbc541a1d3903e21084f2b"}, "originalPosition": 61}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7b47c80524d067315cbc541a1d3903e21084f2b", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/f7b47c80524d067315cbc541a1d3903e21084f2b", "committedDate": "2020-09-02T02:58:54Z", "message": "Add the @TestTransaction annotation\n\nThis allows you to run tests in a rollback only transaction.\n\nFixes #6463"}, "afterCommit": {"oid": "cda28c3221ed1c3e6f3b7a6d40d486a7f36801f4", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/cda28c3221ed1c3e6f3b7a6d40d486a7f36801f4", "committedDate": "2020-09-07T05:15:51Z", "message": "Add the @TestTransaction annotation\n\nThis allows you to run tests in a rollback only transaction.\n\nFixes #6463"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cda28c3221ed1c3e6f3b7a6d40d486a7f36801f4", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/cda28c3221ed1c3e6f3b7a6d40d486a7f36801f4", "committedDate": "2020-09-07T05:15:51Z", "message": "Add the @TestTransaction annotation\n\nThis allows you to run tests in a rollback only transaction.\n\nFixes #6463"}, "afterCommit": {"oid": "3a2e6701a38388f7e4e5d2d7cbbb4eeec809810c", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/3a2e6701a38388f7e4e5d2d7cbbb4eeec809810c", "committedDate": "2020-09-07T06:32:15Z", "message": "Add the @TestTransaction annotation\n\nThis allows you to run tests in a rollback only transaction.\n\nFixes #6463"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84d816cd4336781ed13cbdc7d56ee3bb26020448", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/84d816cd4336781ed13cbdc7d56ee3bb26020448", "committedDate": "2020-09-07T12:46:23Z", "message": "Add the @TestTransaction annotation\n\nThis allows you to run tests in a rollback only transaction.\n\nFixes #6463"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2d057f52d68f5bb6fccc0757c8d7d2e45f702cf", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/a2d057f52d68f5bb6fccc0757c8d7d2e45f702cf", "committedDate": "2020-09-07T14:00:59Z", "message": "@TestTransaction - move logic to the TestTransactionInterceptor class\n\n- add basic support for interceptor's inheritance\n- other unsupported use cases are described here:\nhttps://github.com/quarkusio/quarkus/issues/11942"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a2e6701a38388f7e4e5d2d7cbbb4eeec809810c", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/3a2e6701a38388f7e4e5d2d7cbbb4eeec809810c", "committedDate": "2020-09-07T06:32:15Z", "message": "Add the @TestTransaction annotation\n\nThis allows you to run tests in a rollback only transaction.\n\nFixes #6463"}, "afterCommit": {"oid": "a2d057f52d68f5bb6fccc0757c8d7d2e45f702cf", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/a2d057f52d68f5bb6fccc0757c8d7d2e45f702cf", "committedDate": "2020-09-07T14:00:59Z", "message": "@TestTransaction - move logic to the TestTransactionInterceptor class\n\n- add basic support for interceptor's inheritance\n- other unsupported use cases are described here:\nhttps://github.com/quarkusio/quarkus/issues/11942"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNTgzNjM1", "url": "https://github.com/quarkusio/quarkus/pull/11798#pullrequestreview-483583635", "createdAt": "2020-09-07T14:08:25Z", "commit": {"oid": "a2d057f52d68f5bb6fccc0757c8d7d2e45f702cf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjA3Njg1", "url": "https://github.com/quarkusio/quarkus/pull/11798#pullrequestreview-483607685", "createdAt": "2020-09-07T14:45:23Z", "commit": {"oid": "a2d057f52d68f5bb6fccc0757c8d7d2e45f702cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNDo0NToyM1rOHOB7xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNDo0NToyM1rOHOB7xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ3Mzc5OQ==", "bodyText": "Thanks for having considered my flush()-suggestion. Very cool approach with this new TestTransactionInterceptor!\nI am wondering whether this block could kick in cases where it is not really needed? Usually ServiceLoader calls are not super-cheap.\nI used to apply https://en.wikipedia.org/wiki/Initialization-on-demand_holder_idiom in my projects but I don't know whether this would make any difference here.", "url": "https://github.com/quarkusio/quarkus/pull/11798#discussion_r484473799", "createdAt": "2020-09-07T14:45:23Z", "author": {"login": "famod"}, "path": "extensions/narayana-jta/runtime/src/main/java/io/quarkus/narayana/jta/runtime/interceptor/TestTransactionInterceptor.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.narayana.jta.runtime.interceptor;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.ServiceLoader;\n+\n+import javax.inject.Inject;\n+import javax.interceptor.AroundInvoke;\n+import javax.interceptor.InvocationContext;\n+import javax.transaction.UserTransaction;\n+\n+import io.quarkus.narayana.jta.runtime.test.TestTransactionCallback;\n+\n+public class TestTransactionInterceptor {\n+\n+    static final List<TestTransactionCallback> CALLBACKS;\n+\n+    static {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2d057f52d68f5bb6fccc0757c8d7d2e45f702cf"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 665, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}