{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NTA2NTI2", "number": 11014, "title": "If no Accept header is set default to the first 'produces' type", "bodyText": "Currently if the request does not include an Accept header the\nmethod will still be invoked but the content type will not\nalways be automatically set.\nFixes #10960", "createdAt": "2020-07-28T02:50:09Z", "url": "https://github.com/quarkusio/quarkus/pull/11014", "merged": true, "mergeCommit": {"oid": "2041ad6ed87174e9db31dff26f52ca3ed80e9724"}, "closed": true, "closedAt": "2020-07-29T09:35:46Z", "author": {"login": "stuartwdouglas"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5TNHKgFqTQ1NjQ3MDEzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5ntVlgFqTQ1NzM1NTUyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NDcwMTMz", "url": "https://github.com/quarkusio/quarkus/pull/11014#pullrequestreview-456470133", "createdAt": "2020-07-28T09:40:40Z", "commit": {"oid": "b2b92fdd98fd6bf8249d378767cc8df902c45d58"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo0MDo0MFrOG4E6Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo0MTo0OVrOG4E9Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1MzkxNQ==", "bodyText": "I think that we should only set the content-type header if the business method did not set it manually, i.e. after it was executed. If we set it before then multiple content-type headers may be set to the response.", "url": "https://github.com/quarkusio/quarkus/pull/11014#discussion_r461453915", "createdAt": "2020-07-28T09:40:40Z", "author": {"login": "mkouba"}, "path": "extensions/vertx-web/deployment/src/main/java/io/quarkus/vertx/web/deployment/VertxWebProcessor.java", "diffHunk": "@@ -539,12 +542,14 @@ void implementInvoke(HandlerDescriptor descriptor, BeanInfo bean, MethodInfo met\n         MethodDescriptor methodDescriptor = MethodDescriptor\n                 .ofMethod(bean.getImplClazz().name().toString(), method.name(), returnType, parameterTypes);\n \n+        // If no content-type header is set then try to use the most acceptable content type\n+        // the business method can override this manually if required\n+        invoke.invokeStaticMethod(Methods.ROUTE_HANDLERS_SET_CONTENT_TYPE, routingContext,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2b92fdd98fd6bf8249d378767cc8df902c45d58"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1NDYzNQ==", "bodyText": "manual-content-type is not a good path for this route. Maybe default-content-type?", "url": "https://github.com/quarkusio/quarkus/pull/11014#discussion_r461454635", "createdAt": "2020-07-28T09:41:49Z", "author": {"login": "mkouba"}, "path": "extensions/vertx-web/deployment/src/test/java/io/quarkus/vertx/web/mutiny/SyncRouteTest.java", "diffHunk": "@@ -87,6 +118,13 @@ Person getPersonUtf8(RoutingContext context) {\n             return new Person(\"neo\", 12345);\n         }\n \n+        @Route(path = \"manual-content-type\", produces = \"application/json\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2b92fdd98fd6bf8249d378767cc8df902c45d58"}, "originalPosition": 63}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2b92fdd98fd6bf8249d378767cc8df902c45d58", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/b2b92fdd98fd6bf8249d378767cc8df902c45d58", "committedDate": "2020-07-28T02:49:50Z", "message": "If no Accept header is set default to the first 'produces' type\n\nCurrently if the request does not include an Accept header the\nmethod will still be invoked but the content type will not\nalways be automatically set.\n\nFixes #10960"}, "afterCommit": {"oid": "93aa38edf0cfe4b56aae60cb843357e39cd4ccad", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/93aa38edf0cfe4b56aae60cb843357e39cd4ccad", "committedDate": "2020-07-28T11:37:02Z", "message": "If no Accept header is set default to the first 'produces' type\n\nCurrently if the request does not include an Accept header the\nmethod will still be invoked but the content type will not\nalways be automatically set.\n\nFixes #10960"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjkzMDU1", "url": "https://github.com/quarkusio/quarkus/pull/11014#pullrequestreview-456693055", "createdAt": "2020-07-28T14:29:52Z", "commit": {"oid": "93aa38edf0cfe4b56aae60cb843357e39cd4ccad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoyOTo1M1rOG4PdHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDoyOTo1M1rOG4PdHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYyNjY1Mg==", "bodyText": "Shouldn't we use io.vertx.ext.web.RoutingContext.addHeadersEndHandler(Handler<Void>) instead?\nAlso from perf POV this means one more Handler instance per each request. It's probably negligible but I wonder if the previous approach \"set the content type after the route method is executed\" represents some serious issue?", "url": "https://github.com/quarkusio/quarkus/pull/11014#discussion_r461626652", "createdAt": "2020-07-28T14:29:53Z", "author": {"login": "mkouba"}, "path": "extensions/vertx-web/runtime/src/main/java/io/quarkus/vertx/web/runtime/RouteHandlers.java", "diffHunk": "@@ -18,14 +19,22 @@ private RouteHandlers() {\n     private static final LazyValue<Event<SecurityIdentity>> SECURITY_IDENTITY_EVENT = new LazyValue<>(\n             RouteHandlers::createEvent);\n \n-    public static void setContentType(RoutingContext context) {\n+    public static void setContentType(RoutingContext context, String defaultContentType) {\n         HttpServerResponse response = context.response();\n-        if (response.headers().get(CONTENT_TYPE) == null) {\n-            String acceptableContentType = context.getAcceptableContentType();\n-            if (acceptableContentType != null) {\n-                response.putHeader(CONTENT_TYPE, acceptableContentType);\n+        response.headersEndHandler(new Handler<Void>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93aa38edf0cfe4b56aae60cb843357e39cd4ccad"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e28b6125c680f5c8443026d324f399fefa71e308", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/e28b6125c680f5c8443026d324f399fefa71e308", "committedDate": "2020-07-29T05:17:37Z", "message": "If no Accept header is set default to the first 'produces' type\n\nCurrently if the request does not include an Accept header the\nmethod will still be invoked but the content type will not\nalways be automatically set.\n\nFixes #10960"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93aa38edf0cfe4b56aae60cb843357e39cd4ccad", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/93aa38edf0cfe4b56aae60cb843357e39cd4ccad", "committedDate": "2020-07-28T11:37:02Z", "message": "If no Accept header is set default to the first 'produces' type\n\nCurrently if the request does not include an Accept header the\nmethod will still be invoked but the content type will not\nalways be automatically set.\n\nFixes #10960"}, "afterCommit": {"oid": "e28b6125c680f5c8443026d324f399fefa71e308", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/e28b6125c680f5c8443026d324f399fefa71e308", "committedDate": "2020-07-29T05:17:37Z", "message": "If no Accept header is set default to the first 'produces' type\n\nCurrently if the request does not include an Accept header the\nmethod will still be invoked but the content type will not\nalways be automatically set.\n\nFixes #10960"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MzU1NTI2", "url": "https://github.com/quarkusio/quarkus/pull/11014#pullrequestreview-457355526", "createdAt": "2020-07-29T09:35:35Z", "commit": {"oid": "e28b6125c680f5c8443026d324f399fefa71e308"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 985, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}