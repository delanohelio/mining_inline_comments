{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMzA4Njk5", "number": 8071, "title": "JPA named query with Hibernate with Panache", "bodyText": "This PR adds support for JPA named queries inside Hibernate with Panache.\nFixes #3483\nI only added tests for the find() method but it should works for count(), delete() and update() as the code is common to all query constructions.", "createdAt": "2020-03-23T10:52:52Z", "url": "https://github.com/quarkusio/quarkus/pull/8071", "merged": true, "mergeCommit": {"oid": "1e52669ca5dc05a556c78aba3c9cdd3db44fff2f"}, "closed": true, "closedAt": "2020-04-09T09:43:57Z", "author": {"login": "loicmathieu"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRcF8rAFqTM4MjAwMjg0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUALWhAFqTM4NzIxNTY0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMDAyODQw", "url": "https://github.com/quarkusio/quarkus/pull/8071#pullrequestreview-382002840", "createdAt": "2020-03-26T13:24:26Z", "commit": {"oid": "eda3c749fce3d2e78364f991ac96355d9cddca45"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMzoyNDoyNlrOF8GqpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMzoyNDoyNlrOF8GqpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU2ODEwMQ==", "bodyText": "Given that we're testing for this before we check for isEmpty this can throw.", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398568101", "createdAt": "2020-03-26T13:24:26Z", "author": {"login": "FroMage"}, "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java", "diffHunk": "@@ -135,6 +142,10 @@ static String createFindQuery(Class<?> entityClass, String query, int paramCount\n         return \"FROM \" + getEntityName(entityClass) + \" WHERE \" + query;\n     }\n \n+    static boolean isNamedQuery(String query) {\n+        return query.charAt(0) == '#';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda3c749fce3d2e78364f991ac96355d9cddca45"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eda3c749fce3d2e78364f991ac96355d9cddca45", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/eda3c749fce3d2e78364f991ac96355d9cddca45", "committedDate": "2020-03-23T10:49:16Z", "message": "feat: JPA named query\n\nFixes #3483"}, "afterCommit": {"oid": "4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75", "committedDate": "2020-03-26T14:41:36Z", "message": "feat: JPA named query\n\nFixes #3483"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMTA3NjY3", "url": "https://github.com/quarkusio/quarkus/pull/8071#pullrequestreview-382107667", "createdAt": "2020-03-26T15:11:09Z", "commit": {"oid": "4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToxMTowOVrOF8Lqzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToxMTozOFrOF8LsZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDA2Mg==", "bodyText": "Well, it can also happen here. You could have fixed isNamedQuery instead ;)", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398650062", "createdAt": "2020-03-26T15:11:09Z", "author": {"login": "FroMage"}, "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java", "diffHunk": "@@ -249,7 +260,12 @@ public static Object findById(Class<?> entityClass, Object id, LockModeType lock\n         String findQuery = createFindQuery(entityClass, query, paramCount(params));\n         EntityManager em = getEntityManager();\n         // FIXME: check for duplicate ORDER BY clause?\n-        Query jpaQuery = em.createQuery(sort != null ? findQuery + toOrderBy(sort) : findQuery);\n+        Query jpaQuery;\n+        if (isNamedQuery(query)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY1MDQ3MA==", "bodyText": "And here.", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r398650470", "createdAt": "2020-03-26T15:11:38Z", "author": {"login": "FroMage"}, "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java", "diffHunk": "@@ -263,7 +279,12 @@ public static Object findById(Class<?> entityClass, Object id, LockModeType lock\n         String findQuery = createFindQuery(entityClass, query, paramCount(params));\n         EntityManager em = getEntityManager();\n         // FIXME: check for duplicate ORDER BY clause?\n-        Query jpaQuery = em.createQuery(sort != null ? findQuery + toOrderBy(sort) : findQuery);\n+        Query jpaQuery;\n+        if (isNamedQuery(query)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/4f86bd853ad27e1e24478ebb8bf1fbfd2bda8e75", "committedDate": "2020-03-26T14:41:36Z", "message": "feat: JPA named query\n\nFixes #3483"}, "afterCommit": {"oid": "051f3cfb9b3d140f4de1647817df0c63c9868f8a", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/051f3cfb9b3d140f4de1647817df0c63c9868f8a", "committedDate": "2020-03-27T10:38:17Z", "message": "feat: JPA named query\n\nFixes #3483"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbd2dda8f37c07ffd8ca07c8df992f5c66d8a8d8", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/bbd2dda8f37c07ffd8ca07c8df992f5c66d8a8d8", "committedDate": "2020-04-01T09:02:11Z", "message": "feat: JPA named query\n\nFixes #3483"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfeb417ef990f984ed29dfd192a4cc6d9ae71fb6", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/cfeb417ef990f984ed29dfd192a4cc6d9ae71fb6", "committedDate": "2020-04-01T09:01:26Z", "message": "Scoping : check that the named query is defined on the JPA entity"}, "afterCommit": {"oid": "58c364d9d9871834f0ee6feec96ad6f78dc2f558", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/58c364d9d9871834f0ee6feec96ad6f78dc2f558", "committedDate": "2020-04-01T09:05:21Z", "message": "Scoping : check that the named query is defined on the JPA entity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTA3MDI2", "url": "https://github.com/quarkusio/quarkus/pull/8071#pullrequestreview-387107026", "createdAt": "2020-04-03T09:42:22Z", "commit": {"oid": "58c364d9d9871834f0ee6feec96ad6f78dc2f558"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwOTo0MjoyM1rOGAOK1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwOTo0MjoyM1rOGAOK1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4NTMzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            or on one of it's super classes.\n          \n          \n            \n            or on one of its super classes.", "url": "https://github.com/quarkusio/quarkus/pull/8071#discussion_r402885333", "createdAt": "2020-04-03T09:42:23Z", "author": {"login": "FroMage"}, "path": "docs/src/main/asciidoc/hibernate-orm-panache.adoc", "diffHunk": "@@ -518,6 +518,31 @@ Order.find(\"select distinct o from Order o left join fetch o.lineItems\");\n Order.update(\"update from Person set name = 'Mortal' where status = ?\", Status.Alive);\n ----\n \n+=== Named queries\n+\n+You can reference a named query instead of a (simplified) HQL query by prefixing its name with the '#' character.\n+\n+[source,java]\n+----\n+@Entity\n+@NamedQuery(name = \"Person.getByName\", query = \"from Person where name = :name\")\n+public class Person extends PanacheEntity {\n+    public String name;\n+    public LocalDate birth;\n+    public Status status;\n+\n+    public static Person findByName(String name){\n+        return find(\"#Person.getByName\", name).firstResult();\n+    }\n+}\n+----\n+\n+[WARNING]\n+====\n+Named queries can only be defined inside your JPA entity classes (being the Panache entity class, or the repository parameterized type),\n+or on one of it's super classes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c364d9d9871834f0ee6feec96ad6f78dc2f558"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59384e27e753be751e6e194cc63fc3ea1257a5e5", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/59384e27e753be751e6e194cc63fc3ea1257a5e5", "committedDate": "2020-04-03T10:38:29Z", "message": "Scoping : check that the named query is defined on the JPA entity"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "666b29ba668c2016df16b37e2130cb92af18171f", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/666b29ba668c2016df16b37e2130cb92af18171f", "committedDate": "2020-04-03T09:56:54Z", "message": "Update docs/src/main/asciidoc/hibernate-orm-panache.adoc\n\nCo-Authored-By: St\u00e9phane \u00c9pardaud <stef@inforealm.org>"}, "afterCommit": {"oid": "59384e27e753be751e6e194cc63fc3ea1257a5e5", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/59384e27e753be751e6e194cc63fc3ea1257a5e5", "committedDate": "2020-04-03T10:38:29Z", "message": "Scoping : check that the named query is defined on the JPA entity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MjE1NjQ5", "url": "https://github.com/quarkusio/quarkus/pull/8071#pullrequestreview-387215649", "createdAt": "2020-04-03T12:36:58Z", "commit": {"oid": "59384e27e753be751e6e194cc63fc3ea1257a5e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3567, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}