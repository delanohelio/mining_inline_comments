{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MDMwMjcw", "number": 6830, "title": "Throw a DefinitionException when non-producer method is annotated with a stereotype", "bodyText": "\u2026h a stereotype\nBased on discussion in #6819", "createdAt": "2020-01-28T14:02:02Z", "url": "https://github.com/quarkusio/quarkus/pull/6830", "merged": true, "mergeCommit": {"oid": "3b8d255046bb4532d7959bd61b9a3a794a16dd6c"}, "closed": true, "closedAt": "2020-02-13T10:04:36Z", "author": {"login": "jmartisk"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-x70NgFqTM0OTM5NzcyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB9wjfgBqjMwMTczNDM5MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5Mzk3NzIx", "url": "https://github.com/quarkusio/quarkus/pull/6830#pullrequestreview-349397721", "createdAt": "2020-01-28T14:05:57Z", "commit": {"oid": "7bb7491b485f3ae99cb97e3bf08bb2595b78da64"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNDowNTo1N1rOFimILw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNDowNzo1MlrOFimMfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgyMDU5MQ==", "bodyText": "I don't think that we need to store this map in a field. It could be just a local variable inside the findBeans() method. WDYT?", "url": "https://github.com/quarkusio/quarkus/pull/6830#discussion_r371820591", "createdAt": "2020-01-28T14:05:57Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanDeployment.java", "diffHunk": "@@ -64,6 +64,9 @@\n \n     private final Map<DotName, StereotypeInfo> stereotypes;\n \n+    // excluding additional BeanDefiningAnnotations\n+    private final Map<DotName, StereotypeInfo> realStereotypes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bb7491b485f3ae99cb97e3bf08bb2595b78da64"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTgyMTY5Mg==", "bodyText": "I'd move this logic here: https://github.com/quarkusio/quarkus/blob/master/independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanDeployment.java#L660 (to verify the inherited methods as well).", "url": "https://github.com/quarkusio/quarkus/pull/6830#discussion_r371821692", "createdAt": "2020-01-28T14:07:52Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanDeployment.java", "diffHunk": "@@ -638,9 +644,21 @@ static ScopeInfo getValidScope(Collection<ScopeInfo> stereotypeScopes, Annotatio\n                                 beanClass);\n                         beanClasses.add(beanClass);\n                     }\n-                } else if (annotationStore.hasAnnotation(method, DotNames.DISPOSES)) {\n-                    // Disposers are not inherited\n-                    disposerMethods.add(method);\n+                } else {\n+                    // Verify that non-producer methods are not annotated with stereotypes\n+                    // only account for 'real' stereotypes that are not additional BeanDefiningAnnotations\n+                    for (AnnotationInstance i : annotationStore.getAnnotations(method)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bb7491b485f3ae99cb97e3bf08bb2595b78da64"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7bb7491b485f3ae99cb97e3bf08bb2595b78da64", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/7bb7491b485f3ae99cb97e3bf08bb2595b78da64", "committedDate": "2020-01-28T13:57:04Z", "message": "Throw a DefinitionException when non-producer method is annotated with a stereotype"}, "afterCommit": {"oid": "d51947b4e2628442db8c9ee3a1106f16cdb39dd1", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/d51947b4e2628442db8c9ee3a1106f16cdb39dd1", "committedDate": "2020-01-29T05:47:51Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d51947b4e2628442db8c9ee3a1106f16cdb39dd1", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/d51947b4e2628442db8c9ee3a1106f16cdb39dd1", "committedDate": "2020-01-29T05:47:51Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}, "afterCommit": {"oid": "5b5fed06709b5cd960f2007fd32d2c06169b24ce", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/5b5fed06709b5cd960f2007fd32d2c06169b24ce", "committedDate": "2020-01-30T07:27:01Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b5fed06709b5cd960f2007fd32d2c06169b24ce", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/5b5fed06709b5cd960f2007fd32d2c06169b24ce", "committedDate": "2020-01-30T07:27:01Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}, "afterCommit": {"oid": "a58742be620b3cbd04dee6f34a1dfc5f75aee1a5", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/a58742be620b3cbd04dee6f34a1dfc5f75aee1a5", "committedDate": "2020-02-03T09:46:08Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNTQ3NDQ0", "url": "https://github.com/quarkusio/quarkus/pull/6830#pullrequestreview-353547444", "createdAt": "2020-02-05T08:51:49Z", "commit": {"oid": "a58742be620b3cbd04dee6f34a1dfc5f75aee1a5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODo1MTo1MFrOFlv0-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODo1MTo1MFrOFlv0-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEyNTI0MA==", "bodyText": "I think that we should also verify that a stereotype can be declared on a producer method/field...", "url": "https://github.com/quarkusio/quarkus/pull/6830#discussion_r375125240", "createdAt": "2020-02-05T08:51:50Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/tests/src/test/java/io/quarkus/arc/test/validation/StereotypeOnMethodTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package io.quarkus.arc.test.validation;\n+\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import io.quarkus.arc.test.ArcTestContainer;\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.inject.Stereotype;\n+import javax.enterprise.inject.spi.DefinitionException;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+public class StereotypeOnMethodTest {\n+\n+    @RegisterExtension\n+    public ArcTestContainer container = ArcTestContainer.builder()\n+            .beanClasses(BeanWithStereotypeOnMethod.class, Audited.class)\n+            .shouldFail()\n+            .build();\n+\n+    /**\n+     * Verify that DefinitionException is thrown if there is a stereotype applied on a non-producer method.\n+     */\n+    @Test\n+    public void testStereotypeOnNonProducerMethod() {\n+        Throwable error = container.getFailure();\n+        assertNotNull(error);\n+        assertTrue(error instanceof DefinitionException);\n+        assertTrue(error.getMessage().contains(\"auditedMethod\"));\n+    }\n+\n+    @ApplicationScoped\n+    static class BeanWithStereotypeOnMethod {\n+\n+        @Audited\n+        public void auditedMethod() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a58742be620b3cbd04dee6f34a1dfc5f75aee1a5"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a58742be620b3cbd04dee6f34a1dfc5f75aee1a5", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/a58742be620b3cbd04dee6f34a1dfc5f75aee1a5", "committedDate": "2020-02-03T09:46:08Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}, "afterCommit": {"oid": "082f539a52ddead472cfca8d5002ac6cef2b1d1a", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/082f539a52ddead472cfca8d5002ac6cef2b1d1a", "committedDate": "2020-02-06T12:09:33Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NDcwMzI5", "url": "https://github.com/quarkusio/quarkus/pull/6830#pullrequestreview-354470329", "createdAt": "2020-02-06T14:01:57Z", "commit": {"oid": "082f539a52ddead472cfca8d5002ac6cef2b1d1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a1294d3221787c7d22ca794cfedd05d4fa040d", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/b4a1294d3221787c7d22ca794cfedd05d4fa040d", "committedDate": "2020-02-07T11:37:06Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "082f539a52ddead472cfca8d5002ac6cef2b1d1a", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/082f539a52ddead472cfca8d5002ac6cef2b1d1a", "committedDate": "2020-02-06T12:09:33Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}, "afterCommit": {"oid": "b4a1294d3221787c7d22ca794cfedd05d4fa040d", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/b4a1294d3221787c7d22ca794cfedd05d4fa040d", "committedDate": "2020-02-07T11:37:06Z", "message": "Throw a DefinitionException when non-producer method/field is annotated with a stereotype"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 169, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}