{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMTg0ODk3", "number": 11217, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo0MjoxNVrOEVW6yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo1MDozN1rOEVXE0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwODMxMDQ4OnYy", "diffSide": "RIGHT", "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanDeployment.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo0MjoxNVrOG8EHeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo1NzoxMFrOG8EjQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTE5Mg==", "bodyText": "Wondering if we should make beans a LinkedHashSet instead? Not sure how iterating on the bean list for each synthetic bean will slow us down at bootstrap for large number of beans.", "url": "https://github.com/quarkusio/quarkus/pull/11217#discussion_r465635192", "createdAt": "2020-08-05T10:42:15Z", "author": {"login": "gsmet"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanDeployment.java", "diffHunk": "@@ -966,6 +966,13 @@ private RegistrationContext registerSyntheticBeans(List<BeanRegistrar> beanRegis\n     }\n \n     private void addSyntheticBean(BeanInfo bean) {\n+        for (BeanInfo b : beans) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edb01354f80f0d5cb72ccd885a9eafc67f2cd859"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0MjMwNQ==", "bodyText": "Hm, we do iterate over all beans quite often and since a typical quarkus apps will have hundreds of beans at most I don't think it's worth the effort...", "url": "https://github.com/quarkusio/quarkus/pull/11217#discussion_r465642305", "createdAt": "2020-08-05T10:57:10Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanDeployment.java", "diffHunk": "@@ -966,6 +966,13 @@ private RegistrationContext registerSyntheticBeans(List<BeanRegistrar> beanRegis\n     }\n \n     private void addSyntheticBean(BeanInfo bean) {\n+        for (BeanInfo b : beans) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTE5Mg=="}, "originalCommit": {"oid": "edb01354f80f0d5cb72ccd885a9eafc67f2cd859"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwODMyMDk3OnYy", "diffSide": "RIGHT", "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo0NTo1MFrOG8EN3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMTowMDozM1rOG8Eprw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNjgyOA==", "bodyText": "I'm surprised by the ifFalse here?", "url": "https://github.com/quarkusio/quarkus/pull/11217#discussion_r465636828", "createdAt": "2020-08-05T10:45:50Z", "author": {"login": "gsmet"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanGenerator.java", "diffHunk": "@@ -1606,6 +1614,36 @@ protected void implementGetIdentifier(BeanInfo bean, ClassCreator beanCreator) {\n         getScope.returnValue(getScope.load(bean.getIdentifier()));\n     }\n \n+    protected void implementEquals(BeanInfo bean, ClassCreator beanCreator) {\n+        MethodCreator equals = beanCreator.getMethodCreator(\"equals\", boolean.class, Object.class).setModifiers(ACC_PUBLIC);\n+        // if (this == obj) {\n+        //    return true;\n+        // }\n+        equals.ifFalse(equals.invokeStaticMethod(MethodDescriptors.OBJECTS_REFERENCE_EQUALS, equals.getThis(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edb01354f80f0d5cb72ccd885a9eafc67f2cd859"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0Mzk1MQ==", "bodyText": "Great catch! ;-)", "url": "https://github.com/quarkusio/quarkus/pull/11217#discussion_r465643951", "createdAt": "2020-08-05T11:00:33Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/processor/src/main/java/io/quarkus/arc/processor/BeanGenerator.java", "diffHunk": "@@ -1606,6 +1614,36 @@ protected void implementGetIdentifier(BeanInfo bean, ClassCreator beanCreator) {\n         getScope.returnValue(getScope.load(bean.getIdentifier()));\n     }\n \n+    protected void implementEquals(BeanInfo bean, ClassCreator beanCreator) {\n+        MethodCreator equals = beanCreator.getMethodCreator(\"equals\", boolean.class, Object.class).setModifiers(ACC_PUBLIC);\n+        // if (this == obj) {\n+        //    return true;\n+        // }\n+        equals.ifFalse(equals.invokeStaticMethod(MethodDescriptors.OBJECTS_REFERENCE_EQUALS, equals.getThis(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNjgyOA=="}, "originalCommit": {"oid": "edb01354f80f0d5cb72ccd885a9eafc67f2cd859"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwODMzNDMwOnYy", "diffSide": "RIGHT", "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/ComputingCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo1MDowNlrOG8EWKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMTowMzo0NlrOG8Ev2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzODk1Mw==", "bodyText": "Could we avoid the lambda in runtime code?", "url": "https://github.com/quarkusio/quarkus/pull/11217#discussion_r465638953", "createdAt": "2020-08-05T10:50:06Z", "author": {"login": "gsmet"}, "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/ComputingCache.java", "diffHunk": "@@ -21,18 +22,42 @@\n public class ComputingCache<K, V> {\n \n     private final ConcurrentMap<K, LazyValue<V>> map;\n+    private final Function<K, V> computingFunction;\n \n-    private final Function<K, LazyValue<V>> function;\n+    /**\n+     * Note that {@link #getValue(Object)} cannot be used if no default computing function is specified.\n+     */\n+    public ComputingCache() {\n+        this(null);\n+    }\n \n     public ComputingCache(Function<K, V> computingFunction) {\n         this.map = new ConcurrentHashMap<>();\n-        this.function = new CacheFunction(computingFunction);\n+        this.computingFunction = computingFunction;\n     }\n \n     public V getValue(K key) {\n+        return computeIfAbsent(key, computingFunction);\n+    }\n+\n+    public V getValueIfPresent(K key) {\n+        LazyValue<V> value = map.get(key);\n+        return value != null ? value.getIfPresent() : null;\n+    }\n+\n+    public V computeIfAbsent(K key,\n+            Function<? super K, ? extends V> computingFunction) {\n+        return computeIfAbsent(key, () -> computingFunction.apply(key));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edb01354f80f0d5cb72ccd885a9eafc67f2cd859"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0NTUyOQ==", "bodyText": "Of course we could ;-). Although we used lambdas even before this PR...", "url": "https://github.com/quarkusio/quarkus/pull/11217#discussion_r465645529", "createdAt": "2020-08-05T11:03:46Z", "author": {"login": "mkouba"}, "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/ComputingCache.java", "diffHunk": "@@ -21,18 +22,42 @@\n public class ComputingCache<K, V> {\n \n     private final ConcurrentMap<K, LazyValue<V>> map;\n+    private final Function<K, V> computingFunction;\n \n-    private final Function<K, LazyValue<V>> function;\n+    /**\n+     * Note that {@link #getValue(Object)} cannot be used if no default computing function is specified.\n+     */\n+    public ComputingCache() {\n+        this(null);\n+    }\n \n     public ComputingCache(Function<K, V> computingFunction) {\n         this.map = new ConcurrentHashMap<>();\n-        this.function = new CacheFunction(computingFunction);\n+        this.computingFunction = computingFunction;\n     }\n \n     public V getValue(K key) {\n+        return computeIfAbsent(key, computingFunction);\n+    }\n+\n+    public V getValueIfPresent(K key) {\n+        LazyValue<V> value = map.get(key);\n+        return value != null ? value.getIfPresent() : null;\n+    }\n+\n+    public V computeIfAbsent(K key,\n+            Function<? super K, ? extends V> computingFunction) {\n+        return computeIfAbsent(key, () -> computingFunction.apply(key));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzODk1Mw=="}, "originalCommit": {"oid": "edb01354f80f0d5cb72ccd885a9eafc67f2cd859"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwODMzNjE3OnYy", "diffSide": "RIGHT", "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/AbstractSharedContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo1MDozN1rOG8EXQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMDo1MDozN1rOG8EXQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzOTIzNA==", "bodyText": "Could we avoid the lambda in runtime code?", "url": "https://github.com/quarkusio/quarkus/pull/11217#discussion_r465639234", "createdAt": "2020-08-05T10:50:37Z", "author": {"login": "gsmet"}, "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/AbstractSharedContext.java", "diffHunk": "@@ -5,30 +5,31 @@\n import io.quarkus.arc.InjectableContext;\n import java.util.Iterator;\n import java.util.Map;\n-import java.util.Objects;\n import java.util.Set;\n import java.util.stream.Collectors;\n import javax.enterprise.context.spi.Contextual;\n import javax.enterprise.context.spi.CreationalContext;\n \n abstract class AbstractSharedContext implements InjectableContext, InjectableContext.ContextState {\n \n-    private final ComputingCache<Key<?>, ContextInstanceHandle<?>> instances;\n+    private final ComputingCache<String, ContextInstanceHandle<?>> instances;\n \n     public AbstractSharedContext() {\n-        this.instances = new ComputingCache<>(AbstractSharedContext::createInstanceHandle);\n+        this.instances = new ComputingCache<>();\n     }\n \n     @SuppressWarnings(\"unchecked\")\n     @Override\n     public <T> T get(Contextual<T> contextual, CreationalContext<T> creationalContext) {\n-        return (T) instances.getValue(new Key<>(contextual, creationalContext)).get();\n+        InjectableBean<T> bean = (InjectableBean<T>) contextual;\n+        return (T) instances.computeIfAbsent(bean.getIdentifier(), () -> createInstanceHandle(bean, creationalContext)).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edb01354f80f0d5cb72ccd885a9eafc67f2cd859"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 675, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}