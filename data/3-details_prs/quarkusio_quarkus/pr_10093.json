{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NDY1ODk0", "number": 10093, "title": "Add debug symbols support #9792", "bodyText": "Closes #9792.\nThis PR adds:\n\nA new debug symbol enable option called quarkus.native.debug.enabled.\nA new option has been added instead of breaking existing users that might rely on quarkus.native.debugSymbols flag. This flag adds -g to the native-image invocation which is a GraalVM EE only flag. Should it eventually deprecated?\nAfter creating the native image, if objcopy is found, it uses it to split the debug symbols from the binary executable. The debug symbols are put in a file called <executable>.debug at the same level as the binary.\nThis new option is disabled by default. See quarkus-dev discussion for details.\n\nQ. What can I debug with this?\n\nUser code in Quarkus project.\nJDK code.\nSome of the com.oracle.svm code.\n\nQ. What can't I debug?\n\nLibrary dependencies. Further work on Quarkus build code needs to be done to enable source jars to be found. I'll create a follow up issue for this. See #10094.\norg.graalvm code. Some sources are missing from latest GraalVM CE downloads. @adinn already spotted this and reported it in oracle/graal#2551.\n\nQ. What I do need to do native debugging?\n\ngdb version 8.x or 9.x. I tried with 7.6 but gdb itself gave me a segmentation fault (working with @adinn to figure out what's wrong there).\n(optional) emacs so that you can have nice integration between gdb and source navigation.\n\nQ. Can I give this a try?\nSure!\nI've been using this sample project called debug-info to test things out. This is how it works:\n\nBuild this Quarkus branch locally.\nGo into debug-info project and call (assumes you're using GraalVM CE 20.1.0 as JAVA_HOME):\n\n./mvnw clean package -DskipTests \\\n\t-Pnative \\\n\t-Dquarkus.platform.version=999-SNAPSHOT \\\n\t-Dquarkus-plugin.version=999-SNAPSHOT \\\n\t-Dquarkus.platform.artifact-id=quarkus-bom \\\n\t-Dquarkus.native.debug.enabled=true\n\n\nFire up emacs (or any other tool that has gdb integration) from the root of the project.\nCall M-x gud-gdb\nSet directories for source lookup: set directories ../src/main/java:debug-info-1.0.0-SNAPSHOT-native-image-source-jar/sources/graal:debug-info-1.0.0-SNAPSHOT-native-image-source-jar/sources/jdk\nInvoke gdb: gdb --fullname target/debug-info-1.0.0-SNAPSHOT-runner\nVerify that debug symbols are present, e.g. info func greeting\nPut a breakpoint in the code, e.g. break debug.info.GreetingService::greeting\nMake gdb execute the program, e.g. run\nFrom a separate shell exercise the app, e.g. curl localhost:8080/hello/greeting/quarkus. The debugger should stop in the breakpoint.\nType s or n to jump around the code.", "createdAt": "2020-06-18T13:15:18Z", "url": "https://github.com/quarkusio/quarkus/pull/10093", "merged": true, "mergeCommit": {"oid": "63fe9361c5e385479ecc53ce10a9f68253ece2da"}, "closed": true, "closedAt": "2020-07-01T10:48:46Z", "author": {"login": "galderz"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsbjTkgH2gAyNDM2NDY1ODk0OmUyZmZkNjY4ZWRlYzhmYjI1ZTRlNDNiYTZjMTliMGFiNzEyYzU1NDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwX1KiAFqTQ0MDE2NDQ4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e2ffd668edec8fb25e4e43ba6c19b0ab712c5547", "author": {"user": {"login": "galderz", "name": "Galder Zamarre\u00f1o"}}, "url": "https://github.com/quarkusio/quarkus/commit/e2ffd668edec8fb25e4e43ba6c19b0ab712c5547", "committedDate": "2020-06-18T10:04:45Z", "message": "Add debug symbols support #9792\n\n* Added new debug symbol enable option,\nto avoid breaking existing usage.\n* Used objcopy to split debug symbols from binary."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMzA4MTMx", "url": "https://github.com/quarkusio/quarkus/pull/10093#pullrequestreview-433308131", "createdAt": "2020-06-18T13:55:28Z", "commit": {"oid": "e2ffd668edec8fb25e4e43ba6c19b0ab712c5547"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzo1NToyOFrOGlwepA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzo1NToyOFrOGlwepA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI0NDc3Mg==", "bodyText": "I'd suggest to run this objcopy(\"--strip-debug\", executable.toString()); also when no debug symbols are being requested.  The reason for this is that OpenJDK's static libraries might contain debug symbols which in turn might end up in the native image binary and you could get rid of them in the produced native image by stripping them via objcopy --strip-debug.", "url": "https://github.com/quarkusio/quarkus/pull/10093#discussion_r442244772", "createdAt": "2020-06-18T13:55:28Z", "author": {"login": "jerboaa"}, "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java", "diffHunk": "@@ -528,4 +535,48 @@ private static String testGCCArgument(String argument) {\n         return \"\";\n     }\n \n+    private boolean objcopyExists(Map<String, String> env) {\n+        // System path\n+        String systemPath = env.get(PATH);\n+        if (systemPath != null) {\n+            String[] pathDirs = systemPath.split(File.pathSeparator);\n+            for (String pathDir : pathDirs) {\n+                File dir = new File(pathDir);\n+                if (dir.isDirectory()) {\n+                    File file = new File(dir, \"objcopy\");\n+                    if (file.exists()) {\n+                        return true;\n+                    }\n+                }\n+            }\n+        }\n+\n+        log.info(\"Cannot find executable (objcopy) to separate symbols from executable.\");\n+        return false;\n+    }\n+\n+    private void splitDebugSymbols(Path executable) {\n+        Path symbols = Paths.get(String.format(\"%s.debug\", executable.toString()));\n+        objcopy(\"--only-keep-debug\", executable.toString(), symbols.toString());\n+        objcopy(\"--strip-debug\", executable.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2ffd668edec8fb25e4e43ba6c19b0ab712c5547"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NjcyNzc4", "url": "https://github.com/quarkusio/quarkus/pull/10093#pullrequestreview-436672778", "createdAt": "2020-06-24T13:57:46Z", "commit": {"oid": "a6818d42867ff45a7209cc8f9c915c18f77366c9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxMzo1Nzo0NlrOGoTW3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxMzo1Nzo0NlrOGoTW3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDkxMzM3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            // Strip debug symbols regardless, because the the underlying JDK might contain them\n          \n          \n            \n                            // Strip debug symbols regardless, because the underlying JDK might contain them", "url": "https://github.com/quarkusio/quarkus/pull/10093#discussion_r444913374", "createdAt": "2020-06-24T13:57:46Z", "author": {"login": "gsmet"}, "path": "core/deployment/src/main/java/io/quarkus/deployment/pkg/steps/NativeImageBuildStep.java", "diffHunk": "@@ -359,6 +359,14 @@ public NativeImageBuildItem build(NativeConfig nativeConfig, NativeImageSourceJa\n             Files.delete(generatedImage);\n             System.setProperty(\"native.image.path\", finalPath.toAbsolutePath().toString());\n \n+            if (objcopyExists(env)) {\n+                if (nativeConfig.debug.enabled) {\n+                    splitDebugSymbols(finalPath);\n+                }\n+                // Strip debug symbols regardless, because the the underlying JDK might contain them", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6818d42867ff45a7209cc8f9c915c18f77366c9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cacbb23ff20014aefef27db0561f0ff995d95258", "author": {"user": {"login": "galderz", "name": "Galder Zamarre\u00f1o"}}, "url": "https://github.com/quarkusio/quarkus/commit/cacbb23ff20014aefef27db0561f0ff995d95258", "committedDate": "2020-06-30T08:08:28Z", "message": "Strip debug symbols regardless #9792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee7b838b9929df19ca83565e16e102c30fe5c815", "author": {"user": {"login": "galderz", "name": "Galder Zamarre\u00f1o"}}, "url": "https://github.com/quarkusio/quarkus/commit/ee7b838b9929df19ca83565e16e102c30fe5c815", "committedDate": "2020-06-30T08:08:28Z", "message": "Removed old debugSymbols option (only applies to EE) #9792"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6818d42867ff45a7209cc8f9c915c18f77366c9", "author": {"user": {"login": "galderz", "name": "Galder Zamarre\u00f1o"}}, "url": "https://github.com/quarkusio/quarkus/commit/a6818d42867ff45a7209cc8f9c915c18f77366c9", "committedDate": "2020-06-22T10:02:20Z", "message": "Removed old debugSymbols option (only applies to EE) #9792"}, "afterCommit": {"oid": "ee7b838b9929df19ca83565e16e102c30fe5c815", "author": {"user": {"login": "galderz", "name": "Galder Zamarre\u00f1o"}}, "url": "https://github.com/quarkusio/quarkus/commit/ee7b838b9929df19ca83565e16e102c30fe5c815", "committedDate": "2020-06-30T08:08:28Z", "message": "Removed old debugSymbols option (only applies to EE) #9792"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMTY0NDg4", "url": "https://github.com/quarkusio/quarkus/pull/10093#pullrequestreview-440164488", "createdAt": "2020-06-30T16:00:20Z", "commit": {"oid": "ee7b838b9929df19ca83565e16e102c30fe5c815"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4264, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}