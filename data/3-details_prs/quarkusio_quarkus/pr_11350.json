{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2ODE3NTgy", "number": 11350, "title": "Introduce AutoAddScopeBuildItem to remove boilerplate necessary when annotation transformers are used to add a scope annotation to a class", "bodyText": "...annotation transformers are used to add a scope annotation to a class\n\nalso fixes #11340", "createdAt": "2020-08-12T14:43:02Z", "url": "https://github.com/quarkusio/quarkus/pull/11350", "merged": true, "mergeCommit": {"oid": "a644d46b5d143c22ad956a27bbd12d0454e26df1"}, "closed": true, "closedAt": "2020-08-13T16:25:53Z", "author": {"login": "mkouba"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-PBcCAFqTQ2NjEzNDE0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-ikN1gFqTQ2NjkyMjU5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTM0MTQx", "url": "https://github.com/quarkusio/quarkus/pull/11350#pullrequestreview-466134141", "createdAt": "2020-08-12T17:39:31Z", "commit": {"oid": "85ce4a8dbfb40d3be8bed7b7220a9cd2c525a600"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzozOTozMlrOG_ru9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNzozOTozMlrOG_ru9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQzMDAwNg==", "bodyText": "It might be a stupid question and sorry if it's the case but should we also detect the lifecycle annotations? You might not have anything injected but a @PostConstruct?", "url": "https://github.com/quarkusio/quarkus/pull/11350#discussion_r469430006", "createdAt": "2020-08-12T17:39:32Z", "author": {"login": "gsmet"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/AutoAddScopeBuildItem.java", "diffHunk": "@@ -0,0 +1,241 @@\n+package io.quarkus.arc.deployment;\n+\n+import java.util.Collection;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.ClassInfo;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.IndexView;\n+\n+import io.quarkus.arc.processor.Annotations;\n+import io.quarkus.arc.processor.BuiltinScope;\n+import io.quarkus.arc.processor.DotNames;\n+import io.quarkus.builder.item.MultiBuildItem;\n+\n+/**\n+ * This build item can be used to turn a class that is not annotated with a CDI scope annotation into a bean, i.e. the default\n+ * scope annotation is added automatically if conditions are met.\n+ */\n+public final class AutoAddScopeBuildItem extends MultiBuildItem {\n+\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    private final MatchPredicate matchPredicate;\n+    private final boolean injectable;\n+    private final DotName defaultScope;\n+    private final boolean unremovable;\n+    private final String reason;\n+\n+    private AutoAddScopeBuildItem(MatchPredicate matchPredicate, boolean injectable,\n+            DotName defaultScope, boolean unremovable, String reason) {\n+        this.matchPredicate = matchPredicate;\n+        this.injectable = injectable;\n+        this.defaultScope = defaultScope;\n+        this.unremovable = unremovable;\n+        this.reason = reason;\n+    }\n+\n+    public boolean isInjectable() {\n+        return injectable;\n+    }\n+\n+    public DotName getDefaultScope() {\n+        return defaultScope;\n+    }\n+\n+    public boolean isUnremovable() {\n+        return unremovable;\n+    }\n+\n+    public String getReason() {\n+        return reason != null ? \": \" + reason : \"\";\n+    }\n+\n+    public boolean test(ClassInfo clazz, Collection<AnnotationInstance> annotations, IndexView index) {\n+        return matchPredicate.test(clazz, annotations, index);\n+    }\n+\n+    public interface MatchPredicate {\n+\n+        /**\n+         * @param clazz\n+         * @param annotations\n+         * @param index\n+         * @return {@code true} if the input arguments match the predicate,\n+         *         otherwise {@code false}\n+         */\n+        boolean test(ClassInfo clazz, Collection<AnnotationInstance> annotations, IndexView index);\n+\n+        default MatchPredicate and(MatchPredicate other) {\n+            return new MatchPredicate() {\n+                @Override\n+                public boolean test(ClassInfo clazz, Collection<AnnotationInstance> annotations, IndexView index) {\n+                    return test(clazz, annotations, index) && other.test(clazz, annotations, index);\n+                }\n+            };\n+        }\n+\n+    }\n+\n+    public static class Builder {\n+\n+        private MatchPredicate matchPredicate;\n+        private boolean injectable;\n+        private DotName defaultScope;\n+        private boolean unremovable;\n+        private String reason;\n+\n+        private Builder() {\n+            this.defaultScope = BuiltinScope.DEPENDENT.getName();\n+            this.unremovable = false;\n+            this.injectable = false;\n+        }\n+\n+        /**\n+         * At least one injection point must be declared in the class hierarchy. Otherwise, the scope annotation is not added.\n+         * \n+         * @return self\n+         */\n+        public Builder hasInjectionPoint() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85ce4a8dbfb40d3be8bed7b7220a9cd2c525a600"}, "originalPosition": 101}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "85ce4a8dbfb40d3be8bed7b7220a9cd2c525a600", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/85ce4a8dbfb40d3be8bed7b7220a9cd2c525a600", "committedDate": "2020-08-12T14:41:45Z", "message": "Introduce AutoAddScopeBuildItem to remove boilerplate necessary when...\n\n...annotation transformers are used to add a scope annotation to a class\n- also fixes #11340"}, "afterCommit": {"oid": "dc6a24c8ee182b4b0f3594ba63b1b4ce3f4476d5", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/dc6a24c8ee182b4b0f3594ba63b1b4ce3f4476d5", "committedDate": "2020-08-13T06:54:16Z", "message": "Introduce AutoAddScopeBuildItem to remove boilerplate necessary when...\n\n...annotation transformers are used to add a scope annotation to a class\n- also fixes #11340"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NTU3OTQz", "url": "https://github.com/quarkusio/quarkus/pull/11350#pullrequestreview-466557943", "createdAt": "2020-08-13T08:40:10Z", "commit": {"oid": "dc6a24c8ee182b4b0f3594ba63b1b4ce3f4476d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a80d0eaee0f0ee17ffc32e5b987915b5d45d14c", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/0a80d0eaee0f0ee17ffc32e5b987915b5d45d14c", "committedDate": "2020-08-13T10:48:16Z", "message": "Introduce AutoAddScopeBuildItem to remove boilerplate necessary when...\n\n...annotation transformers are used to add a scope annotation to a class\n- also fixes #11340"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc6a24c8ee182b4b0f3594ba63b1b4ce3f4476d5", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/dc6a24c8ee182b4b0f3594ba63b1b4ce3f4476d5", "committedDate": "2020-08-13T06:54:16Z", "message": "Introduce AutoAddScopeBuildItem to remove boilerplate necessary when...\n\n...annotation transformers are used to add a scope annotation to a class\n- also fixes #11340"}, "afterCommit": {"oid": "0a80d0eaee0f0ee17ffc32e5b987915b5d45d14c", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/0a80d0eaee0f0ee17ffc32e5b987915b5d45d14c", "committedDate": "2020-08-13T10:48:16Z", "message": "Introduce AutoAddScopeBuildItem to remove boilerplate necessary when...\n\n...annotation transformers are used to add a scope annotation to a class\n- also fixes #11340"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2OTIyNTkz", "url": "https://github.com/quarkusio/quarkus/pull/11350#pullrequestreview-466922593", "createdAt": "2020-08-13T16:25:43Z", "commit": {"oid": "0a80d0eaee0f0ee17ffc32e5b987915b5d45d14c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 977, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}