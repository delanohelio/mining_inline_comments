{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NzUwNzQ3", "number": 7369, "title": "S2i improvements", "bodyText": "This pull request adds a few tiny improvements:\n\nmake build timeout configurable\nuse a better name for the build archive (it may appear in the logs and docker-xxxx is misleading).\nFallback to oc binary  builds when java client hits stream reset errors.", "createdAt": "2020-02-23T21:05:23Z", "url": "https://github.com/quarkusio/quarkus/pull/7369", "merged": true, "mergeCommit": {"oid": "3f378831cc088d907dafdeb34ddf4bd7e29d6fd8"}, "closed": true, "closedAt": "2020-02-24T17:05:58Z", "author": {"login": "iocanel"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHPclagH2gAyMzc4NzUwNzQ3OmNhZDJmMDc1YTJmNWY5ZWNiYjdiNmYyZTgzOGJjNWVhZWRiZDY4NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHdgwvgH2gAyMzc4NzUwNzQ3OjVlMmE5ZjMxN2UwNjkxNjlhM2VlOWZjYzc5YmI0YWMyZDEzYjJiMTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cad2f075a2f5f9ecbb7b6f2e838bc5eaedbd6876", "author": {"user": {"login": "iocanel", "name": "Ioannis Canellos"}}, "url": "https://github.com/quarkusio/quarkus/commit/cad2f075a2f5f9ecbb7b6f2e838bc5eaedbd6876", "committedDate": "2020-02-23T21:03:21Z", "message": "feat: make s2i build timeout configurable."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03851437c9519113388cf30c7182b335266862d5", "author": {"user": {"login": "iocanel", "name": "Ioannis Canellos"}}, "url": "https://github.com/quarkusio/quarkus/commit/03851437c9519113388cf30c7182b335266862d5", "committedDate": "2020-02-23T21:05:08Z", "message": "feat: fallback to oc start build on stream reset."}, "afterCommit": {"oid": "60c2eb54335c7ddb7662f000fa5e267f081cc74e", "author": {"user": {"login": "iocanel", "name": "Ioannis Canellos"}}, "url": "https://github.com/quarkusio/quarkus/commit/60c2eb54335c7ddb7662f000fa5e267f081cc74e", "committedDate": "2020-02-23T21:09:26Z", "message": "feat: fallback to oc start build on stream reset."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTIyNjY0", "url": "https://github.com/quarkusio/quarkus/pull/7369#pullrequestreview-363122664", "createdAt": "2020-02-23T21:12:36Z", "commit": {"oid": "60c2eb54335c7ddb7662f000fa5e267f081cc74e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QyMToxMjozNlrOFtS1qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QyMToxMjozNlrOFtS1qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAzODg5MA==", "bodyText": "I think we shouldn't use the backquotes here and just use regular ones", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383038890", "createdAt": "2020-02-23T21:12:36Z", "author": {"login": "geoand"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,9 +242,24 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build = null;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the `oc` binary.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60c2eb54335c7ddb7662f000fa5e267f081cc74e"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623", "author": {"user": {"login": "iocanel", "name": "Ioannis Canellos"}}, "url": "https://github.com/quarkusio/quarkus/commit/e2d565de574764f669f189942de7b79fdcdd1623", "committedDate": "2020-02-24T06:19:53Z", "message": "feat: fallback to oc start build on stream reset."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60c2eb54335c7ddb7662f000fa5e267f081cc74e", "author": {"user": {"login": "iocanel", "name": "Ioannis Canellos"}}, "url": "https://github.com/quarkusio/quarkus/commit/60c2eb54335c7ddb7662f000fa5e267f081cc74e", "committedDate": "2020-02-23T21:09:26Z", "message": "feat: fallback to oc start build on stream reset."}, "afterCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623", "author": {"user": {"login": "iocanel", "name": "Ioannis Canellos"}}, "url": "https://github.com/quarkusio/quarkus/commit/e2d565de574764f669f189942de7b79fdcdd1623", "committedDate": "2020-02-24T06:19:53Z", "message": "feat: fallback to oc start build on stream reset."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjAyNjEy", "url": "https://github.com/quarkusio/quarkus/pull/7369#pullrequestreview-363202612", "createdAt": "2020-02-24T07:35:27Z", "commit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjA1NjYw", "url": "https://github.com/quarkusio/quarkus/pull/7369#pullrequestreview-363205660", "createdAt": "2020-02-24T07:45:18Z", "commit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0NToxOFrOFtXjpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0NzowM1rOFtXlwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjE5OQ==", "bodyText": "Are we only using binary s2i? For \"code\" s2i, 5 minutes won't be enough.", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383116199", "createdAt": "2020-02-24T07:45:18Z", "author": {"login": "cescoffier"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iConfig.java", "diffHunk": "@@ -50,6 +51,12 @@\n     @ConfigItem(defaultValue = \"/home/quarkus/application\")\n     public String nativeBinaryPath;\n \n+    /**\n+     * The build timeout.\n+     */\n+    @ConfigItem(defaultValue = \"PT5M\")\n+    Duration buildTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjM1NQ==", "bodyText": "use a logger instead?", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383116355", "createdAt": "2020-02-24T07:45:49Z", "author": {"login": "cescoffier"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,16 +242,31 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the 'oc' binary.\");\n+                if (!ExecUtil.exec(\"oc\", \"start-build\", buildConfig.getMetadata().getName(), \"--from-archive\",\n+                        binaryFile.toPath().toAbsolutePath().toString())) {\n+                    throw s2iException(e);\n+                }\n+                return;\n+            } else {\n+                throw s2iException(e);\n+            }\n+        }\n+\n         try (BufferedReader reader = new BufferedReader(\n                 client.builds().withName(build.getMetadata().getName()).getLogReader())) {\n             for (String line = reader.readLine(); line != null; line = reader.readLine()) {\n                 System.out.println(line);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjczNw==", "bodyText": "Wondering if at some point we should get the oc client from the OpenShift instance. We had incompatibilities in the past and it would avoid having the user install oc.", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383116737", "createdAt": "2020-02-24T07:47:03Z", "author": {"login": "cescoffier"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,16 +242,31 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the 'oc' binary.\");\n+                if (!ExecUtil.exec(\"oc\", \"start-build\", buildConfig.getMetadata().getName(), \"--from-archive\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e2a9f317e069169a3ee9fcc79bb4ac2d13b2b12", "author": {"user": {"login": "iocanel", "name": "Ioannis Canellos"}}, "url": "https://github.com/quarkusio/quarkus/commit/5e2a9f317e069169a3ee9fcc79bb4ac2d13b2b12", "committedDate": "2020-02-24T13:26:35Z", "message": "refactor: use generic artifact names in s2i builds"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4192, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}