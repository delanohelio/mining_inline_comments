{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NjQyNTA4", "number": 7303, "title": "Implement Context Propagation support for Mutiny", "bodyText": "This PR enables the support for Context Propagation when using Mutiny.\nIt includes:\n\na bit of functional code (reactive converters, a small change in the transactional filter...)\na few tests\nITs\ndocumentation update", "createdAt": "2020-02-20T09:26:53Z", "url": "https://github.com/quarkusio/quarkus/pull/7303", "merged": true, "mergeCommit": {"oid": "8edc492e9cf0d37d248d5cd3befb573a273035d9"}, "closed": true, "closedAt": "2020-02-20T19:22:52Z", "author": {"login": "cescoffier"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGH-gNAFqTM2MTc1OTg5Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGND5ZgFqTM2MjAwOTE1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNzU5ODkz", "url": "https://github.com/quarkusio/quarkus/pull/7303#pullrequestreview-361759893", "createdAt": "2020-02-20T09:46:10Z", "commit": {"oid": "6ca9fad6d743bd23d4ef678fb6f453cd816a0acc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOTo0NjoxMFrOFsMnJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOTo0NjoxMFrOFsMnJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg4ODI5Mw==", "bodyText": "Why did you drop this clause? We don't have to convert it if it's a Publisher.", "url": "https://github.com/quarkusio/quarkus/pull/7303#discussion_r381888293", "createdAt": "2020-02-20T09:46:10Z", "author": {"login": "FroMage"}, "path": "extensions/narayana-jta/runtime/src/main/java/io/quarkus/narayana/jta/runtime/interceptor/TransactionalInterceptorBase.java", "diffHunk": "@@ -124,8 +124,7 @@ protected Object invokeInOurTx(InvocationContext ic, TransactionManager tm, Runn\n             // handle asynchronously if not throwing\n             if (!throwing && ret != null) {\n                 ReactiveTypeConverter<Object> converter = null;\n-                if (ret instanceof CompletionStage == false\n-                        && ret instanceof Publisher == false) {\n+                if (ret instanceof CompletionStage == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ca9fad6d743bd23d4ef678fb6f453cd816a0acc"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ca9fad6d743bd23d4ef678fb6f453cd816a0acc", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/6ca9fad6d743bd23d4ef678fb6f453cd816a0acc", "committedDate": "2020-02-20T09:25:12Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}, "afterCommit": {"oid": "57430cb99d303d3e0a98e829d7fe972a4e2dd7b2", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/57430cb99d303d3e0a98e829d7fe972a4e2dd7b2", "committedDate": "2020-02-20T10:42:10Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57430cb99d303d3e0a98e829d7fe972a4e2dd7b2", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/57430cb99d303d3e0a98e829d7fe972a4e2dd7b2", "committedDate": "2020-02-20T10:42:10Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}, "afterCommit": {"oid": "c99c91f0865c4b8f674de9f212552a714ecd7213", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/c99c91f0865c4b8f674de9f212552a714ecd7213", "committedDate": "2020-02-20T10:58:16Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c99c91f0865c4b8f674de9f212552a714ecd7213", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/c99c91f0865c4b8f674de9f212552a714ecd7213", "committedDate": "2020-02-20T10:58:16Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}, "afterCommit": {"oid": "d093bb567b948d053c2d473a87ca63a75123a6cf", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/d093bb567b948d053c2d473a87ca63a75123a6cf", "committedDate": "2020-02-20T12:38:02Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d093bb567b948d053c2d473a87ca63a75123a6cf", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/d093bb567b948d053c2d473a87ca63a75123a6cf", "committedDate": "2020-02-20T12:38:02Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}, "afterCommit": {"oid": "e25a8bf4925b416731632d9eb17fd662523111a1", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/e25a8bf4925b416731632d9eb17fd662523111a1", "committedDate": "2020-02-20T13:07:23Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTMwODU5", "url": "https://github.com/quarkusio/quarkus/pull/7303#pullrequestreview-361930859", "createdAt": "2020-02-20T14:12:10Z", "commit": {"oid": "e25a8bf4925b416731632d9eb17fd662523111a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDoxMjoxMVrOFsUzaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNDoxMjoxMVrOFsUzaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAyMjUwNw==", "bodyText": "Shouldn't it be:\nif(ret instanceof CompletionStage == false\n && (ret instanceof Publisher == false || !ic.getMethod().getReturnType() == Publisher.class))\nYou need to check the method's declared return type, not the instance exact type, which can never be Publisher since it's an interface.\nNote that I wonder if we don't have the same issue with CompletionStage and CompletableFuture. Could you add a test to see what happens if an intercepted method is declared to return a CompletableFuture?", "url": "https://github.com/quarkusio/quarkus/pull/7303#discussion_r382022507", "createdAt": "2020-02-20T14:12:11Z", "author": {"login": "FroMage"}, "path": "extensions/narayana-jta/runtime/src/main/java/io/quarkus/narayana/jta/runtime/interceptor/TransactionalInterceptorBase.java", "diffHunk": "@@ -124,8 +124,7 @@ protected Object invokeInOurTx(InvocationContext ic, TransactionManager tm, Runn\n             // handle asynchronously if not throwing\n             if (!throwing && ret != null) {\n                 ReactiveTypeConverter<Object> converter = null;\n-                if (ret instanceof CompletionStage == false\n-                        && ret instanceof Publisher == false) {\n+                if (ret instanceof CompletionStage == false && !ret.getClass().equals(Publisher.class)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e25a8bf4925b416731632d9eb17fd662523111a1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e21ab2d1ba485a81fc7675214ffb7d4b9ee4eab7", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/e21ab2d1ba485a81fc7675214ffb7d4b9ee4eab7", "committedDate": "2020-02-20T14:38:31Z", "message": "Update Mutiny to 0.4.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b23b1e9976c8903fa259c9720d13df519ccf042", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/2b23b1e9976c8903fa259c9720d13df519ccf042", "committedDate": "2020-02-20T14:38:31Z", "message": "Add the Mutiny Context Propagation dependency to the BOM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11a36194ca261b8ab4df7de935f03116c639cd1a", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/11a36194ca261b8ab4df7de935f03116c639cd1a", "committedDate": "2020-02-20T14:38:31Z", "message": "Add test to verify the failure behavior.\n\nCheck the response is processed correctly when an endpoint fails (intentionally or not)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3facd752f2812dfa8a989768234f0517d94d4d2d", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/3facd752f2812dfa8a989768234f0517d94d4d2d", "committedDate": "2020-02-20T14:38:31Z", "message": "Implement the reactive converters for Uni and Multi\n\nAlso add the SPI to the native image."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd5d8e092b9ef4e43327b5f32ccab932a5034de", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/2bd5d8e092b9ef4e43327b5f32ccab932a5034de", "committedDate": "2020-02-20T14:38:31Z", "message": "Add support for Mutiny in the context propagation extension\n\n* Add the dependency on mutiny-context-propagation\n* Extract the version of the smallrye-reactive-converter-rxjava2 used in context propagation tests\n* Implement tests verifying the context propagation when using resteasy, transactions, servlets and when the returned Unis are created from direct values or from completion stages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acca039c8ab60e0d41eca00edd510dc590168b3b", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/acca039c8ab60e0d41eca00edd510dc590168b3b", "committedDate": "2020-02-20T14:38:31Z", "message": "Improve the Transactional Interceptor to handle other Publisher types\n\nConverters should also be searched for Publisher instances, or you won't be able to re-create the Publisher instance (Flux, Mono, Multi) after the async handling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dac5d32e9a78511c28ea1421945ff5fde715b477", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/dac5d32e9a78511c28ea1421945ff5fde715b477", "committedDate": "2020-02-20T14:38:36Z", "message": "Add integration tests verifying the context propagation with Mutiny"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4029976ee9621fe5f123e6b8699bf06ecce8c31", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/b4029976ee9621fe5f123e6b8699bf06ecce8c31", "committedDate": "2020-02-20T14:38:36Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e25a8bf4925b416731632d9eb17fd662523111a1", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/e25a8bf4925b416731632d9eb17fd662523111a1", "committedDate": "2020-02-20T13:07:23Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}, "afterCommit": {"oid": "b4029976ee9621fe5f123e6b8699bf06ecce8c31", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/b4029976ee9621fe5f123e6b8699bf06ecce8c31", "committedDate": "2020-02-20T14:38:36Z", "message": "Update documentation with the Mutiny / Context propagation support\n\nRemove the example using Reactive Streams Operators (Axle) as this model is now deprecated."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMDA5MTU1", "url": "https://github.com/quarkusio/quarkus/pull/7303#pullrequestreview-362009155", "createdAt": "2020-02-20T15:42:39Z", "commit": {"oid": "b4029976ee9621fe5f123e6b8699bf06ecce8c31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4149, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}