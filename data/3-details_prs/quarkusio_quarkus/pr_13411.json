{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1MDk4MTcz", "number": 13411, "title": "Enable the RequestScope on gRPC service invocations", "bodyText": "Wrap gRPC service invocation with an interceptor enabling / disabling the request scope.\nThe scope is deactivated when the communication is terminated (on cancellation, failure or completion)\nFix #13356 \ufeff", "createdAt": "2020-11-21T08:20:01Z", "url": "https://github.com/quarkusio/quarkus/pull/13411", "merged": true, "mergeCommit": {"oid": "40cd91ee1cc0767f1a0ad50fdec845b6c0ac04e8"}, "closed": true, "closedAt": "2021-01-06T09:06:24Z", "author": {"login": "cescoffier"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfESiEgBqjQwMjUwMjY2NjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtauk7AFqTU2MjM4NDkyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ca1b9c5e96c3504794b6a4e095f74205d34c6cd", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/3ca1b9c5e96c3504794b6a4e095f74205d34c6cd", "committedDate": "2020-11-21T08:18:32Z", "message": "Enable the RequestScope on gRPC service invocations"}, "afterCommit": {"oid": "366d0c55b98231de7c7f52d2696b503a23618988", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/366d0c55b98231de7c7f52d2696b503a23618988", "committedDate": "2020-11-22T17:48:36Z", "message": "Enable the RequestScope on gRPC service invocations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MjMwNjcz", "url": "https://github.com/quarkusio/quarkus/pull/13411#pullrequestreview-536230673", "createdAt": "2020-11-23T07:51:14Z", "commit": {"oid": "366d0c55b98231de7c7f52d2696b503a23618988"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwNzo1MToxNFrOH4CFhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwNzo1MToxNFrOH4CFhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUxNjQ4Ng==", "bodyText": "why is this variable called managed?", "url": "https://github.com/quarkusio/quarkus/pull/13411#discussion_r528516486", "createdAt": "2020-11-23T07:51:14Z", "author": {"login": "michalszynkiewicz"}, "path": "extensions/grpc/runtime/src/main/java/io/quarkus/grpc/runtime/supports/RequestScopeHandlerInterceptor.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package io.quarkus.grpc.runtime.supports;\n+\n+import io.grpc.ForwardingServerCall;\n+import io.grpc.Metadata;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.Status;\n+import io.quarkus.arc.Arc;\n+import io.quarkus.arc.ManagedContext;\n+\n+public class RequestScopeHandlerInterceptor implements ServerInterceptor {\n+\n+    private final ManagedContext reqContext;\n+\n+    public RequestScopeHandlerInterceptor() {\n+        reqContext = Arc.container().requestContext();\n+    }\n+\n+    @Override\n+    public <ReqT, RespT> ServerCall.Listener<ReqT> interceptCall(ServerCall<ReqT, RespT> call,\n+            Metadata headers,\n+            ServerCallHandler<ReqT, RespT> next) {\n+\n+        boolean managed = !reqContext.isActive();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "366d0c55b98231de7c7f52d2696b503a23618988"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MjMwOTY0", "url": "https://github.com/quarkusio/quarkus/pull/13411#pullrequestreview-536230964", "createdAt": "2020-11-23T07:51:49Z", "commit": {"oid": "366d0c55b98231de7c7f52d2696b503a23618988"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MjQ3NDk3", "url": "https://github.com/quarkusio/quarkus/pull/13411#pullrequestreview-536247497", "createdAt": "2020-11-23T08:21:35Z", "commit": {"oid": "366d0c55b98231de7c7f52d2696b503a23618988"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyMTozNVrOH4C6MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyMTozNVrOH4C6MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTk2OA==", "bodyText": "@cescoffier Do you expect this to be called from a different thread than the one that called reqContext.activate()?", "url": "https://github.com/quarkusio/quarkus/pull/13411#discussion_r528529968", "createdAt": "2020-11-23T08:21:35Z", "author": {"login": "mkouba"}, "path": "extensions/grpc/runtime/src/main/java/io/quarkus/grpc/runtime/supports/RequestScopeHandlerInterceptor.java", "diffHunk": "@@ -0,0 +1,41 @@\n+package io.quarkus.grpc.runtime.supports;\n+\n+import io.grpc.ForwardingServerCall;\n+import io.grpc.Metadata;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.Status;\n+import io.quarkus.arc.Arc;\n+import io.quarkus.arc.ManagedContext;\n+\n+public class RequestScopeHandlerInterceptor implements ServerInterceptor {\n+\n+    private final ManagedContext reqContext;\n+\n+    public RequestScopeHandlerInterceptor() {\n+        reqContext = Arc.container().requestContext();\n+    }\n+\n+    @Override\n+    public <ReqT, RespT> ServerCall.Listener<ReqT> interceptCall(ServerCall<ReqT, RespT> call,\n+            Metadata headers,\n+            ServerCallHandler<ReqT, RespT> next) {\n+\n+        boolean managed = !reqContext.isActive();\n+        if (managed) {\n+            reqContext.activate();\n+        }\n+\n+        return next.startCall(new ForwardingServerCall.SimpleForwardingServerCall<ReqT, RespT>(call) {\n+            @Override\n+            public void close(Status status, Metadata trailers) {\n+                super.close(status, trailers);\n+                if (managed) {\n+                    reqContext.deactivate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "366d0c55b98231de7c7f52d2696b503a23618988"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MzMxMjc0", "url": "https://github.com/quarkusio/quarkus/pull/13411#pullrequestreview-536331274", "createdAt": "2020-11-23T10:15:58Z", "commit": {"oid": "366d0c55b98231de7c7f52d2696b503a23618988"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "366d0c55b98231de7c7f52d2696b503a23618988", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/366d0c55b98231de7c7f52d2696b503a23618988", "committedDate": "2020-11-22T17:48:36Z", "message": "Enable the RequestScope on gRPC service invocations"}, "afterCommit": {"oid": "d87deb29610b3473084e8b2f94c51a10ced98b35", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/d87deb29610b3473084e8b2f94c51a10ced98b35", "committedDate": "2020-12-09T16:31:22Z", "message": "Enable the RequestScope on gRPC service invocations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b8190e2683e70b61904abfc58d9f7f3ea97ca33", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/1b8190e2683e70b61904abfc58d9f7f3ea97ca33", "committedDate": "2021-01-04T18:48:43Z", "message": "Enable the RequestScope on gRPC service invocations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d87deb29610b3473084e8b2f94c51a10ced98b35", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/d87deb29610b3473084e8b2f94c51a10ced98b35", "committedDate": "2020-12-09T16:31:22Z", "message": "Enable the RequestScope on gRPC service invocations"}, "afterCommit": {"oid": "1b8190e2683e70b61904abfc58d9f7f3ea97ca33", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/quarkusio/quarkus/commit/1b8190e2683e70b61904abfc58d9f7f3ea97ca33", "committedDate": "2021-01-04T18:48:43Z", "message": "Enable the RequestScope on gRPC service invocations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMzg0OTIx", "url": "https://github.com/quarkusio/quarkus/pull/13411#pullrequestreview-562384921", "createdAt": "2021-01-06T07:52:14Z", "commit": {"oid": "1b8190e2683e70b61904abfc58d9f7f3ea97ca33"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1454, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}