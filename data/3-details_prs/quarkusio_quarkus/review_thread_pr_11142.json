{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwODA1Njk4", "number": 11142, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwMjo1MjoxNFrOElfMFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwOToyNjo0NFrOEn_w6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3NzQzNzY2OnYy", "diffSide": "RIGHT", "path": "test-framework/common/src/main/java/io/quarkus/test/common/PathTestHelper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwMjo1MjoxNFrOHU_diw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwNzo0ODo0MFrOHVECjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3MzMyMw==", "bodyText": "@glefloch Based on my analysis, if we want to keep the code impact to a minimum, then I will need to do the following,\n\nIdentify the test sources and serialize it as part of the plugin (via the tooling API)\nRead that information in this class and associate the test-to-main mapping so that isInTestDir returns true\n\nIf this approach sounds good, then I can serialize it as part of the QuarkusPluginExtension.beforeTest() method.\nApart from the Gradle extension, is there any additional place that needs to be modified?", "url": "https://github.com/quarkusio/quarkus/pull/11142#discussion_r491773323", "createdAt": "2020-09-21T02:52:14Z", "author": {"login": "roguexz"}, "path": "test-framework/common/src/main/java/io/quarkus/test/common/PathTestHelper.java", "diffHunk": "@@ -99,6 +100,20 @@\n                 File.separator + \"test-classes\",\n                 File.separator + \"classes\");\n         //endregion\n+\n+        String mappings = System.getenv(\"ADDITIONAL_TEST_TO_MAIN_MAPPINGS\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b49c99f67ea8d8afafa3f9cecd07432839035761"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg0ODMzMw==", "bodyText": "Yes, actually, we are already scanning workspace here: \n  \n    \n      quarkus/devtools/gradle/src/main/java/io/quarkus/gradle/builder/QuarkusModelBuilder.java\n    \n    \n         Line 126\n      in\n      77b772c\n    \n    \n    \n    \n\n        \n          \n           private WorkspaceModule getWorkspaceModule(Project project, LaunchMode mode) { \n        \n    \n  \n\n\nIf you can add those source set here, you will be able to get them through the model used : \n  \n    \n      quarkus/test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusTestExtension.java\n    \n    \n         Line 199\n      in\n      77b772c\n    \n    \n    \n    \n\n        \n          \n           BuildToolHelper.enableGradleAppModel(projectRoot, \"TEST\", QuarkusModelHelper.TEST_REQUIRED_TASKS);", "url": "https://github.com/quarkusio/quarkus/pull/11142#discussion_r491848333", "createdAt": "2020-09-21T07:48:40Z", "author": {"login": "glefloch"}, "path": "test-framework/common/src/main/java/io/quarkus/test/common/PathTestHelper.java", "diffHunk": "@@ -99,6 +100,20 @@\n                 File.separator + \"test-classes\",\n                 File.separator + \"classes\");\n         //endregion\n+\n+        String mappings = System.getenv(\"ADDITIONAL_TEST_TO_MAIN_MAPPINGS\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc3MzMyMw=="}, "originalCommit": {"oid": "b49c99f67ea8d8afafa3f9cecd07432839035761"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODcyNzMyOnYy", "diffSide": "RIGHT", "path": "devtools/gradle/src/main/java/io/quarkus/gradle/QuarkusPluginExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjowODoyNVrOHYJ4Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjowODoyNVrOHYJ4Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA4OTY2Ng==", "bodyText": "Let's add `TEST_TO_MAIN_MAPPINGS\" to BootstrapConstants.", "url": "https://github.com/quarkusio/quarkus/pull/11142#discussion_r495089666", "createdAt": "2020-09-25T16:08:25Z", "author": {"login": "aloubyansky"}, "path": "devtools/gradle/src/main/java/io/quarkus/gradle/QuarkusPluginExtension.java", "diffHunk": "@@ -55,6 +58,23 @@ void beforeTest(Test task) {\n             final Path serializedModel = QuarkusGradleUtils.serializeAppModel(appModel, task);\n             props.put(BootstrapConstants.SERIALIZED_APP_MODEL, serializedModel.toString());\n \n+            // Identify the folder containing the sources associated with this test task\n+            StringJoiner joiner = new StringJoiner(\",\");\n+            getSourceSets().stream()\n+                    .filter(sourceSet -> Objects.equals(\n+                            task.getTestClassesDirs().getAsPath(),\n+                            sourceSet.getOutput().getClassesDirs().getAsPath()))\n+                    .flatMap(sourceSet -> sourceSet.getOutput().getClassesDirs().getFiles().stream())\n+                    .filter(File::exists)\n+                    .distinct()\n+                    .forEach(testSrcDir -> {\n+                        String mapping = String.format(\"%s:%s\",\n+                                project.relativePath(testSrcDir),\n+                                project.relativePath(outputDirectory()));\n+                        joiner.add(mapping);\n+                    });\n+            task.environment(\"TEST_TO_MAIN_MAPPINGS\", joiner.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a86ec6f4deb2290451ef8c67fb956f36a15c28a5"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5ODczODQ4OnYy", "diffSide": "RIGHT", "path": "test-framework/common/src/main/java/io/quarkus/test/common/PathTestHelper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxMToxOFrOHYJ-rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNjoxMToxOFrOHYJ-rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA5MTM3NA==", "bodyText": "I think we should throw an exception in this case instead.", "url": "https://github.com/quarkusio/quarkus/pull/11142#discussion_r495091374", "createdAt": "2020-09-25T16:11:18Z", "author": {"login": "aloubyansky"}, "path": "test-framework/common/src/main/java/io/quarkus/test/common/PathTestHelper.java", "diffHunk": "@@ -99,6 +100,20 @@\n                 File.separator + \"test-classes\",\n                 File.separator + \"classes\");\n         //endregion\n+\n+        String mappings = System.getenv(\"TEST_TO_MAIN_MAPPINGS\");\n+        if (mappings != null) {\n+            Stream.of(mappings.split(\",\"))\n+                    .filter(s -> !s.isEmpty())\n+                    .forEach(s -> {\n+                        String[] entry = s.split(\":\");\n+                        if (entry.length == 2) {\n+                            TEST_TO_MAIN_DIR_FRAGMENTS.put(entry[0], entry[1]);\n+                        } else {\n+                            System.err.println(\"Unable to parse additional test-to-main mapping: \" + s);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a86ec6f4deb2290451ef8c67fb956f36a15c28a5"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMDY2MzAyOnYy", "diffSide": "RIGHT", "path": "devtools/gradle/build.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMzowMToyMFrOHYc5dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMzowMToyMFrOHYc5dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwMTMzMw==", "bodyText": "I am verifying the capability as a functional test.", "url": "https://github.com/quarkusio/quarkus/pull/11142#discussion_r495401333", "createdAt": "2020-09-26T03:01:20Z", "author": {"login": "roguexz"}, "path": "devtools/gradle/build.gradle", "diffHunk": "@@ -27,6 +27,17 @@ repositories {\n     mavenCentral()\n }\n \n+sourceSets {\n+    // Functional Tests\n+    funcTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4f780f6b0484ef9cfc71704087a61d2124f2f52"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMDY2NDgxOnYy", "diffSide": "RIGHT", "path": "devtools/gradle/build.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMzowMTo1NVrOHYc6gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMzowMTo1NVrOHYc6gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwMTYwMA==", "bodyText": "The build task depends on the check task. So, mvn clean install will in-turn trigger the functional tests", "url": "https://github.com/quarkusio/quarkus/pull/11142#discussion_r495401600", "createdAt": "2020-09-26T03:01:55Z", "author": {"login": "roguexz"}, "path": "devtools/gradle/build.gradle", "diffHunk": "@@ -83,3 +94,29 @@ gradlePlugin {\n wrapper {\n     distributionType = Wrapper.DistributionType.ALL\n }\n+\n+/*\n+ * Functional tests for this module.\n+ */\n+task functionalTest(type: Test, description: 'Functional tests', dependsOn: [processResources, classes]) {\n+    description = 'Run the functional tests.'\n+    group = 'verification'\n+\n+    useJUnitPlatform()\n+    testClassesDirs = sourceSets.funcTest.output.classesDirs\n+    classpath = sourceSets.funcTest.runtimeClasspath\n+    environment 'QUARKUS_VERSION', \"${version}\"\n+    mustRunAfter test\n+\n+    // propagate the custom local maven repo, in case it's configured\n+    if (System.properties.containsKey('maven.repo.local')) {\n+        systemProperty 'maven.repo.local', System.properties.get('maven.repo.local')\n+    }\n+    testLogging {\n+        events \"passed\", \"skipped\", \"failed\"\n+    }\n+    // Circumvent issue: https://github.com/gradle/gradle/issues/1675\n+    systemProperty 'org.gradle.testkit.dir', file(\"${buildDir}/tmp/test-kit\")\n+}\n+\n+check.dependsOn functionalTest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4f780f6b0484ef9cfc71704087a61d2124f2f52"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMDY3NTg0OnYy", "diffSide": "RIGHT", "path": "devtools/gradle/src/funcTest/resources/additional-source-sets/build.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMzowNjoxN1rOHYdBuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMzowNjoxN1rOHYdBuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQwMzQ0OQ==", "bodyText": "Apologies for the name confusion. Here is what's happening.\nmvn clean install\n    --executes--> gradle functionalTest\n        --runs-> AdditionalSourceSetsTest\n            --executes--> a Gradle build using this build file\n                --executes--> this task (which happens to be named as \"functionalTest\")", "url": "https://github.com/quarkusio/quarkus/pull/11142#discussion_r495403449", "createdAt": "2020-09-26T03:06:17Z", "author": {"login": "roguexz"}, "path": "devtools/gradle/src/funcTest/resources/additional-source-sets/build.gradle", "diffHunk": "@@ -0,0 +1,55 @@\n+plugins {\n+    id 'java'\n+    id 'io.quarkus'\n+}\n+\n+repositories {\n+    mavenLocal()\n+    mavenCentral()\n+}\n+\n+String quarkusVersion = System.getProperty('QUARKUS_VERSION')\n+dependencies {\n+    implementation \"io.quarkus:quarkus-arc:${quarkusVersion}\"\n+    testImplementation \"io.quarkus:quarkus-junit5:${quarkusVersion}\"\n+}\n+\n+sourceSets {\n+    // Functional Tests\n+    funcTest {\n+        java.srcDir 'src/funcTest/java'\n+        if (file('src/funcTest/resources').exists()) {\n+            resources.srcDir 'src/funcTest/resources'\n+        }\n+\n+        compileClasspath += sourceSets.main.output + configurations.testRuntimeClasspath + configurations.compileOnly\n+        runtimeClasspath += output + compileClasspath\n+    }\n+}\n+\n+compileJava {\n+    options.compilerArgs << '-parameters'\n+}\n+\n+java {\n+    sourceCompatibility = JavaVersion.VERSION_1_8\n+    targetCompatibility = JavaVersion.VERSION_1_8\n+}\n+\n+/*\n+ * Functional tests for this module.\n+ */\n+task functionalTest(type: Test, description: 'Functional tests', dependsOn: [processResources, classes]) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4f780f6b0484ef9cfc71704087a61d2124f2f52"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMDgwODIxOnYy", "diffSide": "RIGHT", "path": "devtools/gradle/src/funcTest/resources/additional-source-sets/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNTo1OTo1OVrOHYeDgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNTo1OTo1OVrOHYeDgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyMDI4OQ==", "bodyText": "Can you remove those settings from the sample test project?", "url": "https://github.com/quarkusio/quarkus/pull/11142#discussion_r495420289", "createdAt": "2020-09-26T05:59:59Z", "author": {"login": "glefloch"}, "path": "devtools/gradle/src/funcTest/resources/additional-source-sets/build.gradle", "diffHunk": "@@ -0,0 +1,55 @@\n+plugins {\n+    id 'java'\n+    id 'io.quarkus'\n+}\n+\n+repositories {\n+    mavenLocal()\n+    mavenCentral()\n+}\n+\n+String quarkusVersion = System.getProperty('QUARKUS_VERSION')\n+dependencies {\n+    implementation \"io.quarkus:quarkus-arc:${quarkusVersion}\"\n+    testImplementation \"io.quarkus:quarkus-junit5:${quarkusVersion}\"\n+}\n+\n+sourceSets {\n+    // Functional Tests\n+    funcTest {\n+        java.srcDir 'src/funcTest/java'\n+        if (file('src/funcTest/resources').exists()) {\n+            resources.srcDir 'src/funcTest/resources'\n+        }\n+\n+        compileClasspath += sourceSets.main.output + configurations.testRuntimeClasspath + configurations.compileOnly\n+        runtimeClasspath += output + compileClasspath\n+    }\n+}\n+\n+compileJava {\n+    options.compilerArgs << '-parameters'\n+}\n+\n+java {\n+    sourceCompatibility = JavaVersion.VERSION_1_8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4f780f6b0484ef9cfc71704087a61d2124f2f52"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMzc0NjMyOnYy", "diffSide": "RIGHT", "path": "devtools/gradle/src/main/java/io/quarkus/gradle/QuarkusPluginExtension.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwOToyNjo0NFrOHY1kAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwOToyNjo0NFrOHY1kAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgwNTQ0Mw==", "bodyText": "Instead of using forEach and an external StringJoiner, would it be better to use something more functional?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        StringJoiner joiner = new StringJoiner(\",\");\n          \n          \n            \n                        getSourceSets().stream()\n          \n          \n            \n                                .filter(sourceSet -> Objects.equals(\n          \n          \n            \n                                        task.getTestClassesDirs().getAsPath(),\n          \n          \n            \n                                        sourceSet.getOutput().getClassesDirs().getAsPath()))\n          \n          \n            \n                                .flatMap(sourceSet -> sourceSet.getOutput().getClassesDirs().getFiles().stream())\n          \n          \n            \n                                .filter(File::exists)\n          \n          \n            \n                                .distinct()\n          \n          \n            \n                                .forEach(testSrcDir -> {\n          \n          \n            \n                                    String mapping = String.format(\"%s:%s\",\n          \n          \n            \n                                            project.relativePath(testSrcDir),\n          \n          \n            \n                                            project.relativePath(outputDirectory()));\n          \n          \n            \n                                    joiner.add(mapping);\n          \n          \n            \n                                });\n          \n          \n            \n                        task.environment(BootstrapConstants.TEST_TO_MAIN_MAPPINGS, joiner.toString());\n          \n          \n            \n                        String fileList = getSourceSets().stream()\n          \n          \n            \n                                .filter(sourceSet -> Objects.equals(\n          \n          \n            \n                                        task.getTestClassesDirs().getAsPath(),\n          \n          \n            \n                                        sourceSet.getOutput().getClassesDirs().getAsPath()))\n          \n          \n            \n                                .flatMap(sourceSet -> sourceSet.getOutput().getClassesDirs().getFiles().stream())\n          \n          \n            \n                                .filter(File::exists)\n          \n          \n            \n                                .distinct()\n          \n          \n            \n                                .map(testSrcDir -> String.format(\"%s:%s\",\n          \n          \n            \n                                            project.relativePath(testSrcDir),\n          \n          \n            \n                                            project.relativePath(outputDirectory())))\n          \n          \n            \n                                .collect( Collectors.joining( \",\" ) );\n          \n          \n            \n                        task.environment(BootstrapConstants.TEST_TO_MAIN_MAPPINGS, fileList);", "url": "https://github.com/quarkusio/quarkus/pull/11142#discussion_r495805443", "createdAt": "2020-09-28T09:26:44Z", "author": {"login": "ebramirez"}, "path": "devtools/gradle/src/main/java/io/quarkus/gradle/QuarkusPluginExtension.java", "diffHunk": "@@ -55,6 +58,23 @@ void beforeTest(Test task) {\n             final Path serializedModel = QuarkusGradleUtils.serializeAppModel(appModel, task);\n             props.put(BootstrapConstants.SERIALIZED_APP_MODEL, serializedModel.toString());\n \n+            // Identify the folder containing the sources associated with this test task\n+            StringJoiner joiner = new StringJoiner(\",\");\n+            getSourceSets().stream()\n+                    .filter(sourceSet -> Objects.equals(\n+                            task.getTestClassesDirs().getAsPath(),\n+                            sourceSet.getOutput().getClassesDirs().getAsPath()))\n+                    .flatMap(sourceSet -> sourceSet.getOutput().getClassesDirs().getFiles().stream())\n+                    .filter(File::exists)\n+                    .distinct()\n+                    .forEach(testSrcDir -> {\n+                        String mapping = String.format(\"%s:%s\",\n+                                project.relativePath(testSrcDir),\n+                                project.relativePath(outputDirectory()));\n+                        joiner.add(mapping);\n+                    });\n+            task.environment(BootstrapConstants.TEST_TO_MAIN_MAPPINGS, joiner.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9fe14060e68ef735919a912859a5feb7c4795ba"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 794, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}