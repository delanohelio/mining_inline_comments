{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwODk3MDA1", "number": 13619, "title": "Detect wrong usage of singleton annotations", "bodyText": "i.e. javax.ejb.Singleton", "createdAt": "2020-12-02T10:00:31Z", "url": "https://github.com/quarkusio/quarkus/pull/13619", "merged": true, "mergeCommit": {"oid": "9256986a8df6e6144a730ed9a5268526085dba06"}, "closed": true, "closedAt": "2020-12-02T13:07:30Z", "author": {"login": "mkouba"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiLlIBAH2gAyNTMwODk3MDA1OmU5OTU0ODNhNDM3NWFjMGY5YTU5NDQ1YzczNzFiNGNhZTQ2NjcyNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiNHg5AFqTU0Mjc1NjUxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e995483a4375ac0f9a59445c7371b4cae4667271", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/e995483a4375ac0f9a59445c7371b4cae4667271", "committedDate": "2020-12-02T10:00:10Z", "message": "Detect wrong usage of singleton annotations\n\n- i.e. javax.ejb.Singleton"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjg0MTM1", "url": "https://github.com/quarkusio/quarkus/pull/13619#pullrequestreview-542684135", "createdAt": "2020-12-02T10:14:13Z", "commit": {"oid": "e995483a4375ac0f9a59445c7371b4cae4667271"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMDoxNDoxM1rOH9Tv6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxMDoxNDoxM1rOH9Tv6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0ODc0Nw==", "bodyText": "I'm completely fine with this, but maybe it makes sense to just catch anything other than our CDI Singleton?", "url": "https://github.com/quarkusio/quarkus/pull/13619#discussion_r534048747", "createdAt": "2020-12-02T10:14:13Z", "author": {"login": "geoand"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/WrongAnnotationsProcessor.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package io.quarkus.arc.deployment;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.function.Function;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.IndexView;\n+\n+import io.quarkus.arc.deployment.ValidationPhaseBuildItem.ValidationErrorBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.ApplicationIndexBuildItem;\n+\n+public class WrongAnnotationsProcessor {\n+\n+    @BuildStep\n+    void detect(ArcConfig config, ApplicationIndexBuildItem applicationIndex,\n+            BuildProducer<ValidationErrorBuildItem> validationError) {\n+\n+        if (!config.detectWrongAnnotations) {\n+            return;\n+        }\n+\n+        IndexView index = applicationIndex.getIndex();\n+        List<WrongAnnotation> wrongAnnotations = new ArrayList<>();\n+        Function<AnnotationInstance, String> singletonFun = new Function<AnnotationInstance, String>() {\n+\n+            @Override\n+            public String apply(AnnotationInstance annotationInstance) {\n+                return String.format(\"%s declared on %s, use @javax.inject.Singleton instead\",\n+                        annotationInstance.toString(false), getTargetInfo(annotationInstance));\n+            }\n+        };\n+        wrongAnnotations.add(new WrongAnnotation(DotName.createSimple(\"com.google.inject.Singleton\"), singletonFun));\n+        wrongAnnotations.add(new WrongAnnotation(DotName.createSimple(\"javax.ejb.Singleton\"), singletonFun));\n+        wrongAnnotations.add(new WrongAnnotation(DotName.createSimple(\"groovy.lang.Singleton\"), singletonFun));\n+        wrongAnnotations.add(new WrongAnnotation(DotName.createSimple(\"jakarta.ejb.Singleton\"), singletonFun));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e995483a4375ac0f9a59445c7371b4cae4667271"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNzU2NTE2", "url": "https://github.com/quarkusio/quarkus/pull/13619#pullrequestreview-542756516", "createdAt": "2020-12-02T11:47:38Z", "commit": {"oid": "e995483a4375ac0f9a59445c7371b4cae4667271"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1190, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}