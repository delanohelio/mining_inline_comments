{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMTU2Nzcw", "number": 11466, "title": "Disable the code flow access token verification by default (pre-1.7.0.Final status)", "bodyText": "Fixes #11460.\nFixes #11418.\nIn 1.7.0.Final we have the access tokens returned as part of the code flow verified by default. This has caused 2 regressions so far.\nNote this PR is simply restoring what was there all the time before 1.7.0.Final - i.e Quarkus OIDC has always been verifying ID tokens since ID tokens are treated as the primary principal tokens in the code flow but access tokens were only injected if required but they were not re-validated.\nVerifying both ID and access tokens should be really encouraged, works fine with KC in the code flow, because the users can still inject access tokens as JWT tokens, etc.\nBut some providers are likely returning binary access tokens (definitely can be the the case with Auth0 now that I think about it) or JWTs signed by the key not available in the local JWK set (and no introspection endpoint is supported) so it causes side-effects when Vertx tries to introspect as a fallback when it fails to verify with the JWK. Hence it is better to make this feature optional but I've also updated the docs accordingly.\nAlso note that if quarkus.oidc.roles.source=accesstoken is set in the code flow (take the roles from the access token vs ID token, new in 1.7.0.Final) then the access token will always be verified (test exists in oidc-tenancy) since we can't base the authorization decision on the non-re-validated access token.", "createdAt": "2020-08-19T13:14:40Z", "url": "https://github.com/quarkusio/quarkus/pull/11466", "merged": true, "mergeCommit": {"oid": "e77f9e83bf10654fd8e738bad8b24e0155d07243"}, "closed": true, "closedAt": "2020-08-20T14:43:22Z", "author": {"login": "sberyozkin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAdP5pgBqjM2NzEzNjkwNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAu4l-gBqjM2NzQ4ODkwOTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a304072e953ac7812f8609054e73101f54bd8e00", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/a304072e953ac7812f8609054e73101f54bd8e00", "committedDate": "2020-08-19T12:55:12Z", "message": "Disable the code flow access token verification by default (pre-1.7.0.Final status)"}, "afterCommit": {"oid": "d0b76d5b4a22200a89d4bfb90692e35fefac530e", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/d0b76d5b4a22200a89d4bfb90692e35fefac530e", "committedDate": "2020-08-19T15:21:35Z", "message": "Disable the code flow access token verification by default (pre-1.7.0.Final status)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0b76d5b4a22200a89d4bfb90692e35fefac530e", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/d0b76d5b4a22200a89d4bfb90692e35fefac530e", "committedDate": "2020-08-19T15:21:35Z", "message": "Disable the code flow access token verification by default (pre-1.7.0.Final status)"}, "afterCommit": {"oid": "210885bb799ed72e021446b19e96204dcf48cfea", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/210885bb799ed72e021446b19e96204dcf48cfea", "committedDate": "2020-08-19T20:44:17Z", "message": "Disable the code flow access token verification by default (pre-1.7.0.Final status)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDIxMzUx", "url": "https://github.com/quarkusio/quarkus/pull/11466#pullrequestreview-471021351", "createdAt": "2020-08-19T23:02:11Z", "commit": {"oid": "210885bb799ed72e021446b19e96204dcf48cfea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMzowMjoxMVrOHDe1Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMzowMjoxMVrOHDe1Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQxMjg5MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    || resolvedContext.oidcConfig.roles.source.isPresent()\n          \n          \n            \n                                            && resolvedContext.oidcConfig.roles.source.get() == Source.accesstoken)) {\n          \n          \n            \n                                    || (resolvedContext.oidcConfig.roles.source.isPresent()\n          \n          \n            \n                                            && resolvedContext.oidcConfig.roles.source.get() == Source.accesstoken))) {", "url": "https://github.com/quarkusio/quarkus/pull/11466#discussion_r473412890", "createdAt": "2020-08-19T23:02:11Z", "author": {"login": "gastaldi"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcIdentityProvider.java", "diffHunk": "@@ -79,7 +79,8 @@ public SecurityIdentity get() {\n \n         if (request.getToken() instanceof IdTokenCredential\n                 && (resolvedContext.oidcConfig.authentication.verifyAccessToken\n-                        || resolvedContext.oidcConfig.roles.source.get() == Source.accesstoken)) {\n+                        || resolvedContext.oidcConfig.roles.source.isPresent()\n+                                && resolvedContext.oidcConfig.roles.source.get() == Source.accesstoken)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "210885bb799ed72e021446b19e96204dcf48cfea"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "210885bb799ed72e021446b19e96204dcf48cfea", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/210885bb799ed72e021446b19e96204dcf48cfea", "committedDate": "2020-08-19T20:44:17Z", "message": "Disable the code flow access token verification by default (pre-1.7.0.Final status)"}, "afterCommit": {"oid": "07216facd7f3edf6d33112f8e36f670ee0693022", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/07216facd7f3edf6d33112f8e36f670ee0693022", "committedDate": "2020-08-20T10:35:21Z", "message": "Disable the code flow access token verification by default (pre-1.7.0.Final status)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNTA2OTMz", "url": "https://github.com/quarkusio/quarkus/pull/11466#pullrequestreview-471506933", "createdAt": "2020-08-20T11:36:13Z", "commit": {"oid": "07216facd7f3edf6d33112f8e36f670ee0693022"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNTEwMTU0", "url": "https://github.com/quarkusio/quarkus/pull/11466#pullrequestreview-471510154", "createdAt": "2020-08-20T11:41:10Z", "commit": {"oid": "07216facd7f3edf6d33112f8e36f670ee0693022"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd9892905e04f7caef3b431b248f9574b70417a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/2bd9892905e04f7caef3b431b248f9574b70417a", "committedDate": "2020-08-20T11:54:32Z", "message": "Disable the code flow access token verification by default (pre-1.7.0.Final status)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07216facd7f3edf6d33112f8e36f670ee0693022", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/07216facd7f3edf6d33112f8e36f670ee0693022", "committedDate": "2020-08-20T10:35:21Z", "message": "Disable the code flow access token verification by default (pre-1.7.0.Final status)"}, "afterCommit": {"oid": "2bd9892905e04f7caef3b431b248f9574b70417a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/2bd9892905e04f7caef3b431b248f9574b70417a", "committedDate": "2020-08-20T11:54:32Z", "message": "Disable the code flow access token verification by default (pre-1.7.0.Final status)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 828, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}