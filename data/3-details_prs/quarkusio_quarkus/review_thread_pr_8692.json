{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1OTYyNTk3", "number": 8692, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDoxNjo1NFrODzp0Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDoxNjo1NFrODzp0Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDg5MDY2OnYy", "diffSide": "RIGHT", "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMDoxNjo1NFrOGINZOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDozOToyMFrOGIX2hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ==", "bodyText": "Perhaps we should simplify the message to just say that config roots can only be accessed at runtime init? Mentioning bootstrap here is kind of confusing since there is also the bootstrap config phase.", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411261241", "createdAt": "2020-04-20T10:16:54Z", "author": {"login": "geoand"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java", "diffHunk": "@@ -151,10 +153,16 @@ public void register(RegistrationContext context) {\n                 for (RootDefinition rootDefinition : configItem.getReadResult().getAllRoots()) {\n                     if (rootDefinition.getConfigPhase() == ConfigPhase.BUILD_AND_RUN_TIME_FIXED\n                             || rootDefinition.getConfigPhase() == ConfigPhase.RUN_TIME) {\n-                        context.configure(rootDefinition.getConfigurationClass()).types(rootDefinition.getConfigurationClass())\n+                        Class<?> configRootClass = rootDefinition.getConfigurationClass();\n+                        context.configure(configRootClass).types(configRootClass)\n                                 .scope(Dependent.class).creator(mc -> {\n                                     // e.g. return Config.ApplicationConfig\n-                                    mc.returnValue(mc.readStaticField(rootDefinition.getDescriptor()));\n+                                    ResultHandle configRoot = mc.readStaticField(rootDefinition.getDescriptor());\n+                                    mc.ifNull(configRoot).trueBranch().throwException(CreationException.class,\n+                                            String.format(\n+                                                    \"Config root %s [%s] was not initialized yet. Make sure the bean is accessed at the right time in the correct bootstrap phase.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e5ce8bba5c654640f605d9d5611f4d495d4f057"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5MDMwNA==", "bodyText": "Perhaps we should simplify the message to just say that config roots can only be accessed at runtime init\n\nWell, BUILD_AND_RUN_TIME_FIXED roots can be safely used in STATIC_INIT.\n\nMentioning bootstrap here is kind of confusing since there is also the bootstrap config phase.\n\nHm, so it's bootstrap phase VS bootstrap config phase. I'm not sure about the correct wording.", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411290304", "createdAt": "2020-04-20T11:07:37Z", "author": {"login": "mkouba"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java", "diffHunk": "@@ -151,10 +153,16 @@ public void register(RegistrationContext context) {\n                 for (RootDefinition rootDefinition : configItem.getReadResult().getAllRoots()) {\n                     if (rootDefinition.getConfigPhase() == ConfigPhase.BUILD_AND_RUN_TIME_FIXED\n                             || rootDefinition.getConfigPhase() == ConfigPhase.RUN_TIME) {\n-                        context.configure(rootDefinition.getConfigurationClass()).types(rootDefinition.getConfigurationClass())\n+                        Class<?> configRootClass = rootDefinition.getConfigurationClass();\n+                        context.configure(configRootClass).types(configRootClass)\n                                 .scope(Dependent.class).creator(mc -> {\n                                     // e.g. return Config.ApplicationConfig\n-                                    mc.returnValue(mc.readStaticField(rootDefinition.getDescriptor()));\n+                                    ResultHandle configRoot = mc.readStaticField(rootDefinition.getDescriptor());\n+                                    mc.ifNull(configRoot).trueBranch().throwException(CreationException.class,\n+                                            String.format(\n+                                                    \"Config root %s [%s] was not initialized yet. Make sure the bean is accessed at the right time in the correct bootstrap phase.\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}, "originalCommit": {"oid": "7e5ce8bba5c654640f605d9d5611f4d495d4f057"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMDE1MQ==", "bodyText": "Yeah it's tricky. Maybe let's just go with what you added and see if people get confused", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411300151", "createdAt": "2020-04-20T11:24:58Z", "author": {"login": "geoand"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java", "diffHunk": "@@ -151,10 +153,16 @@ public void register(RegistrationContext context) {\n                 for (RootDefinition rootDefinition : configItem.getReadResult().getAllRoots()) {\n                     if (rootDefinition.getConfigPhase() == ConfigPhase.BUILD_AND_RUN_TIME_FIXED\n                             || rootDefinition.getConfigPhase() == ConfigPhase.RUN_TIME) {\n-                        context.configure(rootDefinition.getConfigurationClass()).types(rootDefinition.getConfigurationClass())\n+                        Class<?> configRootClass = rootDefinition.getConfigurationClass();\n+                        context.configure(configRootClass).types(configRootClass)\n                                 .scope(Dependent.class).creator(mc -> {\n                                     // e.g. return Config.ApplicationConfig\n-                                    mc.returnValue(mc.readStaticField(rootDefinition.getDescriptor()));\n+                                    ResultHandle configRoot = mc.readStaticField(rootDefinition.getDescriptor());\n+                                    mc.ifNull(configRoot).trueBranch().throwException(CreationException.class,\n+                                            String.format(\n+                                                    \"Config root %s [%s] was not initialized yet. Make sure the bean is accessed at the right time in the correct bootstrap phase.\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}, "originalCommit": {"oid": "7e5ce8bba5c654640f605d9d5611f4d495d4f057"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM3OTY4Nw==", "bodyText": "I'll remove the next sentence...", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411379687", "createdAt": "2020-04-20T13:32:43Z", "author": {"login": "mkouba"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java", "diffHunk": "@@ -151,10 +153,16 @@ public void register(RegistrationContext context) {\n                 for (RootDefinition rootDefinition : configItem.getReadResult().getAllRoots()) {\n                     if (rootDefinition.getConfigPhase() == ConfigPhase.BUILD_AND_RUN_TIME_FIXED\n                             || rootDefinition.getConfigPhase() == ConfigPhase.RUN_TIME) {\n-                        context.configure(rootDefinition.getConfigurationClass()).types(rootDefinition.getConfigurationClass())\n+                        Class<?> configRootClass = rootDefinition.getConfigurationClass();\n+                        context.configure(configRootClass).types(configRootClass)\n                                 .scope(Dependent.class).creator(mc -> {\n                                     // e.g. return Config.ApplicationConfig\n-                                    mc.returnValue(mc.readStaticField(rootDefinition.getDescriptor()));\n+                                    ResultHandle configRoot = mc.readStaticField(rootDefinition.getDescriptor());\n+                                    mc.ifNull(configRoot).trueBranch().throwException(CreationException.class,\n+                                            String.format(\n+                                                    \"Config root %s [%s] was not initialized yet. Make sure the bean is accessed at the right time in the correct bootstrap phase.\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}, "originalCommit": {"oid": "7e5ce8bba5c654640f605d9d5611f4d495d4f057"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4Nzg5Ng==", "bodyText": "Done.", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411387896", "createdAt": "2020-04-20T13:43:31Z", "author": {"login": "mkouba"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java", "diffHunk": "@@ -151,10 +153,16 @@ public void register(RegistrationContext context) {\n                 for (RootDefinition rootDefinition : configItem.getReadResult().getAllRoots()) {\n                     if (rootDefinition.getConfigPhase() == ConfigPhase.BUILD_AND_RUN_TIME_FIXED\n                             || rootDefinition.getConfigPhase() == ConfigPhase.RUN_TIME) {\n-                        context.configure(rootDefinition.getConfigurationClass()).types(rootDefinition.getConfigurationClass())\n+                        Class<?> configRootClass = rootDefinition.getConfigurationClass();\n+                        context.configure(configRootClass).types(configRootClass)\n                                 .scope(Dependent.class).creator(mc -> {\n                                     // e.g. return Config.ApplicationConfig\n-                                    mc.returnValue(mc.readStaticField(rootDefinition.getDescriptor()));\n+                                    ResultHandle configRoot = mc.readStaticField(rootDefinition.getDescriptor());\n+                                    mc.ifNull(configRoot).trueBranch().throwException(CreationException.class,\n+                                            String.format(\n+                                                    \"Config root %s [%s] was not initialized yet. Make sure the bean is accessed at the right time in the correct bootstrap phase.\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}, "originalCommit": {"oid": "7e5ce8bba5c654640f605d9d5611f4d495d4f057"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQzMjU4MA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/quarkusio/quarkus/pull/8692#discussion_r411432580", "createdAt": "2020-04-20T14:39:20Z", "author": {"login": "geoand"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ConfigBuildStep.java", "diffHunk": "@@ -151,10 +153,16 @@ public void register(RegistrationContext context) {\n                 for (RootDefinition rootDefinition : configItem.getReadResult().getAllRoots()) {\n                     if (rootDefinition.getConfigPhase() == ConfigPhase.BUILD_AND_RUN_TIME_FIXED\n                             || rootDefinition.getConfigPhase() == ConfigPhase.RUN_TIME) {\n-                        context.configure(rootDefinition.getConfigurationClass()).types(rootDefinition.getConfigurationClass())\n+                        Class<?> configRootClass = rootDefinition.getConfigurationClass();\n+                        context.configure(configRootClass).types(configRootClass)\n                                 .scope(Dependent.class).creator(mc -> {\n                                     // e.g. return Config.ApplicationConfig\n-                                    mc.returnValue(mc.readStaticField(rootDefinition.getDescriptor()));\n+                                    ResultHandle configRoot = mc.readStaticField(rootDefinition.getDescriptor());\n+                                    mc.ifNull(configRoot).trueBranch().throwException(CreationException.class,\n+                                            String.format(\n+                                                    \"Config root %s [%s] was not initialized yet. Make sure the bean is accessed at the right time in the correct bootstrap phase.\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI2MTI0MQ=="}, "originalCommit": {"oid": "7e5ce8bba5c654640f605d9d5611f4d495d4f057"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3382, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}