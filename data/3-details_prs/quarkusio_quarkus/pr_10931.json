{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NjM3MDg0", "number": 10931, "title": "fixed lost OIDC refresh token when performing a refresh", "bodyText": "Fixes #10924", "createdAt": "2020-07-23T11:11:51Z", "url": "https://github.com/quarkusio/quarkus/pull/10931", "merged": true, "mergeCommit": {"oid": "2a9d2cac983895be6ced43969b2c12365f622fe9"}, "closed": true, "closedAt": "2020-07-24T09:23:31Z", "author": {"login": "sdaschner"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3t_kqgFqTQ1NDA1MzMwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4AiMBgFqTQ1NDc0NjY1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MDUzMzAz", "url": "https://github.com/quarkusio/quarkus/pull/10931#pullrequestreview-454053303", "createdAt": "2020-07-23T11:47:05Z", "commit": {"oid": "97b6b0c748f68a535d6d6f33cea6108f4feaa259"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MDczMzcz", "url": "https://github.com/quarkusio/quarkus/pull/10931#pullrequestreview-454073373", "createdAt": "2020-07-23T12:19:07Z", "commit": {"oid": "97b6b0c748f68a535d6d6f33cea6108f4feaa259"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjoxOTowN1rOG2H6-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjoxOTowN1rOG2H6-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNjA3Mg==", "bodyText": "Lets replace null with result.opaqueRefreshToken()", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459406072", "createdAt": "2020-07-23T12:19:07Z", "author": {"login": "sberyozkin"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -303,7 +303,7 @@ public void accept(SecurityIdentity identity) {\n                                             LOG.debug(\"ID Token is required to contain 'exp' and 'iat' claims\");\n                                             uniEmitter.fail(new AuthenticationCompletionException());\n                                         }\n-                                        processSuccessfulAuthentication(context, configContext, result, identity);\n+                                        processSuccessfulAuthentication(context, configContext, result, null, identity);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97b6b0c748f68a535d6d6f33cea6108f4feaa259"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MDc0MjU4", "url": "https://github.com/quarkusio/quarkus/pull/10931#pullrequestreview-454074258", "createdAt": "2020-07-23T12:20:26Z", "commit": {"oid": "97b6b0c748f68a535d6d6f33cea6108f4feaa259"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjoyMDoyNlrOG2H9tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjoyMDoyNlrOG2H9tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNjc3Mw==", "bodyText": "Lets replace refreshToken with result.opaqueRefreshToken() != null ? result.opaqueRefreshToken() : refreshToken because this check only makes sense in context of the refresh token grant processing", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459406773", "createdAt": "2020-07-23T12:20:26Z", "author": {"login": "sberyozkin"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -471,7 +470,7 @@ public void handle(AsyncResult<Void> result) {\n                                                 @Override\n                                                 public void accept(SecurityIdentity identity) {\n                                                     // after a successful refresh, rebuild the identity and update the cookie \n-                                                    processSuccessfulAuthentication(context, configContext, token,\n+                                                    processSuccessfulAuthentication(context, configContext, token, refreshToken,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97b6b0c748f68a535d6d6f33cea6108f4feaa259"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MDc1NjAw", "url": "https://github.com/quarkusio/quarkus/pull/10931#pullrequestreview-454075600", "createdAt": "2020-07-23T12:22:26Z", "commit": {"oid": "97b6b0c748f68a535d6d6f33cea6108f4feaa259"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjoyMjoyN1rOG2IB2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjoyMjoyN1rOG2IB2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQwNzgzNQ==", "bodyText": "This line can be removed once the proposed changes have been implemented", "url": "https://github.com/quarkusio/quarkus/pull/10931#discussion_r459407835", "createdAt": "2020-07-23T12:22:27Z", "author": {"login": "sberyozkin"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -348,15 +348,14 @@ private String signJwtWithClientSecret(OidcTenantConfig cfg) {\n     }\n \n     private void processSuccessfulAuthentication(RoutingContext context, TenantConfigContext configContext,\n-            AccessToken result, SecurityIdentity securityIdentity) {\n-\n+            AccessToken result, String refreshToken, SecurityIdentity securityIdentity) {\n         removeCookie(context, configContext, getSessionCookieName(configContext));\n \n-        String cookieValue = new StringBuilder(result.opaqueIdToken())\n-                .append(COOKIE_DELIM)\n-                .append(result.opaqueAccessToken())\n-                .append(COOKIE_DELIM)\n-                .append(result.opaqueRefreshToken()).toString();\n+        String refresh = result.opaqueRefreshToken() != null ? result.opaqueRefreshToken() : refreshToken;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97b6b0c748f68a535d6d6f33cea6108f4feaa259"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MDc3OTI1", "url": "https://github.com/quarkusio/quarkus/pull/10931#pullrequestreview-454077925", "createdAt": "2020-07-23T12:25:53Z", "commit": {"oid": "97b6b0c748f68a535d6d6f33cea6108f4feaa259"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MDg3Njgw", "url": "https://github.com/quarkusio/quarkus/pull/10931#pullrequestreview-454087680", "createdAt": "2020-07-23T12:39:54Z", "commit": {"oid": "97b6b0c748f68a535d6d6f33cea6108f4feaa259"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7d9f90ed6b8c099ad88186306057507c7858bb2", "author": {"user": {"login": "sdaschner", "name": "Sebastian Daschner"}}, "url": "https://github.com/quarkusio/quarkus/commit/a7d9f90ed6b8c099ad88186306057507c7858bb2", "committedDate": "2020-07-23T12:39:27Z", "message": "added PR requested changes"}, "afterCommit": {"oid": "9a3f7e4bd5a6cc48be48ded9ca3cd7bbfd73f2d3", "author": {"user": {"login": "sdaschner", "name": "Sebastian Daschner"}}, "url": "https://github.com/quarkusio/quarkus/commit/9a3f7e4bd5a6cc48be48ded9ca3cd7bbfd73f2d3", "committedDate": "2020-07-23T14:24:15Z", "message": "added PR requested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5d158226b1a91372712b5f178eb5c1ac50207db", "author": {"user": {"login": "sdaschner", "name": "Sebastian Daschner"}}, "url": "https://github.com/quarkusio/quarkus/commit/c5d158226b1a91372712b5f178eb5c1ac50207db", "committedDate": "2020-07-23T14:30:46Z", "message": "fixed lost OIDC refresh token when performing a refresh"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a3f7e4bd5a6cc48be48ded9ca3cd7bbfd73f2d3", "author": {"user": {"login": "sdaschner", "name": "Sebastian Daschner"}}, "url": "https://github.com/quarkusio/quarkus/commit/9a3f7e4bd5a6cc48be48ded9ca3cd7bbfd73f2d3", "committedDate": "2020-07-23T14:24:15Z", "message": "added PR requested changes"}, "afterCommit": {"oid": "c5d158226b1a91372712b5f178eb5c1ac50207db", "author": {"user": {"login": "sdaschner", "name": "Sebastian Daschner"}}, "url": "https://github.com/quarkusio/quarkus/commit/c5d158226b1a91372712b5f178eb5c1ac50207db", "committedDate": "2020-07-23T14:30:46Z", "message": "fixed lost OIDC refresh token when performing a refresh"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NzQ2NjU0", "url": "https://github.com/quarkusio/quarkus/pull/10931#pullrequestreview-454746654", "createdAt": "2020-07-24T09:23:11Z", "commit": {"oid": "c5d158226b1a91372712b5f178eb5c1ac50207db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1111, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}