{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MzY1MTc4", "number": 9268, "title": "quarkus-mongodb-panache: Added support to $in operator", "bodyText": "This is a fix for the issue #8531.\nI've added unit tests, and updated the documentation also.\n@loicmathieu , could you review this PR please?\nSorry for my delay, the next will be faster.\nLet me know if you have any question.\nBest.", "createdAt": "2020-05-13T13:32:02Z", "url": "https://github.com/quarkusio/quarkus/pull/9268", "merged": true, "mergeCommit": {"oid": "9b967a752fc43ec1a72c90639a4222e6981a5e66"}, "closed": true, "closedAt": "2020-05-15T11:18:27Z", "author": {"login": "diogocarleto"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg5N40gFqTQxMDkzMjcyMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcheMDZAFqTQxMjQ2NjkyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwOTMyNzIw", "url": "https://github.com/quarkusio/quarkus/pull/9268#pullrequestreview-410932720", "createdAt": "2020-05-13T13:38:23Z", "commit": {"oid": "474b83f59228af2a416db0b0ba29eb0f61a8abc0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzozODoyM1rOGUyBlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzo0OTo1NFrOGUyj8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0NDMxMQ==", "bodyText": "Wildcard imports are prohibited", "url": "https://github.com/quarkusio/quarkus/pull/9268#discussion_r424444311", "createdAt": "2020-05-13T13:38:23Z", "author": {"login": "loicmathieu"}, "path": "extensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/binder/CommonQueryBinder.java", "diffHunk": "@@ -6,8 +6,7 @@\n import java.time.LocalDateTime;\n import java.time.ZoneOffset;\n import java.time.format.DateTimeFormatter;\n-import java.util.Date;\n-import java.util.TimeZone;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474b83f59228af2a416db0b0ba29eb0f61a8abc0"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ0ODc5OA==", "bodyText": "You can use an iterator or turn you collection into an array to avoid creating a new ArrayList from the collection.\nAnd you can use a StringJoiner to avoid dealing with leading , ...", "url": "https://github.com/quarkusio/quarkus/pull/9268#discussion_r424448798", "createdAt": "2020-05-13T13:44:20Z", "author": {"login": "loicmathieu"}, "path": "extensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/binder/CommonQueryBinder.java", "diffHunk": "@@ -55,4 +57,27 @@ static String escape(Object value) {\n         }\n         return \"'\" + value.toString().replace(\"\\\\\", \"\\\\\\\\\").replace(\"'\", \"\\\\'\") + \"'\";\n     }\n+\n+    /**\n+     * Method used to apply in $in operators\n+     */\n+    private static String arrayValue(Object value) {\n+        StringBuilder arrayValue = new StringBuilder();\n+        List valueList = valueToList(value);\n+        for (int i = 0; i < valueList.size(); i++) {\n+            arrayValue.append(escape(valueList.get(i)));\n+            if (i + 1 < valueList.size()) {\n+                arrayValue.append(\", \");\n+            }\n+        }\n+        return arrayValue.toString();\n+    }\n+\n+    private static List valueToList(Object value) {\n+        if (value.getClass().isArray()) {\n+            return Arrays.asList((Object[]) value);\n+        }\n+\n+        return new ArrayList<>((Collection) value);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474b83f59228af2a416db0b0ba29eb0f61a8abc0"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MDkwMA==", "bodyText": "All operators are escaped with single quotes.\nI know this is not mandatory but I prefere to keep it this way", "url": "https://github.com/quarkusio/quarkus/pull/9268#discussion_r424450900", "createdAt": "2020-05-13T13:47:03Z", "author": {"login": "loicmathieu"}, "path": "extensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/binder/MongoParserVisitor.java", "diffHunk": "@@ -100,4 +100,13 @@ public String visitPathExpression(HqlParser.PathExpressionContext ctx) {\n         // this is the name of the field, we apply replacement and escape with '\n         return \"'\" + replacementMap.getOrDefault(ctx.getText(), ctx.getText()) + \"'\";\n     }\n+\n+    @Override\n+    public String visitInPredicate(HqlParser.InPredicateContext ctx) {\n+        StringBuilder sb = new StringBuilder(ctx.expression().accept(this))\n+                .append(\":{$in:[\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474b83f59228af2a416db0b0ba29eb0f61a8abc0"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MjA1MA==", "bodyText": "Can you escape field with single quotes as in the other examples ?\nAnd do the same in the other test methods", "url": "https://github.com/quarkusio/quarkus/pull/9268#discussion_r424452050", "createdAt": "2020-05-13T13:48:31Z", "author": {"login": "loicmathieu"}, "path": "extensions/panache/mongodb-panache/runtime/src/test/java/io/quarkus/mongodb/panache/runtime/MongoOperationsTest.java", "diffHunk": "@@ -97,6 +94,24 @@ public void testBindNativeFilterByIndex() {\n \n         query = MongoOperations.bindFilter(Object.class, \"{'field': ?1, 'isOk': ?2}\", new Object[] { \"a value\", true });\n         assertEquals(\"{'field': 'a value', 'isOk': true}\", query);\n+\n+        //queries related to $in operator\n+        List<Object> list = Arrays.asList(\"f1\", \"f2\");\n+        query = MongoOperations.bindFilter(DemoObj.class, \"{ field: { $in: [?1] } }\", new Object[] { list });\n+        assertEquals(\"{ field: { $in: ['f1', 'f2'] } }\", query);\n+\n+        query = MongoOperations.bindFilter(DemoObj.class, \"{ field: { $in: [?1] }, isOk: ?2 }\", new Object[] { list, true });\n+        assertEquals(\"{ field: { $in: ['f1', 'f2'] }, isOk: true }\", query);\n+\n+        query = MongoOperations.bindFilter(DemoObj.class,\n+                \"{ field: { $in: [?1] }, $or: [ {'property': ?2}, {'property': ?3} ] }\",\n+                new Object[] { list, \"jpg\", \"gif\" });\n+        assertEquals(\"{ field: { $in: ['f1', 'f2'] }, $or: [ {'property': 'jpg'}, {'property': 'gif'} ] }\", query);\n+\n+        query = MongoOperations.bindFilter(DemoObj.class,\n+                \"{ field: { $in: [?1] }, isOk: ?2, $or: [ {'property': ?3}, {'property': ?4} ] }\",\n+                new Object[] { list, true, \"jpg\", \"gif\" });\n+        assertEquals(\"{ field: { $in: ['f1', 'f2'] }, isOk: true, $or: [ {'property': 'jpg'}, {'property': 'gif'} ] }\", query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474b83f59228af2a416db0b0ba29eb0f61a8abc0"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MjU5OA==", "bodyText": "Don't commit commented code.\nRemove it or uncomment it.", "url": "https://github.com/quarkusio/quarkus/pull/9268#discussion_r424452598", "createdAt": "2020-05-13T13:49:21Z", "author": {"login": "loicmathieu"}, "path": "extensions/panache/mongodb-panache/runtime/src/test/java/io/quarkus/mongodb/panache/runtime/MongoOperationsTest.java", "diffHunk": "@@ -273,4 +352,43 @@ public void testBindUpdate() {\n                 Parameters.with(\"field\", \"a value\").map());\n         assertEquals(\"{'$set':{'field':'a value'}}\", update);\n     }\n+\n+    //    @Test\n+    //    public void testBuildNativeQueryWithInOperator() {\n+    //        List<Object> list = Arrays.asList(\"id1\", \"id2\");\n+    //        String query = MongoOperations.bindFilter(DemoObj.class, \"{ id: { $in: [?1] } }\", new Object[]{list});\n+    //        assertEquals(\"{ id: { $in: ['id1', 'id2'] } }\", query);\n+    //    }\n+    //\n+    //    @Test\n+    //    public void testBuildNativeWithInPlusAndOperators() {\n+    //        List<Object> list = Arrays.asList(\"id1\", \"id2\");\n+    //        String query = MongoOperations.bindQuery(DemoObj.class, \"{ id: { $in: [?1] }, isOk: ?2 }\", new Object[]{list, true});\n+    //        assertEquals(\"{ id: { $in: ['id1', 'id2'] }, isOk: true }\", query);\n+    //    }\n+    //\n+    //    @Test\n+    //    public void testBuildNativeWithInPlusOrOperators() {\n+    //        List<Object> list = Arrays.asList(\"id1\", \"id2\");\n+    //        String query = MongoOperations.bindQuery(DemoObj.class,\n+    //                \"{ id: { $in: [?1] }, $or: [ {'property': ?2}, {'property': ?3} ] }\",\n+    //                new Object[]{list, \"jpg\", \"gif\"});\n+    //        assertEquals(\"{ id: { $in: ['id1', 'id2'] }, $or: [ {'property': 'jpg'}, {'property': 'gif'} ] }\", query);\n+    //    }\n+    //\n+    //    @Test\n+    //    public void testBuildNativeWithInPlusAndPlusOrOperators() {\n+    //        List<Object> list = Arrays.asList(\"id1\", \"id2\");\n+    //        String query = MongoOperations.bindQuery(DemoObj.class,\n+    //                \"{ _id: { $in: [?1] }, isOk: ?2, $or: [ {'property': ?3}, {'property': ?4} ] }\",\n+    //                new Object[]{list, true, \"jpg\", \"gif\"});\n+    //        assertEquals(\"{ _id: { $in: ['id1', 'id2'] }, isOk: true, $or: [ {'property': 'jpg'}, {'property': 'gif'} ] }\", query);\n+    //    }\n+    //\n+    //    @Test\n+    //    public void testBuildQueryWithInOperator() {\n+    //        List<Object> list = Arrays.asList(\"id1\", \"id2\");\n+    //        String query = MongoOperations.bindQuery(DemoObj.class, \"id in ?1\", new Object[]{list});\n+    //        assertEquals(\"{ id: { $in: ['id1', 'id2'] } }\", query);\n+    //    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474b83f59228af2a416db0b0ba29eb0f61a8abc0"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1MzEwNg==", "bodyText": "Wildcard imports are prohibited", "url": "https://github.com/quarkusio/quarkus/pull/9268#discussion_r424453106", "createdAt": "2020-05-13T13:49:54Z", "author": {"login": "loicmathieu"}, "path": "extensions/panache/mongodb-panache/runtime/src/test/java/io/quarkus/mongodb/panache/runtime/MongoOperationsTest.java", "diffHunk": "@@ -6,10 +6,7 @@\n import java.time.LocalDateTime;\n import java.time.ZoneId;\n import java.time.ZoneOffset;\n-import java.util.Collections;\n-import java.util.Date;\n-import java.util.HashMap;\n-import java.util.Map;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474b83f59228af2a416db0b0ba29eb0f61a8abc0"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDI3NDYx", "url": "https://github.com/quarkusio/quarkus/pull/9268#pullrequestreview-411027461", "createdAt": "2020-05-13T15:12:25Z", "commit": {"oid": "c6ef8f625d4399c6212fb7f5c0e080765a7ca4f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f030833e71615fcd8c36f08155521a84bf226e1", "author": {"user": {"login": "diogocarleto", "name": "Diogo Carleto"}}, "url": "https://github.com/quarkusio/quarkus/commit/5f030833e71615fcd8c36f08155521a84bf226e1", "committedDate": "2020-05-15T08:54:52Z", "message": "adding support to $in operator."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "debaaf269d4f547bce9b39b304c7ca3e5b2dc87a", "author": {"user": {"login": "diogocarleto", "name": "Diogo Carleto"}}, "url": "https://github.com/quarkusio/quarkus/commit/debaaf269d4f547bce9b39b304c7ca3e5b2dc87a", "committedDate": "2020-05-14T14:01:34Z", "message": "Merge branch 'master' of https://github.com/quarkusio/quarkus into mongoPanacheInOperatorFix\n\n# Conflicts:\n#\textensions/panache/mongodb-panache/runtime/src/main/java/io/quarkus/mongodb/panache/package-info.java"}, "afterCommit": {"oid": "5f030833e71615fcd8c36f08155521a84bf226e1", "author": {"user": {"login": "diogocarleto", "name": "Diogo Carleto"}}, "url": "https://github.com/quarkusio/quarkus/commit/5f030833e71615fcd8c36f08155521a84bf226e1", "committedDate": "2020-05-15T08:54:52Z", "message": "adding support to $in operator."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNDY2OTIx", "url": "https://github.com/quarkusio/quarkus/pull/9268#pullrequestreview-412466921", "createdAt": "2020-05-15T08:55:54Z", "commit": {"oid": "5f030833e71615fcd8c36f08155521a84bf226e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3442, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}