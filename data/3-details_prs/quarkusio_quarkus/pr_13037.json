{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMjA4NTgx", "number": 13037, "title": "Support micrometer StatsD meter registry", "bodyText": "Resolves #12900\nTo be clear: this enables the registry in JVM mode. Native mode is (for the moment) disabled, as I work with the micrometer team on how best to disentangle the reactor/shaded netty dependencies", "createdAt": "2020-10-30T18:34:19Z", "url": "https://github.com/quarkusio/quarkus/pull/13037", "merged": true, "mergeCommit": {"oid": "9f5d77a4906d33a984df87f287fe38d6f01bdafe"}, "closed": true, "closedAt": "2020-11-02T09:36:56Z", "author": {"login": "ebullient"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXrf6UAFqTUyMDk1MjM3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYTuCdABqjM5NDU0MjM3NjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTUyMzcy", "url": "https://github.com/quarkusio/quarkus/pull/13037#pullrequestreview-520952372", "createdAt": "2020-10-30T18:58:16Z", "commit": {"oid": "12a0bb52219f1e000c59443902549c15dba2ea1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12a0bb52219f1e000c59443902549c15dba2ea1a", "author": {"user": {"login": "ebullient", "name": "Erin Schnabel"}}, "url": "https://github.com/quarkusio/quarkus/commit/12a0bb52219f1e000c59443902549c15dba2ea1a", "committedDate": "2020-10-30T18:32:58Z", "message": "General IT for meter registry startup"}, "afterCommit": {"oid": "57fd7c690a17ff431d12548a47f1358717462faa", "author": {"user": {"login": "ebullient", "name": "Erin Schnabel"}}, "url": "https://github.com/quarkusio/quarkus/commit/57fd7c690a17ff431d12548a47f1358717462faa", "committedDate": "2020-10-30T19:38:37Z", "message": "General IT for meter registry startup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTkzMjIx", "url": "https://github.com/quarkusio/quarkus/pull/13037#pullrequestreview-520993221", "createdAt": "2020-10-30T19:56:18Z", "commit": {"oid": "57fd7c690a17ff431d12548a47f1358717462faa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTo1NjoxOVrOHreNxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTo1NjoxOVrOHreNxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM0NTg2MA==", "bodyText": "This class can extend NativeMeterRegistriesTest?", "url": "https://github.com/quarkusio/quarkus/pull/13037#discussion_r515345860", "createdAt": "2020-10-30T19:56:19Z", "author": {"login": "machi1990"}, "path": "integration-tests/micrometer-native/src/test/java/io/quarkus/it/micrometer/native_mode/NativeMeterRegistriesIT.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package io.quarkus.it.micrometer.native_mode;\n+\n+import static io.restassured.RestAssured.given;\n+\n+import java.util.List;\n+\n+import org.hamcrest.MatcherAssert;\n+import org.hamcrest.Matchers;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.Test;\n+\n+import io.quarkus.test.junit.NativeImageTest;\n+import io.restassured.response.Response;\n+\n+@NativeImageTest\n+class NativeMeterRegistriesIT {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57fd7c690a17ff431d12548a47f1358717462faa"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTkzNDg0", "url": "https://github.com/quarkusio/quarkus/pull/13037#pullrequestreview-520993484", "createdAt": "2020-10-30T19:56:44Z", "commit": {"oid": "57fd7c690a17ff431d12548a47f1358717462faa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTo1Njo0NFrOHreOcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOTo1Njo0NFrOHreOcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM0NjAzNA==", "bodyText": "wildcard imports are not used throughtout the codebase.", "url": "https://github.com/quarkusio/quarkus/pull/13037#discussion_r515346034", "createdAt": "2020-10-30T19:56:44Z", "author": {"login": "machi1990"}, "path": "integration-tests/micrometer-native/src/main/java/io/quarkus/it/micrometer/native_mode/MessageResource.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package io.quarkus.it.micrometer.native_mode;\n+\n+import java.lang.management.ManagementFactory;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import javax.management.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57fd7c690a17ff431d12548a47f1358717462faa"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxMDgwNzUz", "url": "https://github.com/quarkusio/quarkus/pull/13037#pullrequestreview-521080753", "createdAt": "2020-10-30T23:12:02Z", "commit": {"oid": "57fd7c690a17ff431d12548a47f1358717462faa"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzoxMjowMlrOHris3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMzoxMjo0OVrOHritYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQxOTM1Ng==", "bodyText": "This one doesn't seem to be used?", "url": "https://github.com/quarkusio/quarkus/pull/13037#discussion_r515419356", "createdAt": "2020-10-30T23:12:02Z", "author": {"login": "gsmet"}, "path": "integration-tests/micrometer-native/src/main/java/io/quarkus/it/micrometer/native_mode/MessageResource.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package io.quarkus.it.micrometer.native_mode;\n+\n+import java.lang.management.ManagementFactory;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+import javax.management.*;\n+\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.composite.CompositeMeterRegistry;\n+import io.quarkus.vertx.web.Route;\n+import io.quarkus.vertx.web.RouteBase;\n+import io.vertx.core.http.HttpMethod;\n+\n+@RouteBase(path = \"/message\")\n+public class MessageResource {\n+\n+    private final MeterRegistry registry;\n+    private final MBeanServer mBeanServer = ManagementFactory.getPlatformMBeanServer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57fd7c690a17ff431d12548a47f1358717462faa"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTQxOTQ5MQ==", "bodyText": "What is the reason why we don't support native mode for all these exporters?", "url": "https://github.com/quarkusio/quarkus/pull/13037#discussion_r515419491", "createdAt": "2020-10-30T23:12:49Z", "author": {"login": "gsmet"}, "path": "extensions/micrometer/deployment/src/main/java/io/quarkus/micrometer/deployment/export/StatsdRegistryProcessor.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package io.quarkus.micrometer.deployment.export;\n+\n+import java.util.function.BooleanSupplier;\n+\n+import org.jboss.logging.Logger;\n+\n+import io.quarkus.arc.deployment.AdditionalBeanBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.pkg.steps.NativeBuild;\n+import io.quarkus.micrometer.deployment.MicrometerRegistryProviderBuildItem;\n+import io.quarkus.micrometer.runtime.MicrometerRecorder;\n+import io.quarkus.micrometer.runtime.config.MicrometerConfig;\n+import io.quarkus.micrometer.runtime.export.StatsdMeterRegistryProvider;\n+\n+/**\n+ * Add support for the StatsD Meter Registry. Note that the registry may not\n+ * be available at deployment time for some projects: Avoid direct class\n+ * references.\n+ */\n+public class StatsdRegistryProcessor {\n+    private static final Logger log = Logger.getLogger(StatsdRegistryProcessor.class);\n+\n+    static final String REGISTRY_CLASS_NAME = \"io.micrometer.statsd.StatsdMeterRegistry\";\n+    static final Class<?> REGISTRY_CLASS = MicrometerRecorder.getClassForName(REGISTRY_CLASS_NAME);\n+\n+    public static class StatsdRegistryEnabled implements BooleanSupplier {\n+        MicrometerConfig mConfig;\n+\n+        @Override\n+        public boolean getAsBoolean() {\n+            return REGISTRY_CLASS != null && mConfig.checkRegistryEnabledWithDefault(mConfig.export.statsd);\n+        }\n+    }\n+\n+    @BuildStep(onlyIf = { NativeBuild.class, StatsdRegistryEnabled.class })\n+    MicrometerRegistryProviderBuildItem nativeModeNotSupported() {\n+        log.info(\"The StatsD meter registry does not support running in native mode.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57fd7c690a17ff431d12548a47f1358717462faa"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57fd7c690a17ff431d12548a47f1358717462faa", "author": {"user": {"login": "ebullient", "name": "Erin Schnabel"}}, "url": "https://github.com/quarkusio/quarkus/commit/57fd7c690a17ff431d12548a47f1358717462faa", "committedDate": "2020-10-30T19:38:37Z", "message": "General IT for meter registry startup"}, "afterCommit": {"oid": "677e83a6ece267318ec1b8ff589a1c086ea949e0", "author": {"user": {"login": "ebullient", "name": "Erin Schnabel"}}, "url": "https://github.com/quarkusio/quarkus/commit/677e83a6ece267318ec1b8ff589a1c086ea949e0", "committedDate": "2020-10-31T01:03:09Z", "message": "General IT for meter registry startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2795823de60424a725bdb125366005c5ec807bf", "author": {"user": {"login": "ebullient", "name": "Erin Schnabel"}}, "url": "https://github.com/quarkusio/quarkus/commit/f2795823de60424a725bdb125366005c5ec807bf", "committedDate": "2020-11-01T17:49:46Z", "message": "Support StatsD micrometer meter registry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7df387070ee079eb6b3ac809d31fcb31658c9c7", "author": {"user": {"login": "ebullient", "name": "Erin Schnabel"}}, "url": "https://github.com/quarkusio/quarkus/commit/d7df387070ee079eb6b3ac809d31fcb31658c9c7", "committedDate": "2020-11-01T17:49:46Z", "message": "General IT for meter registry startup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "677e83a6ece267318ec1b8ff589a1c086ea949e0", "author": {"user": {"login": "ebullient", "name": "Erin Schnabel"}}, "url": "https://github.com/quarkusio/quarkus/commit/677e83a6ece267318ec1b8ff589a1c086ea949e0", "committedDate": "2020-10-31T01:03:09Z", "message": "General IT for meter registry startup"}, "afterCommit": {"oid": "d7df387070ee079eb6b3ac809d31fcb31658c9c7", "author": {"user": {"login": "ebullient", "name": "Erin Schnabel"}}, "url": "https://github.com/quarkusio/quarkus/commit/d7df387070ee079eb6b3ac809d31fcb31658c9c7", "committedDate": "2020-11-01T17:49:46Z", "message": "General IT for meter registry startup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1597, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}