{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5OTM5MDY5", "number": 6938, "title": "Configure all Test tasks properly (#3552)", "bodyText": "Also configure Test tasks that are created (in the build file, or in other plugins) after the quarkus plugin is applied.", "createdAt": "2020-02-01T20:59:10Z", "url": "https://github.com/quarkusio/quarkus/pull/6938", "merged": true, "mergeCommit": {"oid": "f17cd20271ecbbce31158d0a9413c526aeca1f45"}, "closed": true, "closedAt": "2020-02-12T14:44:05Z", "author": {"login": "jskov"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAYkb0AFqTM1MTk0MjYzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDnbKIgFqTM1NzUwNzI2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTQyNjMy", "url": "https://github.com/quarkusio/quarkus/pull/6938#pullrequestreview-351942632", "createdAt": "2020-02-02T13:43:36Z", "commit": {"oid": "fad3174c59c292c793aaa2d28f7b9c3aa9a1a8dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMTMwODYx", "url": "https://github.com/quarkusio/quarkus/pull/6938#pullrequestreview-352130861", "createdAt": "2020-02-03T09:52:29Z", "commit": {"oid": "fad3174c59c292c793aaa2d28f7b9c3aa9a1a8dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo1MjoyOVrOFkrolA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo1MjoyOVrOFkrolA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAwNzk1Ng==", "bodyText": "This doesn't work in JDK 8 AFAIK", "url": "https://github.com/quarkusio/quarkus/pull/6938#discussion_r374007956", "createdAt": "2020-02-03T09:52:29Z", "author": {"login": "gastaldi"}, "path": "devtools/gradle/src/functionalTest/java/io/quarkus/gradle/TaskDependenciesFunctionalTest.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package io.quarkus.gradle;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+import org.gradle.testkit.runner.BuildResult;\n+import org.gradle.testkit.runner.GradleRunner;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+public class TaskDependenciesFunctionalTest {\n+    @TempDir Path projectDir;\n+\n+    /**\n+     * Ensure that all Test tasks depend on the task\n+     * QuarkusTestConfig\n+     * This should include Test tasks created after the\n+     * plugin is applied (such as acceptTest in this test).\n+     */\n+    @Test\n+    public void shouldMakeTestTasksDependOnQuarkusTestConfig() throws IOException {\n+        createBuildFile();\n+        \n+        BuildResult build = GradleRunner.create()\n+                .withProjectDir(projectDir.toFile())\n+                .withArguments(\"-m\", \"acceptTest\")\n+                .withPluginClasspath()\n+                .build();\n+        \n+        assertThat(build.getOutput()).contains(\":quarkusTestConfig SKIPPED\");\n+    }\n+\n+    private void createBuildFile() throws IOException {\n+        Path buildFile = projectDir.resolve(\"build.gradle\");\n+        \n+        try (InputStream is = getClass().getResourceAsStream(\"/TaskDependenciesFunctionalTest.gradle\")) {\n+            String txt = new String(is.readAllBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fad3174c59c292c793aaa2d28f7b9c3aa9a1a8dd"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMjQwMDc4", "url": "https://github.com/quarkusio/quarkus/pull/6938#pullrequestreview-352240078", "createdAt": "2020-02-03T13:10:39Z", "commit": {"oid": "fad3174c59c292c793aaa2d28f7b9c3aa9a1a8dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzoxMDo0MFrOFkwyQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzoxMDo0MFrOFkwyQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5MjM1NA==", "bodyText": "tasks.withType(Test.class).whenTaskAdded(configureTestTask) ?", "url": "https://github.com/quarkusio/quarkus/pull/6938#discussion_r374092354", "createdAt": "2020-02-03T13:10:40Z", "author": {"login": "gastaldi"}, "path": "devtools/gradle/src/main/java/io/quarkus/gradle/QuarkusPlugin.java", "diffHunk": "@@ -104,15 +105,18 @@ private void registerTasks(Project project) {\n                     Task testNative = tasks.create(TEST_NATIVE_TASK_NAME, QuarkusTestNative.class);\n                     testNative.dependsOn(buildNative);\n                     testNative.setShouldRunAfter(Collections.singletonList(tasks.findByName(JavaPlugin.TEST_TASK_NAME)));\n-                    tasks.withType(Test.class).forEach(t -> {\n+\n+                    Consumer<Test> configureTestTask = t -> {\n                         // Quarkus test configuration task which should be executed before any Quarkus test\n                         t.dependsOn(quarkusTestConfig);\n                         // also make each task use the JUnit platform since it's the only supported test environment\n                         t.useJUnitPlatform();\n-                    });\n+                    };\n+                    tasks.withType(Test.class).forEach(configureTestTask);\n+                    tasks.withType(Test.class).whenTaskAdded(t -> configureTestTask.accept(t));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fad3174c59c292c793aaa2d28f7b9c3aa9a1a8dd"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMjQxMDQ4", "url": "https://github.com/quarkusio/quarkus/pull/6938#pullrequestreview-352241048", "createdAt": "2020-02-03T13:12:26Z", "commit": {"oid": "fad3174c59c292c793aaa2d28f7b9c3aa9a1a8dd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzoxMjoyNlrOFkw1HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMzoxMjoyNlrOFkw1HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA5MzA4NA==", "bodyText": "This is also not compatible with JDK 8 as Files.writeString was introduced in JDK 11", "url": "https://github.com/quarkusio/quarkus/pull/6938#discussion_r374093084", "createdAt": "2020-02-03T13:12:26Z", "author": {"login": "gastaldi"}, "path": "devtools/gradle/src/functionalTest/java/io/quarkus/gradle/TaskDependenciesFunctionalTest.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package io.quarkus.gradle;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+import org.gradle.testkit.runner.BuildResult;\n+import org.gradle.testkit.runner.GradleRunner;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+public class TaskDependenciesFunctionalTest {\n+    @TempDir Path projectDir;\n+\n+    /**\n+     * Ensure that all Test tasks depend on the task\n+     * QuarkusTestConfig\n+     * This should include Test tasks created after the\n+     * plugin is applied (such as acceptTest in this test).\n+     */\n+    @Test\n+    public void shouldMakeTestTasksDependOnQuarkusTestConfig() throws IOException {\n+        createBuildFile();\n+        \n+        BuildResult build = GradleRunner.create()\n+                .withProjectDir(projectDir.toFile())\n+                .withArguments(\"-m\", \"acceptTest\")\n+                .withPluginClasspath()\n+                .build();\n+        \n+        assertThat(build.getOutput()).contains(\":quarkusTestConfig SKIPPED\");\n+    }\n+\n+    private void createBuildFile() throws IOException {\n+        Path buildFile = projectDir.resolve(\"build.gradle\");\n+        \n+        try (InputStream is = getClass().getResourceAsStream(\"/TaskDependenciesFunctionalTest.gradle\")) {\n+            String txt = new String(is.readAllBytes());\n+            Files.writeString(buildFile, txt);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fad3174c59c292c793aaa2d28f7b9c3aa9a1a8dd"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d76978ad9e21b192644675e220d9ec14a894605f", "author": {"user": {"login": "jskov", "name": "Jesper Skov"}}, "url": "https://github.com/quarkusio/quarkus/commit/d76978ad9e21b192644675e220d9ec14a894605f", "committedDate": "2020-02-11T16:53:42Z", "message": "Configure all Test tasks properly (#3552)\n\nAlso configure test tasks that are created (in the build file, or\nin other plugins) after the quarkus plugin is applied."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NTA3MjYx", "url": "https://github.com/quarkusio/quarkus/pull/6938#pullrequestreview-357507261", "createdAt": "2020-02-12T14:43:49Z", "commit": {"oid": "d76978ad9e21b192644675e220d9ec14a894605f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 34, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}