{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NTY5NDQw", "number": 10016, "title": "Hibernate Reactive session and connection leaks", "bodyText": "Fixes #10015", "createdAt": "2020-06-15T14:14:41Z", "url": "https://github.com/quarkusio/quarkus/pull/10016", "merged": true, "mergeCommit": {"oid": "a246657fbce2a310ca18b349e31d807b6f9575da"}, "closed": true, "closedAt": "2020-06-17T08:51:26Z", "author": {"login": "tsegismont"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrh-GDgFqTQzMDcyODIzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr4nNOABqjM0NTAwNzQ0NjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNzI4MjM0", "url": "https://github.com/quarkusio/quarkus/pull/10016#pullrequestreview-430728234", "createdAt": "2020-06-15T14:59:31Z", "commit": {"oid": "0a656cfd441e77e1349139371d6b824e54cea59d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a656cfd441e77e1349139371d6b824e54cea59d", "author": {"user": {"login": "tsegismont", "name": "Thomas Segismont"}}, "url": "https://github.com/quarkusio/quarkus/commit/0a656cfd441e77e1349139371d6b824e54cea59d", "committedDate": "2020-06-15T14:14:19Z", "message": "HibernateReactiveTestEndpoint#populateDB leaks a connection"}, "afterCommit": {"oid": "8b627340f00567a369e7d80355e9d20941b02615", "author": {"user": {"login": "tsegismont", "name": "Thomas Segismont"}}, "url": "https://github.com/quarkusio/quarkus/commit/8b627340f00567a369e7d80355e9d20941b02615", "committedDate": "2020-06-15T15:42:30Z", "message": "Hibernate Reactive session and connection leaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNzg4NTYy", "url": "https://github.com/quarkusio/quarkus/pull/10016#pullrequestreview-430788562", "createdAt": "2020-06-15T16:06:47Z", "commit": {"oid": "8b627340f00567a369e7d80355e9d20941b02615"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNjowNjo0OFrOGj47AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNjowODoyMlrOGj4-kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4NTk1Mw==", "bodyText": "I think this is a justifiable limitation of the Uni<Mutiny.Session> functionality, because CompletionStage<Stage.Session> behaves in the same way, so we make it cached and use the same session in the entire request.", "url": "https://github.com/quarkusio/quarkus/pull/10016#discussion_r440285953", "createdAt": "2020-06-15T16:06:48Z", "author": {"login": "FroMage"}, "path": "extensions/hibernate-reactive/runtime/src/main/java/io/quarkus/hibernate/reactive/runtime/ReactiveSessionProducer.java", "diffHunk": "@@ -34,7 +34,7 @@\n     @RequestScoped\n     @DefaultBean\n     public Uni<Mutiny.Session> mutinySession() {\n-        return mutinySessionFactory.openSession();\n+        return mutinySessionFactory.openSession().cache();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b627340f00567a369e7d80355e9d20941b02615"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4Njg2Nw==", "bodyText": "At this point it could be interesting to figure out if the reactiveSession has already been subscribed to, because if not, it will never have been produced and doesn't need to be closed. We might be creating it just to close it.\nBut I'm pretty sure that the current implementation is based on CompletionStage so it's eager and will always be created, so we can forget this optimisation for now.", "url": "https://github.com/quarkusio/quarkus/pull/10016#discussion_r440286867", "createdAt": "2020-06-15T16:08:22Z", "author": {"login": "FroMage"}, "path": "extensions/hibernate-reactive/runtime/src/main/java/io/quarkus/hibernate/reactive/runtime/ReactiveSessionProducer.java", "diffHunk": "@@ -45,11 +45,7 @@ public void disposeStageSession(@Disposes CompletionStage<Stage.Session> reactiv\n     }\n \n     public void disposeMutinySession(@Disposes Uni<Mutiny.Session> reactiveSession) {\n-        // TODO: @AGG this is not working, need to check w/ Clement to figure out the proper way\n-        reactiveSession.on().termination((session, ex, cancelled) -> {\n-            if (session != null)\n-                session.close();\n-        });\n+        reactiveSession.subscribe().with(Mutiny.Session::close);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b627340f00567a369e7d80355e9d20941b02615"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODYxNTMy", "url": "https://github.com/quarkusio/quarkus/pull/10016#pullrequestreview-430861532", "createdAt": "2020-06-15T17:45:10Z", "commit": {"oid": "8b627340f00567a369e7d80355e9d20941b02615"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67a3593102f81092315ed5b137ffbeba1f0d9828", "author": {"user": {"login": "tsegismont", "name": "Thomas Segismont"}}, "url": "https://github.com/quarkusio/quarkus/commit/67a3593102f81092315ed5b137ffbeba1f0d9828", "committedDate": "2020-06-16T17:22:08Z", "message": "Hibernate Reactive session and connection leaks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b627340f00567a369e7d80355e9d20941b02615", "author": {"user": {"login": "tsegismont", "name": "Thomas Segismont"}}, "url": "https://github.com/quarkusio/quarkus/commit/8b627340f00567a369e7d80355e9d20941b02615", "committedDate": "2020-06-15T15:42:30Z", "message": "Hibernate Reactive session and connection leaks"}, "afterCommit": {"oid": "67a3593102f81092315ed5b137ffbeba1f0d9828", "author": {"user": {"login": "tsegismont", "name": "Thomas Segismont"}}, "url": "https://github.com/quarkusio/quarkus/commit/67a3593102f81092315ed5b137ffbeba1f0d9828", "committedDate": "2020-06-16T17:22:08Z", "message": "Hibernate Reactive session and connection leaks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4376, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}