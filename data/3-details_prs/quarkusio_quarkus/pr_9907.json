{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMzcxNjMw", "number": 9907, "title": "Correctly register metrics for inherited default methods", "bodyText": "Fixes #9887", "createdAt": "2020-06-10T10:48:01Z", "url": "https://github.com/quarkusio/quarkus/pull/9907", "merged": true, "mergeCommit": {"oid": "0899731092a5e61bc7315235d289db3e8da8d39e"}, "closed": true, "closedAt": "2020-06-22T05:56:33Z", "author": {"login": "jmartisk"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp4VYggFqTQyNzk3NzI0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqJ0bpgFqTQyODY5MDg3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3OTc3MjQ1", "url": "https://github.com/quarkusio/quarkus/pull/9907#pullrequestreview-427977245", "createdAt": "2020-06-10T11:55:01Z", "commit": {"oid": "6660b1185ae60577cd098b17627df8b75d831209"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMTo1NTowMVrOGhxWjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMTo1NTowMVrOGhxWjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA2NDc4Mw==", "bodyText": "Is that true? It seems that you call findNonOverriddenDefaultMethods when you traverse the inheritance hierachy, so not all superclasses are processed yet when you call this method. Would it be better to traverse the inheritance hierarchy twice, first to process superclasses, and second to process interfaces?", "url": "https://github.com/quarkusio/quarkus/pull/9907#discussion_r438064783", "createdAt": "2020-06-10T11:55:01Z", "author": {"login": "Ladicek"}, "path": "extensions/smallrye-metrics/deployment/src/main/java/io/quarkus/smallrye/metrics/deployment/SmallRyeMetricsProcessor.java", "diffHunk": "@@ -396,6 +407,35 @@ void registerMetricsFromAnnotatedMethods(SmallRyeMetricsRecorder metrics,\n         }\n     }\n \n+    private void findNonOverriddenDefaultMethods(ClassInfo interfaceInfo, List<ClassInfo> subClasses,\n+            SmallRyeMetricsRecorder recorder,\n+            BeanArchiveIndexBuildItem beanArchiveIndex, JandexMemberInfoAdapter memberInfoAdapter, BeanInfo beanInfo) {\n+        // Check for default methods which are NOT overridden by the bean that we are registering metrics for\n+        // or any of its superclasses. Register a metric for each of them.\n+        interfaceInfo.methods().forEach(method -> {\n+            if (!Modifier.isAbstract(method.flags())) { // only take default methods\n+                // Here we check that the default method is not overridden by the bean of any of its superclasses,\n+                // because in such case it was already picked up while scanning through superclasses and their methods", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6660b1185ae60577cd098b17627df8b75d831209"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6660b1185ae60577cd098b17627df8b75d831209", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/6660b1185ae60577cd098b17627df8b75d831209", "committedDate": "2020-06-10T10:46:45Z", "message": "Correctly register metrics for inherited default methods"}, "afterCommit": {"oid": "9291c70db048eb268fe5595e7c544a127239ebc7", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/9291c70db048eb268fe5595e7c544a127239ebc7", "committedDate": "2020-06-11T07:53:47Z", "message": "Correctly register metrics for inherited default methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4Njc3ODcx", "url": "https://github.com/quarkusio/quarkus/pull/9907#pullrequestreview-428677871", "createdAt": "2020-06-11T07:58:44Z", "commit": {"oid": "9291c70db048eb268fe5595e7c544a127239ebc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNzo1ODo0NFrOGiSnCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNzo1ODo0NFrOGiSnCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYwOTY3Mw==", "bodyText": "Should it be a Set?", "url": "https://github.com/quarkusio/quarkus/pull/9907#discussion_r438609673", "createdAt": "2020-06-11T07:58:44Z", "author": {"login": "Ladicek"}, "path": "extensions/smallrye-metrics/deployment/src/main/java/io/quarkus/smallrye/metrics/deployment/SmallRyeMetricsProcessor.java", "diffHunk": "@@ -370,17 +371,22 @@ void registerMetricsFromAnnotatedMethods(SmallRyeMetricsRecorder metrics,\n         for (ClassInfo clazz : collectedMetricsClasses.values()) {\n             BeanInfo beanInfo = beanInfoAdapter.convert(clazz);\n             ClassInfo superclass = clazz;\n+            List<String> alreadyRegisteredNames = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9291c70db048eb268fe5595e7c544a127239ebc7"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9291c70db048eb268fe5595e7c544a127239ebc7", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/9291c70db048eb268fe5595e7c544a127239ebc7", "committedDate": "2020-06-11T07:53:47Z", "message": "Correctly register metrics for inherited default methods"}, "afterCommit": {"oid": "fe5e3122d5d784c6b9ca0df602d2ea2244609a72", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/fe5e3122d5d784c6b9ca0df602d2ea2244609a72", "committedDate": "2020-06-11T08:09:24Z", "message": "Correctly register metrics for inherited default methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe5e3122d5d784c6b9ca0df602d2ea2244609a72", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/fe5e3122d5d784c6b9ca0df602d2ea2244609a72", "committedDate": "2020-06-11T08:09:24Z", "message": "Correctly register metrics for inherited default methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjkwODcw", "url": "https://github.com/quarkusio/quarkus/pull/9907#pullrequestreview-428690870", "createdAt": "2020-06-11T08:17:19Z", "commit": {"oid": "fe5e3122d5d784c6b9ca0df602d2ea2244609a72"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4330, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}