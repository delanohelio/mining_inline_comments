{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3OTY0MTk0", "number": 6824, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMTozNjo0NVrODbMDiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo0MjoyMFrODckfqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5ODM1NjU2OnYy", "diffSide": "RIGHT", "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMTozNjo0NVrOFih34A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwOTowMzoyMlrOFmTknQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MDg4MA==", "bodyText": "On Jaeger creates metrics. On runtime restart a new tracer is created therefore a set of metrics is registered. On multiple restarts the same set of metrics are being registered which causes\nCaused by: java.lang.IllegalArgumentException: A metric with metricID MetricID{name='jaeger_tracer_reporter_queue_length', tags=[]} already exists\n\tat io.smallrye.metrics.MetricsRegistryImpl.register(MetricsRegistryImpl.java:129)\n\tat io.quarkus.jaeger.runtime.QuarkusJaegerMetricsFactory.createGauge(QuarkusJaegerMetricsFactory.java:48)\n\tat io.jaegertracing.internal.metrics.Metrics.createMetrics(Metrics.java:66)\n\t... 37 more\n\nDoes anybody know a better solution to this?", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r371750880", "createdAt": "2020-01-28T11:36:45Z", "author": {"login": "pavolloffay"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "diffHunk": "@@ -21,6 +21,9 @@\n \n     @Override\n     public Counter createCounter(final String name, final Map<String, String> tags) {\n+        // On restart (e.g. in dev mode) Jaeger registers\n+        // the same metrics which would result in exception\n+        registry.remove(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "615136c46264f1e8684f99d126745510434f4786"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc3ODU4Mg==", "bodyText": "@jmartisk perhaps?", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r371778582", "createdAt": "2020-01-28T12:42:12Z", "author": {"login": "geoand"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "diffHunk": "@@ -21,6 +21,9 @@\n \n     @Override\n     public Counter createCounter(final String name, final Map<String, String> tags) {\n+        // On restart (e.g. in dev mode) Jaeger registers\n+        // the same metrics which would result in exception\n+        registry.remove(name);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MDg4MA=="}, "originalCommit": {"oid": "615136c46264f1e8684f99d126745510434f4786"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA0NDQ2Mg==", "bodyText": "@jmartisk Any idea about this?", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r374044462", "createdAt": "2020-02-03T11:10:37Z", "author": {"login": "geoand"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "diffHunk": "@@ -21,6 +21,9 @@\n \n     @Override\n     public Counter createCounter(final String name, final Map<String, String> tags) {\n+        // On restart (e.g. in dev mode) Jaeger registers\n+        // the same metrics which would result in exception\n+        registry.remove(name);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MDg4MA=="}, "originalCommit": {"oid": "615136c46264f1e8684f99d126745510434f4786"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY5OTI5MQ==", "bodyText": "Oh, my deepest apologies for such late reply! The notifications got buried somewhere and I probably skipped over them when there we too many of them to have a thorough look.\nI suppose you should use a shutdown task for any metric that the extension creates so that it will get removed on each live reload\nSee https://github.com/quarkusio/quarkus/blob/master/extensions/smallrye-metrics/runtime/src/main/java/io/quarkus/smallrye/metrics/runtime/SmallRyeMetricsRecorder.java#L110\nI am seriously considering changing the Metrics extension so that all metrics will be removed automatically though, so this will not be needed anymore", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r375699291", "createdAt": "2020-02-06T08:37:45Z", "author": {"login": "jmartisk"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "diffHunk": "@@ -21,6 +21,9 @@\n \n     @Override\n     public Counter createCounter(final String name, final Map<String, String> tags) {\n+        // On restart (e.g. in dev mode) Jaeger registers\n+        // the same metrics which would result in exception\n+        registry.remove(name);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MDg4MA=="}, "originalCommit": {"oid": "615136c46264f1e8684f99d126745510434f4786"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcwMDEzNQ==", "bodyText": "No problem @jmartisk !", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r375700135", "createdAt": "2020-02-06T08:40:01Z", "author": {"login": "geoand"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "diffHunk": "@@ -21,6 +21,9 @@\n \n     @Override\n     public Counter createCounter(final String name, final Map<String, String> tags) {\n+        // On restart (e.g. in dev mode) Jaeger registers\n+        // the same metrics which would result in exception\n+        registry.remove(name);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MDg4MA=="}, "originalCommit": {"oid": "615136c46264f1e8684f99d126745510434f4786"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcwMjkxNA==", "bodyText": "Or is this something that happens dynamically at runtime, rather than through a recorder? In that case I suppose you can't use a shutdown task, and I'd say the right thing to do is to remove them like you do atm, until we perform the Metrics change I mentioned.", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r375702914", "createdAt": "2020-02-06T08:46:24Z", "author": {"login": "jmartisk"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "diffHunk": "@@ -21,6 +21,9 @@\n \n     @Override\n     public Counter createCounter(final String name, final Map<String, String> tags) {\n+        // On restart (e.g. in dev mode) Jaeger registers\n+        // the same metrics which would result in exception\n+        registry.remove(name);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MDg4MA=="}, "originalCommit": {"oid": "615136c46264f1e8684f99d126745510434f4786"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcxMDg3Nw==", "bodyText": "thanks @jmartisk then I will keep this here.", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r375710877", "createdAt": "2020-02-06T09:03:22Z", "author": {"login": "pavolloffay"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "diffHunk": "@@ -21,6 +21,9 @@\n \n     @Override\n     public Counter createCounter(final String name, final Map<String, String> tags) {\n+        // On restart (e.g. in dev mode) Jaeger registers\n+        // the same metrics which would result in exception\n+        registry.remove(name);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MDg4MA=="}, "originalCommit": {"oid": "615136c46264f1e8684f99d126745510434f4786"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMjg0NjQ4OnYy", "diffSide": "RIGHT", "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/JaegerDeploymentRecorder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo0MjoyMFrOFkrUNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMDozMDozM1rOFksxDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAwMjc0MQ==", "bodyText": "TBH this looks a little suspicious. Can you please explain what you are trying to achieve here?", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r374002741", "createdAt": "2020-02-03T09:42:20Z", "author": {"login": "geoand"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/JaegerDeploymentRecorder.java", "diffHunk": "@@ -1,45 +1,37 @@\n package io.quarkus.jaeger.runtime;\n \n-import static io.jaegertracing.Configuration.JAEGER_SERVICE_NAME;\n-\n import java.util.Optional;\n import java.util.function.Function;\n \n-import org.eclipse.microprofile.config.Config;\n-import org.eclipse.microprofile.config.ConfigProvider;\n import org.jboss.logging.Logger;\n \n import io.opentracing.util.GlobalTracer;\n+import io.quarkus.runtime.ApplicationConfig;\n import io.quarkus.runtime.annotations.Recorder;\n \n @Recorder\n public class JaegerDeploymentRecorder {\n-    private static volatile boolean registered;\n-\n     private static final Logger log = Logger.getLogger(JaegerDeploymentRecorder.class);\n+    private static final Optional UNKNOWN_SERVICE_NAME = Optional.of(\"quarkus/unknown\");\n+    private static final QuarkusJaegerTracer quarkusTracer = new QuarkusJaegerTracer();\n \n-    public void registerTracer(JaegerConfig jaeger) {\n-        if (!registered) {\n-            if (isValidConfig(jaeger)) {\n-                initTracerConfig(jaeger);\n-                QuarkusJaegerTracer quarkusJaegerTracer = new QuarkusJaegerTracer();\n-                log.debugf(\"Registering tracer to GlobalTracer %s\", quarkusJaegerTracer);\n-                GlobalTracer.register(quarkusJaegerTracer);\n-            }\n-            registered = true;\n+    static {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "556685637c3a071e74471aeea30c897919d0341e"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAyNjUwOA==", "bodyText": "GlobalTracer is used to pass the tracer to CDI producer defined in MP-OpenTracing spec.\nThis block registers the quarkus tracer to the global tracer. GlobalTracer has is a static accessor to a registered tracer, and it does not have a reset method - hence I have added it to static block.\nI have moved it to registerTracer  method - It might be better if a caller resets the tracer (via reflection - there is a test-jar utility).", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r374026508", "createdAt": "2020-02-03T10:30:33Z", "author": {"login": "pavolloffay"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/JaegerDeploymentRecorder.java", "diffHunk": "@@ -1,45 +1,37 @@\n package io.quarkus.jaeger.runtime;\n \n-import static io.jaegertracing.Configuration.JAEGER_SERVICE_NAME;\n-\n import java.util.Optional;\n import java.util.function.Function;\n \n-import org.eclipse.microprofile.config.Config;\n-import org.eclipse.microprofile.config.ConfigProvider;\n import org.jboss.logging.Logger;\n \n import io.opentracing.util.GlobalTracer;\n+import io.quarkus.runtime.ApplicationConfig;\n import io.quarkus.runtime.annotations.Recorder;\n \n @Recorder\n public class JaegerDeploymentRecorder {\n-    private static volatile boolean registered;\n-\n     private static final Logger log = Logger.getLogger(JaegerDeploymentRecorder.class);\n+    private static final Optional UNKNOWN_SERVICE_NAME = Optional.of(\"quarkus/unknown\");\n+    private static final QuarkusJaegerTracer quarkusTracer = new QuarkusJaegerTracer();\n \n-    public void registerTracer(JaegerConfig jaeger) {\n-        if (!registered) {\n-            if (isValidConfig(jaeger)) {\n-                initTracerConfig(jaeger);\n-                QuarkusJaegerTracer quarkusJaegerTracer = new QuarkusJaegerTracer();\n-                log.debugf(\"Registering tracer to GlobalTracer %s\", quarkusJaegerTracer);\n-                GlobalTracer.register(quarkusJaegerTracer);\n-            }\n-            registered = true;\n+    static {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAwMjc0MQ=="}, "originalCommit": {"oid": "556685637c3a071e74471aeea30c897919d0341e"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1171, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}