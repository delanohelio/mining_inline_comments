{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MDI0OTc5", "number": 7860, "title": "Add healthcheck for reactive datasources", "bodyText": "the datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down.", "createdAt": "2020-03-13T22:11:27Z", "url": "https://github.com/quarkusio/quarkus/pull/7860", "merged": true, "mergeCommit": {"oid": "dbb6cfef59e7acc8c81b42d39762de9e439f3b36"}, "closed": true, "closedAt": "2020-05-04T11:37:30Z", "author": {"login": "machi1990"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNXz-UgBqjMxMjgzOTQzMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcd95nzAFqTQwNDkwNzUyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "25f197594887da32693f2f35d5a83804183c7ba2", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/25f197594887da32693f2f35d5a83804183c7ba2", "committedDate": "2020-03-13T21:16:22Z", "message": "feat: add healthcheck for reactive datasources\n\nthe datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down."}, "afterCommit": {"oid": "f546849399ae4434152d91f00ab69528d1c54201", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/f546849399ae4434152d91f00ab69528d1c54201", "committedDate": "2020-03-13T22:10:57Z", "message": "feat: add healthcheck for reactive datasources\n\nthe datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0OTM3ODcz", "url": "https://github.com/quarkusio/quarkus/pull/7860#pullrequestreview-374937873", "createdAt": "2020-03-16T06:33:53Z", "commit": {"oid": "f546849399ae4434152d91f00ab69528d1c54201"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0OTk1Nzc0", "url": "https://github.com/quarkusio/quarkus/pull/7860#pullrequestreview-374995774", "createdAt": "2020-03-16T08:26:03Z", "commit": {"oid": "f546849399ae4434152d91f00ab69528d1c54201"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwODoyNjowM1rOF2prNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwODoyOToyN1rOF2pxhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1MDIyOA==", "bodyText": "can't we get more than one?", "url": "https://github.com/quarkusio/quarkus/pull/7860#discussion_r392850228", "createdAt": "2020-03-16T08:26:03Z", "author": {"login": "cescoffier"}, "path": "extensions/reactive-mysql-client/runtime/src/main/java/io/quarkus/reactive/mysql/client/runtime/health/ReactiveMySQLDataSourceHealthCheck.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.reactive.mysql.client.runtime.health;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.PostConstruct;\n+import javax.enterprise.context.ApplicationScoped;\n+\n+import org.eclipse.microprofile.health.HealthCheck;\n+import org.eclipse.microprofile.health.HealthCheckResponse;\n+import org.eclipse.microprofile.health.HealthCheckResponseBuilder;\n+import org.eclipse.microprofile.health.Readiness;\n+\n+import io.quarkus.arc.Arc;\n+import io.vertx.mysqlclient.MySQLPool;\n+\n+@Readiness\n+@ApplicationScoped\n+public class ReactiveMySQLDataSourceHealthCheck implements HealthCheck {\n+\n+    private MySQLPool mySQLPool;\n+\n+    @PostConstruct\n+    protected void init() {\n+        mySQLPool = Arc.container().instance(MySQLPool.class).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f546849399ae4434152d91f00ab69528d1c54201"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1MTAxMw==", "bodyText": "You need to check you are not on the IO Thread, because if so you cannot block.", "url": "https://github.com/quarkusio/quarkus/pull/7860#discussion_r392851013", "createdAt": "2020-03-16T08:27:40Z", "author": {"login": "cescoffier"}, "path": "extensions/reactive-mysql-client/runtime/src/main/java/io/quarkus/reactive/mysql/client/runtime/health/ReactiveMySQLDataSourceHealthCheck.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.reactive.mysql.client.runtime.health;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.PostConstruct;\n+import javax.enterprise.context.ApplicationScoped;\n+\n+import org.eclipse.microprofile.health.HealthCheck;\n+import org.eclipse.microprofile.health.HealthCheckResponse;\n+import org.eclipse.microprofile.health.HealthCheckResponseBuilder;\n+import org.eclipse.microprofile.health.Readiness;\n+\n+import io.quarkus.arc.Arc;\n+import io.vertx.mysqlclient.MySQLPool;\n+\n+@Readiness\n+@ApplicationScoped\n+public class ReactiveMySQLDataSourceHealthCheck implements HealthCheck {\n+\n+    private MySQLPool mySQLPool;\n+\n+    @PostConstruct\n+    protected void init() {\n+        mySQLPool = Arc.container().instance(MySQLPool.class).get();\n+    }\n+\n+    @Override\n+    public HealthCheckResponse call() {\n+        HealthCheckResponseBuilder builder = HealthCheckResponse.named(\"Reactive MySQL connection health check\").up();\n+\n+        try {\n+            CompletableFuture<Void> databaseConnectionAttempt = new CompletableFuture<>();\n+            mySQLPool.query(\"SELECT 1\", ar -> {\n+                if (ar.failed()) {\n+                    builder.down();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f546849399ae4434152d91f00ab69528d1c54201"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg1MTg0Nw==", "bodyText": "Same comments:\n\nhow to handle when there are several Pools\nyou need to be sure to not block the IO Thread.", "url": "https://github.com/quarkusio/quarkus/pull/7860#discussion_r392851847", "createdAt": "2020-03-16T08:29:27Z", "author": {"login": "cescoffier"}, "path": "extensions/reactive-pg-client/runtime/src/main/java/io/quarkus/reactive/pg/client/runtime/health/ReactivePgDataSourceHealthCheck.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package io.quarkus.reactive.pg.client.runtime.health;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.PostConstruct;\n+import javax.enterprise.context.ApplicationScoped;\n+\n+import org.eclipse.microprofile.health.HealthCheck;\n+import org.eclipse.microprofile.health.HealthCheckResponse;\n+import org.eclipse.microprofile.health.HealthCheckResponseBuilder;\n+import org.eclipse.microprofile.health.Readiness;\n+\n+import io.quarkus.arc.Arc;\n+import io.vertx.pgclient.PgPool;\n+\n+@Readiness\n+@ApplicationScoped\n+public class ReactivePgDataSourceHealthCheck implements HealthCheck {\n+    private PgPool pgPool;\n+\n+    @PostConstruct\n+    protected void init() {\n+        pgPool = Arc.container().instance(PgPool.class).get();\n+    }\n+\n+    @Override\n+    public HealthCheckResponse call() {\n+        HealthCheckResponseBuilder builder = HealthCheckResponse.named(\"Reactive PostgreSQL connection health check\").up();\n+\n+        try {\n+            CompletableFuture<Void> databaseConnectionAttempt = new CompletableFuture<>();\n+            pgPool.query(\"SELECT 1\", ar -> {\n+                if (ar.failed()) {\n+                    builder.down();\n+                }\n+                databaseConnectionAttempt.complete(null);\n+            });\n+            databaseConnectionAttempt.join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f546849399ae4434152d91f00ab69528d1c54201"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f546849399ae4434152d91f00ab69528d1c54201", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/f546849399ae4434152d91f00ab69528d1c54201", "committedDate": "2020-03-13T22:10:57Z", "message": "feat: add healthcheck for reactive datasources\n\nthe datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down."}, "afterCommit": {"oid": "9ce89c66456079143d3bbeee17c1ca7eff7aa7d3", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/9ce89c66456079143d3bbeee17c1ca7eff7aa7d3", "committedDate": "2020-03-24T12:28:58Z", "message": "feat: add healthcheck for reactive datasources\n\nthe datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ce89c66456079143d3bbeee17c1ca7eff7aa7d3", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/9ce89c66456079143d3bbeee17c1ca7eff7aa7d3", "committedDate": "2020-03-24T12:28:58Z", "message": "feat: add healthcheck for reactive datasources\n\nthe datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down."}, "afterCommit": {"oid": "5e168564bf5a3a5d3e9dc3057462829420363705", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/5e168564bf5a3a5d3e9dc3057462829420363705", "committedDate": "2020-04-08T16:02:41Z", "message": "feat: add healthcheck for reactive datasources\n\nthe datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1Mzg5MDMx", "url": "https://github.com/quarkusio/quarkus/pull/7860#pullrequestreview-395389031", "createdAt": "2020-04-17T11:54:28Z", "commit": {"oid": "5e168564bf5a3a5d3e9dc3057462829420363705"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMTo1NDoyOFrOGHK_3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMTo1NDoyOFrOGHK_3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE3MzQwNw==", "bodyText": "Does \"SELECT 1\" trigger a roundtrip with the database?\nJust want to be sure.", "url": "https://github.com/quarkusio/quarkus/pull/7860#discussion_r410173407", "createdAt": "2020-04-17T11:54:28Z", "author": {"login": "cescoffier"}, "path": "extensions/reactive-pg-client/runtime/src/main/java/io/quarkus/reactive/pg/client/runtime/health/ReactivePgDataSourceHealthCheck.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.reactive.pg.client.runtime.health;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.annotation.PostConstruct;\n+import javax.enterprise.context.ApplicationScoped;\n+\n+import org.eclipse.microprofile.health.HealthCheck;\n+import org.eclipse.microprofile.health.HealthCheckResponse;\n+import org.eclipse.microprofile.health.HealthCheckResponseBuilder;\n+import org.eclipse.microprofile.health.Readiness;\n+\n+import io.quarkus.arc.Arc;\n+import io.vertx.pgclient.PgPool;\n+\n+@Readiness\n+@ApplicationScoped\n+public class ReactivePgDataSourceHealthCheck implements HealthCheck {\n+    private PgPool pgPool;\n+\n+    @PostConstruct\n+    protected void init() {\n+        pgPool = Arc.container().instance(PgPool.class).get();\n+    }\n+\n+    @Override\n+    public HealthCheckResponse call() {\n+        HealthCheckResponseBuilder builder = HealthCheckResponse.named(\"Reactive PostgreSQL connection health check\").up();\n+\n+        try {\n+            CompletableFuture<Void> databaseConnectionAttempt = new CompletableFuture<>();\n+            pgPool.query(\"SELECT 1\", ar -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e168564bf5a3a5d3e9dc3057462829420363705"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce832c00681c3ec21d0bc270ddb8a3544a3ac63", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/bce832c00681c3ec21d0bc270ddb8a3544a3ac63", "committedDate": "2020-04-24T16:13:28Z", "message": "feat: add healthcheck for reactive datasources\n\nthe datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e168564bf5a3a5d3e9dc3057462829420363705", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/5e168564bf5a3a5d3e9dc3057462829420363705", "committedDate": "2020-04-08T16:02:41Z", "message": "feat: add healthcheck for reactive datasources\n\nthe datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down."}, "afterCommit": {"oid": "bce832c00681c3ec21d0bc270ddb8a3544a3ac63", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/bce832c00681c3ec21d0bc270ddb8a3544a3ac63", "committedDate": "2020-04-24T16:13:28Z", "message": "feat: add healthcheck for reactive datasources\n\nthe datasource config had a health check enabled option which was only consumed by Agroal Datasource\nand not the reactive ones. Let's use this option for reactive datasource too and send appropriate\ncheck status when database is down."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0OTA3NTI1", "url": "https://github.com/quarkusio/quarkus/pull/7860#pullrequestreview-404907525", "createdAt": "2020-05-04T11:37:02Z", "commit": {"oid": "bce832c00681c3ec21d0bc270ddb8a3544a3ac63"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3885, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}