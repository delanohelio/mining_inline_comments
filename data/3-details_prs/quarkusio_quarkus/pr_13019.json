{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNDM4NDUy", "number": 13019, "title": "Avoid retaining empty instances of HashSet", "bodyText": "This is a very minor improvement; spotted it while browsing heap dumps:\napparently a Quarkus application is retaining a good amount of references to empty sets. We can trivially get rid of them.", "createdAt": "2020-10-29T17:23:10Z", "url": "https://github.com/quarkusio/quarkus/pull/13019", "merged": true, "mergeCommit": {"oid": "80d4f2e6b3902f20fa26855a3ae0c1271804ab9c"}, "closed": true, "closedAt": "2020-11-02T14:22:51Z", "author": {"login": "Sanne"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXVlhYgFqTUxOTkwNzQ3Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYhjPxgFqTUyMTQ4MDUxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTA3NDcz", "url": "https://github.com/quarkusio/quarkus/pull/13019#pullrequestreview-519907473", "createdAt": "2020-10-29T17:26:29Z", "commit": {"oid": "b95460001d3c26ac876af558f400ffe100b3e06e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzoyNjoyOVrOHqmyww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzoyNjoyOVrOHqmyww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQzNzgyNw==", "bodyText": "Stupid question: is it a case where we often have 1 element? I know for HV, it was a very common case and we decided to optimize it properly: https://github.com/hibernate/hibernate-validator/blob/master/engine/src/main/java/org/hibernate/validator/internal/util/CollectionHelper.java#L106 .\nIt might not be the case here so put it in the crazy idea box if it doesn't make sense :).", "url": "https://github.com/quarkusio/quarkus/pull/13019#discussion_r514437827", "createdAt": "2020-10-29T17:26:29Z", "author": {"login": "gsmet"}, "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/CurrentInjectionPointProvider.java", "diffHunk": "@@ -177,14 +177,20 @@ public int getPosition() {\n \n     }\n \n+    private static <V> Set<V> trimImmutableSet(final Set<V> input) {\n+        if (input == null)\n+            return null;\n+        return input.isEmpty() ? Collections.EMPTY_SET : input;\n+    }\n+\n     static abstract class AnnotatedBase implements Annotated {\n \n         private final Type baseType;\n         private final Set<Annotation> annotations;\n \n         AnnotatedBase(Type baseType, Set<Annotation> annotations) {\n             this.baseType = baseType;\n-            this.annotations = annotations;\n+            this.annotations = trimImmutableSet(annotations); //Don't retain memory for empty sets: HashSet is relatively large.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b95460001d3c26ac876af558f400ffe100b3e06e"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b95460001d3c26ac876af558f400ffe100b3e06e", "author": {"user": {"login": "Sanne", "name": "Sanne Grinovero"}}, "url": "https://github.com/quarkusio/quarkus/commit/b95460001d3c26ac876af558f400ffe100b3e06e", "committedDate": "2020-10-29T17:20:00Z", "message": "Avoid retaining empty instances of HashSet"}, "afterCommit": {"oid": "ef4df33defa1f3894c2a9ad63c38d89febf859d6", "author": {"user": {"login": "Sanne", "name": "Sanne Grinovero"}}, "url": "https://github.com/quarkusio/quarkus/commit/ef4df33defa1f3894c2a9ad63c38d89febf859d6", "committedDate": "2020-10-30T11:32:39Z", "message": "More memory savings opportunities in RemovedBeanImpl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDExMjU3", "url": "https://github.com/quarkusio/quarkus/pull/13019#pullrequestreview-521411257", "createdAt": "2020-11-02T08:22:19Z", "commit": {"oid": "ef4df33defa1f3894c2a9ad63c38d89febf859d6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e8e41eaf56275112cc1bf00af7e48106db08b64", "author": {"user": {"login": "Sanne", "name": "Sanne Grinovero"}}, "url": "https://github.com/quarkusio/quarkus/commit/2e8e41eaf56275112cc1bf00af7e48106db08b64", "committedDate": "2020-11-02T09:31:32Z", "message": "Static constant DEFAULT_QUALIFIERS should be immutable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902b132aee7f4778596cc472a9a6492ece96ceea", "author": {"user": {"login": "Sanne", "name": "Sanne Grinovero"}}, "url": "https://github.com/quarkusio/quarkus/commit/902b132aee7f4778596cc472a9a6492ece96ceea", "committedDate": "2020-11-02T09:34:35Z", "message": "Avoid retaining a large HashSet for immutable sets of zero/1 elements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b07f20a6ffedf03d3e5ea3bf8d97bc2c2757e204", "author": {"user": {"login": "Sanne", "name": "Sanne Grinovero"}}, "url": "https://github.com/quarkusio/quarkus/commit/b07f20a6ffedf03d3e5ea3bf8d97bc2c2757e204", "committedDate": "2020-11-02T09:34:35Z", "message": "Remove unnecessary wrapping: this set is already unmodifiable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca3785575f16c53d3027a2c484e4d21139ad52dd", "author": {"user": {"login": "Sanne", "name": "Sanne Grinovero"}}, "url": "https://github.com/quarkusio/quarkus/commit/ca3785575f16c53d3027a2c484e4d21139ad52dd", "committedDate": "2020-11-02T09:34:35Z", "message": "More memory savings opportunities in RemovedBeanImpl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef4df33defa1f3894c2a9ad63c38d89febf859d6", "author": {"user": {"login": "Sanne", "name": "Sanne Grinovero"}}, "url": "https://github.com/quarkusio/quarkus/commit/ef4df33defa1f3894c2a9ad63c38d89febf859d6", "committedDate": "2020-10-30T11:32:39Z", "message": "More memory savings opportunities in RemovedBeanImpl"}, "afterCommit": {"oid": "ca3785575f16c53d3027a2c484e4d21139ad52dd", "author": {"user": {"login": "Sanne", "name": "Sanne Grinovero"}}, "url": "https://github.com/quarkusio/quarkus/commit/ca3785575f16c53d3027a2c484e4d21139ad52dd", "committedDate": "2020-11-02T09:34:35Z", "message": "More memory savings opportunities in RemovedBeanImpl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDgwNTE3", "url": "https://github.com/quarkusio/quarkus/pull/13019#pullrequestreview-521480517", "createdAt": "2020-11-02T09:56:47Z", "commit": {"oid": "ca3785575f16c53d3027a2c484e4d21139ad52dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1590, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}