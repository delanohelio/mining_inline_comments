{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMTI2MDI4", "number": 12224, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjoyNzowNlrOElof_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjoyOTo1MlrOElolLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODk2MzE4OnYy", "diffSide": "RIGHT", "path": "extensions/kafka-streams/runtime/src/main/java/io/quarkus/kafka/streams/runtime/KafkaStreamsProducer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjoyNzowNlrOHVNeXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNDo0ODo0MVrOHVT4SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwMjkwOQ==", "bodyText": "Instead of having to reason about the two booleans, how about establishing an enum which exposes all the potential states the producer can be in, e.g. enum State { RUNNING, RUNNING_NON_STOPPABLE, STOPPED}?", "url": "https://github.com/quarkusio/quarkus/pull/12224#discussion_r492002909", "createdAt": "2020-09-21T12:27:06Z", "author": {"login": "gunnarmorling"}, "path": "extensions/kafka-streams/runtime/src/main/java/io/quarkus/kafka/streams/runtime/KafkaStreamsProducer.java", "diffHunk": "@@ -54,6 +54,8 @@\n     private static final Logger LOGGER = Logger.getLogger(KafkaStreamsProducer.class.getName());\n     private static volatile boolean shutdown = false;\n \n+    public static volatile boolean ignoreShutdownFlag = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d08186f6e93a240f0a72b37f11b299651834a066"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEwNzg0OQ==", "bodyText": "I'll drop the 2nd boolean", "url": "https://github.com/quarkusio/quarkus/pull/12224#discussion_r492107849", "createdAt": "2020-09-21T14:48:41Z", "author": {"login": "vietk"}, "path": "extensions/kafka-streams/runtime/src/main/java/io/quarkus/kafka/streams/runtime/KafkaStreamsProducer.java", "diffHunk": "@@ -54,6 +54,8 @@\n     private static final Logger LOGGER = Logger.getLogger(KafkaStreamsProducer.class.getName());\n     private static volatile boolean shutdown = false;\n \n+    public static volatile boolean ignoreShutdownFlag = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwMjkwOQ=="}, "originalCommit": {"oid": "d08186f6e93a240f0a72b37f11b299651834a066"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODk2NTk5OnYy", "diffSide": "RIGHT", "path": "extensions/kafka-streams/runtime/src/main/java/io/quarkus/kafka/streams/runtime/devmode/KafkaStreamsHotReplacementSetup.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjoyNzo1NFrOHVNgIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNDo0ODoyM1rOHVT3Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwMzM2Mw==", "bodyText": "Won't this cause things to not shut down properly? If a shutdown request comes in while this flag is set, this request will be ignored, but it seems we'd never do the shutdown later on then?", "url": "https://github.com/quarkusio/quarkus/pull/12224#discussion_r492003363", "createdAt": "2020-09-21T12:27:54Z", "author": {"login": "gunnarmorling"}, "path": "extensions/kafka-streams/runtime/src/main/java/io/quarkus/kafka/streams/runtime/devmode/KafkaStreamsHotReplacementSetup.java", "diffHunk": "@@ -32,11 +33,14 @@ public void run() {\n                             @Override\n                             public void run() {\n                                 try {\n+                                    KafkaStreamsProducer.ignoreShutdownFlag = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d08186f6e93a240f0a72b37f11b299651834a066"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEwNzYwNw==", "bodyText": "I think @rquinio's comment make sense in fact.\nThe producer bean is recreated however, the class is still the same as loaded before, however shutdown flag is set to true because if the first shutdown from dev mode. So putting the state back to the initial value in the constructor should make the trick", "url": "https://github.com/quarkusio/quarkus/pull/12224#discussion_r492107607", "createdAt": "2020-09-21T14:48:23Z", "author": {"login": "vietk"}, "path": "extensions/kafka-streams/runtime/src/main/java/io/quarkus/kafka/streams/runtime/devmode/KafkaStreamsHotReplacementSetup.java", "diffHunk": "@@ -32,11 +33,14 @@ public void run() {\n                             @Override\n                             public void run() {\n                                 try {\n+                                    KafkaStreamsProducer.ignoreShutdownFlag = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwMzM2Mw=="}, "originalCommit": {"oid": "d08186f6e93a240f0a72b37f11b299651834a066"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODk3NjQ3OnYy", "diffSide": "RIGHT", "path": "extensions/kafka-streams/runtime/src/main/java/io/quarkus/kafka/streams/runtime/KafkaStreamsProducer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMjoyOTo1MlrOHVNmvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNTowMTo0MlrOHVUt0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwNTA1NA==", "bodyText": "It may be simpler to set shutdown to false in KafkaStreamsProducer constructor ?\nIf injection is being re-triggered, I suppose it means a restart is happening in same classloader.", "url": "https://github.com/quarkusio/quarkus/pull/12224#discussion_r492005054", "createdAt": "2020-09-21T12:29:52Z", "author": {"login": "rquinio"}, "path": "extensions/kafka-streams/runtime/src/main/java/io/quarkus/kafka/streams/runtime/KafkaStreamsProducer.java", "diffHunk": "@@ -103,7 +105,9 @@ public KafkaStreamsTopologyManager kafkaStreamsTopologyManager() {\n     }\n \n     void onStop(@Observes ShutdownEvent event) {\n-        shutdown = true;\n+        if (!ignoreShutdownFlag) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d08186f6e93a240f0a72b37f11b299651834a066"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEyMTU1NQ==", "bodyText": "makes sense, tested it works", "url": "https://github.com/quarkusio/quarkus/pull/12224#discussion_r492121555", "createdAt": "2020-09-21T15:01:42Z", "author": {"login": "vietk"}, "path": "extensions/kafka-streams/runtime/src/main/java/io/quarkus/kafka/streams/runtime/KafkaStreamsProducer.java", "diffHunk": "@@ -103,7 +105,9 @@ public KafkaStreamsTopologyManager kafkaStreamsTopologyManager() {\n     }\n \n     void onStop(@Observes ShutdownEvent event) {\n-        shutdown = true;\n+        if (!ignoreShutdownFlag) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwNTA1NA=="}, "originalCommit": {"oid": "d08186f6e93a240f0a72b37f11b299651834a066"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 186, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}