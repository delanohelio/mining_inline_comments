{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NTI3NDk0", "number": 8352, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNjo1NDoyM1rODuCrNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNjoyOTozMlrODwqSUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NjA0OTE2OnYy", "diffSide": "RIGHT", "path": "bom/runtime/pom.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNjo1NDoyM1rOF_0cnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMjoxMjowMVrOF_-U3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2MzkwMw==", "bodyText": "Hi Stuart, it is not really related to this PR, would it make sense to move quarkus-security into quarkus eventually ? I've added a couple of exceptions into quarkus-vertx-http which should probably be alongside other exceptions like AuthenticationFailedException, and we can tweak things faster there", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r402463903", "createdAt": "2020-04-02T16:54:23Z", "author": {"login": "sberyozkin"}, "path": "bom/runtime/pom.xml", "diffHunk": "@@ -182,7 +182,7 @@\n         <mockito.version>3.3.3</mockito.version>\n         <jna.version>5.3.1</jna.version>\n         <antlr.version>4.7.2</antlr.version>\n-        <quarkus-security.version>1.0.1.Final</quarkus-security.version>\n+        <quarkus-security.version>1.1.0.Beta1</quarkus-security.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5f71ef96ad266276c3a553b53f936b9efd3fa77"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyNTc1Nw==", "bodyText": "By the way, I'm not asking to move it now :-), only a question/suggestion as I recall you were contemplating it at some point", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r402625757", "createdAt": "2020-04-02T22:12:01Z", "author": {"login": "sberyozkin"}, "path": "bom/runtime/pom.xml", "diffHunk": "@@ -182,7 +182,7 @@\n         <mockito.version>3.3.3</mockito.version>\n         <jna.version>5.3.1</jna.version>\n         <antlr.version>4.7.2</antlr.version>\n-        <quarkus-security.version>1.0.1.Final</quarkus-security.version>\n+        <quarkus-security.version>1.1.0.Beta1</quarkus-security.version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2MzkwMw=="}, "originalCommit": {"oid": "b5f71ef96ad266276c3a553b53f936b9efd3fa77"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI0NDI0OnYy", "diffSide": "RIGHT", "path": "extensions/elytron-security-oauth2/runtime/src/main/java/io/quarkus/elytron/security/oauth2/runtime/auth/OAuth2Augmentor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0MjozN1rOGBV3LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0MjozN1rOGBV3LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA1OTk0OQ==", "bodyText": "Depending on how much laziness you want, you can delay the object creation to subscription time:\nreturn Uni.createFrom().item(() -> {\n    return     .....build();\n});", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404059949", "createdAt": "2020-04-06T12:42:37Z", "author": {"login": "cescoffier"}, "path": "extensions/elytron-security-oauth2/runtime/src/main/java/io/quarkus/elytron/security/oauth2/runtime/auth/OAuth2Augmentor.java", "diffHunk": "@@ -37,11 +35,10 @@ public int priority() {\n                     builder.addRole(i);\n                 }\n             }\n-            cs.complete(builder.build());\n+            return Uni.createFrom().item(builder.build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI1MTIyOnYy", "diffSide": "RIGHT", "path": "extensions/elytron-security-oauth2/runtime/src/main/java/io/quarkus/elytron/security/oauth2/runtime/auth/OAuth2AuthMechanism.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0NDoxNlrOGBV7Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0NDoxNlrOGBV7Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2MDk5NQ==", "bodyText": "Any reason to change the output?\nInitially, you was redeeming null, now you create null from an Optional.", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404060995", "createdAt": "2020-04-06T12:44:16Z", "author": {"login": "cescoffier"}, "path": "extensions/elytron-security-oauth2/runtime/src/main/java/io/quarkus/elytron/security/oauth2/runtime/auth/OAuth2AuthMechanism.java", "diffHunk": "@@ -46,16 +46,16 @@\n \n         }\n         // No suitable header has been found in this request,\n-        return CompletableFuture.completedFuture(null);\n+        return Uni.createFrom().optional(Optional.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI1NTU5OnYy", "diffSide": "RIGHT", "path": "extensions/elytron-security-oauth2/runtime/src/main/java/io/quarkus/elytron/security/oauth2/runtime/auth/OAuth2AuthMechanism.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0NToyNlrOGBV94Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0NToyNlrOGBV94Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2MTY2NQ==", "bodyText": "Depends on the laziness you want, you can delay the result creation with a supplier (() -> {...}).\nIt would only create the object on subscription.", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404061665", "createdAt": "2020-04-06T12:45:26Z", "author": {"login": "cescoffier"}, "path": "extensions/elytron-security-oauth2/runtime/src/main/java/io/quarkus/elytron/security/oauth2/runtime/auth/OAuth2AuthMechanism.java", "diffHunk": "@@ -46,16 +46,16 @@\n \n         }\n         // No suitable header has been found in this request,\n-        return CompletableFuture.completedFuture(null);\n+        return Uni.createFrom().optional(Optional.empty());\n     }\n \n     @Override\n-    public CompletionStage<ChallengeData> getChallenge(RoutingContext context) {\n+    public Uni<ChallengeData> getChallenge(RoutingContext context) {\n         ChallengeData result = new ChallengeData(\n                 HttpResponseStatus.UNAUTHORIZED.code(),\n                 HttpHeaderNames.WWW_AUTHENTICATE,\n                 \"Bearer {token}\");\n-        return CompletableFuture.completedFuture(result);\n+        return Uni.createFrom().item(result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI1OTUwOnYy", "diffSide": "RIGHT", "path": "extensions/elytron-security-properties-file/deployment/src/test/java/io/quarkus/security/test/CustomAuth.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0NjozMVrOGBWAWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0NjozMVrOGBWAWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2MjI5OQ==", "bodyText": "I believe you want to emit null right?", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404062299", "createdAt": "2020-04-06T12:46:31Z", "author": {"login": "cescoffier"}, "path": "extensions/elytron-security-properties-file/deployment/src/test/java/io/quarkus/security/test/CustomAuth.java", "diffHunk": "@@ -65,24 +65,22 @@\n \n                     // By this point we had a header we should have been able to verify but for some reason\n                     // it was not correctly structured.\n-                    CompletableFuture<SecurityIdentity> cf = new CompletableFuture<>();\n-                    cf.completeExceptionally(new AuthenticationFailedException());\n-                    return cf;\n+                    return Uni.createFrom().failure(new AuthenticationFailedException());\n                 }\n             }\n         }\n \n         // No suitable header has been found in this request,\n-        return CompletableFuture.completedFuture(null);\n+        return Uni.createFrom().optional(Optional.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI2MTQwOnYy", "diffSide": "RIGHT", "path": "extensions/elytron-security-properties-file/deployment/src/test/java/io/quarkus/security/test/CustomAuth.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0Njo1OVrOGBWBfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0Njo1OVrOGBWBfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2MjU4OQ==", "bodyText": "You can, if you want, delay the creation of the challenge at subscription time.", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404062589", "createdAt": "2020-04-06T12:46:59Z", "author": {"login": "cescoffier"}, "path": "extensions/elytron-security-properties-file/deployment/src/test/java/io/quarkus/security/test/CustomAuth.java", "diffHunk": "@@ -65,24 +65,22 @@\n \n                     // By this point we had a header we should have been able to verify but for some reason\n                     // it was not correctly structured.\n-                    CompletableFuture<SecurityIdentity> cf = new CompletableFuture<>();\n-                    cf.completeExceptionally(new AuthenticationFailedException());\n-                    return cf;\n+                    return Uni.createFrom().failure(new AuthenticationFailedException());\n                 }\n             }\n         }\n \n         // No suitable header has been found in this request,\n-        return CompletableFuture.completedFuture(null);\n+        return Uni.createFrom().optional(Optional.empty());\n     }\n \n     @Override\n-    public CompletionStage<ChallengeData> getChallenge(RoutingContext context) {\n+    public Uni<ChallengeData> getChallenge(RoutingContext context) {\n         ChallengeData result = new ChallengeData(\n                 HttpResponseStatus.UNAUTHORIZED.code(),\n                 HttpHeaderNames.WWW_AUTHENTICATE,\n                 \"BASIC realm=CUSTOM\");\n-        return CompletableFuture.completedFuture(result);\n+        return Uni.createFrom().item(result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI2OTgzOnYy", "diffSide": "RIGHT", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/BearerAuthenticationMechanism.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0OToxOVrOGBWGmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0OToxOVrOGBWGmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2Mzg5OQ==", "bodyText": "Wondering if this ChallengeData can be cached and singleton.", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404063899", "createdAt": "2020-04-06T12:49:19Z", "author": {"login": "cescoffier"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/BearerAuthenticationMechanism.java", "diffHunk": "@@ -25,18 +25,17 @@\n         if (token != null) {\n             return authenticate(identityProviderManager, new AccessTokenCredential(token, context));\n         }\n-\n-        return CompletableFuture.completedFuture(null);\n+        return Uni.createFrom().optional(Optional.empty());\n     }\n \n-    public CompletionStage<ChallengeData> getChallenge(RoutingContext context, DefaultTenantConfigResolver resolver) {\n+    public Uni<ChallengeData> getChallenge(RoutingContext context, DefaultTenantConfigResolver resolver) {\n         String bearerToken = extractBearerToken(context);\n \n         if (bearerToken == null) {\n-            return CompletableFuture.completedFuture(new ChallengeData(HttpResponseStatus.UNAUTHORIZED.code(), null, null));\n+            return Uni.createFrom().item(new ChallengeData(HttpResponseStatus.UNAUTHORIZED.code(), null, null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI3MDc1OnYy", "diffSide": "RIGHT", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/BearerAuthenticationMechanism.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0OTozM1rOGBWHHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0OTozM1rOGBWHHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NDAzMQ==", "bodyText": "Wondering if this ChallengeData can be cached and singleton.", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404064031", "createdAt": "2020-04-06T12:49:33Z", "author": {"login": "cescoffier"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/BearerAuthenticationMechanism.java", "diffHunk": "@@ -25,18 +25,17 @@\n         if (token != null) {\n             return authenticate(identityProviderManager, new AccessTokenCredential(token, context));\n         }\n-\n-        return CompletableFuture.completedFuture(null);\n+        return Uni.createFrom().optional(Optional.empty());\n     }\n \n-    public CompletionStage<ChallengeData> getChallenge(RoutingContext context, DefaultTenantConfigResolver resolver) {\n+    public Uni<ChallengeData> getChallenge(RoutingContext context, DefaultTenantConfigResolver resolver) {\n         String bearerToken = extractBearerToken(context);\n \n         if (bearerToken == null) {\n-            return CompletableFuture.completedFuture(new ChallengeData(HttpResponseStatus.UNAUTHORIZED.code(), null, null));\n+            return Uni.createFrom().item(new ChallengeData(HttpResponseStatus.UNAUTHORIZED.code(), null, null));\n         }\n \n-        return CompletableFuture.completedFuture(new ChallengeData(HttpResponseStatus.FORBIDDEN.code(), null, null));\n+        return Uni.createFrom().item(new ChallengeData(HttpResponseStatus.FORBIDDEN.code(), null, null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI3MjUwOnYy", "diffSide": "RIGHT", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/BearerAuthenticationMechanism.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo1MDowM1rOGBWIPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo1MDowM1rOGBWIPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NDMxNw==", "bodyText": "Are you trying to emit null?", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404064317", "createdAt": "2020-04-06T12:50:03Z", "author": {"login": "cescoffier"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/BearerAuthenticationMechanism.java", "diffHunk": "@@ -25,18 +25,17 @@\n         if (token != null) {\n             return authenticate(identityProviderManager, new AccessTokenCredential(token, context));\n         }\n-\n-        return CompletableFuture.completedFuture(null);\n+        return Uni.createFrom().optional(Optional.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI3NTYxOnYy", "diffSide": "RIGHT", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo1MDo1MFrOGBWKEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo1MToxMFrOGBWK7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NDc4Nw==", "bodyText": "Is it something that could be migrated to Uni?", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404064787", "createdAt": "2020-04-06T12:50:50Z", "author": {"login": "cescoffier"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -56,13 +59,13 @@ private static QuarkusSecurityIdentity augmentIdentity(SecurityIdentity security\n                 .addPermissionChecker(new Function<Permission, CompletionStage<Boolean>>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NTAwNQ==", "bodyText": "That would avoid the eager subscription.", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404065005", "createdAt": "2020-04-06T12:51:10Z", "author": {"login": "cescoffier"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -56,13 +59,13 @@ private static QuarkusSecurityIdentity augmentIdentity(SecurityIdentity security\n                 .addPermissionChecker(new Function<Permission, CompletionStage<Boolean>>() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NDc4Nw=="}, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzI5MDgxOnYy", "diffSide": "RIGHT", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcIdentityProvider.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo1NDozOFrOGBWTNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNjozMTo1OFrOGDyTlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NzEyNQ==", "bodyText": "Are we ok with waiting \"indefinitely\"?", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404067125", "createdAt": "2020-04-06T12:54:38Z", "author": {"login": "cescoffier"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcIdentityProvider.java", "diffHunk": "@@ -48,15 +49,15 @@\n             return context.runBlocking(new Supplier<SecurityIdentity>() {\n                 @Override\n                 public SecurityIdentity get() {\n-                    return authenticate(request, vertxContext).join();\n+                    return authenticate(request, vertxContext).await().indefinitely();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDExMzA2MQ==", "bodyText": "@cescoffier the expectation here has been that Vertx client will not block itself if establishing a connection to OIDC is required. Can it block ? CC @pmlopes", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404113061", "createdAt": "2020-04-06T13:59:41Z", "author": {"login": "sberyozkin"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcIdentityProvider.java", "diffHunk": "@@ -48,15 +49,15 @@\n             return context.runBlocking(new Supplier<SecurityIdentity>() {\n                 @Override\n                 public SecurityIdentity get() {\n-                    return authenticate(request, vertxContext).join();\n+                    return authenticate(request, vertxContext).await().indefinitely();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NzEyNQ=="}, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYyMzEyNg==", "bodyText": "this code waits for an item, even if the underlying communication and processing in non-blocking, this code is waiting for the result.", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r406623126", "createdAt": "2020-04-10T06:31:58Z", "author": {"login": "cescoffier"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcIdentityProvider.java", "diffHunk": "@@ -48,15 +49,15 @@\n             return context.runBlocking(new Supplier<SecurityIdentity>() {\n                 @Override\n                 public SecurityIdentity get() {\n-                    return authenticate(request, vertxContext).join();\n+                    return authenticate(request, vertxContext).await().indefinitely();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NzEyNQ=="}, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzMwMzc1OnYy", "diffSide": "RIGHT", "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/QuarkusIdentityProviderManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo1Nzo1OVrOGBWbSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo1Nzo1OVrOGBWbSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2OTE5Mg==", "bodyText": "you can use flatMap as a shortcut.", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404069192", "createdAt": "2020-04-06T12:57:59Z", "author": {"login": "cescoffier"}, "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/QuarkusIdentityProviderManagerImpl.java", "diffHunk": "@@ -104,50 +104,49 @@ public SecurityIdentity authenticateBlocking(AuthenticationRequest request) {\n             throw new IllegalArgumentException(\n                     \"No IdentityProviders were registered to handle AuthenticationRequest \" + request);\n         }\n-        return (SecurityIdentity) handleProvider(0, (List) providers, request, blockingRequestContext).toCompletableFuture()\n-                .join();\n+        return (SecurityIdentity) handleProvider(0, (List) providers, request, blockingRequestContext).await().indefinitely();\n     }\n \n-    private <T extends AuthenticationRequest> CompletionStage<SecurityIdentity> handleProvider(int pos,\n+    private <T extends AuthenticationRequest> Uni<SecurityIdentity> handleProvider(int pos,\n             List<IdentityProvider<T>> providers, T request, AuthenticationRequestContext context) {\n         if (pos == providers.size()) {\n             //we failed to authentication\n             log.debug(\"Authentication failed as providers would authenticate the request\");\n-            CompletableFuture<SecurityIdentity> cf = new CompletableFuture<>();\n-            cf.completeExceptionally(new AuthenticationFailedException());\n-            return cf;\n+            return Uni.createFrom().failure(new AuthenticationFailedException());\n         }\n         IdentityProvider<T> current = providers.get(pos);\n-        CompletionStage<SecurityIdentity> cs = current.authenticate(request, context)\n-                .thenCompose(new Function<SecurityIdentity, CompletionStage<SecurityIdentity>>() {\n+        Uni<SecurityIdentity> cs = current.authenticate(request, context)\n+                .onItem().produceUni(new Function<SecurityIdentity, Uni<SecurityIdentity>>() {\n                     @Override\n-                    public CompletionStage<SecurityIdentity> apply(SecurityIdentity identity) {\n-                        if (identity != null) {\n-                            return CompletableFuture.completedFuture(identity);\n+                    public Uni<SecurityIdentity> apply(SecurityIdentity securityIdentity) {\n+                        if (securityIdentity != null) {\n+                            return Uni.createFrom().item(securityIdentity);\n                         }\n                         return handleProvider(pos + 1, providers, request, context);\n                     }\n                 });\n-        return cs.thenCompose(new Function<SecurityIdentity, CompletionStage<SecurityIdentity>>() {\n-            @Override\n-            public CompletionStage<SecurityIdentity> apply(SecurityIdentity identity) {\n-                return handleIdentityFromProvider(0, identity, context);\n-            }\n-        });\n+        return cs.onItem()\n+                .produceUni(new Function<SecurityIdentity, Uni<SecurityIdentity>>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzMwNDU0OnYy", "diffSide": "RIGHT", "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/QuarkusIdentityProviderManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo1ODoxMFrOGBWbwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo1ODoxMFrOGBWbwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2OTMxNA==", "bodyText": "you can use flatMap as a shortcut", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404069314", "createdAt": "2020-04-06T12:58:10Z", "author": {"login": "cescoffier"}, "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/QuarkusIdentityProviderManagerImpl.java", "diffHunk": "@@ -104,50 +104,49 @@ public SecurityIdentity authenticateBlocking(AuthenticationRequest request) {\n             throw new IllegalArgumentException(\n                     \"No IdentityProviders were registered to handle AuthenticationRequest \" + request);\n         }\n-        return (SecurityIdentity) handleProvider(0, (List) providers, request, blockingRequestContext).toCompletableFuture()\n-                .join();\n+        return (SecurityIdentity) handleProvider(0, (List) providers, request, blockingRequestContext).await().indefinitely();\n     }\n \n-    private <T extends AuthenticationRequest> CompletionStage<SecurityIdentity> handleProvider(int pos,\n+    private <T extends AuthenticationRequest> Uni<SecurityIdentity> handleProvider(int pos,\n             List<IdentityProvider<T>> providers, T request, AuthenticationRequestContext context) {\n         if (pos == providers.size()) {\n             //we failed to authentication\n             log.debug(\"Authentication failed as providers would authenticate the request\");\n-            CompletableFuture<SecurityIdentity> cf = new CompletableFuture<>();\n-            cf.completeExceptionally(new AuthenticationFailedException());\n-            return cf;\n+            return Uni.createFrom().failure(new AuthenticationFailedException());\n         }\n         IdentityProvider<T> current = providers.get(pos);\n-        CompletionStage<SecurityIdentity> cs = current.authenticate(request, context)\n-                .thenCompose(new Function<SecurityIdentity, CompletionStage<SecurityIdentity>>() {\n+        Uni<SecurityIdentity> cs = current.authenticate(request, context)\n+                .onItem().produceUni(new Function<SecurityIdentity, Uni<SecurityIdentity>>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzUxNDIxOnYy", "diffSide": "RIGHT", "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/QuarkusErrorHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMzo0NjoyOFrOGBYePg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMzo0NjoyOFrOGBYePg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwMjcxOA==", "bodyText": "Not totally sure what you are doing here.\nThe subscription will trigger the computation.\nBut you may want to be sure that an error has not been emitted.", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r404102718", "createdAt": "2020-04-06T13:46:28Z", "author": {"login": "cescoffier"}, "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/QuarkusErrorHandler.java", "diffHunk": "@@ -53,7 +53,7 @@ public void handle(RoutingContext event) {\n                     public void run() {\n                         event.response().end();\n                     }\n-                });\n+                }).subscribeAsCompletionStage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75166965a777d30d9638465a216dfe9846f8b26a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMzUxMDU5OnYy", "diffSide": "RIGHT", "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/QuarkusSecurityIdentity.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNjoyOTozMlrOGDyRdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwNjoyOTozMlrOGDyRdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYyMjU4Mg==", "bodyText": "return val?", "url": "https://github.com/quarkusio/quarkus/pull/8352#discussion_r406622582", "createdAt": "2020-04-10T06:29:32Z", "author": {"login": "cescoffier"}, "path": "extensions/security/runtime/src/main/java/io/quarkus/security/runtime/QuarkusSecurityIdentity.java", "diffHunk": "@@ -74,39 +77,42 @@ public boolean isAnonymous() {\n     }\n \n     @Override\n-    public CompletionStage<Boolean> checkPermission(Permission permission) {\n+    public Uni<Boolean> checkPermission(Permission permission) {\n         if (permissionCheckers.isEmpty()) {\n-            return CompletableFuture.completedFuture(true);\n+            return Uni.createFrom().item(true);\n         }\n-        List<CompletableFuture<Boolean>> results = new ArrayList<>(permissionCheckers.size());\n-        for (Function<Permission, CompletionStage<Boolean>> checker : permissionCheckers) {\n-            CompletionStage<Boolean> res = checker.apply(permission);\n+        List<Uni<Boolean>> results = new ArrayList<>(permissionCheckers.size());\n+        for (Function<Permission, Uni<Boolean>> checker : permissionCheckers) {\n+            Uni<Boolean> res = checker.apply(permission);\n             if (res != null) {\n-                results.add(res.toCompletableFuture());\n+                results.add(res);\n             }\n         }\n         if (results.isEmpty()) {\n-            return CompletableFuture.completedFuture(true);\n+            return Uni.createFrom().item(true);\n         }\n         if (results.size() == 1) {\n             return results.get(0);\n         }\n-        CompletionStage<Boolean> ret = results.get(0);\n-        for (int i = 1; i < results.size(); ++i) {\n-            ret = ret.thenCombine(results.get(i), new BiFunction<Boolean, Boolean, Boolean>() {\n-                @Override\n-                public Boolean apply(Boolean aBoolean, Boolean aBoolean2) {\n-                    if (aBoolean == null) {\n-                        return aBoolean2;\n+        return Uni.combine().all().unis(results).combinedWith(new Function<List<?>, Boolean>() {\n+            @Override\n+            public Boolean apply(List<?> o) {\n+                Boolean result = null;\n+                //if any are true we return true\n+                //otherwise if all are null we return null\n+                //if some are false and some null we return false\n+                for (Object i : o) {\n+                    if (i != null) {\n+                        boolean val = (boolean) i;\n+                        if (val) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "122a71d6d7dc5f2891ab34d352e14ebf74ae0efc"}, "originalPosition": 81}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3604, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}