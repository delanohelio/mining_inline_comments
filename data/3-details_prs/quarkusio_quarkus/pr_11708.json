{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MzQxNzM3", "number": 11708, "title": "Turn StartupBuildSteps.annotationTransformer() into an AutoAddScopeBuildItem", "bodyText": "\u2026ildItem.\nFixes #11700", "createdAt": "2020-08-28T11:08:44Z", "url": "https://github.com/quarkusio/quarkus/pull/11708", "merged": true, "mergeCommit": {"oid": "02c274c2cab1986dbb4f312a951b0eb81ff460d6"}, "closed": true, "closedAt": "2020-08-31T15:47:12Z", "author": {"login": "manovotn"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDTfTqAFqTQ3NzY1NzQ2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEOVfygFqTQ3ODQwOTU0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjU3NDYx", "url": "https://github.com/quarkusio/quarkus/pull/11708#pullrequestreview-477657461", "createdAt": "2020-08-28T11:37:02Z", "commit": {"oid": "83376970e1a462feaa1553dc21cd5949b53415f5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMTozNzowMlrOHI-XjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMTo0MDozMVrOHI-m1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTE3MjQ5Mg==", "bodyText": "This rule is applied automatically: https://github.com/quarkusio/quarkus/blob/master/extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/AutoAddScopeProcessor.java#L51", "url": "https://github.com/quarkusio/quarkus/pull/11708#discussion_r479172492", "createdAt": "2020-08-28T11:37:02Z", "author": {"login": "mkouba"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/StartupBuildSteps.java", "diffHunk": "@@ -51,26 +48,15 @@\n     private static final Logger LOGGER = Logger.getLogger(StartupBuildSteps.class);\n \n     @BuildStep\n-    AnnotationsTransformerBuildItem annotationTransformer(CustomScopeAnnotationsBuildItem customScopes) {\n-        return new AnnotationsTransformerBuildItem(new AnnotationsTransformer() {\n-\n-            @Override\n-            public boolean appliesTo(org.jboss.jandex.AnnotationTarget.Kind kind) {\n-                return kind == org.jboss.jandex.AnnotationTarget.Kind.CLASS;\n-            }\n-\n-            @Override\n-            public void transform(TransformationContext context) {\n-                if (context.isClass() && !customScopes.isScopeDeclaredOn(context.getTarget().asClass())) {\n-                    // Class with no built-in scope annotation but with @Scheduled method\n-                    if (Annotations.contains(context.getTarget().asClass().classAnnotations(), STARTUP_NAME)) {\n-                        LOGGER.debugf(\"Found @Startup on a class %s with no scope annotations - adding @ApplicationScoped\",\n-                                context.getTarget());\n-                        context.transform().add(ApplicationScoped.class).done();\n-                    }\n-                }\n-            }\n-        });\n+    AutoAddScopeBuildItem addScope(CustomScopeAnnotationsBuildItem customScopes) {\n+        // Class with no built-in scope annotation but with @Startup method\n+        return AutoAddScopeBuildItem.builder()\n+                .defaultScope(BuiltinScope.APPLICATION)\n+                .match((clazz, annotations, index) -> clazz.classAnnotation(STARTUP_NAME) != null\n+                        && !customScopes.isScopeDeclaredOn(clazz))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83376970e1a462feaa1553dc21cd5949b53415f5"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTE3MzQxMw==", "bodyText": "You can use AutoAddScopeBuildItem.Builder.containsAnnotations(DotName...) instead...", "url": "https://github.com/quarkusio/quarkus/pull/11708#discussion_r479173413", "createdAt": "2020-08-28T11:37:54Z", "author": {"login": "mkouba"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/StartupBuildSteps.java", "diffHunk": "@@ -51,26 +48,15 @@\n     private static final Logger LOGGER = Logger.getLogger(StartupBuildSteps.class);\n \n     @BuildStep\n-    AnnotationsTransformerBuildItem annotationTransformer(CustomScopeAnnotationsBuildItem customScopes) {\n-        return new AnnotationsTransformerBuildItem(new AnnotationsTransformer() {\n-\n-            @Override\n-            public boolean appliesTo(org.jboss.jandex.AnnotationTarget.Kind kind) {\n-                return kind == org.jboss.jandex.AnnotationTarget.Kind.CLASS;\n-            }\n-\n-            @Override\n-            public void transform(TransformationContext context) {\n-                if (context.isClass() && !customScopes.isScopeDeclaredOn(context.getTarget().asClass())) {\n-                    // Class with no built-in scope annotation but with @Scheduled method\n-                    if (Annotations.contains(context.getTarget().asClass().classAnnotations(), STARTUP_NAME)) {\n-                        LOGGER.debugf(\"Found @Startup on a class %s with no scope annotations - adding @ApplicationScoped\",\n-                                context.getTarget());\n-                        context.transform().add(ApplicationScoped.class).done();\n-                    }\n-                }\n-            }\n-        });\n+    AutoAddScopeBuildItem addScope(CustomScopeAnnotationsBuildItem customScopes) {\n+        // Class with no built-in scope annotation but with @Startup method\n+        return AutoAddScopeBuildItem.builder()\n+                .defaultScope(BuiltinScope.APPLICATION)\n+                .match((clazz, annotations, index) -> clazz.classAnnotation(STARTUP_NAME) != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83376970e1a462feaa1553dc21cd5949b53415f5"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTE3NjQwNQ==", "bodyText": "This is already handled in the unremovableBeans() method. We should either remove that method or remove this requirement...", "url": "https://github.com/quarkusio/quarkus/pull/11708#discussion_r479176405", "createdAt": "2020-08-28T11:40:31Z", "author": {"login": "mkouba"}, "path": "extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/StartupBuildSteps.java", "diffHunk": "@@ -51,26 +48,15 @@\n     private static final Logger LOGGER = Logger.getLogger(StartupBuildSteps.class);\n \n     @BuildStep\n-    AnnotationsTransformerBuildItem annotationTransformer(CustomScopeAnnotationsBuildItem customScopes) {\n-        return new AnnotationsTransformerBuildItem(new AnnotationsTransformer() {\n-\n-            @Override\n-            public boolean appliesTo(org.jboss.jandex.AnnotationTarget.Kind kind) {\n-                return kind == org.jboss.jandex.AnnotationTarget.Kind.CLASS;\n-            }\n-\n-            @Override\n-            public void transform(TransformationContext context) {\n-                if (context.isClass() && !customScopes.isScopeDeclaredOn(context.getTarget().asClass())) {\n-                    // Class with no built-in scope annotation but with @Scheduled method\n-                    if (Annotations.contains(context.getTarget().asClass().classAnnotations(), STARTUP_NAME)) {\n-                        LOGGER.debugf(\"Found @Startup on a class %s with no scope annotations - adding @ApplicationScoped\",\n-                                context.getTarget());\n-                        context.transform().add(ApplicationScoped.class).done();\n-                    }\n-                }\n-            }\n-        });\n+    AutoAddScopeBuildItem addScope(CustomScopeAnnotationsBuildItem customScopes) {\n+        // Class with no built-in scope annotation but with @Startup method\n+        return AutoAddScopeBuildItem.builder()\n+                .defaultScope(BuiltinScope.APPLICATION)\n+                .match((clazz, annotations, index) -> clazz.classAnnotation(STARTUP_NAME) != null\n+                        && !customScopes.isScopeDeclaredOn(clazz))\n+                .unremovable()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83376970e1a462feaa1553dc21cd5949b53415f5"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83376970e1a462feaa1553dc21cd5949b53415f5", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/83376970e1a462feaa1553dc21cd5949b53415f5", "committedDate": "2020-08-28T11:06:57Z", "message": "Turn StartupBuildSteps.annotationTransformer() into an AutoAddScopeBuildItem."}, "afterCommit": {"oid": "01d3fdc4b75ba3e465c0c35d1fb9116463615d89", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/01d3fdc4b75ba3e465c0c35d1fb9116463615d89", "committedDate": "2020-08-28T14:30:51Z", "message": "Turn StartupBuildSteps.annotationTransformer() into an AutoAddScopeBuildItem."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c1d7e33aaab03ff9db3ac9abc4cf5379e8910d8", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/0c1d7e33aaab03ff9db3ac9abc4cf5379e8910d8", "committedDate": "2020-08-31T08:00:14Z", "message": "Turn StartupBuildSteps.annotationTransformer() into an AutoAddScopeBuildItem."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01d3fdc4b75ba3e465c0c35d1fb9116463615d89", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/01d3fdc4b75ba3e465c0c35d1fb9116463615d89", "committedDate": "2020-08-28T14:30:51Z", "message": "Turn StartupBuildSteps.annotationTransformer() into an AutoAddScopeBuildItem."}, "afterCommit": {"oid": "0c1d7e33aaab03ff9db3ac9abc4cf5379e8910d8", "author": {"user": {"login": "manovotn", "name": "Matej Novotny"}}, "url": "https://github.com/quarkusio/quarkus/commit/0c1d7e33aaab03ff9db3ac9abc4cf5379e8910d8", "committedDate": "2020-08-31T08:00:14Z", "message": "Turn StartupBuildSteps.annotationTransformer() into an AutoAddScopeBuildItem."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDA5NTQw", "url": "https://github.com/quarkusio/quarkus/pull/11708#pullrequestreview-478409540", "createdAt": "2020-08-31T08:15:05Z", "commit": {"oid": "0c1d7e33aaab03ff9db3ac9abc4cf5379e8910d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 628, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}