{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NDQ2NTU1", "number": 12198, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoxNTowN1rOEpXVLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoyMToyMFrOEpXeaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODA5MzI1OnYy", "diffSide": "RIGHT", "path": "extensions/oidc/deployment/src/main/java/io/quarkus/oidc/deployment/OidcBuildStep.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoxNTowN1rOHa_W7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoxNTowN1rOHa_W7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2MzA4NQ==", "bodyText": "You should read the ValidationPhaseBuildItem javadoc more carefully ;-). Your build step should produce or pretend that it produces a ValidationErrorBuildItem.", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498063085", "createdAt": "2020-10-01T08:15:07Z", "author": {"login": "mkouba"}, "path": "extensions/oidc/deployment/src/main/java/io/quarkus/oidc/deployment/OidcBuildStep.java", "diffHunk": "@@ -90,6 +97,18 @@ public SyntheticBeanBuildItem setup(\n                 .done();\n     }\n \n+    @BuildStep(onlyIf = IsEnabled.class)\n+    @Record(ExecutionTime.RUNTIME_INIT)\n+    public void findSecurityEventObservers(\n+            OidcRecorder recorder,\n+            ValidationPhaseBuildItem validationPhase) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODEwNzg1OnYy", "diffSide": "RIGHT", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoxODo1N1rOHa_fww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMToyOTowMFrOHbGEQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NTM0Nw==", "bodyText": "You should rather create and cache an Event object for perf reasons, i.e. Event<SecurityEvent> event = Arc.container().beanManager().getEvent().select(SecurityEvent.class) and then event.fire(...).", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498065347", "createdAt": "2020-10-01T08:18:57Z", "author": {"login": "mkouba"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -390,6 +396,13 @@ private void processSuccessfulAuthentication(RoutingContext context,\n             maxAge += configContext.oidcConfig.authentication.sessionAgeExtension.getSeconds();\n         }\n         createCookie(context, configContext, getSessionCookieName(configContext), cookieValue, maxAge);\n+        fireEvent(SecurityEvent.Type.OIDC_LOGIN, securityIdentity);\n+    }\n+\n+    private void fireEvent(SecurityEvent.Type eventType, SecurityIdentity securityIdentity) {\n+        if (resolver.isSecurityEventObserved()) {\n+            Arc.container().beanManager().fireEvent(new SecurityEvent(eventType, securityIdentity));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NjA0Mg==", "bodyText": "Or even inject the Event object if possible...", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498066042", "createdAt": "2020-10-01T08:20:04Z", "author": {"login": "mkouba"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -390,6 +396,13 @@ private void processSuccessfulAuthentication(RoutingContext context,\n             maxAge += configContext.oidcConfig.authentication.sessionAgeExtension.getSeconds();\n         }\n         createCookie(context, configContext, getSessionCookieName(configContext), cookieValue, maxAge);\n+        fireEvent(SecurityEvent.Type.OIDC_LOGIN, securityIdentity);\n+    }\n+\n+    private void fireEvent(SecurityEvent.Type eventType, SecurityIdentity securityIdentity) {\n+        if (resolver.isSecurityEventObserved()) {\n+            Arc.container().beanManager().fireEvent(new SecurityEvent(eventType, securityIdentity));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NTM0Nw=="}, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEyODAzNA==", "bodyText": "Hi Martin @mkouba so if it gets injected as an Instance, ex, Instance<Event<SecurityEvent>> securityEvent, then securityEvent.isResolvable() (=> if true then it means there must be at least one Observer available) would make the build step with ValidationPhaseBuildItem and the securityEventObserved property redundant ? Or would securityEvent.isResolvable() check be a bit more expensive than using the ValidationPhaseBuildItem approach ?\nAt the moment I've added Event<SecurityEvent> event = Arc.container().beanManager().getEvent().select(SecurityEvent.class)", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498128034", "createdAt": "2020-10-01T10:02:42Z", "author": {"login": "sberyozkin"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -390,6 +396,13 @@ private void processSuccessfulAuthentication(RoutingContext context,\n             maxAge += configContext.oidcConfig.authentication.sessionAgeExtension.getSeconds();\n         }\n         createCookie(context, configContext, getSessionCookieName(configContext), cookieValue, maxAge);\n+        fireEvent(SecurityEvent.Type.OIDC_LOGIN, securityIdentity);\n+    }\n+\n+    private void fireEvent(SecurityEvent.Type eventType, SecurityIdentity securityIdentity) {\n+        if (resolver.isSecurityEventObserved()) {\n+            Arc.container().beanManager().fireEvent(new SecurityEvent(eventType, securityIdentity));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NTM0Nw=="}, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzNzY0MQ==", "bodyText": "Or if injection this Event will only lead to a slightly better cache creation time then maybe Arc.container().beanManager().getEvent().select(SecurityEvent.class)  will do ?", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498137641", "createdAt": "2020-10-01T10:19:26Z", "author": {"login": "sberyozkin"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -390,6 +396,13 @@ private void processSuccessfulAuthentication(RoutingContext context,\n             maxAge += configContext.oidcConfig.authentication.sessionAgeExtension.getSeconds();\n         }\n         createCookie(context, configContext, getSessionCookieName(configContext), cookieValue, maxAge);\n+        fireEvent(SecurityEvent.Type.OIDC_LOGIN, securityIdentity);\n+    }\n+\n+    private void fireEvent(SecurityEvent.Type eventType, SecurityIdentity securityIdentity) {\n+        if (resolver.isSecurityEventObserved()) {\n+            Arc.container().beanManager().fireEvent(new SecurityEvent(eventType, securityIdentity));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NTM0Nw=="}, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEzOTMyMw==", "bodyText": "You should not use Instance but Event<SecurityEvent> (Event is a built-in bean and is always available). And no, securityEvent.isResolvable() does not care about observers. Arc.container().beanManager().getEvent().select(SecurityEvent.class) is fine.", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498139323", "createdAt": "2020-10-01T10:22:25Z", "author": {"login": "mkouba"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -390,6 +396,13 @@ private void processSuccessfulAuthentication(RoutingContext context,\n             maxAge += configContext.oidcConfig.authentication.sessionAgeExtension.getSeconds();\n         }\n         createCookie(context, configContext, getSessionCookieName(configContext), cookieValue, maxAge);\n+        fireEvent(SecurityEvent.Type.OIDC_LOGIN, securityIdentity);\n+    }\n+\n+    private void fireEvent(SecurityEvent.Type eventType, SecurityIdentity securityIdentity) {\n+        if (resolver.isSecurityEventObserved()) {\n+            Arc.container().beanManager().fireEvent(new SecurityEvent(eventType, securityIdentity));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NTM0Nw=="}, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE3Mjk5Mg==", "bodyText": "Hi @mkouba OK, thanks, so I've just injected the event and also moved the boolean property to the same bean, and now it all looks very compact, and it is also very optimal performance wise :-), how does it all look to you now ?\nI did not want to hide it all in DefaultTenantConfigResolver as it is mainly about resolving different OIDC properties/config... so for now keeping checking and firing the events in CodeAuthenticationMechanism\nthanks", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498172992", "createdAt": "2020-10-01T11:29:00Z", "author": {"login": "sberyozkin"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -390,6 +396,13 @@ private void processSuccessfulAuthentication(RoutingContext context,\n             maxAge += configContext.oidcConfig.authentication.sessionAgeExtension.getSeconds();\n         }\n         createCookie(context, configContext, getSessionCookieName(configContext), cookieValue, maxAge);\n+        fireEvent(SecurityEvent.Type.OIDC_LOGIN, securityIdentity);\n+    }\n+\n+    private void fireEvent(SecurityEvent.Type eventType, SecurityIdentity securityIdentity) {\n+        if (resolver.isSecurityEventObserved()) {\n+            Arc.container().beanManager().fireEvent(new SecurityEvent(eventType, securityIdentity));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NTM0Nw=="}, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODExNjkxOnYy", "diffSide": "RIGHT", "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/TenantConfigBean.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoyMToyMFrOHa_lbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoyMToyMFrOHa_lbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2Njc5OQ==", "bodyText": "This field should be probably volatile...", "url": "https://github.com/quarkusio/quarkus/pull/12198#discussion_r498066799", "createdAt": "2020-10-01T08:21:20Z", "author": {"login": "mkouba"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/TenantConfigBean.java", "diffHunk": "@@ -10,6 +10,7 @@\n     private final Map<String, TenantConfigContext> staticTenantsConfig;\n     private final TenantConfigContext defaultTenant;\n     private final Function<OidcTenantConfig, TenantConfigContext> tenantConfigContextFactory;\n+    private boolean securityEventObserved;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed81d0310be40cafb2e4d8d2dca308cba2dcf0ce"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 172, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}