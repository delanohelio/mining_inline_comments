{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3OTY0MTk0", "number": 6824, "title": "Make Jaeger tracer reconfigurable", "bodyText": "Resolves https://issues.redhat.com/browse/TRACING-876\nChanges\n\nJaeger tracer reconfigurable on restarts e.g. in dev mode. I\ncleaner way how the quarkus tracer is configured (instead of passing conf via system property it passes configuration directly to tracer object.)\nConfig validation (service name) is disabled. If the Jaeger service name is not configured it will use quarkus.application.name or fallback to a quarkus/unknown.\n\nSigned-off-by: Pavol Loffay ploffay@redhat.com", "createdAt": "2020-01-28T11:34:40Z", "url": "https://github.com/quarkusio/quarkus/pull/6824", "merged": true, "mergeCommit": {"oid": "4d0c07e9f047c6d8d4c5280a9194192df4c329f7"}, "closed": true, "closedAt": "2020-02-07T08:15:29Z", "author": {"login": "pavolloffay"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-vwgMgFqTM0OTMwNzg1Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB63oiAFqTM1NDk4ODIzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzA3ODUy", "url": "https://github.com/quarkusio/quarkus/pull/6824#pullrequestreview-349307852", "createdAt": "2020-01-28T11:36:45Z", "commit": {"oid": "615136c46264f1e8684f99d126745510434f4786"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMTozNjo0NVrOFih34A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMTozNjo0NVrOFih34A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc1MDg4MA==", "bodyText": "On Jaeger creates metrics. On runtime restart a new tracer is created therefore a set of metrics is registered. On multiple restarts the same set of metrics are being registered which causes\nCaused by: java.lang.IllegalArgumentException: A metric with metricID MetricID{name='jaeger_tracer_reporter_queue_length', tags=[]} already exists\n\tat io.smallrye.metrics.MetricsRegistryImpl.register(MetricsRegistryImpl.java:129)\n\tat io.quarkus.jaeger.runtime.QuarkusJaegerMetricsFactory.createGauge(QuarkusJaegerMetricsFactory.java:48)\n\tat io.jaegertracing.internal.metrics.Metrics.createMetrics(Metrics.java:66)\n\t... 37 more\n\nDoes anybody know a better solution to this?", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r371750880", "createdAt": "2020-01-28T11:36:45Z", "author": {"login": "pavolloffay"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/QuarkusJaegerMetricsFactory.java", "diffHunk": "@@ -21,6 +21,9 @@\n \n     @Override\n     public Counter createCounter(final String name, final Map<String, String> tags) {\n+        // On restart (e.g. in dev mode) Jaeger registers\n+        // the same metrics which would result in exception\n+        registry.remove(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "615136c46264f1e8684f99d126745510434f4786"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff03525e0ea692d8f56851edf0c5eed8d774e05b", "author": {"user": {"login": "pavolloffay", "name": "Pavol Loffay"}}, "url": "https://github.com/quarkusio/quarkus/commit/ff03525e0ea692d8f56851edf0c5eed8d774e05b", "committedDate": "2020-01-29T09:48:28Z", "message": "Fallback to unknown if there is no app name\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>"}, "afterCommit": {"oid": "556685637c3a071e74471aeea30c897919d0341e", "author": {"user": {"login": "pavolloffay", "name": "Pavol Loffay"}}, "url": "https://github.com/quarkusio/quarkus/commit/556685637c3a071e74471aeea30c897919d0341e", "committedDate": "2020-01-29T12:35:48Z", "message": "Fallback to unknown if there is no app name\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMTI0MjA2", "url": "https://github.com/quarkusio/quarkus/pull/6824#pullrequestreview-352124206", "createdAt": "2020-02-03T09:42:20Z", "commit": {"oid": "556685637c3a071e74471aeea30c897919d0341e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo0MjoyMFrOFkrUNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo0MjoyMFrOFkrUNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAwMjc0MQ==", "bodyText": "TBH this looks a little suspicious. Can you please explain what you are trying to achieve here?", "url": "https://github.com/quarkusio/quarkus/pull/6824#discussion_r374002741", "createdAt": "2020-02-03T09:42:20Z", "author": {"login": "geoand"}, "path": "extensions/jaeger/runtime/src/main/java/io/quarkus/jaeger/runtime/JaegerDeploymentRecorder.java", "diffHunk": "@@ -1,45 +1,37 @@\n package io.quarkus.jaeger.runtime;\n \n-import static io.jaegertracing.Configuration.JAEGER_SERVICE_NAME;\n-\n import java.util.Optional;\n import java.util.function.Function;\n \n-import org.eclipse.microprofile.config.Config;\n-import org.eclipse.microprofile.config.ConfigProvider;\n import org.jboss.logging.Logger;\n \n import io.opentracing.util.GlobalTracer;\n+import io.quarkus.runtime.ApplicationConfig;\n import io.quarkus.runtime.annotations.Recorder;\n \n @Recorder\n public class JaegerDeploymentRecorder {\n-    private static volatile boolean registered;\n-\n     private static final Logger log = Logger.getLogger(JaegerDeploymentRecorder.class);\n+    private static final Optional UNKNOWN_SERVICE_NAME = Optional.of(\"quarkus/unknown\");\n+    private static final QuarkusJaegerTracer quarkusTracer = new QuarkusJaegerTracer();\n \n-    public void registerTracer(JaegerConfig jaeger) {\n-        if (!registered) {\n-            if (isValidConfig(jaeger)) {\n-                initTracerConfig(jaeger);\n-                QuarkusJaegerTracer quarkusJaegerTracer = new QuarkusJaegerTracer();\n-                log.debugf(\"Registering tracer to GlobalTracer %s\", quarkusJaegerTracer);\n-                GlobalTracer.register(quarkusJaegerTracer);\n-            }\n-            registered = true;\n+    static {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "556685637c3a071e74471aeea30c897919d0341e"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54cffc06e3d7da5fecdf437bb26770655e166c17", "author": {"user": {"login": "pavolloffay", "name": "Pavol Loffay"}}, "url": "https://github.com/quarkusio/quarkus/commit/54cffc06e3d7da5fecdf437bb26770655e166c17", "committedDate": "2020-02-03T10:29:09Z", "message": "Move static global tracer initialization to a method\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>"}, "afterCommit": {"oid": "bcdc03c8142f4b4c86e7ac8d440e473bc7e65367", "author": {"user": {"login": "pavolloffay", "name": "Pavol Loffay"}}, "url": "https://github.com/quarkusio/quarkus/commit/bcdc03c8142f4b4c86e7ac8d440e473bc7e65367", "committedDate": "2020-02-03T10:30:54Z", "message": "Move static global tracer initialization to a method\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "434f195df32f207faee92a13f0a98e2ce69bd0cb", "author": {"user": {"login": "pavolloffay", "name": "Pavol Loffay"}}, "url": "https://github.com/quarkusio/quarkus/commit/434f195df32f207faee92a13f0a98e2ce69bd0cb", "committedDate": "2020-02-03T11:06:10Z", "message": "Make Jaeger tracer reconfigurable\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d557e7e3b44941b243a2f3d2deb9b25cd20a2699", "author": {"user": {"login": "pavolloffay", "name": "Pavol Loffay"}}, "url": "https://github.com/quarkusio/quarkus/commit/d557e7e3b44941b243a2f3d2deb9b25cd20a2699", "committedDate": "2020-02-03T11:06:10Z", "message": "Move static global tracer initialization to a method\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcdc03c8142f4b4c86e7ac8d440e473bc7e65367", "author": {"user": {"login": "pavolloffay", "name": "Pavol Loffay"}}, "url": "https://github.com/quarkusio/quarkus/commit/bcdc03c8142f4b4c86e7ac8d440e473bc7e65367", "committedDate": "2020-02-03T10:30:54Z", "message": "Move static global tracer initialization to a method\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>"}, "afterCommit": {"oid": "d557e7e3b44941b243a2f3d2deb9b25cd20a2699", "author": {"user": {"login": "pavolloffay", "name": "Pavol Loffay"}}, "url": "https://github.com/quarkusio/quarkus/commit/d557e7e3b44941b243a2f3d2deb9b25cd20a2699", "committedDate": "2020-02-03T11:06:10Z", "message": "Move static global tracer initialization to a method\n\nSigned-off-by: Pavol Loffay <ploffay@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTg4MjMx", "url": "https://github.com/quarkusio/quarkus/pull/6824#pullrequestreview-354988231", "createdAt": "2020-02-07T08:15:16Z", "commit": {"oid": "d557e7e3b44941b243a2f3d2deb9b25cd20a2699"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 163, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}