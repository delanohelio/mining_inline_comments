{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2Mjk5MDY2", "number": 10576, "title": "Bootstrap workspace discovery: fix infinite loop, pom model cache", "bodyText": "Fixes #10549", "createdAt": "2020-07-08T14:55:51Z", "url": "https://github.com/quarkusio/quarkus/pull/10576", "merged": true, "mergeCommit": {"oid": "b9f12586c5e7f9f6999e9ef2d54384439eee5f01"}, "closed": true, "closedAt": "2020-07-08T23:24:52Z", "author": {"login": "aloubyansky"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy8PQmAFqTQ0NDg4NjI1NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczC-wzgFqTQ0NTE5MzE0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODg2MjU1", "url": "https://github.com/quarkusio/quarkus/pull/10576#pullrequestreview-444886255", "createdAt": "2020-07-08T15:33:15Z", "commit": {"oid": "b07e455d5121f95f7a337d87f4824c95c7146fcd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNTozMzoxNlrOGuttew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNTozMzoxNlrOGuttew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYzNjYwMw==", "bodyText": "This snippet can be replaced with:\n        private Model model(Path pomFile) throws BootstrapMavenException {\n            return cachedModels.computeIfEmpty(pomFile.getParent(), parent->readModel(pomFile));\n        }", "url": "https://github.com/quarkusio/quarkus/pull/10576#discussion_r451636603", "createdAt": "2020-07-08T15:33:16Z", "author": {"login": "gastaldi"}, "path": "independent-projects/bootstrap/maven-resolver/src/main/java/io/quarkus/bootstrap/resolver/maven/workspace/LocalProject.java", "diffHunk": "@@ -30,6 +31,124 @@\n     private static final String PROJECT_BASEDIR = \"${project.basedir}\";\n     private static final String POM_XML = \"pom.xml\";\n \n+    private static class WorkspaceLoader {\n+\n+        private final LocalWorkspace workspace = new LocalWorkspace();\n+        private final Map<Path, Model> cachedModels = new HashMap<>();\n+        private final Path currentProjectPom;\n+        private Path workspaceRootPom;\n+\n+        private WorkspaceLoader(Path currentProjectPom) throws BootstrapMavenException {\n+            this.currentProjectPom = isPom(currentProjectPom) ? currentProjectPom : locateCurrentProjectPom(currentProjectPom, true);\n+        }\n+\n+        private boolean isPom(Path p) {\n+            if (Files.exists(p) && !Files.isDirectory(p)) {\n+                try {\n+                    loadAndCache(p);\n+                    return true;\n+                } catch (BootstrapMavenException e) {\n+                    // not a POM file\n+                }\n+            }\n+            return false;\n+        }\n+\n+        private Model model(Path pomFile) throws BootstrapMavenException {\n+            Model model = cachedModels.get(pomFile.getParent());\n+            if(model == null) {\n+                model = loadAndCache(pomFile);\n+            }\n+            return model;\n+        }\n+\n+        private Model loadAndCache(Path pomFile) throws BootstrapMavenException {\n+            final Model model = readModel(pomFile);\n+            cachedModels.put(pomFile.getParent(), model);\n+            return model;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b07e455d5121f95f7a337d87f4824c95c7146fcd"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "297a82b73a063ceb08420b37bc449a602090ef99", "author": {"user": {"login": "aloubyansky", "name": "Alexey Loubyansky"}}, "url": "https://github.com/quarkusio/quarkus/commit/297a82b73a063ceb08420b37bc449a602090ef99", "committedDate": "2020-07-08T15:49:27Z", "message": "Bootstrap workspace discovery: fix infinite loop, pom model cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b07e455d5121f95f7a337d87f4824c95c7146fcd", "author": {"user": {"login": "aloubyansky", "name": "Alexey Loubyansky"}}, "url": "https://github.com/quarkusio/quarkus/commit/b07e455d5121f95f7a337d87f4824c95c7146fcd", "committedDate": "2020-07-08T14:53:43Z", "message": "Bootstrap workspace discovery: fix infinite loop, pom model cache"}, "afterCommit": {"oid": "297a82b73a063ceb08420b37bc449a602090ef99", "author": {"user": {"login": "aloubyansky", "name": "Alexey Loubyansky"}}, "url": "https://github.com/quarkusio/quarkus/commit/297a82b73a063ceb08420b37bc449a602090ef99", "committedDate": "2020-07-08T15:49:27Z", "message": "Bootstrap workspace discovery: fix infinite loop, pom model cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDc3ODk3", "url": "https://github.com/quarkusio/quarkus/pull/10576#pullrequestreview-445077897", "createdAt": "2020-07-08T19:46:09Z", "commit": {"oid": "297a82b73a063ceb08420b37bc449a602090ef99"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTkzMTQ1", "url": "https://github.com/quarkusio/quarkus/pull/10576#pullrequestreview-445193145", "createdAt": "2020-07-08T23:24:35Z", "commit": {"oid": "297a82b73a063ceb08420b37bc449a602090ef99"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3690, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}