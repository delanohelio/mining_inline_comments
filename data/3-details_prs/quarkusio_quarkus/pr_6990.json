{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwODQzOTgw", "number": 6990, "title": "ArC - improve performance of Reflections.findX() methods", "bodyText": "resolves #6959\n\nImplementation notes\n\nwe do cache all results in static caches\nwe intentionally do not use weak references for keys/values - caches are cleared when the when the container is shut down\n\nMicrobenchmarks\nI've added a microbenchmark to compare the performance results: https://github.com/mkouba/arc-benchmarks/blob/master/src/main/java/io/quarkus/arc/benchmarks/ReflectionsBenchmark.java. And the results are:\n1.2.0.Final\nBenchmark                         Mode  Cnt       Score       Error  Units\nReflectionsBenchmark.findField   thrpt   25  468775,169 \u00b1 21317,025  ops/s\nReflectionsBenchmark.findMethod  thrpt   25  320135,824 \u00b1  6466,329  ops/s\n\n999-SNAPSHOT\nBenchmark                         Mode  Cnt         Score         Error  Units\nReflectionsBenchmark.findField   thrpt   25  62357079,271 \u00b1 2309336,554  ops/s\nReflectionsBenchmark.findMethod  thrpt   25  54075745,129 \u00b1 1846794,145  ops/s", "createdAt": "2020-02-04T13:41:49Z", "url": "https://github.com/quarkusio/quarkus/pull/6990", "merged": true, "mergeCommit": {"oid": "ef099f3a4bdc00cfea4ff394b68c37bb3dcad372"}, "closed": true, "closedAt": "2020-02-04T21:32:59Z", "author": {"login": "mkouba"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBBmPkgH2gAyMzcwODQzOTgwOjg4Y2E5NTExY2RiYjUxYjIwZjYzZjY3OGFlYTUyM2QzNWFiOWZkNGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBDlSbgFqTM1MzA4NjU2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "88ca9511cdbb51b20f63f678aea523d35ab9fd4f", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/88ca9511cdbb51b20f63f678aea523d35ab9fd4f", "committedDate": "2020-02-04T13:31:41Z", "message": "ArC - improve performance of Reflections.findX() methods\n\n- resolves #6959"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyOTg0NjE0", "url": "https://github.com/quarkusio/quarkus/pull/6990#pullrequestreview-352984614", "createdAt": "2020-02-04T13:46:40Z", "commit": {"oid": "88ca9511cdbb51b20f63f678aea523d35ab9fd4f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMzo0Njo0MFrOFlUhnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxMzo0Njo0MFrOFlUhnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY3NzkxNw==", "bodyText": "Could you try with:\n\nremoving the finals here and in the other key class\ncaching the hashCode in the constructor\nnot using Objects.hash(clazz, methodName) as it does one more array allocation\n\nThat's what I did in HV and it was beneficial. If it doesn't make any significant difference, we can keep it your way but as you have a benchmark and we are optimizing things, it's worth a quick check IMHO", "url": "https://github.com/quarkusio/quarkus/pull/6990#discussion_r374677917", "createdAt": "2020-02-04T13:46:40Z", "author": {"login": "gsmet"}, "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/Reflections.java", "diffHunk": "@@ -148,4 +197,74 @@ public static Object invokeMethod(Class<?> clazz, String name, Class<?>[] paramT\n         }\n     }\n \n+    static final class MethodKey {\n+\n+        final Class<?> clazz;\n+        final String methodName;\n+        final Class<?>[] parameterTypes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88ca9511cdbb51b20f63f678aea523d35ab9fd4f"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5812f7bb8a4800fcad1ca8f5b4217539fa048cb9", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/5812f7bb8a4800fcad1ca8f5b4217539fa048cb9", "committedDate": "2020-02-04T15:40:26Z", "message": "Reflections - cache key hashCodes and get rid of Objects.hashCode()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMDgwNjgy", "url": "https://github.com/quarkusio/quarkus/pull/6990#pullrequestreview-353080682", "createdAt": "2020-02-04T15:43:34Z", "commit": {"oid": "5812f7bb8a4800fcad1ca8f5b4217539fa048cb9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNTo0MzozNFrOFlY9Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNTo0MzozNFrOFlY9Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc1MDUxMA==", "bodyText": "Maybe move that part to a buildHashCode method? :)", "url": "https://github.com/quarkusio/quarkus/pull/6990#discussion_r374750510", "createdAt": "2020-02-04T15:43:34Z", "author": {"login": "gsmet"}, "path": "independent-projects/arc/runtime/src/main/java/io/quarkus/arc/impl/Reflections.java", "diffHunk": "@@ -148,4 +197,84 @@ public static Object invokeMethod(Class<?> clazz, String name, Class<?>[] paramT\n         }\n     }\n \n+    static final class MethodKey {\n+\n+        final Class<?> clazz;\n+        final String methodName;\n+        final Class<?>[] parameterTypes;\n+        final int hashCode;\n+\n+        public MethodKey(Class<?> clazz, String methodName, Class<?>[] parameterTypes) {\n+            this.clazz = clazz;\n+            this.methodName = methodName;\n+            this.parameterTypes = parameterTypes;\n+            final int prime = 31;\n+            int result = 1;\n+            result = prime * result + Arrays.hashCode(parameterTypes);\n+            result = prime * result + ((clazz == null) ? 0 : clazz.hashCode());\n+            result = prime * result + ((methodName == null) ? 0 : methodName.hashCode());\n+            this.hashCode = result;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5812f7bb8a4800fcad1ca8f5b4217539fa048cb9"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMDg2NTYw", "url": "https://github.com/quarkusio/quarkus/pull/6990#pullrequestreview-353086560", "createdAt": "2020-02-04T15:50:27Z", "commit": {"oid": "5812f7bb8a4800fcad1ca8f5b4217539fa048cb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 71, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}