{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3Nzc2OTIz", "number": 8779, "title": "Add first version of Spring Cache annotations", "bodyText": "Depends on: quarkusio/quarkus-spring-api#12\nThis first version is intentionally limited. Spring Cache support can be greatly expanded with extra work on the caching layer once #8631 is in", "createdAt": "2020-04-23T08:57:36Z", "url": "https://github.com/quarkusio/quarkus/pull/8779", "merged": true, "mergeCommit": {"oid": "62036adff632c365c0d0f6a14b5e593907ead65d"}, "closed": true, "closedAt": "2020-05-12T10:38:32Z", "author": {"login": "geoand"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcarMd_gBqjMyNjc5NzAxMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcghDl7gFqTQwOTg3NDA1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5788a39d6671b30c9d5e4accce2c64d41e384a38", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/5788a39d6671b30c9d5e4accce2c64d41e384a38", "committedDate": "2020-04-23T08:50:19Z", "message": "Add first version of Spring Cache annotations"}, "afterCommit": {"oid": "b30bf2c18c8874f54c5d63de4a7398e01cd71b71", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/b30bf2c18c8874f54c5d63de4a7398e01cd71b71", "committedDate": "2020-04-24T06:07:31Z", "message": "Add first version of Spring Cache annotations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b30bf2c18c8874f54c5d63de4a7398e01cd71b71", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/b30bf2c18c8874f54c5d63de4a7398e01cd71b71", "committedDate": "2020-04-24T06:07:31Z", "message": "Add first version of Spring Cache annotations"}, "afterCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889", "committedDate": "2020-05-01T17:45:52Z", "message": "Add first version of Spring Cache annotations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTUxNDYw", "url": "https://github.com/quarkusio/quarkus/pull/8779#pullrequestreview-404551460", "createdAt": "2020-05-02T18:46:59Z", "commit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxODo0Njo1OVrOGPlV-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQyMDo1Njo0MlrOGPmKVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk5MzY1Ng==", "bodyText": "SPRING_CACHE should come before SPRING_CLOUD_CONFIG_CLIENT if alphabetical order matters :)", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r418993656", "createdAt": "2020-05-02T18:46:59Z", "author": {"login": "gwenneg"}, "path": "core/deployment/src/main/java/io/quarkus/deployment/builditem/FeatureBuildItem.java", "diffHunk": "@@ -93,6 +93,7 @@\n     public static final String SPRING_SECURITY = \"spring-security\";\n     public static final String SPRING_BOOT_PROPERTIES = \"spring-boot-properties\";\n     public static final String SPRING_CLOUD_CONFIG_CLIENT = \"spring-cloud-config-client\";\n+    public static final String SPRING_CACHE = \"spring-cache\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMTUxNg==", "bodyText": "Is this file used somewhere?", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419001516", "createdAt": "2020-05-02T20:03:26Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/test/resources/cache-config-test.properties", "diffHunk": "@@ -0,0 +1,4 @@\n+quarkus.cache.caffeine.\"test-cache\".initial-capacity=10\n+quarkus.cache.caffeine.\"test-cache\".maximum-size=100\n+quarkus.cache.caffeine.\"test-cache\".expire-after-write=30\n+quarkus.cache.caffeine.\"test-cache\".expire-after-access=P2D", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMjQ5OA==", "bodyText": "This message is not consistent with the test.", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419002498", "createdAt": "2020-05-02T20:13:32Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/test/java/io/quarkus/cache/test/runtime/UnsupportedAnnotationValueTest.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package io.quarkus.cache.test.runtime;\n+\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+import javax.inject.Singleton;\n+\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.test.QuarkusUnitTest;\n+\n+public class UnsupportedAnnotationValueTest {\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest TEST = new QuarkusUnitTest().setArchiveProducer(\n+            () -> ShrinkWrap.create(JavaArchive.class).addClass(CachedService.class))\n+            .setExpectedException(IllegalArgumentException.class);\n+\n+    @Test\n+    public void testApplicationShouldNotStart() {\n+        fail(\"Application should not start when Spring caching annotations are used on a class instead of a method\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzIzNQ==", "bodyText": "Is it OK to put the link here while the guide isn't part of the PR?", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419003235", "createdAt": "2020-05-02T20:20:31Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/runtime/src/main/resources/META-INF/quarkus-extension.yaml", "diffHunk": "@@ -0,0 +1,10 @@\n+---\n+name: \"Quarkus Extension for Spring Cache API\"\n+metadata:\n+  keywords:\n+  - \"spring-cache\"\n+  - \"spring\"\n+  guide: \"https://quarkus.io/guides/spring-cache\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzYwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);\n          \n          \n            \n                        AnnotationInstance cacheable = methodInfo.annotation(CACHEABLE);", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419003609", "createdAt": "2020-05-02T20:24:08Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheAnnotationsTransformer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHEABLE;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_EVICT;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_PUT;\n+import static io.quarkus.spring.cache.SpringCacheUtil.getSpringCacheName;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.MethodInfo;\n+\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.cache.deployment.CacheDeploymentConstants;\n+import io.quarkus.cache.runtime.CacheInvalidateAllInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheInvalidateInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheResultInterceptorBinding;\n+\n+public class SpringCacheAnnotationsTransformer implements AnnotationsTransformer {\n+\n+    private static final DotName CACHE_RESULT_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheResultInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateAllInterceptorBinding.class.getName());\n+\n+    @Override\n+    public boolean appliesTo(AnnotationTarget.Kind kind) {\n+        return kind == AnnotationTarget.Kind.METHOD;\n+    }\n+\n+    @Override\n+    public void transform(TransformationContext transformationContext) {\n+        AnnotationTarget target = transformationContext.getTarget();\n+        if (target.kind() != AnnotationTarget.Kind.METHOD) {\n+            return;\n+        }\n+        MethodInfo methodInfo = target.asMethod();\n+        if (methodInfo.hasAnnotation(CACHEABLE)) {\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwMzYzNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        AnnotationInstance cacheResult = methodInfo.annotation(CACHE_PUT);\n          \n          \n            \n                        AnnotationInstance cachePut = methodInfo.annotation(CACHE_PUT);", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419003637", "createdAt": "2020-05-02T20:24:28Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheAnnotationsTransformer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHEABLE;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_EVICT;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_PUT;\n+import static io.quarkus.spring.cache.SpringCacheUtil.getSpringCacheName;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.MethodInfo;\n+\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.cache.deployment.CacheDeploymentConstants;\n+import io.quarkus.cache.runtime.CacheInvalidateAllInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheInvalidateInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheResultInterceptorBinding;\n+\n+public class SpringCacheAnnotationsTransformer implements AnnotationsTransformer {\n+\n+    private static final DotName CACHE_RESULT_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheResultInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateAllInterceptorBinding.class.getName());\n+\n+    @Override\n+    public boolean appliesTo(AnnotationTarget.Kind kind) {\n+        return kind == AnnotationTarget.Kind.METHOD;\n+    }\n+\n+    @Override\n+    public void transform(TransformationContext transformationContext) {\n+        AnnotationTarget target = transformationContext.getTarget();\n+        if (target.kind() != AnnotationTarget.Kind.METHOD) {\n+            return;\n+        }\n+        MethodInfo methodInfo = target.asMethod();\n+        if (methodInfo.hasAnnotation(CACHEABLE)) {\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);\n+            String cacheName = getSpringCacheName(cacheResult);\n+            if ((cacheName != null) && !cacheName.isEmpty()) {\n+                transformationContext.transform().add(CACHE_RESULT_INTERCEPTOR_BINDING,\n+                        AnnotationValue.createStringValue(CacheDeploymentConstants.CACHE_NAME_PARAM, cacheName)).done();\n+            }\n+        } else if (methodInfo.hasAnnotation(CACHE_EVICT)) {\n+            AnnotationInstance cacheEvict = methodInfo.annotation(CACHE_EVICT);\n+            String cacheName = getSpringCacheName(cacheEvict);\n+            if ((cacheName == null) || cacheName.isEmpty()) {\n+                return;\n+            }\n+            AnnotationValue allEntriesValue = cacheEvict.value(\"allEntries\");\n+            boolean allEntries = false;\n+            if (allEntriesValue != null) {\n+                allEntries = allEntriesValue.asBoolean();\n+            }\n+            transformationContext.transform()\n+                    .add(allEntries ? CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING\n+                            : CACHE_INVALIDATE_INTERCEPTOR_BINDING,\n+                            AnnotationValue.createStringValue(CacheDeploymentConstants.CACHE_NAME_PARAM, cacheName))\n+                    .done();\n+        } else if (methodInfo.hasAnnotation(CACHE_PUT)) {\n+            /*\n+             * @CachePut is just an operation that overrides the cache entry with the new result so it is\n+             * equivalent of first invalidating the cache entry and then adding the new result\n+             */\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHE_PUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNTIwNA==", "bodyText": "Out of curiosity, will key be supported in the future?", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419005204", "createdAt": "2020-05-02T20:39:03Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n+    private static final Set<String> CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES = Collections\n+            .unmodifiableSet(new HashSet<>(Arrays.asList(\"key\", \"keyGenerator\", \"cacheManager\", \"cacheResolver\", \"condition\",\n+                    \"unless\", \"sync\", \"beforeInvocation\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNTgyMQ==", "bodyText": "Is it OK to silently ignore at build time a @Cacheable annotation because of the absence of cache name?\nSame question for the other cases below.", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419005821", "createdAt": "2020-05-02T20:44:51Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheAnnotationsTransformer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHEABLE;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_EVICT;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_PUT;\n+import static io.quarkus.spring.cache.SpringCacheUtil.getSpringCacheName;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.MethodInfo;\n+\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.cache.deployment.CacheDeploymentConstants;\n+import io.quarkus.cache.runtime.CacheInvalidateAllInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheInvalidateInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheResultInterceptorBinding;\n+\n+public class SpringCacheAnnotationsTransformer implements AnnotationsTransformer {\n+\n+    private static final DotName CACHE_RESULT_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheResultInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateAllInterceptorBinding.class.getName());\n+\n+    @Override\n+    public boolean appliesTo(AnnotationTarget.Kind kind) {\n+        return kind == AnnotationTarget.Kind.METHOD;\n+    }\n+\n+    @Override\n+    public void transform(TransformationContext transformationContext) {\n+        AnnotationTarget target = transformationContext.getTarget();\n+        if (target.kind() != AnnotationTarget.Kind.METHOD) {\n+            return;\n+        }\n+        MethodInfo methodInfo = target.asMethod();\n+        if (methodInfo.hasAnnotation(CACHEABLE)) {\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);\n+            String cacheName = getSpringCacheName(cacheResult);\n+            if ((cacheName != null) && !cacheName.isEmpty()) {\n+                transformationContext.transform().add(CACHE_RESULT_INTERCEPTOR_BINDING,\n+                        AnnotationValue.createStringValue(CacheDeploymentConstants.CACHE_NAME_PARAM, cacheName)).done();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNjE2Ng==", "bodyText": "The code would be easier to read if this test was like the other ones :)\nEdit: See this comment first.", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419006166", "createdAt": "2020-05-02T20:48:33Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheAnnotationsTransformer.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHEABLE;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_EVICT;\n+import static io.quarkus.spring.cache.SpringCacheProcessor.CACHE_PUT;\n+import static io.quarkus.spring.cache.SpringCacheUtil.getSpringCacheName;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.MethodInfo;\n+\n+import io.quarkus.arc.processor.AnnotationsTransformer;\n+import io.quarkus.cache.deployment.CacheDeploymentConstants;\n+import io.quarkus.cache.runtime.CacheInvalidateAllInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheInvalidateInterceptorBinding;\n+import io.quarkus.cache.runtime.CacheResultInterceptorBinding;\n+\n+public class SpringCacheAnnotationsTransformer implements AnnotationsTransformer {\n+\n+    private static final DotName CACHE_RESULT_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheResultInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateInterceptorBinding.class.getName());\n+    private static final DotName CACHE_INVALIDATE_ALL_INTERCEPTOR_BINDING = DotName\n+            .createSimple(CacheInvalidateAllInterceptorBinding.class.getName());\n+\n+    @Override\n+    public boolean appliesTo(AnnotationTarget.Kind kind) {\n+        return kind == AnnotationTarget.Kind.METHOD;\n+    }\n+\n+    @Override\n+    public void transform(TransformationContext transformationContext) {\n+        AnnotationTarget target = transformationContext.getTarget();\n+        if (target.kind() != AnnotationTarget.Kind.METHOD) {\n+            return;\n+        }\n+        MethodInfo methodInfo = target.asMethod();\n+        if (methodInfo.hasAnnotation(CACHEABLE)) {\n+            AnnotationInstance cacheResult = methodInfo.annotation(CACHEABLE);\n+            String cacheName = getSpringCacheName(cacheResult);\n+            if ((cacheName != null) && !cacheName.isEmpty()) {\n+                transformationContext.transform().add(CACHE_RESULT_INTERCEPTOR_BINDING,\n+                        AnnotationValue.createStringValue(CacheDeploymentConstants.CACHE_NAME_PARAM, cacheName)).done();\n+            }\n+        } else if (methodInfo.hasAnnotation(CACHE_EVICT)) {\n+            AnnotationInstance cacheEvict = methodInfo.annotation(CACHE_EVICT);\n+            String cacheName = getSpringCacheName(cacheEvict);\n+            if ((cacheName == null) || cacheName.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNjM3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CLOUD_CONFIG_CLIENT));\n          \n          \n            \n                    feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CACHE));", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419006374", "createdAt": "2020-05-02T20:50:20Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n+    private static final Set<String> CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES = Collections\n+            .unmodifiableSet(new HashSet<>(Arrays.asList(\"key\", \"keyGenerator\", \"cacheManager\", \"cacheResolver\", \"condition\",\n+                    \"unless\", \"sync\", \"beforeInvocation\")));\n+\n+    @BuildStep\n+    void feature(BuildProducer<FeatureBuildItem> feature) {\n+        feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CLOUD_CONFIG_CLIENT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNjUzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                + String.join(\",\", unsupportedValues));\n          \n          \n            \n                                + String.join(\", \", unsupportedValues));", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419006536", "createdAt": "2020-05-02T20:51:54Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n+    private static final Set<String> CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES = Collections\n+            .unmodifiableSet(new HashSet<>(Arrays.asList(\"key\", \"keyGenerator\", \"cacheManager\", \"cacheResolver\", \"condition\",\n+                    \"unless\", \"sync\", \"beforeInvocation\")));\n+\n+    @BuildStep\n+    void feature(BuildProducer<FeatureBuildItem> feature) {\n+        feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CLOUD_CONFIG_CLIENT));\n+    }\n+\n+    @BuildStep\n+    AnnotationsTransformerBuildItem transform() {\n+        return new AnnotationsTransformerBuildItem(new SpringCacheAnnotationsTransformer());\n+    }\n+\n+    @BuildStep\n+    List<AdditionalCacheNameBuildItem> cacheNames(CombinedIndexBuildItem combinedIndex) {\n+        Set<String> cacheNames = new HashSet<>();\n+        for (DotName cacheAnnotation : CACHE_ANNOTATIONS) {\n+            Collection<AnnotationInstance> instances = combinedIndex.getIndex().getAnnotations(cacheAnnotation);\n+            for (AnnotationInstance instance : instances) {\n+                validateUsage(instance);\n+                String cacheName = getSpringCacheName(instance);\n+                if ((cacheName != null) && !cacheName.isEmpty()) {\n+                    cacheNames.add(cacheName);\n+                }\n+            }\n+        }\n+        List<AdditionalCacheNameBuildItem> result = new ArrayList<>(cacheNames.size());\n+        for (String cacheName : cacheNames) {\n+            result.add(new AdditionalCacheNameBuildItem(cacheName));\n+        }\n+        return result;\n+    }\n+\n+    private void validateUsage(AnnotationInstance instance) {\n+        if (instance.target().kind() != AnnotationTarget.Kind.METHOD) {\n+            throw new IllegalArgumentException(\n+                    \"Currently Spring Caching annotations can only be added to methods. Offending instance is annotation '\"\n+                            + instance + \"' on \" + instance.target() + \"'\");\n+        }\n+        List<AnnotationValue> values = instance.values();\n+        List<String> unsupportedValues = new ArrayList<>();\n+        for (AnnotationValue value : values) {\n+            if (CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES.contains(value.name())) {\n+                unsupportedValues.add(value.name());\n+            }\n+        }\n+        if (!unsupportedValues.isEmpty()) {\n+            throw new IllegalArgumentException(\"Annotation '\" +\n+                    instance + \"' on '\" + instance.target()\n+                    + \"' contains the following currently unsupported annotation values: \"\n+                    + String.join(\",\", unsupportedValues));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTAwNzA2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static String getSpringCacheName(AnnotationInstance annotationInstance) {\n          \n          \n            \n                static Optional<String> getSpringCacheName(AnnotationInstance annotationInstance) {\n          \n      \n    \n    \n  \n\nReturning an Optional here that would be empty when cacheName == null || cacheName.isEmpty() could help reducing the number of tests conditions in SpringCacheAnnotationsTransformer.", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419007062", "createdAt": "2020-05-02T20:56:42Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheUtil.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.spring.cache;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+\n+final class SpringCacheUtil {\n+\n+    private SpringCacheUtil() {\n+    }\n+\n+    /**\n+     * Meant to be called for instances of {@code @Cacheable}, {@code @CacheEvict} or {@code @CachePut}\n+     * Returns the single name of the cache to use\n+     */\n+    static String getSpringCacheName(AnnotationInstance annotationInstance) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8fd2c9aa5ccd3bb7c2fd06ef5b067fe50111889"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "409268cfbfb089f432e14fdc18d11f10a8f06e0b", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/409268cfbfb089f432e14fdc18d11f10a8f06e0b", "committedDate": "2020-05-02T21:58:37Z", "message": "Update extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>"}, "afterCommit": {"oid": "0f8a9aec176aa5066dbbd9ed309aa6a734da0b58", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/0f8a9aec176aa5066dbbd9ed309aa6a734da0b58", "committedDate": "2020-05-03T08:48:54Z", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjU2Nzc5", "url": "https://github.com/quarkusio/quarkus/pull/8779#pullrequestreview-404656779", "createdAt": "2020-05-03T20:57:46Z", "commit": {"oid": "0f8a9aec176aa5066dbbd9ed309aa6a734da0b58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QyMDo1Nzo0N1rOGPvchA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QyMDo1Nzo0N1rOGPvchA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1OTE3Mg==", "bodyText": "You had an empty string check before, it is gone on purpose?\nI expected return cacheName == null || cacheName.isEmpty() ? Optional.empty() : Optional.of(cacheName); here.", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r419159172", "createdAt": "2020-05-03T20:57:47Z", "author": {"login": "gwenneg"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheUtil.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package io.quarkus.spring.cache;\n+\n+import java.util.Optional;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+\n+final class SpringCacheUtil {\n+\n+    private SpringCacheUtil() {\n+    }\n+\n+    /**\n+     * Meant to be called for instances of {@code @Cacheable}, {@code @CacheEvict} or {@code @CachePut}\n+     * Returns the single name of the cache to use\n+     */\n+    static Optional<String> getSpringCacheName(AnnotationInstance annotationInstance) {\n+        String cacheName = null;\n+        AnnotationValue cacheNameValue = annotationInstance.value(\"cacheNames\");\n+        if (cacheNameValue != null) {\n+            cacheName = singleName(cacheNameValue, annotationInstance.target());\n+        }\n+        if (cacheName == null || cacheName.isEmpty()) {\n+            AnnotationValue value = annotationInstance.value();\n+            if (value != null) {\n+                cacheName = singleName(value, annotationInstance.target());\n+            }\n+        }\n+        return cacheName == null ? Optional.empty() : Optional.of(cacheName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f8a9aec176aa5066dbbd9ed309aa6a734da0b58"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f8a9aec176aa5066dbbd9ed309aa6a734da0b58", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/0f8a9aec176aa5066dbbd9ed309aa6a734da0b58", "committedDate": "2020-05-03T08:48:54Z", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>"}, "afterCommit": {"oid": "1c6d725e29087aba3b9104cf72f51a16b6897050", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/1c6d725e29087aba3b9104cf72f51a16b6897050", "committedDate": "2020-05-03T21:07:53Z", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NzkzNzA4", "url": "https://github.com/quarkusio/quarkus/pull/8779#pullrequestreview-408793708", "createdAt": "2020-05-10T23:40:25Z", "commit": {"oid": "1c6d725e29087aba3b9104cf72f51a16b6897050"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQyMzo0MDoyNVrOGTIpBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMFQyMzo0MDoyNVrOGTIpBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjcxNzcwMg==", "bodyText": "Isn't that risky to look for geo here while it could match both geo and george?", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r422717702", "createdAt": "2020-05-10T23:40:25Z", "author": {"login": "gwenneg"}, "path": "integration-tests/spring-web/src/test/java/io/quarkus/it/spring/web/SpringCacheControllerTest.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package io.quarkus.it.spring.web;\n+\n+import static org.hamcrest.Matchers.containsString;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.RestAssured;\n+\n+@QuarkusTest\n+public class SpringCacheControllerTest {\n+\n+    @Test\n+    public void testCache() {\n+        // first invocation\n+        RestAssured.when().get(\"/cache/greet/george\").then()\n+                .contentType(\"application/json\")\n+                .body(containsString(\"george\"), containsString(\"0\"));\n+\n+        // second invocation should yield same count\n+        RestAssured.when().get(\"/cache/greet/george\").then()\n+                .contentType(\"application/json\")\n+                .body(containsString(\"george\"), containsString(\"0\"));\n+\n+        // invocation with different key should yield different count\n+        RestAssured.when().get(\"/cache/greet/geo\").then()\n+                .contentType(\"application/json\")\n+                .body(containsString(\"geo\"), containsString(\"1\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c6d725e29087aba3b9104cf72f51a16b6897050"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c6d725e29087aba3b9104cf72f51a16b6897050", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/1c6d725e29087aba3b9104cf72f51a16b6897050", "committedDate": "2020-05-03T21:07:53Z", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>"}, "afterCommit": {"oid": "20747241ffcfb204a09b76b9d981ed9e2e98eea8", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/20747241ffcfb204a09b76b9d981ed9e2e98eea8", "committedDate": "2020-05-11T04:35:38Z", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTczMjA4", "url": "https://github.com/quarkusio/quarkus/pull/8779#pullrequestreview-408973208", "createdAt": "2020-05-11T08:40:47Z", "commit": {"oid": "20747241ffcfb204a09b76b9d981ed9e2e98eea8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20747241ffcfb204a09b76b9d981ed9e2e98eea8", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/20747241ffcfb204a09b76b9d981ed9e2e98eea8", "committedDate": "2020-05-11T04:35:38Z", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>"}, "afterCommit": {"oid": "eddcbea2900569941fc1610526f97a927b7420cc", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/eddcbea2900569941fc1610526f97a927b7420cc", "committedDate": "2020-05-11T17:32:46Z", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5ODE3MDQw", "url": "https://github.com/quarkusio/quarkus/pull/8779#pullrequestreview-409817040", "createdAt": "2020-05-12T08:31:56Z", "commit": {"oid": "eddcbea2900569941fc1610526f97a927b7420cc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwODozMTo1NlrOGT75Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwODozNDoyOVrOGT7_CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1NzQwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n          \n          \n            \n                // some of these restrictions can probably be lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423557407", "createdAt": "2020-05-12T08:31:56Z", "author": {"login": "gsmet"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eddcbea2900569941fc1610526f97a927b7420cc"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1NzcyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"Currently Spring Caching annotations can only be added to methods. Offending instance is annotation '\"\n          \n          \n            \n                                \"Currently Spring Cache annotations can only be added to methods. Offending instance is annotation '\"", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423557723", "createdAt": "2020-05-12T08:32:30Z", "author": {"login": "gsmet"}, "path": "extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java", "diffHunk": "@@ -0,0 +1,94 @@\n+package io.quarkus.spring.cache;\n+\n+import static io.quarkus.spring.cache.SpringCacheUtil.*;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import org.jboss.jandex.AnnotationInstance;\n+import org.jboss.jandex.AnnotationTarget;\n+import org.jboss.jandex.AnnotationValue;\n+import org.jboss.jandex.DotName;\n+import org.springframework.cache.annotation.CacheEvict;\n+import org.springframework.cache.annotation.CachePut;\n+import org.springframework.cache.annotation.Cacheable;\n+\n+import io.quarkus.arc.deployment.AnnotationsTransformerBuildItem;\n+import io.quarkus.cache.deployment.AdditionalCacheNameBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n+import io.quarkus.deployment.builditem.FeatureBuildItem;\n+\n+public class SpringCacheProcessor {\n+\n+    static final DotName CACHEABLE = DotName.createSimple(Cacheable.class.getName());\n+    static final DotName CACHE_PUT = DotName.createSimple(CachePut.class.getName());\n+    static final DotName CACHE_EVICT = DotName.createSimple(CacheEvict.class.getName());\n+\n+    private static final List<DotName> CACHE_ANNOTATIONS = Collections\n+            .unmodifiableList(Arrays.asList(CACHEABLE, CACHE_PUT, CACHE_EVICT));\n+\n+    // some of these restrictions can probably lifted by us doing additional work on caching after https://github.com/quarkusio/quarkus/pull/8631 lands\n+    private static final Set<String> CURRENTLY_UNSUPPORTED_ANNOTATION_VALUES = Collections\n+            .unmodifiableSet(new HashSet<>(Arrays.asList(\"key\", \"keyGenerator\", \"cacheManager\", \"cacheResolver\", \"condition\",\n+                    \"unless\", \"sync\", \"beforeInvocation\")));\n+\n+    @BuildStep\n+    void feature(BuildProducer<FeatureBuildItem> feature) {\n+        feature.produce(new FeatureBuildItem(FeatureBuildItem.SPRING_CACHE));\n+    }\n+\n+    @BuildStep\n+    AnnotationsTransformerBuildItem transform() {\n+        return new AnnotationsTransformerBuildItem(new SpringCacheAnnotationsTransformer());\n+    }\n+\n+    @BuildStep\n+    List<AdditionalCacheNameBuildItem> cacheNames(CombinedIndexBuildItem combinedIndex) {\n+        Set<String> cacheNames = new HashSet<>();\n+        for (DotName cacheAnnotation : CACHE_ANNOTATIONS) {\n+            Collection<AnnotationInstance> instances = combinedIndex.getIndex().getAnnotations(cacheAnnotation);\n+            for (AnnotationInstance instance : instances) {\n+                validateUsage(instance);\n+                Optional<String> cacheName = getSpringCacheName(instance);\n+                if (cacheName.isPresent()) {\n+                    cacheNames.add(cacheName.get());\n+                }\n+            }\n+        }\n+        List<AdditionalCacheNameBuildItem> result = new ArrayList<>(cacheNames.size());\n+        for (String cacheName : cacheNames) {\n+            result.add(new AdditionalCacheNameBuildItem(cacheName));\n+        }\n+        return result;\n+    }\n+\n+    private void validateUsage(AnnotationInstance instance) {\n+        if (instance.target().kind() != AnnotationTarget.Kind.METHOD) {\n+            throw new IllegalArgumentException(\n+                    \"Currently Spring Caching annotations can only be added to methods. Offending instance is annotation '\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eddcbea2900569941fc1610526f97a927b7420cc"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1ODQxMw==", "bodyText": "Not consistent with the deployment name Spring - Cache. Let's try to be consistent with the other Spring extensions whatever they use.", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423558413", "createdAt": "2020-05-12T08:33:36Z", "author": {"login": "gsmet"}, "path": "extensions/spring-cache/pom.xml", "diffHunk": "@@ -0,0 +1,21 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>quarkus-build-parent</artifactId>\n+        <groupId>io.quarkus</groupId>\n+        <version>999-SNAPSHOT</version>\n+        <relativePath>../../build-parent/pom.xml</relativePath>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>quarkus-spring-cache-parent</artifactId>\n+    <name>Quarkus - Spring Cache</name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eddcbea2900569941fc1610526f97a927b7420cc"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1ODUzMw==", "bodyText": "Not consistent with the deployment name Spring - Cache.", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423558533", "createdAt": "2020-05-12T08:33:49Z", "author": {"login": "gsmet"}, "path": "extensions/spring-cache/runtime/pom.xml", "diffHunk": "@@ -0,0 +1,63 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <parent>\n+        <artifactId>quarkus-spring-cache-parent</artifactId>\n+        <groupId>io.quarkus</groupId>\n+        <version>999-SNAPSHOT</version>\n+    </parent>\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>quarkus-spring-cache</artifactId>\n+    <name>Quarkus - Spring Cache - Runtime</name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eddcbea2900569941fc1610526f97a927b7420cc"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzU1ODkyMA==", "bodyText": "Maybe add cache?", "url": "https://github.com/quarkusio/quarkus/pull/8779#discussion_r423558920", "createdAt": "2020-05-12T08:34:29Z", "author": {"login": "gsmet"}, "path": "extensions/spring-cache/runtime/src/main/resources/META-INF/quarkus-extension.yaml", "diffHunk": "@@ -0,0 +1,10 @@\n+---\n+name: \"Quarkus Extension for Spring Cache API\"\n+metadata:\n+  keywords:\n+  - \"spring-cache\"\n+  - \"spring\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eddcbea2900569941fc1610526f97a927b7420cc"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "778ff5196edbfff83faf6eaf926e05c2f0030d6d", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/778ff5196edbfff83faf6eaf926e05c2f0030d6d", "committedDate": "2020-05-12T08:38:55Z", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1c10008a5948e939cede79850e6df50f00a1495", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/f1c10008a5948e939cede79850e6df50f00a1495", "committedDate": "2020-05-12T08:36:08Z", "message": "Update extensions/spring-cache/deployment/src/main/java/io/quarkus/spring/cache/SpringCacheProcessor.java\n\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>"}, "afterCommit": {"oid": "778ff5196edbfff83faf6eaf926e05c2f0030d6d", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/778ff5196edbfff83faf6eaf926e05c2f0030d6d", "committedDate": "2020-05-12T08:38:55Z", "message": "Add first version of Spring Cache annotations\n\nCo-authored-by: Gwenneg Lepage <gwenneg@users.noreply.github.com>\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5ODc0MDU4", "url": "https://github.com/quarkusio/quarkus/pull/8779#pullrequestreview-409874058", "createdAt": "2020-05-12T09:42:27Z", "commit": {"oid": "778ff5196edbfff83faf6eaf926e05c2f0030d6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4494, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}