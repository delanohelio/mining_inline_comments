{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMzIzOTYw", "number": 8006, "title": "Authentication fixes", "bodyText": "Use synthetic beans to configure form and basic auth\nAllow multiple authentication mechanisms\nBetter default behaviour based on what is configured\n\nAlso includes synthetic bean fixes from @mkouba\nFixes #7768\nFixes #5284\nFixes #8138", "createdAt": "2020-03-20T02:42:20Z", "url": "https://github.com/quarkusio/quarkus/pull/8006", "merged": true, "mergeCommit": {"oid": "cbd81cfc6b91103b029e6a331d8c77af9b2af4b3"}, "closed": true, "closedAt": "2020-03-26T11:11:07Z", "author": {"login": "stuartwdouglas"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPXqunABqjMxNDc5MTY5NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRZaCuAFqTM4MTg2OTIxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "244ca3d5c5115f46cad353cb39b734ec076bc63b", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/244ca3d5c5115f46cad353cb39b734ec076bc63b", "committedDate": "2020-03-20T02:41:15Z", "message": "Multiple authentication fixes\n\n- Use synthetic beans to configure form and basic auth\n- Allow multiple authentication mechanisms\n- Better default behaviour based on what is configured\n\nFixes #7768\nFixes #5284"}, "afterCommit": {"oid": "5ccd864277ca0de1d8e3bfa5e16cc065d3f22267", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/5ccd864277ca0de1d8e3bfa5e16cc065d3f22267", "committedDate": "2020-03-20T03:09:08Z", "message": "Multiple authentication fixes\n\n- Use synthetic beans to configure form and basic auth\n- Allow multiple authentication mechanisms\n- Better default behaviour based on what is configured\n\nFixes #7768\nFixes #5284"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4OTMzNzc4", "url": "https://github.com/quarkusio/quarkus/pull/8006#pullrequestreview-378933778", "createdAt": "2020-03-21T17:03:59Z", "commit": {"oid": "5ccd864277ca0de1d8e3bfa5e16cc065d3f22267"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNzowMzo1OVrOF5qf3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNzowMzo1OVrOF5qf3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwOTQzNw==", "bodyText": "In case of those 3 extensions on the class path, can we get a case where quarkus-oidc will an identity provider with the other matching extensions ?\nIMHO for a given credential type only a single authentication mechanism should be supported. So if the users add all 3 of those extensions plus some custom one for the same credential type then only one is selected which means they will need to choose what exactly is needed by adding only one of these extensions :-)", "url": "https://github.com/quarkusio/quarkus/pull/8006#discussion_r396009437", "createdAt": "2020-03-21T17:03:59Z", "author": {"login": "sberyozkin"}, "path": "extensions/vertx-http/runtime/src/main/java/io/quarkus/vertx/http/runtime/security/HttpAuthenticator.java", "diffHunk": "@@ -24,33 +29,40 @@\n     @Inject\n     IdentityProviderManager identityProviderManager;\n \n-    final HttpAuthenticationMechanism mechanism;\n+    final HttpAuthenticationMechanism[] mechanisms;\n \n     public HttpAuthenticator() {\n-        mechanism = null;\n+        mechanisms = null;\n     }\n \n     @Inject\n     public HttpAuthenticator(Instance<HttpAuthenticationMechanism> instance,\n-            Instance<IdentityProvider<UsernamePasswordAuthenticationRequest>> usernamePassword) {\n-        if (instance.isResolvable()) {\n-            if (instance.isAmbiguous()) {\n-                throw new IllegalStateException(\"Multiple HTTP authentication mechanisms are not implemented yet, discovered \"\n-                        + instance.stream().collect(Collectors.toList()));\n+            Instance<IdentityProvider<?>> providers) {\n+        List<HttpAuthenticationMechanism> mechanisms = new ArrayList<>();\n+        for (HttpAuthenticationMechanism mechanism : instance) {\n+            boolean notFound = false;\n+            for (Class<? extends AuthenticationRequest> mechType : mechanism.getCredentialTypes()) {\n+                boolean found = false;\n+                for (IdentityProvider<?> i : providers) {\n+                    if (i.getRequestType().equals(mechType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ccd864277ca0de1d8e3bfa5e16cc065d3f22267"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4c3c381fbc189d0c9edb2502128dc58b60011fb", "author": {"user": {"login": "mkouba", "name": "Martin Kouba"}}, "url": "https://github.com/quarkusio/quarkus/commit/f4c3c381fbc189d0c9edb2502128dc58b60011fb", "committedDate": "2020-03-25T23:47:33Z", "message": "Make it possible to initialize a synthetic bean during RUNTIME_INIT\n\n- follows up on https://github.com/quarkusio/quarkus/pull/5938"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53b3b483a1ac127a39e5563d8275818e0b5554fd", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/53b3b483a1ac127a39e5563d8275818e0b5554fd", "committedDate": "2020-03-26T00:19:50Z", "message": "Multiple authentication fixes\n\n- Use synthetic beans to configure form and basic auth\n- Allow multiple authentication mechanisms\n- Better default behaviour based on what is configured\n\nFixes #7768\nFixes #5284"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ccd864277ca0de1d8e3bfa5e16cc065d3f22267", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/5ccd864277ca0de1d8e3bfa5e16cc065d3f22267", "committedDate": "2020-03-20T03:09:08Z", "message": "Multiple authentication fixes\n\n- Use synthetic beans to configure form and basic auth\n- Allow multiple authentication mechanisms\n- Better default behaviour based on what is configured\n\nFixes #7768\nFixes #5284"}, "afterCommit": {"oid": "53b3b483a1ac127a39e5563d8275818e0b5554fd", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/53b3b483a1ac127a39e5563d8275818e0b5554fd", "committedDate": "2020-03-26T00:19:50Z", "message": "Multiple authentication fixes\n\n- Use synthetic beans to configure form and basic auth\n- Allow multiple authentication mechanisms\n- Better default behaviour based on what is configured\n\nFixes #7768\nFixes #5284"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxODY1ODk4", "url": "https://github.com/quarkusio/quarkus/pull/8006#pullrequestreview-381865898", "createdAt": "2020-03-26T10:14:31Z", "commit": {"oid": "53b3b483a1ac127a39e5563d8275818e0b5554fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxNDozMlrOF7_3Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxNDozMlrOF7_3Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NjU4Mg==", "bodyText": "That is fine, we can support bearer,code-flow in the future when a given mechanism supports different types", "url": "https://github.com/quarkusio/quarkus/pull/8006#discussion_r398456582", "createdAt": "2020-03-26T10:14:32Z", "author": {"login": "sberyozkin"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcAuthenticationMechanism.java", "diffHunk": "@@ -41,4 +46,15 @@ private boolean isWebApp(RoutingContext context) {\n         return OidcTenantConfig.ApplicationType.WEB_APP == tenantContext.oidcConfig.applicationType;\n     }\n \n+    @Override\n+    public Set<Class<? extends AuthenticationRequest>> getCredentialTypes() {\n+        return Collections.singleton(TokenAuthenticationRequest.class);\n+    }\n+\n+    @Override\n+    public HttpCredentialTransport getCredentialTransport() {\n+        //not 100% correct, but enough for now\n+        //if OIDC is present we don't really want another bearer mechanism\n+        return new HttpCredentialTransport(HttpCredentialTransport.Type.AUTHORIZATION, \"bearer\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53b3b483a1ac127a39e5563d8275818e0b5554fd"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxODY5MjE4", "url": "https://github.com/quarkusio/quarkus/pull/8006#pullrequestreview-381869218", "createdAt": "2020-03-26T10:18:52Z", "commit": {"oid": "53b3b483a1ac127a39e5563d8275818e0b5554fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3756, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}