{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NDM2Nzc0", "number": 8261, "title": "Amazon Alexa extension for Quarkus Native integration with AWS Lambda", "bodyText": "Summary:\nIntroduce a new extension, to assist the native image compilation of Amazon Alexa AWS Lambda functions.  Alexa can also be hosted by any HTTPS endpoint.\nThe Amazon Alexa ASK Java SDK v2 uses the RequestStreamHandler interface, via subclassing the SkillStreamHandler classes.  With the merge of commits to enable Amazon Alexa to be integrated with Quarkus, the remaining piece was support for Quarkus native.\nCommits that added the functionality required for Alexa were #7866, #7985 and documentation #7927\nThe AWS ASK SDK v2 uses a builder pattern for the Jackson deserialisation, which needs to be added as reflective classes to the native build.  I've created a simple scanner to do this dynamically via identifying all classes annotated with JsonDeserialize.class. As common with all AWS clients, a dynamic proxy is required also.  It is quite tedious to do all this manually if a Quarkus extension was not used.\nFYI, I'll update documentation in a subsequent PR if this one is accepted.\nTested by:\nInstall new extension:\n\ngit clone -b ext/alexa https://github.com/oztimpower/quarkus.git\ncd quarkus\ncd extensions/amazon-alexa\nmvn install\n\nAlexa Test Project:\n\ngit clone https://github.com/oztimpower/alexa-quarkus.git\ncd alexa-quarkus\nmvn -Pnative package -Dquarkus.native.container-build=true\n\nThe output of the native image will show the number of classes included for build time.\nPrinting 20792 classes of type BUILD_TIME to /project/reports/build_time_classes_20200330_052538.txt \n\nsam local invoke --template sam.native.yaml --event payload.json\n\nA positive outcome is expected, where Quarkus Native is able to produce a valid response to the Lambda test payload.json.\nEND RequestId: d9815e18-3c7c-1881-120e-af6ebed0bb81\nREPORT RequestId: d9815e18-3c7c-1881-120e-af6ebed0bb81\tInit Duration: 235.37 ms\tDuration: 103.46 ms\tBilled Duration: 200 ms\tMemory Size: 256 MB\tMax Memory Used: 51 MB\t\n\n{\"version\":\"1.0\",\"userAgent\":\"ask-java/2.28.0 Java/11.0.6 templateResolver\",\"response\":{\"outputSpeech\":{\"type\":\"SSML\",\"ssml\":\"\\u003cspeak\\u003eHi \\u003calexa:name type=\\\"first\\\" personId=\\\"amzn1.ask.account.AA274FLEVWIWU6CTPZQ25XW6P7XGAJJ4YB7OPEFKULHJRUQDIO5AFS2UNPLBPG6BZKTGRTH6BDQZJ3SNAC6ELTPWT4DALVM5WZGC59JHXBZQRZ4V646JEF2EKO3DVMWW65E67NPBTLIGV4HUDK45JFAQWAY5C7OGWQNIOLWNS4M6WNLIMQWU5HUEHDXAT7QTONKHS7ILR2V5EOY\\\"/\\u003e\\u003c/speak\\u003e\"}}}\n\n\nNegative Test:\n\nComment out the new extension in the project POM\n\n<!--\n        <dependency>\n            <groupId>io.quarkus</groupId>\n            <artifactId>quarkus-amazon-alexa</artifactId>\n            <version>${quarkus.version}</version>\n        </dependency>\n-->\n\n\n\nRecompile\nmvn  -Pnative package -Dquarkus.native.container-build=true\n\nThe number of classes included at build time drops significantly.\nPrinting 11212 classes of type BUILD_TIME to /project/reports/build_time_classes_20200330_055547.txt \n\nsam local invoke --template sam.native.yaml --event payload.json\n\nCaused by: com.fasterxml.jackson.databind.exc.InvalidDefinitionException: Builder class com.amazon.ask.model.RequestEnvelope$Builder does not have build method (name: 'build')\n\nEND RequestId: 411c18ec-af00-1623-1ff3-795de76f32ed\nREPORT RequestId: 411c18ec-af00-1623-1ff3-795de76f32ed\tInit Duration: 143.56 ms\tDuration: 49.91 ms\tBilled Duration: 100 ms\tMemory Size: 256 MB\tMax Memory Used: 35 MB\t\n\n{\"errorType\":\"com.amazon.ask.exception.AskSdkException\",\"errorMessage\":\"Deserialization error\"}\n\n\n/cc @patriot1burke\n/cc @gsmet\n/cc @geoand", "createdAt": "2020-03-30T06:32:01Z", "url": "https://github.com/quarkusio/quarkus/pull/8261", "merged": true, "mergeCommit": {"oid": "77545eb73774533d9fe1c3313876703338fd0060"}, "closed": true, "closedAt": "2020-04-06T23:59:27Z", "author": {"login": "oztimpower"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSphAsgFqTM4MzU5ODA4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTSBpaAFqTM4NTMwNjIyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNTk4MDg3", "url": "https://github.com/quarkusio/quarkus/pull/8261#pullrequestreview-383598087", "createdAt": "2020-03-30T07:38:53Z", "commit": {"oid": "a7cd7a8d177edcc14eb44f99ab161132c2913225"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzozODo1M1rOF9dGdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzozODo1M1rOF9dGdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk4NDI0Nw==", "bodyText": "Can we try and use Jandex to do this?\nThat is pretty much what all the other extensions do.", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r399984247", "createdAt": "2020-03-30T07:38:53Z", "author": {"login": "geoand"}, "path": "extensions/amazon-lambda-alexa/deployment/src/main/java/io/quarkus/amazon/lambda/alexa/AlexaProcessor.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package io.quarkus.amazon.lambda.alexa;\n+\n+import java.util.Set;\n+\n+import org.reflections.Reflections;\n+\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.builditem.nativeimage.NativeImageProxyDefinitionBuildItem;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import io.quarkus.deployment.pkg.steps.NativeBuild;\n+\n+public class AlexaProcessor {\n+\n+    @BuildStep(onlyIf = NativeBuild.class)\n+    public void reflection(BuildProducer<ReflectiveClassBuildItem> reflectiveClass) {\n+\n+        Reflections reflections = new Reflections(\"com.amazon.ask\");\n+        Set<Class<?>> types = reflections.getTypesAnnotatedWith(JsonDeserialize.class);\n+\n+        types.forEach(type -> reflectiveClass\n+                .produce(new ReflectiveClassBuildItem(true, true, type.getName(), type.getName() + \"$Builder\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7cd7a8d177edcc14eb44f99ab161132c2913225"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjk3Njk2", "url": "https://github.com/quarkusio/quarkus/pull/8261#pullrequestreview-383697696", "createdAt": "2020-03-30T09:53:44Z", "commit": {"oid": "a7cd7a8d177edcc14eb44f99ab161132c2913225"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOTo1Mzo0NFrOF9iEUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOTo1Mzo0NFrOF9iEUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTYxOQ==", "bodyText": "Is it specific to Amazon Lambda or could be used to use Alexa in another context?", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400065619", "createdAt": "2020-03-30T09:53:44Z", "author": {"login": "gsmet"}, "path": "extensions/amazon-lambda-alexa/runtime/pom.xml", "diffHunk": "@@ -0,0 +1,57 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <parent>\n+        <groupId>io.quarkus</groupId>\n+        <artifactId>quarkus-amazon-lambda-alexa-parent</artifactId>\n+        <version>999-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+\n+    <artifactId>quarkus-amazon-lambda-alexa</artifactId>\n+    <name>Quarkus - Amazon Lambda Alexa - Runtime</name>\n+    <description>Write AWS Lambda functions for Amazon Alexa</description>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7cd7a8d177edcc14eb44f99ab161132c2913225"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjk3OTk1", "url": "https://github.com/quarkusio/quarkus/pull/8261#pullrequestreview-383697995", "createdAt": "2020-03-30T09:54:08Z", "commit": {"oid": "a7cd7a8d177edcc14eb44f99ab161132c2913225"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOTo1NDowOFrOF9iFbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOTo1NDowOFrOF9iFbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2NTkwMw==", "bodyText": "I'm surprised we don't have a dependency to some Alexa SDK?", "url": "https://github.com/quarkusio/quarkus/pull/8261#discussion_r400065903", "createdAt": "2020-03-30T09:54:08Z", "author": {"login": "gsmet"}, "path": "extensions/amazon-lambda-alexa/runtime/pom.xml", "diffHunk": "@@ -0,0 +1,57 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <parent>\n+        <groupId>io.quarkus</groupId>\n+        <artifactId>quarkus-amazon-lambda-alexa-parent</artifactId>\n+        <version>999-SNAPSHOT</version>\n+        <relativePath>../pom.xml</relativePath>\n+    </parent>\n+\n+    <artifactId>quarkus-amazon-lambda-alexa</artifactId>\n+    <name>Quarkus - Amazon Lambda Alexa - Runtime</name>\n+    <description>Write AWS Lambda functions for Amazon Alexa</description>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-amazon-lambda</artifactId>\n+        </dependency>\n+    </dependencies>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7cd7a8d177edcc14eb44f99ab161132c2913225"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7cd7a8d177edcc14eb44f99ab161132c2913225", "author": {"user": {"login": "oztimpower", "name": "Timothy Power"}}, "url": "https://github.com/quarkusio/quarkus/commit/a7cd7a8d177edcc14eb44f99ab161132c2913225", "committedDate": "2020-03-30T05:58:13Z", "message": "Working version scanning classpath for annotations"}, "afterCommit": {"oid": "1da256a4dfab0b4bf23bd02395070dc9e6b1d17f", "author": {"user": {"login": "oztimpower", "name": "Timothy Power"}}, "url": "https://github.com/quarkusio/quarkus/commit/1da256a4dfab0b4bf23bd02395070dc9e6b1d17f", "committedDate": "2020-03-31T06:53:22Z", "message": "Modify to use with Jandex\nRename to Amazon Alexa"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1da256a4dfab0b4bf23bd02395070dc9e6b1d17f", "author": {"user": {"login": "oztimpower", "name": "Timothy Power"}}, "url": "https://github.com/quarkusio/quarkus/commit/1da256a4dfab0b4bf23bd02395070dc9e6b1d17f", "committedDate": "2020-03-31T06:53:22Z", "message": "Modify to use with Jandex\nRename to Amazon Alexa"}, "afterCommit": {"oid": "f9553cfcc82054e0f8c1ef99981714be83d4e730", "author": {"user": {"login": "oztimpower", "name": "Timothy Power"}}, "url": "https://github.com/quarkusio/quarkus/commit/f9553cfcc82054e0f8c1ef99981714be83d4e730", "committedDate": "2020-03-31T07:43:49Z", "message": "Modify to use with Jandex, Rename to Amazon Alexa"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a7dea439e45966da189c4261282c22837321771", "author": {"user": {"login": "oztimpower", "name": "Timothy Power"}}, "url": "https://github.com/quarkusio/quarkus/commit/1a7dea439e45966da189c4261282c22837321771", "committedDate": "2020-03-31T12:59:41Z", "message": "Modify to use with Jandex, Rename to Amazon Alexa"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9553cfcc82054e0f8c1ef99981714be83d4e730", "author": {"user": {"login": "oztimpower", "name": "Timothy Power"}}, "url": "https://github.com/quarkusio/quarkus/commit/f9553cfcc82054e0f8c1ef99981714be83d4e730", "committedDate": "2020-03-31T07:43:49Z", "message": "Modify to use with Jandex, Rename to Amazon Alexa"}, "afterCommit": {"oid": "1a7dea439e45966da189c4261282c22837321771", "author": {"user": {"login": "oztimpower", "name": "Timothy Power"}}, "url": "https://github.com/quarkusio/quarkus/commit/1a7dea439e45966da189c4261282c22837321771", "committedDate": "2020-03-31T12:59:41Z", "message": "Modify to use with Jandex, Rename to Amazon Alexa"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzA2MjI2", "url": "https://github.com/quarkusio/quarkus/pull/8261#pullrequestreview-385306226", "createdAt": "2020-04-01T06:50:44Z", "commit": {"oid": "1a7dea439e45966da189c4261282c22837321771"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4806, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}