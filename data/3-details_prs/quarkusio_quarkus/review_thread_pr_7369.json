{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NzUwNzQ3", "number": 7369, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QyMToxMjozNlrODiLdRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0NzowM1rODiO2Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MTY1ODkyOnYy", "diffSide": "RIGHT", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QyMToxMjozNlrOFtS1qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QyMToxMjozNlrOFtS1qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAzODg5MA==", "bodyText": "I think we shouldn't use the backquotes here and just use regular ones", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383038890", "createdAt": "2020-02-23T21:12:36Z", "author": {"login": "geoand"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,9 +242,24 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build = null;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the `oc` binary.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60c2eb54335c7ddb7662f000fa5e267f081cc74e"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjIxMDM5OnYy", "diffSide": "RIGHT", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0NToxOFrOFtXjpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0NzozNFrOFtXmRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjE5OQ==", "bodyText": "Are we only using binary s2i? For \"code\" s2i, 5 minutes won't be enough.", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383116199", "createdAt": "2020-02-24T07:45:18Z", "author": {"login": "cescoffier"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iConfig.java", "diffHunk": "@@ -50,6 +51,12 @@\n     @ConfigItem(defaultValue = \"/home/quarkus/application\")\n     public String nativeBinaryPath;\n \n+    /**\n+     * The build timeout.\n+     */\n+    @ConfigItem(defaultValue = \"PT5M\")\n+    Duration buildTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjg3MA==", "bodyText": "Only binary at this point", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383116870", "createdAt": "2020-02-24T07:47:34Z", "author": {"login": "geoand"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iConfig.java", "diffHunk": "@@ -50,6 +51,12 @@\n     @ConfigItem(defaultValue = \"/home/quarkus/application\")\n     public String nativeBinaryPath;\n \n+    /**\n+     * The build timeout.\n+     */\n+    @ConfigItem(defaultValue = \"PT5M\")\n+    Duration buildTimeout;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjE5OQ=="}, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjIxMTQyOnYy", "diffSide": "RIGHT", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0NTo0OVrOFtXkQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo1MTo0MVrOFtXqnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjM1NQ==", "bodyText": "use a logger instead?", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383116355", "createdAt": "2020-02-24T07:45:49Z", "author": {"login": "cescoffier"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,16 +242,31 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the 'oc' binary.\");\n+                if (!ExecUtil.exec(\"oc\", \"start-build\", buildConfig.getMetadata().getName(), \"--from-archive\",\n+                        binaryFile.toPath().toAbsolutePath().toString())) {\n+                    throw s2iException(e);\n+                }\n+                return;\n+            } else {\n+                throw s2iException(e);\n+            }\n+        }\n+\n         try (BufferedReader reader = new BufferedReader(\n                 client.builds().withName(build.getMetadata().getName()).getLogReader())) {\n             for (String line = reader.readLine(); line != null; line = reader.readLine()) {\n                 System.out.println(line);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNzk4MA==", "bodyText": "\ud83d\udc4d , fixed", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383117980", "createdAt": "2020-02-24T07:51:41Z", "author": {"login": "geoand"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,16 +242,31 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the 'oc' binary.\");\n+                if (!ExecUtil.exec(\"oc\", \"start-build\", buildConfig.getMetadata().getName(), \"--from-archive\",\n+                        binaryFile.toPath().toAbsolutePath().toString())) {\n+                    throw s2iException(e);\n+                }\n+                return;\n+            } else {\n+                throw s2iException(e);\n+            }\n+        }\n+\n         try (BufferedReader reader = new BufferedReader(\n                 client.builds().withName(build.getMetadata().getName()).getLogReader())) {\n             for (String line = reader.readLine(); line != null; line = reader.readLine()) {\n                 System.out.println(line);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjM1NQ=="}, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjIxNDEwOnYy", "diffSide": "RIGHT", "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo0NzowM1rOFtXlwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNzo1Nzo0MVrOFtXxYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjczNw==", "bodyText": "Wondering if at some point we should get the oc client from the OpenShift instance. We had incompatibilities in the past and it would avoid having the user install oc.", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383116737", "createdAt": "2020-02-24T07:47:03Z", "author": {"login": "cescoffier"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,16 +242,31 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the 'oc' binary.\");\n+                if (!ExecUtil.exec(\"oc\", \"start-build\", buildConfig.getMetadata().getName(), \"--from-archive\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNzE0Mg==", "bodyText": "This is only a fallback that @iocanel added because he saw the client failing is some weird circumstances. I'll leave it up to him to decide", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383117142", "createdAt": "2020-02-24T07:48:34Z", "author": {"login": "geoand"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,16 +242,31 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the 'oc' binary.\");\n+                if (!ExecUtil.exec(\"oc\", \"start-build\", buildConfig.getMetadata().getName(), \"--from-archive\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjczNw=="}, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNzU0NA==", "bodyText": "Agree, I don't like the idea of having the user depend on any kind of binary. This is just a fallback mechanism to work around a known issue in the client.", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383117544", "createdAt": "2020-02-24T07:50:02Z", "author": {"login": "iocanel"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,16 +242,31 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the 'oc' binary.\");\n+                if (!ExecUtil.exec(\"oc\", \"start-build\", buildConfig.getMetadata().getName(), \"--from-archive\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjczNw=="}, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExOTcxNQ==", "bodyText": "Never tried to grab the binary from the instance, I will have a look.", "url": "https://github.com/quarkusio/quarkus/pull/7369#discussion_r383119715", "createdAt": "2020-02-24T07:57:41Z", "author": {"login": "iocanel"}, "path": "extensions/container-image/container-image-s2i/deployment/src/main/java/io/quarkus/container/image/s2i/deployment/S2iProcessor.java", "diffHunk": "@@ -227,16 +242,31 @@ private static void s2iBuild(KubernetesClient client, List<HasMetadata> buildRes\n      * @param buildConfig The build config.\n      * @param binaryFile The binary file.\n      */\n-    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile) {\n-        Build build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n-                .fromFile(binaryFile);\n+    private static void s2iBuild(OpenShiftClient client, BuildConfig buildConfig, File binaryFile, S2iConfig s2iConfig) {\n+        Build build;\n+        try {\n+            build = client.buildConfigs().withName(buildConfig.getMetadata().getName()).instantiateBinary()\n+                    .withTimeoutInMillis(s2iConfig.buildTimeout.toMillis()).fromFile(binaryFile);\n+        } catch (Exception e) {\n+            if (e.getCause() instanceof StreamResetException) {\n+                LOG.warn(\"Stream was reset while building. Falling back to building with the 'oc' binary.\");\n+                if (!ExecUtil.exec(\"oc\", \"start-build\", buildConfig.getMetadata().getName(), \"--from-archive\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzExNjczNw=="}, "originalCommit": {"oid": "e2d565de574764f669f189942de7b79fdcdd1623"}, "originalPosition": 104}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 162, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}