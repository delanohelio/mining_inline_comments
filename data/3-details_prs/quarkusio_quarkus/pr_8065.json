{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMDYyNzcy", "number": 8065, "title": "fix(flyway): multiple datasource migration does not work on native", "bodyText": "The QuarkusPathLocationScanner returned all migrations locations by default, this risked to cause\ncollision when we have a same filename for a migration script which is handled by different\ndatasources - a behaviour encountered on the issue #7685. Let's avoid this case by making sure that\nthe scanner only returns migration that it can recognize.\nFixes #7685\n/cc @yanxuehe this should fix the issue for you.", "createdAt": "2020-03-22T20:07:12Z", "url": "https://github.com/quarkusio/quarkus/pull/8065", "merged": true, "mergeCommit": {"oid": "8df8855b15d37ab822680534083788acabe7e487"}, "closed": true, "closedAt": "2020-03-24T12:44:15Z", "author": {"login": "machi1990"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQQLmGgH2gAyMzkyMDYyNzcyOmVjZGRmYjBhMmVlYjUyODNmZDFlYmJmMTgzMDczN2Y3OGNmMTVkMGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQyQ8jAFqTM4MDI2OTk3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ecddfb0a2eeb5283fd1ebbf1830737f78cf15d0b", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/ecddfb0a2eeb5283fd1ebbf1830737f78cf15d0b", "committedDate": "2020-03-22T21:00:01Z", "message": "fix(flyway): multiple datasource migration does not work on native\n\nThe QuarkusPathLocationScanner returned all migrations locations by default, this risked to cause\ncollision when we have a same filename for a migration script which is handled by different\ndatasources - a behaviour encountered on the issue #7685. Let's avoid this case by making sure that\nthe scanner only returns migration that it can recognize.\n\nFixes #7685"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ece2cbd34e5121d7510f1b2c6577174acb77babd", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/ece2cbd34e5121d7510f1b2c6577174acb77babd", "committedDate": "2020-03-22T19:57:32Z", "message": "fix(flyway): multiple datasource migration does not work on native\n\nThe QuarkusPathLocationScanner returned all migrations locations by default, this risked to cause\ncollision when we have a same filename for a migration script which is handled by different\ndatasources - a behaviour encountered on the issue #7685. Let's avoid this case by making sure that\nthe scanner only returns migration that it can recognize.\n\nFixes #7685"}, "afterCommit": {"oid": "ecddfb0a2eeb5283fd1ebbf1830737f78cf15d0b", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/ecddfb0a2eeb5283fd1ebbf1830737f78cf15d0b", "committedDate": "2020-03-22T21:00:01Z", "message": "fix(flyway): multiple datasource migration does not work on native\n\nThe QuarkusPathLocationScanner returned all migrations locations by default, this risked to cause\ncollision when we have a same filename for a migration script which is handled by different\ndatasources - a behaviour encountered on the issue #7685. Let's avoid this case by making sure that\nthe scanner only returns migration that it can recognize.\n\nFixes #7685"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MjM1NTUw", "url": "https://github.com/quarkusio/quarkus/pull/8065#pullrequestreview-379235550", "createdAt": "2020-03-23T09:00:34Z", "commit": {"oid": "ecddfb0a2eeb5283fd1ebbf1830737f78cf15d0b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwOTowMDozNFrOF58BwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwOTowNDoxOVrOF58KJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI5NjY0MQ==", "bodyText": "Could you clean up all these useless comments? I did it in the Liquibase extension that was based on it. It should be done in a separate commit.", "url": "https://github.com/quarkusio/quarkus/pull/8065#discussion_r396296641", "createdAt": "2020-03-23T09:00:34Z", "author": {"login": "gsmet"}, "path": "extensions/flyway/deployment/src/main/java/io/quarkus/flyway/FlywayProcessor.java", "diffHunk": "@@ -88,19 +82,20 @@ void build(BuildProducer<AdditionalBeanBuildItem> additionalBeanProducer,\n                 .collect(Collectors.toSet());\n         new FlywayDatasourceBeanGenerator(dataSourceNames, generatedBeanBuildItem).createFlywayProducerBean();\n \n-        registerNativeImageResources(resourceProducer, generatedResourceProducer,\n-                discoverApplicationMigrations(getMigrationLocations(dataSourceNames)));\n+        List<String> applicationMigrations = discoverApplicationMigrations(getMigrationLocations(dataSourceNames));\n+        recorder.setApplicationMigrationFiles(applicationMigrations);\n \n-        containerListenerProducer.produce(\n-                new BeanContainerListenerBuildItem(recorder.setFlywayBuildConfig(flywayBuildConfig)));\n+        resourceProducer.produce(new NativeImageResourceBuildItem(applicationMigrations.toArray(new String[0])));\n+\n+        containerListenerProducer.produce(new BeanContainerListenerBuildItem(recorder.setFlywayBuildConfig(flywayBuildConfig)));\n     }\n \n     /**\n      * Handles all the operations that can be recorded in the RUNTIME_INIT execution time phase\n      *\n      * @param recorder Used to set the runtime config\n      * @param flywayRuntimeConfig The Flyway configuration\n-     * @param dataSourceInitializedBuildItem Added this dependency to be sure that Agroal is initialized first\n+     * @param jdbcDataSourceBuildItems Added this dependency to be sure that Agroal is initialized first", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecddfb0a2eeb5283fd1ebbf1830737f78cf15d0b"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI5ODIwNA==", "bodyText": "It might be a silly idea but shouldn't we have a Map<Datasource name, Migration files>?", "url": "https://github.com/quarkusio/quarkus/pull/8065#discussion_r396298204", "createdAt": "2020-03-23T09:03:13Z", "author": {"login": "gsmet"}, "path": "extensions/flyway/deployment/src/main/java/io/quarkus/flyway/FlywayProcessor.java", "diffHunk": "@@ -88,19 +82,20 @@ void build(BuildProducer<AdditionalBeanBuildItem> additionalBeanProducer,\n                 .collect(Collectors.toSet());\n         new FlywayDatasourceBeanGenerator(dataSourceNames, generatedBeanBuildItem).createFlywayProducerBean();\n \n-        registerNativeImageResources(resourceProducer, generatedResourceProducer,\n-                discoverApplicationMigrations(getMigrationLocations(dataSourceNames)));\n+        List<String> applicationMigrations = discoverApplicationMigrations(getMigrationLocations(dataSourceNames));\n+        recorder.setApplicationMigrationFiles(applicationMigrations);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecddfb0a2eeb5283fd1ebbf1830737f78cf15d0b"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI5ODc4OA==", "bodyText": "It was preexisiting bug we would need to use debugf here. I fixed a few in the Liquibase extension.", "url": "https://github.com/quarkusio/quarkus/pull/8065#discussion_r396298788", "createdAt": "2020-03-23T09:04:19Z", "author": {"login": "gsmet"}, "path": "extensions/flyway/runtime/src/main/java/io/quarkus/flyway/runtime/graal/QuarkusPathLocationScanner.java", "diffHunk": "@@ -21,32 +15,46 @@\n \n public final class QuarkusPathLocationScanner implements ResourceAndClassScanner {\n     private static final Log LOG = LogFactory.getLog(QuarkusPathLocationScanner.class);\n-    /**\n-     * File with the migrations list. It is generated dynamically in the Flyway Quarkus Processor\n-     */\n-    public final static String MIGRATIONS_LIST_FILE = \"META-INF/flyway-migrations.txt\";\n+    private static final String LOCATION_SEPARATOR = \"/\";\n+    private static List<String> applicationMigrationFiles;\n+\n+    private final Collection<LoadableResource> scannedResources;\n+\n+    public QuarkusPathLocationScanner(Collection<Location> locations) {\n+        this.scannedResources = new ArrayList<>();\n+        ClassLoader classLoader = Thread.currentThread().getContextClassLoader();\n+\n+        for (String migrationFile : applicationMigrationFiles) {\n+            if (canHandleMigrationFile(locations, migrationFile)) {\n+                LOG.debug(\"Loading \" + migrationFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecddfb0a2eeb5283fd1ebbf1830737f78cf15d0b"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "469204f363c096afd5773edfed9e95ce9940bdee", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/469204f363c096afd5773edfed9e95ce9940bdee", "committedDate": "2020-03-23T09:39:12Z", "message": "refactor: use JBoss logging api in QuarkusPathLocationScanner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f4b720562c008abb35b679760512cd1aa4acba0", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/0f4b720562c008abb35b679760512cd1aa4acba0", "committedDate": "2020-03-23T09:39:29Z", "message": "refactor: remove useless comments from FlywayProcessor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjY0MTg2", "url": "https://github.com/quarkusio/quarkus/pull/8065#pullrequestreview-380264186", "createdAt": "2020-03-24T12:34:23Z", "commit": {"oid": "0f4b720562c008abb35b679760512cd1aa4acba0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMjozNDoyM1rOF6uIrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMjozNDoyM1rOF6uIrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzExNzYxMw==", "bodyText": "Dunno, this doesn't seem useless to me :)", "url": "https://github.com/quarkusio/quarkus/pull/8065#discussion_r397117613", "createdAt": "2020-03-24T12:34:23Z", "author": {"login": "gastaldi"}, "path": "extensions/flyway/deployment/src/main/java/io/quarkus/flyway/FlywayProcessor.java", "diffHunk": "@@ -117,10 +108,6 @@ ServiceStartBuildItem configureRuntimeProperties(FlywayRecorder recorder,\n \n     /**\n      * Collects the configured migration locations for the default and all named DataSources.\n-     * <p>\n-     * A {@link LinkedHashSet} is used to avoid duplications.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f4b720562c008abb35b679760512cd1aa4acba0"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjY5OTc4", "url": "https://github.com/quarkusio/quarkus/pull/8065#pullrequestreview-380269978", "createdAt": "2020-03-24T12:42:38Z", "commit": {"oid": "0f4b720562c008abb35b679760512cd1aa4acba0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3555, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}