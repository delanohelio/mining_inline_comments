{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5Njg0MTU3", "number": 7902, "title": "Make use of ExtendedMetadataBuilder in the Metrics extension", "bodyText": "Fixes #7875", "createdAt": "2020-03-17T08:03:38Z", "url": "https://github.com/quarkusio/quarkus/pull/7902", "merged": true, "mergeCommit": {"oid": "4979d6d5c2a98b460e7fd1d24d66deebbf21017b"}, "closed": true, "closedAt": "2020-03-18T14:21:10Z", "author": {"login": "jmartisk"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcONfz4AH2gAyMzg5Njg0MTU3OmU0ZTBkNmUyOTNlY2M2ZjUxYmNlMzZmYmQ3Y2ZmNzMxNjJmOTJlYTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO4EmmAFqTM3NjkwOTMyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e4e0d6e293ecc6f51bce36fbd7cff73162f92ea3", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/e4e0d6e293ecc6f51bce36fbd7cff73162f92ea3", "committedDate": "2020-03-16T12:44:32Z", "message": "Make use of ExtendedMetadataBuilder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1ODM4MDY5", "url": "https://github.com/quarkusio/quarkus/pull/7902#pullrequestreview-375838069", "createdAt": "2020-03-17T08:50:40Z", "commit": {"oid": "e4e0d6e293ecc6f51bce36fbd7cff73162f92ea3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODo1MDo0MFrOF3SwiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QwODo1MDo0MFrOF3SwiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyMzMzNw==", "bodyText": "While we are at it, can we remove the use of lambdas in runtime code please?", "url": "https://github.com/quarkusio/quarkus/pull/7902#discussion_r393523337", "createdAt": "2020-03-17T08:50:40Z", "author": {"login": "geoand"}, "path": "extensions/smallrye-metrics/runtime/src/main/java/io/quarkus/smallrye/metrics/runtime/SmallRyeMetricsRecorder.java", "diffHunk": "@@ -558,28 +559,38 @@ private void micrometerJvmGcMetrics(MetricRegistry registry, ShutdownContext shu\n         if (!ImageInfo.inImageCode()) {\n             MicrometerGCMetrics gcMetrics = new MicrometerGCMetrics();\n \n-            registry.register(new ExtendedMetadata(\"jvm.gc.max.data.size\",\n-                    MetricType.GAUGE,\n-                    MetricUnits.BYTES,\n-                    \"Max size of old generation memory pool\",\n-                    true), new LambdaGauge(gcMetrics::getMaxDataSize));\n-            registry.register(new ExtendedMetadata(\"jvm.gc.live.data.size\",\n-                    MetricType.GAUGE,\n-                    MetricUnits.BYTES,\n-                    \"Size of old generation memory pool after a full GC\",\n-                    true), new LambdaGauge(gcMetrics::getLiveDataSize));\n-            registry.register(new ExtendedMetadata(\"jvm.gc.memory.promoted\",\n-                    MetricType.COUNTER,\n-                    MetricUnits.BYTES,\n-                    \"Count of positive increases in the size of the old generation memory pool before GC to after GC\",\n-                    true,\n-                    \"jvm_gc_memory_promoted_bytes_total\"), new LambdaCounter(gcMetrics::getPromotedBytes));\n-            registry.register(new ExtendedMetadata(\"jvm.gc.memory.allocated\",\n-                    MetricType.COUNTER,\n-                    MetricUnits.BYTES,\n-                    \"Incremented for an increase in the size of the young generation memory pool after one GC to before the next\",\n-                    true,\n-                    \"jvm_gc_memory_allocated_bytes_total\"), new LambdaCounter(gcMetrics::getAllocatedBytes));\n+            registry.register(new ExtendedMetadataBuilder()\n+                    .withName(\"jvm.gc.max.data.size\")\n+                    .withType(MetricType.GAUGE)\n+                    .withUnit(MetricUnits.BYTES)\n+                    .withDescription(\"Max size of old generation memory pool\")\n+                    .skipsScopeInOpenMetricsExportCompletely(true)\n+                    .build(), new LambdaGauge(gcMetrics::getMaxDataSize));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e0d6e293ecc6f51bce36fbd7cff73162f92ea3"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODY3MjUx", "url": "https://github.com/quarkusio/quarkus/pull/7902#pullrequestreview-376867251", "createdAt": "2020-03-18T13:35:33Z", "commit": {"oid": "e4e0d6e293ecc6f51bce36fbd7cff73162f92ea3"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzozNTozNFrOF4FMOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzozNTo1N1rOF4FNKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM0OTYyNA==", "bodyText": "Is it normal that both the descriptions of this one and the one above are identical?", "url": "https://github.com/quarkusio/quarkus/pull/7902#discussion_r394349624", "createdAt": "2020-03-18T13:35:34Z", "author": {"login": "gsmet"}, "path": "extensions/smallrye-metrics/runtime/src/main/java/io/quarkus/smallrye/metrics/runtime/MicrometerGCMetrics.java", "diffHunk": "@@ -147,28 +148,34 @@ public void startWatchingNotifications() {\n                     gcPauseMaxValue.set(duration); // update the maximum GC length if needed\n                 }\n                 if (!registry.getGauges().containsKey(pauseSecondsMaxMetricID)) {\n-                    registry.register(new ExtendedMetadata(metricName + \".seconds.max\",\n-                            MetricType.GAUGE,\n-                            MetricUnits.NONE,\n-                            \"Time spent in GC pause\",\n-                            true),\n+                    registry.register(new ExtendedMetadataBuilder()\n+                            .withName(metricName + \".seconds.max\")\n+                            .withType(MetricType.GAUGE)\n+                            .withUnit(MetricUnits.NONE)\n+                            .withDescription(\"Time spent in GC pause\")\n+                            .skipsScopeInOpenMetricsExportCompletely(true)\n+                            .build(),\n                             new LambdaGauge(() -> mapForStoringMax.get(causeAndAction).doubleValue() / 1000.0), tags);\n                 }\n \n-                ExtendedMetadata countMetadata = new ExtendedMetadata(metricName + \".seconds.count\",\n-                        MetricType.COUNTER,\n-                        MetricUnits.NONE,\n-                        \"Time spent in GC pause\",\n-                        true,\n-                        metricName.replace(\".\", \"_\") + \"_seconds_count\");\n+                ExtendedMetadata countMetadata = new ExtendedMetadataBuilder()\n+                        .withName(metricName + \".seconds.count\")\n+                        .withType(MetricType.COUNTER)\n+                        .withUnit(MetricUnits.NONE)\n+                        .withDescription(\"Time spent in GC pause\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e0d6e293ecc6f51bce36fbd7cff73162f92ea3"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM0OTg2Nw==", "bodyText": "And same here?", "url": "https://github.com/quarkusio/quarkus/pull/7902#discussion_r394349867", "createdAt": "2020-03-18T13:35:57Z", "author": {"login": "gsmet"}, "path": "extensions/smallrye-metrics/runtime/src/main/java/io/quarkus/smallrye/metrics/runtime/MicrometerGCMetrics.java", "diffHunk": "@@ -147,28 +148,34 @@ public void startWatchingNotifications() {\n                     gcPauseMaxValue.set(duration); // update the maximum GC length if needed\n                 }\n                 if (!registry.getGauges().containsKey(pauseSecondsMaxMetricID)) {\n-                    registry.register(new ExtendedMetadata(metricName + \".seconds.max\",\n-                            MetricType.GAUGE,\n-                            MetricUnits.NONE,\n-                            \"Time spent in GC pause\",\n-                            true),\n+                    registry.register(new ExtendedMetadataBuilder()\n+                            .withName(metricName + \".seconds.max\")\n+                            .withType(MetricType.GAUGE)\n+                            .withUnit(MetricUnits.NONE)\n+                            .withDescription(\"Time spent in GC pause\")\n+                            .skipsScopeInOpenMetricsExportCompletely(true)\n+                            .build(),\n                             new LambdaGauge(() -> mapForStoringMax.get(causeAndAction).doubleValue() / 1000.0), tags);\n                 }\n \n-                ExtendedMetadata countMetadata = new ExtendedMetadata(metricName + \".seconds.count\",\n-                        MetricType.COUNTER,\n-                        MetricUnits.NONE,\n-                        \"Time spent in GC pause\",\n-                        true,\n-                        metricName.replace(\".\", \"_\") + \"_seconds_count\");\n+                ExtendedMetadata countMetadata = new ExtendedMetadataBuilder()\n+                        .withName(metricName + \".seconds.count\")\n+                        .withType(MetricType.COUNTER)\n+                        .withUnit(MetricUnits.NONE)\n+                        .withDescription(\"Time spent in GC pause\")\n+                        .skipsScopeInOpenMetricsExportCompletely(true)\n+                        .withOpenMetricsKeyOverride(metricName.replace(\".\", \"_\") + \"_seconds_count\")\n+                        .build();\n                 registry.counter(countMetadata, tags).inc();\n \n-                registry.counter(new ExtendedMetadata(metricName + \".seconds.sum\",\n-                        MetricType.COUNTER,\n-                        MetricUnits.MILLISECONDS,\n-                        \"Time spent in GC pause\",\n-                        true,\n-                        metricName.replace(\".\", \"_\") + \"_seconds_sum\"), tags).inc(duration);\n+                registry.counter(new ExtendedMetadataBuilder()\n+                        .withName(metricName + \".seconds.sum\")\n+                        .withType(MetricType.COUNTER)\n+                        .withUnit(MetricUnits.MILLISECONDS)\n+                        .withDescription(\"Time spent in GC pause\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e0d6e293ecc6f51bce36fbd7cff73162f92ea3"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2OTA5MzI3", "url": "https://github.com/quarkusio/quarkus/pull/7902#pullrequestreview-376909327", "createdAt": "2020-03-18T14:20:44Z", "commit": {"oid": "e4e0d6e293ecc6f51bce36fbd7cff73162f92ea3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3683, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}