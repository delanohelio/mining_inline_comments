{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MDIwNDMy", "number": 8695, "title": "Support of multiple persistence units for Hibernate Panache", "bodyText": "As proposed by Guillaume in this comment #2759 (comment)\nSupersedes #4018 (which was quite old)\n/cc @gsmet @Sanne", "createdAt": "2020-04-20T12:01:37Z", "url": "https://github.com/quarkusio/quarkus/pull/8695", "merged": true, "mergeCommit": {"oid": "c6fa955df69d43b33bee5b153a7030fc9f630094"}, "closed": true, "closedAt": "2020-09-01T07:13:46Z", "author": {"login": "machi1990"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBLBUEgBqjM2ODEwNjg0MjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEiDlOgFqTQ3OTQ1OTM1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce0a33eb37ba260eebe94099568ef2264870233a", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/ce0a33eb37ba260eebe94099568ef2264870233a", "committedDate": "2020-04-20T11:58:36Z", "message": "feat(panache): lay some ground work for support of multiple persistence units"}, "afterCommit": {"oid": "046cd22b8aaf9ccb56a3111f6fa0be48a92059ba", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/046cd22b8aaf9ccb56a3111f6fa0be48a92059ba", "committedDate": "2020-08-21T20:40:41Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "046cd22b8aaf9ccb56a3111f6fa0be48a92059ba", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/046cd22b8aaf9ccb56a3111f6fa0be48a92059ba", "committedDate": "2020-08-21T20:40:41Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}, "afterCommit": {"oid": "1fb27e8b01fae1c6082f68a91f5d16953f68c6a9", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/1fb27e8b01fae1c6082f68a91f5d16953f68c6a9", "committedDate": "2020-08-21T20:45:29Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fb27e8b01fae1c6082f68a91f5d16953f68c6a9", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/1fb27e8b01fae1c6082f68a91f5d16953f68c6a9", "committedDate": "2020-08-21T20:45:29Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}, "afterCommit": {"oid": "192c124412f1ca053983383fa3e1c1a974b705a0", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/192c124412f1ca053983383fa3e1c1a974b705a0", "committedDate": "2020-08-21T20:52:31Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "192c124412f1ca053983383fa3e1c1a974b705a0", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/192c124412f1ca053983383fa3e1c1a974b705a0", "committedDate": "2020-08-21T20:52:31Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}, "afterCommit": {"oid": "40fbf07f33ad63ab4f140272959d2494bdf10e4c", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/40fbf07f33ad63ab4f140272959d2494bdf10e4c", "committedDate": "2020-08-26T18:12:42Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40fbf07f33ad63ab4f140272959d2494bdf10e4c", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/40fbf07f33ad63ab4f140272959d2494bdf10e4c", "committedDate": "2020-08-26T18:12:42Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}, "afterCommit": {"oid": "3480c0aef66f60496455852acf00d9e1ba807383", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/3480c0aef66f60496455852acf00d9e1ba807383", "committedDate": "2020-08-26T18:17:18Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3480c0aef66f60496455852acf00d9e1ba807383", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/3480c0aef66f60496455852acf00d9e1ba807383", "committedDate": "2020-08-26T18:17:18Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}, "afterCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/3eaef9dc1b740fe67ebe34daf3949938609c87c9", "committedDate": "2020-08-26T19:34:22Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NzE0MjU5", "url": "https://github.com/quarkusio/quarkus/pull/8695#pullrequestreview-476714259", "createdAt": "2020-08-27T13:22:13Z", "commit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMzoyMjoxM1rOHIQHew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMzo0NzozNVrOHIRLmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQxNDcxNQ==", "bodyText": "No star imports, please.", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r478414715", "createdAt": "2020-08-27T13:22:13Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -10,20 +10,8 @@\n import java.io.IOException;\n import java.nio.file.Files;\n import java.nio.file.Path;\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.LinkedHashSet;\n-import java.util.List;\n-import java.util.Locale;\n-import java.util.Map;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQxNTMxMw==", "bodyText": "I think I would name it JpaModelPersistenceUnitMappingBuildItem.\nAlso I already built something here to push it to the JPAConfig: https://github.com/quarkusio/quarkus/blob/master/extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java#L455 so I don't think we should build it again .\nIt's not perfect either as we can't really properly deal with XML descriptors but I think it's good enough for what we want.", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r478415313", "createdAt": "2020-08-27T13:23:11Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -255,7 +243,8 @@ public void configurationDescriptorBuilding(\n             BuildProducer<SystemPropertyBuildItem> systemProperties,\n             BuildProducer<NativeImageResourceBuildItem> nativeImageResources,\n             BuildProducer<HotDeploymentWatchedFileBuildItem> hotDeploymentWatchedFiles,\n-            BuildProducer<PersistenceUnitDescriptorBuildItem> persistenceUnitDescriptors) {\n+            BuildProducer<PersistenceUnitDescriptorBuildItem> persistenceUnitDescriptors,\n+            BuildProducer<JpaEntityPerPersistenceUnitsBuildItem> jpaEntitiesPerPersistenceUnits) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyMTk5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Internal model to hold a Jpa entity to its corresponding persistence units.\n          \n          \n            \n             * Internal model to hold the mapping linking a JPA entity to its corresponding persistence units.", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r478421994", "createdAt": "2020-08-27T13:32:57Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/JpaEntityPerPersistenceUnitsBuildItem.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package io.quarkus.hibernate.orm.deployment;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.quarkus.builder.item.SimpleBuildItem;\n+\n+/**\n+ * Internal model to hold a Jpa entity to its corresponding persistence units.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyMjI1MQ==", "bodyText": "Maybe make it an unmodifiableMap?", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r478422251", "createdAt": "2020-08-27T13:33:19Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/JpaEntityPerPersistenceUnitsBuildItem.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package io.quarkus.hibernate.orm.deployment;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import io.quarkus.builder.item.SimpleBuildItem;\n+\n+/**\n+ * Internal model to hold a Jpa entity to its corresponding persistence units.\n+ */\n+public final class JpaEntityPerPersistenceUnitsBuildItem extends SimpleBuildItem {\n+\n+    private final Map<String, List<String>> entityToPersistenceUnits;\n+\n+    public JpaEntityPerPersistenceUnitsBuildItem(Map<String, List<String>> entityToPersistenceUnits) {\n+        this.entityToPersistenceUnits = entityToPersistenceUnits;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyNDQ3MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"PanacheEntity '%s' cannot be defined for usage in 'several persistence unit. The following persistence units were found %s'\",\n          \n          \n            \n                                    \"PanacheEntity '%s' cannot be defined for usage in several persistence units. The following persistence units were found: %s.\",", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r478424470", "createdAt": "2020-08-27T13:36:40Z", "author": {"login": "gsmet"}, "path": "extensions/panache/hibernate-orm-panache-kotlin/deployment/src/main/java/io/quarkus/hibernate/orm/panache/kotlin/deployment/KotlinPanacheResourceProcessor.java", "diffHunk": "@@ -185,5 +201,24 @@ void build(CombinedIndexBuildItem index,\n                 }\n             }\n         }\n+\n+        Map<String, List<String>> collectedEntityToPersistenceUnits = new HashMap<>();\n+        if (entityPerPersistenceUnits.isPresent()) {\n+            collectedEntityToPersistenceUnits = entityPerPersistenceUnits.get().getEntityToPersistenceUnits();\n+        }\n+\n+        for (Map.Entry<String, List<String>> entry : collectedEntityToPersistenceUnits.entrySet()) {\n+            String entityName = entry.getKey();\n+            List<String> selectedPersistenceUnits = entry.getValue();\n+            boolean isPanacheEntity = modelClasses.stream().anyMatch(name -> name.equals(entityName));\n+            if (selectedPersistenceUnits.size() > 1 && isPanacheEntity) {\n+                throw new IllegalStateException(String.format(\n+                        \"PanacheEntity '%s' cannot be defined for usage in 'several persistence unit. The following persistence units were found %s'\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyNTQ3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        \"PanacheEntity '%s' cannot be defined for usage in 'several persistence unit. The following persistence units were found %s'\",\n          \n          \n            \n                                        \"PanacheEntity '%s' cannot be defined for usage in several persistence units. The following persistence units were found: %s.\",", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r478425472", "createdAt": "2020-08-27T13:38:11Z", "author": {"login": "gsmet"}, "path": "extensions/panache/hibernate-orm-panache/deployment/src/main/java/io/quarkus/hibernate/orm/panache/deployment/PanacheHibernateResourceProcessor.java", "diffHunk": "@@ -194,4 +202,31 @@ void build(CombinedIndexBuildItem index,\n         }\n         return null;\n     }\n+\n+    @BuildStep\n+    @Record(ExecutionTime.STATIC_INIT)\n+    void persistenceUnits(PanacheHibernateOrmRecorder recorder,\n+            Optional<JpaEntityPerPersistenceUnitsBuildItem> entityPerPersistenceUnits,\n+            List<PanacheEntityClassBuildItem> entityClasses) {\n+        Map<String, String> panacheEntityToPersistenceUnit = new HashMap<>();\n+        if (entityPerPersistenceUnits.isPresent()) {\n+            Map<String, List<String>> collectedEntityToPersistenceUnits = entityPerPersistenceUnits.get()\n+                    .getEntityToPersistenceUnits();\n+            for (Map.Entry<String, List<String>> entry : collectedEntityToPersistenceUnits.entrySet()) {\n+                String entityName = entry.getKey();\n+                List<String> selectedPersistenceUnits = entry.getValue();\n+                boolean isPanacheEntity = entityClasses.stream()\n+                        .anyMatch(entity -> entity.get().name().toString().equals(entityName));\n+\n+                if (selectedPersistenceUnits.size() > 1 && isPanacheEntity) {\n+                    throw new IllegalStateException(String.format(\n+                            \"PanacheEntity '%s' cannot be defined for usage in 'several persistence unit. The following persistence units were found %s'\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyNTg0OA==", "bodyText": "Also it's not very clear in the message that this is not supported.", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r478425848", "createdAt": "2020-08-27T13:38:43Z", "author": {"login": "gsmet"}, "path": "extensions/panache/hibernate-orm-panache/deployment/src/main/java/io/quarkus/hibernate/orm/panache/deployment/PanacheHibernateResourceProcessor.java", "diffHunk": "@@ -194,4 +202,31 @@ void build(CombinedIndexBuildItem index,\n         }\n         return null;\n     }\n+\n+    @BuildStep\n+    @Record(ExecutionTime.STATIC_INIT)\n+    void persistenceUnits(PanacheHibernateOrmRecorder recorder,\n+            Optional<JpaEntityPerPersistenceUnitsBuildItem> entityPerPersistenceUnits,\n+            List<PanacheEntityClassBuildItem> entityClasses) {\n+        Map<String, String> panacheEntityToPersistenceUnit = new HashMap<>();\n+        if (entityPerPersistenceUnits.isPresent()) {\n+            Map<String, List<String>> collectedEntityToPersistenceUnits = entityPerPersistenceUnits.get()\n+                    .getEntityToPersistenceUnits();\n+            for (Map.Entry<String, List<String>> entry : collectedEntityToPersistenceUnits.entrySet()) {\n+                String entityName = entry.getKey();\n+                List<String> selectedPersistenceUnits = entry.getValue();\n+                boolean isPanacheEntity = entityClasses.stream()\n+                        .anyMatch(entity -> entity.get().name().toString().equals(entityName));\n+\n+                if (selectedPersistenceUnits.size() > 1 && isPanacheEntity) {\n+                    throw new IllegalStateException(String.format(\n+                            \"PanacheEntity '%s' cannot be defined for usage in 'several persistence unit. The following persistence units were found %s'\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQyODQ2Mg==", "bodyText": "Shouldn't we only flush the entityManager of the entity?", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r478428462", "createdAt": "2020-08-27T13:42:24Z", "author": {"login": "gsmet"}, "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/JpaOperations.java", "diffHunk": "@@ -71,16 +85,31 @@ public static boolean isPersistent(Object entity) {\n     }\n \n     public static void flush() {\n-        delegate.flush();\n+        Set<String> values = new HashSet<>(entityToPersistenceUnit.values());\n+        for (String persistentUnit : values) {\n+            getEntityManager(persistentUnit).flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQzMjE1Mw==", "bodyText": "I wonder if we could avoid a lot of overhead by having a generated method in the PanacheEntity/Repository return a static Literal for consumption by CDI.\nIt would avoid the overhead of the map lookup and would also avoid the overhead of instantiating a new Literal each time we want to the get EntityManager.\nI'm not that versed into Panache so it might just be a crazy idea.", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r478432153", "createdAt": "2020-08-27T13:47:35Z", "author": {"login": "gsmet"}, "path": "extensions/panache/hibernate-orm-panache-kotlin/runtime/src/main/java/io/quarkus/hibernate/orm/panache/kotlin/runtime/JpaOperations.java", "diffHunk": "@@ -307,6 +330,13 @@ public static int update(Class<?> entityClass, String query, Object... params) {\n             return query.stream();\n         }\n \n+        @Override\n+        public EntityManager getEntityManager(Class<?> clazz) {\n+            String clazzName = clazz.getName();\n+            String persistentUnitName = entityToPersistenceUnit.get(clazzName);\n+            return super.getEntityManager(persistentUnitName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eaef9dc1b740fe67ebe34daf3949938609c87c9"}, "originalPosition": 69}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9189f28b1340c6e867bab50e2249af75283f4938", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/9189f28b1340c6e867bab50e2249af75283f4938", "committedDate": "2020-08-27T13:50:51Z", "message": "Update extensions/panache/hibernate-orm-panache/deployment/src/main/java/io/quarkus/hibernate/orm/panache/deployment/PanacheHibernateResourceProcessor.java\n\nCo-authored-by: Guillaume Smet <guillaume.smet@gmail.com>"}, "afterCommit": {"oid": "477b99bb55b4c036c944e91a9715ff49919921e1", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/477b99bb55b4c036c944e91a9715ff49919921e1", "committedDate": "2020-08-27T14:39:45Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "477b99bb55b4c036c944e91a9715ff49919921e1", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/477b99bb55b4c036c944e91a9715ff49919921e1", "committedDate": "2020-08-27T14:39:45Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}, "afterCommit": {"oid": "d03124ee893531ed05a409f7c4e147c731c1e45c", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/d03124ee893531ed05a409f7c4e147c731c1e45c", "committedDate": "2020-08-27T14:54:51Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d03124ee893531ed05a409f7c4e147c731c1e45c", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/d03124ee893531ed05a409f7c4e147c731c1e45c", "committedDate": "2020-08-27T14:54:51Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}, "afterCommit": {"oid": "8111e128ccf0754ecc9bf7c4bdae2a78a0ab03f1", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/8111e128ccf0754ecc9bf7c4bdae2a78a0ab03f1", "committedDate": "2020-08-27T15:04:40Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8111e128ccf0754ecc9bf7c4bdae2a78a0ab03f1", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/8111e128ccf0754ecc9bf7c4bdae2a78a0ab03f1", "committedDate": "2020-08-27T15:04:40Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}, "afterCommit": {"oid": "921bc691cd047bcd8a4693e72b6108495f5ac3a6", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/921bc691cd047bcd8a4693e72b6108495f5ac3a6", "committedDate": "2020-08-27T19:47:06Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "921bc691cd047bcd8a4693e72b6108495f5ac3a6", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/921bc691cd047bcd8a4693e72b6108495f5ac3a6", "committedDate": "2020-08-27T19:47:06Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}, "afterCommit": {"oid": "582885e7c19a2a453e00ef332b04518317a6f053", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/582885e7c19a2a453e00ef332b04518317a6f053", "committedDate": "2020-08-31T13:40:23Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "582885e7c19a2a453e00ef332b04518317a6f053", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/582885e7c19a2a453e00ef332b04518317a6f053", "committedDate": "2020-08-31T13:40:23Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}, "afterCommit": {"oid": "ddad5162861d2df759b9276ba534ada1ae069b3c", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/ddad5162861d2df759b9276ba534ada1ae069b3c", "committedDate": "2020-08-31T13:46:31Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NjMyMzg2", "url": "https://github.com/quarkusio/quarkus/pull/8695#pullrequestreview-478632386", "createdAt": "2020-08-31T13:49:12Z", "commit": {"oid": "ddad5162861d2df759b9276ba534ada1ae069b3c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzo0OToxMlrOHJ5osg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMzo0OToxMlrOHJ5osg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE0MzUzOA==", "bodyText": "Is this really needed? I would have expected the standard ORM processor to be triggered too? Or am I missing something?", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r480143538", "createdAt": "2020-08-31T13:49:12Z", "author": {"login": "gsmet"}, "path": "extensions/panache/hibernate-orm-panache-kotlin/deployment/src/main/java/io/quarkus/hibernate/orm/panache/kotlin/deployment/KotlinPanacheResourceProcessor.java", "diffHunk": "@@ -185,5 +202,24 @@ void build(CombinedIndexBuildItem index,\n                 }\n             }\n         }\n+\n+        Map<String, Set<String>> collectedEntityToPersistenceUnits = new HashMap<>();\n+        if (jpaModelPersistenceUnitMapping.isPresent()) {\n+            collectedEntityToPersistenceUnits = jpaModelPersistenceUnitMapping.get().getEntityToPersistenceUnits();\n+        }\n+\n+        for (Map.Entry<String, Set<String>> entry : collectedEntityToPersistenceUnits.entrySet()) {\n+            String entityName = entry.getKey();\n+            List<String> selectedPersistenceUnits = new ArrayList<>(entry.getValue());\n+            boolean isPanacheEntity = modelClasses.stream().anyMatch(name -> name.equals(entityName));\n+            if (selectedPersistenceUnits.size() > 1 && isPanacheEntity) {\n+                throw new IllegalStateException(String.format(\n+                        \"PanacheEntity '%s' cannot be defined for usage in several persistence units which is not supported. The following persistence units were found: %s.\",\n+                        entityName, String.join(\",\", selectedPersistenceUnits)));\n+            }\n+\n+            panacheEntityToPersistenceUnit.put(entityName, selectedPersistenceUnits.get(0));\n+        }\n+        recorder.setEntityToPersistenceUnit(panacheEntityToPersistenceUnit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddad5162861d2df759b9276ba534ada1ae069b3c"}, "originalPosition": 113}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ddad5162861d2df759b9276ba534ada1ae069b3c", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/ddad5162861d2df759b9276ba534ada1ae069b3c", "committedDate": "2020-08-31T13:46:31Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}, "afterCommit": {"oid": "2dd36722844fd3d772d724a0d8373f143aed98ce", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/2dd36722844fd3d772d724a0d8373f143aed98ce", "committedDate": "2020-08-31T14:14:54Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NzU5ODgy", "url": "https://github.com/quarkusio/quarkus/pull/8695#pullrequestreview-478759882", "createdAt": "2020-08-31T16:24:58Z", "commit": {"oid": "2dd36722844fd3d772d724a0d8373f143aed98ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjoyNDo1OFrOHJ_taw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNjoyNDo1OFrOHJ_taw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDI0MzA1MQ==", "bodyText": "It would probably be better to move this code just below the line below, otherwise we consider the current class too. It's not really a problem but it's less correct.\n@machi1990 I'll wait to see if you have other comments before fixing this.", "url": "https://github.com/quarkusio/quarkus/pull/8695#discussion_r480243051", "createdAt": "2020-08-31T16:24:58Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -956,6 +968,27 @@ private void enhanceEntities(final JpaEntitiesBuildItem domainObjects,\n         return modelClassesPerPersistenceUnits;\n     }\n \n+    private static Set<String> getRelatedModelClassNames(IndexView index, Set<String> knownModelClassNames,\n+            String modelClassName) {\n+        Set<String> relatedModelClassNames = new HashSet<>();\n+        ClassInfo modelClassInfo = index.getClassByName(DotName.createSimple(modelClassName));\n+\n+        // for now we only deal with entities and mapped super classes\n+        if (modelClassInfo.classAnnotation(JPA_ENTITY) == null &&\n+                modelClassInfo.classAnnotation(MAPPED_SUPERCLASS) == null) {\n+            return Collections.emptySet();\n+        }\n+\n+        while (modelClassInfo != null && !modelClassInfo.name().equals(DotNames.OBJECT)) {\n+            if (knownModelClassNames.contains(modelClassName)) {\n+                relatedModelClassNames.add(modelClassInfo.name().toString());\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dd36722844fd3d772d724a0d8373f143aed98ce"}, "originalPosition": 90}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2dd36722844fd3d772d724a0d8373f143aed98ce", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/2dd36722844fd3d772d724a0d8373f143aed98ce", "committedDate": "2020-08-31T14:14:54Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}, "afterCommit": {"oid": "0d596e0d1152aa52957ad1b3fbd8a5212f4a4708", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/0d596e0d1152aa52957ad1b3fbd8a5212f4a4708", "committedDate": "2020-08-31T17:45:14Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99a4b4f163ac9b17e7a2da4e14e87d9557f39950", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/99a4b4f163ac9b17e7a2da4e14e87d9557f39950", "committedDate": "2020-08-31T19:57:08Z", "message": "feat(panache): add support of multiple persistence units in hibernate\norm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee0e042ec2a782467eba208575db91de02bb67ff", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/ee0e042ec2a782467eba208575db91de02bb67ff", "committedDate": "2020-08-31T19:57:08Z", "message": "Make JpaModelPersistenceUnitMappingBuildItem map unmodifiable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83709944d5304682e3c1baef432045cc91a8bac1", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/83709944d5304682e3c1baef432045cc91a8bac1", "committedDate": "2020-08-31T19:57:08Z", "message": "Improve error message for Panache entities attached to several PUs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "780966ab94830c9ad7788753efaca08f32a97e1b", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/780966ab94830c9ad7788753efaca08f32a97e1b", "committedDate": "2020-08-31T19:57:08Z", "message": "Don't make the PU map unmodifiable as we clear it on destroy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59402d95310c23c58950a0cb3c7594ba26edc829", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/59402d95310c23c58950a0cb3c7594ba26edc829", "committedDate": "2020-08-31T19:57:08Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d596e0d1152aa52957ad1b3fbd8a5212f4a4708", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/0d596e0d1152aa52957ad1b3fbd8a5212f4a4708", "committedDate": "2020-08-31T17:45:14Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}, "afterCommit": {"oid": "59402d95310c23c58950a0cb3c7594ba26edc829", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/59402d95310c23c58950a0cb3c7594ba26edc829", "committedDate": "2020-08-31T19:57:08Z", "message": "Add the whole hierarchy of an entity to the persistence unit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NDU5MzU1", "url": "https://github.com/quarkusio/quarkus/pull/8695#pullrequestreview-479459355", "createdAt": "2020-09-01T07:13:37Z", "commit": {"oid": "59402d95310c23c58950a0cb3c7594ba26edc829"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4453, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}