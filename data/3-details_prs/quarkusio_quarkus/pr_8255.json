{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1Mjc2NDM4", "number": 8255, "title": "Fix issue 8254 - PanacheQuery.count() throws \"unexpected token: SELECT\"", "bodyText": "Fixes #8254\nQueries like these\nselect distinct o from Order o left join fetch o.lineItems\nare translated into\nSELECT COUNT(*) select distinct o from Order o left join fetch o.lineItems\nwhen PanacheQuery.count() is invoked which clearly is not valid syntax.\nThis change will result in a query that looks like this:\nSELECT COUNT(distinct o) from Order o left join fetch o.lineItems\nWorks with SELECT and SELECT DISTINCT.", "createdAt": "2020-03-29T16:08:49Z", "url": "https://github.com/quarkusio/quarkus/pull/8255", "merged": true, "mergeCommit": {"oid": "e64a7ac53ac4e9542bb4e0883e4a1237fb0953a1"}, "closed": true, "closedAt": "2020-03-31T15:24:40Z", "author": {"login": "sirf"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSp-ddgFqTM4MzYxOTY4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSv17vABqjMxNzkwNzI1MzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzNjE5Njg2", "url": "https://github.com/quarkusio/quarkus/pull/8255#pullrequestreview-383619686", "createdAt": "2020-03-30T08:11:03Z", "commit": {"oid": "3ea623e8d464317276c43b57f53ace265addd984"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd11b8151e588c426c42330e0bc4a5cc5e8aee1d", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/dd11b8151e588c426c42330e0bc4a5cc5e8aee1d", "committedDate": "2020-03-30T12:17:54Z", "message": "one more test"}, "afterCommit": {"oid": "7c984eab57517c83942cff7891120cbc11ca869c", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/7c984eab57517c83942cff7891120cbc11ca869c", "committedDate": "2020-03-30T12:23:25Z", "message": "Fix https://github.com/quarkusio/quarkus/issues/8254"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c984eab57517c83942cff7891120cbc11ca869c", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/7c984eab57517c83942cff7891120cbc11ca869c", "committedDate": "2020-03-30T12:23:25Z", "message": "Fix https://github.com/quarkusio/quarkus/issues/8254"}, "afterCommit": {"oid": "2f71dc13017539e31bdc6d0a5bce9b2c6b36b09c", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/2f71dc13017539e31bdc6d0a5bce9b2c6b36b09c", "committedDate": "2020-03-30T12:33:45Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f71dc13017539e31bdc6d0a5bce9b2c6b36b09c", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/2f71dc13017539e31bdc6d0a5bce9b2c6b36b09c", "committedDate": "2020-03-30T12:33:45Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}, "afterCommit": {"oid": "08e9e141df39a1f234f46a44e1671ad0affc9975", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/08e9e141df39a1f234f46a44e1671ad0affc9975", "committedDate": "2020-03-30T13:57:53Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08e9e141df39a1f234f46a44e1671ad0affc9975", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/08e9e141df39a1f234f46a44e1671ad0affc9975", "committedDate": "2020-03-30T13:57:53Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}, "afterCommit": {"oid": "b236505e57b3f6df38ce21172611f6abf98dd387", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/b236505e57b3f6df38ce21172611f6abf98dd387", "committedDate": "2020-03-30T14:14:10Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzODk4MTE1", "url": "https://github.com/quarkusio/quarkus/pull/8255#pullrequestreview-383898115", "createdAt": "2020-03-30T14:15:08Z", "commit": {"oid": "b236505e57b3f6df38ce21172611f6abf98dd387"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzOTIyMTYz", "url": "https://github.com/quarkusio/quarkus/pull/8255#pullrequestreview-383922163", "createdAt": "2020-03-30T14:38:38Z", "commit": {"oid": "b236505e57b3f6df38ce21172611f6abf98dd387"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDozODozOFrOF9s-JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDozODozOFrOF9s-JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0NDI2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (selectMatcher.matches())\n          \n          \n            \n                        return \"SELECT COUNT(\" + selectMatcher.group(1) + \") \" + selectMatcher.group(2);\n          \n          \n            \n                    if (selectMatcher.matches()) {\n          \n          \n            \n                        return \"SELECT COUNT(\" + selectMatcher.group(1) + \") \" + selectMatcher.group(2);\n          \n          \n            \n                    }", "url": "https://github.com/quarkusio/quarkus/pull/8255#discussion_r400244261", "createdAt": "2020-03-30T14:38:38Z", "author": {"login": "gastaldi"}, "path": "extensions/panache/hibernate-orm-panache/runtime/src/main/java/io/quarkus/hibernate/orm/panache/runtime/PanacheQueryImpl.java", "diffHunk": "@@ -153,6 +158,9 @@ public long count() {\n     }\n \n     protected String countQuery() {\n+        Matcher selectMatcher = SELECT_PATTERN.matcher(query);\n+        if (selectMatcher.matches())\n+            return \"SELECT COUNT(\" + selectMatcher.group(1) + \") \" + selectMatcher.group(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b236505e57b3f6df38ce21172611f6abf98dd387"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b236505e57b3f6df38ce21172611f6abf98dd387", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/b236505e57b3f6df38ce21172611f6abf98dd387", "committedDate": "2020-03-30T14:14:10Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}, "afterCommit": {"oid": "91cfbfec4433bc62d5041267b93143b3b29cba79", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/91cfbfec4433bc62d5041267b93143b3b29cba79", "committedDate": "2020-03-30T14:53:10Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "331aa50588216ff42abb804ff9ff1f649f11b03e", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/331aa50588216ff42abb804ff9ff1f649f11b03e", "committedDate": "2020-03-30T15:01:01Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91cfbfec4433bc62d5041267b93143b3b29cba79", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/91cfbfec4433bc62d5041267b93143b3b29cba79", "committedDate": "2020-03-30T14:53:10Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}, "afterCommit": {"oid": "331aa50588216ff42abb804ff9ff1f649f11b03e", "author": {"user": null}, "url": "https://github.com/quarkusio/quarkus/commit/331aa50588216ff42abb804ff9ff1f649f11b03e", "committedDate": "2020-03-30T15:01:01Z", "message": "Fix 8254 PanacheQuery.count() throws \"unexpected token: SELECT\""}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4803, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}