{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0NzA2NDMy", "number": 13088, "title": "Fix narayana-jta ClassNotFoundException in native mode", "bodyText": "This replaces #10429\nFix #10180", "createdAt": "2020-11-03T12:39:51Z", "url": "https://github.com/quarkusio/quarkus/pull/13088", "merged": true, "mergeCommit": {"oid": "be96caa76029582beab813652fcc700f06d66211"}, "closed": true, "closedAt": "2020-11-30T13:26:24Z", "author": {"login": "zhfeng"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZPTJhABqjM5NTgwNzY5ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhjAkVAFqTU0MDc4ODY0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "585ca0482460273fb7c058c2ef4840c4a7051372", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/585ca0482460273fb7c058c2ef4840c4a7051372", "committedDate": "2020-11-03T12:35:24Z", "message": "Fix #10180 narayana-jta ClassNotFoundException in native mode"}, "afterCommit": {"oid": "996c7c8f522b50947614a32f0a57f893186e8730", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/996c7c8f522b50947614a32f0a57f893186e8730", "committedDate": "2020-11-04T15:13:23Z", "message": "Fix #10180 narayana-jta ClassNotFoundException in native mode"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "996c7c8f522b50947614a32f0a57f893186e8730", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/996c7c8f522b50947614a32f0a57f893186e8730", "committedDate": "2020-11-04T15:13:23Z", "message": "Fix #10180 narayana-jta ClassNotFoundException in native mode"}, "afterCommit": {"oid": "f60cd0581e226c733281019e2224f8bba60adc29", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/f60cd0581e226c733281019e2224f8bba60adc29", "committedDate": "2020-11-05T02:35:20Z", "message": "Fix #10180 narayana-jta ClassNotFoundException in native mode"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f60cd0581e226c733281019e2224f8bba60adc29", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/f60cd0581e226c733281019e2224f8bba60adc29", "committedDate": "2020-11-05T02:35:20Z", "message": "Fix #10180 narayana-jta ClassNotFoundException in native mode"}, "afterCommit": {"oid": "817eced11465869689fa225c4d0f1236f7bcc0ea", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/817eced11465869689fa225c4d0f1236f7bcc0ea", "committedDate": "2020-11-05T02:36:50Z", "message": "Fix #10180 narayana-jta ClassNotFoundException in native mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDM1NzE4", "url": "https://github.com/quarkusio/quarkus/pull/13088#pullrequestreview-524035718", "createdAt": "2020-11-05T08:48:05Z", "commit": {"oid": "817eced11465869689fa225c4d0f1236f7bcc0ea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo0ODowNVrOHt49ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo0ODowNVrOHt49ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg4MTI1MQ==", "bodyText": "This test only says that there is a transaction. A more comprehensive test is to check that there is both a transaction and that it is active/running. So if you return String.valueOf(txn.getStatus()); then that will test much more than the presence of a transaction. Then TransactionalTestCase can verify that it was running by checking that the response body has the value  javax.transaction.Status.STATUS_ACTIVE (ie given().when().get(\"/hello\").then().body(is(\"0\"));`). Here the value zero corresponds to STATUS_ACTIVE. To make the test clearer you could test against the constant field instead of \"0\".\nNote also that this would work regardless of the format of transaction uids since it is testing at the level of the JTA specification.", "url": "https://github.com/quarkusio/quarkus/pull/13088#discussion_r517881251", "createdAt": "2020-11-05T08:48:05Z", "author": {"login": "mmusgrov"}, "path": "integration-tests/narayana-jta/src/main/java/io/quarkus/narayana/jta/TransactionalResource.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package io.quarkus.narayana.jta;\n+\n+import javax.transaction.Transaction;\n+import javax.transaction.Transactional;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.MediaType;\n+\n+import com.arjuna.ats.arjuna.common.Uid;\n+import com.arjuna.ats.jta.TransactionManager;\n+\n+@Path(\"/txuid\")\n+public class TransactionalResource {\n+\n+    @GET\n+    @Produces(MediaType.TEXT_PLAIN)\n+    @Transactional\n+    public String txuid() throws javax.transaction.SystemException {\n+        Transaction txn = TransactionManager.transactionManager().getTransaction();\n+        Uid uid = ((com.arjuna.ats.jta.transaction.Transaction) txn).get_uid();\n+        return uid.toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "817eced11465869689fa225c4d0f1236f7bcc0ea"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDcwMjM2", "url": "https://github.com/quarkusio/quarkus/pull/13088#pullrequestreview-524470236", "createdAt": "2020-11-05T16:58:59Z", "commit": {"oid": "033c1ca6f45b4844cfeaf9ee8c165db61133d58e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo1ODo1OVrOHuM5kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo1ODo1OVrOHuM5kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIwNzg4OA==", "bodyText": "Our Uid format is internal and if we change the format then this will break (similarly if Quarkus replaces the underlying transaction engine).\nTesting uid format does not provide any positive benefit?\nHowever the test that verifies that the @Transactional annotation correctly starts a transaction is valid and is sufficient.", "url": "https://github.com/quarkusio/quarkus/pull/13088#discussion_r518207888", "createdAt": "2020-11-05T16:58:59Z", "author": {"login": "mmusgrov"}, "path": "integration-tests/narayana-jta/src/test/java/io/quarkus/narayana/jta/TransactionalTestCase.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package io.quarkus.narayana.jta;\n+\n+import static org.hamcrest.core.Is.is;\n+\n+import org.hamcrest.text.MatchesPattern;\n+import org.junit.jupiter.api.Test;\n+\n+import io.quarkus.test.common.http.TestHTTPEndpoint;\n+import io.quarkus.test.junit.QuarkusTest;\n+import io.restassured.RestAssured;\n+\n+@QuarkusTest\n+@TestHTTPEndpoint(TransactionalResource.class)\n+public class TransactionalTestCase {\n+\n+    @Test\n+    public void test() {\n+        RestAssured.when().get(\"/uid\").then().assertThat().body(MatchesPattern.matchesPattern(\"[:0-9a-f]+\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033c1ca6f45b4844cfeaf9ee8c165db61133d58e"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "033c1ca6f45b4844cfeaf9ee8c165db61133d58e", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/033c1ca6f45b4844cfeaf9ee8c165db61133d58e", "committedDate": "2020-11-05T14:06:05Z", "message": "add a test case to check the transaction status"}, "afterCommit": {"oid": "93c833f949ac7aaf2a6d393de0833472df487d88", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/93c833f949ac7aaf2a6d393de0833472df487d88", "committedDate": "2020-11-09T05:00:31Z", "message": "remove the uid test case"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93c833f949ac7aaf2a6d393de0833472df487d88", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/93c833f949ac7aaf2a6d393de0833472df487d88", "committedDate": "2020-11-09T05:00:31Z", "message": "remove the uid test case"}, "afterCommit": {"oid": "d040247c95c1752e7134c85af9e6ba47d24e3fdc", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/d040247c95c1752e7134c85af9e6ba47d24e3fdc", "committedDate": "2020-11-09T05:29:29Z", "message": "remove the uid test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MDg1NzU4", "url": "https://github.com/quarkusio/quarkus/pull/13088#pullrequestreview-526085758", "createdAt": "2020-11-09T09:52:38Z", "commit": {"oid": "d040247c95c1752e7134c85af9e6ba47d24e3fdc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "846290b9e46b38494d34eece6d981db85a8a3836", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/846290b9e46b38494d34eece6d981db85a8a3836", "committedDate": "2020-11-30T10:17:44Z", "message": "Fix #10180 narayana-jta ClassNotFoundException in native mode"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d040247c95c1752e7134c85af9e6ba47d24e3fdc", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/d040247c95c1752e7134c85af9e6ba47d24e3fdc", "committedDate": "2020-11-09T05:29:29Z", "message": "remove the uid test case"}, "afterCommit": {"oid": "846290b9e46b38494d34eece6d981db85a8a3836", "author": {"user": {"login": "zhfeng", "name": "Amos Feng"}}, "url": "https://github.com/quarkusio/quarkus/commit/846290b9e46b38494d34eece6d981db85a8a3836", "committedDate": "2020-11-30T10:17:44Z", "message": "Fix #10180 narayana-jta ClassNotFoundException in native mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNzg4NjQ1", "url": "https://github.com/quarkusio/quarkus/pull/13088#pullrequestreview-540788645", "createdAt": "2020-11-30T10:44:02Z", "commit": {"oid": "846290b9e46b38494d34eece6d981db85a8a3836"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1610, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}