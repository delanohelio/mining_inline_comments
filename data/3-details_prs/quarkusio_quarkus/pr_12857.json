{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NjE4NTU0", "number": 12857, "title": "Optimize OIDC code flow to do one less redirect when the original path has to be restored", "bodyText": "OIDC CodeAuthenticationMechanism can restore the original request path, for example:\n\nUser does GET /web-app/service\nRedirect path is configured as /web-app\nThe user, after authenticating, is redirected back to Quarkus to /web-app\nNow, before proceeding with the code to token exchange, the user is redirected to /web-app/service thus restoring the original request URI; to implement it, a custom pathChecked query is added, so it is not ideal\nFinally, after the code has been exchanged, another redirect follows, dropping code and state and other non-custom query parameters\n\nSo, step 4 is redundant, it adds to the cost of processing and also returns code and state back to the browser because the code flow has not completed yet.\nAs such this PR drops step 4 and the original path, if needed, will be restored as part of the last step\nI had to fix a few tests because they were written around the flow involving step4.", "createdAt": "2020-10-21T15:02:23Z", "url": "https://github.com/quarkusio/quarkus/pull/12857", "merged": true, "mergeCommit": {"oid": "67fd2514c2a3a1d704ff6eaa02402371079c648c"}, "closed": true, "closedAt": "2020-11-09T15:29:39Z", "author": {"login": "sberyozkin"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUuwu7gBqjM5MDQ0MjkwMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda1sJHgFqTUyNjMxMzEzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4206a765b42cd79ed4677807234962cfa15f2bb9", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/4206a765b42cd79ed4677807234962cfa15f2bb9", "committedDate": "2020-10-21T14:54:32Z", "message": "Optional authentication challenge if OIDC 'state' cookie is not available"}, "afterCommit": {"oid": "870f4605ad80c4e709fdf6901eb5d82d5e02658e", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/870f4605ad80c4e709fdf6901eb5d82d5e02658e", "committedDate": "2020-10-21T15:04:19Z", "message": "Support OIDC code flow custom 'code' query parameter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDg3ODcy", "url": "https://github.com/quarkusio/quarkus/pull/12857#pullrequestreview-518087872", "createdAt": "2020-10-27T19:50:55Z", "commit": {"oid": "870f4605ad80c4e709fdf6901eb5d82d5e02658e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTo1MDo1NVrOHpOP4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTo1MDo1NVrOHpOP4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4NzEwNg==", "bodyText": "Isn't just a matter of checking whether or not the state cookie was set and if not just redirect to the IdP ?", "url": "https://github.com/quarkusio/quarkus/pull/12857#discussion_r512987106", "createdAt": "2020-10-27T19:50:55Z", "author": {"login": "pedroigor"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -278,13 +277,18 @@ private boolean shouldAutoRedirect(TenantConfigContext configContext, RoutingCon\n                 // Local redirect restoring the original request path, the state cookie is no longer needed\n                 removeCookie(context, configContext, getStateCookieName(configContext));\n             }\n+        } else if (configContext.oidcConfig.authentication.isChallengeWithoutStateCookie()) {\n+            LOG.debug(\"The state cookie is missing after a redirect from IDP, re-authentication is required\");\n+            return Uni.createFrom().optional(Optional.empty());\n         } else {\n             // State cookie must be available to minimize the risk of CSRF\n-            LOG.debug(\"The state cookie is missing after a redirect from IDP\");\n+            LOG.debug(\"The state cookie is missing after a redirect from IDP, authentication has failed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "870f4605ad80c4e709fdf6901eb5d82d5e02658e"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "870f4605ad80c4e709fdf6901eb5d82d5e02658e", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/870f4605ad80c4e709fdf6901eb5d82d5e02658e", "committedDate": "2020-10-21T15:04:19Z", "message": "Support OIDC code flow custom 'code' query parameter"}, "afterCommit": {"oid": "629e1b697f3e5f519b83192ce761c0b5aa45981c", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/629e1b697f3e5f519b83192ce761c0b5aa45981c", "committedDate": "2020-10-29T13:24:42Z", "message": "Support OIDC code flow custom 'code' query parameter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "629e1b697f3e5f519b83192ce761c0b5aa45981c", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/629e1b697f3e5f519b83192ce761c0b5aa45981c", "committedDate": "2020-10-29T13:24:42Z", "message": "Support OIDC code flow custom 'code' query parameter"}, "afterCommit": {"oid": "2cacc58a2484e3da81cf517652dad42e476e3db4", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/2cacc58a2484e3da81cf517652dad42e476e3db4", "committedDate": "2020-10-30T15:50:09Z", "message": "Support OIDC code flow custom 'code' query parameter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2cacc58a2484e3da81cf517652dad42e476e3db4", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/2cacc58a2484e3da81cf517652dad42e476e3db4", "committedDate": "2020-10-30T15:50:09Z", "message": "Support OIDC code flow custom 'code' query parameter"}, "afterCommit": {"oid": "7c6de991ea7192c9743001b9844ed19e93f74e51", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/7c6de991ea7192c9743001b9844ed19e93f74e51", "committedDate": "2020-11-03T11:12:03Z", "message": "Support OIDC code flow custom 'code' query parameter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c6de991ea7192c9743001b9844ed19e93f74e51", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/7c6de991ea7192c9743001b9844ed19e93f74e51", "committedDate": "2020-11-03T11:12:03Z", "message": "Support OIDC code flow custom 'code' query parameter"}, "afterCommit": {"oid": "809f6d1ded705f2162b6ee665956f66b191bcba4", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/809f6d1ded705f2162b6ee665956f66b191bcba4", "committedDate": "2020-11-06T18:59:47Z", "message": "Support OIDC code flow custom 'code' query parameter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "809f6d1ded705f2162b6ee665956f66b191bcba4", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/809f6d1ded705f2162b6ee665956f66b191bcba4", "committedDate": "2020-11-06T18:59:47Z", "message": "Support OIDC code flow custom 'code' query parameter"}, "afterCommit": {"oid": "8657b02b2375f729254d44853e474009b59486fc", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/8657b02b2375f729254d44853e474009b59486fc", "committedDate": "2020-11-08T16:07:23Z", "message": "Support OIDC code flow custom 'code' query parameter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8657b02b2375f729254d44853e474009b59486fc", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/8657b02b2375f729254d44853e474009b59486fc", "committedDate": "2020-11-08T16:07:23Z", "message": "Support OIDC code flow custom 'code' query parameter"}, "afterCommit": {"oid": "fa9d71dbbdaaef4c334eadacce7ca97a420bedfa", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/fa9d71dbbdaaef4c334eadacce7ca97a420bedfa", "committedDate": "2020-11-08T16:09:52Z", "message": "Support OIDC code flow custom 'code' query parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "290520ea60da476d759db449195711a0e093b6f3", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/290520ea60da476d759db449195711a0e093b6f3", "committedDate": "2020-11-09T11:05:37Z", "message": "Support OIDC code flow custom 'code' query parameter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa9d71dbbdaaef4c334eadacce7ca97a420bedfa", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/fa9d71dbbdaaef4c334eadacce7ca97a420bedfa", "committedDate": "2020-11-08T16:09:52Z", "message": "Support OIDC code flow custom 'code' query parameter"}, "afterCommit": {"oid": "290520ea60da476d759db449195711a0e093b6f3", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/290520ea60da476d759db449195711a0e093b6f3", "committedDate": "2020-11-09T11:05:37Z", "message": "Support OIDC code flow custom 'code' query parameter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzEzMTM4", "url": "https://github.com/quarkusio/quarkus/pull/12857#pullrequestreview-526313138", "createdAt": "2020-11-09T14:32:27Z", "commit": {"oid": "290520ea60da476d759db449195711a0e093b6f3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1685, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}