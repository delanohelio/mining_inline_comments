{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NDY1Mzk3", "number": 11300, "title": "Properly support subfolders for Flyway database migrations", "bodyText": "Fix #11288", "createdAt": "2020-08-10T12:19:21Z", "url": "https://github.com/quarkusio/quarkus/pull/11300", "merged": true, "mergeCommit": {"oid": "24306ef98533b6e31883c214b0183d838fe83943"}, "closed": true, "closedAt": "2020-08-10T19:15:17Z", "author": {"login": "gsmet"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9hSRKgFqTQ2NDE3OTQ1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEmOXcgFqTQ3OTY3MjAyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MTc5NDU0", "url": "https://github.com/quarkusio/quarkus/pull/11300#pullrequestreview-464179454", "createdAt": "2020-08-10T12:22:17Z", "commit": {"oid": "5d7655a5b57f4d5d5dcbddadf4a3c1dc4a79ec13"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec47f0312e5c41196cb752b8359861a6cccfb7aa", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/ec47f0312e5c41196cb752b8359861a6cccfb7aa", "committedDate": "2020-08-10T12:27:04Z", "message": "Properly support subfolders for Flyway database migrations\n\nFix #11288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c715ba3410e6d45efe55128115756f37d179642e", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/c715ba3410e6d45efe55128115756f37d179642e", "committedDate": "2020-08-10T12:27:04Z", "message": "Remove debug logging in Flyway test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d7655a5b57f4d5d5dcbddadf4a3c1dc4a79ec13", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/5d7655a5b57f4d5d5dcbddadf4a3c1dc4a79ec13", "committedDate": "2020-08-10T12:18:17Z", "message": "Remove debug logging in Flyway test"}, "afterCommit": {"oid": "c715ba3410e6d45efe55128115756f37d179642e", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/c715ba3410e6d45efe55128115756f37d179642e", "committedDate": "2020-08-10T12:27:04Z", "message": "Remove debug logging in Flyway test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NjcyMDIx", "url": "https://github.com/quarkusio/quarkus/pull/11300#pullrequestreview-479672021", "createdAt": "2020-09-01T12:05:00Z", "commit": {"oid": "c715ba3410e6d45efe55128115756f37d179642e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMjowNTowMFrOHKzMrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMjowNTowMFrOHKzMrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4NjYzNw==", "bodyText": "This does not work in a Jar !\nI get unable to optain inputstream for resource:\ndb/migration/oracle/../oracle/<migration_name>.sql\nwith quarkus/flyway.locations=db/migration/oracle", "url": "https://github.com/quarkusio/quarkus/pull/11300#discussion_r481086637", "createdAt": "2020-09-01T12:05:00Z", "author": {"login": "rmanibus"}, "path": "extensions/flyway/deployment/src/main/java/io/quarkus/flyway/FlywayProcessor.java", "diffHunk": "@@ -232,11 +226,33 @@ ServiceStartBuildItem createBeansAndStartActions(FlywayRecorder recorder,\n         }\n     }\n \n+    private String normalizeLocation(String location) {\n+        if (location == null) {\n+            throw new IllegalStateException(\"Flyway migration location may not be null.\");\n+        }\n+\n+        // Strip any 'classpath:' protocol prefixes because they are assumed\n+        // but not recognized by ClassLoader.getResources()\n+        if (location.startsWith(CLASSPATH_APPLICATION_MIGRATIONS_PROTOCOL + ':')) {\n+            location = location.substring(CLASSPATH_APPLICATION_MIGRATIONS_PROTOCOL.length() + 1);\n+            if (location.startsWith(\"/\")) {\n+                location = location.substring(1);\n+            }\n+        }\n+        if (!location.endsWith(\"/\")) {\n+            location += \"/\";\n+        }\n+\n+        return location;\n+    }\n+\n     private Set<String> getApplicationMigrationsFromPath(final String location, final URL path)\n             throws IOException, URISyntaxException {\n-        try (final Stream<Path> pathStream = Files.walk(Paths.get(path.toURI()))) {\n+        Path rootPath = Paths.get(path.toURI());\n+\n+        try (final Stream<Path> pathStream = Files.walk(rootPath)) {\n             return pathStream.filter(Files::isRegularFile)\n-                    .map(it -> Paths.get(location, it.getFileName().toString()).toString())\n+                    .map(it -> Paths.get(location, rootPath.relativize(it).toString()).toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c715ba3410e6d45efe55128115756f37d179642e"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 949, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}