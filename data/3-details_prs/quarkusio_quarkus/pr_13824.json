{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MTUzMzIz", "number": 13824, "title": "MongoDB read preferences by query", "bodyText": "Fixes #10909", "createdAt": "2020-12-10T18:28:30Z", "url": "https://github.com/quarkusio/quarkus/pull/13824", "merged": true, "mergeCommit": {"oid": "797d1dcaab44c23dd98a0196f9e835f9ce06d752"}, "closed": true, "closedAt": "2020-12-16T16:13:16Z", "author": {"login": "loicmathieu"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk37XkAFqTU0OTQ5OTYxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlJg4xABqjQxMDA4NjkyMzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NDk5NjEx", "url": "https://github.com/quarkusio/quarkus/pull/13824#pullrequestreview-549499611", "createdAt": "2020-12-10T18:46:05Z", "commit": {"oid": "a0954ec06c4c6d5bb3fa19bc118d99f3bac6fa85"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxODo0NjowNVrOIDYGsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxODo0Nzo0OVrOIDYLGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQxMTU3MA==", "bodyText": "The collection should be updated/reassigned here rather than lazily.  Save some headaches down the line.", "url": "https://github.com/quarkusio/quarkus/pull/13824#discussion_r540411570", "createdAt": "2020-12-10T18:46:05Z", "author": {"login": "evanchooly"}, "path": "extensions/panache/mongodb-panache-common/runtime/src/main/java/io/quarkus/mongodb/panache/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -139,12 +142,21 @@ private void checkPagination() {\n         return (CommonPanacheQueryImpl<T>) this;\n     }\n \n+    public <T extends Entity> CommonPanacheQueryImpl<T> withReadPreference(ReadPreference readPreference) {\n+        this.readPreference = readPreference;\n+        return (CommonPanacheQueryImpl<T>) this;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0954ec06c4c6d5bb3fa19bc118d99f3bac6fa85"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQxMjAxMw==", "bodyText": "This can all but ignore the ReadPreference but updating as above.", "url": "https://github.com/quarkusio/quarkus/pull/13824#discussion_r540412013", "createdAt": "2020-12-10T18:46:45Z", "author": {"login": "evanchooly"}, "path": "extensions/panache/mongodb-panache-common/runtime/src/main/java/io/quarkus/mongodb/panache/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -139,12 +142,21 @@ private void checkPagination() {\n         return (CommonPanacheQueryImpl<T>) this;\n     }\n \n+    public <T extends Entity> CommonPanacheQueryImpl<T> withReadPreference(ReadPreference readPreference) {\n+        this.readPreference = readPreference;\n+        return (CommonPanacheQueryImpl<T>) this;\n+    }\n+\n     // Results\n \n     @SuppressWarnings(\"unchecked\")\n     public long count() {\n         if (count == null) {\n-            count = collection.countDocuments(mongoQuery);\n+            MongoCollection theCollection = collection;\n+            if (this.readPreference != null) {\n+                theCollection = theCollection.withReadPreference(this.readPreference);\n+            }\n+            count = theCollection.countDocuments(mongoQuery);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0954ec06c4c6d5bb3fa19bc118d99f3bac6fa85"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQxMjY5Ng==", "bodyText": "Same here.", "url": "https://github.com/quarkusio/quarkus/pull/13824#discussion_r540412696", "createdAt": "2020-12-10T18:47:49Z", "author": {"login": "evanchooly"}, "path": "extensions/panache/mongodb-panache-common/runtime/src/main/java/io/quarkus/mongodb/panache/runtime/CommonPanacheQueryImpl.java", "diffHunk": "@@ -156,7 +168,11 @@ public long count() {\n     @SuppressWarnings(\"unchecked\")\n     private <T extends Entity> List<T> list(Integer limit) {\n         List<T> list = new ArrayList<>();\n-        FindIterable find = mongoQuery == null ? collection.find() : collection.find(mongoQuery);\n+        MongoCollection theCollection = collection;\n+        if (this.readPreference != null) {\n+            theCollection = theCollection.withReadPreference(this.readPreference);\n+        }\n+        FindIterable find = mongoQuery == null ? theCollection.find() : theCollection.find(mongoQuery);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0954ec06c4c6d5bb3fa19bc118d99f3bac6fa85"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0954ec06c4c6d5bb3fa19bc118d99f3bac6fa85", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/a0954ec06c4c6d5bb3fa19bc118d99f3bac6fa85", "committedDate": "2020-12-10T18:27:21Z", "message": "feat: mongdb read preferences by query"}, "afterCommit": {"oid": "63e8de2683b3e3b2f67f596fae8964a2fae68a52", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/63e8de2683b3e3b2f67f596fae8964a2fae68a52", "committedDate": "2020-12-11T12:19:12Z", "message": "feat: mongdb read preferences by query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63e8de2683b3e3b2f67f596fae8964a2fae68a52", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/63e8de2683b3e3b2f67f596fae8964a2fae68a52", "committedDate": "2020-12-11T12:19:12Z", "message": "feat: mongdb read preferences by query"}, "afterCommit": {"oid": "fb21fdf2ebbcd93f9f132ae092174968c4d4e344", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/fb21fdf2ebbcd93f9f132ae092174968c4d4e344", "committedDate": "2020-12-11T12:26:41Z", "message": "feat: mongdb read preferences by query"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMTc1MTk2", "url": "https://github.com/quarkusio/quarkus/pull/13824#pullrequestreview-550175196", "createdAt": "2020-12-11T15:02:31Z", "commit": {"oid": "fb21fdf2ebbcd93f9f132ae092174968c4d4e344"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2c6b4c75ba3b27fffc4aa908654af538ebddf7d", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/b2c6b4c75ba3b27fffc4aa908654af538ebddf7d", "committedDate": "2020-12-11T15:16:13Z", "message": "feat: mongdb read preferences by query"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb21fdf2ebbcd93f9f132ae092174968c4d4e344", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/fb21fdf2ebbcd93f9f132ae092174968c4d4e344", "committedDate": "2020-12-11T12:26:41Z", "message": "feat: mongdb read preferences by query"}, "afterCommit": {"oid": "b2c6b4c75ba3b27fffc4aa908654af538ebddf7d", "author": {"user": {"login": "loicmathieu", "name": "Lo\u00efc Mathieu"}}, "url": "https://github.com/quarkusio/quarkus/commit/b2c6b4c75ba3b27fffc4aa908654af538ebddf7d", "committedDate": "2020-12-11T15:16:13Z", "message": "feat: mongdb read preferences by query"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4289, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}