{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTY5MTk1", "number": 7448, "title": "Fix a connection-delay processing", "bodyText": "Fixes #7447", "createdAt": "2020-02-27T00:05:49Z", "url": "https://github.com/quarkusio/quarkus/pull/7448", "merged": true, "mergeCommit": {"oid": "f87c4457248c402466cb9e34d1fc3013dd03d50b"}, "closed": true, "closedAt": "2020-03-04T01:53:22Z", "author": {"login": "sberyozkin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIP8OXABqjMwNzU5MDk4MjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKM_AGAFqTM2ODQ1NDc0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22afb11ea7230e076d329b761a342d784c82f4b7", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/22afb11ea7230e076d329b761a342d784c82f4b7", "committedDate": "2020-02-27T00:04:54Z", "message": "Fix a connection-delay processing"}, "afterCommit": {"oid": "cace3a4d1a503d05dbc9ce33eb726b8c8113875f", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/cace3a4d1a503d05dbc9ce33eb726b8c8113875f", "committedDate": "2020-02-27T00:11:27Z", "message": "Fix a connection-delay processing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MzQwNjgy", "url": "https://github.com/quarkusio/quarkus/pull/7448#pullrequestreview-365340682", "createdAt": "2020-02-27T00:27:39Z", "commit": {"oid": "cace3a4d1a503d05dbc9ce33eb726b8c8113875f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDoyNzozOVrOFvBRzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDoyNzozOVrOFvBRzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg0ODMzNA==", "bodyText": "Can this be called in an IO thread?", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r384848334", "createdAt": "2020-02-27T00:27:39Z", "author": {"login": "stuartwdouglas"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -119,16 +120,22 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n \n                 auth = cf.join();\n                 break;\n-            } catch (OIDCException ex) {\n-                if (i + 1 < connectionRetryCount) {\n-                    try {\n-                        Thread.sleep(2000);\n-                    } catch (InterruptedException iex) {\n-                        // continue connecting\n+            } catch (Throwable throwable) {\n+                while (throwable instanceof CompletionException && throwable.getCause() != null) {\n+                    throwable = throwable.getCause();\n+                }\n+                if (throwable instanceof OIDCException) {\n+                    if (i + 1 < connectionRetryCount) {\n+                        try {\n+                            Thread.sleep(2000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cace3a4d1a503d05dbc9ce33eb726b8c8113875f"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cace3a4d1a503d05dbc9ce33eb726b8c8113875f", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/cace3a4d1a503d05dbc9ce33eb726b8c8113875f", "committedDate": "2020-02-27T00:11:27Z", "message": "Fix a connection-delay processing"}, "afterCommit": {"oid": "4cef6530304e67282788d2cd025bee45dd43b9c5", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/4cef6530304e67282788d2cd025bee45dd43b9c5", "committedDate": "2020-02-27T12:29:24Z", "message": "Fix a connection-delay processing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDMwNzE4", "url": "https://github.com/quarkusio/quarkus/pull/7448#pullrequestreview-366030718", "createdAt": "2020-02-27T22:00:57Z", "commit": {"oid": "4cef6530304e67282788d2cd025bee45dd43b9c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMjowMDo1N1rOFvivtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMjowMDo1N1rOFvivtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5NjY2MQ==", "bodyText": "runAsync should never be used, it uses the default fork join pool that we have no control over.", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385396661", "createdAt": "2020-02-27T22:00:57Z", "author": {"login": "stuartwdouglas"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -119,16 +120,29 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n \n                 auth = cf.join();\n                 break;\n-            } catch (OIDCException ex) {\n-                if (i + 1 < connectionRetryCount) {\n-                    try {\n-                        Thread.sleep(2000);\n-                    } catch (InterruptedException iex) {\n-                        // continue connecting\n+            } catch (Throwable throwable) {\n+                while (throwable instanceof CompletionException && throwable.getCause() != null) {\n+                    throwable = throwable.getCause();\n+                }\n+                if (throwable instanceof OIDCException) {\n+                    if (i + 1 < connectionRetryCount) {\n+                        CompletableFuture.runAsync(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cef6530304e67282788d2cd025bee45dd43b9c5"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDMwOTcw", "url": "https://github.com/quarkusio/quarkus/pull/7448#pullrequestreview-366030970", "createdAt": "2020-02-27T22:01:25Z", "commit": {"oid": "4cef6530304e67282788d2cd025bee45dd43b9c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMjowMToyNVrOFviwdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMjowMToyNVrOFviwdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5Njg1Mg==", "bodyText": "Also this blocks the thread anyway, so now you are blocking 2 threads instead of just one.", "url": "https://github.com/quarkusio/quarkus/pull/7448#discussion_r385396852", "createdAt": "2020-02-27T22:01:25Z", "author": {"login": "stuartwdouglas"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -119,16 +120,29 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n \n                 auth = cf.join();\n                 break;\n-            } catch (OIDCException ex) {\n-                if (i + 1 < connectionRetryCount) {\n-                    try {\n-                        Thread.sleep(2000);\n-                    } catch (InterruptedException iex) {\n-                        // continue connecting\n+            } catch (Throwable throwable) {\n+                while (throwable instanceof CompletionException && throwable.getCause() != null) {\n+                    throwable = throwable.getCause();\n+                }\n+                if (throwable instanceof OIDCException) {\n+                    if (i + 1 < connectionRetryCount) {\n+                        CompletableFuture.runAsync(\n+                                new Runnable() {\n+                                    @Override\n+                                    public void run() {\n+                                        try {\n+                                            Thread.sleep(2000);\n+                                        } catch (InterruptedException iex) {\n+                                            // continue connecting\n+                                        }\n+                                    }\n+                                })\n+                                .join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cef6530304e67282788d2cd025bee45dd43b9c5"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4cef6530304e67282788d2cd025bee45dd43b9c5", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/4cef6530304e67282788d2cd025bee45dd43b9c5", "committedDate": "2020-02-27T12:29:24Z", "message": "Fix a connection-delay processing"}, "afterCommit": {"oid": "2bdd2ea63eb3bc85d9b5749a3ff9c0c38c6f7f1a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/2bdd2ea63eb3bc85d9b5749a3ff9c0c38c6f7f1a", "committedDate": "2020-03-02T10:54:20Z", "message": "Fix a connection-delay processing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "066712100a56ed70121c8c8a14ac757ab789260e", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/066712100a56ed70121c8c8a14ac757ab789260e", "committedDate": "2020-03-03T15:08:26Z", "message": "Fix a connection-delay processing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bdd2ea63eb3bc85d9b5749a3ff9c0c38c6f7f1a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/2bdd2ea63eb3bc85d9b5749a3ff9c0c38c6f7f1a", "committedDate": "2020-03-02T10:54:20Z", "message": "Fix a connection-delay processing"}, "afterCommit": {"oid": "066712100a56ed70121c8c8a14ac757ab789260e", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/066712100a56ed70121c8c8a14ac757ab789260e", "committedDate": "2020-03-03T15:08:26Z", "message": "Fix a connection-delay processing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDU0NzQz", "url": "https://github.com/quarkusio/quarkus/pull/7448#pullrequestreview-368454743", "createdAt": "2020-03-04T01:53:00Z", "commit": {"oid": "066712100a56ed70121c8c8a14ac757ab789260e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4034, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}