{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4OTk2MTUy", "number": 13537, "title": "Refactoring Vault components to be CDI beans", "bodyText": "This is a complete internal refactoring to use CDI beans instead of regular classes.\nI was able to drop 2 classes, and this brought a lot of simplification and consistency on the others.\nThis is also preparation work for #4162 or reopening of #8885\nquestions:\n\nis there a better way to pass runtime config to the beans than through the recorder: https://github.com/vsevel/quarkus/blob/vault_cdi/extensions/vault/runtime/src/main/java/io/quarkus/vault/runtime/VaultRecorder.java#L23\nI have left the @ApplicationScoped on the VaultCredentialsProvider, because that is what we have in the other implementations (e.g. CustomCredentialsProvider in mysql). but I chose @Singleton for all the other services. should we standardize on just one?", "createdAt": "2020-11-28T19:06:42Z", "url": "https://github.com/quarkusio/quarkus/pull/13537", "merged": true, "mergeCommit": {"oid": "82595dc45d6ffc2e60cf7bb2449ab13519a31a43"}, "closed": true, "closedAt": "2021-01-08T22:36:28Z", "author": {"login": "vsevel"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqsmUgAFqTU1OTMwMDU2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtlOkvABqjQxNzY4MzY2OTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzAwNTYw", "url": "https://github.com/quarkusio/quarkus/pull/13537#pullrequestreview-559300560", "createdAt": "2020-12-28T20:59:44Z", "commit": {"oid": "953924d08340fd915a5c8777d564d8a2ea7c64aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQyMDo1OTo0NFrOIMB62A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQyMDo1OTo0NFrOIMB62A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTQ4NTI3Mg==", "bodyText": "@vsevel I think the best way to access Arc is via io.quarkus.arc.deployment.BeanContainerBuildItem - you'd add it as the built step parameter and it will give you BeanContainer which will go to the recorder, try it please.\nI believe the other option is to have this runtime config to be wrapped into a synthetic bean (see for ex OidcRecorder) and then inject that into the beans which need it and access it in the @PostConstruct methods - however - I'm not 100% sure it will work in the case of the vault extension - maybe you can experiment with this approach in a follow up PR", "url": "https://github.com/quarkusio/quarkus/pull/13537#discussion_r549485272", "createdAt": "2020-12-28T20:59:44Z", "author": {"login": "sberyozkin"}, "path": "extensions/vault/runtime/src/main/java/io/quarkus/vault/runtime/VaultRecorder.java", "diffHunk": "@@ -18,12 +18,10 @@\n \n     private static final Logger log = Logger.getLogger(VaultRecorder.class);\n \n-    public RuntimeValue<ConfigSourceProvider> configureRuntimeProperties(VaultBuildTimeConfig vaultBuildTimeConfig,\n-            VaultRuntimeConfig vaultRuntimeConfig,\n-            TlsConfig tlsConfig) {\n-\n+    public RuntimeValue<ConfigSourceProvider> configureRuntimeProperties(VaultRuntimeConfig vaultRuntimeConfig) {\n         if (vaultRuntimeConfig.url.isPresent()) {\n-            VaultManager.init(vaultBuildTimeConfig, vaultRuntimeConfig, tlsConfig);\n+            Arc.container().instance(VaultAuthManager.class).get().setVaultRuntimeConfig(vaultRuntimeConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "953924d08340fd915a5c8777d564d8a2ea7c64aa"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "953924d08340fd915a5c8777d564d8a2ea7c64aa", "author": {"user": {"login": "vsevel", "name": "Vincent Sevel"}}, "url": "https://github.com/quarkusio/quarkus/commit/953924d08340fd915a5c8777d564d8a2ea7c64aa", "committedDate": "2020-11-28T18:57:39Z", "message": "Vault CDI"}, "afterCommit": {"oid": "95d6b62d96a0c02d90a675b1484fe3764801eaba", "author": {"user": {"login": "vsevel", "name": "Vincent Sevel"}}, "url": "https://github.com/quarkusio/quarkus/commit/95d6b62d96a0c02d90a675b1484fe3764801eaba", "committedDate": "2020-12-29T20:28:12Z", "message": "Vault CDI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNzA4MTU3", "url": "https://github.com/quarkusio/quarkus/pull/13537#pullrequestreview-560708157", "createdAt": "2021-01-03T16:09:28Z", "commit": {"oid": "95d6b62d96a0c02d90a675b1484fe3764801eaba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwODY3MDk1", "url": "https://github.com/quarkusio/quarkus/pull/13537#pullrequestreview-560867095", "createdAt": "2021-01-04T09:02:31Z", "commit": {"oid": "95d6b62d96a0c02d90a675b1484fe3764801eaba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwOTowMjozMVrOINp3AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwOTowMjozMVrOINp3AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE4ODIyNQ==", "bodyText": "Why the @Named qualifier? Is it required for some functionality?", "url": "https://github.com/quarkusio/quarkus/pull/13537#discussion_r551188225", "createdAt": "2021-01-04T09:02:31Z", "author": {"login": "mkouba"}, "path": "extensions/vault/runtime/src/main/java/io/quarkus/vault/runtime/VaultCredentialsProvider.java", "diffHunk": "@@ -3,28 +3,29 @@\n import java.util.HashMap;\n import java.util.Map;\n \n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n import io.quarkus.credentials.CredentialsProvider;\n import io.quarkus.vault.VaultException;\n+import io.quarkus.vault.VaultKVSecretEngine;\n import io.quarkus.vault.runtime.config.CredentialsProviderConfig;\n import io.quarkus.vault.runtime.config.VaultRuntimeConfig;\n \n+@ApplicationScoped\n+@Named(\"vault-credentials-provider\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95d6b62d96a0c02d90a675b1484fe3764801eaba"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43e0296a3b979ce8570141b56d95237678b82559", "author": {"user": {"login": "vsevel", "name": "Vincent Sevel"}}, "url": "https://github.com/quarkusio/quarkus/commit/43e0296a3b979ce8570141b56d95237678b82559", "committedDate": "2021-01-06T12:05:32Z", "message": "Vault CDI"}, "afterCommit": {"oid": "184564a791660b052444bb37cd61f017d60a6ddc", "author": {"user": {"login": "vsevel", "name": "Vincent Sevel"}}, "url": "https://github.com/quarkusio/quarkus/commit/184564a791660b052444bb37cd61f017d60a6ddc", "committedDate": "2021-01-06T17:16:56Z", "message": "Vault CDI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8b366d5b0d64dc2a96dd8dfd05e62344357788f", "author": {"user": {"login": "vsevel", "name": "Vincent Sevel"}}, "url": "https://github.com/quarkusio/quarkus/commit/f8b366d5b0d64dc2a96dd8dfd05e62344357788f", "committedDate": "2021-01-06T18:04:31Z", "message": "Vault CDI"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "184564a791660b052444bb37cd61f017d60a6ddc", "author": {"user": {"login": "vsevel", "name": "Vincent Sevel"}}, "url": "https://github.com/quarkusio/quarkus/commit/184564a791660b052444bb37cd61f017d60a6ddc", "committedDate": "2021-01-06T17:16:56Z", "message": "Vault CDI"}, "afterCommit": {"oid": "f8b366d5b0d64dc2a96dd8dfd05e62344357788f", "author": {"user": {"login": "vsevel", "name": "Vincent Sevel"}}, "url": "https://github.com/quarkusio/quarkus/commit/f8b366d5b0d64dc2a96dd8dfd05e62344357788f", "committedDate": "2021-01-06T18:04:31Z", "message": "Vault CDI"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1330, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}