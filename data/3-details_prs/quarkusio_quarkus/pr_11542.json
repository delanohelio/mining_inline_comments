{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMDYwMjk5", "number": 11542, "title": "Enable jbang integration in Quarkus", "bodyText": "This PR started out as trying to run a jar directly via quarkus; but after talking with @stuartwdouglas\ntaking another approach where jbang has a SPI to let quarkus (or any other framework) hook into the build process.\nWith this PR + jbang PR you can take the following file, save in quarkus.java and do:\njbang quarkus.java to run it\njbang --debug quarkus.java to debug it\njbang --native quarkus.java to get native image built (currently rely on docker; TBD use graalvm if available)\n//usr/bin/env jbang \"$0\" \"$@\" ; exit $?\n// //DEPS <dependency1> <dependency2>\n//DEPS io.quarkus:quarkus-arc:999-SNAPSHOT\n\nimport io.quarkus.runtime.Quarkus;\nimport io.quarkus.runtime.QuarkusApplication;\n\nimport static java.lang.System.*;\n\npublic class quarkus {\n\n    public static void main(String... args) {\n        Quarkus.run(MyApp.class, args);\n    }\n\n    public static class MyApp implements QuarkusApplication {\n\n        @Override\n        public int run(String... args) throws Exception {\n            System.out.println(\"Inside Quarkus!\");\n            return 0;\n        }\n    }\n}\nyou can also do configuration using //CONFIG\n//DEPS io.quarkus:quarkus-resteasy:999-SNAPSHOT\n//DEPS io.quarkus:quarkus-container-image-jib:999-SNAPSHOT\n//CONFIG quarkus.http.port=7777\n//CONFIG quarkus.native.container-build=true\n//CONFIG quarkus.container-image.build=true\n//CONFIG quarkus.container-image.name=jbang-test\n\nimport io.quarkus.runtime.Quarkus;\n\nimport javax.ws.rs.GET;\nimport javax.ws.rs.Path;\n\n@Path(\"/hello\")\npublic class quarkus {\n\n    public static void main(String... args) {\n        Quarkus.run(args);\n    }\n\n    @GET\n    public String sayHello() {\n        return \"hello\";\n    }\n}\n\nThings yet to do/being considered:\n\n release jbang 0.40 with SPI enabled\n transformation missing thus things like panache does not work (trivial fix)\n Consider if //CONFIG should be //QCONFIG as it is quarkus specific\n remove dependency on intermediate pom.xml and just work based on dependency list\n enable dev:mode (package as mutable-jar and this should \"just work\")\n enable run from IDE (currently it requires it to be packaged as jar)\n(work around is to do jbang --debug app.java and connect with debugger from there.)\n consider if we should allow triggering thngs like openshift/kubernetes/funky deploy (all technical possible; just a question on if can make the UX experience sane from jbang side)\n\nIn addition this PR also try and make it possible to run app directly without having\npom.xml/build.gradle but not yet complete.\nfor now added .jar to zipfilesystem to avoid FileSystemNotFoundException and\nthen avoided introspection as if a gradle project.\nBut then hitting that appmodel is null.", "createdAt": "2020-08-23T01:26:12Z", "url": "https://github.com/quarkusio/quarkus/pull/11542", "merged": true, "mergeCommit": {"oid": "af6dd4b2ebb8478f007ef31bafd0bfca96d0b988"}, "closed": true, "closedAt": "2020-08-29T12:17:11Z", "author": {"login": "maxandersen"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDcvZNgBqjM3MDU4MjU5Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDjH-oABqjM3MDYyMTc5OTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8696209663be4d7e10443da4827a446380e23a2e", "author": {"user": {"login": "maxandersen", "name": "Max Rydahl Andersen"}}, "url": "https://github.com/quarkusio/quarkus/commit/8696209663be4d7e10443da4827a446380e23a2e", "committedDate": "2020-08-28T22:18:25Z", "message": "Merge branch 'master' into jbangenabled"}, "afterCommit": {"oid": "2d66517db48a7843421e77d1f2daabddcfd05ee0", "author": {"user": {"login": "maxandersen", "name": "Max Rydahl Andersen"}}, "url": "https://github.com/quarkusio/quarkus/commit/2d66517db48a7843421e77d1f2daabddcfd05ee0", "committedDate": "2020-08-28T22:15:13Z", "message": "formatting fixes and pass launch argument hints back"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDU1NDc5", "url": "https://github.com/quarkusio/quarkus/pull/11542#pullrequestreview-478055479", "createdAt": "2020-08-28T22:26:14Z", "commit": {"oid": "8696209663be4d7e10443da4827a446380e23a2e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMjoyNjoxNFrOHJV-5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMjoyNzo0NlrOHJWAeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU1OTM5OQ==", "bodyText": "Avoid star imports", "url": "https://github.com/quarkusio/quarkus/pull/11542#discussion_r479559399", "createdAt": "2020-08-28T22:26:14Z", "author": {"login": "gastaldi"}, "path": "core/deployment/src/main/java/io/quarkus/deployment/jbang/JBangAugmentorImpl.java", "diffHunk": "@@ -0,0 +1,156 @@\n+package io.quarkus.deployment.jbang;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8696209663be4d7e10443da4827a446380e23a2e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU1OTgwMQ==", "bodyText": "This snippet locks the JAR file in Windows.", "url": "https://github.com/quarkusio/quarkus/pull/11542#discussion_r479559801", "createdAt": "2020-08-28T22:27:46Z", "author": {"login": "gastaldi"}, "path": "core/launcher/src/main/java/io/quarkus/launcher/QuarkusLauncher.java", "diffHunk": "@@ -33,7 +31,14 @@ public static void launch(String callingClass, String quarkusApplication, Consum\n             path = path.substring(0, path.length() - classResource.length());\n             URL newResource = new URL(resource.getProtocol(), resource.getHost(), resource.getPort(), path);\n \n-            Path appClasses = Paths.get(newResource.toURI());\n+            URI uri = newResource.toURI();\n+            Path appClasses;\n+            if (\"jar\".equals(uri.getScheme())) {\n+                JarURLConnection connection = (JarURLConnection) uri.toURL().openConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8696209663be4d7e10443da4827a446380e23a2e"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d66517db48a7843421e77d1f2daabddcfd05ee0", "author": {"user": {"login": "maxandersen", "name": "Max Rydahl Andersen"}}, "url": "https://github.com/quarkusio/quarkus/commit/2d66517db48a7843421e77d1f2daabddcfd05ee0", "committedDate": "2020-08-28T22:15:13Z", "message": "formatting fixes and pass launch argument hints back"}, "afterCommit": {"oid": "ad0988d2aba56c5c29fb4505d2ee7cfeed7648e8", "author": {"user": {"login": "maxandersen", "name": "Max Rydahl Andersen"}}, "url": "https://github.com/quarkusio/quarkus/commit/ad0988d2aba56c5c29fb4505d2ee7cfeed7648e8", "committedDate": "2020-08-28T22:28:36Z", "message": "formatting fixes and pass launch argument hints back"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac11203e9363db9c7a6b3158acdeeb2fadb74626", "author": {"user": {"login": "maxandersen", "name": "Max Rydahl Andersen"}}, "url": "https://github.com/quarkusio/quarkus/commit/ac11203e9363db9c7a6b3158acdeeb2fadb74626", "committedDate": "2020-08-28T23:04:48Z", "message": "disable jarurlconnection caching"}, "afterCommit": {"oid": "bc977040b33480ba853539b3453adbbe364f196e", "author": {"user": {"login": "maxandersen", "name": "Max Rydahl Andersen"}}, "url": "https://github.com/quarkusio/quarkus/commit/bc977040b33480ba853539b3453adbbe364f196e", "committedDate": "2020-08-29T05:47:04Z", "message": "Adding support for jbang integration\n\nDone by implementing jbang experimental\nSPI to let Quarkus participate in the build of a jar\n+ passing //Q:CONFIG in as system properties.\n\nInitial version supports building jar as well as native\nimage via docker.\n\n - various fixes for handling default packages in arc and metrics.\n - fixes a few places of class.forname not honoring TCCL\n - slightly open up appmodel to enable this but still reliant\n   on pom.xml being bundled (future versions shouldn't)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "545eff5efbe34abb1961a47c0ef08662bc844872", "author": {"user": {"login": "maxandersen", "name": "Max Rydahl Andersen"}}, "url": "https://github.com/quarkusio/quarkus/commit/545eff5efbe34abb1961a47c0ef08662bc844872", "committedDate": "2020-08-29T05:52:53Z", "message": "Adding support for jbang integration\n\nDone by implementing jbang experimental\nSPI to let Quarkus participate in the build of a jar\n+ passing //Q:CONFIG in as system properties.\n\nInitial version supports building jar as well as native\nimage via docker.\n\n - various fixes for handling default packages in arc and metrics.\n - fixes a few places of class.forname not honoring TCCL\n - slightly open up appmodel to enable this but still reliant\n   on pom.xml being bundled (future versions shouldn't)\n\nCo-Authored: Alexey Loubyansky <olubyans@redhat.com>\nCo-Authored: Stuart Douglas <stuart.w.douglas@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc977040b33480ba853539b3453adbbe364f196e", "author": {"user": {"login": "maxandersen", "name": "Max Rydahl Andersen"}}, "url": "https://github.com/quarkusio/quarkus/commit/bc977040b33480ba853539b3453adbbe364f196e", "committedDate": "2020-08-29T05:47:04Z", "message": "Adding support for jbang integration\n\nDone by implementing jbang experimental\nSPI to let Quarkus participate in the build of a jar\n+ passing //Q:CONFIG in as system properties.\n\nInitial version supports building jar as well as native\nimage via docker.\n\n - various fixes for handling default packages in arc and metrics.\n - fixes a few places of class.forname not honoring TCCL\n - slightly open up appmodel to enable this but still reliant\n   on pom.xml being bundled (future versions shouldn't)"}, "afterCommit": {"oid": "545eff5efbe34abb1961a47c0ef08662bc844872", "author": {"user": {"login": "maxandersen", "name": "Max Rydahl Andersen"}}, "url": "https://github.com/quarkusio/quarkus/commit/545eff5efbe34abb1961a47c0ef08662bc844872", "committedDate": "2020-08-29T05:52:53Z", "message": "Adding support for jbang integration\n\nDone by implementing jbang experimental\nSPI to let Quarkus participate in the build of a jar\n+ passing //Q:CONFIG in as system properties.\n\nInitial version supports building jar as well as native\nimage via docker.\n\n - various fixes for handling default packages in arc and metrics.\n - fixes a few places of class.forname not honoring TCCL\n - slightly open up appmodel to enable this but still reliant\n   on pom.xml being bundled (future versions shouldn't)\n\nCo-Authored: Alexey Loubyansky <olubyans@redhat.com>\nCo-Authored: Stuart Douglas <stuart.w.douglas@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 874, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}