{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2OTc5OTYw", "number": 11772, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMDoyOTozNlrOEe17Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMDozNzowM1rOEe2E2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNzc2MjM0OnYy", "diffSide": "RIGHT", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfigPersistenceUnit.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMDoyOTozNlrOHKwPkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQwNjowMDo0MVrOHNmn2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAzODIyNQ==", "bodyText": "@michael-schnell @Sanne I'm not entirely sure this is useful now that we can define a datasource for a PU. Or in the case of the schema do you want to use another datasource when the tenant is defined?", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481038225", "createdAt": "2020-09-01T10:29:36Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfigPersistenceUnit.java", "diffHunk": "@@ -149,16 +149,40 @@\n     @ConfigItem(defaultValue = \"true\")\n     public boolean secondLevelCachingEnabled;\n \n+    /**\n+     * Defines the method for multi-tenancy (DATABASE, NONE, SCHEMA). The complete list of allowed values is available in the\n+     * https://docs.jboss.org/hibernate/stable/orm/javadocs/org/hibernate/MultiTenancyStrategy.html[Hibernate ORM JavaDoc].\n+     * The type DISCRIMINATOR is currently not supported. The default value is NONE (no multi-tenancy).\n+     *\n+     * @asciidoclet\n+     */\n+    @ConfigItem\n+    public Optional<String> multitenant;\n+\n+    /**\n+     * Defines the name of the datasource to use in case of SCHEMA approach. The datasource of the persistence unit will be used\n+     * if not set.\n+     */\n+    @ConfigItem\n+    public Optional<String> multitenantSchemaDatasource;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA3MTkyMA==", "bodyText": "AFAICT there is actually zero difference between SCHEMA and DATABASE in Hibernate multitenancy, so I don't think you need two things.", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481071920", "createdAt": "2020-09-01T11:36:58Z", "author": {"login": "gavinking"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfigPersistenceUnit.java", "diffHunk": "@@ -149,16 +149,40 @@\n     @ConfigItem(defaultValue = \"true\")\n     public boolean secondLevelCachingEnabled;\n \n+    /**\n+     * Defines the method for multi-tenancy (DATABASE, NONE, SCHEMA). The complete list of allowed values is available in the\n+     * https://docs.jboss.org/hibernate/stable/orm/javadocs/org/hibernate/MultiTenancyStrategy.html[Hibernate ORM JavaDoc].\n+     * The type DISCRIMINATOR is currently not supported. The default value is NONE (no multi-tenancy).\n+     *\n+     * @asciidoclet\n+     */\n+    @ConfigItem\n+    public Optional<String> multitenant;\n+\n+    /**\n+     * Defines the name of the datasource to use in case of SCHEMA approach. The datasource of the persistence unit will be used\n+     * if not set.\n+     */\n+    @ConfigItem\n+    public Optional<String> multitenantSchemaDatasource;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAzODIyNQ=="}, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA5ODI3Nw==", "bodyText": "I don't know about Hibernate ORM but it makes a difference here as things are handled in the Quarkus extension. I'm unclear though if we really want this.\nI agree this needs more discussions and thoughts.", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481098277", "createdAt": "2020-09-01T12:26:54Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfigPersistenceUnit.java", "diffHunk": "@@ -149,16 +149,40 @@\n     @ConfigItem(defaultValue = \"true\")\n     public boolean secondLevelCachingEnabled;\n \n+    /**\n+     * Defines the method for multi-tenancy (DATABASE, NONE, SCHEMA). The complete list of allowed values is available in the\n+     * https://docs.jboss.org/hibernate/stable/orm/javadocs/org/hibernate/MultiTenancyStrategy.html[Hibernate ORM JavaDoc].\n+     * The type DISCRIMINATOR is currently not supported. The default value is NONE (no multi-tenancy).\n+     *\n+     * @asciidoclet\n+     */\n+    @ConfigItem\n+    public Optional<String> multitenant;\n+\n+    /**\n+     * Defines the name of the datasource to use in case of SCHEMA approach. The datasource of the persistence unit will be used\n+     * if not set.\n+     */\n+    @ConfigItem\n+    public Optional<String> multitenantSchemaDatasource;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAzODIyNQ=="}, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyNjMyOQ==", "bodyText": "There might not be a difference within Hibernatate between SCHEMA and DATABASE, but there is one if you need to generate to database schema with Flyway.", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r484026329", "createdAt": "2020-09-06T06:00:41Z", "author": {"login": "michael-schnell"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmConfigPersistenceUnit.java", "diffHunk": "@@ -149,16 +149,40 @@\n     @ConfigItem(defaultValue = \"true\")\n     public boolean secondLevelCachingEnabled;\n \n+    /**\n+     * Defines the method for multi-tenancy (DATABASE, NONE, SCHEMA). The complete list of allowed values is available in the\n+     * https://docs.jboss.org/hibernate/stable/orm/javadocs/org/hibernate/MultiTenancyStrategy.html[Hibernate ORM JavaDoc].\n+     * The type DISCRIMINATOR is currently not supported. The default value is NONE (no multi-tenancy).\n+     *\n+     * @asciidoclet\n+     */\n+    @ConfigItem\n+    public Optional<String> multitenant;\n+\n+    /**\n+     * Defines the name of the datasource to use in case of SCHEMA approach. The datasource of the persistence unit will be used\n+     * if not set.\n+     */\n+    @ConfigItem\n+    public Optional<String> multitenantSchemaDatasource;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAzODIyNQ=="}, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNzc2NDY0OnYy", "diffSide": "RIGHT", "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/tenant/DataSourceTenantConnectionResolver.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMDozMDoxOFrOHKwQ9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMDozMDoxOFrOHKwQ9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAzODU4Mw==", "bodyText": "@michael-schnell @Sanne I'm not sure I understand the need to somehow copy the existing datasource?", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481038583", "createdAt": "2020-09-01T10:30:18Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/tenant/DataSourceTenantConnectionResolver.java", "diffHunk": "@@ -25,73 +23,90 @@\n  * @author Michael Schnell\n  *\n  */\n-@DefaultBean\n-@ApplicationScoped\n public class DataSourceTenantConnectionResolver implements TenantConnectionResolver {\n \n     private static final Logger LOG = Logger.getLogger(DataSourceTenantConnectionResolver.class);\n \n-    @Inject\n-    JPAConfig jpaConfig;\n+    private String persistenceUnitName;\n+\n+    private String dataSourceName;\n+\n+    private MultiTenancyStrategy multiTenancyStrategy;\n+\n+    private String multiTenancySchemaDataSourceName;\n+\n+    public DataSourceTenantConnectionResolver() {\n+    }\n+\n+    public DataSourceTenantConnectionResolver(String persistenceUnitName, String dataSourceName,\n+            MultiTenancyStrategy multiTenancyStrategy, String multiTenancySchemaDataSourceName) {\n+        this.persistenceUnitName = persistenceUnitName;\n+        this.dataSourceName = dataSourceName;\n+        this.multiTenancyStrategy = multiTenancyStrategy;\n+        this.multiTenancySchemaDataSourceName = multiTenancySchemaDataSourceName;\n+    }\n \n     @Override\n     public ConnectionProvider resolve(String tenantId) {\n+        LOG.debugv(\"resolve((persistenceUnitName={0}, tenantIdentifier={1})\", persistenceUnitName, tenantId);\n+        LOG.debugv(\"multitenancy strategy: {0}\", multiTenancyStrategy);\n \n-        LOG.debugv(\"resolve({0})\", tenantId);\n-\n-        final MultiTenancyStrategy strategy = jpaConfig.getMultiTenancyStrategy();\n-        LOG.debugv(\"multitenancy strategy: {0}\", strategy);\n-        AgroalDataSource dataSource = tenantDataSource(jpaConfig, tenantId, strategy);\n+        AgroalDataSource dataSource = tenantDataSource(dataSourceName, tenantId, multiTenancyStrategy,\n+                multiTenancySchemaDataSourceName);\n         if (dataSource == null) {\n-            throw new IllegalStateException(\"No instance of datasource found for tenant: \" + tenantId);\n+            throw new IllegalStateException(\n+                    String.format(\"No instance of datasource found for persistence unit '%1$s' and tenant '%2$s'\",\n+                            persistenceUnitName, tenantId));\n         }\n-        if (strategy == MultiTenancyStrategy.SCHEMA) {\n-            return new TenantConnectionProvider(tenantId, dataSource);\n+        if (multiTenancyStrategy == MultiTenancyStrategy.SCHEMA) {\n+            return new SchemaTenantConnectionProvider(tenantId, dataSource);\n         }\n         return new QuarkusConnectionProvider(dataSource);\n     }\n \n     /**\n      * Create a new data source from the given configuration.\n-     * \n+     *\n      * @param config Configuration to use.\n-     * \n+     *\n      * @return New data source instance.\n      */\n     private static AgroalDataSource createFrom(AgroalDataSourceConfiguration config) {\n         try {\n             return AgroalDataSource.from(config);\n         } catch (SQLException ex) {\n-            throw new IllegalStateException(\"Failed to create a new data source based on the default config\", ex);\n+            throw new IllegalStateException(\"Failed to create a new data source based on the existing datasource configuration\",\n+                    ex);\n         }\n     }\n \n-    /**\n-     * Returns either the default data source or the tenant specific one.\n-     * \n-     * @param tenantId Tenant identifier. The value is required (non-{@literal null}) in case of\n-     *        {@link MultiTenancyStrategy#DATABASE}.\n-     * @param strategy Current multitenancy strategy Required value that cannot be {@literal null}.\n-     * \n-     * @return Data source.\n-     */\n-    private static AgroalDataSource tenantDataSource(JPAConfig jpaConfig, String tenantId, MultiTenancyStrategy strategy) {\n+    private static AgroalDataSource tenantDataSource(String dataSourceName, String tenantId, MultiTenancyStrategy strategy,\n+            String multiTenancySchemaDataSourceName) {\n         if (strategy != MultiTenancyStrategy.SCHEMA) {\n             return Arc.container().instance(AgroalDataSource.class, new DataSource.DataSourceLiteral(tenantId)).get();\n         }\n-        String dataSourceName = jpaConfig.getMultiTenancySchemaDataSource();\n-        if (dataSourceName == null) {\n-            AgroalDataSource dataSource = Arc.container().instance(AgroalDataSource.class).get();\n+\n+        if (multiTenancySchemaDataSourceName == null) {\n+            AgroalDataSource dataSource = getDataSource(dataSourceName);\n             return createFrom(dataSource.getConfiguration());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNzc4NzE0OnYy", "diffSide": "RIGHT", "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMDozNzowM1rOHKweWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMTowNzoxMVrOHKxZCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0MjAwOQ==", "bodyText": "Shouldn't this be \"name\"?", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481042009", "createdAt": "2020-09-01T10:37:03Z", "author": {"login": "geoand"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -504,6 +504,39 @@ public void startPersistenceUnits(HibernateOrmRecorder recorder, BeanContainerBu\n         recorder.startAllPersistenceUnits(beanContainer.getValue());\n     }\n \n+    @BuildStep\n+    @Record(RUNTIME_INIT)\n+    public void multitenancy(HibernateOrmRecorder recorder,\n+            List<PersistenceUnitDescriptorBuildItem> persistenceUnitDescriptors,\n+            BuildProducer<SyntheticBeanBuildItem> syntheticBeans) {\n+        for (PersistenceUnitDescriptorBuildItem persistenceUnitDescriptor : persistenceUnitDescriptors) {\n+            if (persistenceUnitDescriptor.getMultiTenancyStrategy() == MultiTenancyStrategy.NONE) {\n+                continue;\n+            }\n+\n+            ExtendedBeanConfigurator configurator = SyntheticBeanBuildItem.configure(DataSourceTenantConnectionResolver.class)\n+                    .scope(ApplicationScoped.class)\n+                    .types(TenantConnectionResolver.class)\n+                    .setRuntimeInit()\n+                    .defaultBean()\n+                    .unremovable()\n+                    .supplier(recorder.dataSourceTenantConnectionResolver(persistenceUnitDescriptor.getPersistenceUnitName(),\n+                            persistenceUnitDescriptor.getDataSource(), persistenceUnitDescriptor.getMultiTenancyStrategy(),\n+                            persistenceUnitDescriptor.getMultiTenancySchemaDataSource()));\n+\n+            if (PersistenceUnitUtil.isDefaultPersistenceUnit(persistenceUnitDescriptor.getPersistenceUnitName())) {\n+                configurator.addQualifier(Default.class);\n+            } else {\n+                configurator.addQualifier().annotation(DotNames.NAMED)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();\n+                configurator.addQualifier().annotation(PersistenceUnit.class)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0Njg2NQ==", "bodyText": "No, this is our own annotation: https://github.com/quarkusio/quarkus/blob/master/extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/PersistenceUnit.java#L39", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481046865", "createdAt": "2020-09-01T10:46:31Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -504,6 +504,39 @@ public void startPersistenceUnits(HibernateOrmRecorder recorder, BeanContainerBu\n         recorder.startAllPersistenceUnits(beanContainer.getValue());\n     }\n \n+    @BuildStep\n+    @Record(RUNTIME_INIT)\n+    public void multitenancy(HibernateOrmRecorder recorder,\n+            List<PersistenceUnitDescriptorBuildItem> persistenceUnitDescriptors,\n+            BuildProducer<SyntheticBeanBuildItem> syntheticBeans) {\n+        for (PersistenceUnitDescriptorBuildItem persistenceUnitDescriptor : persistenceUnitDescriptors) {\n+            if (persistenceUnitDescriptor.getMultiTenancyStrategy() == MultiTenancyStrategy.NONE) {\n+                continue;\n+            }\n+\n+            ExtendedBeanConfigurator configurator = SyntheticBeanBuildItem.configure(DataSourceTenantConnectionResolver.class)\n+                    .scope(ApplicationScoped.class)\n+                    .types(TenantConnectionResolver.class)\n+                    .setRuntimeInit()\n+                    .defaultBean()\n+                    .unremovable()\n+                    .supplier(recorder.dataSourceTenantConnectionResolver(persistenceUnitDescriptor.getPersistenceUnitName(),\n+                            persistenceUnitDescriptor.getDataSource(), persistenceUnitDescriptor.getMultiTenancyStrategy(),\n+                            persistenceUnitDescriptor.getMultiTenancySchemaDataSource()));\n+\n+            if (PersistenceUnitUtil.isDefaultPersistenceUnit(persistenceUnitDescriptor.getPersistenceUnitName())) {\n+                configurator.addQualifier(Default.class);\n+            } else {\n+                configurator.addQualifier().annotation(DotNames.NAMED)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();\n+                configurator.addQualifier().annotation(PersistenceUnit.class)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0MjAwOQ=="}, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0ODM4Nw==", "bodyText": "Ah OK, I thought it was the javax.persistence annotation", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481048387", "createdAt": "2020-09-01T10:49:28Z", "author": {"login": "geoand"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -504,6 +504,39 @@ public void startPersistenceUnits(HibernateOrmRecorder recorder, BeanContainerBu\n         recorder.startAllPersistenceUnits(beanContainer.getValue());\n     }\n \n+    @BuildStep\n+    @Record(RUNTIME_INIT)\n+    public void multitenancy(HibernateOrmRecorder recorder,\n+            List<PersistenceUnitDescriptorBuildItem> persistenceUnitDescriptors,\n+            BuildProducer<SyntheticBeanBuildItem> syntheticBeans) {\n+        for (PersistenceUnitDescriptorBuildItem persistenceUnitDescriptor : persistenceUnitDescriptors) {\n+            if (persistenceUnitDescriptor.getMultiTenancyStrategy() == MultiTenancyStrategy.NONE) {\n+                continue;\n+            }\n+\n+            ExtendedBeanConfigurator configurator = SyntheticBeanBuildItem.configure(DataSourceTenantConnectionResolver.class)\n+                    .scope(ApplicationScoped.class)\n+                    .types(TenantConnectionResolver.class)\n+                    .setRuntimeInit()\n+                    .defaultBean()\n+                    .unremovable()\n+                    .supplier(recorder.dataSourceTenantConnectionResolver(persistenceUnitDescriptor.getPersistenceUnitName(),\n+                            persistenceUnitDescriptor.getDataSource(), persistenceUnitDescriptor.getMultiTenancyStrategy(),\n+                            persistenceUnitDescriptor.getMultiTenancySchemaDataSource()));\n+\n+            if (PersistenceUnitUtil.isDefaultPersistenceUnit(persistenceUnitDescriptor.getPersistenceUnitName())) {\n+                configurator.addQualifier(Default.class);\n+            } else {\n+                configurator.addQualifier().annotation(DotNames.NAMED)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();\n+                configurator.addQualifier().annotation(PersistenceUnit.class)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0MjAwOQ=="}, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA1NTg5Ng==", "bodyText": "I decided against it as they are quite confusing.", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481055896", "createdAt": "2020-09-01T11:04:53Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -504,6 +504,39 @@ public void startPersistenceUnits(HibernateOrmRecorder recorder, BeanContainerBu\n         recorder.startAllPersistenceUnits(beanContainer.getValue());\n     }\n \n+    @BuildStep\n+    @Record(RUNTIME_INIT)\n+    public void multitenancy(HibernateOrmRecorder recorder,\n+            List<PersistenceUnitDescriptorBuildItem> persistenceUnitDescriptors,\n+            BuildProducer<SyntheticBeanBuildItem> syntheticBeans) {\n+        for (PersistenceUnitDescriptorBuildItem persistenceUnitDescriptor : persistenceUnitDescriptors) {\n+            if (persistenceUnitDescriptor.getMultiTenancyStrategy() == MultiTenancyStrategy.NONE) {\n+                continue;\n+            }\n+\n+            ExtendedBeanConfigurator configurator = SyntheticBeanBuildItem.configure(DataSourceTenantConnectionResolver.class)\n+                    .scope(ApplicationScoped.class)\n+                    .types(TenantConnectionResolver.class)\n+                    .setRuntimeInit()\n+                    .defaultBean()\n+                    .unremovable()\n+                    .supplier(recorder.dataSourceTenantConnectionResolver(persistenceUnitDescriptor.getPersistenceUnitName(),\n+                            persistenceUnitDescriptor.getDataSource(), persistenceUnitDescriptor.getMultiTenancyStrategy(),\n+                            persistenceUnitDescriptor.getMultiTenancySchemaDataSource()));\n+\n+            if (PersistenceUnitUtil.isDefaultPersistenceUnit(persistenceUnitDescriptor.getPersistenceUnitName())) {\n+                configurator.addQualifier(Default.class);\n+            } else {\n+                configurator.addQualifier().annotation(DotNames.NAMED)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();\n+                configurator.addQualifier().annotation(PersistenceUnit.class)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0MjAwOQ=="}, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA1NjAxMw==", "bodyText": "And also I needed it to be a qualifier.", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481056013", "createdAt": "2020-09-01T11:05:06Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -504,6 +504,39 @@ public void startPersistenceUnits(HibernateOrmRecorder recorder, BeanContainerBu\n         recorder.startAllPersistenceUnits(beanContainer.getValue());\n     }\n \n+    @BuildStep\n+    @Record(RUNTIME_INIT)\n+    public void multitenancy(HibernateOrmRecorder recorder,\n+            List<PersistenceUnitDescriptorBuildItem> persistenceUnitDescriptors,\n+            BuildProducer<SyntheticBeanBuildItem> syntheticBeans) {\n+        for (PersistenceUnitDescriptorBuildItem persistenceUnitDescriptor : persistenceUnitDescriptors) {\n+            if (persistenceUnitDescriptor.getMultiTenancyStrategy() == MultiTenancyStrategy.NONE) {\n+                continue;\n+            }\n+\n+            ExtendedBeanConfigurator configurator = SyntheticBeanBuildItem.configure(DataSourceTenantConnectionResolver.class)\n+                    .scope(ApplicationScoped.class)\n+                    .types(TenantConnectionResolver.class)\n+                    .setRuntimeInit()\n+                    .defaultBean()\n+                    .unremovable()\n+                    .supplier(recorder.dataSourceTenantConnectionResolver(persistenceUnitDescriptor.getPersistenceUnitName(),\n+                            persistenceUnitDescriptor.getDataSource(), persistenceUnitDescriptor.getMultiTenancyStrategy(),\n+                            persistenceUnitDescriptor.getMultiTenancySchemaDataSource()));\n+\n+            if (PersistenceUnitUtil.isDefaultPersistenceUnit(persistenceUnitDescriptor.getPersistenceUnitName())) {\n+                configurator.addQualifier(Default.class);\n+            } else {\n+                configurator.addQualifier().annotation(DotNames.NAMED)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();\n+                configurator.addQualifier().annotation(PersistenceUnit.class)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0MjAwOQ=="}, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA1NzAzNQ==", "bodyText": "Makes sense", "url": "https://github.com/quarkusio/quarkus/pull/11772#discussion_r481057035", "createdAt": "2020-09-01T11:07:11Z", "author": {"login": "geoand"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -504,6 +504,39 @@ public void startPersistenceUnits(HibernateOrmRecorder recorder, BeanContainerBu\n         recorder.startAllPersistenceUnits(beanContainer.getValue());\n     }\n \n+    @BuildStep\n+    @Record(RUNTIME_INIT)\n+    public void multitenancy(HibernateOrmRecorder recorder,\n+            List<PersistenceUnitDescriptorBuildItem> persistenceUnitDescriptors,\n+            BuildProducer<SyntheticBeanBuildItem> syntheticBeans) {\n+        for (PersistenceUnitDescriptorBuildItem persistenceUnitDescriptor : persistenceUnitDescriptors) {\n+            if (persistenceUnitDescriptor.getMultiTenancyStrategy() == MultiTenancyStrategy.NONE) {\n+                continue;\n+            }\n+\n+            ExtendedBeanConfigurator configurator = SyntheticBeanBuildItem.configure(DataSourceTenantConnectionResolver.class)\n+                    .scope(ApplicationScoped.class)\n+                    .types(TenantConnectionResolver.class)\n+                    .setRuntimeInit()\n+                    .defaultBean()\n+                    .unremovable()\n+                    .supplier(recorder.dataSourceTenantConnectionResolver(persistenceUnitDescriptor.getPersistenceUnitName(),\n+                            persistenceUnitDescriptor.getDataSource(), persistenceUnitDescriptor.getMultiTenancyStrategy(),\n+                            persistenceUnitDescriptor.getMultiTenancySchemaDataSource()));\n+\n+            if (PersistenceUnitUtil.isDefaultPersistenceUnit(persistenceUnitDescriptor.getPersistenceUnitName())) {\n+                configurator.addQualifier(Default.class);\n+            } else {\n+                configurator.addQualifier().annotation(DotNames.NAMED)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();\n+                configurator.addQualifier().annotation(PersistenceUnit.class)\n+                        .addValue(\"value\", persistenceUnitDescriptor.getPersistenceUnitName()).done();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0MjAwOQ=="}, "originalCommit": {"oid": "4a6421fbec78e8cdbbf7e5935ba5c8359d40a02d"}, "originalPosition": 97}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 452, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}