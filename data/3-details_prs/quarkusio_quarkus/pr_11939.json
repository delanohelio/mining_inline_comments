{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMzMyNzAy", "number": 11939, "title": "JSON exporter for Micrometer", "bodyText": "", "createdAt": "2020-09-07T12:07:59Z", "url": "https://github.com/quarkusio/quarkus/pull/11939", "merged": true, "mergeCommit": {"oid": "14507f88b991f77f125eef58e3cec5aafb8be435"}, "closed": true, "closedAt": "2020-09-24T10:59:03Z", "author": {"login": "jmartisk"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGyvMdgBqjM3Mzk1NTc4Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLYkDNAFqTQ5MzQ5ODgyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b97dc27d608868758dbd6ed927643a3a91169184", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/b97dc27d608868758dbd6ed927643a3a91169184", "committedDate": "2020-09-07T11:10:58Z", "message": "JSON exporter for Micrometer"}, "afterCommit": {"oid": "4c02b0498c26a6dd697b6cae106273d3183d8b5a", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/4c02b0498c26a6dd697b6cae106273d3183d8b5a", "committedDate": "2020-09-08T07:47:20Z", "message": "move /metrics-json endpoint to /metrics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c02b0498c26a6dd697b6cae106273d3183d8b5a", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/4c02b0498c26a6dd697b6cae106273d3183d8b5a", "committedDate": "2020-09-08T07:47:20Z", "message": "move /metrics-json endpoint to /metrics"}, "afterCommit": {"oid": "73d5e13ca496c26e8732dc96b7b49819017514a9", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/73d5e13ca496c26e8732dc96b7b49819017514a9", "committedDate": "2020-09-08T07:51:08Z", "message": "move /metrics-json endpoint to /metrics"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73d5e13ca496c26e8732dc96b7b49819017514a9", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/73d5e13ca496c26e8732dc96b7b49819017514a9", "committedDate": "2020-09-08T07:51:08Z", "message": "move /metrics-json endpoint to /metrics"}, "afterCommit": {"oid": "ff7837b90af707fc5795c53f44390bd9c8e72e73", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/ff7837b90af707fc5795c53f44390bd9c8e72e73", "committedDate": "2020-09-08T08:55:12Z", "message": "move /metrics-json endpoint to /metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjM0Mjgw", "url": "https://github.com/quarkusio/quarkus/pull/11939#pullrequestreview-484234280", "createdAt": "2020-09-08T15:03:25Z", "commit": {"oid": "93546ccbb6a589f43dea8e7b7cc15c48126cf4d5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTowMzoyNlrOHOhmbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0OTo0OFrOHOjivQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5MjYyMw==", "bodyText": "You don't need the indirection..\n    gauge = io.micrometer.core.instrument.Gauge.builder(metricInfo.name(), longAdder, LongAdder::doubleValue)", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r484992623", "createdAt": "2020-09-08T15:03:26Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/binder/mpmetrics/ConcurrentGaugeImpl.java", "diffHunk": "@@ -14,7 +15,8 @@\n     Gauge gauge;\n \n     ConcurrentGaugeImpl register(MpMetadata metadata, MetricDescriptor metricInfo, MeterRegistry registry) {\n-        gauge = io.micrometer.core.instrument.Gauge.builder(metricInfo.name(), longAdder::longValue)\n+        ToDoubleFunction<LongAdder> function = LongAdder::doubleValue;\n+        gauge = io.micrometer.core.instrument.Gauge.builder(metricInfo.name(), longAdder, function)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93546ccbb6a589f43dea8e7b7cc15c48126cf4d5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk5OTA3Mg==", "bodyText": "I still am not sure how the two registries are interacting, but I think it is clear that when both are present, the way the json registry observes the value of the gauge causes the prometheus registry value to observe NaN, and that breaks the planet. ;)  Switching over to invoking a method on the object is fine, but we should avoid allocation of ToDoubleFunction for each instance. We could make that lambda a static, or we could use a method on the object:\n    double getDoubleValue() {\n        return getValue().doubleValue();\n    }\n\nand reference that:\n                gauge = io.micrometer.core.instrument.Gauge.builder(metadata.name, this, GaugeAdapterImpl::getDoubleValue)", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r484999072", "createdAt": "2020-09-08T15:12:58Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/binder/mpmetrics/AnnotatedGaugeAdapter.java", "diffHunk": "@@ -52,7 +53,8 @@ public GaugeAdapterImpl(String name, String description, String targetName, Stri\n         public GaugeAdapterImpl register(MetricDescriptor id, MeterRegistry registry) {\n             this.id = id;\n             if (gauge == null || metadata.cleanDirtyMetadata()) {\n-                gauge = io.micrometer.core.instrument.Gauge.builder(metadata.name, this::getValue)\n+                ToDoubleFunction<GaugeAdapterImpl> function = i -> i.getValue().doubleValue();\n+                gauge = io.micrometer.core.instrument.Gauge.builder(metadata.name, this, function)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93546ccbb6a589f43dea8e7b7cc15c48126cf4d5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwMDAwMA==", "bodyText": "Execution of this step should still be guarded as others are.", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r485000000", "createdAt": "2020-09-08T15:14:18Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/deployment/src/main/java/io/quarkus/micrometer/deployment/export/JsonRegistryProcessor.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.micrometer.deployment.export;\n+\n+import org.jboss.logging.Logger;\n+\n+import io.quarkus.arc.deployment.AdditionalBeanBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.annotations.ExecutionTime;\n+import io.quarkus.deployment.annotations.Record;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import io.quarkus.micrometer.deployment.MicrometerRegistryProviderBuildItem;\n+import io.quarkus.micrometer.runtime.config.MicrometerConfig;\n+import io.quarkus.micrometer.runtime.export.JsonMeterRegistryProvider;\n+import io.quarkus.micrometer.runtime.export.JsonRecorder;\n+import io.quarkus.micrometer.runtime.registry.json.JsonMeterRegistry;\n+import io.quarkus.vertx.http.deployment.RouteBuildItem;\n+\n+public class JsonRegistryProcessor {\n+\n+    private static final Logger log = Logger.getLogger(JsonRegistryProcessor.class);\n+\n+    @BuildStep\n+    @Record(ExecutionTime.STATIC_INIT)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93546ccbb6a589f43dea8e7b7cc15c48126cf4d5"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAwMDMwOQ==", "bodyText": "Why is reflection necessary for these classes? I'm missing something", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r485000309", "createdAt": "2020-09-08T15:14:48Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/deployment/src/main/java/io/quarkus/micrometer/deployment/export/JsonRegistryProcessor.java", "diffHunk": "@@ -0,0 +1,46 @@\n+package io.quarkus.micrometer.deployment.export;\n+\n+import org.jboss.logging.Logger;\n+\n+import io.quarkus.arc.deployment.AdditionalBeanBuildItem;\n+import io.quarkus.deployment.annotations.BuildProducer;\n+import io.quarkus.deployment.annotations.BuildStep;\n+import io.quarkus.deployment.annotations.ExecutionTime;\n+import io.quarkus.deployment.annotations.Record;\n+import io.quarkus.deployment.builditem.nativeimage.ReflectiveClassBuildItem;\n+import io.quarkus.micrometer.deployment.MicrometerRegistryProviderBuildItem;\n+import io.quarkus.micrometer.runtime.config.MicrometerConfig;\n+import io.quarkus.micrometer.runtime.export.JsonMeterRegistryProvider;\n+import io.quarkus.micrometer.runtime.export.JsonRecorder;\n+import io.quarkus.micrometer.runtime.registry.json.JsonMeterRegistry;\n+import io.quarkus.vertx.http.deployment.RouteBuildItem;\n+\n+public class JsonRegistryProcessor {\n+\n+    private static final Logger log = Logger.getLogger(JsonRegistryProcessor.class);\n+\n+    @BuildStep\n+    @Record(ExecutionTime.STATIC_INIT)\n+    public void initializeJsonRegistry(MicrometerConfig config,\n+            BuildProducer<MicrometerRegistryProviderBuildItem> registryProviders,\n+            BuildProducer<RouteBuildItem> routes,\n+            BuildProducer<AdditionalBeanBuildItem> additionalBeans,\n+            JsonRecorder recorder,\n+            BuildProducer<ReflectiveClassBuildItem> reflectiveClasses) {\n+        if (config.checkRegistryEnabledWithDefault(config.export.json)) {\n+            additionalBeans.produce(AdditionalBeanBuildItem.builder()\n+                    .addBeanClass(JsonMeterRegistryProvider.class)\n+                    .setUnremovable().build());\n+            registryProviders.produce(new MicrometerRegistryProviderBuildItem(JsonMeterRegistry.class));\n+            routes.produce(new RouteBuildItem(recorder.route(config.export.json.path), recorder.getHandler()));\n+            reflectiveClasses.produce(ReflectiveClassBuildItem\n+                    .builder(\"org.HdrHistogram.Histogram\",\n+                            \"org.HdrHistogram.DoubleHistogram\",\n+                            \"org.HdrHistogram.ConcurrentHistogram\")\n+                    .constructors(true).build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93546ccbb6a589f43dea8e7b7cc15c48126cf4d5"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAxNTcwNQ==", "bodyText": "I would like to understand where these values come from. Negative values don't seem correct for an out-of-the-box default. Can we talk through this?", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r485015705", "createdAt": "2020-09-08T15:36:44Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/registry/json/JsonMeterRegistry.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package io.quarkus.micrometer.runtime.registry.json;\n+\n+import java.time.Duration;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.ToDoubleFunction;\n+import java.util.function.ToLongFunction;\n+\n+import io.micrometer.core.instrument.Clock;\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.DistributionSummary;\n+import io.micrometer.core.instrument.FunctionCounter;\n+import io.micrometer.core.instrument.FunctionTimer;\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.LongTaskTimer;\n+import io.micrometer.core.instrument.Measurement;\n+import io.micrometer.core.instrument.Meter;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Timer;\n+import io.micrometer.core.instrument.cumulative.CumulativeCounter;\n+import io.micrometer.core.instrument.cumulative.CumulativeDistributionSummary;\n+import io.micrometer.core.instrument.cumulative.CumulativeFunctionCounter;\n+import io.micrometer.core.instrument.cumulative.CumulativeFunctionTimer;\n+import io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n+import io.micrometer.core.instrument.distribution.pause.PauseDetector;\n+import io.micrometer.core.instrument.internal.DefaultGauge;\n+import io.micrometer.core.instrument.internal.DefaultMeter;\n+import io.micrometer.core.instrument.noop.NoopLongTaskTimer;\n+\n+/**\n+ * A registry that, when exported, mimics the JSON exporter from MP Metrics 3.0\n+ * as closely as it is reasonable to attempt to.\n+ */\n+public class JsonMeterRegistry extends MeterRegistry {\n+\n+    private final JsonExporter jsonExporter;\n+\n+    public JsonMeterRegistry(Clock clock) {\n+        super(clock);\n+        this.jsonExporter = new JsonExporter();\n+    }\n+\n+    @Override\n+    protected <T> Gauge newGauge(Meter.Id id, T obj, ToDoubleFunction<T> valueFunction) {\n+        return new DefaultGauge<>(id, obj, valueFunction);\n+    }\n+\n+    @Override\n+    protected Counter newCounter(Meter.Id id) {\n+        return new CumulativeCounter(id);\n+    }\n+\n+    @Override\n+    protected Timer newTimer(Meter.Id id, DistributionStatisticConfig distributionStatisticConfig,\n+            PauseDetector pauseDetector) {\n+        // turn off percentiles and histograms because we don't need them for the JSON export\n+        distributionStatisticConfig = DistributionStatisticConfig.builder()\n+                .percentilesHistogram(false)\n+                .percentiles(new double[0])\n+                .build()\n+                .merge(distributionStatisticConfig);\n+        return new JsonTimer(id, clock, distributionStatisticConfig, pauseDetector, getBaseTimeUnit());\n+    }\n+\n+    @Override\n+    protected DistributionSummary newDistributionSummary(Meter.Id id, DistributionStatisticConfig distributionStatisticConfig,\n+            double scale) {\n+        distributionStatisticConfig = DistributionStatisticConfig.builder()\n+                .percentilePrecision(3)\n+                .percentilesHistogram(false)\n+                .minimumExpectedValue(Double.MIN_VALUE)\n+                .maximumExpectedValue(Double.MAX_VALUE)\n+                .bufferLength(1024)\n+                .expiry(Duration.ofDays(3))\n+                .build()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93546ccbb6a589f43dea8e7b7cc15c48126cf4d5"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMzMyNw==", "bodyText": "p50 getSnapshot().getMedian()\np75 getSnapshot().get75thPercentile()\np95 getSnapshot().get95thPercentile()\np98 getSnapshot().get98thPercentile()\np99 getSnapshot().get99thPercentile()\np999 getSnapshot().get999thPercentile()\n?", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r485023327", "createdAt": "2020-09-08T15:48:05Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/registry/json/JsonMeterRegistry.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package io.quarkus.micrometer.runtime.registry.json;\n+\n+import java.time.Duration;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.ToDoubleFunction;\n+import java.util.function.ToLongFunction;\n+\n+import io.micrometer.core.instrument.Clock;\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.DistributionSummary;\n+import io.micrometer.core.instrument.FunctionCounter;\n+import io.micrometer.core.instrument.FunctionTimer;\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.LongTaskTimer;\n+import io.micrometer.core.instrument.Measurement;\n+import io.micrometer.core.instrument.Meter;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Timer;\n+import io.micrometer.core.instrument.cumulative.CumulativeCounter;\n+import io.micrometer.core.instrument.cumulative.CumulativeDistributionSummary;\n+import io.micrometer.core.instrument.cumulative.CumulativeFunctionCounter;\n+import io.micrometer.core.instrument.cumulative.CumulativeFunctionTimer;\n+import io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n+import io.micrometer.core.instrument.distribution.pause.PauseDetector;\n+import io.micrometer.core.instrument.internal.DefaultGauge;\n+import io.micrometer.core.instrument.internal.DefaultMeter;\n+import io.micrometer.core.instrument.noop.NoopLongTaskTimer;\n+\n+/**\n+ * A registry that, when exported, mimics the JSON exporter from MP Metrics 3.0\n+ * as closely as it is reasonable to attempt to.\n+ */\n+public class JsonMeterRegistry extends MeterRegistry {\n+\n+    private final JsonExporter jsonExporter;\n+\n+    public JsonMeterRegistry(Clock clock) {\n+        super(clock);\n+        this.jsonExporter = new JsonExporter();\n+    }\n+\n+    @Override\n+    protected <T> Gauge newGauge(Meter.Id id, T obj, ToDoubleFunction<T> valueFunction) {\n+        return new DefaultGauge<>(id, obj, valueFunction);\n+    }\n+\n+    @Override\n+    protected Counter newCounter(Meter.Id id) {\n+        return new CumulativeCounter(id);\n+    }\n+\n+    @Override\n+    protected Timer newTimer(Meter.Id id, DistributionStatisticConfig distributionStatisticConfig,\n+            PauseDetector pauseDetector) {\n+        // turn off percentiles and histograms because we don't need them for the JSON export\n+        distributionStatisticConfig = DistributionStatisticConfig.builder()\n+                .percentilesHistogram(false)\n+                .percentiles(new double[0])\n+                .build()\n+                .merge(distributionStatisticConfig);\n+        return new JsonTimer(id, clock, distributionStatisticConfig, pauseDetector, getBaseTimeUnit());\n+    }\n+\n+    @Override\n+    protected DistributionSummary newDistributionSummary(Meter.Id id, DistributionStatisticConfig distributionStatisticConfig,\n+            double scale) {\n+        distributionStatisticConfig = DistributionStatisticConfig.builder()\n+                .percentilePrecision(3)\n+                .percentilesHistogram(false)\n+                .minimumExpectedValue(Double.MIN_VALUE)\n+                .maximumExpectedValue(Double.MAX_VALUE)\n+                .bufferLength(1024)\n+                .expiry(Duration.ofDays(3))\n+                .build()\n+                .merge(distributionStatisticConfig);\n+        return new CumulativeDistributionSummary(id, clock, distributionStatisticConfig, scale, false);\n+    }\n+\n+    @Override\n+    protected Meter newMeter(Meter.Id id, Meter.Type type, Iterable<Measurement> measurements) {\n+        return new DefaultMeter(id, type, measurements);\n+    }\n+\n+    @Override\n+    protected <T> FunctionTimer newFunctionTimer(Meter.Id id, T obj, ToLongFunction<T> countFunction,\n+            ToDoubleFunction<T> totalTimeFunction, TimeUnit totalTimeFunctionUnit) {\n+        return new CumulativeFunctionTimer<>(id, obj, countFunction, totalTimeFunction,\n+                totalTimeFunctionUnit, getBaseTimeUnit());\n+    }\n+\n+    @Override\n+    protected <T> FunctionCounter newFunctionCounter(Meter.Id id, T obj, ToDoubleFunction<T> countFunction) {\n+        return new CumulativeFunctionCounter<>(id, obj, countFunction);\n+    }\n+\n+    @Override\n+    protected LongTaskTimer newLongTaskTimer(Meter.Id id, DistributionStatisticConfig distributionStatisticConfig) {\n+        return new NoopLongTaskTimer(id);\n+    }\n+\n+    @Override\n+    protected TimeUnit getBaseTimeUnit() {\n+        return TimeUnit.MILLISECONDS;\n+    }\n+\n+    @Override\n+    protected DistributionStatisticConfig defaultHistogramConfig() {\n+        return DistributionStatisticConfig.builder()\n+                .percentiles(0.5, 0.75, 0.95, 0.98, 0.99)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93546ccbb6a589f43dea8e7b7cc15c48126cf4d5"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyNDQ0NQ==", "bodyText": "One thing we could consider is not publishing the percentiles by default (but publish the other calculations), and rely on the usual MeterFilter behavior for users to turn those on.. the memory implications for using histograms isn't trivial.", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r485024445", "createdAt": "2020-09-08T15:49:48Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/registry/json/JsonMeterRegistry.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package io.quarkus.micrometer.runtime.registry.json;\n+\n+import java.time.Duration;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.ToDoubleFunction;\n+import java.util.function.ToLongFunction;\n+\n+import io.micrometer.core.instrument.Clock;\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.DistributionSummary;\n+import io.micrometer.core.instrument.FunctionCounter;\n+import io.micrometer.core.instrument.FunctionTimer;\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.LongTaskTimer;\n+import io.micrometer.core.instrument.Measurement;\n+import io.micrometer.core.instrument.Meter;\n+import io.micrometer.core.instrument.MeterRegistry;\n+import io.micrometer.core.instrument.Timer;\n+import io.micrometer.core.instrument.cumulative.CumulativeCounter;\n+import io.micrometer.core.instrument.cumulative.CumulativeDistributionSummary;\n+import io.micrometer.core.instrument.cumulative.CumulativeFunctionCounter;\n+import io.micrometer.core.instrument.cumulative.CumulativeFunctionTimer;\n+import io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n+import io.micrometer.core.instrument.distribution.pause.PauseDetector;\n+import io.micrometer.core.instrument.internal.DefaultGauge;\n+import io.micrometer.core.instrument.internal.DefaultMeter;\n+import io.micrometer.core.instrument.noop.NoopLongTaskTimer;\n+\n+/**\n+ * A registry that, when exported, mimics the JSON exporter from MP Metrics 3.0\n+ * as closely as it is reasonable to attempt to.\n+ */\n+public class JsonMeterRegistry extends MeterRegistry {\n+\n+    private final JsonExporter jsonExporter;\n+\n+    public JsonMeterRegistry(Clock clock) {\n+        super(clock);\n+        this.jsonExporter = new JsonExporter();\n+    }\n+\n+    @Override\n+    protected <T> Gauge newGauge(Meter.Id id, T obj, ToDoubleFunction<T> valueFunction) {\n+        return new DefaultGauge<>(id, obj, valueFunction);\n+    }\n+\n+    @Override\n+    protected Counter newCounter(Meter.Id id) {\n+        return new CumulativeCounter(id);\n+    }\n+\n+    @Override\n+    protected Timer newTimer(Meter.Id id, DistributionStatisticConfig distributionStatisticConfig,\n+            PauseDetector pauseDetector) {\n+        // turn off percentiles and histograms because we don't need them for the JSON export\n+        distributionStatisticConfig = DistributionStatisticConfig.builder()\n+                .percentilesHistogram(false)\n+                .percentiles(new double[0])\n+                .build()\n+                .merge(distributionStatisticConfig);\n+        return new JsonTimer(id, clock, distributionStatisticConfig, pauseDetector, getBaseTimeUnit());\n+    }\n+\n+    @Override\n+    protected DistributionSummary newDistributionSummary(Meter.Id id, DistributionStatisticConfig distributionStatisticConfig,\n+            double scale) {\n+        distributionStatisticConfig = DistributionStatisticConfig.builder()\n+                .percentilePrecision(3)\n+                .percentilesHistogram(false)\n+                .minimumExpectedValue(Double.MIN_VALUE)\n+                .maximumExpectedValue(Double.MAX_VALUE)\n+                .bufferLength(1024)\n+                .expiry(Duration.ofDays(3))\n+                .build()\n+                .merge(distributionStatisticConfig);\n+        return new CumulativeDistributionSummary(id, clock, distributionStatisticConfig, scale, false);\n+    }\n+\n+    @Override\n+    protected Meter newMeter(Meter.Id id, Meter.Type type, Iterable<Measurement> measurements) {\n+        return new DefaultMeter(id, type, measurements);\n+    }\n+\n+    @Override\n+    protected <T> FunctionTimer newFunctionTimer(Meter.Id id, T obj, ToLongFunction<T> countFunction,\n+            ToDoubleFunction<T> totalTimeFunction, TimeUnit totalTimeFunctionUnit) {\n+        return new CumulativeFunctionTimer<>(id, obj, countFunction, totalTimeFunction,\n+                totalTimeFunctionUnit, getBaseTimeUnit());\n+    }\n+\n+    @Override\n+    protected <T> FunctionCounter newFunctionCounter(Meter.Id id, T obj, ToDoubleFunction<T> countFunction) {\n+        return new CumulativeFunctionCounter<>(id, obj, countFunction);\n+    }\n+\n+    @Override\n+    protected LongTaskTimer newLongTaskTimer(Meter.Id id, DistributionStatisticConfig distributionStatisticConfig) {\n+        return new NoopLongTaskTimer(id);\n+    }\n+\n+    @Override\n+    protected TimeUnit getBaseTimeUnit() {\n+        return TimeUnit.MILLISECONDS;\n+    }\n+\n+    @Override\n+    protected DistributionStatisticConfig defaultHistogramConfig() {\n+        return DistributionStatisticConfig.builder()\n+                .percentiles(0.5, 0.75, 0.95, 0.98, 0.99)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMzMyNw=="}, "originalCommit": {"oid": "93546ccbb6a589f43dea8e7b7cc15c48126cf4d5"}, "originalPosition": 109}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93546ccbb6a589f43dea8e7b7cc15c48126cf4d5", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/93546ccbb6a589f43dea8e7b7cc15c48126cf4d5", "committedDate": "2020-09-08T10:54:59Z", "message": "use jakarta.json dependency only"}, "afterCommit": {"oid": "b6243833b35aab2285598db908875374bfb2ee58", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/b6243833b35aab2285598db908875374bfb2ee58", "committedDate": "2020-09-09T05:36:40Z", "message": "avoid instantiating ToDoubleFunction unnecessarily"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6243833b35aab2285598db908875374bfb2ee58", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/b6243833b35aab2285598db908875374bfb2ee58", "committedDate": "2020-09-09T05:36:40Z", "message": "avoid instantiating ToDoubleFunction unnecessarily"}, "afterCommit": {"oid": "6af0a4b5916ce4763221145bd460f33a6ec764e2", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/6af0a4b5916ce4763221145bd460f33a6ec764e2", "committedDate": "2020-09-09T06:07:39Z", "message": "Add 99.9th percentile"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MzY5OTQx", "url": "https://github.com/quarkusio/quarkus/pull/11939#pullrequestreview-485369941", "createdAt": "2020-09-09T20:14:42Z", "commit": {"oid": "2cb39c6076aedab11675e4d0747bb7e8942f7082"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDoxNDo0MlrOHPYtkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDoxNDo0MlrOHPYtkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg5NTU3MQ==", "bodyText": "Given what this does (retrieve from collection effectively retrieves from the stream repeatedly), I think you should rejigger this to use the match function on the Meter interface as is done here:\nhttps://github.com/micrometer-metrics/micrometer/blob/master/implementations/micrometer-registry-appoptics/src/main/java/io/micrometer/appoptics/AppOpticsMeterRegistry.java#L98\n(most other registries do this as well).\nGives you a one time loop through everything that you can use to initialize those collections with what you need, and then you can emit the lot at the end.", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r485895571", "createdAt": "2020-09-09T20:14:42Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/registry/json/JsonExporter.java", "diffHunk": "@@ -0,0 +1,173 @@\n+/*\n+ * Copyright 2017 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.quarkus.micrometer.runtime.registry.json;\n+\n+import java.io.StringWriter;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.json.JsonObject;\n+import javax.json.JsonObjectBuilder;\n+import javax.json.JsonValue;\n+import javax.json.JsonWriter;\n+import javax.json.spi.JsonProvider;\n+import javax.json.stream.JsonGenerator;\n+\n+import io.micrometer.core.instrument.Counter;\n+import io.micrometer.core.instrument.DistributionSummary;\n+import io.micrometer.core.instrument.FunctionCounter;\n+import io.micrometer.core.instrument.FunctionTimer;\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.Meter;\n+import io.micrometer.core.instrument.Tag;\n+import io.micrometer.core.instrument.Timer;\n+import io.micrometer.core.instrument.distribution.HistogramSnapshot;\n+import io.micrometer.core.instrument.distribution.ValueAtPercentile;\n+\n+public class JsonExporter {\n+\n+    private static final Map<String, ?> JSON_CONFIG = Collections.singletonMap(JsonGenerator.PRETTY_PRINTING, true);\n+    private static final JsonProvider JSON_PROVIDER = JsonProvider.provider();\n+\n+    public JsonExporter() {\n+    }\n+\n+    public StringBuilder exportEverything(JsonMeterRegistry meterRegistry) {\n+        JsonObjectBuilder root = JSON_PROVIDER.createObjectBuilder();\n+        exportCounters(retrieveFromCollection(Counter.class, meterRegistry)).forEach(root::add);\n+        exportGauges(retrieveFromCollection(Gauge.class, meterRegistry)).forEach(root::add);\n+        exportFunctionCounters(retrieveFromCollection(FunctionCounter.class, meterRegistry)).forEach(root::add);\n+        exportTimers(retrieveFromCollection(Timer.class, meterRegistry)).forEach(root::add);\n+        exportFunctionTimers(retrieveFromCollection(FunctionTimer.class, meterRegistry)).forEach(root::add);\n+        exportDistributionSummaries(retrieveFromCollection(DistributionSummary.class, meterRegistry)).forEach(root::add);\n+        return stringify(root.build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cb39c6076aedab11675e4d0747bb7e8942f7082"}, "originalPosition": 62}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2cb39c6076aedab11675e4d0747bb7e8942f7082", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/2cb39c6076aedab11675e4d0747bb7e8942f7082", "committedDate": "2020-09-09T09:47:05Z", "message": "guard the processor method with onlyIf"}, "afterCommit": {"oid": "f74bb82f39880104df1fef85d473531ff5eef48c", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/f74bb82f39880104df1fef85d473531ff5eef48c", "committedDate": "2020-09-14T07:13:25Z", "message": "improve meter iteration in the exporter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f74bb82f39880104df1fef85d473531ff5eef48c", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/f74bb82f39880104df1fef85d473531ff5eef48c", "committedDate": "2020-09-14T07:13:25Z", "message": "improve meter iteration in the exporter"}, "afterCommit": {"oid": "af139822b20d95c50547457ca85ee83150ff6878", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/af139822b20d95c50547457ca85ee83150ff6878", "committedDate": "2020-09-15T08:56:31Z", "message": "make bufferLength and expiry configurable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NzI1NzQ3", "url": "https://github.com/quarkusio/quarkus/pull/11939#pullrequestreview-489725747", "createdAt": "2020-09-16T15:07:41Z", "commit": {"oid": "af139822b20d95c50547457ca85ee83150ff6878"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNTowNzo0MlrOHS1e7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNTowNzo0MlrOHS1e7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxMjY4NA==", "bodyText": "Not sure the configureJsonRegistry or object vars are necessary?\n    @Produces\n    @Singleton\n    public JsonMeterRegistry registry(Clock clock, Config config) {\n        return new JsonMeterRegistry(clock, config.export.json.bufferLength, config.export.json.expiry);\n    }\n\nThat should just work (injection of microprofile config)?", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r489512684", "createdAt": "2020-09-16T15:07:42Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/export/JsonMeterRegistryProvider.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package io.quarkus.micrometer.runtime.export;\n+\n+import java.time.Duration;\n+\n+import javax.enterprise.inject.Produces;\n+import javax.inject.Singleton;\n+\n+import io.micrometer.core.instrument.Clock;\n+import io.quarkus.micrometer.runtime.registry.json.JsonMeterRegistry;\n+\n+@Singleton\n+public class JsonMeterRegistryProvider {\n+\n+    private Integer bufferLength;\n+    private Duration expiry;\n+\n+    @Produces\n+    @Singleton\n+    public JsonMeterRegistry registry(Clock clock) {\n+        return new JsonMeterRegistry(clock, bufferLength, expiry);\n+    }\n+\n+    public void configureJsonRegistry(Integer bufferLength, Duration expiry) {\n+        this.bufferLength = bufferLength;\n+        this.expiry = expiry;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af139822b20d95c50547457ca85ee83150ff6878"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NzI2MTA5", "url": "https://github.com/quarkusio/quarkus/pull/11939#pullrequestreview-489726109", "createdAt": "2020-09-16T15:08:03Z", "commit": {"oid": "af139822b20d95c50547457ca85ee83150ff6878"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNTowODowM1rOHS1gDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNTowODowM1rOHS1gDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxMjk3Mg==", "bodyText": "See other comment -- not sure why this step is necessary.", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r489512972", "createdAt": "2020-09-16T15:08:03Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/export/JsonRecorder.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package io.quarkus.micrometer.runtime.export;\n+\n+import java.util.function.Function;\n+\n+import io.quarkus.arc.runtime.BeanContainer;\n+import io.quarkus.micrometer.runtime.config.MicrometerConfig;\n+import io.quarkus.micrometer.runtime.export.handlers.JsonHandler;\n+import io.quarkus.runtime.annotations.Recorder;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+@Recorder\n+public class JsonRecorder {\n+    JsonHandler handler;\n+\n+    public JsonHandler getHandler() {\n+        if (handler == null) {\n+            handler = new JsonHandler();\n+        }\n+\n+        return handler;\n+    }\n+\n+    public void configureJsonRegistry(MicrometerConfig config, BeanContainer beanContainer) {\n+        beanContainer\n+                .instance(JsonMeterRegistryProvider.class)\n+                .configureJsonRegistry(config.export.json.bufferLength, config.export.json.expiry);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af139822b20d95c50547457ca85ee83150ff6878"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NzI3MDMy", "url": "https://github.com/quarkusio/quarkus/pull/11939#pullrequestreview-489727032", "createdAt": "2020-09-16T15:08:57Z", "commit": {"oid": "af139822b20d95c50547457ca85ee83150ff6878"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNTowODo1N1rOHS1iqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNTowODo1N1rOHS1iqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxMzY0MQ==", "bodyText": "WOOHOO! =)", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r489513641", "createdAt": "2020-09-16T15:08:57Z", "author": {"login": "ebullient"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/registry/json/JsonDistributionSummary.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package io.quarkus.micrometer.runtime.registry.json;\n+\n+import java.util.Arrays;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.concurrent.atomic.DoubleAdder;\n+\n+import io.micrometer.core.instrument.AbstractDistributionSummary;\n+import io.micrometer.core.instrument.Clock;\n+import io.micrometer.core.instrument.Measurement;\n+import io.micrometer.core.instrument.Statistic;\n+import io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n+import io.micrometer.core.instrument.distribution.TimeWindowMax;\n+\n+public class JsonDistributionSummary extends AbstractDistributionSummary {\n+\n+    private final AtomicLong count;\n+    private final DoubleAdder total;\n+    private final TimeWindowMax max;\n+    private final TimeWindowMin min;\n+\n+    public JsonDistributionSummary(Id id, Clock clock, DistributionStatisticConfig distributionStatisticConfig,\n+            double scale, boolean supportsAggregablePercentiles) {\n+        super(id, clock, distributionStatisticConfig, scale, supportsAggregablePercentiles);\n+        this.count = new AtomicLong();\n+        this.total = new DoubleAdder();\n+        this.max = new TimeWindowMax(clock, distributionStatisticConfig);\n+        this.min = new TimeWindowMin(clock, distributionStatisticConfig);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af139822b20d95c50547457ca85ee83150ff6878"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NzMwMzkx", "url": "https://github.com/quarkusio/quarkus/pull/11939#pullrequestreview-489730391", "createdAt": "2020-09-16T15:12:27Z", "commit": {"oid": "af139822b20d95c50547457ca85ee83150ff6878"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af139822b20d95c50547457ca85ee83150ff6878", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/af139822b20d95c50547457ca85ee83150ff6878", "committedDate": "2020-09-15T08:56:31Z", "message": "make bufferLength and expiry configurable"}, "afterCommit": {"oid": "928f180271c1a51b3b46e441b1d4f9806ac8faa7", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/928f180271c1a51b3b46e441b1d4f9806ac8faa7", "committedDate": "2020-09-17T08:07:27Z", "message": "JSON exporter for Micrometer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNzM2NDQx", "url": "https://github.com/quarkusio/quarkus/pull/11939#pullrequestreview-492736441", "createdAt": "2020-09-21T15:30:36Z", "commit": {"oid": "928f180271c1a51b3b46e441b1d4f9806ac8faa7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDE4MzIy", "url": "https://github.com/quarkusio/quarkus/pull/11939#pullrequestreview-493418322", "createdAt": "2020-09-22T12:44:32Z", "commit": {"oid": "928f180271c1a51b3b46e441b1d4f9806ac8faa7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMjo0NDozMlrOHV4LWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMjo0Njo0NFrOHV4Q0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMjU1Mw==", "bodyText": "Javadoc doesn't match the actual config default. Which should it be?", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r492702553", "createdAt": "2020-09-22T12:44:32Z", "author": {"login": "kenfinnigan"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/config/JsonConfig.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package io.quarkus.micrometer.runtime.config;\n+\n+import java.time.Duration;\n+import java.util.Optional;\n+\n+import io.quarkus.runtime.annotations.ConfigGroup;\n+import io.quarkus.runtime.annotations.ConfigItem;\n+\n+@ConfigGroup\n+public class JsonConfig implements MicrometerConfig.CapabilityEnabled {\n+    /**\n+     * Support for export to JSON format. Off by default.\n+     */\n+    @ConfigItem(defaultValue = \"false\")\n+    public Optional<Boolean> enabled;\n+\n+    /**\n+     * The path for the JSON metrics endpoint.\n+     * The default value is {@code /metrics-json}.\n+     */\n+    @ConfigItem(defaultValue = \"/metrics\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "928f180271c1a51b3b46e441b1d4f9806ac8faa7"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcwMzk1NA==", "bodyText": "I might have missed this somewhere, but should the content type be changed? I thought \"004\" was the right one for Prometheus?", "url": "https://github.com/quarkusio/quarkus/pull/11939#discussion_r492703954", "createdAt": "2020-09-22T12:46:44Z", "author": {"login": "kenfinnigan"}, "path": "extensions/micrometer/runtime/src/main/java/io/quarkus/micrometer/runtime/export/PrometheusRecorder.java", "diffHunk": "@@ -24,7 +23,7 @@ public PrometheusHandler getHandler() {\n         return new Function<Router, Route>() {\n             @Override\n             public Route apply(Router router) {\n-                return router.route(path).produces(TextFormat.CONTENT_TYPE_004);\n+                return router.route(path).order(1).produces(\"text/plain\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "928f180271c1a51b3b46e441b1d4f9806ac8faa7"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daab6d4ef2a18624421f44ece64bc1c2e376dafb", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/daab6d4ef2a18624421f44ece64bc1c2e376dafb", "committedDate": "2020-09-22T13:15:35Z", "message": "JSON exporter for Micrometer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "928f180271c1a51b3b46e441b1d4f9806ac8faa7", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/928f180271c1a51b3b46e441b1d4f9806ac8faa7", "committedDate": "2020-09-17T08:07:27Z", "message": "JSON exporter for Micrometer"}, "afterCommit": {"oid": "daab6d4ef2a18624421f44ece64bc1c2e376dafb", "author": {"user": {"login": "jmartisk", "name": "Jan Martiska"}}, "url": "https://github.com/quarkusio/quarkus/commit/daab6d4ef2a18624421f44ece64bc1c2e376dafb", "committedDate": "2020-09-22T13:15:35Z", "message": "JSON exporter for Micrometer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDk4ODIx", "url": "https://github.com/quarkusio/quarkus/pull/11939#pullrequestreview-493498821", "createdAt": "2020-09-22T14:07:30Z", "commit": {"oid": "daab6d4ef2a18624421f44ece64bc1c2e376dafb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 565, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}