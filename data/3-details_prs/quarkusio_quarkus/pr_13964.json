{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMjkyNDYy", "number": 13964, "title": "Add framework for integrating with RESTEasy Reactive Methods", "bodyText": "This adds interfaces that allow external code to:\n\nAdd Handlers at various points in the chain\nProvide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided.", "createdAt": "2020-12-18T05:14:48Z", "url": "https://github.com/quarkusio/quarkus/pull/13964", "merged": true, "mergeCommit": {"oid": "a448f77151c40c72ca812af6b67acb1a265c7aa1"}, "closed": true, "closedAt": "2021-01-25T04:26:16Z", "author": {"login": "stuartwdouglas"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnaNfegFqTU1NTU5OTkxOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdzbFVPABqjQyNDMwODAyNzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NTk5OTE4", "url": "https://github.com/quarkusio/quarkus/pull/13964#pullrequestreview-555599918", "createdAt": "2020-12-18T15:43:57Z", "commit": {"oid": "8ed3efacddba43686aca22ca53affa96f90ddfd8"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNTo0Mzo1OFrOIIoPUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNTo1MTozNVrOIIoh0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkxODgwMw==", "bodyText": "So how about a @HandlerFor(type = ServerWebSocket.class) annotation? Or we make it implement ParameterExtractor<ServerWebSocket> but I was thinking with an annotation we can make extractors pluggable based on annotations too in the future: @HandlerFor(annotatedWith = FroMage.class) which would support parameters annotated with @FroMage.\nI think this could be simpler than MethodScannerBuildItem and its context.", "url": "https://github.com/quarkusio/quarkus/pull/13964#discussion_r545918803", "createdAt": "2020-12-18T15:43:58Z", "author": {"login": "FroMage"}, "path": "extensions/resteasy-reactive/quarkus-resteasy-reactive/runtime/src/main/java/io/quarkus/resteasy/reactive/server/runtime/websocket/VertxWebSocketParamExtractor.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package io.quarkus.resteasy.reactive.server.runtime.websocket;\n+\n+import org.jboss.resteasy.reactive.server.core.ResteasyReactiveRequestContext;\n+import org.jboss.resteasy.reactive.server.core.parameters.ParameterExtractor;\n+\n+import io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext;\n+import io.vertx.core.AsyncResult;\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.core.http.ServerWebSocket;\n+\n+//TODO: do we actually want vert.x websockets?\n+//they are not our primary API but they are easy to support\n+public class VertxWebSocketParamExtractor implements ParameterExtractor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ed3efacddba43686aca22ca53affa96f90ddfd8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyMDMwNQ==", "bodyText": "Check out what I did in MultiResponseHandler which is similar to this, where I suspend, then do this:\n            // let's make sure we never restart by accident, also make sure we're not marked as completed\n            requestContext.restart(AWOL, true);", "url": "https://github.com/quarkusio/quarkus/pull/13964#discussion_r545920305", "createdAt": "2020-12-18T15:46:19Z", "author": {"login": "FroMage"}, "path": "extensions/resteasy-reactive/quarkus-resteasy-reactive/runtime/src/main/java/io/quarkus/resteasy/reactive/server/runtime/websocket/VertxWebSocketRestHandler.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package io.quarkus.resteasy.reactive.server.runtime.websocket;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.jboss.resteasy.reactive.server.core.ResteasyReactiveRequestContext;\n+import org.jboss.resteasy.reactive.server.model.HandlerChainCustomizer;\n+import org.jboss.resteasy.reactive.server.spi.ServerRestHandler;\n+\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.ServerWebSocket;\n+\n+public class VertxWebSocketRestHandler implements HandlerChainCustomizer {\n+\n+    @Override\n+    public List<ServerRestHandler> handlers(Phase phase) {\n+        if (phase == Phase.AFTER_METHOD_INVOKE) {\n+            return Collections.singletonList(new ServerRestHandler() {\n+                @Override\n+                public void handle(ResteasyReactiveRequestContext requestContext) throws Exception {\n+                    for (Object i : requestContext.getParameters()) {\n+                        if (i instanceof ServerWebSocket) {\n+                            ServerWebSocket socket = (ServerWebSocket) i;\n+                            socket.closeHandler(new Handler<Void>() {\n+                                @Override\n+                                public void handle(Void event) {\n+                                    requestContext.close();\n+                                }\n+                            });\n+                        }\n+                    }\n+                    requestContext.suspend(); //we never resume", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ed3efacddba43686aca22ca53affa96f90ddfd8"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyMDk2NA==", "bodyText": "Shouldn't we do this when we inject the param? There's always the potential for the method invocation to throw and get directly to the exception handler and we haven't registered the close handler, no?", "url": "https://github.com/quarkusio/quarkus/pull/13964#discussion_r545920964", "createdAt": "2020-12-18T15:47:26Z", "author": {"login": "FroMage"}, "path": "extensions/resteasy-reactive/quarkus-resteasy-reactive/runtime/src/main/java/io/quarkus/resteasy/reactive/server/runtime/websocket/VertxWebSocketRestHandler.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package io.quarkus.resteasy.reactive.server.runtime.websocket;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.jboss.resteasy.reactive.server.core.ResteasyReactiveRequestContext;\n+import org.jboss.resteasy.reactive.server.model.HandlerChainCustomizer;\n+import org.jboss.resteasy.reactive.server.spi.ServerRestHandler;\n+\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.ServerWebSocket;\n+\n+public class VertxWebSocketRestHandler implements HandlerChainCustomizer {\n+\n+    @Override\n+    public List<ServerRestHandler> handlers(Phase phase) {\n+        if (phase == Phase.AFTER_METHOD_INVOKE) {\n+            return Collections.singletonList(new ServerRestHandler() {\n+                @Override\n+                public void handle(ResteasyReactiveRequestContext requestContext) throws Exception {\n+                    for (Object i : requestContext.getParameters()) {\n+                        if (i instanceof ServerWebSocket) {\n+                            ServerWebSocket socket = (ServerWebSocket) i;\n+                            socket.closeHandler(new Handler<Void>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ed3efacddba43686aca22ca53affa96f90ddfd8"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyMjc0Nw==", "bodyText": "Even here I wonder if we couldn't annotate MultiResponseHandler:\n@RegisterRestHandler(phase = HandlerChainCustomizer.Phase.AFTER_METHOD_INVOKE, forType = Multi.class)\npublic class MultiResponseHandler implements ServerRestHandler {\n}", "url": "https://github.com/quarkusio/quarkus/pull/13964#discussion_r545922747", "createdAt": "2020-12-18T15:50:20Z", "author": {"login": "FroMage"}, "path": "independent-projects/resteasy-reactive/server/processor/src/main/java/org/jboss/resteasy/reactive/server/processor/scanning/AsyncReturnTypeScanner.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package org.jboss.resteasy.reactive.server.processor.scanning;\n+\n+import io.smallrye.mutiny.Multi;\n+import io.smallrye.mutiny.Uni;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletionStage;\n+import org.jboss.jandex.DotName;\n+import org.jboss.jandex.MethodInfo;\n+import org.jboss.resteasy.reactive.server.handlers.CompletionStageResponseHandler;\n+import org.jboss.resteasy.reactive.server.handlers.MultiResponseHandler;\n+import org.jboss.resteasy.reactive.server.handlers.UniResponseHandler;\n+import org.jboss.resteasy.reactive.server.model.FixedHandlerChainCustomizer;\n+import org.jboss.resteasy.reactive.server.model.HandlerChainCustomizer;\n+\n+public class AsyncReturnTypeScanner implements MethodScanner {\n+    private static final DotName COMPLETION_STAGE = DotName.createSimple(CompletionStage.class.getName());\n+    private static final DotName UNI = DotName.createSimple(Uni.class.getName());\n+    private static final DotName MULTI = DotName.createSimple(Multi.class.getName());\n+\n+    @Override\n+    public List<HandlerChainCustomizer> scan(MethodInfo method, Map<String, Object> methodContext) {\n+        if (method.returnType().name().equals(COMPLETION_STAGE)) {\n+            return Collections.singletonList(new FixedHandlerChainCustomizer(new CompletionStageResponseHandler(),\n+                    HandlerChainCustomizer.Phase.AFTER_METHOD_INVOKE));\n+        } else if (method.returnType().name().equals(UNI)) {\n+            return Collections.singletonList(new FixedHandlerChainCustomizer(new UniResponseHandler(),\n+                    HandlerChainCustomizer.Phase.AFTER_METHOD_INVOKE));\n+        }\n+        if (method.returnType().name().equals(MULTI)) {\n+            return Collections.singletonList(new FixedHandlerChainCustomizer(new MultiResponseHandler(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ed3efacddba43686aca22ca53affa96f90ddfd8"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkyMzUzOQ==", "bodyText": "Well done :)", "url": "https://github.com/quarkusio/quarkus/pull/13964#discussion_r545923539", "createdAt": "2020-12-18T15:51:35Z", "author": {"login": "FroMage"}, "path": "independent-projects/resteasy-reactive/server/runtime/src/main/java/org/jboss/resteasy/reactive/server/core/startup/RuntimeResourceDeployment.java", "diffHunk": "@@ -386,8 +390,10 @@ public ParameterExtractor parameterExtractor(Map<String, Integer> pathParameterI\n                 return extractor;\n             case BEAN:\n                 return new BeanParamExtractor((BeanFactory<Object>) info.getFactoryCreator().apply(loadClass(javaType)));\n+            case CUSTOM:\n+                return customExtractor;\n             default:\n-                return new QueryParamExtractor(name, single, encoded);\n+                throw new RuntimeException(\"Unkown param type: \" + type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ed3efacddba43686aca22ca53affa96f90ddfd8"}, "originalPosition": 111}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ed3efacddba43686aca22ca53affa96f90ddfd8", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/8ed3efacddba43686aca22ca53affa96f90ddfd8", "committedDate": "2020-12-18T05:12:43Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}, "afterCommit": {"oid": "e6dab3bbb668d73520a8f92e86f0dc0a4a0414f2", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/e6dab3bbb668d73520a8f92e86f0dc0a4a0414f2", "committedDate": "2020-12-22T00:30:05Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6dab3bbb668d73520a8f92e86f0dc0a4a0414f2", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/e6dab3bbb668d73520a8f92e86f0dc0a4a0414f2", "committedDate": "2020-12-22T00:30:05Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}, "afterCommit": {"oid": "741f92241202947d03d6dfe5c2f23e9e6a1136d3", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/741f92241202947d03d6dfe5c2f23e9e6a1136d3", "committedDate": "2021-01-08T01:03:44Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "741f92241202947d03d6dfe5c2f23e9e6a1136d3", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/741f92241202947d03d6dfe5c2f23e9e6a1136d3", "committedDate": "2021-01-08T01:03:44Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}, "afterCommit": {"oid": "52f7ee91d5fd51ffc54a8e8543290e063a39f50e", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/52f7ee91d5fd51ffc54a8e8543290e063a39f50e", "committedDate": "2021-01-08T04:21:24Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52f7ee91d5fd51ffc54a8e8543290e063a39f50e", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/52f7ee91d5fd51ffc54a8e8543290e063a39f50e", "committedDate": "2021-01-08T04:21:24Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}, "afterCommit": {"oid": "f42086d24d9ae8b2186b1a6366dfc4e0a50f2533", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/f42086d24d9ae8b2186b1a6366dfc4e0a50f2533", "committedDate": "2021-01-12T12:34:26Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2MjI2MDM3", "url": "https://github.com/quarkusio/quarkus/pull/13964#pullrequestreview-566226037", "createdAt": "2021-01-12T12:36:34Z", "commit": {"oid": "f42086d24d9ae8b2186b1a6366dfc4e0a50f2533"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f42086d24d9ae8b2186b1a6366dfc4e0a50f2533", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/f42086d24d9ae8b2186b1a6366dfc4e0a50f2533", "committedDate": "2021-01-12T12:34:26Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}, "afterCommit": {"oid": "67e93cff6d29b9e6b7e393daff71b24058bb0838", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/67e93cff6d29b9e6b7e393daff71b24058bb0838", "committedDate": "2021-01-19T04:46:30Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22c658f4b74786830ff7c655accecfe1ab8ff678", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/22c658f4b74786830ff7c655accecfe1ab8ff678", "committedDate": "2021-01-24T23:40:26Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67e93cff6d29b9e6b7e393daff71b24058bb0838", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/67e93cff6d29b9e6b7e393daff71b24058bb0838", "committedDate": "2021-01-19T04:46:30Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}, "afterCommit": {"oid": "22c658f4b74786830ff7c655accecfe1ab8ff678", "author": {"user": {"login": "stuartwdouglas", "name": "Stuart Douglas"}}, "url": "https://github.com/quarkusio/quarkus/commit/22c658f4b74786830ff7c655accecfe1ab8ff678", "committedDate": "2021-01-24T23:40:26Z", "message": "Add framework for integrating with RR Methods\n\nThis adds interfaces that allow external code to:\n- Add Handlers at various points in the chain\n- Provide custom ParamExtractors\n\nThis enables integration of more complex things like\nWebSockets. As a test of the intergration Vert.x\nwebsocket support is also provided."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4220, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}