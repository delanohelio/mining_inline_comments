{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMjA3MTI5", "number": 11166, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNDozMTowMFrOEUoP0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMDo1NTo1N1rOEatAWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMDY2Mzg3OnYy", "diffSide": "RIGHT", "path": "extensions/hibernate-search-elasticsearch/deployment/src/main/java/io/quarkus/hibernate/search/elasticsearch/HibernateSearchElasticsearchProcessor.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNDozMTowMVrOG673Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNToxMTowNVrOHDMA9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTM3NA==", "bodyText": "Not sure I follow you here. We make the version mandatory for named backend so maybe we should just make it mandatory for everything, default backend included? And then we could keep the named backend active?", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r464451374", "createdAt": "2020-08-03T14:31:01Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-search-elasticsearch/deployment/src/main/java/io/quarkus/hibernate/search/elasticsearch/HibernateSearchElasticsearchProcessor.java", "diffHunk": "@@ -97,37 +97,34 @@ void setRuntimeConfig(HibernateSearchElasticsearchRecorder recorder,\n     }\n \n     private static void checkConfig(HibernateSearchElasticsearchBuildTimeConfig buildTimeConfig) {\n-        if (buildTimeConfig.additionalBackends.defaultBackend.isPresent()) {\n-            String defaultBackend = buildTimeConfig.additionalBackends.defaultBackend.get();\n-            // we have a default named backend\n-            if (buildTimeConfig.defaultBackend.version.isPresent()) {\n-                throw new ConfigurationError(\n-                        \"quarkus.hibernate-search.elasticsearch.default-backend cannot be used in conjunction with a default backend configuration.\");\n-            }\n-            if (!buildTimeConfig.additionalBackends.backends.containsKey(defaultBackend)) {\n-                throw new ConfigurationError(\n-                        \"The default backend defined does not exist: \" + defaultBackend);\n-            }\n-        } else {\n-            // we are in the default backend case\n+        if (buildTimeConfig.namedBackends.backends.isEmpty()) {\n+            // There isn't any named backend: the default backend will be used.\n+\n+            // we validate that the version is present\n             if (!buildTimeConfig.defaultBackend.version.isPresent()) {\n                 throw new ConfigurationError(\n                         \"The Elasticsearch version needs to be defined via the quarkus.hibernate-search.elasticsearch.version property.\");\n             }\n-        }\n+        } else {\n+            // There is at least one named backend: we disallow using the default backend.\n+            // Theoretically we could allow using it,\n+            // but then we would be unable to detect whether the default backend is used\n+            // (and thus absolutely needs the version to be configured)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c926b015d63fe221332a261a2ab1a4db0349ca5f"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2NzUwMA==", "bodyText": "If we do that, then people using named backends exclusively (which, IMO, is what they should do if they have multiple backends) will have to set the version for the default backend even if they don't use it. I can do that if you want, but I'm not sure it's a better solution.", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r464467500", "createdAt": "2020-08-03T14:56:07Z", "author": {"login": "yrodiere"}, "path": "extensions/hibernate-search-elasticsearch/deployment/src/main/java/io/quarkus/hibernate/search/elasticsearch/HibernateSearchElasticsearchProcessor.java", "diffHunk": "@@ -97,37 +97,34 @@ void setRuntimeConfig(HibernateSearchElasticsearchRecorder recorder,\n     }\n \n     private static void checkConfig(HibernateSearchElasticsearchBuildTimeConfig buildTimeConfig) {\n-        if (buildTimeConfig.additionalBackends.defaultBackend.isPresent()) {\n-            String defaultBackend = buildTimeConfig.additionalBackends.defaultBackend.get();\n-            // we have a default named backend\n-            if (buildTimeConfig.defaultBackend.version.isPresent()) {\n-                throw new ConfigurationError(\n-                        \"quarkus.hibernate-search.elasticsearch.default-backend cannot be used in conjunction with a default backend configuration.\");\n-            }\n-            if (!buildTimeConfig.additionalBackends.backends.containsKey(defaultBackend)) {\n-                throw new ConfigurationError(\n-                        \"The default backend defined does not exist: \" + defaultBackend);\n-            }\n-        } else {\n-            // we are in the default backend case\n+        if (buildTimeConfig.namedBackends.backends.isEmpty()) {\n+            // There isn't any named backend: the default backend will be used.\n+\n+            // we validate that the version is present\n             if (!buildTimeConfig.defaultBackend.version.isPresent()) {\n                 throw new ConfigurationError(\n                         \"The Elasticsearch version needs to be defined via the quarkus.hibernate-search.elasticsearch.version property.\");\n             }\n-        }\n+        } else {\n+            // There is at least one named backend: we disallow using the default backend.\n+            // Theoretically we could allow using it,\n+            // but then we would be unable to detect whether the default backend is used\n+            // (and thus absolutely needs the version to be configured)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTM3NA=="}, "originalCommit": {"oid": "c926b015d63fe221332a261a2ab1a4db0349ca5f"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEwNDYzMQ==", "bodyText": "I fixed this according to our discussion on Zulip, rebased and force-pushed. Let's wait for CI, but then as far as I know it can be merged.", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r473104631", "createdAt": "2020-08-19T15:11:05Z", "author": {"login": "yrodiere"}, "path": "extensions/hibernate-search-elasticsearch/deployment/src/main/java/io/quarkus/hibernate/search/elasticsearch/HibernateSearchElasticsearchProcessor.java", "diffHunk": "@@ -97,37 +97,34 @@ void setRuntimeConfig(HibernateSearchElasticsearchRecorder recorder,\n     }\n \n     private static void checkConfig(HibernateSearchElasticsearchBuildTimeConfig buildTimeConfig) {\n-        if (buildTimeConfig.additionalBackends.defaultBackend.isPresent()) {\n-            String defaultBackend = buildTimeConfig.additionalBackends.defaultBackend.get();\n-            // we have a default named backend\n-            if (buildTimeConfig.defaultBackend.version.isPresent()) {\n-                throw new ConfigurationError(\n-                        \"quarkus.hibernate-search.elasticsearch.default-backend cannot be used in conjunction with a default backend configuration.\");\n-            }\n-            if (!buildTimeConfig.additionalBackends.backends.containsKey(defaultBackend)) {\n-                throw new ConfigurationError(\n-                        \"The default backend defined does not exist: \" + defaultBackend);\n-            }\n-        } else {\n-            // we are in the default backend case\n+        if (buildTimeConfig.namedBackends.backends.isEmpty()) {\n+            // There isn't any named backend: the default backend will be used.\n+\n+            // we validate that the version is present\n             if (!buildTimeConfig.defaultBackend.version.isPresent()) {\n                 throw new ConfigurationError(\n                         \"The Elasticsearch version needs to be defined via the quarkus.hibernate-search.elasticsearch.version property.\");\n             }\n-        }\n+        } else {\n+            // There is at least one named backend: we disallow using the default backend.\n+            // Theoretically we could allow using it,\n+            // but then we would be unable to detect whether the default backend is used\n+            // (and thus absolutely needs the version to be configured)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTM3NA=="}, "originalCommit": {"oid": "c926b015d63fe221332a261a2ab1a4db0349ca5f"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMDY2NjYyOnYy", "diffSide": "RIGHT", "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNDozMTozNlrOG674vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNDo1NjoyN1rOG683Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTc3NA==", "bodyText": "Given we are still experimental, I would just drop it and document it in the release notes.", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r464451774", "createdAt": "2020-08-03T14:31:36Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -128,9 +128,18 @@\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem\n+        @ConfigItem(name = ConfigItem.PARENT)\n         ElasticsearchIndexConfig indexDefaults;\n \n+        /**\n+         * @deprecated Define index defaults directly at the backend level instead of using {@code index-defaults};\n+         *             e.g. use simply {@code quarkus.hibernate-search.elasticsearch.indexing.queue.count}\n+         *             instead of {@code quarkus.hibernate-search.elasticsearch.index-defaults.indexing.queue.count}.\n+         */\n+        @ConfigItem(name = \"index-defaults\")\n+        @Deprecated\n+        ElasticsearchIndexConfig legacyIndexDefaults;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c926b015d63fe221332a261a2ab1a4db0349ca5f"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2NzcyMg==", "bodyText": "Ok, I'll add a commit.", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r464467722", "createdAt": "2020-08-03T14:56:27Z", "author": {"login": "yrodiere"}, "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -128,9 +128,18 @@\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem\n+        @ConfigItem(name = ConfigItem.PARENT)\n         ElasticsearchIndexConfig indexDefaults;\n \n+        /**\n+         * @deprecated Define index defaults directly at the backend level instead of using {@code index-defaults};\n+         *             e.g. use simply {@code quarkus.hibernate-search.elasticsearch.indexing.queue.count}\n+         *             instead of {@code quarkus.hibernate-search.elasticsearch.index-defaults.indexing.queue.count}.\n+         */\n+        @ConfigItem(name = \"index-defaults\")\n+        @Deprecated\n+        ElasticsearchIndexConfig legacyIndexDefaults;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ1MTc3NA=="}, "originalCommit": {"oid": "c926b015d63fe221332a261a2ab1a4db0349ca5f"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2NDM1ODAwOnYy", "diffSide": "RIGHT", "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMDo1NTo1N1rOHES_fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxMDo1NDozMFrOHEoz3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA==", "bodyText": "Maybe we could rename that one to defaultBackend? That would be clearer IMHO.", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474267518", "createdAt": "2020-08-20T20:55:57Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -128,7 +128,7 @@\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem\n+        @ConfigItem(name = ConfigItem.PARENT)\n         ElasticsearchIndexConfig indexDefaults;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e6f816539f6bf5b54ea75a45cddfd585c559612"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQzODU3NQ==", "bodyText": "This is not the default backend. This is the default configuration for indexes of a particular backend. E.g. quarkus.hibernate-search.elasticsearch.index-defaults.foo or quarkus.hibernate-search.elasticsearch.myBackend.index-defaults.foo.\ndefaultBackend is already present at line 32.\nWhat we could do, if you want, is remove this indexDefaults, since users can now put their default index configuration at the backend level, and it will be automatically applied to all indexes. In Hibernate Search it's already deprecated and we log a warning when it's used:\n\t@LogMessage(level = Logger.Level.WARN)\n\t@Message(id = ID_OFFSET_2 + 85,\n\t\t\tvalue = \"Using configuration property '%1$s'. The prefix 'index_defaults' is deprecated and its support will ultimately be removed.\"\n\t\t\t\t\t+ \" Instead, you should just set defaults for index properties at the backend level.\"\n\t\t\t\t\t+ \" For example, set 'hibernate.search.backend.indexing.queue_size'\"\n\t\t\t\t\t+ \" instead of 'hibernate.search.backend.index_defaults.indexing.queue_size'.\")\n\tvoid deprecatedIndexDefaultsPrefix(String key);", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474438575", "createdAt": "2020-08-21T06:40:54Z", "author": {"login": "yrodiere"}, "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -128,7 +128,7 @@\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem\n+        @ConfigItem(name = ConfigItem.PARENT)\n         ElasticsearchIndexConfig indexDefaults;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA=="}, "originalCommit": {"oid": "2e6f816539f6bf5b54ea75a45cddfd585c559612"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYxODgxNw==", "bodyText": "Ah OK, then let's remove it if it's deprecated in Search.", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474618817", "createdAt": "2020-08-21T10:40:02Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -128,7 +128,7 @@\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem\n+        @ConfigItem(name = ConfigItem.PARENT)\n         ElasticsearchIndexConfig indexDefaults;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA=="}, "originalCommit": {"oid": "2e6f816539f6bf5b54ea75a45cddfd585c559612"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNDM5Mg==", "bodyText": "Actually I was wrong, since I changed @ConfigItem to @ConfigItem(name = ConfigItem.PARENT), the index-defaults. prefix is no longer used. This will just be used to collect default index properties set at the backend level. So we're good, and the name is correct too.", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474624392", "createdAt": "2020-08-21T10:53:01Z", "author": {"login": "yrodiere"}, "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -128,7 +128,7 @@\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem\n+        @ConfigItem(name = ConfigItem.PARENT)\n         ElasticsearchIndexConfig indexDefaults;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA=="}, "originalCommit": {"oid": "2e6f816539f6bf5b54ea75a45cddfd585c559612"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDYyNDk5MA==", "bodyText": "After discussion on Zulip, we want to keep it.", "url": "https://github.com/quarkusio/quarkus/pull/11166#discussion_r474624990", "createdAt": "2020-08-21T10:54:30Z", "author": {"login": "gsmet"}, "path": "extensions/hibernate-search-elasticsearch/runtime/src/main/java/io/quarkus/hibernate/search/elasticsearch/runtime/HibernateSearchElasticsearchRuntimeConfig.java", "diffHunk": "@@ -128,7 +128,7 @@\n         /**\n          * The default configuration for the Elasticsearch indexes.\n          */\n-        @ConfigItem\n+        @ConfigItem(name = ConfigItem.PARENT)\n         ElasticsearchIndexConfig indexDefaults;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI2NzUxOA=="}, "originalCommit": {"oid": "2e6f816539f6bf5b54ea75a45cddfd585c559612"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 653, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}