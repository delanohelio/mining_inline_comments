{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyODI1MDQz", "number": 7099, "reviewThreads": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxNzo0NjozM1rODeSXxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNToxNjowMlrODiXPdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDg0ODcwOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxNzo0NjozM1rOFnWJDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxODowNjozOFrOFnWOZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwMTU1MA==", "bodyText": "can we explicit the imports in use and not use start imports here?", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376801550", "createdAt": "2020-02-09T17:46:33Z", "author": {"login": "machi1990"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -24,20 +24,13 @@\n import com.mongodb.client.MongoClient;\n \n import io.quarkus.arc.Unremovable;\n-import io.quarkus.arc.deployment.BeanContainerListenerBuildItem;\n-import io.quarkus.arc.deployment.BeanDefiningAnnotationBuildItem;\n-import io.quarkus.arc.deployment.GeneratedBeanBuildItem;\n-import io.quarkus.arc.deployment.GeneratedBeanGizmoAdaptor;\n-import io.quarkus.arc.deployment.UnremovableBeanBuildItem;\n+import io.quarkus.arc.deployment.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc0843988cdf7444cdadeddb74c1f57fa341d204"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwMjkxNw==", "bodyText": "done", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376802917", "createdAt": "2020-02-09T18:06:38Z", "author": {"login": "Postremus"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -24,20 +24,13 @@\n import com.mongodb.client.MongoClient;\n \n import io.quarkus.arc.Unremovable;\n-import io.quarkus.arc.deployment.BeanContainerListenerBuildItem;\n-import io.quarkus.arc.deployment.BeanDefiningAnnotationBuildItem;\n-import io.quarkus.arc.deployment.GeneratedBeanBuildItem;\n-import io.quarkus.arc.deployment.GeneratedBeanGizmoAdaptor;\n-import io.quarkus.arc.deployment.UnremovableBeanBuildItem;\n+import io.quarkus.arc.deployment.*;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwMTU1MA=="}, "originalCommit": {"oid": "bc0843988cdf7444cdadeddb74c1f57fa341d204"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDg0ODk0OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxNzo0Njo1M1rOFnWJKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxNzo0Njo1M1rOFnWJKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwMTU3OQ==", "bodyText": "same here about the usage of star imports..", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376801579", "createdAt": "2020-02-09T17:46:53Z", "author": {"login": "machi1990"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -24,20 +24,13 @@\n import com.mongodb.client.MongoClient;\n \n import io.quarkus.arc.Unremovable;\n-import io.quarkus.arc.deployment.BeanContainerListenerBuildItem;\n-import io.quarkus.arc.deployment.BeanDefiningAnnotationBuildItem;\n-import io.quarkus.arc.deployment.GeneratedBeanBuildItem;\n-import io.quarkus.arc.deployment.GeneratedBeanGizmoAdaptor;\n-import io.quarkus.arc.deployment.UnremovableBeanBuildItem;\n+import io.quarkus.arc.deployment.*;\n import io.quarkus.arc.processor.DotNames;\n+import io.quarkus.deployment.Capabilities;\n import io.quarkus.deployment.annotations.BuildProducer;\n import io.quarkus.deployment.annotations.BuildStep;\n import io.quarkus.deployment.annotations.Record;\n-import io.quarkus.deployment.builditem.ApplicationArchivesBuildItem;\n-import io.quarkus.deployment.builditem.CombinedIndexBuildItem;\n-import io.quarkus.deployment.builditem.ExtensionSslNativeSupportBuildItem;\n-import io.quarkus.deployment.builditem.FeatureBuildItem;\n-import io.quarkus.deployment.builditem.SslNativeConfigBuildItem;\n+import io.quarkus.deployment.builditem.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc0843988cdf7444cdadeddb74c1f57fa341d204"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMDg0OTQwOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/metrics/MongoMetricsConnectionPoolListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxNzo0ODowNFrOFnWJcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQxNzo0ODowNFrOFnWJcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjgwMTY1MA==", "bodyText": "let's get rid of wildcard imports..", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376801650", "createdAt": "2020-02-09T17:48:04Z", "author": {"login": "machi1990"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/metrics/MongoMetricsConnectionPoolListener.java", "diffHunk": "@@ -0,0 +1,83 @@\n+package io.quarkus.mongodb.metrics;\n+\n+import org.eclipse.microprofile.metrics.*;\n+\n+import com.mongodb.connection.ServerId;\n+import com.mongodb.event.*;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc0843988cdf7444cdadeddb74c1f57fa341d204"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTUzNDg1OnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/mongodb.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNzoyOTo1OFrOFncKLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNzoyOTo1OFrOFncKLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkwMDE0Mw==", "bodyText": "\"Will automatically add metrics\" followed by explanation that it must be explicitly enabled is a bit confusing.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376900143", "createdAt": "2020-02-10T07:29:58Z", "author": {"login": "jmartisk"}, "path": "docs/src/main/asciidoc/mongodb.adoc", "diffHunk": "@@ -523,6 +523,14 @@ So when you access the `/health/ready` endpoint of your application you will hav\n \n This behavior can be disabled by setting the `quarkus.mongodb.health.enabled` property to `false` in your `application.properties`.\n \n+== Metrics\n+\n+If you are using the `quarkus-smallrye-metrics` extension, `quarkus-mongodb` will automatically add metrics for the connection pools.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTU0Mjg4OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/metrics/MongoMetricsConnectionPoolListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNzozNDoyM1rOFncPBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNzozNDoyM1rOFncPBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkwMTM4MA==", "bodyText": "Counters are only supposed to go up. If you need a metric that goes down as well, it should be a Gauge. This would confuse Prometheus, which only expects counters to go up.\nI suppose you could change ConnectionPoolCounter to ConnectionPoolGauge that implements Gauge instead of Counter, and to be able to call the inc and dec methods here, you can cast the retrieved metric to ConnectionPoolGauge", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376901380", "createdAt": "2020-02-10T07:34:23Z", "author": {"login": "jmartisk"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/metrics/MongoMetricsConnectionPoolListener.java", "diffHunk": "@@ -0,0 +1,95 @@\n+package io.quarkus.mongodb.metrics;\n+\n+import org.eclipse.microprofile.metrics.Counter;\n+import org.eclipse.microprofile.metrics.Metadata;\n+import org.eclipse.microprofile.metrics.MetricRegistry;\n+import org.eclipse.microprofile.metrics.MetricType;\n+import org.eclipse.microprofile.metrics.Tag;\n+\n+import com.mongodb.connection.ServerId;\n+import com.mongodb.event.ConnectionAddedEvent;\n+import com.mongodb.event.ConnectionCheckedInEvent;\n+import com.mongodb.event.ConnectionCheckedOutEvent;\n+import com.mongodb.event.ConnectionPoolClosedEvent;\n+import com.mongodb.event.ConnectionPoolListener;\n+import com.mongodb.event.ConnectionPoolOpenedEvent;\n+import com.mongodb.event.ConnectionPoolWaitQueueEnteredEvent;\n+import com.mongodb.event.ConnectionPoolWaitQueueExitedEvent;\n+import com.mongodb.event.ConnectionRemovedEvent;\n+\n+import io.smallrye.metrics.MetricRegistries;\n+\n+public class MongoMetricsConnectionPoolListener implements ConnectionPoolListener {\n+    private final static String sizeName = \"mongodb.connection-pool.size\";\n+    private final static String checkedOutCountName = \"mongodb.connection-pool.checked-out-count\";\n+\n+    @Override\n+    public void connectionPoolOpened(ConnectionPoolOpenedEvent event) {\n+        Tag[] tags = createTags(event.getServerId());\n+\n+        Metadata sizeMetadata = Metadata.builder().withName(sizeName).withType(MetricType.COUNTER)\n+                .withDescription(\"the current size of the pool, including idle and and in-use members\").build();\n+        Metadata checkedOutCountMetadata = Metadata.builder().withName(checkedOutCountName).withType(MetricType.COUNTER)\n+                .withDescription(\" the current count of connections that are currently in use\").build();\n+\n+        getMetricRegistry().register(sizeMetadata, new ConnectionPoolCounter(), tags);\n+        getMetricRegistry().register(checkedOutCountMetadata, new ConnectionPoolCounter(), tags);\n+    }\n+\n+    @Override\n+    public void connectionPoolClosed(ConnectionPoolClosedEvent event) {\n+    }\n+\n+    @Override\n+    public void connectionCheckedOut(ConnectionCheckedOutEvent event) {\n+        Tag[] tags = createTags(event.getConnectionId().getServerId());\n+\n+        Counter checkedOutCount = getMetricRegistry().counter(checkedOutCountName, tags);\n+        checkedOutCount.inc();\n+    }\n+\n+    @Override\n+    public void connectionCheckedIn(ConnectionCheckedInEvent event) {\n+        Tag[] tags = createTags(event.getConnectionId().getServerId());\n+\n+        Counter checkedOutCount = getMetricRegistry().counter(checkedOutCountName, tags);\n+        checkedOutCount.inc(-1);\n+    }\n+\n+    @Override\n+    public void waitQueueEntered(ConnectionPoolWaitQueueEnteredEvent connectionPoolWaitQueueEnteredEvent) {\n+        // Not supported, since the event is deprecated and will be removed anyway\n+    }\n+\n+    @Override\n+    public void waitQueueExited(ConnectionPoolWaitQueueExitedEvent connectionPoolWaitQueueExitedEvent) {\n+        // Not supported, since the event is deprecated and will be removed anyway\n+    }\n+\n+    @Override\n+    public void connectionAdded(ConnectionAddedEvent event) {\n+        Tag[] tags = createTags(event.getConnectionId().getServerId());\n+\n+        Counter sizeCount = getMetricRegistry().counter(sizeName, tags);\n+        sizeCount.inc();\n+    }\n+\n+    @Override\n+    public void connectionRemoved(ConnectionRemovedEvent event) {\n+        Tag[] tags = createTags(event.getConnectionId().getServerId());\n+\n+        Counter sizeCount = getMetricRegistry().counter(sizeName, tags);\n+        sizeCount.inc(-1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTU1MjcwOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/test/java/io/quarkus/mongodb/MongoMetricsTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNzozOTo0NVrOFncU7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNzozOTo0NVrOFncU7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkwMjg5NQ==", "bodyText": "IIUC this connection pool listener is needed for updating the metrics, but here you only explictly add it in a test, but how will it be added in production code? I suppose that when quarkus.mongodb.metrics.enabled is true, then we need to do this automatically. So something like this needs to be in the place in Quarkus codebase that produces Mongo clients (AbstractMongoClientProducer I think?) To be able to do that, AbstractMongoClientProducer will need to be able to see the value of quarkus.mongodb.metrics.enabled property, so I think it might need to be turned into a runtime property.\nThe test should just do the regular\n@Inject\nMongoClient mongoClient;\n\nand shouldn't customize the client by itself", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376902895", "createdAt": "2020-02-10T07:39:45Z", "author": {"login": "jmartisk"}, "path": "extensions/mongodb-client/deployment/src/test/java/io/quarkus/mongodb/MongoMetricsTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package io.quarkus.mongodb;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import org.eclipse.microprofile.metrics.Counter;\n+import org.eclipse.microprofile.metrics.MetricID;\n+import org.eclipse.microprofile.metrics.MetricRegistry;\n+import org.eclipse.microprofile.metrics.Tag;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import com.mongodb.ConnectionString;\n+import com.mongodb.MongoClientSettings;\n+import com.mongodb.client.MongoClient;\n+\n+import io.quarkus.mongodb.metrics.MongoMetricsConnectionPoolListener;\n+import io.smallrye.metrics.MetricRegistries;\n+\n+public class MongoMetricsTest extends MongoTestBase {\n+\n+    private MongoClient client;\n+    private MetricRegistry metricRegistry;\n+\n+    @BeforeEach\n+    void init() {\n+        client = com.mongodb.client.MongoClients\n+                .create(MongoClientSettings.builder().applyConnectionString(new ConnectionString(getConnectionString()))\n+                        .applyToConnectionPoolSettings(\n+                                builder -> builder.addConnectionPoolListener(new MongoMetricsConnectionPoolListener()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTU2NjQ4OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNzo0Njo0MlrOFncdBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNzo0Njo0MlrOFncdBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkwNDk2NQ==", "bodyText": "What is this for? Is it something that the Mongo client library recognizes? I haven't been able to find what it is used for at runtime.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376904965", "createdAt": "2020-02-10T07:46:42Z", "author": {"login": "jmartisk"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -313,4 +315,13 @@ HealthBuildItem addHealthCheck(MongoClientBuildTimeConfig buildTimeConfig) {\n         return new HealthBuildItem(\"io.quarkus.mongodb.health.MongoHealthCheck\",\n                 buildTimeConfig.healthEnabled, \"mongodb\");\n     }\n+\n+    @BuildStep\n+    void produceMetricsEnabledProperty(BuildProducer<SystemPropertyBuildItem> producer,\n+            MongoClientBuildTimeConfig buildTimeConfig, Capabilities capabilities) {\n+\n+        if (buildTimeConfig.metricsEnabled && capabilities.isCapabilityPresent(Capabilities.METRICS)) {\n+            producer.produce(new SystemPropertyBuildItem(\"mongodb.metrics.enabled\", \"true\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTU4NjgxOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwNzo1NTo1N1rOFncojg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwODoyMDo1MlrOFndI-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkwNzkxOA==", "bodyText": "AFAIK the full list of metrics is known at build time? If so, we should register them here (including their tags). See https://github.com/quarkusio/quarkus/blob/master/extensions/agroal/deployment/src/main/java/io/quarkus/agroal/deployment/AgroalProcessor.java#L427 for example. The MongoMetricsConnectionPoolListener will then just update their values and won't have to take care of registering them at runtime", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376907918", "createdAt": "2020-02-10T07:55:57Z", "author": {"login": "jmartisk"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -313,4 +315,13 @@ HealthBuildItem addHealthCheck(MongoClientBuildTimeConfig buildTimeConfig) {\n         return new HealthBuildItem(\"io.quarkus.mongodb.health.MongoHealthCheck\",\n                 buildTimeConfig.healthEnabled, \"mongodb\");\n     }\n+\n+    @BuildStep\n+    void produceMetricsEnabledProperty(BuildProducer<SystemPropertyBuildItem> producer,\n+            MongoClientBuildTimeConfig buildTimeConfig, Capabilities capabilities) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkxMDY3Nw==", "bodyText": "AFAIK the full list of metrics is known at build time?\n\nWe do not necessarily know all tags.\nWe use the tags host and port here.\nIn case of the mongo+srv protocoll, the servers are resolved through dns entries.\nhttps://docs.mongodb.com/manual/reference/connection-string/#dns-seedlist-connection-format\nWe therefore would not know them during build time.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376910677", "createdAt": "2020-02-10T08:05:07Z", "author": {"login": "Postremus"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -313,4 +315,13 @@ HealthBuildItem addHealthCheck(MongoClientBuildTimeConfig buildTimeConfig) {\n         return new HealthBuildItem(\"io.quarkus.mongodb.health.MongoHealthCheck\",\n                 buildTimeConfig.healthEnabled, \"mongodb\");\n     }\n+\n+    @BuildStep\n+    void produceMetricsEnabledProperty(BuildProducer<SystemPropertyBuildItem> producer,\n+            MongoClientBuildTimeConfig buildTimeConfig, Capabilities capabilities) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkwNzkxOA=="}, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkxNjIxNg==", "bodyText": "Ok, that's unfortunate. In that case, the metrics won't currently get automatically deregistered during reload in dev mode (until we include a commit for #7018), therefore MongoMetricsConnectionPoolListener will at least temporarily need to take into account the fact that after a reload, the metrics from previous run can still exist, and instead of just registering them, it should delete and re-register them if they exist, so that they can start again from zero", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376916216", "createdAt": "2020-02-10T08:20:52Z", "author": {"login": "jmartisk"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -313,4 +315,13 @@ HealthBuildItem addHealthCheck(MongoClientBuildTimeConfig buildTimeConfig) {\n         return new HealthBuildItem(\"io.quarkus.mongodb.health.MongoHealthCheck\",\n                 buildTimeConfig.healthEnabled, \"mongodb\");\n     }\n+\n+    @BuildStep\n+    void produceMetricsEnabledProperty(BuildProducer<SystemPropertyBuildItem> producer,\n+            MongoClientBuildTimeConfig buildTimeConfig, Capabilities capabilities) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkwNzkxOA=="}, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTk5MTY5OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/pom.xml", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMToyOVrOFngZVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwOTozNzo1M1rOFoCOyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2OTU1OQ==", "bodyText": "This should be quarkus-smallrye-metrics-spi", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376969559", "createdAt": "2020-02-10T10:11:29Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/pom.xml", "diffHunk": "@@ -58,6 +58,11 @@\n             <artifactId>assertj-core</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-smallrye-metrics-deployment</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ2MjIzMw==", "bodyText": "quarkus-smallrye-metrics-spi does not have the MetricRegistries class.\nIf I use an @Inject RegistryType(VENDOR) MetricRegistry for the Metric Registry, arc can not find an implementation.\nHow can I just use quarkus-smallrye-metrics-spi in my tests?", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r377462233", "createdAt": "2020-02-11T06:31:12Z", "author": {"login": "Postremus"}, "path": "extensions/mongodb-client/deployment/pom.xml", "diffHunk": "@@ -58,6 +58,11 @@\n             <artifactId>assertj-core</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-smallrye-metrics-deployment</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2OTU1OQ=="}, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ2NTE3Mw==", "bodyText": "quarkus-smallrye-metrics-spi basically only contains the MetricBuildItem class which is used for registering metrics at build time, and imports the MP Metrics API, but not the implementation, that's why the injection doesn't work. If you need your tests to actually use the metrics extension, importing quarkus-smallrye-metrics-deployment is fine IMO.\nInstead of using MetricRegistries, which is a class from SmallRye Metrics, I'd suggest staying with just pure MP Metrics API, that is indeed @Inject RegistryType(VENDOR) MetricRegistry. If you import quarkus-smallrye-metrics-deployment it should work I think.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r377465173", "createdAt": "2020-02-11T06:46:23Z", "author": {"login": "jmartisk"}, "path": "extensions/mongodb-client/deployment/pom.xml", "diffHunk": "@@ -58,6 +58,11 @@\n             <artifactId>assertj-core</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-smallrye-metrics-deployment</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2OTU1OQ=="}, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ5NTc5NA==", "bodyText": "If you need your tests to actually use the metrics extension, importing quarkus-smallrye-metrics-deployment is fine IMO.\n\nI'm not agree, if your test need quarkus-smallrye-metrics-deployment you should add it with the test scope and also import the SPI. With this, someone that don't want metrics can still avoid the inclusion of all the dependencies at runtime.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r377495794", "createdAt": "2020-02-11T08:34:33Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/pom.xml", "diffHunk": "@@ -58,6 +58,11 @@\n             <artifactId>assertj-core</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-smallrye-metrics-deployment</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2OTU1OQ=="}, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ5OTQ1OA==", "bodyText": "it has the test scope here\nWhat's the point in importing the SPI when you're not using anything that it offers? We're not using MetricBuildItem because the full list of metrics is not known at build time, so metrics have to be registered dynamically at runtime, and for that the MP Metrics API is used directly", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r377499458", "createdAt": "2020-02-11T08:43:58Z", "author": {"login": "jmartisk"}, "path": "extensions/mongodb-client/deployment/pom.xml", "diffHunk": "@@ -58,6 +58,11 @@\n             <artifactId>assertj-core</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-smallrye-metrics-deployment</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2OTU1OQ=="}, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUyMDg4NA==", "bodyText": "@jmartisk sorry, I didn't notice that it has the test scope.\nThe fact that it didn't use the MetricBuildItem is a little annoying as it will be better than all extension register metrics the same way.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r377520884", "createdAt": "2020-02-11T09:31:38Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/pom.xml", "diffHunk": "@@ -58,6 +58,11 @@\n             <artifactId>assertj-core</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-smallrye-metrics-deployment</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2OTU1OQ=="}, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUyMzkxMw==", "bodyText": "I agree it would be convenient, and we try to do that as much as possible, but it's not achievable always. Not always do extensions know the full list of metrics at build time.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r377523913", "createdAt": "2020-02-11T09:37:53Z", "author": {"login": "jmartisk"}, "path": "extensions/mongodb-client/deployment/pom.xml", "diffHunk": "@@ -58,6 +58,11 @@\n             <artifactId>assertj-core</artifactId>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>io.quarkus</groupId>\n+            <artifactId>quarkus-smallrye-metrics-deployment</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk2OTU1OQ=="}, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMTk5NDYzOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientBuildTimeConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMjoxOVrOFngbHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMDoxMjoxOVrOFngbHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk3MDAxNQ==", "bodyText": "false is the default value for boolean so it could be omitted", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r376970015", "createdAt": "2020-02-10T10:12:19Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientBuildTimeConfig.java", "diffHunk": "@@ -11,4 +11,10 @@\n      */\n     @ConfigItem(name = \"health.enabled\", defaultValue = \"true\")\n     public boolean healthEnabled;\n+\n+    /**\n+     * Whether or not metrics are published in case the smallrye-metrics extension is present.\n+     */\n+    @ConfigItem(name = \"metrics.enabled\", defaultValue = \"false\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6008d96afde336e03b3d1ebd24e96b6c80b332aa"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTA1ODk3OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/test/java/io/quarkus/mongodb/MongoMetricsTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwNzoyMzoyMFrOFoj7YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwNzoyMzoyMFrOFoj7YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3NjAwMQ==", "bodyText": "Yeah, I just noticed that I deactivated this test.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r378076001", "createdAt": "2020-02-12T07:23:20Z", "author": {"login": "Postremus"}, "path": "extensions/mongodb-client/deployment/src/test/java/io/quarkus/mongodb/MongoMetricsTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+package io.quarkus.mongodb;\n+\n+import javax.inject.Inject;\n+\n+import org.eclipse.microprofile.metrics.Tag;\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.mongodb.client.MongoClient;\n+\n+import io.quarkus.test.QuarkusUnitTest;\n+\n+public class MongoMetricsTest extends MongoTestBase {\n+\n+    @Inject\n+    MongoClient client;\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest config = new QuarkusUnitTest()\n+            .setArchiveProducer(() -> ShrinkWrap.create(JavaArchive.class).addClasses(MongoTestBase.class))\n+            .withConfigurationResource(\"application-metrics-mongo.properties\");\n+\n+    @AfterEach\n+    void cleanup() {\n+        if (client != null) {\n+            client.close();\n+        }\n+    }\n+\n+    @Test\n+    void testMetricsInitialization() {\n+        // Metrics get registered once the driver opens the connection pool\n+        // The connection pool has a size of 0 by default\n+        //assertNull(getCounterValueOrNull(\"mongodb.connection-pool.size\", getTags()));\n+        //assertNull(getCounterValueOrNull(\"mongodb.connection-pool.checked-out-count\", getTags()));\n+\n+        // Just need to execute something so that an connection is opened\n+        //String name = client.listDatabaseNames().first();\n+\n+        //assertEquals(1L, getCounterValueOrNull(\"mongodb.connection-pool.size\", getTags()));\n+        //assertEquals(0L, getCounterValueOrNull(\"mongodb.connection-pool.checked-out-count\", getTags()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac5ab570215b64a08ff4e6d26c0d2d67d90bd167"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTIyODg1OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODozMTo1M1rOFolfBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODozMTo1M1rOFolfBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwMTUxMA==", "bodyText": "Can you move the connectionPoolListenerProvider on a new line, this will be easier to read", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r378101510", "createdAt": "2020-02-12T08:31:53Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -75,9 +78,14 @@ UnremovableBeanBuildItem markBeansAsUnremovable() {\n     void configureRuntimeProperties(MongoClientRecorder recorder,\n             CodecProviderBuildItem codecProvider,\n             BsonDiscriminatorBuildItem bsonDiscriminator,\n-            MongodbConfig config) {\n+            MongodbConfig config, List<MongoConnectionPoolListenerBuildItem> connectionPoolListenerProvider) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac5ab570215b64a08ff4e6d26c0d2d67d90bd167"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTIzNzA5OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODozNDo1NlrOFolkJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODozNDo1NlrOFolkJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwMjgyMA==", "bodyText": "We usually name a build step method by what it does. Here you setup metrics or you add the listener so maybe setupMetrics or addConnectionPoolListener are better names.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r378102820", "createdAt": "2020-02-12T08:34:56Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -332,4 +340,14 @@ HealthBuildItem addHealthCheck(MongoClientBuildTimeConfig buildTimeConfig) {\n         return new HealthBuildItem(\"io.quarkus.mongodb.health.MongoHealthCheck\",\n                 buildTimeConfig.healthEnabled, \"mongodb\");\n     }\n+\n+    @BuildStep\n+    void produceMongoClientSettings(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac5ab570215b64a08ff4e6d26c0d2d67d90bd167"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTI0MzExOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/metrics/MongoMetricsConnectionPoolListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODozNjo1MlrOFolnsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQwODozNjo1MlrOFolnsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEwMzczMA==", "bodyText": "constants are usally defined as private static final and are uppercase.\nprivate static final String SIZE_PROPERTY = \"mongodb.connection-pool.size\";\nSame for checkedOutCountName.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r378103730", "createdAt": "2020-02-12T08:36:52Z", "author": {"login": "loicmathieu"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/metrics/MongoMetricsConnectionPoolListener.java", "diffHunk": "@@ -0,0 +1,116 @@\n+package io.quarkus.mongodb.metrics;\n+\n+import org.eclipse.microprofile.metrics.Metadata;\n+import org.eclipse.microprofile.metrics.Metric;\n+import org.eclipse.microprofile.metrics.MetricID;\n+import org.eclipse.microprofile.metrics.MetricRegistry;\n+import org.eclipse.microprofile.metrics.MetricType;\n+import org.eclipse.microprofile.metrics.Tag;\n+\n+import com.mongodb.connection.ServerId;\n+import com.mongodb.event.ConnectionAddedEvent;\n+import com.mongodb.event.ConnectionCheckedInEvent;\n+import com.mongodb.event.ConnectionCheckedOutEvent;\n+import com.mongodb.event.ConnectionPoolClosedEvent;\n+import com.mongodb.event.ConnectionPoolListener;\n+import com.mongodb.event.ConnectionPoolOpenedEvent;\n+import com.mongodb.event.ConnectionPoolWaitQueueEnteredEvent;\n+import com.mongodb.event.ConnectionPoolWaitQueueExitedEvent;\n+import com.mongodb.event.ConnectionRemovedEvent;\n+\n+import io.smallrye.metrics.MetricRegistries;\n+\n+public class MongoMetricsConnectionPoolListener implements ConnectionPoolListener {\n+    private final static String sizeName = \"mongodb.connection-pool.size\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac5ab570215b64a08ff4e6d26c0d2d67d90bd167"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzU3OTMwOnYy", "diffSide": "RIGHT", "path": "docs/src/main/asciidoc/mongodb.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNToxMzozMVrOFtkLRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNToxMzozMVrOFtkLRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyMjk1MQ==", "bodyText": "con?", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r383322951", "createdAt": "2020-02-24T15:13:31Z", "author": {"login": "geoand"}, "path": "docs/src/main/asciidoc/mongodb.adoc", "diffHunk": "@@ -543,6 +543,14 @@ So when you access the `/health/ready` endpoint of your application you will hav\n \n This behavior can be disabled by setting the `quarkus.mongodb.health.enabled` property to `false` in your `application.properties`.\n \n+== Metrics\n+\n+If you are using the `quarkus-smallrye-metrics` extension, `quarkus-mongodb` con provide metrics about the connection pools.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be1c551cd833232212b40a8cb44449895d58d964"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzU4Mjg3OnYy", "diffSide": "LEFT", "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNToxNDoyNFrOFtkNZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNToxODo0NlrOFtkYEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyMzQ5NQ==", "bodyText": "Any reason this change was made or what it simply done by the formatter? Dittor for the similar changes below", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r383323495", "createdAt": "2020-02-24T15:14:24Z", "author": {"login": "geoand"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -114,7 +124,7 @@ BsonDiscriminatorBuildItem collectBsonDiscriminators(CombinedIndexBuildItem inde\n      * Create a producer bean managing the lifecycle of the MongoClient.\n      * <p>\n      * The generated class will look like\n-     * ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be1c551cd833232212b40a8cb44449895d58d964"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyNjIyNQ==", "bodyText": "I think this might just have been to formatter, I will check.", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r383326225", "createdAt": "2020-02-24T15:18:46Z", "author": {"login": "Postremus"}, "path": "extensions/mongodb-client/deployment/src/main/java/io/quarkus/mongodb/deployment/MongoClientProcessor.java", "diffHunk": "@@ -114,7 +124,7 @@ BsonDiscriminatorBuildItem collectBsonDiscriminators(CombinedIndexBuildItem inde\n      * Create a producer bean managing the lifecycle of the MongoClient.\n      * <p>\n      * The generated class will look like\n-     * ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyMzQ5NQ=="}, "originalCommit": {"oid": "be1c551cd833232212b40a8cb44449895d58d964"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzU4ODgyOnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/AbstractMongoClientProducer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNToxNTo1MFrOFtkQ_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNToxNTo1MFrOFtkQ_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyNDQxMg==", "bodyText": "Please change this to not use lambdas. We try very hard to not use lambdas in runtime code because a small startup time and have a small memory footprint", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r383324412", "createdAt": "2020-02-24T15:15:50Z", "author": {"login": "geoand"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/AbstractMongoClientProducer.java", "diffHunk": "@@ -295,6 +297,13 @@ private MongoClientSettings createMongoConfiguration(MongoClientConfig config) {\n         if (config.readPreference.isPresent()) {\n             settings.readPreference(ReadPreference.valueOf(config.readPreference.get()));\n         }\n+\n+        if (!connectionPoolListeners.isEmpty()) {\n+            settings.applyToConnectionPoolSettings(builder -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be1c551cd833232212b40a8cb44449895d58d964"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MzU4OTY0OnYy", "diffSide": "RIGHT", "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/AbstractMongoClientProducer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNToxNjowMlrOFtkRcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNToxNjowMlrOFtkRcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzMyNDUzMA==", "bodyText": "Same for method references :)", "url": "https://github.com/quarkusio/quarkus/pull/7099#discussion_r383324530", "createdAt": "2020-02-24T15:16:02Z", "author": {"login": "geoand"}, "path": "extensions/mongodb-client/runtime/src/main/java/io/quarkus/mongodb/runtime/AbstractMongoClientProducer.java", "diffHunk": "@@ -295,6 +297,13 @@ private MongoClientSettings createMongoConfiguration(MongoClientConfig config) {\n         if (config.readPreference.isPresent()) {\n             settings.readPreference(ReadPreference.valueOf(config.readPreference.get()));\n         }\n+\n+        if (!connectionPoolListeners.isEmpty()) {\n+            settings.applyToConnectionPoolSettings(builder -> {\n+                connectionPoolListeners.forEach(builder::addConnectionPoolListener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be1c551cd833232212b40a8cb44449895d58d964"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 937, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}