{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NzgyMzgy", "number": 8278, "title": "Support OIDC client_secret_jwt", "bodyText": "Fixes #8050\nSee also #8050 (comment)\nThanks\nAlso CC @stianst", "createdAt": "2020-03-30T17:07:34Z", "url": "https://github.com/quarkusio/quarkus/pull/8278", "merged": true, "mergeCommit": {"oid": "31430184ec4960b12e302274c4ae89a9c4819fcc"}, "closed": true, "closedAt": "2020-04-14T03:17:28Z", "author": {"login": "sberyozkin"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSxyM3ABqjMxNzk2NTQyODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXeedrAFqTM5MjY3MjkwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "635002f64df6d7b1ae78c631ffec01fd232f2b92", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/635002f64df6d7b1ae78c631ffec01fd232f2b92", "committedDate": "2020-03-30T16:52:54Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "fad88fbe48e6f42d9f422f52032652f1ec763e61", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/fad88fbe48e6f42d9f422f52032652f1ec763e61", "committedDate": "2020-03-30T17:16:43Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fad88fbe48e6f42d9f422f52032652f1ec763e61", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/fad88fbe48e6f42d9f422f52032652f1ec763e61", "committedDate": "2020-03-30T17:16:43Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "939ef336768fd90d1807cacfd9b7037e1cc5a83a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/939ef336768fd90d1807cacfd9b7037e1cc5a83a", "committedDate": "2020-03-31T15:20:20Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "939ef336768fd90d1807cacfd9b7037e1cc5a83a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/939ef336768fd90d1807cacfd9b7037e1cc5a83a", "committedDate": "2020-03-31T15:20:20Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "4fb60e88556a3f72a5d39000071a9550666cb2c6", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/4fb60e88556a3f72a5d39000071a9550666cb2c6", "committedDate": "2020-04-06T13:46:00Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4fb60e88556a3f72a5d39000071a9550666cb2c6", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/4fb60e88556a3f72a5d39000071a9550666cb2c6", "committedDate": "2020-04-06T13:46:00Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "3369f8f29ed7e1faefde67d25d17f2c9caf68fd7", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/3369f8f29ed7e1faefde67d25d17f2c9caf68fd7", "committedDate": "2020-04-06T14:14:11Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTIzMTkx", "url": "https://github.com/quarkusio/quarkus/pull/8278#pullrequestreview-388523191", "createdAt": "2020-04-06T18:46:20Z", "commit": {"oid": "3369f8f29ed7e1faefde67d25d17f2c9caf68fd7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODo0NjoyMFrOGBlMyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODo0ODo0M1rOGBlSYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMTI0Mg==", "bodyText": "I'm wondering if we can't just create the signed JWT at build time? But I guess that would not work for dynamic configurations?", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r404311242", "createdAt": "2020-04-06T18:46:20Z", "author": {"login": "pedroigor"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -194,9 +199,11 @@ private static QuarkusSecurityIdentity augmentIdentity(SecurityIdentity security\n \n         // Client secret has to be posted as a form parameter if OIDC requires the client_secret_post authentication\n         Credentials creds = configContext.oidcConfig.getCredentials();\n-        if (creds.clientSecret.value.isPresent() && creds.clientSecret.method.isPresent()\n-                && Secret.Method.POST == creds.clientSecret.method.get()) {\n+        if (creds.clientSecret.value.isPresent() && Secret.Method.POST == creds.clientSecret.method.orElse(null)) {\n             params.put(\"client_secret\", creds.clientSecret.value.get());\n+        } else if (creds.jwt.secret.isPresent()) {\n+            params.put(\"client_assertion_type\", \"urn:ietf:params:oauth:client-assertion-type:jwt-bearer\");\n+            params.put(\"client_assertion\", signJwtWithClientSecret(configContext.oidcConfig));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3369f8f29ed7e1faefde67d25d17f2c9caf68fd7"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxMjY3Mw==", "bodyText": "Maybe it should be createdTenantContextFromPublicKey instead ?", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r404312673", "createdAt": "2020-04-06T18:48:43Z", "author": {"login": "pedroigor"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -195,6 +190,20 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n         return new TenantConfigContext(auth, oidcConfig);\n     }\n \n+    @SuppressWarnings(\"deprecation\")\n+    private TenantConfigContext createdTenantContextFromPrivateKey(OAuth2ClientOptions options, OidcTenantConfig oidcConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3369f8f29ed7e1faefde67d25d17f2c9caf68fd7"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3369f8f29ed7e1faefde67d25d17f2c9caf68fd7", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/3369f8f29ed7e1faefde67d25d17f2c9caf68fd7", "committedDate": "2020-04-06T14:14:11Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "16a3166d4252d8ad3f1581bb100a9a9776401b1e", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/16a3166d4252d8ad3f1581bb100a9a9776401b1e", "committedDate": "2020-04-07T10:07:03Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16a3166d4252d8ad3f1581bb100a9a9776401b1e", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/16a3166d4252d8ad3f1581bb100a9a9776401b1e", "committedDate": "2020-04-07T10:07:03Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "a98ae3dcccaf33401dbdd1ce1d7f82a032012d8a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/a98ae3dcccaf33401dbdd1ce1d7f82a032012d8a", "committedDate": "2020-04-07T16:50:09Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzA5NTU4", "url": "https://github.com/quarkusio/quarkus/pull/8278#pullrequestreview-389309558", "createdAt": "2020-04-07T16:53:51Z", "commit": {"oid": "a98ae3dcccaf33401dbdd1ce1d7f82a032012d8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo1Mzo1MVrOGCNAhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjo1Mzo1MVrOGCNAhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk2MzQ2Mg==", "bodyText": "oops, that is too much :-)", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r404963462", "createdAt": "2020-04-07T16:53:51Z", "author": {"login": "sberyozkin"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java", "diffHunk": "@@ -222,6 +229,25 @@ private static QuarkusSecurityIdentity augmentIdentity(SecurityIdentity security\n         return cf;\n     }\n \n+    private String signJwtWithClientSecret(OidcTenantConfig cfg) {\n+        final byte[] keyBytes = cfg.credentials.jwt.secret.get().getBytes(StandardCharsets.UTF_8);\n+        SecretKey key = new SecretKeySpec(keyBytes, 0, keyBytes.length, \"HMACSHA256\");\n+\n+        // 'jti' claim is created by default.\n+        // 'exp' may be configured if it will be necessary.\n+        final long iat = (System.currentTimeMillis() / 1000);\n+        // 10 seconds\n+        final long exp = iat + 10 * 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a98ae3dcccaf33401dbdd1ce1d7f82a032012d8a"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a98ae3dcccaf33401dbdd1ce1d7f82a032012d8a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/a98ae3dcccaf33401dbdd1ce1d7f82a032012d8a", "committedDate": "2020-04-07T16:50:09Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "c30c0b60fa1c7280da6deae8483ca0d902a2cff5", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/c30c0b60fa1c7280da6deae8483ca0d902a2cff5", "committedDate": "2020-04-07T16:55:48Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5OTU5NTI4", "url": "https://github.com/quarkusio/quarkus/pull/8278#pullrequestreview-389959528", "createdAt": "2020-04-08T13:12:28Z", "commit": {"oid": "c30c0b60fa1c7280da6deae8483ca0d902a2cff5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNzE0MjY4", "url": "https://github.com/quarkusio/quarkus/pull/8278#pullrequestreview-390714268", "createdAt": "2020-04-09T11:36:02Z", "commit": {"oid": "c30c0b60fa1c7280da6deae8483ca0d902a2cff5"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMTozNjowM1rOGDU9Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMTozNjowM1rOGDU9Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE0MjI1NA==", "bodyText": "This should really be at debug, in general we try not to pollute the log on startup, especially not messages that just inform the user of what they have done.", "url": "https://github.com/quarkusio/quarkus/pull/8278#discussion_r406142254", "createdAt": "2020-04-09T11:36:03Z", "author": {"login": "stuartwdouglas"}, "path": "extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/OidcRecorder.java", "diffHunk": "@@ -195,6 +189,20 @@ public void handle(AsyncResult<OAuth2Auth> event) {\n         return new TenantConfigContext(auth, oidcConfig);\n     }\n \n+    @SuppressWarnings(\"deprecation\")\n+    private TenantConfigContext createdTenantContextFromPublicKey(OAuth2ClientOptions options, OidcTenantConfig oidcConfig) {\n+        if (oidcConfig.applicationType == ApplicationType.WEB_APP) {\n+            throw new ConfigurationException(\"'public-key' property can only be used with the 'service' applications\");\n+        }\n+        LOG.info(\"'public-key' property for the local token verification is set,\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c30c0b60fa1c7280da6deae8483ca0d902a2cff5"}, "originalPosition": 57}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c30c0b60fa1c7280da6deae8483ca0d902a2cff5", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/c30c0b60fa1c7280da6deae8483ca0d902a2cff5", "committedDate": "2020-04-07T16:55:48Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "3b6f2db21dd38b2a5520517cb5c4890914c7c510", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/3b6f2db21dd38b2a5520517cb5c4890914c7c510", "committedDate": "2020-04-09T13:19:40Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b6f2db21dd38b2a5520517cb5c4890914c7c510", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/3b6f2db21dd38b2a5520517cb5c4890914c7c510", "committedDate": "2020-04-09T13:19:40Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "32bb0702b19b7b4604566483a0d904bf07f01ca1", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/32bb0702b19b7b4604566483a0d904bf07f01ca1", "committedDate": "2020-04-09T13:39:25Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32bb0702b19b7b4604566483a0d904bf07f01ca1", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/32bb0702b19b7b4604566483a0d904bf07f01ca1", "committedDate": "2020-04-09T13:39:25Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "564c1e03a9fa4289955b97a22898e6bde3fa4ada", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/564c1e03a9fa4289955b97a22898e6bde3fa4ada", "committedDate": "2020-04-09T16:14:36Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "564c1e03a9fa4289955b97a22898e6bde3fa4ada", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/564c1e03a9fa4289955b97a22898e6bde3fa4ada", "committedDate": "2020-04-09T16:14:36Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "273f6ed16243f54b0595e7672e0a65d0b3417463", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/273f6ed16243f54b0595e7672e0a65d0b3417463", "committedDate": "2020-04-09T22:01:46Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "273f6ed16243f54b0595e7672e0a65d0b3417463", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/273f6ed16243f54b0595e7672e0a65d0b3417463", "committedDate": "2020-04-09T22:01:46Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "d73541eca61ab7fe3ce7168c8bc4b748f6fcb39a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/d73541eca61ab7fe3ce7168c8bc4b748f6fcb39a", "committedDate": "2020-04-10T16:28:44Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aab27a8ce5184ebb5569b942d06477d22831880", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/0aab27a8ce5184ebb5569b942d06477d22831880", "committedDate": "2020-04-10T16:39:09Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d73541eca61ab7fe3ce7168c8bc4b748f6fcb39a", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/d73541eca61ab7fe3ce7168c8bc4b748f6fcb39a", "committedDate": "2020-04-10T16:28:44Z", "message": "Support OIDC client_secret_jwt"}, "afterCommit": {"oid": "0aab27a8ce5184ebb5569b942d06477d22831880", "author": {"user": {"login": "sberyozkin", "name": null}}, "url": "https://github.com/quarkusio/quarkus/commit/0aab27a8ce5184ebb5569b942d06477d22831880", "committedDate": "2020-04-10T16:39:09Z", "message": "Support OIDC client_secret_jwt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTc2NDI5", "url": "https://github.com/quarkusio/quarkus/pull/8278#pullrequestreview-392576429", "createdAt": "2020-04-14T03:16:59Z", "commit": {"oid": "0aab27a8ce5184ebb5569b942d06477d22831880"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNjcyOTAx", "url": "https://github.com/quarkusio/quarkus/pull/8278#pullrequestreview-392672901", "createdAt": "2020-04-14T07:36:47Z", "commit": {"oid": "0aab27a8ce5184ebb5569b942d06477d22831880"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4813, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}