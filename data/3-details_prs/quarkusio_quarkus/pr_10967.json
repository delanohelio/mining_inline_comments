{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NjU1Nzgy", "number": 10967, "title": "Added support to Quartz Plugins And Listeners", "bodyText": "Added support to Quartz Plugins And Listeners, as described on issue #10962\nFix #10962", "createdAt": "2020-07-25T19:35:18Z", "url": "https://github.com/quarkusio/quarkus/pull/10967", "merged": true, "mergeCommit": {"oid": "2a5b0a094e3527351c87a26e6f4ca8deca4ad64a"}, "closed": true, "closedAt": "2020-07-29T16:14:34Z", "author": {"login": "marcelorubim"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4-RplAFqTQ1NTYxMzcwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5rJy9gH2gAyNDU2NjU1NzgyOmQ2NDdjMWE4NTY3Zjk3YTc2YTRlNjI4MDQ5MmFlZmIyOWM4NDEyMzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NjEzNzAw", "url": "https://github.com/quarkusio/quarkus/pull/10967#pullrequestreview-455613700", "createdAt": "2020-07-27T09:19:13Z", "commit": {"oid": "c382a9bfcdb10eefcbf952c9a97bd91ce82e5444"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwOToxOToxNFrOG3abMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwOToxOToxNFrOG3abMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc1NzgxMQ==", "bodyText": "That's not a good plugin to test. We do shutdown the quartz scheduler when a quarkus app/test stops ;-).", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r460757811", "createdAt": "2020-07-27T09:19:14Z", "author": {"login": "mkouba"}, "path": "extensions/quartz/deployment/src/test/java/io/quarkus/quartz/test/RegisterShutdownHookPluginTest.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package io.quarkus.quartz.test;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import javax.inject.Inject;\n+\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.asset.StringAsset;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import io.quarkus.scheduler.Scheduled;\n+import io.quarkus.scheduler.Scheduler;\n+import io.quarkus.test.QuarkusUnitTest;\n+\n+public class RegisterShutdownHookPluginTest {\n+\n+    @Inject\n+    Scheduler quartzScheduler;\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest test = new QuarkusUnitTest()\n+            .setArchiveProducer(() -> ShrinkWrap.create(JavaArchive.class)\n+                    .addClasses(Jobs.class)\n+                    .addAsResource(new StringAsset(\n+                                    \"quarkus.quartz.plugin.shutdownhook.class=org.quartz.plugins.management.ShutdownHookPlugin\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c382a9bfcdb10eefcbf952c9a97bd91ce82e5444"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NjQ4OTY3", "url": "https://github.com/quarkusio/quarkus/pull/10967#pullrequestreview-455648967", "createdAt": "2020-07-27T10:08:01Z", "commit": {"oid": "80342de73112c1f8d6bc228e3bf3f944ab4b2c5d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MTUxNzIy", "url": "https://github.com/quarkusio/quarkus/pull/10967#pullrequestreview-456151722", "createdAt": "2020-07-27T21:34:13Z", "commit": {"oid": "932ea063cbbd237e7337ab660607162196e0de1b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMTozNDoxM1rOG30acg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMTo0MTozMVrOG30oEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4MzYwMg==", "bodyText": "I think we should also add validation here that the class is a class implementing a org.quartz.JobListener interface. This way, we would throw the error earlier in build time. Let me know if you'd need help in doing it.\n/cc @mkouba", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461183602", "createdAt": "2020-07-27T21:34:13Z", "author": {"login": "machi1990"}, "path": "extensions/quartz/deployment/src/main/java/io/quarkus/quartz/deployment/QuartzProcessor.java", "diffHunk": "@@ -136,6 +136,18 @@ private String guessDriver(Optional<JdbcDataSourceBuildItem> jdbcDataSource) {\n                     .add(new ReflectiveClassBuildItem(true, false, QuarkusQuartzConnectionPoolProvider.class.getName()));\n         }\n \n+        config.triggerListeners.values().forEach((value) -> {\n+            reflectiveClasses.add(new ReflectiveClassBuildItem(true, false, value.clazz));\n+        });\n+\n+        config.jobListeners.values().forEach((value) -> {\n+            reflectiveClasses.add(new ReflectiveClassBuildItem(true, false, value.clazz));\n+        });\n+\n+        config.plugins.values().forEach((value) -> {\n+            reflectiveClasses.add(new ReflectiveClassBuildItem(true, false, value.clazz));\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "932ea063cbbd237e7337ab660607162196e0de1b"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NTY4MQ==", "bodyText": "We tend to avoid usage of lambdas in runtime modules. Can we go for classic for loops here? Probably extracting this logic into a method addListenerProperty(String prefix, QuartzAdditionalPropsConfig config) {...}, where the prefix is one of\n\nStdSchedulerFactory.PROP_PLUGIN_PREFIX ,\nStdSchedulerFactory.PROP_JOB_LISTENER_PREFIX and\nStdSchedulerFactory.PROP_JOB_LISTENER_PREFIX\n\nwould remove some of the duplication.", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461185681", "createdAt": "2020-07-27T21:38:25Z", "author": {"login": "machi1990"}, "path": "extensions/quartz/runtime/src/main/java/io/quarkus/quartz/runtime/QuartzScheduler.java", "diffHunk": "@@ -323,6 +323,28 @@ private Properties getSchedulerConfigurationProperties(QuartzSupport quartzSuppo\n             }\n         }\n \n+        buildTimeConfig.triggerListeners.forEach((key, value) -> {\n+            props.put(StdSchedulerFactory.PROP_TRIGGER_LISTENER_PREFIX + \".\" + key + \".class\", value.clazz);\n+            value.propsValue\n+                    .forEach((s, s2) -> props\n+                            .put(String.format(\"%s.%s.%s\", StdSchedulerFactory.PROP_TRIGGER_LISTENER_PREFIX, key, s), s2));\n+        });\n+\n+        buildTimeConfig.jobListeners.forEach((key, value) -> {\n+            props.put(StdSchedulerFactory.PROP_JOB_LISTENER_PREFIX + \".\" + key + \".class\", value.clazz);\n+            value.propsValue\n+                    .forEach((s, s2) -> props\n+                            .put(String.format(\"%s.%s.%s\", StdSchedulerFactory.PROP_JOB_LISTENER_PREFIX, key, s), s2));\n+        });\n+\n+        buildTimeConfig.plugins.forEach((key, value) -> {\n+            props.put(StdSchedulerFactory.PROP_PLUGIN_PREFIX + \".\" + key + \".class\", value.clazz);\n+            value.propsValue\n+                    .forEach(\n+                            (s, s2) -> props.put(String.format(\"%s.%s.%s\", StdSchedulerFactory.PROP_PLUGIN_PREFIX, key, s),\n+                                    s2));\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "932ea063cbbd237e7337ab660607162196e0de1b"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4NzA4OQ==", "bodyText": "Nice.\nDo you think we can be able to add a line or two in the Quartz guide about configuring listeners and plugins?", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461187089", "createdAt": "2020-07-27T21:41:31Z", "author": {"login": "machi1990"}, "path": "integration-tests/quartz/src/main/resources/application.properties", "diffHunk": "@@ -15,3 +15,7 @@ quarkus.flyway.migrate-at-start=true\n quarkus.flyway.baseline-on-migrate=true\n quarkus.flyway.baseline-version=1.0\n quarkus.flyway.baseline-description=Quartz\n+\n+# Register de LoggingJobHistoryPlugin for testing\n+quarkus.quartz.plugin.jobHistory.class=org.quartz.plugins.history.LoggingJobHistoryPlugin\n+quarkus.quartz.plugin.jobHistory.jobSuccessMessage=Job [{1}.{0}] execution complete and reports: {8}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "932ea063cbbd237e7337ab660607162196e0de1b"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2ODUzNDI1", "url": "https://github.com/quarkusio/quarkus/pull/10967#pullrequestreview-456853425", "createdAt": "2020-07-28T17:27:34Z", "commit": {"oid": "7f0e7cf3482c3730f0a58e6897bb3eff5f94b752"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNzoyNzozNFrOG4W_Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNzozMTo0NVrOG4XJUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MDAzNA==", "bodyText": "This is much better. Thank you.\nAlso in this issue we wanted to document the programmatic way of doing things as pointed out by @mkouba in #10962 (comment). Can you add a note in the documentation about that? Thank you.", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461750034", "createdAt": "2020-07-28T17:27:34Z", "author": {"login": "machi1990"}, "path": "docs/src/main/asciidoc/quartz.adoc", "diffHunk": "@@ -400,6 +400,20 @@ After a few seconds, in another terminal, run `curl localhost:8080/tasks` to ver\n \n You can also generate the native executable with `./mvnw clean package -Pnative`.\n \n+[[quartz-register-plugin-listeners]]\n+== Registering Plugin and Listeners\n+\n+You can register a plugin, jobListener or triggerListener through Quarkus configuration.\n+\n+The example bellow register the plugin `org.quartz.plugins.history.LoggingJobHistoryPlugin` named as `jobHistory` with the property `jobSuccessMessage` defined as `Job [{1}.{0}] execution complete and reports: {8}` \n+\n+[source,conf]\n+----\n+quarkus.quartz.plugin.jobHistory.class=org.quartz.plugins.history.LoggingJobHistoryPlugin\n+quarkus.quartz.plugin.jobHistory.jobSuccessMessage=Job [{1}.{0}] execution complete and reports: {8}\n+----\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f0e7cf3482c3730f0a58e6897bb3eff5f94b752"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc1MjY1Ng==", "bodyText": "This is fine for me.\nI am thinking maybe we can have a unit tests for validation. The UnsupportedClusteredJobConfigurationTest.java can be of inspiration.\nWhat do you think?", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r461752656", "createdAt": "2020-07-28T17:31:45Z", "author": {"login": "machi1990"}, "path": "extensions/quartz/deployment/src/main/java/io/quarkus/quartz/deployment/QuartzProcessor.java", "diffHunk": "@@ -136,6 +136,18 @@ private String guessDriver(Optional<JdbcDataSourceBuildItem> jdbcDataSource) {\n                     .add(new ReflectiveClassBuildItem(true, false, QuarkusQuartzConnectionPoolProvider.class.getName()));\n         }\n \n+        config.triggerListeners.values().forEach((value) -> {\n+            reflectiveClasses.add(new ReflectiveClassBuildItem(true, false, value.clazz));\n+        });\n+\n+        config.jobListeners.values().forEach((value) -> {\n+            reflectiveClasses.add(new ReflectiveClassBuildItem(true, false, value.clazz));\n+        });\n+\n+        config.plugins.values().forEach((value) -> {\n+            reflectiveClasses.add(new ReflectiveClassBuildItem(true, false, value.clazz));\n+        });", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE4MzYwMg=="}, "originalCommit": {"oid": "932ea063cbbd237e7337ab660607162196e0de1b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTIyNTk1", "url": "https://github.com/quarkusio/quarkus/pull/10967#pullrequestreview-456922595", "createdAt": "2020-07-28T19:02:00Z", "commit": {"oid": "1d5cfb9464e11e07144d2d931d60bf37a1ca0adc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjM0MzQ0", "url": "https://github.com/quarkusio/quarkus/pull/10967#pullrequestreview-457234344", "createdAt": "2020-07-29T06:41:41Z", "commit": {"oid": "1d5cfb9464e11e07144d2d931d60bf37a1ca0adc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjo0MTo0MVrOG4qqOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNjo0MzozN1rOG4qtTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MjM3Nw==", "bodyText": "The example bellow registers the plugin...", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r462072377", "createdAt": "2020-07-29T06:41:41Z", "author": {"login": "mkouba"}, "path": "docs/src/main/asciidoc/quartz.adoc", "diffHunk": "@@ -400,6 +400,31 @@ After a few seconds, in another terminal, run `curl localhost:8080/tasks` to ver\n \n You can also generate the native executable with `./mvnw clean package -Pnative`.\n \n+[[quartz-register-plugin-listeners]]\n+== Registering Plugin and Listeners\n+\n+You can register a plugin, jobListener or triggerListener through Quarkus configuration.\n+\n+The example bellow register the plugin `org.quartz.plugins.history.LoggingJobHistoryPlugin` named as `jobHistory` with the property `jobSuccessMessage` defined as `Job [{1}.{0}] execution complete and reports: {8}` ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d5cfb9464e11e07144d2d931d60bf37a1ca0adc"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA3MzE2Ng==", "bodyText": "You can also register a listener programmatically with an injected org.quartz.Scheduler...", "url": "https://github.com/quarkusio/quarkus/pull/10967#discussion_r462073166", "createdAt": "2020-07-29T06:43:37Z", "author": {"login": "mkouba"}, "path": "docs/src/main/asciidoc/quartz.adoc", "diffHunk": "@@ -400,6 +400,31 @@ After a few seconds, in another terminal, run `curl localhost:8080/tasks` to ver\n \n You can also generate the native executable with `./mvnw clean package -Pnative`.\n \n+[[quartz-register-plugin-listeners]]\n+== Registering Plugin and Listeners\n+\n+You can register a plugin, jobListener or triggerListener through Quarkus configuration.\n+\n+The example bellow register the plugin `org.quartz.plugins.history.LoggingJobHistoryPlugin` named as `jobHistory` with the property `jobSuccessMessage` defined as `Job [{1}.{0}] execution complete and reports: {8}` \n+\n+[source,conf]\n+----\n+quarkus.quartz.plugin.jobHistory.class=org.quartz.plugins.history.LoggingJobHistoryPlugin\n+quarkus.quartz.plugin.jobHistory.jobSuccessMessage=Job [{1}.{0}] execution complete and reports: {8}\n+----\n+\n+You can also register a jobListener or a triggerListener through Quartz API by injecting the underlying `org.quartz.Scheduler`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d5cfb9464e11e07144d2d931d60bf37a1ca0adc"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjQ4MjE5", "url": "https://github.com/quarkusio/quarkus/pull/10967#pullrequestreview-457248219", "createdAt": "2020-07-29T07:06:52Z", "commit": {"oid": "456f4bfe8570e8876d0703a4439c8ebc8fa4388d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mzk3MDA3", "url": "https://github.com/quarkusio/quarkus/pull/10967#pullrequestreview-457397007", "createdAt": "2020-07-29T10:33:09Z", "commit": {"oid": "6ea7076b2a254d244bb12904f666426f9930048a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NDEyMDE2", "url": "https://github.com/quarkusio/quarkus/pull/10967#pullrequestreview-457412016", "createdAt": "2020-07-29T10:56:59Z", "commit": {"oid": "748bdde996abe838c74ef5829e88cf0c7271ea83"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d647c1a8567f97a76a4e6280492aefb29c841237", "author": {"user": {"login": "marcelorubim", "name": "Marcelo Rubim"}}, "url": "https://github.com/quarkusio/quarkus/commit/d647c1a8567f97a76a4e6280492aefb29c841237", "committedDate": "2020-07-29T13:36:23Z", "message": "Added support to configure plugins and listeners on Quartz extension."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1131, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}