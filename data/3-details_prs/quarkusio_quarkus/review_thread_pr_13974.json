{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNjk3Nzgx", "number": 13974, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMToyOTo1OFrOFHWj1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMTozMDo0N1rOFHWkfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMjUzOTc1OnYy", "diffSide": "RIGHT", "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMToyOTo1OFrOIIzTmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMjozOTowMFrOII0wsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDEyMA==", "bodyText": "I think debug logs like this should also be in the init method, since it seems that method returns prematurely in this case", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546100120", "createdAt": "2020-12-18T21:29:58Z", "author": {"login": "gastaldi"}, "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "221c918a71ae14a24fbedd4d68aaac8e6273db20"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExNzU3Ng==", "bodyText": "@gastaldi sure, it is just the way it is currently implemented that a recorder calls the initialization method only if that property is enabled, so the user disabled it, forgot to re-enable and got NPE, so this issue is just about avoiding NPE and saying somethng useful... Pedro @pedroigor is managing this extension, I only venture with some basic fixes into it :-).\nPerhaps indeed a deeper refactoring is required here", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546117576", "createdAt": "2020-12-18T22:18:58Z", "author": {"login": "sberyozkin"}, "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDEyMA=="}, "originalCommit": {"oid": "221c918a71ae14a24fbedd4d68aaac8e6273db20"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMzk1NA==", "bodyText": "@gastaldi I'll have a quick look as well if it can be caught earlier, there must be a way", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546123954", "createdAt": "2020-12-18T22:39:00Z", "author": {"login": "sberyozkin"}, "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDEyMA=="}, "originalCommit": {"oid": "221c918a71ae14a24fbedd4d68aaac8e6273db20"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMjU0MTQyOnYy", "diffSide": "RIGHT", "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMTozMDo0N1rOIIzUtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOVQwMjowNzo1OVrOII36cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ==", "bodyText": "Can we also explain why the Authentication failed to the caller here?", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546100405", "createdAt": "2020-12-18T21:30:47Z", "author": {"login": "gastaldi"}, "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");\n+            throw new AuthenticationFailedException();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "221c918a71ae14a24fbedd4d68aaac8e6273db20"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExODc3Nw==", "bodyText": "I was thinking, since this code is executed as part of the user authentication process, it should be 401. In fact first I coded an IllegalStateException but then I changed my mind, but now that you asked, I wonder if returning 500 would be best as it is really a server configuration issue. What would you prefer yourself ?", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546118777", "createdAt": "2020-12-18T22:22:40Z", "author": {"login": "sberyozkin"}, "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");\n+            throw new AuthenticationFailedException();\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ=="}, "originalCommit": {"oid": "221c918a71ae14a24fbedd4d68aaac8e6273db20"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMTY1MQ==", "bodyText": "Returning 500 makes more sense to me", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546121651", "createdAt": "2020-12-18T22:31:26Z", "author": {"login": "gastaldi"}, "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");\n+            throw new AuthenticationFailedException();\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ=="}, "originalCommit": {"oid": "221c918a71ae14a24fbedd4d68aaac8e6273db20"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMzYxMA==", "bodyText": "@gastaldi thanks, I'll fix during the next few days, have to sign off now, thanks for starting the review, enjoy the weekend :-)", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546123610", "createdAt": "2020-12-18T22:37:53Z", "author": {"login": "sberyozkin"}, "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");\n+            throw new AuthenticationFailedException();\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ=="}, "originalCommit": {"oid": "221c918a71ae14a24fbedd4d68aaac8e6273db20"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3NTYwMg==", "bodyText": "Likewise, have fun! \ud83d\ude09", "url": "https://github.com/quarkusio/quarkus/pull/13974#discussion_r546175602", "createdAt": "2020-12-19T02:07:59Z", "author": {"login": "gastaldi"}, "path": "extensions/keycloak-authorization/runtime/src/main/java/io/quarkus/keycloak/pep/runtime/KeycloakPolicyEnforcerAuthorizer.java", "diffHunk": "@@ -43,6 +46,11 @@\n \n     @Override\n     public CheckResult apply(RoutingContext routingContext, SecurityIdentity identity) {\n+        if (delegate == null) {\n+            LOG.debug(\n+                    \"Keycloak Policy Enforcer has not been initialized - please make sure 'quarkus.oidc.enabled' is not set to 'false'\");\n+            throw new AuthenticationFailedException();\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEwMDQwNQ=="}, "originalCommit": {"oid": "221c918a71ae14a24fbedd4d68aaac8e6273db20"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4439, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}