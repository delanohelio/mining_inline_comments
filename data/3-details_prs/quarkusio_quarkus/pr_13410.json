{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1MDM0OTUy", "number": 13410, "title": "Fix cache exception handling", "bodyText": "Fixes #13399.", "createdAt": "2020-11-21T01:33:38Z", "url": "https://github.com/quarkusio/quarkus/pull/13410", "merged": true, "mergeCommit": {"oid": "de1efce25ee83e87a9ff79b9441001df6e287964"}, "closed": true, "closedAt": "2020-11-23T09:49:45Z", "author": {"login": "gwenneg"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeh1RWgFqTUzNTg2OTEwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfSCRyAFqTUzNjMxMDI1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODY5MTAw", "url": "https://github.com/quarkusio/quarkus/pull/13410#pullrequestreview-535869100", "createdAt": "2020-11-21T01:40:01Z", "commit": {"oid": "81ca429c79d40b87ca8c9c56361203f30d02d980"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMTo0MDowMVrOH3loSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMTo0MDowMVrOH3loSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA1MDI1MA==", "bodyText": "@ben-manes I need your help with this line. When it is executed, Caffeine is logging a warning about an Exception thrown during asynchronous load (the old warning I already got rid of before). Why is this happening while the future was removed from the cache with the previous line?", "url": "https://github.com/quarkusio/quarkus/pull/13410#discussion_r528050250", "createdAt": "2020-11-21T01:40:01Z", "author": {"login": "gwenneg"}, "path": "extensions/cache/runtime/src/main/java/io/quarkus/cache/runtime/caffeine/CaffeineCache.java", "diffHunk": "@@ -68,9 +68,15 @@ public CaffeineCache(CaffeineCacheInfo cacheInfo) {\n         CompletableFuture<Object> newCacheValue = new CompletableFuture<Object>();\n         CompletableFuture<Object> existingCacheValue = cache.asMap().putIfAbsent(key, newCacheValue);\n         if (existingCacheValue == null) {\n-            Object value = valueLoader.apply(key);\n-            newCacheValue.complete(NullValueConverter.toCacheValue(value));\n-            return unwrapCacheValue(newCacheValue);\n+            try {\n+                Object value = valueLoader.apply(key);\n+                newCacheValue.complete(NullValueConverter.toCacheValue(value));\n+                return unwrapCacheValue(newCacheValue);\n+            } catch (Throwable t) {\n+                cache.asMap().remove(key, newCacheValue);\n+                newCacheValue.completeExceptionally(t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81ca429c79d40b87ca8c9c56361203f30d02d980"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81ca429c79d40b87ca8c9c56361203f30d02d980", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/81ca429c79d40b87ca8c9c56361203f30d02d980", "committedDate": "2020-11-21T01:32:57Z", "message": "Fix cache exception handling"}, "afterCommit": {"oid": "f6cf8414a3bfd7c96599abdd6d6e22c601e10669", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/f6cf8414a3bfd7c96599abdd6d6e22c601e10669", "committedDate": "2020-11-21T18:51:34Z", "message": "Fix cache exception handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MDk3OTQx", "url": "https://github.com/quarkusio/quarkus/pull/13410#pullrequestreview-536097941", "createdAt": "2020-11-22T17:50:21Z", "commit": {"oid": "f6cf8414a3bfd7c96599abdd6d6e22c601e10669"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMlQxNzo1MDoyMVrOH35Hig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMlQxNzo1MDoyMVrOH35Hig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODM2OTU0Ng==", "bodyText": "Not sure I understand this particular one?\nIt looks a bit like dark magic, we should at least add comments about what we're doing here.", "url": "https://github.com/quarkusio/quarkus/pull/13410#discussion_r528369546", "createdAt": "2020-11-22T17:50:21Z", "author": {"login": "gsmet"}, "path": "extensions/cache/runtime/src/main/java/io/quarkus/cache/runtime/CacheResultInterceptor.java", "diffHunk": "@@ -59,8 +60,15 @@ public Object apply(Object k) {\n                 }\n             }\n \n-        } catch (CacheException e) {\n-            if (e.getCause() instanceof Exception) {\n+        } catch (ExecutionException e) {\n+            if (e.getCause() instanceof CacheException) {\n+                CacheException cacheException = (CacheException) e.getCause();\n+                if (cacheException.getCause() instanceof Exception) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cf8414a3bfd7c96599abdd6d6e22c601e10669"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e3dd92a9e1b7f19ad045c4b7bbe4df01e2d15a6", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/9e3dd92a9e1b7f19ad045c4b7bbe4df01e2d15a6", "committedDate": "2020-11-22T20:19:12Z", "message": "Fix cache exception handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6cf8414a3bfd7c96599abdd6d6e22c601e10669", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/f6cf8414a3bfd7c96599abdd6d6e22c601e10669", "committedDate": "2020-11-21T18:51:34Z", "message": "Fix cache exception handling"}, "afterCommit": {"oid": "9e3dd92a9e1b7f19ad045c4b7bbe4df01e2d15a6", "author": {"user": {"login": "gwenneg", "name": "Gwenneg Lepage"}}, "url": "https://github.com/quarkusio/quarkus/commit/9e3dd92a9e1b7f19ad045c4b7bbe4df01e2d15a6", "committedDate": "2020-11-22T20:19:12Z", "message": "Fix cache exception handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MzEwMjU0", "url": "https://github.com/quarkusio/quarkus/pull/13410#pullrequestreview-536310254", "createdAt": "2020-11-23T09:49:40Z", "commit": {"oid": "9e3dd92a9e1b7f19ad045c4b7bbe4df01e2d15a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1452, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}