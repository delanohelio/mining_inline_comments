{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NDE5NjEx", "number": 8815, "title": "Make deploying to Minikube effortless when not using a registry ", "bodyText": "The idea here to force-set IfNotPresent to ImagePullPolicy when no registry is being used (and therefore only local docker daemon can work).\nBased on the observation of @davsclaus and done after talking with @maxandersen", "createdAt": "2020-04-24T08:52:58Z", "url": "https://github.com/quarkusio/quarkus/pull/8815", "merged": true, "mergeCommit": {"oid": "a527712da0e7c3224b2028e3315830ea2ba5a92d"}, "closed": true, "closedAt": "2020-04-24T13:18:32Z", "author": {"login": "geoand"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcat5RkAFqTM5OTc3NzgwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcav9jYgBqjMyNjkwMzk4ODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5Nzc3ODA4", "url": "https://github.com/quarkusio/quarkus/pull/8815#pullrequestreview-399777808", "createdAt": "2020-04-24T09:16:24Z", "commit": {"oid": "de7177bf438c5921395dca6fbea35d2367d7ff30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwOToxNjoyNFrOGLOcxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwOToxNjoyNFrOGLOcxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQyNDI2MA==", "bodyText": "Should inline the determineImagePullPolicy call like the subsequent applyConfig calls do?", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414424260", "createdAt": "2020-04-24T09:16:24Z", "author": {"login": "Ladicek"}, "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java", "diffHunk": "@@ -225,10 +230,13 @@ public void build(ApplicationInfoBuildItem applicationInfo,\n         //Apply configuration\n         applyGlobalConfig(session, kubernetesConfig);\n         ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);\n+        ImagePullPolicy imagePullPolicy = determineImagePullPolicy(kubernetesConfig, containerImage, capabilities);\n         applyConfig(session, project, KUBERNETES, getResourceName(kubernetesConfig, applicationInfo), kubernetesConfig,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de7177bf438c5921395dca6fbea35d2367d7ff30"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de7177bf438c5921395dca6fbea35d2367d7ff30", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/de7177bf438c5921395dca6fbea35d2367d7ff30", "committedDate": "2020-04-24T08:38:22Z", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes"}, "afterCommit": {"oid": "12ba684fc7074138b347b51b41e654c3cebf8e16", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/12ba684fc7074138b347b51b41e654c3cebf8e16", "committedDate": "2020-04-24T09:21:29Z", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NzkzMDc1", "url": "https://github.com/quarkusio/quarkus/pull/8815#pullrequestreview-399793075", "createdAt": "2020-04-24T09:37:35Z", "commit": {"oid": "12ba684fc7074138b347b51b41e654c3cebf8e16"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwOTozNzozNVrOGLPSOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwOTozNzozNVrOGLPSOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQzNzk0NQ==", "bodyText": "I don't really get the purpose of calling kubernetesDeploy.getAsBoolean().\nWhatever the reason, this needs to change, as this call is performing an actual request to kubernetes. This should never be the case when generating resources. Generated resources should be the same regardless of the if and what is the configured environment on the user side.", "url": "https://github.com/quarkusio/quarkus/pull/8815#discussion_r414437945", "createdAt": "2020-04-24T09:37:35Z", "author": {"login": "iocanel"}, "path": "extensions/kubernetes/vanilla/deployment/src/main/java/io/quarkus/kubernetes/deployment/KubernetesProcessor.java", "diffHunk": "@@ -391,6 +399,22 @@ private void applyConfig(Session session, Project project, String target, String\n         });\n     }\n \n+    /**\n+     * When there is no registry defined and s2i isn't being used, the only ImagePullPolicy that can work is 'IfNotPresent'.\n+     * This case comes up when users want to deploy their application to a cluster like Minikube where no registry is used\n+     * and instead they rely on the image being built directly into the docker daemon that the cluster uses.\n+     */\n+    private ImagePullPolicy determineImagePullPolicy(PlatformConfiguration config,\n+            Optional<ContainerImageInfoBuildItem> containerImage, Capabilities capabilities) {\n+        ImagePullPolicy imagePullPolicy = config.getImagePullPolicy();\n+        if (containerImage.isPresent()\n+                && ContainerImageUtil.isRegistryMissingAndNotS2I(capabilities, containerImage.get())\n+                && kubernetesDeploy.getAsBoolean()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12ba684fc7074138b347b51b41e654c3cebf8e16"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5Nzk0NjIz", "url": "https://github.com/quarkusio/quarkus/pull/8815#pullrequestreview-399794623", "createdAt": "2020-04-24T09:39:53Z", "commit": {"oid": "12ba684fc7074138b347b51b41e654c3cebf8e16"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94927aa7ab96fadd14347fc1a99e1da01ba47305", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/94927aa7ab96fadd14347fc1a99e1da01ba47305", "committedDate": "2020-04-24T11:12:36Z", "message": "Fix broken KubernetesDeployer\n\n7f78a470 cleaned up the class, but the build item\nthat was removed was evidently also used to control\nthe execution order of the various build steps.\nThe issue is easily be fixed by adding\nArtifactResultBuildItem as a \"dependency\" since it is\nproduced by the container-image build steps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12ba684fc7074138b347b51b41e654c3cebf8e16", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/12ba684fc7074138b347b51b41e654c3cebf8e16", "committedDate": "2020-04-24T09:21:29Z", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes"}, "afterCommit": {"oid": "d699899675d3656d0d0ef03e1b5918be1a3e8b9c", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/d699899675d3656d0d0ef03e1b5918be1a3e8b9c", "committedDate": "2020-04-24T11:25:22Z", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODY1MTcy", "url": "https://github.com/quarkusio/quarkus/pull/8815#pullrequestreview-399865172", "createdAt": "2020-04-24T11:31:10Z", "commit": {"oid": "d699899675d3656d0d0ef03e1b5918be1a3e8b9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d699899675d3656d0d0ef03e1b5918be1a3e8b9c", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/d699899675d3656d0d0ef03e1b5918be1a3e8b9c", "committedDate": "2020-04-24T11:25:22Z", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes"}, "afterCommit": {"oid": "b98cc74f16d8a06031e2210f792fc9b4cb941dd6", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/b98cc74f16d8a06031e2210f792fc9b4cb941dd6", "committedDate": "2020-04-24T11:37:00Z", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4781238019392e70ef6463bc51b29dffa229119c", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/4781238019392e70ef6463bc51b29dffa229119c", "committedDate": "2020-04-24T11:40:45Z", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b98cc74f16d8a06031e2210f792fc9b4cb941dd6", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/b98cc74f16d8a06031e2210f792fc9b4cb941dd6", "committedDate": "2020-04-24T11:37:00Z", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes"}, "afterCommit": {"oid": "4781238019392e70ef6463bc51b29dffa229119c", "author": {"user": {"login": "geoand", "name": "Georgios Andrianakis"}}, "url": "https://github.com/quarkusio/quarkus/commit/4781238019392e70ef6463bc51b29dffa229119c", "committedDate": "2020-04-24T11:40:45Z", "message": "Force ImagePullPolicy to be IfNotPresent when deploying to local Kubernetes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4512, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}