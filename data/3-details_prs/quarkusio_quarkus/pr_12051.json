{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1Mjc0NzQz", "number": 12051, "title": "Only create the Reactive PoolProducers and health check beans if we produce a pool", "bodyText": "Fixes #12043\n/cc @rsvoboda @geoand", "createdAt": "2020-09-11T17:05:37Z", "url": "https://github.com/quarkusio/quarkus/pull/12051", "merged": true, "mergeCommit": {"oid": "10f44ccaf5e83a0e869a694f0356f309cb3ea239"}, "closed": true, "closedAt": "2020-09-14T09:09:25Z", "author": {"login": "gsmet"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH4gojAH2gAyNDg1Mjc0NzQzOjliZWRmZDQ3Nzc0OGQyYjM2MDdiYjQ0ZmFmMjc1ZWFmNzljZjQxMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIQl8GgFqTQ4NzI1NjY4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9bedfd477748d2b3607bb44faf275eaf79cf4101", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/9bedfd477748d2b3607bb44faf275eaf79cf4101", "committedDate": "2020-09-11T17:05:02Z", "message": "Only create the Reactive PoolProducers and health check beans if we produce a pool\n\nFixes #12043"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDE4MzMz", "url": "https://github.com/quarkusio/quarkus/pull/12051#pullrequestreview-487018333", "createdAt": "2020-09-11T18:08:49Z", "commit": {"oid": "9bedfd477748d2b3607bb44faf275eaf79cf4101"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODowODo0OVrOHQozrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODowODo0OVrOHQozrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIwNzg1Mw==", "bodyText": "Is this the default when no scope is used?", "url": "https://github.com/quarkusio/quarkus/pull/12051#discussion_r487207853", "createdAt": "2020-09-11T18:08:49Z", "author": {"login": "geoand"}, "path": "extensions/reactive-db2-client/deployment/src/main/java/io/quarkus/reactive/db2/client/deployment/ReactiveDB2ClientProcessor.java", "diffHunk": "@@ -30,9 +31,24 @@\n \n class ReactiveDB2ClientProcessor {\n \n+    /**\n+     * The producer needs to be produced in a separate method to avoid a circular dependency (the Vert.x instance creation\n+     * consumes the AdditionalBeanBuildItems).\n+     */\n     @BuildStep\n-    AdditionalBeanBuildItem registerBean() {\n-        return AdditionalBeanBuildItem.unremovableOf(DB2PoolProducer.class);\n+    void poolProducer(\n+            BuildProducer<AdditionalBeanBuildItem> additionalBeans,\n+            DataSourcesBuildTimeConfig dataSourcesBuildTimeConfig,\n+            DataSourceReactiveBuildTimeConfig dataSourceReactiveBuildTimeConfig) {\n+        if (!createPool(dataSourcesBuildTimeConfig, dataSourceReactiveBuildTimeConfig)) {\n+            return;\n+        }\n+\n+        additionalBeans.produce(new AdditionalBeanBuildItem.Builder()\n+                .addBeanClass(DB2PoolProducer.class)\n+                .setUnremovable()\n+                .setDefaultScope(DotNames.APPLICATION_SCOPED)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bedfd477748d2b3607bb44faf275eaf79cf4101"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDIyNjA1", "url": "https://github.com/quarkusio/quarkus/pull/12051#pullrequestreview-487022605", "createdAt": "2020-09-11T18:15:20Z", "commit": {"oid": "9bedfd477748d2b3607bb44faf275eaf79cf4101"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODoxNToyMVrOHQpAZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODoxNToyMVrOHQpAZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIxMTEwOQ==", "bodyText": "Can we have a comment on what the rationale is behind this?", "url": "https://github.com/quarkusio/quarkus/pull/12051#discussion_r487211109", "createdAt": "2020-09-11T18:15:21Z", "author": {"login": "geoand"}, "path": "extensions/reactive-db2-client/deployment/src/main/java/io/quarkus/reactive/db2/client/deployment/ReactiveDB2ClientProcessor.java", "diffHunk": "@@ -82,8 +93,30 @@ ServiceStartBuildItem build(BuildProducer<FeatureBuildItem> feature,\n     }\n \n     @BuildStep\n-    HealthBuildItem addHealthCheck(DataSourcesBuildTimeConfig dataSourcesBuildTimeConfig) {\n-        return new HealthBuildItem(\"io.quarkus.reactive.db2.client.runtime.health.ReactiveDB2DataSourceHealthCheck\",\n-                dataSourcesBuildTimeConfig.healthEnabled);\n+    void addHealthCheck(\n+            BuildProducer<HealthBuildItem> healthChecks,\n+            DataSourcesBuildTimeConfig dataSourcesBuildTimeConfig,\n+            DataSourceReactiveBuildTimeConfig dataSourceReactiveBuildTimeConfig) {\n+        if (!createPool(dataSourcesBuildTimeConfig, dataSourceReactiveBuildTimeConfig)) {\n+            return;\n+        }\n+\n+        healthChecks\n+                .produce(new HealthBuildItem(\"io.quarkus.reactive.db2.client.runtime.health.ReactiveDB2DataSourceHealthCheck\",\n+                        dataSourcesBuildTimeConfig.healthEnabled));\n+    }\n+\n+    private static boolean createPool(DataSourcesBuildTimeConfig dataSourcesBuildTimeConfig,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bedfd477748d2b3607bb44faf275eaf79cf4101"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjI3NTQ5", "url": "https://github.com/quarkusio/quarkus/pull/12051#pullrequestreview-487227549", "createdAt": "2020-09-12T12:48:14Z", "commit": {"oid": "9bedfd477748d2b3607bb44faf275eaf79cf4101"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MjU2Njg1", "url": "https://github.com/quarkusio/quarkus/pull/12051#pullrequestreview-487256685", "createdAt": "2020-09-12T21:08:33Z", "commit": {"oid": "9bedfd477748d2b3607bb44faf275eaf79cf4101"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 462, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}