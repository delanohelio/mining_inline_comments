{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MDA0OTM1", "number": 11322, "title": "Support multiple Hibernate ORM persistence units via Quarkus configuration", "bodyText": "/cc @Sanne @machi1990 @michael-schnell\nThis is the preliminary infrastructure work for the support of multiple persistence units. I would like to merge this PR early (well, as soon as we agree the code is correct) and then do additional follow-ups for tweaking how we do the entity <-> persistence unit mapping and if we allow an entity to belong to several persistence units.\nFixes #2835", "createdAt": "2020-08-11T10:07:15Z", "url": "https://github.com/quarkusio/quarkus/pull/11322", "merged": true, "mergeCommit": {"oid": "9cd6e1b32951239359bc146b0ded628d37a0bfca"}, "closed": true, "closedAt": "2020-08-21T10:18:21Z", "author": {"login": "gsmet"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-imMygBqjM2NTI4NzE2OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA3KhBAFqTQ3MjAwMTUxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8143d0b5be7120df35b17489fa0c06180000b78e", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/8143d0b5be7120df35b17489fa0c06180000b78e", "committedDate": "2020-08-11T12:35:50Z", "message": "fix: make sure that config section within the same config root are merged properly"}, "afterCommit": {"oid": "0dc2c5a3187e11d5c74c073fa4e52dbb685c18d2", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/0dc2c5a3187e11d5c74c073fa4e52dbb685c18d2", "committedDate": "2020-08-13T13:32:32Z", "message": "Introduce the CDI infrastructure for multi-persistence units\n\nIn passing, we now make JTA the only case handled.\nI will throw a proper error in a follow-up commit when not enabled."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0dc2c5a3187e11d5c74c073fa4e52dbb685c18d2", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/0dc2c5a3187e11d5c74c073fa4e52dbb685c18d2", "committedDate": "2020-08-13T13:32:32Z", "message": "Introduce the CDI infrastructure for multi-persistence units\n\nIn passing, we now make JTA the only case handled.\nI will throw a proper error in a follow-up commit when not enabled."}, "afterCommit": {"oid": "4d251f494105a090c4148c6f5ac10b0c2a2284e5", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/4d251f494105a090c4148c6f5ac10b0c2a2284e5", "committedDate": "2020-08-17T20:29:16Z", "message": "Simplify multiple persistence units configuration\n\nWe don't have a prefix in the other extensions so let's try to be\nconsistent and see how it goes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d251f494105a090c4148c6f5ac10b0c2a2284e5", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/4d251f494105a090c4148c6f5ac10b0c2a2284e5", "committedDate": "2020-08-17T20:29:16Z", "message": "Simplify multiple persistence units configuration\n\nWe don't have a prefix in the other extensions so let's try to be\nconsistent and see how it goes."}, "afterCommit": {"oid": "974f27f46f1b31c0d695f98e83ad2f80ec4bb37a", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/974f27f46f1b31c0d695f98e83ad2f80ec4bb37a", "committedDate": "2020-08-18T09:11:04Z", "message": "Throw an exception if storage engine configuration is not consistent\n\nIn passing, reorganize the dialect configuration to work around an issue\nwith SmallRye Config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1dabdd2303dc56f21e0de4b005e816b964624cc", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/d1dabdd2303dc56f21e0de4b005e816b964624cc", "committedDate": "2020-08-18T16:03:57Z", "message": "fix: make sure that config section within the same config root are merged properly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9894aad7625e158d284d7832be168ce0861a3ee", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/f9894aad7625e158d284d7832be168ce0861a3ee", "committedDate": "2020-08-18T16:11:22Z", "message": "fix: generate unique anchors for ConfigSection fom section title and section key"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74514b0c748f5e12ef9ad1cea23363ea429ba86a", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/74514b0c748f5e12ef9ad1cea23363ea429ba86a", "committedDate": "2020-08-18T16:11:26Z", "message": "Enable scanning in JPA tests as we enforce it now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a03d478e53efa5af1a5fdbdd76f88c94296a296", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/4a03d478e53efa5af1a5fdbdd76f88c94296a296", "committedDate": "2020-08-18T16:11:26Z", "message": "Prepare configuration for multiple persistence units support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc9096d22c99830b0e3e41d049d7bbca91a63912", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/bc9096d22c99830b0e3e41d049d7bbca91a63912", "committedDate": "2020-08-18T16:11:26Z", "message": "Support defining the datasource used by a persistence unit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "677360504960761d1aad2a2d8930882c0099df4e", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/677360504960761d1aad2a2d8930882c0099df4e", "committedDate": "2020-08-18T16:11:26Z", "message": "Add config for multiple persistence units"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31547956881919e36b0cd59423a57b9e008db3a1", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/31547956881919e36b0cd59423a57b9e008db3a1", "committedDate": "2020-08-18T16:11:26Z", "message": "Rename the default persistence unit to \"<default>\"\n\nIt has a special meaning and I don't want it to conflict with the user\ndefined ones."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0810c07943f8116b805bc58aa740f5cb3d3cc20b", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/0810c07943f8116b805bc58aa740f5cb3d3cc20b", "committedDate": "2020-08-18T16:11:26Z", "message": "Make archives containing entity packages part of the Jandex index"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f3362fbf2e4365fa73df2c4461b6672866b59d9", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/4f3362fbf2e4365fa73df2c4461b6672866b59d9", "committedDate": "2020-08-18T16:11:26Z", "message": "Reorganize HibernateOrmProcessor a bit\n\nNo code changes, just moving methods around."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fbaefb015ced7d85655ba0b06c4a95c418ec941", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/1fbaefb015ced7d85655ba0b06c4a95c418ec941", "committedDate": "2020-08-18T16:11:26Z", "message": "Introduce the CDI infrastructure for multi-persistence units\n\nIn passing, we now make JTA the only case handled.\nI will throw a proper error in a follow-up commit when not enabled."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51c87b827f8903bf6eb82b7c945917f4cfe5dd77", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/51c87b827f8903bf6eb82b7c945917f4cfe5dd77", "committedDate": "2020-08-18T16:11:26Z", "message": "Make JPAConfig less brittle and also publish the entity -> PUs mapping\n\nI decided to support multiple PUs there. We will see how it goes in\nPanache."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40a3711ffae078b1f11e3e206e0060d4cb72365c", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/40a3711ffae078b1f11e3e206e0060d4cb72365c", "committedDate": "2020-08-18T16:11:26Z", "message": "Move PersistenceUnitUtil to the runtime module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6faaa73c6dea8d1ec0adc6f6a59c3bcd073d7290", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/6faaa73c6dea8d1ec0adc6f6a59c3bcd073d7290", "committedDate": "2020-08-18T16:11:26Z", "message": "Throw an exception if no JTA\n\nSanne confirmed that not having JTA around is not a valid configuration.\nWe used to have some partial support for it but it was buggy at best.\n\nThe support was removed in a previous commit, this commit only adds a\nproper exception for it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3f718122128fb41bf949e2fdb9c8e2e5e4b7459", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/f3f718122128fb41bf949e2fdb9c8e2e5e4b7459", "committedDate": "2020-08-18T16:11:26Z", "message": "Simplify multiple persistence units configuration\n\nWe don't have a prefix in the other extensions so let's try to be\nconsistent and see how it goes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e79df93cb932e147dfe88c185fd99a576353970b", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/e79df93cb932e147dfe88c185fd99a576353970b", "committedDate": "2020-08-18T16:11:26Z", "message": "Throw an exception if storage engine configuration is not consistent\n\nIn passing, reorganize the dialect configuration to work around an issue\nwith SmallRye Config."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e729b013ddf512f07f51b79cde88b6f2056355b2", "author": {"user": {"login": "machi1990", "name": "Manyanda Chitimbo"}}, "url": "https://github.com/quarkusio/quarkus/commit/e729b013ddf512f07f51b79cde88b6f2056355b2", "committedDate": "2020-08-18T13:17:46Z", "message": "fix: generate unique anchors for ConfigSection fom section title and section key"}, "afterCommit": {"oid": "e79df93cb932e147dfe88c185fd99a576353970b", "author": {"user": {"login": "gsmet", "name": "Guillaume Smet"}}, "url": "https://github.com/quarkusio/quarkus/commit/e79df93cb932e147dfe88c185fd99a576353970b", "committedDate": "2020-08-18T16:11:26Z", "message": "Throw an exception if storage engine configuration is not consistent\n\nIn passing, reorganize the dialect configuration to work around an issue\nwith SmallRye Config."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODk3NjAw", "url": "https://github.com/quarkusio/quarkus/pull/11322#pullrequestreview-471897600", "createdAt": "2020-08-20T18:58:26Z", "commit": {"oid": "677360504960761d1aad2a2d8930882c0099df4e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODo1ODoyNlrOHEPHqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxODo1ODoyNlrOHEPHqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDIwNDA3Mw==", "bodyText": "Just curious, did you figure that this was necessary?", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474204073", "createdAt": "2020-08-20T18:58:26Z", "author": {"login": "Sanne"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -666,6 +697,14 @@ private static void producePersistenceUnitDescriptorFromConfig(\n         // we found one\n         ParsedPersistenceXmlDescriptor descriptor = new ParsedPersistenceXmlDescriptor(null); //todo URL\n         descriptor.setName(persistenceUnitName);\n+\n+        descriptor.setExcludeUnlistedClasses(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "677360504960761d1aad2a2d8930882c0099df4e"}, "originalPosition": 140}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTg5NDc3", "url": "https://github.com/quarkusio/quarkus/pull/11322#pullrequestreview-471989477", "createdAt": "2020-08-20T21:12:02Z", "commit": {"oid": "31547956881919e36b0cd59423a57b9e008db3a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMToxMjowMlrOHETeDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMToxMjowMlrOHETeDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI3NTM0MA==", "bodyText": "What do you mean by \"has special meaning\", is it not possible for a user to speficy this name explicitly?", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474275340", "createdAt": "2020-08-20T21:12:02Z", "author": {"login": "Sanne"}, "path": "extensions/hibernate-orm/deployment/src/main/java/io/quarkus/hibernate/orm/deployment/HibernateOrmProcessor.java", "diffHunk": "@@ -126,7 +126,7 @@\n \n     public static final String HIBERNATE_ORM_CONFIG_PREFIX = \"quarkus.hibernate-orm.\";\n     public static final String NO_SQL_LOAD_SCRIPT_FILE = \"no-file\";\n-    public static final String DEFAULT_PERSISTENCE_UNIT_NAME = \"default\";\n+    public static final String DEFAULT_PERSISTENCE_UNIT_NAME = \"<default>\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31547956881919e36b0cd59423a57b9e008db3a1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTkxMzAz", "url": "https://github.com/quarkusio/quarkus/pull/11322#pullrequestreview-471991303", "createdAt": "2020-08-20T21:15:10Z", "commit": {"oid": "677360504960761d1aad2a2d8930882c0099df4e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMToxNToxMFrOHETkAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMToxNToxMFrOHETkAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI3Njg2NA==", "bodyText": "Could you add a comment somewhere to remind why this is an invalid configuration? I guess because it's missing the package names filter packages?", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474276864", "createdAt": "2020-08-20T21:15:10Z", "author": {"login": "Sanne"}, "path": "extensions/hibernate-orm/deployment/src/test/resources/application-multiple-persistence-units-invalid.properties", "diffHunk": "@@ -0,0 +1,7 @@\n+quarkus.datasource.users.db-kind=h2\n+quarkus.datasource.users.jdbc.url=jdbc:h2:tcp://localhost/mem:users;DB_CLOSE_DELAY=-1\n+\n+quarkus.hibernate-orm.persistence-units.\"users\".dialect=org.hibernate.dialect.H2Dialect\n+quarkus.hibernate-orm.persistence-units.\"users\".log.sql=true\n+quarkus.hibernate-orm.persistence-units.\"users\".database.generation=drop-and-create\n+quarkus.hibernate-orm.persistence-units.\"users\".datasource=users", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "677360504960761d1aad2a2d8930882c0099df4e"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTk5MDMw", "url": "https://github.com/quarkusio/quarkus/pull/11322#pullrequestreview-471999030", "createdAt": "2020-08-20T21:29:00Z", "commit": {"oid": "1fbaefb015ced7d85655ba0b06c4a95c418ec941"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMToyOTowMFrOHET8Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMToyOTowMFrOHET8Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI4MzAzNQ==", "bodyText": "is this condition check useful? I was assuming that unitName would be always defined, at most <default>.\nIf I'm wrong, we might want to improve the following (nested) if so that the default can still be used/injected even when there's more than one PU defined.", "url": "https://github.com/quarkusio/quarkus/pull/11322#discussion_r474283035", "createdAt": "2020-08-20T21:29:00Z", "author": {"login": "Sanne"}, "path": "extensions/hibernate-orm/runtime/src/main/java/io/quarkus/hibernate/orm/runtime/JPAConfig.java", "diffHunk": "@@ -91,8 +70,22 @@ void initDefaultPersistenceUnit() {\n         }\n     }\n \n-    boolean isJtaEnabled() {\n-        return jtaEnabled.get();\n+    public EntityManagerFactory getEntityManagerFactory(String unitName) {\n+        LazyPersistenceUnit lazyPersistenceUnit = null;\n+        if (unitName == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fbaefb015ced7d85655ba0b06c4a95c418ec941"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDAxNTE5", "url": "https://github.com/quarkusio/quarkus/pull/11322#pullrequestreview-472001519", "createdAt": "2020-08-20T21:33:30Z", "commit": {"oid": "e79df93cb932e147dfe88c185fd99a576353970b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 963, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}