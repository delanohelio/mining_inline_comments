{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNTcxMTYx", "number": 2005, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODoxODoyOFrOEcsVEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODoyMzo0MlrOEcscNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTIxODc0OnYy", "diffSide": "RIGHT", "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/AwsCrtAsyncHttpClient.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODoxODoyOFrOHHYGZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTowMDowMFrOHHZgXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5NjkzMw==", "bodyText": "Duration has getSeconds()", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2005#discussion_r477496933", "createdAt": "2020-08-26T18:18:28Z", "author": {"login": "dagnir"}, "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/AwsCrtAsyncHttpClient.java", "diffHunk": "@@ -105,13 +106,25 @@ private AwsCrtAsyncHttpClient(DefaultBuilder builder, AttributeMap config) {\n \n             this.initialWindowSize = builder.initialWindowSize;\n             this.maxConnectionsPerEndpoint = maxConns;\n-            this.monitoringOptions = builder.monitoringOptions;\n+            this.monitoringOptions = revolveHttpMonitoringOptions(builder.connectionHealthChecksConfiguration);\n             this.maxConnectionIdleInMilliseconds = config.get(SdkHttpConfigurationOption.CONNECTION_MAX_IDLE_TIMEOUT).toMillis();\n \n             this.proxyOptions = buildProxyOptions(builder.proxyConfiguration);\n         }\n     }\n \n+    private HttpMonitoringOptions revolveHttpMonitoringOptions(ConnectionHealthChecksConfiguration config) {\n+        if (config == null) {\n+            return null;\n+        }\n+\n+        HttpMonitoringOptions httpMonitoringOptions = new HttpMonitoringOptions();\n+        httpMonitoringOptions.setMinThroughputBytesPerSecond(config.minThroughputInBytesPerSecond());\n+        int seconds = (int) (TimeUnit.MILLISECONDS.toSeconds(config.allowableThroughputFailureInterval().toMillis()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd11ca88504ad6f16696414f0b6b813de685af0a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxMjc4OQ==", "bodyText": "getSeconds only gets the seconds from the duration, i.e., not the total number of whole seconds in the duration\ntoSeconds is added since 9,, so we can't use it unfortunately. :(\nhttps://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/time/Duration.html#toSeconds()", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2005#discussion_r477512789", "createdAt": "2020-08-26T18:47:13Z", "author": {"login": "zoewangg"}, "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/AwsCrtAsyncHttpClient.java", "diffHunk": "@@ -105,13 +106,25 @@ private AwsCrtAsyncHttpClient(DefaultBuilder builder, AttributeMap config) {\n \n             this.initialWindowSize = builder.initialWindowSize;\n             this.maxConnectionsPerEndpoint = maxConns;\n-            this.monitoringOptions = builder.monitoringOptions;\n+            this.monitoringOptions = revolveHttpMonitoringOptions(builder.connectionHealthChecksConfiguration);\n             this.maxConnectionIdleInMilliseconds = config.get(SdkHttpConfigurationOption.CONNECTION_MAX_IDLE_TIMEOUT).toMillis();\n \n             this.proxyOptions = buildProxyOptions(builder.proxyConfiguration);\n         }\n     }\n \n+    private HttpMonitoringOptions revolveHttpMonitoringOptions(ConnectionHealthChecksConfiguration config) {\n+        if (config == null) {\n+            return null;\n+        }\n+\n+        HttpMonitoringOptions httpMonitoringOptions = new HttpMonitoringOptions();\n+        httpMonitoringOptions.setMinThroughputBytesPerSecond(config.minThroughputInBytesPerSecond());\n+        int seconds = (int) (TimeUnit.MILLISECONDS.toSeconds(config.allowableThroughputFailureInterval().toMillis()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5NjkzMw=="}, "originalCommit": {"oid": "fd11ca88504ad6f16696414f0b6b813de685af0a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxNTM3OQ==", "bodyText": "http://hg.openjdk.java.net/jdk9/jdk9/jdk/file/7f644a5d554a/src/java.base/share/classes/java/time/Duration.java they seem to have the same impl :P", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2005#discussion_r477515379", "createdAt": "2020-08-26T18:51:55Z", "author": {"login": "dagnir"}, "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/AwsCrtAsyncHttpClient.java", "diffHunk": "@@ -105,13 +106,25 @@ private AwsCrtAsyncHttpClient(DefaultBuilder builder, AttributeMap config) {\n \n             this.initialWindowSize = builder.initialWindowSize;\n             this.maxConnectionsPerEndpoint = maxConns;\n-            this.monitoringOptions = builder.monitoringOptions;\n+            this.monitoringOptions = revolveHttpMonitoringOptions(builder.connectionHealthChecksConfiguration);\n             this.maxConnectionIdleInMilliseconds = config.get(SdkHttpConfigurationOption.CONNECTION_MAX_IDLE_TIMEOUT).toMillis();\n \n             this.proxyOptions = buildProxyOptions(builder.proxyConfiguration);\n         }\n     }\n \n+    private HttpMonitoringOptions revolveHttpMonitoringOptions(ConnectionHealthChecksConfiguration config) {\n+        if (config == null) {\n+            return null;\n+        }\n+\n+        HttpMonitoringOptions httpMonitoringOptions = new HttpMonitoringOptions();\n+        httpMonitoringOptions.setMinThroughputBytesPerSecond(config.minThroughputInBytesPerSecond());\n+        int seconds = (int) (TimeUnit.MILLISECONDS.toSeconds(config.allowableThroughputFailureInterval().toMillis()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5NjkzMw=="}, "originalCommit": {"oid": "fd11ca88504ad6f16696414f0b6b813de685af0a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxNTU2OA==", "bodyText": "don't feel strongly about this though", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2005#discussion_r477515568", "createdAt": "2020-08-26T18:52:18Z", "author": {"login": "dagnir"}, "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/AwsCrtAsyncHttpClient.java", "diffHunk": "@@ -105,13 +106,25 @@ private AwsCrtAsyncHttpClient(DefaultBuilder builder, AttributeMap config) {\n \n             this.initialWindowSize = builder.initialWindowSize;\n             this.maxConnectionsPerEndpoint = maxConns;\n-            this.monitoringOptions = builder.monitoringOptions;\n+            this.monitoringOptions = revolveHttpMonitoringOptions(builder.connectionHealthChecksConfiguration);\n             this.maxConnectionIdleInMilliseconds = config.get(SdkHttpConfigurationOption.CONNECTION_MAX_IDLE_TIMEOUT).toMillis();\n \n             this.proxyOptions = buildProxyOptions(builder.proxyConfiguration);\n         }\n     }\n \n+    private HttpMonitoringOptions revolveHttpMonitoringOptions(ConnectionHealthChecksConfiguration config) {\n+        if (config == null) {\n+            return null;\n+        }\n+\n+        HttpMonitoringOptions httpMonitoringOptions = new HttpMonitoringOptions();\n+        httpMonitoringOptions.setMinThroughputBytesPerSecond(config.minThroughputInBytesPerSecond());\n+        int seconds = (int) (TimeUnit.MILLISECONDS.toSeconds(config.allowableThroughputFailureInterval().toMillis()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5NjkzMw=="}, "originalCommit": {"oid": "fd11ca88504ad6f16696414f0b6b813de685af0a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxNzQzNg==", "bodyText": "Interesting! Didn't know they have the same impl. Why do they have two APIs then?! \ud83e\udd14", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2005#discussion_r477517436", "createdAt": "2020-08-26T18:55:35Z", "author": {"login": "zoewangg"}, "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/AwsCrtAsyncHttpClient.java", "diffHunk": "@@ -105,13 +106,25 @@ private AwsCrtAsyncHttpClient(DefaultBuilder builder, AttributeMap config) {\n \n             this.initialWindowSize = builder.initialWindowSize;\n             this.maxConnectionsPerEndpoint = maxConns;\n-            this.monitoringOptions = builder.monitoringOptions;\n+            this.monitoringOptions = revolveHttpMonitoringOptions(builder.connectionHealthChecksConfiguration);\n             this.maxConnectionIdleInMilliseconds = config.get(SdkHttpConfigurationOption.CONNECTION_MAX_IDLE_TIMEOUT).toMillis();\n \n             this.proxyOptions = buildProxyOptions(builder.proxyConfiguration);\n         }\n     }\n \n+    private HttpMonitoringOptions revolveHttpMonitoringOptions(ConnectionHealthChecksConfiguration config) {\n+        if (config == null) {\n+            return null;\n+        }\n+\n+        HttpMonitoringOptions httpMonitoringOptions = new HttpMonitoringOptions();\n+        httpMonitoringOptions.setMinThroughputBytesPerSecond(config.minThroughputInBytesPerSecond());\n+        int seconds = (int) (TimeUnit.MILLISECONDS.toSeconds(config.allowableThroughputFailureInterval().toMillis()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5NjkzMw=="}, "originalCommit": {"oid": "fd11ca88504ad6f16696414f0b6b813de685af0a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxOTk2Nw==", "bodyText": "Found this relevant link: https://bugs.openjdk.java.net/browse/JDK-8142936\nTL;DR They added toSeconds to be consistent with other toXXX methods", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2005#discussion_r477519967", "createdAt": "2020-08-26T19:00:00Z", "author": {"login": "zoewangg"}, "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/AwsCrtAsyncHttpClient.java", "diffHunk": "@@ -105,13 +106,25 @@ private AwsCrtAsyncHttpClient(DefaultBuilder builder, AttributeMap config) {\n \n             this.initialWindowSize = builder.initialWindowSize;\n             this.maxConnectionsPerEndpoint = maxConns;\n-            this.monitoringOptions = builder.monitoringOptions;\n+            this.monitoringOptions = revolveHttpMonitoringOptions(builder.connectionHealthChecksConfiguration);\n             this.maxConnectionIdleInMilliseconds = config.get(SdkHttpConfigurationOption.CONNECTION_MAX_IDLE_TIMEOUT).toMillis();\n \n             this.proxyOptions = buildProxyOptions(builder.proxyConfiguration);\n         }\n     }\n \n+    private HttpMonitoringOptions revolveHttpMonitoringOptions(ConnectionHealthChecksConfiguration config) {\n+        if (config == null) {\n+            return null;\n+        }\n+\n+        HttpMonitoringOptions httpMonitoringOptions = new HttpMonitoringOptions();\n+        httpMonitoringOptions.setMinThroughputBytesPerSecond(config.minThroughputInBytesPerSecond());\n+        int seconds = (int) (TimeUnit.MILLISECONDS.toSeconds(config.allowableThroughputFailureInterval().toMillis()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5NjkzMw=="}, "originalCommit": {"oid": "fd11ca88504ad6f16696414f0b6b813de685af0a"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTIzNzAxOnYy", "diffSide": "RIGHT", "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/ConnectionHealthChecksConfiguration.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODoyMzo0MlrOHHYRjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODo0NDowMFrOHHY80g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5OTc4OQ==", "bodyText": "nit: Duration doesn't have a single unit so I don't think it would make sense to say \"in seconds\" here. We might want to add a note on the setter that it only supports seconds precision though", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2005#discussion_r477499789", "createdAt": "2020-08-26T18:23:42Z", "author": {"login": "dagnir"}, "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/ConnectionHealthChecksConfiguration.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.http.crt;\n+\n+import java.time.Duration;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * Configuration that defines health checks for for all connections established by\n+ * the{@link ConnectionHealthChecksConfiguration}.\n+ */\n+@SdkPublicApi\n+public final class ConnectionHealthChecksConfiguration {\n+    private final long minThroughputInBytesPerSecond;\n+    private final Duration allowableThroughputFailureInterval;\n+\n+    private ConnectionHealthChecksConfiguration(DefaultConnectionHealthChecksConfigurationBuilder builder) {\n+        this.minThroughputInBytesPerSecond = Validate.paramNotNull(builder.minThroughputInBytesPerSecond,\n+                                                                   \"minThroughputInBytesPerSecond\");\n+        this.allowableThroughputFailureInterval = Validate.isPositive(builder.allowableThroughputFailureIntervalSeconds,\n+                                                                      \"allowableThroughputFailureIntervalSeconds\");\n+    }\n+\n+    /**\n+     * @return the minimum amount of throughput, in bytes per second, for a connection to be considered healthy.\n+     */\n+    public long minThroughputInBytesPerSecond() {\n+        return minThroughputInBytesPerSecond;\n+    }\n+\n+    /**\n+     * @return How long, in seconds, a connection is allowed to be unhealthy before getting shut down.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd11ca88504ad6f16696414f0b6b813de685af0a"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUxMDg2Ng==", "bodyText": "Yup, copy paste error", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2005#discussion_r477510866", "createdAt": "2020-08-26T18:44:00Z", "author": {"login": "zoewangg"}, "path": "http-clients/aws-crt-client/src/main/java/software/amazon/awssdk/http/crt/ConnectionHealthChecksConfiguration.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.http.crt;\n+\n+import java.time.Duration;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * Configuration that defines health checks for for all connections established by\n+ * the{@link ConnectionHealthChecksConfiguration}.\n+ */\n+@SdkPublicApi\n+public final class ConnectionHealthChecksConfiguration {\n+    private final long minThroughputInBytesPerSecond;\n+    private final Duration allowableThroughputFailureInterval;\n+\n+    private ConnectionHealthChecksConfiguration(DefaultConnectionHealthChecksConfigurationBuilder builder) {\n+        this.minThroughputInBytesPerSecond = Validate.paramNotNull(builder.minThroughputInBytesPerSecond,\n+                                                                   \"minThroughputInBytesPerSecond\");\n+        this.allowableThroughputFailureInterval = Validate.isPositive(builder.allowableThroughputFailureIntervalSeconds,\n+                                                                      \"allowableThroughputFailureIntervalSeconds\");\n+    }\n+\n+    /**\n+     * @return the minimum amount of throughput, in bytes per second, for a connection to be considered healthy.\n+     */\n+    public long minThroughputInBytesPerSecond() {\n+        return minThroughputInBytesPerSecond;\n+    }\n+\n+    /**\n+     * @return How long, in seconds, a connection is allowed to be unhealthy before getting shut down.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ5OTc4OQ=="}, "originalCommit": {"oid": "fd11ca88504ad6f16696414f0b6b813de685af0a"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3999, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}