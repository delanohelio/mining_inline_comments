{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMzg0MTIz", "number": 2179, "title": "Add amz-sdk-request header, removed amz-sdk-retry header.", "bodyText": "Most changes are from a rename of MockHttpClient to MockSyncHttpClient so that a common parent interface can be added for generic programming purposes.\nThe new amz-sdk-request header does not include the TTL, because it's not at all easy to calculate with pluggable HTTP clients and the specification lists it as optional. The TTL can be added when service teams ask for it.", "createdAt": "2020-12-03T00:56:24Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179", "merged": true, "mergeCommit": {"oid": "0e016da4cea171080563e99881985268ad36da71"}, "closed": true, "closedAt": "2020-12-07T18:56:20Z", "author": {"login": "millems"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdinvQ7gFqTU0NDI3MTk2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj5-P_AH2gAyNTMxMzg0MTIzOjdjOWE0N2VhODMwOThlYWYxMDk5NTc5NWI2OTFjODRmY2EzNjkxYTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MjcxOTYy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#pullrequestreview-544271962", "createdAt": "2020-12-03T18:48:35Z", "commit": {"oid": "5179a538b5ecdcf960424ac9d33df2d9f0df09ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODo0ODozNVrOH-r4JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODo0ODozNVrOH-r4JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ5MjY0NQ==", "bodyText": "I think the retry capacity is very valuable for troubleshooting; otherwise there's no way to tell if the retry gets throttled. I've seen an issue before where all requests failed of IOException, and I initially thought all retry attempts failed, but this header made me realize that the request did not get retried because there was no retry capacity.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#discussion_r535492645", "createdAt": "2020-12-03T18:48:35Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/http/pipeline/stages/utils/RetryableStageHelper.java", "diffHunk": "@@ -140,14 +139,8 @@ public void logBackingOff(Duration backoffDelay) {\n      * Retrieve the request to send to the service, including any detailed retry information headers.\n      */\n     public SdkHttpFullRequest requestToSend() {\n-        Integer availableRetryCapacity = TokenBucketRetryCondition.getCapacityForExecution(context.executionAttributes())\n-                                                                  .map(TokenBucketRetryCondition.Capacity::capacityRemaining)\n-                                                                  .orElse(null);\n-        String headerValue = (attemptNumber - 1) + \"/\" +\n-                             context.executionAttributes().getAttribute(LAST_BACKOFF_DELAY_DURATION).toMillis() + \"/\" +\n-                             (availableRetryCapacity != null ? availableRetryCapacity : \"\");\n         return request.toBuilder()\n-                      .putHeader(SDK_RETRY_INFO_HEADER, headerValue)\n+                      .putHeader(SDK_RETRY_INFO_HEADER, \"attempt=\" + attemptNumber + \"; max=\" + retryPolicy.numRetries())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5179a538b5ecdcf960424ac9d33df2d9f0df09ae"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5179a538b5ecdcf960424ac9d33df2d9f0df09ae", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/5179a538b5ecdcf960424ac9d33df2d9f0df09ae", "committedDate": "2020-12-03T00:55:50Z", "message": "Add amz-sdk-request header, removed amz-sdk-retry header.\n\nMost changes are from a rename of MockHttpClient to MockSyncHttpClient so that a common parent interface can be added for generic programming purposes.\n\nThe new amz-sdk-request header does not include the TTL, because it's not at all easy to calculate with pluggable HTTP clients and the specification lists it as optional. The TTL can be added when service teams ask for it."}, "afterCommit": {"oid": "5d9c56af62bc6c7c67438bd983e9db4d7d26929f", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/5d9c56af62bc6c7c67438bd983e9db4d7d26929f", "committedDate": "2020-12-04T18:44:23Z", "message": "Add amz-sdk-request header, removed amz-sdk-retry header.\n\nMost changes are from a rename of MockHttpClient to MockSyncHttpClient so that a common parent interface can be added for generic programming purposes.\n\nThe new amz-sdk-request header does not include the TTL, because it's not at all easy to calculate with pluggable HTTP clients and the specification lists it as optional. The TTL can be added when service teams ask for it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cffce865aaed308f5ba8b818b3bb660c5421ec0", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/1cffce865aaed308f5ba8b818b3bb660c5421ec0", "committedDate": "2020-12-04T18:48:26Z", "message": "Add amz-sdk-request header, removed amz-sdk-retry header.\n\nMost changes are from a rename of MockHttpClient to MockSyncHttpClient so that a common parent interface can be added for generic programming purposes.\n\nThe new amz-sdk-request header does not include the TTL, because it's not at all easy to calculate with pluggable HTTP clients and the specification lists it as optional. The TTL can be added when service teams ask for it."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d9c56af62bc6c7c67438bd983e9db4d7d26929f", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/5d9c56af62bc6c7c67438bd983e9db4d7d26929f", "committedDate": "2020-12-04T18:44:23Z", "message": "Add amz-sdk-request header, removed amz-sdk-retry header.\n\nMost changes are from a rename of MockHttpClient to MockSyncHttpClient so that a common parent interface can be added for generic programming purposes.\n\nThe new amz-sdk-request header does not include the TTL, because it's not at all easy to calculate with pluggable HTTP clients and the specification lists it as optional. The TTL can be added when service teams ask for it."}, "afterCommit": {"oid": "1cffce865aaed308f5ba8b818b3bb660c5421ec0", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/1cffce865aaed308f5ba8b818b3bb660c5421ec0", "committedDate": "2020-12-04T18:48:26Z", "message": "Add amz-sdk-request header, removed amz-sdk-retry header.\n\nMost changes are from a rename of MockHttpClient to MockSyncHttpClient so that a common parent interface can be added for generic programming purposes.\n\nThe new amz-sdk-request header does not include the TTL, because it's not at all easy to calculate with pluggable HTTP clients and the specification lists it as optional. The TTL can be added when service teams ask for it."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzEzMzc4", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#pullrequestreview-545313378", "createdAt": "2020-12-04T21:38:47Z", "commit": {"oid": "1cffce865aaed308f5ba8b818b3bb660c5421ec0"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTozODo0N1rOH_i7Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTozOTozNlrOH_i82w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5NDUyNg==", "bodyText": "debug?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#discussion_r536394526", "createdAt": "2020-12-04T21:38:47Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/conditions/TokenBucketRetryCondition.java", "diffHunk": "@@ -122,9 +125,17 @@ public boolean shouldRetry(RetryPolicyContext context) {\n             context.executionAttributes().putAttribute(LAST_ACQUIRED_CAPACITY, c);\n             context.executionAttributes().putAttribute(RETRY_COUNT_OF_LAST_CAPACITY_ACQUISITION,\n                                                        context.retriesAttempted());\n+            log.trace(() -> \"Successfully acquired token bucket capacity to retry this request. \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cffce865aaed308f5ba8b818b3bb660c5421ec0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM5NDk3MQ==", "bodyText": "Nice!", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#discussion_r536394971", "createdAt": "2020-12-04T21:39:36Z", "author": {"login": "zoewangg"}, "path": "test/codegen-generated-classes-test/src/test/java/software/amazon/awssdk/services/retry/RetryHeaderTestSuite.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.retry;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.util.List;\n+import java.util.stream.Stream;\n+import org.junit.Before;\n+import org.junit.Test;\n+import software.amazon.awssdk.http.HttpExecuteResponse;\n+import software.amazon.awssdk.http.SdkHttpRequest;\n+import software.amazon.awssdk.http.SdkHttpResponse;\n+import software.amazon.awssdk.testutils.service.http.MockHttpClient;\n+\n+/**\n+ * A set of tests that verify the behavior of retry-related headers (amz-sdk-invocation-id and amz-sdk-request).\n+ */\n+public abstract class RetryHeaderTestSuite<T extends MockHttpClient> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cffce865aaed308f5ba8b818b3bb660c5421ec0"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c30b458eded8a6afde517863df9a602682d8b817", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/c30b458eded8a6afde517863df9a602682d8b817", "committedDate": "2020-12-04T22:44:23Z", "message": "Merge branch 'master' into millem/retry-headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02cedf415d1e5802f8cc350624ed2778c8be6dd2", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/02cedf415d1e5802f8cc350624ed2778c8be6dd2", "committedDate": "2020-12-07T18:31:19Z", "message": "Merge branch 'master' into millem/retry-headers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NDIzNjg3", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2179#pullrequestreview-546423687", "createdAt": "2020-12-07T18:32:14Z", "commit": {"oid": "02cedf415d1e5802f8cc350624ed2778c8be6dd2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c9a47ea83098eaf10995795b691c84fca3691a8", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7c9a47ea83098eaf10995795b691c84fca3691a8", "committedDate": "2020-12-07T18:37:10Z", "message": "Merge branch 'master' into millem/retry-headers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2388, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}