{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMjEyMzI4", "number": 2182, "title": "Handle TLS 1.3 bad cert errors in proxy handler", "bodyText": "Description\nFixed the issue where BAD_CERTIFICATE issue manifested as acquire connection timeout error when using TLS1.3 and proxy.\nMotivation and Context\nRequests w/ proxy\n\nBefore this change\n\n\n\n\nTLS version\nBAD_CERTIFICATE error\n\n\n\n\nTLS 1.2\njava.io.IOException: Unable to send CONNECT request to proxy\n\n\nTLS 1.3\nAcquire operation took longer than the configured maximum time\n\n\n\n\nAfter this change\n\n\n\n\nTLS version\nBAD_CERTIFICATE error\n\n\n\n\nTLS 1.2\njava.io.IOException: Unable to send CONNECT request to proxy\n\n\nTLS 1.3\njava.io.IOException: Unable to send CONNECT request to proxy\n\n\n\nRequests w/o proxy\n\nBefore this change\n\n\n\n\nTLS version\nBAD_CERTIFICATE error\n\n\n\n\nTLS 1.2\nThe channel was closed...\n\n\nTLS 1.3\nServer failed to send complete response\n\n\n\n\nAfter this change\n\n\n\n\nTLS version\nBAD_CERTIFICATE error\n\n\n\n\nTLS 1.2\nThe channel was closed...\n\n\nTLS 1.3\nServer failed to send complete response. The channel was closed...\n\n\n\nTesting\nAdded unit tests.\nScreenshots (if appropriate)\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n I have read the CONTRIBUTING document\n Local run of mvn install succeeds\n My code follows the code style of this project\n My change requires a change to the Javadoc documentation\n I have updated the Javadoc documentation accordingly\n I have read the README document\n I have added tests to cover my changes\n All new and existing tests passed\n A short description of the change has been added to the CHANGELOG\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-12-04T00:51:02Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2182", "merged": true, "mergeCommit": {"oid": "a235d0adb9502a0a220c79432c8692e8c3470c1d"}, "closed": true, "closedAt": "2020-12-07T21:14:05Z", "author": {"login": "zoewangg"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABditRtgABqjQwNzA1Mjk2NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj6T5ugH2gAyNTMyMjEyMzI4OjdhNGU4NjkyNTM2M2RjYWU0ZDUxOTczZTFmNGU1NGVjMDExMWFkMzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5629478eb7c65768b469200ba2764def8cc8cd16", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/5629478eb7c65768b469200ba2764def8cc8cd16", "committedDate": "2020-12-04T00:49:32Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}, "afterCommit": {"oid": "e0883306a924e68d8f62b63a55af35ecf2f76d38", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/e0883306a924e68d8f62b63a55af35ecf2f76d38", "committedDate": "2020-12-04T01:15:34Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0883306a924e68d8f62b63a55af35ecf2f76d38", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/e0883306a924e68d8f62b63a55af35ecf2f76d38", "committedDate": "2020-12-04T01:15:34Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}, "afterCommit": {"oid": "07322d278993238d9dd9a058642a8e084c8a6985", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/07322d278993238d9dd9a058642a8e084c8a6985", "committedDate": "2020-12-04T01:41:58Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjAyMDEz", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2182#pullrequestreview-545202013", "createdAt": "2020-12-04T18:32:25Z", "commit": {"oid": "07322d278993238d9dd9a058642a8e084c8a6985"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODozMjoyNVrOH_c_Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxODozMjoyNVrOH_c_Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI5NzI2Ng==", "bodyText": "Is there any way we can detect that it was a handshake error so that they don't have to enable SSL logs? I wouldn't want every customer having to enable SSL logs to see if it was a handshake error just a plain-ol'-closed-channel.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2182#discussion_r536297266", "createdAt": "2020-12-04T18:32:25Z", "author": {"login": "millems"}, "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/utils/NettyUtils.java", "diffHunk": "@@ -40,6 +40,14 @@\n      */\n     public static final SucceededFuture<?> SUCCEEDED_FUTURE = new SucceededFuture<>(null, null);\n \n+    public static final String CLOSED_CHANNEL_MESSAGE = \"The channel was closed. This may have been done by the client (e.g. \"\n+                                                        + \"because the request was aborted), \" +\n+                                                        \"by the service (e.g. because there was a handshake error[use -Djavax\"\n+                                                        + \".net.debug=ssl to enable SSL logs], the request \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07322d278993238d9dd9a058642a8e084c8a6985"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzIzMzEy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2182#pullrequestreview-545323312", "createdAt": "2020-12-04T21:52:46Z", "commit": {"oid": "07322d278993238d9dd9a058642a8e084c8a6985"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTo1Mjo0NlrOH_jcrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTo1Mjo0NlrOH_jcrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQwMzExOA==", "bodyText": "Any reason we propagate this event, when initPromise is already done, but not channelInactive?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2182#discussion_r536403118", "createdAt": "2020-12-04T21:52:46Z", "author": {"login": "dagnir"}, "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ProxyTunnelInitHandler.java", "diffHunk": "@@ -98,6 +96,31 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) {\n         initPromise.setFailure(new IOException(\"Could not connect to proxy\"));\n     }\n \n+    @Override\n+    public void channelInactive(ChannelHandlerContext ctx) {\n+        if (!initPromise.isDone()) {\n+            handleConnectRequestFailure(ctx, null);\n+        }\n+    }\n+\n+    @Override\n+    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {\n+        if (!initPromise.isDone()) {\n+            handleConnectRequestFailure(ctx, cause);\n+        } else {\n+            ctx.fireExceptionCaught(cause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07322d278993238d9dd9a058642a8e084c8a6985"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07322d278993238d9dd9a058642a8e084c8a6985", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/07322d278993238d9dd9a058642a8e084c8a6985", "committedDate": "2020-12-04T01:41:58Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}, "afterCommit": {"oid": "658a3df33e582f7e074355aeb4a68f6da660e44e", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/658a3df33e582f7e074355aeb4a68f6da660e44e", "committedDate": "2020-12-04T23:28:48Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "658a3df33e582f7e074355aeb4a68f6da660e44e", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/658a3df33e582f7e074355aeb4a68f6da660e44e", "committedDate": "2020-12-04T23:28:48Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}, "afterCommit": {"oid": "babd6013d225add3ba08119e13e3f962f6d2fec3", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/babd6013d225add3ba08119e13e3f962f6d2fec3", "committedDate": "2020-12-04T23:29:30Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MzY4MjE4", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2182#pullrequestreview-545368218", "createdAt": "2020-12-04T23:49:48Z", "commit": {"oid": "babd6013d225add3ba08119e13e3f962f6d2fec3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMzo0OTo0OFrOH_mRvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMzo0OTo0OFrOH_mRvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ0OTQ3MA==", "bodyText": "nit: is this issue unique to BAD_CERTIFICATE?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2182#discussion_r536449470", "createdAt": "2020-12-04T23:49:48Z", "author": {"login": "dagnir"}, "path": ".changes/next-release/bugfix-NettyNIOHTTPClient-dbb46f2.json", "diffHunk": "@@ -0,0 +1,6 @@\n+{\n+    \"category\": \"Netty NIO HTTP Client\", \n+    \"contributor\": \"\", \n+    \"type\": \"bugfix\", \n+    \"description\": \"Fixed the issue where BAD_CERTIFICATE issue manifested as acquire connection timeout error when using TLS1.3 and proxy.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "babd6013d225add3ba08119e13e3f962f6d2fec3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d102e8aaf9d00adf6cecf6fd139b484fdb2e5997", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d102e8aaf9d00adf6cecf6fd139b484fdb2e5997", "committedDate": "2020-12-07T18:47:35Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "babd6013d225add3ba08119e13e3f962f6d2fec3", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/babd6013d225add3ba08119e13e3f962f6d2fec3", "committedDate": "2020-12-04T23:29:30Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}, "afterCommit": {"oid": "d102e8aaf9d00adf6cecf6fd139b484fdb2e5997", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d102e8aaf9d00adf6cecf6fd139b484fdb2e5997", "committedDate": "2020-12-07T18:47:35Z", "message": "Handle TLS 1.3 bad cert errors in proxy handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a4e86925363dcae4d51973e1f4e54ec0111ad36", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7a4e86925363dcae4d51973e1f4e54ec0111ad36", "committedDate": "2020-12-07T19:00:49Z", "message": "Merge branch 'master' into zoewang/fixNettyProxy-TLS1.3"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2392, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}