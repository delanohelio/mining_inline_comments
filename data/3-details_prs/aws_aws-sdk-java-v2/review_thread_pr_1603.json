{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NDk1Nzc5", "number": 1603, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMjozMjozMVrODZqJ9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMjo1MTo1NFrODZqcqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjMxNjY4OnYy", "diffSide": "RIGHT", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/Http2MultiplexedChannelPool.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMjozMjozMVrOFgLB-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMjo1MDo0MFrOFgLdGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI3OTQ4Mw==", "bodyText": "Still not sure if we should set it to warn as GOAWAY is not uncommon and retry normally should work. Using warn might raise unnecessary concerns.\nCan we add the message in the exception instead?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1603#discussion_r369279483", "createdAt": "2020-01-21T22:32:31Z", "author": {"login": "zoewangg"}, "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/Http2MultiplexedChannelPool.java", "diffHunk": "@@ -316,7 +316,7 @@ private boolean acquireStreamOnInitializedConnection(MultiplexedChannelRecord ch\n     }\n \n     public void handleGoAway(Channel parentChannel, int lastStreamId, GoAwayException exception) {\n-        log.debug(() -> \"Received GOAWAY on \" + parentChannel + \" with lastStreamId of \" + lastStreamId);\n+        log.warn(() -> \"Received GOAWAY on \" + parentChannel + \" with lastStreamId of \" + lastStreamId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e56b888fc33386e63102d14568e4bf1713b9e1e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4NjQyNA==", "bodyText": "Yeah looking at this again, I don't think it's necessary to increase the level here. The changes MultiplexedChannelRecord should be all we need", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1603#discussion_r369286424", "createdAt": "2020-01-21T22:50:40Z", "author": {"login": "dagnir"}, "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/Http2MultiplexedChannelPool.java", "diffHunk": "@@ -316,7 +316,7 @@ private boolean acquireStreamOnInitializedConnection(MultiplexedChannelRecord ch\n     }\n \n     public void handleGoAway(Channel parentChannel, int lastStreamId, GoAwayException exception) {\n-        log.debug(() -> \"Received GOAWAY on \" + parentChannel + \" with lastStreamId of \" + lastStreamId);\n+        log.warn(() -> \"Received GOAWAY on \" + parentChannel + \" with lastStreamId of \" + lastStreamId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI3OTQ4Mw=="}, "originalCommit": {"oid": "3e56b888fc33386e63102d14568e4bf1713b9e1e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MjM2NDU2OnYy", "diffSide": "RIGHT", "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/MultiplexedChannelRecord.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMjo1MTo1NFrOFgLe5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzowODo1MFrOFgL19A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4Njg4NA==", "bodyText": "Same here. Can we add the message in the exception instead?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1603#discussion_r369286884", "createdAt": "2020-01-21T22:51:54Z", "author": {"login": "zoewangg"}, "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/MultiplexedChannelRecord.java", "diffHunk": "@@ -81,7 +82,15 @@ boolean acquireStream(Promise<Channel> promise) {\n     private void acquireClaimedStream(Promise<Channel> promise) {\n         doInEventLoop(connection.eventLoop(), () -> {\n             if (state != RecordState.OPEN) {\n-                String message = \"Connection received GOAWAY or was closed while acquiring new stream.\";\n+                String message;\n+                // GOAWAY\n+                if (state == RecordState.CLOSED_TO_NEW) {\n+                    message = String.format(\"Connection %s received GOAWAY with Last Stream ID %d. Unable to open new \"\n+                                            + \"streams on this connection.\", connection, lastStreamId);\n+                } else {\n+                    message = String.format(\"Connection %s was closed while acquiring new stream.\", connection);\n+                }\n+                log.warn(() -> message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e56b888fc33386e63102d14568e4bf1713b9e1e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI5Mjc4OA==", "bodyText": "I would rather keep this here. This is the specific case we care about right, trying to create a stream on one that has received a GOAWAY. The message is added to the exception as well", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1603#discussion_r369292788", "createdAt": "2020-01-21T23:08:50Z", "author": {"login": "dagnir"}, "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/http2/MultiplexedChannelRecord.java", "diffHunk": "@@ -81,7 +82,15 @@ boolean acquireStream(Promise<Channel> promise) {\n     private void acquireClaimedStream(Promise<Channel> promise) {\n         doInEventLoop(connection.eventLoop(), () -> {\n             if (state != RecordState.OPEN) {\n-                String message = \"Connection received GOAWAY or was closed while acquiring new stream.\";\n+                String message;\n+                // GOAWAY\n+                if (state == RecordState.CLOSED_TO_NEW) {\n+                    message = String.format(\"Connection %s received GOAWAY with Last Stream ID %d. Unable to open new \"\n+                                            + \"streams on this connection.\", connection, lastStreamId);\n+                } else {\n+                    message = String.format(\"Connection %s was closed while acquiring new stream.\", connection);\n+                }\n+                log.warn(() -> message);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4Njg4NA=="}, "originalCommit": {"oid": "3e56b888fc33386e63102d14568e4bf1713b9e1e"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4320, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}