{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMDg0Mzgw", "number": 1721, "title": "Log signed event for easier debugging", "bodyText": "Description\nIn case of future bugs related to event stream signing, this should help in\ndebuggging to see the contents of the message in an easier to read format.\nMotivation and Context\nNice to have for future debugging.\nTesting\nmvn clean install\nScreenshots (if appropriate)\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n I have read the CONTRIBUTING document\n Local run of mvn install succeeds\n My code follows the code style of this project\n My change requires a change to the Javadoc documentation\n I have updated the Javadoc documentation accordingly\n I have read the README document\n I have added tests to cover my changes\n All new and existing tests passed\n A short description of the change has been added to the CHANGELOG\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-03-17T21:22:02Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721", "merged": true, "mergeCommit": {"oid": "c4a2596dd8aee2a2956778382199547e1e54cc6f"}, "closed": true, "closedAt": "2020-03-17T23:12:04Z", "author": {"login": "dagnir"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOpostgBqjMxMzkxNDM3NDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOqturgBqjMxMzkzMzE0NjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07910dac258bd64ed568b906791800c907fd148a", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/07910dac258bd64ed568b906791800c907fd148a", "committedDate": "2020-03-17T21:15:00Z", "message": "Log signed event for easier debugging\n\nIn case of future bugs related to event stream signing, this should help in\ndebuggging to see the contents of the message in an easier to read format."}, "afterCommit": {"oid": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/cb34fc80876e356ac6a9796751c4df2f9b8eb6ce", "committedDate": "2020-03-17T21:31:25Z", "message": "Log signed event for easier debugging\n\nIn case of future bugs related to event stream signing, this should help in\ndebuggging to see the contents of the message in an easier to read format."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NDQ0MDA2", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#pullrequestreview-376444006", "createdAt": "2020-03-17T22:18:00Z", "commit": {"oid": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMjoxODowMFrOF3wAsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMjoyMzowOVrOF3wItA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMjYwOQ==", "bodyText": "Log4j2 docs suggest we could use logger.isTraceEnabled() here? Might be slightly better than passing a string", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394002609", "createdAt": "2020-03-17T22:18:00Z", "author": {"login": "bmaizels"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/BaseEventStreamAsyncAws4Signer.java", "diffHunk": "@@ -160,6 +161,13 @@ public ByteBuffer apply(ByteBuffer byteBuffer) {\n                  * Encode signed event to byte\n                  */\n                 Message signedMessage = new Message(sortHeaders(headers), payload);\n+\n+                if (LOG.isLoggingLevelEnabled(\"trace\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMzA1Mg==", "bodyText": "another approach is to use LOG.printf(.... which allows you to dynamically set the log level which means that theoretically you could do all this in a single line without having an if statement.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394003052", "createdAt": "2020-03-17T22:19:09Z", "author": {"login": "bmaizels"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/BaseEventStreamAsyncAws4Signer.java", "diffHunk": "@@ -160,6 +161,13 @@ public ByteBuffer apply(ByteBuffer byteBuffer) {\n                  * Encode signed event to byte\n                  */\n                 Message signedMessage = new Message(sortHeaders(headers), payload);\n+\n+                if (LOG.isLoggingLevelEnabled(\"trace\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMjYwOQ=="}, "originalCommit": {"oid": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMzY5Ng==", "bodyText": "why not do this with some kind of stream thing?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394003696", "createdAt": "2020-03-17T22:20:46Z", "author": {"login": "bmaizels"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/BaseEventStreamAsyncAws4Signer.java", "diffHunk": "@@ -259,4 +267,35 @@ public void subscribe(Subscriber<? super ByteBuffer> s) {\n             return transformedRequestBody.contentLength();\n         }\n     }\n+\n+    private static String toDebugString(Message m, boolean truncatePayload) {\n+        StringBuilder sb = new StringBuilder(\"Message = {headers={\");\n+        Map<String, HeaderValue> headers = m.getHeaders();\n+\n+        Iterator<Map.Entry<String, HeaderValue>> headersIter = headers.entrySet().iterator();\n+\n+        while (headersIter.hasNext()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNDA5Mg==", "bodyText": "Could payload.length be 0? what happens then?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394004092", "createdAt": "2020-03-17T22:21:43Z", "author": {"login": "bmaizels"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/BaseEventStreamAsyncAws4Signer.java", "diffHunk": "@@ -259,4 +267,35 @@ public void subscribe(Subscriber<? super ByteBuffer> s) {\n             return transformedRequestBody.contentLength();\n         }\n     }\n+\n+    private static String toDebugString(Message m, boolean truncatePayload) {\n+        StringBuilder sb = new StringBuilder(\"Message = {headers={\");\n+        Map<String, HeaderValue> headers = m.getHeaders();\n+\n+        Iterator<Map.Entry<String, HeaderValue>> headersIter = headers.entrySet().iterator();\n+\n+        while (headersIter.hasNext()) {\n+            Map.Entry<String, HeaderValue> h = headersIter.next();\n+\n+            sb.append(h.getKey()).append(\"={\").append(h.getValue().toString()).append(\"}\");\n+\n+            if (headersIter.hasNext()) {\n+                sb.append(\", \");\n+            }\n+        }\n+\n+        sb.append(\"}, payload=\");\n+\n+        byte[] payload = m.getPayload();\n+\n+        byte[] payloadToLog;\n+        if (truncatePayload) {\n+            // Would be nice if BinaryUtils.toHex() could take an array index range instead so we don't need to copy\n+            payloadToLog = Arrays.copyOf(payload, Math.min(32, payload.length));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNDY2MA==", "bodyText": "I know we don't usually write unit tests for logs but maybe this method is complex enough to justify one?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#discussion_r394004660", "createdAt": "2020-03-17T22:23:09Z", "author": {"login": "bmaizels"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/signer/internal/BaseEventStreamAsyncAws4Signer.java", "diffHunk": "@@ -259,4 +267,35 @@ public void subscribe(Subscriber<? super ByteBuffer> s) {\n             return transformedRequestBody.contentLength();\n         }\n     }\n+\n+    private static String toDebugString(Message m, boolean truncatePayload) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb34fc80876e356ac6a9796751c4df2f9b8eb6ce"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NDU1NTk1", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1721#pullrequestreview-376455595", "createdAt": "2020-03-17T22:43:59Z", "commit": {"oid": "fdfee31a0c4e601c1f7e12b5a63ddeb60e807b61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ad061d0dfd6ab2f856bc64bcc02f16008a49ec6", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/0ad061d0dfd6ab2f856bc64bcc02f16008a49ec6", "committedDate": "2020-03-17T22:46:49Z", "message": "Log signed event for easier debugging\n\nIn case of future bugs related to event stream signing, this should help in\ndebuggging to see the contents of the message in an easier to read format."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdfee31a0c4e601c1f7e12b5a63ddeb60e807b61", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/fdfee31a0c4e601c1f7e12b5a63ddeb60e807b61", "committedDate": "2020-03-17T22:40:32Z", "message": "Add tests for log string"}, "afterCommit": {"oid": "0ad061d0dfd6ab2f856bc64bcc02f16008a49ec6", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/0ad061d0dfd6ab2f856bc64bcc02f16008a49ec6", "committedDate": "2020-03-17T22:46:49Z", "message": "Log signed event for easier debugging\n\nIn case of future bugs related to event stream signing, this should help in\ndebuggging to see the contents of the message in an easier to read format."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2750, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}