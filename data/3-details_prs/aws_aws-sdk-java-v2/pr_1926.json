{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NDU5OTc5", "number": 1926, "title": "Updated the metrics design to include details on how metrics can be enabled at the request level, client level and global level.", "bodyText": "", "createdAt": "2020-06-24T20:13:41Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1926", "merged": true, "mergeCommit": {"oid": "12f3afd431249634bef451928e0e2ee2233d6066"}, "closed": true, "closedAt": "2020-06-30T23:42:36Z", "author": {"login": "millems"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuhJrNAH2gAyNDM5NDU5OTc5OjNiOGMwMzE5NDAxYWQxOGQzYjA0MGJkMjc4NjNiMTI2YjI1OTJmNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcweZlwgFqTQ0MDQ1NjIxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b8c0319401ad18d3b040bd27863b126b2592f73", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/3b8c0319401ad18d3b040bd27863b126b2592f73", "committedDate": "2020-06-24T21:44:02Z", "message": "Updated the metrics design to include details on how metrics can be enabled at the request level, client level and global level."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7da65ba9a313c466311fe5a524bc8f6d336bb913", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7da65ba9a313c466311fe5a524bc8f6d336bb913", "committedDate": "2020-06-24T20:12:15Z", "message": "Updated the metrics design to include details on how metrics can be enabled at the request level, client level and global level."}, "afterCommit": {"oid": "3b8c0319401ad18d3b040bd27863b126b2592f73", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/3b8c0319401ad18d3b040bd27863b126b2592f73", "committedDate": "2020-06-24T21:44:02Z", "message": "Updated the metrics design to include details on how metrics can be enabled at the request level, client level and global level."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDMxNjEy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1926#pullrequestreview-440431612", "createdAt": "2020-06-30T22:33:45Z", "commit": {"oid": "3b8c0319401ad18d3b040bd27863b126b2592f73"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMjozMzo0NVrOGrQwRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMjozMzo0NVrOGrQwRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNjQ1Mg==", "bodyText": "Should we make it case insensitive?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1926#discussion_r448016452", "createdAt": "2020-06-30T22:33:45Z", "author": {"login": "zoewangg"}, "path": "docs/design/core/metrics/Design.md", "diffHunk": "@@ -60,107 +60,174 @@ standard metrics collected by the SDK.\n \n ## Enabling Metrics\n \n-Metrics feature is disabled by default. Metrics can be enabled at client level in the following ways.\n-\n-### Feature Flags (Metrics Provider)\n-\n-* SDK exposes an [interface](prototype/MetricConfigurationProvider.java) to enable the metrics feature and specify\n-  options to configure the metrics behavior.\n-* SDK provides an implementation of this interface based on system properties.\n-* Here are the system properties SDK supports:\n-  - **aws.javasdk2x.metrics.enabled** - Metrics feature is enabled if this system property is set\n-  - **aws.javasdk2x.metrics.category** - Comma separated set of MetricCategory that are enabled for collection\n-* SDK calls the methods in this interface for each request ie, enabled() method is called for every request to determine\n-  if the metrics feature is enabled or not (similarly for other configuration options).\n-  -  This allows customers to control metrics behavior in a more flexible manner; for example using an external database\n-     like DynamoDB to dynamically control metrics collection. This is useful to enable/disable metrics feature and\n-     control metrics options at runtime without the need to make code changes or re-deploy the application.\n-* As the interface methods are called for each request, it is recommended for the implementations to run expensive tasks\n-  asynchronously in the background, cache the results and periodically refresh the results.\n+The metrics feature is disabled by default. Metrics can be enabled and configured in the following ways:\n+\n+### Option 1: Configuring MetricPublishers on a request\n+\n+A publisher can be configured directly on the `RequestOverrideConfiguration`:\n+\n+```java\n+MetricPublisher metricPublisher = CloudWatchMetricPublisher.create();\n+DynamoDbClient dynamoDb = DynamoDbClient.create();\n+dynamoDb.listTables(ListTablesRequest.builder()\n+                                     .overrideConfiguration(c -> c.addMetricPublisher(metricPublisher))\n+                                     .build());\n+```\n+\n+The methods exposed for setting metric publishers follow the pattern established by `ExecutionInterceptor`s:\n+\n+```java\n+class RequestOverrideConfiguration {\n+    // ...\n+    class Builder {\n+        // ...\n+        Builder metricPublishers(List<MetricPublisher> metricsPublishers);\n+        Builder addMetricPublisher(MetricPublisher metricsPublisher);\n+    }\n+}\n+```\n+\n+### Option 2: Configuring MetricPublishers on a client\n+\n+A publisher can be configured directly on the `ClientOverrideConfiguration`. A publisher specified in this way is used\n+with lower priority than **Option 1** above.\n \n ```java\n-ClientOverrideConfiguration config = ClientOverrideConfiguration\n-    .builder()\n-    // If this is not set, SDK uses the default chain with system property\n-    .metricConfigurationProvider(new SystemSettingsMetricConfigurationProvider())\n-    .build();\n-\n-// Set the ClientOverrideConfiguration instance on the client builder\n-CodePipelineAsyncClient asyncClient =\n-    CodePipelineAsyncClient\n-        .builder()\n-        .overrideConfiguration(config)\n-        .build();\n+MetricPublisher metricPublisher = CloudWatchMetricPublisher.create();\n+DynamoDbClient dynamoDb = DynamoDbClient.builder()\n+                                        .overrideConfiguration(c -> c.addMetricPublisher(metricPublisher))\n+                                        .build();\n ```\n \n-### Metrics Provider Chain\n+The methods exposed for setting metric publishers follow the pattern established by `ExecutionInterceptor`s:\n+\n+```java\n+class ClientOverrideConfiguration {\n+    // ...\n+    class Builder {\n+        // ...\n+        Builder metricPublishers(List<MetricPublisher> metricsPublishers);\n+        Builder addMetricPublisher(MetricPublisher metricsPublisher);\n+    }\n+}\n+```\n+\n+**Note:** As with the `httpClient` setting, calling `close()` on the `DynamoDbClient` *will not* close the configured\n+`metricPublishers`. You must close the `metricPublishers` yourself when you're done using them.\n+\n+### Option 3: Configuring MetricPublishers using System Properties or Environment Variables\n+\n+This option allows the customer to enable metric publishing by default, without needing to enable it via **Option 1** \n+or **Option 2** above. This means that a customer can enable metrics without needing to make a change to their runtime \n+code.\n+\n+This option is enabled using an environment variable or system property. If both are specified, the system property \n+will be used. If metrics are enabled at the client level using **Option 2** above, this option is ignored. Overriding \n+the metric publisher at request time using **Option 1** overrides any publishers that have been enabled globally.\n+\n+**System Property:** `aws.metricPublishingEnabled=true` \n+\n+**Environment Variable:** `AWS_METRIC_PUBLISHING_ENABLED=true`\n+\n+The value specified must be one of `\"true\"` or `\"false\"`. Specifying any other string values will result in ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b8c0319401ad18d3b040bd27863b126b2592f73"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23bfebb71d17fbb9f13bbc8eee6595c5764f7c00", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/23bfebb71d17fbb9f13bbc8eee6595c5764f7c00", "committedDate": "2020-06-30T23:35:26Z", "message": "Merge branch 'master' into millem/metrics-configuration-design"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDU1NDY4", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1926#pullrequestreview-440455468", "createdAt": "2020-06-30T23:37:35Z", "commit": {"oid": "23bfebb71d17fbb9f13bbc8eee6595c5764f7c00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDU2MjEy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1926#pullrequestreview-440456212", "createdAt": "2020-06-30T23:39:33Z", "commit": {"oid": "23bfebb71d17fbb9f13bbc8eee6595c5764f7c00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2628, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}