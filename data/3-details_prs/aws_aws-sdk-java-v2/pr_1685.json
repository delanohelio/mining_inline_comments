{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MDE0MTY1", "number": 1685, "title": "Fix merging of single value headers", "bodyText": "Description\nUse the last seen HTTP/1.1 header value for headers defined to only appear once in an HTTP message instead of merging them all into a list. The order in which header values are inspected is: headers set on the request, overridden headers set on the client, then finally overridden headers set on an SDK request. See https://tools.ietf.org/html/rfc2616#section-4.2 for more information.\nMotivation and Context\nBug fix.\nTesting\nmvn clean install. Will run integ tests.\nScreenshots (if appropriate)\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n I have read the CONTRIBUTING document\n Local run of mvn install succeeds\n My code follows the code style of this project\n My change requires a change to the Javadoc documentation\n I have updated the Javadoc documentation accordingly\n I have read the README document\n I have added tests to cover my changes\n All new and existing tests passed\n A short description of the change has been added to the CHANGELOG\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-03-05T01:14:21Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685", "merged": true, "mergeCommit": {"oid": "b1b2f7b131a7d65ae3954088340ec4e086fe1a13"}, "closed": true, "closedAt": "2020-03-09T17:42:33Z", "author": {"login": "dagnir"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKhN5JABqjMwOTkzMTMyNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLLqSwABqjMxMDc0MDM0OTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "044133fe3da0837dc57b3daee50b074a76f97812", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/044133fe3da0837dc57b3daee50b074a76f97812", "committedDate": "2020-03-05T01:09:39Z", "message": "Fix merging of single value headers"}, "afterCommit": {"oid": "42ccd0301a922cdb70d65c7ebf82debf4f4fa8a9", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/42ccd0301a922cdb70d65c7ebf82debf4f4fa8a9", "committedDate": "2020-03-05T01:27:14Z", "message": "Fix merging of single value headers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1412a3bfc0d6cc0a7c036844dbc3ea009fab590c", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/1412a3bfc0d6cc0a7c036844dbc3ea009fab590c", "committedDate": "2020-03-06T01:03:29Z", "message": "Update changelog message"}, "afterCommit": {"oid": "b84bbc3167074a987fa007c590e078694ecee62f", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/b84bbc3167074a987fa007c590e078694ecee62f", "committedDate": "2020-03-06T01:12:32Z", "message": "Update changelog message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMDI3NTAy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#pullrequestreview-370027502", "createdAt": "2020-03-06T01:20:58Z", "commit": {"oid": "b84bbc3167074a987fa007c590e078694ecee62f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwMToyMDo1OFrOFyqR0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwMToyMDo1OFrOFyqR0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY2NTgwOQ==", "bodyText": "Is this needed?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r388665809", "createdAt": "2020-03-06T01:20:58Z", "author": {"login": "spfink"}, "path": "utils/src/main/java/software/amazon/awssdk/utils/http/SdkHttpUtils.java", "diffHunk": "@@ -297,4 +307,12 @@ public static String appendUri(String baseUri, String path) {\n     public static Optional<String> firstMatchingHeader(Map<String, List<String>> headers, String header) {\n         return allMatchingHeaders(headers, header).findFirst();\n     }\n+\n+    public static Set<String> singleHeaders() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b84bbc3167074a987fa007c590e078694ecee62f"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMDMxODMw", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#pullrequestreview-370031830", "createdAt": "2020-03-06T01:34:45Z", "commit": {"oid": "d0f8f62478f5bdd8dd9a31e87c74e5fc1a6f6f07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32be9ae6029c7a8d2f48769b777163ed263e21bd", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/32be9ae6029c7a8d2f48769b777163ed263e21bd", "committedDate": "2020-03-06T19:09:35Z", "message": "Merge branch 'master' into single-header-merge-fix"}, "afterCommit": {"oid": "5e5eb53d78d31a9a596bc4f0ed12134368ff60e4", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/5e5eb53d78d31a9a596bc4f0ed12134368ff60e4", "committedDate": "2020-03-06T21:35:10Z", "message": "Remove some headers defined as lists"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjgxNTg0", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#pullrequestreview-370681584", "createdAt": "2020-03-06T23:14:11Z", "commit": {"oid": "5e5eb53d78d31a9a596bc4f0ed12134368ff60e4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzoxNDoxMVrOFzKLyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzoxNTo1NFrOFzKNaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4ODU1Mg==", "bodyText": "We're now introducing an implicit 'priority' in the sense that the last header 'wins'. Can we add a comment about that?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r389188552", "createdAt": "2020-03-06T23:14:11Z", "author": {"login": "millems"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/http/pipeline/stages/MergeCustomHeadersStage.java", "diffHunk": "@@ -52,7 +54,15 @@ public MergeCustomHeadersStage(HttpClientDependencies dependencies) {\n     private final Map<String, List<String>> mergeHeaders(Map<String, List<String>>... headers) {\n         Map<String, List<String>> result = new LinkedHashMap<>();\n         for (Map<String, List<String>> header : headers) {\n-            header.forEach((k, v) -> result.computeIfAbsent(k, ignored -> new ArrayList<>()).addAll(v));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e5eb53d78d31a9a596bc4f0ed12134368ff60e4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE4ODk2OQ==", "bodyText": "Should we disallow (or log) when there are multiple values specified in the same headerValues for a single-header?\nIt's a bit weird if I add multiple content-types at the request level, but it just takes the last one.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#discussion_r389188969", "createdAt": "2020-03-06T23:15:54Z", "author": {"login": "millems"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/http/pipeline/stages/MergeCustomHeadersStage.java", "diffHunk": "@@ -52,7 +54,15 @@ public MergeCustomHeadersStage(HttpClientDependencies dependencies) {\n     private final Map<String, List<String>> mergeHeaders(Map<String, List<String>>... headers) {\n         Map<String, List<String>> result = new LinkedHashMap<>();\n         for (Map<String, List<String>> header : headers) {\n-            header.forEach((k, v) -> result.computeIfAbsent(k, ignored -> new ArrayList<>()).addAll(v));\n+            header.forEach((headerName, headerValues) -> {\n+                List<String> resultHeaderValues = result.computeIfAbsent(headerName, ignored -> new ArrayList<>());\n+                if (SdkHttpUtils.isSingleHeader(headerName)) {\n+                    resultHeaderValues.clear();\n+                    resultHeaderValues.add(CollectionUtils.lastElement(headerValues));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e5eb53d78d31a9a596bc4f0ed12134368ff60e4"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjk0ODE2", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1685#pullrequestreview-370694816", "createdAt": "2020-03-07T00:04:28Z", "commit": {"oid": "8fa29ec6e8cf702f614e1bcbfb46ec18196cf19a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19f966486e11e497d1dd21bed7846e6bb430f541", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/19f966486e11e497d1dd21bed7846e6bb430f541", "committedDate": "2020-03-07T00:07:20Z", "message": "Fix checkstyle and remove unused lastElement()"}, "afterCommit": {"oid": "647a2ff83ebdecab5e4b1bedf1343e87c0e558b4", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/647a2ff83ebdecab5e4b1bedf1343e87c0e558b4", "committedDate": "2020-03-07T02:06:32Z", "message": "Fix merging of single value headers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "869488ec4a69c7d7413d9958ce446490d7e677dc", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/869488ec4a69c7d7413d9958ce446490d7e677dc", "committedDate": "2020-03-07T02:09:41Z", "message": "Merge branch 'master' into single-header-merge-fix"}, "afterCommit": {"oid": "6d383364854fb93504b838837d114ee858bb4346", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/6d383364854fb93504b838837d114ee858bb4346", "committedDate": "2020-03-07T02:50:39Z", "message": "Fix merging of single value headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d2c16aac43896e693ffe260617ac6ce59b1a346", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/9d2c16aac43896e693ffe260617ac6ce59b1a346", "committedDate": "2020-03-07T02:54:13Z", "message": "Fix merging of single value headers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d383364854fb93504b838837d114ee858bb4346", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/6d383364854fb93504b838837d114ee858bb4346", "committedDate": "2020-03-07T02:50:39Z", "message": "Fix merging of single value headers"}, "afterCommit": {"oid": "9d2c16aac43896e693ffe260617ac6ce59b1a346", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/9d2c16aac43896e693ffe260617ac6ce59b1a346", "committedDate": "2020-03-07T02:54:13Z", "message": "Fix merging of single value headers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2718, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}