{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNDMxMTgw", "number": 1644, "title": "PR #728 attempt 2: Fixed buggy netty-reactive-streams test and re-added changes from PR", "bodyText": "#728 was reverted because of an intermittent test failure, and we didn't want to risk releasing a bug. I've fixed that test failure after discovering it's a bug in the netty-reactive-streams test, not our implementation.\nThis change re-introduces the changes from #728 in one commit, and the fixes for the intermittent test failure in a second commit, for easier reviewing.\nBefore the fix, HandlerPublisherVerificationTest#stochastic_spec103_mustSignalOnMethodsSequentially would fail once every few hundred iterations. After the fix, HandlerPublisherVerificationTest#stochastic_spec103_mustSignalOnMethodsSequentially did not fail after a few thousand iterations.", "createdAt": "2020-02-11T01:11:09Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1644", "merged": true, "mergeCommit": {"oid": "c55ca9140a4d69ccae2dfa9992b3f626513b3994"}, "closed": true, "closedAt": "2020-02-11T21:06:19Z", "author": {"login": "millems"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDHU-XAFqTM1NjM3NTY1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDX6EhABqjMwMjgxMzQ5NjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Mzc1NjU2", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1644#pullrequestreview-356375656", "createdAt": "2020-02-11T01:20:06Z", "commit": {"oid": "749ebdb65fe6b2353276a5300e5e7f7dc09c3aa4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Mzc5MDM2", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1644#pullrequestreview-356379036", "createdAt": "2020-02-11T01:34:33Z", "commit": {"oid": "749ebdb65fe6b2353276a5300e5e7f7dc09c3aa4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMTozNDozM1rOFn7bcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwMTozNDozM1rOFn7bcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQxMjQ2NA==", "bodyText": "As discussed, let's look into simplifying this either with a single threaded test or using .getAndIncrement() to cache the value instead of get() that then requires a compareAndSet()", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1644#discussion_r377412464", "createdAt": "2020-02-11T01:34:33Z", "author": {"login": "bmaizels"}, "path": "http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/internal/nrs/util/BatchedProducer.java", "diffHunk": "@@ -58,10 +58,18 @@ public void read(final ChannelHandlerContext ctx) throws Exception {\n         ctx.pipeline().channel().eventLoop().parent().execute(new Runnable() {\n             @Override\n             public void run() {\n-                for (int i = 0; i < batchSize && sequence.get() != eofOn; i++) {\n-                    ctx.fireChannelRead(sequence.getAndIncrement());\n+                long valueToProduce = sequence.get();\n+                for (int i = 0; i < batchSize && valueToProduce != eofOn;) {\n+                    if (!sequence.compareAndSet(valueToProduce, valueToProduce + 1)) {\n+                        // Another thread already produced this value, try again with the next value.\n+                        valueToProduce = sequence.get();\n+                        continue;\n+                    }\n+\n+                    ctx.fireChannelRead(valueToProduce);\n+                    ++i;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "749ebdb65fe6b2353276a5300e5e7f7dc09c3aa4"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "749ebdb65fe6b2353276a5300e5e7f7dc09c3aa4", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/749ebdb65fe6b2353276a5300e5e7f7dc09c3aa4", "committedDate": "2020-02-11T01:08:23Z", "message": "Fixed a race condition in netty-reactive-streams test: BatchedProducer would sometimes miss that it should stop producing data."}, "afterCommit": {"oid": "6535a8b1d41eb49b8ae8c1f0ddceec0fd99fe335", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/6535a8b1d41eb49b8ae8c1f0ddceec0fd99fe335", "committedDate": "2020-02-11T01:38:48Z", "message": "Fixed a race condition in netty-reactive-streams test: BatchedProducer would sometimes miss that it should stop producing data."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6535a8b1d41eb49b8ae8c1f0ddceec0fd99fe335", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/6535a8b1d41eb49b8ae8c1f0ddceec0fd99fe335", "committedDate": "2020-02-11T01:38:48Z", "message": "Fixed a race condition in netty-reactive-streams test: BatchedProducer would sometimes miss that it should stop producing data."}, "afterCommit": {"oid": "83a79b50974bac514bf06827a9e1b7999efaf27b", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/83a79b50974bac514bf06827a9e1b7999efaf27b", "committedDate": "2020-02-11T01:42:02Z", "message": "Fixed a race condition in netty-reactive-streams test: BatchedProducer would sometimes miss that it should stop producing data."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2ODU0MDA3", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1644#pullrequestreview-356854007", "createdAt": "2020-02-11T17:32:44Z", "commit": {"oid": "83a79b50974bac514bf06827a9e1b7999efaf27b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ce338eb1b4b12b9472ad5d6c3190c2c2396629f", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/4ce338eb1b4b12b9472ad5d6c3190c2c2396629f", "committedDate": "2020-02-11T20:18:45Z", "message": "Revert \"Revert changes in PR#728\"\n\nThis reverts commit 4ac0ba8f5fb8c89ba9526f3629bf4a0b5e2b784b."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f44351b97cab8b80ff77e7da76aff76cb8f46a4", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2f44351b97cab8b80ff77e7da76aff76cb8f46a4", "committedDate": "2020-02-11T20:16:26Z", "message": "Merge branch 'master' into millem/fix-signature-errors-2"}, "afterCommit": {"oid": "79fd29864e5e0e2a4944151077d5beb7507bbf57", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/79fd29864e5e0e2a4944151077d5beb7507bbf57", "committedDate": "2020-02-11T20:18:45Z", "message": "Fixed a race condition in netty-reactive-streams test: BatchedProducer would sometimes miss that it should stop producing data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d055f942db1278353d75d4e2c6f530357366e1e", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2d055f942db1278353d75d4e2c6f530357366e1e", "committedDate": "2020-02-11T20:38:59Z", "message": "Fixed a race condition in netty-reactive-streams test: BatchedProducer would sometimes miss that it should stop producing data."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79fd29864e5e0e2a4944151077d5beb7507bbf57", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/79fd29864e5e0e2a4944151077d5beb7507bbf57", "committedDate": "2020-02-11T20:18:45Z", "message": "Fixed a race condition in netty-reactive-streams test: BatchedProducer would sometimes miss that it should stop producing data."}, "afterCommit": {"oid": "2d055f942db1278353d75d4e2c6f530357366e1e", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2d055f942db1278353d75d4e2c6f530357366e1e", "committedDate": "2020-02-11T20:38:59Z", "message": "Fixed a race condition in netty-reactive-streams test: BatchedProducer would sometimes miss that it should stop producing data."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2665, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}