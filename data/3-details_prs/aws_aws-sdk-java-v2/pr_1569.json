{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4ODA3NDYx", "number": 1569, "title": "Add RequestBody.fromRemainingByteBuffer()", "bodyText": "Fixes #1534\n\nDescription\n\nMotivation and Context\n\n\nTesting\nNew unit tests.\nScreenshots (if appropriate)\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n I have read the CONTRIBUTING document\n Local run of mvn install succeeds\n My code follows the code style of this project\n My change requires a change to the Javadoc documentation\n I have updated the Javadoc documentation accordingly\n I have read the README document\n I have added tests to cover my changes\n All new and existing tests passed\n A short description of the change has been added to the CHANGELOG\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-01-02T21:55:14Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569", "merged": true, "mergeCommit": {"oid": "aad53edd3f4e218ae551fb24bd4df598e2f0b144"}, "closed": true, "closedAt": "2020-01-03T17:41:08Z", "author": {"login": "dagnir"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2hD4ogBqjI5MTg5MDI0MDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb2jBeuABqjI5MTkxMzcxMTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2a32b91a2b24dc5b0057aafbc50b3f32b365792", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/e2a32b91a2b24dc5b0057aafbc50b3f32b365792", "committedDate": "2020-01-02T21:54:16Z", "message": "Add RequestBody.fromRemainingBytes()\n\nFixes #1534"}, "afterCommit": {"oid": "94b0f4b842373f9fa2bfa96dcb618d1ce3d978c4", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/94b0f4b842373f9fa2bfa96dcb618d1ce3d978c4", "committedDate": "2020-01-02T21:57:39Z", "message": "Add RequestBody.romRemainingByteBuffer()\n\nFixes #1534"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94b0f4b842373f9fa2bfa96dcb618d1ce3d978c4", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/94b0f4b842373f9fa2bfa96dcb618d1ce3d978c4", "committedDate": "2020-01-02T21:57:39Z", "message": "Add RequestBody.romRemainingByteBuffer()\n\nFixes #1534"}, "afterCommit": {"oid": "7500d8b06f3cf9815e6e780f83f57ffb13e68e22", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7500d8b06f3cf9815e6e780f83f57ffb13e68e22", "committedDate": "2020-01-02T21:59:47Z", "message": "Add RequestBody.romRemainingByteBuffer()\n\nFixes #1534"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7500d8b06f3cf9815e6e780f83f57ffb13e68e22", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7500d8b06f3cf9815e6e780f83f57ffb13e68e22", "committedDate": "2020-01-02T21:59:47Z", "message": "Add RequestBody.romRemainingByteBuffer()\n\nFixes #1534"}, "afterCommit": {"oid": "088b5fdb4811bc12b53800d34f8f3eef3ec79647", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/088b5fdb4811bc12b53800d34f8f3eef3ec79647", "committedDate": "2020-01-02T22:00:58Z", "message": "Add RequestBody.fromRemainingByteBuffer()\n\nFixes #1534"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3OTAzNDgy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#pullrequestreview-337903482", "createdAt": "2020-01-02T23:22:41Z", "commit": {"oid": "088b5fdb4811bc12b53800d34f8f3eef3ec79647"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQyMzoyMjo0MVrOFZ3aJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQyMzozMjowMVrOFZ3hgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2NjUzMg==", "bodyText": "Can we update the javadoc in the original fromByteBuffer(...) to make it clear that this one does -not- respect the current read position.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362666532", "createdAt": "2020-01-02T23:22:41Z", "author": {"login": "bmaizels"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/sync/RequestBody.java", "diffHunk": "@@ -169,6 +169,18 @@ public static RequestBody fromByteBuffer(ByteBuffer byteBuffer) {\n         return fromBytesDirect(BinaryUtils.copyAllBytesFrom(byteBuffer));\n     }\n \n+    /**\n+     * Creates a {@link RequestBody} from the remaining readable bytes from a {@link ByteBuffer}. Unlike\n+     * {@link #fromByteBuffer(ByteBuffer)}, this method respects the current read position of the buffer and reads only\n+     * the remaining bytes. The buffer is copied before reading so no changes are made to original buffer.\n+     *\n+     * @param byteBuffer ByteBuffer to send to the service.\n+     * @return RequestBody instance.\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088b5fdb4811bc12b53800d34f8f3eef3ec79647"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2Njg0Mw==", "bodyText": "Capture bb.remaining() before calling fromRemainingByteBuffer just to ensure that it's not being mutated.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362666843", "createdAt": "2020-01-02T23:24:04Z", "author": {"login": "bmaizels"}, "path": "core/sdk-core/src/test/java/software/amazon/awssdk/core/sync/RequestBodyTest.java", "diffHunk": "@@ -104,4 +103,19 @@ public void emptyBytesConstructorHasCorrectContentType() {\n         RequestBody requestBody = RequestBody.empty();\n         assertThat(requestBody.contentType()).isEqualTo(Mimetype.MIMETYPE_OCTET_STREAM);\n     }\n+\n+    @Test\n+    public void remainingByteBufferConstructorOnlyRemainingBytesCopied() throws IOException {\n+        ByteBuffer bb = ByteBuffer.allocate(4);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        bb.get();\n+\n+        RequestBody requestBody = RequestBody.fromRemainingByteBuffer(bb);\n+        assertThat(requestBody.contentLength()).isEqualTo(bb.remaining());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088b5fdb4811bc12b53800d34f8f3eef3ec79647"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2Njg5Mg==", "bodyText": "Or have a separate test to assert such...", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362666892", "createdAt": "2020-01-02T23:24:19Z", "author": {"login": "bmaizels"}, "path": "core/sdk-core/src/test/java/software/amazon/awssdk/core/sync/RequestBodyTest.java", "diffHunk": "@@ -104,4 +103,19 @@ public void emptyBytesConstructorHasCorrectContentType() {\n         RequestBody requestBody = RequestBody.empty();\n         assertThat(requestBody.contentType()).isEqualTo(Mimetype.MIMETYPE_OCTET_STREAM);\n     }\n+\n+    @Test\n+    public void remainingByteBufferConstructorOnlyRemainingBytesCopied() throws IOException {\n+        ByteBuffer bb = ByteBuffer.allocate(4);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        bb.get();\n+\n+        RequestBody requestBody = RequestBody.fromRemainingByteBuffer(bb);\n+        assertThat(requestBody.contentLength()).isEqualTo(bb.remaining());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2Njg0Mw=="}, "originalCommit": {"oid": "088b5fdb4811bc12b53800d34f8f3eef3ec79647"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2NzIwMw==", "bodyText": "Not keen on the way this test is written, it's vulnerable to bb being mutated, also the assertion reads kinda back to front usually we assert the thing that's under test rather than the thing being under test as the thing we compare to.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362667203", "createdAt": "2020-01-02T23:25:56Z", "author": {"login": "bmaizels"}, "path": "core/sdk-core/src/test/java/software/amazon/awssdk/core/sync/RequestBodyTest.java", "diffHunk": "@@ -104,4 +103,19 @@ public void emptyBytesConstructorHasCorrectContentType() {\n         RequestBody requestBody = RequestBody.empty();\n         assertThat(requestBody.contentType()).isEqualTo(Mimetype.MIMETYPE_OCTET_STREAM);\n     }\n+\n+    @Test\n+    public void remainingByteBufferConstructorOnlyRemainingBytesCopied() throws IOException {\n+        ByteBuffer bb = ByteBuffer.allocate(4);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        bb.get();\n+\n+        RequestBody requestBody = RequestBody.fromRemainingByteBuffer(bb);\n+        assertThat(requestBody.contentLength()).isEqualTo(bb.remaining());\n+\n+        byte[] requestBodyBytes = IoUtils.toByteArray(requestBody.contentStreamProvider().newStream());\n+        assertThat(bb).isEqualTo(ByteBuffer.wrap(requestBodyBytes));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088b5fdb4811bc12b53800d34f8f3eef3ec79647"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2NzcyNA==", "bodyText": "Can we use assertJ for all our new tests? I get that you don't want to refactor all the existing tests, but at least for new tests.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362667724", "createdAt": "2020-01-02T23:28:29Z", "author": {"login": "bmaizels"}, "path": "utils/src/test/java/software/amazon/awssdk/utils/BinaryUtilsTest.java", "diffHunk": "@@ -159,4 +159,46 @@ public void testCopyBytesFrom_DirectByteBuffer_Idempotent() {\n         assertTrue(partial1.length == 3);\n         assertTrue(Arrays.equals(new byte[] {2, 3, 4}, partial1));\n     }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_nullBuffer() {\n+        assertNull(BinaryUtils.copyRemainingBytesFrom(null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088b5fdb4811bc12b53800d34f8f3eef3ec79647"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjY2ODQxOA==", "bodyText": "These tests might be clearer if we work with bytes instead of ints. Also, we should assert that the sequence is read correctly, eg: given a sequence of [ 1, 2, 3, 4 ] of which we read two bytes we can assert that we are left with a buffer that is equivalent to [ 3, 4 ] rather than just checking length.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#discussion_r362668418", "createdAt": "2020-01-02T23:32:01Z", "author": {"login": "bmaizels"}, "path": "utils/src/test/java/software/amazon/awssdk/utils/BinaryUtilsTest.java", "diffHunk": "@@ -159,4 +159,46 @@ public void testCopyBytesFrom_DirectByteBuffer_Idempotent() {\n         assertTrue(partial1.length == 3);\n         assertTrue(Arrays.equals(new byte[] {2, 3, 4}, partial1));\n     }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_nullBuffer() {\n+        assertNull(BinaryUtils.copyRemainingBytesFrom(null));\n+    }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_noRemainingBytes() {\n+        ByteBuffer bb = ByteBuffer.allocate(8);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        bb.getInt();\n+\n+        assertEquals(0, BinaryUtils.copyRemainingBytesFrom(bb).length);\n+    }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_fullBuffer() {\n+        ByteBuffer bb = ByteBuffer.allocate(8);\n+        bb.putInt(42);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        byte[] copy = BinaryUtils.copyRemainingBytesFrom(bb);\n+        assertEquals(bb, ByteBuffer.wrap(copy));\n+        assertEquals(8, copy.length);\n+    }\n+\n+    @Test\n+    public void testCopyRemainingBytesFrom_partiallyReadBuffer() {\n+        ByteBuffer bb = ByteBuffer.allocate(8);\n+        bb.putInt(42);\n+        bb.putInt(42);\n+        bb.flip();\n+\n+        bb.getInt();\n+\n+        byte[] copy = BinaryUtils.copyRemainingBytesFrom(bb);\n+        assertEquals(bb, ByteBuffer.wrap(copy));\n+        assertEquals(4, copy.length);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088b5fdb4811bc12b53800d34f8f3eef3ec79647"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3OTExNjIz", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1569#pullrequestreview-337911623", "createdAt": "2020-01-03T00:01:09Z", "commit": {"oid": "c0c0c94bbdf4d581202578a8757aabd2206ad301"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cd1664907cc3a78ba59f4548caef2a002de2db5", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2cd1664907cc3a78ba59f4548caef2a002de2db5", "committedDate": "2020-01-03T00:15:00Z", "message": "Add RequestBody.fromRemainingByteBuffer()\n\nFixes #1534"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0c0c94bbdf4d581202578a8757aabd2206ad301", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/c0c0c94bbdf4d581202578a8757aabd2206ad301", "committedDate": "2020-01-02T23:57:35Z", "message": "Review comments"}, "afterCommit": {"oid": "2cd1664907cc3a78ba59f4548caef2a002de2db5", "author": {"user": {"login": "dagnir", "name": "Dongie Agnir"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2cd1664907cc3a78ba59f4548caef2a002de2db5", "committedDate": "2020-01-03T00:15:00Z", "message": "Add RequestBody.fromRemainingByteBuffer()\n\nFixes #1534"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2773, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}