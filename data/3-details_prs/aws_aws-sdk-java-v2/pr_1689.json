{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NjEyNjM5", "number": 1689, "title": "Clean-up and refactor of attribute and attribute tags classes; prepar\u2026", "bodyText": "\u2026ation for injection of custom converters\nDescription\nBesides the clean-up, one key structural feature of this change is to delay the resolution of attributes\nto specific converters so that a custom converter provider can be injected. The interface changes required to facilitate the actual injection are coming in a separate PR.\nRelates to #35\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-03-06T03:16:50Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1689", "merged": true, "mergeCommit": {"oid": "86b05d40718cb9c4c020d141262e01d4408e22a9"}, "closed": true, "closedAt": "2020-03-11T00:02:12Z", "author": {"login": "bmaizels"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcK3cuqgBqjMxMDM4NDQ5MDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMbSdDABqjMxMTY4MjY3MjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e3129ea1c26ac749df02f95ecdf97386870fdfe", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/3e3129ea1c26ac749df02f95ecdf97386870fdfe", "committedDate": "2020-03-06T03:17:02Z", "message": "Merge branch 'master' into bmaizels/ddb-enhanced-attribute-refactor"}, "afterCommit": {"oid": "da4aba0e16117a6393ff1168af7fed0972259295", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/da4aba0e16117a6393ff1168af7fed0972259295", "committedDate": "2020-03-06T03:21:11Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da4aba0e16117a6393ff1168af7fed0972259295", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/da4aba0e16117a6393ff1168af7fed0972259295", "committedDate": "2020-03-06T03:21:11Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}, "afterCommit": {"oid": "58fbca3ac454e0c1d93c9f6de889d041ff4ccebf", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/58fbca3ac454e0c1d93c9f6de889d041ff4ccebf", "committedDate": "2020-03-06T04:17:28Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58fbca3ac454e0c1d93c9f6de889d041ff4ccebf", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/58fbca3ac454e0c1d93c9f6de889d041ff4ccebf", "committedDate": "2020-03-06T04:17:28Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}, "afterCommit": {"oid": "2e597ba33457fc8ebca4e3f1949798dabc40a02f", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2e597ba33457fc8ebca4e3f1949798dabc40a02f", "committedDate": "2020-03-06T16:44:10Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e597ba33457fc8ebca4e3f1949798dabc40a02f", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2e597ba33457fc8ebca4e3f1949798dabc40a02f", "committedDate": "2020-03-06T16:44:10Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}, "afterCommit": {"oid": "9e0f42a51099a57cf1b4bec5a7dac3ec600a4111", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/9e0f42a51099a57cf1b4bec5a7dac3ec600a4111", "committedDate": "2020-03-06T17:25:22Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e0f42a51099a57cf1b4bec5a7dac3ec600a4111", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/9e0f42a51099a57cf1b4bec5a7dac3ec600a4111", "committedDate": "2020-03-06T17:25:22Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}, "afterCommit": {"oid": "44cf5fa89b156af77c3c9416022ae47dfbfab74c", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/44cf5fa89b156af77c3c9416022ae47dfbfab74c", "committedDate": "2020-03-06T17:30:41Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44cf5fa89b156af77c3c9416022ae47dfbfab74c", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/44cf5fa89b156af77c3c9416022ae47dfbfab74c", "committedDate": "2020-03-06T17:30:41Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}, "afterCommit": {"oid": "f1b526010485a88c4aa29a16f38580f53c516842", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/f1b526010485a88c4aa29a16f38580f53c516842", "committedDate": "2020-03-10T15:50:16Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTk4ODU4", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1689#pullrequestreview-371598858", "createdAt": "2020-03-09T23:46:22Z", "commit": {"oid": "44cf5fa89b156af77c3c9416022ae47dfbfab74c"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMzo0NjoyMlrOFz9AlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjoxMDowN1rOF0WHZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyMTI2OQ==", "bodyText": "Line 48 below in javadoc below (not selectable in PR) has the old attribute definition as an example.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1689#discussion_r390021269", "createdAt": "2020-03-09T23:46:22Z", "author": {"login": "cenedhryn"}, "path": "services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/extensions/VersionedRecordExtension.java", "diffHunk": "@@ -21,15 +21,16 @@\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Optional;\n+import java.util.function.Consumer;\n import java.util.function.Function;\n-\n import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.enhanced.dynamodb.AttributeValueType;\n import software.amazon.awssdk.enhanced.dynamodb.DynamoDbEnhancedClientExtension;\n import software.amazon.awssdk.enhanced.dynamodb.Expression;\n import software.amazon.awssdk.enhanced.dynamodb.TableMetadata;\n import software.amazon.awssdk.enhanced.dynamodb.internal.operations.OperationContext;\n-import software.amazon.awssdk.enhanced.dynamodb.mapper.AttributeTag;\n-import software.amazon.awssdk.enhanced.dynamodb.mapper.AttributeValueType;\n+import software.amazon.awssdk.enhanced.dynamodb.mapper.StaticAttributeTag;\n+import software.amazon.awssdk.enhanced.dynamodb.mapper.StaticTableMetadata;\n import software.amazon.awssdk.services.dynamodb.model.AttributeValue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44cf5fa89b156af77c3c9416022ae47dfbfab74c"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAyOTczNg==", "bodyText": "I'm assuming all the moving around of static imports is a consistency move, pls confirm.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1689#discussion_r390029736", "createdAt": "2020-03-10T00:16:59Z", "author": {"login": "cenedhryn"}, "path": "services-custom/dynamodb-enhanced/src/test/java/software/amazon/awssdk/enhanced/dynamodb/converters/attribute/OptionalAttributeConvertersTest.java", "diffHunk": "@@ -16,10 +16,10 @@\n package software.amazon.awssdk.enhanced.dynamodb.converters.attribute;\n \n import static org.assertj.core.api.Assertions.assertThat;\n-import static software.amazon.awssdk.enhanced.dynamodb.internal.converter.attribute.EnhancedAttributeValue.fromNumber;\n-import static software.amazon.awssdk.enhanced.dynamodb.internal.converter.attribute.EnhancedAttributeValue.nullValue;\n import static software.amazon.awssdk.enhanced.dynamodb.converters.attribute.ConverterTestUtils.transformFrom;\n import static software.amazon.awssdk.enhanced.dynamodb.converters.attribute.ConverterTestUtils.transformTo;\n+import static software.amazon.awssdk.enhanced.dynamodb.internal.converter.attribute.EnhancedAttributeValue.fromNumber;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44cf5fa89b156af77c3c9416022ae47dfbfab74c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxMjg5MQ==", "bodyText": "This line ends unexpectedly.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1689#discussion_r390412891", "createdAt": "2020-03-10T15:43:42Z", "author": {"login": "cenedhryn"}, "path": "services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/mapper/StaticAttributeTag.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.enhanced.dynamodb.mapper;\n+\n+import java.util.function.Consumer;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.enhanced.dynamodb.AttributeValueType;\n+\n+/**\n+ * Interface for a tag that can be applied to any {@link StaticAttribute}. When a tagged attribute is added to a\n+ * {@link software.amazon.awssdk.enhanced.dynamodb.TableSchema}, the table metadata stored on the schema will be updated\n+ * by calling the {@link #modifyMetadata(String, AttributeValueType)} method for every tag associated with the\n+ * attribute.\n+ * <p>\n+ * Core implementations of these tags that", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44cf5fa89b156af77c3c9416022ae47dfbfab74c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyNTc5NA==", "bodyText": "Why did you change to HashMap?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1689#discussion_r390425794", "createdAt": "2020-03-10T16:00:46Z", "author": {"login": "cenedhryn"}, "path": "services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/mapper/StaticTableMetadata.java", "diffHunk": "@@ -166,37 +171,31 @@ public int hashCode() {\n         return result;\n     }\n \n-    @ThreadSafe\n+    /**\n+     * Builder for {@link StaticTableMetadata}\n+     */\n     public static class Builder {\n-        private final Map<String, Object> customMetadata = new ConcurrentHashMap<>();\n-        private final Map<String, Index> indexByNameMap = new ConcurrentHashMap<>();\n-        private final Map<String, AttributeValueType> keyAttributes = new ConcurrentHashMap<>();\n+        private final Map<String, Object> customMetadata = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44cf5fa89b156af77c3c9416022ae47dfbfab74c"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzMjYxMw==", "bodyText": "I have noticed that in many test files, we're defining but not using the secondary index. Should we consider adding more tests to target that and cover more behavior?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1689#discussion_r390432613", "createdAt": "2020-03-10T16:10:07Z", "author": {"login": "cenedhryn"}, "path": "services-custom/dynamodb-enhanced/src/test/java/software/amazon/awssdk/enhanced/dynamodb/functionaltests/AsyncBasicCrudTest.java", "diffHunk": "@@ -170,27 +168,43 @@ public int hashCode() {\n \n     private static final TableSchema<Record> TABLE_SCHEMA =\n         StaticTableSchema.builder(Record.class)\n-                   .newItemSupplier(Record::new)\n-                   .attributes(\n-                       attribute(\"id\", TypeToken.of(String.class), Record::getId, Record::setId).as(primaryPartitionKey()),\n-                       attribute(\"sort\", TypeToken.of(String.class), Record::getSort, Record::setSort).as(primarySortKey()),\n-                       // This is a DynamoDb reserved word, forces testing of AttributeNames\n-                       attribute(\"attribute\", TypeToken.of(String.class), Record::getAttribute, Record::setAttribute),\n-                       // Using tricky characters to force scrubbing of attributeName tokens\n-                       attribute(\"*attribute2*\", TypeToken.of(String.class), Record::getAttribute2, Record::setAttribute2)\n-                           .as(secondaryPartitionKey(\"gsi_1\")),\n-                       attribute(\"attribute3\", TypeToken.of(String.class), Record::getAttribute3, Record::setAttribute3)\n-                           .as(secondarySortKey(\"gsi_1\")))\n-                   .build();\n+                         .newItemSupplier(Record::new)\n+                         .addAttribute(String.class, a -> a.name(\"id\")\n+                                                           .getter(Record::getId)\n+                                                           .setter(Record::setId)\n+                                                           .tags(primaryPartitionKey()))\n+                         .addAttribute(String.class, a -> a.name(\"sort\")\n+                                                           .getter(Record::getSort)\n+                                                           .setter(Record::setSort)\n+                                                           .tags(primarySortKey()))\n+                         .addAttribute(String.class, a -> a.name(\"attribute\")\n+                                                           .getter(Record::getAttribute)\n+                                                           .setter(Record::setAttribute))\n+                         .addAttribute(String.class, a -> a.name(\"attribute2*\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1b526010485a88c4aa29a16f38580f53c516842"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1b526010485a88c4aa29a16f38580f53c516842", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/f1b526010485a88c4aa29a16f38580f53c516842", "committedDate": "2020-03-10T15:50:16Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}, "afterCommit": {"oid": "51ad8c2ef8582c483ea265dbd779c02ef23417a8", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/51ad8c2ef8582c483ea265dbd779c02ef23417a8", "committedDate": "2020-03-10T18:54:14Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51ad8c2ef8582c483ea265dbd779c02ef23417a8", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/51ad8c2ef8582c483ea265dbd779c02ef23417a8", "committedDate": "2020-03-10T18:54:14Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}, "afterCommit": {"oid": "8012cb844b22c8978639993809cc0bdab473631a", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/8012cb844b22c8978639993809cc0bdab473631a", "committedDate": "2020-03-10T18:58:03Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8012cb844b22c8978639993809cc0bdab473631a", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/8012cb844b22c8978639993809cc0bdab473631a", "committedDate": "2020-03-10T18:58:03Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}, "afterCommit": {"oid": "e9410dfa7b9972c1eeda9fc8f2ebfb887fe00996", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/e9410dfa7b9972c1eeda9fc8f2ebfb887fe00996", "committedDate": "2020-03-10T19:00:03Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMjU1NjM3", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1689#pullrequestreview-372255637", "createdAt": "2020-03-10T19:25:29Z", "commit": {"oid": "e9410dfa7b9972c1eeda9fc8f2ebfb887fe00996"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7885a86fca1a8c7251087877cf7649b1a4716d9b", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7885a86fca1a8c7251087877cf7649b1a4716d9b", "committedDate": "2020-03-10T23:23:43Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9410dfa7b9972c1eeda9fc8f2ebfb887fe00996", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/e9410dfa7b9972c1eeda9fc8f2ebfb887fe00996", "committedDate": "2020-03-10T19:00:03Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}, "afterCommit": {"oid": "7885a86fca1a8c7251087877cf7649b1a4716d9b", "author": {"user": {"login": "bmaizels", "name": "Benjamin Maizels"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7885a86fca1a8c7251087877cf7649b1a4716d9b", "committedDate": "2020-03-10T23:23:43Z", "message": "Clean-up and refactor of attribute and attribute tags classes; preparation for injection of custom converters"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2727, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}