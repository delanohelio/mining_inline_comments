{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NTMxNDA1", "number": 2079, "title": "Fix slash path parameter in apache http client", "bodyText": "Description\nFixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error.\nRoot case:\nIn previous implementation, all occurrences of // were replaced with /%2F, including the one right after the http scheme, causing http://localhost/%2F -> http:/%2Flocalhost/%2F\nMotivation and Context\n\n\nTesting\nAdded integ tests and unit tests\nScreenshots (if appropriate)\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n I have read the CONTRIBUTING document\n Local run of mvn install succeeds\n My code follows the code style of this project\n My change requires a change to the Javadoc documentation\n I have updated the Javadoc documentation accordingly\n I have read the README document\n I have added tests to cover my changes\n All new and existing tests passed\n A short description of the change has been added to the CHANGELOG\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-10-01T20:34:37Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079", "merged": true, "mergeCommit": {"oid": "323b2164052f5ed4aec7ea0a4341b9314e7f9d8b"}, "closed": true, "closedAt": "2020-10-02T01:48:59Z", "author": {"login": "zoewangg"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOXmBHgFqTUwMDcwMjQ1MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOalEqAFqTUwMDc5NDU5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzAyNDUx", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#pullrequestreview-500702451", "createdAt": "2020-10-01T20:41:31Z", "commit": {"oid": "87fa6603cad01f097ae35ea89a2ee0b75392efcb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMDo0MTozMVrOHbaIIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMDo0MTozMVrOHbaIIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMTY2Nw==", "bodyText": "Irrelevant but \"wow\" to this name.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498501667", "createdAt": "2020-10-01T20:41:31Z", "author": {"login": "Quanzzzz"}, "path": "services/s3/src/it/java/software/amazon/awssdk/services/s3/KeysWithLeadingSlashIntegrationTest.java", "diffHunk": "@@ -26,7 +26,8 @@\n public class KeysWithLeadingSlashIntegrationTest extends S3IntegrationTestBase {\n \n     private static final String BUCKET = temporaryBucketName(KeysWithLeadingSlashIntegrationTest.class);\n-    private static final String KEY = \"/stupidkeywithillegalleadingslashthatsucks\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87fa6603cad01f097ae35ea89a2ee0b75392efcb"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87fa6603cad01f097ae35ea89a2ee0b75392efcb", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/87fa6603cad01f097ae35ea89a2ee0b75392efcb", "committedDate": "2020-10-01T20:32:09Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}, "afterCommit": {"oid": "ccef13d571397dc180a9deac2b0c398a6d4741ca", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/ccef13d571397dc180a9deac2b0c398a6d4741ca", "committedDate": "2020-10-01T20:59:45Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzAwNTAx", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#pullrequestreview-500700501", "createdAt": "2020-10-01T20:38:22Z", "commit": {"oid": "87fa6603cad01f097ae35ea89a2ee0b75392efcb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMDozODoyMlrOHbaCtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMDo1Mjo0OFrOHbacfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwMDI3Nw==", "bodyText": "Seems unnecessary.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498500277", "createdAt": "2020-10-01T20:38:22Z", "author": {"login": "millems"}, "path": "http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/internal/ApacheHttpRequestConfig.java", "diffHunk": "@@ -1,3 +1,4 @@\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87fa6603cad01f097ae35ea89a2ee0b75392efcb"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUwNjg3OA==", "bodyText": "What if they are explicitly using the port? i.e. http://localhost:80/test. Is that handled correctly, without mangling the host for the signature?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498506878", "createdAt": "2020-10-01T20:52:48Z", "author": {"login": "millems"}, "path": "http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/internal/impl/ApacheHttpRequestFactory.java", "diffHunk": "@@ -66,12 +66,24 @@ public HttpRequestBase create(final HttpExecuteRequest request, final ApacheHttp\n      * and other AWS services, this is allowed and required. This methods replaces\n      * any occurrence of \"//\" in the URI path with \"/%2F\".\n      *\n+     * @see SdkHttpRequest#getUri()\n      * @param uri The existing URI with double slashes not sanitized for Apache.\n      * @return a new String containing the modified URI\n      */\n     private String sanitizeUri(URI uri) {\n-        String newPath = uri.getPath().replace(\"//\", \"/%2F\");\n-        return uri.toString().replace(uri.getPath(), newPath);\n+        String path = uri.getPath();\n+        if (path.contains(\"//\")) {\n+            String newPath = path.replace(\"//\", \"/%2F\");\n+            String portString = SdkHttpUtils.isUsingStandardPort(uri.getScheme(), uri.getPort()) ?\n+                                \"\" : \":\" + uri.getPort();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87fa6603cad01f097ae35ea89a2ee0b75392efcb"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccef13d571397dc180a9deac2b0c398a6d4741ca", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/ccef13d571397dc180a9deac2b0c398a6d4741ca", "committedDate": "2020-10-01T20:59:45Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}, "afterCommit": {"oid": "dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d", "committedDate": "2020-10-01T22:25:55Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzYwMDgw", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#pullrequestreview-500760080", "createdAt": "2020-10-01T22:28:26Z", "commit": {"oid": "dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMjoyODoyNlrOHbcp8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMjoyODoyNlrOHbcp8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU0MzA4OQ==", "bodyText": "What about fragment? Are there other parts of the URI we should also be worried about?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#discussion_r498543089", "createdAt": "2020-10-01T22:28:26Z", "author": {"login": "millems"}, "path": "http-clients/apache-client/src/main/java/software/amazon/awssdk/http/apache/internal/impl/ApacheHttpRequestFactory.java", "diffHunk": "@@ -66,12 +64,23 @@ public HttpRequestBase create(final HttpExecuteRequest request, final ApacheHttp\n      * and other AWS services, this is allowed and required. This methods replaces\n      * any occurrence of \"//\" in the URI path with \"/%2F\".\n      *\n+     * @see SdkHttpRequest#getUri()\n      * @param uri The existing URI with double slashes not sanitized for Apache.\n      * @return a new String containing the modified URI\n      */\n     private String sanitizeUri(URI uri) {\n-        String newPath = uri.getPath().replace(\"//\", \"/%2F\");\n-        return uri.toString().replace(uri.getPath(), newPath);\n+        String path = uri.getPath();\n+        if (path.contains(\"//\")) {\n+            String newPath = path.replace(\"//\", \"/%2F\");\n+            String port = uri.getPort() == -1 ? \"\" : String.valueOf(uri.getPort());\n+\n+            String query = uri.getQuery() == null ? \"\" : uri.getQuery();\n+\n+            return URI.create(uri.getScheme() + \"://\" +\n+                              uri.getHost() + port + newPath + query)\n+                      .toString();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzY5NzU5", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#pullrequestreview-500769759", "createdAt": "2020-10-01T22:53:52Z", "commit": {"oid": "dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/dbae29eee3be6359dc3e3b6e5a7f8f29f917ab2d", "committedDate": "2020-10-01T22:25:55Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}, "afterCommit": {"oid": "2b302acb2a605ac4b0efa5e6d97552220e2c334d", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2b302acb2a605ac4b0efa5e6d97552220e2c334d", "committedDate": "2020-10-01T23:01:05Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b302acb2a605ac4b0efa5e6d97552220e2c334d", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2b302acb2a605ac4b0efa5e6d97552220e2c334d", "committedDate": "2020-10-01T23:01:05Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}, "afterCommit": {"oid": "e4cbfe66dc51e2b1fadedc7883d869a374e31f83", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/e4cbfe66dc51e2b1fadedc7883d869a374e31f83", "committedDate": "2020-10-02T00:02:36Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0f0e0a72444ab367d7f340c350b63b76551927a", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d0f0e0a72444ab367d7f340c350b63b76551927a", "committedDate": "2020-10-02T00:03:59Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4cbfe66dc51e2b1fadedc7883d869a374e31f83", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/e4cbfe66dc51e2b1fadedc7883d869a374e31f83", "committedDate": "2020-10-02T00:02:36Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}, "afterCommit": {"oid": "d0f0e0a72444ab367d7f340c350b63b76551927a", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d0f0e0a72444ab367d7f340c350b63b76551927a", "committedDate": "2020-10-02T00:03:59Z", "message": "Fixed an issue in Apache HTTP client where a request with path parameter as a single slash threw invalid host name error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzk0NTk4", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2079#pullrequestreview-500794598", "createdAt": "2020-10-02T00:10:12Z", "commit": {"oid": "d0f0e0a72444ab367d7f340c350b63b76551927a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2358, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}