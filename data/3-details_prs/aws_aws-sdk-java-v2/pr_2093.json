{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MzI0NjIz", "number": 2093, "title": "Refactors S3EndpointUtils into a set of resolvers for endpoints.", "bodyText": "Description\nRefactors S3EndpointUtils into two resolvers for bucket names and access points, respectively. A factory returns a resolver based on the bucket name contents. Both resolvers return a ConfiguredS3SdkHttpRequest. The previous utils class now contains common methods used by both resolvers.\nMotivation and Context\nThe S3EndpointUtils class had grown far beyond being a utils class and has been doing the heavy lifting of parsing access points and building endpoints for them. With new types of S3 access point resources around the corner, splitting the code up into dedicated classes is more maintainable and decreases the risk of logic errors.\nTesting\nFunctional tests for EndpointAddressInterceptor and S3Utilities pass.\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n I have read the CONTRIBUTING document\n Local run of mvn install succeeds\n My code follows the code style of this project\n My change requires a change to the Javadoc documentation\n I have updated the Javadoc documentation accordingly\n I have read the README document\n I have added tests to cover my changes\n All new and existing tests passed\n A short description of the change has been added to the CHANGELOG\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-10-15T19:20:56Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2093", "merged": true, "mergeCommit": {"oid": "a1dafacb3d011c089c976d69264e0ccdec307f3c"}, "closed": true, "closedAt": "2020-10-19T23:57:39Z", "author": {"login": "cenedhryn"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdS4mFKgBqjM4ODM2MzI2NTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUNK8BABqjM4OTU5NzU0ODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0892ec416ec8587ce8905fd2ed6321420974cf3", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d0892ec416ec8587ce8905fd2ed6321420974cf3", "committedDate": "2020-10-15T19:14:00Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}, "afterCommit": {"oid": "6d3f2e25dce1942412c1bc18fc53000229a09613", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/6d3f2e25dce1942412c1bc18fc53000229a09613", "committedDate": "2020-10-15T21:23:22Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d3f2e25dce1942412c1bc18fc53000229a09613", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/6d3f2e25dce1942412c1bc18fc53000229a09613", "committedDate": "2020-10-15T21:23:22Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}, "afterCommit": {"oid": "d68d6ee0bf8f43399df713b81f9f14e99a895a97", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d68d6ee0bf8f43399df713b81f9f14e99a895a97", "committedDate": "2020-10-15T21:27:30Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d68d6ee0bf8f43399df713b81f9f14e99a895a97", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d68d6ee0bf8f43399df713b81f9f14e99a895a97", "committedDate": "2020-10-15T21:27:30Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}, "afterCommit": {"oid": "fb8acf129a3d4280c1b8c3404bac9eec3ec84a9a", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/fb8acf129a3d4280c1b8c3404bac9eec3ec84a9a", "committedDate": "2020-10-16T19:37:17Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTQ3OTUz", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2093#pullrequestreview-511947953", "createdAt": "2020-10-19T16:31:31Z", "commit": {"oid": "fb8acf129a3d4280c1b8c3404bac9eec3ec84a9a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjozMTozMlrOHkXO0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjozNjowN1rOHkXaSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5MTQwOA==", "bodyText": "Usually when we go to the trouble to do this (which we don't tend to for internal classes), there's also a private default constructor.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2093#discussion_r507891408", "createdAt": "2020-10-19T16:31:32Z", "author": {"login": "bmaizels"}, "path": "services/s3/src/main/java/software/amazon/awssdk/services/s3/internal/endpoints/S3AccessPointEndpointResolver.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.s3.internal.endpoints;\n+\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isAccelerateEnabled;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isArnRegionEnabled;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isDualstackEnabled;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isFipsRegion;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isFipsRegionProvided;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isPathStyleAccessEnabled;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.removeFipsIfNeeded;\n+\n+import java.net.URI;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.arns.Arn;\n+import software.amazon.awssdk.http.SdkHttpRequest;\n+import software.amazon.awssdk.regions.PartitionMetadata;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.s3.S3Configuration;\n+import software.amazon.awssdk.services.s3.internal.ConfiguredS3SdkHttpRequest;\n+import software.amazon.awssdk.services.s3.internal.resource.S3AccessPointBuilder;\n+import software.amazon.awssdk.services.s3.internal.resource.S3AccessPointResource;\n+import software.amazon.awssdk.services.s3.internal.resource.S3ArnConverter;\n+import software.amazon.awssdk.services.s3.internal.resource.S3OutpostAccessPointBuilder;\n+import software.amazon.awssdk.services.s3.internal.resource.S3OutpostResource;\n+import software.amazon.awssdk.services.s3.internal.resource.S3Resource;\n+import software.amazon.awssdk.services.s3.internal.resource.S3ResourceType;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * Returns a new configured HTTP request with a resolved access point endpoint and signing overrides.\n+ */\n+@SdkInternalApi\n+public final class S3AccessPointEndpointResolver implements S3EndpointResolver {\n+\n+    private static final String S3_OUTPOSTS_NAME = \"s3-outposts\";\n+\n+    public static S3AccessPointEndpointResolver create() {\n+        return new S3AccessPointEndpointResolver();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb8acf129a3d4280c1b8c3404bac9eec3ec84a9a"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5MTg1Mw==", "bodyText": "See previous comment about private default constructor.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2093#discussion_r507891853", "createdAt": "2020-10-19T16:32:16Z", "author": {"login": "bmaizels"}, "path": "services/s3/src/main/java/software/amazon/awssdk/services/s3/internal/endpoints/S3BucketEndpointResolver.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.s3.internal.endpoints;\n+\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.accelerateEndpoint;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.dualstackEndpoint;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isAccelerateEnabled;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isAccelerateSupported;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isDualstackEnabled;\n+import static software.amazon.awssdk.services.s3.internal.endpoints.S3EndpointUtils.isPathStyleAccessEnabled;\n+import static software.amazon.awssdk.utils.FunctionalUtils.invokeSafely;\n+\n+import java.net.URI;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.http.SdkHttpRequest;\n+import software.amazon.awssdk.regions.RegionMetadata;\n+import software.amazon.awssdk.services.s3.S3Configuration;\n+import software.amazon.awssdk.services.s3.internal.BucketUtils;\n+import software.amazon.awssdk.services.s3.internal.ConfiguredS3SdkHttpRequest;\n+\n+/**\n+ * Returns a new configured HTTP request with a resolved endpoint with either virtual addressing or path style access.\n+ * Supports accelerate and dual stack.\n+ */\n+@SdkInternalApi\n+public final class S3BucketEndpointResolver implements S3EndpointResolver {\n+\n+    public static S3BucketEndpointResolver create() {\n+        return new S3BucketEndpointResolver();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb8acf129a3d4280c1b8c3404bac9eec3ec84a9a"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5MjY5MQ==", "bodyText": "Since we're following the classic SDK pojo pattern here, we should also add a 'toBuilder()' method.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2093#discussion_r507892691", "createdAt": "2020-10-19T16:33:32Z", "author": {"login": "bmaizels"}, "path": "services/s3/src/main/java/software/amazon/awssdk/services/s3/internal/endpoints/S3EndpointResolverContext.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.s3.internal.endpoints;\n+\n+import java.util.Objects;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.core.SdkRequest;\n+import software.amazon.awssdk.http.SdkHttpRequest;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.s3.S3Configuration;\n+\n+/**\n+ * Contains the information needed to resolve S3 endpoints.\n+ */\n+@SdkInternalApi\n+public final class S3EndpointResolverContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb8acf129a3d4280c1b8c3404bac9eec3ec84a9a"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NDM0NA==", "bodyText": "I'm wondering if it would be more readable just to say\nif (bucketName != null && isArn(bucketName) { \n    return ACCESS_POINT_ENDPOINT_RESOLVER; \n} \nreturn BUCKET_ENDPOINT RESOLVER;", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2093#discussion_r507894344", "createdAt": "2020-10-19T16:36:07Z", "author": {"login": "bmaizels"}, "path": "services/s3/src/main/java/software/amazon/awssdk/services/s3/internal/endpoints/S3EndpointResolverFactory.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.s3.internal.endpoints;\n+\n+import java.util.Optional;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+\n+/**\n+ * Get endpoint resolver.\n+ */\n+@SdkInternalApi\n+public final class S3EndpointResolverFactory {\n+\n+    private static final S3EndpointResolver ACCESS_POINT_ENDPOINT_RESOLVER = S3AccessPointEndpointResolver.create();\n+    private static final S3EndpointResolver BUCKET_ENDPOINT_RESOLVER = S3BucketEndpointResolver.create();\n+\n+    private S3EndpointResolverFactory() {\n+    }\n+\n+    public static S3EndpointResolver getEndpointResolver(String bucketName) {\n+        return Optional.ofNullable(bucketName)\n+                       .filter(S3EndpointUtils::isArn)\n+                       .map(arn -> ACCESS_POINT_ENDPOINT_RESOLVER)\n+                       .orElseGet(() -> BUCKET_ENDPOINT_RESOLVER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb8acf129a3d4280c1b8c3404bac9eec3ec84a9a"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb8acf129a3d4280c1b8c3404bac9eec3ec84a9a", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/fb8acf129a3d4280c1b8c3404bac9eec3ec84a9a", "committedDate": "2020-10-16T19:37:17Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}, "afterCommit": {"oid": "3f496a0b9106f711862d949f5ab4d94ec89c9117", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/3f496a0b9106f711862d949f5ab4d94ec89c9117", "committedDate": "2020-10-19T18:07:59Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f496a0b9106f711862d949f5ab4d94ec89c9117", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/3f496a0b9106f711862d949f5ab4d94ec89c9117", "committedDate": "2020-10-19T18:07:59Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}, "afterCommit": {"oid": "a3a207908e1f35f4c0b6ffb1ba32a53717e570b9", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a3a207908e1f35f4c0b6ffb1ba32a53717e570b9", "committedDate": "2020-10-19T21:12:17Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMTY3Mjky", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2093#pullrequestreview-512167292", "createdAt": "2020-10-19T21:18:56Z", "commit": {"oid": "a3a207908e1f35f4c0b6ffb1ba32a53717e570b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c98d60aa9b57f354d171a1d98daef090a160fe57", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/c98d60aa9b57f354d171a1d98daef090a160fe57", "committedDate": "2020-10-19T23:55:51Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3a207908e1f35f4c0b6ffb1ba32a53717e570b9", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a3a207908e1f35f4c0b6ffb1ba32a53717e570b9", "committedDate": "2020-10-19T21:12:17Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}, "afterCommit": {"oid": "c98d60aa9b57f354d171a1d98daef090a160fe57", "author": {"user": {"login": "cenedhryn", "name": "Anna-Karin Salander"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/c98d60aa9b57f354d171a1d98daef090a160fe57", "committedDate": "2020-10-19T23:55:51Z", "message": "Refactors S3EndpointUtils into a set of resolvers for endpoints."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2365, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}