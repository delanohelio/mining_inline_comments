{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMTAwNTY0", "number": 1673, "title": "Fix overflow bugs in backoff strategy.", "bodyText": "Fixed issue #1453 based on the proposed fix code provided by OlegZhukov, set up ceils for baseDelay, maxBackoffTime and retriesAttempted to prevent potential overflow problems.\nDescription\n\nAdded three ceils for baseDelay, maxBackoffTime and retriesAttempted respectively. Restricted the exponentialDelayMillis from overflow via applying these ceils in calculation. Added unit tests for EqualJitterBackoffStrategy.java based on proposed test cases provided by OlegZhukov.\nIn addition, to make it easier to compare different Duration objects, two functions min and max are added in NumericUtils.java, corresponding tests are added too.\nMotivation and Context\n\n\nBefore this modification, the exponentialDelay has a risk of overflow due to its type as Integer. Besides, baseDelay and maxBackoffTime are not checked if they will meet overflow problems while converting into Millis. So to fix these potential problems, we need to add some restrictions on these variables, as well as the calculation.\nThe open issue corresponding to this pull request is: #1453 .\nTesting\n\n\n\nTwo new test classes are added in this pull request. One is the test class for EqualJitterBackoffStrategyTest.java, which includes unit tests for different values of baseDelay and maxBackoffTime. The other is for NumericUtils.java, testing whether the compare functions work well in different situations.\nScreenshots (if appropriate)\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n I have read the CONTRIBUTING document\n Local run of mvn install succeeds\n My code follows the code style of this project\n My change requires a change to the Javadoc documentation\n I have updated the Javadoc documentation accordingly\n I have read the README document\n I have added tests to cover my changes\n All new and existing tests passed\n A short description of the change has been added to the CHANGELOG\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-02-27T22:14:56Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673", "merged": true, "mergeCommit": {"oid": "9f7afe9fee0b43d003cbd8cda8ba6b0af72aab45"}, "closed": true, "closedAt": "2020-03-02T19:33:57Z", "author": {"login": "Quanzzzz"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIk7syABqjMwODAwMjg0MzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJyjD6gH2gAyMzgxMTAwNTY0OmY1ZjA4ZGMxNTRjMDdmMTk2Mzc0ODA4YmU3NDEwZjljMDBkOWJlNjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "780e563a0eb3f3b41ddda4046cf7e03adfd946a8", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/780e563a0eb3f3b41ddda4046cf7e03adfd946a8", "committedDate": "2020-02-27T22:20:57Z", "message": "Changed variable names"}, "afterCommit": {"oid": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "committedDate": "2020-02-28T00:34:36Z", "message": "Fix overflow bugs in backoff strategy."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTA1Mzcw", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#pullrequestreview-366105370", "createdAt": "2020-02-28T01:09:56Z", "commit": {"oid": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMTowOTo1NlrOFvmjmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMToxMTowNVrOFvmk-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1OTA5OQ==", "bodyText": "Javadoc this", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#discussion_r385459099", "createdAt": "2020-02-28T01:09:56Z", "author": {"login": "spfink"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java", "diffHunk": "@@ -24,6 +24,8 @@\n @FunctionalInterface\n public interface BackoffStrategy {\n \n+    int RETRIES_ATTEMPTED_CEILING = (int) Math.floor(Math.log(Integer.MAX_VALUE) / Math.log(2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1OTI0OA==", "bodyText": "You should pull in our style template as this is incorrect", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#discussion_r385459248", "createdAt": "2020-02-28T01:10:26Z", "author": {"login": "spfink"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/backoff/BackoffStrategy.java", "diffHunk": "@@ -33,21 +35,22 @@\n     Duration computeDelayBeforeNextRetry(RetryPolicyContext context);\n \n     default int calculateExponentialDelay(int retriesAttempted, Duration baseDelay, Duration maxBackoffTime) {\n-        return (int) Math.min((1L << retriesAttempted) * baseDelay.toMillis(), maxBackoffTime.toMillis());\n+        int cappedRetries = Math.min(retriesAttempted, RETRIES_ATTEMPTED_CEILING);\n+        return (int) Math.min(baseDelay.multipliedBy(1L << cappedRetries).toMillis(), maxBackoffTime.toMillis());\n     }\n \n     static BackoffStrategy defaultStrategy() {\n         return FullJitterBackoffStrategy.builder()\n-                                        .baseDelay(SdkDefaultRetrySetting.BASE_DELAY)\n-                                        .maxBackoffTime(SdkDefaultRetrySetting.MAX_BACKOFF)\n-                                        .build();\n+                .baseDelay(SdkDefaultRetrySetting.BASE_DELAY)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ1OTQ0OA==", "bodyText": "Take a look at some of our existing tests and rename these to match our pattern", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#discussion_r385459448", "createdAt": "2020-02-28T01:11:05Z", "author": {"login": "spfink"}, "path": "core/sdk-core/src/test/java/software/amazon/awssdk/core/retry/backoff/EqualJitterBackoffStrategyTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.retry.backoff;\n+\n+import org.junit.Test;\n+import org.mockito.Mock;\n+import software.amazon.awssdk.core.retry.RetryPolicyContext;\n+\n+import java.time.Duration;\n+import java.util.Random;\n+\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.Assert.*;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.testng.Assert.assertThrows;\n+\n+public class EqualJitterBackoffStrategyTest {\n+\n+    private static final int RANDOM_RESULT = 12345;\n+    private static final Duration FIVE_DAYS = Duration.ofDays(5);\n+    private static final Duration MAX_DURATION = Duration.ofSeconds(Long.MAX_VALUE);\n+    private static final Duration ONE_SECOND = Duration.ofSeconds(1);\n+    private static final Duration ONE_NANO_SECOND = Duration.ofNanos(1);\n+    private static final int NANO_IN_MILLISECONDS = 1_000_000;\n+    private static final Duration NEGATIVE_ONE_SECOND = Duration.ofSeconds(-1);\n+\n+    @Mock\n+    private Random mockRandom = mock(Random.class);\n+\n+    @Test\n+    public void GIVEN_exponentialDelayAboveCeiling_THEN_return_JitteredCeiling() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/0b1606c3b3015d0bd00405c2d7ebe3e3ee53cdae", "committedDate": "2020-02-28T00:34:36Z", "message": "Fix overflow bugs in backoff strategy."}, "afterCommit": {"oid": "3e89194e3f52c358e573c963ab8136c4fa6cb39f", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/3e89194e3f52c358e573c963ab8136c4fa6cb39f", "committedDate": "2020-02-28T06:26:47Z", "message": "Merge branch 'master' of https://github.com/aws/aws-sdk-java-v2 into backoff-overflow-fixing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e89194e3f52c358e573c963ab8136c4fa6cb39f", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/3e89194e3f52c358e573c963ab8136c4fa6cb39f", "committedDate": "2020-02-28T06:26:47Z", "message": "Merge branch 'master' of https://github.com/aws/aws-sdk-java-v2 into backoff-overflow-fixing"}, "afterCommit": {"oid": "0e723e512c60b46b1e7996c85582c699e11122b3", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/0e723e512c60b46b1e7996c85582c699e11122b3", "committedDate": "2020-02-28T06:37:44Z", "message": "Fix overflow bugs in backoff strategy."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NzUxNjk0", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1673#pullrequestreview-366751694", "createdAt": "2020-02-29T00:05:58Z", "commit": {"oid": "0e723e512c60b46b1e7996c85582c699e11122b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "committedDate": "2020-02-29T00:20:18Z", "message": "Fix overflow bugs in backoff strategy."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e723e512c60b46b1e7996c85582c699e11122b3", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/0e723e512c60b46b1e7996c85582c699e11122b3", "committedDate": "2020-02-28T06:37:44Z", "message": "Fix overflow bugs in backoff strategy."}, "afterCommit": {"oid": "cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/cc88c19b83b5c21dcae1b545d452b2ed55e6d7dc", "committedDate": "2020-02-29T00:20:18Z", "message": "Fix overflow bugs in backoff strategy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee4a458609ce5eb3220faa331922395c3299c6d7", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/ee4a458609ce5eb3220faa331922395c3299c6d7", "committedDate": "2020-02-29T00:49:51Z", "message": "Merge branch 'master' into backoff-overflow-fixing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5f08dc154c07f196374808be7410f9c00d9be64", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/f5f08dc154c07f196374808be7410f9c00d9be64", "committedDate": "2020-03-02T19:04:57Z", "message": "Merge branch 'master' into backoff-overflow-fixing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2699, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}