{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMDI3MTA4", "number": 1884, "title": "Async metrics Part1: Add metrics codegen changes for async clients", "bodyText": "Description\nAdd metrics codegen changes for async clients\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-06-09T19:47:21Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884", "merged": true, "mergeCommit": {"oid": "c882aaa0be323bd5cff55a5689347f4a1b9e13ff"}, "closed": true, "closedAt": "2020-06-10T17:08:25Z", "author": {"login": "zoewangg"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpqkfjgFqTQyNzQ5MTIwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp8ygjgFqTQyODI2MTA5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NDkxMjAz", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#pullrequestreview-427491203", "createdAt": "2020-06-09T19:52:50Z", "commit": {"oid": "f10bd22855ea90c7d15665c038e613c6cdcedd22"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxOTo1Mjo1MVrOGhZ26A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxOTo1Mjo1MVrOGhZ26A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY3OTg0OA==", "bodyText": "Publishing needs to happen after execution so we would need to add a completion stage to the future instead of publishing here", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#discussion_r437679848", "createdAt": "2020-06-09T19:52:51Z", "author": {"login": "dagnir"}, "path": "codegen/src/test/resources/software/amazon/awssdk/codegen/poet/client/test-endpoint-discovery-async.java", "diffHunk": "@@ -264,6 +288,10 @@ public final String serviceName() {\n             return executeFuture;\n         } catch (Throwable t) {\n             return CompletableFutureUtils.failedFuture(t);\n+        } finally {\n+            Optional<MetricPublisher> metricPublisher = MetricUtils.resolvePublisher(clientConfiguration,\n+                    testDiscoveryRequiredRequest);\n+            metricPublisher.ifPresent(p -> p.publish(apiCallMetricCollector.collect()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f10bd22855ea90c7d15665c038e613c6cdcedd22"}, "originalPosition": 107}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f10bd22855ea90c7d15665c038e613c6cdcedd22", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/f10bd22855ea90c7d15665c038e613c6cdcedd22", "committedDate": "2020-06-09T19:45:43Z", "message": "Add metrics codegen changes for async clients"}, "afterCommit": {"oid": "8f9280eedd6d776388dd2921f858259e1fd6b91b", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/8f9280eedd6d776388dd2921f858259e1fd6b91b", "committedDate": "2020-06-09T22:31:14Z", "message": "Add metrics codegen changes for async clients"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NTk0MDk4", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#pullrequestreview-427594098", "createdAt": "2020-06-09T22:40:18Z", "commit": {"oid": "8f9280eedd6d776388dd2921f858259e1fd6b91b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMjo0MDoxOFrOGhe1nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQyMjo0MDoxOFrOGhe1nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc2MTQzNg==", "bodyText": "I created this overload because for some operations, the input request is modified (eg: applySignerOverride), so the request variable is not final. As a result, we can't use the input request parameter in the whenComplete block because variables used in lambda should be final or effectively final", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#discussion_r437761436", "createdAt": "2020-06-09T22:40:18Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/util/MetricUtils.java", "diffHunk": "@@ -54,6 +56,19 @@ private MetricUtils() {\n         return Optional.ofNullable(clientConfig.option(METRIC_PUBLISHER));\n     }\n \n+    /**\n+     * Resolve the correct metric publisher to use. The publisher set on the request always takes precedence.\n+     *\n+     * @param clientConfig The client configuration.\n+     * @param requestConfig The request override configuration.\n+     * @return The metric publisher to use.\n+     */\n+    public static Optional<MetricPublisher> resolvePublisher(SdkClientConfiguration clientConfig,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f9280eedd6d776388dd2921f858259e1fd6b91b"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f9280eedd6d776388dd2921f858259e1fd6b91b", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/8f9280eedd6d776388dd2921f858259e1fd6b91b", "committedDate": "2020-06-09T22:31:14Z", "message": "Add metrics codegen changes for async clients"}, "afterCommit": {"oid": "881eb7f1b379435a00702aa5379ed1178059424f", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/881eb7f1b379435a00702aa5379ed1178059424f", "committedDate": "2020-06-09T23:04:37Z", "message": "Add metrics codegen changes for async clients"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "881eb7f1b379435a00702aa5379ed1178059424f", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/881eb7f1b379435a00702aa5379ed1178059424f", "committedDate": "2020-06-09T23:04:37Z", "message": "Add metrics codegen changes for async clients"}, "afterCommit": {"oid": "63e8c9b4e2c205bafad294a2c0c12c529c040459", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/63e8c9b4e2c205bafad294a2c0c12c529c040459", "committedDate": "2020-06-10T05:55:53Z", "message": "Add metrics codegen changes for async clients"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63e8c9b4e2c205bafad294a2c0c12c529c040459", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/63e8c9b4e2c205bafad294a2c0c12c529c040459", "committedDate": "2020-06-10T05:55:53Z", "message": "Add metrics codegen changes for async clients"}, "afterCommit": {"oid": "a3a62b40b3a8616cada8bbbc6342eec75d0d81fa", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a3a62b40b3a8616cada8bbbc6342eec75d0d81fa", "committedDate": "2020-06-10T05:58:49Z", "message": "Add metrics codegen changes for async clients"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3a62b40b3a8616cada8bbbc6342eec75d0d81fa", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a3a62b40b3a8616cada8bbbc6342eec75d0d81fa", "committedDate": "2020-06-10T05:58:49Z", "message": "Add metrics codegen changes for async clients"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MjYxMDk3", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1884#pullrequestreview-428261097", "createdAt": "2020-06-10T17:06:27Z", "commit": {"oid": "a3a62b40b3a8616cada8bbbc6342eec75d0d81fa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2595, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}