{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMjQ1MTI3", "number": 1681, "title": "Updated retry policy behavior.", "bodyText": "Added support for \"retry modes\". A retry mode allows configuring multiple SDK parameters at once using default retry profiles, some of which are standardized between AWS SDK languages. See RetryMode javadoc for more information.\nAdded the ability to configure or disable the default retry throttling behavior of the SDK that 'kicks in' during a large volume of retriable service call errors. This behavior can now be configured via RetryPolicy.retryCapacityCondition.\nFixed an issue where the retry condition returned by RetryPolicy.retryCondition differed from the one specified by RetryPolicy.Builder.retryCondition. The old value can be accessed via the new RetryPolicy.aggregateRetryCondition.\nFixed an issue where specifying your own retry policy would override AWS and service-specific retry conditions. By default, all retry policies now have AWS and service-specific retry conditions added. This can be disabled via the new RetryPolicy.furtherRefinementsAllowed(false).", "createdAt": "2020-03-03T23:16:46Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681", "merged": true, "mergeCommit": {"oid": "77b07a22fd937fd83d0d37be8715a761e7b95739"}, "closed": true, "closedAt": "2020-03-07T00:06:10Z", "author": {"login": "millems"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKfNYiAFqTM2OTEyMTU0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLJC0-gH2gAyMzgzMjQ1MTI3OjUzMWQ2OWRlMGFkYTYwYmE2MDg5NWQ3YzA0ZGQ3M2QzYzc2ZWVhZWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTIxNTQ5", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#pullrequestreview-369121549", "createdAt": "2020-03-04T21:05:01Z", "commit": {"oid": "d6d3caa45d6e6e59529a90e6853a8bf235a00767"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMTowNTowMlrOFx9lhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMzowMjo0NFrOFyA0_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkzMzU3Mg==", "bodyText": "add @ThreadSafe?\nCan we add some tests for this class to make sure it's actually thread safe?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r387933572", "createdAt": "2020-03-04T21:05:02Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/capacity/TokenBucket.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.internal.capacity;\n+\n+import java.util.Optional;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.core.retry.conditions.TokenBucketRetryCondition.Capacity;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * A lock-free implementation of a token bucket. Tokens can be acquired from the bucket as long as there is sufficient capacity\n+ * in the bucket.\n+ */\n+@SdkInternalApi\n+public class TokenBucket {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d3caa45d6e6e59529a90e6853a8bf235a00767"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDUwMg==", "bodyText": "Hmm, what's the benefit of this over using locks? Not necessarily against this, but I'd prefer using locks if the perf gain is minimal because while(true) is scary...", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r387974502", "createdAt": "2020-03-04T22:31:59Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/capacity/TokenBucket.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.internal.capacity;\n+\n+import java.util.Optional;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.core.retry.conditions.TokenBucketRetryCondition.Capacity;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * A lock-free implementation of a token bucket. Tokens can be acquired from the bucket as long as there is sufficient capacity\n+ * in the bucket.\n+ */\n+@SdkInternalApi\n+public class TokenBucket {\n+    private final int maxCapacity;\n+    private final AtomicInteger capacity;\n+\n+    /**\n+     * Create a bucket containing the specified number of tokens.\n+     */\n+    public TokenBucket(int maxCapacity) {\n+        this.maxCapacity = maxCapacity;\n+        this.capacity = new AtomicInteger(maxCapacity);\n+    }\n+\n+    /**\n+     * Try to acquire a certain number of tokens from this bucket. If there aren't sufficient tokens in this bucket,\n+     * {@link Optional#empty()} is returned.\n+     */\n+    public Optional<Capacity> tryAcquire(int amountToAcquire) {\n+        Validate.isTrue(amountToAcquire >= 0, \"Amount must not be negative.\");\n+\n+        if (amountToAcquire == 0) {\n+            return Optional.of(Capacity.builder()\n+                                       .capacityAcquired(0)\n+                                       .capacityRemaining(capacity.get())\n+                                       .build());\n+        }\n+\n+        while (true) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d3caa45d6e6e59529a90e6853a8bf235a00767"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3ODU0Ng==", "bodyText": "2 features and 2 bug fixes! Let's break them to separate PRs next time. \ud83d\ude38", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r387978546", "createdAt": "2020-03-04T22:41:56Z", "author": {"login": "zoewangg"}, "path": ".changes/next-release/feature-AWSSDKforJavav2-f7b0ca8.json", "diffHunk": "@@ -0,0 +1,5 @@\n+{\n+    \"type\": \"feature\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d3caa45d6e6e59529a90e6853a8bf235a00767"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4Mjk1NA==", "bodyText": "Why did we remove those validations?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r387982954", "createdAt": "2020-03-04T22:52:59Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/http/ExecutionContext.java", "diffHunk": "@@ -37,10 +36,10 @@\n     private final ExecutionAttributes executionAttributes;\n \n     private ExecutionContext(final Builder builder) {\n-        this.signer = Validate.paramNotNull(builder.signer, \"signer\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d3caa45d6e6e59529a90e6853a8bf235a00767"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NDQ1NQ==", "bodyText": "can we create constants for the numbers?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r387984455", "createdAt": "2020-03-04T22:56:44Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/conditions/TokenBucketRetryCondition.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.retry.conditions;\n+\n+import java.util.Optional;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.core.interceptor.ExecutionAttribute;\n+import software.amazon.awssdk.core.interceptor.ExecutionAttributes;\n+import software.amazon.awssdk.core.internal.capacity.TokenBucket;\n+import software.amazon.awssdk.core.internal.retry.SdkDefaultRetrySetting;\n+import software.amazon.awssdk.core.retry.RetryMode;\n+import software.amazon.awssdk.core.retry.RetryPolicy;\n+import software.amazon.awssdk.core.retry.RetryPolicyContext;\n+import software.amazon.awssdk.utils.ToString;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * A {@link RetryCondition} that limits the number of retries made by the SDK using a token bucket algorithm. \"Tokens\" are\n+ * acquired from the bucket whenever {@link #shouldRetry} returns true, and are released to the bucket whenever\n+ * {@link #requestSucceeded} or {@link #requestWillNotBeRetried} are invoked.\n+ *\n+ * <p>\n+ * If \"tokens\" cannot be acquired from the bucket, it means too many requests have failed and the request will not be allowed\n+ * to retry until we start to see initial non-retried requests succeed via {@link #requestSucceeded(RetryPolicyContext)}.\n+ *\n+ * <p>\n+ * This prevents the client from holding the calling thread to retry when it's likely that it will fail anyway.\n+ *\n+ * <p>\n+ * This is currently included in the default {@link RetryPolicy#aggregateRetryCondition()}, but can be disabled by setting the\n+ * {@link RetryPolicy.Builder#retryCapacityCondition} to null.\n+ */\n+@SdkPublicApi\n+public class TokenBucketRetryCondition implements RetryCondition {\n+    private static final ExecutionAttribute<Capacity> LAST_ACQUIRED_CAPACITY =\n+        new ExecutionAttribute<>(\"TokenBucketRetryCondition.LAST_ACQUIRED_CAPACITY\");\n+\n+    private static final ExecutionAttribute<Integer> RETRY_COUNT_OF_LAST_CAPACITY_ACQUISITION =\n+        new ExecutionAttribute<>(\"TokenBucketRetryCondition.RETRY_COUNT_OF_LAST_CAPACITY_ACQUISITION\");\n+\n+    private final TokenBucket capacity;\n+    private final TokenBucketExceptionCostCalculator exceptionCostCalculator;\n+\n+    private TokenBucketRetryCondition(Builder builder) {\n+        this.capacity = new TokenBucket(Validate.notNull(builder.tokenBucketSize, \"tokenBucketSize\"));\n+        this.exceptionCostCalculator = Validate.notNull(builder.exceptionCostCalculator, \"exceptionCostCalculator\");\n+    }\n+\n+    /**\n+     * Create a condition using the {@link RetryMode#defaultRetryMode()}. This is equivalent to\n+     * {@code forRetryMode(RetryMode.defaultRetryMode())}.\n+     *\n+     * <p>\n+     * For more detailed control, see {@link #builder()}.\n+     */\n+    public static TokenBucketRetryCondition create() {\n+        return forRetryMode(RetryMode.defaultRetryMode());\n+    }\n+\n+    /**\n+     * Create a condition using the configured {@link RetryMode}. The {@link RetryMode#LEGACY} does not subtract tokens from\n+     * the token bucket when throttling exceptions are encountered. The {@link RetryMode#STANDARD} treats throttling and non-\n+     * throttling exceptions as the same cost.\n+     *\n+     * <p>\n+     * For more detailed control, see {@link #builder()}.\n+     */\n+    public static TokenBucketRetryCondition forRetryMode(RetryMode retryMode) {\n+        return TokenBucketRetryCondition.builder()\n+                                        .tokenBucketSize(SdkDefaultRetrySetting.TOKEN_BUCKET_SIZE)\n+                                        .exceptionCostCalculator(getExceptionCostCalculator(retryMode))\n+                                        .build();\n+    }\n+\n+    private static TokenBucketExceptionCostCalculator getExceptionCostCalculator(RetryMode retryMode) {\n+        switch (retryMode) {\n+            case LEGACY: return TokenBucketExceptionCostCalculator.builder()\n+                                                                  .throttlingExceptionCost(0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d3caa45d6e6e59529a90e6853a8bf235a00767"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NjY4Nw==", "bodyText": "Do we really need additional hooks? I feel there are some overlaps between them and interceptors. I'd be fine if this is internal, but this class is public api.\nMy concern is that having two places to inject afterAttempt hooks can be confusing.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r387986687", "createdAt": "2020-03-04T23:02:44Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/conditions/RetryCondition.java", "diffHunk": "@@ -32,14 +30,31 @@\n      */\n     boolean shouldRetry(RetryPolicyContext context);\n \n+    /**\n+     * Called by the SDK to notify this condition that the provided request will not be retried, because some retry condition\n+     * determined that it shouldn't be retried.\n+     */\n+    default void requestWillNotBeRetried(RetryPolicyContext context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6d3caa45d6e6e59529a90e6853a8bf235a00767"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "130e4214c670291d913633862380fe06bb473a1d", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/130e4214c670291d913633862380fe06bb473a1d", "committedDate": "2020-03-05T18:31:38Z", "message": "Merge branch 'master' into millem/retry-improvements"}, "afterCommit": {"oid": "f68b47e8cbcffd15575df0beed171bc51f321773", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/f68b47e8cbcffd15575df0beed171bc51f321773", "committedDate": "2020-03-05T19:52:34Z", "message": "Addressed comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODYwOTA5", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#pullrequestreview-369860909", "createdAt": "2020-03-05T19:43:04Z", "commit": {"oid": "130e4214c670291d913633862380fe06bb473a1d"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxOTo0MzowNVrOFyhc_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMTo0ODoxOVrOFylYvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyMTIxNQ==", "bodyText": "How about addServiceSpecificRetryPolicy?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r388521215", "createdAt": "2020-03-05T19:43:05Z", "author": {"login": "zoewangg"}, "path": "core/aws-core/src/main/java/software/amazon/awssdk/awscore/retry/AwsRetryPolicy.java", "diffHunk": "@@ -31,12 +32,38 @@\n     private AwsRetryPolicy() {\n     }\n \n+    /**\n+     * Retrieve the {@link RetryCondition#defaultRetryCondition()} with AWS-specific conditions added.\n+     */\n     public static RetryCondition defaultRetryCondition() {\n-        return OrRetryCondition.create(RetryCondition.defaultRetryCondition(),\n-                                       RetryOnErrorCodeCondition.create(AwsErrorCode.RETRYABLE_ERROR_CODES));\n+        return OrRetryCondition.create(RetryCondition.defaultRetryCondition(), awsRetryCondition());\n     }\n \n+    /**\n+     * Retrieve the {@link RetryPolicy#defaultRetryPolicy()} with AWS-specific conditions added.\n+     */\n     public static RetryPolicy defaultRetryPolicy() {\n-        return RetryPolicy.defaultRetryPolicy().toBuilder().retryCondition(defaultRetryCondition()).build();\n+        return forRetryMode(RetryMode.defaultRetryMode());\n+    }\n+\n+    /**\n+     * Retrieve the {@link RetryPolicy#defaultRetryPolicy()} with AWS-specific conditions added. This uses the specified\n+     * {@link RetryMode} when constructing the {@link RetryPolicy}.\n+     */\n+    public static RetryPolicy forRetryMode(RetryMode retryMode) {\n+        return addRefinements(RetryPolicy.forRetryMode(retryMode));\n+    }\n+\n+    /**\n+     * Update the provided {@link RetryPolicy} to add AWS-specific conditions.\n+     */\n+    public static RetryPolicy addRefinements(RetryPolicy condition) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "130e4214c670291d913633862380fe06bb473a1d"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUyMjQwOQ==", "bodyText": "How about serviceSpecificRetryPolicyAllowed or shouldAddServiceSpecificRetryPolicy?\nShould we use Boolean so that we can differentiate the default with unset?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r388522409", "createdAt": "2020-03-05T19:45:08Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/RetryPolicy.java", "diffHunk": "@@ -112,71 +208,142 @@ public boolean equals(Object o) {\n         if (!throttlingBackoffStrategy.equals(that.throttlingBackoffStrategy)) {\n             return false;\n         }\n-        return numRetries.equals(that.numRetries);\n+        return true;\n     }\n \n     @Override\n     public int hashCode() {\n-        int result = retryCondition.hashCode();\n+        int result = aggregateRetryCondition.hashCode();\n+        result = 31 * result + Boolean.hashCode(furtherRefinementsAllowed);\n         result = 31 * result + backoffStrategy.hashCode();\n         result = 31 * result + throttlingBackoffStrategy.hashCode();\n-        result = 31 * result + numRetries.hashCode();\n         return result;\n     }\n \n-    public static Builder builder() {\n-        return new BuilderImpl();\n-    }\n-\n-    public static RetryPolicy defaultRetryPolicy() {\n-        return RetryPolicy.builder()\n-                          .backoffStrategy(BackoffStrategy.defaultStrategy())\n-                          .throttlingBackoffStrategy(BackoffStrategy.defaultThrottlingStrategy())\n-                          .numRetries(SdkDefaultRetrySetting.DEFAULT_MAX_RETRIES)\n-                          .retryCondition(RetryCondition.defaultRetryCondition())\n-                          .build();\n-    }\n-\n-    public static RetryPolicy none() {\n-        return RetryPolicy.builder()\n-                          .numRetries(0)\n-                          .backoffStrategy(BackoffStrategy.none())\n-                          .throttlingBackoffStrategy(BackoffStrategy.none())\n-                          .retryCondition(RetryCondition.none())\n-                          .build();\n-    }\n-\n     public interface Builder extends CopyableBuilder<Builder, RetryPolicy> {\n-        Builder numRetries(Integer numRetries);\n-\n-        Integer numRetries();\n-\n+        /**\n+         * Configure whether further refinements of this retry policy are allowed after it is created. This may include service-\n+         * specific retry conditions that may not otherwise be covered by the {@link RetryCondition#defaultRetryCondition()}.\n+         *\n+         * <p>\n+         * By default, this is true.\n+         */\n+        Builder furtherRefinementsAllowed(boolean furtherRefinementsAllowed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "130e4214c670291d913633862380fe06bb473a1d"}, "originalPosition": 247}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzMDMyNw==", "bodyText": "Don't we need to update the generated test files accordingly to make the codegen tests pass?  Or we don't have any tests for it?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r388530327", "createdAt": "2020-03-05T19:59:15Z", "author": {"login": "zoewangg"}, "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/builder/BaseClientBuilderClass.java", "diffHunk": "@@ -198,14 +197,20 @@ private MethodSpec finalizeServiceConfigurationMethod() {\n                    .endControlFlow();\n \n             builder.addCode(\"return config.toBuilder()\\n\" +\n-                                  \"       .option($1T.EXECUTION_INTERCEPTORS, interceptors)\\n\" +\n-                                  \"       .option($1T.ENDPOINT_DISCOVERY_ENABLED, endpointDiscoveryEnabled)\\n\" +\n-                                  \"       .build();\", SdkClientOption.class);\n+                            \".option($T.ENDPOINT_DISCOVERY_ENABLED, endpointDiscoveryEnabled)\\n\",\n+                            SdkClientOption.class);\n         } else {\n-            builder.addCode(\"return config.toBuilder()\\n\" +\n-                                  \"       .option($T.EXECUTION_INTERCEPTORS, interceptors)\\n\" +\n-                                  \"       .build();\", SdkClientOption.class);\n+            builder.addCode(\"return config.toBuilder()\\n\");\n+        }\n+\n+        builder.addCode(\".option($1T.EXECUTION_INTERCEPTORS, interceptors)\", SdkClientOption.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68b47e8cbcffd15575df0beed171bc51f321773"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzMzUwMg==", "bodyText": "What's isBeforeAttemptSent?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r388533502", "createdAt": "2020-03-05T20:05:47Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/http/pipeline/stages/utils/RetryableStageHelper.java", "diffHunk": "@@ -0,0 +1,231 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.internal.http.pipeline.stages.utils;\n+\n+import static software.amazon.awssdk.core.internal.retry.SdkDefaultRetrySetting.SDK_RETRY_INFO_HEADER;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletionException;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.core.Response;\n+import software.amazon.awssdk.core.SdkStandardLogger;\n+import software.amazon.awssdk.core.client.config.SdkClientOption;\n+import software.amazon.awssdk.core.exception.NonRetryableException;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.core.exception.SdkException;\n+import software.amazon.awssdk.core.internal.InternalCoreExecutionAttribute;\n+import software.amazon.awssdk.core.internal.http.HttpClientDependencies;\n+import software.amazon.awssdk.core.internal.http.RequestExecutionContext;\n+import software.amazon.awssdk.core.internal.http.pipeline.stages.AsyncRetryableStage;\n+import software.amazon.awssdk.core.internal.http.pipeline.stages.RetryableStage;\n+import software.amazon.awssdk.core.internal.retry.ClockSkewAdjuster;\n+import software.amazon.awssdk.core.retry.RetryPolicy;\n+import software.amazon.awssdk.core.retry.RetryPolicyContext;\n+import software.amazon.awssdk.core.retry.RetryUtils;\n+import software.amazon.awssdk.core.retry.conditions.TokenBucketRetryCondition;\n+import software.amazon.awssdk.http.SdkHttpFullRequest;\n+import software.amazon.awssdk.http.SdkHttpResponse;\n+\n+/**\n+ * Contains the logic shared by {@link RetryableStage} and {@link AsyncRetryableStage} when querying and interacting with a\n+ * {@link RetryPolicy}.\n+ */\n+@SdkInternalApi\n+public class RetryableStageHelper {\n+    private final SdkHttpFullRequest request;\n+    private final RequestExecutionContext context;\n+    private final RetryPolicy retryPolicy;\n+    private final HttpClientDependencies dependencies;\n+\n+    private int attemptNumber = 0;\n+    private SdkHttpResponse lastResponse = null;\n+    private SdkException lastException = null;\n+    private Duration lastBackoffDelay = null;\n+\n+    public RetryableStageHelper(SdkHttpFullRequest request,\n+                                RequestExecutionContext context,\n+                                HttpClientDependencies dependencies) {\n+        this.request = request;\n+        this.context = context;\n+        this.retryPolicy = dependencies.clientConfiguration().option(SdkClientOption.RETRY_POLICY);\n+        this.dependencies = dependencies;\n+    }\n+\n+    /**\n+     * Invoke when starting a request attempt, before querying the retry policy.\n+     */\n+    public void startingAttempt() {\n+        ++attemptNumber;\n+        context.executionAttributes().putAttribute(InternalCoreExecutionAttribute.EXECUTION_ATTEMPT, attemptNumber);\n+    }\n+\n+    /**\n+     * Returns true if the retry policy allows this attempt. This will always return true if the current attempt is not a retry\n+     * (i.e. it's the first request in the execution).\n+     */\n+    public boolean retryPolicyAllowsRetry() {\n+        if (isInitialAttempt()) {\n+            return true;\n+        }\n+\n+        if (lastException instanceof NonRetryableException) {\n+            return false;\n+        }\n+\n+        RetryPolicyContext context = retryPolicyContext(true);\n+\n+        boolean willRetry = retryPolicy.aggregateRetryCondition().shouldRetry(context);\n+        if (!willRetry) {\n+            retryPolicy.aggregateRetryCondition().requestWillNotBeRetried(context);\n+        }\n+\n+        return willRetry;\n+    }\n+\n+    /**\n+     * Return the exception that should be thrown, because the retry policy did not allow the request to be retried.\n+     */\n+    public SdkException retryPolicyDisallowedRetryException() {\n+        return lastException;\n+    }\n+\n+    /**\n+     * Get the amount of time that the request should be delayed before being sent. This may be {@link Duration#ZERO}, such as\n+     * for the first request in the request series.\n+     */\n+    public Duration getBackoffDelay() {\n+        Duration result;\n+        if (isInitialAttempt()) {\n+            result = Duration.ZERO;\n+        } else {\n+            RetryPolicyContext context = retryPolicyContext(true);\n+            if (RetryUtils.isThrottlingException(lastException)) {\n+                result = retryPolicy.throttlingBackoffStrategy().computeDelayBeforeNextRetry(context);\n+            } else {\n+                result = retryPolicy.backoffStrategy().computeDelayBeforeNextRetry(context);\n+            }\n+        }\n+        lastBackoffDelay = result;\n+        return result;\n+    }\n+\n+    /**\n+     * Log a message to the user at the debug level to indicate how long we will wait before retrying the request.\n+     */\n+    public void logBackingOff(Duration backoffDelay) {\n+        SdkStandardLogger.REQUEST_LOGGER.debug(() -> \"Retryable error detected. Will retry in \" +\n+                                                     backoffDelay.toMillis() + \"ms. Request attempt number \" +\n+                                                     attemptNumber);\n+    }\n+\n+    /**\n+     * Retrieve the request to send to the service, including any detailed retry information headers.\n+     */\n+    public SdkHttpFullRequest requestToSend() {\n+        Integer availableRetryCapacity = TokenBucketRetryCondition.getCapacityForExecution(context.executionAttributes())\n+                                                                  .map(TokenBucketRetryCondition.Capacity::capacityRemaining)\n+                                                                  .orElse(null);\n+\n+        return request.toBuilder()\n+                      .putHeader(SDK_RETRY_INFO_HEADER,\n+                                 String.format(\"%s/%s/%s\",\n+                                               attemptNumber - 1,\n+                                               lastBackoffDelay.toMillis(),\n+                                               availableRetryCapacity != null ? availableRetryCapacity : \"\"))\n+                      .build();\n+    }\n+\n+    /**\n+     * Log a message to the user at the debug level to indicate that we are sending the request to the service.\n+     */\n+    public void logSendingRequest() {\n+        SdkStandardLogger.REQUEST_LOGGER.debug(() -> (isInitialAttempt() ? \"Sending\" : \"Retrying\") + \" Request: \" + request);\n+    }\n+\n+    /**\n+     * Adjust the client-side clock skew if the provided response indicates that there is a large skew between the client and\n+     * service. This will allow a retried request to be signed with what is likely to be a more accurate time.\n+     */\n+    public void adjustClockIfClockSkew(Response<?> response) {\n+        ClockSkewAdjuster clockSkewAdjuster = dependencies.clockSkewAdjuster();\n+        if (!response.isSuccess() && clockSkewAdjuster.shouldAdjust(response.exception())) {\n+            dependencies.updateTimeOffset(clockSkewAdjuster.getAdjustmentInSeconds(response.httpResponse()));\n+        }\n+    }\n+\n+    /**\n+     * Notify the retry policy that the request attempt succeeded.\n+     */\n+    public void attemptSucceeded() {\n+        retryPolicy.aggregateRetryCondition().requestSucceeded(retryPolicyContext(false));\n+    }\n+\n+    /**\n+     * Retrieve the current attempt number, updated whenever {@link #startingAttempt()} is invoked.\n+     */\n+    public int getAttemptNumber() {\n+        return attemptNumber;\n+    }\n+\n+    /**\n+     * Retrieve the last call failure exception encountered by this execution, updated whenever {@link #setLastException} is\n+     * invoked.\n+     */\n+    public SdkException getLastException() {\n+        return lastException;\n+    }\n+\n+    /**\n+     * Update the {@link #getLastException()} value for this helper. This will be used to determine whether the request should\n+     * be retried.\n+     */\n+    public void setLastException(Throwable lastException) {\n+        if (lastException instanceof CompletionException) {\n+            setLastException(lastException.getCause());\n+        } else if (lastException instanceof SdkException) {\n+            this.lastException = (SdkException) lastException;\n+        } else {\n+            this.lastException = SdkClientException.create(\"Unable to execute HTTP request: \" + lastException.getMessage(),\n+                                                           lastException);\n+        }\n+    }\n+\n+    /**\n+     * Set the last HTTP response returned by the service. This will be used to determine whether the request should be retried.\n+     */\n+    public void setLastResponse(SdkHttpResponse lastResponse) {\n+        this.lastResponse = lastResponse;\n+    }\n+\n+    private boolean isInitialAttempt() {\n+        return attemptNumber == 1;\n+    }\n+\n+    private RetryPolicyContext retryPolicyContext(boolean isBeforeAttemptSent) {\n+        return RetryPolicyContext.builder()\n+                                 .request(request)\n+                                 .originalRequest(context.originalRequest())\n+                                 .exception(lastException)\n+                                 .retriesAttempted(retriesAttemptedSoFar(isBeforeAttemptSent))\n+                                 .executionAttributes(context.executionAttributes())\n+                                 .httpStatusCode(lastResponse == null ? null : lastResponse.statusCode())\n+                                 .build();\n+    }\n+\n+    private int retriesAttemptedSoFar(boolean isBeforeAttemptSent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68b47e8cbcffd15575df0beed171bc51f321773"}, "originalPosition": 228}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzNTE2NA==", "bodyText": "How about TokenBucketExceptionCostProvider? I feel it doesn't really calculate anything..", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r388535164", "createdAt": "2020-03-05T20:09:12Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/conditions/TokenBucketExceptionCostCalculator.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.retry.conditions;\n+\n+import java.util.function.Function;\n+import software.amazon.awssdk.annotations.NotThreadSafe;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.annotations.ThreadSafe;\n+import software.amazon.awssdk.core.exception.SdkException;\n+import software.amazon.awssdk.core.internal.retry.DefaultTokenBucketExceptionCostCalculator;\n+\n+/**\n+ * A function used by {@link TokenBucketRetryCondition} to determine how many tokens should be removed from the bucket when an\n+ * exception is encountered. This can be implemented directly, or using the helper methods provided by the {@link #builder()}.\n+ */\n+@SdkPublicApi\n+@FunctionalInterface\n+@ThreadSafe\n+public interface TokenBucketExceptionCostCalculator extends Function<SdkException, Integer> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68b47e8cbcffd15575df0beed171bc51f321773"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODUzOTAwNg==", "bodyText": "No, it would not improve readability, but I think it would improve maintainability to have all default sdk retry configurations in one place, i.e., SdkDefaultRetrySetting where we keep TOKEN_BUCKET_SIZE. In addition, when customers ask our default settings, we can just point them to one place.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r388539006", "createdAt": "2020-03-05T20:16:29Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/conditions/TokenBucketRetryCondition.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.retry.conditions;\n+\n+import java.util.Optional;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.core.interceptor.ExecutionAttribute;\n+import software.amazon.awssdk.core.interceptor.ExecutionAttributes;\n+import software.amazon.awssdk.core.internal.capacity.TokenBucket;\n+import software.amazon.awssdk.core.internal.retry.SdkDefaultRetrySetting;\n+import software.amazon.awssdk.core.retry.RetryMode;\n+import software.amazon.awssdk.core.retry.RetryPolicy;\n+import software.amazon.awssdk.core.retry.RetryPolicyContext;\n+import software.amazon.awssdk.utils.ToString;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * A {@link RetryCondition} that limits the number of retries made by the SDK using a token bucket algorithm. \"Tokens\" are\n+ * acquired from the bucket whenever {@link #shouldRetry} returns true, and are released to the bucket whenever\n+ * {@link #requestSucceeded} or {@link #requestWillNotBeRetried} are invoked.\n+ *\n+ * <p>\n+ * If \"tokens\" cannot be acquired from the bucket, it means too many requests have failed and the request will not be allowed\n+ * to retry until we start to see initial non-retried requests succeed via {@link #requestSucceeded(RetryPolicyContext)}.\n+ *\n+ * <p>\n+ * This prevents the client from holding the calling thread to retry when it's likely that it will fail anyway.\n+ *\n+ * <p>\n+ * This is currently included in the default {@link RetryPolicy#aggregateRetryCondition()}, but can be disabled by setting the\n+ * {@link RetryPolicy.Builder#retryCapacityCondition} to null.\n+ */\n+@SdkPublicApi\n+public class TokenBucketRetryCondition implements RetryCondition {\n+    private static final ExecutionAttribute<Capacity> LAST_ACQUIRED_CAPACITY =\n+        new ExecutionAttribute<>(\"TokenBucketRetryCondition.LAST_ACQUIRED_CAPACITY\");\n+\n+    private static final ExecutionAttribute<Integer> RETRY_COUNT_OF_LAST_CAPACITY_ACQUISITION =\n+        new ExecutionAttribute<>(\"TokenBucketRetryCondition.RETRY_COUNT_OF_LAST_CAPACITY_ACQUISITION\");\n+\n+    private final TokenBucket capacity;\n+    private final TokenBucketExceptionCostCalculator exceptionCostCalculator;\n+\n+    private TokenBucketRetryCondition(Builder builder) {\n+        this.capacity = new TokenBucket(Validate.notNull(builder.tokenBucketSize, \"tokenBucketSize\"));\n+        this.exceptionCostCalculator = Validate.notNull(builder.exceptionCostCalculator, \"exceptionCostCalculator\");\n+    }\n+\n+    /**\n+     * Create a condition using the {@link RetryMode#defaultRetryMode()}. This is equivalent to\n+     * {@code forRetryMode(RetryMode.defaultRetryMode())}.\n+     *\n+     * <p>\n+     * For more detailed control, see {@link #builder()}.\n+     */\n+    public static TokenBucketRetryCondition create() {\n+        return forRetryMode(RetryMode.defaultRetryMode());\n+    }\n+\n+    /**\n+     * Create a condition using the configured {@link RetryMode}. The {@link RetryMode#LEGACY} does not subtract tokens from\n+     * the token bucket when throttling exceptions are encountered. The {@link RetryMode#STANDARD} treats throttling and non-\n+     * throttling exceptions as the same cost.\n+     *\n+     * <p>\n+     * For more detailed control, see {@link #builder()}.\n+     */\n+    public static TokenBucketRetryCondition forRetryMode(RetryMode retryMode) {\n+        return TokenBucketRetryCondition.builder()\n+                                        .tokenBucketSize(SdkDefaultRetrySetting.TOKEN_BUCKET_SIZE)\n+                                        .exceptionCostCalculator(getExceptionCostCalculator(retryMode))\n+                                        .build();\n+    }\n+\n+    private static TokenBucketExceptionCostCalculator getExceptionCostCalculator(RetryMode retryMode) {\n+        switch (retryMode) {\n+            case LEGACY: return TokenBucketExceptionCostCalculator.builder()\n+                                                                  .throttlingExceptionCost(0)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk4NDQ1NQ=="}, "originalCommit": {"oid": "d6d3caa45d6e6e59529a90e6853a8bf235a00767"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU0MjAxNA==", "bodyText": "Nice javadocs!", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r388542014", "createdAt": "2020-03-05T20:21:39Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/conditions/TokenBucketRetryCondition.java", "diffHunk": "@@ -0,0 +1,288 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.retry.conditions;\n+\n+import java.util.Optional;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.core.interceptor.ExecutionAttribute;\n+import software.amazon.awssdk.core.interceptor.ExecutionAttributes;\n+import software.amazon.awssdk.core.internal.capacity.TokenBucket;\n+import software.amazon.awssdk.core.internal.retry.SdkDefaultRetrySetting;\n+import software.amazon.awssdk.core.retry.RetryMode;\n+import software.amazon.awssdk.core.retry.RetryPolicy;\n+import software.amazon.awssdk.core.retry.RetryPolicyContext;\n+import software.amazon.awssdk.utils.ToString;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * A {@link RetryCondition} that limits the number of retries made by the SDK using a token bucket algorithm. \"Tokens\" are\n+ * acquired from the bucket whenever {@link #shouldRetry} returns true, and are released to the bucket whenever\n+ * {@link #requestSucceeded} or {@link #requestWillNotBeRetried} are invoked.\n+ *\n+ * <p>\n+ * If \"tokens\" cannot be acquired from the bucket, it means too many requests have failed and the request will not be allowed\n+ * to retry until we start to see initial non-retried requests succeed via {@link #requestSucceeded(RetryPolicyContext)}.\n+ *\n+ * <p>\n+ * This prevents the client from holding the calling thread to retry when it's likely that it will fail anyway.\n+ *\n+ * <p>\n+ * This is currently included in the default {@link RetryPolicy#aggregateRetryCondition()}, but can be disabled by setting the\n+ * {@link RetryPolicy.Builder#retryCapacityCondition} to null.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68b47e8cbcffd15575df0beed171bc51f321773"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU4NTY2Mw==", "bodyText": "Is this class tested anywhere?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r388585663", "createdAt": "2020-03-05T21:48:19Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/internal/http/pipeline/stages/utils/RetryableStageHelper.java", "diffHunk": "@@ -0,0 +1,231 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.core.internal.http.pipeline.stages.utils;\n+\n+import static software.amazon.awssdk.core.internal.retry.SdkDefaultRetrySetting.SDK_RETRY_INFO_HEADER;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletionException;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.core.Response;\n+import software.amazon.awssdk.core.SdkStandardLogger;\n+import software.amazon.awssdk.core.client.config.SdkClientOption;\n+import software.amazon.awssdk.core.exception.NonRetryableException;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.core.exception.SdkException;\n+import software.amazon.awssdk.core.internal.InternalCoreExecutionAttribute;\n+import software.amazon.awssdk.core.internal.http.HttpClientDependencies;\n+import software.amazon.awssdk.core.internal.http.RequestExecutionContext;\n+import software.amazon.awssdk.core.internal.http.pipeline.stages.AsyncRetryableStage;\n+import software.amazon.awssdk.core.internal.http.pipeline.stages.RetryableStage;\n+import software.amazon.awssdk.core.internal.retry.ClockSkewAdjuster;\n+import software.amazon.awssdk.core.retry.RetryPolicy;\n+import software.amazon.awssdk.core.retry.RetryPolicyContext;\n+import software.amazon.awssdk.core.retry.RetryUtils;\n+import software.amazon.awssdk.core.retry.conditions.TokenBucketRetryCondition;\n+import software.amazon.awssdk.http.SdkHttpFullRequest;\n+import software.amazon.awssdk.http.SdkHttpResponse;\n+\n+/**\n+ * Contains the logic shared by {@link RetryableStage} and {@link AsyncRetryableStage} when querying and interacting with a\n+ * {@link RetryPolicy}.\n+ */\n+@SdkInternalApi\n+public class RetryableStageHelper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f68b47e8cbcffd15575df0beed171bc51f321773"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTk0NzA4", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#pullrequestreview-369994708", "createdAt": "2020-03-05T23:55:57Z", "commit": {"oid": "7617d615acb74776d421a8a5eb1e566ab21eb0b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMzo1NTo1N1rOFyoSjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMzo1NTo1N1rOFyoSjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYzMzIyOQ==", "bodyText": "Seems we only have tests for sync client. Can we add tests for async client as well?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r388633229", "createdAt": "2020-03-05T23:55:57Z", "author": {"login": "zoewangg"}, "path": "test/codegen-generated-classes-test/src/test/java/software/amazon/awssdk/services/retry/ClientRetryModeTest.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright 2010-2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.retry;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.anyRequestedFor;\n+import static com.github.tomakehurst.wiremock.client.WireMock.anyUrl;\n+import static com.github.tomakehurst.wiremock.client.WireMock.post;\n+import static com.github.tomakehurst.wiremock.client.WireMock.stubFor;\n+import static com.github.tomakehurst.wiremock.client.WireMock.verify;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import com.github.tomakehurst.wiremock.junit.WireMockRule;\n+import java.net.URI;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;\n+import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;\n+import software.amazon.awssdk.core.exception.SdkException;\n+import software.amazon.awssdk.core.retry.RetryMode;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.protocolrestjson.ProtocolRestJsonClient;\n+import software.amazon.awssdk.services.protocolrestjson.ProtocolRestJsonClientBuilder;\n+\n+public class ClientRetryModeTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7617d615acb74776d421a8a5eb1e566ab21eb0b7"}, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7617d615acb74776d421a8a5eb1e566ab21eb0b7", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7617d615acb74776d421a8a5eb1e566ab21eb0b7", "committedDate": "2020-03-05T23:47:16Z", "message": "Merge branch 'master' into millem/retry-improvements"}, "afterCommit": {"oid": "c541587c6c11d5f64bdd3171680ee7ef7a3d6b52", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/c541587c6c11d5f64bdd3171680ee7ef7a3d6b52", "committedDate": "2020-03-06T19:35:22Z", "message": "Addressed comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c541587c6c11d5f64bdd3171680ee7ef7a3d6b52", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/c541587c6c11d5f64bdd3171680ee7ef7a3d6b52", "committedDate": "2020-03-06T19:35:22Z", "message": "Addressed comments."}, "afterCommit": {"oid": "d1c2a59537f740e8a2161f981406842ff24f5d31", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d1c2a59537f740e8a2161f981406842ff24f5d31", "committedDate": "2020-03-06T20:29:23Z", "message": "Addressed comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjM5Nzg1", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#pullrequestreview-370639785", "createdAt": "2020-03-06T21:32:57Z", "commit": {"oid": "d1c2a59537f740e8a2161f981406842ff24f5d31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMTozMjo1N1rOFzIH2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMTozMjo1N1rOFzIH2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE1NDc3OQ==", "bodyText": "Could this be a breaking change? Duplicate conditions provided would now get evaluated twice", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#discussion_r389154779", "createdAt": "2020-03-06T21:32:57Z", "author": {"login": "zoewangg"}, "path": "core/sdk-core/src/main/java/software/amazon/awssdk/core/retry/conditions/OrRetryCondition.java", "diffHunk": "@@ -28,12 +28,16 @@\n @SdkPublicApi\n public final class OrRetryCondition implements RetryCondition {\n \n-    private Set<RetryCondition> conditions = new HashSet<>();\n+    private final List<RetryCondition> conditions = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1c2a59537f740e8a2161f981406842ff24f5d31"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9baddaea810ed8ae0cf9ddfec115f5f0f318e4f9", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/9baddaea810ed8ae0cf9ddfec115f5f0f318e4f9", "committedDate": "2020-03-06T22:30:57Z", "message": "Merge branch 'master' into millem/retry-improvements"}, "afterCommit": {"oid": "2a1862c2c73c81a2c40a7fe48e244dbef5f1d833", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2a1862c2c73c81a2c40a7fe48e244dbef5f1d833", "committedDate": "2020-03-06T22:31:35Z", "message": "Updated retry policy behavior.\n\n1. Added support for \"retry modes\". A retry mode allows configuring multiple SDK parameters at once using default retry profiles, some of which are standardized between AWS SDK languages. See RetryMode javadoc for more information.\n2. Added the ability to configure or disable the default retry throttling behavior of the SDK that 'kicks in' during a large volume of retriable service call errors. This behavior can now be configured via `RetryPolicy.retryCapacityCondition`.\n3. Fixed an issue where the retry condition returned by `RetryPolicy.retryCondition` differed from the one specified by `RetryPolicy.Builder.retryCondition`. The old value can be accessed via the new `RetryPolicy.aggregateRetryCondition`.\n4. Fixed an issue where specifying your own retry policy would override AWS and service-specific retry conditions. By default, all retry policies now have AWS and service-specific retry conditions added. This can be disabled via the new `RetryPolicy.furtherRefinementsAllowed(false)`."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a1862c2c73c81a2c40a7fe48e244dbef5f1d833", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/2a1862c2c73c81a2c40a7fe48e244dbef5f1d833", "committedDate": "2020-03-06T22:31:35Z", "message": "Updated retry policy behavior.\n\n1. Added support for \"retry modes\". A retry mode allows configuring multiple SDK parameters at once using default retry profiles, some of which are standardized between AWS SDK languages. See RetryMode javadoc for more information.\n2. Added the ability to configure or disable the default retry throttling behavior of the SDK that 'kicks in' during a large volume of retriable service call errors. This behavior can now be configured via `RetryPolicy.retryCapacityCondition`.\n3. Fixed an issue where the retry condition returned by `RetryPolicy.retryCondition` differed from the one specified by `RetryPolicy.Builder.retryCondition`. The old value can be accessed via the new `RetryPolicy.aggregateRetryCondition`.\n4. Fixed an issue where specifying your own retry policy would override AWS and service-specific retry conditions. By default, all retry policies now have AWS and service-specific retry conditions added. This can be disabled via the new `RetryPolicy.furtherRefinementsAllowed(false)`."}, "afterCommit": {"oid": "b4dbc44b3b529b512ccae0eebaa02bd2f3bccb32", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/b4dbc44b3b529b512ccae0eebaa02bd2f3bccb32", "committedDate": "2020-03-06T22:47:46Z", "message": "Updated retry policy behavior.\n\n1. Added support for \"retry modes\". A retry mode allows configuring multiple SDK parameters at once using default retry profiles, some of which are standardized between AWS SDK languages. See RetryMode javadoc for more information.\n2. Added the ability to configure or disable the default retry throttling behavior of the SDK that 'kicks in' during a large volume of retriable service call errors. This behavior can now be configured via `RetryPolicy.retryCapacityCondition`.\n3. Fixed an issue where the retry condition returned by `RetryPolicy.retryCondition` differed from the one specified by `RetryPolicy.Builder.retryCondition`. The old value can be accessed via the new `RetryPolicy.aggregateRetryCondition`.\n4. Fixed an issue where specifying your own retry policy would override AWS and service-specific retry conditions. By default, all retry policies now have AWS and service-specific retry conditions added. This can be disabled via the new `RetryPolicy.furtherRefinementsAllowed(false)`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjc0MDgx", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1681#pullrequestreview-370674081", "createdAt": "2020-03-06T22:51:45Z", "commit": {"oid": "b4dbc44b3b529b512ccae0eebaa02bd2f3bccb32"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "329cd60c20de778b318cf2f9c50c0cda25c64d52", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/329cd60c20de778b318cf2f9c50c0cda25c64d52", "committedDate": "2020-03-06T23:45:55Z", "message": "Updated retry policy behavior.\n\n1. Added support for \"retry modes\". A retry mode allows configuring multiple SDK parameters at once using default retry profiles, some of which are standardized between AWS SDK languages. See RetryMode javadoc for more information.\n2. Added the ability to configure or disable the default retry throttling behavior of the SDK that 'kicks in' during a large volume of retriable service call errors. This behavior can now be configured via `RetryPolicy.retryCapacityCondition`.\n3. Fixed an issue where the retry condition returned by `RetryPolicy.retryCondition` differed from the one specified by `RetryPolicy.Builder.retryCondition`. The old value can be accessed via the new `RetryPolicy.aggregateRetryCondition`.\n4. Fixed an issue where specifying your own retry policy would override AWS and service-specific retry conditions. By default, all retry policies now have AWS and service-specific retry conditions added. This can be disabled via the new `RetryPolicy.furtherRefinementsAllowed(false)`."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3799a64ff4d75bbafd4830f03de147cf004c8d31", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/3799a64ff4d75bbafd4830f03de147cf004c8d31", "committedDate": "2020-03-06T22:52:47Z", "message": "Merge branch 'master' into millem/retry-improvements"}, "afterCommit": {"oid": "329cd60c20de778b318cf2f9c50c0cda25c64d52", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/329cd60c20de778b318cf2f9c50c0cda25c64d52", "committedDate": "2020-03-06T23:45:55Z", "message": "Updated retry policy behavior.\n\n1. Added support for \"retry modes\". A retry mode allows configuring multiple SDK parameters at once using default retry profiles, some of which are standardized between AWS SDK languages. See RetryMode javadoc for more information.\n2. Added the ability to configure or disable the default retry throttling behavior of the SDK that 'kicks in' during a large volume of retriable service call errors. This behavior can now be configured via `RetryPolicy.retryCapacityCondition`.\n3. Fixed an issue where the retry condition returned by `RetryPolicy.retryCondition` differed from the one specified by `RetryPolicy.Builder.retryCondition`. The old value can be accessed via the new `RetryPolicy.aggregateRetryCondition`.\n4. Fixed an issue where specifying your own retry policy would override AWS and service-specific retry conditions. By default, all retry policies now have AWS and service-specific retry conditions added. This can be disabled via the new `RetryPolicy.furtherRefinementsAllowed(false)`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "531d69de0ada60ba60895d7c04dd73d3c76eeaed", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/531d69de0ada60ba60895d7c04dd73d3c76eeaed", "committedDate": "2020-03-06T23:51:29Z", "message": "Merge branch 'master' into millem/retry-improvements"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2716, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}