{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNTYzODc4", "number": 2004, "title": "Updated endpoint discovery behavior for operations that require endpoint discovery.", "bodyText": "Updated endpoint discovery behavior for operations that require endpoint discovery.\nSpecifically, when endpoint discovery is required:\n\nIf endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\nIf an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\nIntroduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the discovered endpoint.\n\nMotivation:\n\nThe behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\nThis removes the ambiguity as to whether the \"endpoint override\" is the discovery endpoint or the discovered endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the discovered endpoint.", "createdAt": "2020-08-25T23:50:38Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004", "merged": true, "mergeCommit": {"oid": "c2c0e28d72c7d6abfd262f98f87136e6da18a933"}, "closed": true, "closedAt": "2020-08-27T21:03:50Z", "author": {"login": "millems"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCuuuOgBqjM2OTU3MzMxMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDG3ANgFqTQ3NzA3NjMyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe619d788e40d6329e8255faecc7218df10bcbfb", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/fe619d788e40d6329e8255faecc7218df10bcbfb", "committedDate": "2020-08-25T23:53:32Z", "message": "Merge branch 'master' into millem/endpoint-discovery-updates"}, "afterCommit": {"oid": "c7fb1e174c02bd81e1efa67bb1f5fea194f0ee73", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/c7fb1e174c02bd81e1efa67bb1f5fea194f0ee73", "committedDate": "2020-08-26T16:38:00Z", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically:\n1. If endpoint discovery is disabled, throw an exception.\n2. If an endpoint override is specified, throw an exception.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs.\n\nMotivation: The behavior across SDKs is inconsistent, so this brings it more into line for consistency. It also makes it easier to add a \"discoveryEndpointOverride\" in the future to disambiguate the \"endpoint used for execution\" from the \"endpoint used for discovery\" configuration values. Without this change, the SDK would use the endpointOverride as the discovery endpoint."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7fb1e174c02bd81e1efa67bb1f5fea194f0ee73", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/c7fb1e174c02bd81e1efa67bb1f5fea194f0ee73", "committedDate": "2020-08-26T16:38:00Z", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically:\n1. If endpoint discovery is disabled, throw an exception.\n2. If an endpoint override is specified, throw an exception.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs.\n\nMotivation: The behavior across SDKs is inconsistent, so this brings it more into line for consistency. It also makes it easier to add a \"discoveryEndpointOverride\" in the future to disambiguate the \"endpoint used for execution\" from the \"endpoint used for discovery\" configuration values. Without this change, the SDK would use the endpointOverride as the discovery endpoint."}, "afterCommit": {"oid": "eb360c72316717b2697e555ac42fc42603dd8562", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/eb360c72316717b2697e555ac42fc42603dd8562", "committedDate": "2020-08-26T16:52:13Z", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1Nzk1Nzk2", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#pullrequestreview-475795796", "createdAt": "2020-08-26T19:30:00Z", "commit": {"oid": "eb360c72316717b2697e555ac42fc42603dd8562"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTozMDowMFrOHHariA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOTo0NjozOVrOHHbOGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzOTIwOA==", "bodyText": "Is this statement correct? I don't know the existing code around endpoint discovery well; when I read this code, I read it as:\n\"If the model has an endpoint discovery operation AND allowEndpointOverrideForEndpointDiscoveryRequiredOperations is true, then check the ENDPOINT_OVERRIDDEN flag.\"\nI can't see ENDPOINT_DISCOVERY_ENABLED being involved in the logic; is it then correct to say that Endpoint discovery is enabled for this client? Or am I missing something?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477539208", "createdAt": "2020-08-26T19:30:00Z", "author": {"login": "cenedhryn"}, "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/client/SyncClientClass.java", "diffHunk": "@@ -154,6 +162,17 @@ private MethodSpec constructor() {\n                                  EndpointDiscoveryRefreshCache.class,\n                                  poetExtensions.getClientClass(model.getNamingStrategy().getServiceName() +\n                                                                \"EndpointDiscoveryCacheLoader\"));\n+\n+            if (model.getCustomizationConfig().allowEndpointOverrideForEndpointDiscoveryRequiredOperations()) {\n+                builder.beginControlFlow(\"if (clientConfiguration.option(SdkClientOption.ENDPOINT_OVERRIDDEN) == \"\n+                                         + \"Boolean.TRUE)\");\n+                builder.addStatement(\"log.warn(() -> $S)\",\n+                                     \"Endpoint discovery is enabled for this client, and an endpoint override was also \"\n+                                     + \"specified. This will disable endpoint discovery for methods that require it, instead \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb360c72316717b2697e555ac42fc42603dd8562"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0ODA1OA==", "bodyText": "Should the message tell the user about the allowEndpointOverrideForEndpointDiscoveryRequiredOperations flag?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477548058", "createdAt": "2020-08-26T19:46:39Z", "author": {"login": "cenedhryn"}, "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/client/SyncClientClass.java", "diffHunk": "@@ -181,8 +200,37 @@ private MethodSpec constructor() {\n         protocolSpec.errorResponseHandler(opModel).ifPresent(method::addCode);\n \n         if (opModel.getEndpointDiscovery() != null) {\n+            method.addStatement(\"boolean endpointDiscoveryEnabled = \"\n+                                + \"clientConfiguration.option(SdkClientOption.ENDPOINT_DISCOVERY_ENABLED)\");\n+\n+            if (opModel.getEndpointDiscovery().isRequired()) {\n+                method.beginControlFlow(\"if (!endpointDiscoveryEnabled)\");\n+                method.addStatement(\"throw new $T($S)\", IllegalStateException.class,\n+                                    \"This operation requires endpoint discovery, but endpoint discovery was disabled on the \"\n+                                    + \"client.\");\n+                method.endControlFlow();\n+\n+\n+                method.addStatement(\"boolean endpointOverridden = \"\n+                                    + \"clientConfiguration.option(SdkClientOption.ENDPOINT_OVERRIDDEN) == Boolean.TRUE\");\n+                method.beginControlFlow(\"if (endpointOverridden)\");\n+\n+                if (!model.getCustomizationConfig()\n+                          .allowEndpointOverrideForEndpointDiscoveryRequiredOperations()) {\n+                    method.addStatement(\"throw new $T($S)\", IllegalStateException.class,\n+                                        \"This operation requires endpoint discovery, but an endpoint override was specified when \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb360c72316717b2697e555ac42fc42603dd8562"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODY5NTQ1", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#pullrequestreview-475869545", "createdAt": "2020-08-26T21:23:40Z", "commit": {"oid": "eb360c72316717b2697e555ac42fc42603dd8562"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMToyMzo0MFrOHHeP9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMTozODoxMlrOHHeptQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5NzY4NA==", "bodyText": "Got it!", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477597684", "createdAt": "2020-08-26T21:23:40Z", "author": {"login": "cenedhryn"}, "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/client/SyncClientClass.java", "diffHunk": "@@ -181,8 +200,37 @@ private MethodSpec constructor() {\n         protocolSpec.errorResponseHandler(opModel).ifPresent(method::addCode);\n \n         if (opModel.getEndpointDiscovery() != null) {\n+            method.addStatement(\"boolean endpointDiscoveryEnabled = \"\n+                                + \"clientConfiguration.option(SdkClientOption.ENDPOINT_DISCOVERY_ENABLED)\");\n+\n+            if (opModel.getEndpointDiscovery().isRequired()) {\n+                method.beginControlFlow(\"if (!endpointDiscoveryEnabled)\");\n+                method.addStatement(\"throw new $T($S)\", IllegalStateException.class,\n+                                    \"This operation requires endpoint discovery, but endpoint discovery was disabled on the \"\n+                                    + \"client.\");\n+                method.endControlFlow();\n+\n+\n+                method.addStatement(\"boolean endpointOverridden = \"\n+                                    + \"clientConfiguration.option(SdkClientOption.ENDPOINT_OVERRIDDEN) == Boolean.TRUE\");\n+                method.beginControlFlow(\"if (endpointOverridden)\");\n+\n+                if (!model.getCustomizationConfig()\n+                          .allowEndpointOverrideForEndpointDiscoveryRequiredOperations()) {\n+                    method.addStatement(\"throw new $T($S)\", IllegalStateException.class,\n+                                        \"This operation requires endpoint discovery, but an endpoint override was specified when \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0ODA1OA=="}, "originalCommit": {"oid": "eb360c72316717b2697e555ac42fc42603dd8562"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYwNDI3Nw==", "bodyText": "This is complicated, but I'll have another go at the logic.\nThe requirements state that for the values of the three flags (ED Required - ED enabled - Endpoint Overridden), 1. The general behavior when ED Required == TRUE is as follows:\nIf Endpoint Overridden == TRUE, there shall always be an exception\nIf ED enabled == FALSE there will also always be an exception\n2. The customized flag allowEndpointOverrideForEndpointDiscoveryRequiredOperations should change the default behavior so that when Endpoint Overridden == TRUE instead of an exception we'll use the custom endpoint (by disabling the endpoint discovery...)\nHowever, in the code below the Endpoint Overridden logic comes after ED enabled logic, so that if the values are FALSE - TRUE for ED enabled - Endpoint Overridden, we'll throw an exception even though it seems the requirement says we should use custom endpoints for all cases where it's specified (and the flag with the really long name is used).\nIf I understood everything correct, either the requirement is incorrect, or we should switch places of these if statements and give endpoint overridden a higher priority.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#discussion_r477604277", "createdAt": "2020-08-26T21:38:12Z", "author": {"login": "cenedhryn"}, "path": "codegen/src/main/java/software/amazon/awssdk/codegen/poet/client/SyncClientClass.java", "diffHunk": "@@ -181,8 +200,37 @@ private MethodSpec constructor() {\n         protocolSpec.errorResponseHandler(opModel).ifPresent(method::addCode);\n \n         if (opModel.getEndpointDiscovery() != null) {\n+            method.addStatement(\"boolean endpointDiscoveryEnabled = \"\n+                                + \"clientConfiguration.option(SdkClientOption.ENDPOINT_DISCOVERY_ENABLED)\");\n+\n+            if (opModel.getEndpointDiscovery().isRequired()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb360c72316717b2697e555ac42fc42603dd8562"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb360c72316717b2697e555ac42fc42603dd8562", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/eb360c72316717b2697e555ac42fc42603dd8562", "committedDate": "2020-08-26T16:52:13Z", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint."}, "afterCommit": {"oid": "47a001f6030df9c083984df8da9a027e0bef389f", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/47a001f6030df9c083984df8da9a027e0bef389f", "committedDate": "2020-08-27T20:09:25Z", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03f8af7741b3090d2c1abd5f48d2f7e4ba3ec418", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/03f8af7741b3090d2c1abd5f48d2f7e4ba3ec418", "committedDate": "2020-08-27T20:10:38Z", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47a001f6030df9c083984df8da9a027e0bef389f", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/47a001f6030df9c083984df8da9a027e0bef389f", "committedDate": "2020-08-27T20:09:25Z", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint."}, "afterCommit": {"oid": "03f8af7741b3090d2c1abd5f48d2f7e4ba3ec418", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/03f8af7741b3090d2c1abd5f48d2f7e4ba3ec418", "committedDate": "2020-08-27T20:10:38Z", "message": "Updated endpoint discovery behavior for operations that require endpoint discovery.\n\nSpecifically, when endpoint discovery is required:\n1. If endpoint discovery is disabled, throw an exception. Endpoint discovery is required. Disabling it should not be allowed.\n2. If an endpoint override is specified, throw an exception. Endpoint discovery being required implies the endpoint MUST be discovered.\n3. Introduce an \"allowEndpointOverrideForEndpointDiscoveryRequiredOperations\" customization flag that can be used by services that need to disable (2) before we can reach a more long-term state of consistency across the SDKs. This flag will treat the \"endpointOverride\" as the *discovered* endpoint.\n\nMotivation:\n1. The behavior across the SDKs is inconsistent, so this brings the Java SDK more into line with the other SDKs.\n2. This removes the ambiguity as to whether the \"endpoint override\" is the *discovery* endpoint or the *discovered* endpoint by just disallowing its use altogether. In the future we can add a \"discoveryEndpointOverride\" to codify \"endpointOverride\" as being the *discovered* endpoint."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "839576bd2162f6e62526b7fe9fa8e30eb73bac0c", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/839576bd2162f6e62526b7fe9fa8e30eb73bac0c", "committedDate": "2020-08-27T20:11:47Z", "message": "Merge branch 'master' into millem/endpoint-discovery-updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MDc2MzIz", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2004#pullrequestreview-477076323", "createdAt": "2020-08-27T20:58:31Z", "commit": {"oid": "839576bd2162f6e62526b7fe9fa8e30eb73bac0c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2431, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}