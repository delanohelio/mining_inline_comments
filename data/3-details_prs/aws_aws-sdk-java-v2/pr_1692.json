{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDMyMzU2", "number": 1692, "title": "Upgrade Netty version to 4.1.46.Final", "bodyText": "Upgraded Netty version from 4.1.42.Final to 4.1.46.Final and Netty-open-ssl-version to 2.0.29.Final.\nApplied fix to reduce heap memory usage with Netty clients.\nDescription\n\nUpdated the versions in pom file and added the functions with the same name onHeadersRead as existed one to avoid calling wrong function problem.\nMotivation and Context\n\n\nTesting\n\n\n\nScreenshots (if appropriate)\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n I have read the CONTRIBUTING document\n Local run of mvn install succeeds\n My code follows the code style of this project\n My change requires a change to the Javadoc documentation\n I have updated the Javadoc documentation accordingly\n I have read the README document\n I have added tests to cover my changes\n All new and existing tests passed\n A short description of the change has been added to the CHANGELOG\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-03-06T21:37:29Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692", "merged": true, "mergeCommit": {"oid": "a72f494ac1fb22bdef2ebb21367eab99bc58ad8f"}, "closed": true, "closedAt": "2020-03-20T19:54:43Z", "author": {"login": "Quanzzzz"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLHXjvgBqjMxMDY5OTg3MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPlsfpAFqTM3ODc1ODkzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b105c6a7deaedc363834edb017de094dc93924aa", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/b105c6a7deaedc363834edb017de094dc93924aa", "committedDate": "2020-03-06T21:30:26Z", "message": "Upgrade Netty version to 4.1.46.Final"}, "afterCommit": {"oid": "0a416a3743967607e560f74c2e2449fab9bd8003", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/0a416a3743967607e560f74c2e2449fab9bd8003", "committedDate": "2020-03-06T21:53:45Z", "message": "Upgrade Netty version to 4.1.46.Final"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9abdecb4d67e34b81ca3cde14db0a7b132bde41", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a9abdecb4d67e34b81ca3cde14db0a7b132bde41", "committedDate": "2020-03-09T22:24:03Z", "message": "Merge branch 'master' into netty-upgrade"}, "afterCommit": {"oid": "0dae562898b869ef0fafce40f6dc24b2344cef34", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/0dae562898b869ef0fafce40f6dc24b2344cef34", "committedDate": "2020-03-11T02:49:49Z", "message": "Merge branch 'master' into netty-upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyOTQ2MTM0", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#pullrequestreview-372946134", "createdAt": "2020-03-11T16:54:02Z", "commit": {"oid": "0dae562898b869ef0fafce40f6dc24b2344cef34"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNjo1NDowMlrOF0_8Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNjo1NDoyOVrOF0_9Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExNzg4Nw==", "bodyText": "Can we delegate instead of copy+paste?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r391117887", "createdAt": "2020-03-11T16:54:02Z", "author": {"login": "millems"}, "path": "http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java", "diffHunk": "@@ -97,6 +97,21 @@ public void goAwayCanCloseAllStreams() throws InterruptedException {\n \n         CountDownLatch allRequestsReceived = new CountDownLatch(2);\n         Supplier<Http2FrameListener> frameListenerSupplier = () -> new TestFrameListener() {\n+            @Override\n+            public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int padding, boolean endStream) {\n+                serverChannels.add(ctx.channel().id().asShortText());\n+\n+                Http2Headers outboundHeaders = new DefaultHttp2Headers()\n+                    .status(\"200\")\n+                    .add(\"content-type\", \"text/plain\")\n+                    .addInt(\"content-length\", 5);\n+\n+                frameWriter().writeHeaders(ctx, streamId, outboundHeaders, 0, false, ctx.newPromise());\n+                ctx.flush();\n+\n+                allRequestsReceived.countDown();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dae562898b869ef0fafce40f6dc24b2344cef34"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExODAyOQ==", "bodyText": "Can we delegate instead of copy+paste?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r391118029", "createdAt": "2020-03-11T16:54:17Z", "author": {"login": "millems"}, "path": "http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java", "diffHunk": "@@ -146,6 +161,12 @@ public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers\n     public void execute_goAwayReceived_existingChannelsNotReused() throws InterruptedException {\n         // Frame listener supplier for each connection\n         Supplier<Http2FrameListener> frameListenerSupplier = () -> new TestFrameListener() {\n+            @Override\n+            public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int padding, boolean endStream) {\n+                frameWriter().writeHeaders(ctx, streamId, new DefaultHttp2Headers().add(\"content-length\", \"0\").status(\"204\"), 0, true, ctx.newPromise());\n+                ctx.flush();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dae562898b869ef0fafce40f6dc24b2344cef34"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExODE3NQ==", "bodyText": "Can we delegate instead of copy+paste?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r391118175", "createdAt": "2020-03-11T16:54:29Z", "author": {"login": "millems"}, "path": "http-clients/netty-nio-client/src/test/java/software/amazon/awssdk/http/nio/netty/fault/GoAwayTest.java", "diffHunk": "@@ -188,6 +209,27 @@ public void execute_goAwayReceived_lastStreamId_lowerStreamsNotClosed() throws I\n         CountDownLatch allRequestsReceived = new CountDownLatch(2);\n         byte[] getPayload = \"go away!\".getBytes(StandardCharsets.UTF_8);\n         Supplier<Http2FrameListener> frameListenerSupplier = () -> new TestFrameListener() {\n+            @Override\n+            public void onHeadersRead(ChannelHandlerContext ctx, int streamId, Http2Headers headers, int padding, boolean endStream) {\n+                channelToStreams.computeIfAbsent(ctx.channel().id().asShortText(), (k) -> Collections.newSetFromMap(new ConcurrentHashMap<>())).add(streamId);\n+\n+                if (streamId == 3) {\n+                    stream3Received.complete(null);\n+                }\n+\n+                if (streamId < 5) {\n+                    Http2Headers outboundHeaders = new DefaultHttp2Headers()\n+                        .status(\"200\")\n+                        .add(\"content-type\", \"text/plain\")\n+                        .addInt(\"content-length\", getPayload.length);\n+\n+                    frameWriter().writeHeaders(ctx, streamId, outboundHeaders, 0, false, ctx.newPromise());\n+                    ctx.flush();\n+                }\n+\n+                allRequestsReceived.countDown();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dae562898b869ef0fafce40f6dc24b2344cef34"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMTA1OTcx", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#pullrequestreview-373105971", "createdAt": "2020-03-11T20:34:52Z", "commit": {"oid": "358777b16fc015d70ce1966588b3706a246eb878"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "952072fac3195220a9a56b7e160b84acbef3f16d", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/952072fac3195220a9a56b7e160b84acbef3f16d", "committedDate": "2020-03-11T20:38:33Z", "message": "Merge branch 'master' into netty-upgrade"}, "afterCommit": {"oid": "3705a466554d5058fe20ca41460bf46d61572451", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/3705a466554d5058fe20ca41460bf46d61572451", "committedDate": "2020-03-17T17:39:44Z", "message": "Applied similar fix of Coral team to fix high failure problem"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32be517ee9af5fe4d7e6160ca55e31e8a2b12406", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/32be517ee9af5fe4d7e6160ca55e31e8a2b12406", "committedDate": "2020-03-17T18:10:53Z", "message": "Merge branch 'master' into netty-upgrade"}, "afterCommit": {"oid": "8681a2cfe9c206370b9a76a3d12ff17ecc79cb95", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/8681a2cfe9c206370b9a76a3d12ff17ecc79cb95", "committedDate": "2020-03-17T23:09:33Z", "message": "Upgrade Netty version to 4.1.46.Final and applied fix to solve failure problem"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTM1NzQw", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#pullrequestreview-377935740", "createdAt": "2020-03-19T17:22:34Z", "commit": {"oid": "d1f335f8141d2e3d0ac1cd56b859898b55744ecd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzoyMjozNFrOF44wJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzoyNzo0NFrOF4496Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NDQwNg==", "bodyText": "Can we add a comment here to explain why we are setting this?\nProbably something like this:\n// Use unpooled allocator to avoid increased heap memory usage from Netty 4.1.43. See https://github.com/netty/netty/issues/9768", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r395194406", "createdAt": "2020-03-19T17:22:34Z", "author": {"login": "zoewangg"}, "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java", "diffHunk": "@@ -94,6 +96,8 @@ public void channelCreated(Channel ch) {\n \n             pipeline.addLast(sslHandler);\n             pipeline.addLast(SslCloseCompletionEventHandler.getInstance());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1f335f8141d2e3d0ac1cd56b859898b55744ecd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NzkyOQ==", "bodyText": "Should we only set this for JDK SsLProvider since the issue only affects customers using JDK SSL engine?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#discussion_r395197929", "createdAt": "2020-03-19T17:27:44Z", "author": {"login": "zoewangg"}, "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/ChannelPipelineInitializer.java", "diffHunk": "@@ -94,6 +96,8 @@ public void channelCreated(Channel ch) {\n \n             pipeline.addLast(sslHandler);\n             pipeline.addLast(SslCloseCompletionEventHandler.getInstance());\n+\n+            ch.config().setOption(ChannelOption.ALLOCATOR, UnpooledByteBufAllocator.DEFAULT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1f335f8141d2e3d0ac1cd56b859898b55744ecd"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23aa2669a29fa0703dbcb803204b0b00dc94acb7", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/23aa2669a29fa0703dbcb803204b0b00dc94acb7", "committedDate": "2020-03-19T18:35:07Z", "message": "Upgrade Netty version to 4.1.46.Final and applied fix to solve failure problem"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1f335f8141d2e3d0ac1cd56b859898b55744ecd", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d1f335f8141d2e3d0ac1cd56b859898b55744ecd", "committedDate": "2020-03-17T23:57:18Z", "message": "Merge branch 'master' into netty-upgrade"}, "afterCommit": {"oid": "23aa2669a29fa0703dbcb803204b0b00dc94acb7", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/23aa2669a29fa0703dbcb803204b0b00dc94acb7", "committedDate": "2020-03-19T18:35:07Z", "message": "Upgrade Netty version to 4.1.46.Final and applied fix to solve failure problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84f890e61140f8052df029f78c971aa6e998dd21", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/84f890e61140f8052df029f78c971aa6e998dd21", "committedDate": "2020-03-19T18:36:34Z", "message": "Merge branch 'master' into netty-upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d59325e1e7783567b8f066b966a79c910b91b422", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d59325e1e7783567b8f066b966a79c910b91b422", "committedDate": "2020-03-20T17:19:02Z", "message": "Merge branch 'master' into netty-upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc68d60cda0dee356f382ea9c78469de810ed29e", "author": {"user": {"login": "zoewangg", "name": "Zoe Wang"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/dc68d60cda0dee356f382ea9c78469de810ed29e", "committedDate": "2020-03-20T19:13:00Z", "message": "Merge branch 'master' into netty-upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NzU4OTMx", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1692#pullrequestreview-378758931", "createdAt": "2020-03-20T19:30:02Z", "commit": {"oid": "dc68d60cda0dee356f382ea9c78469de810ed29e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2730, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}