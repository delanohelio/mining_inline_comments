{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMTkxNDMy", "number": 2118, "title": "Add support for SSO credentials provider", "bodyText": "Add support for SSO Credentials Provider.\nDescription\n\nIn this pr, a credential provider that exchanges a resolved SSO login token for temporary AWS credentials is added. Besides, several new classes and tests are added to enable this credentials provider.\nMain Updates since the first review:\n\nMerged the SsoCredentialsProvider into part of the ProfileCredentialsProvider so the profile addressing part can be better taken care of;\nSeparate the generation of cached token path and resolution of access token to make it more flexible;\nUpdated all the tests to make them match the current code and achieve better coverage;\n\nBesides the main changes for SSO, there are also some small changes to the code:\n\nCorrected the javadocs of annotation SdkInternalApi to make it more accurate;\nMoved the userHomeDirectorymethod out of ProfileFileLocation and put it in the utils module, thus it can be used by the other modules;\n\nMotivation and Context\n\n\nCurrently, SSO provides customers an interface where customers can copy-paste snippests to set the environment variables to temporary credentials that they generate.\nWhile the interface is good for console access and fine for occasional API use, it is painful for repeated API use as customers have to go back to the SSO page every hour to get new credentials. Allowing customers to use their existing login username and password to fetch temporart AWS credentials without having to go to an external site is a much more seamless experience.\nTesting\n\n\n\nSince this credentials provider include interaction with SSO service and it relies on another SSO login flow, so there isn\u2019t integration tests added here. However, to make sure the functionality is sound, multiple unit tests and functional tests are added.\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n I have read the CONTRIBUTING document\n Local run of mvn install succeeds\n My code follows the code style of this project\n My change requires a change to the Javadoc documentation\n I have updated the Javadoc documentation accordingly\n I have read the README document\n I have added tests to cover my changes\n All new and existing tests passed\n A short description of the change has been added to the CHANGELOG\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-10-26T17:28:41Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118", "merged": true, "mergeCommit": {"oid": "6e68364be32e166fd1c11a55c0e4e4f989375105"}, "closed": true, "closedAt": "2020-11-20T18:20:15Z", "author": {"login": "Quanzzzz"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWZRuCgFqTUxNzA4ODExMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdebh1CgFqTUzNTY3MzEwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDg4MTEx", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#pullrequestreview-517088111", "createdAt": "2020-10-26T19:00:41Z", "commit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTowMDo0MVrOHoeJ9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTowOTo0M1rOHoedtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5OTE1Ng==", "bodyText": "Why tie this to the ProfileFile file instead of having the ProfileCredentialProvider create this class like the other providers?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512199156", "createdAt": "2020-10-26T19:00:41Z", "author": {"login": "abrooksv"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.profiles.ProfileFileSystemSetting;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.SsoCredentialsUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.cache.CachedSupplier;\n+import software.amazon.awssdk.utils.cache.NonBlocking;\n+import software.amazon.awssdk.utils.cache.RefreshResult;\n+\n+/**\n+ * An implementation of {@link AwsCredentialsProvider} that is extended within this package to provide support for periodically\n+ * updating session credentials. The credential provider loads configuration from a {@link ProfileFile}, and use this information\n+ * to generate a cached token directory. With this directory the information a {@link SsoClient} can do a\n+ * {@link SsoClient#getRoleCredentials(Consumer)} call to retrieve the credentials needed.\n+ *\n+ * When credentials get close to expiration, this class will attempt to update them asynchronously using\n+ * {@link SsoCredentialsUtils#getUpdatedCredentials()}. If the credentials end up expiring, this class will block all calls\n+ * to {@link #resolveCredentials()} until the credentials can be updated.\n+ */\n+@SdkPublicApi\n+public final class SsoCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n+\n+    private static final String ASYNC_THREAD_NAME = \"sso-credentials-provider\";\n+\n+    private final RuntimeException loadException;\n+\n+    private final SsoClient ssoClient;\n+    private final Duration staleTime;\n+    private final Duration prefetchTime;\n+\n+    private final CachedSupplier<SsoCredentialsHolder> credentialCache;\n+\n+    /**\n+     * @see #builder()\n+     */\n+    SsoCredentialsProvider(BuilderImpl builder) {\n+        this.ssoClient = Validate.notNull(builder.ssoClient, \"SSO client must not be null.\");\n+\n+        this.staleTime = Optional.ofNullable(builder.staleTime).orElse(DEFAULT_STALE_TIME);\n+        this.prefetchTime = Optional.ofNullable(builder.prefetchTime).orElse(DEFAULT_PREFETCH_TIME);\n+\n+        RuntimeException loadException = null;\n+        CachedSupplier.Builder<SsoCredentialsHolder> cacheBuilder = null;\n+        try {\n+            String profileName = builder.profileName != null ? builder.profileName\n+                                                      : ProfileFileSystemSetting.AWS_PROFILE.getStringValueOrThrow();\n+\n+            ProfileFile profileFile = Optional.ofNullable(builder.profileFile)\n+                                  .orElseGet(builder.defaultProfileFileLoader);\n+\n+            // Load Profile from the profile file\n+            Optional<Profile> profileOptional = profileFile.profile(profileName);\n+            if (!profileOptional.isPresent()) {\n+                throw SdkClientException.create(String.format(\"Profile file contained no credentials for \" +\n+                                                              \"profile '%s' : %s\", profileName, profileFile));\n+            }\n+\n+            // Update SSO Credentials with configurations in profile\n+            cacheBuilder = CachedSupplier.builder(() -> updateSsoCredentials(profileOptional.get()));\n+            if (builder.asyncCredentialUpdateEnabled) {\n+                cacheBuilder.prefetchStrategy(new NonBlocking(ASYNC_THREAD_NAME));\n+            }\n+\n+        } catch (RuntimeException e) {\n+            loadException = e;\n+        }\n+\n+        if (loadException != null) {\n+            this.loadException = loadException;\n+            this.credentialCache = null;\n+        } else {\n+            this.loadException = null;\n+            this.credentialCache = cacheBuilder.build();\n+        }\n+    }\n+\n+    /**\n+     * Update the expiring session SSO credentials by calling SSO. Invoked by {@link CachedSupplier} when the credentials\n+     * are close to expiring.\n+     */\n+    private RefreshResult<SsoCredentialsHolder> updateSsoCredentials(Profile profile) {\n+        SsoCredentialsHolder credentials = new SsoCredentialsHolder(\n+            (AwsSsoCredentials) new SsoCredentialsUtils(profile, ssoClient).getUpdatedCredentials());\n+        Instant acutalTokenExpiration = credentials.getSsoCredentialsExpiration().toInstant();\n+\n+        return RefreshResult.builder(credentials)\n+                            .staleTime(acutalTokenExpiration.minus(staleTime))\n+                            .prefetchTime(acutalTokenExpiration.minus(prefetchTime))\n+                            .build();\n+    }\n+\n+    /**\n+     * The amount of time, relative to session token expiration, that the cached credentials are considered stale and\n+     * should no longer be used. All threads will block until the value is updated.\n+     */\n+    public Duration staleTime() {\n+        return staleTime;\n+    }\n+\n+    /**\n+     * The amount of time, relative to session token expiration, that the cached credentials are considered close to stale\n+     * and should be updated.\n+     */\n+    public Duration prefetchTime() {\n+        return prefetchTime;\n+    }\n+\n+    /**\n+     * Get a builder for creating a custom {@link SsoCredentialsProvider}.\n+     */\n+    public static BuilderImpl builder() {\n+        return new BuilderImpl();\n+    }\n+\n+    @Override\n+    public AwsCredentials resolveCredentials() {\n+        if (loadException != null) {\n+            throw loadException;\n+        }\n+        return credentialCache.get().getSsoCredentials();\n+    }\n+\n+    @Override\n+    public void close() {\n+        credentialCache.close();\n+        ssoClient.close();\n+    }\n+\n+    /**\n+     * A builder for creating a custom {@link SsoCredentialsProvider}.\n+     */\n+    public interface Builder {\n+\n+        /**\n+         * Define the profile file that should be used by this credentials provider. By default, the\n+         * {@link ProfileFile#defaultProfileFile()} is used.\n+         */\n+        Builder profileFile(ProfileFile profileFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIwMDM5Mw==", "bodyText": "Hard coding this instead of allowing users to build a callback to handle expiration seems overly limiting and prevents tools built upon the SDK to be able to use SSO", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512200393", "createdAt": "2020-10-26T19:03:01Z", "author": {"login": "abrooksv"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsUtils.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ACCOUNT_ID;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_REGION;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ROLE_NAME;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_START_URL;\n+import static software.amazon.awssdk.utils.JavaSystemSetting.USER_NAME;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.Instant;\n+import java.util.Map;\n+import javax.xml.bind.DatatypeConverter;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.AwsSsoCredentials;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.internal.SystemSettingUtils;\n+\n+@SdkProtectedApi\n+public final class SsoCredentialsUtils {\n+\n+    private static final String TOKEN_DIRECTORY = \"/Users/\" + SystemSettingUtils.resolveSetting(USER_NAME).get() +\n+                                                  \"/.aws/sso/cache/\";\n+\n+    private Profile profile;\n+    private SsoClient ssoClient;\n+\n+    private String ssoRegion;\n+    private String ssoAccountId;\n+    private String ssoRoleName;\n+    private String ssoStartUrl;\n+\n+    private SsoCredentialsTokenProperties tokenProperties;\n+\n+    public SsoCredentialsUtils(Profile profile, SsoClient ssoClient) {\n+        this.profile = profile;\n+        this.ssoClient = ssoClient;\n+    }\n+\n+    /**\n+     * Validate and resolve the SSO profile. Then load the cached token file to retrieve necessary information for the SSO call.\n+     */\n+    public AwsCredentials getUpdatedCredentials() {\n+        validateAndResolveSsoProfile(profile);\n+\n+        try {\n+            String cachedTokenPath = generateCachedTokenPath(ssoStartUrl);\n+            File cachedTokenFile = new File(cachedTokenPath);\n+\n+            tokenProperties = new ObjectMapper().readValue(cachedTokenFile,\n+                                                           SsoCredentialsTokenProperties.class);\n+            if (tokenExpired(tokenProperties.getExpiresAt())) {\n+                throw ExpiredTokenException.builder().message(\"The SSO session associated with this profile has expired or is\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIwMzI0Mg==", "bodyText": "CLI generates timestamps in the format 2020-10-27T03:07:06UTC, does that lead to errors?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512203242", "createdAt": "2020-10-26T19:08:00Z", "author": {"login": "abrooksv"}, "path": "services/sso/src/test/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProviderTest.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import javax.xml.bind.DatatypeConverter;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.ExpiredTokenException;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.StringInputStream;\n+import software.amazon.awssdk.utils.Validate;\n+\n+public class SsoCredentialsProviderTest {\n+\n+    private static String START_URL = \"https://d-abc123.awsapps.com/start-beta\";\n+\n+    private static String testTokenDirectory;\n+    private SsoCredentialsProvider provider;\n+\n+    @Rule\n+    public final ExpectedException exception = ExpectedException.none();\n+\n+    @BeforeClass\n+    public static void createTestTokenFile() throws Exception {\n+        testTokenDirectory = generateCachedTokenPath(START_URL);\n+        createTestTokenFile(testTokenDirectory, \"2090-01-01T00:00:00Z\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIwNDIxMg==", "bodyText": "Seems dangerous to write test data to a users home dir", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512204212", "createdAt": "2020-10-26T19:09:43Z", "author": {"login": "abrooksv"}, "path": "services/sso/src/test/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProviderTest.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import javax.xml.bind.DatatypeConverter;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.ExpiredTokenException;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.StringInputStream;\n+import software.amazon.awssdk.utils.Validate;\n+\n+public class SsoCredentialsProviderTest {\n+\n+    private static String START_URL = \"https://d-abc123.awsapps.com/start-beta\";\n+\n+    private static String testTokenDirectory;\n+    private SsoCredentialsProvider provider;\n+\n+    @Rule\n+    public final ExpectedException exception = ExpectedException.none();\n+\n+    @BeforeClass\n+    public static void createTestTokenFile() throws Exception {\n+        testTokenDirectory = generateCachedTokenPath(START_URL);\n+        createTestTokenFile(testTokenDirectory, \"2090-01-01T00:00:00Z\");\n+    }\n+\n+    @AfterClass\n+    public static void deleteTestTokenFile() {\n+        deleteTestTokenFile(testTokenDirectory);\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withValidProfileAndToken_getExpectedCredentials() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+\n+        String expectAccessKeyId = \"testAccessKeyId\";\n+        String expectSecretAccessKey = \"testAccessKeyId\";\n+        String expectSessionToken = \"testAccessKeyId\";\n+        RoleCredentials roleCredentials = RoleCredentials.builder()\n+                                                         .accessKeyId(expectAccessKeyId)\n+                                                         .secretAccessKey(expectSecretAccessKey)\n+                                                         .expiration(Long.MAX_VALUE)\n+                                                         .sessionToken(expectSessionToken)\n+                                                         .build();\n+\n+        GetRoleCredentialsResponse expectedResponse = GetRoleCredentialsResponse.builder()\n+                                                                                .roleCredentials(roleCredentials)\n+                                                                                .build();\n+\n+        when(ssoClient.getRoleCredentials(any(GetRoleCredentialsRequest.class))).thenReturn(expectedResponse);\n+\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        AwsSsoCredentials ssoCredentials = (AwsSsoCredentials) provider.resolveCredentials();\n+\n+        assertThat(ssoCredentials.sessionToken()).isEqualTo(expectSessionToken);\n+        assertThat(ssoCredentials.accessKeyId()).isEqualTo(expectAccessKeyId);\n+        assertThat(ssoCredentials.secretAccessKey()).isEqualTo(expectSecretAccessKey);\n+        assertThat(ssoCredentials.expiration()).isEqualTo(Long.MAX_VALUE);\n+\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_NoSuchProfile_throwSdkClientException() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        exception.expect(RuntimeException.class);\n+        exception.expectMessage(\"Profile file contained no credentials for profile 'bar'\");\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"bar\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        provider.resolveCredentials();\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withExpiredTokenFile_throwExpiredTokenException() throws Exception {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String expiredStartUrl = START_URL + \"-expired\";\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + expiredStartUrl + \"\\n\";\n+        String expiredTokenDir = generateCachedTokenPath(expiredStartUrl);\n+        createTestTokenFile(expiredTokenDir, \"2020-01-01T00:00:00Z\");\n+\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+\n+        exception.expect(ExpiredTokenException.class);\n+        exception.expectMessage(\"The SSO session associated with this profile has expired\");\n+\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withWrongStartUrl_throwSdkClientException() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String wrongStartUrl = START_URL + \"-wrong\";\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + wrongStartUrl + \"\\n\";\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+\n+        exception.expect(SdkClientException.class);\n+        exception.expectMessage(\"Unable to read the cached token file.\");\n+\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingAccountId_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_account_id\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingRegion_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_region\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingRoleName_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_role_name\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingStartUrl_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_start_url\");\n+    }\n+\n+    private void missingProfileContentTestHelper(String profileContent, String missingContent) {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        exception.expect(SdkClientException.class);\n+        exception.expectMessage(\"This profile is invalid, \" + missingContent + \" is missing.\");\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    private static void createTestTokenFile(String tokenDirectory, String expiration) throws Exception {\n+        String tokenFileContent = \"{\\n\" +\n+                                  \"\\\"accessToken\\\": \\\"base64string\\\",\\n\" +\n+                                  \"\\\"expiresAt\\\": \\\"\" + expiration + \"\\\",\\n\" +\n+                                  \"\\\"region\\\": \\\"us-west-2\\\",\\n\" +\n+                                  \"\\\"startUrl\\\": \\\"https//d-abc123.awsapps.com/start\\\"\\n\" +\n+                                  \"}\";\n+        try{\n+            File fakeTokenFile = new File(tokenDirectory);\n+            if (fakeTokenFile.createNewFile()) {\n+                FileWriter fileWriter = new FileWriter(fakeTokenFile);\n+                fileWriter.write(tokenFileContent);\n+                fileWriter.close();\n+            }\n+        } catch (IOException e) {\n+            throw new Exception(String.format(\"Creating the test token file failed because of %s\", e));\n+        }\n+\n+    }\n+\n+    private static String generateCachedTokenPath(String startUrl) {\n+        Validate.notNull(startUrl, \"The start url shouldn't be null.\");\n+        byte[] startUrlBytes = startUrl.getBytes(StandardCharsets.UTF_8);\n+        String encodedUrl = new String(startUrlBytes, StandardCharsets.UTF_8);\n+        return \"/Users/\"+System.getProperty(\"user.name\")+\"/.aws/sso/cache/\" +  sha1Hex(encodedUrl) + \".json\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 255}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTAxOTE0", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#pullrequestreview-517101914", "createdAt": "2020-10-26T19:20:24Z", "commit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOToyMDoyNFrOHoe0jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOToyMDoyNFrOHoe0jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIxMDA2Mg==", "bodyText": "Do we not want to treat expiring soon as expired?\nWhen checking to see if a cached token is expired, the SDK MAY treat the token as expired if it will expire within 15 minutes of the expiresAt time", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512210062", "createdAt": "2020-10-26T19:20:24Z", "author": {"login": "abrooksv"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsUtils.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ACCOUNT_ID;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_REGION;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ROLE_NAME;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_START_URL;\n+import static software.amazon.awssdk.utils.JavaSystemSetting.USER_NAME;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.Instant;\n+import java.util.Map;\n+import javax.xml.bind.DatatypeConverter;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.AwsSsoCredentials;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.internal.SystemSettingUtils;\n+\n+@SdkProtectedApi\n+public final class SsoCredentialsUtils {\n+\n+    private static final String TOKEN_DIRECTORY = \"/Users/\" + SystemSettingUtils.resolveSetting(USER_NAME).get() +\n+                                                  \"/.aws/sso/cache/\";\n+\n+    private Profile profile;\n+    private SsoClient ssoClient;\n+\n+    private String ssoRegion;\n+    private String ssoAccountId;\n+    private String ssoRoleName;\n+    private String ssoStartUrl;\n+\n+    private SsoCredentialsTokenProperties tokenProperties;\n+\n+    public SsoCredentialsUtils(Profile profile, SsoClient ssoClient) {\n+        this.profile = profile;\n+        this.ssoClient = ssoClient;\n+    }\n+\n+    /**\n+     * Validate and resolve the SSO profile. Then load the cached token file to retrieve necessary information for the SSO call.\n+     */\n+    public AwsCredentials getUpdatedCredentials() {\n+        validateAndResolveSsoProfile(profile);\n+\n+        try {\n+            String cachedTokenPath = generateCachedTokenPath(ssoStartUrl);\n+            File cachedTokenFile = new File(cachedTokenPath);\n+\n+            tokenProperties = new ObjectMapper().readValue(cachedTokenFile,\n+                                                           SsoCredentialsTokenProperties.class);\n+            if (tokenExpired(tokenProperties.getExpiresAt())) {\n+                throw ExpiredTokenException.builder().message(\"The SSO session associated with this profile has expired or is\"\n+                                                              + \" otherwise invalid. To refresh this SSO session run aws sso\"\n+                                                              + \" login with the corresponding profile.\").build();\n+            }\n+\n+        } catch (IOException e) {\n+            throw SdkClientException.builder().message(\"Unable to read the cached token file. Please check if the correct \"\n+                                                       + \"sso_start_url is configured in the profile\").cause(e).build();\n+        }\n+\n+        return getCredentialsFromSso();\n+    }\n+\n+    private void validateAndResolveSsoProfile(Profile profile) {\n+        Map<String, String> configurations = profile.properties();\n+\n+        if (configurations.containsKey(SSO_ACCOUNT_ID)) {\n+            ssoAccountId = configurations.get(SSO_ACCOUNT_ID);\n+        } else {\n+            throw SdkClientException.create(String.format(\"This profile is invalid, %s is missing.\", SSO_ACCOUNT_ID));\n+        }\n+\n+        if (configurations.containsKey(SSO_REGION)) {\n+            ssoRegion = configurations.get(SSO_REGION);\n+        } else {\n+            throw SdkClientException.create(String.format(\"This profile is invalid, %s is missing.\", SSO_REGION));\n+        }\n+\n+        if (configurations.containsKey(SSO_ROLE_NAME)) {\n+            ssoRoleName = configurations.get(SSO_ROLE_NAME);\n+        } else {\n+            throw SdkClientException.create(String.format(\"This profile is invalid, %s is missing.\", SSO_ROLE_NAME));\n+        }\n+\n+        if (configurations.containsKey(SSO_START_URL)) {\n+            ssoStartUrl = configurations.get(SSO_START_URL);\n+        } else {\n+            throw SdkClientException.create(String.format(\"This profile is invalid, %s is missing.\", SSO_START_URL));\n+        }\n+\n+    }\n+\n+    /**\n+     * Call SSO to retrieve a new {@link AwsSsoCredentials}.\n+     * @return\n+     */\n+    private AwsSsoCredentials getCredentialsFromSso() {\n+        GetRoleCredentialsRequest request = GetRoleCredentialsRequest.builder().accountId(ssoAccountId)\n+                                                                               .roleName(ssoRoleName)\n+                                                                               .accessToken(tokenProperties.getAccessToken())\n+                                                                               .build();\n+        GetRoleCredentialsResponse response = ssoClient.getRoleCredentials(request);\n+        RoleCredentials roleCredentials = response.roleCredentials();\n+        return AwsSsoCredentials.create(roleCredentials.accessKeyId(), roleCredentials.secretAccessKey(),\n+                                        roleCredentials.sessionToken(), roleCredentials.expiration());\n+\n+    }\n+\n+    private boolean tokenExpired(String expiresTime) {\n+        return Instant.now().isAfter(Instant.parse(expiresTime));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 138}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTU3ODE1", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#pullrequestreview-517157815", "createdAt": "2020-10-26T20:40:19Z", "commit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "state": "COMMENTED", "comments": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMDo0MDoxOVrOHohgmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQyMzoyMDozN1rOHol6-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI1NDEwNQ==", "bodyText": "Nit: \"Added support for retrieving SSO credentials: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html\"", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512254105", "createdAt": "2020-10-26T20:40:19Z", "author": {"login": "millems"}, "path": ".changes/next-release/feature-AWSSingleSignon-9e785be.json", "diffHunk": "@@ -0,0 +1,6 @@\n+{\n+    \"category\": \"AWS Single Sign-on\", \n+    \"contributor\": \"\", \n+    \"type\": \"feature\", \n+    \"description\": \"A new SSO credentials provider is now supported, with which customers can now retrieve SSO temporary credentials easilier without copy-paste work every time anymore.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI1NDI0Nw==", "bodyText": "Please document.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512254247", "createdAt": "2020-10-26T20:40:32Z", "author": {"login": "millems"}, "path": "core/profiles/src/main/java/software/amazon/awssdk/profiles/ProfileProperty.java", "diffHunk": "@@ -99,6 +99,14 @@\n      */\n     public static final String RETRY_MODE = \"retry_mode\";\n \n+    public static final String SSO_REGION = \"sso_region\";\n+\n+    public static final String SSO_ROLE_NAME = \"sso_role_name\";\n+\n+    public static final String SSO_ACCOUNT_ID = \"sso_account_id\";\n+\n+    public static final String SSO_START_URL = \"sso_start_url\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI1NDg3Ng==", "bodyText": "Use Instant for specific points in time, not \"long\"", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512254876", "createdAt": "2020-10-26T20:41:49Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/AwsSsoCredentials.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.util.Objects;\n+import software.amazon.awssdk.annotations.Immutable;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.utils.ToString;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * A sprcial type of {@link AwsCredentials} that provides a session token to be used in service authentication. Session\n+ * tokens are typically provided by AWS Single Sign-On Service, and provide temporary access to an AWS service.\n+ */\n+@Immutable\n+@SdkPublicApi\n+public final class AwsSsoCredentials implements AwsCredentials {\n+\n+    private final String accessKeyId;\n+    private final String secretAccessKey;\n+    private final String sessionToken;\n+    private final long expiration;\n+\n+    /**\n+     * Constructs a new SSO credentials object, with the specified AWS access key, AWS secret key, AWS session token\n+     * and expiration time.\n+     *\n+     * @param accessKey The AWS access key, used to identify the user interacting with AWS.\n+     * @param secretKey The AWS secret access key, used to authenticate the user interacting with AWS.\n+     * @param sessionToken The AWS session token, retrieved from an AWS token service, used for authenticating that this user has\n+     * received temporary permission to access some resource.\n+     * @param expiration The expiration time in millis, used to check if this credential has expired.\n+     */\n+    private AwsSsoCredentials(String accessKey, String secretKey, String sessionToken, long expiration) {\n+        this.accessKeyId = Validate.paramNotNull(accessKey, \"accessKey\");\n+        this.secretAccessKey = Validate.paramNotNull(secretKey, \"secretKey\");\n+        this.sessionToken = Validate.paramNotNull(sessionToken, \"sessionToken\");\n+        this.expiration = Validate.paramNotNull(expiration, \"expiration\");\n+    }\n+\n+    public static AwsSsoCredentials create(String accessKey, String secretKey, String sessionToken, long expiration) {\n+        return new AwsSsoCredentials(accessKey, secretKey, sessionToken, expiration);\n+    }\n+\n+    /**\n+     * Retrieve the AWS access key, used to identify the user interacting with AWS.\n+     */\n+    @Override\n+    public String accessKeyId() {\n+        return accessKeyId;\n+    }\n+\n+    /**\n+     * Retrieve the AWS secret access key, used to authenticate the user interacting with AWS.\n+     */\n+    @Override\n+    public String secretAccessKey() {\n+        return secretAccessKey;\n+    }\n+\n+    /**\n+     * Retrieve the AWS session token. This token is retrieved from an AWS token service, and is used for authenticating that this\n+     * user has received temporary permission to access some resource.\n+     */\n+    public String sessionToken() {\n+        return sessionToken;\n+    }\n+\n+    /**\n+     * Retrieve the expiration time. This is the absolute time millis of expiration of this credentials, and is used for\n+     * credentials validation.\n+     */\n+    public long expiration() {\n+        return expiration;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI1NTA1MA==", "bodyText": "Use Instant, not Date", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512255050", "createdAt": "2020-10-26T20:42:05Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsHolder.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.time.Instant;\n+import java.util.Date;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.annotations.ThreadSafe;\n+\n+/**\n+ * Holder class used to atomically store a SSO session credentials with its expiration time.\n+ */\n+@SdkInternalApi\n+@ThreadSafe\n+public class SsoCredentialsHolder {\n+    private final AwsSsoCredentials ssoCredentials;\n+    private final Date ssoCredentialsExpiration;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI1NTU5NQ==", "bodyText": "private?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512255595", "createdAt": "2020-10-26T20:43:08Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.profiles.ProfileFileSystemSetting;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.SsoCredentialsUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.cache.CachedSupplier;\n+import software.amazon.awssdk.utils.cache.NonBlocking;\n+import software.amazon.awssdk.utils.cache.RefreshResult;\n+\n+/**\n+ * An implementation of {@link AwsCredentialsProvider} that is extended within this package to provide support for periodically\n+ * updating session credentials. The credential provider loads configuration from a {@link ProfileFile}, and use this information\n+ * to generate a cached token directory. With this directory the information a {@link SsoClient} can do a\n+ * {@link SsoClient#getRoleCredentials(Consumer)} call to retrieve the credentials needed.\n+ *\n+ * When credentials get close to expiration, this class will attempt to update them asynchronously using\n+ * {@link SsoCredentialsUtils#getUpdatedCredentials()}. If the credentials end up expiring, this class will block all calls\n+ * to {@link #resolveCredentials()} until the credentials can be updated.\n+ */\n+@SdkPublicApi\n+public final class SsoCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n+\n+    private static final String ASYNC_THREAD_NAME = \"sso-credentials-provider\";\n+\n+    private final RuntimeException loadException;\n+\n+    private final SsoClient ssoClient;\n+    private final Duration staleTime;\n+    private final Duration prefetchTime;\n+\n+    private final CachedSupplier<SsoCredentialsHolder> credentialCache;\n+\n+    /**\n+     * @see #builder()\n+     */\n+    SsoCredentialsProvider(BuilderImpl builder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjI1NTg5MQ==", "bodyText": "Can this just be part of the ProfileCredentialsProvider?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512255891", "createdAt": "2020-10-26T20:43:42Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.profiles.ProfileFileSystemSetting;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.SsoCredentialsUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.cache.CachedSupplier;\n+import software.amazon.awssdk.utils.cache.NonBlocking;\n+import software.amazon.awssdk.utils.cache.RefreshResult;\n+\n+/**\n+ * An implementation of {@link AwsCredentialsProvider} that is extended within this package to provide support for periodically\n+ * updating session credentials. The credential provider loads configuration from a {@link ProfileFile}, and use this information\n+ * to generate a cached token directory. With this directory the information a {@link SsoClient} can do a\n+ * {@link SsoClient#getRoleCredentials(Consumer)} call to retrieve the credentials needed.\n+ *\n+ * When credentials get close to expiration, this class will attempt to update them asynchronously using\n+ * {@link SsoCredentialsUtils#getUpdatedCredentials()}. If the credentials end up expiring, this class will block all calls\n+ * to {@link #resolveCredentials()} until the credentials can be updated.\n+ */\n+@SdkPublicApi\n+public final class SsoCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxNTY5OQ==", "bodyText": "Can we just use AwsSessionCredentials?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512315699", "createdAt": "2020-10-26T22:51:03Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/AwsSsoCredentials.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.util.Objects;\n+import software.amazon.awssdk.annotations.Immutable;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.utils.ToString;\n+import software.amazon.awssdk.utils.Validate;\n+\n+/**\n+ * A sprcial type of {@link AwsCredentials} that provides a session token to be used in service authentication. Session\n+ * tokens are typically provided by AWS Single Sign-On Service, and provide temporary access to an AWS service.\n+ */\n+@Immutable\n+@SdkPublicApi\n+public final class AwsSsoCredentials implements AwsCredentials {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxNjA1OA==", "bodyText": "Can we move this to an internal-named package or make it a package-protected class?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512316058", "createdAt": "2020-10-26T22:51:59Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsHolder.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.time.Instant;\n+import java.util.Date;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.annotations.ThreadSafe;\n+\n+/**\n+ * Holder class used to atomically store a SSO session credentials with its expiration time.\n+ */\n+@SdkInternalApi\n+@ThreadSafe\n+public class SsoCredentialsHolder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxNjkzNw==", "bodyText": "Can all profile stuff be pushed to the ProfileCredentialsProvider, and have this class not use anything profile-file related? E.g. see StsAssumeRoleCredentialsProvider + StsProfileCredentialsProviderFactory and their relationship to ProfileCredentialsProvider. We might even be able to reuse ChildProfileCredentialsProviderFactory if we're lucky.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512316937", "createdAt": "2020-10-26T22:54:13Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,303 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.profiles.ProfileFileSystemSetting;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.SsoCredentialsUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.cache.CachedSupplier;\n+import software.amazon.awssdk.utils.cache.NonBlocking;\n+import software.amazon.awssdk.utils.cache.RefreshResult;\n+\n+/**\n+ * An implementation of {@link AwsCredentialsProvider} that is extended within this package to provide support for periodically\n+ * updating session credentials. The credential provider loads configuration from a {@link ProfileFile}, and use this information\n+ * to generate a cached token directory. With this directory the information a {@link SsoClient} can do a\n+ * {@link SsoClient#getRoleCredentials(Consumer)} call to retrieve the credentials needed.\n+ *\n+ * When credentials get close to expiration, this class will attempt to update them asynchronously using\n+ * {@link SsoCredentialsUtils#getUpdatedCredentials()}. If the credentials end up expiring, this class will block all calls\n+ * to {@link #resolveCredentials()} until the credentials can be updated.\n+ */\n+@SdkPublicApi\n+public final class SsoCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n+\n+    private static final String ASYNC_THREAD_NAME = \"sso-credentials-provider\";\n+\n+    private final RuntimeException loadException;\n+\n+    private final SsoClient ssoClient;\n+    private final Duration staleTime;\n+    private final Duration prefetchTime;\n+\n+    private final CachedSupplier<SsoCredentialsHolder> credentialCache;\n+\n+    /**\n+     * @see #builder()\n+     */\n+    SsoCredentialsProvider(BuilderImpl builder) {\n+        this.ssoClient = Validate.notNull(builder.ssoClient, \"SSO client must not be null.\");\n+\n+        this.staleTime = Optional.ofNullable(builder.staleTime).orElse(DEFAULT_STALE_TIME);\n+        this.prefetchTime = Optional.ofNullable(builder.prefetchTime).orElse(DEFAULT_PREFETCH_TIME);\n+\n+        RuntimeException loadException = null;\n+        CachedSupplier.Builder<SsoCredentialsHolder> cacheBuilder = null;\n+        try {\n+            String profileName = builder.profileName != null ? builder.profileName\n+                                                      : ProfileFileSystemSetting.AWS_PROFILE.getStringValueOrThrow();\n+\n+            ProfileFile profileFile = Optional.ofNullable(builder.profileFile)\n+                                  .orElseGet(builder.defaultProfileFileLoader);\n+\n+            // Load Profile from the profile file\n+            Optional<Profile> profileOptional = profileFile.profile(profileName);\n+            if (!profileOptional.isPresent()) {\n+                throw SdkClientException.create(String.format(\"Profile file contained no credentials for \" +\n+                                                              \"profile '%s' : %s\", profileName, profileFile));\n+            }\n+\n+            // Update SSO Credentials with configurations in profile\n+            cacheBuilder = CachedSupplier.builder(() -> updateSsoCredentials(profileOptional.get()));\n+            if (builder.asyncCredentialUpdateEnabled) {\n+                cacheBuilder.prefetchStrategy(new NonBlocking(ASYNC_THREAD_NAME));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxNzg1NQ==", "bodyText": "Protected classes shouldn't be in the internal package. Is this actually protected?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512317855", "createdAt": "2020-10-26T22:56:37Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/ExpiredTokenException.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.core.SdkField;\n+import software.amazon.awssdk.core.SdkPojo;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.services.sso.auth.SsoCredentialsProvider;\n+\n+/**\n+ * <p>\n+ * The SSO session token that was passed is expired or is not valid, Get a new SSO session token from the\n+ * {@link SsoCredentialsProvider} and then retry the request.\n+ * </p>\n+ */\n+@SdkProtectedApi\n+public class ExpiredTokenException extends SdkClientException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxODEwOQ==", "bodyText": "Why protected?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512318109", "createdAt": "2020-10-26T22:57:21Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsTokenProperties.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+\n+/**\n+ * A container for credential properties.\n+ */\n+@SdkProtectedApi\n+public class SsoCredentialsTokenProperties {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxODE4Ng==", "bodyText": "Why protected?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512318186", "createdAt": "2020-10-26T22:57:35Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsUtils.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ACCOUNT_ID;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_REGION;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ROLE_NAME;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_START_URL;\n+import static software.amazon.awssdk.utils.JavaSystemSetting.USER_NAME;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.Instant;\n+import java.util.Map;\n+import javax.xml.bind.DatatypeConverter;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.AwsSsoCredentials;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.internal.SystemSettingUtils;\n+\n+@SdkProtectedApi\n+public final class SsoCredentialsUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxODI1Ng==", "bodyText": "Can we just use JsonNode so that we don't have this whole class?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512318256", "createdAt": "2020-10-26T22:57:49Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsTokenProperties.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+\n+/**\n+ * A container for credential properties.\n+ */\n+@SdkProtectedApi\n+public class SsoCredentialsTokenProperties {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxODgyMQ==", "bodyText": "Who \"gets a new SSO session token and then retry the request\"? Is that an instruction to someone?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512318821", "createdAt": "2020-10-26T22:59:24Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/ExpiredTokenException.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.core.SdkField;\n+import software.amazon.awssdk.core.SdkPojo;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.services.sso.auth.SsoCredentialsProvider;\n+\n+/**\n+ * <p>\n+ * The SSO session token that was passed is expired or is not valid, Get a new SSO session token from the\n+ * {@link SsoCredentialsProvider} and then retry the request.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxOTI0Mg==", "bodyText": "NEVER use ObjectMapper directly! We don't want our libraries to have a hard-dependency on Jackson-databind. Use JacksonUtils.sensitiveJsonNodeOf here: (1) so that we only indirectly depend on Jackson (marginally better), and (2) so that we don't log the user's access token if parsing fails.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512319242", "createdAt": "2020-10-26T23:00:18Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsUtils.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ACCOUNT_ID;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_REGION;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ROLE_NAME;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_START_URL;\n+import static software.amazon.awssdk.utils.JavaSystemSetting.USER_NAME;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.Instant;\n+import java.util.Map;\n+import javax.xml.bind.DatatypeConverter;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.AwsSsoCredentials;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.internal.SystemSettingUtils;\n+\n+@SdkProtectedApi\n+public final class SsoCredentialsUtils {\n+\n+    private static final String TOKEN_DIRECTORY = \"/Users/\" + SystemSettingUtils.resolveSetting(USER_NAME).get() +\n+                                                  \"/.aws/sso/cache/\";\n+\n+    private Profile profile;\n+    private SsoClient ssoClient;\n+\n+    private String ssoRegion;\n+    private String ssoAccountId;\n+    private String ssoRoleName;\n+    private String ssoStartUrl;\n+\n+    private SsoCredentialsTokenProperties tokenProperties;\n+\n+    public SsoCredentialsUtils(Profile profile, SsoClient ssoClient) {\n+        this.profile = profile;\n+        this.ssoClient = ssoClient;\n+    }\n+\n+    /**\n+     * Validate and resolve the SSO profile. Then load the cached token file to retrieve necessary information for the SSO call.\n+     */\n+    public AwsCredentials getUpdatedCredentials() {\n+        validateAndResolveSsoProfile(profile);\n+\n+        try {\n+            String cachedTokenPath = generateCachedTokenPath(ssoStartUrl);\n+            File cachedTokenFile = new File(cachedTokenPath);\n+\n+            tokenProperties = new ObjectMapper().readValue(cachedTokenFile,\n+                                                           SsoCredentialsTokenProperties.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyMTQyNw==", "bodyText": "Is this only valid on Mac? See ProfileFileLocation for the proper way to find the customer's home directory.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512321427", "createdAt": "2020-10-26T23:06:21Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsUtils.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ACCOUNT_ID;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_REGION;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ROLE_NAME;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_START_URL;\n+import static software.amazon.awssdk.utils.JavaSystemSetting.USER_NAME;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.Instant;\n+import java.util.Map;\n+import javax.xml.bind.DatatypeConverter;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.AwsSsoCredentials;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.internal.SystemSettingUtils;\n+\n+@SdkProtectedApi\n+public final class SsoCredentialsUtils {\n+\n+    private static final String TOKEN_DIRECTORY = \"/Users/\" + SystemSettingUtils.resolveSetting(USER_NAME).get() +\n+                                                  \"/.aws/sso/cache/\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNDMyNQ==", "bodyText": "This is a bit DRYer, and makes it only one hash key lookup in configurations instead of two:\nssoAccountId = Validate.notNull(configurations.get(SSO_ACCOUNT_ID), \n                                \"The %s profile is invalid, %s is missing.\", profile.name(), SSO_ACCOUNT_ID);", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512324325", "createdAt": "2020-10-26T23:14:33Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsUtils.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ACCOUNT_ID;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_REGION;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ROLE_NAME;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_START_URL;\n+import static software.amazon.awssdk.utils.JavaSystemSetting.USER_NAME;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.Instant;\n+import java.util.Map;\n+import javax.xml.bind.DatatypeConverter;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.AwsSsoCredentials;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.internal.SystemSettingUtils;\n+\n+@SdkProtectedApi\n+public final class SsoCredentialsUtils {\n+\n+    private static final String TOKEN_DIRECTORY = \"/Users/\" + SystemSettingUtils.resolveSetting(USER_NAME).get() +\n+                                                  \"/.aws/sso/cache/\";\n+\n+    private Profile profile;\n+    private SsoClient ssoClient;\n+\n+    private String ssoRegion;\n+    private String ssoAccountId;\n+    private String ssoRoleName;\n+    private String ssoStartUrl;\n+\n+    private SsoCredentialsTokenProperties tokenProperties;\n+\n+    public SsoCredentialsUtils(Profile profile, SsoClient ssoClient) {\n+        this.profile = profile;\n+        this.ssoClient = ssoClient;\n+    }\n+\n+    /**\n+     * Validate and resolve the SSO profile. Then load the cached token file to retrieve necessary information for the SSO call.\n+     */\n+    public AwsCredentials getUpdatedCredentials() {\n+        validateAndResolveSsoProfile(profile);\n+\n+        try {\n+            String cachedTokenPath = generateCachedTokenPath(ssoStartUrl);\n+            File cachedTokenFile = new File(cachedTokenPath);\n+\n+            tokenProperties = new ObjectMapper().readValue(cachedTokenFile,\n+                                                           SsoCredentialsTokenProperties.class);\n+            if (tokenExpired(tokenProperties.getExpiresAt())) {\n+                throw ExpiredTokenException.builder().message(\"The SSO session associated with this profile has expired or is\"\n+                                                              + \" otherwise invalid. To refresh this SSO session run aws sso\"\n+                                                              + \" login with the corresponding profile.\").build();\n+            }\n+\n+        } catch (IOException e) {\n+            throw SdkClientException.builder().message(\"Unable to read the cached token file. Please check if the correct \"\n+                                                       + \"sso_start_url is configured in the profile\").cause(e).build();\n+        }\n+\n+        return getCredentialsFromSso();\n+    }\n+\n+    private void validateAndResolveSsoProfile(Profile profile) {\n+        Map<String, String> configurations = profile.properties();\n+\n+        if (configurations.containsKey(SSO_ACCOUNT_ID)) {\n+            ssoAccountId = configurations.get(SSO_ACCOUNT_ID);\n+        } else {\n+            throw SdkClientException.create(String.format(\"This profile is invalid, %s is missing.\", SSO_ACCOUNT_ID));\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNDk3Mg==", "bodyText": "These not being final makes me nervous about thread-safety. The first two can easily be made final, but the next 4 only happen when we do getUpdatedCredentials. Is there any way to just do the work of getUpdatedCredentials at initialization and create a new SsoCredentialsUtils (there's probably a better name) whenever we need a refresh?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512324972", "createdAt": "2020-10-26T23:16:22Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsUtils.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ACCOUNT_ID;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_REGION;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ROLE_NAME;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_START_URL;\n+import static software.amazon.awssdk.utils.JavaSystemSetting.USER_NAME;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.Instant;\n+import java.util.Map;\n+import javax.xml.bind.DatatypeConverter;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.AwsSsoCredentials;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.internal.SystemSettingUtils;\n+\n+@SdkProtectedApi\n+public final class SsoCredentialsUtils {\n+\n+    private static final String TOKEN_DIRECTORY = \"/Users/\" + SystemSettingUtils.resolveSetting(USER_NAME).get() +\n+                                                  \"/.aws/sso/cache/\";\n+\n+    private Profile profile;\n+    private SsoClient ssoClient;\n+\n+    private String ssoRegion;\n+    private String ssoAccountId;\n+    private String ssoRoleName;\n+    private String ssoStartUrl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNTUzNg==", "bodyText": "Is this dependency always available?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512325536", "createdAt": "2020-10-26T23:18:02Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsUtils.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ACCOUNT_ID;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_REGION;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ROLE_NAME;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_START_URL;\n+import static software.amazon.awssdk.utils.JavaSystemSetting.USER_NAME;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.Instant;\n+import java.util.Map;\n+import javax.xml.bind.DatatypeConverter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNTYzNw==", "bodyText": "BinaryUtils?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512325637", "createdAt": "2020-10-26T23:18:24Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCredentialsUtils.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ACCOUNT_ID;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_REGION;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_ROLE_NAME;\n+import static software.amazon.awssdk.profiles.ProfileProperty.SSO_START_URL;\n+import static software.amazon.awssdk.utils.JavaSystemSetting.USER_NAME;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import java.time.Instant;\n+import java.util.Map;\n+import javax.xml.bind.DatatypeConverter;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.AwsSsoCredentials;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.Validate;\n+import software.amazon.awssdk.utils.internal.SystemSettingUtils;\n+\n+@SdkProtectedApi\n+public final class SsoCredentialsUtils {\n+\n+    private static final String TOKEN_DIRECTORY = \"/Users/\" + SystemSettingUtils.resolveSetting(USER_NAME).get() +\n+                                                  \"/.aws/sso/cache/\";\n+\n+    private Profile profile;\n+    private SsoClient ssoClient;\n+\n+    private String ssoRegion;\n+    private String ssoAccountId;\n+    private String ssoRoleName;\n+    private String ssoStartUrl;\n+\n+    private SsoCredentialsTokenProperties tokenProperties;\n+\n+    public SsoCredentialsUtils(Profile profile, SsoClient ssoClient) {\n+        this.profile = profile;\n+        this.ssoClient = ssoClient;\n+    }\n+\n+    /**\n+     * Validate and resolve the SSO profile. Then load the cached token file to retrieve necessary information for the SSO call.\n+     */\n+    public AwsCredentials getUpdatedCredentials() {\n+        validateAndResolveSsoProfile(profile);\n+\n+        try {\n+            String cachedTokenPath = generateCachedTokenPath(ssoStartUrl);\n+            File cachedTokenFile = new File(cachedTokenPath);\n+\n+            tokenProperties = new ObjectMapper().readValue(cachedTokenFile,\n+                                                           SsoCredentialsTokenProperties.class);\n+            if (tokenExpired(tokenProperties.getExpiresAt())) {\n+                throw ExpiredTokenException.builder().message(\"The SSO session associated with this profile has expired or is\"\n+                                                              + \" otherwise invalid. To refresh this SSO session run aws sso\"\n+                                                              + \" login with the corresponding profile.\").build();\n+            }\n+\n+        } catch (IOException e) {\n+            throw SdkClientException.builder().message(\"Unable to read the cached token file. Please check if the correct \"\n+                                                       + \"sso_start_url is configured in the profile\").cause(e).build();\n+        }\n+\n+        return getCredentialsFromSso();\n+    }\n+\n+    private void validateAndResolveSsoProfile(Profile profile) {\n+        Map<String, String> configurations = profile.properties();\n+\n+        if (configurations.containsKey(SSO_ACCOUNT_ID)) {\n+            ssoAccountId = configurations.get(SSO_ACCOUNT_ID);\n+        } else {\n+            throw SdkClientException.create(String.format(\"This profile is invalid, %s is missing.\", SSO_ACCOUNT_ID));\n+        }\n+\n+        if (configurations.containsKey(SSO_REGION)) {\n+            ssoRegion = configurations.get(SSO_REGION);\n+        } else {\n+            throw SdkClientException.create(String.format(\"This profile is invalid, %s is missing.\", SSO_REGION));\n+        }\n+\n+        if (configurations.containsKey(SSO_ROLE_NAME)) {\n+            ssoRoleName = configurations.get(SSO_ROLE_NAME);\n+        } else {\n+            throw SdkClientException.create(String.format(\"This profile is invalid, %s is missing.\", SSO_ROLE_NAME));\n+        }\n+\n+        if (configurations.containsKey(SSO_START_URL)) {\n+            ssoStartUrl = configurations.get(SSO_START_URL);\n+        } else {\n+            throw SdkClientException.create(String.format(\"This profile is invalid, %s is missing.\", SSO_START_URL));\n+        }\n+\n+    }\n+\n+    /**\n+     * Call SSO to retrieve a new {@link AwsSsoCredentials}.\n+     * @return\n+     */\n+    private AwsSsoCredentials getCredentialsFromSso() {\n+        GetRoleCredentialsRequest request = GetRoleCredentialsRequest.builder().accountId(ssoAccountId)\n+                                                                               .roleName(ssoRoleName)\n+                                                                               .accessToken(tokenProperties.getAccessToken())\n+                                                                               .build();\n+        GetRoleCredentialsResponse response = ssoClient.getRoleCredentials(request);\n+        RoleCredentials roleCredentials = response.roleCredentials();\n+        return AwsSsoCredentials.create(roleCredentials.accessKeyId(), roleCredentials.secretAccessKey(),\n+                                        roleCredentials.sessionToken(), roleCredentials.expiration());\n+\n+    }\n+\n+    private boolean tokenExpired(String expiresTime) {\n+        return Instant.now().isAfter(Instant.parse(expiresTime));\n+    }\n+\n+    /**\n+     * Generate the cached file name by generating the SHA1 Hex Digest of the UTF-8 encoded start url bytes.\n+     */\n+    private String generateCachedTokenPath(String startUrl) {\n+        Validate.notNull(startUrl, \"The start url shouldn't be null.\");\n+        byte[] startUrlBytes = startUrl.getBytes(StandardCharsets.UTF_8);\n+        String encodedUrl = new String(startUrlBytes, StandardCharsets.UTF_8);\n+        return TOKEN_DIRECTORY +  sha1Hex(encodedUrl) + \".json\";\n+    }\n+\n+    /**\n+     * Use {@link MessageDigest} instance to encrypt the input String.\n+     */\n+    private String sha1Hex(String input) {\n+        MessageDigest md;\n+        try {\n+            md = MessageDigest.getInstance(\"SHA-1\");\n+            md.update(input.getBytes(StandardCharsets.UTF_8));\n+        } catch (NoSuchAlgorithmException e) {\n+            throw SdkClientException.builder().message(\"Unable to use \\\"SHA-1\\\" algorithm.\").cause(e).build();\n+        }\n+\n+        return DatatypeConverter.printHexBinary(md.digest());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNTc4Ng==", "bodyText": "BinaryUtils?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512325786", "createdAt": "2020-10-26T23:18:51Z", "author": {"login": "millems"}, "path": "services/sso/src/test/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProviderTest.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import javax.xml.bind.DatatypeConverter;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.ExpiredTokenException;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.StringInputStream;\n+import software.amazon.awssdk.utils.Validate;\n+\n+public class SsoCredentialsProviderTest {\n+\n+    private static String START_URL = \"https://d-abc123.awsapps.com/start-beta\";\n+\n+    private static String testTokenDirectory;\n+    private SsoCredentialsProvider provider;\n+\n+    @Rule\n+    public final ExpectedException exception = ExpectedException.none();\n+\n+    @BeforeClass\n+    public static void createTestTokenFile() throws Exception {\n+        testTokenDirectory = generateCachedTokenPath(START_URL);\n+        createTestTokenFile(testTokenDirectory, \"2090-01-01T00:00:00Z\");\n+    }\n+\n+    @AfterClass\n+    public static void deleteTestTokenFile() {\n+        deleteTestTokenFile(testTokenDirectory);\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withValidProfileAndToken_getExpectedCredentials() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+\n+        String expectAccessKeyId = \"testAccessKeyId\";\n+        String expectSecretAccessKey = \"testAccessKeyId\";\n+        String expectSessionToken = \"testAccessKeyId\";\n+        RoleCredentials roleCredentials = RoleCredentials.builder()\n+                                                         .accessKeyId(expectAccessKeyId)\n+                                                         .secretAccessKey(expectSecretAccessKey)\n+                                                         .expiration(Long.MAX_VALUE)\n+                                                         .sessionToken(expectSessionToken)\n+                                                         .build();\n+\n+        GetRoleCredentialsResponse expectedResponse = GetRoleCredentialsResponse.builder()\n+                                                                                .roleCredentials(roleCredentials)\n+                                                                                .build();\n+\n+        when(ssoClient.getRoleCredentials(any(GetRoleCredentialsRequest.class))).thenReturn(expectedResponse);\n+\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        AwsSsoCredentials ssoCredentials = (AwsSsoCredentials) provider.resolveCredentials();\n+\n+        assertThat(ssoCredentials.sessionToken()).isEqualTo(expectSessionToken);\n+        assertThat(ssoCredentials.accessKeyId()).isEqualTo(expectAccessKeyId);\n+        assertThat(ssoCredentials.secretAccessKey()).isEqualTo(expectSecretAccessKey);\n+        assertThat(ssoCredentials.expiration()).isEqualTo(Long.MAX_VALUE);\n+\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_NoSuchProfile_throwSdkClientException() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        exception.expect(RuntimeException.class);\n+        exception.expectMessage(\"Profile file contained no credentials for profile 'bar'\");\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"bar\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        provider.resolveCredentials();\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withExpiredTokenFile_throwExpiredTokenException() throws Exception {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String expiredStartUrl = START_URL + \"-expired\";\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + expiredStartUrl + \"\\n\";\n+        String expiredTokenDir = generateCachedTokenPath(expiredStartUrl);\n+        createTestTokenFile(expiredTokenDir, \"2020-01-01T00:00:00Z\");\n+\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+\n+        exception.expect(ExpiredTokenException.class);\n+        exception.expectMessage(\"The SSO session associated with this profile has expired\");\n+\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withWrongStartUrl_throwSdkClientException() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String wrongStartUrl = START_URL + \"-wrong\";\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + wrongStartUrl + \"\\n\";\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+\n+        exception.expect(SdkClientException.class);\n+        exception.expectMessage(\"Unable to read the cached token file.\");\n+\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingAccountId_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_account_id\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingRegion_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_region\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingRoleName_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_role_name\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingStartUrl_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_start_url\");\n+    }\n+\n+    private void missingProfileContentTestHelper(String profileContent, String missingContent) {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        exception.expect(SdkClientException.class);\n+        exception.expectMessage(\"This profile is invalid, \" + missingContent + \" is missing.\");\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    private static void createTestTokenFile(String tokenDirectory, String expiration) throws Exception {\n+        String tokenFileContent = \"{\\n\" +\n+                                  \"\\\"accessToken\\\": \\\"base64string\\\",\\n\" +\n+                                  \"\\\"expiresAt\\\": \\\"\" + expiration + \"\\\",\\n\" +\n+                                  \"\\\"region\\\": \\\"us-west-2\\\",\\n\" +\n+                                  \"\\\"startUrl\\\": \\\"https//d-abc123.awsapps.com/start\\\"\\n\" +\n+                                  \"}\";\n+        try{\n+            File fakeTokenFile = new File(tokenDirectory);\n+            if (fakeTokenFile.createNewFile()) {\n+                FileWriter fileWriter = new FileWriter(fakeTokenFile);\n+                fileWriter.write(tokenFileContent);\n+                fileWriter.close();\n+            }\n+        } catch (IOException e) {\n+            throw new Exception(String.format(\"Creating the test token file failed because of %s\", e));\n+        }\n+\n+    }\n+\n+    private static String generateCachedTokenPath(String startUrl) {\n+        Validate.notNull(startUrl, \"The start url shouldn't be null.\");\n+        byte[] startUrlBytes = startUrl.getBytes(StandardCharsets.UTF_8);\n+        String encodedUrl = new String(startUrlBytes, StandardCharsets.UTF_8);\n+        return \"/Users/\"+System.getProperty(\"user.name\")+\"/.aws/sso/cache/\" +  sha1Hex(encodedUrl) + \".json\";\n+    }\n+\n+    private static String sha1Hex(String input) {\n+        MessageDigest md;\n+        try{\n+            md = MessageDigest.getInstance(\"SHA-1\");\n+            md.update(input.getBytes(StandardCharsets.UTF_8));\n+        } catch (NoSuchAlgorithmException e) {\n+            throw SdkClientException.builder().message(\"Unable to use \\\"SHA-1\\\" algorithm.\").cause(e).build();\n+        }\n+\n+        return DatatypeConverter.printHexBinary(md.digest());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 267}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNjM1Nw==", "bodyText": "It's bad form to reproduce the logic you're testing within your tests (e.g. sha1Hex, generateCachedTokenPath), because you're likely going to write the same bug in both places and defeat the purpose of your tests. Can you just hard-code the values you are expecting here?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512326357", "createdAt": "2020-10-26T23:20:31Z", "author": {"login": "millems"}, "path": "services/sso/src/test/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProviderTest.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import javax.xml.bind.DatatypeConverter;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.ExpiredTokenException;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.StringInputStream;\n+import software.amazon.awssdk.utils.Validate;\n+\n+public class SsoCredentialsProviderTest {\n+\n+    private static String START_URL = \"https://d-abc123.awsapps.com/start-beta\";\n+\n+    private static String testTokenDirectory;\n+    private SsoCredentialsProvider provider;\n+\n+    @Rule\n+    public final ExpectedException exception = ExpectedException.none();\n+\n+    @BeforeClass\n+    public static void createTestTokenFile() throws Exception {\n+        testTokenDirectory = generateCachedTokenPath(START_URL);\n+        createTestTokenFile(testTokenDirectory, \"2090-01-01T00:00:00Z\");\n+    }\n+\n+    @AfterClass\n+    public static void deleteTestTokenFile() {\n+        deleteTestTokenFile(testTokenDirectory);\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withValidProfileAndToken_getExpectedCredentials() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+\n+        String expectAccessKeyId = \"testAccessKeyId\";\n+        String expectSecretAccessKey = \"testAccessKeyId\";\n+        String expectSessionToken = \"testAccessKeyId\";\n+        RoleCredentials roleCredentials = RoleCredentials.builder()\n+                                                         .accessKeyId(expectAccessKeyId)\n+                                                         .secretAccessKey(expectSecretAccessKey)\n+                                                         .expiration(Long.MAX_VALUE)\n+                                                         .sessionToken(expectSessionToken)\n+                                                         .build();\n+\n+        GetRoleCredentialsResponse expectedResponse = GetRoleCredentialsResponse.builder()\n+                                                                                .roleCredentials(roleCredentials)\n+                                                                                .build();\n+\n+        when(ssoClient.getRoleCredentials(any(GetRoleCredentialsRequest.class))).thenReturn(expectedResponse);\n+\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        AwsSsoCredentials ssoCredentials = (AwsSsoCredentials) provider.resolveCredentials();\n+\n+        assertThat(ssoCredentials.sessionToken()).isEqualTo(expectSessionToken);\n+        assertThat(ssoCredentials.accessKeyId()).isEqualTo(expectAccessKeyId);\n+        assertThat(ssoCredentials.secretAccessKey()).isEqualTo(expectSecretAccessKey);\n+        assertThat(ssoCredentials.expiration()).isEqualTo(Long.MAX_VALUE);\n+\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_NoSuchProfile_throwSdkClientException() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        exception.expect(RuntimeException.class);\n+        exception.expectMessage(\"Profile file contained no credentials for profile 'bar'\");\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"bar\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        provider.resolveCredentials();\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withExpiredTokenFile_throwExpiredTokenException() throws Exception {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String expiredStartUrl = START_URL + \"-expired\";\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + expiredStartUrl + \"\\n\";\n+        String expiredTokenDir = generateCachedTokenPath(expiredStartUrl);\n+        createTestTokenFile(expiredTokenDir, \"2020-01-01T00:00:00Z\");\n+\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+\n+        exception.expect(ExpiredTokenException.class);\n+        exception.expectMessage(\"The SSO session associated with this profile has expired\");\n+\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withWrongStartUrl_throwSdkClientException() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String wrongStartUrl = START_URL + \"-wrong\";\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + wrongStartUrl + \"\\n\";\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+\n+        exception.expect(SdkClientException.class);\n+        exception.expectMessage(\"Unable to read the cached token file.\");\n+\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingAccountId_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_account_id\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingRegion_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_region\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingRoleName_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_role_name\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingStartUrl_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_start_url\");\n+    }\n+\n+    private void missingProfileContentTestHelper(String profileContent, String missingContent) {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        exception.expect(SdkClientException.class);\n+        exception.expectMessage(\"This profile is invalid, \" + missingContent + \" is missing.\");\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    private static void createTestTokenFile(String tokenDirectory, String expiration) throws Exception {\n+        String tokenFileContent = \"{\\n\" +\n+                                  \"\\\"accessToken\\\": \\\"base64string\\\",\\n\" +\n+                                  \"\\\"expiresAt\\\": \\\"\" + expiration + \"\\\",\\n\" +\n+                                  \"\\\"region\\\": \\\"us-west-2\\\",\\n\" +\n+                                  \"\\\"startUrl\\\": \\\"https//d-abc123.awsapps.com/start\\\"\\n\" +\n+                                  \"}\";\n+        try{\n+            File fakeTokenFile = new File(tokenDirectory);\n+            if (fakeTokenFile.createNewFile()) {\n+                FileWriter fileWriter = new FileWriter(fakeTokenFile);\n+                fileWriter.write(tokenFileContent);\n+                fileWriter.close();\n+            }\n+        } catch (IOException e) {\n+            throw new Exception(String.format(\"Creating the test token file failed because of %s\", e));\n+        }\n+\n+    }\n+\n+    private static String generateCachedTokenPath(String startUrl) {\n+        Validate.notNull(startUrl, \"The start url shouldn't be null.\");\n+        byte[] startUrlBytes = startUrl.getBytes(StandardCharsets.UTF_8);\n+        String encodedUrl = new String(startUrlBytes, StandardCharsets.UTF_8);\n+        return \"/Users/\"+System.getProperty(\"user.name\")+\"/.aws/sso/cache/\" +  sha1Hex(encodedUrl) + \".json\";\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 256}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyNjM5Mw==", "bodyText": "+1 Look at how we test profile files for a better example.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r512326393", "createdAt": "2020-10-26T23:20:37Z", "author": {"login": "millems"}, "path": "services/sso/src/test/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProviderTest.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+import javax.xml.bind.DatatypeConverter;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.ExpectedException;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.ExpiredTokenException;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsResponse;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.StringInputStream;\n+import software.amazon.awssdk.utils.Validate;\n+\n+public class SsoCredentialsProviderTest {\n+\n+    private static String START_URL = \"https://d-abc123.awsapps.com/start-beta\";\n+\n+    private static String testTokenDirectory;\n+    private SsoCredentialsProvider provider;\n+\n+    @Rule\n+    public final ExpectedException exception = ExpectedException.none();\n+\n+    @BeforeClass\n+    public static void createTestTokenFile() throws Exception {\n+        testTokenDirectory = generateCachedTokenPath(START_URL);\n+        createTestTokenFile(testTokenDirectory, \"2090-01-01T00:00:00Z\");\n+    }\n+\n+    @AfterClass\n+    public static void deleteTestTokenFile() {\n+        deleteTestTokenFile(testTokenDirectory);\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withValidProfileAndToken_getExpectedCredentials() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+\n+        String expectAccessKeyId = \"testAccessKeyId\";\n+        String expectSecretAccessKey = \"testAccessKeyId\";\n+        String expectSessionToken = \"testAccessKeyId\";\n+        RoleCredentials roleCredentials = RoleCredentials.builder()\n+                                                         .accessKeyId(expectAccessKeyId)\n+                                                         .secretAccessKey(expectSecretAccessKey)\n+                                                         .expiration(Long.MAX_VALUE)\n+                                                         .sessionToken(expectSessionToken)\n+                                                         .build();\n+\n+        GetRoleCredentialsResponse expectedResponse = GetRoleCredentialsResponse.builder()\n+                                                                                .roleCredentials(roleCredentials)\n+                                                                                .build();\n+\n+        when(ssoClient.getRoleCredentials(any(GetRoleCredentialsRequest.class))).thenReturn(expectedResponse);\n+\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        AwsSsoCredentials ssoCredentials = (AwsSsoCredentials) provider.resolveCredentials();\n+\n+        assertThat(ssoCredentials.sessionToken()).isEqualTo(expectSessionToken);\n+        assertThat(ssoCredentials.accessKeyId()).isEqualTo(expectAccessKeyId);\n+        assertThat(ssoCredentials.secretAccessKey()).isEqualTo(expectSecretAccessKey);\n+        assertThat(ssoCredentials.expiration()).isEqualTo(Long.MAX_VALUE);\n+\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_NoSuchProfile_throwSdkClientException() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        exception.expect(RuntimeException.class);\n+        exception.expectMessage(\"Profile file contained no credentials for profile 'bar'\");\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"bar\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        provider.resolveCredentials();\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withExpiredTokenFile_throwExpiredTokenException() throws Exception {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String expiredStartUrl = START_URL + \"-expired\";\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + expiredStartUrl + \"\\n\";\n+        String expiredTokenDir = generateCachedTokenPath(expiredStartUrl);\n+        createTestTokenFile(expiredTokenDir, \"2020-01-01T00:00:00Z\");\n+\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+\n+        exception.expect(ExpiredTokenException.class);\n+        exception.expectMessage(\"The SSO session associated with this profile has expired\");\n+\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void retrieveSSOCredentials_withWrongStartUrl_throwSdkClientException() {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        String wrongStartUrl = START_URL + \"-wrong\";\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + wrongStartUrl + \"\\n\";\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+\n+        exception.expect(SdkClientException.class);\n+        exception.expectMessage(\"Unable to read the cached token file.\");\n+\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingAccountId_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_account_id\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingRegion_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_role_name=SampleRole\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_region\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingRoleName_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_start_url=\" + START_URL + \"\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_role_name\");\n+    }\n+\n+    @Test\n+    public void createSSOCredentialsProvider_missingStartUrl_throwSdkClientException() {\n+        String profileContent = \"[profile foo]\\n\" +\n+                                \"sso_account_id=012345678901\\n\" +\n+                                \"sso_region=us-east-1\\n\" +\n+                                \"sso_role_name=SampleRole\\n\";\n+        missingProfileContentTestHelper(profileContent,\"sso_start_url\");\n+    }\n+\n+    private void missingProfileContentTestHelper(String profileContent, String missingContent) {\n+        SsoClient ssoClient = mock(SsoClient.class);\n+        ProfileFile profiles = ProfileFile.builder()\n+                                          .content(new StringInputStream(profileContent))\n+                                          .type(ProfileFile.Type.CONFIGURATION)\n+                                          .build();\n+\n+\n+        provider = SsoCredentialsProvider.builder()\n+                                         .profileFile(profiles)\n+                                         .profileName(\"foo\")\n+                                         .ssoClient(ssoClient)\n+                                         .build();\n+        exception.expect(SdkClientException.class);\n+        exception.expectMessage(\"This profile is invalid, \" + missingContent + \" is missing.\");\n+        provider.resolveCredentials();\n+        provider.close();\n+    }\n+\n+    private static void createTestTokenFile(String tokenDirectory, String expiration) throws Exception {\n+        String tokenFileContent = \"{\\n\" +\n+                                  \"\\\"accessToken\\\": \\\"base64string\\\",\\n\" +\n+                                  \"\\\"expiresAt\\\": \\\"\" + expiration + \"\\\",\\n\" +\n+                                  \"\\\"region\\\": \\\"us-west-2\\\",\\n\" +\n+                                  \"\\\"startUrl\\\": \\\"https//d-abc123.awsapps.com/start\\\"\\n\" +\n+                                  \"}\";\n+        try{\n+            File fakeTokenFile = new File(tokenDirectory);\n+            if (fakeTokenFile.createNewFile()) {\n+                FileWriter fileWriter = new FileWriter(fakeTokenFile);\n+                fileWriter.write(tokenFileContent);\n+                fileWriter.close();\n+            }\n+        } catch (IOException e) {\n+            throw new Exception(String.format(\"Creating the test token file failed because of %s\", e));\n+        }\n+\n+    }\n+\n+    private static String generateCachedTokenPath(String startUrl) {\n+        Validate.notNull(startUrl, \"The start url shouldn't be null.\");\n+        byte[] startUrlBytes = startUrl.getBytes(StandardCharsets.UTF_8);\n+        String encodedUrl = new String(startUrlBytes, StandardCharsets.UTF_8);\n+        return \"/Users/\"+System.getProperty(\"user.name\")+\"/.aws/sso/cache/\" +  sha1Hex(encodedUrl) + \".json\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIwNDIxMg=="}, "originalCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461"}, "originalPosition": 255}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9889d086cfd9fb2d55ccad662f825b68984c6461", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/9889d086cfd9fb2d55ccad662f825b68984c6461", "committedDate": "2020-10-26T17:26:14Z", "message": "Add support for SSO credentials provider"}, "afterCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/187767b2de70685ac65f21ec9c3d9cc0c64d3427", "committedDate": "2020-11-05T00:35:06Z", "message": "Add SSO credentials provider support and related tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NDI3MzEz", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#pullrequestreview-525427313", "createdAt": "2020-11-06T19:18:56Z", "commit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "state": "COMMENTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxOToxODo1NlrOHu6eHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxOTo1ODo1N1rOHu7nhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk1NDUyNA==", "bodyText": "Does this match the rules in the CLI? (After role_arn, before session_token, skip SSO if any of the 4 required fields aren't set, instead of raising an error?)", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518954524", "createdAt": "2020-11-06T19:18:56Z", "author": {"login": "millems"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/credentials/internal/ProfileCredentialsUtils.java", "diffHunk": "@@ -116,6 +119,11 @@ public ProfileCredentialsUtils(Profile profile, Function<String, Optional<Profil\n             }\n         }\n \n+        if (properties.containsKey(ProfileProperty.SSO_ROLE_NAME) || properties.containsKey(ProfileProperty.SSO_ACCOUNT_ID)\n+            || properties.containsKey(ProfileProperty.SSO_REGION) || properties.containsKey(ProfileProperty.SSO_START_URL)) {\n+            return Optional.ofNullable(ssoProfileCredentialsProvider());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk1NTM2Nw==", "bodyText": "You should check with John to see if this line is correct, since he's changing this line for STS.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518955367", "createdAt": "2020-11-06T19:20:43Z", "author": {"login": "millems"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/credentials/internal/ProfileCredentialsUtils.java", "diffHunk": "@@ -262,4 +294,20 @@ private ChildProfileCredentialsProviderFactory stsCredentialsProviderFactory() {\n             throw new IllegalStateException(\"Failed to create the '\" + name + \"' profile credentials provider.\", e);\n         }\n     }\n+\n+    /**\n+     * Load the factory that can be used to create the SSO credentials provider, assuming it is on the classpath.\n+     */\n+    private SsoCredentialsProviderFactory ssoCredentialsProviderFactory() {\n+        try {\n+            Class<?> ssoCredentialsProviderFactory = Class.forName(SSO_PROFILE_CREDENTIALS_PROVIDER_FACTORY, true,\n+                                                                   Thread.currentThread().getContextClassLoader());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk1NzI0MQ==", "bodyText": "Isn't this used by SSO, so it should be protected?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518957241", "createdAt": "2020-11-06T19:24:39Z", "author": {"login": "millems"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/credentials/internal/SsoCredentialsProfileProperties.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.auth.credentials.internal;\n+\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+\n+/**\n+ * A container for SSO credential properties, these properties can be loaded from the profile in default.\n+ */\n+@SdkInternalApi\n+public class SsoCredentialsProfileProperties {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk1OTMzMw==", "bodyText": "Is this still accurate? E.g. with regard loading from a profile file.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518959333", "createdAt": "2020-11-06T19:29:13Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,252 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static software.amazon.awssdk.utils.Validate.notNull;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsSessionCredentials;\n+import software.amazon.awssdk.auth.credentials.SessionCredentialsHolder;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.ExpiredTokenException;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+import software.amazon.awssdk.utils.cache.CachedSupplier;\n+import software.amazon.awssdk.utils.cache.NonBlocking;\n+import software.amazon.awssdk.utils.cache.RefreshResult;\n+\n+/**\n+ * An implementation of {@link AwsCredentialsProvider} that is extended within this package to provide support for periodically\n+ * updating session credentials. The credential provider loads configuration from a {@link ProfileFile}, and use this information\n+ * to generate a cached token directory. With this directory the information a {@link SsoClient} can do a\n+ * {@link SsoClient#getRoleCredentials(Consumer)} call to retrieve the credentials needed.\n+ *\n+ * Currently, the cached token is assumed unexpired, and if it's expired then an {@link ExpiredTokenException} will be thrown. If\n+ * the users want to change the behavior of this, please implement your own cached token resolving logic and override the\n+ * {@link Builder#refreshRequest).\n+ *\n+ * When credentials get close to expiration, this class will attempt to update them asynchronously. If the credentials\n+ * end up expiring, this class will block all calls to {@link #resolveCredentials()} until the credentials can be updated.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2MDkyOA==", "bodyText": "I know it hurts to duplicate this, but I'd vote for copying it to the two places it's needed instead of sharing it, and making it an API we have to maintain backwards-compatibility on.\nMaybe an alternative would be to make AwsSessionCredentials have an optional expiration time? Not sure if that's better or worse...", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518960928", "createdAt": "2020-11-06T19:32:27Z", "author": {"login": "millems"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/credentials/SessionCredentialsHolder.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.auth.credentials;\n+\n+import java.time.Instant;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.annotations.ThreadSafe;\n+\n+/**\n+ * Holder class used to atomically store a session with its expiration time.\n+ */\n+@SdkProtectedApi\n+@ThreadSafe\n+public final class SessionCredentialsHolder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2MjI3NQ==", "bodyText": "Do these need to be public?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518962275", "createdAt": "2020-11-06T19:35:15Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,252 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static software.amazon.awssdk.utils.Validate.notNull;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsSessionCredentials;\n+import software.amazon.awssdk.auth.credentials.SessionCredentialsHolder;\n+import software.amazon.awssdk.profiles.ProfileFile;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.ExpiredTokenException;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+import software.amazon.awssdk.utils.cache.CachedSupplier;\n+import software.amazon.awssdk.utils.cache.NonBlocking;\n+import software.amazon.awssdk.utils.cache.RefreshResult;\n+\n+/**\n+ * An implementation of {@link AwsCredentialsProvider} that is extended within this package to provide support for periodically\n+ * updating session credentials. The credential provider loads configuration from a {@link ProfileFile}, and use this information\n+ * to generate a cached token directory. With this directory the information a {@link SsoClient} can do a\n+ * {@link SsoClient#getRoleCredentials(Consumer)} call to retrieve the credentials needed.\n+ *\n+ * Currently, the cached token is assumed unexpired, and if it's expired then an {@link ExpiredTokenException} will be thrown. If\n+ * the users want to change the behavior of this, please implement your own cached token resolving logic and override the\n+ * {@link Builder#refreshRequest).\n+ *\n+ * When credentials get close to expiration, this class will attempt to update them asynchronously. If the credentials\n+ * end up expiring, this class will block all calls to {@link #resolveCredentials()} until the credentials can be updated.\n+ */\n+@SdkPublicApi\n+public final class SsoCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n+\n+    private static final String ASYNC_THREAD_NAME = \"sso-credentials-provider\";\n+\n+    private final Supplier<GetRoleCredentialsRequest> getRoleCredentialsRequestSupplier;\n+\n+    private final SsoClient ssoClient;\n+    private final Duration staleTime;\n+    private final Duration prefetchTime;\n+\n+    private final CachedSupplier<SessionCredentialsHolder> credentialCache;\n+\n+    /**\n+     * @see #builder()\n+     */\n+    private SsoCredentialsProvider(BuilderImpl builder) {\n+        this.ssoClient = notNull(builder.ssoClient, \"SSO client must not be null.\");\n+        this.getRoleCredentialsRequestSupplier = builder.getRoleCredentialsRequestSupplier;\n+\n+        this.staleTime = Optional.ofNullable(builder.staleTime).orElse(DEFAULT_STALE_TIME);\n+        this.prefetchTime = Optional.ofNullable(builder.prefetchTime).orElse(DEFAULT_PREFETCH_TIME);\n+\n+        CachedSupplier.Builder<SessionCredentialsHolder> cacheBuilder = CachedSupplier.builder(this::updateSsoCredentials);\n+        if (builder.asyncCredentialUpdateEnabled) {\n+            cacheBuilder.prefetchStrategy(new NonBlocking(ASYNC_THREAD_NAME));\n+        }\n+\n+        this.credentialCache = cacheBuilder.build();\n+    }\n+\n+    /**\n+     * Update the expiring session SSO credentials by calling SSO. Invoked by {@link CachedSupplier} when the credentials\n+     * are close to expiring.\n+     */\n+    private RefreshResult<SessionCredentialsHolder> updateSsoCredentials() {\n+        SessionCredentialsHolder credentials = getUpdatedCredentials(ssoClient);\n+        Instant acutalTokenExpiration = credentials.getSessionCredentialsExpiration();\n+\n+        return RefreshResult.builder(credentials)\n+                            .staleTime(acutalTokenExpiration.minus(staleTime))\n+                            .prefetchTime(acutalTokenExpiration.minus(prefetchTime))\n+                            .build();\n+    }\n+\n+    private SessionCredentialsHolder getUpdatedCredentials(SsoClient ssoClient) {\n+        GetRoleCredentialsRequest request = getRoleCredentialsRequestSupplier.get();\n+        notNull(request, \"GetRoleCredentialsRequest can't be null.\");\n+        RoleCredentials roleCredentials = ssoClient.getRoleCredentials(request).roleCredentials();\n+        AwsSessionCredentials sessionCredentials = AwsSessionCredentials.create(roleCredentials.accessKeyId(),\n+                                                                                roleCredentials.secretAccessKey(),\n+                                                                                roleCredentials.sessionToken());\n+        return new SessionCredentialsHolder(sessionCredentials, Instant.ofEpochMilli(roleCredentials.expiration()));\n+    }\n+\n+    /**\n+     * The amount of time, relative to session token expiration, that the cached credentials are considered stale and\n+     * should no longer be used. All threads will block until the value is updated.\n+     */\n+    public Duration staleTime() {\n+        return staleTime;\n+    }\n+\n+    /**\n+     * The amount of time, relative to session token expiration, that the cached credentials are considered close to stale\n+     * and should be updated.\n+     */\n+    public Duration prefetchTime() {\n+        return prefetchTime;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2MzA4NA==", "bodyText": "If customers will see this, it'll have to be a public API. Should we just use a generic SdkClientException, or do you think customers will want to catch this exception specifically and do something about it?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518963084", "createdAt": "2020-11-06T19:36:54Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/ExpiredTokenException.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.core.SdkField;\n+import software.amazon.awssdk.core.SdkPojo;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+\n+/**\n+ * <p>\n+ * The session token that was passed is expired or is not valid.\n+ * </p>\n+ */\n+@SdkInternalApi\n+public class ExpiredTokenException extends SdkClientException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2NDA1MA==", "bodyText": "Is this 15 minute non-grace-period in the SEP?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518964050", "createdAt": "2020-11-06T19:39:08Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoCachedAccessTokenProvider.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static java.time.temporal.ChronoUnit.MINUTES;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.time.Instant;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.core.util.json.JacksonUtils;\n+import software.amazon.awssdk.services.sso.auth.SsoCredentialsProvider;\n+import software.amazon.awssdk.utils.IoUtils;\n+\n+/**\n+ * Resolve the access token from the cached token file. If the token has expired then throw out an exception to ask the users to\n+ * update the token. This provider can also be replaced by any other implementation of resolving the access token. The users can\n+ * resolve the access token in their own way and add it to the {@link SsoCredentialsProvider.Builder#refreshRequest}.\n+ */\n+@SdkInternalApi\n+public final class SsoCachedAccessTokenProvider {\n+\n+    private Path cachedTokenFilePath;\n+\n+    public SsoCachedAccessTokenProvider(Path cachedTokenFilePath) {\n+        this.cachedTokenFilePath = cachedTokenFilePath;\n+    }\n+\n+    public String resolveAccessToken() {\n+        try (InputStream cachedTokenStream = Files.newInputStream(cachedTokenFilePath)) {\n+            return getTokenFromJson(IoUtils.toUtf8String(cachedTokenStream));\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n+    private String getTokenFromJson(String json) {\n+        JsonNode jsonNode = JacksonUtils.sensitiveJsonNodeOf(json);\n+\n+        if (validateToken(jsonNode.get(\"expiresAt\").asText())) {\n+            throw ExpiredTokenException.builder().message(\"The SSO session associated with this profile has expired or is\"\n+                                                          + \" otherwise invalid. To refresh this SSO session run aws sso\"\n+                                                          + \" login with the corresponding profile.\").build();\n+        }\n+\n+        return jsonNode.get(\"accessToken\").asText();\n+    }\n+\n+    private boolean validateToken(String expirationTime) {\n+        return Instant.now().isAfter(Instant.parse(expirationTime).minus(15, MINUTES));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2NjY3Nw==", "bodyText": "I don't actually see this class in this PR. Am I blind?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518966677", "createdAt": "2020-11-06T19:44:53Z", "author": {"login": "millems"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/credentials/internal/ProfileCredentialsUtils.java", "diffHunk": "@@ -49,6 +50,8 @@\n public final class ProfileCredentialsUtils {\n     private static final String STS_PROFILE_CREDENTIALS_PROVIDER_FACTORY =\n         \"software.amazon.awssdk.services.sts.internal.StsProfileCredentialsProviderFactory\";\n+    private static final String SSO_PROFILE_CREDENTIALS_PROVIDER_FACTORY =\n+        \"software.amazon.awssdk.services.sso.internal.SsoCredentialsProviderFactory\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2NzM0NA==", "bodyText": "Is this what's supposed to be in that string I commented on earlier? If so, should this be a protected API, since its constructor is invoked by the auth module?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518967344", "createdAt": "2020-11-06T19:46:25Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoProfileCredentialsProviderFactory.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.services.sso.internal.SsoCachedTokenFileUtils.generateCachedTokenPath;\n+import static software.amazon.awssdk.utils.UserHomeDirectoryUtils.userHomeDirectory;\n+\n+import java.nio.file.Paths;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AnonymousCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.SsoCredentialsProviderFactory;\n+import software.amazon.awssdk.auth.credentials.internal.SsoCredentialsProfileProperties;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.SsoCredentialsProvider;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.utils.IoUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+\n+/**\n+ * An implementation of {@link SsoCredentialsProviderFactory} that allows users to get SSO role credentials using the startUrl\n+ * sprcified in either a {@link Profile} or environment variables.\n+ */\n+@SdkInternalApi\n+public class SsoProfileCredentialsProviderFactory implements SsoCredentialsProviderFactory {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2ODU2OA==", "bodyText": "Nit: can this just use the other create() method?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518968568", "createdAt": "2020-11-06T19:49:06Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoProfileCredentialsProviderFactory.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.services.sso.internal.SsoCachedTokenFileUtils.generateCachedTokenPath;\n+import static software.amazon.awssdk.utils.UserHomeDirectoryUtils.userHomeDirectory;\n+\n+import java.nio.file.Paths;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AnonymousCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.SsoCredentialsProviderFactory;\n+import software.amazon.awssdk.auth.credentials.internal.SsoCredentialsProfileProperties;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.SsoCredentialsProvider;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.utils.IoUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+\n+/**\n+ * An implementation of {@link SsoCredentialsProviderFactory} that allows users to get SSO role credentials using the startUrl\n+ * sprcified in either a {@link Profile} or environment variables.\n+ */\n+@SdkInternalApi\n+public class SsoProfileCredentialsProviderFactory implements SsoCredentialsProviderFactory {\n+\n+    private static final String TOKEN_DIRECTORY = Paths.get(userHomeDirectory(), \".aws\", \"sso\", \"cache\").toString();\n+\n+    private SsoCachedAccessTokenProvider tokenProvider;\n+\n+    /**\n+     * Default method to create the {@link SsoProfileCredentialsProvider} with a {@link SsoCachedAccessTokenProvider}\n+     * object created with the start url from {@link Profile} or environment variables and the default token file directory.\n+     */\n+    public AwsCredentialsProvider create(SsoCredentialsProfileProperties ssoCredentialsProfileProperties) {\n+        this.tokenProvider = new SsoCachedAccessTokenProvider(\n+            generateCachedTokenPath(ssoCredentialsProfileProperties.ssoStartUrl(), TOKEN_DIRECTORY));\n+        return new SsoProfileCredentialsProvider(ssoCredentialsProfileProperties, tokenProvider);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2OTAxMA==", "bodyText": "Is this field needed?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518969010", "createdAt": "2020-11-06T19:50:00Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoProfileCredentialsProviderFactory.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.services.sso.internal.SsoCachedTokenFileUtils.generateCachedTokenPath;\n+import static software.amazon.awssdk.utils.UserHomeDirectoryUtils.userHomeDirectory;\n+\n+import java.nio.file.Paths;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AnonymousCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.SsoCredentialsProviderFactory;\n+import software.amazon.awssdk.auth.credentials.internal.SsoCredentialsProfileProperties;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.SsoCredentialsProvider;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.utils.IoUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+\n+/**\n+ * An implementation of {@link SsoCredentialsProviderFactory} that allows users to get SSO role credentials using the startUrl\n+ * sprcified in either a {@link Profile} or environment variables.\n+ */\n+@SdkInternalApi\n+public class SsoProfileCredentialsProviderFactory implements SsoCredentialsProviderFactory {\n+\n+    private static final String TOKEN_DIRECTORY = Paths.get(userHomeDirectory(), \".aws\", \"sso\", \"cache\").toString();\n+\n+    private SsoCachedAccessTokenProvider tokenProvider;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2OTQxMA==", "bodyText": "Isn't this also a protected API?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518969410", "createdAt": "2020-11-06T19:50:47Z", "author": {"login": "millems"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/credentials/internal/SsoCredentialsProfileProperties.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.auth.credentials.internal;\n+\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+\n+/**\n+ * A container for SSO credential properties, these properties can be loaded from the profile in default.\n+ */\n+@SdkInternalApi\n+public class SsoCredentialsProfileProperties {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk2OTcxOQ==", "bodyText": "Should this be named with \"Profile\" since it's not necessarily related to a profile file? I'd honestly rather just pass a Profile to a ProfileCredentialsProviderFactory instead of a SsoCredentialsProfileProperties to a SsoCredentialsProviderFactory, and not make this specific to SSO. If we had done that for the web identity token file, we wouldn't have to create yet another protected API here.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518969719", "createdAt": "2020-11-06T19:51:28Z", "author": {"login": "millems"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/credentials/internal/SsoCredentialsProfileProperties.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.auth.credentials.internal;\n+\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+\n+/**\n+ * A container for SSO credential properties, these properties can be loaded from the profile in default.\n+ */\n+@SdkInternalApi\n+public class SsoCredentialsProfileProperties {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk3MjIxOQ==", "bodyText": "Unqualified generics. Supplier of what?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518972219", "createdAt": "2020-11-06T19:56:36Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoProfileCredentialsProviderFactory.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.services.sso.internal.SsoCachedTokenFileUtils.generateCachedTokenPath;\n+import static software.amazon.awssdk.utils.UserHomeDirectoryUtils.userHomeDirectory;\n+\n+import java.nio.file.Paths;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AnonymousCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.SsoCredentialsProviderFactory;\n+import software.amazon.awssdk.auth.credentials.internal.SsoCredentialsProfileProperties;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.SsoCredentialsProvider;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.utils.IoUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+\n+/**\n+ * An implementation of {@link SsoCredentialsProviderFactory} that allows users to get SSO role credentials using the startUrl\n+ * sprcified in either a {@link Profile} or environment variables.\n+ */\n+@SdkInternalApi\n+public class SsoProfileCredentialsProviderFactory implements SsoCredentialsProviderFactory {\n+\n+    private static final String TOKEN_DIRECTORY = Paths.get(userHomeDirectory(), \".aws\", \"sso\", \"cache\").toString();\n+\n+    private SsoCachedAccessTokenProvider tokenProvider;\n+\n+    /**\n+     * Default method to create the {@link SsoProfileCredentialsProvider} with a {@link SsoCachedAccessTokenProvider}\n+     * object created with the start url from {@link Profile} or environment variables and the default token file directory.\n+     */\n+    public AwsCredentialsProvider create(SsoCredentialsProfileProperties ssoCredentialsProfileProperties) {\n+        this.tokenProvider = new SsoCachedAccessTokenProvider(\n+            generateCachedTokenPath(ssoCredentialsProfileProperties.ssoStartUrl(), TOKEN_DIRECTORY));\n+        return new SsoProfileCredentialsProvider(ssoCredentialsProfileProperties, tokenProvider);\n+    }\n+\n+    /**\n+     * Alternative method to create the {@link SsoProfileCredentialsProvider} with a customized\n+     * {@link SsoCachedAccessTokenProvider}. This method is only used for testing.\n+     */\n+    @SdkTestInternalApi\n+    public AwsCredentialsProvider create(SsoCredentialsProfileProperties ssoCredentialsProfileProperties,\n+                                         SsoCachedAccessTokenProvider tokenProvider) {\n+        this.tokenProvider = tokenProvider;\n+        return new SsoProfileCredentialsProvider(ssoCredentialsProfileProperties, tokenProvider);\n+    }\n+\n+    /**\n+     * A wrapper for a {@link SsoCredentialsProvider} that is returned by this factory when\n+     * {@link #create(SsoCredentialsProfileProperties)} or\n+     * {@link #create(SsoCredentialsProfileProperties, SsoCachedAccessTokenProvider)} is invoked. This wrapper is important\n+     * because it ensures the parent credentials provider is closed when the sso credentials provider is no longer needed.\n+     */\n+    private static final class SsoProfileCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+        private final SsoClient ssoClient;\n+        private final SsoCredentialsProvider credentialsProvider;\n+\n+        private SsoProfileCredentialsProvider(SsoCredentialsProfileProperties credentialsProperties,\n+                                              SsoCachedAccessTokenProvider provider) {\n+            String ssoAccountId = credentialsProperties.ssoAccountId();\n+            String ssoRoleName = credentialsProperties.ssoRoleName();\n+            String ssoRegion = credentialsProperties.ssoRegion();\n+\n+            this.ssoClient = SsoClient.builder()\n+                                      .credentialsProvider(AnonymousCredentialsProvider.create())\n+                                      .region(Region.of(ssoRegion))\n+                                      .build();\n+\n+            GetRoleCredentialsRequest request = GetRoleCredentialsRequest.builder()\n+                                                                         .accountId(ssoAccountId)\n+                                                                         .roleName(ssoRoleName)\n+                                                                         .build();\n+\n+            GetRoleCredentialsRequestSupplier supplier = new GetRoleCredentialsRequestSupplier(request,\n+                                                                                               provider.resolveAccessToken());\n+\n+            this.credentialsProvider = SsoCredentialsProvider.builder()\n+                                                             .ssoClient(ssoClient)\n+                                                             .refreshRequest(supplier)\n+                                                             .build();\n+        }\n+\n+        @Override\n+        public AwsCredentials resolveCredentials() {\n+            return this.credentialsProvider.resolveCredentials();\n+        }\n+\n+        @Override\n+        public void close() {\n+            IoUtils.closeQuietly(credentialsProvider, null);\n+            IoUtils.closeQuietly(ssoClient, null);\n+        }\n+    }\n+\n+\n+    private static final class GetRoleCredentialsRequestSupplier implements Supplier {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk3MjUzMg==", "bodyText": "This looks constant. Do we need to even use a supplier here? What if the token expires?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518972532", "createdAt": "2020-11-06T19:57:14Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoProfileCredentialsProviderFactory.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.services.sso.internal.SsoCachedTokenFileUtils.generateCachedTokenPath;\n+import static software.amazon.awssdk.utils.UserHomeDirectoryUtils.userHomeDirectory;\n+\n+import java.nio.file.Paths;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AnonymousCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.SsoCredentialsProviderFactory;\n+import software.amazon.awssdk.auth.credentials.internal.SsoCredentialsProfileProperties;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.SsoCredentialsProvider;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.utils.IoUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+\n+/**\n+ * An implementation of {@link SsoCredentialsProviderFactory} that allows users to get SSO role credentials using the startUrl\n+ * sprcified in either a {@link Profile} or environment variables.\n+ */\n+@SdkInternalApi\n+public class SsoProfileCredentialsProviderFactory implements SsoCredentialsProviderFactory {\n+\n+    private static final String TOKEN_DIRECTORY = Paths.get(userHomeDirectory(), \".aws\", \"sso\", \"cache\").toString();\n+\n+    private SsoCachedAccessTokenProvider tokenProvider;\n+\n+    /**\n+     * Default method to create the {@link SsoProfileCredentialsProvider} with a {@link SsoCachedAccessTokenProvider}\n+     * object created with the start url from {@link Profile} or environment variables and the default token file directory.\n+     */\n+    public AwsCredentialsProvider create(SsoCredentialsProfileProperties ssoCredentialsProfileProperties) {\n+        this.tokenProvider = new SsoCachedAccessTokenProvider(\n+            generateCachedTokenPath(ssoCredentialsProfileProperties.ssoStartUrl(), TOKEN_DIRECTORY));\n+        return new SsoProfileCredentialsProvider(ssoCredentialsProfileProperties, tokenProvider);\n+    }\n+\n+    /**\n+     * Alternative method to create the {@link SsoProfileCredentialsProvider} with a customized\n+     * {@link SsoCachedAccessTokenProvider}. This method is only used for testing.\n+     */\n+    @SdkTestInternalApi\n+    public AwsCredentialsProvider create(SsoCredentialsProfileProperties ssoCredentialsProfileProperties,\n+                                         SsoCachedAccessTokenProvider tokenProvider) {\n+        this.tokenProvider = tokenProvider;\n+        return new SsoProfileCredentialsProvider(ssoCredentialsProfileProperties, tokenProvider);\n+    }\n+\n+    /**\n+     * A wrapper for a {@link SsoCredentialsProvider} that is returned by this factory when\n+     * {@link #create(SsoCredentialsProfileProperties)} or\n+     * {@link #create(SsoCredentialsProfileProperties, SsoCachedAccessTokenProvider)} is invoked. This wrapper is important\n+     * because it ensures the parent credentials provider is closed when the sso credentials provider is no longer needed.\n+     */\n+    private static final class SsoProfileCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+        private final SsoClient ssoClient;\n+        private final SsoCredentialsProvider credentialsProvider;\n+\n+        private SsoProfileCredentialsProvider(SsoCredentialsProfileProperties credentialsProperties,\n+                                              SsoCachedAccessTokenProvider provider) {\n+            String ssoAccountId = credentialsProperties.ssoAccountId();\n+            String ssoRoleName = credentialsProperties.ssoRoleName();\n+            String ssoRegion = credentialsProperties.ssoRegion();\n+\n+            this.ssoClient = SsoClient.builder()\n+                                      .credentialsProvider(AnonymousCredentialsProvider.create())\n+                                      .region(Region.of(ssoRegion))\n+                                      .build();\n+\n+            GetRoleCredentialsRequest request = GetRoleCredentialsRequest.builder()\n+                                                                         .accountId(ssoAccountId)\n+                                                                         .roleName(ssoRoleName)\n+                                                                         .build();\n+\n+            GetRoleCredentialsRequestSupplier supplier = new GetRoleCredentialsRequestSupplier(request,\n+                                                                                               provider.resolveAccessToken());\n+\n+            this.credentialsProvider = SsoCredentialsProvider.builder()\n+                                                             .ssoClient(ssoClient)\n+                                                             .refreshRequest(supplier)\n+                                                             .build();\n+        }\n+\n+        @Override\n+        public AwsCredentials resolveCredentials() {\n+            return this.credentialsProvider.resolveCredentials();\n+        }\n+\n+        @Override\n+        public void close() {\n+            IoUtils.closeQuietly(credentialsProvider, null);\n+            IoUtils.closeQuietly(ssoClient, null);\n+        }\n+    }\n+\n+\n+    private static final class GetRoleCredentialsRequestSupplier implements Supplier {\n+        private final GetRoleCredentialsRequest request;\n+        private final String cachedToken;\n+\n+        GetRoleCredentialsRequestSupplier(GetRoleCredentialsRequest request,\n+                                          String cachedToken) {\n+            this.request = request;\n+            this.cachedToken = cachedToken;\n+        }\n+\n+        @Override\n+        public Object get() {\n+            return request.toBuilder().accessToken(cachedToken).build();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk3MzMxOQ==", "bodyText": "Don't we already have this elsewhere?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r518973319", "createdAt": "2020-11-06T19:58:57Z", "author": {"login": "millems"}, "path": "utils/src/test/java/software/amazon/awssdk/testutils/EnvironmentVariableHelper.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.testutils;\n+\n+import java.lang.reflect.Field;\n+import java.security.AccessController;\n+import java.security.PrivilegedActionException;\n+import java.security.PrivilegedExceptionAction;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import org.junit.rules.ExternalResource;\n+import software.amazon.awssdk.utils.SystemSetting;\n+\n+/**\n+ * A utility that can temporarily forcibly set environment variables and\n+ * then allows resetting them to the original values.\n+ */\n+public class EnvironmentVariableHelper extends ExternalResource {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTE1NzIy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#pullrequestreview-525515722", "createdAt": "2020-11-06T21:48:13Z", "commit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMTo0ODoxM1rOHu-l_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQyMTo0ODoxM1rOHu-l_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTAyMjA3Ng==", "bodyText": "nit: you could probably move this down since it's not used if HOME is set.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r519022076", "createdAt": "2020-11-06T21:48:13Z", "author": {"login": "kiiadi"}, "path": "utils/src/main/java/software/amazon/awssdk/utils/UserHomeDirectoryUtils.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.utils;\n+\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+\n+/**\n+ * Load the home directory that should be used for the stored file. This will check the same environment variables as the CLI\n+ * to identify the location of home, before falling back to java-specific resolution.\n+ */\n+@SdkProtectedApi\n+public final class UserHomeDirectoryUtils {\n+\n+    private UserHomeDirectoryUtils() {\n+\n+    }\n+\n+    public static String userHomeDirectory() {\n+        boolean isWindows = JavaSystemSetting.OS_NAME.getStringValue()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTc1ODQ4", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#pullrequestreview-527575848", "createdAt": "2020-11-10T20:20:18Z", "commit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDoyMDoxOFrOHwuJEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDoyMDoxOFrOHwuJEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg0OTY4MA==", "bodyText": "Can we rename SsoCachedAccessTokenProvider to SsoAccessTokenProvider? The fact that it works on a cache seems like an implementation detail.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r520849680", "createdAt": "2020-11-10T20:20:18Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SsoProfileCredentialsProviderFactory.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import static software.amazon.awssdk.services.sso.internal.SsoCachedTokenFileUtils.generateCachedTokenPath;\n+import static software.amazon.awssdk.utils.UserHomeDirectoryUtils.userHomeDirectory;\n+\n+import java.nio.file.Paths;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AnonymousCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.SsoCredentialsProviderFactory;\n+import software.amazon.awssdk.auth.credentials.internal.SsoCredentialsProfileProperties;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.auth.SsoCredentialsProvider;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.utils.IoUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+\n+/**\n+ * An implementation of {@link SsoCredentialsProviderFactory} that allows users to get SSO role credentials using the startUrl\n+ * sprcified in either a {@link Profile} or environment variables.\n+ */\n+@SdkInternalApi\n+public class SsoProfileCredentialsProviderFactory implements SsoCredentialsProviderFactory {\n+\n+    private static final String TOKEN_DIRECTORY = Paths.get(userHomeDirectory(), \".aws\", \"sso\", \"cache\").toString();\n+\n+    private SsoCachedAccessTokenProvider tokenProvider;\n+\n+    /**\n+     * Default method to create the {@link SsoProfileCredentialsProvider} with a {@link SsoCachedAccessTokenProvider}\n+     * object created with the start url from {@link Profile} or environment variables and the default token file directory.\n+     */\n+    public AwsCredentialsProvider create(SsoCredentialsProfileProperties ssoCredentialsProfileProperties) {\n+        this.tokenProvider = new SsoCachedAccessTokenProvider(\n+            generateCachedTokenPath(ssoCredentialsProfileProperties.ssoStartUrl(), TOKEN_DIRECTORY));\n+        return new SsoProfileCredentialsProvider(ssoCredentialsProfileProperties, tokenProvider);\n+    }\n+\n+    /**\n+     * Alternative method to create the {@link SsoProfileCredentialsProvider} with a customized\n+     * {@link SsoCachedAccessTokenProvider}. This method is only used for testing.\n+     */\n+    @SdkTestInternalApi\n+    public AwsCredentialsProvider create(SsoCredentialsProfileProperties ssoCredentialsProfileProperties,\n+                                         SsoCachedAccessTokenProvider tokenProvider) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "187767b2de70685ac65f21ec9c3d9cc0c64d3427", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/187767b2de70685ac65f21ec9c3d9cc0c64d3427", "committedDate": "2020-11-05T00:35:06Z", "message": "Add SSO credentials provider support and related tests."}, "afterCommit": {"oid": "7734c58fcfe7e7a7b353f3d65eafa0afbee2725d", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7734c58fcfe7e7a7b353f3d65eafa0afbee2725d", "committedDate": "2020-11-18T23:27:22Z", "message": "Add SSO credentials provider support and related tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7734c58fcfe7e7a7b353f3d65eafa0afbee2725d", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7734c58fcfe7e7a7b353f3d65eafa0afbee2725d", "committedDate": "2020-11-18T23:27:22Z", "message": "Add SSO credentials provider support and related tests."}, "afterCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7fa7dba9ff1da04a48013721d69eeec158018e88", "committedDate": "2020-11-18T23:41:08Z", "message": "Add SSO credentials provider support and related tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0Nzg1NTcz", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#pullrequestreview-534785573", "createdAt": "2020-11-19T19:36:21Z", "commit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOTozNjoyMVrOH2uj3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOTo0NjozNVrOH2u7Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0Nzk5Ng==", "bodyText": "Why is this protected?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r527147996", "createdAt": "2020-11-19T19:36:21Z", "author": {"login": "millems"}, "path": "core/auth/src/main/java/software/amazon/awssdk/auth/credentials/internal/ProfileCredentialsUtils.java", "diffHunk": "@@ -46,10 +47,12 @@\n /**\n  * Utility class to load {@link #credentialsProvider()} configured in a profile.\n  */\n-@SdkInternalApi\n+@SdkProtectedApi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE0OTgzMQ==", "bodyText": "Can we override build() to return ExpiredTokenException? Customers might want to get hold of an actual instance of ExpiredTokenException, and without the different build return type they'd need to cast,", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r527149831", "createdAt": "2020-11-19T19:39:39Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/ExpiredTokenException.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.core.SdkField;\n+import software.amazon.awssdk.core.SdkPojo;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+\n+/**\n+ * <p>\n+ * The session token that was passed is expired or is not valid.\n+ * </p>\n+ */\n+@SdkPublicApi\n+public class ExpiredTokenException extends SdkClientException {\n+\n+    private static final List<SdkField<?>> SDK_FIELDS = Collections.unmodifiableList(Arrays.asList());\n+\n+    private ExpiredTokenException(Builder b) {\n+        super(b);\n+    }\n+\n+    @Override\n+    public Builder toBuilder() {\n+        return new BuilderImpl(this);\n+    }\n+\n+    public static Builder builder() {\n+        return new BuilderImpl();\n+    }\n+\n+    public interface Builder extends SdkPojo, SdkClientException.Builder {\n+        @Override\n+        Builder message(String message);\n+\n+        @Override\n+        Builder cause(Throwable cause);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE1MjgwNg==", "bodyText": "You could simplify this to\nSupplier<GetRoleCredentialsRequest> supplier = () -> request.toBuilder().accessToken(tokenProvider.resolveAccessToken()).build();\n\n(or even use the copy() method instead of toBuilder() and build() if you're feeling extra frisky).", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r527152806", "createdAt": "2020-11-19T19:44:38Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoProfileCredentialsProviderFactory.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static software.amazon.awssdk.services.sso.internal.SsoTokenFileUtils.generateCachedTokenPath;\n+import static software.amazon.awssdk.utils.UserHomeDirectoryUtils.userHomeDirectory;\n+\n+import java.nio.file.Paths;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkProtectedApi;\n+import software.amazon.awssdk.annotations.SdkTestInternalApi;\n+import software.amazon.awssdk.auth.credentials.AnonymousCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.ProfileCredentialsProviderFactory;\n+import software.amazon.awssdk.profiles.Profile;\n+import software.amazon.awssdk.profiles.ProfileProperty;\n+import software.amazon.awssdk.regions.Region;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.SsoAccessTokenProvider;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.utils.IoUtils;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+\n+/**\n+ * An implementation of {@link ProfileCredentialsProviderFactory} that allows users to get SSO role credentials using the startUrl\n+ * specified in either a {@link Profile} or environment variables.\n+ */\n+@SdkProtectedApi\n+public class SsoProfileCredentialsProviderFactory implements ProfileCredentialsProviderFactory {\n+\n+    private static final String TOKEN_DIRECTORY = Paths.get(userHomeDirectory(), \".aws\", \"sso\", \"cache\").toString();\n+\n+    /**\n+     * Default method to create the {@link SsoProfileCredentialsProvider} with a {@link SsoAccessTokenProvider}\n+     * object created with the start url from {@link Profile} or environment variables and the default token file directory.\n+     */\n+    public AwsCredentialsProvider create(Profile profile) {\n+        return create(profile, new SsoAccessTokenProvider(\n+            generateCachedTokenPath(profile.properties().get(ProfileProperty.SSO_START_URL), TOKEN_DIRECTORY)));\n+    }\n+\n+    /**\n+     * Alternative method to create the {@link SsoProfileCredentialsProvider} with a customized\n+     * {@link SsoAccessTokenProvider}. This method is only used for testing.\n+     */\n+    @SdkTestInternalApi\n+    public AwsCredentialsProvider create(Profile profile,\n+                                         SsoAccessTokenProvider tokenProvider) {\n+        return new SsoProfileCredentialsProvider(profile, tokenProvider);\n+    }\n+\n+    /**\n+     * A wrapper for a {@link SsoCredentialsProvider} that is returned by this factory when {@link #create(Profile)} or\n+     * {@link #create(Profile, SsoAccessTokenProvider)} is invoked. This wrapper is important because it ensures the parent\n+     * credentials provider is closed when the sso credentials provider is no longer needed.\n+     */\n+    private static final class SsoProfileCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+        private final SsoClient ssoClient;\n+        private final SsoCredentialsProvider credentialsProvider;\n+\n+        private SsoProfileCredentialsProvider(Profile profile,\n+                                              SsoAccessTokenProvider provider) {\n+            String ssoAccountId = profile.properties().get(ProfileProperty.SSO_ACCOUNT_ID);\n+            String ssoRoleName = profile.properties().get(ProfileProperty.SSO_ROLE_NAME);\n+            String ssoRegion = profile.properties().get(ProfileProperty.SSO_REGION);\n+\n+            this.ssoClient = SsoClient.builder()\n+                                      .credentialsProvider(AnonymousCredentialsProvider.create())\n+                                      .region(Region.of(ssoRegion))\n+                                      .build();\n+\n+            GetRoleCredentialsRequest request = GetRoleCredentialsRequest.builder()\n+                                                                         .accountId(ssoAccountId)\n+                                                                         .roleName(ssoRoleName)\n+                                                                         .build();\n+\n+            GetRoleCredentialsRequestSupplier supplier = new GetRoleCredentialsRequestSupplier(request,\n+                                                                                               provider);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE1Mzk2Nw==", "bodyText": "It looks like the directory name is software.amazon.awssdk.services.sso instead of having a chain of parent directories: software/amazon/awssdk/services/sso. Is that just github being weird, or is that accurate?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r527153967", "createdAt": "2020-11-19T19:46:35Z", "author": {"login": "millems"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,250 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0Nzk4MTkz", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#pullrequestreview-534798193", "createdAt": "2020-11-19T19:53:31Z", "commit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOTo1MzozMVrOH2vLFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDo0NDowOFrOH2w4Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE1ODAzOA==", "bodyText": "private?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r527158038", "createdAt": "2020-11-19T19:53:31Z", "author": {"login": "zoewangg"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,250 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static software.amazon.awssdk.utils.Validate.notNull;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsSessionCredentials;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.SessionCredentialsHolder;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+import software.amazon.awssdk.utils.cache.CachedSupplier;\n+import software.amazon.awssdk.utils.cache.NonBlocking;\n+import software.amazon.awssdk.utils.cache.RefreshResult;\n+\n+/**\n+ * An implementation of {@link AwsCredentialsProvider} that is extended within this package to provide support for periodically\n+ * updating session credentials. This credential provider maintains a {@link Supplier<GetRoleCredentialsRequest>} for a\n+ * {@link SsoClient#getRoleCredentials(Consumer)} call to retrieve the credentials needed.\n+ *\n+ * While creating the {@link GetRoleCredentialsRequest}, an access token is needed to be resolved from a token file.\n+ * In default, the token is assumed unexpired, and if it's expired then an {@link ExpiredTokenException} will be thrown.\n+ * If the users want to change the behavior of this, please implement your own token resolving logic and override the\n+ * {@link Builder#refreshRequest).\n+ *\n+ * When credentials get close to expiration, this class will attempt to update them asynchronously. If the credentials\n+ * end up expiring, this class will block all calls to {@link #resolveCredentials()} until the credentials can be updated.\n+ */\n+@SdkPublicApi\n+public final class SsoCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n+\n+    private static final String ASYNC_THREAD_NAME = \"sso-credentials-provider\";\n+\n+    private final Supplier<GetRoleCredentialsRequest> getRoleCredentialsRequestSupplier;\n+\n+    private final SsoClient ssoClient;\n+    private final Duration staleTime;\n+    private final Duration prefetchTime;\n+\n+    private final CachedSupplier<SessionCredentialsHolder> credentialCache;\n+\n+    /**\n+     * @see #builder()\n+     */\n+    private SsoCredentialsProvider(BuilderImpl builder) {\n+        this.ssoClient = notNull(builder.ssoClient, \"SSO client must not be null.\");\n+        this.getRoleCredentialsRequestSupplier = builder.getRoleCredentialsRequestSupplier;\n+\n+        this.staleTime = Optional.ofNullable(builder.staleTime).orElse(DEFAULT_STALE_TIME);\n+        this.prefetchTime = Optional.ofNullable(builder.prefetchTime).orElse(DEFAULT_PREFETCH_TIME);\n+\n+        CachedSupplier.Builder<SessionCredentialsHolder> cacheBuilder = CachedSupplier.builder(this::updateSsoCredentials);\n+        if (builder.asyncCredentialUpdateEnabled) {\n+            cacheBuilder.prefetchStrategy(new NonBlocking(ASYNC_THREAD_NAME));\n+        }\n+\n+        this.credentialCache = cacheBuilder.build();\n+    }\n+\n+    /**\n+     * Update the expiring session SSO credentials by calling SSO. Invoked by {@link CachedSupplier} when the credentials\n+     * are close to expiring.\n+     */\n+    private RefreshResult<SessionCredentialsHolder> updateSsoCredentials() {\n+        SessionCredentialsHolder credentials = getUpdatedCredentials(ssoClient);\n+        Instant acutalTokenExpiration = credentials.getSessionCredentialsExpiration();\n+\n+        return RefreshResult.builder(credentials)\n+                            .staleTime(acutalTokenExpiration.minus(staleTime))\n+                            .prefetchTime(acutalTokenExpiration.minus(prefetchTime))\n+                            .build();\n+    }\n+\n+    private SessionCredentialsHolder getUpdatedCredentials(SsoClient ssoClient) {\n+        GetRoleCredentialsRequest request = getRoleCredentialsRequestSupplier.get();\n+        notNull(request, \"GetRoleCredentialsRequest can't be null.\");\n+        RoleCredentials roleCredentials = ssoClient.getRoleCredentials(request).roleCredentials();\n+        AwsSessionCredentials sessionCredentials = AwsSessionCredentials.create(roleCredentials.accessKeyId(),\n+                                                                                roleCredentials.secretAccessKey(),\n+                                                                                roleCredentials.sessionToken());\n+        return new SessionCredentialsHolder(sessionCredentials, Instant.ofEpochMilli(roleCredentials.expiration()));\n+    }\n+\n+    /**\n+     * The amount of time, relative to session token expiration, that the cached credentials are considered stale and\n+     * should no longer be used. All threads will block until the value is updated.\n+     */\n+    public Duration staleTime() {\n+        return staleTime;\n+    }\n+\n+    /**\n+     * The amount of time, relative to session token expiration, that the cached credentials are considered close to stale\n+     * and should be updated.\n+     */\n+    public Duration prefetchTime() {\n+        return prefetchTime;\n+    }\n+\n+    /**\n+     * Get a builder for creating a custom {@link SsoCredentialsProvider}.\n+     */\n+    public static BuilderImpl builder() {\n+        return new BuilderImpl();\n+    }\n+\n+    @Override\n+    public AwsCredentials resolveCredentials() {\n+        return credentialCache.get().getSessionCredentials();\n+    }\n+\n+    @Override\n+    public void close() {\n+        credentialCache.close();\n+    }\n+\n+    /**\n+     * A builder for creating a custom {@link SsoCredentialsProvider}.\n+     */\n+    public interface Builder {\n+\n+        /**\n+         * Configure the {@link SsoClient} to use when calling SSO to update the session. This client should not be shut\n+         * down as long as this credentials provider is in use.\n+         */\n+        Builder ssoClient(SsoClient ssoclient);\n+\n+        /**\n+         * Configure whether the provider should fetch credentials asynchronously in the background. If this is true,\n+         * threads are less likely to block when credentials are loaded, but addtiional resources are used to maintian\n+         * the provider.\n+         *\n+         * <p>By default, this is disabled.</p>\n+         */\n+        Builder asyncCredentialUpdateEnabled(Boolean asyncCredentialUpdateEnabled);\n+\n+        /**\n+         * Configure the amount of time, relative to SSO session token expiration, that the cached credentials are considered\n+         * stale and should no longer be used. All threads will block until the value is updated.\n+         *\n+         * <p>By default, this is 1 minute.</p>\n+         */\n+        Builder staleTime(Duration staleTime);\n+\n+        /**\n+         * Configure the amount of time, relative to SSO session token expiration, that the cached credentials are considered\n+         * close to stale and should be updated. See {@link #asyncCredentialUpdateEnabled}.\n+         *\n+         * <p>By default, this is 5 minutes.</p>\n+         */\n+        Builder prefetchTime(Duration prefetchTime);\n+\n+        /**\n+         * Configure the {@link GetRoleCredentialsRequest} that should be periodically sent to the SSO service to update the\n+         * credentials.\n+         */\n+        Builder refreshRequest(GetRoleCredentialsRequest getRoleCredentialsRequest);\n+\n+        /**\n+         * Similar to {@link #refreshRequest(GetRoleCredentialsRequest)}, but takes a {@link Supplier} to supply the request to\n+         * SSO.\n+         */\n+        Builder refreshRequest(Supplier<GetRoleCredentialsRequest> getRoleCredentialsRequestSupplier);\n+\n+        /**\n+         * Create a {@link SsoCredentialsProvider} using the configuration applied to this builder.\n+         * @return\n+         */\n+        SsoCredentialsProvider build();\n+\n+    }\n+\n+    public static final class BuilderImpl implements Builder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE1OTQ1OA==", "bodyText": "minor: can we change the getters to fluent style? getSessionCredentials -> sessionCredentials", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r527159458", "createdAt": "2020-11-19T19:55:51Z", "author": {"login": "zoewangg"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/internal/SessionCredentialsHolder.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.internal;\n+\n+import java.time.Instant;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.annotations.ThreadSafe;\n+import software.amazon.awssdk.auth.credentials.AwsSessionCredentials;\n+\n+/**\n+ * Holder class used to atomically store a session with its expiration time.\n+ */\n+@SdkInternalApi\n+@ThreadSafe\n+public final class SessionCredentialsHolder {\n+\n+    private final AwsSessionCredentials sessionCredentials;\n+    private final Instant sessionCredentialsExpiration;\n+\n+    public SessionCredentialsHolder(AwsSessionCredentials credentials, Instant expiration) {\n+        this.sessionCredentials = credentials;\n+        this.sessionCredentialsExpiration = expiration;\n+    }\n+\n+    public AwsSessionCredentials getSessionCredentials() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE4Mjg0Ng==", "bodyText": "final?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r527182846", "createdAt": "2020-11-19T20:37:48Z", "author": {"login": "zoewangg"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/ExpiredTokenException.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.core.SdkField;\n+import software.amazon.awssdk.core.SdkPojo;\n+import software.amazon.awssdk.core.exception.SdkClientException;\n+\n+/**\n+ * <p>\n+ * The session token that was passed is expired or is not valid.\n+ * </p>\n+ */\n+@SdkPublicApi\n+public class ExpiredTokenException extends SdkClientException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE4MzEzOA==", "bodyText": "nit: missing <p>", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r527183138", "createdAt": "2020-11-19T20:38:27Z", "author": {"login": "zoewangg"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,250 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static software.amazon.awssdk.utils.Validate.notNull;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsSessionCredentials;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.SessionCredentialsHolder;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+import software.amazon.awssdk.utils.cache.CachedSupplier;\n+import software.amazon.awssdk.utils.cache.NonBlocking;\n+import software.amazon.awssdk.utils.cache.RefreshResult;\n+\n+/**\n+ * An implementation of {@link AwsCredentialsProvider} that is extended within this package to provide support for periodically\n+ * updating session credentials. This credential provider maintains a {@link Supplier<GetRoleCredentialsRequest>} for a\n+ * {@link SsoClient#getRoleCredentials(Consumer)} call to retrieve the credentials needed.\n+ *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE4NjAxNA==", "bodyText": "Would it make sense to prefix it with sdk-? It'd be easier to filter all SDK threads in a thread dump.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#discussion_r527186014", "createdAt": "2020-11-19T20:44:08Z", "author": {"login": "zoewangg"}, "path": "services/sso/src/main/java/software.amazon.awssdk.services.sso/auth/SsoCredentialsProvider.java", "diffHunk": "@@ -0,0 +1,250 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.services.sso.auth;\n+\n+import static software.amazon.awssdk.utils.Validate.notNull;\n+\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import software.amazon.awssdk.annotations.SdkPublicApi;\n+import software.amazon.awssdk.auth.credentials.AwsCredentials;\n+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;\n+import software.amazon.awssdk.auth.credentials.AwsSessionCredentials;\n+import software.amazon.awssdk.services.sso.SsoClient;\n+import software.amazon.awssdk.services.sso.internal.SessionCredentialsHolder;\n+import software.amazon.awssdk.services.sso.model.GetRoleCredentialsRequest;\n+import software.amazon.awssdk.services.sso.model.RoleCredentials;\n+import software.amazon.awssdk.utils.SdkAutoCloseable;\n+import software.amazon.awssdk.utils.cache.CachedSupplier;\n+import software.amazon.awssdk.utils.cache.NonBlocking;\n+import software.amazon.awssdk.utils.cache.RefreshResult;\n+\n+/**\n+ * An implementation of {@link AwsCredentialsProvider} that is extended within this package to provide support for periodically\n+ * updating session credentials. This credential provider maintains a {@link Supplier<GetRoleCredentialsRequest>} for a\n+ * {@link SsoClient#getRoleCredentials(Consumer)} call to retrieve the credentials needed.\n+ *\n+ * While creating the {@link GetRoleCredentialsRequest}, an access token is needed to be resolved from a token file.\n+ * In default, the token is assumed unexpired, and if it's expired then an {@link ExpiredTokenException} will be thrown.\n+ * If the users want to change the behavior of this, please implement your own token resolving logic and override the\n+ * {@link Builder#refreshRequest).\n+ *\n+ * When credentials get close to expiration, this class will attempt to update them asynchronously. If the credentials\n+ * end up expiring, this class will block all calls to {@link #resolveCredentials()} until the credentials can be updated.\n+ */\n+@SdkPublicApi\n+public final class SsoCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);\n+\n+    private static final String ASYNC_THREAD_NAME = \"sso-credentials-provider\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88"}, "originalPosition": 57}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7fa7dba9ff1da04a48013721d69eeec158018e88", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/7fa7dba9ff1da04a48013721d69eeec158018e88", "committedDate": "2020-11-18T23:41:08Z", "message": "Add SSO credentials provider support and related tests."}, "afterCommit": {"oid": "f800dac42455595fa4aee275d33c1b402176f352", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/f800dac42455595fa4aee275d33c1b402176f352", "committedDate": "2020-11-20T00:28:28Z", "message": "Add SSO credentials provider support and related tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a72aadebfc66fd397759e8132935454533deeb0e", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a72aadebfc66fd397759e8132935454533deeb0e", "committedDate": "2020-11-20T00:29:31Z", "message": "Add SSO credentials provider support and related tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f800dac42455595fa4aee275d33c1b402176f352", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/f800dac42455595fa4aee275d33c1b402176f352", "committedDate": "2020-11-20T00:28:28Z", "message": "Add SSO credentials provider support and related tests."}, "afterCommit": {"oid": "a72aadebfc66fd397759e8132935454533deeb0e", "author": {"user": {"login": "Quanzzzz", "name": "Quan Zhou"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a72aadebfc66fd397759e8132935454533deeb0e", "committedDate": "2020-11-20T00:29:31Z", "message": "Add SSO credentials provider support and related tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjczMTA4", "url": "https://github.com/aws/aws-sdk-java-v2/pull/2118#pullrequestreview-535673108", "createdAt": "2020-11-20T18:19:21Z", "commit": {"oid": "a72aadebfc66fd397759e8132935454533deeb0e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2374, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}