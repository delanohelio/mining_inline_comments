{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxMzUwMDc2", "number": 1995, "title": "Make STSCredentialsProvider prefetch and stale times configurable", "bodyText": "Description\nAllow clients to specify the time (relative to expiration) for when to refresh STS session tokens.\nMotivation and Context\nThe default STSCredentialsProvider's strategy for refreshing STS sessions is to wait until the session is almost stale and to refresh it either 5 minutes (prefetch) or 1 minute (stale) before it expires. This works great for most use cases. However, it doesn't work well for pre-signed S3 urls. For example, let's say I want to pre-sign an s3 URL that will be good for 90 minutes AND I'm signing the URL with an assumed STS role's credentials. The URL's effective expiration is the min(url expiration, sts session expiration). In other words, if you have STS session credentials that last for 60 minutes, and you want to hand out a URL that will last for 30 minutes, any URLs signed with said session credentials from minutes 31 to 60 will not actually be valid for the full 30 minutes.\nThe solution is to allow the client to specify the stale and prefetch times of the to use when determining when a session is ready for prefetch and when it's stale. I expose these values as Java Function objects because I intend to reference runtime changeable configuration properties to compute the stale and prefetch times (e.g. prefetch = actual - ${url_length} - ${prefetch_relative_to_url_expiration})\nTesting\nI modified the StsCredentialsProviderTestBase. For each current test case I replicated it and specified stale and prefetch time functions that provide the same values they did before.\nScreenshots (if appropriate)\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n\nChecklist\n\n\n\n\n I have read the CONTRIBUTING document\n\n\n[Not quite] Local run of mvn install succeeds\nI've seen several failures for classes that are not related to anything I've touched. Re-running the tests in intellij succeeds\nFor example: aws-sdk-java-v2/test/codegen-generated-classes-test/target/surefire-reports\n\n\n My code follows the code style of this project\n\n\n My change requires a change to the Javadoc documentation\n\n\n I have updated the Javadoc documentation accordingly\n\n\n I have read the README document\n\n\n I have added tests to cover my changes\n\n\n All new and existing tests passed\n\n\n A short description of the change has been added to the CHANGELOG\n\n\n My change is to implement 1.11 parity feature and I have updated LaunchChangelog\n\n\nLicense\n\n\n\n\n I confirm that this pull request can be released under the Apache 2 license", "createdAt": "2020-08-21T03:14:49Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995", "merged": true, "mergeCommit": {"oid": "ff3f0ae143d86aa3f83cc1b743681c8ee93dd440"}, "closed": true, "closedAt": "2020-09-15T22:44:03Z", "author": {"login": "Helmsdown"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH4a6VgBqjM3NTcxNzI4MzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJPrK6gFqTQ4OTE1NTI4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0d2d3e6bd8a5a00abe52e6a4a5415cf289cfeef", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d0d2d3e6bd8a5a00abe52e6a4a5415cf289cfeef", "committedDate": "2020-08-21T21:43:21Z", "message": "Merge branch 'master' into sts-refresh-timing"}, "afterCommit": {"oid": "420cf6cccf2b6f35612009c9bbb20764d2c716d6", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/420cf6cccf2b6f35612009c9bbb20764d2c716d6", "committedDate": "2020-08-21T02:29:03Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "420cf6cccf2b6f35612009c9bbb20764d2c716d6", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/420cf6cccf2b6f35612009c9bbb20764d2c716d6", "committedDate": "2020-08-21T02:29:03Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}, "afterCommit": {"oid": "462e891e39e96406a18dd8896a641e3a21143f76", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/462e891e39e96406a18dd8896a641e3a21143f76", "committedDate": "2020-09-11T17:26:12Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "462e891e39e96406a18dd8896a641e3a21143f76", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/462e891e39e96406a18dd8896a641e3a21143f76", "committedDate": "2020-09-11T17:26:12Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}, "afterCommit": {"oid": "b6a51b3b2ce330b0eab1cc7745053978348832fe", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/b6a51b3b2ce330b0eab1cc7745053978348832fe", "committedDate": "2020-09-11T19:25:31Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4OTM3MTAy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#pullrequestreview-488937102", "createdAt": "2020-09-15T18:05:59Z", "commit": {"oid": "b6a51b3b2ce330b0eab1cc7745053978348832fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxODowNTo1OVrOHSN7mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxODowNTo1OVrOHSN7mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2NDY2Ng==", "bodyText": "Small typo here in 'minutes'.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488864666", "createdAt": "2020-09-15T18:05:59Z", "author": {"login": "bmaizels"}, "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -127,6 +142,30 @@ public B asyncCredentialUpdateEnabled(Boolean asyncCredentialUpdateEnabled) {\n             return (B) this;\n         }\n \n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched synchronously.\n+         *\n+         * <p>By default, this is 1 minute.</p>\n+         */\n+        @SuppressWarnings(\"unchecked\")\n+        public B staleTime(Duration staleTime) {\n+            this.staleTime = staleTime;\n+            return (B) this;\n+        }\n+\n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched asynchronously.\n+         * The value only applies if asyncCredentialUpdateEnabled is enabled.\n+         *\n+         * <p>By default, this is 5 minuts.</p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6a51b3b2ce330b0eab1cc7745053978348832fe"}, "originalPosition": 84}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b6a51b3b2ce330b0eab1cc7745053978348832fe", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/b6a51b3b2ce330b0eab1cc7745053978348832fe", "committedDate": "2020-09-11T19:25:31Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}, "afterCommit": {"oid": "a735ba543e1c038e2581b976ce25173f34861867", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a735ba543e1c038e2581b976ce25173f34861867", "committedDate": "2020-09-15T19:07:05Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a735ba543e1c038e2581b976ce25173f34861867", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a735ba543e1c038e2581b976ce25173f34861867", "committedDate": "2020-09-15T19:07:05Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}, "afterCommit": {"oid": "9931dc82e2a256654600d98c0a8fff0ba232bf9c", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/9931dc82e2a256654600d98c0a8fff0ba232bf9c", "committedDate": "2020-09-15T21:10:50Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9931dc82e2a256654600d98c0a8fff0ba232bf9c", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/9931dc82e2a256654600d98c0a8fff0ba232bf9c", "committedDate": "2020-09-15T21:10:50Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}, "afterCommit": {"oid": "e1e851f999ec0ba8746eed49cdafc6eeec012201", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/e1e851f999ec0ba8746eed49cdafc6eeec012201", "committedDate": "2020-09-15T21:13:54Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MTEyNzQ3", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#pullrequestreview-489112747", "createdAt": "2020-09-15T21:28:30Z", "commit": {"oid": "e1e851f999ec0ba8746eed49cdafc6eeec012201"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMToyODozMFrOHSVLng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMTozNToxNVrOHSVXqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4MzQ1NA==", "bodyText": "Can we change this to: Configure the amount of time, relative to STS token expiration, that the cached credentials are considered stale and should no longer be used. All threads will block until the value is updated.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488983454", "createdAt": "2020-09-15T21:28:30Z", "author": {"login": "bmaizels"}, "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -127,6 +150,30 @@ public B asyncCredentialUpdateEnabled(Boolean asyncCredentialUpdateEnabled) {\n             return (B) this;\n         }\n \n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched synchronously.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1e851f999ec0ba8746eed49cdafc6eeec012201"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk4NjUzNg==", "bodyText": "Can we change this to: Configure the amount of time, relative to STS token expiration, that the cached credentials are considered close to stale and should be updated. See {@link #asyncCredentialUpdateEnabled}.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488986536", "createdAt": "2020-09-15T21:35:15Z", "author": {"login": "bmaizels"}, "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -127,6 +150,30 @@ public B asyncCredentialUpdateEnabled(Boolean asyncCredentialUpdateEnabled) {\n             return (B) this;\n         }\n \n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched synchronously.\n+         *\n+         * <p>By default, this is 1 minute.</p>\n+         */\n+        @SuppressWarnings(\"unchecked\")\n+        public B staleTime(Duration staleTime) {\n+            this.staleTime = staleTime;\n+            return (B) this;\n+        }\n+\n+        /**\n+         * Configure the amount of time, relative to STS token expiration, that a new STS token should be fetched asynchronously.\n+         * The value only applies if asyncCredentialUpdateEnabled is enabled.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1e851f999ec0ba8746eed49cdafc6eeec012201"}, "originalPosition": 97}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1e851f999ec0ba8746eed49cdafc6eeec012201", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/e1e851f999ec0ba8746eed49cdafc6eeec012201", "committedDate": "2020-09-15T21:13:54Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}, "afterCommit": {"oid": "d1ed98feacef6555680aad8374d34be42f7ec843", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d1ed98feacef6555680aad8374d34be42f7ec843", "committedDate": "2020-09-15T21:37:44Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MTI5NjUy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#pullrequestreview-489129652", "createdAt": "2020-09-15T21:44:20Z", "commit": {"oid": "d1ed98feacef6555680aad8374d34be42f7ec843"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMTo0NDoyMFrOHSV3CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMTo0NDo0NVrOHSV4Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk5NDU2OA==", "bodyText": "Can we add javadoc: The amount of time, relative to STS token expiration, that the cached credentials are considered stale and should no longer be used. All threads will block until the value is updated.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488994568", "createdAt": "2020-09-15T21:44:20Z", "author": {"login": "bmaizels"}, "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -83,6 +96,14 @@ public void close() {\n         sessionCache.close();\n     }\n \n+    public Duration staleTime() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1ed98feacef6555680aad8374d34be42f7ec843"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODk5NDg5MQ==", "bodyText": "Can we add javadoc: The amount of time, relative to STS token expiration, that the cached credentials are considered close to stale and should be updated.", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r488994891", "createdAt": "2020-09-15T21:44:45Z", "author": {"login": "bmaizels"}, "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -83,6 +96,14 @@ public void close() {\n         sessionCache.close();\n     }\n \n+    public Duration staleTime() {\n+        return staleTime;\n+    }\n+\n+    public Duration prefetchTime() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1ed98feacef6555680aad8374d34be42f7ec843"}, "originalPosition": 64}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1ed98feacef6555680aad8374d34be42f7ec843", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/d1ed98feacef6555680aad8374d34be42f7ec843", "committedDate": "2020-09-15T21:37:44Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}, "afterCommit": {"oid": "720c5bc4af74224b706761983349147ed4a512b3", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/720c5bc4af74224b706761983349147ed4a512b3", "committedDate": "2020-09-15T21:52:38Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MTUwNjU3", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#pullrequestreview-489150657", "createdAt": "2020-09-15T22:27:20Z", "commit": {"oid": "720c5bc4af74224b706761983349147ed4a512b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MTUxNTA2", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#pullrequestreview-489151506", "createdAt": "2020-09-15T22:29:19Z", "commit": {"oid": "720c5bc4af74224b706761983349147ed4a512b3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMjoyOToxOVrOHSYE9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMjoyOTo0MFrOHSYF6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMDkwMw==", "bodyText": "Can we change this to : private static final Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r489030903", "createdAt": "2020-09-15T22:29:19Z", "author": {"login": "bmaizels"}, "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -40,6 +42,10 @@\n @ThreadSafe\n @SdkInternalApi\n abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720c5bc4af74224b706761983349147ed4a512b3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTAzMTE0NQ==", "bodyText": "Can we change this to: private static final Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#discussion_r489031145", "createdAt": "2020-09-15T22:29:40Z", "author": {"login": "bmaizels"}, "path": "services/sts/src/main/java/software/amazon/awssdk/services/sts/auth/StsCredentialsProvider.java", "diffHunk": "@@ -40,6 +42,10 @@\n @ThreadSafe\n @SdkInternalApi\n abstract class StsCredentialsProvider implements AwsCredentialsProvider, SdkAutoCloseable {\n+\n+    private static Duration DEFAULT_STALE_TIME = Duration.ofMinutes(1);\n+    private static Duration DEFAULT_PREFETCH_TIME = Duration.ofMinutes(5);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720c5bc4af74224b706761983349147ed4a512b3"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59d985a4aa7139cca14dd6789dd8e12457df5f30", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/59d985a4aa7139cca14dd6789dd8e12457df5f30", "committedDate": "2020-09-15T22:36:10Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "720c5bc4af74224b706761983349147ed4a512b3", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/720c5bc4af74224b706761983349147ed4a512b3", "committedDate": "2020-09-15T21:52:38Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}, "afterCommit": {"oid": "59d985a4aa7139cca14dd6789dd8e12457df5f30", "author": {"user": {"login": "Helmsdown", "name": null}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/59d985a4aa7139cca14dd6789dd8e12457df5f30", "committedDate": "2020-09-15T22:36:10Z", "message": "Make STSCredentialsProvider prefetch and stale times configurable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MTU1Mjgw", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1995#pullrequestreview-489155280", "createdAt": "2020-09-15T22:38:17Z", "commit": {"oid": "59d985a4aa7139cca14dd6789dd8e12457df5f30"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2427, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}