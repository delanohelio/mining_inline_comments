{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMDc1MTg2", "number": 1885, "title": "Added support for HTTP/2 metrics to Netty.", "bodyText": "Updated existing HTTP metrics to specify that they are \"concurrency\", not \"connections\". For HTTP/2, we can't calculate the maximum number of connections, and concurrency is more useful to customers anyway.\nFixed the AVAILABLE_CONCURRENCY in Netty to actually be the number of established but idle concurrency, not the difference between max concurrency and leased concurrency.", "createdAt": "2020-06-09T21:26:42Z", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885", "merged": true, "mergeCommit": {"oid": "9032023c516b877958cd54d39a8f7bd4122bc9ac"}, "closed": true, "closedAt": "2020-06-11T18:40:37Z", "author": {"login": "millems"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpr-8ngBqjM0MjY5MjQ0NTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqSQVXAFqTQyOTE2MjIwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6fe00775bfaa730c0fb09ba537a98ee91455d98", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/a6fe00775bfaa730c0fb09ba537a98ee91455d98", "committedDate": "2020-06-09T21:24:04Z", "message": "Added support for HTTP/2 metrics to Netty.\n\nUpdated existing HTTP metrics to specify that they are \"concurrency\", not \"connections\". For HTTP/2, we can't calculate the maximum number of connections, and concurrency is more useful to customers anyway.\n\nFixed the AVAILABLE_CONCURRENCY in Netty to actually be the number of established but idle concurrency, not the difference between max concurrency and leased concurrency."}, "afterCommit": {"oid": "804e7bb3dec8cb6e7eff347656aee9597500b42e", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/804e7bb3dec8cb6e7eff347656aee9597500b42e", "committedDate": "2020-06-09T21:31:32Z", "message": "Added support for HTTP/2 metrics to Netty.\n\nUpdated existing HTTP metrics to specify that they are \"concurrency\", not \"connections\". For HTTP/2, we can't calculate the maximum number of connections, and concurrency is more useful to customers anyway.\n\nFixed the AVAILABLE_CONCURRENCY in Netty to actually be the number of established but idle concurrency, not the difference between max concurrency and leased concurrency."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf8eccb9e971e98a698891780fdfcfd586af2074", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/cf8eccb9e971e98a698891780fdfcfd586af2074", "committedDate": "2020-06-10T00:19:01Z", "message": "Added support for HTTP/2 metrics to Netty.\n\nUpdated existing HTTP metrics to specify that they are \"concurrency\", not \"connections\". For HTTP/2, we can't calculate the maximum number of connections, and concurrency is more useful to customers anyway.\n\nFixed the AVAILABLE_CONCURRENCY in Netty to actually be the number of established but idle concurrency, not the difference between max concurrency and leased concurrency."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "804e7bb3dec8cb6e7eff347656aee9597500b42e", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/804e7bb3dec8cb6e7eff347656aee9597500b42e", "committedDate": "2020-06-09T21:31:32Z", "message": "Added support for HTTP/2 metrics to Netty.\n\nUpdated existing HTTP metrics to specify that they are \"concurrency\", not \"connections\". For HTTP/2, we can't calculate the maximum number of connections, and concurrency is more useful to customers anyway.\n\nFixed the AVAILABLE_CONCURRENCY in Netty to actually be the number of established but idle concurrency, not the difference between max concurrency and leased concurrency."}, "afterCommit": {"oid": "cf8eccb9e971e98a698891780fdfcfd586af2074", "author": {"user": {"login": "millems", "name": "Matthew Miller"}}, "url": "https://github.com/aws/aws-sdk-java-v2/commit/cf8eccb9e971e98a698891780fdfcfd586af2074", "committedDate": "2020-06-10T00:19:01Z", "message": "Added support for HTTP/2 metrics to Netty.\n\nUpdated existing HTTP metrics to specify that they are \"concurrency\", not \"connections\". For HTTP/2, we can't calculate the maximum number of connections, and concurrency is more useful to customers anyway.\n\nFixed the AVAILABLE_CONCURRENCY in Netty to actually be the number of established but idle concurrency, not the difference between max concurrency and leased concurrency."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MTU3NjA5", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#pullrequestreview-429157609", "createdAt": "2020-06-11T17:55:58Z", "commit": {"oid": "cf8eccb9e971e98a698891780fdfcfd586af2074"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MTYyMjAy", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#pullrequestreview-429162202", "createdAt": "2020-06-11T18:02:19Z", "commit": {"oid": "cf8eccb9e971e98a698891780fdfcfd586af2074"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODowMjoxOVrOGio4SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODowNTowNlrOGio-lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDUzNw==", "bodyText": "Seems like for h2 operations,  all metrics here are for streams, should we add metrics for connections?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#discussion_r438974537", "createdAt": "2020-06-11T18:02:19Z", "author": {"login": "zoewangg"}, "path": "http-client-spi/src/main/java/software/amazon/awssdk/http/HttpMetric.java", "diffHunk": "@@ -30,24 +31,64 @@\n     public static final SdkMetric<String> HTTP_CLIENT_NAME = metric(\"HttpClientName\", String.class);\n \n     /**\n-     * The maximum number of connections that will be pooled by the HTTP client.\n+     * The maximum number of concurrent requests that is supported by the HTTP client.\n+     *\n+     * <p>For HTTP/1 operations, this is equal to the maximum number of TCP connections that can be be pooled by the HTTP client.\n+     * For HTTP/2 operations, this is equal to the maximum number of streams that can be pooled by the HTTP client.\n+     *\n+     * <p>Note: Depending on the HTTP client, this is either a value for all endpoints served by the HTTP client, or a value\n+     * that applies only to the specific endpoint/host used in the request. For 'apache-http-client', this value is\n+     * for the entire HTTP client. For 'netty-nio-client', this value is per-endpoint. In all cases, this value is scoped to an\n+     * individual HTTP client instance, and does not include concurrency that may be available in other HTTP clients running\n+     * within the same JVM.\n      */\n-    public static final SdkMetric<Integer> MAX_CONNECTIONS = metric(\"MaxConnections\", Integer.class);\n+    public static final SdkMetric<Integer> MAX_CONCURRENCY = metric(\"MaxConcurrency\", Integer.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf8eccb9e971e98a698891780fdfcfd586af2074"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NjE1MA==", "bodyText": "should we namespace the key?", "url": "https://github.com/aws/aws-sdk-java-v2/pull/1885#discussion_r438976150", "createdAt": "2020-06-11T18:05:06Z", "author": {"login": "zoewangg"}, "path": "http-clients/netty-nio-client/src/main/java/software/amazon/awssdk/http/nio/netty/internal/IdleConnectionCountingChannelPool.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package software.amazon.awssdk.http.nio.netty.internal;\n+\n+import static software.amazon.awssdk.http.nio.netty.internal.utils.NettyUtils.doInEventLoop;\n+\n+import io.netty.channel.Channel;\n+import io.netty.channel.pool.ChannelPool;\n+import io.netty.util.AttributeKey;\n+import io.netty.util.concurrent.EventExecutor;\n+import io.netty.util.concurrent.Future;\n+import io.netty.util.concurrent.Promise;\n+import java.util.concurrent.CompletableFuture;\n+import software.amazon.awssdk.annotations.SdkInternalApi;\n+import software.amazon.awssdk.http.HttpMetric;\n+import software.amazon.awssdk.metrics.MetricCollector;\n+import software.amazon.awssdk.utils.Logger;\n+\n+/**\n+ * A channel pool implementation that tracks the number of \"idle\" channels in an underlying channel pool.\n+ *\n+ * <p>Specifically, this pool counts the number of channels acquired and then released from/to the underlying channel pool. It\n+ * will monitor for the underlying channels to be closed, and will remove them from the \"idle\" count.\n+ */\n+@SdkInternalApi\n+public class IdleConnectionCountingChannelPool implements SdkChannelPool {\n+    private static final Logger log = Logger.loggerFor(IdleConnectionCountingChannelPool.class);\n+\n+    /**\n+     * The idle channel state for a specific channel. This should only be accessed from the {@link #executor}.\n+     */\n+    private static final AttributeKey<ChannelIdleState> CHANNEL_STATE =\n+        AttributeKey.newInstance(\"IdleConnectionCountingChannelPool.CHANNEL_STATE\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf8eccb9e971e98a698891780fdfcfd586af2074"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2598, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}