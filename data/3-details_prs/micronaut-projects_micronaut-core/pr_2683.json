{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1OTM0ODgw", "number": 2683, "title": "Custom port per controller. Fixes #2532", "bodyText": "", "createdAt": "2020-01-22T16:03:31Z", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2683", "merged": true, "mergeCommit": {"oid": "6e3b88856fe7f5891b2816bac7437ebb0c94a089"}, "closed": true, "closedAt": "2020-01-23T08:05:18Z", "author": {"login": "graemerocher"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb83-FzgH2gAyMzY1OTM0ODgwOjY0MTRlMjE2Yjg5ZGUxNjExOTY5MTYyYWY3Y2NmMmQ4M2JlYTc4NTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9Fg5ZAH2gAyMzY1OTM0ODgwOjI1ZDVlYmUwYmJlYzc1NjVjZmQ3ZTZlMjAzM2ZkZDRlYmQ5NmRmOWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6414e216b89de1611969162af7ccf2d83bea7850", "author": {"user": {"login": "graemerocher", "name": "Graeme Rocher"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/6414e216b89de1611969162af7ccf2d83bea7850", "committedDate": "2020-01-22T16:02:59Z", "message": "Custom port per controller. Fixes #2532"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NzEzODAy", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2683#pullrequestreview-346713802", "createdAt": "2020-01-22T16:14:03Z", "commit": {"oid": "6414e216b89de1611969162af7ccf2d83bea7850"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNjoxNDo0N1rOFgiFAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNjoxNDo0N1rOFgiFAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY1NzA4OA==", "bodyText": "Shouldn't there be a test for two controllers with two different ports that requests to one doesn't get to a route the other one has? And what happens when a port isn't specified on a particular Controller? Does it default to port 80 or a random port?", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2683#discussion_r369657088", "createdAt": "2020-01-22T16:14:47Z", "author": {"login": "dave08"}, "path": "http-server-netty/src/test/groovy/io/micronaut/http/server/netty/ports/ControllerPortSpec.groovy", "diffHunk": "@@ -0,0 +1,57 @@\n+package io.micronaut.http.server.netty.ports\n+\n+import io.micronaut.context.ApplicationContext\n+import io.micronaut.core.io.socket.SocketUtils\n+import io.micronaut.http.HttpStatus\n+import io.micronaut.http.annotation.Controller\n+import io.micronaut.http.annotation.Get\n+import io.micronaut.http.client.RxHttpClient\n+import io.micronaut.http.client.exceptions.HttpClientResponseException\n+import io.micronaut.runtime.server.EmbeddedServer\n+import spock.lang.Retry\n+import spock.lang.Specification\n+\n+class ControllerPortSpec extends Specification {\n+\n+\n+    @Retry // try because a port binding issue could occur on CI\n+    void \"test custom controller port\"() {\n+\n+        given:\n+        def customPort = SocketUtils.findAvailableTcpPort()\n+        EmbeddedServer embeddedServer = ApplicationContext.run(\n+                EmbeddedServer,\n+                ['my.controller.port': customPort]\n+        )\n+        def client = embeddedServer.applicationContext.createBean(RxHttpClient, new URL(\"http://localhost:$customPort\"))\n+        def client2 = embeddedServer.applicationContext.createBean(RxHttpClient, embeddedServer.getURL())\n+\n+        when:\n+        def response = client.toBlocking().retrieve(\"/custom-port1\")\n+\n+        then:\n+        response == 'ok'\n+\n+        when:\n+        client2.toBlocking().retrieve(\"/custom-port1\")\n+\n+        then:\n+        def e = thrown(HttpClientResponseException)\n+        e.response.status() == HttpStatus.NOT_FOUND\n+\n+\n+        cleanup:\n+        embeddedServer.close()\n+        client.close()\n+        client2.close()\n+    }\n+\n+    @Controller(value = \"/custom-port1\", port='${my.controller.port}')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6414e216b89de1611969162af7ccf2d83bea7850"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c3910504dc35323e5a49ae346e329f02c510b80", "author": {"user": {"login": "graemerocher", "name": "Graeme Rocher"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/4c3910504dc35323e5a49ae346e329f02c510b80", "committedDate": "2020-01-22T16:37:39Z", "message": "Fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODEzNjMx", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2683#pullrequestreview-346813631", "createdAt": "2020-01-22T18:39:49Z", "commit": {"oid": "4c3910504dc35323e5a49ae346e329f02c510b80"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxODozOTo1MFrOFgmxrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxODozOTo1MFrOFgmxrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTczNDA2MQ==", "bodyText": "perhaps log an error here?", "url": "https://github.com/micronaut-projects/micronaut-core/pull/2683#discussion_r369734061", "createdAt": "2020-01-22T18:39:50Z", "author": {"login": "jameskleeh"}, "path": "inject/src/main/java/io/micronaut/inject/annotation/DefaultAnnotationMetadata.java", "diffHunk": "@@ -528,6 +528,13 @@ public OptionalInt intValue(@Nonnull String annotation, @Nonnull String member,\n         Object rawValue = getRawSingleValue(annotation, member, valueMapper);\n         if (rawValue instanceof Number) {\n             return OptionalInt.of(((Number) rawValue).intValue());\n+        } else if (rawValue instanceof CharSequence) {\n+            try {\n+                final int i = Integer.parseInt(rawValue.toString());\n+                return OptionalInt.of(i);\n+            } catch (NumberFormatException e) {\n+                return OptionalInt.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3910504dc35323e5a49ae346e329f02c510b80"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25d5ebe0bbec7565cfd7e6e2033fdd4ebd96df9a", "author": {"user": {"login": "graemerocher", "name": "Graeme Rocher"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/25d5ebe0bbec7565cfd7e6e2033fdd4ebd96df9a", "committedDate": "2020-01-23T07:49:46Z", "message": "Rethrow exception instead of swallowing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2907, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}