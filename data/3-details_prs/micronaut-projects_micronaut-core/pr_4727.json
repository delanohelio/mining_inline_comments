{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNjEwMzI4", "number": 4727, "title": "refactor: changes to locale resolver", "bodyText": "This PR address most of the requested changes to #4717\n\nI have fixed the missing Javadoc.\nI have implemented a test for SessionLocaleResolver and added extra tests.\nI moved the main logic for default and fixed resolution outside of the http-server module. So that they can be used without an http-server.\nI created configuration interfaces so that parts of configuration can be used outside HttpServerConfiguration.\nI have sorted the locale resolvers in CompositeLocaleResolver.\nI moved locale resolution into its own packages.\n\nSee: #3787", "createdAt": "2020-12-17T05:22:32Z", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727", "merged": true, "mergeCommit": {"oid": "b35f4436a2872a59cba338ee83f9297cddbbd39d"}, "closed": true, "closedAt": "2020-12-17T17:15:37Z", "author": {"login": "sdelamo"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm8jNPgH2gAyNTQxNjEwMzI4OmYxMzQ0MGY5MzliNDk5YzljZDUzOWE5Njk2YTc4YTkzNWZmZTA5NmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnGHBfgH2gAyNTQxNjEwMzI4OjkwMDM0ZDVmN2M4N2I3MzA1MTk4MjhlN2I2NzYxY2IyNWVjZmM5NGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/f13440f939b499c9cd539a9696a78a935ffe096c", "committedDate": "2020-12-17T05:19:07Z", "message": "refactor: changes to locale resolver"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjMyNTU0", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727#pullrequestreview-554632554", "createdAt": "2020-12-17T14:04:46Z", "commit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNDowNDo0NlrOIH3H1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNDowNzozMFrOIH3PQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTExNDA3MA==", "bodyText": "if this is a standalone class it doesn't make sense to tie it to configuration. It should simply receive the locale as the argument", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727#discussion_r545114070", "createdAt": "2020-12-17T14:04:46Z", "author": {"login": "jameskleeh"}, "path": "core/src/main/java/io/micronaut/core/util/localeresolution/FixedLocaleResolver.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2017-2020 original authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.micronaut.core.util.localeresolution;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import java.util.Locale;\n+import java.util.Optional;\n+\n+/**\n+ * Generic implementation of {@link io.micronaut.core.util.LocaleResolver} for fixed locale resolution.\n+ *\n+ * @author Sergio del Amo\n+ * @since 2.3.0\n+ * @param <T> The context object which will be used to resolve the locale\n+ */\n+public class FixedLocaleResolver<T> extends DefaultLocaleResolver<T> {\n+\n+    protected final Locale locale;\n+\n+    /**\n+     *\n+     * @param localeResolutionConfiguration Locale Resolution configuration\n+     */\n+    public FixedLocaleResolver(LocaleResolutionConfiguration localeResolutionConfiguration) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTExNDMyMw==", "bodyText": "I don't think we need a separate interface for this", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727#discussion_r545114323", "createdAt": "2020-12-17T14:05:06Z", "author": {"login": "jameskleeh"}, "path": "core/src/main/java/io/micronaut/core/util/localeresolution/LocaleResolutionConfiguration.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2017-2020 original authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.micronaut.core.util.localeresolution;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import java.util.Locale;\n+import java.util.Optional;\n+\n+/**\n+ * Locale resolution configuration.\n+ *\n+ * @author Sergio del Amo\n+ * @since 2.3.0\n+ */\n+public interface LocaleResolutionConfiguration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTExNDY4NA==", "bodyText": "This is redundant", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727#discussion_r545114684", "createdAt": "2020-12-17T14:05:40Z", "author": {"login": "jameskleeh"}, "path": "http-server/src/main/java/io/micronaut/http/server/util/localeresolution/CompositeHttpLocaleResolver.java", "diffHunk": "@@ -13,31 +13,41 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package io.micronaut.http.server.util;\n+package io.micronaut.http.server.util.localeresolution;\n \n import edu.umd.cs.findbugs.annotations.NonNull;\n import io.micronaut.context.annotation.Primary;\n+import io.micronaut.core.order.OrderUtil;\n+import io.micronaut.core.order.Ordered;\n import io.micronaut.http.HttpRequest;\n-import io.micronaut.http.server.HttpServerConfiguration;\n \n import javax.inject.Singleton;\n import java.util.Arrays;\n import java.util.Locale;\n import java.util.Optional;\n \n+/**\n+ * {@link Primary} {@link HttpLocaleResolver} which evaluates every {@link HttpLocaleResolver} by order to resolve a {@link java.util.Locale}.\n+ *\n+ * @author Sergio del Amo\n+ * @author James Kleeh\n+ * @since 2.3.0\n+ */\n @Singleton\n @Primary\n-public class CompositeHttpLocaleResolver implements HttpLocaleResolver {\n+public class CompositeHttpLocaleResolver extends HttpDefaultLocaleResolver {\n \n     private final HttpLocaleResolver[] localeResolvers;\n-    private final Locale defaultLocale;\n \n+    /**\n+     * @param localeResolvers HTTP Locale Resolvers\n+     * @param httpLocaleResolutionConfiguration Locale Resolution configuration for HTTP Requests\n+     */\n     public CompositeHttpLocaleResolver(HttpLocaleResolver[] localeResolvers,\n-                                       HttpServerConfiguration serverConfiguration) {\n+                                       HttpLocaleResolutionConfiguration httpLocaleResolutionConfiguration) {\n+        super(httpLocaleResolutionConfiguration);\n+        OrderUtil.sort(localeResolvers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTExNDkyMA==", "bodyText": "Setting an order here doesn't make sense because this is the primary bean", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727#discussion_r545114920", "createdAt": "2020-12-17T14:06:05Z", "author": {"login": "jameskleeh"}, "path": "http-server/src/main/java/io/micronaut/http/server/util/localeresolution/CompositeHttpLocaleResolver.java", "diffHunk": "@@ -50,7 +60,7 @@ public CompositeHttpLocaleResolver(HttpLocaleResolver[] localeResolvers,\n     }\n \n     @Override\n-    public Locale resolveOrDefault(@NonNull HttpRequest<?> request) {\n-        return resolve(request).orElse(defaultLocale);\n+    public int getOrder() {\n+        return Ordered.LOWEST_PRECEDENCE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTExNTU4OQ==", "bodyText": "We shouldn't use HIGHEST_PRECEDENCE because then its impossible to create one with a higher precedence", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727#discussion_r545115589", "createdAt": "2020-12-17T14:07:01Z", "author": {"login": "jameskleeh"}, "path": "http-server/src/main/java/io/micronaut/http/server/util/localeresolution/HttpFixedLocaleResolver.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2017-2020 original authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.micronaut.http.server.util.localeresolution;\n+\n+import io.micronaut.context.annotation.Requires;\n+import io.micronaut.core.order.Ordered;\n+import io.micronaut.core.util.localeresolution.FixedLocaleResolver;\n+import io.micronaut.core.util.localeresolution.LocaleResolutionConfiguration;\n+import io.micronaut.http.HttpRequest;\n+import io.micronaut.http.server.HttpServerConfiguration;\n+\n+import javax.inject.Singleton;\n+\n+/**\n+ * Generic implementation of {@link io.micronaut.core.util.LocaleResolver} for fixed locale resolution.\n+ *\n+ * @author Sergio del Amo\n+ * @since 2.3.0\n+ */\n+@Singleton\n+@Requires(property = HttpServerConfiguration.HttpLocaleResolutionConfigurationProperties.PREFIX + \".fixed\")\n+public class HttpFixedLocaleResolver extends FixedLocaleResolver<HttpRequest<?>> implements HttpLocaleResolver {\n+\n+    /**\n+     * @param localeResolutionConfiguration Locale Resolution configuration\n+     */\n+    public HttpFixedLocaleResolver(LocaleResolutionConfiguration localeResolutionConfiguration) {\n+        super(localeResolutionConfiguration);\n+    }\n+\n+    @Override\n+    public int getOrder() {\n+        return Ordered.HIGHEST_PRECEDENCE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTExNTk2OQ==", "bodyText": "This should not be indexed. There will only be 1 bean of this type", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727#discussion_r545115969", "createdAt": "2020-12-17T14:07:30Z", "author": {"login": "jameskleeh"}, "path": "http-server/src/main/java/io/micronaut/http/server/util/localeresolution/HttpLocaleResolutionConfiguration.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2017-2020 original authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.micronaut.http.server.util.localeresolution;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import io.micronaut.core.annotation.Indexed;\n+import io.micronaut.core.util.localeresolution.LocaleResolutionConfiguration;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Configuration for Locale Resolution in a HTTP Request.\n+ *\n+ * @author Sergio del Amo\n+ * @since 2.3.0\n+ */\n+@Indexed(HttpLocaleResolutionConfiguration.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjQyMjE3", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727#pullrequestreview-554642217", "createdAt": "2020-12-17T14:15:20Z", "commit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNDoxNToyMFrOIH3lug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNDoxNToyMFrOIH3lug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEyMTcyMg==", "bodyText": "This should be AbstractLocaleResolver. Calling it default means to me that its the default implementation, which isn't true", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4727#discussion_r545121722", "createdAt": "2020-12-17T14:15:20Z", "author": {"login": "jameskleeh"}, "path": "core/src/main/java/io/micronaut/core/util/localeresolution/DefaultLocaleResolver.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2017-2020 original authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.micronaut.core.util.localeresolution;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import io.micronaut.core.util.LocaleResolver;\n+\n+import java.util.Locale;\n+\n+/**\n+ * Provides an abstract class which implements {@link LocaleResolver} and handles default locale resolution.\n+ *\n+ * @author Sergio del Amo\n+ * @since 2.3.0\n+ * @param <T> The context object which will be used to resolve the locale\n+ */\n+public abstract class DefaultLocaleResolver<T> implements LocaleResolver<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f13440f939b499c9cd539a9696a78a935ffe096c"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51a2712648c98ff79afc4aba56c4af0a15ee21ec", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/51a2712648c98ff79afc4aba56c4af0a15ee21ec", "committedDate": "2020-12-17T14:39:58Z", "message": ":%s/DefaultLocaleResolver/AbstractLocaleResolver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aab26b899a1c31658b3314bcf16690b65491022e", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/aab26b899a1c31658b3314bcf16690b65491022e", "committedDate": "2020-12-17T14:47:58Z", "message": "add a padding to fixed locale resolver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "330f9f3ce9a5e775f94f78ade27ea6e46a934f2f", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/330f9f3ce9a5e775f94f78ade27ea6e46a934f2f", "committedDate": "2020-12-17T14:49:01Z", "message": "don't sort locale resolvers they are already sorted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8fc185b092e1efe6f92b51c757e4881ea7a1f37", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/a8fc185b092e1efe6f92b51c757e4881ea7a1f37", "committedDate": "2020-12-17T14:50:36Z", "message": "remove @Indexed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca1e728aab470224a7a05535b62f97f041b3423b", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/ca1e728aab470224a7a05535b62f97f041b3423b", "committedDate": "2020-12-17T14:53:30Z", "message": "don't override getOrder in Composite"}, "afterCommit": {"oid": "a374e0258c8649026d58415af9c30a46f2898ba1", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/a374e0258c8649026d58415af9c30a46f2898ba1", "committedDate": "2020-12-17T14:53:53Z", "message": "don't override getOrder in Composite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e43cd77d833e8f439111204025722543288fef61", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/e43cd77d833e8f439111204025722543288fef61", "committedDate": "2020-12-17T14:55:44Z", "message": "don't override getOrder in Composite"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a374e0258c8649026d58415af9c30a46f2898ba1", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/a374e0258c8649026d58415af9c30a46f2898ba1", "committedDate": "2020-12-17T14:53:53Z", "message": "don't override getOrder in Composite"}, "afterCommit": {"oid": "e43cd77d833e8f439111204025722543288fef61", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/e43cd77d833e8f439111204025722543288fef61", "committedDate": "2020-12-17T14:55:44Z", "message": "don't override getOrder in Composite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b29562ecd477ecd66bca5d86bf661beb2241a3f", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/5b29562ecd477ecd66bca5d86bf661beb2241a3f", "committedDate": "2020-12-17T15:00:16Z", "message": "make test more robust for ordering"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56d65eceba8a5c47519107d662271d687adfb2e7", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/56d65eceba8a5c47519107d662271d687adfb2e7", "committedDate": "2020-12-17T15:00:33Z", "message": "don't extend FixedLocaleResolver from AbstractLocaleResolver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac69a44dafccf93ae1c54a6b865149b1bc13eb57", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/ac69a44dafccf93ae1c54a6b865149b1bc13eb57", "committedDate": "2020-12-17T15:06:11Z", "message": "Split default and fix configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90034d5f7c87b730519828e7b6761cb25ecfc94b", "author": {"user": {"login": "sdelamo", "name": "Sergio del Amo"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/90034d5f7c87b730519828e7b6761cb25ecfc94b", "committedDate": "2020-12-17T16:27:23Z", "message": "FixedLocaleResolver take a Locale"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2716, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}