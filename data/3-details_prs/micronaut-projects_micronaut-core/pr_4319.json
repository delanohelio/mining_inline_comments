{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNTc1NTMz", "number": 4319, "title": "Issue 3582 configure Netty shutdown quiet period and shutdown timeout", "bodyText": "Fixes #3582 - adding feature to configure the shutdown quiet period and shutdown timeout for Netty event loop groups and http server", "createdAt": "2020-10-14T18:57:17Z", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319", "merged": true, "mergeCommit": {"oid": "937a86e572e7ec3f505c26ce9e34d9170555ac25"}, "closed": true, "closedAt": "2020-11-11T20:07:45Z", "author": {"login": "wetted"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSh1yCgH2gAyNTAzNTc1NTMzOjIyMzIyMjFlOWNhYTA4YTZhMjExYWQ3ZmNkN2M2OTE4YjZiZjMzNWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWVuymgH2gAyNTAzNTc1NTMzOjc1ODg4ZjdhMmEwYzUzNWEzNzA3ZTk3ZGI1OGQ4ODc4OGU5ZGM1M2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2232221e9caa08a6a211ad7fcd7c6918b6bf335c", "author": {"user": {"login": "wetted", "name": "Dean Wette"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/2232221e9caa08a6a211ad7fcd7c6918b6bf335c", "committedDate": "2020-10-14T18:53:29Z", "message": "Issue 3582 - adding feature to configure the shutdown quiet period and shutdown timeout for Netty event loop groups and http server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f3480ee92d5e9839c407a0277e06e40952017a3", "author": {"user": {"login": "wetted", "name": "Dean Wette"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/7f3480ee92d5e9839c407a0277e06e40952017a3", "committedDate": "2020-10-14T19:37:20Z", "message": "Issue 3582 - adding feature to configure the shutdown quiet period and shutdown timeout for Netty event loop groups and http server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc415acf0a2bebdaf9e4c78e18aaa867936b4f0", "author": {"user": {"login": "wetted", "name": "Dean Wette"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/adc415acf0a2bebdaf9e4c78e18aaa867936b4f0", "committedDate": "2020-10-19T19:14:40Z", "message": "Issue 3582\n- adding feature to configure the shutdown quiet period and shutdown timeouts\n- adding overloaded versions of HttpClient create; RxStreamingHttpClient create; and RxHttpClientFactory createClient and createStreamingClient to accept a HttpClientConfiguration instance, for cases where the client is created outside the Micronaut application context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f90794625adfd12b27683fe9cff4b4f7114c7dae", "author": {"user": {"login": "wetted", "name": "Dean Wette"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/f90794625adfd12b27683fe9cff4b4f7114c7dae", "committedDate": "2020-10-19T20:36:59Z", "message": "Issue 3582\n- adding feature to configure the shutdown quiet period and shutdown timeouts\n- adding overloaded versions of HttpClient create; RxStreamingHttpClient create; and RxHttpClientFactory createClient and createStreamingClient to accept a HttpClientConfiguration instance, for cases where the client is created outside the Micronaut application context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d", "author": {"user": {"login": "wetted", "name": "Dean Wette"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/437b5af7f50d7cafda7bba98411236ca9f759e6d", "committedDate": "2020-10-20T15:23:23Z", "message": "Issue 3582\n- revise section 6.27.1 of the documentaion to add clarification about Netty server configuration\n- add deprecation warning in NettyHttpServer about preferring Netty event loop groups configurations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35de798ad95bad665b57cd047106da5e491df392", "author": {"user": {"login": "jameskleeh", "name": "James Kleeh"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/35de798ad95bad665b57cd047106da5e491df392", "committedDate": "2020-10-23T20:49:11Z", "message": "Update threadPools.adoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1OTk3ODE0", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319#pullrequestreview-515997814", "createdAt": "2020-10-23T20:41:44Z", "commit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDo0MTo0NFrOHnd27g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMDo0MzowN1rOHnd5Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0NTcxMA==", "bodyText": "This should be surrounded with if (LOGGER.isWarnEnabled())", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319#discussion_r511145710", "createdAt": "2020-10-23T20:41:44Z", "author": {"login": "jameskleeh"}, "path": "http-netty/src/main/java/io/micronaut/http/netty/channel/DefaultEventLoopGroupRegistry.java", "diffHunk": "@@ -56,29 +66,49 @@ public DefaultEventLoopGroupRegistry(EventLoopGroupFactory eventLoopGroupFactory\n         this.beanLocator = beanLocator;\n     }\n \n+    /**\n+     * Shut down event loop groups according to configuration.\n+     */\n+    @PreDestroy\n+    void shutdown() {\n+        eventLoopGroups.forEach((eventLoopGroup, configuration) -> {\n+            try {\n+                long quietPeriod = configuration.getShutdownQuietPeriod().toMillis();\n+                long timeout = configuration.getShutdownTimeout().toMillis();\n+                eventLoopGroup.shutdownGracefully(quietPeriod, timeout, TimeUnit.MILLISECONDS);\n+            } catch (Throwable t) {\n+                LOGGER.warn(\"Error shutting down EventLoopGroup: {}\", t.getMessage(), t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0NTg1NQ==", "bodyText": "LOG here is generally preferred over LOGGER", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319#discussion_r511145855", "createdAt": "2020-10-23T20:42:04Z", "author": {"login": "jameskleeh"}, "path": "http-netty/src/main/java/io/micronaut/http/netty/channel/DefaultEventLoopGroupRegistry.java", "diffHunk": "@@ -42,9 +48,13 @@\n @Internal\n @BootstrapContextCompatible\n public class DefaultEventLoopGroupRegistry implements EventLoopGroupRegistry {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(DefaultEventLoopGroupRegistry.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0NjA3MQ==", "bodyText": "Please add @SInCE 2.2.0 here", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319#discussion_r511146071", "createdAt": "2020-10-23T20:42:35Z", "author": {"login": "jameskleeh"}, "path": "http-client-core/src/main/java/io/micronaut/http/client/RxStreamingHttpClient.java", "diffHunk": "@@ -59,4 +59,16 @@\n     static RxStreamingHttpClient create(URL url) {\n         return HttpClientConfiguration.createStreamingClient(url);\n     }\n+\n+    /**\n+     * Create a new {@link HttpClient} with the specified configuration. Note that this method should only be used\n+     * outside of the context of an application. Within Micronaut use {@link javax.inject.Inject} to inject a client instead\n+     *\n+     * @param url The base URL\n+     * @param configuration The client configuration\n+     * @return The client\n+     */\n+    static RxStreamingHttpClient create(URL url, HttpClientConfiguration configuration) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0NjExOQ==", "bodyText": "Please add @SInCE 2.2.0 here", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319#discussion_r511146119", "createdAt": "2020-10-23T20:42:41Z", "author": {"login": "jameskleeh"}, "path": "http-client-core/src/main/java/io/micronaut/http/client/RxHttpClientFactory.java", "diffHunk": "@@ -43,4 +53,14 @@\n      * @return The client\n      */\n     RxStreamingHttpClient createStreamingClient(@Nullable URL url);\n+\n+    /**\n+     * Create a new {@link HttpClient} with the specified configuration. Note that this method should only be used\n+     * outside of the context of an application. Within Micronaut use {@link javax.inject.Inject} to inject a client instead\n+     *\n+     * @param url The base URL\n+     * @param configuration The client configuration\n+     * @return The client\n+     */\n+    RxStreamingHttpClient createStreamingClient(@Nullable URL url, HttpClientConfiguration configuration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0NjE0MA==", "bodyText": "Please add @SInCE 2.2.0 here", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319#discussion_r511146140", "createdAt": "2020-10-23T20:42:44Z", "author": {"login": "jameskleeh"}, "path": "http-client-core/src/main/java/io/micronaut/http/client/RxHttpClientFactory.java", "diffHunk": "@@ -35,6 +35,16 @@\n      */\n     RxHttpClient createClient(@Nullable URL url);\n \n+    /**\n+     * Create a new {@link HttpClient} with the specified configuration. Note that this method should only be used\n+     * outside of the context of an application. Within Micronaut use {@link javax.inject.Inject} to inject a client instead\n+     *\n+     * @param url The base URL\n+     * @param configuration the client configuration\n+     * @return The client\n+     */\n+    RxHttpClient createClient(@Nullable URL url, HttpClientConfiguration configuration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0NjE4OQ==", "bodyText": "Please add @SInCE 2.2.0 here", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319#discussion_r511146189", "createdAt": "2020-10-23T20:42:51Z", "author": {"login": "jameskleeh"}, "path": "http-client-core/src/main/java/io/micronaut/http/client/HttpClientConfiguration.java", "diffHunk": "@@ -609,6 +649,26 @@ static RxHttpClient createClient(@Nullable URL url) {\n     @Internal\n     static RxStreamingHttpClient createStreamingClient(@NonNull URL url) {\n         ArgumentUtils.requireNonNull(\"url\", url);\n+        RxHttpClientFactory clientFactory = getRxHttpClientFactory();\n+        return clientFactory.createStreamingClient(url);\n+    }\n+\n+    /**\n+     * Create a new {@link HttpClient} with the specified configuration. Note that this method should only be used\n+     * outside of the context of an application. Within Micronaut use {@link javax.inject.Inject} to inject a client instead\n+     *\n+     * @param url The base URL\n+     * @param configuration The client configuration\n+     * @return The client\n+     */\n+    @Internal\n+    static RxStreamingHttpClient createStreamingClient(@NonNull URL url, HttpClientConfiguration configuration) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0NjIyOA==", "bodyText": "Please add @SInCE 2.2.0 here", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319#discussion_r511146228", "createdAt": "2020-10-23T20:42:57Z", "author": {"login": "jameskleeh"}, "path": "http-client-core/src/main/java/io/micronaut/http/client/HttpClientConfiguration.java", "diffHunk": "@@ -586,19 +619,26 @@ public Proxy resolveProxy(boolean isSsl, String host, int port) {\n      */\n     @Internal\n     static RxHttpClient createClient(@Nullable URL url) {\n-        RxHttpClientFactory clientFactory = HttpClientConfiguration.clientFactory;\n-        if (clientFactory == null) {\n-            synchronized (HttpClientConfiguration.class) { // double check\n-                clientFactory = HttpClientConfiguration.clientFactory;\n-                if (clientFactory == null) {\n-                    clientFactory = resolveClientFactory();\n-                    HttpClientConfiguration.clientFactory = clientFactory;\n-                }\n-            }\n-        }\n+        RxHttpClientFactory clientFactory = getRxHttpClientFactory();\n+\n         return clientFactory.createClient(url);\n     }\n \n+    /**\n+     * Create a new {@link HttpClient} with the specified configuration. Note that this method should only be used\n+     * outside of the context of an application. Within Micronaut use {@link javax.inject.Inject} to inject a client instead\n+     *\n+     * @param url The base URL\n+     * @param configuration the client configuration\n+     * @return The client\n+     */\n+    @Internal\n+    static RxHttpClient createClient(@Nullable URL url, HttpClientConfiguration configuration) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE0NjMwNw==", "bodyText": "Please add @SInCE 2.2.0 here", "url": "https://github.com/micronaut-projects/micronaut-core/pull/4319#discussion_r511146307", "createdAt": "2020-10-23T20:43:07Z", "author": {"login": "jameskleeh"}, "path": "http-client-core/src/main/java/io/micronaut/http/client/HttpClient.java", "diffHunk": "@@ -233,4 +233,16 @@ default HttpClient refresh() {\n     static HttpClient create(@Nullable URL url) {\n         return HttpClientConfiguration.createClient(url);\n     }\n+\n+    /**\n+     * Create a new {@link HttpClient} with the specified configuration. Note that this method should only be used\n+     * outside of the context of an application. Within Micronaut use {@link javax.inject.Inject} to inject a client instead\n+     *\n+     * @param url The base URL\n+     * @param configuration the client configuration\n+     * @return The client\n+     */\n+    static HttpClient create(@Nullable URL url, HttpClientConfiguration configuration) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437b5af7f50d7cafda7bba98411236ca9f759e6d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75888f7a2a0c535a3707e97db58d88788e9dc53e", "author": {"user": {"login": "wetted", "name": "Dean Wette"}}, "url": "https://github.com/micronaut-projects/micronaut-core/commit/75888f7a2a0c535a3707e97db58d88788e9dc53e", "committedDate": "2020-10-26T15:02:41Z", "message": "Issue 3582\n- adding feature to configure the shutdown quiet period and shutdown timeouts\n- adding overloaded versions of HttpClient create; RxStreamingHttpClient create; and RxHttpClientFactory createClient and createStreamingClient to accept a HttpClientConfiguration instance, for cases where the client is created outside the Micronaut application context"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2730, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}