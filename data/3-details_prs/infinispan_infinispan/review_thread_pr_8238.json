{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MTI5ODEz", "number": 8238, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOToxNTo1NlrOD1bzXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOToxNTo1NlrOD1bzXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MzU2NjM3OnYy", "diffSide": "LEFT", "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "isResolved": false, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOToxNTo1NlrOGK4Epw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMzowMTo1OFrOGNS2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ==", "bodyText": "@tristantarrant I didn't find a use case for this? Could you please help me on that ?", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r414057639", "createdAt": "2020-04-23T19:15:56Z", "author": {"login": "diegolovison"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -155,41 +152,10 @@ protected void start(String name, File rootDir, String configurationFile) {\n                .label(\"name\", \"Infinispan Server\")\n                .label(\"version\", Version.getVersion())\n                .label(\"release\", Version.getVersion())\n-               .label(\"architecture\", \"x86_64\")\n-               .user(\"root\");\n+               .label(\"architecture\", \"x86_64\");\n \n          if (!prebuiltImage) {\n-            if (OS.getCurrentOs() != OS.WINDOWS) {\n-               // We need to remap the UID/GID of the jboss user inside the container to the ones of the user outside so that files created on volume mounts have the correct ownership/permissions\n-               String uid = runProcess(\"id\", \"-u\");\n-               String gid = runProcess(\"id\", \"-g\");\n-\n-               builder\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v usermod)\\\" ]; then usermod -u \" + uid +\" jboss; fi\")\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v groupmod)\\\" ]; then groupmod -g \" + gid + \" jboss; fi\");\n-            }\n-            builder\n-                  .copy(\"build\", INFINISPAN_SERVER_HOME)\n-                  .run(\"chown\", \"-R\", \"jboss:jboss\", INFINISPAN_SERVER_HOME)\n-                  .user(\"jboss\");\n-         }\n-         // Copy the resources to a location from where they can be added to the image\n-         try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5fe3ffbfba30ccf784e08496add376a0e5023ac0"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDUyOTcwOA==", "bodyText": "This is needed when using this out-of-tree. It must be kept", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r414529708", "createdAt": "2020-04-24T12:15:54Z", "author": {"login": "tristantarrant"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -155,41 +152,10 @@ protected void start(String name, File rootDir, String configurationFile) {\n                .label(\"name\", \"Infinispan Server\")\n                .label(\"version\", Version.getVersion())\n                .label(\"release\", Version.getVersion())\n-               .label(\"architecture\", \"x86_64\")\n-               .user(\"root\");\n+               .label(\"architecture\", \"x86_64\");\n \n          if (!prebuiltImage) {\n-            if (OS.getCurrentOs() != OS.WINDOWS) {\n-               // We need to remap the UID/GID of the jboss user inside the container to the ones of the user outside so that files created on volume mounts have the correct ownership/permissions\n-               String uid = runProcess(\"id\", \"-u\");\n-               String gid = runProcess(\"id\", \"-g\");\n-\n-               builder\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v usermod)\\\" ]; then usermod -u \" + uid +\" jboss; fi\")\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v groupmod)\\\" ]; then groupmod -g \" + gid + \" jboss; fi\");\n-            }\n-            builder\n-                  .copy(\"build\", INFINISPAN_SERVER_HOME)\n-                  .run(\"chown\", \"-R\", \"jboss:jboss\", INFINISPAN_SERVER_HOME)\n-                  .user(\"jboss\");\n-         }\n-         // Copy the resources to a location from where they can be added to the image\n-         try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, "originalCommit": {"oid": "5fe3ffbfba30ccf784e08496add376a0e5023ac0"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgwNTM3OQ==", "bodyText": "What means using this out-of-tree? What should be the test that must fail if we don't have this code?", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r414805379", "createdAt": "2020-04-24T19:15:58Z", "author": {"login": "diegolovison"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -155,41 +152,10 @@ protected void start(String name, File rootDir, String configurationFile) {\n                .label(\"name\", \"Infinispan Server\")\n                .label(\"version\", Version.getVersion())\n                .label(\"release\", Version.getVersion())\n-               .label(\"architecture\", \"x86_64\")\n-               .user(\"root\");\n+               .label(\"architecture\", \"x86_64\");\n \n          if (!prebuiltImage) {\n-            if (OS.getCurrentOs() != OS.WINDOWS) {\n-               // We need to remap the UID/GID of the jboss user inside the container to the ones of the user outside so that files created on volume mounts have the correct ownership/permissions\n-               String uid = runProcess(\"id\", \"-u\");\n-               String gid = runProcess(\"id\", \"-g\");\n-\n-               builder\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v usermod)\\\" ]; then usermod -u \" + uid +\" jboss; fi\")\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v groupmod)\\\" ]; then groupmod -g \" + gid + \" jboss; fi\");\n-            }\n-            builder\n-                  .copy(\"build\", INFINISPAN_SERVER_HOME)\n-                  .run(\"chown\", \"-R\", \"jboss:jboss\", INFINISPAN_SERVER_HOME)\n-                  .user(\"jboss\");\n-         }\n-         // Copy the resources to a location from where they can be added to the image\n-         try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, "originalCommit": {"oid": "5fe3ffbfba30ccf784e08496add376a0e5023ac0"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc3NzM3OQ==", "bodyText": "I have added the code", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r415777379", "createdAt": "2020-04-27T12:40:35Z", "author": {"login": "diegolovison"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -155,41 +152,10 @@ protected void start(String name, File rootDir, String configurationFile) {\n                .label(\"name\", \"Infinispan Server\")\n                .label(\"version\", Version.getVersion())\n                .label(\"release\", Version.getVersion())\n-               .label(\"architecture\", \"x86_64\")\n-               .user(\"root\");\n+               .label(\"architecture\", \"x86_64\");\n \n          if (!prebuiltImage) {\n-            if (OS.getCurrentOs() != OS.WINDOWS) {\n-               // We need to remap the UID/GID of the jboss user inside the container to the ones of the user outside so that files created on volume mounts have the correct ownership/permissions\n-               String uid = runProcess(\"id\", \"-u\");\n-               String gid = runProcess(\"id\", \"-g\");\n-\n-               builder\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v usermod)\\\" ]; then usermod -u \" + uid +\" jboss; fi\")\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v groupmod)\\\" ]; then groupmod -g \" + gid + \" jboss; fi\");\n-            }\n-            builder\n-                  .copy(\"build\", INFINISPAN_SERVER_HOME)\n-                  .run(\"chown\", \"-R\", \"jboss:jboss\", INFINISPAN_SERVER_HOME)\n-                  .user(\"jboss\");\n-         }\n-         // Copy the resources to a location from where they can be added to the image\n-         try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, "originalCommit": {"oid": "5fe3ffbfba30ccf784e08496add376a0e5023ac0"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk4MDcyMg==", "bodyText": "Can you please try running your changes with https://github.com/tristantarrant/infinispan-playground-testdriver ?", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r415980722", "createdAt": "2020-04-27T16:51:54Z", "author": {"login": "tristantarrant"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -155,41 +152,10 @@ protected void start(String name, File rootDir, String configurationFile) {\n                .label(\"name\", \"Infinispan Server\")\n                .label(\"version\", Version.getVersion())\n                .label(\"release\", Version.getVersion())\n-               .label(\"architecture\", \"x86_64\")\n-               .user(\"root\");\n+               .label(\"architecture\", \"x86_64\");\n \n          if (!prebuiltImage) {\n-            if (OS.getCurrentOs() != OS.WINDOWS) {\n-               // We need to remap the UID/GID of the jboss user inside the container to the ones of the user outside so that files created on volume mounts have the correct ownership/permissions\n-               String uid = runProcess(\"id\", \"-u\");\n-               String gid = runProcess(\"id\", \"-g\");\n-\n-               builder\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v usermod)\\\" ]; then usermod -u \" + uid +\" jboss; fi\")\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v groupmod)\\\" ]; then groupmod -g \" + gid + \" jboss; fi\");\n-            }\n-            builder\n-                  .copy(\"build\", INFINISPAN_SERVER_HOME)\n-                  .run(\"chown\", \"-R\", \"jboss:jboss\", INFINISPAN_SERVER_HOME)\n-                  .user(\"jboss\");\n-         }\n-         // Copy the resources to a location from where they can be added to the image\n-         try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, "originalCommit": {"oid": "5fe3ffbfba30ccf784e08496add376a0e5023ac0"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA4OTUyNQ==", "bodyText": "I was not able to create a cluster until tristantarrant/infinispan-playground-testdriver#3\nI have fixed ContainerInfinispanServerDriver\nThe main changes were:\n\npublic static final String IMAGE_USER = \"185\";\nbuilder.run(\"usermod -u \" + IMAGE_USER + \" jboss\");\nThe prebuilt image has the user 185, in this case, now we are also setting the user 185", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r416089525", "createdAt": "2020-04-27T19:29:38Z", "author": {"login": "diegolovison"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -155,41 +152,10 @@ protected void start(String name, File rootDir, String configurationFile) {\n                .label(\"name\", \"Infinispan Server\")\n                .label(\"version\", Version.getVersion())\n                .label(\"release\", Version.getVersion())\n-               .label(\"architecture\", \"x86_64\")\n-               .user(\"root\");\n+               .label(\"architecture\", \"x86_64\");\n \n          if (!prebuiltImage) {\n-            if (OS.getCurrentOs() != OS.WINDOWS) {\n-               // We need to remap the UID/GID of the jboss user inside the container to the ones of the user outside so that files created on volume mounts have the correct ownership/permissions\n-               String uid = runProcess(\"id\", \"-u\");\n-               String gid = runProcess(\"id\", \"-g\");\n-\n-               builder\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v usermod)\\\" ]; then usermod -u \" + uid +\" jboss; fi\")\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v groupmod)\\\" ]; then groupmod -g \" + gid + \" jboss; fi\");\n-            }\n-            builder\n-                  .copy(\"build\", INFINISPAN_SERVER_HOME)\n-                  .run(\"chown\", \"-R\", \"jboss:jboss\", INFINISPAN_SERVER_HOME)\n-                  .user(\"jboss\");\n-         }\n-         // Copy the resources to a location from where they can be added to the image\n-         try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, "originalCommit": {"oid": "5fe3ffbfba30ccf784e08496add376a0e5023ac0"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM1Nzk0Mw==", "bodyText": "I'd prefer doing this dynamically as there is no guarantee that the user id will stay constant and might also change depending on upstream/downstream/version/etc", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r416357943", "createdAt": "2020-04-28T06:22:43Z", "author": {"login": "tristantarrant"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -155,41 +152,10 @@ protected void start(String name, File rootDir, String configurationFile) {\n                .label(\"name\", \"Infinispan Server\")\n                .label(\"version\", Version.getVersion())\n                .label(\"release\", Version.getVersion())\n-               .label(\"architecture\", \"x86_64\")\n-               .user(\"root\");\n+               .label(\"architecture\", \"x86_64\");\n \n          if (!prebuiltImage) {\n-            if (OS.getCurrentOs() != OS.WINDOWS) {\n-               // We need to remap the UID/GID of the jboss user inside the container to the ones of the user outside so that files created on volume mounts have the correct ownership/permissions\n-               String uid = runProcess(\"id\", \"-u\");\n-               String gid = runProcess(\"id\", \"-g\");\n-\n-               builder\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v usermod)\\\" ]; then usermod -u \" + uid +\" jboss; fi\")\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v groupmod)\\\" ]; then groupmod -g \" + gid + \" jboss; fi\");\n-            }\n-            builder\n-                  .copy(\"build\", INFINISPAN_SERVER_HOME)\n-                  .run(\"chown\", \"-R\", \"jboss:jboss\", INFINISPAN_SERVER_HOME)\n-                  .user(\"jboss\");\n-         }\n-         // Copy the resources to a location from where they can be added to the image\n-         try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, "originalCommit": {"oid": "5fe3ffbfba30ccf784e08496add376a0e5023ac0"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU5MzQ1OA==", "bodyText": "I have changed the user to 200 and also removed:\nif (!prebuiltImage) {\n  builder.run(\"usermod -u \" + IMAGE_USER + \" jboss\");\n}\n\nIt means that, if we built the image on the fly, will have a user 200\nIf we use a prebuilt image, we are setting the user to 200\nWhen executing chown or chmod with an UID, Linux won't fail. ( This was a surprise for me)\nI have executed the test in https://github.com/tristantarrant/infinispan-playground-testdriver and it passed.", "url": "https://github.com/infinispan/infinispan/pull/8238#discussion_r416593458", "createdAt": "2020-04-28T13:01:58Z", "author": {"login": "diegolovison"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -155,41 +152,10 @@ protected void start(String name, File rootDir, String configurationFile) {\n                .label(\"name\", \"Infinispan Server\")\n                .label(\"version\", Version.getVersion())\n                .label(\"release\", Version.getVersion())\n-               .label(\"architecture\", \"x86_64\")\n-               .user(\"root\");\n+               .label(\"architecture\", \"x86_64\");\n \n          if (!prebuiltImage) {\n-            if (OS.getCurrentOs() != OS.WINDOWS) {\n-               // We need to remap the UID/GID of the jboss user inside the container to the ones of the user outside so that files created on volume mounts have the correct ownership/permissions\n-               String uid = runProcess(\"id\", \"-u\");\n-               String gid = runProcess(\"id\", \"-g\");\n-\n-               builder\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v usermod)\\\" ]; then usermod -u \" + uid +\" jboss; fi\")\n-                     .run(\"/bin/sh\", \"-c\", \"if [ -x \\\"$(command -v groupmod)\\\" ]; then groupmod -g \" + gid + \" jboss; fi\");\n-            }\n-            builder\n-                  .copy(\"build\", INFINISPAN_SERVER_HOME)\n-                  .run(\"chown\", \"-R\", \"jboss:jboss\", INFINISPAN_SERVER_HOME)\n-                  .user(\"jboss\");\n-         }\n-         // Copy the resources to a location from where they can be added to the image\n-         try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA1NzYzOQ=="}, "originalCommit": {"oid": "5fe3ffbfba30ccf784e08496add376a0e5023ac0"}, "originalPosition": 107}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4299, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}