{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2OTMyNDMw", "number": 7788, "title": "ISPN-11226 Set the cache manager in the task context for distributed \u2026", "bodyText": "https://issues.redhat.com/browse/ISPN-11226\nThis has the side-effect of being able to run distributed tasks in the server. To simplify things, only string parameters are supported for know. This limitation will be removed once we have registration of protobuf serialization contexts in the server.", "createdAt": "2020-01-24T17:07:24Z", "url": "https://github.com/infinispan/infinispan/pull/7788", "merged": true, "mergeCommit": {"oid": "92ae4bca60bef7c2603adadd4e114b8f070ff9a0"}, "closed": true, "closedAt": "2020-02-07T10:08:14Z", "author": {"login": "tristantarrant"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-xPBBgFqTM0OTM2NTczNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBstNygBqjMwMTQzOTg0NzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzY1NzM0", "url": "https://github.com/infinispan/infinispan/pull/7788#pullrequestreview-349365734", "createdAt": "2020-01-28T13:19:59Z", "commit": {"oid": "30d5acbc9afcb4715d80b9e3fcda61f846a0fbbd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30d5acbc9afcb4715d80b9e3fcda61f846a0fbbd", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/30d5acbc9afcb4715d80b9e3fcda61f846a0fbbd", "committedDate": "2020-01-24T17:06:55Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}, "afterCommit": {"oid": "c5336a0bc8c3ac4af7c1563abeb3c0a4eaa603f6", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/c5336a0bc8c3ac4af7c1563abeb3c0a4eaa603f6", "committedDate": "2020-01-29T14:58:17Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5336a0bc8c3ac4af7c1563abeb3c0a4eaa603f6", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/c5336a0bc8c3ac4af7c1563abeb3c0a4eaa603f6", "committedDate": "2020-01-29T14:58:17Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}, "afterCommit": {"oid": "0c641a9e0c48c1ebe4badda08c607a2934be1667", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/0c641a9e0c48c1ebe4badda08c607a2934be1667", "committedDate": "2020-02-03T16:11:16Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c641a9e0c48c1ebe4badda08c607a2934be1667", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/0c641a9e0c48c1ebe4badda08c607a2934be1667", "committedDate": "2020-02-03T16:11:16Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}, "afterCommit": {"oid": "fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef", "committedDate": "2020-02-03T17:15:09Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNDI1MzE1", "url": "https://github.com/infinispan/infinispan/pull/7788#pullrequestreview-352425315", "createdAt": "2020-02-03T17:21:48Z", "commit": {"oid": "fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNzoyMTo0OFrOFk5XWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNzozMjowNlrOFk5ruw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIzMjkyMA==", "bodyText": "This is much simpler than +5 etc. I'll update the class to use this approach for all values in the future.", "url": "https://github.com/infinispan/infinispan/pull/7788#discussion_r374232920", "createdAt": "2020-02-03T17:21:48Z", "author": {"login": "ryanemerson"}, "path": "commons/src/main/java/org/infinispan/commons/marshall/ProtoStreamTypeIds.java", "diffHunk": "@@ -78,10 +78,12 @@\n    int FILE_READ_LOCK_KEY = LUCENE_LOWER_BOUND + 4;\n    int FILE_LIST_CACHE_VALUE = LUCENE_LOWER_BOUND + 5;\n \n-   // Scripting 4800 -> 4999\n+   // Tasks + Scripting 4800 -> 4999\n    int SCRIPTING_LOWER_BOUND = LUCENE_LOWER_BOUND + 200;\n    int EXECUTION_MODE = SCRIPTING_LOWER_BOUND;\n    int SCRIPT_METADATA = SCRIPTING_LOWER_BOUND + 1;\n+   int DISTRIBUTED_SERVER_TASK = SCRIPT_METADATA + 1;\n+   int DISTRIBUTED_SERVER_TASK_PARAMETER = DISTRIBUTED_SERVER_TASK + 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIzNDI2Mw==", "bodyText": "Is this an old comment? It doesn't seem to belong here anymore.", "url": "https://github.com/infinispan/infinispan/pull/7788#discussion_r374234263", "createdAt": "2020-02-03T17:24:29Z", "author": {"login": "ryanemerson"}, "path": "server/runtime/src/main/java/org/infinispan/server/Extensions.java", "diffHunk": "@@ -84,6 +84,7 @@ private void loadServerTasks(ClassLoader classLoader) {\n    }\n \n    public TaskEngine getServerTaskEngine(EmbeddedCacheManager cm) {\n+      // Create marshallers for all tasks", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIzNjk0MA==", "bodyText": "Class variable serverTaskEngine is never used, so we can remove the constructor.", "url": "https://github.com/infinispan/infinispan/pull/7788#discussion_r374236940", "createdAt": "2020-02-03T17:29:52Z", "author": {"login": "ryanemerson"}, "path": "server/runtime/src/main/java/org/infinispan/server/tasks/DistributedServerTaskRunner.java", "diffHunk": "@@ -36,8 +38,9 @@ public DistributedServerTaskRunner(ServerTaskEngine serverTaskEngine) {\n             results.add(v);\n          }\n       };\n-      CompletableFuture<Void> future = clusterExecutor.submitConsumer(new DistributedServerTask<>(\n-            masterCacheNode.getName(), taskName, context.getParameters()), triConsumer);\n+      List<TaskParameter> taskParams = context.getParameters().orElse(Collections.emptyMap()).entrySet().stream().map(e -> new TaskParameter(e.getKey(), e.getValue().toString())).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIzNzQ2NQ==", "bodyText": "Can be package-private", "url": "https://github.com/infinispan/infinispan/pull/7788#discussion_r374237465", "createdAt": "2020-02-03T17:30:51Z", "author": {"login": "ryanemerson"}, "path": "server/runtime/src/main/java/org/infinispan/server/tasks/PersistenceContextInitializer.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package org.infinispan.server.tasks;\n+\n+import org.infinispan.protostream.SerializationContextInitializer;\n+import org.infinispan.protostream.annotations.AutoProtoSchemaBuilder;\n+\n+/**\n+ * Interface used to initialise a {@link org.infinispan.protostream.SerializationContext} using the specified Pojos,\n+ * Marshaller implementations and provided .proto schemas.\n+ *\n+ * @author Tristan Tarrant\n+ * @since 11.0\n+ */\n+@AutoProtoSchemaBuilder(\n+      includeClasses = {\n+            TaskParameter.class,\n+            DistributedServerTask.class\n+      },\n+      schemaFileName = \"persistence.servertasks.proto\",\n+      schemaFilePath = \"proto/generated\",\n+      schemaPackageName = \"org.infinispan.persistence.servertasks\")\n+public interface PersistenceContextInitializer extends SerializationContextInitializer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDIzODEzOQ==", "bodyText": "Class and constructor can be package-private as only used internally.", "url": "https://github.com/infinispan/infinispan/pull/7788#discussion_r374238139", "createdAt": "2020-02-03T17:32:06Z", "author": {"login": "ryanemerson"}, "path": "server/runtime/src/main/java/org/infinispan/server/tasks/TaskParameter.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package org.infinispan.server.tasks;\n+\n+import org.infinispan.commons.marshall.ProtoStreamTypeIds;\n+import org.infinispan.protostream.annotations.ProtoFactory;\n+import org.infinispan.protostream.annotations.ProtoField;\n+import org.infinispan.protostream.annotations.ProtoTypeId;\n+\n+/**\n+ * @author Tristan Tarrant &lt;tristan@infinispan.org&gt;\n+ * @since 11.0\n+ **/\n+@ProtoTypeId(ProtoStreamTypeIds.DISTRIBUTED_SERVER_TASK_PARAMETER)\n+public class TaskParameter {\n+   @ProtoField(number = 1)\n+   String key;\n+\n+   @ProtoField(number = 2)\n+   String value;\n+\n+   @ProtoFactory\n+   public TaskParameter(String key, String value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/fcfd2a4b6fa44964bd0e4f4ecad4b2a90b6944ef", "committedDate": "2020-02-03T17:15:09Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}, "afterCommit": {"oid": "d4dae7fe5a21f0a52fe196658b062e426a28d285", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/d4dae7fe5a21f0a52fe196658b062e426a28d285", "committedDate": "2020-02-03T21:10:22Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4dae7fe5a21f0a52fe196658b062e426a28d285", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/d4dae7fe5a21f0a52fe196658b062e426a28d285", "committedDate": "2020-02-03T21:10:22Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}, "afterCommit": {"oid": "3c759d749a7f7addf6283652bd0af5fc26ebe141", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/3c759d749a7f7addf6283652bd0af5fc26ebe141", "committedDate": "2020-02-06T07:43:23Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b11d6ebe74cf6b9b2c21969df47b2e21710334e", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/9b11d6ebe74cf6b9b2c21969df47b2e21710334e", "committedDate": "2020-02-06T15:34:13Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c759d749a7f7addf6283652bd0af5fc26ebe141", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/3c759d749a7f7addf6283652bd0af5fc26ebe141", "committedDate": "2020-02-06T07:43:23Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}, "afterCommit": {"oid": "9b11d6ebe74cf6b9b2c21969df47b2e21710334e", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/9b11d6ebe74cf6b9b2c21969df47b2e21710334e", "committedDate": "2020-02-06T15:34:13Z", "message": "ISPN-11226 Set the cache manager in the task context for distributed tasks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1244, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}