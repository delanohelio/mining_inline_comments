{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MTAzMzIz", "number": 8107, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjozMDozOVrODrn23Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo1MTo0MlrODroWGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDY4MzgxOnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjozMDozOVrOF8Elrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNDo1MToxOVrOF8Kr9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzNDA2Mw==", "bodyText": "This types is used only to count them ? And then writeObject + convertToLegacy again? surely a mistake", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398534063", "createdAt": "2020-03-26T12:30:39Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -151,7 +153,15 @@ private Object extractValue(Object storageValue, DataConversion valueDataConvers\n       @Override\n       public void writeObject(ObjectOutput output, IndexWorker worker) throws IOException {\n          output.writeObject(worker.cacheName);\n-         output.writeObject(PojoIndexedTypeIdentifier.convertToLegacy(worker.indexedType));\n+         if (worker.indexedTypes == null) {\n+            output.writeInt(0);\n+         } else {\n+            Set<? extends Class<?>> types = worker.indexedTypes.stream().map(PojoIndexedTypeIdentifier::convertToLegacy).collect(Collectors.toSet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzMzk3NQ==", "bodyText": "ops...", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398633975", "createdAt": "2020-03-26T14:51:19Z", "author": {"login": "gustavonalle"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -151,7 +153,15 @@ private Object extractValue(Object storageValue, DataConversion valueDataConvers\n       @Override\n       public void writeObject(ObjectOutput output, IndexWorker worker) throws IOException {\n          output.writeObject(worker.cacheName);\n-         output.writeObject(PojoIndexedTypeIdentifier.convertToLegacy(worker.indexedType));\n+         if (worker.indexedTypes == null) {\n+            output.writeInt(0);\n+         } else {\n+            Set<? extends Class<?>> types = worker.indexedTypes.stream().map(PojoIndexedTypeIdentifier::convertToLegacy).collect(Collectors.toSet());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzNDA2Mw=="}, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDY5MjAzOnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjozMjo1NVrOF8EqyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNToxMDoyNFrOF8LobA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzNTM2OA==", "bodyText": "Is the initial capacity really helping ?", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398535368", "createdAt": "2020-03-26T12:32:55Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -162,14 +172,19 @@ public void writeObject(ObjectOutput output, IndexWorker worker) throws IOExcept\n       @Override\n       public IndexWorker readObject(ObjectInput input) throws IOException, ClassNotFoundException {\n          String cacheName = (String) input.readObject();\n-         Class indexedClass = (Class) input.readObject();\n+         int typesSize = input.readInt();\n+         Set<IndexedTypeIdentifier> types = new HashSet<>(typesSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY0OTQ1Mg==", "bodyText": "TBH using or not initial capacity here is irrelevant: this Set will be generally small (< 10), and instances will  be created almost never", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398649452", "createdAt": "2020-03-26T15:10:24Z", "author": {"login": "gustavonalle"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -162,14 +172,19 @@ public void writeObject(ObjectOutput output, IndexWorker worker) throws IOExcept\n       @Override\n       public IndexWorker readObject(ObjectInput input) throws IOException, ClassNotFoundException {\n          String cacheName = (String) input.readObject();\n-         Class indexedClass = (Class) input.readObject();\n+         int typesSize = input.readInt();\n+         Set<IndexedTypeIdentifier> types = new HashSet<>(typesSize);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzNTM2OA=="}, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDY5Njg3OnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjozNDoxOFrOF8Et4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjozNDoxOFrOF8Et4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzNjE2Mw==", "bodyText": "The if (typesSize > 0)  is not needed, the for already guards against that.", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398536163", "createdAt": "2020-03-26T12:34:18Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -162,14 +172,19 @@ public void writeObject(ObjectOutput output, IndexWorker worker) throws IOExcept\n       @Override\n       public IndexWorker readObject(ObjectInput input) throws IOException, ClassNotFoundException {\n          String cacheName = (String) input.readObject();\n-         Class indexedClass = (Class) input.readObject();\n+         int typesSize = input.readInt();\n+         Set<IndexedTypeIdentifier> types = new HashSet<>(typesSize);\n+         if (typesSize > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDcwNjMxOnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjozNzowNFrOF8E0FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNDo1Njo1N1rOF8K9rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzNzc0OQ==", "bodyText": "Perfect timing to also sort out the TODO on line 76", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398537749", "createdAt": "2020-03-26T12:37:04Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -46,17 +47,17 @@\n public final class IndexWorker implements Function<EmbeddedCacheManager, Void> {\n \n    private final String cacheName;\n-   private final IndexedTypeIdentifier indexedType;\n+   private final Set<IndexedTypeIdentifier> indexedTypes;\n    private final boolean flush;\n    private final boolean clean;\n    private final boolean skipIndex;\n    private final boolean primaryOwner;\n    private final Set<Object> keys;\n \n-   IndexWorker(String cacheName, IndexedTypeIdentifier indexedType, boolean flush, boolean clean, boolean skipIndex,\n+   IndexWorker(String cacheName, Set<IndexedTypeIdentifier> indexedTypes, boolean flush, boolean clean, boolean skipIndex,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzODUwOA==", "bodyText": "I have upcoming PRs that will get rid of most of that cache decoration", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398638508", "createdAt": "2020-03-26T14:56:57Z", "author": {"login": "gustavonalle"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -46,17 +47,17 @@\n public final class IndexWorker implements Function<EmbeddedCacheManager, Void> {\n \n    private final String cacheName;\n-   private final IndexedTypeIdentifier indexedType;\n+   private final Set<IndexedTypeIdentifier> indexedTypes;\n    private final boolean flush;\n    private final boolean clean;\n    private final boolean skipIndex;\n    private final boolean primaryOwner;\n    private final Set<Object> keys;\n \n-   IndexWorker(String cacheName, IndexedTypeIdentifier indexedType, boolean flush, boolean clean, boolean skipIndex,\n+   IndexWorker(String cacheName, Set<IndexedTypeIdentifier> indexedTypes, boolean flush, boolean clean, boolean skipIndex,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzNzc0OQ=="}, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDcxNDA2OnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjozOTowN1rOF8E46A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNDo1Nzo1N1rOF8LAtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzODk4NA==", "bodyText": "When reading, this silently leads to null being transformed into empty set. Do we care?", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398538984", "createdAt": "2020-03-26T12:39:07Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -151,7 +153,15 @@ private Object extractValue(Object storageValue, DataConversion valueDataConvers\n       @Override\n       public void writeObject(ObjectOutput output, IndexWorker worker) throws IOException {\n          output.writeObject(worker.cacheName);\n-         output.writeObject(PojoIndexedTypeIdentifier.convertToLegacy(worker.indexedType));\n+         if (worker.indexedTypes == null) {\n+            output.writeInt(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYzOTI4NA==", "bodyText": "not really, when Re-indexing only a set of keys using the MassIndexer, the types are ignored", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398639284", "createdAt": "2020-03-26T14:57:57Z", "author": {"login": "gustavonalle"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -151,7 +153,15 @@ private Object extractValue(Object storageValue, DataConversion valueDataConvers\n       @Override\n       public void writeObject(ObjectOutput output, IndexWorker worker) throws IOException {\n          output.writeObject(worker.cacheName);\n-         output.writeObject(PojoIndexedTypeIdentifier.convertToLegacy(worker.indexedType));\n+         if (worker.indexedTypes == null) {\n+            output.writeInt(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzODk4NA=="}, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDcyODkxOnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo0Mjo1OVrOF8FCJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo0Mjo1OVrOF8FCJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0MTM0OQ==", "bodyText": "I think this TODO was just resolved \ud83d\ude01", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398541349", "createdAt": "2020-03-26T12:42:59Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/IndexWorker.java", "diffHunk": "@@ -103,8 +104,9 @@ public Void apply(EmbeddedCacheManager embeddedCacheManager) {\n                      value = wrapper.wrap(value);\n                   }\n                   //TODO do not use Class equality but refactor to type equality:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDc2Mzc4OnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/impl/massindex/DistributedExecutorMassIndexer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo1MTo0MlrOF8FXuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo1MTo0MlrOF8FXuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0Njg3Mg==", "bodyText": "This compositeFuture could be declared directly where it is used.", "url": "https://github.com/infinispan/infinispan/pull/8107#discussion_r398546872", "createdAt": "2020-03-26T12:51:42Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/DistributedExecutorMassIndexer.java", "diffHunk": "@@ -186,33 +186,32 @@ public boolean isRunning() {\n \n          BiConsumer<Void, Throwable> flushIfNeeded = (v, t) -> {\n             try {\n-               for (IndexedTypeIdentifier type : toFlush) {\n-                  indexUpdater.flush(type);\n-               }\n+               indexUpdater.flush(toFlush);\n             } finally {\n                lock.unlock();\n             }\n          };\n          CompletableFuture<Void> compositeFuture;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2c6751b97d1c98497b384b8f6ab90c59b283773"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4352, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}