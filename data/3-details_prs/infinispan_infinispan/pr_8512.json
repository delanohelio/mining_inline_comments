{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNjI3NTEy", "number": 8512, "title": "ISPN-12043 Shared stores should not have (add|remove)Segments methods\u2026", "bodyText": "\u2026 invoked\nhttps://issues.redhat.com/browse/ISPN-12043", "createdAt": "2020-06-26T14:46:56Z", "url": "https://github.com/infinispan/infinispan/pull/8512", "merged": true, "mergeCommit": {"oid": "0c112c5ec1c47b907ed6a15124b027738c054c15"}, "closed": true, "closedAt": "2020-06-26T19:23:29Z", "author": {"login": "wburns"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvEeDRAFqTQzODM2MjQ3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvGd71gBqjM0ODc0NDI5MTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MzYyNDc3", "url": "https://github.com/infinispan/infinispan/pull/8512#pullrequestreview-438362477", "createdAt": "2020-06-26T14:52:58Z", "commit": {"oid": "6f0e7f14a964a2a58025493a44849bc869ec8342"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f0e7f14a964a2a58025493a44849bc869ec8342", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/6f0e7f14a964a2a58025493a44849bc869ec8342", "committedDate": "2020-06-26T14:45:45Z", "message": "ISPN-12043 Shared stores should not have (add|remove)Segments methods invoked"}, "afterCommit": {"oid": "a6603ee642c0c2ea5af5fd5047bba2a52aec631f", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/a6603ee642c0c2ea5af5fd5047bba2a52aec631f", "committedDate": "2020-06-26T14:54:50Z", "message": "ISPN-12043 Shared stores should not have (add|remove)Segments methods invoked"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6603ee642c0c2ea5af5fd5047bba2a52aec631f", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/a6603ee642c0c2ea5af5fd5047bba2a52aec631f", "committedDate": "2020-06-26T14:54:50Z", "message": "ISPN-12043 Shared stores should not have (add|remove)Segments methods invoked"}, "afterCommit": {"oid": "0ab55c9b0bf6e15aee67d06661c6542e1882549c", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/0ab55c9b0bf6e15aee67d06661c6542e1882549c", "committedDate": "2020-06-26T14:55:29Z", "message": "ISPN-12043 Shared stores should not have (add|remove)Segments methods invoked"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4Mzg2MTg3", "url": "https://github.com/infinispan/infinispan/pull/8512#pullrequestreview-438386187", "createdAt": "2020-06-26T15:23:06Z", "commit": {"oid": "0ab55c9b0bf6e15aee67d06661c6542e1882549c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNToyNzozMVrOGplIXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNToyNzozMVrOGplIXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1MzE1MA==", "bodyText": "This seems wrong, just because a store is segmentable and shareable it doesn't mean in the config it's actually segmented or shared (as the method name implies).", "url": "https://github.com/infinispan/infinispan/pull/8512#discussion_r446253150", "createdAt": "2020-06-26T15:27:31Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/persistence/manager/PersistenceManagerImpl.java", "diffHunk": "@@ -219,16 +221,24 @@ public void start() {\n                availabilityTask = nonBlockingManager.scheduleWithFixedDelay(this::pollStoreAvailability, interval, interval, MILLISECONDS));\n          }\n \n-         storeStartup.doOnComplete(() -> lock.unlockWrite(stamp))\n-               // Blocks here waiting for stores and availability task to start if needed\n-               .blockingAwait();\n+         // Blocks here waiting for stores and availability task to start if needed\n+         storeStartup.blockingAwait();\n+         allSegmentedOrShared = allStoresSegmentedOrShared();\n       } catch (Throwable t) {\n          lock.unlockWrite(stamp);\n          log.debug(\"PersistenceManagerImpl encountered an exception during startup of stores\", t);\n          throw t;\n+      } finally {\n+         lock.unlockWrite(stamp);\n       }\n    }\n \n+   @GuardedBy(\"lock\")\n+   private boolean allStoresSegmentedOrShared() {\n+      return getStoreLocked(storeStatus -> !storeStatus.characteristics.contains(Characteristic.SEGMENTABLE) ||\n+            !storeStatus.characteristics.contains(Characteristic.SHAREABLE)) != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ab55c9b0bf6e15aee67d06661c6542e1882549c"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd1bb66a6957c21c80c42d45eac37255fc663413", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/bd1bb66a6957c21c80c42d45eac37255fc663413", "committedDate": "2020-06-26T17:12:29Z", "message": "ISPN-12043 Shared stores should not have (add|remove)Segments methods invoked"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ab55c9b0bf6e15aee67d06661c6542e1882549c", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/0ab55c9b0bf6e15aee67d06661c6542e1882549c", "committedDate": "2020-06-26T14:55:29Z", "message": "ISPN-12043 Shared stores should not have (add|remove)Segments methods invoked"}, "afterCommit": {"oid": "bd1bb66a6957c21c80c42d45eac37255fc663413", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/bd1bb66a6957c21c80c42d45eac37255fc663413", "committedDate": "2020-06-26T17:12:29Z", "message": "ISPN-12043 Shared stores should not have (add|remove)Segments methods invoked"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 480, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}