{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMjg1Njk2", "number": 7853, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMTozMjo1NFrODexSuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTo1NDoyOFrODf758g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNTkxNDgxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/util/concurrent/ConditionFuture.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMTozMjo1NFrOFoFrqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMzoxOToyNVrOFp2R6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4MDQ1OA==", "bodyText": "doesn't need to be synchronized as well? futures.values()", "url": "https://github.com/infinispan/infinispan/pull/7853#discussion_r377580458", "createdAt": "2020-02-11T11:32:54Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/util/concurrent/ConditionFuture.java", "diffHunk": "@@ -96,24 +99,31 @@ public void updateAsync(T value, Executor executor) {\n \n       try {\n          executor.execute(() -> checkConditions(value));\n-      } catch (Exception e) {\n+      } catch (Throwable t) {\n          for (Data data : futures.values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0136e8627521ac2008cfc31696823142e0bec225"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4MTMxNw==", "bodyText": "ps. same for stop()", "url": "https://github.com/infinispan/infinispan/pull/7853#discussion_r377581317", "createdAt": "2020-02-11T11:34:55Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/util/concurrent/ConditionFuture.java", "diffHunk": "@@ -96,24 +99,31 @@ public void updateAsync(T value, Executor executor) {\n \n       try {\n          executor.execute(() -> checkConditions(value));\n-      } catch (Exception e) {\n+      } catch (Throwable t) {\n          for (Data data : futures.values()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4MDQ1OA=="}, "originalCommit": {"oid": "0136e8627521ac2008cfc31696823142e0bec225"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQyNTI1OA==", "bodyText": "Done, good eyes Pedro!", "url": "https://github.com/infinispan/infinispan/pull/7853#discussion_r379425258", "createdAt": "2020-02-14T13:19:25Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/util/concurrent/ConditionFuture.java", "diffHunk": "@@ -96,24 +99,31 @@ public void updateAsync(T value, Executor executor) {\n \n       try {\n          executor.execute(() -> checkConditions(value));\n-      } catch (Exception e) {\n+      } catch (Throwable t) {\n          for (Data data : futures.values()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU4MDQ1OA=="}, "originalCommit": {"oid": "0136e8627521ac2008cfc31696823142e0bec225"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0ODEzMzg0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/util/concurrent/ConditionFuture.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTo1MzowMlrOFp7NSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTo1MzowMlrOFp7NSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUwNTk5NQ==", "bodyText": "@danberindei how about something like this to cut down on the sync scope?\n        final List<Data> copy;\n        synchronized (futures) {\n            copy = new ArrayList<>(futures.values());\n            futures.clear();\n        }\n        for (Data data : copy) {\n            data.cancelFuture.cancel(false);\n        }", "url": "https://github.com/infinispan/infinispan/pull/7853#discussion_r379505995", "createdAt": "2020-02-14T15:53:02Z", "author": {"login": "johnou"}, "path": "core/src/main/java/org/infinispan/util/concurrent/ConditionFuture.java", "diffHunk": "@@ -96,35 +99,58 @@ public void updateAsync(T value, Executor executor) {\n \n       try {\n          executor.execute(() -> checkConditions(value));\n-      } catch (Exception e) {\n-         for (Data data : futures.values()) {\n-            data.cancelFuture.cancel(false);\n-            data.completeExceptionally(e);\n+      } catch (Throwable t) {\n+         List<CompletableFuture<?>> completed;\n+         synchronized (futures) {\n+            completed = new ArrayList<>(futures.size());\n+            for (Data data : futures.values()) {\n+               data.cancelFuture.cancel(false);\n+               completed.add(data);\n+            }\n+         }\n+         for (CompletableFuture<?> future : completed) {\n+            future.completeExceptionally(t);\n          }\n       }\n    }\n \n    private void checkConditions(T value) {\n-      for (Iterator<Map.Entry<Predicate<T>, Data>> iterator = futures.entrySet().iterator(); iterator.hasNext(); ) {\n-         Map.Entry<Predicate<T>, Data> e = iterator.next();\n-         if (e.getKey().test(value)) {\n-            Data data = e.getValue();\n-            data.cancelFuture.cancel(false);\n-            data.complete(null);\n-            iterator.remove();\n+      List<Data> completed;\n+      synchronized (futures) {\n+         completed = new ArrayList<>(futures.size());\n+         for (Iterator<Map.Entry<Predicate<T>, Data>> iterator = futures.entrySet().iterator(); iterator.hasNext(); ) {\n+            Map.Entry<Predicate<T>, Data> e = iterator.next();\n+            if (e.getKey().test(value)) {\n+               Data data = e.getValue();\n+               data.cancelFuture.cancel(false);\n+               completed.add(data);\n+               iterator.remove();\n+            }\n          }\n       }\n+      for (Data data : completed) {\n+         data.complete(null);\n+      }\n    }\n \n    public void stop() {\n       running = false;\n       lastValue = null;\n+\n+      List<CompletableFuture<?>> completed;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1055267e6693e45bf9cd491458158e7a9a417f31"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0ODEzOTM4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/util/concurrent/ConditionFuture.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTo1NDoyOFrOFp7Qiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTo1NDoyOFrOFp7Qiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTUwNjgyNw==", "bodyText": "same sync optimisation can be applied here too.", "url": "https://github.com/infinispan/infinispan/pull/7853#discussion_r379506827", "createdAt": "2020-02-14T15:54:28Z", "author": {"login": "johnou"}, "path": "core/src/main/java/org/infinispan/util/concurrent/ConditionFuture.java", "diffHunk": "@@ -96,35 +99,58 @@ public void updateAsync(T value, Executor executor) {\n \n       try {\n          executor.execute(() -> checkConditions(value));\n-      } catch (Exception e) {\n-         for (Data data : futures.values()) {\n-            data.cancelFuture.cancel(false);\n-            data.completeExceptionally(e);\n+      } catch (Throwable t) {\n+         List<CompletableFuture<?>> completed;\n+         synchronized (futures) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1055267e6693e45bf9cd491458158e7a9a417f31"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4562, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}