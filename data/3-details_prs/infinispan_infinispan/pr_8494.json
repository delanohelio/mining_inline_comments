{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MjkxNjMz", "number": 8494, "title": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor", "bodyText": "https://issues.redhat.com/browse/ISPN-12029", "createdAt": "2020-06-19T20:54:11Z", "url": "https://github.com/infinispan/infinispan/pull/8494", "merged": true, "mergeCommit": {"oid": "52266aa1e32bbea365969ac7c62f206ea63eaed9"}, "closed": true, "closedAt": "2020-07-23T13:24:15Z", "author": {"login": "wburns"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctWeeEAFqTQzNDQ3NDMyMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3vcmxAFqTQ1NDEzMDAzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDc0MzIy", "url": "https://github.com/infinispan/infinispan/pull/8494#pullrequestreview-434474322", "createdAt": "2020-06-21T06:40:15Z", "commit": {"oid": "8a513061b1650c3294479f627eda1d5772d80afe"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwNjo0MToxMVrOGmqBuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMVQwNjo0MzoyMVrOGmqCQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4NzY0MQ==", "bodyText": "I suggest renaming BlockingThreadPoolExecutorFactory, using it only on the nonBlocking path looks weird.", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r443187641", "createdAt": "2020-06-21T06:41:11Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/factories/threads/CoreExecutorFactory.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.infinispan.factories.threads;\n+\n+import java.util.concurrent.ExecutorService;\n+\n+import org.infinispan.commons.executors.BlockingThreadPoolExecutorFactory;\n+import org.infinispan.commons.executors.ThreadPoolExecutorFactory;\n+\n+public class CoreExecutorFactory {\n+   private CoreExecutorFactory() { }\n+\n+   public static ThreadPoolExecutorFactory<? extends ExecutorService> executorFactory(int maxThreads, int coreThreads,\n+         int queueLength, long keepAlive, boolean nonBlocking) {\n+      if (nonBlocking) {\n+         return new BlockingThreadPoolExecutorFactory(maxThreads, coreThreads, queueLength, keepAlive, nonBlocking);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a513061b1650c3294479f627eda1d5772d80afe"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE4Nzc3Nw==", "bodyText": "Couldn't you make BlockingRejectedExecutionHandler implement Executor?", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r443187777", "createdAt": "2020-06-21T06:43:21Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/factories/threads/EnhancedQueueExecutorFactory.java", "diffHunk": "@@ -0,0 +1,92 @@\n+package org.infinispan.factories.threads;\n+\n+import static org.infinispan.commons.logging.Log.CONFIG;\n+\n+import java.time.Duration;\n+import java.time.temporal.ChronoUnit;\n+import java.util.concurrent.ThreadFactory;\n+\n+import org.infinispan.commons.executors.BlockingResource;\n+import org.infinispan.commons.executors.BlockingThreadPoolExecutorFactory;\n+import org.infinispan.commons.executors.ThreadPoolExecutorFactory;\n+import org.infinispan.commons.util.concurrent.BlockingRejectedExecutionHandler;\n+import org.jboss.threads.EnhancedQueueExecutor;\n+import org.jboss.threads.management.ManageableThreadPoolExecutorService;\n+\n+public class EnhancedQueueExecutorFactory implements ThreadPoolExecutorFactory<ManageableThreadPoolExecutorService> {\n+   private final int maxThreads;\n+   private final int coreThreads;\n+   private final int queueLength;\n+   private final long keepAlive;\n+\n+   public EnhancedQueueExecutorFactory(int maxThreads, int coreThreads, int queueLength, long keepAlive, boolean nonBlocking) {\n+      if (nonBlocking) {\n+         throw new UnsupportedOperationException(\"EnhancedQueryExecutorFactory only supports blocking threads currently!\");\n+      }\n+      this.maxThreads = maxThreads;\n+      this.coreThreads = coreThreads;\n+      this.queueLength = queueLength;\n+      this.keepAlive = keepAlive;\n+   }\n+\n+   public int maxThreads() {\n+      return maxThreads;\n+   }\n+\n+   public int coreThreads() {\n+      return coreThreads;\n+   }\n+\n+   public int queueLength() {\n+      return queueLength;\n+   }\n+\n+   public long keepAlive() {\n+      return keepAlive;\n+   }\n+\n+   public static EnhancedQueueExecutorFactory create(int maxThreads, int queueSize, boolean nonBlocking) {\n+      int coreThreads = queueSize == 0 ? 1 : maxThreads;\n+      return new EnhancedQueueExecutorFactory(maxThreads, coreThreads, queueSize,\n+            BlockingThreadPoolExecutorFactory.DEFAULT_KEEP_ALIVE_MILLIS, nonBlocking);\n+   }\n+\n+   @Override\n+   public ManageableThreadPoolExecutorService createExecutor(ThreadFactory factory) {\n+      if (!(factory instanceof BlockingResource)) {\n+         throw new IllegalStateException(\"Executor factory configured to be blocking and received a thread\" +\n+               \" factory that doesn't create blocking threads!\");\n+      }\n+      EnhancedQueueExecutor.Builder builder = new EnhancedQueueExecutor.Builder();\n+      builder.setThreadFactory(factory);\n+      builder.setCorePoolSize(coreThreads);\n+      builder.setMaximumPoolSize(maxThreads);\n+      builder.setGrowthResistance(0.0f);\n+      builder.setMaximumQueueSize(queueLength);\n+      builder.setKeepAliveTime(Duration.of(keepAlive, ChronoUnit.MILLIS));\n+\n+      EnhancedQueueExecutor enhancedQueueExecutor = builder.build();\n+      enhancedQueueExecutor.setHandoffExecutor(task ->\n+         BlockingRejectedExecutionHandler.getInstance().rejectedExecution(task, enhancedQueueExecutor));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a513061b1650c3294479f627eda1d5772d80afe"}, "originalPosition": 70}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a513061b1650c3294479f627eda1d5772d80afe", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/8a513061b1650c3294479f627eda1d5772d80afe", "committedDate": "2020-06-19T20:53:41Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}, "afterCommit": {"oid": "1d23869935a57b9b8396026a1631f484c09e1ca9", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/1d23869935a57b9b8396026a1631f484c09e1ca9", "committedDate": "2020-06-22T03:32:31Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d23869935a57b9b8396026a1631f484c09e1ca9", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/1d23869935a57b9b8396026a1631f484c09e1ca9", "committedDate": "2020-06-22T03:32:31Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}, "afterCommit": {"oid": "e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "committedDate": "2020-06-22T14:55:08Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "378722a09b3e943a8acb193ddc52ebacc918c885", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/378722a09b3e943a8acb193ddc52ebacc918c885", "committedDate": "2020-06-23T09:20:12Z", "message": "Add org.jboss.threads module dependency"}, "afterCommit": {"oid": "e505af6c34d9e1598511e8aeacca1f54aecc297c", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/e505af6c34d9e1598511e8aeacca1f54aecc297c", "committedDate": "2020-06-23T09:21:37Z", "message": "Add org.jboss.threads module dependency"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e505af6c34d9e1598511e8aeacca1f54aecc297c", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/e505af6c34d9e1598511e8aeacca1f54aecc297c", "committedDate": "2020-06-23T09:21:37Z", "message": "Add org.jboss.threads module dependency"}, "afterCommit": {"oid": "e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "committedDate": "2020-06-22T14:55:08Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/e1e35da1f2cc76e072ed181ac8ee3509f088e22e", "committedDate": "2020-06-22T14:55:08Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}, "afterCommit": {"oid": "95d26e86bbfead09eb1ddab5179abfc82974bbcd", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/95d26e86bbfead09eb1ddab5179abfc82974bbcd", "committedDate": "2020-06-23T14:48:28Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95d26e86bbfead09eb1ddab5179abfc82974bbcd", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/95d26e86bbfead09eb1ddab5179abfc82974bbcd", "committedDate": "2020-06-23T14:48:28Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}, "afterCommit": {"oid": "9ff2f79db1dd2dd63138dbe173e186651af029e9", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/9ff2f79db1dd2dd63138dbe173e186651af029e9", "committedDate": "2020-06-26T16:15:29Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ff2f79db1dd2dd63138dbe173e186651af029e9", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/9ff2f79db1dd2dd63138dbe173e186651af029e9", "committedDate": "2020-06-26T16:15:29Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}, "afterCommit": {"oid": "e3dea202389124f2693226f3fc3c9462861a359d", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/e3dea202389124f2693226f3fc3c9462861a359d", "committedDate": "2020-06-26T16:35:39Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDUxMzE4", "url": "https://github.com/infinispan/infinispan/pull/8494#pullrequestreview-438451318", "createdAt": "2020-06-26T16:55:13Z", "commit": {"oid": "e3dea202389124f2693226f3fc3c9462861a359d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NTQwNTA1", "url": "https://github.com/infinispan/infinispan/pull/8494#pullrequestreview-438540505", "createdAt": "2020-06-26T19:22:21Z", "commit": {"oid": "6194c87f03721bf7aba0617b82a60aa6fe2397b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxOToyMjoyMVrOGpsJag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxOToyMjoyMVrOGpsJag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM2ODEwNg==", "bodyText": "Should be private, TestNG thinks it's a test method\nhttps://ci.infinispan.org/job/Infinispan/job/PR-8494/13/testReport/junit/org.infinispan.query.remote.impl/ProtobufMetadataManagerInterceptorTest/waitForNoLocks/", "url": "https://github.com/infinispan/infinispan/pull/8494#discussion_r446368106", "createdAt": "2020-06-26T19:22:21Z", "author": {"login": "danberindei"}, "path": "remote-query/remote-query-server/src/test/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptorTest.java", "diffHunk": "@@ -318,7 +319,22 @@ public void testStateTransfer() {\n \n    private void assertNoTransactionsAndLocks() {\n       assertNoTransactions();\n-      TestingUtil.assertNoLocks(cache(0));\n-      TestingUtil.assertNoLocks(cache(1));\n+      waitForNoLocks(cache(0));\n+      waitForNoLocks(cache(1));\n+   }\n+\n+   public void waitForNoLocks(Cache<?, ?> cache) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6194c87f03721bf7aba0617b82a60aa6fe2397b6"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6194c87f03721bf7aba0617b82a60aa6fe2397b6", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/6194c87f03721bf7aba0617b82a60aa6fe2397b6", "committedDate": "2020-06-26T17:32:29Z", "message": "Test should wait for locks to be removed after commit completed"}, "afterCommit": {"oid": "125fc215b7d86300a65c6ea433639332eb627080", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/125fc215b7d86300a65c6ea433639332eb627080", "committedDate": "2020-07-13T14:34:49Z", "message": "add in explicit jboss threads to feature-pack"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "125fc215b7d86300a65c6ea433639332eb627080", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/125fc215b7d86300a65c6ea433639332eb627080", "committedDate": "2020-07-13T14:34:49Z", "message": "add in explicit jboss threads to feature-pack"}, "afterCommit": {"oid": "2d3598ea3b1f368b8aa547cc173c3f678c776285", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/2d3598ea3b1f368b8aa547cc173c3f678c776285", "committedDate": "2020-07-14T13:34:54Z", "message": "revert upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81559170c74cb8f37455f9882a402dbd2c139d19", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/81559170c74cb8f37455f9882a402dbd2c139d19", "committedDate": "2020-07-17T15:07:08Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d3598ea3b1f368b8aa547cc173c3f678c776285", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/2d3598ea3b1f368b8aa547cc173c3f678c776285", "committedDate": "2020-07-14T13:34:54Z", "message": "revert upgrade"}, "afterCommit": {"oid": "81559170c74cb8f37455f9882a402dbd2c139d19", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/81559170c74cb8f37455f9882a402dbd2c139d19", "committedDate": "2020-07-17T15:07:08Z", "message": "ISPN-12029 Replace Blocking Executor with an EnhancedQueueExecutor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MTMwMDM2", "url": "https://github.com/infinispan/infinispan/pull/8494#pullrequestreview-454130036", "createdAt": "2020-07-23T13:28:42Z", "commit": {"oid": "81559170c74cb8f37455f9882a402dbd2c139d19"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 636, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}