{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMzQ5MjIz", "number": 7856, "title": "ISPN-11298 Create TakeOfflineManager", "bodyText": "https://issues.redhat.com/browse/ISPN-11298\nMoves the code that takes sites offline from BackupSender to TakeOfflineManager.", "createdAt": "2020-02-07T10:48:22Z", "url": "https://github.com/infinispan/infinispan/pull/7856", "merged": true, "mergeCommit": {"oid": "ed1fd4f6aed4d920f016faf5db3760c9175d3e94"}, "closed": true, "closedAt": "2020-02-28T16:05:09Z", "author": {"login": "pruivo"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDnmU-gBqjMwMzExMzUwMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIwN1lABqjMwODIwMDMyNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d475dbf8d513fe755218afed5d5a076408343b2", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/0d475dbf8d513fe755218afed5d5a076408343b2", "committedDate": "2020-02-07T10:46:23Z", "message": "ISPN-11298 Create TakeOfflineManager"}, "afterCommit": {"oid": "37afdc1676089509e2f0af4d41e2e82169dea691", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/37afdc1676089509e2f0af4d41e2e82169dea691", "committedDate": "2020-02-12T14:55:54Z", "message": "ISPN-11298 Create TakeOfflineManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37afdc1676089509e2f0af4d41e2e82169dea691", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/37afdc1676089509e2f0af4d41e2e82169dea691", "committedDate": "2020-02-12T14:55:54Z", "message": "ISPN-11298 Create TakeOfflineManager"}, "afterCommit": {"oid": "d998b66a779075461ded2a418bcfe3a11ffebfbf", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/d998b66a779075461ded2a418bcfe3a11ffebfbf", "committedDate": "2020-02-17T12:00:21Z", "message": "ISPN-11298 Create TakeOfflineManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d998b66a779075461ded2a418bcfe3a11ffebfbf", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/d998b66a779075461ded2a418bcfe3a11ffebfbf", "committedDate": "2020-02-17T12:00:21Z", "message": "ISPN-11298 Create TakeOfflineManager"}, "afterCommit": {"oid": "e4f20314da119a732d491b66556d0ea596b26ef0", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/e4f20314da119a732d491b66556d0ea596b26ef0", "committedDate": "2020-02-19T18:21:44Z", "message": "ISPN-11298 Create TakeOfflineManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4f20314da119a732d491b66556d0ea596b26ef0", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/e4f20314da119a732d491b66556d0ea596b26ef0", "committedDate": "2020-02-19T18:21:44Z", "message": "ISPN-11298 Create TakeOfflineManager"}, "afterCommit": {"oid": "96d31da979dd054cc580e7819a3eabed4916487d", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/96d31da979dd054cc580e7819a3eabed4916487d", "committedDate": "2020-02-21T16:09:39Z", "message": "ISPN-11298 Create TakeOfflineManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96d31da979dd054cc580e7819a3eabed4916487d", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/96d31da979dd054cc580e7819a3eabed4916487d", "committedDate": "2020-02-21T16:09:39Z", "message": "ISPN-11298 Create TakeOfflineManager"}, "afterCommit": {"oid": "24e0c7565c567f66a58f4abf89ed5703d757542c", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/24e0c7565c567f66a58f4abf89ed5703d757542c", "committedDate": "2020-02-24T17:58:12Z", "message": "ISPN-11298 Create TakeOfflineManager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MjQzNjk5", "url": "https://github.com/infinispan/infinispan/pull/7856#pullrequestreview-366243699", "createdAt": "2020-02-28T08:59:31Z", "commit": {"oid": "24e0c7565c567f66a58f4abf89ed5703d757542c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwODo1OTozMVrOFvtu_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwOTowNDozMVrOFvt24A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3NjcwMw==", "bodyText": "Old Javadoc?", "url": "https://github.com/infinispan/infinispan/pull/7856#discussion_r385576703", "createdAt": "2020-02-28T08:59:31Z", "author": {"login": "ryanemerson"}, "path": "core/src/main/java/org/infinispan/xsite/status/TakeOfflineManager.java", "diffHunk": "@@ -0,0 +1,95 @@\n+package org.infinispan.xsite.status;\n+\n+import java.util.Map;\n+\n+import org.infinispan.configuration.cache.TakeOfflineConfiguration;\n+import org.infinispan.configuration.cache.TakeOfflineConfigurationBuilder;\n+import org.infinispan.remoting.transport.XSiteResponse;\n+\n+/**\n+ * It keeps tracks of cross-site requests to take sites offline when certain failures conditions happen.\n+ * <p>\n+ * Those condition are configured in {@link TakeOfflineConfiguration}.\n+ *\n+ * @author Pedro Ruivo\n+ * @since 11.0\n+ */\n+public interface TakeOfflineManager {\n+\n+   /**\n+    * Registers a cross-site request made.\n+    * <p>\n+    * Handles the response for the request and takes action in case of failure.\n+    *\n+    * @param response The cross-site response.\n+    */\n+   void registerRequest(XSiteResponse response);\n+\n+   /**\n+    * Returns the site state for site {@code siteName}.\n+    * <p>\n+    * The site can be {@link SiteState#ONLINE} or {@link SiteState#OFFLINE}. If it doesn't exist, {@link\n+    * SiteState#NOT_FOUND} is returned.\n+    *\n+    * @param siteName The remote site name.\n+    * @return The {@link SiteState}.\n+    */\n+   SiteState getSiteState(String siteName);\n+\n+   /**\n+    * It changes the {@link TakeOfflineConfiguration} for site {@code siteName}.\n+    * <p>\n+    * If the {@code siteName} doesn't exist, this method is a no-op.\n+    *\n+    * @param siteName      The remote site name.\n+    * @param afterFailures The new {@link TakeOfflineConfigurationBuilder#afterFailures(int)} or {@code null} for no\n+    *                      changes.\n+    * @param minTimeToWait The new {@link TakeOfflineConfigurationBuilder#minTimeToWait(long)} or {@code null} for no\n+    *                      changes.\n+    */\n+   void amendConfiguration(String siteName, Integer afterFailures, Long minTimeToWait);\n+\n+   /**\n+    * It returns the current {@link TakeOfflineConfiguration} for site {@code siteName}.\n+    *\n+    * @param siteName The remote site name.\n+    * @return The current {@link TakeOfflineConfiguration} or {@code null} if the site {@code siteName} doesn't exist.\n+    */\n+   TakeOfflineConfiguration getConfiguration(String siteName);\n+\n+   /**\n+    * It returns a {@link Map} with the sites name and their state (Online or Offline).\n+    * <p>\n+    * If a site is online, then its value is {@link Boolean#TRUE}, otherwise is {@link Boolean#FALSE}.\n+    *\n+    * @return A {@link Map} with the site state.\n+    */\n+   Map<String, Boolean> status();\n+\n+   /*\n+    * Brings a site with the given name back online.\n+    */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24e0c7565c567f66a58f4abf89ed5703d757542c"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3ODcyMA==", "bodyText": "Why do we no need to register the request when we didn't before? AFAICT, there was no call to XSiteResponse#whenCompleted previously", "url": "https://github.com/infinispan/infinispan/pull/7856#discussion_r385578720", "createdAt": "2020-02-28T09:04:31Z", "author": {"login": "ryanemerson"}, "path": "core/src/main/java/org/infinispan/xsite/BackupSenderImpl.java", "diffHunk": "@@ -244,21 +173,18 @@ private void sendTo(XSiteReplicateCommand command, Collection<XSiteBackup> xSite\n       if (rpcManager == null) {\n          for (XSiteBackup backup : xSiteBackups) {\n             XSiteResponse cs = transport.backupRemotely(backup, command);\n+            takeOfflineManager.registerRequest(cs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24e0c7565c567f66a58f4abf89ed5703d757542c"}, "originalPosition": 143}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24e0c7565c567f66a58f4abf89ed5703d757542c", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/24e0c7565c567f66a58f4abf89ed5703d757542c", "committedDate": "2020-02-24T17:58:12Z", "message": "ISPN-11298 Create TakeOfflineManager"}, "afterCommit": {"oid": "efd1072c262af938910adc770575c5025865ae44", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/efd1072c262af938910adc770575c5025865ae44", "committedDate": "2020-02-28T09:23:49Z", "message": "ISPN-11298 Create TakeOfflineManager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3049645aaa7c9e75aba1f8483ce5668b3d29b435", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/3049645aaa7c9e75aba1f8483ce5668b3d29b435", "committedDate": "2020-02-28T13:47:53Z", "message": "ISPN-11298 Create TakeOfflineManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efd1072c262af938910adc770575c5025865ae44", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/efd1072c262af938910adc770575c5025865ae44", "committedDate": "2020-02-28T09:23:49Z", "message": "ISPN-11298 Create TakeOfflineManager"}, "afterCommit": {"oid": "3049645aaa7c9e75aba1f8483ce5668b3d29b435", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/3049645aaa7c9e75aba1f8483ce5668b3d29b435", "committedDate": "2020-02-28T13:47:53Z", "message": "ISPN-11298 Create TakeOfflineManager"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1309, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}