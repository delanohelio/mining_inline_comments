{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MTE4NTM5", "number": 8109, "title": "StatefulSet Integration Test", "bodyText": "https://issues.redhat.com/browse/ISPN-11527\nhttps://issues.redhat.com/browse/ISPN-11537\nhttps://issues.redhat.com/browse/ISPN-11538\nhttps://issues.redhat.com/browse/ISPN-11582\nI'll create a backport PR once this has been merged.\nThe clustered locks changed was required as previously it was not cleaning up it's resource and was blocking shutdown via sigterm.\nISPN-11538 should probably be 11.x only.", "createdAt": "2020-03-26T11:42:45Z", "url": "https://github.com/infinispan/infinispan/pull/8109", "merged": true, "mergeCommit": {"oid": "95fd43e8704f9f52832d14c6ca749332182a8890"}, "closed": true, "closedAt": "2020-04-03T15:49:09Z", "author": {"login": "ryanemerson"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRciyYABqjMxNjgzNzA5MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUE6QQgFqTM4NjI4MTcxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "799f7e18bd2f581d824df54801473521dd7c91dc", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/799f7e18bd2f581d824df54801473521dd7c91dc", "committedDate": "2020-03-26T12:05:20Z", "message": "ISPN-11537 Always launch the server process in the background"}, "afterCommit": {"oid": "b9a6ebed901a012d2b4b80a72e1f55de0c8a36a6", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/b9a6ebed901a012d2b4b80a72e1f55de0c8a36a6", "committedDate": "2020-03-26T13:47:59Z", "message": "ISPN-11537 Always launch the server process in the background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9a6ebed901a012d2b4b80a72e1f55de0c8a36a6", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/b9a6ebed901a012d2b4b80a72e1f55de0c8a36a6", "committedDate": "2020-03-26T13:47:59Z", "message": "ISPN-11537 Always launch the server process in the background"}, "afterCommit": {"oid": "701fd98de5922ef366708633ca33f8356fcc98d7", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/701fd98de5922ef366708633ca33f8356fcc98d7", "committedDate": "2020-03-26T14:01:35Z", "message": "ISPN-11537 Always launch the server process in the background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "701fd98de5922ef366708633ca33f8356fcc98d7", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/701fd98de5922ef366708633ca33f8356fcc98d7", "committedDate": "2020-03-26T14:01:35Z", "message": "ISPN-11537 Always launch the server process in the background"}, "afterCommit": {"oid": "5a1683fc8d52acc3a219c114b7ed912368881ff8", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/5a1683fc8d52acc3a219c114b7ed912368881ff8", "committedDate": "2020-03-26T14:03:16Z", "message": "ISPN-11537 Always launch the server process in the background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a1683fc8d52acc3a219c114b7ed912368881ff8", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/5a1683fc8d52acc3a219c114b7ed912368881ff8", "committedDate": "2020-03-26T14:03:16Z", "message": "ISPN-11537 Always launch the server process in the background"}, "afterCommit": {"oid": "2b28d8e807f57d944333f1534f8bb4211004c863", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/2b28d8e807f57d944333f1534f8bb4211004c863", "committedDate": "2020-03-26T16:26:49Z", "message": "ISPN-11537 Always launch the server process in the background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b28d8e807f57d944333f1534f8bb4211004c863", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/2b28d8e807f57d944333f1534f8bb4211004c863", "committedDate": "2020-03-26T16:26:49Z", "message": "ISPN-11537 Always launch the server process in the background"}, "afterCommit": {"oid": "6e616bc45c6943a9ff91d503bf62c304ea2d40cc", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/6e616bc45c6943a9ff91d503bf62c304ea2d40cc", "committedDate": "2020-03-26T17:25:49Z", "message": "ISPN-11538 Always launch the server process in the background"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e616bc45c6943a9ff91d503bf62c304ea2d40cc", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/6e616bc45c6943a9ff91d503bf62c304ea2d40cc", "committedDate": "2020-03-26T17:25:49Z", "message": "ISPN-11538 Always launch the server process in the background"}, "afterCommit": {"oid": "462d8c4f3098fff18ede53198e77f4ef23ede29f", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/462d8c4f3098fff18ede53198e77f4ef23ede29f", "committedDate": "2020-03-27T09:33:06Z", "message": "ISPN-11538 Always launch the server process in the background"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMDc1MDA2", "url": "https://github.com/infinispan/infinispan/pull/8109#pullrequestreview-383075006", "createdAt": "2020-03-27T17:45:14Z", "commit": {"oid": "d6bfc402b475da30df73a2b700bf4573f9123545"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNzo0NToxNFrOF87vGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNzo0NToxNFrOF87vGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQzNzU5Mg==", "bodyText": "we want this ?", "url": "https://github.com/infinispan/infinispan/pull/8109#discussion_r399437592", "createdAt": "2020-03-27T17:45:14Z", "author": {"login": "karesti"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -318,6 +329,16 @@ public void kill(int server) {\n       Exceptions.unchecked(() -> containers.get(server).execInContainer(INFINISPAN_SERVER_HOME + \"/bin/kill.sh\"));\n    }\n \n+   // TODO should this just replace stop?\n+   public void sigterm(int server) {\n+      GenericContainer container = containers.get(server);\n+      CountdownLatchLoggingConsumer latch = new CountdownLatchLoggingConsumer(1, SHUTDOWN_MESSAGE_REGEX);\n+      container.withLogConsumer(latch);\n+      Container.ExecResult result = Exceptions.unchecked(() -> container.execInContainer(INFINISPAN_SERVER_HOME + \"/bin/term.sh\"));\n+      System.out.printf(\"[%d] TERM %s\\n\", server, result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6bfc402b475da30df73a2b700bf4573f9123545"}, "originalPosition": 103}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "462d8c4f3098fff18ede53198e77f4ef23ede29f", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/462d8c4f3098fff18ede53198e77f4ef23ede29f", "committedDate": "2020-03-27T09:33:06Z", "message": "ISPN-11538 Always launch the server process in the background"}, "afterCommit": {"oid": "f8d0502d76dc1e0f388bc9614fbef480e233b4e2", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/f8d0502d76dc1e0f388bc9614fbef480e233b4e2", "committedDate": "2020-04-01T14:43:11Z", "message": "ISPN-11582 Use pgrep instead of jps for server resilience tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8d0502d76dc1e0f388bc9614fbef480e233b4e2", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/f8d0502d76dc1e0f388bc9614fbef480e233b4e2", "committedDate": "2020-04-01T14:43:11Z", "message": "ISPN-11582 Use pgrep instead of jps for server resilience tests"}, "afterCommit": {"oid": "07c75513354f987ec7b71cf2c0e677ac8d891b4a", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/07c75513354f987ec7b71cf2c0e677ac8d891b4a", "committedDate": "2020-04-01T16:28:16Z", "message": "ISPN-11582 Use pgrep instead of jps for server resilience tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2Mjc2OTg5", "url": "https://github.com/infinispan/infinispan/pull/8109#pullrequestreview-386276989", "createdAt": "2020-04-02T09:58:58Z", "commit": {"oid": "07c75513354f987ec7b71cf2c0e677ac8d891b4a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOTo1ODo1OVrOF_kAVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwOTo1ODo1OVrOF_kAVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE5NDUxOQ==", "bodyText": "You have lost the visualvm.display.name", "url": "https://github.com/infinispan/infinispan/pull/8109#discussion_r402194519", "createdAt": "2020-04-02T09:58:59Z", "author": {"login": "tristantarrant"}, "path": "server/runtime/src/main/server/bin/server.sh", "diffHunk": "@@ -11,52 +11,43 @@ DIRNAME=`dirname \"$0\"`\n . \"$DIRNAME/common.sh\"\n \n while true; do\n-   if [ \"x$LAUNCH_ISPN_IN_BACKGROUND\" = \"x\" ]; then\n-      # Execute the JVM in the foreground\n-      eval \\\"$JAVA\\\" $JAVA_OPTS \\\n-         -Dvisualvm.display.name=$PROCESS_NAME \\\n-         -Dinfinispan.server.home.path=\\\"\"$ISPN_HOME\"\\\" \\\n-         -classpath \\\"\"$CLASSPATH\"\\\" \"$LOADER_CLASS\" \"$MAIN_CLASS\" \"$ARGUMENTS\"\n-      ISPN_STATUS=$?\n-   else\n-      # Execute the JVM in the background\n-      eval \\\"$JAVA\\\" $JAVA_OPTS \\\n-         -Djava.util.logging.manager=org.apache.logging.log4j.jul.LogManager \\\n-         -Dinfinispan.server.home.path=\\\"\"$ISPN_HOME\"\\\" \\\n-         -classpath \\\"\"$CLASSPATH\"\\\" \"$LOADER_CLASS\" \"$MAIN_CLASS\" \"$ARGUMENTS\" \"&\"\n-      ISPN_PID=$!\n-      # Trap common signals and relay them to the server process\n-      trap \"kill -HUP  $ISPN_PID\" HUP\n-      trap \"kill -TERM $ISPN_PID\" INT\n-      trap \"kill -QUIT $ISPN_PID\" QUIT\n-      trap \"kill -PIPE $ISPN_PID\" PIPE\n-      trap \"kill -TERM $ISPN_PID\" TERM\n-      if [ \"x$ISPN_PIDFILE\" != \"x\" ]; then\n-        echo $ISPN_PID > $ISPN_PIDFILE\n+   # Execute the JVM in the background\n+   eval \\\"$JAVA\\\" $JAVA_OPTS \\\n+      -Djava.util.logging.manager=org.apache.logging.log4j.jul.LogManager \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c75513354f987ec7b71cf2c0e677ac8d891b4a"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7cc3e0302d28baddb17dc4f3e61b4c1c027ecaf", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/e7cc3e0302d28baddb17dc4f3e61b4c1c027ecaf", "committedDate": "2020-04-02T11:11:49Z", "message": "ISPN-11527 Lazily start locks cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3757053d26c36a9f2eef419bdaffcff66c8d41e", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/c3757053d26c36a9f2eef419bdaffcff66c8d41e", "committedDate": "2020-04-02T11:11:49Z", "message": "ISPN-11537 Add StatefulSet rolling upgrade server integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f8837672ee0884d635e52a72f10885ba9468ad1", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/4f8837672ee0884d635e52a72f10885ba9468ad1", "committedDate": "2020-04-02T11:11:49Z", "message": "ISPN-11537 Parameterize StatefulSetRollingUpgradeIT cluster size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cec0b37e4894c7e6749403852abb6ac329d36f7c", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/cec0b37e4894c7e6749403852abb6ac329d36f7c", "committedDate": "2020-04-02T11:11:49Z", "message": "ISPN-11537 Add more details to endpoint trace logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d0050bb9a157b3ea358aee79d1b2e51fd3d8520", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/0d0050bb9a157b3ea358aee79d1b2e51fd3d8520", "committedDate": "2020-04-02T11:13:03Z", "message": "ISPN-11538 Always launch the server process in the background"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96fa095b124155861a70050a84f8a7aadcfc30c7", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/96fa095b124155861a70050a84f8a7aadcfc30c7", "committedDate": "2020-04-02T11:13:03Z", "message": "ISPN-11582 Use pgrep instead of jps for server resilience tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07c75513354f987ec7b71cf2c0e677ac8d891b4a", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/07c75513354f987ec7b71cf2c0e677ac8d891b4a", "committedDate": "2020-04-01T16:28:16Z", "message": "ISPN-11582 Use pgrep instead of jps for server resilience tests"}, "afterCommit": {"oid": "96fa095b124155861a70050a84f8a7aadcfc30c7", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/96fa095b124155861a70050a84f8a7aadcfc30c7", "committedDate": "2020-04-02T11:13:03Z", "message": "ISPN-11582 Use pgrep instead of jps for server resilience tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MjgxNzE5", "url": "https://github.com/infinispan/infinispan/pull/8109#pullrequestreview-386281719", "createdAt": "2020-04-02T10:05:41Z", "commit": {"oid": "07c75513354f987ec7b71cf2c0e677ac8d891b4a"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMDowNTo0MVrOF_kPXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNzoyNToyNFrOGAfi8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE5ODM2NQ==", "bodyText": "Nitpicking: I'd put @Inject on the same line when there's no component name, and remove the empty lines.", "url": "https://github.com/infinispan/infinispan/pull/8109#discussion_r402198365", "createdAt": "2020-04-02T10:05:41Z", "author": {"login": "danberindei"}, "path": "lock/src/main/java/org/infinispan/lock/impl/manager/EmbeddedClusteredLockManager.java", "diffHunk": "@@ -48,56 +50,76 @@\n    public static final String IS_LOCKED = \"isLocked\";\n \n    private final ConcurrentHashMap<String, ClusteredLock> locks = new ConcurrentHashMap<>();\n-   private final CompletableFuture<CacheHolder> cacheHolderFuture;\n    private final ClusteredLockManagerConfiguration config;\n-   private ScheduledExecutorService scheduledExecutorService;\n-   private Executor executor;\n+   private volatile boolean started = false;\n+\n+   @Inject", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c75513354f987ec7b71cf2c0e677ac8d891b4a"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE5OTE0MA==", "bodyText": "BasicComponentRegistryImpl already logs component start/stop at trace level", "url": "https://github.com/infinispan/infinispan/pull/8109#discussion_r402199140", "createdAt": "2020-04-02T10:07:06Z", "author": {"login": "danberindei"}, "path": "lock/src/main/java/org/infinispan/lock/impl/manager/EmbeddedClusteredLockManager.java", "diffHunk": "@@ -48,56 +50,76 @@\n    public static final String IS_LOCKED = \"isLocked\";\n \n    private final ConcurrentHashMap<String, ClusteredLock> locks = new ConcurrentHashMap<>();\n-   private final CompletableFuture<CacheHolder> cacheHolderFuture;\n    private final ClusteredLockManagerConfiguration config;\n-   private ScheduledExecutorService scheduledExecutorService;\n-   private Executor executor;\n+   private volatile boolean started = false;\n+\n+   @Inject\n+   EmbeddedCacheManager cacheManager;\n+\n+   @Inject @ComponentName(KnownComponentNames.TIMEOUT_SCHEDULE_EXECUTOR)\n+   ScheduledExecutorService scheduledExecutorService;\n+\n+   @Inject @ComponentName(KnownComponentNames.BLOCKING_EXECUTOR)\n+   Executor executor;\n \n    private AdvancedCache<ClusteredLockKey, ClusteredLockValue> cache;\n \n-   public EmbeddedClusteredLockManager(CompletableFuture<CacheHolder> cacheHolderFuture, ClusteredLockManagerConfiguration config) {\n-      this.cacheHolderFuture = cacheHolderFuture;\n+   public EmbeddedClusteredLockManager(ClusteredLockManagerConfiguration config) {\n       this.config = config;\n    }\n \n-   @Inject\n-   public void injectDep(@ComponentName(KnownComponentNames.TIMEOUT_SCHEDULE_EXECUTOR) ScheduledExecutorService scheduledExecutorService,\n-                         @ComponentName(KnownComponentNames.BLOCKING_EXECUTOR) Executor executor) {\n-      this.scheduledExecutorService = scheduledExecutorService;\n-      this.executor = executor;\n+   @Start\n+   public void start() {\n+      if (trace)\n+         log.trace(\"Starting EmbeddedClusteredLockManager\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07c75513354f987ec7b71cf2c0e677ac8d891b4a"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEwNjk5Ng==", "bodyText": "I feel like this warrants a comment, I wouldn't expect query to depend on clustered-lock", "url": "https://github.com/infinispan/infinispan/pull/8109#discussion_r403106996", "createdAt": "2020-04-03T15:59:56Z", "author": {"login": "danberindei"}, "path": "query/src/main/java/org/infinispan/query/impl/LifecycleManager.java", "diffHunk": "@@ -86,7 +86,7 @@\n  *\n  * @author Sanne Grinovero &lt;sanne@hibernate.org&gt; (C) 2011 Red Hat Inc.\n  */\n-@InfinispanModule(name = \"query\", requiredModules = {\"core\", \"query-core\"}, optionalModules = \"lucene-directory\")\n+@InfinispanModule(name = \"query\", requiredModules = {\"core\", \"query-core\", \"clustered-lock\"}, optionalModules = \"lucene-directory\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96fa095b124155861a70050a84f8a7aadcfc30c7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEwODUxMw==", "bodyText": "@tristantarrant just curious, is anyone else using visualvm.display.name except for VisualVM, or is it a de-facto standard?", "url": "https://github.com/infinispan/infinispan/pull/8109#discussion_r403108513", "createdAt": "2020-04-03T16:02:30Z", "author": {"login": "danberindei"}, "path": "server/runtime/src/main/server/bin/server.sh", "diffHunk": "@@ -11,52 +11,43 @@ DIRNAME=`dirname \"$0\"`\n . \"$DIRNAME/common.sh\"\n \n while true; do\n-   if [ \"x$LAUNCH_ISPN_IN_BACKGROUND\" = \"x\" ]; then\n-      # Execute the JVM in the foreground\n-      eval \\\"$JAVA\\\" $JAVA_OPTS \\\n-         -Dvisualvm.display.name=$PROCESS_NAME \\\n-         -Dinfinispan.server.home.path=\\\"\"$ISPN_HOME\"\\\" \\\n-         -classpath \\\"\"$CLASSPATH\"\\\" \"$LOADER_CLASS\" \"$MAIN_CLASS\" \"$ARGUMENTS\"\n-      ISPN_STATUS=$?\n-   else\n-      # Execute the JVM in the background\n-      eval \\\"$JAVA\\\" $JAVA_OPTS \\\n-         -Djava.util.logging.manager=org.apache.logging.log4j.jul.LogManager \\\n-         -Dinfinispan.server.home.path=\\\"\"$ISPN_HOME\"\\\" \\\n-         -classpath \\\"\"$CLASSPATH\"\\\" \"$LOADER_CLASS\" \"$MAIN_CLASS\" \"$ARGUMENTS\" \"&\"\n-      ISPN_PID=$!\n-      # Trap common signals and relay them to the server process\n-      trap \"kill -HUP  $ISPN_PID\" HUP\n-      trap \"kill -TERM $ISPN_PID\" INT\n-      trap \"kill -QUIT $ISPN_PID\" QUIT\n-      trap \"kill -PIPE $ISPN_PID\" PIPE\n-      trap \"kill -TERM $ISPN_PID\" TERM\n-      if [ \"x$ISPN_PIDFILE\" != \"x\" ]; then\n-        echo $ISPN_PID > $ISPN_PIDFILE\n+   # Execute the JVM in the background\n+   eval \\\"$JAVA\\\" $JAVA_OPTS \\\n+      -Djava.util.logging.manager=org.apache.logging.log4j.jul.LogManager \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE5NDUxOQ=="}, "originalCommit": {"oid": "07c75513354f987ec7b71cf2c0e677ac8d891b4a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE1ODc4Mw==", "bodyText": "Why prefer this to container.stop(), doesn't it also send a TERM signal?\nAlso, do we really need the kill.sh and term.sh scripts? Couldn't we replace them with execInContainer(String.format(\"kill -%d 1\", signal))?", "url": "https://github.com/infinispan/infinispan/pull/8109#discussion_r403158783", "createdAt": "2020-04-03T17:12:40Z", "author": {"login": "danberindei"}, "path": "server/testdriver/core/src/main/java/org/infinispan/server/test/core/ContainerInfinispanServerDriver.java", "diffHunk": "@@ -318,6 +328,16 @@ public void kill(int server) {\n       Exceptions.unchecked(() -> containers.get(server).execInContainer(INFINISPAN_SERVER_HOME + \"/bin/kill.sh\"));\n    }\n \n+   // TODO should this just replace stop?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96fa095b124155861a70050a84f8a7aadcfc30c7"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE3MDAzMg==", "bodyText": "Weird, I never thought about the possibility of JUnit executing the rules in the \"wrong\" order.\nI see there are a few other tests that use multiple rules, perhaps we should change them as well: HotRodListenerWithDslFilter, HotRodCacheQueries, LuceneTransformationTest. Or did you only use a RuleChain here because you needed the constructor parameter, and it wasn't available in the initializer?", "url": "https://github.com/infinispan/infinispan/pull/8109#discussion_r403170032", "createdAt": "2020-04-03T17:25:24Z", "author": {"login": "danberindei"}, "path": "server/tests/src/test/java/org/infinispan/server/resilience/StatefulSetRollingUpgradeIT.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package org.infinispan.server.resilience;\n+\n+import static org.infinispan.server.security.Common.sync;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.IntStream;\n+\n+import org.infinispan.client.rest.RestClient;\n+import org.infinispan.client.rest.RestResponse;\n+import org.infinispan.server.test.core.ContainerInfinispanServerDriver;\n+import org.infinispan.server.test.core.ServerRunMode;\n+import org.infinispan.server.test.junit4.InfinispanServerRule;\n+import org.infinispan.server.test.junit4.InfinispanServerRuleBuilder;\n+import org.infinispan.server.test.junit4.InfinispanServerTestMethodRule;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.RuleChain;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+\n+/**\n+ * Start cluster (0..numServers) redeploy after upgrade. Rolling upgrades always occur in the order numServers...0 and\n+ * the node with index numServers - 1 does not restart until node numServers has completed successfully.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+@RunWith(Parameterized.class)\n+public class StatefulSetRollingUpgradeIT {\n+\n+   private static final int NUM_ROLLING_UPGRADES = 4;\n+   private static final String CACHE_MANAGER = \"default\";\n+\n+   private final int numServers;\n+   private InfinispanServerRule serverRule;\n+   private InfinispanServerTestMethodRule methodRule;\n+\n+   @Parameterized.Parameters(name = \"{0}\")\n+   public static Collection<Object[]> data() {\n+      return Arrays.asList(new Object[][]{{2}, {3}, {4}, {5}});\n+   }\n+\n+   public StatefulSetRollingUpgradeIT(int numServers) {\n+      this.numServers = numServers;\n+   }\n+\n+   @Rule\n+   public RuleChain getRuleChain() {\n+      serverRule = InfinispanServerRuleBuilder.config(\"configuration/ClusteredServerTest.xml\")\n+            .numServers(numServers)\n+            .runMode(ServerRunMode.CONTAINER)\n+            .parallelStartup(false)\n+            .build();\n+\n+      methodRule = new InfinispanServerTestMethodRule(serverRule);\n+\n+      return RuleChain.outerRule(serverRule)\n+            .around(methodRule);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96fa095b124155861a70050a84f8a7aadcfc30c7"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 990, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}