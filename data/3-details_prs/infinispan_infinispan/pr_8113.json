{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MzQ0MDU1", "number": 8113, "title": "ISPN-11541 Add internal metadata to write commands", "bodyText": "https://issues.redhat.com/browse/ISPN-11541", "createdAt": "2020-03-26T18:27:16Z", "url": "https://github.com/infinispan/infinispan/pull/8113", "merged": true, "mergeCommit": {"oid": "f10d8b55c12827146aa899c2e7cfc9393e3dde41"}, "closed": true, "closedAt": "2020-04-14T10:32:20Z", "author": {"login": "pruivo"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRtboNABqjMxNzE2NDU1Nzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXMNPmABqjMyMjY2MjM2NDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c06eba9a8b285a3ccc7a347d85181329743bad2", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/3c06eba9a8b285a3ccc7a347d85181329743bad2", "committedDate": "2020-03-26T18:26:40Z", "message": "ISPN-11541 Add internal metadata to write commands"}, "afterCommit": {"oid": "ae96055673d295d759ac7c2f8c0ef0527957fef1", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/ae96055673d295d759ac7c2f8c0ef0527957fef1", "committedDate": "2020-03-27T09:38:35Z", "message": "ISPN-11541 Add internal metadata to write commands"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae96055673d295d759ac7c2f8c0ef0527957fef1", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/ae96055673d295d759ac7c2f8c0ef0527957fef1", "committedDate": "2020-03-27T09:38:35Z", "message": "ISPN-11541 Add internal metadata to write commands"}, "afterCommit": {"oid": "919a3c71c7309d3a57307403f76c0c95857b4e93", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/919a3c71c7309d3a57307403f76c0c95857b4e93", "committedDate": "2020-03-30T08:46:35Z", "message": "ISPN-11541 Add internal metadata to write commands"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "919a3c71c7309d3a57307403f76c0c95857b4e93", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/919a3c71c7309d3a57307403f76c0c95857b4e93", "committedDate": "2020-03-30T08:46:35Z", "message": "ISPN-11541 Add internal metadata to write commands"}, "afterCommit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/38d1bd6936899a842cd82357ec1dc3e8aab62194", "committedDate": "2020-04-06T15:14:47Z", "message": "ISPN-11541 Add internal metadata to write commands"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDk5NDc0", "url": "https://github.com/infinispan/infinispan/pull/8113#pullrequestreview-389099474", "createdAt": "2020-04-07T13:11:30Z", "commit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzoxMTozMVrOGCCzWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzoyNjozMFrOGCDc7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NjI0OQ==", "bodyText": "Is this still meant to be commented?\nIf we're removing this, should it be a separate commit/Jira?", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404796249", "createdAt": "2020-04-07T13:11:31Z", "author": {"login": "ryanemerson"}, "path": "core/src/main/java/org/infinispan/factories/InterceptorChainFactory.java", "diffHunk": "@@ -125,9 +124,10 @@ private AsyncInterceptorChain buildInterceptorChain() {\n       }\n       interceptorChain.appendInterceptor(createInterceptor(new InvocationContextInterceptor(), InvocationContextInterceptor.class), false);\n \n-      if (!configuration.transaction().transactionMode().isTransactional()) {\n-         interceptorChain.appendInterceptor(createInterceptor(new VersionInterceptor(), VersionInterceptor.class), false);\n-      }\n+      //TODO! why adding version for replace?\n+      //if (!configuration.transaction().transactionMode().isTransactional()) {\n+      //   interceptorChain.appendInterceptor(createInterceptor(new VersionInterceptor(), VersionInterceptor.class), false);\n+      //}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgwNTY3OQ==", "bodyText": "We should add MetaParamsInternalMetadata to CommandsFactory#buildPutKeyValueCommand.\nSimilarly, I noticed that the internal metadata is not  set in ProtobufMetadataManagerInterceptor. How are internal commands handled by xsite, should this be set there as well?", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404805679", "createdAt": "2020-04-07T13:24:50Z", "author": {"login": "ryanemerson"}, "path": "core/src/main/java/org/infinispan/statetransfer/StateConsumerImpl.java", "diffHunk": "@@ -733,6 +733,7 @@ protected IntSet getOwnedSegments(ConsistentHash consistentHash) {\n       InternalMetadataImpl metadata = new InternalMetadataImpl(e);\n       PutKeyValueCommand put = commandsFactory.buildPutKeyValueCommand(e.getKey(), e.getValue(), segmentId,\n                                                                        metadata, STATE_TRANSFER_FLAGS);\n+      put.setInternalMetadata(e.getInternalMetadata());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgwNjg5Mg==", "bodyText": "Unless this method will be used more in follow up changes, this method seems unnecessary.", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404806892", "createdAt": "2020-04-07T13:26:30Z", "author": {"login": "ryanemerson"}, "path": "core/src/main/java/org/infinispan/xsite/ClusteredCacheBackupReceiver.java", "diffHunk": "@@ -208,6 +207,10 @@ private XSiteStatePushCommand newStatePushCommand(List<XSiteState> stateList) {\n       return commandsFactory.buildXSiteStatePushCommand(stateList.toArray(new XSiteState[0]), 0);\n    }\n \n+   private ClusteringDependentLogic getClusteringDependentLogic() {\n+      return cache.getComponentRegistry().getComponent(ClusteringDependentLogic.class);\n+   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDkwNTE0", "url": "https://github.com/infinispan/infinispan/pull/8113#pullrequestreview-389090514", "createdAt": "2020-04-07T13:00:44Z", "commit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzowMDo0NFrOGCCX1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzowMDo0NFrOGCCX1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4OTIwNQ==", "bodyText": "Is there no way we can trim this somehow... a ConcurrentHashMap for every functional command is a lot of bloat. Why not just 1 like we did with the other metadata?", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404789205", "createdAt": "2020-04-07T13:00:44Z", "author": {"login": "wburns"}, "path": "core/src/main/java/org/infinispan/commands/functional/AbstractWriteManyCommand.java", "diffHunk": "@@ -20,6 +24,7 @@\n    long flags;\n    DataConversion keyDataConversion;\n    DataConversion valueDataConversion;\n+   Map<Object, MetaParamsInternalMetadata> internalMetadataMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDM5OTg2", "url": "https://github.com/infinispan/infinispan/pull/8113#pullrequestreview-389039986", "createdAt": "2020-04-07T11:52:02Z", "commit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMTo1MjowMlrOGB_5ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMTo1MjowMlrOGB_5ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc0ODY1MA==", "bodyText": "Can we use an immutable empty list here?", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r404748650", "createdAt": "2020-04-07T11:52:02Z", "author": {"login": "johnou"}, "path": "core/src/main/java/org/infinispan/commands/functional/AbstractWriteManyCommand.java", "diffHunk": "@@ -30,13 +35,15 @@ protected AbstractWriteManyCommand(CommandInvocationId commandInvocationId,\n       this.flags = params.toFlagsBitSet();\n       this.keyDataConversion = keyDataConversion;\n       this.valueDataConversion = valueDataConversion;\n+      this.internalMetadataMap = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38d1bd6936899a842cd82357ec1dc3e8aab62194", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/38d1bd6936899a842cd82357ec1dc3e8aab62194", "committedDate": "2020-04-06T15:14:47Z", "message": "ISPN-11541 Add internal metadata to write commands"}, "afterCommit": {"oid": "11252ee28ccfe69b57b71577db60086f6ff8c999", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/11252ee28ccfe69b57b71577db60086f6ff8c999", "committedDate": "2020-04-07T15:46:49Z", "message": "ISPN-11541 Add internal metadata to write commands"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11252ee28ccfe69b57b71577db60086f6ff8c999", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/11252ee28ccfe69b57b71577db60086f6ff8c999", "committedDate": "2020-04-07T15:46:49Z", "message": "ISPN-11541 Add internal metadata to write commands"}, "afterCommit": {"oid": "d853df100da2eb427ced45fe8068b43c78ab2df0", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/d853df100da2eb427ced45fe8068b43c78ab2df0", "committedDate": "2020-04-07T17:56:32Z", "message": "ISPN-11541 Add internal metadata to write commands"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d853df100da2eb427ced45fe8068b43c78ab2df0", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/d853df100da2eb427ced45fe8068b43c78ab2df0", "committedDate": "2020-04-07T17:56:32Z", "message": "ISPN-11541 Add internal metadata to write commands"}, "afterCommit": {"oid": "c577dd6cf42a84b93281b8464b43a9535aae8b56", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/c577dd6cf42a84b93281b8464b43a9535aae8b56", "committedDate": "2020-04-08T08:36:50Z", "message": "ISPN-11541 Add internal metadata to write commands"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTk2MzA5", "url": "https://github.com/infinispan/infinispan/pull/8113#pullrequestreview-390596309", "createdAt": "2020-04-09T08:36:26Z", "commit": {"oid": "c577dd6cf42a84b93281b8464b43a9535aae8b56"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwODozNjoyNlrOGDPDiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwODozNjo1NlrOGDPEow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0NTU3Nw==", "bodyText": "Unnecessary override of isValid, it's the same as ValidResponse impl.", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r406045577", "createdAt": "2020-04-09T08:36:26Z", "author": {"login": "ryanemerson"}, "path": "core/src/main/java/org/infinispan/remoting/responses/PrepareResponse.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package org.infinispan.remoting.responses;\n+\n+import static org.infinispan.commons.marshall.MarshallUtil.marshallMap;\n+import static org.infinispan.commons.marshall.MarshallUtil.unmarshallMap;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.infinispan.commons.marshall.AbstractExternalizer;\n+import org.infinispan.container.versioning.IncrementableEntryVersion;\n+import org.infinispan.marshall.core.Ids;\n+import org.infinispan.transaction.impl.WriteSkewHelper;\n+\n+/**\n+ * A {@link ValidResponse} used by Optimistic Transactions.\n+ * <p>\n+ * It contains the new {@link IncrementableEntryVersion} for each key updated.\n+ * <p>\n+ * To be extended in the future.\n+ *\n+ * @author Pedro Ruivo\n+ * @since 11.0\n+ */\n+public class PrepareResponse extends ValidResponse {\n+\n+   public static final Externalizer EXTERNALIZER = new Externalizer();\n+\n+   private Map<Object, IncrementableEntryVersion> newWriteSkewVersions;\n+\n+   public static void writeTo(PrepareResponse response, ObjectOutput output) throws IOException {\n+      marshallMap(response.newWriteSkewVersions, output);\n+   }\n+\n+   public static PrepareResponse readFrom(ObjectInput input) throws IOException, ClassNotFoundException {\n+      PrepareResponse response = new PrepareResponse();\n+      response.newWriteSkewVersions = unmarshallMap(input, HashMap::new);\n+      return response;\n+   }\n+\n+   public static PrepareResponse asPrepareResponse(Object rv) {\n+      assert rv == null || rv instanceof PrepareResponse;\n+      return rv == null ? new PrepareResponse() : (PrepareResponse) rv;\n+   }\n+\n+   @Override\n+   public boolean isSuccessful() {\n+      return true;\n+   }\n+\n+   @Override\n+   public boolean isValid() {\n+      return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c577dd6cf42a84b93281b8464b43a9535aae8b56"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA0NTg1OQ==", "bodyText": "Should we throw new UnsupportedOperationException(); here the same as in UnsureResponse as it should never be called?", "url": "https://github.com/infinispan/infinispan/pull/8113#discussion_r406045859", "createdAt": "2020-04-09T08:36:56Z", "author": {"login": "ryanemerson"}, "path": "core/src/main/java/org/infinispan/remoting/responses/PrepareResponse.java", "diffHunk": "@@ -0,0 +1,111 @@\n+package org.infinispan.remoting.responses;\n+\n+import static org.infinispan.commons.marshall.MarshallUtil.marshallMap;\n+import static org.infinispan.commons.marshall.MarshallUtil.unmarshallMap;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.infinispan.commons.marshall.AbstractExternalizer;\n+import org.infinispan.container.versioning.IncrementableEntryVersion;\n+import org.infinispan.marshall.core.Ids;\n+import org.infinispan.transaction.impl.WriteSkewHelper;\n+\n+/**\n+ * A {@link ValidResponse} used by Optimistic Transactions.\n+ * <p>\n+ * It contains the new {@link IncrementableEntryVersion} for each key updated.\n+ * <p>\n+ * To be extended in the future.\n+ *\n+ * @author Pedro Ruivo\n+ * @since 11.0\n+ */\n+public class PrepareResponse extends ValidResponse {\n+\n+   public static final Externalizer EXTERNALIZER = new Externalizer();\n+\n+   private Map<Object, IncrementableEntryVersion> newWriteSkewVersions;\n+\n+   public static void writeTo(PrepareResponse response, ObjectOutput output) throws IOException {\n+      marshallMap(response.newWriteSkewVersions, output);\n+   }\n+\n+   public static PrepareResponse readFrom(ObjectInput input) throws IOException, ClassNotFoundException {\n+      PrepareResponse response = new PrepareResponse();\n+      response.newWriteSkewVersions = unmarshallMap(input, HashMap::new);\n+      return response;\n+   }\n+\n+   public static PrepareResponse asPrepareResponse(Object rv) {\n+      assert rv == null || rv instanceof PrepareResponse;\n+      return rv == null ? new PrepareResponse() : (PrepareResponse) rv;\n+   }\n+\n+   @Override\n+   public boolean isSuccessful() {\n+      return true;\n+   }\n+\n+   @Override\n+   public boolean isValid() {\n+      return true;\n+   }\n+\n+   @Override\n+   public Object getResponseValue() {\n+      return null; //not used!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c577dd6cf42a84b93281b8464b43a9535aae8b56"}, "originalPosition": 62}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c577dd6cf42a84b93281b8464b43a9535aae8b56", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/c577dd6cf42a84b93281b8464b43a9535aae8b56", "committedDate": "2020-04-08T08:36:50Z", "message": "ISPN-11541 Add internal metadata to write commands"}, "afterCommit": {"oid": "7438ff694eaff60c55a32bfb43ff756923f5ce4f", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/7438ff694eaff60c55a32bfb43ff756923f5ce4f", "committedDate": "2020-04-09T09:24:24Z", "message": "ISPN-11541 Add internal metadata to write commands"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e3d496db7eb0d4db8c23a3a32c3c48f064a2536", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/2e3d496db7eb0d4db8c23a3a32c3c48f064a2536", "committedDate": "2020-04-13T10:19:32Z", "message": "ISPN-11541 Add internal metadata to write commands"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7438ff694eaff60c55a32bfb43ff756923f5ce4f", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/7438ff694eaff60c55a32bfb43ff756923f5ce4f", "committedDate": "2020-04-09T09:24:24Z", "message": "ISPN-11541 Add internal metadata to write commands"}, "afterCommit": {"oid": "2e3d496db7eb0d4db8c23a3a32c3c48f064a2536", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/2e3d496db7eb0d4db8c23a3a32c3c48f064a2536", "committedDate": "2020-04-13T10:19:32Z", "message": "ISPN-11541 Add internal metadata to write commands"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 995, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}