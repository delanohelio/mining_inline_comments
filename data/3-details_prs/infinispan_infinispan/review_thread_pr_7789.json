{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NTE1NDg2", "number": 7789, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNDo1NjoyMVrODkr1sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjoxMzoxOVrODkt7oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NzkzNTg0OnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/dsl/embedded/impl/QueryEngine.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNDo1NjoyMVrOFxJLvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNDo1NjoyMVrOFxJLvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA3NTAwNQ==", "bodyText": "So asyncExecutor and indexedQueryMode params are no longer used here. Why not remove them also from method signature? We can do that, QueryEngine is not API.", "url": "https://github.com/infinispan/infinispan/pull/7789#discussion_r387075005", "createdAt": "2020-03-03T14:56:21Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/dsl/embedded/impl/QueryEngine.java", "diffHunk": "@@ -666,15 +666,9 @@ protected RowProcessor makeProjectionProcessor(Class<?>[] projectedTypes, Object\n                                             TimeoutExceptionFactory timeoutExceptionFactory,\n                                             ExecutorService asyncExecutor,\n                                             Class<?>... classes) {\n-      CacheQuery cacheQuery;\n-      if (indexedQueryMode == IndexedQueryMode.BROADCAST) {\n-         cacheQuery = new ClusteredCacheQueryImpl<>(luceneQuery, getSearchFactory(), asyncExecutor, cache,\n-               keyTransformationHandler, classes);\n-      } else {\n-         cacheQuery = new CacheQueryImpl<>(luceneQuery, getSearchFactory(), cache, keyTransformationHandler,\n-               timeoutExceptionFactory, classes);\n-      }\n-      return (CacheQuery<E>) cacheQuery;\n+      return new CacheQueryImpl<>(luceneQuery, getSearchFactory(), cache, keyTransformationHandler,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84d7dc5f6f321516e394f3fa55710c01a8daf1d"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5Nzk4NTU2OnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/impl/SearchManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTowNzoyMlrOFxJp4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTowNzoyMlrOFxJp4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4MjcyMQ==", "bodyText": "It's a bit odd we loose the classes argument in SearcManager.getQuery but QueryEngine.buildCacheQuery still takes an array of classes", "url": "https://github.com/infinispan/infinispan/pull/7789#discussion_r387082721", "createdAt": "2020-03-03T15:07:22Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/impl/SearchManagerImpl.java", "diffHunk": "@@ -63,10 +60,10 @@ public SearchManagerImpl(AdvancedCache<?, ?> cache) {\n    }\n \n    @Override\n-   public <E> CacheQuery<E> getQuery(String queryString, IndexedQueryMode indexedQueryMode, Class<?>... classes) {\n+   public <E> CacheQuery<E> getQuery(String queryString, IndexedQueryMode indexedQueryMode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84d7dc5f6f321516e394f3fa55710c01a8daf1d"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODE0OTU5OnYy", "diffSide": "LEFT", "path": "remote-query/remote-query-server/src/test/java/org/infinispan/query/remote/impl/indexing/ProtobufWrapperIndexingTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo0NDowOFrOFxLODQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo0NDowOFrOFxLODQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEwODM2NQ==", "bodyText": "This test could have been kept. Just remove lines 62-78 and we're good.", "url": "https://github.com/infinispan/infinispan/pull/7789#discussion_r387108365", "createdAt": "2020-03-03T15:44:08Z", "author": {"login": "anistor"}, "path": "remote-query/remote-query-server/src/test/java/org/infinispan/query/remote/impl/indexing/ProtobufWrapperIndexingTest.java", "diffHunk": "@@ -1,111 +0,0 @@\n-package org.infinispan.query.remote.impl.indexing;\n-\n-import static org.testng.AssertJUnit.assertEquals;\n-import static org.testng.AssertJUnit.assertNotNull;\n-\n-import java.io.IOException;\n-import java.util.Collections;\n-import java.util.List;\n-\n-import org.apache.lucene.search.Query;\n-import org.hibernate.search.query.engine.spi.EntityInfo;\n-import org.hibernate.search.spi.SearchIntegrator;\n-import org.infinispan.configuration.cache.ConfigurationBuilder;\n-import org.infinispan.manager.EmbeddedCacheManager;\n-import org.infinispan.protostream.ProtobufUtil;\n-import org.infinispan.protostream.SerializationContext;\n-import org.infinispan.protostream.sampledomain.Address;\n-import org.infinispan.protostream.sampledomain.User;\n-import org.infinispan.protostream.sampledomain.marshallers.MarshallerRegistration;\n-import org.infinispan.query.Search;\n-import org.infinispan.query.SearchManager;\n-import org.infinispan.query.remote.impl.ProgrammaticSearchMappingProviderImpl;\n-import org.infinispan.query.remote.impl.ProtobufMetadataManagerImpl;\n-import org.infinispan.test.SingleCacheManagerTest;\n-import org.infinispan.test.fwk.TestCacheManagerFactory;\n-import org.infinispan.transaction.TransactionMode;\n-import org.testng.annotations.Test;\n-\n-/**\n- * @author anistor@redhat.com\n- * @since 6.0\n- */\n-@Test(groups = \"functional\", testName = \"query.remote.impl.indexing.ProtobufWrapperIndexingTest\")\n-public class ProtobufWrapperIndexingTest extends SingleCacheManagerTest {\n-\n-   protected EmbeddedCacheManager createCacheManager() throws Exception {\n-      ConfigurationBuilder cfg = getDefaultStandaloneCacheConfig(true);\n-      cfg.transaction().transactionMode(TransactionMode.TRANSACTIONAL)\n-            .indexing().enable()\n-            .addProperty(\"default.directory_provider\", \"local-heap\")\n-            .addProperty(\"lucene_version\", \"LUCENE_CURRENT\");\n-      return TestCacheManagerFactory.createCacheManager(cfg);\n-   }\n-\n-   public void testIndexingWithWrapper() throws Exception {\n-      SerializationContext serCtx = ProtobufMetadataManagerImpl.getSerializationContext(cacheManager);\n-\n-      MarshallerRegistration.registerMarshallers(serCtx);\n-\n-      // Store some test data:\n-      byte[] value1 = createMarshalledUser(serCtx, \"Adrian\", \"Nistor\");\n-      byte[] value2 = createMarshalledUser(serCtx, \"John\", \"Batman\");\n-\n-      cache.put(new byte[]{1, 2, 3}, value1);\n-      cache.put(new byte[]{4, 5, 6}, value2);\n-\n-      SearchManager sm = Search.getSearchManager(cache);\n-\n-      SearchIntegrator searchFactory = sm.unwrap(SearchIntegrator.class);\n-      assertNotNull(searchFactory.getIndexManager(ProgrammaticSearchMappingProviderImpl.getIndexName(cache.getName())));\n-\n-      Query luceneQuery = sm.buildQueryBuilderForClass(ProtobufValueWrapper.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84d7dc5f6f321516e394f3fa55710c01a8daf1d"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODE4OTA0OnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/impl/QueryDefinition.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo1MzowNlrOFxLmgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo1MzowNlrOFxLmgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNDYyNQ==", "bodyText": "The old version of the code was setting firstResult and maxResults here only first time, if hsQuery == null.", "url": "https://github.com/infinispan/infinispan/pull/7789#discussion_r387114625", "createdAt": "2020-03-03T15:53:06Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/impl/QueryDefinition.java", "diffHunk": "@@ -98,26 +85,20 @@ private QueryEngine getQueryEngine(AdvancedCache<?, ?> cache) {\n \n    public void initialize(AdvancedCache<?, ?> cache) {\n       if (hsQuery == null) {\n-         if (luceneQuery != null) {\n-            hsQuery = ComponentRegistryUtils.getSearchIntegrator(cache).createHSQuery(luceneQuery);\n-            if (sort != null)\n-               hsQuery.sort(sort);\n+         QueryEngine<?> queryEngine = getQueryEngine(cache);\n+         HsQueryRequest hsQueryRequest;\n+         if (indexedType != null && sortableFields != null) {\n+            IndexedTypeMap<CustomTypeMetadata> metadata = createMetadata();\n+            hsQueryRequest = queryEngine.createHsQuery(queryString, metadata, namedParameters);\n          } else {\n-            QueryEngine queryEngine = getQueryEngine(cache);\n-            HsQueryRequest hsQueryRequest;\n-            if (indexedType != null && sortableFields != null) {\n-               IndexedTypeMap<CustomTypeMetadata> metadata = createMetadata();\n-               hsQueryRequest = queryEngine.createHsQuery(queryString, metadata, namedParameters);\n-            } else {\n-               hsQueryRequest = queryEngine.createHsQuery(queryString, null, namedParameters);\n-            }\n-            hsQuery = hsQueryRequest.getHsQuery();\n-            sort = hsQueryRequest.getSort();\n-            hsQuery.projection(hsQueryRequest.getProjections());\n+            hsQueryRequest = queryEngine.createHsQuery(queryString, null, namedParameters);\n          }\n-         hsQuery.firstResult(firstResult);\n-         hsQuery.maxResults(maxResults);\n+         hsQuery = hsQueryRequest.getHsQuery();\n+         sort = hsQueryRequest.getSort();\n+         hsQuery.projection(hsQueryRequest.getProjections());\n       }\n+      hsQuery.firstResult(firstResult);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84d7dc5f6f321516e394f3fa55710c01a8daf1d"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODIwMTQ5OnYy", "diffSide": "LEFT", "path": "client/hotrod-client/src/test/java/org/infinispan/client/hotrod/stress/RemoteQueryDslPerfTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo1NjowMVrOFxLuUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjoyODowMFrOFxNJ5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNjYyNw==", "bodyText": "Extracting this out of the loop is an optimization that impacts the measurement. I believe we want to measure total query execution time including any initial preparation/parsing time for the query. The system is free to eventually internally optimize that by using caching for parsed queries, but we should not help here.", "url": "https://github.com/infinispan/infinispan/pull/7789#discussion_r387116627", "createdAt": "2020-03-03T15:56:01Z", "author": {"login": "anistor"}, "path": "client/hotrod-client/src/test/java/org/infinispan/client/hotrod/stress/RemoteQueryDslPerfTest.java", "diffHunk": "@@ -150,14 +150,12 @@ public void testEmbeddedQueryDslExecution() throws Exception {\n    }\n \n    public void testEmbeddedLuceneQueryExecution() throws Exception {\n-      SearchManager searchManager = org.infinispan.query.Search.getSearchManager(cache);\n-      org.apache.lucene.search.Query query = searchManager.buildQueryBuilderForClass(UserHS.class).get()\n-            .keyword().onField(\"name\").matching(\"John1\").createQuery();\n+      QueryFactory queryFactory = Search.getQueryFactory(cache);\n+      Query cacheQuery = queryFactory.create(String.format(\"From %s where name = 'John1'\", UserHS.class.getName()));\n \n       final int loops = 100000;\n       final long startTs = System.nanoTime();\n       for (int i = 0; i < loops; i++) {\n-         CacheQuery<User> cacheQuery = searchManager.getQuery(query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84d7dc5f6f321516e394f3fa55710c01a8daf1d"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0MDA3MQ==", "bodyText": "ok, I'll move it back", "url": "https://github.com/infinispan/infinispan/pull/7789#discussion_r387140071", "createdAt": "2020-03-03T16:28:00Z", "author": {"login": "gustavonalle"}, "path": "client/hotrod-client/src/test/java/org/infinispan/client/hotrod/stress/RemoteQueryDslPerfTest.java", "diffHunk": "@@ -150,14 +150,12 @@ public void testEmbeddedQueryDslExecution() throws Exception {\n    }\n \n    public void testEmbeddedLuceneQueryExecution() throws Exception {\n-      SearchManager searchManager = org.infinispan.query.Search.getSearchManager(cache);\n-      org.apache.lucene.search.Query query = searchManager.buildQueryBuilderForClass(UserHS.class).get()\n-            .keyword().onField(\"name\").matching(\"John1\").createQuery();\n+      QueryFactory queryFactory = Search.getQueryFactory(cache);\n+      Query cacheQuery = queryFactory.create(String.format(\"From %s where name = 'John1'\", UserHS.class.getName()));\n \n       final int loops = 100000;\n       final long startTs = System.nanoTime();\n       for (int i = 0; i < loops; i++) {\n-         CacheQuery<User> cacheQuery = searchManager.getQuery(query);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExNjYyNw=="}, "originalCommit": {"oid": "d84d7dc5f6f321516e394f3fa55710c01a8daf1d"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODIxODc5OnYy", "diffSide": "RIGHT", "path": "query/src/main/java/org/infinispan/query/CacheQuery.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo1OTo0NFrOFxL5RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNTo1OTo0NFrOFxL5RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzExOTQyOQ==", "bodyText": "This javadoc ref is broken", "url": "https://github.com/infinispan/infinispan/pull/7789#discussion_r387119429", "createdAt": "2020-03-03T15:59:44Z", "author": {"login": "anistor"}, "path": "query/src/main/java/org/infinispan/query/CacheQuery.java", "diffHunk": "@@ -18,7 +19,7 @@\n  * @author Navin Surtani\n  * @author Sanne Grinovero &lt;sanne@hibernate.org&gt; (C) 2011 Red Hat Inc.\n  * @author Marko Luksa\n- * @see org.infinispan.query.impl.SearchManagerImpl#getQuery(org.apache.lucene.search.Query, Class...)\n+ * @see org.infinispan.query.impl.SearchManagerImpl#getQuery(String, IndexedQueryMode, Class...)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84d7dc5f6f321516e394f3fa55710c01a8daf1d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODI3ODcyOnYy", "diffSide": "RIGHT", "path": "query/src/test/java/org/infinispan/query/tx/NonLocalIndexingTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjoxMzoxOVrOFxMeSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjoyMDo1NFrOFxM0JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyODkwNA==", "bodyText": "I'm confused by this. Why 0?", "url": "https://github.com/infinispan/infinispan/pull/7789#discussion_r387128904", "createdAt": "2020-03-03T16:13:19Z", "author": {"login": "anistor"}, "path": "query/src/test/java/org/infinispan/query/tx/NonLocalIndexingTest.java", "diffHunk": "@@ -61,7 +59,7 @@ public void testQueryAfterAddingNewNode() throws Exception {\n       store(\"Astronaut\", new AnotherGrassEater(\"Astronaut\", \"is having a hard time to find grass\"), cache(1));\n       //replacing same key with a new type:\n       assertFind(\"cat\", 0);\n-      assertFind(\"grass\", 1);\n+      assertFind(\"grass\", 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d84d7dc5f6f321516e394f3fa55710c01a8daf1d"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzNDUwMQ==", "bodyText": "The API that worked on Lucene queries would do a query targeting all entities in the method assertFind (Person and AnotherGrassEater). With my changes it only targets the Person entity", "url": "https://github.com/infinispan/infinispan/pull/7789#discussion_r387134501", "createdAt": "2020-03-03T16:20:54Z", "author": {"login": "gustavonalle"}, "path": "query/src/test/java/org/infinispan/query/tx/NonLocalIndexingTest.java", "diffHunk": "@@ -61,7 +59,7 @@ public void testQueryAfterAddingNewNode() throws Exception {\n       store(\"Astronaut\", new AnotherGrassEater(\"Astronaut\", \"is having a hard time to find grass\"), cache(1));\n       //replacing same key with a new type:\n       assertFind(\"cat\", 0);\n-      assertFind(\"grass\", 1);\n+      assertFind(\"grass\", 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEyODkwNA=="}, "originalCommit": {"oid": "d84d7dc5f6f321516e394f3fa55710c01a8daf1d"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4532, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}