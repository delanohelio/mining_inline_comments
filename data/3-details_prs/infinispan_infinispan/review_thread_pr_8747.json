{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4Mzk5NDQy", "number": 8747, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzowODo1NVrOEquGhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNDo1MDowMlrOEsFRiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMjMwOTgyOnYy", "diffSide": "RIGHT", "path": "server/rest/src/main/java/org/infinispan/rest/cachemanager/RestCacheManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzowODo1NVrOHdFhjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMjozNToxNVrOHdxGsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2MTI2Mw==", "bodyText": "HotRodServer avoids the toString() calls by keeping a map cacheName -> CacheInfo, and in the CacheInfo a map KeyValuePair<MediaType, MediaType> -> encoded cache.\nThe only gotcha is that MediaType.toString() ignores the weight parameter, while equals() and hashCode() do not.  I'd rather we remove the weight parameter explicitly instead of ignoring it in toString(). FWIW HotRodServer ignores all parameters when creating the encoded cache (with getTypeSubType()), which is probably wrong.", "url": "https://github.com/infinispan/infinispan/pull/8747#discussion_r500261263", "createdAt": "2020-10-06T13:08:55Z", "author": {"login": "danberindei"}, "path": "server/rest/src/main/java/org/infinispan/rest/cachemanager/RestCacheManager.java", "diffHunk": "@@ -71,14 +71,16 @@ public RestCacheManager(EmbeddedCacheManager instance, Predicate<? super String>\n          throw logger.missingRequiredMediaType(name);\n       }\n       checkCacheAvailable(name);\n-      String cacheKey = name + \"-\" + keyContentType.getTypeSubtype() + valueContentType.getTypeSubtype();\n+      String mapKey = keyContentType.toString();\n+      String mapValue = valueContentType.toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a845cbc1aa8dfcb00b0c9c85fa3cd573efc647f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI3NjkyMQ==", "bodyText": "ok, let me change it", "url": "https://github.com/infinispan/infinispan/pull/8747#discussion_r500276921", "createdAt": "2020-10-06T13:30:00Z", "author": {"login": "gustavonalle"}, "path": "server/rest/src/main/java/org/infinispan/rest/cachemanager/RestCacheManager.java", "diffHunk": "@@ -71,14 +71,16 @@ public RestCacheManager(EmbeddedCacheManager instance, Predicate<? super String>\n          throw logger.missingRequiredMediaType(name);\n       }\n       checkCacheAvailable(name);\n-      String cacheKey = name + \"-\" + keyContentType.getTypeSubtype() + valueContentType.getTypeSubtype();\n+      String mapKey = keyContentType.toString();\n+      String mapValue = valueContentType.toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2MTI2Mw=="}, "originalCommit": {"oid": "3a845cbc1aa8dfcb00b0c9c85fa3cd573efc647f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NTI4Mw==", "bodyText": "Ok, I gave up of excluding this q parameter, it is almost never sent, only when interacting with the REST API from the browser as a GET (not XHR)", "url": "https://github.com/infinispan/infinispan/pull/8747#discussion_r500975283", "createdAt": "2020-10-07T12:35:15Z", "author": {"login": "gustavonalle"}, "path": "server/rest/src/main/java/org/infinispan/rest/cachemanager/RestCacheManager.java", "diffHunk": "@@ -71,14 +71,16 @@ public RestCacheManager(EmbeddedCacheManager instance, Predicate<? super String>\n          throw logger.missingRequiredMediaType(name);\n       }\n       checkCacheAvailable(name);\n-      String cacheKey = name + \"-\" + keyContentType.getTypeSubtype() + valueContentType.getTypeSubtype();\n+      String mapKey = keyContentType.toString();\n+      String mapValue = valueContentType.toString();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2MTI2Mw=="}, "originalCommit": {"oid": "3a845cbc1aa8dfcb00b0c9c85fa3cd573efc647f"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMjMyMTc2OnYy", "diffSide": "RIGHT", "path": "server/rest/src/test/java/org/infinispan/rest/cachemanager/RestCacheManagerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzoxMTozMFrOHdFo_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMjozNjoxMlrOHdxJBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2MzE2NA==", "bodyText": "We should also verify that using a media type list with q parameters does not create a new encoded cache.", "url": "https://github.com/infinispan/infinispan/pull/8747#discussion_r500263164", "createdAt": "2020-10-06T13:11:30Z", "author": {"login": "danberindei"}, "path": "server/rest/src/test/java/org/infinispan/rest/cachemanager/RestCacheManagerTest.java", "diffHunk": "@@ -60,17 +60,14 @@ public void shouldReuseEncodedCaches() {\n       // Verify they are stored internally\n       assertEquals(knownCaches.size(), 4);\n \n-\n-      // Requesting again with same media, or with same media but different parameters should reuse internal instance\n+      // Requesting again with same media but different parameters should not reuse internal instance\n       Mockito.reset(embeddedCacheManager);\n-      restCacheManager.getCache(\"cache2\", MediaType.MATCH_ALL, MediaType.TEXT_PLAIN, request);\n       restCacheManager.getCache(\"cache2\", MediaType.MATCH_ALL, MediaType.fromString(\"text/plain; charset=UTF-8\"), request);\n       restCacheManager.getCache(\"cache2\", MediaType.MATCH_ALL, MediaType.fromString(\"text/plain; charset=SHIFT-JIS\"), request);\n \n-      assertEquals(knownCaches.keySet().size(), 4);\n+      assertEquals(knownCaches.keySet().size(), 6);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a845cbc1aa8dfcb00b0c9c85fa3cd573efc647f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3NTg3Ng==", "bodyText": "I decided to take into account every parameter from the MediaType to associate it with an encoded cache, so they are all available to the transcoders", "url": "https://github.com/infinispan/infinispan/pull/8747#discussion_r500975876", "createdAt": "2020-10-07T12:36:12Z", "author": {"login": "gustavonalle"}, "path": "server/rest/src/test/java/org/infinispan/rest/cachemanager/RestCacheManagerTest.java", "diffHunk": "@@ -60,17 +60,14 @@ public void shouldReuseEncodedCaches() {\n       // Verify they are stored internally\n       assertEquals(knownCaches.size(), 4);\n \n-\n-      // Requesting again with same media, or with same media but different parameters should reuse internal instance\n+      // Requesting again with same media but different parameters should not reuse internal instance\n       Mockito.reset(embeddedCacheManager);\n-      restCacheManager.getCache(\"cache2\", MediaType.MATCH_ALL, MediaType.TEXT_PLAIN, request);\n       restCacheManager.getCache(\"cache2\", MediaType.MATCH_ALL, MediaType.fromString(\"text/plain; charset=UTF-8\"), request);\n       restCacheManager.getCache(\"cache2\", MediaType.MATCH_ALL, MediaType.fromString(\"text/plain; charset=SHIFT-JIS\"), request);\n \n-      assertEquals(knownCaches.keySet().size(), 4);\n+      assertEquals(knownCaches.keySet().size(), 6);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2MzE2NA=="}, "originalCommit": {"oid": "3a845cbc1aa8dfcb00b0c9c85fa3cd573efc647f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NjAyMzA2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/AdvancedCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjozMjozM1rOHfHuiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjozMjozM1rOHfHuiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5NDUwNw==", "bodyText": "Love the explicit generic types!", "url": "https://github.com/infinispan/infinispan/pull/8747#discussion_r502394507", "createdAt": "2020-10-09T12:32:33Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/AdvancedCache.java", "diffHunk": "@@ -826,9 +827,17 @@ default V merge(K key, V value, SerializableBiFunction<? super V, ? super V, ? e\n     * @param valueMediaType {@link org.infinispan.commons.dataconversion} for the values.\n     * @return an instance of {@link AdvancedCache} where all data will formatted according to the supplied {@link\n     * org.infinispan.commons.dataconversion.MediaType}.\n+    *\n+    * @deprecated Use {@link #withMediaType(MediaType, MediaType)} instead.\n     */\n+   @Deprecated\n    AdvancedCache<?, ?> withMediaType(String keyMediaType, String valueMediaType);\n \n+   /**\n+    * @see #withMediaType(String, String)\n+    */\n+   <K1, V1> AdvancedCache<K1, V1> withMediaType(MediaType keyMediaType, MediaType valueMediaType);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c3f74c0bccb3d70ea7209f04c31bf4acf5881fc"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NjU5MjExOnYy", "diffSide": "RIGHT", "path": "server/tests/src/test/java/org/infinispan/server/persistence/CustomNonBlockingStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNDo1MDowMlrOHfNJCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNToxMDo0NFrOHfODLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ4MzIwOA==", "bodyText": "You missed a cast that's not needed any more on line 25", "url": "https://github.com/infinispan/infinispan/pull/8747#discussion_r502483208", "createdAt": "2020-10-09T14:50:02Z", "author": {"login": "danberindei"}, "path": "server/tests/src/test/java/org/infinispan/server/persistence/CustomNonBlockingStore.java", "diffHunk": "@@ -23,7 +23,7 @@\n    public CompletionStage<Void> start(InitializationContext ctx) {\n       marshallableEntryFactory = ctx.getMarshallableEntryFactory();\n       AdvancedCache<String, String> object = (AdvancedCache) ctx.getCache().getAdvancedCache()\n-            .withMediaType(MediaType.APPLICATION_OBJECT_TYPE, MediaType.APPLICATION_OBJECT_TYPE);\n+            .withMediaType(MediaType.APPLICATION_OBJECT, MediaType.APPLICATION_OBJECT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c3f74c0bccb3d70ea7209f04c31bf4acf5881fc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ5ODA5NA==", "bodyText": "removed", "url": "https://github.com/infinispan/infinispan/pull/8747#discussion_r502498094", "createdAt": "2020-10-09T15:10:44Z", "author": {"login": "gustavonalle"}, "path": "server/tests/src/test/java/org/infinispan/server/persistence/CustomNonBlockingStore.java", "diffHunk": "@@ -23,7 +23,7 @@\n    public CompletionStage<Void> start(InitializationContext ctx) {\n       marshallableEntryFactory = ctx.getMarshallableEntryFactory();\n       AdvancedCache<String, String> object = (AdvancedCache) ctx.getCache().getAdvancedCache()\n-            .withMediaType(MediaType.APPLICATION_OBJECT_TYPE, MediaType.APPLICATION_OBJECT_TYPE);\n+            .withMediaType(MediaType.APPLICATION_OBJECT, MediaType.APPLICATION_OBJECT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ4MzIwOA=="}, "originalCommit": {"oid": "8c3f74c0bccb3d70ea7209f04c31bf4acf5881fc"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3836, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}