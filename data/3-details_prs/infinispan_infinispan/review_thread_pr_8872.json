{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzMzM4MTIz", "number": 8872, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyMTozMFrOE8G87g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyODo0N1rOE8HGrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDYzOTE4OnYy", "diffSide": "LEFT", "path": "query/src/main/java/org/infinispan/search/mapper/mapping/impl/IndexProperties.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyMTozMFrOH4C6Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwOTozMzoyNFrOH40_yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTkyNg==", "bodyText": "Are you sure about this? I think we discussed this at some point and the Search 6 defaults weren't acceptable for Infinispan. I.e. for each index 10 indexing queues, and for each cache about as many threads as the number of processor cores available to the JVM on startup.\nNote that having more indexing queues than threads is not useful.", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528529926", "createdAt": "2020-11-23T08:21:30Z", "author": {"login": "yrodiere"}, "path": "query/src/main/java/org/infinispan/search/mapper/mapping/impl/IndexProperties.java", "diffHunk": "@@ -31,25 +28,21 @@ public void setProperty(String key, Object value) {\n    }\n \n    public void setProperties(Map<String, Object> properties) {\n-      properties.entrySet().stream()\n-            .forEach(property -> setProperty(property.getKey(), property.getValue()) );\n+      properties.forEach(this::setProperty);\n    }\n \n    public ConfigurationPropertySource createPropertySource(ConfigurationPropertyChecker propertyChecker) {\n       ConfigurationPropertySource basePropertySource =\n             propertyChecker.wrap(ConfigurationPropertySource.fromMap(backendProperties))\n-                  .withPrefix(BACKEND_PROPERTIES_PREFIX);\n+                  .withPrefix(EngineSettings.BACKEND);\n       ConfigurationPropertySource propertySource =\n             basePropertySource.withOverride(ConfigurationPropertySource.fromMap(engineProperties));\n       defaultProperties();\n       return propertySource;\n    }\n \n    private void defaultProperties() {\n-      engineProperties.put(\"hibernate.search.default_backend\", INFINISPAN_BACKEND_NAME);\n       backendProperties.put(\"type\", \"lucene\");\n       backendProperties.put(\"analysis.configurer\", new DefaultAnalysisConfigurer());\n-      backendProperties.put(\"thread_pool.size\", \"1\");\n-      backendProperties.put(\"index_defaults.indexing.queue_count\", \"1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY2OTI2NA==", "bodyText": "Noted, I revamped the config in #8815, and those will become Infinispan level properties. I was planning handling the defaults there.", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528669264", "createdAt": "2020-11-23T12:30:30Z", "author": {"login": "gustavonalle"}, "path": "query/src/main/java/org/infinispan/search/mapper/mapping/impl/IndexProperties.java", "diffHunk": "@@ -31,25 +28,21 @@ public void setProperty(String key, Object value) {\n    }\n \n    public void setProperties(Map<String, Object> properties) {\n-      properties.entrySet().stream()\n-            .forEach(property -> setProperty(property.getKey(), property.getValue()) );\n+      properties.forEach(this::setProperty);\n    }\n \n    public ConfigurationPropertySource createPropertySource(ConfigurationPropertyChecker propertyChecker) {\n       ConfigurationPropertySource basePropertySource =\n             propertyChecker.wrap(ConfigurationPropertySource.fromMap(backendProperties))\n-                  .withPrefix(BACKEND_PROPERTIES_PREFIX);\n+                  .withPrefix(EngineSettings.BACKEND);\n       ConfigurationPropertySource propertySource =\n             basePropertySource.withOverride(ConfigurationPropertySource.fromMap(engineProperties));\n       defaultProperties();\n       return propertySource;\n    }\n \n    private void defaultProperties() {\n-      engineProperties.put(\"hibernate.search.default_backend\", INFINISPAN_BACKEND_NAME);\n       backendProperties.put(\"type\", \"lucene\");\n       backendProperties.put(\"analysis.configurer\", new DefaultAnalysisConfigurer());\n-      backendProperties.put(\"thread_pool.size\", \"1\");\n-      backendProperties.put(\"index_defaults.indexing.queue_count\", \"1\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTkyNg=="}, "originalCommit": {"oid": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTM1MDYwMw==", "bodyText": "I have moved the defaults to the new config PR at #8815, thanks @yrodiere", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r529350603", "createdAt": "2020-11-24T09:33:24Z", "author": {"login": "gustavonalle"}, "path": "query/src/main/java/org/infinispan/search/mapper/mapping/impl/IndexProperties.java", "diffHunk": "@@ -31,25 +28,21 @@ public void setProperty(String key, Object value) {\n    }\n \n    public void setProperties(Map<String, Object> properties) {\n-      properties.entrySet().stream()\n-            .forEach(property -> setProperty(property.getKey(), property.getValue()) );\n+      properties.forEach(this::setProperty);\n    }\n \n    public ConfigurationPropertySource createPropertySource(ConfigurationPropertyChecker propertyChecker) {\n       ConfigurationPropertySource basePropertySource =\n             propertyChecker.wrap(ConfigurationPropertySource.fromMap(backendProperties))\n-                  .withPrefix(BACKEND_PROPERTIES_PREFIX);\n+                  .withPrefix(EngineSettings.BACKEND);\n       ConfigurationPropertySource propertySource =\n             basePropertySource.withOverride(ConfigurationPropertySource.fromMap(engineProperties));\n       defaultProperties();\n       return propertySource;\n    }\n \n    private void defaultProperties() {\n-      engineProperties.put(\"hibernate.search.default_backend\", INFINISPAN_BACKEND_NAME);\n       backendProperties.put(\"type\", \"lucene\");\n       backendProperties.put(\"analysis.configurer\", new DefaultAnalysisConfigurer());\n-      backendProperties.put(\"thread_pool.size\", \"1\");\n-      backendProperties.put(\"index_defaults.indexing.queue_count\", \"1\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTkyNg=="}, "originalCommit": {"oid": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDY1NjAwOnYy", "diffSide": "RIGHT", "path": "query/src/test/resources/nrt-performance-writer.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyNjoyNFrOH4DDhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjozNDowNFrOH4LiCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMjM1Nw==", "bodyText": "FWIW, NRT is enabled by default. This doesn't enable it, it just changes the commit interval from 1,000ms to 10,000ms.", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528532357", "createdAt": "2020-11-23T08:26:24Z", "author": {"login": "yrodiere"}, "path": "query/src/test/resources/nrt-performance-writer.xml", "diffHunk": "@@ -24,7 +24,7 @@\n                <indexed-entity>org.infinispan.query.test.Person</indexed-entity>\n             </indexed-entities>\n             <!-- Enabled fastest writer: NRT backend -->\n-            <property name=\"index_defaults.io.commit_interval\">10000</property>\n+            <property name=\"io.commit_interval\">10000</property>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3MTI0MQ==", "bodyText": "yes, I am aware. This file is reminiscent of a very old test that needs to be revisit after  due to #8815 too", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528671241", "createdAt": "2020-11-23T12:34:04Z", "author": {"login": "gustavonalle"}, "path": "query/src/test/resources/nrt-performance-writer.xml", "diffHunk": "@@ -24,7 +24,7 @@\n                <indexed-entity>org.infinispan.query.test.Person</indexed-entity>\n             </indexed-entities>\n             <!-- Enabled fastest writer: NRT backend -->\n-            <property name=\"index_defaults.io.commit_interval\">10000</property>\n+            <property name=\"io.commit_interval\">10000</property>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMjM1Nw=="}, "originalCommit": {"oid": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDY2MTY0OnYy", "diffSide": "RIGHT", "path": "query/src/test/resources/nrt-performance-writer.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyODowMlrOH4DGsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyODowMlrOH4DGsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzE3MQ==", "bodyText": "Same comment about sharding: it will be driven by the segment IDs, not the document IDs.", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528533171", "createdAt": "2020-11-23T08:28:02Z", "author": {"login": "yrodiere"}, "path": "query/src/test/resources/nrt-performance-writer.xml", "diffHunk": "@@ -37,11 +37,11 @@\n             -->\n \n             <!-- Enable sharding on writers -->\n-            <property name=\"index_defaults.sharding.strategy\">hash</property>\n-            <property name=\"index_defaults.sharding.number_of_shards\">6</property>\n+            <property name=\"sharding.strategy\">hash</property>\n+            <property name=\"sharding.number_of_shards\">6</property>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNDY2NDEzOnYy", "diffSide": "RIGHT", "path": "query/src/test/resources/nrt-performance-writer-infinispandirectory.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwODoyODo0N1rOH4DIJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjozNjoxNFrOH4Lmiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzU0MA==", "bodyText": "FYI, Hibernate Search uses the routing keys for sharding when they are provided, not the document IDs.\nInfinispan uses the segment IDs as routing keys.\nNot sure it changes anything, but I thought you would want to know.", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528533540", "createdAt": "2020-11-23T08:28:47Z", "author": {"login": "yrodiere"}, "path": "query/src/test/resources/nrt-performance-writer-infinispandirectory.xml", "diffHunk": "@@ -31,12 +31,12 @@\n             <!-- Write indexes in Infinispan -->\n             <property name=\"directory.type\">local-heap</property>\n             <!-- Enable sharding on writers -->\n-            <property name=\"index_defaults.sharding.strategy\">hash</property>\n-            <property name=\"index_defaults.sharding.number_of_shards\">6</property>\n+            <property name=\"sharding.strategy\">hash</property>\n+            <property name=\"sharding.number_of_shards\">6</property>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3MjM5NQ==", "bodyText": "Regarding shards: the plan is to not expose it to the user whatsoever.", "url": "https://github.com/infinispan/infinispan/pull/8872#discussion_r528672395", "createdAt": "2020-11-23T12:36:14Z", "author": {"login": "gustavonalle"}, "path": "query/src/test/resources/nrt-performance-writer-infinispandirectory.xml", "diffHunk": "@@ -31,12 +31,12 @@\n             <!-- Write indexes in Infinispan -->\n             <property name=\"directory.type\">local-heap</property>\n             <!-- Enable sharding on writers -->\n-            <property name=\"index_defaults.sharding.strategy\">hash</property>\n-            <property name=\"index_defaults.sharding.number_of_shards\">6</property>\n+            <property name=\"sharding.strategy\">hash</property>\n+            <property name=\"sharding.number_of_shards\">6</property>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMzU0MA=="}, "originalCommit": {"oid": "ae952d808f48bc929bc1d5d06fef34b99bb2ab79"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3790, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}