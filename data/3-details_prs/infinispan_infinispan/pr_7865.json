{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNTM1Mjgw", "number": 7865, "title": "ISPN-11297 Prevent creating clustered caches incompatible with global state", "bodyText": "https://issues.redhat.com/browse/ISPN-11297", "createdAt": "2020-02-11T08:49:28Z", "url": "https://github.com/infinispan/infinispan/pull/7865", "merged": true, "mergeCommit": {"oid": "03e2db2b2324f9fa161ba29131fb73b0c3d14dec"}, "closed": true, "closedAt": "2020-02-17T10:56:14Z", "author": {"login": "tristantarrant"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDSDCkABqjMwMjY2MTI3Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcENOHnABqjMwMzgyODY3NzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f10810752ad9a92bc5a3187a344c206a4efe8a1", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/9f10810752ad9a92bc5a3187a344c206a4efe8a1", "committedDate": "2020-02-11T08:48:05Z", "message": "ISPN-11297 Prevent creating clustered caches incompatible with global state at start"}, "afterCommit": {"oid": "624e60e2fcdd3782c0c06239844d9e9790a604be", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/624e60e2fcdd3782c0c06239844d9e9790a604be", "committedDate": "2020-02-11T13:49:20Z", "message": "ISPN-11297 Prevent creating clustered caches incompatible with global state at start"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4Nzk3MDQw", "url": "https://github.com/infinispan/infinispan/pull/7865#pullrequestreview-358797040", "createdAt": "2020-02-14T09:07:47Z", "commit": {"oid": "624e60e2fcdd3782c0c06239844d9e9790a604be"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQwOTowNzo0N1rOFpvwHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxMDoxNTo1NFrOFpxvNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTMxODMwMw==", "bodyText": "I'd leave them the way they were, neither changing all the components nor having a different convention per file doesn't sound very appealing.", "url": "https://github.com/infinispan/infinispan/pull/7865#discussion_r379318303", "createdAt": "2020-02-14T09:07:47Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/globalstate/impl/GlobalConfigurationManagerImpl.java", "diffHunk": "@@ -49,12 +49,18 @@\n \n    public static final String CACHE_SCOPE = \"cache\";\n \n-   @Inject EmbeddedCacheManager cacheManager;\n-   @Inject LocalTopologyManager localTopologyManager;\n-   @Inject ConfigurationManager configurationManager;\n-   @Inject InternalCacheRegistry internalCacheRegistry;\n-   @Inject GlobalComponentRegistry globalComponentRegistry;\n-   @Inject @ComponentName(KnownComponentNames.ASYNC_OPERATIONS_EXECUTOR)\n+   @Inject\n+   EmbeddedCacheManager cacheManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "624e60e2fcdd3782c0c06239844d9e9790a604be"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM0ODM2Nw==", "bodyText": "This is kind of confusing, both the local persistent state and the state cache can be said to hold existing configuration state. Could you rename the variables a bit to make it clear where each came from?", "url": "https://github.com/infinispan/infinispan/pull/7865#discussion_r379348367", "createdAt": "2020-02-14T10:11:00Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/globalstate/impl/GlobalConfigurationManagerImpl.java", "diffHunk": "@@ -85,18 +91,42 @@ void start() {\n       parserRegistry = new ParserRegistry();\n \n       localConfigurationManager.initialize(cacheManager, configurationManager, executorService);\n+\n+      // Load any state we previously had", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "624e60e2fcdd3782c0c06239844d9e9790a604be"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM1MDgzOQ==", "bodyText": "I'm not sure if this is ok. Some attributes are validated against the global configuration, and they may not be valid with the current global configuration.", "url": "https://github.com/infinispan/infinispan/pull/7865#discussion_r379350839", "createdAt": "2020-02-14T10:15:54Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/globalstate/impl/GlobalConfigurationManagerImpl.java", "diffHunk": "@@ -172,11 +202,15 @@ void start() {\n \n    CompletableFuture<Void> createCacheLocally(String name, CacheState state) {\n       log.debugf(\"Create cache %s\", name);\n-      ConfigurationBuilderHolder builderHolder = parserRegistry.parse(state.getConfiguration());\n-      Configuration configuration = builderHolder.getNamedConfigurationBuilders().get(name).build();\n+      Configuration configuration = buildConfiguration(name, state);\n       return localConfigurationManager.createCache(name, state.getTemplate(), configuration, state.getFlags());\n    }\n \n+   private Configuration buildConfiguration(String name, CacheState state) {\n+      ConfigurationBuilderHolder builderHolder = parserRegistry.parse(state.getConfiguration());\n+      return builderHolder.getNamedConfigurationBuilders().get(name).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "624e60e2fcdd3782c0c06239844d9e9790a604be"}, "originalPosition": 93}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9df1fdf5dcc63377ab4d63364fd2f5cf75afdd12", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/9df1fdf5dcc63377ab4d63364fd2f5cf75afdd12", "committedDate": "2020-02-14T10:45:51Z", "message": "ISPN-11297 Prevent creating clustered caches incompatible with global state at start"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "624e60e2fcdd3782c0c06239844d9e9790a604be", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/624e60e2fcdd3782c0c06239844d9e9790a604be", "committedDate": "2020-02-11T13:49:20Z", "message": "ISPN-11297 Prevent creating clustered caches incompatible with global state at start"}, "afterCommit": {"oid": "9df1fdf5dcc63377ab4d63364fd2f5cf75afdd12", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/9df1fdf5dcc63377ab4d63364fd2f5cf75afdd12", "committedDate": "2020-02-14T10:45:51Z", "message": "ISPN-11297 Prevent creating clustered caches incompatible with global state at start"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1326, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}