{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNTE1ODYx", "number": 8856, "title": "ISPN-12498 Server Management check authorizations", "bodyText": "https://issues.redhat.com/browse/ISPN-12498", "createdAt": "2020-11-16T08:58:39Z", "url": "https://github.com/infinispan/infinispan/pull/8856", "merged": true, "mergeCommit": {"oid": "d5095ec6bc8d2530519422cc97638b0dc24491a2"}, "closed": true, "closedAt": "2020-11-25T14:36:36Z", "author": {"login": "tristantarrant"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddCIAwABqjM5OTk0NTQ1NzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf_QC9AFqTUzODU1NjIyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ee5747d729857c0a2c77bdbc0046f643b928143", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/4ee5747d729857c0a2c77bdbc0046f643b928143", "committedDate": "2020-11-16T08:57:56Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "c6512c5163472349c696707027ae13616ced53fc", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/c6512c5163472349c696707027ae13616ced53fc", "committedDate": "2020-11-16T10:09:28Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6512c5163472349c696707027ae13616ced53fc", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/c6512c5163472349c696707027ae13616ced53fc", "committedDate": "2020-11-16T10:09:28Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/55701b81662f4107e7c7f01bbfe80c86e03759d7", "committedDate": "2020-11-16T11:22:33Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/55701b81662f4107e7c7f01bbfe80c86e03759d7", "committedDate": "2020-11-16T11:22:33Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "bfc7013b4d5ec80097c89c5529d834dea3298b16", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/bfc7013b4d5ec80097c89c5529d834dea3298b16", "committedDate": "2020-11-16T15:46:48Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDI5MjE0", "url": "https://github.com/infinispan/infinispan/pull/8856#pullrequestreview-531429214", "createdAt": "2020-11-16T15:28:07Z", "commit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNToyODowN1rOH0D6_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTo0NjowOFrOH0EzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MjI1Mw==", "bodyText": "can't you use one of the DefaultCacheManager from this.cacheManagers?", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r524352253", "createdAt": "2020-11-16T15:28:07Z", "author": {"login": "pruivo"}, "path": "server/core/src/main/java/org/infinispan/server/core/backup/BackupManagerImpl.java", "diffHunk": "@@ -43,14 +45,17 @@\n    final BackupReader reader;\n    final Lock backupLock;\n    final Lock restoreLock;\n+   private final EmbeddedCacheManager cacheManager;\n    final Map<String, DefaultCacheManager> cacheManagers;\n    final Map<String, BackupRequest> backupMap;\n    final Map<String, CompletionStage<Void>> restoreMap;\n \n+\n    public BackupManagerImpl(BlockingManager blockingManager, EmbeddedCacheManager cm,\n                             Map<String, DefaultCacheManager> cacheManagers, Path dataRoot) {\n       this.blockingManager = blockingManager;\n       this.rootDir = dataRoot.resolve(WORKING_DIR);\n+      this.cacheManager = cm;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1MjM1Mg==", "bodyText": "nitpick: remove", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r524352352", "createdAt": "2020-11-16T15:28:16Z", "author": {"login": "pruivo"}, "path": "server/core/src/main/java/org/infinispan/server/core/backup/BackupManagerImpl.java", "diffHunk": "@@ -43,14 +45,17 @@\n    final BackupReader reader;\n    final Lock backupLock;\n    final Lock restoreLock;\n+   private final EmbeddedCacheManager cacheManager;\n    final Map<String, DefaultCacheManager> cacheManagers;\n    final Map<String, BackupRequest> backupMap;\n    final Map<String, CompletionStage<Void>> restoreMap;\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1NTQxMw==", "bodyText": "getBackupLocation() is missing.", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r524355413", "createdAt": "2020-11-16T15:32:04Z", "author": {"login": "pruivo"}, "path": "server/core/src/main/java/org/infinispan/server/core/backup/BackupManagerImpl.java", "diffHunk": "@@ -67,11 +72,13 @@ public void init() throws IOException {\n \n    @Override\n    public Set<String> getBackupNames() {\n+      SecurityActions.checkPermission(cacheManager.withSubject(Security.getSubject()), AuthorizationPermission.ADMIN);\n       return new HashSet<>(backupMap.keySet());\n    }\n \n    @Override\n    public Status getBackupStatus(String name) {\n+      SecurityActions.checkPermission(cacheManager.withSubject(Security.getSubject()), AuthorizationPermission.ADMIN);\n       return getBackupStatus(backupMap.get(name));\n    }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1NTg1NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  authzHelper.checkPermission(cacheManager.getSubject(), AuthorizationPermission.ADMIN);\n          \n          \n            \n                  authzHelper.checkPermission(cacheManager.getSubject(), permission);", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r524355855", "createdAt": "2020-11-16T15:32:35Z", "author": {"login": "pruivo"}, "path": "server/core/src/main/java/org/infinispan/server/core/backup/SecurityActions.java", "diffHunk": "@@ -31,4 +35,14 @@ static GlobalConfiguration getGlobalConfiguration(final EmbeddedCacheManager cac\n       GetCacheManagerConfigurationAction action = new GetCacheManagerConfigurationAction(cacheManager);\n       return doPrivileged(action);\n    }\n+\n+   static GlobalComponentRegistry getGlobalComponentRegistry(final EmbeddedCacheManager cacheManager) {\n+      GetGlobalComponentRegistryAction action = new GetGlobalComponentRegistryAction(cacheManager);\n+      return doPrivileged(action);\n+   }\n+\n+   static void checkPermission(EmbeddedCacheManager cacheManager, AuthorizationPermission permission) {\n+      AuthorizationHelper authzHelper = getGlobalComponentRegistry(cacheManager).getComponent(AuthorizationHelper.class);\n+      authzHelper.checkPermission(cacheManager.getSubject(), AuthorizationPermission.ADMIN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2MDQ2OA==", "bodyText": "getAllRestoreNames() isn't protected.", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r524360468", "createdAt": "2020-11-16T15:38:35Z", "author": {"login": "pruivo"}, "path": "server/rest/src/main/java/org/infinispan/rest/resources/ClusterResource.java", "diffHunk": "@@ -38,8 +40,8 @@ public ClusterResource(InvocationHelper invocationHelper) {\n    public Invocations getInvocations() {\n       return new Invocations.Builder()\n             .invocation().methods(POST).path(\"/v2/cluster\").withAction(\"stop\").handleWith(this::stop)\n-            .invocation().methods(GET).path(\"/v2/cluster/backups\").handleWith(this::getAllBackupNames)\n-            .invocation().methods(DELETE, GET, POST).path(\"/v2/cluster/backups/{backupName}\").handleWith(this::backup)\n+            .invocation().methods(GET, HEAD).path(\"/v2/cluster/backups\").handleWith(this::getAllBackupNames)\n+            .invocation().methods(DELETE, GET, HEAD, POST).path(\"/v2/cluster/backups/{backupName}\").handleWith(this::backup)\n             .invocation().methods(GET).path(\"/v2/cluster/restores\").handleWith(this::getAllRestoreNames)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2NTQ5NA==", "bodyText": "isn't required the Subject be set in the TaskContext?", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r524365494", "createdAt": "2020-11-16T15:44:47Z", "author": {"login": "pruivo"}, "path": "server/rest/src/main/java/org/infinispan/rest/resources/LoggingResource.java", "diffHunk": "@@ -65,37 +65,38 @@ public Invocations getInvocations() {\n                   .addOptionalParameter(\"loggerName\", loggerName)\n                   .addOptionalParameter(\"level\", level)\n                   .addOptionalParameter(\"appenders\", appenders)\n-      ).handle((o, t) -> {\n-         NettyRestResponse.Builder response = new NettyRestResponse.Builder();\n-         if (t == null) {\n-            response.status(HttpResponseStatus.NO_CONTENT);\n+                  .subject(request.getSubject())\n+      ).handle((o, t) -> handle(t));\n+   }\n+\n+   private NettyRestResponse handle(Throwable t) {\n+      NettyRestResponse.Builder response = new NettyRestResponse.Builder();\n+      if (t == null) {\n+         response.status(HttpResponseStatus.NO_CONTENT);\n+      } else {\n+         while (t.getCause() != null) {\n+            t = t.getCause();\n+         }\n+         if (t instanceof IllegalStateException) {\n+            response.status(HttpResponseStatus.CONFLICT).entity(t.getMessage());\n+         } else if (t instanceof IllegalArgumentException) {\n+            response.status(HttpResponseStatus.BAD_REQUEST).entity(t.getMessage());\n+         } else if (t instanceof NoSuchElementException) {\n+            response.status(HttpResponseStatus.NOT_FOUND).entity(t.getMessage());\n+         } else if (t instanceof SecurityException) {\n+            response.status(HttpResponseStatus.FORBIDDEN).entity(t.getMessage());\n          } else {\n-            while (t.getCause() != null) {\n-               t = t.getCause();\n-            }\n-            if (t instanceof IllegalStateException) {\n-               response.status(HttpResponseStatus.CONFLICT).entity(t.getMessage());\n-            } else if (t instanceof IllegalArgumentException) {\n-               response.status(HttpResponseStatus.BAD_REQUEST).entity(t.getMessage());\n-            } else if (t instanceof NoSuchElementException) {\n-               response.status(HttpResponseStatus.NOT_FOUND).entity(t.getMessage());\n-            } else {\n-               response.status(HttpResponseStatus.INTERNAL_SERVER_ERROR).entity(t.getMessage());\n-            }\n+            response.status(HttpResponseStatus.INTERNAL_SERVER_ERROR).entity(t.getMessage());\n          }\n-         return response.build();\n-      });\n+      }\n+      return response.build();\n    }\n \n    private CompletionStage<RestResponse> deleteLogger(RestRequest request) {\n       TaskManager taskManager = invocationHelper.getServer().getTaskManager();\n       String loggerName = request.variables().get(\"loggerName\");\n       return taskManager.runTask(\"@@logging@remove\", new TaskContext().addParameter(\"loggerName\", loggerName))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2NjY0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  authzHelper.checkPermission(cacheManager.getSubject(), AuthorizationPermission.ADMIN);\n          \n          \n            \n                  authzHelper.checkPermission(cacheManager.getSubject(), permission);", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r524366643", "createdAt": "2020-11-16T15:46:08Z", "author": {"login": "pruivo"}, "path": "server/runtime/src/main/java/org/infinispan/server/SecurityActions.java", "diffHunk": "@@ -110,4 +112,9 @@ static void setInitialContextFactoryBuilder(InitialContextFactoryBuilder initial\n          return null;\n       });\n    }\n+\n+   static void checkPermission(EmbeddedCacheManager cacheManager, AuthorizationPermission permission) {\n+      AuthorizationHelper authzHelper = getGlobalComponentRegistry(cacheManager).getComponent(AuthorizationHelper.class);\n+      authzHelper.checkPermission(cacheManager.getSubject(), AuthorizationPermission.ADMIN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55701b81662f4107e7c7f01bbfe80c86e03759d7"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bfc7013b4d5ec80097c89c5529d834dea3298b16", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/bfc7013b4d5ec80097c89c5529d834dea3298b16", "committedDate": "2020-11-16T15:46:48Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "269fd109a3b008853b4a406ba4f1985a6969af80", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/269fd109a3b008853b4a406ba4f1985a6969af80", "committedDate": "2020-11-16T16:09:12Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "269fd109a3b008853b4a406ba4f1985a6969af80", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/269fd109a3b008853b4a406ba4f1985a6969af80", "committedDate": "2020-11-16T16:09:12Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "f423f9b6aaa7f4d5c636bcdb22271e624eeb5258", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/f423f9b6aaa7f4d5c636bcdb22271e624eeb5258", "committedDate": "2020-11-16T16:26:58Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f423f9b6aaa7f4d5c636bcdb22271e624eeb5258", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/f423f9b6aaa7f4d5c636bcdb22271e624eeb5258", "committedDate": "2020-11-16T16:26:58Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "414e9739c570796f83aa86297bc029a621ff8313", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/414e9739c570796f83aa86297bc029a621ff8313", "committedDate": "2020-11-16T16:54:47Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "414e9739c570796f83aa86297bc029a621ff8313", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/414e9739c570796f83aa86297bc029a621ff8313", "committedDate": "2020-11-16T16:54:47Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "5b206047a4f836333d13f1df4b2d9d86094c7f20", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/5b206047a4f836333d13f1df4b2d9d86094c7f20", "committedDate": "2020-11-17T17:12:57Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b206047a4f836333d13f1df4b2d9d86094c7f20", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/5b206047a4f836333d13f1df4b2d9d86094c7f20", "committedDate": "2020-11-17T17:12:57Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1", "committedDate": "2020-11-17T17:20:00Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjc0NzEy", "url": "https://github.com/infinispan/infinispan/pull/8856#pullrequestreview-533274712", "createdAt": "2020-11-18T09:54:40Z", "commit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwOTo1NDo0MFrOH1lqig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDoxMTo1MFrOH1mYrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk1MzY3NA==", "bodyText": "org.infinispan.xsite.XSiteAdminOperations#clusterStatus() needs to check for permission too.\nor is it intentional since it is a read-only operation?\nps. another one:\n\norg.infinispan.xsite.XSiteAdminOperations#nodeStatus()\norg.infinispan.xsite.XSiteAdminOperations#getTakeOfflineConfiguration()\norg.infinispan.xsite.XSiteAdminOperations#getSendingSiteName()\norg.infinispan.xsite.XSiteAdminOperations#checkSite", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r525953674", "createdAt": "2020-11-18T09:54:40Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/XSiteAdminOperations.java", "diffHunk": "@@ -59,6 +61,7 @@\n    @Inject XSiteStateTransferManager stateTransferManager;\n    @Inject CommandsFactory commandsFactory;\n    @Inject TakeOfflineManager takeOfflineManager;\n+   @Inject AuthorizationHelper authorizationHelper;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk1MzkwOA==", "bodyText": "offtopic: can you make log final too?", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r525953908", "createdAt": "2020-11-18T09:54:58Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/XSiteAdminOperations.java", "diffHunk": "@@ -59,6 +61,7 @@\n    @Inject XSiteStateTransferManager stateTransferManager;\n    @Inject CommandsFactory commandsFactory;\n    @Inject TakeOfflineManager takeOfflineManager;\n+   @Inject AuthorizationHelper authorizationHelper;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk1MzY3NA=="}, "originalCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk1NjU5OQ==", "bodyText": "can be removed. the private method takeOffline already checks the permission.", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r525956599", "createdAt": "2020-11-18T09:58:48Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/XSiteAdminOperations.java", "diffHunk": "@@ -185,6 +189,7 @@ public String setTakeOfflineAfterFailures(\n    public String setTakeOfflineMinTimeToWait(\n          @Parameter(name = \"site\", description = \"The name of the backup site\") String site,\n          @Parameter(name = \"minTimeToWait\", description = \"The minimum amount of time in milliseconds to wait before taking a site offline\") long minTimeToWait) {\n+      authorizationHelper.checkPermission(AuthorizationPermission.ADMIN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk2MDE2Mw==", "bodyText": "stupid question: isn't cacheManager.withSubject(Security.getSubject()) required here in this class?", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r525960163", "createdAt": "2020-11-18T10:03:59Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/GlobalXSiteAdminOperations.java", "diffHunk": "@@ -107,6 +108,7 @@ public final String cancelPushState(@Parameter(description = \"The destination si\n    }\n \n    public final Map<String, SiteStatus> globalStatus() {\n+      SecurityActions.checkPermission(cacheManager, AuthorizationPermission.ADMIN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk2MzMwOQ==", "bodyText": "nitpick\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     Security.doAs(restRequest.getSubject(), (PrivilegedAction) () -> {\n          \n          \n            \n                     Security.doAs(restRequest.getSubject(), (PrivilegedAction<Void>) () -> {", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r525963309", "createdAt": "2020-11-18T10:08:36Z", "author": {"login": "pruivo"}, "path": "server/rest/src/main/java/org/infinispan/rest/resources/ClusterResource.java", "diffHunk": "@@ -49,16 +51,22 @@ public Invocations getInvocations() {\n       List<String> servers = restRequest.parameters().get(\"server\");\n \n       if (servers != null && !servers.isEmpty()) {\n-         invocationHelper.getServer().serverStop(servers);\n+         Security.doAs(restRequest.getSubject(), (PrivilegedAction) () -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk2MzQ1Mw==", "bodyText": "nitpick\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     Security.doAs(restRequest.getSubject(), (PrivilegedAction) () -> {\n          \n          \n            \n                     Security.doAs(restRequest.getSubject(), (PrivilegedAction<Void>) () -> {", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r525963453", "createdAt": "2020-11-18T10:08:50Z", "author": {"login": "pruivo"}, "path": "server/rest/src/main/java/org/infinispan/rest/resources/ClusterResource.java", "diffHunk": "@@ -49,16 +51,22 @@ public Invocations getInvocations() {\n       List<String> servers = restRequest.parameters().get(\"server\");\n \n       if (servers != null && !servers.isEmpty()) {\n-         invocationHelper.getServer().serverStop(servers);\n+         Security.doAs(restRequest.getSubject(), (PrivilegedAction) () -> {\n+            invocationHelper.getServer().serverStop(servers);\n+            return null;\n+         });\n       } else {\n-         invocationHelper.getServer().clusterStop();\n+         Security.doAs(restRequest.getSubject(), (PrivilegedAction) () -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk2Mzc5Mg==", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Set<String> names = Security.doAs(request.getSubject(), (PrivilegedAction<Set<String>>) () -> backupManager.getBackupNames());\n          \n          \n            \n                  Set<String> names = Security.doAs(request.getSubject(), (PrivilegedAction<Set<String>>) backupManager::getBackupNames);", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r525963792", "createdAt": "2020-11-18T10:09:21Z", "author": {"login": "pruivo"}, "path": "server/rest/src/main/java/org/infinispan/rest/resources/ClusterResource.java", "diffHunk": "@@ -49,16 +51,22 @@ public Invocations getInvocations() {\n       List<String> servers = restRequest.parameters().get(\"server\");\n \n       if (servers != null && !servers.isEmpty()) {\n-         invocationHelper.getServer().serverStop(servers);\n+         Security.doAs(restRequest.getSubject(), (PrivilegedAction) () -> {\n+            invocationHelper.getServer().serverStop(servers);\n+            return null;\n+         });\n       } else {\n-         invocationHelper.getServer().clusterStop();\n+         Security.doAs(restRequest.getSubject(), (PrivilegedAction) () -> {\n+            invocationHelper.getServer().clusterStop();\n+            return null;\n+         });\n       }\n       return CompletableFuture.completedFuture(new NettyRestResponse.Builder().status(NO_CONTENT).build());\n    }\n \n    private CompletionStage<RestResponse> getAllBackupNames(RestRequest request) {\n       BackupManager backupManager = invocationHelper.getServer().getBackupManager();\n-      Set<String> names = backupManager.getBackupNames();\n+      Set<String> names = Security.doAs(request.getSubject(), (PrivilegedAction<Set<String>>) () -> backupManager.getBackupNames());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk2NDAzNw==", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  Set<String> names = Security.doAs(request.getSubject(), (PrivilegedAction<Set<String>>) () -> backupManager.getRestoreNames());\n          \n          \n            \n                  Set<String> names = Security.doAs(request.getSubject(), (PrivilegedAction<Set<String>>) backupManager::getRestoreNames);", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r525964037", "createdAt": "2020-11-18T10:09:41Z", "author": {"login": "pruivo"}, "path": "server/rest/src/main/java/org/infinispan/rest/resources/ClusterResource.java", "diffHunk": "@@ -69,7 +77,7 @@ public Invocations getInvocations() {\n \n    private CompletionStage<RestResponse> getAllRestoreNames(RestRequest request) {\n       BackupManager backupManager = invocationHelper.getServer().getBackupManager();\n-      Set<String> names = backupManager.getRestoreNames();\n+      Set<String> names = Security.doAs(request.getSubject(), (PrivilegedAction<Set<String>>) () -> backupManager.getRestoreNames());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk2NTQ4Ng==", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     Map<String, SiteStatus> globalStatus = Security.doAs(request.getSubject(), (PrivilegedAction<Map<String, SiteStatus>>) () -> globalXSiteAdmin.globalStatus());\n          \n          \n            \n                     Map<String, SiteStatus> globalStatus = Security.doAs(request.getSubject(), (PrivilegedAction<Map<String, SiteStatus>>) globalXSiteAdmin::globalStatus);", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r525965486", "createdAt": "2020-11-18T10:11:50Z", "author": {"login": "pruivo"}, "path": "server/rest/src/main/java/org/infinispan/rest/resources/XSiteResource.java", "diffHunk": "@@ -117,7 +119,8 @@ public Invocations getInvocations() {\n       if (globalXSiteAdmin == null) return CompletableFuture.completedFuture(responseBuilder.status(NOT_FOUND).build());\n \n       return CompletableFuture.supplyAsync(() -> {\n-         Map<String, GlobalStatus> collect = globalXSiteAdmin.globalStatus().entrySet().stream().collect(Collectors.toMap(Entry::getKey, e -> {\n+         Map<String, SiteStatus> globalStatus = Security.doAs(request.getSubject(), (PrivilegedAction<Map<String, SiteStatus>>) () -> globalXSiteAdmin.globalStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/ccefdd1e4d536c153f5a4b03eac3f503bd8e1fe1", "committedDate": "2020-11-17T17:20:00Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "0780cc0178cc83265ebcedf3d4fa4b22a0f2d144", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/0780cc0178cc83265ebcedf3d4fa4b22a0f2d144", "committedDate": "2020-11-18T12:50:26Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0780cc0178cc83265ebcedf3d4fa4b22a0f2d144", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/0780cc0178cc83265ebcedf3d4fa4b22a0f2d144", "committedDate": "2020-11-18T12:50:26Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "3a1cb95275a3e8b347d0da175bfcccf438b14dbd", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/3a1cb95275a3e8b347d0da175bfcccf438b14dbd", "committedDate": "2020-11-18T17:13:22Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a1cb95275a3e8b347d0da175bfcccf438b14dbd", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/3a1cb95275a3e8b347d0da175bfcccf438b14dbd", "committedDate": "2020-11-18T17:13:22Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "84b02f5dcde40b3c4bd873bc5395fefe03fe8051", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/84b02f5dcde40b3c4bd873bc5395fefe03fe8051", "committedDate": "2020-11-19T10:56:42Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MjcwNjQ3", "url": "https://github.com/infinispan/infinispan/pull/8856#pullrequestreview-534270647", "createdAt": "2020-11-19T10:19:16Z", "commit": {"oid": "3a1cb95275a3e8b347d0da175bfcccf438b14dbd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDoxOToxNlrOH2WDvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMTowNjoyOFrOH2X5EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc0NjU1Ng==", "bodyText": "nit: remove extra spaces :)", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r526746556", "createdAt": "2020-11-19T10:19:16Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/security/Security.java", "diffHunk": "@@ -107,25 +125,13 @@ private static boolean isTrustedClass(Class<?> klass) {\n    public static <T> T doAs(final Subject subject,\n          final java.security.PrivilegedExceptionAction<T> action)\n          throws java.security.PrivilegedActionException {\n-      Deque<Subject> stack = SUBJECT.get();\n-      if (stack == null) {\n-         stack = new ArrayDeque<>();\n-         SUBJECT.set(stack);\n-      }\n-      if (subject != null) {\n-         stack.push(subject);\n-      }\n+      Deque<Subject> stack = pre(subject);\n       try {\n          return action.run();\n       } catch (Exception e) {\n-         throw new PrivilegedActionException(e);\n+            throw new PrivilegedActionException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a1cb95275a3e8b347d0da175bfcccf438b14dbd"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1OTA5OQ==", "bodyText": "missing check in org.infinispan.query.impl.massindex.DistributedExecutorMassIndexer#run(java.lang.Object...). it doesn't use executeInternal().\nNot sure if it is worth to protect org.infinispan.query.impl.massindex.DistributedExecutorMassIndexer#isRunning()", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r526759099", "createdAt": "2020-11-19T10:38:59Z", "author": {"login": "pruivo"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/DistributedExecutorMassIndexer.java", "diffHunk": "@@ -60,6 +63,7 @@ public DistributedExecutorMassIndexer(AdvancedCache<?, ?> cache, KeyTransformati\n       this.blockingManager = cache.getCacheManager().getGlobalComponentRegistry()\n             .getComponent(BlockingManager.class);\n       this.lock = MassIndexerLockFactory.buildLock(cache);\n+      this.authorizationHelper = cache.getComponentRegistry().getComponent(AuthorizationHelper.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a1cb95275a3e8b347d0da175bfcccf438b14dbd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1OTcyNw==", "bodyText": "isn't this overkill? could invoke the method directly in AuthorizationHelper", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r526759727", "createdAt": "2020-11-19T10:39:58Z", "author": {"login": "pruivo"}, "path": "query/src/main/java/org/infinispan/query/impl/massindex/SecurityActions.java", "diffHunk": "@@ -32,4 +34,8 @@ private SecurityActions() {\n          return cache;\n       }\n    }\n+\n+   static void checkPermission(AuthorizationHelper authorizationHelper, AuthorizationPermission permission) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a1cb95275a3e8b347d0da175bfcccf438b14dbd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3MjMyNQ==", "bodyText": "Missing test annotation.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               public void testRestNonAdminsMustNotAccessBackupsAndRestores() {\n          \n          \n            \n               @Test\n          \n          \n            \n               public void testRestNonAdminsMustNotAccessBackupsAndRestores() {", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r526772325", "createdAt": "2020-11-19T10:59:28Z", "author": {"login": "pruivo"}, "path": "server/tests/src/test/java/org/infinispan/server/security/authorization/AbstractAuthorization.java", "diffHunk": "@@ -207,6 +208,98 @@ public void testAnonymousHealthPredefinedCache() {\n       assertEquals(\"HEALTHY\", sync(client.cacheManager(\"default\").healthStatus()).getBody());\n    }\n \n+   @Test\n+   public void testRestNonAdminsMustNotShutdownServer() {\n+      for (String user : Arrays.asList(\"reader\", \"writer\", \"supervisor\")) {\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().server().stop()).getStatus());\n+      }\n+   }\n+\n+   @Test\n+   public void testRestNonAdminsMustNotShutdownCluster() {\n+      for (String user : Arrays.asList(\"reader\", \"writer\", \"supervisor\")) {\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cluster().stop()).getStatus());\n+      }\n+   }\n+\n+   @Test\n+   public void testRestNonAdminsMustNotModifyCacheIgnores() {\n+      for (String user : Arrays.asList(\"reader\", \"writer\", \"supervisor\")) {\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().server().ignoreCache(\"default\", \"predefined\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().server().unIgnoreCache(\"default\", \"predefined\")).getStatus());\n+      }\n+   }\n+\n+   @Test\n+   public void testRestAdminsShouldBeAbleToModifyLoggers() {\n+      assertEquals(204, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(\"admin\")).get().server().logging().setLogger(\"org.infinispan.TEST_LOGGER\", \"ERROR\", \"STDOUT\")).getStatus());\n+      assertEquals(204, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(\"admin\")).get().server().logging().removeLogger(\"org.infinispan.TEST_LOGGER\")).getStatus());\n+   }\n+\n+   @Test\n+   public void testRestNonAdminsMustNotModifyLoggers() {\n+      for (String user : Arrays.asList(\"reader\", \"writer\", \"supervisor\")) {\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().server().logging().setLogger(\"org.infinispan.TEST_LOGGER\", \"ERROR\", \"STDOUT\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().server().logging().removeLogger(\"org.infinispan.TEST_LOGGER\")).getStatus());\n+      }\n+   }\n+\n+   @Test\n+   public void testRestNonAdminsMustNotObtainReport() {\n+      for (String user : Arrays.asList(\"reader\", \"writer\", \"supervisor\")) {\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().server().report()).getStatus());\n+      }\n+   }\n+\n+   @Test\n+   public void testRestNonAdminsMustNotAccessPerformXSiteOps() {\n+      for (String user : Arrays.asList(\"reader\", \"writer\", \"supervisor\")) {\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").takeSiteOffline(\"NYC\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").bringSiteOnline(\"NYC\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").cancelPushState(\"NYC\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").cancelReceiveState(\"NYC\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").clearPushStateStatus()).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").pushSiteState(\"NYC\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").pushStateStatus()).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").xsiteBackups()).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").backupStatus(\"NYC\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").getXSiteTakeOfflineConfig(\"NYC\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(\"xsite\").updateXSiteTakeOfflineConfig(\"NYC\", 10, 1000)).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cacheManager(\"default\").bringBackupOnline(\"NYC\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cacheManager(\"default\").takeOffline(\"NYC\")).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cacheManager(\"default\").backupStatuses()).getStatus());\n+      }\n+   }\n+\n+   @Test\n+   public void testRestNonAdminsMustNotPerformSearchActions() {\n+      String schema = Exceptions.unchecked(() -> Util.getResourceAsString(\"/sample_bank_account/bank.proto\", this.getClass().getClassLoader()));\n+      assertEquals(200, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(\"admin\")).get().schemas().put(\"bank.proto\", schema)).getStatus());\n+      org.infinispan.configuration.cache.ConfigurationBuilder builder = new org.infinispan.configuration.cache.ConfigurationBuilder();\n+      builder.indexing().enable().addIndexedEntity(\"sample_bank_account.User\");\n+      getServerTest().rest().withClientConfiguration(restBuilders.get(\"admin\")).withServerConfiguration(builder).create();\n+      String indexedCache = getServerTest().getMethodName();\n+\n+      for (String user : Arrays.asList(\"reader\", \"writer\", \"supervisor\")) {\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(indexedCache).clearSearchStats()).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(indexedCache).reindex()).getStatus());\n+         assertEquals(403, sync(getServerTest().rest().withClientConfiguration(restBuilders.get(user)).get().cache(indexedCache).clearIndex()).getStatus());\n+      }\n+   }\n+\n+   public void testRestNonAdminsMustNotAccessBackupsAndRestores() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84b02f5dcde40b3c4bd873bc5395fefe03fe8051"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc3NjU5Mw==", "bodyText": "wait!? is this correct? username equals to password?", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r526776593", "createdAt": "2020-11-19T11:06:28Z", "author": {"login": "pruivo"}, "path": "server/rest/src/test/java/org/infinispan/rest/resources/security/SimpleSecurityDomain.java", "diffHunk": "@@ -1,24 +1,30 @@\n package org.infinispan.rest.resources.security;\n \n+import java.util.HashMap;\n+import java.util.Map;\n+\n import javax.security.auth.Subject;\n \n import org.infinispan.rest.authentication.SecurityDomain;\n \n /**\n- * Security domain that returns always the same subject\n+ * Security domain that supports a simple map of subjects\n  */\n public class SimpleSecurityDomain implements SecurityDomain {\n \n-   private final Subject subject;\n+   private final Map<String, Subject> subjects;\n \n-   public SimpleSecurityDomain(Subject subject) {\n-      this.subject = subject;\n+   public SimpleSecurityDomain(Subject... subjects) {\n+      this.subjects = new HashMap<>(subjects.length);\n+      for (Subject subject : subjects) {\n+         this.subjects.put(subject.getPrincipals().iterator().next().getName().toLowerCase(), subject);\n+      }\n    }\n \n    @Override\n    public Subject authenticate(String username, String password) throws SecurityException {\n       if (username.equals(password)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84b02f5dcde40b3c4bd873bc5395fefe03fe8051"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84b02f5dcde40b3c4bd873bc5395fefe03fe8051", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/84b02f5dcde40b3c4bd873bc5395fefe03fe8051", "committedDate": "2020-11-19T10:56:42Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "a53cd50a4d560c7f7281ee1eed58077c264d5303", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/a53cd50a4d560c7f7281ee1eed58077c264d5303", "committedDate": "2020-11-19T11:18:23Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MzUxMTk0", "url": "https://github.com/infinispan/infinispan/pull/8856#pullrequestreview-534351194", "createdAt": "2020-11-19T11:55:32Z", "commit": {"oid": "a53cd50a4d560c7f7281ee1eed58077c264d5303"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMTo1NTozMlrOH2Z78Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMTo1NzoyMlrOH2aAOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgxMDA5Nw==", "bodyText": "why is this required? the cache already contains the subject (via Cache.withSubject())", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r526810097", "createdAt": "2020-11-19T11:55:32Z", "author": {"login": "pruivo"}, "path": "server/rest/src/main/java/org/infinispan/rest/resources/SearchAdminResource.java", "diffHunk": "@@ -108,7 +109,7 @@ public Invocations getInvocations() {\n          throw new CacheException(\"NotImplemented\");\n       } else {\n          SearchStatistics searchStatistics = Search.getSearchStatistics(cache);\n-         searchStatistics.getQueryStatistics().clear();\n+         Security.doAs(restRequest.getSubject(), () -> searchStatistics.getQueryStatistics().clear());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a53cd50a4d560c7f7281ee1eed58077c264d5303"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgxMTE5Mw==", "bodyText": "shouldn't this be invoked only when security==false?", "url": "https://github.com/infinispan/infinispan/pull/8856#discussion_r526811193", "createdAt": "2020-11-19T11:57:22Z", "author": {"login": "pruivo"}, "path": "server/rest/src/test/java/org/infinispan/rest/resources/CacheV2ResourceTest.java", "diffHunk": "@@ -643,6 +644,11 @@ public void testSearchStatistics() {\n \n       // Clear all stats\n       RestResponse response = join(cacheClient.clearSearchStats());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a53cd50a4d560c7f7281ee1eed58077c264d5303"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a53cd50a4d560c7f7281ee1eed58077c264d5303", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/a53cd50a4d560c7f7281ee1eed58077c264d5303", "committedDate": "2020-11-19T11:18:23Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "88874ec4d7837a03920b74e041e0d13be60bef38", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/88874ec4d7837a03920b74e041e0d13be60bef38", "committedDate": "2020-11-19T14:13:48Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88874ec4d7837a03920b74e041e0d13be60bef38", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/88874ec4d7837a03920b74e041e0d13be60bef38", "committedDate": "2020-11-19T14:13:48Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "ff5f00cb606470d76d129ec43d4a1e0287feea2f", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/ff5f00cb606470d76d129ec43d4a1e0287feea2f", "committedDate": "2020-11-24T16:47:18Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a4e9a0171dae0740fa4b98ed4c24b1adde16e1a", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/0a4e9a0171dae0740fa4b98ed4c24b1adde16e1a", "committedDate": "2020-11-25T07:56:33Z", "message": "ISPN-12498 Check authorization on server management ops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dfcd56e6f1346351fd56b2a37cc8f05493ea3a5", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/6dfcd56e6f1346351fd56b2a37cc8f05493ea3a5", "committedDate": "2020-11-25T07:56:33Z", "message": "ISPN-12498 Check authorization on search actions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38ebb5bf74eab2d591a332b091d9a36facc750d6", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/38ebb5bf74eab2d591a332b091d9a36facc750d6", "committedDate": "2020-11-25T07:56:33Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff5f00cb606470d76d129ec43d4a1e0287feea2f", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/ff5f00cb606470d76d129ec43d4a1e0287feea2f", "committedDate": "2020-11-24T16:47:18Z", "message": "ISPN-12498 Check authorization on backup manager ops"}, "afterCommit": {"oid": "38ebb5bf74eab2d591a332b091d9a36facc750d6", "author": {"user": {"login": "tristantarrant", "name": "Tristan Tarrant"}}, "url": "https://github.com/infinispan/infinispan/commit/38ebb5bf74eab2d591a332b091d9a36facc750d6", "committedDate": "2020-11-25T07:56:33Z", "message": "ISPN-12498 Check authorization on backup manager ops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NTU2MjI0", "url": "https://github.com/infinispan/infinispan/pull/8856#pullrequestreview-538556224", "createdAt": "2020-11-25T14:30:26Z", "commit": {"oid": "38ebb5bf74eab2d591a332b091d9a36facc750d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 298, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}