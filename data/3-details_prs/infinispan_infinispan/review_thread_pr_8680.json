{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzNjcwOTM5", "number": 8680, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNToxOTo1NlrOEw0ZWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo1NToxMlrOEw1aiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NjI1NTYyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/commands/irac/IracMetadataRequestCommand.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNToxOTo1NlrOHmnFtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxOToyNzoyMlrOHmwmcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0ODM3NA==", "bodyText": "Looks like topologyId can be removed as well?", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510248374", "createdAt": "2020-10-22T15:19:56Z", "author": {"login": "wburns"}, "path": "core/src/main/java/org/infinispan/commands/irac/IracMetadataRequestCommand.java", "diffHunk": "@@ -90,6 +92,7 @@ public String toString() {\n             \"cacheName=\" + cacheName +\n             \", segment=\" + segment +\n             \", topologyId=\" + topologyId +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4539874c28934d83ab4afadf531524c8925468e2"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0NjU1OA==", "bodyText": "not really. It makes sure the node has at least that topology installed before handling the executing the command.", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510346558", "createdAt": "2020-10-22T17:45:51Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/commands/irac/IracMetadataRequestCommand.java", "diffHunk": "@@ -90,6 +92,7 @@ public String toString() {\n             \"cacheName=\" + cacheName +\n             \", segment=\" + segment +\n             \", topologyId=\" + topologyId +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0ODM3NA=="}, "originalCommit": {"oid": "4539874c28934d83ab4afadf531524c8925468e2"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0NzQzNQ==", "bodyText": "Shouldn't it be part of the readFrom and writeTo though?", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510347435", "createdAt": "2020-10-22T17:47:19Z", "author": {"login": "wburns"}, "path": "core/src/main/java/org/infinispan/commands/irac/IracMetadataRequestCommand.java", "diffHunk": "@@ -90,6 +92,7 @@ public String toString() {\n             \"cacheName=\" + cacheName +\n             \", segment=\" + segment +\n             \", topologyId=\" + topologyId +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0ODM3NA=="}, "originalCommit": {"oid": "4539874c28934d83ab4afadf531524c8925468e2"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQwNDIxMQ==", "bodyText": "no, the previous code was incorrect.\nThe CacheRpcCommandExternalizer [1] invokes the ReplicableCommandExternalizer [2] and the latter sends the topology id.\n[1] https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/marshall/exts/CacheRpcCommandExternalizer.java#L142\n[2] https://github.com/infinispan/infinispan/blob/master/core/src/main/java/org/infinispan/marshall/exts/ReplicableCommandExternalizer.java#L82", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510404211", "createdAt": "2020-10-22T19:27:22Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/commands/irac/IracMetadataRequestCommand.java", "diffHunk": "@@ -90,6 +92,7 @@ public String toString() {\n             \"cacheName=\" + cacheName +\n             \", segment=\" + segment +\n             \", topologyId=\" + topologyId +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI0ODM3NA=="}, "originalCommit": {"oid": "4539874c28934d83ab4afadf531524c8925468e2"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NjM5NDUzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/container/versioning/irac/TopologyIracVersion.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo0OToyMFrOHmoc2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzo0ODoxMFrOHmtKpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3MDY4Mw==", "bodyText": "This seems awfully expensive to compile a new Pattern on every invocation. I would suggest to store the compiled pattern statically.", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510270683", "createdAt": "2020-10-22T15:49:20Z", "author": {"login": "wburns"}, "path": "core/src/main/java/org/infinispan/container/versioning/irac/TopologyIracVersion.java", "diffHunk": "@@ -36,6 +49,16 @@ public static TopologyIracVersion max(TopologyIracVersion v1, TopologyIracVersio\n       return v1.compareTo(v2) < 0 ? v2 : v1;\n    }\n \n+   public static TopologyIracVersion fromString(String s) {\n+      Matcher m = Pattern.compile(REGEX).matcher(s);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4539874c28934d83ab4afadf531524c8925468e2"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0Nzk0Mg==", "bodyText": "right!", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510347942", "createdAt": "2020-10-22T17:48:10Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/container/versioning/irac/TopologyIracVersion.java", "diffHunk": "@@ -36,6 +49,16 @@ public static TopologyIracVersion max(TopologyIracVersion v1, TopologyIracVersio\n       return v1.compareTo(v2) < 0 ? v2 : v1;\n    }\n \n+   public static TopologyIracVersion fromString(String s) {\n+      Matcher m = Pattern.compile(REGEX).matcher(s);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3MDY4Mw=="}, "originalCommit": {"oid": "4539874c28934d83ab4afadf531524c8925468e2"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NjQwNTMzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/container/versioning/irac/TopologyIracVersion.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo1MTozN1rOHmojkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzo0ODozOVrOHmtLuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3MjQwMw==", "bodyText": "Is there a reason this was changed? The prior appending is much faster and a bit easier to read imo.", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510272403", "createdAt": "2020-10-22T15:51:37Z", "author": {"login": "wburns"}, "path": "core/src/main/java/org/infinispan/container/versioning/irac/TopologyIracVersion.java", "diffHunk": "@@ -63,7 +86,7 @@ public int compareTo(TopologyIracVersion other) {\n \n    @Override\n    public String toString() {\n-      return '(' + Integer.toString(topologyId) + ':' + version + ')';\n+      return String.format(FMT, topologyId, version);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4539874c28934d83ab4afadf531524c8925468e2"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0ODIxOQ==", "bodyText": "I've spent too much time in python xD", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510348219", "createdAt": "2020-10-22T17:48:39Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/container/versioning/irac/TopologyIracVersion.java", "diffHunk": "@@ -63,7 +86,7 @@ public int compareTo(TopologyIracVersion other) {\n \n    @Override\n    public String toString() {\n-      return '(' + Integer.toString(topologyId) + ':' + version + ')';\n+      return String.format(FMT, topologyId, version);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3MjQwMw=="}, "originalCommit": {"oid": "4539874c28934d83ab4afadf531524c8925468e2"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NjQyMjUxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/interceptors/impl/NonTxIracLocalSiteInterceptor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo1NToxMlrOHmouHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNTo1NToxMlrOHmouHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI3NTEwMA==", "bodyText": "Good catch \ud83d\udc4d", "url": "https://github.com/infinispan/infinispan/pull/8680#discussion_r510275100", "createdAt": "2020-10-22T15:55:12Z", "author": {"login": "wburns"}, "path": "core/src/main/java/org/infinispan/interceptors/impl/NonTxIracLocalSiteInterceptor.java", "diffHunk": "@@ -226,20 +225,21 @@ private void handleDataWriteCommand(InvocationContext ctx, DataWriteCommand comm\n    /**\n     * Visits th {@link WriteCommand} after executed and stores the {@link IracMetadata} if it was successful.\n     */\n+   @SuppressWarnings(\"unused\")\n    private void handleWriteCommand(InvocationContext ctx, WriteCommand command, Object rv, Throwable t) {\n       if (!command.isSuccessful()) {\n          return;\n       }\n       for (Object key : command.getAffectedKeys()) {\n-         if (skipEntryCommit(ctx, key)) {\n+         if (skipEntryCommit(ctx, command, key)) {\n             continue;\n          }\n          setMetadataToCacheEntry(ctx.lookupEntry(key), command.getInternalMetadata(key).iracMetadata());\n       }\n    }\n \n-   private boolean skipEntryCommit(InvocationContext ctx, Object key) {\n-      switch (getOwnership(key)) {\n+   private boolean skipEntryCommit(InvocationContext ctx, WriteCommand command, Object key) {\n+      switch (getOwnership(getSegment(command, key))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4539874c28934d83ab4afadf531524c8925468e2"}, "originalPosition": 99}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3934, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}