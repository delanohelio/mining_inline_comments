{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MTA0OTYy", "number": 8752, "title": "ISPN-12394 Allow templates to be defined clusterwide and persisted", "bodyText": "https://issues.redhat.com/browse/ISPN-12394\nhttps://issues.redhat.com/browse/ISPN-12411", "createdAt": "2020-10-07T09:17:32Z", "url": "https://github.com/infinispan/infinispan/pull/8752", "merged": true, "mergeCommit": {"oid": "c50588e1d457e9bc46ee2f405687095755ef87fa"}, "closed": true, "closedAt": "2020-10-19T19:24:26Z", "author": {"login": "ryanemerson"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQJ4fGABqjM4NDk2MTk0OTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVTHykgFqTUxNTQ3NTg2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b5b04c4e262453dc50401b13f1bb59a8a9d19aa", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/8b5b04c4e262453dc50401b13f1bb59a8a9d19aa", "committedDate": "2020-10-07T09:14:01Z", "message": "ISPN-12394 Allow templates to be defined clusterwide and persisted"}, "afterCommit": {"oid": "f9df257fac1d6ff4b3c6f664393fa30329558ce8", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/f9df257fac1d6ff4b3c6f664393fa30329558ce8", "committedDate": "2020-10-07T09:50:41Z", "message": "ISPN-12394 Allow templates to be defined clusterwide and persisted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9df257fac1d6ff4b3c6f664393fa30329558ce8", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/f9df257fac1d6ff4b3c6f664393fa30329558ce8", "committedDate": "2020-10-07T09:50:41Z", "message": "ISPN-12394 Allow templates to be defined clusterwide and persisted"}, "afterCommit": {"oid": "8eaea95270d782b5785116da42056b4889f23135", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/8eaea95270d782b5785116da42056b4889f23135", "committedDate": "2020-10-07T12:36:39Z", "message": "ISPN-12394 Allow templates to be defined clusterwide and persisted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8eaea95270d782b5785116da42056b4889f23135", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/8eaea95270d782b5785116da42056b4889f23135", "committedDate": "2020-10-07T12:36:39Z", "message": "ISPN-12394 Allow templates to be defined clusterwide and persisted"}, "afterCommit": {"oid": "b8b3f02be9c680a8ae4d7187e674d66628fe78e2", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/b8b3f02be9c680a8ae4d7187e674d66628fe78e2", "committedDate": "2020-10-08T15:35:53Z", "message": "ISPN-12394 Allow templates to be defined clusterwide and persisted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8b3f02be9c680a8ae4d7187e674d66628fe78e2", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/b8b3f02be9c680a8ae4d7187e674d66628fe78e2", "committedDate": "2020-10-08T15:35:53Z", "message": "ISPN-12394 Allow templates to be defined clusterwide and persisted"}, "afterCommit": {"oid": "75067f76897596eafc79f9f66ac8cb1954ec73ea", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/75067f76897596eafc79f9f66ac8cb1954ec73ea", "committedDate": "2020-10-08T16:28:26Z", "message": "ISPN-12394 Allow templates to be defined clusterwide and persisted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDA2Njkw", "url": "https://github.com/infinispan/infinispan/pull/8752#pullrequestreview-507406690", "createdAt": "2020-10-13T13:01:22Z", "commit": {"oid": "cde276338614e5df352a0a0b04e733925e4edaef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzowMToyMlrOHglffg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzowMToyMlrOHglffg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkzMDc1MA==", "bodyText": "Why didn't you add these to CacheContainerAdmin instead so that they can be shared with EmbeddedCacheManagerAdmin", "url": "https://github.com/infinispan/infinispan/pull/8752#discussion_r503930750", "createdAt": "2020-10-13T13:01:22Z", "author": {"login": "tristantarrant"}, "path": "client/hotrod-client/src/main/java/org/infinispan/client/hotrod/RemoteCacheManagerAdmin.java", "diffHunk": "@@ -102,4 +102,23 @@\n     * @throws HotRodClientException\n     */\n    void reindexCache(String name) throws HotRodClientException;\n+\n+   /**\n+    * Retrieves an existing template on the remote server cluster. If it doesn't exist, it will be created using the\n+    * specified template name.\n+    *\n+    * @param name the name of the template to create\n+    * @param configuration the configuration object\n+    *\n+    * @throws HotRodClientException\n+    */\n+   void createTemplate(String name, BasicConfiguration configuration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cde276338614e5df352a0a0b04e733925e4edaef"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bc227d9ba09522383f6b42eb9c06ca347e6fc2a", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/2bc227d9ba09522383f6b42eb9c06ca347e6fc2a", "committedDate": "2020-10-13T13:56:03Z", "message": "ISPN-12394 Allow templates to be defined clusterwide and persisted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "155b1ff04ca5322b446cf00c6af8825628d6717a", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/155b1ff04ca5322b446cf00c6af8825628d6717a", "committedDate": "2020-10-13T13:56:03Z", "message": "ISPN-12411 org.infinispan.CONFIG should ignore zero-capacity-node=true"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cde276338614e5df352a0a0b04e733925e4edaef", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/cde276338614e5df352a0a0b04e733925e4edaef", "committedDate": "2020-10-09T12:54:50Z", "message": "ISPN-12411 org.infinispan.CONFIG should ignore zero-capacity-node=true"}, "afterCommit": {"oid": "155b1ff04ca5322b446cf00c6af8825628d6717a", "author": {"user": {"login": "ryanemerson", "name": "Ryan Emerson"}}, "url": "https://github.com/infinispan/infinispan/commit/155b1ff04ca5322b446cf00c6af8825628d6717a", "committedDate": "2020-10-13T13:56:03Z", "message": "ISPN-12411 org.infinispan.CONFIG should ignore zero-capacity-node=true"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NDc1ODYy", "url": "https://github.com/infinispan/infinispan/pull/8752#pullrequestreview-515475862", "createdAt": "2020-10-23T09:00:20Z", "commit": {"oid": "155b1ff04ca5322b446cf00c6af8825628d6717a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwOTowMDoyMFrOHnFGDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwOToyMDozM1rOHnFzbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDczOTk4MA==", "bodyText": "What's the reason to not allow a LOCAL configuration?\nI was thinking of deprecating DefaultCacheManager.defineConfiguration() and telling the users to use the admin interface instead, but we can't do that if we don't allow LOCAL templates.", "url": "https://github.com/infinispan/infinispan/pull/8752#discussion_r510739980", "createdAt": "2020-10-23T09:00:20Z", "author": {"login": "danberindei"}, "path": "commons/all/src/main/java/org/infinispan/commons/api/CacheContainerAdmin.java", "diffHunk": "@@ -119,4 +119,19 @@ public static AdminFlag valueOf(int index) {\n     * @return\n     */\n    C withFlags(EnumSet<AdminFlag> flags);\n+\n+   /**\n+    *  Creates a template on the container using the provided configuration.\n+    *\n+    * @param name the name of the template\n+    * @param configuration the configuration to use. It must be a clustered configuration (e.g. distributed)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "155b1ff04ca5322b446cf00c6af8825628d6717a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc0MTk3Ng==", "bodyText": "In keeping with my previous comment, Defines a cache template cluster-wide would sound more friendly to LOCAL caches. It would also fit better with @oraNod's in-progress terminology PR (#8742).", "url": "https://github.com/infinispan/infinispan/pull/8752#discussion_r510741976", "createdAt": "2020-10-23T09:04:09Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/globalstate/GlobalConfigurationManager.java", "diffHunk": "@@ -26,6 +26,24 @@\n     */\n    Cache<ScopedState, Object> getStateCache();\n \n+   /**\n+    * Defines a cluster-wide configuration template", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "155b1ff04ca5322b446cf00c6af8825628d6717a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc0NzY5MA==", "bodyText": "DefaultCacheManager and Configuration don't allow a template and a cache to have the same name, shouldn't we do that here as well? Either way, the documentation should be clear about the namespaces and there should be a test.\nIt might have been simpler to keep a single scope and rely on Configuration.isTemplate() to distinguish between caches and templates.", "url": "https://github.com/infinispan/infinispan/pull/8752#discussion_r510747690", "createdAt": "2020-10-23T09:13:51Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/globalstate/impl/GlobalConfigurationManagerImpl.java", "diffHunk": "@@ -143,6 +163,28 @@ void start() {\n       return stateCache;\n    }\n \n+   @Override\n+   public CompletableFuture<Void> createTemplate(String name, Configuration configuration, EnumSet<CacheContainerAdmin.AdminFlag> flags) {\n+      Cache<ScopedState, Object> cache = getStateCache();\n+      ScopedState key = new ScopedState(TEMPLATE_SCOPE, name);\n+      return cache.containsKeyAsync(key).thenCompose(exists -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "155b1ff04ca5322b446cf00c6af8825628d6717a"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc1MTU5Nw==", "bodyText": "Shouldn't it say \"across the cluster\" as well? E.g.\nRemoves a template across the cluster. If the template is persistent, it will also be removed from persisted state.", "url": "https://github.com/infinispan/infinispan/pull/8752#discussion_r510751597", "createdAt": "2020-10-23T09:20:33Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/manager/EmbeddedCacheManagerAdmin.java", "diffHunk": "@@ -68,6 +68,37 @@\n     */\n    <K, V> Cache<K, V> getOrCreateCache(String name, Configuration configuration);\n \n+   /**\n+    * Creates a template that is replicated across the cluster using the specified configuration.\n+    * The template will survive topology changes, e.g. when a new node joins the cluster,\n+    * it will automatically be created there. This method will wait for the template to be created on all nodes before\n+    * returning.\n+    *\n+    * @param name the name of the template\n+    * @param configuration the configuration to use. It must be a clustered configuration (e.g. distributed)\n+    * @throws org.infinispan.commons.CacheConfigurationException if a template with the same name already exists\n+    */\n+   void createTemplate(String name, Configuration configuration);\n+\n+   /**\n+    * Retrieves an existing template or creates one across the cluster using the specified configuration.\n+    * The template will survive topology changes, e.g. when a new node joins the cluster,\n+    * it will automatically be created there. This method will wait for the template to be created on all nodes before\n+    * returning.\n+    *\n+    * @param name the name of the template\n+    * @param configuration the configuration to use. It must be a clustered configuration (e.g. distributed)\n+    * @return the template configuration\n+    */\n+   Configuration getOrCreateTemplate(String name, Configuration configuration);\n+\n+   /**\n+    * Removes a template from the cache container. Any persisted data will be cleared.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "155b1ff04ca5322b446cf00c6af8825628d6717a"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 359, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}