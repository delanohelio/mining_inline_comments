{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1MTk4Mjg4", "number": 8687, "title": "ISPN-12319 XSite Response should allow a value", "bodyText": "https://issues.redhat.com/browse/ISPN-12319", "createdAt": "2020-09-11T15:36:09Z", "url": "https://github.com/infinispan/infinispan/pull/8687", "merged": true, "mergeCommit": {"oid": "3305fbdb3e7ced30af4479502797df89eaf865fb"}, "closed": true, "closedAt": "2020-09-15T09:46:43Z", "author": {"login": "wburns"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH3nfUgBqjM3NTY5NDU0MTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI3HIkAFqTQ4ODAxNjcxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6539c31f9662e9cd254afa4671a841c4152870af", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/6539c31f9662e9cd254afa4671a841c4152870af", "committedDate": "2020-09-11T15:34:38Z", "message": "ISPN-12319 XSite Response should allow a value"}, "afterCommit": {"oid": "3f1f616e3fae976e962e44b39c307ebc4293e249", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/3f1f616e3fae976e962e44b39c307ebc4293e249", "committedDate": "2020-09-11T16:02:30Z", "message": "ISPN-12319 XSite Response should allow a value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2OTM4MzQ5", "url": "https://github.com/infinispan/infinispan/pull/8687#pullrequestreview-486938349", "createdAt": "2020-09-11T16:08:30Z", "commit": {"oid": "3f1f616e3fae976e962e44b39c307ebc4293e249"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNjowODozMFrOHQk_mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNjoyMDoyMFrOHQlYsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE0NTM2OA==", "bodyText": "can you add the generics to org.infinispan.remoting.transport.RetryOnFailureXSiteCommand#newInstance()?\njust to remove the warnings from IDEA", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487145368", "createdAt": "2020-09-11T16:08:30Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/remoting/transport/RetryOnFailureXSiteCommand.java", "diffHunk": "@@ -18,16 +18,16 @@\n  * @author Pedro Ruivo\n  * @since 7.0\n  */\n-public class RetryOnFailureXSiteCommand {\n+public class RetryOnFailureXSiteCommand<O> {\n \n    public static final RetryPolicy NO_RETRY = new MaxRetriesPolicy(0);\n    private static final Log log = LogFactory.getLog(RetryOnFailureXSiteCommand.class);\n    private static final boolean trace = log.isTraceEnabled();\n    private final XSiteBackup xSiteBackup;\n-   private final XSiteReplicateCommand command;\n+   private final XSiteReplicateCommand<O> command;\n    private final RetryPolicy retryPolicy;\n \n-   private RetryOnFailureXSiteCommand(XSiteBackup backup, XSiteReplicateCommand command, RetryPolicy retryPolicy) {\n+   private RetryOnFailureXSiteCommand(XSiteBackup backup, XSiteReplicateCommand<O> command, RetryPolicy retryPolicy) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1f616e3fae976e962e44b39c307ebc4293e249"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE0NzkwOA==", "bodyText": "nitpick\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     complete((O) response.getResponseValue());\n          \n          \n            \n                     //noinspection unchecked\n          \n          \n            \n                     complete((O) response.getResponseValue());", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487147908", "createdAt": "2020-09-11T16:13:16Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/remoting/transport/impl/XSiteResponseImpl.java", "diffHunk": "@@ -38,12 +39,12 @@ public void whenCompleted(XSiteResponseCompleted xSiteResponseCompleted) {\n    }\n \n    @Override\n-   public void accept(Object o, Throwable throwable) {\n+   public void accept(ValidResponse response, Throwable throwable) {\n       durationNanos = timeService.timeDuration(sendTimeNanos, TimeUnit.NANOSECONDS);\n       if (throwable != null) {\n          completeExceptionally(throwable);\n       } else {\n-         complete(null);\n+         complete((O) response.getResponseValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1f616e3fae976e962e44b39c307ebc4293e249"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE1MTM1Mw==", "bodyText": "-1 CacheRpcCommand doesn't require anything from the BackupReceiver and you have the ComponentRegistry available in GlobalInboundInvocationHandler\nI would change XSiteReplicateCommand to the following and make the if-else in SingleXSiteRpcCommand\n   public CompletionStage<O> performInLocalSite(ComponentRegistry registry, boolean preserveOrder) {\n      //by default, the command is executed against BackupReceiver.\n      return execute(registry.getBackupReceiver().running(), preserveOrder);\n   }\n   //abstract? or not?\n   public abstract CompletionStage<O> execute(BackupReceiver receiver, boolean preserveOrder);", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487151353", "createdAt": "2020-09-11T16:19:36Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/ClusteredCacheBackupReceiver.java", "diffHunk": "@@ -200,13 +202,20 @@ private static PrivateMetadata internalMetadata(IracMetadata metadata) {\n    }\n \n    @Override\n-   public final CompletionStage<Void> handleRemoteCommand(VisitableCommand command, boolean preserveOrder) {\n+   public final CompletionStage<Object> handleRemoteCommand(ReplicableCommand command, boolean preserveOrder) {\n+      //currently, it only handles sync xsite requests.\n+      //async xsite requests are handle by the other methods.\n+      assert !preserveOrder;\n       try {\n-         //currently, it only handles sync xsite requests.\n-         //async xsite requests are handle by the other methods.\n-         assert !preserveOrder;\n-         //noinspection unchecked\n-         return (CompletableFuture<Void>) command.acceptVisitor(null, defaultHandler);\n+         if (command instanceof VisitableCommand) {\n+            //noinspection unchecked\n+            return (CompletionStage<Object>) ((VisitableCommand)command).acceptVisitor(null, defaultHandler);\n+         } else if (command instanceof CacheRpcCommand) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1f616e3fae976e962e44b39c307ebc4293e249"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE1MTc5NA==", "bodyText": "Also, don't need to spend CPU throwing the exception. you can create the CF with it directly (completedExceptionFuture())", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r487151794", "createdAt": "2020-09-11T16:20:20Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/ClusteredCacheBackupReceiver.java", "diffHunk": "@@ -200,13 +202,20 @@ private static PrivateMetadata internalMetadata(IracMetadata metadata) {\n    }\n \n    @Override\n-   public final CompletionStage<Void> handleRemoteCommand(VisitableCommand command, boolean preserveOrder) {\n+   public final CompletionStage<Object> handleRemoteCommand(ReplicableCommand command, boolean preserveOrder) {\n+      //currently, it only handles sync xsite requests.\n+      //async xsite requests are handle by the other methods.\n+      assert !preserveOrder;\n       try {\n-         //currently, it only handles sync xsite requests.\n-         //async xsite requests are handle by the other methods.\n-         assert !preserveOrder;\n-         //noinspection unchecked\n-         return (CompletableFuture<Void>) command.acceptVisitor(null, defaultHandler);\n+         if (command instanceof VisitableCommand) {\n+            //noinspection unchecked\n+            return (CompletionStage<Object>) ((VisitableCommand)command).acceptVisitor(null, defaultHandler);\n+         } else if (command instanceof CacheRpcCommand) {\n+            //noinspection unchecked\n+            return (CompletionStage<Object>) ((CacheRpcCommand) command).invokeAsync(componentRegistry);\n+         } else {\n+            throw new UnsupportedOperationException(\"Only VisitableCommand and CacheRpcCommand is allowed!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1f616e3fae976e962e44b39c307ebc4293e249"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f39ec6aa085b01bfaf591c0c33dedc31efa96da", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/4f39ec6aa085b01bfaf591c0c33dedc31efa96da", "committedDate": "2020-09-14T14:12:38Z", "message": "trying to convert - stil broken"}, "afterCommit": {"oid": "dedb66b81c815434dd0f80f365573cec26432042", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/dedb66b81c815434dd0f80f365573cec26432042", "committedDate": "2020-09-14T17:03:52Z", "message": "ISPN-12319 XSite Response should allow a value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3OTkzODI2", "url": "https://github.com/infinispan/infinispan/pull/8687#pullrequestreview-487993826", "createdAt": "2020-09-14T17:28:58Z", "commit": {"oid": "dedb66b81c815434dd0f80f365573cec26432042"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNzoyODo1OFrOHRff-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNzozMDo1N1rOHRfkTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwMzkyOA==", "bodyText": "nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  }\n          \n          \n            \n                  else {\n          \n          \n            \n                  } else {", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r488103928", "createdAt": "2020-09-14T17:28:58Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/SingleXSiteRpcCommand.java", "diffHunk": "@@ -34,8 +37,23 @@ public SingleXSiteRpcCommand() {\n    }\n \n    @Override\n-   public CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder) {\n-      return receiver.handleRemoteCommand(command, preserveOrder);\n+   public CompletionStage<Object> performInLocalSite(ComponentRegistry registry, boolean preserveOrder) {\n+      // Need to check VisitableCommand before CacheRpcCommand as PrepareCommand implements both but need to visit\n+      if (command instanceof VisitableCommand) {\n+         return super.performInLocalSite(registry, preserveOrder);\n+      }\n+      else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dedb66b81c815434dd0f80f365573cec26432042"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNDE0MQ==", "bodyText": "nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return (CompletionStage<Object>) ((CacheRpcCommand) command).invokeAsync(registry);\n          \n          \n            \n                        //noinspection unchecked\n          \n          \n            \n                        return (CompletionStage<Object>) ((CacheRpcCommand) command).invokeAsync(registry);", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r488104141", "createdAt": "2020-09-14T17:29:20Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/SingleXSiteRpcCommand.java", "diffHunk": "@@ -34,8 +37,23 @@ public SingleXSiteRpcCommand() {\n    }\n \n    @Override\n-   public CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder) {\n-      return receiver.handleRemoteCommand(command, preserveOrder);\n+   public CompletionStage<Object> performInLocalSite(ComponentRegistry registry, boolean preserveOrder) {\n+      // Need to check VisitableCommand before CacheRpcCommand as PrepareCommand implements both but need to visit\n+      if (command instanceof VisitableCommand) {\n+         return super.performInLocalSite(registry, preserveOrder);\n+      }\n+      else {\n+         try {\n+            return (CompletionStage<Object>) ((CacheRpcCommand) command).invokeAsync(registry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dedb66b81c815434dd0f80f365573cec26432042"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEwNTAzNg==", "bodyText": "nitpick:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  XSiteReplicateCommand command = mock(XSiteReplicateCommand.class);\n          \n          \n            \n                  XSiteReplicateCommand<?> command = mock(XSiteReplicateCommand.class);", "url": "https://github.com/infinispan/infinispan/pull/8687#discussion_r488105036", "createdAt": "2020-09-14T17:30:57Z", "author": {"login": "pruivo"}, "path": "core/src/test/java/org/infinispan/jmx/PerCacheInboundHandlerMBeanTest.java", "diffHunk": "@@ -82,7 +82,7 @@ public void testStats() throws Throwable {\n       assertEquals(Boolean.TRUE, mBeanServer.getAttribute(objName, \"StatisticsEnabled\"));\n \n       XSiteReplicateCommand command = mock(XSiteReplicateCommand.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dedb66b81c815434dd0f80f365573cec26432042"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9de719b2fd31f89ac6f99c4103e8939c3034c3be", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/9de719b2fd31f89ac6f99c4103e8939c3034c3be", "committedDate": "2020-09-14T17:51:12Z", "message": "ISPN-12319 XSite Response should allow a value"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dedb66b81c815434dd0f80f365573cec26432042", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/dedb66b81c815434dd0f80f365573cec26432042", "committedDate": "2020-09-14T17:03:52Z", "message": "ISPN-12319 XSite Response should allow a value"}, "afterCommit": {"oid": "9de719b2fd31f89ac6f99c4103e8939c3034c3be", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/9de719b2fd31f89ac6f99c4103e8939c3034c3be", "committedDate": "2020-09-14T17:51:12Z", "message": "ISPN-12319 XSite Response should allow a value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDE2NzEz", "url": "https://github.com/infinispan/infinispan/pull/8687#pullrequestreview-488016713", "createdAt": "2020-09-14T18:01:12Z", "commit": {"oid": "9de719b2fd31f89ac6f99c4103e8939c3034c3be"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 467, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}