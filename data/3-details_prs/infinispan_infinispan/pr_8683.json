{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzODk2MjU2", "number": 8683, "title": "ISPN-12316 Convert expiration to no longer use transactions", "bodyText": "https://issues.redhat.com/browse/ISPN-12316", "createdAt": "2020-09-10T14:01:53Z", "url": "https://github.com/infinispan/infinispan/pull/8683", "merged": true, "mergeCommit": {"oid": "2a81e01d52497b3cd9247f8b99728e4d7ca6d44e"}, "closed": true, "closedAt": "2020-09-10T17:58:45Z", "author": {"login": "wburns"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHieGIgFqTQ4NjA0MjM4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHjYedgBqjM3NTIwMTkwODE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDQyMzg4", "url": "https://github.com/infinispan/infinispan/pull/8683#pullrequestreview-486042388", "createdAt": "2020-09-10T15:14:04Z", "commit": {"oid": "e98511638bb37b4b0d4ea3c6f3d02738dd8337ef"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNToxNDowNVrOHP4-gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNToxNDozMlrOHP4_4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyNDE5Mg==", "bodyText": "lambda can be cached (sound like Dan xD)", "url": "https://github.com/infinispan/infinispan/pull/8683#discussion_r486424192", "createdAt": "2020-09-10T15:14:05Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/interceptors/impl/TransactionalExceptionEvictionInterceptor.java", "diffHunk": "@@ -166,6 +168,31 @@ public Object visitInvalidateCommand(InvocationContext ctx, InvalidateCommand co\n       return super.visitInvalidateCommand(ctx, command);\n    }\n \n+   // Remove Expired is not transactional\n+   @Override\n+   public Object visitRemoveExpiredCommand(InvocationContext ctx, RemoveExpiredCommand command) {\n+      Object key = command.getKey();\n+      // Skip adding changeAmount if originator is not primary\n+      if (ctx.isOriginLocal() && dm != null && !dm.getCacheTopology().getSegmentDistribution(command.getSegment()).isPrimary()) {\n+         return invokeNext(ctx, command);\n+      }\n+      return invokeNextThenAccept(ctx, command, ((rCtx, rCommand, rv) -> {\n+         if (rCommand.isSuccessful()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98511638bb37b4b0d4ea3c6f3d02738dd8337ef"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQyNDU0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                           MVCCEntry<Object, Object> entry = (MVCCEntry) ctx.lookupEntry(key);\n          \n          \n            \n                           MVCCEntry<?, ?> entry = (MVCCEntry<?, ?>) ctx.lookupEntry(key);\n          \n      \n    \n    \n  \n\njust to remove the warning from IDEA :)", "url": "https://github.com/infinispan/infinispan/pull/8683#discussion_r486424546", "createdAt": "2020-09-10T15:14:32Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/interceptors/impl/TransactionalExceptionEvictionInterceptor.java", "diffHunk": "@@ -166,6 +168,31 @@ public Object visitInvalidateCommand(InvocationContext ctx, InvalidateCommand co\n       return super.visitInvalidateCommand(ctx, command);\n    }\n \n+   // Remove Expired is not transactional\n+   @Override\n+   public Object visitRemoveExpiredCommand(InvocationContext ctx, RemoveExpiredCommand command) {\n+      Object key = command.getKey();\n+      // Skip adding changeAmount if originator is not primary\n+      if (ctx.isOriginLocal() && dm != null && !dm.getCacheTopology().getSegmentDistribution(command.getSegment()).isPrimary()) {\n+         return invokeNext(ctx, command);\n+      }\n+      return invokeNextThenAccept(ctx, command, ((rCtx, rCommand, rv) -> {\n+         if (rCommand.isSuccessful()) {\n+            if (dm == null || dm.getCacheTopology().getSegmentDistribution(rCommand.getSegment()).isWriteOwner()) {\n+               MVCCEntry<Object, Object> entry = (MVCCEntry) ctx.lookupEntry(key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98511638bb37b4b0d4ea3c6f3d02738dd8337ef"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTA4MjA2", "url": "https://github.com/infinispan/infinispan/pull/8683#pullrequestreview-486108206", "createdAt": "2020-09-10T16:25:04Z", "commit": {"oid": "ce74d8baf20be6a8b53dc36ffcbcc3453d3b0b31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "865b40b2ef82a32791d9312f2e4362b579792bc0", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/865b40b2ef82a32791d9312f2e4362b579792bc0", "committedDate": "2020-09-10T16:27:59Z", "message": "ISPN-12316 Convert expiration to no longer use transactions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce74d8baf20be6a8b53dc36ffcbcc3453d3b0b31", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/ce74d8baf20be6a8b53dc36ffcbcc3453d3b0b31", "committedDate": "2020-09-10T15:51:42Z", "message": "Review comments"}, "afterCommit": {"oid": "865b40b2ef82a32791d9312f2e4362b579792bc0", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/865b40b2ef82a32791d9312f2e4362b579792bc0", "committedDate": "2020-09-10T16:27:59Z", "message": "ISPN-12316 Convert expiration to no longer use transactions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 463, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}