{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0Mzc4Mzc3", "number": 7878, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo0MTozM1rODffz8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToxMzo1M1rODfgdlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzUzNjUxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/XSiteReplicateCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo0MTozM1rOFpO8Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo0MTozM1rOFpO8Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4MDY5MQ==", "bodyText": "this method should be abstract. Not all commands go through handleStateTransferControl() method.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378780691", "createdAt": "2020-02-13T10:41:33Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/XSiteReplicateCommand.java", "diffHunk": "@@ -11,15 +12,36 @@\n  * @author Pedro Ruivo\n  * @since 7.0\n  */\n-public abstract class XSiteReplicateCommand extends BaseRpcCommand {\n+public abstract class XSiteReplicateCommand implements CacheRpcCommand {\n \n-   private String originSite;\n+   private final byte commandId;\n+   protected ByteString cacheName;\n+   private Address origin;\n+   protected String originSite;\n \n-   protected XSiteReplicateCommand(ByteString cacheName) {\n-      super(cacheName);\n+   protected XSiteReplicateCommand(byte commandId, ByteString cacheName) {\n+      this.commandId = commandId;\n+      this.cacheName = cacheName;\n    }\n \n-   public abstract CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder);\n+   @Override\n+   public boolean isReturnValueExpected() {\n+      return false;\n+   }\n+\n+   @Override\n+   public byte getCommandId() {\n+      return commandId;\n+   }\n+\n+   public CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder) {\n+      assert !preserveOrder;\n+      return receiver.handleStateTransferControl(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzUzOTI5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteAmendOfflineStatusCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo0MjoyNlrOFpO90A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo0MjoyNlrOFpO90A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4MTEzNg==", "bodyText": "this command never goes to the remote site.\nIt shouldn't extend XSiteReplicateCommand", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378781136", "createdAt": "2020-02-13T10:42:26Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteAmendOfflineStatusCommand.java", "diffHunk": "@@ -5,21 +5,21 @@\n import java.io.ObjectOutput;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.util.concurrent.CompletableFutures;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Amend a sites offline status.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteAmendOfflineStatusCommand extends BaseRpcCommand {\n+public class XSiteAmendOfflineStatusCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzU0MDE1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteBringOnlineCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo0Mjo0MFrOFpO-UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo0Mjo0MFrOFpO-UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4MTI2NQ==", "bodyText": "this command never goes to the remote site.\nIt shouldn't extend XSiteReplicateCommand", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378781265", "createdAt": "2020-02-13T10:42:40Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteBringOnlineCommand.java", "diffHunk": "@@ -6,20 +6,20 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Take a site offline.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteBringOnlineCommand extends BaseRpcCommand {\n+public class XSiteBringOnlineCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzU0MDgwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteOfflineStatusCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo0Mjo1MFrOFpO-tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo0Mjo1MFrOFpO-tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4MTM2Ng==", "bodyText": "this command never goes to the remote site.\nIt shouldn't extend XSiteReplicateCommand", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378781366", "createdAt": "2020-02-13T10:42:50Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteOfflineStatusCommand.java", "diffHunk": "@@ -6,20 +6,20 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Get the offline status of a {@link BackupSender}.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteOfflineStatusCommand extends BaseRpcCommand {\n+public class XSiteOfflineStatusCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzU5NTgyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferCancelSendCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo1Nzo1OFrOFpPfzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo1Nzo1OFrOFpPfzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc4OTgzOA==", "bodyText": "After this refactor. this command is only invoked in the local site. It can extend BaseRpcCommand (or implement CacheRpcCommand directly).", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378789838", "createdAt": "2020-02-13T10:57:58Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferCancelSendCommand.java", "diffHunk": "@@ -0,0 +1,75 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateProvider;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Cancel sending XSite state.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferCancelSendCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzU5ODY0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferClearStatusCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo1ODo0OFrOFpPhhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMDo1ODo0OFrOFpPhhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5MDI3OQ==", "bodyText": "Same as above. It is a local site only command.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378790279", "createdAt": "2020-02-13T10:58:48Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferClearStatusCommand.java", "diffHunk": "@@ -0,0 +1,43 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Clear XSite state transfer status.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferClearStatusCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzYxNTY5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferFinishSendCommand.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTowNDoyM1rOFpPsCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTozMzowOVrOFpQfuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5Mjk2OQ==", "bodyText": "This command is local site only. It doesn't need to extend XSiteReplicateCommand.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378792969", "createdAt": "2020-02-13T11:04:23Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferFinishSendCommand.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Finish sending XSite state.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferFinishSendCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgwNjIwMQ==", "bodyText": "I was trying to reduce the amount of duplication, but you're right extending XSiteReplicateCommand is not the way todo it.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378806201", "createdAt": "2020-02-13T11:33:09Z", "author": {"login": "ryanemerson"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferFinishSendCommand.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Finish sending XSite state.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferFinishSendCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5Mjk2OQ=="}, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzYxNjgxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferRestartSendingCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTowNDo0M1rOFpPswg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTowNDo0M1rOFpPswg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5MzE1NA==", "bodyText": "same as above.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378793154", "createdAt": "2020-02-13T11:04:43Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferRestartSendingCommand.java", "diffHunk": "@@ -0,0 +1,81 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateProvider;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Restart sending XSite state.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferRestartSendingCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzYyMjU1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferStartSendCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTowNjo0MlrOFpPwgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTowNjo0MlrOFpPwgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NDExMw==", "bodyText": "local site only command.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378794113", "createdAt": "2020-02-13T11:06:42Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferStartSendCommand.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.util.concurrent.CompletableFutures;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateProvider;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Start send XSite state.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferStartSendCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzYyODgyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferStatusRequestCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTowODo1MFrOFpP0bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMTowODo1MFrOFpP0bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NTExNw==", "bodyText": "local only site.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378795117", "createdAt": "2020-02-13T11:08:50Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStateTransferStatusRequestCommand.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package org.infinispan.xsite.commands;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionStage;\n+\n+import org.infinispan.factories.ComponentRegistry;\n+import org.infinispan.util.ByteString;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n+import org.infinispan.xsite.statetransfer.XSiteStateTransferManager;\n+\n+/**\n+ * Get XSite state transfer status.\n+ *\n+ * @author Ryan Emerson\n+ * @since 11.0\n+ */\n+public class XSiteStateTransferStatusRequestCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzYzNDQ1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStatusCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToxMDo1M1rOFpP3-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToxMDo1M1rOFpP3-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NjAyNQ==", "bodyText": "can be reverted. the command never goes to the remote site.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378796025", "createdAt": "2020-02-13T11:10:53Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteStatusCommand.java", "diffHunk": "@@ -3,28 +3,28 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Return the status of a {@link BackupSender}.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteStatusCommand extends BaseRpcCommand {\n+public class XSiteStatusCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzYzNTAxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteTakeOfflineCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToxMTowMlrOFpP4VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToxMTowMlrOFpP4VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NjExNg==", "bodyText": "same here", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378796116", "createdAt": "2020-02-13T11:11:02Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/commands/XSiteTakeOfflineCommand.java", "diffHunk": "@@ -6,20 +6,20 @@\n import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.CompletionStage;\n \n-import org.infinispan.commands.remote.BaseRpcCommand;\n import org.infinispan.factories.ComponentRegistry;\n import org.infinispan.util.ByteString;\n import org.infinispan.xsite.BackupSender;\n+import org.infinispan.xsite.XSiteReplicateCommand;\n \n /**\n  * Take a site offline.\n  *\n  * @author Ryan Emerson\n  * @since 11.0\n  */\n-public class XSiteTakeOfflineCommand extends BaseRpcCommand {\n+public class XSiteTakeOfflineCommand extends XSiteReplicateCommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzYzNjkyOnYy", "diffSide": "LEFT", "path": "core/src/main/java/org/infinispan/xsite/statetransfer/XSiteStatePushCommand.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToxMTo0MFrOFpP5mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToxMTo0MFrOFpP5mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NjQ0MA==", "bodyText": "this cannot be deleted. Otherwise, the remote site never receives the state.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378796440", "createdAt": "2020-02-13T11:11:40Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/statetransfer/XSiteStatePushCommand.java", "diffHunk": "@@ -25,23 +24,17 @@\n    private long timeoutMillis;\n \n    public XSiteStatePushCommand(ByteString cacheName, XSiteState[] chunk, long timeoutMillis) {\n-      super(cacheName);\n+      super(COMMAND_ID, cacheName);\n       this.chunk = chunk;\n       this.timeoutMillis = timeoutMillis;\n    }\n \n    public XSiteStatePushCommand(ByteString cacheName) {\n-      super(cacheName);\n-   }\n-\n-   @Override\n-   public CompletionStage<Void> performInLocalSite(BackupReceiver receiver, boolean preserveOrder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0MzY0MzA5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/infinispan/xsite/statetransfer/XSiteStateTransferManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToxMzo1M1rOFpP9UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMToxMzo1M1rOFpP9UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc5NzM5Mg==", "bodyText": "should be CacheRpcCommand as parameter.", "url": "https://github.com/infinispan/infinispan/pull/7878#discussion_r378797392", "createdAt": "2020-02-13T11:13:53Z", "author": {"login": "pruivo"}, "path": "core/src/main/java/org/infinispan/xsite/statetransfer/XSiteStateTransferManagerImpl.java", "diffHunk": "@@ -319,34 +328,33 @@ private void handleFailure(XSiteBackup xSiteBackup) {\n       }\n       siteCollector.remove(xSiteBackup.getSiteName());\n       try {\n-         controlStateTransferOnLocalSite(StateTransferControl.CANCEL_SEND, xSiteBackup.getSiteName());\n+         XSiteReplicateCommand command = commandsFactory.buildXSiteStateTransferCancelSendCommand(xSiteBackup.getSiteName());\n+         controlStateTransferOnLocalSite(command);\n       } catch (Exception e) {\n          if (debug) {\n             log.debugf(e, \"Exception while cancel sending to remote site %s\", xSiteBackup.getSiteName());\n          }\n       }\n       try {\n-         controlStateTransferOnRemoteSite(xSiteBackup, StateTransferControl.FINISH_RECEIVE, null);\n+         XSiteReplicateCommand command = commandsFactory.buildXSiteStateTransferFinishReceiveCommand(null);\n+         controlStateTransferOnRemoteSite(xSiteBackup, command, null);\n       } catch (Throwable throwable) {\n          if (debug) {\n             log.debugf(throwable, \"Exception while cancel receiving in remote site %s\", xSiteBackup.getSiteName());\n          }\n       }\n    }\n \n-   private void controlStateTransferOnRemoteSite(XSiteBackup xSiteBackup, StateTransferControl control,\n+   private void controlStateTransferOnRemoteSite(XSiteBackup xSiteBackup, XSiteReplicateCommand command,\n                                                  BackupRpcConfiguration backupRpcConfiguration) throws Throwable {\n-      XSiteStateTransferControlCommand command = commandsFactory.buildXSiteStateTransferControlCommand(control, null);\n       RetryPolicy retryPolicy = backupRpcConfiguration == null ? NO_RETRY :\n             new MaxRetriesPolicy(backupRpcConfiguration.maxRetries);\n       long waitTime = backupRpcConfiguration == null ? 1 : backupRpcConfiguration.waitTime;\n       RetryOnFailureXSiteCommand remoteSite = RetryOnFailureXSiteCommand.newInstance(xSiteBackup, command, retryPolicy);\n       remoteSite.execute(rpcManager, waitTime, TimeUnit.MILLISECONDS);\n    }\n \n-   private void controlStateTransferOnLocalSite(StateTransferControl control, String siteName) throws Exception {\n-      XSiteStateTransferControlCommand command = commandsFactory.buildXSiteStateTransferControlCommand(control, siteName);\n-      command.setTopologyId(currentTopologyId());\n+   private void controlStateTransferOnLocalSite(XSiteReplicateCommand command) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97ab010b86916f4796e5092f108576746cf3cb09"}, "originalPosition": 167}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4469, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}