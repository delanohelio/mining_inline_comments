{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNzI3MzU2", "number": 8944, "title": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking", "bodyText": "https://issues.redhat.com/browse/ISPN-11832", "createdAt": "2020-12-18T19:13:36Z", "url": "https://github.com/infinispan/infinispan/pull/8944", "merged": true, "mergeCommit": {"oid": "b1924e773412e93cbfa99625d5d8070e2a86dd24"}, "closed": true, "closedAt": "2021-01-22T09:37:32Z", "author": {"login": "wburns"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoS_hmgFqTU1NjI2MjI4MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdyWMGzgBqjQyMzQwNzY5OTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2MjYyMjgx", "url": "https://github.com/infinispan/infinispan/pull/8944#pullrequestreview-556262281", "createdAt": "2020-12-21T10:01:53Z", "commit": {"oid": "c826eff0e3ac6e4e56a232c712a9130a2f96f229"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMDowMTo1M1rOIJSs6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxMDowMTo1M1rOIJSs6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYxNDUwNA==", "bodyText": "I'd remove this class entirely", "url": "https://github.com/infinispan/infinispan/pull/8944#discussion_r546614504", "createdAt": "2020-12-21T10:01:53Z", "author": {"login": "anistor"}, "path": "remote-query/remote-query-server/src/main/java/org/infinispan/query/remote/impl/RemoteQueryServerBlockHoundIntegration.java", "diffHunk": "@@ -10,12 +9,5 @@\n public class RemoteQueryServerBlockHoundIntegration implements BlockHoundIntegration {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c826eff0e3ac6e4e56a232c712a9130a2f96f229"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MjQ0Nzcx", "url": "https://github.com/infinispan/infinispan/pull/8944#pullrequestreview-557244771", "createdAt": "2020-12-22T17:29:29Z", "commit": {"oid": "c826eff0e3ac6e4e56a232c712a9130a2f96f229"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzoyOToyOVrOIKC-9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzoyOToyOVrOIKC-9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwNTU1OQ==", "bodyText": "There is an older issue here (also present in the old blocking code).\nThe global errors key should contain the errors in all the schemas, not just the errors from the latest schema added/updated. So the interceptor can't use a PutKeyValueCommand, it should use a ComputeCommand or similar to remove the successful keys and add the new error keys to the global errors atomically.", "url": "https://github.com/infinispan/infinispan/pull/8944#discussion_r547405559", "createdAt": "2020-12-22T17:29:29Z", "author": {"login": "danberindei"}, "path": "remote-query/remote-query-server/src/main/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptor.java", "diffHunk": "@@ -472,7 +523,7 @@ private void updateGlobalErrors(InvocationContext ctx, Set<String> errorFiles, l\n          cmd = commandsFactory.buildPutKeyValueCommand(ERRORS_KEY_SUFFIX, sb.toString(),\n                keyPartitioner.getSegment(ERRORS_KEY_SUFFIX), DEFAULT_METADATA, flagsBitSet);\n       }\n-      invoker.running().invoke(ctx, cmd);\n+      return invoker.running().invokeAsync(ctx, cmd);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c826eff0e3ac6e4e56a232c712a9130a2f96f229"}, "originalPosition": 312}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c826eff0e3ac6e4e56a232c712a9130a2f96f229", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/c826eff0e3ac6e4e56a232c712a9130a2f96f229", "committedDate": "2020-12-18T19:13:07Z", "message": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking"}, "afterCommit": {"oid": "2c2add9cccaac04de50910d9f0eeb0ffa80d3f54", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/2c2add9cccaac04de50910d9f0eeb0ffa80d3f54", "committedDate": "2021-01-04T15:14:19Z", "message": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c2add9cccaac04de50910d9f0eeb0ffa80d3f54", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/2c2add9cccaac04de50910d9f0eeb0ffa80d3f54", "committedDate": "2021-01-04T15:14:19Z", "message": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking"}, "afterCommit": {"oid": "c6c88540012a6f4057da5ec31de72ec597c81d04", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/c6c88540012a6f4057da5ec31de72ec597c81d04", "committedDate": "2021-01-04T15:14:37Z", "message": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwOTgzNTMz", "url": "https://github.com/infinispan/infinispan/pull/8944#pullrequestreview-570983533", "createdAt": "2021-01-19T08:02:19Z", "commit": {"oid": "c6c88540012a6f4057da5ec31de72ec597c81d04"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwODowMjoxOVrOIWCVPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOVQwODo0NDoyNFrOIWD0Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTk3Nzc4OQ==", "bodyText": "IMO having a separate if here makes sense only if you move this line out of the if below:\nregisterProtoFile((String) key, (String) value, progressCallback);\n\nI'd rather move the lines of this if block inside the if block above that assigns a non-null value to progressCallback instead.", "url": "https://github.com/infinispan/infinispan/pull/8944#discussion_r559977789", "createdAt": "2021-01-19T08:02:19Z", "author": {"login": "danberindei"}, "path": "remote-query/remote-query-server/src/main/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptor.java", "diffHunk": "@@ -276,9 +285,32 @@ private void handlePutKeyValueResult(InvocationContext rCtx, PutKeyValueCommand\n          }\n \n          if (progressCallback != null) {\n-            updateGlobalErrors(rCtx, progressCallback.getErrorFiles(), flagsBitSet);\n+            CompletionStage<Void> schemaUpdate = updateSchema(rCtx, progressCallback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6c88540012a6f4057da5ec31de72ec597c81d04"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTk4MDMxOA==", "bodyText": "I think updateSchemaErrors would be a bit better", "url": "https://github.com/infinispan/infinispan/pull/8944#discussion_r559980318", "createdAt": "2021-01-19T08:07:18Z", "author": {"login": "danberindei"}, "path": "remote-query/remote-query-server/src/main/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptor.java", "diffHunk": "@@ -276,9 +285,32 @@ private void handlePutKeyValueResult(InvocationContext rCtx, PutKeyValueCommand\n          }\n \n          if (progressCallback != null) {\n-            updateGlobalErrors(rCtx, progressCallback.getErrorFiles(), flagsBitSet);\n+            CompletionStage<Void> schemaUpdate = updateSchema(rCtx, progressCallback);\n+            CompletionStage<Object> errorUpdate = updateGlobalErrors(rCtx, progressCallback.getErrorFiles().keySet(), flagsBitSet);\n+\n+            return asyncValue(CompletionStages.allOf(schemaUpdate, errorUpdate))\n+                  .thenApplyMakeStage(rCtx, putKeyValueCommand, (rCtx2, rCommand2, rv2) -> rv);\n          }\n       }\n+      return SyncInvocationStage.makeStage(rv);\n+   }\n+\n+   CompletionStage<Void> updateSchema(InvocationContext ctx, ProgressCallback progressCallback) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6c88540012a6f4057da5ec31de72ec597c81d04"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTk4NTEyMA==", "bodyText": "I suggest replacing all the instances of the \"lock .errors key\" comment with \"lock global errors key\", the fact that .errors is the key for global errors isn't obvious.\nMaybe even extract a method lockGlobalErrors to be used everywhere.", "url": "https://github.com/infinispan/infinispan/pull/8944#discussion_r559985120", "createdAt": "2021-01-19T08:15:59Z", "author": {"login": "danberindei"}, "path": "remote-query/remote-query-server/src/main/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptor.java", "diffHunk": "@@ -337,66 +369,81 @@ public Object visitPutMapCommand(InvocationContext ctx, PutMapCommand command) {\n          }\n \n          if (progressCallback != null) {\n-            updateGlobalErrors(rCtx, progressCallback.getErrorFiles(), flagsBitSet);\n+            CompletionStage<Void> schemaUpdate = updateSchema(rCtx, progressCallback);\n+            CompletionStage<Object> errorUpdate = updateGlobalErrors(rCtx, progressCallback.getErrorFiles().keySet(), flagsBitSet);\n+\n+            return asyncValue(CompletionStages.allOf(schemaUpdate, errorUpdate));\n          }\n+         return InvocationStage.completedNullStage();\n       });\n    }\n \n    @Override\n    public Object visitRemoveCommand(InvocationContext ctx, RemoveCommand command) {\n-      if (ctx.isOriginLocal()) {\n-         if (!(command.getKey() instanceof String)) {\n-            throw log.keyMustBeString(command.getKey().getClass());\n+      if (!ctx.isOriginLocal()) {\n+         return invokeNext(ctx, command);\n+      }\n+      if (!(command.getKey() instanceof String)) {\n+         throw log.keyMustBeString(command.getKey().getClass());\n+      }\n+      String key = (String) command.getKey();\n+      if (!shouldIntercept(key)) {\n+         return invokeNext(ctx, command);\n+      }\n+      // lock .errors key", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6c88540012a6f4057da5ec31de72ec597c81d04"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDAwMjA5NQ==", "bodyText": "I created https://issues.redhat.com/browse/ISPN-12631", "url": "https://github.com/infinispan/infinispan/pull/8944#discussion_r560002095", "createdAt": "2021-01-19T08:44:24Z", "author": {"login": "danberindei"}, "path": "remote-query/remote-query-server/src/main/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptor.java", "diffHunk": "@@ -472,7 +523,7 @@ private void updateGlobalErrors(InvocationContext ctx, Set<String> errorFiles, l\n          cmd = commandsFactory.buildPutKeyValueCommand(ERRORS_KEY_SUFFIX, sb.toString(),\n                keyPartitioner.getSegment(ERRORS_KEY_SUFFIX), DEFAULT_METADATA, flagsBitSet);\n       }\n-      invoker.running().invoke(ctx, cmd);\n+      return invoker.running().invokeAsync(ctx, cmd);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwNTU1OQ=="}, "originalCommit": {"oid": "c826eff0e3ac6e4e56a232c712a9130a2f96f229"}, "originalPosition": 312}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6c88540012a6f4057da5ec31de72ec597c81d04", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/c6c88540012a6f4057da5ec31de72ec597c81d04", "committedDate": "2021-01-04T15:14:37Z", "message": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking"}, "afterCommit": {"oid": "88bfc617969342bcdf21b47ddcd8fc943d5d6f4a", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/88bfc617969342bcdf21b47ddcd8fc943d5d6f4a", "committedDate": "2021-01-19T20:24:01Z", "message": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcxOTM2ODY5", "url": "https://github.com/infinispan/infinispan/pull/8944#pullrequestreview-571936869", "createdAt": "2021-01-20T07:37:29Z", "commit": {"oid": "88bfc617969342bcdf21b47ddcd8fc943d5d6f4a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQwNzozNzozMFrOIWwgyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQwNzozNzozMFrOIWwgyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDczNDQwOQ==", "bodyText": "You can move the lines inside the if above, just like in handlePutKeyValueResult", "url": "https://github.com/infinispan/infinispan/pull/8944#discussion_r560734409", "createdAt": "2021-01-20T07:37:30Z", "author": {"login": "danberindei"}, "path": "remote-query/remote-query-server/src/main/java/org/infinispan/query/remote/impl/ProtobufMetadataManagerInterceptor.java", "diffHunk": "@@ -436,9 +479,13 @@ public Object visitReplaceCommand(InvocationContext ctx, ReplaceCommand command)\n             }\n \n             if (progressCallback != null) {\n-               updateGlobalErrors(rCtx, progressCallback.getErrorFiles(), flagsBitSet);\n+               CompletionStage<Void> schemaUpdate = updateSchemaErrors(rCtx, progressCallback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88bfc617969342bcdf21b47ddcd8fc943d5d6f4a"}, "originalPosition": 306}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5ac6e973311e4c1f85719d20870b4b3bb4c13d9", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/f5ac6e973311e4c1f85719d20870b4b3bb4c13d9", "committedDate": "2021-01-21T15:24:26Z", "message": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88bfc617969342bcdf21b47ddcd8fc943d5d6f4a", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/88bfc617969342bcdf21b47ddcd8fc943d5d6f4a", "committedDate": "2021-01-19T20:24:01Z", "message": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking"}, "afterCommit": {"oid": "f5ac6e973311e4c1f85719d20870b4b3bb4c13d9", "author": {"user": {"login": "wburns", "name": "William Burns"}}, "url": "https://github.com/infinispan/infinispan/commit/f5ac6e973311e4c1f85719d20870b4b3bb4c13d9", "committedDate": "2021-01-21T15:24:26Z", "message": "ISPN-11832 ProtobufMetadataManagerInterceptor is blocking"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 246, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}