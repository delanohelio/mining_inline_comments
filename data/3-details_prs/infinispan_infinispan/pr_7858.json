{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNDMyODg4", "number": 7858, "title": "ISPN-11300 Add internal metadata to cache entries", "bodyText": "https://issues.redhat.com/browse/ISPN-11300\nAdds internal metadata to cache entries. This metadata is used internally by ISPN and it shouldn't be exposed to users.\nIn this PR, it isn't used... yet. IRAC versions will live here and optimistic transaction versions will also be moved.", "createdAt": "2020-02-07T14:16:29Z", "url": "https://github.com/infinispan/infinispan/pull/7858", "merged": true, "mergeCommit": {"oid": "1759071fb052d7002d409e09c3388e46a147fd9d"}, "closed": true, "closedAt": "2020-03-26T09:18:40Z", "author": {"login": "pruivo"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFMEaXgBqjMwNDM0NDQ3MzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTWYtwgFqTM4NTUxMjY0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "362eaa422ef8bc83c71a4f96add3a4d677989814", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/362eaa422ef8bc83c71a4f96add3a4d677989814", "committedDate": "2020-02-07T14:14:06Z", "message": "ISPN-11300 Add internal metadata to cache entries"}, "afterCommit": {"oid": "e4f8cc5ed115846f6b15598ed8a6daf85d2d176d", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/e4f8cc5ed115846f6b15598ed8a6daf85d2d176d", "committedDate": "2020-02-17T11:59:14Z", "message": "ISPN-11300 Add internal metadata to cache entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5ODE0MTYz", "url": "https://github.com/infinispan/infinispan/pull/7858#pullrequestreview-359814163", "createdAt": "2020-02-17T15:25:32Z", "commit": {"oid": "e4f8cc5ed115846f6b15598ed8a6daf85d2d176d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToyNTozMlrOFqoOfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToyNTozMlrOFqoOfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MzU4Mw==", "bodyText": "I'm not a fan of this approach. I think it hurts readability and the benefits of the read/write methods will soon be lost with the removal of the Externalizers", "url": "https://github.com/infinispan/infinispan/pull/7858#discussion_r380243583", "createdAt": "2020-02-17T15:25:32Z", "author": {"login": "ryanemerson"}, "path": "core/src/main/java/org/infinispan/container/entries/AbstractInternalCacheEntry.java", "diffHunk": "@@ -133,4 +172,39 @@ public final boolean equals(Object o) {\n    public final int hashCode() {\n       return  31 * Objects.hashCode(getKey()) + Objects.hashCode(getValue());\n    }\n+\n+   protected abstract InternalCacheValue createCacheValue();\n+\n+   protected void appendFieldsToString(StringBuilder builder) {\n+      builder.append(\"key=\").append(Util.toStr(key));\n+      builder.append(\", value=\").append(Util.toStr(value));\n+      builder.append(\", internalMetadata=\").append(internalMetadata);\n+   }\n+\n+   protected static void writeCommonDataTo(AbstractInternalCacheEntry cacheEntry, ObjectOutput output)\n+         throws IOException {\n+      output.writeObject(cacheEntry.key);\n+      output.writeObject(cacheEntry.value);\n+      output.writeObject(cacheEntry.internalMetadata);\n+   }\n+\n+   protected static CommonData readCommonDataFrom(ObjectInput input) throws IOException, ClassNotFoundException {\n+      Object key = input.readObject();\n+      Object value = input.readObject();\n+      MetaParamsInternalMetadata internalMetadata = (MetaParamsInternalMetadata) input.readObject();\n+      return new CommonData(key, value, internalMetadata);\n+   }\n+\n+   protected static class CommonData {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4f8cc5ed115846f6b15598ed8a6daf85d2d176d"}, "originalPosition": 113}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "353c7368ab43f6eafc683de3fc861cce028aeae3", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/353c7368ab43f6eafc683de3fc861cce028aeae3", "committedDate": "2020-02-17T19:59:08Z", "message": "wip..."}, "afterCommit": {"oid": "2adb7b4b4895d16cf1522b2620f65727ed37c325", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/2adb7b4b4895d16cf1522b2620f65727ed37c325", "committedDate": "2020-02-18T09:18:10Z", "message": "ISPN-11300 Add internal metadata to cache entries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2adb7b4b4895d16cf1522b2620f65727ed37c325", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/2adb7b4b4895d16cf1522b2620f65727ed37c325", "committedDate": "2020-02-18T09:18:10Z", "message": "ISPN-11300 Add internal metadata to cache entries"}, "afterCommit": {"oid": "56a35105e672f0bffef3d73a6c5cd3321de5d534", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/56a35105e672f0bffef3d73a6c5cd3321de5d534", "committedDate": "2020-02-19T21:18:35Z", "message": "wip..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56a35105e672f0bffef3d73a6c5cd3321de5d534", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/56a35105e672f0bffef3d73a6c5cd3321de5d534", "committedDate": "2020-02-19T21:18:35Z", "message": "wip..."}, "afterCommit": {"oid": "7c7494e93effcee1d5495521742abd9e84a5ec3d", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/7c7494e93effcee1d5495521742abd9e84a5ec3d", "committedDate": "2020-02-20T17:17:12Z", "message": "I'm an idiot :)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c7494e93effcee1d5495521742abd9e84a5ec3d", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/7c7494e93effcee1d5495521742abd9e84a5ec3d", "committedDate": "2020-02-20T17:17:12Z", "message": "I'm an idiot :)"}, "afterCommit": {"oid": "508ff6f1586e8eb706254f1f09af7c963cb7b00c", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/508ff6f1586e8eb706254f1f09af7c963cb7b00c", "committedDate": "2020-02-21T11:55:01Z", "message": "wip..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "508ff6f1586e8eb706254f1f09af7c963cb7b00c", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/508ff6f1586e8eb706254f1f09af7c963cb7b00c", "committedDate": "2020-02-21T11:55:01Z", "message": "wip..."}, "afterCommit": {"oid": "8b2107928b219b5818264e3a3ac632d790210ed6", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/8b2107928b219b5818264e3a3ac632d790210ed6", "committedDate": "2020-03-02T10:59:57Z", "message": "wip..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b2107928b219b5818264e3a3ac632d790210ed6", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/8b2107928b219b5818264e3a3ac632d790210ed6", "committedDate": "2020-03-02T10:59:57Z", "message": "wip..."}, "afterCommit": {"oid": "d63fa8c44699e19d709a9d9a8e2fc97b43cfcb3b", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/d63fa8c44699e19d709a9d9a8e2fc97b43cfcb3b", "committedDate": "2020-03-03T09:50:24Z", "message": "wip..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d63fa8c44699e19d709a9d9a8e2fc97b43cfcb3b", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/d63fa8c44699e19d709a9d9a8e2fc97b43cfcb3b", "committedDate": "2020-03-03T09:50:24Z", "message": "wip..."}, "afterCommit": {"oid": "6ba99c923a57ba615e0b4d3b84a7b6547b4147d5", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/6ba99c923a57ba615e0b4d3b84a7b6547b4147d5", "committedDate": "2020-03-03T14:01:41Z", "message": "wip..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ba99c923a57ba615e0b4d3b84a7b6547b4147d5", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/6ba99c923a57ba615e0b4d3b84a7b6547b4147d5", "committedDate": "2020-03-03T14:01:41Z", "message": "wip..."}, "afterCommit": {"oid": "053658bb32abcaf7f9dc902eadb1e8dbc300f95b", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/053658bb32abcaf7f9dc902eadb1e8dbc300f95b", "committedDate": "2020-03-04T09:53:01Z", "message": "Add offheap"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "053658bb32abcaf7f9dc902eadb1e8dbc300f95b", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/053658bb32abcaf7f9dc902eadb1e8dbc300f95b", "committedDate": "2020-03-04T09:53:01Z", "message": "Add offheap"}, "afterCommit": {"oid": "a719ef8dfae497687f8d5c8d5a26b34356a973da", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/a719ef8dfae497687f8d5c8d5a26b34356a973da", "committedDate": "2020-03-09T10:27:02Z", "message": "Add offheap"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a719ef8dfae497687f8d5c8d5a26b34356a973da", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/a719ef8dfae497687f8d5c8d5a26b34356a973da", "committedDate": "2020-03-09T10:27:02Z", "message": "Add offheap"}, "afterCommit": {"oid": "0be9aaf6eae11b663fed469ea2466084d3a64369", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/0be9aaf6eae11b663fed469ea2466084d3a64369", "committedDate": "2020-03-13T10:16:37Z", "message": "ISPN-11300 Add internal metadata to cache entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd", "committedDate": "2020-03-17T15:21:24Z", "message": "ISPN-11300 Add internal metadata to cache entries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0be9aaf6eae11b663fed469ea2466084d3a64369", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/0be9aaf6eae11b663fed469ea2466084d3a64369", "committedDate": "2020-03-13T10:16:37Z", "message": "ISPN-11300 Add internal metadata to cache entries"}, "afterCommit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd", "author": {"user": {"login": "pruivo", "name": "Pedro Ruivo"}}, "url": "https://github.com/infinispan/infinispan/commit/c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd", "committedDate": "2020-03-17T15:21:24Z", "message": "ISPN-11300 Add internal metadata to cache entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTA2MDM3", "url": "https://github.com/infinispan/infinispan/pull/7858#pullrequestreview-385506037", "createdAt": "2020-04-01T11:45:22Z", "commit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo0NToyMlrOF-83og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo0NToyMlrOF-83og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1MzMxNA==", "bodyText": "This is not a public method, so there's no reason to keep the old signature around", "url": "https://github.com/infinispan/infinispan/pull/7858#discussion_r401553314", "createdAt": "2020-04-01T11:45:22Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/container/impl/KeyValueMetadataSizeCalculator.java", "diffHunk": "@@ -17,5 +18,18 @@\n     * @param metadata The metadata for this entry to be used in size calculation\n     * @return The size approximately in memory the key, value and metadata use.\n     */\n-   long calculateSize(K key, V value, Metadata metadata);\n+   default long calculateSize(K key, V value, Metadata metadata) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTA3MDg1", "url": "https://github.com/infinispan/infinispan/pull/7858#pullrequestreview-385507085", "createdAt": "2020-04-01T11:47:02Z", "commit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo0NzowMlrOF-863Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo0NzowMlrOF-863Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1NDE0MQ==", "bodyText": "Yes, it can be removed, I'm actually removing it in #8136", "url": "https://github.com/infinispan/infinispan/pull/7858#discussion_r401554141", "createdAt": "2020-04-01T11:47:02Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/container/offheap/OffHeapEntryFactory.java", "diffHunk": "@@ -20,7 +21,22 @@\n     * @return the address of where the entry was created\n     */\n    default long create(WrappedBytes key, WrappedBytes value, Metadata metadata) {\n-      return create(key, key.hashCode(), value, metadata);\n+      //TODO! can it ^ be removed?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTA4OTAy", "url": "https://github.com/infinispan/infinispan/pull/7858#pullrequestreview-385508902", "createdAt": "2020-04-01T11:49:50Z", "commit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo0OTo1MFrOF-9Agg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo0OTo1MFrOF-9Agg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1NTU4Ng==", "bodyText": "\ud83d\udd2a, it's only used by a test.", "url": "https://github.com/infinispan/infinispan/pull/7858#discussion_r401555586", "createdAt": "2020-04-01T11:49:50Z", "author": {"login": "danberindei"}, "path": "core/src/main/java/org/infinispan/container/offheap/UnpooledOffHeapMemoryAllocator.java", "diffHunk": "@@ -53,11 +53,55 @@ public long getAllocatedAmount() {\n    /**\n     * Tries to estimate overhead of the allocation by first adding 8 to account for underlying allocator housekeeping\n     * and then rounds up to nearest power of 16 to account for 16 byte alignment.\n+    *\n     * @param size the desired size of the allocation\n     * @return the resulting size taking into account various overheads\n     */\n    public static long estimateSizeOverhead(long size) {\n       // We take 8 and add the number provided and then round up to 16 (& operator has higher precedence than +)\n       return (size + 8 + 15) & ~15;\n    }\n+\n+   /**\n+    * See {@link #offHeapEntrySize(boolean, boolean, int, int, int, int)}\n+    */\n+   public static long offHeapEntrySize(boolean evictionEnabled, boolean writeMetadataSize, int keySize, int valueSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTEyNjQ4", "url": "https://github.com/infinispan/infinispan/pull/7858#pullrequestreview-385512648", "createdAt": "2020-04-01T11:55:33Z", "commit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo1NTozM1rOF-9Mcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo1NTozM1rOF-9Mcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1ODY0Mw==", "bodyText": "So there's an extra 80-64=16 bytes even when the MetaParamsInternalMetadata isn't used?", "url": "https://github.com/infinispan/infinispan/pull/7858#discussion_r401558643", "createdAt": "2020-04-01T11:55:33Z", "author": {"login": "danberindei"}, "path": "core/src/test/java/org/infinispan/stats/SingleStatsTest.java", "diffHunk": "@@ -64,10 +69,10 @@ protected void configure(ConfigurationBuilder cfg) {\n             // Binary key/value size is 128 bytes\n             size *= 128;\n          } else {\n-            // Off heap key/value size is 64 bytes\n-            size = UnpooledOffHeapMemoryAllocator.estimateSizeOverhead(size * 64);\n+            // Off heap key/value size is 80 bytes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7ddb8b91dd6946a1a28bbb5cb7d18a99a5faadd"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1318, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}