{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxNTEwMjIz", "number": 219, "title": "Verify that next page is not empty in the history iterator", "bodyText": "Next page token may point to an empty page. This results in a possibility that hasNext() may return true and then next() throws NoSuchElementException. This sequence is invalid and breaks iterator contract.\nHere is example of an exception that we've observed:\nCaused by: io.grpc.StatusRuntimeException: INVALID_ARGUMENT: java.util.NoSuchElementException\n\tat java.base/java.util.Collections$EmptyIterator.next(Collections.java:4277)\n\tat io.temporal.internal.replay.WorkflowHistoryIterator.next(WorkflowHistoryIterator.java:116)\n\tat io.temporal.internal.replay.WorkflowHistoryIterator.next(WorkflowHistoryIterator.java:40)\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:179)\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleQueryWorkflowTask(ReplayWorkflowRunTaskHandler.java:255)\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleQueryOnlyWorkflowTask(ReplayWorkflowTaskHandler.java:241)\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:110)\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:309)\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:275)\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630)\n\tat java.base/java.lang.Thread.run(Thread.java:832)\n\nThis PR addresses the problem by making a call to the server in the hasNext method and checking if the next page is not empty.", "createdAt": "2020-09-23T04:36:04Z", "url": "https://github.com/temporalio/sdk-java/pull/219", "merged": true, "mergeCommit": {"oid": "cfa22296f8b795adc1ade7880e602be830118a4c"}, "closed": true, "closedAt": "2020-09-23T20:47:14Z", "author": {"login": "vitarb"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLlFkFABqjM3OTYyMTQ3Njc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLyyl9gFqTQ5NTAzMTQwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76d38e756c8be13ace0c8da6170380445a090fc1", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/76d38e756c8be13ace0c8da6170380445a090fc1", "committedDate": "2020-09-23T04:38:05Z", "message": "remove redundant null check"}, "afterCommit": {"oid": "33e4d01d197bcca1bd19580856584cee414767f4", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/33e4d01d197bcca1bd19580856584cee414767f4", "committedDate": "2020-09-23T04:42:44Z", "message": "Verify that next page is not empty in the history iterator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MDc2ODIw", "url": "https://github.com/temporalio/sdk-java/pull/219#pullrequestreview-494076820", "createdAt": "2020-09-23T04:46:05Z", "commit": {"oid": "33e4d01d197bcca1bd19580856584cee414767f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNDo0NjowNVrOHWWMfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNDo0NjowNVrOHWWMfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzE5NDM2Nw==", "bodyText": "I think you can avoid this call here if line 111 calls this.hasNext", "url": "https://github.com/temporalio/sdk-java/pull/219#discussion_r493194367", "createdAt": "2020-09-23T04:46:05Z", "author": {"login": "mfateev"}, "path": "temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java", "diffHunk": "@@ -77,6 +112,24 @@ public HistoryEvent next() {\n       return current.next();\n     }\n \n+    GetWorkflowExecutionHistoryResponse response = queryWorkflowExecutionHistory(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33e4d01d197bcca1bd19580856584cee414767f4"}, "originalPosition": 68}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33e4d01d197bcca1bd19580856584cee414767f4", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/33e4d01d197bcca1bd19580856584cee414767f4", "committedDate": "2020-09-23T04:42:44Z", "message": "Verify that next page is not empty in the history iterator"}, "afterCommit": {"oid": "b845eff787e131007414996e8e373e7baba7aaf8", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/b845eff787e131007414996e8e373e7baba7aaf8", "committedDate": "2020-09-23T04:53:56Z", "message": "Verify that next page is not empty in the history iterator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTk3ODQ1", "url": "https://github.com/temporalio/sdk-java/pull/219#pullrequestreview-494997845", "createdAt": "2020-09-23T19:51:46Z", "commit": {"oid": "9e97f80f5a4f8a0172329fa2c1edb415858dbfc6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxOTo1MTo0NlrOHW-jzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxOTo1MTo0NlrOHW-jzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1NTY5Mg==", "bodyText": "I don't think it is correct. As it is still going to blow up with the response contains an empty history and hasNext is not called from outside.\nMy proposal is to change the line 94 to:\nif (this.hasNext()) {\n   return current.next();\n}\nand ensure that hasNext either caches non empty events in current or returns false.", "url": "https://github.com/temporalio/sdk-java/pull/219#discussion_r493855692", "createdAt": "2020-09-23T19:51:46Z", "author": {"login": "mfateev"}, "path": "temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java", "diffHunk": "@@ -66,17 +66,44 @@\n     nextPageToken = task.getNextPageToken();\n   }\n \n+  // Returns true if more history events are available.\n+  // Server can return page tokens that point to empty pages.\n+  // We need to verify that page is valid before returning true.\n+  // Otherwise next() method would throw NoSuchElementException after hasNext() returning true.\n   @Override\n   public boolean hasNext() {\n-    return current.hasNext() || !nextPageToken.isEmpty();\n+    if (current.hasNext()) {\n+      return true;\n+    }\n+    if (nextPageToken.isEmpty()) {\n+      return false;\n+    }\n+\n+    GetWorkflowExecutionHistoryResponse response = queryWorkflowExecutionHistory();\n+\n+    current = response.getHistory().getEventsList().iterator();\n+    nextPageToken = response.getNextPageToken();\n+\n+    return current.hasNext();\n   }\n \n   @Override\n   public HistoryEvent next() {\n-    if (current.hasNext()) {\n+    // If current has next element then simply return it, otherwise check if we have next page token\n+    // If no page token available then we should call next() which throws NoSuchElementException.\n+    if (current.hasNext() || nextPageToken.isEmpty()) {\n       return current.next();\n     }\n \n+    GetWorkflowExecutionHistoryResponse response = queryWorkflowExecutionHistory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e97f80f5a4f8a0172329fa2c1edb415858dbfc6"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd1134daee974dcb68f26a43f859e324d7c26c4b", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/fd1134daee974dcb68f26a43f859e324d7c26c4b", "committedDate": "2020-09-23T20:16:24Z", "message": "Verify that next page is not empty in the history iterator"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76137cec698046ddc6c8fe89df6d25cc7b5656ab", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/76137cec698046ddc6c8fe89df6d25cc7b5656ab", "committedDate": "2020-09-23T17:34:53Z", "message": "Merge branch 'master' into iterator-empty-pages"}, "afterCommit": {"oid": "fd1134daee974dcb68f26a43f859e324d7c26c4b", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/fd1134daee974dcb68f26a43f859e324d7c26c4b", "committedDate": "2020-09-23T20:16:24Z", "message": "Verify that next page is not empty in the history iterator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66aa6afaf41944dd020d1f96a0b25b8f03c871d0", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/66aa6afaf41944dd020d1f96a0b25b8f03c871d0", "committedDate": "2020-09-23T20:22:50Z", "message": "remove test service from the test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f859e575f04eb11af1d49c99ad3306984076e1a2", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/f859e575f04eb11af1d49c99ad3306984076e1a2", "committedDate": "2020-09-23T20:38:32Z", "message": "Improve test scenario to process an empty page"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c0784496f75732a7e1d830d118f6f114a810259", "author": {"user": {"login": "vitarb", "name": "Vitaly"}}, "url": "https://github.com/temporalio/sdk-java/commit/7c0784496f75732a7e1d830d118f6f114a810259", "committedDate": "2020-09-23T20:40:42Z", "message": "update comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MDMxNDA3", "url": "https://github.com/temporalio/sdk-java/pull/219#pullrequestreview-495031407", "createdAt": "2020-09-23T20:40:55Z", "commit": {"oid": "f859e575f04eb11af1d49c99ad3306984076e1a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3511, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}